var Ob=Object.defineProperty;var qp=n=>{throw TypeError(n)};var Vb=(n,t,e)=>t in n?Ob(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var I=(n,t,e)=>Vb(n,typeof t!="symbol"?t+"":t,e),Fu=(n,t,e)=>t.has(n)||qp("Cannot "+e);var j=(n,t,e)=>(Fu(n,t,"read from private field"),e?e.call(n):t.get(n)),Ut=(n,t,e)=>t.has(n)?qp("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(n):t.set(n,e),yt=(n,t,e,s)=>(Fu(n,t,"write to private field"),s?s.call(n,e):t.set(n,e),e),ae=(n,t,e)=>(Fu(n,t,"access private method"),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();const Wb="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAAAXNSR0IArs4c6QAACC9JREFUeF7tnU9rXFUcQH93Jgm0iVXQrQtFIaAJdSvu9QNY/PMt/Br6BRR1objShXRjSlxLK1QRBXEnqYKplNTWRsR05sqb9KWvw5vJmzb32HFONk0mM+/enHc4eZle7kvb79/M4UdRAsNI8eyfP8cw9YqO48EjkkKX10ChyzOuR1BogLVCA5DvDKHQAGuFBiArNAdZoTnWFhpgrdAAZAvNQVZojrWFBlgrNADZQnOQFZpjbaEB1goNQLbQHGSF5lhbaIC1QgOQLTQHWaE51hYaYK3QAGQLzUEeRIqnb+242g5AbqEByL2c46e1U9EfjZUiolqxW/3b9tH83vjzpr2ueaxpr5tl7Hq+1b+zvK75s7FzVmhI6O8ePXNHaGDABR5CoYGTXxVaoQHQ1e89F/iXB63Q5RnXIyg0wFqhAci+y8FBVmiOtYUGWCs0ANlCc5AVmmNtoQHWCg1AttAcZIXmWFtogLVCA5AtNAdZoTnWFhpgrdAAZAvNQVZojnX64oObuV4bNR/rqQ7hzNOcK6F/OOPiJELr9Nb5/dHuoylHHJndGHn88ebX9eeTntPl8Unjjv/wbWPNy5yHOcdTf6+28iVO8iKNkV6/8Jfb6RY+44PI8dIfp2M4aQl04fEX6fAKDZxthQYg138UWujysBW6PON6BAsNsFZoALKF5iArNMfaQgOsFRqAbKE5yArNsbbQAGuFBiBbaA6yQnOsLTTAWqEByBaag6zQHGsLDbBWaACyheYgKzTH2kIDrCuhX7xxKgaNxUnTVhlW32v7aFsNOWn6sx6jy6rHeZizQgNCL+UUF9auxHK+e/P649aet01rlsV6k5ZQdtnzdBKSeZizQgNC93OKrbWdWIq7QgPDLuQQCg2cdoUGIPtHIQdZoTnWFhpgrdAAZAvNQVZojrWFBlgrNADZQnOQFZpjbaEB1goNQLbQHGSF5lhbaIC1QgOQLTQHWaE51hYaYK3QAGQLzUFWaI51enX7+mhh1v3ckbl+zaQ7S3d5vOvdrNvGmpc5V0J/eXrXxUmA1+mFi1tu1lgc9CB+PViPlIbFR1r0AdLGpfMKXdiCFIP47Z9NhS7MuTq8QhOQFRqgfDiEQgOoLTQAuX6Xw0uO8rAVujzjegQLDbBWaACyhQYhew2NwbbQAGoLDUC20CBkC43BttAAagsNQLbQIGQLjcG20ABqCw1AttAgZAuNwbbQAGoLDUC20CDkUaE3oudqu+LQLXRxxBGDSLF+cC1ySpGj3v+zuchx2mNtE6xf29xLtO2x8dceN2b1/OqYzZXm458f/SfznU/ajvnfzVmhAaFvRy9eObgcg9QHRlvsIRQaOP8KDUD2GpqDrNAcawsNsFZoALKF5iArNMfaQgOsFRqAbKE5yArNsbbQAGuFBiBbaA6yQnOsLTTAWqEByBaag6zQHGsLDbBWaACyheYgKzTHOp299Pk9e9vNw/2cx/E87HM+iF68fPBt3HZxUnGz00fbb9wjdL14sG3kaTc+7zrTWY8xbT71mA/7nPt5EBdXN6Mf7j7a1ZP7fV76ZPs1dx+9X3odX9fLg/hq9axCd+T1IE9T6Aeh1/G1Ct0R1Ak8TaFPAOJxh1Do4wid3PcV+uRYTjySQgOQ67ftvIYuD1uhyzM+eoNAocvDVujyjBWaYxwKzcH2GhpgrdAAZK+hOcgKzbG20ABrhQYgW2gOskJzrC00wFqhAcgWmoOs0BxrCw2wrlbbfX16w8VJAGuFBiAPUopnblyPYaoXzx634LW5k+j47p5dFkeOH7/59SxjV3AmzaUJbtrxuywAro51MnNWaEjozb3dGKYeMNpiD6HQwPmvCq3QAOiq867lKA9aocszdi0HxzgUmoNtoQHWCg1A9n1oDrJCc6wtNMBaoQHIFpqDrNAcawsNsFZoALKF5iArNMfaQgOsFRqAbKE5yArNsbbQAGuFBiDXhf50y73tSuMepIj1G1ddnFQadLWWY+fDc/noXuXjKxOPu8/6+Fais9xTfdI90asfum3F4aR7qs/BnFNOcfWx36OXXW1X2um0+965LgtsS8/jf338NExx5QmFJk6yQgOUFRqAXF9DW+jysBW6PON6BAsNsFZoALKFBiF7DY3BttAAagsNQLbQIGQLjcG20ABqCw1AttAgZAuNwbbQAGoLDUC20CBkC43BttAAagsNQLbQIGQLjcG20ADqqtC/PH4tennSnc6BSSzIEAoNnOgcw1jbfy4iefP60rgVujTh0Ya0w3jk1vMKDbBWaACyQgOQ/aOQg6zQHGsLDbBWaACyheYgKzTH2kIDrBUagGyhOcgKzbG20ABrhQYgW2gOskJzrC00wFqhAcgWmoOs0BxrCw2wVmgAsoXmICs0xzrtvvtmPryf87QdEpsTau7gWGK3xrYdIqvxZ9mtcdoOjvycR0Lvr7s4CfA67b3zsZs1Fgfdi5X+jxHRLz7Sog+Qrr/9mUIXtiDnXqwsf6PQhTmPfo8rdHnKCl2ecT2CQgOsFRqAXL/LYaHLw1bo8owtNMc4FJqD7SUHwFqhAchecnCQFZpjbaEB1goNQLbQHGSF5lhbaIC1QgOQLTQHWaE51hYaYK3QAGQLzUFWaI61hQZYV0IvLX/v4iSAtUITkPMw9laejBTuPloat0KXJlwtacyDuLqyGT2FLk5boYsjVmgA8dEQCg3QttAAZN/lACF7yYHBttAAagsNQLbQIGQLjcG20ABqCw1AttAgZAuNwbbQAGoLDUC20CBkC43BttAAagsNQLbQIGQLjcG20ABqCw1AttAgZAuNwf4X8h6Lm5rywjsAAAAASUVORK5CYII=",Gb="/music-learning-tools/student-notation/assets/clear-BoKs1BI5.svg",Kb="data:image/svg+xml,%3csvg%20class='diamond-icon'%20viewBox='0%200%20120%20120'%20aria-hidden='true'%20focusable='false'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M60%205%20L35%2048.3%20L35%2071.7%20L60%20115%20L85%2071.7%20L85%2048.3%20Z'%20/%3e%3c/svg%3e",qb="/music-learning-tools/student-notation/assets/eraser-vjnwKGf-.svg",zb="data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20fill='none'%20stroke='currentColor'%20stroke-width='2'%20stroke-dasharray='3%202'%20xmlns='http://www.w3.org/2000/svg'%3e%3cellipse%20cx='12'%20cy='12'%20rx='8'%20ry='6'%20transform='rotate(-15%2012%2012)'/%3e%3c/svg%3e",Xb="/music-learning-tools/student-notation/assets/loop-DCKCNdJ9.svg",$b="data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20fill='none'%20stroke='currentColor'%20stroke-width='2'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M18%202L6%2014l-2%206%206-2L22%206l-4-4z'/%3e%3cline%20x1='14'%20y1='6'%20x2='18'%20y2='10'/%3e%3c/svg%3e",Yb="/music-learning-tools/student-notation/assets/pause-BvM7-xog.svg",jb="/music-learning-tools/student-notation/assets/play-z9TE0FgS.svg",Jb="/music-learning-tools/student-notation/assets/redo-C3TqBHBd.svg",Zb="/music-learning-tools/student-notation/assets/settings-TJsqx0gz.svg",t2="/music-learning-tools/student-notation/assets/stop-BU_KSLYe.svg",e2="/music-learning-tools/student-notation/assets/undo-D1s0pqx2.svg",n2="/music-learning-tools/student-notation/assets/volume-BF7HNWqG.svg",s2="/music-learning-tools/student-notation/assets/zoomIn-CqIKlW7B.svg",i2="/music-learning-tools/student-notation/assets/zoomOut-Cm9mM1qf.svg",r2="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%20fill='none'%20stroke='currentColor'%20stroke-width='2'%20stroke-linecap='round'%20stroke-linejoin='round'%3e%3c!--%20Grid%20pattern%20--%3e%3cline%20x1='3'%20y1='3'%20x2='3'%20y2='21'%20/%3e%3cline%20x1='9'%20y1='3'%20x2='9'%20y2='21'%20/%3e%3cline%20x1='15'%20y1='3'%20x2='15'%20y2='21'%20/%3e%3cline%20x1='21'%20y1='3'%20x2='21'%20y2='21'%20/%3e%3cline%20x1='3'%20y1='6'%20x2='21'%20y2='6'%20/%3e%3cline%20x1='3'%20y1='12'%20x2='21'%20y2='12'%20/%3e%3cline%20x1='3'%20y1='18'%20x2='21'%20y2='18'%20/%3e%3c!--%20Eye%20with%20slash%20(hide)%20--%3e%3cpath%20d='M1%201%20L23%2023'%20stroke-width='2.5'/%3e%3c/svg%3e",o2="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%20fill='none'%20stroke='currentColor'%20stroke-width='2'%20stroke-linecap='round'%20stroke-linejoin='round'%3e%3c!--%20Drum%20pattern%20--%3e%3cellipse%20cx='12'%20cy='7'%20rx='7'%20ry='3'/%3e%3cpath%20d='M%205%207%20L%205%2017%20Q%205%2020%2012%2020%20Q%2019%2020%2019%2017%20L%2019%207'/%3e%3cline%20x1='8'%20y1='10'%20x2='8'%20y2='16'/%3e%3cline%20x1='16'%20y1='10'%20x2='16'%20y2='16'/%3e%3c!--%20Slash%20(hide)%20--%3e%3cpath%20d='M2%202%20L22%2022'%20stroke-width='2.5'/%3e%3c/svg%3e",A2="/music-learning-tools/student-notation/assets/newPage-C3DkqRnq.svg",a2="/music-learning-tools/student-notation/assets/open-yWU2irvQ.svg",l2="/music-learning-tools/student-notation/assets/print-y0OmDKSR.svg",c2="/music-learning-tools/student-notation/assets/saveAs-DyEXJ3e_.svg",u2="/music-learning-tools/student-notation/assets/dottedQuarterNote-Cf79kpGq.svg",d2="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='168'%20zoomAndPan='magnify'%20viewBox='0%200%20126%20231.75'%20height='309'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='f11b48ab54'%3e%3cpath%20d='M%200.0664062%200%20L%20125%200%20L%20125%20230.75%20L%200.0664062%20230.75%20Z%20M%200.0664062%200%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='9738701237'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23f11b48ab54)'%3e%3cpath%20style='%20stroke:none;fill-rule:nonzero;fill:%23000000;fill-opacity:1;'%20d='M%208.109375%20225.367188%20C%20-6.25%20212.289062%201.699219%20191.523438%2025.289062%20179.214844%20C%2033.234375%20175.371094%2039.132812%20173.574219%2049.386719%20173.832031%20C%2055.796875%20174.089844%2062.976562%20177.679688%2062.976562%20177.679688%20C%2062.976562%20131.273438%2062.71875%2043.585938%2062.71875%200.511719%20C%2065.285156%200.511719%2067.078125%200.257812%2070.667969%200.257812%20C%2070.667969%202.820312%2070.667969%204.871094%2070.667969%206.921875%20C%2070.667969%209.230469%2070.667969%2010.511719%2070.925781%2012.050781%20C%2073.488281%2028.203125%2077.078125%2034.613281%2095.023438%2054.355469%20C%20117.84375%2079.738281%20124.511719%2094.863281%20124.511719%20115.121094%20C%20124.253906%20134.09375%20107.589844%20174.601562%20104%20173.0625%20C%20109.125%20158.707031%20116.304688%20143.320312%20118.101562%20130.503906%20C%20120.40625%20114.863281%20114%2092.8125%20103.742188%2081.277344%20C%2095.539062%2071.53125%2076.050781%2063.070312%2070.667969%2063.070312%20C%2070.667969%2063.070312%2070.410156%20156.398438%2070.410156%20191.78125%20C%2070.410156%20197.675781%2065.027344%20208.1875%2061.949219%20211.777344%20C%2047.847656%20228.699219%2020.414062%20236.390625%208.109375%20225.367188%20Z%20M%208.109375%20225.367188%20'/%3e%3c/g%3e%3c/g%3e%3c/svg%3e",h2="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%3e%3ccircle%20cx='12'%20cy='12'%20r='10'%20stroke='currentColor'%20stroke-width='1.5'%20fill='none'/%3e%3cpath%20d='M%2012%2012%20L%2022%2012%20A%2010%2010%200%200%200%2012%202%20Z'%20fill='currentColor'/%3e%3c/svg%3e",f2="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%3e%3ccircle%20cx='12'%20cy='12'%20r='10'%20stroke='currentColor'%20stroke-width='1.5'%20fill='none'/%3e%3cpath%20d='M%2012%2012%20L%2022%2012%20A%2010%2010%200%200%200%2012%202%20Z'%20fill='currentColor'%20transform='rotate(180,%2012,%2012)'/%3e%3c/svg%3e",p2="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%3e%3ccircle%20cx='12'%20cy='12'%20r='10'%20stroke='currentColor'%20stroke-width='1.5'%20fill='none'/%3e%3cpath%20d='M%2012%2012%20L%2022%2012%20A%2010%2010%200%200%200%2012%202%20Z'%20fill='currentColor'%20transform='rotate(270,%2012,%2012)'/%3e%3c/svg%3e",m2="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%3e%3ccircle%20cx='12'%20cy='12'%20r='10'%20stroke='currentColor'%20stroke-width='1.5'%20fill='none'/%3e%3cpath%20d='M%2012%2012%20L%2022%2012%20A%2010%2010%200%200%200%2012%202%20Z'%20fill='currentColor'%20transform='rotate(90,%2012,%2012)'/%3e%3c/svg%3e",g2="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='111'%20zoomAndPan='magnify'%20viewBox='0%200%2083.25%20230.999992'%20height='308'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='084e4edff4'%3e%3cpath%20d='M%201%20165%20L%2081.761719%20165%20L%2081.761719%20229.226562%20L%201%20229.226562%20Z%20M%201%20165%20'/%3e%3c/clipPath%3e%3cclipPath%20id='fdeab4882e'%3e%3cpath%20d='M%2073%201.03125%20L%2081.761719%201.03125%20L%2081.761719%20192%20L%2073%20192%20Z%20M%2073%201.03125%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='45713f1632'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23084e4edff4)'%3e%3cpath%20style='%20stroke:none;fill-rule:evenodd;fill:%23000000;fill-opacity:0.9;'%20d='M%2057.546875%20222.390625%20C%2076.429688%20212.289062%2086.492188%20194.003906%2080.304688%20180.25%20C%2073.699219%20165.578125%2051.011719%20161.4375%2029.660156%20171.003906%20C%208.308594%20180.574219%20-3.664062%20200.25%202.9375%20214.921875%20C%209.542969%20229.59375%2032.230469%20233.734375%2053.582031%20224.164062%20C%2054.917969%20223.566406%2056.285156%20223.0625%2057.546875%20222.390625%20Z%20M%2057.546875%20222.390625%20'/%3e%3c/g%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23fdeab4882e)'%3e%3cpath%20style='fill:none;stroke-width:1.5;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%20299.504676%20305.984569%20L%20299.504676%20339.572267%20'%20transform='matrix(-5.561147,0,0,-5.549953,1743.335656,1885.43835)'/%3e%3c/g%3e%3c/g%3e%3c/svg%3e",w2="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='456e80bb30'%3e%3cpath%20d='M%2017.898438%2024.675781%20L%20111.859375%2024.675781%20L%20111.859375%20118.640625%20L%2017.898438%20118.640625%20Z%20M%2017.898438%2024.675781%20'/%3e%3c/clipPath%3e%3cclipPath%20id='87c9148330'%3e%3cpath%20d='M%2064.878906%2024.675781%20C%2038.933594%2024.675781%2017.898438%2045.710938%2017.898438%2071.660156%20C%2017.898438%2097.605469%2038.933594%20118.640625%2064.878906%20118.640625%20C%2090.828125%20118.640625%20111.859375%2097.605469%20111.859375%2071.660156%20C%20111.859375%2045.710938%2090.828125%2024.675781%2064.878906%2024.675781%20Z%20M%2064.878906%2024.675781%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='d7032f28cc'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23456e80bb30)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%2387c9148330)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%20-0.00202662%20C%2028.250074%20-0.00202662%200.0009548%2028.247092%200.0009548%2063.095541%20C%200.0009548%2097.938745%2028.250074%20126.187864%2063.093277%20126.187864%20C%2097.941726%20126.187864%20126.185599%2097.938745%20126.185599%2063.095541%20C%20126.185599%2028.247092%2097.941726%20-0.00202662%2063.093277%20-0.00202662%20Z%20M%2063.093277%20-0.00202662%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.67729)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(44.895794,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%2017.8125%200%20L%2017.8125%20-40.09375%20L%204.203125%20-40.09375%20L%204.203125%20-51.09375%20C%207.367188%20-51.09375%209.992188%20-51.253906%2012.078125%20-51.578125%20C%2014.171875%20-51.910156%2015.914062%20-52.6875%2017.3125%20-53.90625%20C%2018.71875%20-55.132812%2019.957031%20-57.09375%2021.03125%20-59.78125%20L%2031.3125%20-59.78125%20L%2031.3125%200%20Z%20M%2017.8125%200%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",v2="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='af2f53afe5'%3e%3cpath%20d='M%2017.898438%2024.566406%20L%20111.859375%2024.566406%20L%20111.859375%20118.527344%20L%2017.898438%20118.527344%20Z%20M%2017.898438%2024.566406%20'/%3e%3c/clipPath%3e%3cclipPath%20id='c8dd529e93'%3e%3cpath%20d='M%2064.878906%2024.566406%20C%2038.933594%2024.566406%2017.898438%2045.601562%2017.898438%2071.546875%20C%2017.898438%2097.496094%2038.933594%20118.527344%2064.878906%20118.527344%20C%2090.828125%20118.527344%20111.859375%2097.496094%20111.859375%2071.546875%20C%20111.859375%2045.601562%2090.828125%2024.566406%2064.878906%2024.566406%20Z%20M%2064.878906%2024.566406%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='4829c2bf70'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23af2f53afe5)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23c8dd529e93)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%200.00130943%20C%2028.250074%200.00130943%200.0009548%2028.250428%200.0009548%2063.093632%20C%200.0009548%2097.942081%2028.250074%20126.185954%2063.093277%20126.185954%20C%2097.941726%20126.185954%20126.185599%2097.942081%20126.185599%2063.093632%20C%20126.185599%2028.250428%2097.941726%200.00130943%2063.093277%200.00130943%20Z%20M%2063.093277%200.00130943%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.565431)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(38.720147,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%203.046875%200%20L%203.046875%20-11.1875%20C%2010.921875%20-16.726562%2017.179688%20-21.421875%2021.828125%20-25.265625%20C%2026.484375%20-29.117188%2029.835938%20-32.507812%2031.890625%20-35.4375%20C%2033.953125%20-38.363281%2034.984375%20-41.109375%2034.984375%20-43.671875%20C%2034.984375%20-45.992188%2034.160156%20-47.75%2032.515625%20-48.9375%20C%2030.878906%20-50.132812%2028.957031%20-50.734375%2026.75%20-50.734375%20C%2024.90625%20-50.734375%2023.085938%20-50.210938%2021.296875%20-49.171875%20C%2019.503906%20-48.128906%2018.28125%20-46.207031%2017.625%20-43.40625%20L%205.28125%20-47.875%20C%206.894531%20-52.050781%209.664062%20-55.253906%2013.59375%20-57.484375%20C%2017.53125%20-59.722656%2022.125%20-60.84375%2027.375%20-60.84375%20C%2031.4375%20-60.84375%2035.078125%20-60.171875%2038.296875%20-58.828125%20C%2041.515625%20-57.492188%2044.046875%20-55.523438%2045.890625%20-52.921875%20C%2047.742188%20-50.328125%2048.671875%20-47.15625%2048.671875%20-43.40625%20C%2048.671875%20-37.375%2046.148438%20-31.773438%2041.109375%20-26.609375%20C%2036.078125%20-21.453125%2029.175781%20-16.3125%2020.40625%20-11.1875%20L%2048.953125%20-11.1875%20L%2048.953125%200%20Z%20M%203.046875%200%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",B2="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='0551ece328'%3e%3cpath%20d='M%2017.898438%2024.675781%20L%20111.859375%2024.675781%20L%20111.859375%20118.640625%20L%2017.898438%20118.640625%20Z%20M%2017.898438%2024.675781%20'/%3e%3c/clipPath%3e%3cclipPath%20id='073daee785'%3e%3cpath%20d='M%2064.878906%2024.675781%20C%2038.933594%2024.675781%2017.898438%2045.710938%2017.898438%2071.660156%20C%2017.898438%2097.605469%2038.933594%20118.640625%2064.878906%20118.640625%20C%2090.828125%20118.640625%20111.859375%2097.605469%20111.859375%2071.660156%20C%20111.859375%2045.710938%2090.828125%2024.675781%2064.878906%2024.675781%20Z%20M%2064.878906%2024.675781%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='04a7d7f831'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%230551ece328)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23073daee785)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%20-0.00202662%20C%2028.250074%20-0.00202662%200.0009548%2028.247092%200.0009548%2063.095541%20C%200.0009548%2097.938745%2028.250074%20126.187864%2063.093277%20126.187864%20C%2097.941726%20126.187864%20126.185599%2097.938745%20126.185599%2063.095541%20C%20126.185599%2028.247092%2097.941726%20-0.00202662%2063.093277%20-0.00202662%20Z%20M%2063.093277%20-0.00202662%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.67729)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(37.869539,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%2026.046875%201.078125%20C%2022.703125%201.078125%2019.492188%200.597656%2016.421875%20-0.359375%20C%2013.347656%20-1.316406%2010.644531%20-2.789062%208.3125%20-4.78125%20C%205.988281%20-6.78125%204.203125%20-9.363281%202.953125%20-12.53125%20L%2015.296875%20-17%20C%2016.078125%20-14.082031%2017.507812%20-12.023438%2019.59375%20-10.828125%20C%2021.6875%20-9.628906%2023.953125%20-9.03125%2026.390625%20-9.03125%20C%2029.203125%20-9.03125%2031.441406%20-9.71875%2033.109375%20-11.09375%20C%2034.773438%20-12.46875%2035.609375%20-14.378906%2035.609375%20-16.828125%20C%2035.609375%20-19.265625%2034.832031%20-21.15625%2033.28125%20-22.5%20C%2031.738281%20-23.84375%2029.695312%20-24.769531%2027.15625%20-25.28125%20C%2024.625%20-25.789062%2021.863281%20-26.046875%2018.875%20-26.046875%20L%2018.875%20-35.53125%20C%2024.007812%20-35.53125%2027.960938%20-36.242188%2030.734375%20-37.671875%20C%2033.515625%20-39.109375%2034.90625%20-41.140625%2034.90625%20-43.765625%20C%2034.90625%20-46.085938%2033.960938%20-47.828125%2032.078125%20-48.984375%20C%2030.203125%20-50.148438%2028.039062%20-50.734375%2025.59375%20-50.734375%20C%2023.382812%20-50.734375%2021.351562%20-50.195312%2019.5%20-49.125%20C%2017.65625%20-48.050781%2016.4375%20-46.144531%2015.84375%20-43.40625%20L%203.578125%20-47.875%20C%204.773438%20-50.914062%206.535156%20-53.390625%208.859375%20-55.296875%20C%2011.179688%20-57.210938%2013.863281%20-58.613281%2016.90625%20-59.5%20C%2019.945312%20-60.394531%2023.109375%20-60.84375%2026.390625%20-60.84375%20C%2029.140625%20-60.84375%2031.828125%20-60.546875%2034.453125%20-59.953125%20C%2037.078125%20-59.359375%2039.445312%20-58.421875%2041.5625%20-57.140625%20C%2043.6875%20-55.859375%2045.390625%20-54.242188%2046.671875%20-52.296875%20C%2047.953125%20-50.359375%2048.59375%20-48.050781%2048.59375%20-45.375%20C%2048.59375%20-42.144531%2047.726562%20-39.320312%2046%20-36.90625%20C%2044.269531%20-34.488281%2042.359375%20-32.6875%2040.265625%20-31.5%20C%2042.234375%20-30.78125%2043.914062%20-29.644531%2045.3125%20-28.09375%20C%2046.71875%20-26.539062%2047.78125%20-24.835938%2048.5%20-22.984375%20C%2049.21875%20-21.140625%2049.578125%20-19.296875%2049.578125%20-17.453125%20C%2049.578125%20-13.273438%2048.472656%20-9.828125%2046.265625%20-7.109375%20C%2044.054688%20-4.398438%2041.160156%20-2.359375%2037.578125%20-0.984375%20C%2034.003906%200.390625%2030.160156%201.078125%2026.046875%201.078125%20Z%20M%2026.046875%201.078125%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",C2="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='0f524ef70a'%3e%3cpath%20d='M%2017.898438%2024.675781%20L%20111.859375%2024.675781%20L%20111.859375%20118.640625%20L%2017.898438%20118.640625%20Z%20M%2017.898438%2024.675781%20'/%3e%3c/clipPath%3e%3cclipPath%20id='786a2dceed'%3e%3cpath%20d='M%2064.878906%2024.675781%20C%2038.933594%2024.675781%2017.898438%2045.710938%2017.898438%2071.660156%20C%2017.898438%2097.605469%2038.933594%20118.640625%2064.878906%20118.640625%20C%2090.828125%20118.640625%20111.859375%2097.605469%20111.859375%2071.660156%20C%20111.859375%2045.710938%2090.828125%2024.675781%2064.878906%2024.675781%20Z%20M%2064.878906%2024.675781%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='1bb9b822db'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%230f524ef70a)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23786a2dceed)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%20-0.00202662%20C%2028.250074%20-0.00202662%200.0009548%2028.247092%200.0009548%2063.095541%20C%200.0009548%2097.938745%2028.250074%20126.187864%2063.093277%20126.187864%20C%2097.941726%20126.187864%20126.185599%2097.938745%20126.185599%2063.095541%20C%20126.185599%2028.247092%2097.941726%20-0.00202662%2063.093277%20-0.00202662%20Z%20M%2063.093277%20-0.00202662%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.67729)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(36.937365,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%2031.140625%200%20L%2031.140625%20-12.625%20L%202.0625%20-12.625%20L%202.0625%20-22.546875%20L%2031.140625%20-59.78125%20L%2044.75%20-59.78125%20L%2044.75%20-24.609375%20L%2052.96875%20-24.609375%20L%2052.96875%20-12.625%20L%2044.75%20-12.625%20L%2044.75%200%20Z%20M%2016.828125%20-24.609375%20L%2031.140625%20-24.609375%20L%2031.140625%20-41.96875%20Z%20M%2016.828125%20-24.609375%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",b2="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='0d82974cc8'%3e%3cpath%20d='M%2017.898438%2024.789062%20L%20111.859375%2024.789062%20L%20111.859375%20118.753906%20L%2017.898438%20118.753906%20Z%20M%2017.898438%2024.789062%20'/%3e%3c/clipPath%3e%3cclipPath%20id='37694f020a'%3e%3cpath%20d='M%2064.878906%2024.789062%20C%2038.933594%2024.789062%2017.898438%2045.824219%2017.898438%2071.769531%20C%2017.898438%2097.71875%2038.933594%20118.753906%2064.878906%20118.753906%20C%2090.828125%20118.753906%20111.859375%2097.71875%20111.859375%2071.769531%20C%20111.859375%2045.824219%2090.828125%2024.789062%2064.878906%2024.789062%20Z%20M%2064.878906%2024.789062%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='22003a5ccc'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%230d82974cc8)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%2337694f020a)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%20-0.000119013%20C%2028.250074%20-0.000119013%200.0009548%2028.249%200.0009548%2063.092203%20C%200.0009548%2097.940652%2028.250074%20126.189771%2063.093277%20126.189771%20C%2097.941726%20126.189771%20126.185599%2097.940652%20126.185599%2063.092203%20C%20126.185599%2028.249%2097.941726%20-0.000119013%2063.093277%20-0.000119013%20Z%20M%2063.093277%20-0.000119013%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.789151)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(37.55493,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%2026.390625%201.078125%20C%2021.203125%201.078125%2016.59375%20-0.0664062%2012.5625%20-2.359375%20C%208.539062%20-4.660156%205.578125%20-8.019531%203.671875%20-12.4375%20L%2015.484375%20-16.734375%20C%2016.316406%20-13.804688%2017.671875%20-11.789062%2019.546875%20-10.6875%20C%2021.429688%20-9.582031%2023.476562%20-9.03125%2025.6875%20-9.03125%20C%2028.84375%20-9.03125%2031.4375%20-9.957031%2033.46875%20-11.8125%20C%2035.5%20-13.664062%2036.515625%20-16.320312%2036.515625%20-19.78125%20C%2036.515625%20-23.476562%2035.453125%20-26.191406%2033.328125%20-27.921875%20C%2031.210938%20-29.648438%2028.753906%20-30.515625%2025.953125%20-30.515625%20C%2021.535156%20-30.515625%2018.253906%20-28.578125%2016.109375%20-24.703125%20L%204.03125%20-29.171875%20L%207.78125%20-59.78125%20L%2047.78125%20-59.78125%20L%2047.78125%20-48.671875%20L%2019.0625%20-48.671875%20L%2017.71875%20-37.5%20C%2019.09375%20-38.507812%2020.894531%20-39.28125%2023.125%20-39.8125%20C%2025.363281%20-40.351562%2027.53125%20-40.625%2029.625%20-40.625%20C%2033.195312%20-40.625%2036.578125%20-39.847656%2039.765625%20-38.296875%20C%2042.960938%20-36.742188%2045.5625%20-34.429688%2047.5625%20-31.359375%20C%2049.5625%20-28.285156%2050.5625%20-24.425781%2050.5625%20-19.78125%20C%2050.5625%20-15.238281%2049.441406%20-11.414062%2047.203125%20-8.3125%20C%2044.960938%20-5.21875%2042.007812%20-2.878906%2038.34375%20-1.296875%20C%2034.675781%200.285156%2030.691406%201.078125%2026.390625%201.078125%20Z%20M%2026.390625%201.078125%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",y2="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='2a134d5da5'%3e%3cpath%20d='M%2017.898438%2024.675781%20L%20111.859375%2024.675781%20L%20111.859375%20118.640625%20L%2017.898438%20118.640625%20Z%20M%2017.898438%2024.675781%20'/%3e%3c/clipPath%3e%3cclipPath%20id='1436cb12ac'%3e%3cpath%20d='M%2064.878906%2024.675781%20C%2038.933594%2024.675781%2017.898438%2045.710938%2017.898438%2071.660156%20C%2017.898438%2097.605469%2038.933594%20118.640625%2064.878906%20118.640625%20C%2090.828125%20118.640625%20111.859375%2097.605469%20111.859375%2071.660156%20C%20111.859375%2045.710938%2090.828125%2024.675781%2064.878906%2024.675781%20Z%20M%2064.878906%2024.675781%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='0d388df51e'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%232a134d5da5)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%231436cb12ac)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%20-0.00202662%20C%2028.250074%20-0.00202662%200.0009548%2028.247092%200.0009548%2063.095541%20C%200.0009548%2097.938745%2028.250074%20126.187864%2063.093277%20126.187864%20C%2097.941726%20126.187864%20126.185599%2097.938745%20126.185599%2063.095541%20C%20126.185599%2028.247092%2097.941726%20-0.00202662%2063.093277%20-0.00202662%20Z%20M%2063.093277%20-0.00202662%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.67729)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(36.669365,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%2028.71875%201.078125%20C%2023%201.078125%2018.363281%20-0.113281%2014.8125%20-2.5%20C%2011.257812%20-4.882812%208.660156%20-8.222656%207.015625%20-12.515625%20C%205.378906%20-16.816406%204.5625%20-21.769531%204.5625%20-27.375%20C%204.5625%20-31.675781%205.035156%20-35.820312%205.984375%20-39.8125%20C%206.941406%20-43.8125%208.453125%20-47.390625%2010.515625%20-50.546875%20C%2012.578125%20-53.710938%2015.242188%20-56.21875%2018.515625%20-58.0625%20C%2021.796875%20-59.914062%2025.765625%20-60.84375%2030.421875%20-60.84375%20C%2034.953125%20-60.84375%2038.738281%20-60.050781%2041.78125%20-58.46875%20C%2044.832031%20-56.894531%2047.128906%20-54.796875%2048.671875%20-52.171875%20L%2036.515625%20-47.78125%20C%2035.910156%20-48.800781%2034.984375%20-49.59375%2033.734375%20-50.15625%20C%2032.484375%20-50.71875%2031.082031%20-51%2029.53125%20-51%20C%2026.363281%20-51%2023.78125%20-49.789062%2021.78125%20-47.375%20C%2019.789062%20-44.96875%2018.796875%20-41.195312%2018.796875%20-36.0625%20C%2020.285156%20-37.4375%2022.054688%20-38.507812%2024.109375%20-39.28125%20C%2026.171875%20-40.0625%2028.664062%20-40.453125%2031.59375%20-40.453125%20C%2035.113281%20-40.453125%2038.40625%20-39.628906%2041.46875%20-37.984375%20C%2044.539062%20-36.347656%2047.015625%20-34.019531%2048.890625%20-31%20C%2050.773438%20-27.988281%2051.71875%20-24.425781%2051.71875%20-20.3125%20C%2051.71875%20-16.195312%2050.734375%20-12.523438%2048.765625%20-9.296875%20C%2046.796875%20-6.078125%2044.082031%20-3.539062%2040.625%20-1.6875%20C%2037.164062%200.15625%2033.195312%201.078125%2028.71875%201.078125%20Z%20M%2028.640625%20-9.03125%20C%2031.554688%20-9.03125%2033.847656%20-10%2035.515625%20-11.9375%20C%2037.191406%20-13.882812%2038.03125%20-16.4375%2038.03125%20-19.59375%20C%2038.03125%20-22.757812%2037.191406%20-25.328125%2035.515625%20-27.296875%20C%2033.847656%20-29.265625%2031.523438%20-30.25%2028.546875%20-30.25%20C%2025.679688%20-30.25%2023.367188%20-29.289062%2021.609375%20-27.375%20C%2019.847656%20-25.46875%2018.96875%20-22.90625%2018.96875%20-19.6875%20C%2018.96875%20-16.46875%2019.847656%20-13.882812%2021.609375%20-11.9375%20C%2023.367188%20-10%2025.710938%20-9.03125%2028.640625%20-9.03125%20Z%20M%2028.640625%20-9.03125%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",S2="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='d5d49c9923'%3e%3cpath%20d='M%2017.898438%2024.675781%20L%20111.859375%2024.675781%20L%20111.859375%20118.640625%20L%2017.898438%20118.640625%20Z%20M%2017.898438%2024.675781%20'/%3e%3c/clipPath%3e%3cclipPath%20id='0ef729529e'%3e%3cpath%20d='M%2064.878906%2024.675781%20C%2038.933594%2024.675781%2017.898438%2045.710938%2017.898438%2071.660156%20C%2017.898438%2097.605469%2038.933594%20118.640625%2064.878906%20118.640625%20C%2090.828125%20118.640625%20111.859375%2097.605469%20111.859375%2071.660156%20C%20111.859375%2045.710938%2090.828125%2024.675781%2064.878906%2024.675781%20Z%20M%2064.878906%2024.675781%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='926e811c6f'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23d5d49c9923)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%230ef729529e)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%20-0.00202662%20C%2028.250074%20-0.00202662%200.0009548%2028.247092%200.0009548%2063.095541%20C%200.0009548%2097.938745%2028.250074%20126.187864%2063.093277%20126.187864%20C%2097.941726%20126.187864%20126.185599%2097.938745%20126.185599%2063.095541%20C%20126.185599%2028.247092%2097.941726%20-0.00202662%2063.093277%20-0.00202662%20Z%20M%2063.093277%20-0.00202662%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.67729)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(40.642754,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%207.421875%200%20L%2031.671875%20-48.59375%20L%201.34375%20-48.59375%20L%201.34375%20-59.78125%20L%2046.078125%20-59.78125%20L%2046.078125%20-48.59375%20L%2023.09375%200%20Z%20M%207.421875%200%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",E2="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAYAAADimHc4AAAAAXNSR0IArs4c6QAABFNJREFUeF7tnU1rFEEQhqvBrOQbveshCupiUG/iSfwNfgRP/h7Be0RBEG8q6EExAQ+5SMRLFBWPEjeiyWqCaxQSoaXdDNszzi61U907U8u7t52pqp59n+nu6o+ZNYu3flhS+rFkaab1icgo/QFEZACgXHgAUK7+qAEl6w8AACBQAJ2wQLwQrgAQQkVBDJc/H9puEBlGHmotz05wPUVcVWdBRJZWR2tFfndlfHQDsJbeTU9VRswiF6IewNvpKc0DYd1pKFlLAFCk3oXyAYBQShaMAwAFhQvlNgwAHt5JT0e7jDo7P513LE/DxK5XjH5j+eVkfY0l+jg+qbsTvvbkV0fvPAX9Y74azit7zj/GJSSI70bCp1tjutcD5p55AEI1DQOK4wCc3QKAAcn9fzEAUJr07YIBAADEChj0AWINRQEAQCSf3Fk9gNmWNx3NWBbY6zzCp65JCs5h4tmqBuAGYkvja2QUD8VUA3BD9ucTDcXyEwEAp8mIaAMAEcXlhAYAjkoRbQAgoric0ADAUSmijbm4sKV2e7qbDVoaW9edhp55sZABkHz1RzV5SzTt6bD2p9sSjH/r9FrmScrqVk62rM73xp8Z1r6siDexKLSZXX6sugZ83amHH9WKJO3PGQD60yu4NQAEl7S/gADQn17BrQEguKT9BQSA/vQKbq0ewMbOcWRBwW8LZkCXP5/b/VDBBy/4qzOqa4D7mRd2VyoIgHkHuSGs5oEYAPBBR7EEgCiy8oMCAF+rKJYAEEVWftChAHBq+ZE3G9otfeo1TdxNsFg+nWt0e0PP777RnQXdXZzzlOr2+ER2xxNnBjuWT/oaX43VdW9Lubd4haMmv10YpKW19HL8JAAMUvNUWQBQmvTtggEAAKQKGPQBUgll/gAg00/srR7AyugxVhZk/+0eql7CpxqAk/NwqyW+C8sMoB5AfWujTP3EZesHsLmhe0lScxbkmqA6AIhrYeEAAFBYujCOABBGx8JRhgLAg6eXU8mxy5fdtvP05vT0FHB2M3nnbOfdM9mcO4mbbGX3I+ZvTk/n7e2L7BxLLnqm1dTdCa/evlS90Qm3Tlii9emm7gc0vtzUDWDtYHPvAREutWrZGQAoFwgAlKs/AQAACBSwROgDBPqJXQFALKEsgCX6fGCTtR4gKyiet+o+wG3MGv19lMi9OCj1EtNezy+3B3T5zzhnX5zqDxF7vVQ1G9MHlleWN2DVnIY6AJM/T+geCQNAvOaFE1l9E4QawMEcyQZNUCRhuWEBgKtUJLvhADB/Ve90NFma2HZpaCTCAwhrvt2YVwyAaL9p6J6O3rx+Xy0A9+d4tZHXADCAmppbBACUpfxeuQAAAGIFDPoAsYaiAAAgkk/urB7AvpH3yILk90HBCNbS99qRnLn9bnPwfjnZNQR3zj+Wd03h/2hNdQ1wT0k2a/WC9KrhBgAlcwAAABAogCZIIF4IVwAIoaIgBgAIxAvhOgQA/gLvdplS6vruLgAAAABJRU5ErkJggg==",x2="/music-learning-tools/student-notation/assets/favicon-Bc4v39Jn.ico",_2="/music-learning-tools/student-notation/assets/favicon-BsWgUeI5.svg",I2="/music-learning-tools/student-notation/assets/atkinsonHyperlegibleNextBold-CRDaWt1k.otf",F2="/music-learning-tools/student-notation/assets/atkinsonHyperlegibleNextRegular-DOJsAlq1.otf",T2="/music-learning-tools/student-notation/assets/atkinsonHyperlegibleNextRegularItalic-DruWc0Qu.otf",Q2="data:application/manifest+json;base64,ew0KICAibmFtZSI6ICJTdHVkZW50Tm90YXRpb24iLA0KICAic2hvcnRfbmFtZSI6ICJTTiIsDQogICJpY29ucyI6IFsNCiAgICB7DQogICAgICAic3JjIjogIi93ZWItYXBwLW1hbmlmZXN0LTE5MngxOTIucG5nIiwNCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwNCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIsDQogICAgICAicHVycG9zZSI6ICJtYXNrYWJsZSINCiAgICB9LA0KICAgIHsNCiAgICAgICJzcmMiOiAiL3dlYi1hcHAtbWFuaWZlc3QtNTEyeDUxMi5wbmciLA0KICAgICAgInNpemVzIjogIjUxMng1MTIiLA0KICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIiwNCiAgICAgICJwdXJwb3NlIjogIm1hc2thYmxlIg0KICAgIH0NCiAgXSwNCiAgInRoZW1lX2NvbG9yIjogIiNmZmZmZmYiLA0KICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmZmZmIiwNCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSINCn0=",M2="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAAAXNSR0IArs4c6QAACJhJREFUeF7tncFuG1UYRv9rO0ElaRFSt0gsCgKhNu0esUasQeQ9eAvEA4DoBsQKNmUBgWwRVSWKEEKCZUkXNICUJhAQajIedF1PNRnZjok6OmN8solke+Zen29OPju6vk7b7/9Rhj8IgSJSPP/nnRimHjK+g0YkBeAuAwXg2FcjKwCYgQKA8MdDKwCYgQKA8BWAh68AfAY2AJiBAoDwbQAevgLwGdgAYAYKAMK3AXj4CsBnYAOAGSgACN8G4OErAJ+BDQBmoAAgfBuAh68AfAY2AJiBAoDwbQAevgLwGdgAYAZF9OLS4Z0oXA6NpaAAGPqIflnGT+vnYjCeQ/5gRoqI6ne+uX5bfar1x1Uf6Gge23xqnv8k28xHAWABvnvqQvTBOSz70AoAXgG5ARQADMAGYOErAMvfl0AwfwWAA7AB2AAUgOVvA8D8FQAOwAZgA1AAlr8NAPNXADgAG4ANQAFY/jYAzF8B4ABsADYABWD52wAwfwWAA7AB2AAUgOVvA8D8FQAOIDfA59fdHp2KIQvwwwVXg1L8Rw3w1o2//H4AKIFhDOPZf9ZjmBfy+4MQSJtf/K0ACPqI4yjjlf0no1AAKIEIBcDQKwCI/tHQCgCmYAOA8MdDKwCYgQKA8BWAh68AfAY2AJiBAoDwbQAevgLwGdgAYAYKAMK3AXj4CsBnYAOAGSgACN8G4OErAJ+BDQBmoAAgfBuAh68AfAY2AJiBAoDwbQAefhbg5f1zrgYFo7ABQPiDMsXW+k6sRO/hNwPUvxigPq/mgvV5lk+3dcy0Oeb5LuD8FQAVoBefrf88FgCcyBIPrQBg+INSAUD8o6EVAExAAUD4vgnm4SsAn4ENAGagACB8G4CHrwB8BjYAmIECgPBtAB6+AvAZ2ABgBgoAwrcBePgKwGdgA4AZKAAI3wbg4SsAn4ENAGagACB8G4CHrwB8Bun17fvuDg3lMBj24su1e64GhfjnYdO1m1sKAAWQooi7xy9GLxXQDBw2Xb71qQJA10EW4JcHGwoA8R81gAJw9BWAY1+NrABgBgoAwq/+C2QDcCEoAMfeBuDZhwLwIfgSCMxAAUD4vgTqAHz/C4SHYAOAEdgAIHwboAPwbQA8BBsAjMAGAOHbAB2AbwPgIdgAYAQ2AAjfBugAfBsAD8EGACOwAUD4NkAH4EcR9x5ccTUoGIUNAMLPnwJ47ugghqm+4f+kTfZnbcpffwLV42ad47+ea9L5Z0FbrPkrACjAUfTjtaNv4jj1wVks99AKAOavACB83wPw8BWAz8AGADNQABC+DcDDVwA+AxsAzEABQPg2AA9fAfgMbAAwAwUA4dsAPHwF4DOwAcAMFACEbwPw8BWAz8AGADNQABC+DcDDVwA+AxsAzEABQPhVA2zculHbHXraUtnmBtL15bvTnkRbx8xazrtY8z+KXrx69K2rQUEP0ofbm7UrNV/Yk3ZLb17w8+yo3tYx0+aYKS7W/PtlEV+vXY1B+P0AlAPpo+0357maqfn9r8fNAny1dk0BwJQVAISvACD86j2ADcCFoAAc+2pkGwDMQAFA+DYAD18B+AxsADADBQDh2wA8fAXgM7ABwAwUAIRvA/DwFYDPwAYAM1AAEL4NwMNXAD4DGwDMQAFA+DYAD18B+AxsADADBQDh2wA8/H55HDfzcujS5dBUGjYART4iipTi0sH+6Hf+mfVJh/o0q8fVf+f7698OMOlpNY+rj1kf+yyfuFjU+SsAKMBxSnF1bzeK1ANnsdxDKwCYvwKA8H0PwMNXAD4DGwDMQAFA+DYAD18B+AxsADADBQDh2wA8fAXgM7ABwAwUAIRvA/DwFYDPwAYAM1AAEL4NwMNXAD4DGwDMQAFA+DYAD18B+AxsADADBQDhVw3w8Za7Q1Mx5GXQLxzsxtDVoFQEkXauv3Fie/RqV//6jdN2+q8/9rRvA5h0f3OsWeeYNK9J1BZp/r1hit2nf4te6XJoyoC0+95JAaiJLOO4WYCdiwpAZq8AIH0FAOFX7wFsAC4EBeDYVyPbAGAGCgDCtwF4+ArAZ2ADgBkoAAjfBuDhKwCfgQ0AZqAAIHwbgIevAHwGNgCYgQKA8G0AHr4C8BnYAGAGCgDCtwF4+ArAZ2ADgBkoAAjfBugA/GGKuxd/j361HLra37w5tRML1sf7qJ82/baOmTbHPJ8FnL8NcNqF1OL9ZRRx/vBylGn8BRnTNuY/7cMWk+bY1jFn+fKAtubSfN7zjNOYvwK0eIGfduqHAlyJqAQ47QDvf+wEFOCxI53/hAowP6u2HqkAbZGd47wKMAeklh+iAC0DnnV6BQDh+18gHr4C8BnYAGAGCgDCtwF4+ArAZ2ADgBkoAAjfBuDhKwCfgQ0AZqAAIHwbgIevAHwGNgCYgQKA8G0AHr4C8BnYAGAGCgDCf9QA7242V47zs1qSGeRl0OcPX3I1KJh32nvng5oAsxZ712dZPa7+O99ffSJimlPN4/Ixs26bROYsC9Kb5+nG/MuyH0/0f4yIPngJLPfQ6f7bn9gA0DWQBVhdua0AEP/Rn18F4OgrAMe+GlkBwAwUAIRfvQm2AbgQFIBjbwPw7EMB+BB8CQRmoAAgfF8C8fAVgM/ABgAzUAAQvg3Aw1cAPgMbAMxAAUD4NgAPXwH4DGwAMAMFAOHbADx8BeAzsAHADBQAhG8D8PCzAIOV7yNiMJ7MvJvv15edV3uCT7qt+Ryby9WnLQufxWbeOU4bO9/enfnbAKAHqSxib/WZSKMLwh+CgAIQ1Kv6LYv4dXUjejH+ggxwLss6tAKAyecGUAAwAD8QA8NXADYABWD52wAs/zy6L4HADBQAhO+/QTsA35dAeAg2ABiBDQDCtwE6AN8GwEOwAcAIbAAQvg3QAfg2AB6CDQBGYAOA8G2ADsC3AfAQbAAwAhsAhG8DdAC+DYCHYAOAEdgAIPzx0P8CpKm0wymYN9kAAAAASUVORK5CYII=",U2="/music-learning-tools/student-notation/assets/web-app-manifest-512x512-Dz8l3SBy.png",P2=`<div id="app-loading-screen">\r
  <div class="loading-container">\r
    <div class="loading-logo">\r
      <svg viewBox="0 0 100 100" class="logo-svg">\r
        <circle cx="50" cy="50" r="45" class="logo-circle" />\r
        <path d="M 30 50 Q 50 30, 70 50 T 70 70" class="logo-path" />\r
      </svg>\r
    </div>\r
    <h1 class="loading-title">Student Notation</h1>\r
    <div class="loading-progress-container">\r
      <div class="loading-progress-bar">\r
        <div class="loading-progress-fill" id="loading-progress-fill"></div>\r
      </div>\r
      <div class="loading-progress-text" id="loading-progress-text">0%</div>\r
    </div>\r
    <div class="loading-status" id="loading-status">Initializing...</div>\r
  </div>\r
</div>\r
<!-- Sidebar for File/App Actions -->\r
<div id="sidebar-overlay"></div>\r
<aside id="sidebar" role="complementary" aria-label="Application settings and controls">\r
<div class="sidebar-container">\r
<div class="app-title">Student Notation</div>\r
</div>\r
<div class="sidebar-container">\r
<button class="sidebar-button" id="save-as-button" title="Save As"><img src="assets/sidebar/saveAs.svg" alt="Save As"><span class="sidebar-button-text">Save As</span></button>\r
<button class="sidebar-button" id="import-button" title="Open"><img src="assets/sidebar/open.svg" alt="Open"><span class="sidebar-button-text">Open</span></button>\r
<button class="sidebar-button" id="print-button" title="Print"><img src="assets/sidebar/print.svg" alt="Print"><span class="sidebar-button-text">Print</span></button>\r
<button class="sidebar-button" id="reset-canvas-button" title="New File"><img src="assets/sidebar/newPage.svg" alt="New Page"><span class="sidebar-button-text">New Page</span></button>\r
</div>\r
<div class="sidebar-container">\r
<h4 class="sidebar-section-header">Handoff</h4>\r
<button class="sidebar-button" id="take-to-singing-trainer-button" title="Take to Singing Trainer">\r
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\r
<path d="M7 17L17 7"/><path d="M7 7h10v10"/>\r
</svg>\r
<span class="sidebar-button-text">Take to Singing Trainer</span></button>\r
</div>\r
<div class="sidebar-container">\r
<button class="sidebar-button" id="hide-drumgrid-toggle" title="Toggle Drum Grid"><img src="assets/sidebar/hideDrums.svg" alt="Toggle Drum Grid"><span class="sidebar-button-text">Hide Drum Grid</span></button>\r
<button class="sidebar-button" id="hide-buttongrid-toggle" title="Toggle Button Grid"><img src="assets/sidebar/hideAnalysis.svg" alt="Toggle Button Grid"><span class="sidebar-button-text">Hide Button Grid</span></button>\r
<div class="sidebar-legend-toggle-row" role="group" aria-label="Legend visibility">\r
  <button class="sidebar-toggle-button" id="hide-leftlegend-toggle" type="button">Hide Left Legend</button>\r
  <button class="sidebar-toggle-button" id="hide-rightlegend-toggle" type="button">Hide Right Legend</button>\r
</div>\r
</div>\r
<div class="sidebar-container">\r
<h4 class="sidebar-section-header">Long Notes Style</h4>\r
<div class="toggle-button-group"><button class="sidebar-toggle-button active" id="long-note-style1-btn">Circle & Tails</button><button class="sidebar-toggle-button" id="long-note-style2-btn">Stadium</button></div>\r
</div>\r
<div class="sidebar-container">\r
<h4 class="sidebar-section-header">Playhead</h4>\r
<div class="toggle-button-group"><button class="sidebar-toggle-button active" id="playhead-mode-cursor-btn">Cursor Playhead</button><button class="sidebar-toggle-button" id="playhead-mode-microbeat-btn">Pulsing Microbeat</button><button class="sidebar-toggle-button" id="playhead-mode-macrobeat-btn">Pulsing Macrobeat</button></div>\r
</div>\r
</aside>\r
<main id="app-container" role="main">\r
  <!-- Toolbar Container -->\r
  <nav id="toolbar" role="navigation" aria-label="Music notation tools">\r
    <!-- Primary Toolbar -->\r
    <div id="toolbar-primary" class="toolbar-primary">\r
        <div class="primary-toolbar-grid-5x5">\r
            <!-- Row 1: settings, volume, blue notes -->\r
            <button class="toolkit-icon-button" id="settings-button" title="Settings"><img src="assets/icons/settings.svg" alt="Settings"></button>\r
            <div id="volume-control-wrapper">\r
                <button class="toolkit-icon-button" id="volume-icon-button" aria-label="Volume" title="Volume"><img src="assets/icons/volume.svg" alt="Volume"></button>\r
                <div id="volume-popup">\r
                    <input type="range" id="vertical-volume-slider" orient="vertical" min="0" max="100" value="70" step="1" />\r
                </div>\r
            </div>\r
            <div class="note circle-note" data-type="circle" data-color="#4a90e2"></div>\r
            <div class="note oval-note" data-type="oval" data-color="#4a90e2"></div>\r
            <div class="note diamond-note" data-type="diamond" data-color="#4a90e2" aria-label="Sixteenth note jewel">\r
                <svg class="diamond-icon" viewBox="0 0 120 120" aria-hidden="true" focusable="false">\r
                    <path d="M60 5 L35 48.3 L35 71.7 L60 115 L85 71.7 L85 48.3 Z" />\r
                </svg>\r
            </div>\r
            <!-- Row 2: zoom in/out, black notes -->\r
            <button class="toolkit-icon-button" id="grid-zoom-in" title="Zoom In"><img src="assets/icons/zoomIn.svg" alt="Zoom In"></button>\r
            <button class="toolkit-icon-button" id="grid-zoom-out" title="Zoom Out"><img src="assets/icons/zoomOut.svg" alt="Zoom Out"></button>\r
            <div class="note circle-note" data-type="circle" data-color="#2d2d2d"></div>\r
            <div class="note oval-note" data-type="oval" data-color="#2d2d2d"></div>\r
            <div class="note diamond-note" data-type="diamond" data-color="#2d2d2d" aria-label="Sixteenth note jewel">\r
                <svg class="diamond-icon" viewBox="0 0 120 120" aria-hidden="true" focusable="false">\r
                    <path d="M60 5 L35 48.3 L35 71.7 L60 115 L85 71.7 L85 48.3 Z" />\r
                </svg>\r
            </div>\r
            <!-- Row 3: redo/undo, red notes -->\r
            <button class="toolkit-icon-button" id="redo-button" title="Redo"><img src="assets/icons/redo.svg" alt="Redo"></button>\r
            <button class="toolkit-icon-button" id="undo-button" title="Undo"><img src="assets/icons/undo.svg" alt="Undo"></button>\r
            <div class="note circle-note" data-type="circle" data-color="#d66573"></div>\r
            <div class="note oval-note" data-type="oval" data-color="#d66573"></div>\r
            <div class="note diamond-note" data-type="diamond" data-color="#d66573" aria-label="Sixteenth note jewel">\r
                <svg class="diamond-icon" viewBox="0 0 120 120" aria-hidden="true" focusable="false">\r
                    <path d="M60 5 L35 48.3 L35 71.7 L60 115 L85 71.7 L85 48.3 Z" />\r
                </svg>\r
            </div>\r
            <!-- Row 4: clear/eraser, green notes -->\r
            <button class="toolkit-icon-button" id="clear-button" title="Clear"><img src="assets/icons/clear.svg" alt="Clear"></button>\r
            <button class="toolkit-icon-button eraser-button" id="eraser-tool-button" title="Eraser">\r
                <img src="assets/icons/eraser.svg" alt="Eraser" class="eraser-icon">\r
            </button>\r
            <div class="note circle-note" data-type="circle" data-color="#68a03f"></div>\r
            <div class="note oval-note" data-type="oval" data-color="#68a03f"></div>\r
            <div class="note diamond-note" data-type="diamond" data-color="#68a03f" aria-label="Sixteenth note jewel">\r
                <svg class="diamond-icon" viewBox="0 0 120 120" aria-hidden="true" focusable="false">\r
                    <path d="M60 5 L35 48.3 L35 71.7 L60 115 L85 71.7 L85 48.3 Z" />\r
                </svg>\r
            </div>\r
            <!-- Row 5: lasso/marker shortcuts, playback controls -->\r
            <button class="toolkit-icon-button" id="lasso-shortcut-button" title="Lasso Tool">\r
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="3 2">\r
                    <ellipse cx="12" cy="12" rx="8" ry="6" transform="rotate(-15 12 12)"/>\r
                </svg>\r
            </button>\r
            <button class="toolkit-icon-button" id="marker-shortcut-button" title="Marker Tool">\r
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                    <path d="M18 2L6 14l-2 6 6-2L22 6l-4-4z"/>\r
                    <line x1="14" y1="6" x2="18" y2="10"/>\r
                </svg>\r
            </button>\r
            <button class="toolkit-icon-button" id="play-button" title="Play"><img src="assets/icons/play.svg" alt="Play"></button>\r
            <button class="toolkit-icon-button" id="stop-button" title="Stop"><img src="assets/icons/stop.svg" alt="Stop"></button>\r
            <button class="toolkit-icon-button" id="loop-button" title="Loop"><img src="assets/icons/loop.svg" alt="Loop"></button>\r
        </div>\r
    </div>\r
    <!-- Secondary Toolbar -->\r
    <div id="toolbar-secondary" class="toolbar-secondary">\r
        <div class="tab-sidebar">\r
            <button class="tab-button" data-tab="timbre">Timbre</button>\r
            <button class="tab-button" data-tab="pitch">Pitch</button>\r
            <button class="tab-button" data-tab="rhythm">Rhythm</button>\r
        </div>\r
        <div class="tab-content">\r
            <!-- Timbre Tab -->\r
            <div class="tab-panel" id="timbre-panel">\r
                <!-- Presets/Effects Section (Separate) -->\r
                <div class="control-section preset-effects-container">\r
                    <div class="preset-effects-controls">\r
                            <div class="preset-effects-tabs">\r
                                <button class="preset-tab-button active" data-preset-tab="presets">Presets</button>\r
                                <button class="preset-tab-button" data-preset-tab="effects">Effects</button>\r
                            </div>\r
                            <div class="preset-effects-content">\r
                                <!-- Presets Tab -->\r
                                <div class="preset-tab-panel active" id="presets-panel">\r
                            <div class="preset-content-box">\r
                                <div class="preset-grid" id="preset-buttons">\r
                                    <div class="preset-column">\r
                                        <button class="preset-button" id="preset-sine">Sine</button>\r
                                        <button class="preset-button" id="preset-triangle">Triangle</button>\r
                                        <button class="preset-button" id="preset-square">Square</button>\r
                                        <button class="preset-button" id="preset-sawtooth">Sawtooth</button>\r
                                    </div>\r
                                    <div class="preset-column">\r
                                        <button class="preset-button" id="preset-piano">Piano</button>\r
                                        <button class="preset-button" id="preset-marimba">Marimba</button>\r
                                        <button class="preset-button" id="preset-woodwind">Woodwind</button>\r
                                        <button class="preset-button" id="preset-strings">Strings</button>\r
                                    </div>\r
                                </div>\r
                            </div>\r
                        </div>\r
                        <!-- Effects Tab -->\r
                        <div class="preset-tab-panel" id="effects-panel">\r
                            <div class="effects-content-box">\r
                                <div class="position-controls-container">\r
                                    <div class="position-control-group">\r
                                        <h5 class="position-label">Delay</h5>\r
                                        <div class="position-component-wrapper">\r
                                            <div class="position-component" id="delay-position"></div>\r
                                            <div id="delay-mix-wrapper"></div>\r
                                        </div>\r
                                        <div class="position-axis-labels" data-axis-x="Time" data-axis-y="Echoes"></div>\r
                                    </div>\r
                                    <div class="position-control-group">\r
                                        <h5 class="position-label">Vibrato</h5>\r
                                        <div class="position-component-wrapper">\r
                                            <div class="position-component" id="vibrato-position"></div>\r
                                            <div id="vibrato-mix-wrapper"></div>\r
                                        </div>\r
                                        <div class="position-axis-labels" data-axis-x="Speed" data-axis-y="Span"></div>\r
                                    </div>\r
                                    <div class="position-control-group">\r
                                        <h5 class="position-label">Tremolo</h5>\r
                                        <div class="position-component-wrapper">\r
                                            <div class="position-component" id="tremolo-position"></div>\r
                                            <div id="tremolo-mix-wrapper"></div>\r
                                        </div>\r
                                        <div class="position-axis-labels" data-axis-x="Speed" data-axis-y="Span"></div>\r
                                    </div>\r
                                </div>\r
                            </div>\r
                        </div>                        \r
                        <div class="effect-controls-container" id="effect-controls" style="display: none;">\r
                            <!-- Effect controls will be dynamically inserted here for data synchronization -->\r
                        </div>\r
                            </div>\r
                    </div>\r
                </div>\r
                <div class="control-section filter-container">\r
                    <!-- Row 1, Col 1: Blend slider -->\r
                    <div class="blend-slider-container"><div id="blend-slider-container"><div class="filter-blend-thumb" id="thumb-b" tabindex="0">B</div></div></div>\r
                    <!-- Row 2, Col 1: Bins grid (appended via JS) -->\r
                    <div class="filter-bins-wrapper"></div>\r
                    <!-- Row 3, Col 1: Cutoff slider -->\r
                    <div id="cutoff-slider-container"><div class="filter-cutoff-thumb" id="thumb-c" tabindex="0">C</div></div>\r
                    <!-- Row 2, Col 2: Vertical M slider (appended via JS) -->\r
                    <div class="filter-vertical-blend-wrapper"></div>\r
                </div>\r
                <div class="control-section adsr-container">\r
                    <!-- Row 1, Col 1: ADSR graph -->\r
                    <div class="adsr-graph-wrapper"><div id="adsr-envelope"></div></div>\r
                    <!-- Row 1, Col 2: Sustain slider -->\r
                    <div class="sustain-slider-wrapper"><div id="sustain-slider-track"><div id="sustain-slider-thumb" tabindex="0">S</div></div></div>\r
                    <!-- Row 2, Col 1: ADR slider -->\r
                    <div id="multi-thumb-slider-container"><div class="time-slider-thumb" id="thumb-a" tabindex="0">A</div><div class="time-slider-thumb" id="thumb-d" tabindex="0">D</div><div class="time-slider-thumb" id="thumb-r" tabindex="0">R</div></div>\r
                </div>\r
                  <!-- Waveform Section (Separate) -->\r
                  <div class="control-section">\r
                      <div class="waveform-section">\r
                          <div class="waveform-content-box">\r
                              <div class="waveform-display-wrapper">\r
                                  <canvas id="static-waveform-canvas"></canvas>\r
                                  <div class="waveform-speed-controls">\r
                                      <button class="waveform-speed-btn" data-speed="50">50%</button>\r
                                      <button class="waveform-speed-btn" data-speed="10">10%</button>\r
                                  </div>\r
                              </div>\r
                          </div>\r
                      </div>\r
                  </div>\r
              </div>\r
              <!-- Pitch Tab -->\r
            <div class="tab-panel" id="pitch-panel">\r
                <div class="control-section pitch-tabs-container">\r
                    <div class="pitch-tabs">\r
                        <button class="pitch-tab-button active" data-pitch-tab="range">Range</button>\r
                        <button class="pitch-tab-button" data-pitch-tab="chords">Chords</button>\r
                        <button class="pitch-tab-button" data-pitch-tab="draw">Draw</button>\r
                    </div>\r
                    <div class="pitch-tab-content">\r
                        <div class="pitch-tab-panel active" id="range-panel">\r
                            <div class="range-content-box">\r
                                <div class="range-layout">\r
                                   <div class="range-panel-section modes-section">\r
                                       <!-- <h4 class="panel-section-title">Modes</h4> -->\r
                                       <div class="tonic-modes-container">\r
                                           <div class="tonic-modes-grid">\r
                                               <button class="tonic-mode-button" data-tonic="1">\r
                                                   <img src="assets/tabicons/tonicShape_1.svg" alt="Major" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Major</span>\r
                                               </button>\r
                                               <button class="tonic-mode-button" data-tonic="2">\r
                                                   <img src="assets/tabicons/tonicShape_2.svg" alt="Dorian" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Dorian</span>\r
                                               </button>\r
                                               <button class="tonic-mode-button" data-tonic="3">\r
                                                   <img src="assets/tabicons/tonicShape_3.svg" alt="Phrygian" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Phrygian</span>\r
                                               </button>\r
                                               <button class="tonic-mode-button" data-tonic="4">\r
                                                   <img src="assets/tabicons/tonicShape_4.svg" alt="Lydian" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Lydian</span>\r
                                               </button>\r
                                               <button class="tonic-mode-button" data-tonic="5">\r
                                                   <img src="assets/tabicons/tonicShape_5.svg" alt="Mixolydian" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Mixolydian</span>\r
                                               </button>\r
                                               <button class="tonic-mode-button" data-tonic="6">\r
                                                   <img src="assets/tabicons/tonicShape_6.svg" alt="Minor" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Minor</span>\r
                                               </button>\r
                                               <button class="tonic-mode-button" data-tonic="7">\r
                                                   <img src="assets/tabicons/tonicShape_7.svg" alt="Locrian" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Locrian</span>\r
                                               </button>\r
                                           </div>\r
                                       </div>\r
                                   </div>\r
                                   <div class="range-panel-section degrees-section">\r
                                       <!-- <h4 class="panel-section-title">Degrees</h4> -->\r
                                       <div class="degree-visibility-toggle-container">\r
                                           <button class="degree-visibility-button" id="degree-visibility-toggle" type="button">\r
                                               Show Degrees\r
                                           </button>\r
                                       </div>\r
                                       <div class="degree-mode-toggle-container" id="degree-mode-toggle">\r
                                           <button class="degree-mode-button" data-mode="diatonic" type="button">Scale</button>\r
                                           <button class="degree-mode-button" data-mode="modal" type="button">Mode</button>\r
                                       </div>\r
                                       <label class="checkbox-label">\r
                                            <input type="checkbox" id="focus-colours-toggle">\r
                                            <span class="checkbox-text">Focus Colours</span>\r
                                        </label>\r
                                   </div>\r
                                   <div class="range-panel-section wheels-section">\r
                                       <!-- <h4 class="panel-section-title">Select Range</h4> -->\r
                                       <div class="clef-wheels-wrapper">\r
                                           <div class="clef-picker-column">\r
                                               <div class="clef-wheel" id="clef-top-wheel" tabindex="0" aria-label="Select top note">\r
                                                   <div class="clef-wheel-viewport">\r
                                                       <div class="clef-wheel-options"></div>\r
                                                   </div>\r
                                                   <div class="clef-wheel-overlay"></div>\r
                                               </div>\r
                                           </div>\r
                                           <div class="clef-picker-column">\r
                                               <div class="clef-wheel" id="clef-bottom-wheel" tabindex="0" aria-label="Select bottom note">\r
                                                   <div class="clef-wheel-viewport">\r
                                                       <div class="clef-wheel-options"></div>\r
                                                   </div>\r
                                                   <div class="clef-wheel-overlay"></div>\r
                                               </div>\r
                                           </div>\r
                                       </div>\r
                                   </div>\r
                                   <div class="range-panel-section presets-section">\r
                                       <!-- <h4 class="panel-section-title">Presets</h4> -->\r
                                       <div class="clef-presets-column">\r
                                           <div class="clef-preset-buttons">\r
                                               <button class="toolkit-button clef-preset-button" id="clef-full-range-button" type="button">\r
                                                   Full Range\r
                                               </button>\r
                                               <button class="toolkit-button clef-preset-button" id="clef-treble-button" type="button">\r
                                                   Treble\r
                                               </button>\r
                                               <button class="toolkit-button clef-preset-button" id="clef-alto-button" type="button">\r
                                                   Alto\r
                                               </button>\r
                                               <button class="toolkit-button clef-preset-button" id="clef-bass-button" type="button">\r
                                                   Bass\r
                                               </button>\r
                                               <button class="toolkit-button clef-preset-button" id="clef-voice1-button" type="button">\r
                                                   Voice I\r
                                               </button>\r
                                               <button class="toolkit-button clef-preset-button" id="clef-voice2-button" type="button">\r
                                                   Voice II\r
                                               </button>\r
                                               <button class="toolkit-button clef-preset-button" id="clef-voice3-button" type="button">\r
                                                   Voice III\r
                                               </button>\r
                                           </div>\r
                                       </div>\r
                                   </div>\r
                                </div>\r
                        </div>\r
                    </div>\r
                        <div class="pitch-tab-panel" id="chords-panel">\r
            <div class="chords-content-box">\r
                <div class="chords-layout">\r
                    <div class="chords-panel-section intervals-grid-section">\r
                        <h4 class="panel-section-title">Intervals</h4>\r
                        <div class="intervals-grid-column">\r
                            <div class="harmony-preset-grid intervals-4x4-grid">\r
                                <button class="harmony-preset-button">M6</button>\r
                                <button class="harmony-preset-button">A6</button>\r
                                <button class="harmony-preset-button">m7</button>\r
                                <button class="harmony-preset-button">M7</button>\r
                                <button class="harmony-preset-button">d5</button>\r
                                <button class="harmony-preset-button">P5</button>\r
                                <button class="harmony-preset-button">A5</button>\r
                                <button class="harmony-preset-button">m6</button>\r
                                <button class="harmony-preset-button">m3</button>\r
                                <button class="harmony-preset-button">M3</button>\r
                                <button class="harmony-preset-button">P4</button>\r
                                <button class="harmony-preset-button">A4</button>\r
                                <button class="harmony-preset-button">U</button>\r
                                <button class="harmony-preset-button">m2</button>\r
                                <button class="harmony-preset-button">M2</button>\r
                                <button class="harmony-preset-button">A2</button>\r
                            </div>\r
                        </div>\r
                    </div>\r
                    <div class="chords-panel-section unified-position-section">\r
                        <h4 class="panel-section-title">Position</h4>\r
                        <div class="unified-position-column">\r
                            <div class="unified-position-toggle" id="unified-position-toggle">\r
                                <div class="left-labels">\r
                                    <span class="state-label" data-step="0">Asc.</span>\r
                                    <span class="state-label" data-step="1">Desc.</span>\r
                                </div>\r
                                <div class="toggle-track">\r
                                    <div class="unified-slider"></div>\r
                                </div>\r
                                <div class="right-labels">\r
                                    <span class="state-label" data-step="0">Root</span>\r
                                    <span class="state-label" data-step="1">1st</span>\r
                                    <span class="state-label" data-step="2">2nd</span>\r
                                    <span class="state-label" data-step="3">3rd</span>\r
                                    <span class="state-label" data-step="4">4th</span>\r
                                    <span class="state-label" data-step="5">5th</span>\r
                                </div>\r
                            </div>\r
                        </div>\r
                    </div>\r
                    <div class="chords-panel-section chords-grid-section">\r
                        <h4 class="panel-section-title">Chords</h4>\r
                        <div class="chords-grid-column">\r
                            <div class="harmony-preset-grid chords-grid chords-grid-6col" id="chords-preset-grid">\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;]" title="Major triad">X</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;]" title="Minor triad">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5d&quot;]" title="Diminished triad">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;6m&quot;]" title="Augmented triad">X+</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7m&quot;]" title="Dominant 7">X</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;7m&quot;]" title="Minor 7">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7M&quot;]" title="Major 7">Xmaj</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5d&quot;, &quot;7m&quot;]" title="Half-diminished 7"></button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5d&quot;, &quot;6M&quot;]" title="Fully diminished 7">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;6M&quot;]" title="Major 6">X</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;2M&quot;, &quot;5P&quot;]" title="Suspended 2">Xsus2</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;4P&quot;, &quot;5P&quot;]" title="Suspended 4">Xsus4</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;7M&quot;]" title="Minor-major 7">xmaj</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;9M&quot;]" title="Major add 9">Xadd9</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;9M&quot;]" title="Minor add 9">xadd9</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;6M&quot;, &quot;9M&quot;]" title="Major 6/9">X6/9</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7m&quot;, &quot;9M&quot;]" title="Dominant 9">X9</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7m&quot;, &quot;9M&quot;, &quot;11P&quot;]" title="Dominant 11">X11</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7m&quot;, &quot;9M&quot;, &quot;13M&quot;]" title="Dominant 13">X13</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7M&quot;, &quot;9M&quot;]" title="Major 9">Xmaj9</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;7m&quot;, &quot;9M&quot;]" title="Minor 9">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;6M&quot;]" title="Minor 6">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;7m&quot;, &quot;9M&quot;, &quot;11P&quot;]" title="Minor 11">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7M&quot;, &quot;11A&quot;]" title="Major 7 sharp 11 (Lydian)">Xmaj711</button>\r
                            </div>\r
                        </div>\r
                    </div>\r
                </div>\r
            </div>\r
        </div>\r
                        <div class="pitch-tab-panel" id="draw-panel">\r
                            <div class="draw-content-box">\r
                                <div class="draw-layout-grid">\r
                                    <!-- Arrow Tool Panel -->\r
                                    <div class="draw-tool-panel" id="draw-arrow-controls" data-draw-tool="arrow">\r
                                        <div class="draw-tool-header">\r
                                            <button class="draw-tool-button" data-draw-tool="arrow" title="Arrow Tool">\r
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                    <line x1="4" y1="20" x2="20" y2="4"/>\r
                                                    <polyline points="14,4 20,4 20,10"/>\r
                                                </svg>\r
                                            </button>\r
                                        </div>\r
                                        <div class="draw-tool-options" id="arrow-tool-options">\r
                                            <div class="draw-option-group">\r
                                                <div class="draw-toolbar-row">\r
                                                    <!-- Stroke weight popup -->\r
                                                    <div class="draw-popup-trigger">\r
                                                        <button class="draw-toolbar-button" title="Stroke width">\r
                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                                <line x1="4" y1="12" x2="20" y2="12"/>\r
                                                            </svg>\r
                                                        </button>\r
                                                        <div class="draw-popup-menu">\r
                                                            <div class="draw-option-label">Stroke</div>\r
                                                            <input type="range" id="arrow-stroke-weight" min="1" max="20" value="4" aria-label="Arrow stroke weight">\r
                                                        </div>\r
                                                    </div>\r
\r
                                                    <!-- Line style popup -->\r
                                                    <div class="draw-popup-trigger">\r
                                                        <button class="draw-toolbar-button" title="Line style">\r
                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                                <line x1="4" y1="8" x2="20" y2="8" stroke-dasharray="4 3"/>\r
                                                                <line x1="4" y1="16" x2="20" y2="16"/>\r
                                                            </svg>\r
                                                        </button>\r
                                                        <div class="draw-popup-menu">\r
                                                            <div class="draw-option-label">Line Style</div>\r
                                                            <div class="draw-button-group">\r
                                                                <button class="draw-option-button active" data-line-style="solid">Solid</button>\r
                                                                <button class="draw-option-button" data-line-style="dashed">Dashed</button>\r
                                                            </div>\r
                                                        </div>\r
                                                    </div>\r
                                                </div>\r
                                                <div class="draw-toolbar-row">\r
                                                    <!-- Left arrowhead popup -->\r
                                                    <div class="draw-popup-trigger">\r
                                                        <button class="draw-toolbar-button" id="arrow-start-head-trigger" title="Start head">\r
                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                                <polyline points="9,5 3,12 9,19"/>\r
                                                                <line x1="3" y1="12" x2="21" y2="12"/>\r
                                                            </svg>\r
                                                        </button>\r
                                                                <div class="draw-popup-menu">\r
                                                                    <div class="draw-option-label">Start</div>\r
                                                                    <div class="draw-button-group">\r
                                                                    <button class="draw-option-button active" data-arrow-start="none">No head</button>\r
                                                                    <button class="draw-option-button" data-arrow-start="filled-arrow">Arrow</button>\r
                                                                    </div>\r
                                                                </div>\r
                                                            </div>\r
                                                    <!-- Swap heads -->\r
                                                    <button class="draw-toolbar-button" id="arrow-swap-heads" title="Swap heads">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <polyline points="9 5 15 5 15 11"/>\r
                                                            <polyline points="15 19 9 19 9 13"/>\r
                                                            <line x1="9" y1="5" x2="5" y2="9"/>\r
                                                            <line x1="15" y1="19" x2="19" y2="15"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <!-- Right arrowhead popup -->\r
                                                    <div class="draw-popup-trigger">\r
                                                        <button class="draw-toolbar-button" id="arrow-end-head-trigger" title="End head">\r
                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                                <polyline points="15,5 21,12 15,19"/>\r
                                                                <line x1="3" y1="12" x2="21" y2="12"/>\r
                                                            </svg>\r
                                                        </button>\r
                                                                <div class="draw-popup-menu">\r
                                                                    <div class="draw-option-label">End</div>\r
                                                                    <div class="draw-button-group">\r
                                                                    <button class="draw-option-button active" data-arrow-end="filled-arrow">Arrow</button>\r
                                                                    <button class="draw-option-button" data-arrow-end="none">No head</button>\r
                                                                    </div>\r
                                                                    <div class="draw-option-label">Head Size</div>\r
                                                                    <input type="range" id="arrow-head-size" min="8" max="32" value="12" aria-label="Arrowhead size">\r
                                                                </div>\r
                                                            </div>\r
                                                </div>\r
                                            </div>\r
                                        </div>\r
                                    </div>\r
                                    <!-- Text Tool Panel -->\r
                                    <div class="draw-tool-panel" id="draw-text-controls" data-draw-tool="text">\r
                                        <div class="draw-tool-header">\r
                                            <button class="draw-tool-button" data-draw-tool="text" title="Text Tool">\r
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                    <polyline points="4,7 4,4 20,4 20,7"/>\r
                                                    <line x1="12" y1="4" x2="12" y2="20"/>\r
                                                    <line x1="9" y1="20" x2="15" y2="20"/>\r
                                                </svg>\r
                                            </button>\r
                                        </div>\r
                                        <div class="draw-tool-options" id="text-tool-options">\r
                                            <div class="draw-option-group draw-toolbar-row">\r
                                                <!-- Size popup -->\r
                                                <div class="draw-popup-trigger">\r
                                                    <button class="draw-toolbar-button" title="Text size">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <path d="M4 18h16"/>\r
                                                            <path d="M8 18l4-12 4 12"/>\r
                                                            <path d="M10 12h4"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <div class="draw-popup-menu">\r
                                                        <div class="draw-option-label">Size (px)</div>\r
                                                        <input type="number" id="text-size-input" min="8" max="72" value="16" aria-label="Text size (px)">\r
                                                    </div>\r
                                                </div>\r
                                                <!-- Colour popup -->\r
                                                <div class="draw-popup-trigger">\r
                                                    <button class="draw-toolbar-button" title="Text colour">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <path d="M12 3l6 16"/>\r
                                                            <path d="M6 19l6-16"/>\r
                                                            <path d="M10 12h4"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <div class="draw-popup-menu">\r
                                                        <div class="draw-option-label">Colour</div>\r
                                                        <div class="draw-color-picker">\r
                                                            <button class="draw-color-button active" data-color="#000000" style="background-color: #000000;" aria-label="Black text"></button>\r
                                                            <button class="draw-color-button" data-color="#4a90e2" style="background-color: #4a90e2;" aria-label="Blue text"></button>\r
                                                            <button class="draw-color-button" data-color="#d66573" style="background-color: #d66573;" aria-label="Red text"></button>\r
                                                            <button class="draw-color-button" data-color="#68a03f" style="background-color: #68a03f;" aria-label="Green text"></button>\r
                                                        </div>\r
                                                    </div>\r
                                                </div>\r
                                                <!-- Style buttons -->\r
                                                <div class="text-style-rows">\r
                                                    <div class="draw-button-group">\r
                                                        <button class="draw-option-button" data-text-style="bold">B</button>\r
                                                        <button class="draw-option-button" data-text-style="italic">I</button>\r
                                                        <button class="draw-option-button" data-text-style="underline">U</button>\r
                                                    </div>\r
                                                    <div class="draw-button-group">\r
                                                        <button class="draw-option-button" data-text-style="background">Bg</button>\r
                                                        <button class="draw-option-button" data-text-style="superscript">x<sup>2</sup></button>\r
                                                        <button class="draw-option-button" data-text-style="subscript">x<sub>2</sub></button>\r
                                                    </div>\r
                                                </div>\r
                                            </div>\r
                                        </div>\r
                                    </div>\r
                                    <!-- Marker Tool Panel -->\r
                                    <div class="draw-tool-panel" id="draw-marker-controls" data-draw-tool="marker">\r
                                        <div class="draw-tool-header">\r
                                            <button class="draw-tool-button" data-draw-tool="marker" title="Marker Tool">\r
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                    <!-- Pointed marker tip -->\r
                                                    <path d="M18 2L6 14l-2 6 6-2L22 6l-4-4z"/>\r
                                                    <line x1="10" y1="18" x2="6" y2="14"/>\r
                                                </svg>\r
                                            </button>\r
                                        </div>\r
                                        <div class="draw-tool-options" id="marker-tool-options">\r
                                            <div class="draw-option-group draw-toolbar-row">\r
                                                <!-- Size popup -->\r
                                                <div class="draw-popup-trigger">\r
                                                    <button class="draw-toolbar-button" title="Marker size">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <path d="M6 19l12-14"/>\r
                                                            <path d="M6 19l-2 4 4-2"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <div class="draw-popup-menu">\r
                                                        <div class="draw-option-label">Size</div>\r
                                                        <input type="range" id="marker-size-input" min="2" max="20" value="6" aria-label="Marker size">\r
                                                    </div>\r
                                                </div>\r
                                                <!-- Colours popup -->\r
                                                <div class="draw-popup-trigger">\r
                                                    <button class="draw-toolbar-button" title="Marker colour">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <path d="M19 4l-7 7"/>\r
                                                            <path d="M5 20l3.5-1.5"/>\r
                                                            <path d="M16 7l1.5 1.5"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <div class="draw-popup-menu">\r
                                                        <div class="draw-option-label">Colours</div>\r
                                                        <div class="draw-color-picker">\r
                                                            <button class="draw-color-button" data-color="#4a90e2" style="background-color: #4a90e2;" aria-label="Blue marker"></button>\r
                                                            <button class="draw-color-button" data-color="#2d2d2d" style="background-color: #2d2d2d;" aria-label="Black marker"></button>\r
                                                            <button class="draw-color-button" data-color="#d66573" style="background-color: #d66573;" aria-label="Red marker"></button>\r
                                                            <button class="draw-color-button" data-color="#68a03f" style="background-color: #68a03f;" aria-label="Green marker"></button>\r
                                                        </div>\r
                                                    </div>\r
                                                </div>\r
                                            </div>\r
                                        </div>\r
                                    </div>\r
                                    <!-- Highlighter Tool Panel -->\r
                                    <div class="draw-tool-panel" id="draw-highlighter-controls" data-draw-tool="highlighter">\r
                                        <div class="draw-tool-header">\r
                                            <button class="draw-tool-button" data-draw-tool="highlighter" title="Highlighter Tool">\r
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity="0.5">\r
                                                    <!-- Flat highlighter head -->\r
                                                    <rect x="3" y="3" width="4" height="18" rx="1"/>\r
                                                    <path d="M7 5h12l-2 14H7z"/>\r
                                                </svg>\r
                                            </button>\r
                                        </div>\r
                                        <div class="draw-tool-options" id="highlighter-tool-options">\r
                                            <div class="draw-option-group draw-toolbar-row">\r
                                                <!-- Size popup -->\r
                                                <div class="draw-popup-trigger">\r
                                                    <button class="draw-toolbar-button" title="Highlighter size">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <rect x="5" y="5" width="10" height="10" rx="2"/>\r
                                                            <path d="M9 15l-2 4"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <div class="draw-popup-menu">\r
                                                        <div class="draw-option-label">Size</div>\r
                                                        <input type="range" id="highlighter-size-input" min="4" max="30" value="10" aria-label="Highlighter size">\r
                                                    </div>\r
                                                </div>\r
                                                <!-- Colours popup -->\r
                                                <div class="draw-popup-trigger">\r
                                                    <button class="draw-toolbar-button" title="Highlighter colour">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <rect x="7" y="7" width="10" height="10" rx="2"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <div class="draw-popup-menu">\r
                                                        <div class="draw-option-label">Colours</div>\r
                                                        <div class="draw-color-picker">\r
                                                            <button class="draw-color-button" data-color="#9fc5ff" style="background-color: #9fc5ff;" aria-label="Light blue highlighter"></button>\r
                                                            <button class="draw-color-button" data-color="#c2c2c2" style="background-color: #c2c2c2;" aria-label="Gray highlighter"></button>\r
                                                            <button class="draw-color-button" data-color="#ffd166" style="background-color: #ffd166;" aria-label="Yellow highlighter"></button>\r
                                                        </div>\r
                                                    </div>\r
                                                </div>\r
                                            </div>\r
                                        </div>\r
                                    </div>\r
                                    <!-- Lasso Tool Panel -->\r
                                    <div class="draw-tool-panel" id="draw-lasso-controls" data-draw-tool="lasso">\r
                                        <div class="draw-tool-header">\r
                                            <button class="draw-tool-button" data-draw-tool="lasso" title="Lasso Select">\r
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="3 2">\r
                                                    <ellipse cx="12" cy="12" rx="8" ry="6" transform="rotate(-15 12 12)"/>\r
                                                </svg>\r
                                            </button>\r
                                        </div>\r
                                        <div class="draw-tool-options" id="lasso-tool-options">\r
                                            <div class="draw-option-group draw-toolbar-row">\r
                                                <div class="draw-option-help">\r
                                                    Draw around notes to select and drag them as a group.\r
                                                </div>\r
                                            </div>\r
                                        </div>\r
                                    </div>\r
                                </div>\r
                            </div>\r
                        </div>\r
                    </div>\r
                </div>\r
            </div>\r
            <!-- Rhythm Tab -->\r
            <div class="tab-panel" id="rhythm-panel">\r
\r
                <!-- Stamps/Triplets Section (Separate) -->\r
                <div class="control-section rhythm-stamp-tabs-container">\r
                    <div class="rhythm-stamp-tabs-controls">\r
                        <div class="rhythm-tab-stamps">\r
                            <button class="rhythm-tab-button rhythm-stamp-tab-button active" data-rhythm-stamp-tab="sixteenth">Sixteenths</button>\r
                            <button class="rhythm-tab-button rhythm-stamp-tab-button" data-rhythm-stamp-tab="triplet">Triplets</button>\r
                        </div>\r
                        <div class="rhythm-stamp-tab-content">\r
                            <div class="rhythm-stamp-tab-panel active" id="sixteenth-stamps-panel">\r
                                <div id="sixteenth-stamps-toolbar-container" class="sixteenth-stamps-toolbar-container">\r
                                    <!-- Stamps toolbar will be rendered here by JavaScript -->\r
                                </div>\r
                            </div>\r
                            <div class="rhythm-stamp-tab-panel" id="triplet-stamps-panel">\r
                                <div id="triplet-stamps-toolbar-container" class="triplet-stamps-toolbar-container">\r
                                    <!-- Triplets toolbar will be rendered here by JavaScript -->\r
                                </div>\r
                            </div>\r
                        </div>\r
                    </div>\r
                </div>\r
                                <!-- Controls Section (Separate) -->\r
                <div class="control-section rhythm-controls-container">\r
                    <div class="rhythm-controls-section">\r
                        <button class="rhythm-tab-button rhythm-controls-tab-button active" disabled>Controls</button>\r
                        <div class="rhythm-controls-content-box">\r
                            <div class="tempo-content-box">\r
                                <div class="tempo-container">\r
                                    <div class="tempo-boxes-container">\r
                                        <div class="tempo-input-group tempo-row">\r
                                            <img src="assets/tabicons/eigthNote.svg" alt="Eighth Note Tempo" class="tempo-label-icon">\r
                                            <div id="eighth-note-tempo"></div>\r
                                        </div>\r
                                        <div class="tempo-input-group tempo-row">\r
                                            <img src="assets/tabicons/quarterNote.svg" alt="Quarter Note Tempo" class="tempo-label-icon">\r
                                            <div id="quarter-note-tempo"></div>\r
                                        </div>\r
                                        <div class="tempo-input-group tempo-row">\r
                                            <img src="assets/tabicons/dottedQuarterNote.svg" alt="Dotted Quarter Note Tempo" class="tempo-label-icon">\r
                                            <div id="dotted-quarter-tempo"></div>\r
                                        </div>\r
                                    </div>\r
                                    <div class="tempo-slider-container tempo-column-2">\r
                                        <input type="range" id="tempo-slider" min="30" max="240" value="90">\r
                                    </div>\r
                                </div>\r
                            </div>\r
                            <div class="rhythm-structure-container">\r
                                <div class="control-subsection">\r
                                    <h4>Add/Del Beat</h4>\r
                                    <div class="macrobeat-adjust-group">\r
                                        <button class="toolkit-button" id="macrobeat-decrease"></button>\r
                                        <button class="toolkit-button" id="macrobeat-increase">+</button>\r
                                    </div>\r
                                </div>\r
                                <div class="control-subsection">\r
                                    <h4>Pickup</h4>\r
                                    <div class="toggle-button-group"><button class="sidebar-toggle-button" id="anacrusis-on-btn">On</button><button class="sidebar-toggle-button" id="anacrusis-off-btn">Off</button></div>\r
                                </div>\r
                            </div>\r
                            <div class="modulation-container">\r
                                <div class="control-subsection">\r
                                    <h4>Modulation</h4>\r
                                    <div class="modulation-controls">\r
                                        <button class="toolkit-button modulation-ratio-btn" id="modulation-2-3-btn" data-ratio="2:3" title="Place 2:3 modulation marker (33% faster)">2:3 - 33% faster</button>\r
                                        <button class="toolkit-button modulation-ratio-btn" id="modulation-3-2-btn" data-ratio="3:2" title="Place 3:2 modulation marker (33% slower)">3:2 - 33% slower</button>\r
                                        <button class="toolkit-button" id="modulation-clear-btn" title="Clear all modulation markers">Clear</button>\r
                                    </div>\r
                                </div>\r
                            </div>\r
                        </div>\r
                    </div>\r
                </div>\r
            </div>\r
        </div>\r
    </div>\r
  </nav>\r
  <div id="canvas-container" role="region" aria-label="Musical notation canvas">\r
    <div id="canvas-content">\r
        <div id="grids-wrapper">\r
            <div id="button-grid">\r
                <div class="button-grid-left-cell">\r
                    <div class="left-cell-grid">\r
                        <div id="flat-toggle-btn" class="accidental-btn active" role="button" tabindex="0" aria-pressed="true"></div>\r
                        <div id="sharp-toggle-btn" class="accidental-btn active" role="button" tabindex="0" aria-pressed="true"></div>\r
                        <div id="hz-toggle-btn" class="accidental-btn" role="button" tabindex="0" aria-pressed="false">Hz</div>\r
                        <div id="spn-octave-toggle-btn" class="accidental-btn octave-toggle-btn active" role="button" tabindex="0" aria-pressed="true" title="Show SPN octave digits" aria-label="Toggle SPN octave digits">\r
                            <span class="octave-label">\r
                                A<span class="octave-digit">1</span>\r
                            </span>\r
                        </div>\r
                    </div>\r
                </div>\r
                <div class="button-grid-middle-cell">\r
                    <div id="beat-line-button-layer">\r
                        <div id="time-signature-row" class="beat-line-row"></div>\r
                        <div id="grouping-buttons-row" class="beat-line-row"></div>\r
                        <div id="boundary-buttons-row" class="beat-line-row"></div>\r
                    </div>\r
                </div>\r
                <div class="button-grid-right-cell">\r
                    <!-- Null/empty cell for alignment with pitch grid right legend -->\r
                </div>\r
            </div>\r
            <div id="pitch-grid-wrapper">\r
                <div id="pitch-grid-container">\r
                    <div id="grid-container">\r
                        <div id="pitch-canvas-wrapper">\r
                            <canvas id="legend-left-canvas"></canvas>\r
                            <canvas id="notation-grid"></canvas>\r
                            <canvas id="legend-right-canvas"></canvas>\r
                            <canvas id="playhead-canvas"></canvas>\r
                            <canvas id="hover-canvas"></canvas>\r
                        </div>\r
                    </div>\r
                </div>\r
            </div>\r
            <div id="grid-scrollbar-proxy" role="scrollbar" aria-label="Horizontal scroll for notation grids" tabindex="0">\r
                <div class="grid-scrollbar-inner"></div>\r
            </div>\r
            <div id="drum-grid-wrapper">\r
                <div class="drum-grid-left-cell">\r
                    <!-- Reserved for future drum legends/controls -->\r
                </div>\r
                <div class="drum-grid-middle-cell">\r
                    <div id="drum-canvas-wrapper">\r
                        <canvas id="drum-grid"></canvas>\r
                        <canvas id="drum-playhead-canvas"></canvas>\r
                        <canvas id="drum-hover-canvas"></canvas>\r
                    </div>\r
                </div>\r
                <div class="drum-grid-right-cell">\r
                    <!-- Placeholder for alignment with right legend spacing -->\r
                </div>\r
            </div>\r
        </div>\r
    </div>\r
</div>\r
</main>\r
<!-- Notification Overlay -->\r
<div id="notification-overlay">\r
    <div class="notification-modal">\r
        <div class="notification-header">\r
            <h3 class="notification-title">Notice</h3>\r
            <button class="notification-close"></button>\r
        </div>\r
        <div class="notification-message"></div>\r
        <div class="notification-actions">\r
            <button class="notification-button">OK</button>\r
        </div>\r
    </div>\r
</div>\r
<!-- ... (Print Preview Modal remains the same) ... -->\r
<div id="print-preview-overlay" class="hidden">\r
    <div id="print-preview-modal">\r
        <div class="print-preview-header">\r
            <h2>Print Preview</h2>\r
            <button id="print-close-button" class="close-button"></button>\r
        </div>\r
        <div class="print-preview-content">\r
            <div class="print-preview-canvas-wrapper">\r
                <canvas id="print-preview-canvas"></canvas>\r
                <canvas id="print-crop-overlay"></canvas>\r
            </div>\r
                <div class="print-preview-options">\r
                <div class="print-info-box">\r
                    <p>Use the crop handles on the preview to trim what gets sent to the printer.</p>\r
                </div>\r
                <h3>Layout</h3>\r
                <div class="print-option-row">\r
                    <label>Paper</label>\r
                    <select id="print-page-size" class="print-select">\r
                        <option value="letter">Letter (8.511)</option>\r
                        <option value="11x14">1114</option>\r
                        <option value="11x17">1117</option>\r
                    </select>\r
                </div>\r
                <div class="print-option-row">\r
                    <label>Orientation</label>\r
                    <button id="print-orientation-toggle" class="toggle-button">Landscape</button>\r
                </div>\r
                <div class="print-option-row">\r
                    <label>Buttons</label>\r
                    <button id="print-button-grid-toggle" class="toggle-button active">Include</button>\r
                </div>\r
                <div class="print-option-row">\r
                    <label>Drums</label>\r
                    <button id="print-drum-grid-toggle" class="toggle-button active">Include</button>\r
                </div>\r
                <div class="print-option-row">\r
                    <label>Left Legend</label>\r
                    <button id="print-left-legend-toggle" class="toggle-button active">Include</button>\r
                </div>\r
                <div class="print-option-row">\r
                    <label>Right Legend</label>\r
                    <button id="print-right-legend-toggle" class="toggle-button active">Include</button>\r
                </div>\r
                <div class="print-option-row">\r
                    <label>Color</label>\r
                    <button id="print-color-mode-toggle" class="toggle-button active">Color</button>\r
                </div>\r
            </div>\r
        </div>\r
        <div class="print-preview-footer">\r
            <button id="print-confirm-button" class="confirm-button">Print</button>\r
        </div>\r
    </div>\r
</div>\r
<div id="print-staging-area"></div>\r
\r
<!-- Svelte component mount points (headless components) -->\r
<!-- Toolbar bridges -->\r
<div data-svelte-component="playback-controls-bridge" style="display: none;"></div>\r
<div data-svelte-component="file-actions-bridge" style="display: none;"></div>\r
<div data-svelte-component="grid-controls-bridge" style="display: none;"></div>\r
<div data-svelte-component="modulation-bridge" style="display: none;"></div>\r
<div data-svelte-component="sidebar-bridge" style="display: none;"></div>\r
<div data-svelte-component="tool-selector-bridge" style="display: none;"></div>\r
<div data-svelte-component="audio-controls-bridge" style="display: none;"></div>\r
<!-- Tab management bridge -->\r
<div data-svelte-component="tab-management-bridge" style="display: none;"></div>\r
<!-- Modal bridges -->\r
<div data-svelte-component="print-preview-bridge" style="display: none;"></div>\r
`,J0="15.1.22",zp=(n,t,e)=>({endTime:t,insertTime:e,type:"exponentialRampToValue",value:n}),Xp=(n,t,e)=>({endTime:t,insertTime:e,type:"linearRampToValue",value:n}),Ud=(n,t)=>({startTime:t,type:"setValue",value:n}),Z0=(n,t,e)=>({duration:e,startTime:t,type:"setValueCurve",values:n}),tw=(n,t,{startTime:e,target:s,timeConstant:i})=>s+(t-s)*Math.exp((e-n)/i),jr=n=>n.type==="exponentialRampToValue",Kl=n=>n.type==="linearRampToValue",wi=n=>jr(n)||Kl(n),af=n=>n.type==="setValue",Gs=n=>n.type==="setValueCurve",ql=(n,t,e,s)=>{const i=n[t];return i===void 0?s:wi(i)||af(i)?i.value:Gs(i)?i.values[i.values.length-1]:tw(e,ql(n,t-1,i.startTime,s),i)},$p=(n,t,e,s,i)=>e===void 0?[s.insertTime,i]:wi(e)?[e.endTime,e.value]:af(e)?[e.startTime,e.value]:Gs(e)?[e.startTime+e.duration,e.values[e.values.length-1]]:[e.startTime,ql(n,t-1,e.startTime,i)],Pd=n=>n.type==="cancelAndHold",Nd=n=>n.type==="cancelScheduledValues",pi=n=>Pd(n)||Nd(n)?n.cancelTime:jr(n)||Kl(n)?n.endTime:n.startTime,Yp=(n,t,e,{endTime:s,value:i})=>e===i?i:0<e&&0<i||e<0&&i<0?e*(i/e)**((n-t)/(s-t)):0,jp=(n,t,e,{endTime:s,value:i})=>e+(n-t)/(s-t)*(i-e),N2=(n,t)=>{const e=Math.floor(t),s=Math.ceil(t);return e===s?n[e]:(1-(t-e))*n[e]+(1-(s-t))*n[s]},D2=(n,{duration:t,startTime:e,values:s})=>{const i=(n-e)/t*(s.length-1);return N2(s,i)},Ua=n=>n.type==="setTarget";class L2{constructor(t){this._automationEvents=[],this._currenTime=0,this._defaultValue=t}[Symbol.iterator](){return this._automationEvents[Symbol.iterator]()}add(t){const e=pi(t);if(Pd(t)||Nd(t)){const s=this._automationEvents.findIndex(r=>Nd(t)&&Gs(r)?r.startTime+r.duration>=e:pi(r)>=e),i=this._automationEvents[s];if(s!==-1&&(this._automationEvents=this._automationEvents.slice(0,s)),Pd(t)){const r=this._automationEvents[this._automationEvents.length-1];if(i!==void 0&&wi(i)){if(r!==void 0&&Ua(r))throw new Error("The internal list is malformed.");const o=r===void 0?i.insertTime:Gs(r)?r.startTime+r.duration:pi(r),A=r===void 0?this._defaultValue:Gs(r)?r.values[r.values.length-1]:r.value,a=jr(i)?Yp(e,o,A,i):jp(e,o,A,i),l=jr(i)?zp(a,e,this._currenTime):Xp(a,e,this._currenTime);this._automationEvents.push(l)}if(r!==void 0&&Ua(r)&&this._automationEvents.push(Ud(this.getValue(e),e)),r!==void 0&&Gs(r)&&r.startTime+r.duration>e){const o=e-r.startTime,A=(r.values.length-1)/r.duration,a=Math.max(2,1+Math.ceil(o*A)),l=o/(a-1)*A,c=r.values.slice(0,a);if(l<1)for(let u=1;u<a;u+=1){const d=l*u%1;c[u]=r.values[u-1]*(1-d)+r.values[u]*d}this._automationEvents[this._automationEvents.length-1]=Z0(c,r.startTime,o)}}}else{const s=this._automationEvents.findIndex(o=>pi(o)>e),i=s===-1?this._automationEvents[this._automationEvents.length-1]:this._automationEvents[s-1];if(i!==void 0&&Gs(i)&&pi(i)+i.duration>e)return!1;const r=jr(t)?zp(t.value,t.endTime,this._currenTime):Kl(t)?Xp(t.value,e,this._currenTime):t;if(s===-1)this._automationEvents.push(r);else{if(Gs(t)&&e+t.duration>pi(this._automationEvents[s]))return!1;this._automationEvents.splice(s,0,r)}}return!0}flush(t){const e=this._automationEvents.findIndex(s=>pi(s)>t);if(e>1){const s=this._automationEvents.slice(e-1),i=s[0];Ua(i)&&s.unshift(Ud(ql(this._automationEvents,e-2,i.startTime,this._defaultValue),i.startTime)),this._automationEvents=s}}getValue(t){if(this._automationEvents.length===0)return this._defaultValue;const e=this._automationEvents.findIndex(o=>pi(o)>t),s=this._automationEvents[e],i=(e===-1?this._automationEvents.length:e)-1,r=this._automationEvents[i];if(r!==void 0&&Ua(r)&&(s===void 0||!wi(s)||s.insertTime>t))return tw(t,ql(this._automationEvents,i-1,r.startTime,this._defaultValue),r);if(r!==void 0&&af(r)&&(s===void 0||!wi(s)))return r.value;if(r!==void 0&&Gs(r)&&(s===void 0||!wi(s)||r.startTime+r.duration>t))return t<r.startTime+r.duration?D2(t,r):r.values[r.values.length-1];if(r!==void 0&&wi(r)&&(s===void 0||!wi(s)))return r.value;if(s!==void 0&&jr(s)){const[o,A]=$p(this._automationEvents,i,r,s,this._defaultValue);return Yp(t,o,A,s)}if(s!==void 0&&Kl(s)){const[o,A]=$p(this._automationEvents,i,r,s,this._defaultValue);return jp(t,o,A,s)}return this._defaultValue}}const k2=n=>({cancelTime:n,type:"cancelAndHold"}),R2=n=>({cancelTime:n,type:"cancelScheduledValues"}),H2=(n,t)=>({endTime:t,type:"exponentialRampToValue",value:n}),O2=(n,t)=>({endTime:t,type:"linearRampToValue",value:n}),V2=(n,t,e)=>({startTime:t,target:n,timeConstant:e,type:"setTarget"}),W2=()=>new DOMException("","AbortError"),G2=n=>(t,e,[s,i,r],o)=>{n(t[i],[e,s,r],A=>A[0]===e&&A[1]===s,o)},K2=n=>(t,e,s)=>{const i=[];for(let r=0;r<s.numberOfInputs;r+=1)i.push(new Set);n.set(t,{activeInputs:i,outputs:new Set,passiveInputs:new WeakMap,renderer:e})},q2=n=>(t,e)=>{n.set(t,{activeInputs:new Set,passiveInputs:new WeakMap,renderer:e})},Eo=new WeakSet,ew=new WeakMap,lf=new WeakMap,nw=new WeakMap,cf=new WeakMap,kc=new WeakMap,sw=new WeakMap,Dd=new WeakMap,Ld=new WeakMap,kd=new WeakMap,iw={construct(){return iw}},z2=n=>{try{const t=new Proxy(n,iw);new t}catch{return!1}return!0},Jp=/^import(?:(?:[\s]+[\w]+|(?:[\s]+[\w]+[\s]*,)?[\s]*\{[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?(?:[\s]*,[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?)*[\s]*}|(?:[\s]+[\w]+[\s]*,)?[\s]*\*[\s]+as[\s]+[\w]+)[\s]+from)?(?:[\s]*)("([^"\\]|\\.)+"|'([^'\\]|\\.)+')(?:[\s]*);?/,Zp=(n,t)=>{const e=[];let s=n.replace(/^[\s]+/,""),i=s.match(Jp);for(;i!==null;){const r=i[1].slice(1,-1),o=i[0].replace(/([\s]+)?;?$/,"").replace(r,new URL(r,t).toString());e.push(o),s=s.slice(i[0].length).replace(/^[\s]+/,""),i=s.match(Jp)}return[e.join(";"),s]},tm=n=>{if(n!==void 0&&!Array.isArray(n))throw new TypeError("The parameterDescriptors property of given value for processorCtor is not an array.")},em=n=>{if(!z2(n))throw new TypeError("The given value for processorCtor should be a constructor.");if(n.prototype===null||typeof n.prototype!="object")throw new TypeError("The given value for processorCtor should have a prototype.")},X2=(n,t,e,s,i,r,o,A,a,l,c,u,d)=>{let p=0;return(f,m,g={credentials:"omit"})=>{const w=c.get(f);if(w!==void 0&&w.has(m))return Promise.resolve();const B=l.get(f);if(B!==void 0){const v=B.get(m);if(v!==void 0)return v}const b=r(f),_=b.audioWorklet===void 0?i(m).then(([v,C])=>{const[y,S]=Zp(v,C),F=`${y};((a,b)=>{(a[b]=a[b]||[]).push((AudioWorkletProcessor,global,registerProcessor,sampleRate,self,window)=>{${S}
})})(window,'_AWGS')`;return e(F)}).then(()=>{const v=d._AWGS.pop();if(v===void 0)throw new SyntaxError;s(b.currentTime,b.sampleRate,()=>v(class{},void 0,(C,y)=>{if(C.trim()==="")throw t();const S=Ld.get(b);if(S!==void 0){if(S.has(C))throw t();em(y),tm(y.parameterDescriptors),S.set(C,y)}else em(y),tm(y.parameterDescriptors),Ld.set(b,new Map([[C,y]]))},b.sampleRate,void 0,void 0))}):Promise.all([i(m),Promise.resolve(n(u,u))]).then(([[v,C],y])=>{const S=p+1;p=S;const[F,x]=Zp(v,C),P=`${F};((AudioWorkletProcessor,registerProcessor)=>{${x}
})(${y?"AudioWorkletProcessor":"class extends AudioWorkletProcessor {__b=new WeakSet();constructor(){super();(p=>p.postMessage=(q=>(m,t)=>q.call(p,m,t?t.filter(u=>!this.__b.has(u)):t))(p.postMessage))(this.port)}}"},(n,p)=>registerProcessor(n,class extends p{${y?"":"__c = (a) => a.forEach(e=>this.__b.add(e.buffer));"}process(i,o,p){${y?"":"i.forEach(this.__c);o.forEach(this.__c);this.__c(Object.values(p));"}return super.process(i.map(j=>j.some(k=>k.length===0)?[]:j),o,p)}}));registerProcessor('__sac${S}',class extends AudioWorkletProcessor{process(){return !1}})`,K=new Blob([P],{type:"application/javascript; charset=utf-8"}),M=URL.createObjectURL(K);return b.audioWorklet.addModule(M,g).then(()=>{if(A(b))return b;const k=o(b);return k.audioWorklet.addModule(M,g).then(()=>k)}).then(k=>{if(a===null)throw new SyntaxError;try{new a(k,`__sac${S}`)}catch{throw new SyntaxError}}).finally(()=>URL.revokeObjectURL(M))});return B===void 0?l.set(f,new Map([[m,_]])):B.set(m,_),_.then(()=>{const v=c.get(f);v===void 0?c.set(f,new Set([m])):v.add(m)}).finally(()=>{const v=l.get(f);v!==void 0&&v.delete(m)}),_}},ns=(n,t)=>{const e=n.get(t);if(e===void 0)throw new Error("A value with the given key could not be found.");return e},Rc=(n,t)=>{const e=Array.from(n).filter(t);if(e.length>1)throw Error("More than one element was found.");if(e.length===0)throw Error("No element was found.");const[s]=e;return n.delete(s),s},rw=(n,t,e,s)=>{const i=ns(n,t),r=Rc(i,o=>o[0]===e&&o[1]===s);return i.size===0&&n.delete(t),r},pa=n=>ns(sw,n),xo=n=>{if(Eo.has(n))throw new Error("The AudioNode is already stored.");Eo.add(n),pa(n).forEach(t=>t(!0))},ow=n=>"port"in n,ma=n=>{if(!Eo.has(n))throw new Error("The AudioNode is not stored.");Eo.delete(n),pa(n).forEach(t=>t(!1))},Rd=(n,t)=>{!ow(n)&&t.every(e=>e.size===0)&&ma(n)},$2=(n,t,e,s,i,r,o,A,a,l,c,u,d)=>{const p=new WeakMap;return(f,m,g,w,B)=>{const{activeInputs:b,passiveInputs:_}=r(m),{outputs:v}=r(f),C=A(f),y=S=>{const F=a(m),x=a(f);if(S){const Q=rw(_,f,g,w);n(b,f,Q,!1),!B&&!u(f)&&e(x,F,g,w),d(m)&&xo(m)}else{const Q=s(b,f,g,w);t(_,w,Q,!1),!B&&!u(f)&&i(x,F,g,w);const T=o(m);if(T===0)c(m)&&Rd(m,b);else{const U=p.get(m);U!==void 0&&clearTimeout(U),p.set(m,setTimeout(()=>{c(m)&&Rd(m,b)},T*1e3))}}};return l(v,[m,g,w],S=>S[0]===m&&S[1]===g&&S[2]===w,!0)?(C.add(y),c(f)?n(b,f,[g,w,y],!0):t(_,w,[f,g,y],!0),!0):!1}},Y2=n=>(t,e,[s,i,r],o)=>{const A=t.get(s);A===void 0?t.set(s,new Set([[i,e,r]])):n(A,[i,e,r],a=>a[0]===i&&a[1]===e,o)},j2=n=>(t,e)=>{const s=n(t,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});e.connect(s).connect(t.destination);const i=()=>{e.removeEventListener("ended",i),e.disconnect(s),s.disconnect()};e.addEventListener("ended",i)},J2=n=>(t,e)=>{n(t).add(e)},Z2={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",fftSize:2048,maxDecibels:-30,minDecibels:-100,smoothingTimeConstant:.8},ty=(n,t,e,s,i,r)=>class extends n{constructor(A,a){const l=i(A),c={...Z2,...a},u=s(l,c),d=r(l)?t():null;super(A,!1,u,d),this._nativeAnalyserNode=u}get fftSize(){return this._nativeAnalyserNode.fftSize}set fftSize(A){this._nativeAnalyserNode.fftSize=A}get frequencyBinCount(){return this._nativeAnalyserNode.frequencyBinCount}get maxDecibels(){return this._nativeAnalyserNode.maxDecibels}set maxDecibels(A){const a=this._nativeAnalyserNode.maxDecibels;if(this._nativeAnalyserNode.maxDecibels=A,!(A>this._nativeAnalyserNode.minDecibels))throw this._nativeAnalyserNode.maxDecibels=a,e()}get minDecibels(){return this._nativeAnalyserNode.minDecibels}set minDecibels(A){const a=this._nativeAnalyserNode.minDecibels;if(this._nativeAnalyserNode.minDecibels=A,!(this._nativeAnalyserNode.maxDecibels>A))throw this._nativeAnalyserNode.minDecibels=a,e()}get smoothingTimeConstant(){return this._nativeAnalyserNode.smoothingTimeConstant}set smoothingTimeConstant(A){this._nativeAnalyserNode.smoothingTimeConstant=A}getByteFrequencyData(A){this._nativeAnalyserNode.getByteFrequencyData(A)}getByteTimeDomainData(A){this._nativeAnalyserNode.getByteTimeDomainData(A)}getFloatFrequencyData(A){this._nativeAnalyserNode.getFloatFrequencyData(A)}getFloatTimeDomainData(A){this._nativeAnalyserNode.getFloatTimeDomainData(A)}},We=(n,t)=>n.context===t,ey=(n,t,e)=>()=>{const s=new WeakMap,i=async(r,o)=>{let A=t(r);if(!We(A,o)){const l={channelCount:A.channelCount,channelCountMode:A.channelCountMode,channelInterpretation:A.channelInterpretation,fftSize:A.fftSize,maxDecibels:A.maxDecibels,minDecibels:A.minDecibels,smoothingTimeConstant:A.smoothingTimeConstant};A=n(o,l)}return s.set(o,A),await e(r,o,A),A};return{render(r,o){const A=s.get(o);return A!==void 0?Promise.resolve(A):i(r,o)}}},zl=n=>{try{n.copyToChannel(new Float32Array(1),0,-1)}catch{return!1}return!0},Ms=()=>new DOMException("","IndexSizeError"),uf=n=>{n.getChannelData=(t=>e=>{try{return t.call(n,e)}catch(s){throw s.code===12?Ms():s}})(n.getChannelData)},ny={numberOfChannels:1},sy=(n,t,e,s,i,r,o,A)=>{let a=null;return class Aw{constructor(c){if(i===null)throw new Error("Missing the native OfflineAudioContext constructor.");const{length:u,numberOfChannels:d,sampleRate:p}={...ny,...c};a===null&&(a=new i(1,1,44100));const f=s!==null&&t(r,r)?new s({length:u,numberOfChannels:d,sampleRate:p}):a.createBuffer(d,u,p);if(f.numberOfChannels===0)throw e();return typeof f.copyFromChannel!="function"?(o(f),uf(f)):t(zl,()=>zl(f))||A(f),n.add(f),f}static[Symbol.hasInstance](c){return c!==null&&typeof c=="object"&&Object.getPrototypeOf(c)===Aw.prototype||n.has(c)}}},rn=-34028234663852886e22,$e=-rn,Zs=n=>Eo.has(n),iy={buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1},ry=(n,t,e,s,i,r,o,A)=>class extends n{constructor(l,c){const u=r(l),d={...iy,...c},p=i(u,d),f=o(u),m=f?t():null;super(l,!1,p,m),this._audioBufferSourceNodeRenderer=m,this._isBufferNullified=!1,this._isBufferSet=d.buffer!==null,this._nativeAudioBufferSourceNode=p,this._onended=null,this._playbackRate=e(this,f,p.playbackRate,$e,rn)}get buffer(){return this._isBufferNullified?null:this._nativeAudioBufferSourceNode.buffer}set buffer(l){if(this._nativeAudioBufferSourceNode.buffer=l,l!==null){if(this._isBufferSet)throw s();this._isBufferSet=!0}}get loop(){return this._nativeAudioBufferSourceNode.loop}set loop(l){this._nativeAudioBufferSourceNode.loop=l}get loopEnd(){return this._nativeAudioBufferSourceNode.loopEnd}set loopEnd(l){this._nativeAudioBufferSourceNode.loopEnd=l}get loopStart(){return this._nativeAudioBufferSourceNode.loopStart}set loopStart(l){this._nativeAudioBufferSourceNode.loopStart=l}get onended(){return this._onended}set onended(l){const c=typeof l=="function"?A(this,l):null;this._nativeAudioBufferSourceNode.onended=c;const u=this._nativeAudioBufferSourceNode.onended;this._onended=u!==null&&u===c?l:u}get playbackRate(){return this._playbackRate}start(l=0,c=0,u){if(this._nativeAudioBufferSourceNode.start(l,c,u),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.start=u===void 0?[l,c]:[l,c,u]),this.context.state!=="closed"){xo(this);const d=()=>{this._nativeAudioBufferSourceNode.removeEventListener("ended",d),Zs(this)&&ma(this)};this._nativeAudioBufferSourceNode.addEventListener("ended",d)}}stop(l=0){this._nativeAudioBufferSourceNode.stop(l),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.stop=l)}},oy=(n,t,e,s,i)=>()=>{const r=new WeakMap;let o=null,A=null;const a=async(l,c)=>{let u=e(l);const d=We(u,c);if(!d){const p={buffer:u.buffer,channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,loop:u.loop,loopEnd:u.loopEnd,loopStart:u.loopStart,playbackRate:u.playbackRate.value};u=t(c,p),o!==null&&u.start(...o),A!==null&&u.stop(A)}return r.set(c,u),d?await n(c,l.playbackRate,u.playbackRate):await s(c,l.playbackRate,u.playbackRate),await i(l,c,u),u};return{set start(l){o=l},set stop(l){A=l},render(l,c){const u=r.get(c);return u!==void 0?Promise.resolve(u):a(l,c)}}},Ay=n=>"playbackRate"in n,ay=n=>"frequency"in n&&"gain"in n,ly=n=>"offset"in n,cy=n=>!("frequency"in n)&&"gain"in n,uy=n=>"detune"in n&&"frequency"in n&&!("gain"in n),dy=n=>"pan"in n,Ye=n=>ns(ew,n),ga=n=>ns(nw,n),Hd=(n,t)=>{const{activeInputs:e}=Ye(n);e.forEach(i=>i.forEach(([r])=>{t.includes(n)||Hd(r,[...t,n])}));const s=Ay(n)?[n.playbackRate]:ow(n)?Array.from(n.parameters.values()):ay(n)?[n.Q,n.detune,n.frequency,n.gain]:ly(n)?[n.offset]:cy(n)?[n.gain]:uy(n)?[n.detune,n.frequency]:dy(n)?[n.pan]:[];for(const i of s){const r=ga(i);r!==void 0&&r.activeInputs.forEach(([o])=>Hd(o,t))}Zs(n)&&ma(n)},aw=n=>{Hd(n.destination,[])},hy=n=>n===void 0||typeof n=="number"||typeof n=="string"&&(n==="balanced"||n==="interactive"||n==="playback"),fy=(n,t,e,s,i,r,o,A,a)=>class extends n{constructor(c={}){if(a===null)throw new Error("Missing the native AudioContext constructor.");let u;try{u=new a(c)}catch(f){throw f.code===12&&f.message==="sampleRate is not in range"?e():f}if(u===null)throw s();if(!hy(c.latencyHint))throw new TypeError(`The provided value '${c.latencyHint}' is not a valid enum value of type AudioContextLatencyCategory.`);if(c.sampleRate!==void 0&&u.sampleRate!==c.sampleRate)throw e();super(u,2);const{latencyHint:d}=c,{sampleRate:p}=u;if(this._baseLatency=typeof u.baseLatency=="number"?u.baseLatency:d==="balanced"?512/p:d==="interactive"||d===void 0?256/p:d==="playback"?1024/p:Math.max(2,Math.min(128,Math.round(d*p/128)))*128/p,this._nativeAudioContext=u,a.name==="webkitAudioContext"?(this._nativeGainNode=u.createGain(),this._nativeOscillatorNode=u.createOscillator(),this._nativeGainNode.gain.value=1e-37,this._nativeOscillatorNode.connect(this._nativeGainNode).connect(u.destination),this._nativeOscillatorNode.start()):(this._nativeGainNode=null,this._nativeOscillatorNode=null),this._state=null,u.state==="running"){this._state="suspended";const f=()=>{this._state==="suspended"&&(this._state=null),u.removeEventListener("statechange",f)};u.addEventListener("statechange",f)}}get baseLatency(){return this._baseLatency}get state(){return this._state!==null?this._state:this._nativeAudioContext.state}close(){return this.state==="closed"?this._nativeAudioContext.close().then(()=>{throw t()}):(this._state==="suspended"&&(this._state=null),this._nativeAudioContext.close().then(()=>{this._nativeGainNode!==null&&this._nativeOscillatorNode!==null&&(this._nativeOscillatorNode.stop(),this._nativeGainNode.disconnect(),this._nativeOscillatorNode.disconnect()),aw(this)}))}createMediaElementSource(c){return new i(this,{mediaElement:c})}createMediaStreamDestination(){return new r(this)}createMediaStreamSource(c){return new o(this,{mediaStream:c})}createMediaStreamTrackSource(c){return new A(this,{mediaStreamTrack:c})}resume(){return this._state==="suspended"?new Promise((c,u)=>{const d=()=>{this._nativeAudioContext.removeEventListener("statechange",d),this._nativeAudioContext.state==="running"?c():this.resume().then(c,u)};this._nativeAudioContext.addEventListener("statechange",d)}):this._nativeAudioContext.resume().catch(c=>{throw c===void 0||c.code===15?t():c})}suspend(){return this._nativeAudioContext.suspend().catch(c=>{throw c===void 0?t():c})}},py=(n,t,e,s,i,r,o,A)=>class extends n{constructor(l,c){const u=r(l),d=o(u),p=i(u,c,d),f=d?t(A):null;super(l,!1,p,f),this._isNodeOfNativeOfflineAudioContext=d,this._nativeAudioDestinationNode=p}get channelCount(){return this._nativeAudioDestinationNode.channelCount}set channelCount(l){if(this._isNodeOfNativeOfflineAudioContext)throw s();if(l>this._nativeAudioDestinationNode.maxChannelCount)throw e();this._nativeAudioDestinationNode.channelCount=l}get channelCountMode(){return this._nativeAudioDestinationNode.channelCountMode}set channelCountMode(l){if(this._isNodeOfNativeOfflineAudioContext)throw s();this._nativeAudioDestinationNode.channelCountMode=l}get maxChannelCount(){return this._nativeAudioDestinationNode.maxChannelCount}},my=n=>{const t=new WeakMap,e=async(s,i)=>{const r=i.destination;return t.set(i,r),await n(s,i,r),r};return{render(s,i){const r=t.get(i);return r!==void 0?Promise.resolve(r):e(s,i)}}},gy=(n,t,e,s,i,r,o,A)=>(a,l)=>{const c=l.listener,u=()=>{const v=new Float32Array(1),C=t(l,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:9}),y=o(l);let S=!1,F=[0,0,-1,0,1,0],x=[0,0,0];const Q=()=>{if(S)return;S=!0;const K=s(l,256,9,0);K.onaudioprocess=({inputBuffer:M})=>{const k=[r(M,v,0),r(M,v,1),r(M,v,2),r(M,v,3),r(M,v,4),r(M,v,5)];k.some((R,J)=>R!==F[J])&&(c.setOrientation(...k),F=k);const N=[r(M,v,6),r(M,v,7),r(M,v,8)];N.some((R,J)=>R!==x[J])&&(c.setPosition(...N),x=N)},C.connect(K)},T=K=>M=>{M!==F[K]&&(F[K]=M,c.setOrientation(...F))},U=K=>M=>{M!==x[K]&&(x[K]=M,c.setPosition(...x))},P=(K,M,k)=>{const N=e(l,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:M});N.connect(C,0,K),N.start(),Object.defineProperty(N.offset,"defaultValue",{get(){return M}});const R=n({context:a},y,N.offset,$e,rn);return A(R,"value",J=>()=>J.call(R),J=>tt=>{try{J.call(R,tt)}catch(rt){if(rt.code!==9)throw rt}Q(),y&&k(tt)}),R.cancelAndHoldAtTime=(J=>y?()=>{throw i()}:(...tt)=>{const rt=J.apply(R,tt);return Q(),rt})(R.cancelAndHoldAtTime),R.cancelScheduledValues=(J=>y?()=>{throw i()}:(...tt)=>{const rt=J.apply(R,tt);return Q(),rt})(R.cancelScheduledValues),R.exponentialRampToValueAtTime=(J=>y?()=>{throw i()}:(...tt)=>{const rt=J.apply(R,tt);return Q(),rt})(R.exponentialRampToValueAtTime),R.linearRampToValueAtTime=(J=>y?()=>{throw i()}:(...tt)=>{const rt=J.apply(R,tt);return Q(),rt})(R.linearRampToValueAtTime),R.setTargetAtTime=(J=>y?()=>{throw i()}:(...tt)=>{const rt=J.apply(R,tt);return Q(),rt})(R.setTargetAtTime),R.setValueAtTime=(J=>y?()=>{throw i()}:(...tt)=>{const rt=J.apply(R,tt);return Q(),rt})(R.setValueAtTime),R.setValueCurveAtTime=(J=>y?()=>{throw i()}:(...tt)=>{const rt=J.apply(R,tt);return Q(),rt})(R.setValueCurveAtTime),R};return{forwardX:P(0,0,T(0)),forwardY:P(1,0,T(1)),forwardZ:P(2,-1,T(2)),positionX:P(6,0,U(0)),positionY:P(7,0,U(1)),positionZ:P(8,0,U(2)),upX:P(3,0,T(3)),upY:P(4,1,T(4)),upZ:P(5,0,T(5))}},{forwardX:d,forwardY:p,forwardZ:f,positionX:m,positionY:g,positionZ:w,upX:B,upY:b,upZ:_}=c.forwardX===void 0?u():c;return{get forwardX(){return d},get forwardY(){return p},get forwardZ(){return f},get positionX(){return m},get positionY(){return g},get positionZ(){return w},get upX(){return B},get upY(){return b},get upZ(){return _}}},Xl=n=>"context"in n,wa=n=>Xl(n[0]),Ir=(n,t,e,s)=>{for(const i of n)if(e(i)){if(s)return!1;throw Error("The set contains at least one similar element.")}return n.add(t),!0},nm=(n,t,[e,s],i)=>{Ir(n,[t,e,s],r=>r[0]===t&&r[1]===e,i)},sm=(n,[t,e,s],i)=>{const r=n.get(t);r===void 0?n.set(t,new Set([[e,s]])):Ir(r,[e,s],o=>o[0]===e,i)},ko=n=>"inputs"in n,$l=(n,t,e,s)=>{if(ko(t)){const i=t.inputs[s];return n.connect(i,e,0),[i,e,0]}return n.connect(t,e,s),[t,e,s]},lw=(n,t,e)=>{for(const s of n)if(s[0]===t&&s[1]===e)return n.delete(s),s;return null},wy=(n,t,e)=>Rc(n,s=>s[0]===t&&s[1]===e),cw=(n,t)=>{if(!pa(n).delete(t))throw new Error("Missing the expected event listener.")},uw=(n,t,e)=>{const s=ns(n,t),i=Rc(s,r=>r[0]===e);return s.size===0&&n.delete(t),i},Yl=(n,t,e,s)=>{ko(t)?n.disconnect(t.inputs[s],e,0):n.disconnect(t,e,s)},jt=n=>ns(lf,n),kA=n=>ns(cf,n),Br=n=>Dd.has(n),Sl=n=>!Eo.has(n),im=(n,t)=>new Promise(e=>{if(t!==null)e(!0);else{const s=n.createScriptProcessor(256,1,1),i=n.createGain(),r=n.createBuffer(1,2,44100),o=r.getChannelData(0);o[0]=1,o[1]=1;const A=n.createBufferSource();A.buffer=r,A.loop=!0,A.connect(s).connect(n.destination),A.connect(i),A.disconnect(i),s.onaudioprocess=a=>{const l=a.inputBuffer.getChannelData(0);Array.prototype.some.call(l,c=>c===1)?e(!0):e(!1),A.stop(),s.onaudioprocess=null,A.disconnect(s),s.disconnect(n.destination)},A.start()}}),Tu=(n,t)=>{const e=new Map;for(const s of n)for(const i of s){const r=e.get(i);e.set(i,r===void 0?1:r+1)}e.forEach((s,i)=>t(i,s))},jl=n=>"context"in n,vy=n=>{const t=new Map;n.connect=(e=>(s,i=0,r=0)=>{const o=jl(s)?e(s,i,r):e(s,i),A=t.get(s);return A===void 0?t.set(s,[{input:r,output:i}]):A.every(a=>a.input!==r||a.output!==i)&&A.push({input:r,output:i}),o})(n.connect.bind(n)),n.disconnect=(e=>(s,i,r)=>{if(e.apply(n),s===void 0)t.clear();else if(typeof s=="number")for(const[o,A]of t){const a=A.filter(l=>l.output!==s);a.length===0?t.delete(o):t.set(o,a)}else if(t.has(s))if(i===void 0)t.delete(s);else{const o=t.get(s);if(o!==void 0){const A=o.filter(a=>a.output!==i&&(a.input!==r||r===void 0));A.length===0?t.delete(s):t.set(s,A)}}for(const[o,A]of t)A.forEach(a=>{jl(o)?n.connect(o,a.output,a.input):n.connect(o,a.output)})})(n.disconnect)},By=(n,t,e,s)=>{const{activeInputs:i,passiveInputs:r}=ga(t),{outputs:o}=Ye(n),A=pa(n),a=l=>{const c=jt(n),u=kA(t);if(l){const d=uw(r,n,e);nm(i,n,d,!1),!s&&!Br(n)&&c.connect(u,e)}else{const d=wy(i,n,e);sm(r,d,!1),!s&&!Br(n)&&c.disconnect(u,e)}};return Ir(o,[t,e],l=>l[0]===t&&l[1]===e,!0)?(A.add(a),Zs(n)?nm(i,n,[e,a],!0):sm(r,[n,e,a],!0),!0):!1},Cy=(n,t,e,s)=>{const{activeInputs:i,passiveInputs:r}=Ye(t),o=lw(i[s],n,e);return o===null?[rw(r,n,e,s)[2],!1]:[o[2],!0]},by=(n,t,e)=>{const{activeInputs:s,passiveInputs:i}=ga(t),r=lw(s,n,e);return r===null?[uw(i,n,e)[1],!1]:[r[2],!0]},df=(n,t,e,s,i)=>{const[r,o]=Cy(n,e,s,i);if(r!==null&&(cw(n,r),o&&!t&&!Br(n)&&Yl(jt(n),jt(e),s,i)),Zs(e)){const{activeInputs:A}=Ye(e);Rd(e,A)}},hf=(n,t,e,s)=>{const[i,r]=by(n,e,s);i!==null&&(cw(n,i),r&&!t&&!Br(n)&&jt(n).disconnect(kA(e),s))},yy=(n,t)=>{const e=Ye(n),s=[];for(const i of e.outputs)wa(i)?df(n,t,...i):hf(n,t,...i),s.push(i[0]);return e.outputs.clear(),s},Sy=(n,t,e)=>{const s=Ye(n),i=[];for(const r of s.outputs)r[1]===e&&(wa(r)?df(n,t,...r):hf(n,t,...r),i.push(r[0]),s.outputs.delete(r));return i},Ey=(n,t,e,s,i)=>{const r=Ye(n);return Array.from(r.outputs).filter(o=>o[0]===e&&(s===void 0||o[1]===s)&&(i===void 0||o[2]===i)).map(o=>(wa(o)?df(n,t,...o):hf(n,t,...o),r.outputs.delete(o),o[0]))},xy=(n,t,e,s,i,r,o,A,a,l,c,u,d,p,f,m)=>class extends l{constructor(w,B,b,_){super(b),this._context=w,this._nativeAudioNode=b;const v=c(w);u(v)&&e(im,()=>im(v,m))!==!0&&vy(b),lf.set(this,b),sw.set(this,new Set),w.state!=="closed"&&B&&xo(this),n(this,_,b)}get channelCount(){return this._nativeAudioNode.channelCount}set channelCount(w){this._nativeAudioNode.channelCount=w}get channelCountMode(){return this._nativeAudioNode.channelCountMode}set channelCountMode(w){this._nativeAudioNode.channelCountMode=w}get channelInterpretation(){return this._nativeAudioNode.channelInterpretation}set channelInterpretation(w){this._nativeAudioNode.channelInterpretation=w}get context(){return this._context}get numberOfInputs(){return this._nativeAudioNode.numberOfInputs}get numberOfOutputs(){return this._nativeAudioNode.numberOfOutputs}connect(w,B=0,b=0){if(B<0||B>=this._nativeAudioNode.numberOfOutputs)throw i();const _=c(this._context),v=f(_);if(d(w)||p(w))throw r();if(Xl(w)){const S=jt(w);try{const x=$l(this._nativeAudioNode,S,B,b),Q=Sl(this);(v||Q)&&this._nativeAudioNode.disconnect(...x),this.context.state!=="closed"&&!Q&&Sl(w)&&xo(w)}catch(x){throw x.code===12?r():x}if(t(this,w,B,b,v)){const x=a([this],w);Tu(x,s(v))}return w}const C=kA(w);if(C.name==="playbackRate"&&C.maxValue===1024)throw o();try{this._nativeAudioNode.connect(C,B),(v||Sl(this))&&this._nativeAudioNode.disconnect(C,B)}catch(S){throw S.code===12?r():S}if(By(this,w,B,v)){const S=a([this],w);Tu(S,s(v))}}disconnect(w,B,b){let _;const v=c(this._context),C=f(v);if(w===void 0)_=yy(this,C);else if(typeof w=="number"){if(w<0||w>=this.numberOfOutputs)throw i();_=Sy(this,C,w)}else{if(B!==void 0&&(B<0||B>=this.numberOfOutputs)||Xl(w)&&b!==void 0&&(b<0||b>=w.numberOfInputs))throw i();if(_=Ey(this,C,w,B,b),_.length===0)throw r()}for(const y of _){const S=a([this],y);Tu(S,A)}}},_y=(n,t,e,s,i,r,o,A,a,l,c,u,d)=>(p,f,m,g=null,w=null)=>{const B=m.value,b=new L2(B),_=f?s(b):null,v={get defaultValue(){return B},get maxValue(){return g===null?m.maxValue:g},get minValue(){return w===null?m.minValue:w},get value(){return m.value},set value(C){m.value=C,v.setValueAtTime(C,p.context.currentTime)},cancelAndHoldAtTime(C){if(typeof m.cancelAndHoldAtTime=="function")_===null&&b.flush(p.context.currentTime),b.add(i(C)),m.cancelAndHoldAtTime(C);else{const y=Array.from(b).pop();_===null&&b.flush(p.context.currentTime),b.add(i(C));const S=Array.from(b).pop();m.cancelScheduledValues(C),y!==S&&S!==void 0&&(S.type==="exponentialRampToValue"?m.exponentialRampToValueAtTime(S.value,S.endTime):S.type==="linearRampToValue"?m.linearRampToValueAtTime(S.value,S.endTime):S.type==="setValue"?m.setValueAtTime(S.value,S.startTime):S.type==="setValueCurve"&&m.setValueCurveAtTime(S.values,S.startTime,S.duration))}return v},cancelScheduledValues(C){return _===null&&b.flush(p.context.currentTime),b.add(r(C)),m.cancelScheduledValues(C),v},exponentialRampToValueAtTime(C,y){if(C===0)throw new RangeError;if(!Number.isFinite(y)||y<0)throw new RangeError;const S=p.context.currentTime;return _===null&&b.flush(S),Array.from(b).length===0&&(b.add(l(B,S)),m.setValueAtTime(B,S)),b.add(o(C,y)),m.exponentialRampToValueAtTime(C,y),v},linearRampToValueAtTime(C,y){const S=p.context.currentTime;return _===null&&b.flush(S),Array.from(b).length===0&&(b.add(l(B,S)),m.setValueAtTime(B,S)),b.add(A(C,y)),m.linearRampToValueAtTime(C,y),v},setTargetAtTime(C,y,S){return _===null&&b.flush(p.context.currentTime),b.add(a(C,y,S)),m.setTargetAtTime(C,y,S),v},setValueAtTime(C,y){return _===null&&b.flush(p.context.currentTime),b.add(l(C,y)),m.setValueAtTime(C,y),v},setValueCurveAtTime(C,y,S){const F=C instanceof Float32Array?C:new Float32Array(C);if(u!==null&&u.name==="webkitAudioContext"){const x=y+S,Q=p.context.sampleRate,T=Math.ceil(y*Q),U=Math.floor(x*Q),P=U-T,K=new Float32Array(P);for(let k=0;k<P;k+=1){const N=(F.length-1)/S*((T+k)/Q-y),R=Math.floor(N),J=Math.ceil(N);K[k]=R===J?F[R]:(1-(N-R))*F[R]+(1-(J-N))*F[J]}_===null&&b.flush(p.context.currentTime),b.add(c(K,y,S)),m.setValueCurveAtTime(K,y,S);const M=U/Q;M<x&&d(v,K[K.length-1],M),d(v,F[F.length-1],x)}else _===null&&b.flush(p.context.currentTime),b.add(c(F,y,S)),m.setValueCurveAtTime(F,y,S);return v}};return e.set(v,m),t.set(v,p),n(v,_),v},Iy=n=>({replay(t){for(const e of n)if(e.type==="exponentialRampToValue"){const{endTime:s,value:i}=e;t.exponentialRampToValueAtTime(i,s)}else if(e.type==="linearRampToValue"){const{endTime:s,value:i}=e;t.linearRampToValueAtTime(i,s)}else if(e.type==="setTarget"){const{startTime:s,target:i,timeConstant:r}=e;t.setTargetAtTime(i,s,r)}else if(e.type==="setValue"){const{startTime:s,value:i}=e;t.setValueAtTime(i,s)}else if(e.type==="setValueCurve"){const{duration:s,startTime:i,values:r}=e;t.setValueCurveAtTime(r,i,s)}else throw new Error("Can't apply an unknown automation.")}});class dw{constructor(t){this._map=new Map(t)}get size(){return this._map.size}entries(){return this._map.entries()}forEach(t,e=null){return this._map.forEach((s,i)=>t.call(e,s,i,this))}get(t){return this._map.get(t)}has(t){return this._map.has(t)}keys(){return this._map.keys()}values(){return this._map.values()}}const Fy={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:1,numberOfOutputs:1,parameterData:{},processorOptions:{}},Ty=(n,t,e,s,i,r,o,A,a,l,c,u,d,p)=>class extends t{constructor(m,g,w){var B;const b=A(m),_=a(b),v=c({...Fy,...w});d(v);const C=Ld.get(b),y=C==null?void 0:C.get(g),S=_||b.state!=="closed"?b:(B=o(b))!==null&&B!==void 0?B:b,F=i(S,_?null:m.baseLatency,l,g,y,v),x=_?s(g,v,y):null;super(m,!0,F,x);const Q=[];F.parameters.forEach((U,P)=>{const K=e(this,_,U);Q.push([P,K])}),this._nativeAudioWorkletNode=F,this._onprocessorerror=null,this._parameters=new dw(Q),_&&n(b,this);const{activeInputs:T}=r(this);u(F,T)}get onprocessorerror(){return this._onprocessorerror}set onprocessorerror(m){const g=typeof m=="function"?p(this,m):null;this._nativeAudioWorkletNode.onprocessorerror=g;const w=this._nativeAudioWorkletNode.onprocessorerror;this._onprocessorerror=w!==null&&w===g?m:w}get parameters(){return this._parameters===null?this._nativeAudioWorkletNode.parameters:this._parameters}get port(){return this._nativeAudioWorkletNode.port}};function Jl(n,t,e,s,i){if(typeof n.copyFromChannel=="function")t[e].byteLength===0&&(t[e]=new Float32Array(128)),n.copyFromChannel(t[e],s,i);else{const r=n.getChannelData(s);if(t[e].byteLength===0)t[e]=r.slice(i,i+128);else{const o=new Float32Array(r.buffer,i*Float32Array.BYTES_PER_ELEMENT,128);t[e].set(o)}}}const hw=(n,t,e,s,i)=>{typeof n.copyToChannel=="function"?t[e].byteLength!==0&&n.copyToChannel(t[e],s,i):t[e].byteLength!==0&&n.getChannelData(s).set(t[e],i)},Zl=(n,t)=>{const e=[];for(let s=0;s<n;s+=1){const i=[],r=typeof t=="number"?t:t[s];for(let o=0;o<r;o+=1)i.push(new Float32Array(128));e.push(i)}return e},Qy=(n,t)=>{const e=ns(kd,n),s=jt(t);return ns(e,s)},My=async(n,t,e,s,i,r,o)=>{const A=t===null?Math.ceil(n.context.length/128)*128:t.length,a=s.channelCount*s.numberOfInputs,l=i.reduce((g,w)=>g+w,0),c=l===0?null:e.createBuffer(l,A,e.sampleRate);if(r===void 0)throw new Error("Missing the processor constructor.");const u=Ye(n),d=await Qy(e,n),p=Zl(s.numberOfInputs,s.channelCount),f=Zl(s.numberOfOutputs,i),m=Array.from(n.parameters.keys()).reduce((g,w)=>({...g,[w]:new Float32Array(128)}),{});for(let g=0;g<A;g+=128){if(s.numberOfInputs>0&&t!==null)for(let w=0;w<s.numberOfInputs;w+=1)for(let B=0;B<s.channelCount;B+=1)Jl(t,p[w],B,B,g);r.parameterDescriptors!==void 0&&t!==null&&r.parameterDescriptors.forEach(({name:w},B)=>{Jl(t,m,w,a+B,g)});for(let w=0;w<s.numberOfInputs;w+=1)for(let B=0;B<i[w];B+=1)f[w][B].byteLength===0&&(f[w][B]=new Float32Array(128));try{const w=p.map((b,_)=>u.activeInputs[_].size===0?[]:b),B=o(g/e.sampleRate,e.sampleRate,()=>d.process(w,f,m));if(c!==null)for(let b=0,_=0;b<s.numberOfOutputs;b+=1){for(let v=0;v<i[b];v+=1)hw(c,f[b],v,_+v,g);_+=i[b]}if(!B)break}catch(w){n.dispatchEvent(new ErrorEvent("processorerror",{colno:w.colno,filename:w.filename,lineno:w.lineno,message:w.message}));break}}return c},Uy=(n,t,e,s,i,r,o,A,a,l,c,u,d,p,f,m)=>(g,w,B)=>{const b=new WeakMap;let _=null;const v=async(C,y)=>{let S=c(C),F=null;const x=We(S,y),Q=Array.isArray(w.outputChannelCount)?w.outputChannelCount:Array.from(w.outputChannelCount);if(u===null){const T=Q.reduce((M,k)=>M+k,0),U=i(y,{channelCount:Math.max(1,T),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,T)}),P=[];for(let M=0;M<C.numberOfOutputs;M+=1)P.push(s(y,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Q[M]}));const K=o(y,{channelCount:w.channelCount,channelCountMode:w.channelCountMode,channelInterpretation:w.channelInterpretation,gain:1});K.connect=t.bind(null,P),K.disconnect=a.bind(null,P),F=[U,P,K]}else x||(S=new u(y,g));if(b.set(y,F===null?S:F[2]),F!==null){if(_===null){if(B===void 0)throw new Error("Missing the processor constructor.");if(d===null)throw new Error("Missing the native OfflineAudioContext constructor.");const k=C.channelCount*C.numberOfInputs,N=B.parameterDescriptors===void 0?0:B.parameterDescriptors.length,R=k+N;_=My(C,R===0?null:await(async()=>{const tt=new d(R,Math.ceil(C.context.length/128)*128,y.sampleRate),rt=[],lt=[];for(let O=0;O<w.numberOfInputs;O+=1)rt.push(o(tt,{channelCount:w.channelCount,channelCountMode:w.channelCountMode,channelInterpretation:w.channelInterpretation,gain:1})),lt.push(i(tt,{channelCount:w.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:w.channelCount}));const W=await Promise.all(Array.from(C.parameters.values()).map(async O=>{const $=r(tt,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:O.value});return await p(tt,O,$.offset),$})),H=s(tt,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,k+N)});for(let O=0;O<w.numberOfInputs;O+=1){rt[O].connect(lt[O]);for(let $=0;$<w.channelCount;$+=1)lt[O].connect(H,$,O*w.channelCount+$)}for(const[O,$]of W.entries())$.connect(H,0,k+O),$.start(0);return H.connect(tt.destination),await Promise.all(rt.map(O=>f(C,tt,O))),m(tt)})(),y,w,Q,B,l)}const T=await _,U=e(y,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),[P,K,M]=F;T!==null&&(U.buffer=T,U.start(0)),U.connect(P);for(let k=0,N=0;k<C.numberOfOutputs;k+=1){const R=K[k];for(let J=0;J<Q[k];J+=1)P.connect(R,N+J,J);N+=Q[k]}return M}if(x)for(const[T,U]of C.parameters.entries())await n(y,U,S.parameters.get(T));else for(const[T,U]of C.parameters.entries())await p(y,U,S.parameters.get(T));return await f(C,y,S),S};return{render(C,y){A(y,C);const S=b.get(y);return S!==void 0?Promise.resolve(S):v(C,y)}}},Py=(n,t,e,s,i,r,o,A,a,l,c,u,d,p,f,m,g,w,B,b)=>class extends f{constructor(v,C){super(v,C),this._nativeContext=v,this._audioWorklet=n===void 0?void 0:{addModule:(y,S)=>n(this,y,S)}}get audioWorklet(){return this._audioWorklet}createAnalyser(){return new t(this)}createBiquadFilter(){return new i(this)}createBuffer(v,C,y){return new e({length:C,numberOfChannels:v,sampleRate:y})}createBufferSource(){return new s(this)}createChannelMerger(v=6){return new r(this,{numberOfInputs:v})}createChannelSplitter(v=6){return new o(this,{numberOfOutputs:v})}createConstantSource(){return new A(this)}createConvolver(){return new a(this)}createDelay(v=1){return new c(this,{maxDelayTime:v})}createDynamicsCompressor(){return new u(this)}createGain(){return new d(this)}createIIRFilter(v,C){return new p(this,{feedback:C,feedforward:v})}createOscillator(){return new m(this)}createPanner(){return new g(this)}createPeriodicWave(v,C,y={disableNormalization:!1}){return new w(this,{...y,imag:C,real:v})}createStereoPanner(){return new B(this)}createWaveShaper(){return new b(this)}decodeAudioData(v,C,y){return l(this._nativeContext,v).then(S=>(typeof C=="function"&&C(S),S),S=>{throw typeof y=="function"&&y(S),S})}},Ny={Q:1,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:350,gain:0,type:"lowpass"},Dy=(n,t,e,s,i,r,o,A)=>class extends n{constructor(l,c){const u=r(l),d={...Ny,...c},p=i(u,d),f=o(u),m=f?e():null;super(l,!1,p,m),this._Q=t(this,f,p.Q,$e,rn),this._detune=t(this,f,p.detune,1200*Math.log2($e),-1200*Math.log2($e)),this._frequency=t(this,f,p.frequency,l.sampleRate/2,0),this._gain=t(this,f,p.gain,40*Math.log10($e),rn),this._nativeBiquadFilterNode=p,A(this,1)}get detune(){return this._detune}get frequency(){return this._frequency}get gain(){return this._gain}get Q(){return this._Q}get type(){return this._nativeBiquadFilterNode.type}set type(l){this._nativeBiquadFilterNode.type=l}getFrequencyResponse(l,c,u){try{this._nativeBiquadFilterNode.getFrequencyResponse(l,c,u)}catch(d){throw d.code===11?s():d}if(l.length!==c.length||c.length!==u.length)throw s()}},Ly=(n,t,e,s,i)=>()=>{const r=new WeakMap,o=async(A,a)=>{let l=e(A);const c=We(l,a);if(!c){const u={Q:l.Q.value,channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,detune:l.detune.value,frequency:l.frequency.value,gain:l.gain.value,type:l.type};l=t(a,u)}return r.set(a,l),c?(await n(a,A.Q,l.Q),await n(a,A.detune,l.detune),await n(a,A.frequency,l.frequency),await n(a,A.gain,l.gain)):(await s(a,A.Q,l.Q),await s(a,A.detune,l.detune),await s(a,A.frequency,l.frequency),await s(a,A.gain,l.gain)),await i(A,a,l),l};return{render(A,a){const l=r.get(a);return l!==void 0?Promise.resolve(l):o(A,a)}}},ky=(n,t)=>(e,s)=>{const i=t.get(e);if(i!==void 0)return i;const r=n.get(e);if(r!==void 0)return r;try{const o=s();return o instanceof Promise?(n.set(e,o),o.catch(()=>!1).then(A=>(n.delete(e),t.set(e,A),A))):(t.set(e,o),o)}catch{return t.set(e,!1),!1}},Ry={channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6},Hy=(n,t,e,s,i)=>class extends n{constructor(o,A){const a=s(o),l={...Ry,...A},c=e(a,l),u=i(a)?t():null;super(o,!1,c,u)}},Oy=(n,t,e)=>()=>{const s=new WeakMap,i=async(r,o)=>{let A=t(r);if(!We(A,o)){const l={channelCount:A.channelCount,channelCountMode:A.channelCountMode,channelInterpretation:A.channelInterpretation,numberOfInputs:A.numberOfInputs};A=n(o,l)}return s.set(o,A),await e(r,o,A),A};return{render(r,o){const A=s.get(o);return A!==void 0?Promise.resolve(A):i(r,o)}}},Vy={channelCount:6,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:6},Wy=(n,t,e,s,i,r)=>class extends n{constructor(A,a){const l=s(A),c=r({...Vy,...a}),u=e(l,c),d=i(l)?t():null;super(A,!1,u,d)}},Gy=(n,t,e)=>()=>{const s=new WeakMap,i=async(r,o)=>{let A=t(r);if(!We(A,o)){const l={channelCount:A.channelCount,channelCountMode:A.channelCountMode,channelInterpretation:A.channelInterpretation,numberOfOutputs:A.numberOfOutputs};A=n(o,l)}return s.set(o,A),await e(r,o,A),A};return{render(r,o){const A=s.get(o);return A!==void 0?Promise.resolve(A):i(r,o)}}},Ky=n=>(t,e,s)=>n(e,t,s),qy=n=>(t,e,s=0,i=0)=>{const r=t[s];if(r===void 0)throw n();return jl(e)?r.connect(e,0,i):r.connect(e,0)},zy=n=>(t,e)=>{const s=n(t,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),i=t.createBuffer(1,2,44100);return s.buffer=i,s.loop=!0,s.connect(e),s.start(),()=>{s.stop(),s.disconnect(e)}},Xy={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",offset:1},$y=(n,t,e,s,i,r,o)=>class extends n{constructor(a,l){const c=i(a),u={...Xy,...l},d=s(c,u),p=r(c),f=p?e():null;super(a,!1,d,f),this._constantSourceNodeRenderer=f,this._nativeConstantSourceNode=d,this._offset=t(this,p,d.offset,$e,rn),this._onended=null}get offset(){return this._offset}get onended(){return this._onended}set onended(a){const l=typeof a=="function"?o(this,a):null;this._nativeConstantSourceNode.onended=l;const c=this._nativeConstantSourceNode.onended;this._onended=c!==null&&c===l?a:c}start(a=0){if(this._nativeConstantSourceNode.start(a),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.start=a),this.context.state!=="closed"){xo(this);const l=()=>{this._nativeConstantSourceNode.removeEventListener("ended",l),Zs(this)&&ma(this)};this._nativeConstantSourceNode.addEventListener("ended",l)}}stop(a=0){this._nativeConstantSourceNode.stop(a),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.stop=a)}},Yy=(n,t,e,s,i)=>()=>{const r=new WeakMap;let o=null,A=null;const a=async(l,c)=>{let u=e(l);const d=We(u,c);if(!d){const p={channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,offset:u.offset.value};u=t(c,p),o!==null&&u.start(o),A!==null&&u.stop(A)}return r.set(c,u),d?await n(c,l.offset,u.offset):await s(c,l.offset,u.offset),await i(l,c,u),u};return{set start(l){o=l},set stop(l){A=l},render(l,c){const u=r.get(c);return u!==void 0?Promise.resolve(u):a(l,c)}}},jy=n=>t=>(n[0]=t,n[0]),Jy={buffer:null,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",disableNormalization:!1},Zy=(n,t,e,s,i,r)=>class extends n{constructor(A,a){const l=s(A),c={...Jy,...a},u=e(l,c),p=i(l)?t():null;super(A,!1,u,p),this._isBufferNullified=!1,this._nativeConvolverNode=u,c.buffer!==null&&r(this,c.buffer.duration)}get buffer(){return this._isBufferNullified?null:this._nativeConvolverNode.buffer}set buffer(A){if(this._nativeConvolverNode.buffer=A,A===null&&this._nativeConvolverNode.buffer!==null){const a=this._nativeConvolverNode.context;this._nativeConvolverNode.buffer=a.createBuffer(1,1,a.sampleRate),this._isBufferNullified=!0,r(this,0)}else this._isBufferNullified=!1,r(this,this._nativeConvolverNode.buffer===null?0:this._nativeConvolverNode.buffer.duration)}get normalize(){return this._nativeConvolverNode.normalize}set normalize(A){this._nativeConvolverNode.normalize=A}},t1=(n,t,e)=>()=>{const s=new WeakMap,i=async(r,o)=>{let A=t(r);if(!We(A,o)){const l={buffer:A.buffer,channelCount:A.channelCount,channelCountMode:A.channelCountMode,channelInterpretation:A.channelInterpretation,disableNormalization:!A.normalize};A=n(o,l)}return s.set(o,A),ko(A)?await e(r,o,A.inputs[0]):await e(r,o,A),A};return{render(r,o){const A=s.get(o);return A!==void 0?Promise.resolve(A):i(r,o)}}},e1=(n,t)=>(e,s,i)=>{if(t===null)throw new Error("Missing the native OfflineAudioContext constructor.");try{return new t(e,s,i)}catch(r){throw r.name==="SyntaxError"?n():r}},n1=()=>new DOMException("","DataCloneError"),rm=n=>{const{port1:t,port2:e}=new MessageChannel;return new Promise(s=>{const i=()=>{e.onmessage=null,t.close(),e.close(),s()};e.onmessage=()=>i();try{t.postMessage(n,[n])}catch{}finally{i()}})},s1=(n,t,e,s,i,r,o,A,a,l,c)=>(u,d)=>{const p=o(u)?u:r(u);if(i.has(d)){const f=e();return Promise.reject(f)}try{i.add(d)}catch{}return t(a,()=>a(p))?p.decodeAudioData(d).then(f=>(rm(d).catch(()=>{}),t(A,()=>A(f))||c(f),n.add(f),f)):new Promise((f,m)=>{const g=async()=>{try{await rm(d)}catch{}},w=B=>{m(B),g()};try{p.decodeAudioData(d,B=>{typeof B.copyFromChannel!="function"&&(l(B),uf(B)),n.add(B),g().then(()=>f(B))},B=>{w(B===null?s():B)})}catch(B){w(B)}})},i1=(n,t,e,s,i,r,o,A)=>(a,l)=>{const c=t.get(a);if(c===void 0)throw new Error("Missing the expected cycle count.");const u=r(a.context),d=A(u);if(c===l){if(t.delete(a),!d&&o(a)){const p=s(a),{outputs:f}=e(a);for(const m of f)if(wa(m)){const g=s(m[0]);n(p,g,m[1],m[2])}else{const g=i(m[0]);p.connect(g,m[1])}}}else t.set(a,c-l)},r1={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",delayTime:0,maxDelayTime:1},o1=(n,t,e,s,i,r,o)=>class extends n{constructor(a,l){const c=i(a),u={...r1,...l},d=s(c,u),p=r(c),f=p?e(u.maxDelayTime):null;super(a,!1,d,f),this._delayTime=t(this,p,d.delayTime),o(this,u.maxDelayTime)}get delayTime(){return this._delayTime}},A1=(n,t,e,s,i)=>r=>{const o=new WeakMap,A=async(a,l)=>{let c=e(a);const u=We(c,l);if(!u){const d={channelCount:c.channelCount,channelCountMode:c.channelCountMode,channelInterpretation:c.channelInterpretation,delayTime:c.delayTime.value,maxDelayTime:r};c=t(l,d)}return o.set(l,c),u?await n(l,a.delayTime,c.delayTime):await s(l,a.delayTime,c.delayTime),await i(a,l,c),c};return{render(a,l){const c=o.get(l);return c!==void 0?Promise.resolve(c):A(a,l)}}},a1=n=>(t,e,s,i)=>n(t[i],r=>r[0]===e&&r[1]===s),l1=n=>(t,e)=>{n(t).delete(e)},c1=n=>"delayTime"in n,u1=(n,t,e)=>function s(i,r){const o=Xl(r)?r:e(n,r);if(c1(o))return[];if(i[0]===o)return[i];if(i.includes(o))return[];const{outputs:A}=t(o);return Array.from(A).map(a=>s([...i,o],a[0])).reduce((a,l)=>a.concat(l),[])},Pa=(n,t,e)=>{const s=t[e];if(s===void 0)throw n();return s},d1=n=>(t,e=void 0,s=void 0,i=0)=>e===void 0?t.forEach(r=>r.disconnect()):typeof e=="number"?Pa(n,t,e).disconnect():jl(e)?s===void 0?t.forEach(r=>r.disconnect(e)):i===void 0?Pa(n,t,s).disconnect(e,0):Pa(n,t,s).disconnect(e,0,i):s===void 0?t.forEach(r=>r.disconnect(e)):Pa(n,t,s).disconnect(e,0),h1={attack:.003,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",knee:30,ratio:12,release:.25,threshold:-24},f1=(n,t,e,s,i,r,o,A)=>class extends n{constructor(l,c){const u=r(l),d={...h1,...c},p=s(u,d),f=o(u),m=f?e():null;super(l,!1,p,m),this._attack=t(this,f,p.attack),this._knee=t(this,f,p.knee),this._nativeDynamicsCompressorNode=p,this._ratio=t(this,f,p.ratio),this._release=t(this,f,p.release),this._threshold=t(this,f,p.threshold),A(this,.006)}get attack(){return this._attack}get channelCount(){return this._nativeDynamicsCompressorNode.channelCount}set channelCount(l){const c=this._nativeDynamicsCompressorNode.channelCount;if(this._nativeDynamicsCompressorNode.channelCount=l,l>2)throw this._nativeDynamicsCompressorNode.channelCount=c,i()}get channelCountMode(){return this._nativeDynamicsCompressorNode.channelCountMode}set channelCountMode(l){const c=this._nativeDynamicsCompressorNode.channelCountMode;if(this._nativeDynamicsCompressorNode.channelCountMode=l,l==="max")throw this._nativeDynamicsCompressorNode.channelCountMode=c,i()}get knee(){return this._knee}get ratio(){return this._ratio}get reduction(){return typeof this._nativeDynamicsCompressorNode.reduction.value=="number"?this._nativeDynamicsCompressorNode.reduction.value:this._nativeDynamicsCompressorNode.reduction}get release(){return this._release}get threshold(){return this._threshold}},p1=(n,t,e,s,i)=>()=>{const r=new WeakMap,o=async(A,a)=>{let l=e(A);const c=We(l,a);if(!c){const u={attack:l.attack.value,channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,knee:l.knee.value,ratio:l.ratio.value,release:l.release.value,threshold:l.threshold.value};l=t(a,u)}return r.set(a,l),c?(await n(a,A.attack,l.attack),await n(a,A.knee,l.knee),await n(a,A.ratio,l.ratio),await n(a,A.release,l.release),await n(a,A.threshold,l.threshold)):(await s(a,A.attack,l.attack),await s(a,A.knee,l.knee),await s(a,A.ratio,l.ratio),await s(a,A.release,l.release),await s(a,A.threshold,l.threshold)),await i(A,a,l),l};return{render(A,a){const l=r.get(a);return l!==void 0?Promise.resolve(l):o(A,a)}}},m1=()=>new DOMException("","EncodingError"),g1=n=>t=>new Promise((e,s)=>{if(n===null){s(new SyntaxError);return}const i=n.document.head;if(i===null)s(new SyntaxError);else{const r=n.document.createElement("script"),o=new Blob([t],{type:"application/javascript"}),A=URL.createObjectURL(o),a=n.onerror,l=()=>{n.onerror=a,URL.revokeObjectURL(A)};n.onerror=(c,u,d,p,f)=>{if(u===A||u===n.location.href&&d===1&&p===1)return l(),s(f),!1;if(a!==null)return a(c,u,d,p,f)},r.onerror=()=>{l(),s(new SyntaxError)},r.onload=()=>{l(),e()},r.src=A,r.type="module",i.appendChild(r)}}),w1=n=>class{constructor(e){this._nativeEventTarget=e,this._listeners=new WeakMap}addEventListener(e,s,i){if(s!==null){let r=this._listeners.get(s);r===void 0&&(r=n(this,s),typeof s=="function"&&this._listeners.set(s,r)),this._nativeEventTarget.addEventListener(e,r,i)}}dispatchEvent(e){return this._nativeEventTarget.dispatchEvent(e)}removeEventListener(e,s,i){const r=s===null?void 0:this._listeners.get(s);this._nativeEventTarget.removeEventListener(e,r===void 0?null:r,i)}},v1=n=>(t,e,s)=>{Object.defineProperties(n,{currentFrame:{configurable:!0,get(){return Math.round(t*e)}},currentTime:{configurable:!0,get(){return t}}});try{return s()}finally{n!==null&&(delete n.currentFrame,delete n.currentTime)}},B1=n=>async t=>{try{const e=await fetch(t);if(e.ok)return[await e.text(),e.url]}catch{}throw n()},C1={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",gain:1},b1=(n,t,e,s,i,r)=>class extends n{constructor(A,a){const l=i(A),c={...C1,...a},u=s(l,c),d=r(l),p=d?e():null;super(A,!1,u,p),this._gain=t(this,d,u.gain,$e,rn)}get gain(){return this._gain}},y1=(n,t,e,s,i)=>()=>{const r=new WeakMap,o=async(A,a)=>{let l=e(A);const c=We(l,a);if(!c){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,gain:l.gain.value};l=t(a,u)}return r.set(a,l),c?await n(a,A.gain,l.gain):await s(a,A.gain,l.gain),await i(A,a,l),l};return{render(A,a){const l=r.get(a);return l!==void 0?Promise.resolve(l):o(A,a)}}},S1=(n,t)=>e=>t(n,e),E1=n=>t=>{const e=n(t);if(e.renderer===null)throw new Error("Missing the renderer of the given AudioNode in the audio graph.");return e.renderer},x1=n=>t=>{var e;return(e=n.get(t))!==null&&e!==void 0?e:0},_1=n=>t=>{const e=n(t);if(e.renderer===null)throw new Error("Missing the renderer of the given AudioParam in the audio graph.");return e.renderer},I1=n=>t=>n.get(t),xe=()=>new DOMException("","InvalidStateError"),F1=n=>t=>{const e=n.get(t);if(e===void 0)throw xe();return e},T1=(n,t)=>e=>{let s=n.get(e);if(s!==void 0)return s;if(t===null)throw new Error("Missing the native OfflineAudioContext constructor.");return s=new t(1,1,44100),n.set(e,s),s},Q1=n=>t=>{const e=n.get(t);if(e===void 0)throw new Error("The context has no set of AudioWorkletNodes.");return e},Hc=()=>new DOMException("","InvalidAccessError"),M1=n=>{n.getFrequencyResponse=(t=>(e,s,i)=>{if(e.length!==s.length||s.length!==i.length)throw Hc();return t.call(n,e,s,i)})(n.getFrequencyResponse)},U1={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers"},P1=(n,t,e,s,i,r)=>class extends n{constructor(A,a){const l=s(A),c=i(l),u={...U1,...a},d=t(l,c?null:A.baseLatency,u),p=c?e(u.feedback,u.feedforward):null;super(A,!1,d,p),M1(d),this._nativeIIRFilterNode=d,r(this,1)}getFrequencyResponse(A,a,l){return this._nativeIIRFilterNode.getFrequencyResponse(A,a,l)}},fw=(n,t,e,s,i,r,o,A,a,l,c)=>{const u=l.length;let d=A;for(let p=0;p<u;p+=1){let f=e[0]*l[p];for(let m=1;m<i;m+=1){const g=d-m&a-1;f+=e[m]*r[g],f-=n[m]*o[g]}for(let m=i;m<s;m+=1)f+=e[m]*r[d-m&a-1];for(let m=i;m<t;m+=1)f-=n[m]*o[d-m&a-1];r[d]=l[p],o[d]=f,d=d+1&a-1,c[p]=f}return d},N1=(n,t,e,s)=>{const i=e instanceof Float64Array?e:new Float64Array(e),r=s instanceof Float64Array?s:new Float64Array(s),o=i.length,A=r.length,a=Math.min(o,A);if(i[0]!==1){for(let f=0;f<o;f+=1)r[f]/=i[0];for(let f=1;f<A;f+=1)i[f]/=i[0]}const l=32,c=new Float32Array(l),u=new Float32Array(l),d=t.createBuffer(n.numberOfChannels,n.length,n.sampleRate),p=n.numberOfChannels;for(let f=0;f<p;f+=1){const m=n.getChannelData(f),g=d.getChannelData(f);c.fill(0),u.fill(0),fw(i,o,r,A,a,c,u,0,l,m,g)}return d},D1=(n,t,e,s,i)=>(r,o)=>{const A=new WeakMap;let a=null;const l=async(c,u)=>{let d=null,p=t(c);const f=We(p,u);if(u.createIIRFilter===void 0?d=n(u,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}):f||(p=u.createIIRFilter(o,r)),A.set(u,d===null?p:d),d!==null){if(a===null){if(e===null)throw new Error("Missing the native OfflineAudioContext constructor.");const g=new e(c.context.destination.channelCount,c.context.length,u.sampleRate);a=(async()=>{await s(c,g,g.destination);const w=await i(g);return N1(w,u,r,o)})()}const m=await a;return d.buffer=m,d.start(0),d}return await s(c,u,p),p};return{render(c,u){const d=A.get(u);return d!==void 0?Promise.resolve(d):l(c,u)}}},L1=(n,t,e,s,i,r)=>o=>(A,a)=>{const l=n.get(A);if(l===void 0){if(!o&&r(A)){const c=s(A),{outputs:u}=e(A);for(const d of u)if(wa(d)){const p=s(d[0]);t(c,p,d[1],d[2])}else{const p=i(d[0]);c.disconnect(p,d[1])}}n.set(A,a)}else n.set(A,l+a)},k1=(n,t)=>e=>{const s=n.get(e);return t(s)||t(e)},R1=(n,t)=>e=>n.has(e)||t(e),H1=(n,t)=>e=>n.has(e)||t(e),O1=(n,t)=>e=>{const s=n.get(e);return t(s)||t(e)},V1=n=>t=>n!==null&&t instanceof n,W1=n=>t=>n!==null&&typeof n.AudioNode=="function"&&t instanceof n.AudioNode,G1=n=>t=>n!==null&&typeof n.AudioParam=="function"&&t instanceof n.AudioParam,K1=(n,t)=>e=>n(e)||t(e),q1=n=>t=>n!==null&&t instanceof n,z1=n=>n!==null&&n.isSecureContext,X1=(n,t,e,s)=>class extends n{constructor(r,o){const A=e(r),a=t(A,o);if(s(A))throw TypeError();super(r,!0,a,null),this._nativeMediaElementAudioSourceNode=a}get mediaElement(){return this._nativeMediaElementAudioSourceNode.mediaElement}},$1={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers"},Y1=(n,t,e,s)=>class extends n{constructor(r,o){const A=e(r);if(s(A))throw new TypeError;const a={...$1,...o},l=t(A,a);super(r,!1,l,null),this._nativeMediaStreamAudioDestinationNode=l}get stream(){return this._nativeMediaStreamAudioDestinationNode.stream}},j1=(n,t,e,s)=>class extends n{constructor(r,o){const A=e(r),a=t(A,o);if(s(A))throw new TypeError;super(r,!0,a,null),this._nativeMediaStreamAudioSourceNode=a}get mediaStream(){return this._nativeMediaStreamAudioSourceNode.mediaStream}},J1=(n,t,e)=>class extends n{constructor(i,r){const o=e(i),A=t(o,r);super(i,!0,A,null)}},Z1=(n,t,e,s,i,r)=>class extends e{constructor(A,a){super(A),this._nativeContext=A,kc.set(this,A),s(A)&&i.set(A,new Set),this._destination=new n(this,a),this._listener=t(this,A),this._onstatechange=null}get currentTime(){return this._nativeContext.currentTime}get destination(){return this._destination}get listener(){return this._listener}get onstatechange(){return this._onstatechange}set onstatechange(A){const a=typeof A=="function"?r(this,A):null;this._nativeContext.onstatechange=a;const l=this._nativeContext.onstatechange;this._onstatechange=l!==null&&l===a?A:l}get sampleRate(){return this._nativeContext.sampleRate}get state(){return this._nativeContext.state}},RA=n=>{const t=new Uint32Array([1179011410,40,1163280727,544501094,16,131073,44100,176400,1048580,1635017060,4,0]);try{const e=n.decodeAudioData(t.buffer,()=>{});return e===void 0?!1:(e.catch(()=>{}),!0)}catch{}return!1},tS=(n,t)=>(e,s,i)=>{const r=new Set;return e.connect=(o=>(A,a=0,l=0)=>{const c=r.size===0;if(t(A))return o.call(e,A,a,l),n(r,[A,a,l],u=>u[0]===A&&u[1]===a&&u[2]===l,!0),c&&s(),A;o.call(e,A,a),n(r,[A,a],u=>u[0]===A&&u[1]===a,!0),c&&s()})(e.connect),e.disconnect=(o=>(A,a,l)=>{const c=r.size>0;if(A===void 0)o.apply(e),r.clear();else if(typeof A=="number"){o.call(e,A);for(const d of r)d[1]===A&&r.delete(d)}else{t(A)?o.call(e,A,a,l):o.call(e,A,a);for(const d of r)d[0]===A&&(a===void 0||d[1]===a)&&(l===void 0||d[2]===l)&&r.delete(d)}const u=r.size===0;c&&u&&i()})(e.disconnect),e},ne=(n,t,e)=>{const s=t[e];s!==void 0&&s!==n[e]&&(n[e]=s)},ye=(n,t)=>{ne(n,t,"channelCount"),ne(n,t,"channelCountMode"),ne(n,t,"channelInterpretation")},om=n=>typeof n.getFloatTimeDomainData=="function",eS=n=>{n.getFloatTimeDomainData=t=>{const e=new Uint8Array(t.length);n.getByteTimeDomainData(e);const s=Math.max(e.length,n.fftSize);for(let i=0;i<s;i+=1)t[i]=(e[i]-128)*.0078125;return t}},nS=(n,t)=>(e,s)=>{const i=e.createAnalyser();if(ye(i,s),!(s.maxDecibels>s.minDecibels))throw t();return ne(i,s,"fftSize"),ne(i,s,"maxDecibels"),ne(i,s,"minDecibels"),ne(i,s,"smoothingTimeConstant"),n(om,()=>om(i))||eS(i),i},sS=n=>n===null?null:n.hasOwnProperty("AudioBuffer")?n.AudioBuffer:null,oe=(n,t,e)=>{const s=t[e];s!==void 0&&s!==n[e].value&&(n[e].value=s)},iS=n=>{n.start=(t=>{let e=!1;return(s=0,i=0,r)=>{if(e)throw xe();t.call(n,s,i,r),e=!0}})(n.start)},ff=n=>{n.start=(t=>(e=0,s=0,i)=>{if(typeof i=="number"&&i<0||s<0||e<0)throw new RangeError("The parameters can't be negative.");t.call(n,e,s,i)})(n.start)},pf=n=>{n.stop=(t=>(e=0)=>{if(e<0)throw new RangeError("The parameter can't be negative.");t.call(n,e)})(n.stop)},rS=(n,t,e,s,i,r,o,A,a,l,c)=>(u,d)=>{const p=u.createBufferSource();return ye(p,d),oe(p,d,"playbackRate"),ne(p,d,"buffer"),ne(p,d,"loop"),ne(p,d,"loopEnd"),ne(p,d,"loopStart"),t(e,()=>e(u))||iS(p),t(s,()=>s(u))||a(p),t(i,()=>i(u))||l(p,u),t(r,()=>r(u))||ff(p),t(o,()=>o(u))||c(p,u),t(A,()=>A(u))||pf(p),n(u,p),p},oS=n=>n===null?null:n.hasOwnProperty("AudioContext")?n.AudioContext:n.hasOwnProperty("webkitAudioContext")?n.webkitAudioContext:null,AS=(n,t)=>(e,s,i)=>{const r=e.destination;if(r.channelCount!==s)try{r.channelCount=s}catch{}i&&r.channelCountMode!=="explicit"&&(r.channelCountMode="explicit"),r.maxChannelCount===0&&Object.defineProperty(r,"maxChannelCount",{value:s});const o=n(e,{channelCount:s,channelCountMode:r.channelCountMode,channelInterpretation:r.channelInterpretation,gain:1});return t(o,"channelCount",A=>()=>A.call(o),A=>a=>{A.call(o,a);try{r.channelCount=a}catch(l){if(a>r.maxChannelCount)throw l}}),t(o,"channelCountMode",A=>()=>A.call(o),A=>a=>{A.call(o,a),r.channelCountMode=a}),t(o,"channelInterpretation",A=>()=>A.call(o),A=>a=>{A.call(o,a),r.channelInterpretation=a}),Object.defineProperty(o,"maxChannelCount",{get:()=>r.maxChannelCount}),o.connect(r),o},aS=n=>n===null?null:n.hasOwnProperty("AudioWorkletNode")?n.AudioWorkletNode:null,lS=n=>{const{port1:t}=new MessageChannel;try{t.postMessage(n)}finally{t.close()}},cS=(n,t,e,s,i)=>(r,o,A,a,l,c)=>{if(A!==null)try{const u=new A(r,a,c),d=new Map;let p=null;if(Object.defineProperties(u,{channelCount:{get:()=>c.channelCount,set:()=>{throw n()}},channelCountMode:{get:()=>"explicit",set:()=>{throw n()}},onprocessorerror:{get:()=>p,set:f=>{typeof p=="function"&&u.removeEventListener("processorerror",p),p=typeof f=="function"?f:null,typeof p=="function"&&u.addEventListener("processorerror",p)}}}),u.addEventListener=(f=>(...m)=>{if(m[0]==="processorerror"){const g=typeof m[1]=="function"?m[1]:typeof m[1]=="object"&&m[1]!==null&&typeof m[1].handleEvent=="function"?m[1].handleEvent:null;if(g!==null){const w=d.get(m[1]);w!==void 0?m[1]=w:(m[1]=B=>{B.type==="error"?(Object.defineProperties(B,{type:{value:"processorerror"}}),g(B)):g(new ErrorEvent(m[0],{...B}))},d.set(g,m[1]))}}return f.call(u,"error",m[1],m[2]),f.call(u,...m)})(u.addEventListener),u.removeEventListener=(f=>(...m)=>{if(m[0]==="processorerror"){const g=d.get(m[1]);g!==void 0&&(d.delete(m[1]),m[1]=g)}return f.call(u,"error",m[1],m[2]),f.call(u,m[0],m[1],m[2])})(u.removeEventListener),c.numberOfOutputs!==0){const f=e(r,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return u.connect(f).connect(r.destination),i(u,()=>f.disconnect(),()=>f.connect(r.destination))}return u}catch(u){throw u.code===11?s():u}if(l===void 0)throw s();return lS(c),t(r,o,l,c)},pw=(n,t)=>n===null?512:Math.max(512,Math.min(16384,Math.pow(2,Math.round(Math.log2(n*t))))),uS=n=>new Promise((t,e)=>{const{port1:s,port2:i}=new MessageChannel;s.onmessage=({data:r})=>{s.close(),i.close(),t(r)},s.onmessageerror=({data:r})=>{s.close(),i.close(),e(r)},i.postMessage(n)}),dS=async(n,t)=>{const e=await uS(t);return new n(e)},hS=(n,t,e,s)=>{let i=kd.get(n);i===void 0&&(i=new WeakMap,kd.set(n,i));const r=dS(e,s);return i.set(t,r),r},fS=(n,t,e,s,i,r,o,A,a,l,c,u,d)=>(p,f,m,g)=>{if(g.numberOfInputs===0&&g.numberOfOutputs===0)throw a();const w=Array.isArray(g.outputChannelCount)?g.outputChannelCount:Array.from(g.outputChannelCount);if(w.some(D=>D<1))throw a();if(w.length!==g.numberOfOutputs)throw t();if(g.channelCountMode!=="explicit")throw a();const B=g.channelCount*g.numberOfInputs,b=w.reduce((D,q)=>D+q,0),_=m.parameterDescriptors===void 0?0:m.parameterDescriptors.length;if(B+_>6||b>6)throw a();const v=new MessageChannel,C=[],y=[];for(let D=0;D<g.numberOfInputs;D+=1)C.push(o(p,{channelCount:g.channelCount,channelCountMode:g.channelCountMode,channelInterpretation:g.channelInterpretation,gain:1})),y.push(i(p,{channelCount:g.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:g.channelCount}));const S=[];if(m.parameterDescriptors!==void 0)for(const{defaultValue:D,maxValue:q,minValue:z,name:et}of m.parameterDescriptors){const Z=r(p,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:g.parameterData[et]!==void 0?g.parameterData[et]:D===void 0?0:D});Object.defineProperties(Z.offset,{defaultValue:{get:()=>D===void 0?0:D},maxValue:{get:()=>q===void 0?$e:q},minValue:{get:()=>z===void 0?rn:z}}),S.push(Z)}const F=s(p,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,B+_)}),x=pw(f,p.sampleRate),Q=A(p,x,B+_,Math.max(1,b)),T=i(p,{channelCount:Math.max(1,b),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,b)}),U=[];for(let D=0;D<g.numberOfOutputs;D+=1)U.push(s(p,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:w[D]}));for(let D=0;D<g.numberOfInputs;D+=1){C[D].connect(y[D]);for(let q=0;q<g.channelCount;q+=1)y[D].connect(F,q,D*g.channelCount+q)}const P=new dw(m.parameterDescriptors===void 0?[]:m.parameterDescriptors.map(({name:D},q)=>{const z=S[q];return z.connect(F,0,B+q),z.start(0),[D,z.offset]}));F.connect(Q);let K=g.channelInterpretation,M=null;const k=g.numberOfOutputs===0?[Q]:U,N={get bufferSize(){return x},get channelCount(){return g.channelCount},set channelCount(D){throw e()},get channelCountMode(){return g.channelCountMode},set channelCountMode(D){throw e()},get channelInterpretation(){return K},set channelInterpretation(D){for(const q of C)q.channelInterpretation=D;K=D},get context(){return Q.context},get inputs(){return C},get numberOfInputs(){return g.numberOfInputs},get numberOfOutputs(){return g.numberOfOutputs},get onprocessorerror(){return M},set onprocessorerror(D){typeof M=="function"&&N.removeEventListener("processorerror",M),M=typeof D=="function"?D:null,typeof M=="function"&&N.addEventListener("processorerror",M)},get parameters(){return P},get port(){return v.port2},addEventListener(...D){return Q.addEventListener(D[0],D[1],D[2])},connect:n.bind(null,k),disconnect:l.bind(null,k),dispatchEvent(...D){return Q.dispatchEvent(D[0])},removeEventListener(...D){return Q.removeEventListener(D[0],D[1],D[2])}},R=new Map;v.port1.addEventListener=(D=>(...q)=>{if(q[0]==="message"){const z=typeof q[1]=="function"?q[1]:typeof q[1]=="object"&&q[1]!==null&&typeof q[1].handleEvent=="function"?q[1].handleEvent:null;if(z!==null){const et=R.get(q[1]);et!==void 0?q[1]=et:(q[1]=Z=>{c(p.currentTime,p.sampleRate,()=>z(Z))},R.set(z,q[1]))}}return D.call(v.port1,q[0],q[1],q[2])})(v.port1.addEventListener),v.port1.removeEventListener=(D=>(...q)=>{if(q[0]==="message"){const z=R.get(q[1]);z!==void 0&&(R.delete(q[1]),q[1]=z)}return D.call(v.port1,q[0],q[1],q[2])})(v.port1.removeEventListener);let J=null;Object.defineProperty(v.port1,"onmessage",{get:()=>J,set:D=>{typeof J=="function"&&v.port1.removeEventListener("message",J),J=typeof D=="function"?D:null,typeof J=="function"&&(v.port1.addEventListener("message",J),v.port1.start())}}),m.prototype.port=v.port1;let tt=null;hS(p,N,m,g).then(D=>tt=D);const lt=Zl(g.numberOfInputs,g.channelCount),W=Zl(g.numberOfOutputs,w),H=m.parameterDescriptors===void 0?[]:m.parameterDescriptors.reduce((D,{name:q})=>({...D,[q]:new Float32Array(128)}),{});let O=!0;const $=()=>{g.numberOfOutputs>0&&Q.disconnect(T);for(let D=0,q=0;D<g.numberOfOutputs;D+=1){const z=U[D];for(let et=0;et<w[D];et+=1)T.disconnect(z,q+et,et);q+=w[D]}},L=new Map;Q.onaudioprocess=({inputBuffer:D,outputBuffer:q})=>{if(tt!==null){const z=u(N);for(let et=0;et<x;et+=128){for(let Z=0;Z<g.numberOfInputs;Z+=1)for(let st=0;st<g.channelCount;st+=1)Jl(D,lt[Z],st,st,et);m.parameterDescriptors!==void 0&&m.parameterDescriptors.forEach(({name:Z},st)=>{Jl(D,H,Z,B+st,et)});for(let Z=0;Z<g.numberOfInputs;Z+=1)for(let st=0;st<w[Z];st+=1)W[Z][st].byteLength===0&&(W[Z][st]=new Float32Array(128));try{const Z=lt.map((pt,St)=>{if(z[St].size>0)return L.set(St,x/128),pt;const Et=L.get(St);return Et===void 0?[]:(pt.every(_t=>_t.every(Jt=>Jt===0))&&(Et===1?L.delete(St):L.set(St,Et-1)),pt)});O=c(p.currentTime+et/p.sampleRate,p.sampleRate,()=>tt.process(Z,W,H));for(let pt=0,St=0;pt<g.numberOfOutputs;pt+=1){for(let Mt=0;Mt<w[pt];Mt+=1)hw(q,W[pt],Mt,St+Mt,et);St+=w[pt]}}catch(Z){O=!1,N.dispatchEvent(new ErrorEvent("processorerror",{colno:Z.colno,filename:Z.filename,lineno:Z.lineno,message:Z.message}))}if(!O){for(let Z=0;Z<g.numberOfInputs;Z+=1){C[Z].disconnect(y[Z]);for(let st=0;st<g.channelCount;st+=1)y[et].disconnect(F,st,Z*g.channelCount+st)}if(m.parameterDescriptors!==void 0){const Z=m.parameterDescriptors.length;for(let st=0;st<Z;st+=1){const pt=S[st];pt.disconnect(F,0,B+st),pt.stop()}}F.disconnect(Q),Q.onaudioprocess=null,at?$():V();break}}}};let at=!1;const G=o(p,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0}),X=()=>Q.connect(G).connect(p.destination),V=()=>{Q.disconnect(G),G.disconnect()},Y=()=>{if(O){V(),g.numberOfOutputs>0&&Q.connect(T);for(let D=0,q=0;D<g.numberOfOutputs;D+=1){const z=U[D];for(let et=0;et<w[D];et+=1)T.connect(z,q+et,et);q+=w[D]}}at=!0},nt=()=>{O&&(X(),$()),at=!1};return X(),d(N,Y,nt)},mw=(n,t)=>{const e=n.createBiquadFilter();return ye(e,t),oe(e,t,"Q"),oe(e,t,"detune"),oe(e,t,"frequency"),oe(e,t,"gain"),ne(e,t,"type"),e},pS=(n,t)=>(e,s)=>{const i=e.createChannelMerger(s.numberOfInputs);return n!==null&&n.name==="webkitAudioContext"&&t(e,i),ye(i,s),i},mS=n=>{const t=n.numberOfOutputs;Object.defineProperty(n,"channelCount",{get:()=>t,set:e=>{if(e!==t)throw xe()}}),Object.defineProperty(n,"channelCountMode",{get:()=>"explicit",set:e=>{if(e!=="explicit")throw xe()}}),Object.defineProperty(n,"channelInterpretation",{get:()=>"discrete",set:e=>{if(e!=="discrete")throw xe()}})},va=(n,t)=>{const e=n.createChannelSplitter(t.numberOfOutputs);return ye(e,t),mS(e),e},gS=(n,t,e,s,i)=>(r,o)=>{if(r.createConstantSource===void 0)return e(r,o);const A=r.createConstantSource();return ye(A,o),oe(A,o,"offset"),t(s,()=>s(r))||ff(A),t(i,()=>i(r))||pf(A),n(r,A),A},Ro=(n,t)=>(n.connect=t.connect.bind(t),n.disconnect=t.disconnect.bind(t),n),wS=(n,t,e,s)=>(i,{offset:r,...o})=>{const A=i.createBuffer(1,2,44100),a=t(i,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),l=e(i,{...o,gain:r}),c=A.getChannelData(0);c[0]=1,c[1]=1,a.buffer=A,a.loop=!0;const u={get bufferSize(){},get channelCount(){return l.channelCount},set channelCount(f){l.channelCount=f},get channelCountMode(){return l.channelCountMode},set channelCountMode(f){l.channelCountMode=f},get channelInterpretation(){return l.channelInterpretation},set channelInterpretation(f){l.channelInterpretation=f},get context(){return l.context},get inputs(){return[]},get numberOfInputs(){return a.numberOfInputs},get numberOfOutputs(){return l.numberOfOutputs},get offset(){return l.gain},get onended(){return a.onended},set onended(f){a.onended=f},addEventListener(...f){return a.addEventListener(f[0],f[1],f[2])},dispatchEvent(...f){return a.dispatchEvent(f[0])},removeEventListener(...f){return a.removeEventListener(f[0],f[1],f[2])},start(f=0){a.start.call(a,f)},stop(f=0){a.stop.call(a,f)}},d=()=>a.connect(l),p=()=>a.disconnect(l);return n(i,a),s(Ro(u,l),d,p)},vS=(n,t)=>(e,s)=>{const i=e.createConvolver();if(ye(i,s),s.disableNormalization===i.normalize&&(i.normalize=!s.disableNormalization),ne(i,s,"buffer"),s.channelCount>2||(t(i,"channelCount",r=>()=>r.call(i),r=>o=>{if(o>2)throw n();return r.call(i,o)}),s.channelCountMode==="max"))throw n();return t(i,"channelCountMode",r=>()=>r.call(i),r=>o=>{if(o==="max")throw n();return r.call(i,o)}),i},gw=(n,t)=>{const e=n.createDelay(t.maxDelayTime);return ye(e,t),oe(e,t,"delayTime"),e},BS=n=>(t,e)=>{const s=t.createDynamicsCompressor();if(ye(s,e),e.channelCount>2||e.channelCountMode==="max")throw n();return oe(s,e,"attack"),oe(s,e,"knee"),oe(s,e,"ratio"),oe(s,e,"release"),oe(s,e,"threshold"),s},hn=(n,t)=>{const e=n.createGain();return ye(e,t),oe(e,t,"gain"),e},CS=n=>(t,e,s)=>{if(t.createIIRFilter===void 0)return n(t,e,s);const i=t.createIIRFilter(s.feedforward,s.feedback);return ye(i,s),i};function bS(n,t){const e=t[0]*t[0]+t[1]*t[1];return[(n[0]*t[0]+n[1]*t[1])/e,(n[1]*t[0]-n[0]*t[1])/e]}function yS(n,t){return[n[0]*t[0]-n[1]*t[1],n[0]*t[1]+n[1]*t[0]]}function Am(n,t){let e=[0,0];for(let s=n.length-1;s>=0;s-=1)e=yS(e,t),e[0]+=n[s];return e}const SS=(n,t,e,s)=>(i,r,{channelCount:o,channelCountMode:A,channelInterpretation:a,feedback:l,feedforward:c})=>{const u=pw(r,i.sampleRate),d=l instanceof Float64Array?l:new Float64Array(l),p=c instanceof Float64Array?c:new Float64Array(c),f=d.length,m=p.length,g=Math.min(f,m);if(f===0||f>20)throw s();if(d[0]===0)throw t();if(m===0||m>20)throw s();if(p[0]===0)throw t();if(d[0]!==1){for(let S=0;S<m;S+=1)p[S]/=d[0];for(let S=1;S<f;S+=1)d[S]/=d[0]}const w=e(i,u,o,o);w.channelCount=o,w.channelCountMode=A,w.channelInterpretation=a;const B=32,b=[],_=[],v=[];for(let S=0;S<o;S+=1){b.push(0);const F=new Float32Array(B),x=new Float32Array(B);F.fill(0),x.fill(0),_.push(F),v.push(x)}w.onaudioprocess=S=>{const F=S.inputBuffer,x=S.outputBuffer,Q=F.numberOfChannels;for(let T=0;T<Q;T+=1){const U=F.getChannelData(T),P=x.getChannelData(T);b[T]=fw(d,f,p,m,g,_[T],v[T],b[T],B,U,P)}};const C=i.sampleRate/2;return Ro({get bufferSize(){return u},get channelCount(){return w.channelCount},set channelCount(S){w.channelCount=S},get channelCountMode(){return w.channelCountMode},set channelCountMode(S){w.channelCountMode=S},get channelInterpretation(){return w.channelInterpretation},set channelInterpretation(S){w.channelInterpretation=S},get context(){return w.context},get inputs(){return[w]},get numberOfInputs(){return w.numberOfInputs},get numberOfOutputs(){return w.numberOfOutputs},addEventListener(...S){return w.addEventListener(S[0],S[1],S[2])},dispatchEvent(...S){return w.dispatchEvent(S[0])},getFrequencyResponse(S,F,x){if(S.length!==F.length||F.length!==x.length)throw n();const Q=S.length;for(let T=0;T<Q;T+=1){const U=-Math.PI*(S[T]/C),P=[Math.cos(U),Math.sin(U)],K=Am(p,P),M=Am(d,P),k=bS(K,M);F[T]=Math.sqrt(k[0]*k[0]+k[1]*k[1]),x[T]=Math.atan2(k[1],k[0])}},removeEventListener(...S){return w.removeEventListener(S[0],S[1],S[2])}},w)},ES=(n,t)=>n.createMediaElementSource(t.mediaElement),xS=(n,t)=>{const e=n.createMediaStreamDestination();return ye(e,t),e.numberOfOutputs===1&&Object.defineProperty(e,"numberOfOutputs",{get:()=>0}),e},_S=(n,{mediaStream:t})=>{const e=t.getAudioTracks();e.sort((r,o)=>r.id<o.id?-1:r.id>o.id?1:0);const s=e.slice(0,1),i=n.createMediaStreamSource(new MediaStream(s));return Object.defineProperty(i,"mediaStream",{value:t}),i},IS=(n,t)=>(e,{mediaStreamTrack:s})=>{if(typeof e.createMediaStreamTrackSource=="function")return e.createMediaStreamTrackSource(s);const i=new MediaStream([s]),r=e.createMediaStreamSource(i);if(s.kind!=="audio")throw n();if(t(e))throw new TypeError;return r},FS=n=>n===null?null:n.hasOwnProperty("OfflineAudioContext")?n.OfflineAudioContext:n.hasOwnProperty("webkitOfflineAudioContext")?n.webkitOfflineAudioContext:null,TS=(n,t,e,s,i,r)=>(o,A)=>{const a=o.createOscillator();return ye(a,A),oe(a,A,"detune"),oe(a,A,"frequency"),A.periodicWave!==void 0?a.setPeriodicWave(A.periodicWave):ne(a,A,"type"),t(e,()=>e(o))||ff(a),t(s,()=>s(o))||r(a,o),t(i,()=>i(o))||pf(a),n(o,a),a},QS=n=>(t,e)=>{const s=t.createPanner();return s.orientationX===void 0?n(t,e):(ye(s,e),oe(s,e,"orientationX"),oe(s,e,"orientationY"),oe(s,e,"orientationZ"),oe(s,e,"positionX"),oe(s,e,"positionY"),oe(s,e,"positionZ"),ne(s,e,"coneInnerAngle"),ne(s,e,"coneOuterAngle"),ne(s,e,"coneOuterGain"),ne(s,e,"distanceModel"),ne(s,e,"maxDistance"),ne(s,e,"panningModel"),ne(s,e,"refDistance"),ne(s,e,"rolloffFactor"),s)},MS=(n,t,e,s,i,r,o,A,a,l)=>(c,{coneInnerAngle:u,coneOuterAngle:d,coneOuterGain:p,distanceModel:f,maxDistance:m,orientationX:g,orientationY:w,orientationZ:B,panningModel:b,positionX:_,positionY:v,positionZ:C,refDistance:y,rolloffFactor:S,...F})=>{const x=c.createPanner();if(F.channelCount>2||F.channelCountMode==="max")throw o();ye(x,F);const Q={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},T=e(c,{...Q,channelInterpretation:"speakers",numberOfInputs:6}),U=s(c,{...F,gain:1}),P=s(c,{...Q,gain:1}),K=s(c,{...Q,gain:0}),M=s(c,{...Q,gain:0}),k=s(c,{...Q,gain:0}),N=s(c,{...Q,gain:0}),R=s(c,{...Q,gain:0}),J=i(c,256,6,1),tt=r(c,{...Q,curve:new Float32Array([1,1]),oversample:"none"});let rt=[g,w,B],lt=[_,v,C];const W=new Float32Array(1);J.onaudioprocess=({inputBuffer:L})=>{const at=[a(L,W,0),a(L,W,1),a(L,W,2)];at.some((X,V)=>X!==rt[V])&&(x.setOrientation(...at),rt=at);const G=[a(L,W,3),a(L,W,4),a(L,W,5)];G.some((X,V)=>X!==lt[V])&&(x.setPosition(...G),lt=G)},Object.defineProperty(K.gain,"defaultValue",{get:()=>0}),Object.defineProperty(M.gain,"defaultValue",{get:()=>0}),Object.defineProperty(k.gain,"defaultValue",{get:()=>0}),Object.defineProperty(N.gain,"defaultValue",{get:()=>0}),Object.defineProperty(R.gain,"defaultValue",{get:()=>0});const H={get bufferSize(){},get channelCount(){return x.channelCount},set channelCount(L){if(L>2)throw o();U.channelCount=L,x.channelCount=L},get channelCountMode(){return x.channelCountMode},set channelCountMode(L){if(L==="max")throw o();U.channelCountMode=L,x.channelCountMode=L},get channelInterpretation(){return x.channelInterpretation},set channelInterpretation(L){U.channelInterpretation=L,x.channelInterpretation=L},get coneInnerAngle(){return x.coneInnerAngle},set coneInnerAngle(L){x.coneInnerAngle=L},get coneOuterAngle(){return x.coneOuterAngle},set coneOuterAngle(L){x.coneOuterAngle=L},get coneOuterGain(){return x.coneOuterGain},set coneOuterGain(L){if(L<0||L>1)throw t();x.coneOuterGain=L},get context(){return x.context},get distanceModel(){return x.distanceModel},set distanceModel(L){x.distanceModel=L},get inputs(){return[U]},get maxDistance(){return x.maxDistance},set maxDistance(L){if(L<0)throw new RangeError;x.maxDistance=L},get numberOfInputs(){return x.numberOfInputs},get numberOfOutputs(){return x.numberOfOutputs},get orientationX(){return P.gain},get orientationY(){return K.gain},get orientationZ(){return M.gain},get panningModel(){return x.panningModel},set panningModel(L){x.panningModel=L},get positionX(){return k.gain},get positionY(){return N.gain},get positionZ(){return R.gain},get refDistance(){return x.refDistance},set refDistance(L){if(L<0)throw new RangeError;x.refDistance=L},get rolloffFactor(){return x.rolloffFactor},set rolloffFactor(L){if(L<0)throw new RangeError;x.rolloffFactor=L},addEventListener(...L){return U.addEventListener(L[0],L[1],L[2])},dispatchEvent(...L){return U.dispatchEvent(L[0])},removeEventListener(...L){return U.removeEventListener(L[0],L[1],L[2])}};u!==H.coneInnerAngle&&(H.coneInnerAngle=u),d!==H.coneOuterAngle&&(H.coneOuterAngle=d),p!==H.coneOuterGain&&(H.coneOuterGain=p),f!==H.distanceModel&&(H.distanceModel=f),m!==H.maxDistance&&(H.maxDistance=m),g!==H.orientationX.value&&(H.orientationX.value=g),w!==H.orientationY.value&&(H.orientationY.value=w),B!==H.orientationZ.value&&(H.orientationZ.value=B),b!==H.panningModel&&(H.panningModel=b),_!==H.positionX.value&&(H.positionX.value=_),v!==H.positionY.value&&(H.positionY.value=v),C!==H.positionZ.value&&(H.positionZ.value=C),y!==H.refDistance&&(H.refDistance=y),S!==H.rolloffFactor&&(H.rolloffFactor=S),(rt[0]!==1||rt[1]!==0||rt[2]!==0)&&x.setOrientation(...rt),(lt[0]!==0||lt[1]!==0||lt[2]!==0)&&x.setPosition(...lt);const O=()=>{U.connect(x),n(U,tt,0,0),tt.connect(P).connect(T,0,0),tt.connect(K).connect(T,0,1),tt.connect(M).connect(T,0,2),tt.connect(k).connect(T,0,3),tt.connect(N).connect(T,0,4),tt.connect(R).connect(T,0,5),T.connect(J).connect(c.destination)},$=()=>{U.disconnect(x),A(U,tt,0,0),tt.disconnect(P),P.disconnect(T),tt.disconnect(K),K.disconnect(T),tt.disconnect(M),M.disconnect(T),tt.disconnect(k),k.disconnect(T),tt.disconnect(N),N.disconnect(T),tt.disconnect(R),R.disconnect(T),T.disconnect(J),J.disconnect(c.destination)};return l(Ro(H,x),O,$)},US=n=>(t,{disableNormalization:e,imag:s,real:i})=>{const r=s instanceof Float32Array?s:new Float32Array(s),o=i instanceof Float32Array?i:new Float32Array(i),A=t.createPeriodicWave(o,r,{disableNormalization:e});if(Array.from(s).length<2)throw n();return A},Ba=(n,t,e,s)=>n.createScriptProcessor(t,e,s),PS=(n,t)=>(e,s)=>{const i=s.channelCountMode;if(i==="clamped-max")throw t();if(e.createStereoPanner===void 0)return n(e,s);const r=e.createStereoPanner();return ye(r,s),oe(r,s,"pan"),Object.defineProperty(r,"channelCountMode",{get:()=>i,set:o=>{if(o!==i)throw t()}}),r},NS=(n,t,e,s,i,r)=>{const A=new Float32Array([1,1]),a=Math.PI/2,l={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},c={...l,oversample:"none"},u=(f,m,g,w)=>{const B=new Float32Array(16385),b=new Float32Array(16385);for(let F=0;F<16385;F+=1){const x=F/16384*a;B[F]=Math.cos(x),b[F]=Math.sin(x)}const _=e(f,{...l,gain:0}),v=s(f,{...c,curve:B}),C=s(f,{...c,curve:A}),y=e(f,{...l,gain:0}),S=s(f,{...c,curve:b});return{connectGraph(){m.connect(_),m.connect(C.inputs===void 0?C:C.inputs[0]),m.connect(y),C.connect(g),g.connect(v.inputs===void 0?v:v.inputs[0]),g.connect(S.inputs===void 0?S:S.inputs[0]),v.connect(_.gain),S.connect(y.gain),_.connect(w,0,0),y.connect(w,0,1)},disconnectGraph(){m.disconnect(_),m.disconnect(C.inputs===void 0?C:C.inputs[0]),m.disconnect(y),C.disconnect(g),g.disconnect(v.inputs===void 0?v:v.inputs[0]),g.disconnect(S.inputs===void 0?S:S.inputs[0]),v.disconnect(_.gain),S.disconnect(y.gain),_.disconnect(w,0,0),y.disconnect(w,0,1)}}},d=(f,m,g,w)=>{const B=new Float32Array(16385),b=new Float32Array(16385),_=new Float32Array(16385),v=new Float32Array(16385),C=Math.floor(16385/2);for(let k=0;k<16385;k+=1)if(k>C){const N=(k-C)/(16384-C)*a;B[k]=Math.cos(N),b[k]=Math.sin(N),_[k]=0,v[k]=1}else{const N=k/(16384-C)*a;B[k]=1,b[k]=0,_[k]=Math.cos(N),v[k]=Math.sin(N)}const y=t(f,{channelCount:2,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:2}),S=e(f,{...l,gain:0}),F=s(f,{...c,curve:B}),x=e(f,{...l,gain:0}),Q=s(f,{...c,curve:b}),T=s(f,{...c,curve:A}),U=e(f,{...l,gain:0}),P=s(f,{...c,curve:_}),K=e(f,{...l,gain:0}),M=s(f,{...c,curve:v});return{connectGraph(){m.connect(y),m.connect(T.inputs===void 0?T:T.inputs[0]),y.connect(S,0),y.connect(x,0),y.connect(U,1),y.connect(K,1),T.connect(g),g.connect(F.inputs===void 0?F:F.inputs[0]),g.connect(Q.inputs===void 0?Q:Q.inputs[0]),g.connect(P.inputs===void 0?P:P.inputs[0]),g.connect(M.inputs===void 0?M:M.inputs[0]),F.connect(S.gain),Q.connect(x.gain),P.connect(U.gain),M.connect(K.gain),S.connect(w,0,0),U.connect(w,0,0),x.connect(w,0,1),K.connect(w,0,1)},disconnectGraph(){m.disconnect(y),m.disconnect(T.inputs===void 0?T:T.inputs[0]),y.disconnect(S,0),y.disconnect(x,0),y.disconnect(U,1),y.disconnect(K,1),T.disconnect(g),g.disconnect(F.inputs===void 0?F:F.inputs[0]),g.disconnect(Q.inputs===void 0?Q:Q.inputs[0]),g.disconnect(P.inputs===void 0?P:P.inputs[0]),g.disconnect(M.inputs===void 0?M:M.inputs[0]),F.disconnect(S.gain),Q.disconnect(x.gain),P.disconnect(U.gain),M.disconnect(K.gain),S.disconnect(w,0,0),U.disconnect(w,0,0),x.disconnect(w,0,1),K.disconnect(w,0,1)}}},p=(f,m,g,w,B)=>{if(m===1)return u(f,g,w,B);if(m===2)return d(f,g,w,B);throw i()};return(f,{channelCount:m,channelCountMode:g,pan:w,...B})=>{if(g==="max")throw i();const b=n(f,{...B,channelCount:1,channelCountMode:g,numberOfInputs:2}),_=e(f,{...B,channelCount:m,channelCountMode:g,gain:1}),v=e(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:w});let{connectGraph:C,disconnectGraph:y}=p(f,m,_,v,b);Object.defineProperty(v.gain,"defaultValue",{get:()=>0}),Object.defineProperty(v.gain,"maxValue",{get:()=>1}),Object.defineProperty(v.gain,"minValue",{get:()=>-1});const S={get bufferSize(){},get channelCount(){return _.channelCount},set channelCount(T){_.channelCount!==T&&(F&&y(),{connectGraph:C,disconnectGraph:y}=p(f,T,_,v,b),F&&C()),_.channelCount=T},get channelCountMode(){return _.channelCountMode},set channelCountMode(T){if(T==="clamped-max"||T==="max")throw i();_.channelCountMode=T},get channelInterpretation(){return _.channelInterpretation},set channelInterpretation(T){_.channelInterpretation=T},get context(){return _.context},get inputs(){return[_]},get numberOfInputs(){return _.numberOfInputs},get numberOfOutputs(){return _.numberOfOutputs},get pan(){return v.gain},addEventListener(...T){return _.addEventListener(T[0],T[1],T[2])},dispatchEvent(...T){return _.dispatchEvent(T[0])},removeEventListener(...T){return _.removeEventListener(T[0],T[1],T[2])}};let F=!1;const x=()=>{C(),F=!0},Q=()=>{y(),F=!1};return r(Ro(S,b),x,Q)}},DS=(n,t,e,s,i,r,o)=>(A,a)=>{const l=A.createWaveShaper();if(r!==null&&r.name==="webkitAudioContext"&&A.createGain().gain.automationRate===void 0)return e(A,a);ye(l,a);const c=a.curve===null||a.curve instanceof Float32Array?a.curve:new Float32Array(a.curve);if(c!==null&&c.length<2)throw t();ne(l,{curve:c},"curve"),ne(l,a,"oversample");let u=null,d=!1;return o(l,"curve",m=>()=>m.call(l),m=>g=>(m.call(l,g),d&&(s(g)&&u===null?u=n(A,l):!s(g)&&u!==null&&(u(),u=null)),g)),i(l,()=>{d=!0,s(l.curve)&&(u=n(A,l))},()=>{d=!1,u!==null&&(u(),u=null)})},LS=(n,t,e,s,i)=>(r,{curve:o,oversample:A,...a})=>{const l=r.createWaveShaper(),c=r.createWaveShaper();ye(l,a),ye(c,a);const u=e(r,{...a,gain:1}),d=e(r,{...a,gain:-1}),p=e(r,{...a,gain:1}),f=e(r,{...a,gain:-1});let m=null,g=!1,w=null;const B={get bufferSize(){},get channelCount(){return l.channelCount},set channelCount(v){u.channelCount=v,d.channelCount=v,l.channelCount=v,p.channelCount=v,c.channelCount=v,f.channelCount=v},get channelCountMode(){return l.channelCountMode},set channelCountMode(v){u.channelCountMode=v,d.channelCountMode=v,l.channelCountMode=v,p.channelCountMode=v,c.channelCountMode=v,f.channelCountMode=v},get channelInterpretation(){return l.channelInterpretation},set channelInterpretation(v){u.channelInterpretation=v,d.channelInterpretation=v,l.channelInterpretation=v,p.channelInterpretation=v,c.channelInterpretation=v,f.channelInterpretation=v},get context(){return l.context},get curve(){return w},set curve(v){if(v!==null&&v.length<2)throw t();if(v===null)l.curve=v,c.curve=v;else{const C=v.length,y=new Float32Array(C+2-C%2),S=new Float32Array(C+2-C%2);y[0]=v[0],S[0]=-v[C-1];const F=Math.ceil((C+1)/2),x=(C+1)/2-1;for(let Q=1;Q<F;Q+=1){const T=Q/F*x,U=Math.floor(T),P=Math.ceil(T);y[Q]=U===P?v[U]:(1-(T-U))*v[U]+(1-(P-T))*v[P],S[Q]=U===P?-v[C-1-U]:-((1-(T-U))*v[C-1-U])-(1-(P-T))*v[C-1-P]}y[F]=C%2===1?v[F-1]:(v[F-2]+v[F-1])/2,l.curve=y,c.curve=S}w=v,g&&(s(w)&&m===null?m=n(r,u):m!==null&&(m(),m=null))},get inputs(){return[u]},get numberOfInputs(){return l.numberOfInputs},get numberOfOutputs(){return l.numberOfOutputs},get oversample(){return l.oversample},set oversample(v){l.oversample=v,c.oversample=v},addEventListener(...v){return u.addEventListener(v[0],v[1],v[2])},dispatchEvent(...v){return u.dispatchEvent(v[0])},removeEventListener(...v){return u.removeEventListener(v[0],v[1],v[2])}};o!==null&&(B.curve=o instanceof Float32Array?o:new Float32Array(o)),A!==B.oversample&&(B.oversample=A);const b=()=>{u.connect(l).connect(p),u.connect(d).connect(c).connect(f).connect(p),g=!0,s(w)&&(m=n(r,u))},_=()=>{u.disconnect(l),l.disconnect(p),u.disconnect(d),d.disconnect(c),c.disconnect(f),f.disconnect(p),g=!1,m!==null&&(m(),m=null)};return i(Ro(B,p),b,_)},tn=()=>new DOMException("","NotSupportedError"),kS={numberOfChannels:1},RS=(n,t,e,s,i)=>class extends n{constructor(o,A,a){let l;if(typeof o=="number"&&A!==void 0&&a!==void 0)l={length:A,numberOfChannels:o,sampleRate:a};else if(typeof o=="object")l=o;else throw new Error("The given parameters are not valid.");const{length:c,numberOfChannels:u,sampleRate:d}={...kS,...l},p=s(u,c,d);t(RA,()=>RA(p))||p.addEventListener("statechange",(()=>{let f=0;const m=g=>{this._state==="running"&&(f>0?(p.removeEventListener("statechange",m),g.stopImmediatePropagation(),this._waitForThePromiseToSettle(g)):f+=1)};return m})()),super(p,u),this._length=c,this._nativeOfflineAudioContext=p,this._state=null}get length(){return this._nativeOfflineAudioContext.length===void 0?this._length:this._nativeOfflineAudioContext.length}get state(){return this._state===null?this._nativeOfflineAudioContext.state:this._state}startRendering(){return this._state==="running"?Promise.reject(e()):(this._state="running",i(this.destination,this._nativeOfflineAudioContext).finally(()=>{this._state=null,aw(this)}))}_waitForThePromiseToSettle(o){this._state===null?this._nativeOfflineAudioContext.dispatchEvent(o):setTimeout(()=>this._waitForThePromiseToSettle(o))}},HS={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:440,periodicWave:void 0,type:"sine"},OS=(n,t,e,s,i,r,o)=>class extends n{constructor(a,l){const c=i(a),u={...HS,...l},d=e(c,u),p=r(c),f=p?s():null,m=a.sampleRate/2;super(a,!1,d,f),this._detune=t(this,p,d.detune,153600,-153600),this._frequency=t(this,p,d.frequency,m,-m),this._nativeOscillatorNode=d,this._onended=null,this._oscillatorNodeRenderer=f,this._oscillatorNodeRenderer!==null&&u.periodicWave!==void 0&&(this._oscillatorNodeRenderer.periodicWave=u.periodicWave)}get detune(){return this._detune}get frequency(){return this._frequency}get onended(){return this._onended}set onended(a){const l=typeof a=="function"?o(this,a):null;this._nativeOscillatorNode.onended=l;const c=this._nativeOscillatorNode.onended;this._onended=c!==null&&c===l?a:c}get type(){return this._nativeOscillatorNode.type}set type(a){this._nativeOscillatorNode.type=a,this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=null)}setPeriodicWave(a){this._nativeOscillatorNode.setPeriodicWave(a),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=a)}start(a=0){if(this._nativeOscillatorNode.start(a),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.start=a),this.context.state!=="closed"){xo(this);const l=()=>{this._nativeOscillatorNode.removeEventListener("ended",l),Zs(this)&&ma(this)};this._nativeOscillatorNode.addEventListener("ended",l)}}stop(a=0){this._nativeOscillatorNode.stop(a),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.stop=a)}},VS=(n,t,e,s,i)=>()=>{const r=new WeakMap;let o=null,A=null,a=null;const l=async(c,u)=>{let d=e(c);const p=We(d,u);if(!p){const f={channelCount:d.channelCount,channelCountMode:d.channelCountMode,channelInterpretation:d.channelInterpretation,detune:d.detune.value,frequency:d.frequency.value,periodicWave:o===null?void 0:o,type:d.type};d=t(u,f),A!==null&&d.start(A),a!==null&&d.stop(a)}return r.set(u,d),p?(await n(u,c.detune,d.detune),await n(u,c.frequency,d.frequency)):(await s(u,c.detune,d.detune),await s(u,c.frequency,d.frequency)),await i(c,u,d),d};return{set periodicWave(c){o=c},set start(c){A=c},set stop(c){a=c},render(c,u){const d=r.get(u);return d!==void 0?Promise.resolve(d):l(c,u)}}},WS={channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",coneInnerAngle:360,coneOuterAngle:360,coneOuterGain:0,distanceModel:"inverse",maxDistance:1e4,orientationX:1,orientationY:0,orientationZ:0,panningModel:"equalpower",positionX:0,positionY:0,positionZ:0,refDistance:1,rolloffFactor:1},GS=(n,t,e,s,i,r,o)=>class extends n{constructor(a,l){const c=i(a),u={...WS,...l},d=e(c,u),p=r(c),f=p?s():null;super(a,!1,d,f),this._nativePannerNode=d,this._orientationX=t(this,p,d.orientationX,$e,rn),this._orientationY=t(this,p,d.orientationY,$e,rn),this._orientationZ=t(this,p,d.orientationZ,$e,rn),this._positionX=t(this,p,d.positionX,$e,rn),this._positionY=t(this,p,d.positionY,$e,rn),this._positionZ=t(this,p,d.positionZ,$e,rn),o(this,1)}get coneInnerAngle(){return this._nativePannerNode.coneInnerAngle}set coneInnerAngle(a){this._nativePannerNode.coneInnerAngle=a}get coneOuterAngle(){return this._nativePannerNode.coneOuterAngle}set coneOuterAngle(a){this._nativePannerNode.coneOuterAngle=a}get coneOuterGain(){return this._nativePannerNode.coneOuterGain}set coneOuterGain(a){this._nativePannerNode.coneOuterGain=a}get distanceModel(){return this._nativePannerNode.distanceModel}set distanceModel(a){this._nativePannerNode.distanceModel=a}get maxDistance(){return this._nativePannerNode.maxDistance}set maxDistance(a){this._nativePannerNode.maxDistance=a}get orientationX(){return this._orientationX}get orientationY(){return this._orientationY}get orientationZ(){return this._orientationZ}get panningModel(){return this._nativePannerNode.panningModel}set panningModel(a){this._nativePannerNode.panningModel=a}get positionX(){return this._positionX}get positionY(){return this._positionY}get positionZ(){return this._positionZ}get refDistance(){return this._nativePannerNode.refDistance}set refDistance(a){this._nativePannerNode.refDistance=a}get rolloffFactor(){return this._nativePannerNode.rolloffFactor}set rolloffFactor(a){this._nativePannerNode.rolloffFactor=a}},KS=(n,t,e,s,i,r,o,A,a,l)=>()=>{const c=new WeakMap;let u=null;const d=async(p,f)=>{let m=null,g=r(p);const w={channelCount:g.channelCount,channelCountMode:g.channelCountMode,channelInterpretation:g.channelInterpretation},B={...w,coneInnerAngle:g.coneInnerAngle,coneOuterAngle:g.coneOuterAngle,coneOuterGain:g.coneOuterGain,distanceModel:g.distanceModel,maxDistance:g.maxDistance,panningModel:g.panningModel,refDistance:g.refDistance,rolloffFactor:g.rolloffFactor},b=We(g,f);if("bufferSize"in g)m=s(f,{...w,gain:1});else if(!b){const _={...B,orientationX:g.orientationX.value,orientationY:g.orientationY.value,orientationZ:g.orientationZ.value,positionX:g.positionX.value,positionY:g.positionY.value,positionZ:g.positionZ.value};g=i(f,_)}if(c.set(f,m===null?g:m),m!==null){if(u===null){if(o===null)throw new Error("Missing the native OfflineAudioContext constructor.");const Q=new o(6,p.context.length,f.sampleRate),T=t(Q,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6});T.connect(Q.destination),u=(async()=>{const U=await Promise.all([p.orientationX,p.orientationY,p.orientationZ,p.positionX,p.positionY,p.positionZ].map(async(P,K)=>{const M=e(Q,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:K===0?1:0});return await A(Q,P,M.offset),M}));for(let P=0;P<6;P+=1)U[P].connect(T,0,P),U[P].start(0);return l(Q)})()}const _=await u,v=s(f,{...w,gain:1});await a(p,f,v);const C=[];for(let Q=0;Q<_.numberOfChannels;Q+=1)C.push(_.getChannelData(Q));let y=[C[0][0],C[1][0],C[2][0]],S=[C[3][0],C[4][0],C[5][0]],F=s(f,{...w,gain:1}),x=i(f,{...B,orientationX:y[0],orientationY:y[1],orientationZ:y[2],positionX:S[0],positionY:S[1],positionZ:S[2]});v.connect(F).connect(x.inputs[0]),x.connect(m);for(let Q=128;Q<_.length;Q+=128){const T=[C[0][Q],C[1][Q],C[2][Q]],U=[C[3][Q],C[4][Q],C[5][Q]];if(T.some((P,K)=>P!==y[K])||U.some((P,K)=>P!==S[K])){y=T,S=U;const P=Q/f.sampleRate;F.gain.setValueAtTime(0,P),F=s(f,{...w,gain:0}),x=i(f,{...B,orientationX:y[0],orientationY:y[1],orientationZ:y[2],positionX:S[0],positionY:S[1],positionZ:S[2]}),F.gain.setValueAtTime(1,P),v.connect(F).connect(x.inputs[0]),x.connect(m)}}return m}return b?(await n(f,p.orientationX,g.orientationX),await n(f,p.orientationY,g.orientationY),await n(f,p.orientationZ,g.orientationZ),await n(f,p.positionX,g.positionX),await n(f,p.positionY,g.positionY),await n(f,p.positionZ,g.positionZ)):(await A(f,p.orientationX,g.orientationX),await A(f,p.orientationY,g.orientationY),await A(f,p.orientationZ,g.orientationZ),await A(f,p.positionX,g.positionX),await A(f,p.positionY,g.positionY),await A(f,p.positionZ,g.positionZ)),ko(g)?await a(p,f,g.inputs[0]):await a(p,f,g),g};return{render(p,f){const m=c.get(f);return m!==void 0?Promise.resolve(m):d(p,f)}}},qS={disableNormalization:!1},zS=(n,t,e,s)=>class ww{constructor(r,o){const A=t(r),a=s({...qS,...o}),l=n(A,a);return e.add(l),l}static[Symbol.hasInstance](r){return r!==null&&typeof r=="object"&&Object.getPrototypeOf(r)===ww.prototype||e.has(r)}},XS=(n,t)=>(e,s,i)=>(n(s).replay(i),t(s,e,i)),$S=(n,t,e)=>async(s,i,r)=>{const o=n(s);await Promise.all(o.activeInputs.map((A,a)=>Array.from(A).map(async([l,c])=>{const d=await t(l).render(l,i),p=s.context.destination;!e(l)&&(s!==p||!e(s))&&d.connect(r,c,a)})).reduce((A,a)=>[...A,...a],[]))},YS=(n,t,e)=>async(s,i,r)=>{const o=t(s);await Promise.all(Array.from(o.activeInputs).map(async([A,a])=>{const c=await n(A).render(A,i);e(A)||c.connect(r,a)}))},jS=(n,t,e,s)=>i=>n(RA,()=>RA(i))?Promise.resolve(n(s,s)).then(r=>{if(!r){const o=e(i,512,0,1);i.oncomplete=()=>{o.onaudioprocess=null,o.disconnect()},o.onaudioprocess=()=>i.currentTime,o.connect(i.destination)}return i.startRendering()}):new Promise(r=>{const o=t(i,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});i.oncomplete=A=>{o.disconnect(),r(A.renderedBuffer)},o.connect(i.destination),i.startRendering()}),JS=n=>(t,e)=>{n.set(t,e)},ZS=n=>(t,e)=>n.set(t,e),tE=(n,t,e,s,i,r,o,A)=>(a,l)=>e(a).render(a,l).then(()=>Promise.all(Array.from(s(l)).map(c=>e(c).render(c,l)))).then(()=>i(l)).then(c=>(typeof c.copyFromChannel!="function"?(o(c),uf(c)):t(r,()=>r(c))||A(c),n.add(c),c)),eE={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",pan:0},nE=(n,t,e,s,i,r)=>class extends n{constructor(A,a){const l=i(A),c={...eE,...a},u=e(l,c),d=r(l),p=d?s():null;super(A,!1,u,p),this._pan=t(this,d,u.pan)}get pan(){return this._pan}},sE=(n,t,e,s,i)=>()=>{const r=new WeakMap,o=async(A,a)=>{let l=e(A);const c=We(l,a);if(!c){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,pan:l.pan.value};l=t(a,u)}return r.set(a,l),c?await n(a,A.pan,l.pan):await s(a,A.pan,l.pan),ko(l)?await i(A,a,l.inputs[0]):await i(A,a,l),l};return{render(A,a){const l=r.get(a);return l!==void 0?Promise.resolve(l):o(A,a)}}},iE=n=>()=>{if(n===null)return!1;try{new n({length:1,sampleRate:44100})}catch{return!1}return!0},rE=(n,t)=>async()=>{if(n===null)return!0;if(t===null)return!1;const e=new Blob(['class A extends AudioWorkletProcessor{process(i){this.port.postMessage(i,[i[0][0].buffer])}}registerProcessor("a",A)'],{type:"application/javascript; charset=utf-8"}),s=new t(1,128,44100),i=URL.createObjectURL(e);let r=!1,o=!1;try{await s.audioWorklet.addModule(i);const A=new n(s,"a",{numberOfOutputs:0}),a=s.createOscillator();A.port.onmessage=()=>r=!0,A.onprocessorerror=()=>o=!0,a.connect(A),a.start(0),await s.startRendering(),await new Promise(l=>setTimeout(l))}catch{}finally{URL.revokeObjectURL(i)}return r&&!o},oE=(n,t)=>()=>{if(t===null)return Promise.resolve(!1);const e=new t(1,1,44100),s=n(e,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return new Promise(i=>{e.oncomplete=()=>{s.disconnect(),i(e.currentTime!==0)},e.startRendering()})},AE=()=>new DOMException("","UnknownError"),aE={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",curve:null,oversample:"none"},lE=(n,t,e,s,i,r,o)=>class extends n{constructor(a,l){const c=i(a),u={...aE,...l},d=e(c,u),f=r(c)?s():null;super(a,!0,d,f),this._isCurveNullified=!1,this._nativeWaveShaperNode=d,o(this,1)}get curve(){return this._isCurveNullified?null:this._nativeWaveShaperNode.curve}set curve(a){if(a===null)this._isCurveNullified=!0,this._nativeWaveShaperNode.curve=new Float32Array([0,0]);else{if(a.length<2)throw t();this._isCurveNullified=!1,this._nativeWaveShaperNode.curve=a}}get oversample(){return this._nativeWaveShaperNode.oversample}set oversample(a){this._nativeWaveShaperNode.oversample=a}},cE=(n,t,e)=>()=>{const s=new WeakMap,i=async(r,o)=>{let A=t(r);if(!We(A,o)){const l={channelCount:A.channelCount,channelCountMode:A.channelCountMode,channelInterpretation:A.channelInterpretation,curve:A.curve,oversample:A.oversample};A=n(o,l)}return s.set(o,A),ko(A)?await e(r,o,A.inputs[0]):await e(r,o,A),A};return{render(r,o){const A=s.get(o);return A!==void 0?Promise.resolve(A):i(r,o)}}},uE=()=>typeof window>"u"?null:window,dE=(n,t)=>e=>{e.copyFromChannel=(s,i,r=0)=>{const o=n(r),A=n(i);if(A>=e.numberOfChannels)throw t();const a=e.length,l=e.getChannelData(A),c=s.length;for(let u=o<0?-o:0;u+o<a&&u<c;u+=1)s[u]=l[u+o]},e.copyToChannel=(s,i,r=0)=>{const o=n(r),A=n(i);if(A>=e.numberOfChannels)throw t();const a=e.length,l=e.getChannelData(A),c=s.length;for(let u=o<0?-o:0;u+o<a&&u<c;u+=1)l[u+o]=s[u]}},hE=n=>t=>{t.copyFromChannel=(e=>(s,i,r=0)=>{const o=n(r),A=n(i);if(o<t.length)return e.call(t,s,A,o)})(t.copyFromChannel),t.copyToChannel=(e=>(s,i,r=0)=>{const o=n(r),A=n(i);if(o<t.length)return e.call(t,s,A,o)})(t.copyToChannel)},fE=n=>(t,e)=>{const s=e.createBuffer(1,1,44100);t.buffer===null&&(t.buffer=s),n(t,"buffer",i=>()=>{const r=i.call(t);return r===s?null:r},i=>r=>i.call(t,r===null?s:r))},pE=(n,t)=>(e,s)=>{s.channelCount=1,s.channelCountMode="explicit",Object.defineProperty(s,"channelCount",{get:()=>1,set:()=>{throw n()}}),Object.defineProperty(s,"channelCountMode",{get:()=>"explicit",set:()=>{throw n()}});const i=e.createBufferSource();t(s,()=>{const A=s.numberOfInputs;for(let a=0;a<A;a+=1)i.connect(s,0,a)},()=>i.disconnect(s))},vw=(n,t,e)=>n.copyFromChannel===void 0?n.getChannelData(e)[0]:(n.copyFromChannel(t,e),t[0]),Bw=n=>{if(n===null)return!1;const t=n.length;return t%2!==0?n[Math.floor(t/2)]!==0:n[t/2-1]+n[t/2]!==0},Ca=(n,t,e,s)=>{let i=n;for(;!i.hasOwnProperty(t);)i=Object.getPrototypeOf(i);const{get:r,set:o}=Object.getOwnPropertyDescriptor(i,t);Object.defineProperty(n,t,{get:e(r),set:s(o)})},mE=n=>({...n,outputChannelCount:n.outputChannelCount!==void 0?n.outputChannelCount:n.numberOfInputs===1&&n.numberOfOutputs===1?[n.channelCount]:Array.from({length:n.numberOfOutputs},()=>1)}),gE=n=>({...n,channelCount:n.numberOfOutputs}),wE=n=>{const{imag:t,real:e}=n;return t===void 0?e===void 0?{...n,imag:[0,0],real:[0,0]}:{...n,imag:Array.from(e,()=>0),real:e}:e===void 0?{...n,imag:t,real:Array.from(t,()=>0)}:{...n,imag:t,real:e}},Cw=(n,t,e)=>{try{n.setValueAtTime(t,e)}catch(s){if(s.code!==9)throw s;Cw(n,t,e+1e-7)}},vE=n=>{const t=n.createBufferSource();t.start();try{t.start()}catch{return!0}return!1},BE=n=>{const t=n.createBufferSource(),e=n.createBuffer(1,1,44100);t.buffer=e;try{t.start(0,1)}catch{return!1}return!0},CE=n=>{const t=n.createBufferSource();t.start();try{t.stop()}catch{return!1}return!0},mf=n=>{const t=n.createOscillator();try{t.start(-1)}catch(e){return e instanceof RangeError}return!1},bw=n=>{const t=n.createBuffer(1,1,44100),e=n.createBufferSource();e.buffer=t,e.start(),e.stop();try{return e.stop(),!0}catch{return!1}},gf=n=>{const t=n.createOscillator();try{t.stop(-1)}catch(e){return e instanceof RangeError}return!1},bE=n=>{const{port1:t,port2:e}=new MessageChannel;try{t.postMessage(n)}finally{t.close(),e.close()}},yE=n=>{n.start=(t=>(e=0,s=0,i)=>{const r=n.buffer,o=r===null?s:Math.min(r.duration,s);r!==null&&o>r.duration-.5/n.context.sampleRate?t.call(n,e,0,0):t.call(n,e,o,i)})(n.start)},yw=(n,t)=>{const e=t.createGain();n.connect(e);const s=(i=>()=>{i.call(n,e),n.removeEventListener("ended",s)})(n.disconnect);n.addEventListener("ended",s),Ro(n,e),n.stop=(i=>{let r=!1;return(o=0)=>{if(r)try{i.call(n,o)}catch{e.gain.setValueAtTime(0,o)}else i.call(n,o),r=!0}})(n.stop)},Ho=(n,t)=>e=>{const s={value:n};return Object.defineProperties(e,{currentTarget:s,target:s}),typeof t=="function"?t.call(n,e):t.handleEvent.call(n,e)},SE=G2(Ir),EE=Y2(Ir),xE=a1(Rc),Sw=new WeakMap,_E=x1(Sw),is=ky(new Map,new WeakMap),xs=uE(),Ew=nS(is,Ms),wf=E1(Ye),Ue=$S(Ye,wf,Br),IE=ey(Ew,jt,Ue),Xt=F1(kc),ai=FS(xs),Gt=q1(ai),xw=new WeakMap,_w=w1(Ho),ba=oS(xs),vf=V1(ba),Bf=W1(xs),Iw=G1(xs),HA=aS(xs),he=xy(K2(ew),$2(SE,EE,$l,xE,Yl,Ye,_E,pa,jt,Ir,Zs,Br,Sl),is,L1(Dd,Yl,Ye,jt,kA,Zs),Ms,Hc,tn,i1($l,Dd,Ye,jt,kA,Xt,Zs,Gt),u1(xw,Ye,ns),_w,Xt,vf,Bf,Iw,Gt,HA),FE=ty(he,IE,Ms,Ew,Xt,Gt),Cf=new WeakSet,am=sS(xs),Fw=jy(new Uint32Array(1)),bf=dE(Fw,Ms),yf=hE(Fw),Tw=sy(Cf,is,tn,am,ai,iE(am),bf,yf),Oc=j2(hn),Qw=YS(wf,ga,Br),Us=Ky(Qw),Oo=rS(Oc,is,vE,BE,CE,mf,bw,gf,yE,fE(Ca),yw),Ps=XS(_1(ga),Qw),TE=oy(Us,Oo,jt,Ps,Ue),rs=_y(q2(nw),xw,cf,Iy,k2,R2,H2,O2,V2,Ud,Z0,ba,Cw),QE=ry(he,TE,rs,xe,Oo,Xt,Gt,Ho),ME=py(he,my,Ms,xe,AS(hn,Ca),Xt,Gt,Ue),UE=Ly(Us,mw,jt,Ps,Ue),Fr=ZS(Sw),PE=Dy(he,rs,UE,Hc,mw,Xt,Gt,Fr),Gi=tS(Ir,Bf),NE=pE(xe,Gi),Ki=pS(ba,NE),DE=Oy(Ki,jt,Ue),LE=Hy(he,DE,Ki,Xt,Gt),kE=Gy(va,jt,Ue),RE=Wy(he,kE,va,Xt,Gt,gE),HE=wS(Oc,Oo,hn,Gi),Vo=gS(Oc,is,HE,mf,gf),OE=Yy(Us,Vo,jt,Ps,Ue),VE=$y(he,rs,OE,Vo,Xt,Gt,Ho),Mw=vS(tn,Ca),WE=t1(Mw,jt,Ue),GE=Zy(he,WE,Mw,Xt,Gt,Fr),KE=A1(Us,gw,jt,Ps,Ue),qE=o1(he,rs,KE,gw,Xt,Gt,Fr),Uw=BS(tn),zE=p1(Us,Uw,jt,Ps,Ue),XE=f1(he,rs,zE,Uw,tn,Xt,Gt,Fr),$E=y1(Us,hn,jt,Ps,Ue),YE=b1(he,rs,$E,hn,Xt,Gt),jE=SS(Hc,xe,Ba,tn),Vc=jS(is,hn,Ba,oE(hn,ai)),JE=D1(Oo,jt,ai,Ue,Vc),ZE=CS(jE),tx=P1(he,ZE,JE,Xt,Gt,Fr),ex=gy(rs,Ki,Vo,Ba,tn,vw,Gt,Ca),Pw=new WeakMap,nx=Z1(ME,ex,_w,Gt,Pw,Ho),Nw=TS(Oc,is,mf,bw,gf,yw),sx=VS(Us,Nw,jt,Ps,Ue),ix=OS(he,rs,Nw,sx,Xt,Gt,Ho),Dw=zy(Oo),rx=LS(Dw,xe,hn,Bw,Gi),Wc=DS(Dw,xe,rx,Bw,Gi,ba,Ca),ox=MS($l,xe,Ki,hn,Ba,Wc,tn,Yl,vw,Gi),Lw=QS(ox),Ax=KS(Us,Ki,Vo,hn,Lw,jt,ai,Ps,Ue,Vc),ax=GS(he,rs,Lw,Ax,Xt,Gt,Fr),lx=US(Ms),cx=zS(lx,Xt,new WeakSet,wE),ux=NS(Ki,va,hn,Wc,tn,Gi),kw=PS(ux,tn),dx=sE(Us,kw,jt,Ps,Ue),hx=nE(he,rs,kw,dx,Xt,Gt),fx=cE(Wc,jt,Ue),px=lE(he,xe,Wc,fx,Xt,Gt,Fr),Rw=z1(xs),Sf=v1(xs),Hw=new WeakMap,mx=T1(Hw,ai),gx=Rw?X2(is,tn,g1(xs),Sf,B1(W2),Xt,mx,Gt,HA,new WeakMap,new WeakMap,rE(HA,ai),xs):void 0,wx=K1(vf,Gt),vx=s1(Cf,is,n1,m1,new WeakSet,Xt,wx,zl,RA,bf,yf),Ow=Py(gx,FE,Tw,QE,PE,LE,RE,VE,GE,vx,qE,XE,YE,tx,nx,ix,ax,cx,hx,px),Bx=X1(he,ES,Xt,Gt),Cx=Y1(he,xS,Xt,Gt),bx=j1(he,_S,Xt,Gt),yx=IS(xe,Gt),Sx=J1(he,yx,Xt),Ex=fy(Ow,xe,tn,AE,Bx,Cx,bx,Sx,ba),Ef=Q1(Pw),xx=J2(Ef),Vw=qy(Ms),_x=l1(Ef),Ww=d1(Ms),Gw=new WeakMap,Ix=S1(Gw,ns),Fx=fS(Vw,Ms,xe,Ki,va,Vo,hn,Ba,tn,Ww,Sf,Ix,Gi),Tx=cS(xe,Fx,hn,tn,Gi),Qx=Uy(Us,Vw,Oo,Ki,va,Vo,hn,_x,Ww,Sf,jt,HA,ai,Ps,Ue,Vc),Mx=I1(Hw),Ux=JS(Gw),lm=Rw?Ty(xx,he,rs,Qx,Tx,Ye,Mx,Xt,Gt,HA,mE,Ux,bE,Ho):void 0,Px=e1(tn,ai),Nx=tE(Cf,is,wf,Ef,Vc,zl,bf,yf),Dx=RS(Ow,is,xe,Px,Nx),Lx=k1(kc,vf),kx=R1(lf,Bf),Rx=H1(cf,Iw),Hx=O1(kc,Gt);function Hn(n){return n===void 0}function Ft(n){return n!==void 0}function Ox(n){return typeof n=="function"}function ni(n){return typeof n=="number"}function fr(n){return Object.prototype.toString.call(n)==="[object Object]"&&n.constructor===Object}function Vx(n){return typeof n=="boolean"}function En(n){return Array.isArray(n)}function si(n){return typeof n=="string"}function Na(n){return si(n)&&/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i.test(n)}function mt(n,t){if(!n)throw new Error(t)}function ii(n,t,e=1/0){if(!(t<=n&&n<=e))throw new RangeError(`Value must be within [${t}, ${e}], got: ${n}`)}function Kw(n){!n.isOffline&&n.state!=="running"&&ya('The AudioContext is "suspended". Invoke Tone.start() from a user action to start the audio.')}let qw=!1,cm=!1;function um(n){qw=n}function Wx(n){Hn(n)&&qw&&!cm&&(cm=!0,ya("Events scheduled inside of scheduled callbacks should use the passed in scheduling time. See https://github.com/Tonejs/Tone.js/wiki/Accurate-Timing"))}let zw=console;function Gx(...n){zw.log(...n)}function ya(...n){zw.warn(...n)}function Kx(n){return new Ex(n)}function qx(n,t,e){return new Dx(n,t,e)}const bn=typeof self=="object"?self:null,zx=bn&&(bn.hasOwnProperty("AudioContext")||bn.hasOwnProperty("webkitAudioContext"));function Xx(n,t,e){return mt(Ft(lm),"AudioWorkletNode only works in a secure context (https or localhost)"),new(n instanceof(bn==null?void 0:bn.BaseAudioContext)?bn==null?void 0:bn.AudioWorkletNode:lm)(n,t,e)}function os(n,t,e,s){var i=arguments.length,r=i<3?t:s===null?s=Object.getOwnPropertyDescriptor(t,e):s,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(n,t,e,s);else for(var A=n.length-1;A>=0;A--)(o=n[A])&&(r=(i<3?o(r):i>3?o(t,e,r):o(t,e))||r);return i>3&&r&&Object.defineProperty(t,e,r),r}function we(n,t,e,s){function i(r){return r instanceof e?r:new e(function(o){o(r)})}return new(e||(e=Promise))(function(r,o){function A(c){try{l(s.next(c))}catch(u){o(u)}}function a(c){try{l(s.throw(c))}catch(u){o(u)}}function l(c){c.done?r(c.value):i(c.value).then(A,a)}l((s=s.apply(n,t||[])).next())})}class $x{constructor(t,e,s,i){this._callback=t,this._type=e,this._minimumUpdateInterval=Math.max(128/(i||44100),.001),this.updateInterval=s,this._createClock()}_createWorker(){const t=new Blob([`
			// the initial timeout time
			let timeoutTime =  ${(this._updateInterval*1e3).toFixed(1)};
			// onmessage callback
			self.onmessage = function(msg){
				timeoutTime = parseInt(msg.data);
			};
			// the tick function which posts a message
			// and schedules a new tick
			function tick(){
				setTimeout(tick, timeoutTime);
				self.postMessage('tick');
			}
			// call tick initially
			tick();
			`],{type:"text/javascript"}),e=URL.createObjectURL(t),s=new Worker(e);s.onmessage=this._callback.bind(this),this._worker=s}_createTimeout(){this._timeout=setTimeout(()=>{this._createTimeout(),this._callback()},this._updateInterval*1e3)}_createClock(){if(this._type==="worker")try{this._createWorker()}catch{this._type="timeout",this._createClock()}else this._type==="timeout"&&this._createTimeout()}_disposeClock(){this._timeout&&clearTimeout(this._timeout),this._worker&&(this._worker.terminate(),this._worker.onmessage=null)}get updateInterval(){return this._updateInterval}set updateInterval(t){var e;this._updateInterval=Math.max(t,this._minimumUpdateInterval),this._type==="worker"&&((e=this._worker)===null||e===void 0||e.postMessage(this._updateInterval*1e3))}get type(){return this._type}set type(t){this._disposeClock(),this._type=t,this._createClock()}dispose(){this._disposeClock()}}function Cr(n){return Rx(n)}function Ui(n){return kx(n)}function El(n){return Hx(n)}function zr(n){return Lx(n)}function Yx(n){return n instanceof Tw}function jx(n,t){return n==="value"||Cr(t)||Ui(t)||Yx(t)}function pr(n,...t){if(!t.length)return n;const e=t.shift();if(fr(n)&&fr(e))for(const s in e)jx(s,e[s])?n[s]=e[s]:fr(e[s])?(n[s]||Object.assign(n,{[s]:{}}),pr(n[s],e[s])):Object.assign(n,{[s]:e[s]});return pr(n,...t)}function Jx(n,t){return n.length===t.length&&n.every((e,s)=>t[s]===e)}function ft(n,t,e=[],s){const i={},r=Array.from(t);if(fr(r[0])&&s&&!Reflect.has(r[0],s)&&(Object.keys(r[0]).some(A=>Reflect.has(n,A))||(pr(i,{[s]:r[0]}),e.splice(e.indexOf(s),1),r.shift())),r.length===1&&fr(r[0]))pr(i,r[0]);else for(let o=0;o<e.length;o++)Ft(r[o])&&(i[e[o]]=r[o]);return pr(n,i)}function Zx(n){return n.constructor.getDefaults()}function co(n,t){return Hn(n)?t:n}function Od(n,t){return t.forEach(e=>{Reflect.has(n,e)&&delete n[e]}),n}/**
 * Tone.js
 * @author Yotam Mann
 * @license http://opensource.org/licenses/MIT MIT License
 * @copyright 2014-2024 Yotam Mann
 */class li{constructor(){this.debug=!1,this._wasDisposed=!1}static getDefaults(){return{}}log(...t){(this.debug||bn&&this.toString()===bn.TONE_DEBUG_CLASS)&&Gx(this,...t)}dispose(){return this._wasDisposed=!0,this}get disposed(){return this._wasDisposed}toString(){return this.name}}li.version=J0;const xf=1e-6;function _o(n,t){return n>t+xf}function Vd(n,t){return _o(n,t)||Yn(n,t)}function tc(n,t){return n+xf<t}function Yn(n,t){return Math.abs(n-t)<xf}function t_(n,t,e){return Math.max(Math.min(n,e),t)}class On extends li{constructor(){super(),this.name="Timeline",this._timeline=[];const t=ft(On.getDefaults(),arguments,["memory"]);this.memory=t.memory,this.increasing=t.increasing}static getDefaults(){return{memory:1/0,increasing:!1}}get length(){return this._timeline.length}add(t){if(mt(Reflect.has(t,"time"),"Timeline: events must have a time attribute"),t.time=t.time.valueOf(),this.increasing&&this.length){const e=this._timeline[this.length-1];mt(Vd(t.time,e.time),"The time must be greater than or equal to the last scheduled time"),this._timeline.push(t)}else{const e=this._search(t.time);this._timeline.splice(e+1,0,t)}if(this.length>this.memory){const e=this.length-this.memory;this._timeline.splice(0,e)}return this}remove(t){const e=this._timeline.indexOf(t);return e!==-1&&this._timeline.splice(e,1),this}get(t,e="time"){const s=this._search(t,e);return s!==-1?this._timeline[s]:null}peek(){return this._timeline[0]}shift(){return this._timeline.shift()}getAfter(t,e="time"){const s=this._search(t,e);return s+1<this._timeline.length?this._timeline[s+1]:null}getBefore(t){const e=this._timeline.length;if(e>0&&this._timeline[e-1].time<t)return this._timeline[e-1];const s=this._search(t);return s-1>=0?this._timeline[s-1]:null}cancel(t){if(this._timeline.length>1){let e=this._search(t);if(e>=0)if(Yn(this._timeline[e].time,t)){for(let s=e;s>=0&&Yn(this._timeline[s].time,t);s--)e=s;this._timeline=this._timeline.slice(0,e)}else this._timeline=this._timeline.slice(0,e+1);else this._timeline=[]}else this._timeline.length===1&&Vd(this._timeline[0].time,t)&&(this._timeline=[]);return this}cancelBefore(t){const e=this._search(t);return e>=0&&(this._timeline=this._timeline.slice(e+1)),this}previousEvent(t){const e=this._timeline.indexOf(t);return e>0?this._timeline[e-1]:null}_search(t,e="time"){if(this._timeline.length===0)return-1;let s=0;const i=this._timeline.length;let r=i;if(i>0&&this._timeline[i-1][e]<=t)return i-1;for(;s<r;){let o=Math.floor(s+(r-s)/2);const A=this._timeline[o],a=this._timeline[o+1];if(Yn(A[e],t)){for(let l=o;l<this._timeline.length;l++){const c=this._timeline[l];if(Yn(c[e],t))o=l;else break}return o}else{if(tc(A[e],t)&&_o(a[e],t))return o;_o(A[e],t)?r=o:s=o+1}}return-1}_iterate(t,e=0,s=this._timeline.length-1){this._timeline.slice(e,s+1).forEach(t)}forEach(t){return this._iterate(t),this}forEachBefore(t,e){const s=this._search(t);return s!==-1&&this._iterate(e,0,s),this}forEachAfter(t,e){const s=this._search(t);return this._iterate(e,s+1),this}forEachBetween(t,e,s){let i=this._search(t),r=this._search(e);return i!==-1&&r!==-1?(this._timeline[i].time!==t&&(i+=1),this._timeline[r].time===e&&(r-=1),this._iterate(s,i,r)):i===-1&&this._iterate(s,0,r),this}forEachFrom(t,e){let s=this._search(t);for(;s>=0&&this._timeline[s].time>=t;)s--;return this._iterate(e,s+1),this}forEachAtTime(t,e){const s=this._search(t);if(s!==-1&&Yn(this._timeline[s].time,t)){let i=s;for(let r=s;r>=0&&Yn(this._timeline[r].time,t);r--)i=r;this._iterate(r=>{e(r)},i,s)}return this}dispose(){return super.dispose(),this._timeline=[],this}}const Xw=[];function Gc(n){Xw.push(n)}function e_(n){Xw.forEach(t=>t(n))}const $w=[];function Kc(n){$w.push(n)}function n_(n){$w.forEach(t=>t(n))}let _f=class Yw extends li{constructor(){super(...arguments),this.name="Emitter"}on(t,e){return t.split(/\W+/).forEach(i=>{Hn(this._events)&&(this._events={}),this._events.hasOwnProperty(i)||(this._events[i]=[]),this._events[i].push(e)}),this}once(t,e){const s=(...i)=>{e(...i),this.off(t,s)};return this.on(t,s),this}off(t,e){return t.split(/\W+/).forEach(i=>{if(Hn(this._events)&&(this._events={}),this._events.hasOwnProperty(i))if(Hn(e))this._events[i]=[];else{const r=this._events[i];for(let o=r.length-1;o>=0;o--)r[o]===e&&r.splice(o,1)}}),this}emit(t,...e){if(this._events&&this._events.hasOwnProperty(t)){const s=this._events[t].slice(0);for(let i=0,r=s.length;i<r;i++)s[i].apply(this,e)}return this}static mixin(t){["on","once","off","emit"].forEach(e=>{const s=Object.getOwnPropertyDescriptor(Yw.prototype,e);Object.defineProperty(t.prototype,e,s)})}dispose(){return super.dispose(),this._events=void 0,this}};class jw extends _f{constructor(){super(...arguments),this.isOffline=!1}toJSON(){return{}}}let qc=class Jw extends jw{constructor(){var t,e;super(),this.name="Context",this._constants=new Map,this._timeouts=new On,this._timeoutIds=0,this._initialized=!1,this._closeStarted=!1,this.isOffline=!1,this._workletPromise=null;const s=ft(Jw.getDefaults(),arguments,["context"]);s.context?(this._context=s.context,this._latencyHint=((t=arguments[0])===null||t===void 0?void 0:t.latencyHint)||""):(this._context=Kx({latencyHint:s.latencyHint}),this._latencyHint=s.latencyHint),this._ticker=new $x(this.emit.bind(this,"tick"),s.clockSource,s.updateInterval,this._context.sampleRate),this.on("tick",this._timeoutLoop.bind(this)),this._context.onstatechange=()=>{this.emit("statechange",this.state)},this[!((e=arguments[0])===null||e===void 0)&&e.hasOwnProperty("updateInterval")?"_lookAhead":"lookAhead"]=s.lookAhead}static getDefaults(){return{clockSource:"worker",latencyHint:"interactive",lookAhead:.1,updateInterval:.05}}initialize(){return this._initialized||(e_(this),this._initialized=!0),this}createAnalyser(){return this._context.createAnalyser()}createOscillator(){return this._context.createOscillator()}createBufferSource(){return this._context.createBufferSource()}createBiquadFilter(){return this._context.createBiquadFilter()}createBuffer(t,e,s){return this._context.createBuffer(t,e,s)}createChannelMerger(t){return this._context.createChannelMerger(t)}createChannelSplitter(t){return this._context.createChannelSplitter(t)}createConstantSource(){return this._context.createConstantSource()}createConvolver(){return this._context.createConvolver()}createDelay(t){return this._context.createDelay(t)}createDynamicsCompressor(){return this._context.createDynamicsCompressor()}createGain(){return this._context.createGain()}createIIRFilter(t,e){return this._context.createIIRFilter(t,e)}createPanner(){return this._context.createPanner()}createPeriodicWave(t,e,s){return this._context.createPeriodicWave(t,e,s)}createStereoPanner(){return this._context.createStereoPanner()}createWaveShaper(){return this._context.createWaveShaper()}createMediaStreamSource(t){return mt(zr(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamSource(t)}createMediaElementSource(t){return mt(zr(this._context),"Not available if OfflineAudioContext"),this._context.createMediaElementSource(t)}createMediaStreamDestination(){return mt(zr(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamDestination()}decodeAudioData(t){return this._context.decodeAudioData(t)}get currentTime(){return this._context.currentTime}get state(){return this._context.state}get sampleRate(){return this._context.sampleRate}get listener(){return this.initialize(),this._listener}set listener(t){mt(!this._initialized,"The listener cannot be set after initialization."),this._listener=t}get transport(){return this.initialize(),this._transport}set transport(t){mt(!this._initialized,"The transport cannot be set after initialization."),this._transport=t}get draw(){return this.initialize(),this._draw}set draw(t){mt(!this._initialized,"Draw cannot be set after initialization."),this._draw=t}get destination(){return this.initialize(),this._destination}set destination(t){mt(!this._initialized,"The destination cannot be set after initialization."),this._destination=t}createAudioWorkletNode(t,e){return Xx(this.rawContext,t,e)}addAudioWorkletModule(t){return we(this,void 0,void 0,function*(){mt(Ft(this.rawContext.audioWorklet),"AudioWorkletNode is only available in a secure context (https or localhost)"),this._workletPromise||(this._workletPromise=this.rawContext.audioWorklet.addModule(t)),yield this._workletPromise})}workletsAreReady(){return we(this,void 0,void 0,function*(){(yield this._workletPromise)?this._workletPromise:Promise.resolve()})}get updateInterval(){return this._ticker.updateInterval}set updateInterval(t){this._ticker.updateInterval=t}get clockSource(){return this._ticker.type}set clockSource(t){this._ticker.type=t}get lookAhead(){return this._lookAhead}set lookAhead(t){this._lookAhead=t,this.updateInterval=t?t/2:.01}get latencyHint(){return this._latencyHint}get rawContext(){return this._context}now(){return this._context.currentTime+this._lookAhead}immediate(){return this._context.currentTime}resume(){return zr(this._context)?this._context.resume():Promise.resolve()}close(){return we(this,void 0,void 0,function*(){zr(this._context)&&this.state!=="closed"&&!this._closeStarted&&(this._closeStarted=!0,yield this._context.close()),this._initialized&&n_(this)})}getConstant(t){if(this._constants.has(t))return this._constants.get(t);{const e=this._context.createBuffer(1,128,this._context.sampleRate),s=e.getChannelData(0);for(let r=0;r<s.length;r++)s[r]=t;const i=this._context.createBufferSource();return i.channelCount=1,i.channelCountMode="explicit",i.buffer=e,i.loop=!0,i.start(0),this._constants.set(t,i),i}}dispose(){return super.dispose(),this._ticker.dispose(),this._timeouts.dispose(),Object.keys(this._constants).map(t=>this._constants[t].disconnect()),this.close(),this}_timeoutLoop(){const t=this.now();this._timeouts.forEachBefore(t,e=>{e.callback(),this._timeouts.remove(e)})}setTimeout(t,e){this._timeoutIds++;const s=this.now();return this._timeouts.add({callback:t,id:this._timeoutIds,time:s+e}),this._timeoutIds}clearTimeout(t){return this._timeouts.forEach(e=>{e.id===t&&this._timeouts.remove(e)}),this}clearInterval(t){return this.clearTimeout(t)}setInterval(t,e){const s=++this._timeoutIds,i=()=>{const r=this.now();this._timeouts.add({callback:()=>{t(),i()},id:s,time:r+e})};return i(),s}};class s_ extends jw{constructor(){super(...arguments),this.lookAhead=0,this.latencyHint=0,this.isOffline=!1}createAnalyser(){return{}}createOscillator(){return{}}createBufferSource(){return{}}createBiquadFilter(){return{}}createBuffer(t,e,s){return{}}createChannelMerger(t){return{}}createChannelSplitter(t){return{}}createConstantSource(){return{}}createConvolver(){return{}}createDelay(t){return{}}createDynamicsCompressor(){return{}}createGain(){return{}}createIIRFilter(t,e){return{}}createPanner(){return{}}createPeriodicWave(t,e,s){return{}}createStereoPanner(){return{}}createWaveShaper(){return{}}createMediaStreamSource(t){return{}}createMediaElementSource(t){return{}}createMediaStreamDestination(){return{}}decodeAudioData(t){return Promise.resolve({})}createAudioWorkletNode(t,e){return{}}get rawContext(){return{}}addAudioWorkletModule(t){return we(this,void 0,void 0,function*(){return Promise.resolve()})}resume(){return Promise.resolve()}setTimeout(t,e){return 0}clearTimeout(t){return this}setInterval(t,e){return 0}clearInterval(t){return this}getConstant(t){return{}}get currentTime(){return 0}get state(){return{}}get sampleRate(){return 0}get listener(){return{}}get transport(){return{}}get draw(){return{}}set draw(t){}get destination(){return{}}set destination(t){}now(){return 0}immediate(){return 0}}function Pt(n,t){En(t)?t.forEach(e=>Pt(n,e)):Object.defineProperty(n,t,{enumerable:!0,writable:!1})}function If(n,t){En(t)?t.forEach(e=>If(n,e)):Object.defineProperty(n,t,{writable:!0})}const Lt=()=>{};class ee extends li{constructor(){super(),this.name="ToneAudioBuffer",this.onload=Lt;const t=ft(ee.getDefaults(),arguments,["url","onload","onerror"]);this.reverse=t.reverse,this.onload=t.onload,si(t.url)?this.load(t.url).catch(t.onerror):t.url&&this.set(t.url)}static getDefaults(){return{onerror:Lt,onload:Lt,reverse:!1}}get sampleRate(){return this._buffer?this._buffer.sampleRate:ke().sampleRate}set(t){return t instanceof ee?t.loaded?this._buffer=t.get():t.onload=()=>{this.set(t),this.onload(this)}:this._buffer=t,this._reversed&&this._reverse(),this}get(){return this._buffer}load(t){return we(this,void 0,void 0,function*(){const e=ee.load(t).then(s=>{this.set(s),this.onload(this)});ee.downloads.push(e);try{yield e}finally{const s=ee.downloads.indexOf(e);ee.downloads.splice(s,1)}return this})}dispose(){return super.dispose(),this._buffer=void 0,this}fromArray(t){const e=En(t)&&t[0].length>0,s=e?t.length:1,i=e?t[0].length:t.length,r=ke(),o=r.createBuffer(s,i,r.sampleRate),A=!e&&s===1?[t]:t;for(let a=0;a<s;a++)o.copyToChannel(A[a],a);return this._buffer=o,this}toMono(t){if(ni(t))this.fromArray(this.toArray(t));else{let e=new Float32Array(this.length);const s=this.numberOfChannels;for(let i=0;i<s;i++){const r=this.toArray(i);for(let o=0;o<r.length;o++)e[o]+=r[o]}e=e.map(i=>i/s),this.fromArray(e)}return this}toArray(t){if(ni(t))return this.getChannelData(t);if(this.numberOfChannels===1)return this.toArray(0);{const e=[];for(let s=0;s<this.numberOfChannels;s++)e[s]=this.getChannelData(s);return e}}getChannelData(t){return this._buffer?this._buffer.getChannelData(t):new Float32Array(0)}slice(t,e=this.duration){mt(this.loaded,"Buffer is not loaded");const s=Math.floor(t*this.sampleRate),i=Math.floor(e*this.sampleRate);mt(s<i,"The start time must be less than the end time");const r=i-s,o=ke().createBuffer(this.numberOfChannels,r,this.sampleRate);for(let A=0;A<this.numberOfChannels;A++)o.copyToChannel(this.getChannelData(A).subarray(s,i),A);return new ee(o)}_reverse(){if(this.loaded)for(let t=0;t<this.numberOfChannels;t++)this.getChannelData(t).reverse();return this}get loaded(){return this.length>0}get duration(){return this._buffer?this._buffer.duration:0}get length(){return this._buffer?this._buffer.length:0}get numberOfChannels(){return this._buffer?this._buffer.numberOfChannels:0}get reverse(){return this._reversed}set reverse(t){this._reversed!==t&&(this._reversed=t,this._reverse())}static fromArray(t){return new ee().fromArray(t)}static fromUrl(t){return we(this,void 0,void 0,function*(){return yield new ee().load(t)})}static load(t){return we(this,void 0,void 0,function*(){const e=ee.baseUrl===""||ee.baseUrl.endsWith("/")?ee.baseUrl:ee.baseUrl+"/",s=yield fetch(e+t);if(!s.ok)throw new Error(`could not load url: ${t}`);const i=yield s.arrayBuffer();return yield ke().decodeAudioData(i)})}static supportsType(t){const e=t.split("."),s=e[e.length-1];return document.createElement("audio").canPlayType("audio/"+s)!==""}static loaded(){return we(this,void 0,void 0,function*(){for(yield Promise.resolve();ee.downloads.length;)yield ee.downloads[0]})}}ee.baseUrl="";ee.downloads=[];class Ff extends qc{constructor(){super({clockSource:"offline",context:El(arguments[0])?arguments[0]:qx(arguments[0],arguments[1]*arguments[2],arguments[2]),lookAhead:0,updateInterval:El(arguments[0])?128/arguments[0].sampleRate:128/arguments[2]}),this.name="OfflineContext",this._currentTime=0,this.isOffline=!0,this._duration=El(arguments[0])?arguments[0].length/arguments[0].sampleRate:arguments[1]}now(){return this._currentTime}get currentTime(){return this._currentTime}_renderClock(t){return we(this,void 0,void 0,function*(){let e=0;for(;this._duration-this._currentTime>=0;){this.emit("tick"),this._currentTime+=128/this.sampleRate,e++;const s=Math.floor(this.sampleRate/128);t&&e%s===0&&(yield new Promise(i=>setTimeout(i,1)))}})}render(){return we(this,arguments,void 0,function*(t=!0){yield this.workletsAreReady(),yield this._renderClock(t);const e=yield this._context.startRendering();return new ee(e)})}close(){return Promise.resolve()}}const Zw=new s_;let nr=Zw;function ke(){return nr===Zw&&zx&&tv(new qc),nr}function tv(n,t=!1){t&&nr.dispose(),zr(n)?nr=new qc(n):El(n)?nr=new Ff(n):nr=n}function ec(){return nr.resume()}if(bn&&!bn.TONE_SILENCE_LOGGING){const t=` * Tone.js v${J0} * `;console.log(`%c${t}`,"background: #000; color: #fff")}function i_(n){return Math.pow(10,n/20)}function ev(n){return 20*(Math.log(n)/Math.LN10)}function nv(n){return Math.pow(2,n/12)}let zc=440;function r_(){return zc}function o_(n){zc=n}function sr(n){return Math.round(sv(n))}function sv(n){return 69+12*Math.log2(n/zc)}function iv(n){return zc*Math.pow(2,(n-69)/12)}class Tf extends li{constructor(t,e,s){super(),this.defaultUnits="s",this._val=e,this._units=s,this.context=t,this._expressions=this._getExpressions()}_getExpressions(){return{hz:{method:t=>this._frequencyToUnits(parseFloat(t)),regexp:/^(\d+(?:\.\d+)?)hz$/i},i:{method:t=>this._ticksToUnits(parseInt(t,10)),regexp:/^(\d+)i$/i},m:{method:t=>this._beatsToUnits(parseInt(t,10)*this._getTimeSignature()),regexp:/^(\d+)m$/i},n:{method:(t,e)=>{const s=parseInt(t,10),i=e==="."?1.5:1;return s===1?this._beatsToUnits(this._getTimeSignature())*i:this._beatsToUnits(4/s)*i},regexp:/^(\d+)n(\.?)$/i},number:{method:t=>this._expressions[this.defaultUnits].method.call(this,t),regexp:/^(\d+(?:\.\d+)?)$/},s:{method:t=>this._secondsToUnits(parseFloat(t)),regexp:/^(\d+(?:\.\d+)?)s$/},samples:{method:t=>parseInt(t,10)/this.context.sampleRate,regexp:/^(\d+)samples$/},t:{method:t=>{const e=parseInt(t,10);return this._beatsToUnits(8/(Math.floor(e)*3))},regexp:/^(\d+)t$/i},tr:{method:(t,e,s)=>{let i=0;return t&&t!=="0"&&(i+=this._beatsToUnits(this._getTimeSignature()*parseFloat(t))),e&&e!=="0"&&(i+=this._beatsToUnits(parseFloat(e))),s&&s!=="0"&&(i+=this._beatsToUnits(parseFloat(s)/4)),i},regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?$/}}}valueOf(){if(this._val instanceof Tf&&this.fromType(this._val),Hn(this._val))return this._noArg();if(si(this._val)&&Hn(this._units)){for(const t in this._expressions)if(this._expressions[t].regexp.test(this._val.trim())){this._units=t;break}}else if(fr(this._val)){let t=0;for(const e in this._val)if(Ft(this._val[e])){const s=this._val[e],i=new this.constructor(this.context,e).valueOf()*s;t+=i}return t}if(Ft(this._units)){const t=this._expressions[this._units],e=this._val.toString().trim().match(t.regexp);return e?t.method.apply(this,e.slice(1)):t.method.call(this,this._val)}else return si(this._val)?parseFloat(this._val):this._val}_frequencyToUnits(t){return 1/t}_beatsToUnits(t){return 60/this._getBpm()*t}_secondsToUnits(t){return t}_ticksToUnits(t){return t*this._beatsToUnits(1)/this._getPPQ()}_noArg(){return this._now()}_getBpm(){return this.context.transport.bpm.value}_getTimeSignature(){return this.context.transport.timeSignature}_getPPQ(){return this.context.transport.PPQ}fromType(t){switch(this._units=void 0,this.defaultUnits){case"s":this._val=t.toSeconds();break;case"i":this._val=t.toTicks();break;case"hz":this._val=t.toFrequency();break;case"midi":this._val=t.toMidi();break}return this}toFrequency(){return 1/this.toSeconds()}toSamples(){return this.toSeconds()*this.context.sampleRate}toMilliseconds(){return this.toSeconds()*1e3}}class Nn extends Tf{constructor(){super(...arguments),this.name="TimeClass"}_getExpressions(){return Object.assign(super._getExpressions(),{now:{method:t=>this._now()+new this.constructor(this.context,t).valueOf(),regexp:/^\+(.+)/},quantize:{method:t=>{const e=new Nn(this.context,t).valueOf();return this._secondsToUnits(this.context.transport.nextSubdivision(e))},regexp:/^@(.+)/}})}quantize(t,e=1){const s=new this.constructor(this.context,t).valueOf(),i=this.valueOf(),A=Math.round(i/s)*s-i;return i+A*e}toNotation(){const t=this.toSeconds(),e=["1m"];for(let r=1;r<9;r++){const o=Math.pow(2,r);e.push(o+"n."),e.push(o+"n"),e.push(o+"t")}e.push("0");let s=e[0],i=new Nn(this.context,e[0]).toSeconds();return e.forEach(r=>{const o=new Nn(this.context,r).toSeconds();Math.abs(o-t)<Math.abs(i-t)&&(s=r,i=o)}),s}toBarsBeatsSixteenths(){const t=this._beatsToUnits(1);let e=this.valueOf()/t;e=parseFloat(e.toFixed(4));const s=Math.floor(e/this._getTimeSignature());let i=e%1*4;e=Math.floor(e)%this._getTimeSignature();const r=i.toString();return r.length>3&&(i=parseFloat(parseFloat(r).toFixed(3))),[s,e,i].join(":")}toTicks(){const t=this._beatsToUnits(1);return this.valueOf()/t*this._getPPQ()}toSeconds(){return this.valueOf()}toMidi(){return sr(this.toFrequency())}_now(){return this.context.now()}}function Be(n,t){return new Nn(ke(),n,t)}class yn extends Nn{constructor(){super(...arguments),this.name="Frequency",this.defaultUnits="hz"}static get A4(){return r_()}static set A4(t){o_(t)}_getExpressions(){return Object.assign({},super._getExpressions(),{midi:{regexp:/^(\d+(?:\.\d+)?midi)/,method(t){return this.defaultUnits==="midi"?t:yn.mtof(t)}},note:{regexp:/^([a-g]{1}(?:b|#|##|x|bb|###|#x|x#|bbb)?)(-?[0-9]+)/i,method(t,e){const i=A_[t.toLowerCase()]+(parseInt(e,10)+1)*12;return this.defaultUnits==="midi"?i:yn.mtof(i)}},tr:{regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?/,method(t,e,s){let i=1;return t&&t!=="0"&&(i*=this._beatsToUnits(this._getTimeSignature()*parseFloat(t))),e&&e!=="0"&&(i*=this._beatsToUnits(parseFloat(e))),s&&s!=="0"&&(i*=this._beatsToUnits(parseFloat(s)/4)),i}}})}transpose(t){return new yn(this.context,this.valueOf()*nv(t))}harmonize(t){return t.map(e=>this.transpose(e))}toMidi(){return sr(this.valueOf())}toNote(){const t=this.toFrequency(),e=Math.log2(t/yn.A4);let s=Math.round(12*e)+57;const i=Math.floor(s/12);return i<0&&(s+=-12*i),a_[s%12]+i.toString()}toSeconds(){return 1/super.toSeconds()}toTicks(){const t=this._beatsToUnits(1),e=this.valueOf()/t;return Math.floor(e*this._getPPQ())}_noArg(){return 0}_frequencyToUnits(t){return t}_ticksToUnits(t){return 1/(t*60/(this._getBpm()*this._getPPQ()))}_beatsToUnits(t){return 1/super._beatsToUnits(t)}_secondsToUnits(t){return 1/t}static mtof(t){return iv(t)}static ftom(t){return sr(t)}}const A_={cbbb:-3,cbb:-2,cb:-1,c:0,"c#":1,cx:2,"c##":2,"c###":3,"cx#":3,"c#x":3,dbbb:-1,dbb:0,db:1,d:2,"d#":3,dx:4,"d##":4,"d###":5,"dx#":5,"d#x":5,ebbb:1,ebb:2,eb:3,e:4,"e#":5,ex:6,"e##":6,"e###":7,"ex#":7,"e#x":7,fbbb:2,fbb:3,fb:4,f:5,"f#":6,fx:7,"f##":7,"f###":8,"fx#":8,"f#x":8,gbbb:4,gbb:5,gb:6,g:7,"g#":8,gx:9,"g##":9,"g###":10,"gx#":10,"g#x":10,abbb:6,abb:7,ab:8,a:9,"a#":10,ax:11,"a##":11,"a###":12,"ax#":12,"a#x":12,bbbb:8,bbb:9,bb:10,b:11,"b#":12,bx:13,"b##":13,"b###":14,"bx#":14,"b#x":14},a_=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];class mA extends Nn{constructor(){super(...arguments),this.name="TransportTime"}_now(){return this.context.transport.seconds}}class un extends li{constructor(){super();const t=ft(un.getDefaults(),arguments,["context"]);this.defaultContext?this.context=this.defaultContext:this.context=t.context}static getDefaults(){return{context:ke()}}now(){return this.context.currentTime+this.context.lookAhead}immediate(){return this.context.currentTime}get sampleTime(){return 1/this.context.sampleRate}get blockTime(){return 128/this.context.sampleRate}toSeconds(t){return Wx(t),new Nn(this.context,t).toSeconds()}toFrequency(t){return new yn(this.context,t).toFrequency()}toTicks(t){return new mA(this.context,t).toTicks()}_getPartialProperties(t){const e=this.get();return Object.keys(e).forEach(s=>{Hn(t[s])&&delete e[s]}),e}get(){const t=Zx(this);return Object.keys(t).forEach(e=>{if(Reflect.has(this,e)){const s=this[e];Ft(s)&&Ft(s.value)&&Ft(s.setValueAtTime)?t[e]=s.value:s instanceof un?t[e]=s._getPartialProperties(t[e]):En(s)||ni(s)||si(s)||Vx(s)?t[e]=s:delete t[e]}}),t}set(t){return Object.keys(t).forEach(e=>{Reflect.has(this,e)&&Ft(this[e])&&(this[e]&&Ft(this[e].value)&&Ft(this[e].setValueAtTime)?this[e].value!==t[e]&&(this[e].value=t[e]):this[e]instanceof un?this[e].set(t[e]):this[e]=t[e])}),this}}class Qf extends On{constructor(t="stopped"){super(),this.name="StateTimeline",this._initial=t,this.setStateAtTime(this._initial,0)}getValueAtTime(t){const e=this.get(t);return e!==null?e.state:this._initial}setStateAtTime(t,e,s){return ii(e,0),this.add(Object.assign({},s,{state:t,time:e})),this}getLastState(t,e){const s=this._search(e);for(let i=s;i>=0;i--){const r=this._timeline[i];if(r.state===t)return r}}getNextState(t,e){const s=this._search(e);if(s!==-1)for(let i=s;i<this._timeline.length;i++){const r=this._timeline[i];if(r.state===t)return r}}}class xt extends un{constructor(){const t=ft(xt.getDefaults(),arguments,["param","units","convert"]);for(super(t),this.name="Param",this.overridden=!1,this._minOutput=1e-7,mt(Ft(t.param)&&(Cr(t.param)||t.param instanceof xt),"param must be an AudioParam");!Cr(t.param);)t.param=t.param._param;this._swappable=Ft(t.swappable)?t.swappable:!1,this._swappable?(this.input=this.context.createGain(),this._param=t.param,this.input.connect(this._param)):this._param=this.input=t.param,this._events=new On(1e3),this._initialValue=this._param.defaultValue,this.units=t.units,this.convert=t.convert,this._minValue=t.minValue,this._maxValue=t.maxValue,Ft(t.value)&&t.value!==this._toType(this._initialValue)&&this.setValueAtTime(t.value,0)}static getDefaults(){return Object.assign(un.getDefaults(),{convert:!0,units:"number"})}get value(){const t=this.now();return this.getValueAtTime(t)}set value(t){this.cancelScheduledValues(this.now()),this.setValueAtTime(t,this.now())}get minValue(){return Ft(this._minValue)?this._minValue:this.units==="time"||this.units==="frequency"||this.units==="normalRange"||this.units==="positive"||this.units==="transportTime"||this.units==="ticks"||this.units==="bpm"||this.units==="hertz"||this.units==="samples"?0:this.units==="audioRange"?-1:this.units==="decibels"?-1/0:this._param.minValue}get maxValue(){return Ft(this._maxValue)?this._maxValue:this.units==="normalRange"||this.units==="audioRange"?1:this._param.maxValue}_is(t,e){return this.units===e}_assertRange(t){return Ft(this.maxValue)&&Ft(this.minValue)&&ii(t,this._fromType(this.minValue),this._fromType(this.maxValue)),t}_fromType(t){return this.convert&&!this.overridden?this._is(t,"time")?this.toSeconds(t):this._is(t,"decibels")?i_(t):this._is(t,"frequency")?this.toFrequency(t):t:this.overridden?0:t}_toType(t){return this.convert&&this.units==="decibels"?ev(t):t}setValueAtTime(t,e){const s=this.toSeconds(e),i=this._fromType(t);return mt(isFinite(i)&&isFinite(s),`Invalid argument(s) to setValueAtTime: ${JSON.stringify(t)}, ${JSON.stringify(e)}`),this._assertRange(i),this.log(this.units,"setValueAtTime",t,s),this._events.add({time:s,type:"setValueAtTime",value:i}),this._param.setValueAtTime(i,s),this}getValueAtTime(t){const e=Math.max(this.toSeconds(t),0),s=this._events.getAfter(e),i=this._events.get(e);let r=this._initialValue;if(i===null)r=this._initialValue;else if(i.type==="setTargetAtTime"&&(s===null||s.type==="setValueAtTime")){const o=this._events.getBefore(i.time);let A;o===null?A=this._initialValue:A=o.value,i.type==="setTargetAtTime"&&(r=this._exponentialApproach(i.time,A,i.value,i.constant,e))}else if(s===null)r=i.value;else if(s.type==="linearRampToValueAtTime"||s.type==="exponentialRampToValueAtTime"){let o=i.value;if(i.type==="setTargetAtTime"){const A=this._events.getBefore(i.time);A===null?o=this._initialValue:o=A.value}s.type==="linearRampToValueAtTime"?r=this._linearInterpolate(i.time,o,s.time,s.value,e):r=this._exponentialInterpolate(i.time,o,s.time,s.value,e)}else r=i.value;return this._toType(r)}setRampPoint(t){t=this.toSeconds(t);let e=this.getValueAtTime(t);return this.cancelAndHoldAtTime(t),this._fromType(e)===0&&(e=this._toType(this._minOutput)),this.setValueAtTime(e,t),this}linearRampToValueAtTime(t,e){const s=this._fromType(t),i=this.toSeconds(e);return mt(isFinite(s)&&isFinite(i),`Invalid argument(s) to linearRampToValueAtTime: ${JSON.stringify(t)}, ${JSON.stringify(e)}`),this._assertRange(s),this._events.add({time:i,type:"linearRampToValueAtTime",value:s}),this.log(this.units,"linearRampToValueAtTime",t,i),this._param.linearRampToValueAtTime(s,i),this}exponentialRampToValueAtTime(t,e){let s=this._fromType(t);s=Yn(s,0)?this._minOutput:s,this._assertRange(s);const i=this.toSeconds(e);return mt(isFinite(s)&&isFinite(i),`Invalid argument(s) to exponentialRampToValueAtTime: ${JSON.stringify(t)}, ${JSON.stringify(e)}`),this._events.add({time:i,type:"exponentialRampToValueAtTime",value:s}),this.log(this.units,"exponentialRampToValueAtTime",t,i),this._param.exponentialRampToValueAtTime(s,i),this}exponentialRampTo(t,e,s){return s=this.toSeconds(s),this.setRampPoint(s),this.exponentialRampToValueAtTime(t,s+this.toSeconds(e)),this}linearRampTo(t,e,s){return s=this.toSeconds(s),this.setRampPoint(s),this.linearRampToValueAtTime(t,s+this.toSeconds(e)),this}targetRampTo(t,e,s){return s=this.toSeconds(s),this.setRampPoint(s),this.exponentialApproachValueAtTime(t,s,e),this}exponentialApproachValueAtTime(t,e,s){e=this.toSeconds(e),s=this.toSeconds(s);const i=Math.log(s+1)/Math.log(200);return this.setTargetAtTime(t,e,i),this.cancelAndHoldAtTime(e+s*.9),this.linearRampToValueAtTime(t,e+s),this}setTargetAtTime(t,e,s){const i=this._fromType(t);mt(isFinite(s)&&s>0,"timeConstant must be a number greater than 0");const r=this.toSeconds(e);return this._assertRange(i),mt(isFinite(i)&&isFinite(r),`Invalid argument(s) to setTargetAtTime: ${JSON.stringify(t)}, ${JSON.stringify(e)}`),this._events.add({constant:s,time:r,type:"setTargetAtTime",value:i}),this.log(this.units,"setTargetAtTime",t,r,s),this._param.setTargetAtTime(i,r,s),this}setValueCurveAtTime(t,e,s,i=1){s=this.toSeconds(s),e=this.toSeconds(e);const r=this._fromType(t[0])*i;this.setValueAtTime(this._toType(r),e);const o=s/(t.length-1);for(let A=1;A<t.length;A++){const a=this._fromType(t[A])*i;this.linearRampToValueAtTime(this._toType(a),e+A*o)}return this}cancelScheduledValues(t){const e=this.toSeconds(t);return mt(isFinite(e),`Invalid argument to cancelScheduledValues: ${JSON.stringify(t)}`),this._events.cancel(e),this._param.cancelScheduledValues(e),this.log(this.units,"cancelScheduledValues",e),this}cancelAndHoldAtTime(t){const e=this.toSeconds(t),s=this._fromType(this.getValueAtTime(e));mt(isFinite(e),`Invalid argument to cancelAndHoldAtTime: ${JSON.stringify(t)}`),this.log(this.units,"cancelAndHoldAtTime",e,"value="+s);const i=this._events.get(e),r=this._events.getAfter(e);return i&&Yn(i.time,e)?r?(this._param.cancelScheduledValues(r.time),this._events.cancel(r.time)):(this._param.cancelAndHoldAtTime(e),this._events.cancel(e+this.sampleTime)):r&&(this._param.cancelScheduledValues(r.time),this._events.cancel(r.time),r.type==="linearRampToValueAtTime"?this.linearRampToValueAtTime(this._toType(s),e):r.type==="exponentialRampToValueAtTime"&&this.exponentialRampToValueAtTime(this._toType(s),e)),this._events.add({time:e,type:"setValueAtTime",value:s}),this._param.setValueAtTime(s,e),this}rampTo(t,e=.1,s){return this.units==="frequency"||this.units==="bpm"||this.units==="decibels"?this.exponentialRampTo(t,e,s):this.linearRampTo(t,e,s),this}apply(t){const e=this.context.currentTime;t.setValueAtTime(this.getValueAtTime(e),e);const s=this._events.get(e);if(s&&s.type==="setTargetAtTime"){const i=this._events.getAfter(s.time),r=i?i.time:e+2,o=(r-e)/10;for(let A=e;A<r;A+=o)t.linearRampToValueAtTime(this.getValueAtTime(A),A)}return this._events.forEachAfter(this.context.currentTime,i=>{i.type==="cancelScheduledValues"?t.cancelScheduledValues(i.time):i.type==="setTargetAtTime"?t.setTargetAtTime(i.value,i.time,i.constant):t[i.type](i.value,i.time)}),this}setParam(t){mt(this._swappable,"The Param must be assigned as 'swappable' in the constructor");const e=this.input;return e.disconnect(this._param),this.apply(t),this._param=t,e.connect(this._param),this}dispose(){return super.dispose(),this._events.dispose(),this}get defaultValue(){return this._toType(this._param.defaultValue)}_exponentialApproach(t,e,s,i,r){return s+(e-s)*Math.exp(-(r-t)/i)}_linearInterpolate(t,e,s,i,r){return e+(i-e)*((r-t)/(s-t))}_exponentialInterpolate(t,e,s,i,r){return e*Math.pow(i/e,(r-t)/(s-t))}}class ht extends un{constructor(){super(...arguments),this._internalChannels=[]}get numberOfInputs(){return Ft(this.input)?Cr(this.input)||this.input instanceof xt?1:this.input.numberOfInputs:0}get numberOfOutputs(){return Ft(this.output)?this.output.numberOfOutputs:0}_isAudioNode(t){return Ft(t)&&(t instanceof ht||Ui(t))}_getInternalNodes(){const t=this._internalChannels.slice(0);return this._isAudioNode(this.input)&&t.push(this.input),this._isAudioNode(this.output)&&this.input!==this.output&&t.push(this.output),t}_setChannelProperties(t){this._getInternalNodes().forEach(s=>{s.channelCount=t.channelCount,s.channelCountMode=t.channelCountMode,s.channelInterpretation=t.channelInterpretation})}_getChannelProperties(){const t=this._getInternalNodes();mt(t.length>0,"ToneAudioNode does not have any internal nodes");const e=t[0];return{channelCount:e.channelCount,channelCountMode:e.channelCountMode,channelInterpretation:e.channelInterpretation}}get channelCount(){return this._getChannelProperties().channelCount}set channelCount(t){const e=this._getChannelProperties();this._setChannelProperties(Object.assign(e,{channelCount:t}))}get channelCountMode(){return this._getChannelProperties().channelCountMode}set channelCountMode(t){const e=this._getChannelProperties();this._setChannelProperties(Object.assign(e,{channelCountMode:t}))}get channelInterpretation(){return this._getChannelProperties().channelInterpretation}set channelInterpretation(t){const e=this._getChannelProperties();this._setChannelProperties(Object.assign(e,{channelInterpretation:t}))}connect(t,e=0,s=0){return ri(this,t,e,s),this}toDestination(){return this.connect(this.context.destination),this}toMaster(){return ya("toMaster() has been renamed toDestination()"),this.toDestination()}disconnect(t,e=0,s=0){return rv(this,t,e,s),this}chain(...t){return OA(this,...t),this}fan(...t){return t.forEach(e=>this.connect(e)),this}dispose(){return super.dispose(),Ft(this.input)&&(this.input instanceof ht?this.input.dispose():Ui(this.input)&&this.input.disconnect()),Ft(this.output)&&(this.output instanceof ht?this.output.dispose():Ui(this.output)&&this.output.disconnect()),this._internalChannels=[],this}}function OA(...n){const t=n.shift();n.reduce((e,s)=>(e instanceof ht?e.connect(s):Ui(e)&&ri(e,s),s),t)}function ri(n,t,e=0,s=0){for(mt(Ft(n),"Cannot connect from undefined node"),mt(Ft(t),"Cannot connect to undefined node"),(t instanceof ht||Ui(t))&&mt(t.numberOfInputs>0,"Cannot connect to node with no inputs"),mt(n.numberOfOutputs>0,"Cannot connect from node with no outputs");t instanceof ht||t instanceof xt;)Ft(t.input)&&(t=t.input);for(;n instanceof ht;)Ft(n.output)&&(n=n.output);Cr(t)?n.connect(t,e):n.connect(t,e,s)}function rv(n,t,e=0,s=0){if(Ft(t))for(;t instanceof ht;)t=t.input;for(;!Ui(n);)Ft(n.output)&&(n=n.output);Cr(t)?n.disconnect(t,e):Ui(t)?n.disconnect(t,e,s):n.disconnect()}class Tt extends ht{constructor(){const t=ft(Tt.getDefaults(),arguments,["gain","units"]);super(t),this.name="Gain",this._gainNode=this.context.createGain(),this.input=this._gainNode,this.output=this._gainNode,this.gain=new xt({context:this.context,convert:t.convert,param:this._gainNode.gain,units:t.units,value:t.gain,minValue:t.minValue,maxValue:t.maxValue}),Pt(this,"gain")}static getDefaults(){return Object.assign(ht.getDefaults(),{convert:!0,gain:1,units:"gain"})}dispose(){return super.dispose(),this._gainNode.disconnect(),this.gain.dispose(),this}}class Io extends ht{constructor(t){super(t),this.onended=Lt,this._startTime=-1,this._stopTime=-1,this._timeout=-1,this.output=new Tt({context:this.context,gain:0}),this._gainNode=this.output,this.getStateAtTime=function(e){const s=this.toSeconds(e);return this._startTime!==-1&&s>=this._startTime&&(this._stopTime===-1||s<=this._stopTime)?"started":"stopped"},this._fadeIn=t.fadeIn,this._fadeOut=t.fadeOut,this._curve=t.curve,this.onended=t.onended}static getDefaults(){return Object.assign(ht.getDefaults(),{curve:"linear",fadeIn:0,fadeOut:0,onended:Lt})}_startGain(t,e=1){mt(this._startTime===-1,"Source cannot be started more than once");const s=this.toSeconds(this._fadeIn);return this._startTime=t+s,this._startTime=Math.max(this._startTime,this.context.currentTime),s>0?(this._gainNode.gain.setValueAtTime(0,t),this._curve==="linear"?this._gainNode.gain.linearRampToValueAtTime(e,t+s):this._gainNode.gain.exponentialApproachValueAtTime(e,t,s)):this._gainNode.gain.setValueAtTime(e,t),this}stop(t){return this.log("stop",t),this._stopGain(this.toSeconds(t)),this}_stopGain(t){mt(this._startTime!==-1,"'start' must be called before 'stop'"),this.cancelStop();const e=this.toSeconds(this._fadeOut);return this._stopTime=this.toSeconds(t)+e,this._stopTime=Math.max(this._stopTime,this.now()),e>0?this._curve==="linear"?this._gainNode.gain.linearRampTo(0,e,t):this._gainNode.gain.targetRampTo(0,e,t):(this._gainNode.gain.cancelAndHoldAtTime(t),this._gainNode.gain.setValueAtTime(0,t)),this.context.clearTimeout(this._timeout),this._timeout=this.context.setTimeout(()=>{const s=this._curve==="exponential"?e*2:0;this._stopSource(this.now()+s),this._onended()},this._stopTime-this.context.currentTime),this}_onended(){if(this.onended!==Lt&&(this.onended(this),this.onended=Lt,!this.context.isOffline)){const t=()=>this.dispose();typeof requestIdleCallback<"u"?requestIdleCallback(t):setTimeout(t,10)}}get state(){return this.getStateAtTime(this.now())}cancelStop(){return this.log("cancelStop"),mt(this._startTime!==-1,"Source is not started"),this._gainNode.gain.cancelScheduledValues(this._startTime+this.sampleTime),this.context.clearTimeout(this._timeout),this._stopTime=-1,this}dispose(){return super.dispose(),this._gainNode.dispose(),this.onended=Lt,this}}class Mf extends Io{constructor(){const t=ft(Mf.getDefaults(),arguments,["offset"]);super(t),this.name="ToneConstantSource",this._source=this.context.createConstantSource(),ri(this._source,this._gainNode),this.offset=new xt({context:this.context,convert:t.convert,param:this._source.offset,units:t.units,value:t.offset,minValue:t.minValue,maxValue:t.maxValue})}static getDefaults(){return Object.assign(Io.getDefaults(),{convert:!0,offset:1,units:"number"})}start(t){const e=this.toSeconds(t);return this.log("start",e),this._startGain(e),this._source.start(e),this}_stopSource(t){this._source.stop(t)}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._source.disconnect(),this.offset.dispose(),this}}class Kt extends ht{constructor(){const t=ft(Kt.getDefaults(),arguments,["value","units"]);super(t),this.name="Signal",this.override=!0,this.output=this._constantSource=new Mf({context:this.context,convert:t.convert,offset:t.value,units:t.units,minValue:t.minValue,maxValue:t.maxValue}),this._constantSource.start(0),this.input=this._param=this._constantSource.offset}static getDefaults(){return Object.assign(ht.getDefaults(),{convert:!0,units:"number",value:0})}connect(t,e=0,s=0){return Xc(this,t,e,s),this}dispose(){return super.dispose(),this._param.dispose(),this._constantSource.dispose(),this}setValueAtTime(t,e){return this._param.setValueAtTime(t,e),this}getValueAtTime(t){return this._param.getValueAtTime(t)}setRampPoint(t){return this._param.setRampPoint(t),this}linearRampToValueAtTime(t,e){return this._param.linearRampToValueAtTime(t,e),this}exponentialRampToValueAtTime(t,e){return this._param.exponentialRampToValueAtTime(t,e),this}exponentialRampTo(t,e,s){return this._param.exponentialRampTo(t,e,s),this}linearRampTo(t,e,s){return this._param.linearRampTo(t,e,s),this}targetRampTo(t,e,s){return this._param.targetRampTo(t,e,s),this}exponentialApproachValueAtTime(t,e,s){return this._param.exponentialApproachValueAtTime(t,e,s),this}setTargetAtTime(t,e,s){return this._param.setTargetAtTime(t,e,s),this}setValueCurveAtTime(t,e,s,i){return this._param.setValueCurveAtTime(t,e,s,i),this}cancelScheduledValues(t){return this._param.cancelScheduledValues(t),this}cancelAndHoldAtTime(t){return this._param.cancelAndHoldAtTime(t),this}rampTo(t,e,s){return this._param.rampTo(t,e,s),this}get value(){return this._param.value}set value(t){this._param.value=t}get convert(){return this._param.convert}set convert(t){this._param.convert=t}get units(){return this._param.units}get overridden(){return this._param.overridden}set overridden(t){this._param.overridden=t}get maxValue(){return this._param.maxValue}get minValue(){return this._param.minValue}apply(t){return this._param.apply(t),this}}function Xc(n,t,e,s){(t instanceof xt||Cr(t)||t instanceof Kt&&t.override)&&(t.cancelScheduledValues(0),t.setValueAtTime(0,0),t instanceof Kt&&(t.overridden=!0)),ri(n,t,e,s)}class Uf extends xt{constructor(){const t=ft(Uf.getDefaults(),arguments,["value"]);super(t),this.name="TickParam",this._events=new On(1/0),this._multiplier=1,this._multiplier=t.multiplier,this._events.cancel(0),this._events.add({ticks:0,time:0,type:"setValueAtTime",value:this._fromType(t.value)}),this.setValueAtTime(t.value,0)}static getDefaults(){return Object.assign(xt.getDefaults(),{multiplier:1,units:"hertz",value:1})}setTargetAtTime(t,e,s){e=this.toSeconds(e),this.setRampPoint(e);const i=this._fromType(t),r=this._events.get(e),o=Math.round(Math.max(1/s,1));for(let A=0;A<=o;A++){const a=s*A+e,l=this._exponentialApproach(r.time,r.value,i,s,a);this.linearRampToValueAtTime(this._toType(l),a)}return this}setValueAtTime(t,e){const s=this.toSeconds(e);super.setValueAtTime(t,e);const i=this._events.get(s),r=this._events.previousEvent(i),o=this._getTicksUntilEvent(r,s);return i.ticks=Math.max(o,0),this}linearRampToValueAtTime(t,e){const s=this.toSeconds(e);super.linearRampToValueAtTime(t,e);const i=this._events.get(s),r=this._events.previousEvent(i),o=this._getTicksUntilEvent(r,s);return i.ticks=Math.max(o,0),this}exponentialRampToValueAtTime(t,e){e=this.toSeconds(e);const s=this._fromType(t),i=this._events.get(e),r=Math.round(Math.max((e-i.time)*10,1)),o=(e-i.time)/r;for(let A=0;A<=r;A++){const a=o*A+i.time,l=this._exponentialInterpolate(i.time,i.value,e,s,a);this.linearRampToValueAtTime(this._toType(l),a)}return this}_getTicksUntilEvent(t,e){if(t===null)t={ticks:0,time:0,type:"setValueAtTime",value:0};else if(Hn(t.ticks)){const o=this._events.previousEvent(t);t.ticks=this._getTicksUntilEvent(o,t.time)}const s=this._fromType(this.getValueAtTime(t.time));let i=this._fromType(this.getValueAtTime(e));const r=this._events.get(e);return r&&r.time===e&&r.type==="setValueAtTime"&&(i=this._fromType(this.getValueAtTime(e-this.sampleTime))),.5*(e-t.time)*(s+i)+t.ticks}getTicksAtTime(t){const e=this.toSeconds(t),s=this._events.get(e);return Math.max(this._getTicksUntilEvent(s,e),0)}getDurationOfTicks(t,e){const s=this.toSeconds(e),i=this.getTicksAtTime(e);return this.getTimeOfTick(i+t)-s}getTimeOfTick(t){const e=this._events.get(t,"ticks"),s=this._events.getAfter(t,"ticks");if(e&&e.ticks===t)return e.time;if(e&&s&&s.type==="linearRampToValueAtTime"&&e.value!==s.value){const i=this._fromType(this.getValueAtTime(e.time)),o=(this._fromType(this.getValueAtTime(s.time))-i)/(s.time-e.time),A=Math.sqrt(Math.pow(i,2)-2*o*(e.ticks-t)),a=(-i+A)/o,l=(-i-A)/o;return(a>0?a:l)+e.time}else return e?e.value===0?1/0:e.time+(t-e.ticks)/e.value:t/this._initialValue}ticksToTime(t,e){return this.getDurationOfTicks(t,e)}timeToTicks(t,e){const s=this.toSeconds(e),i=this.toSeconds(t),r=this.getTicksAtTime(s);return this.getTicksAtTime(s+i)-r}_fromType(t){return this.units==="bpm"&&this.multiplier?1/(60/t/this.multiplier):super._fromType(t)}_toType(t){return this.units==="bpm"&&this.multiplier?t/this.multiplier*60:super._toType(t)}get multiplier(){return this._multiplier}set multiplier(t){const e=this.value;this._multiplier=t,this.cancelScheduledValues(0),this.setValueAtTime(e,0)}}class Pf extends Kt{constructor(){const t=ft(Pf.getDefaults(),arguments,["value"]);super(t),this.name="TickSignal",this.input=this._param=new Uf({context:this.context,convert:t.convert,multiplier:t.multiplier,param:this._constantSource.offset,units:t.units,value:t.value})}static getDefaults(){return Object.assign(Kt.getDefaults(),{multiplier:1,units:"hertz",value:1})}ticksToTime(t,e){return this._param.ticksToTime(t,e)}timeToTicks(t,e){return this._param.timeToTicks(t,e)}getTimeOfTick(t){return this._param.getTimeOfTick(t)}getDurationOfTicks(t,e){return this._param.getDurationOfTicks(t,e)}getTicksAtTime(t){return this._param.getTicksAtTime(t)}get multiplier(){return this._param.multiplier}set multiplier(t){this._param.multiplier=t}dispose(){return super.dispose(),this._param.dispose(),this}}class Nf extends un{constructor(){const t=ft(Nf.getDefaults(),arguments,["frequency"]);super(t),this.name="TickSource",this._state=new Qf,this._tickOffset=new On,this._ticksAtTime=new On,this._secondsAtTime=new On,this.frequency=new Pf({context:this.context,units:t.units,value:t.frequency}),Pt(this,"frequency"),this._state.setStateAtTime("stopped",0),this.setTicksAtTime(0,0)}static getDefaults(){return Object.assign({frequency:1,units:"hertz"},un.getDefaults())}get state(){return this.getStateAtTime(this.now())}start(t,e){const s=this.toSeconds(t);return this._state.getValueAtTime(s)!=="started"&&(this._state.setStateAtTime("started",s),Ft(e)&&this.setTicksAtTime(e,s),this._ticksAtTime.cancel(s),this._secondsAtTime.cancel(s)),this}stop(t){const e=this.toSeconds(t);if(this._state.getValueAtTime(e)==="stopped"){const s=this._state.get(e);s&&s.time>0&&(this._tickOffset.cancel(s.time),this._state.cancel(s.time))}return this._state.cancel(e),this._state.setStateAtTime("stopped",e),this.setTicksAtTime(0,e),this._ticksAtTime.cancel(e),this._secondsAtTime.cancel(e),this}pause(t){const e=this.toSeconds(t);return this._state.getValueAtTime(e)==="started"&&(this._state.setStateAtTime("paused",e),this._ticksAtTime.cancel(e),this._secondsAtTime.cancel(e)),this}cancel(t){return t=this.toSeconds(t),this._state.cancel(t),this._tickOffset.cancel(t),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t),this}getTicksAtTime(t){const e=this.toSeconds(t),s=this._state.getLastState("stopped",e),i=this._ticksAtTime.get(e),r={state:"paused",time:e};this._state.add(r);let o=i||s,A=i?i.ticks:0,a=null;return this._state.forEachBetween(o.time,e+this.sampleTime,l=>{let c=o.time;const u=this._tickOffset.get(l.time);u&&u.time>=o.time&&(A=u.ticks,c=u.time),o.state==="started"&&l.state!=="started"&&(A+=this.frequency.getTicksAtTime(l.time)-this.frequency.getTicksAtTime(c),l.time!==r.time&&(a={state:l.state,time:l.time,ticks:A})),o=l}),this._state.remove(r),a&&this._ticksAtTime.add(a),A}get ticks(){return this.getTicksAtTime(this.now())}set ticks(t){this.setTicksAtTime(t,this.now())}get seconds(){return this.getSecondsAtTime(this.now())}set seconds(t){const e=this.now(),s=this.frequency.timeToTicks(t,e);this.setTicksAtTime(s,e)}getSecondsAtTime(t){t=this.toSeconds(t);const e=this._state.getLastState("stopped",t),s={state:"paused",time:t};this._state.add(s);const i=this._secondsAtTime.get(t);let r=i||e,o=i?i.seconds:0,A=null;return this._state.forEachBetween(r.time,t+this.sampleTime,a=>{let l=r.time;const c=this._tickOffset.get(a.time);c&&c.time>=r.time&&(o=c.seconds,l=c.time),r.state==="started"&&a.state!=="started"&&(o+=a.time-l,a.time!==s.time&&(A={state:a.state,time:a.time,seconds:o})),r=a}),this._state.remove(s),A&&this._secondsAtTime.add(A),o}setTicksAtTime(t,e){return e=this.toSeconds(e),this._tickOffset.cancel(e),this._tickOffset.add({seconds:this.frequency.getDurationOfTicks(t,e),ticks:t,time:e}),this._ticksAtTime.cancel(e),this._secondsAtTime.cancel(e),this}getStateAtTime(t){return t=this.toSeconds(t),this._state.getValueAtTime(t)}getTimeOfTick(t,e=this.now()){const s=this._tickOffset.get(e),i=this._state.get(e),r=Math.max(s.time,i.time),o=this.frequency.getTicksAtTime(r)+t-s.ticks;return this.frequency.getTimeOfTick(o)}forEachTickBetween(t,e,s){let i=this._state.get(t);this._state.forEachBetween(t,e,o=>{i&&i.state==="started"&&o.state!=="started"&&this.forEachTickBetween(Math.max(i.time,t),o.time-this.sampleTime,s),i=o});let r=null;if(i&&i.state==="started"){const o=Math.max(i.time,t),A=this.frequency.getTicksAtTime(o),a=this.frequency.getTicksAtTime(i.time),l=A-a;let c=Math.ceil(l)-l;c=Yn(c,1)?0:c;let u=this.frequency.getTimeOfTick(A+c);for(;u<e;){try{s(u,Math.round(this.getTicksAtTime(u)))}catch(d){r=d;break}u+=this.frequency.getDurationOfTicks(1,u)}}if(r)throw r;return this}dispose(){return super.dispose(),this._state.dispose(),this._tickOffset.dispose(),this._ticksAtTime.dispose(),this._secondsAtTime.dispose(),this.frequency.dispose(),this}}class $c extends un{constructor(){const t=ft($c.getDefaults(),arguments,["callback","frequency"]);super(t),this.name="Clock",this.callback=Lt,this._lastUpdate=0,this._state=new Qf("stopped"),this._boundLoop=this._loop.bind(this),this.callback=t.callback,this._tickSource=new Nf({context:this.context,frequency:t.frequency,units:t.units}),this._lastUpdate=0,this.frequency=this._tickSource.frequency,Pt(this,"frequency"),this._state.setStateAtTime("stopped",0),this.context.on("tick",this._boundLoop)}static getDefaults(){return Object.assign(un.getDefaults(),{callback:Lt,frequency:1,units:"hertz"})}get state(){return this._state.getValueAtTime(this.now())}start(t,e){Kw(this.context);const s=this.toSeconds(t);return this.log("start",s),this._state.getValueAtTime(s)!=="started"&&(this._state.setStateAtTime("started",s),this._tickSource.start(s,e),s<this._lastUpdate&&this.emit("start",s,e)),this}stop(t){const e=this.toSeconds(t);return this.log("stop",e),this._state.cancel(e),this._state.setStateAtTime("stopped",e),this._tickSource.stop(e),e<this._lastUpdate&&this.emit("stop",e),this}pause(t){const e=this.toSeconds(t);return this._state.getValueAtTime(e)==="started"&&(this._state.setStateAtTime("paused",e),this._tickSource.pause(e),e<this._lastUpdate&&this.emit("pause",e)),this}get ticks(){return Math.ceil(this.getTicksAtTime(this.now()))}set ticks(t){this._tickSource.ticks=t}get seconds(){return this._tickSource.seconds}set seconds(t){this._tickSource.seconds=t}getSecondsAtTime(t){return this._tickSource.getSecondsAtTime(t)}setTicksAtTime(t,e){return this._tickSource.setTicksAtTime(t,e),this}getTimeOfTick(t,e=this.now()){return this._tickSource.getTimeOfTick(t,e)}getTicksAtTime(t){return this._tickSource.getTicksAtTime(t)}nextTickTime(t,e){const s=this.toSeconds(e),i=this.getTicksAtTime(s);return this._tickSource.getTimeOfTick(i+t,s)}_loop(){const t=this._lastUpdate,e=this.now();this._lastUpdate=e,this.log("loop",t,e),t!==e&&(this._state.forEachBetween(t,e,s=>{switch(s.state){case"started":const i=this._tickSource.getTicksAtTime(s.time);this.emit("start",s.time,i);break;case"stopped":s.time!==0&&this.emit("stop",s.time);break;case"paused":this.emit("pause",s.time);break}}),this._tickSource.forEachTickBetween(t,e,(s,i)=>{this.callback(s,i)}))}getStateAtTime(t){const e=this.toSeconds(t);return this._state.getValueAtTime(e)}dispose(){return super.dispose(),this.context.off("tick",this._boundLoop),this._tickSource.dispose(),this._state.dispose(),this}}_f.mixin($c);class Df extends ht{constructor(){const t=ft(Df.getDefaults(),arguments,["delayTime","maxDelay"]);super(t),this.name="Delay";const e=this.toSeconds(t.maxDelay);this._maxDelay=Math.max(e,this.toSeconds(t.delayTime)),this._delayNode=this.input=this.output=this.context.createDelay(e),this.delayTime=new xt({context:this.context,param:this._delayNode.delayTime,units:"time",value:t.delayTime,minValue:0,maxValue:this.maxDelay}),Pt(this,"delayTime")}static getDefaults(){return Object.assign(ht.getDefaults(),{delayTime:0,maxDelay:1})}get maxDelay(){return this._maxDelay}dispose(){return super.dispose(),this._delayNode.disconnect(),this.delayTime.dispose(),this}}class ci extends ht{constructor(){const t=ft(ci.getDefaults(),arguments,["volume"]);super(t),this.name="Volume",this.input=this.output=new Tt({context:this.context,gain:t.volume,units:"decibels"}),this.volume=this.output.gain,Pt(this,"volume"),this._unmutedVolume=t.volume,this.mute=t.mute}static getDefaults(){return Object.assign(ht.getDefaults(),{mute:!1,volume:0})}get mute(){return this.volume.value===-1/0}set mute(t){!this.mute&&t?(this._unmutedVolume=this.volume.value,this.volume.value=-1/0):this.mute&&!t&&(this.volume.value=this._unmutedVolume)}dispose(){return super.dispose(),this.input.dispose(),this.volume.dispose(),this}}class Lf extends ht{constructor(){const t=ft(Lf.getDefaults(),arguments);super(t),this.name="Destination",this.input=new ci({context:this.context}),this.output=new Tt({context:this.context}),this.volume=this.input.volume,OA(this.input,this.output,this.context.rawContext.destination),this.mute=t.mute,this._internalChannels=[this.input,this.context.rawContext.destination,this.output]}static getDefaults(){return Object.assign(ht.getDefaults(),{mute:!1,volume:0})}get mute(){return this.input.mute}set mute(t){this.input.mute=t}chain(...t){return this.input.disconnect(),t.unshift(this.input),t.push(this.output),OA(...t),this}get maxChannelCount(){return this.context.rawContext.destination.maxChannelCount}dispose(){return super.dispose(),this.volume.dispose(),this}}Gc(n=>{n.destination=new Lf({context:n})});Kc(n=>{n.destination.dispose()});class l_ extends ht{constructor(){super(...arguments),this.name="Listener",this.positionX=new xt({context:this.context,param:this.context.rawContext.listener.positionX}),this.positionY=new xt({context:this.context,param:this.context.rawContext.listener.positionY}),this.positionZ=new xt({context:this.context,param:this.context.rawContext.listener.positionZ}),this.forwardX=new xt({context:this.context,param:this.context.rawContext.listener.forwardX}),this.forwardY=new xt({context:this.context,param:this.context.rawContext.listener.forwardY}),this.forwardZ=new xt({context:this.context,param:this.context.rawContext.listener.forwardZ}),this.upX=new xt({context:this.context,param:this.context.rawContext.listener.upX}),this.upY=new xt({context:this.context,param:this.context.rawContext.listener.upY}),this.upZ=new xt({context:this.context,param:this.context.rawContext.listener.upZ})}static getDefaults(){return Object.assign(ht.getDefaults(),{positionX:0,positionY:0,positionZ:0,forwardX:0,forwardY:0,forwardZ:-1,upX:0,upY:1,upZ:0})}dispose(){return super.dispose(),this.positionX.dispose(),this.positionY.dispose(),this.positionZ.dispose(),this.forwardX.dispose(),this.forwardY.dispose(),this.forwardZ.dispose(),this.upX.dispose(),this.upY.dispose(),this.upZ.dispose(),this}}Gc(n=>{n.listener=new l_({context:n})});Kc(n=>{n.listener.dispose()});class Yc extends li{constructor(){super(),this.name="ToneAudioBuffers",this._buffers=new Map,this._loadingCount=0;const t=ft(Yc.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");this.baseUrl=t.baseUrl,Object.keys(t.urls).forEach(e=>{this._loadingCount++;const s=t.urls[e];this.add(e,s,this._bufferLoaded.bind(this,t.onload),t.onerror)})}static getDefaults(){return{baseUrl:"",onerror:Lt,onload:Lt,urls:{}}}has(t){return this._buffers.has(t.toString())}get(t){return mt(this.has(t),`ToneAudioBuffers has no buffer named: ${t}`),this._buffers.get(t.toString())}_bufferLoaded(t){this._loadingCount--,this._loadingCount===0&&t&&t()}get loaded(){return Array.from(this._buffers).every(([t,e])=>e.loaded)}add(t,e,s=Lt,i=Lt){return si(e)?(this.baseUrl&&e.trim().substring(0,11).toLowerCase()==="data:audio/"&&(this.baseUrl=""),this._buffers.set(t.toString(),new ee(this.baseUrl+e,s,i))):this._buffers.set(t.toString(),new ee(e,s,i)),this}dispose(){return super.dispose(),this._buffers.forEach(t=>t.dispose()),this._buffers.clear(),this}}class VA extends yn{constructor(){super(...arguments),this.name="MidiClass",this.defaultUnits="midi"}_frequencyToUnits(t){return sr(super._frequencyToUnits(t))}_ticksToUnits(t){return sr(super._ticksToUnits(t))}_beatsToUnits(t){return sr(super._beatsToUnits(t))}_secondsToUnits(t){return sr(super._secondsToUnits(t))}toMidi(){return this.valueOf()}toFrequency(){return iv(this.toMidi())}transpose(t){return new VA(this.context,this.toMidi()+t)}}function c_(n,t){return new VA(ke(),n,t)}class Jr extends mA{constructor(){super(...arguments),this.name="Ticks",this.defaultUnits="i"}_now(){return this.context.transport.ticks}_beatsToUnits(t){return this._getPPQ()*t}_secondsToUnits(t){return Math.floor(t/(60/this._getBpm())*this._getPPQ())}_ticksToUnits(t){return t}toTicks(){return this.valueOf()}toSeconds(){return this.valueOf()/this._getPPQ()*(60/this._getBpm())}}class u_ extends un{constructor(){super(...arguments),this.name="Draw",this.expiration=.25,this.anticipation=.008,this._events=new On,this._boundDrawLoop=this._drawLoop.bind(this),this._animationFrame=-1}schedule(t,e){return this._events.add({callback:t,time:this.toSeconds(e)}),this._events.length===1&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop)),this}cancel(t){return this._events.cancel(this.toSeconds(t)),this}_drawLoop(){const t=this.context.currentTime;this._events.forEachBefore(t+this.anticipation,e=>{t-e.time<=this.expiration&&e.callback(),this._events.remove(e)}),this._events.length>0&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop))}dispose(){return super.dispose(),this._events.dispose(),cancelAnimationFrame(this._animationFrame),this}}Gc(n=>{n.draw=new u_({context:n})});Kc(n=>{n.draw.dispose()});class d_ extends li{constructor(){super(...arguments),this.name="IntervalTimeline",this._root=null,this._length=0}add(t){mt(Ft(t.time),"Events must have a time property"),mt(Ft(t.duration),"Events must have a duration parameter"),t.time=t.time.valueOf();let e=new h_(t.time,t.time+t.duration,t);for(this._root===null?this._root=e:this._root.insert(e),this._length++;e!==null;)e.updateHeight(),e.updateMax(),this._rebalance(e),e=e.parent;return this}remove(t){if(this._root!==null){const e=[];this._root.search(t.time,e);for(const s of e)if(s.event===t){this._removeNode(s),this._length--;break}}return this}get length(){return this._length}cancel(t){return this.forEachFrom(t,e=>this.remove(e)),this}_setRoot(t){this._root=t,this._root!==null&&(this._root.parent=null)}_replaceNodeInParent(t,e){t.parent!==null?(t.isLeftChild()?t.parent.left=e:t.parent.right=e,this._rebalance(t.parent)):this._setRoot(e)}_removeNode(t){if(t.left===null&&t.right===null)this._replaceNodeInParent(t,null);else if(t.right===null)this._replaceNodeInParent(t,t.left);else if(t.left===null)this._replaceNodeInParent(t,t.right);else{const e=t.getBalance();let s,i=null;if(e>0)if(t.left.right===null)s=t.left,s.right=t.right,i=s;else{for(s=t.left.right;s.right!==null;)s=s.right;s.parent&&(s.parent.right=s.left,i=s.parent,s.left=t.left,s.right=t.right)}else if(t.right.left===null)s=t.right,s.left=t.left,i=s;else{for(s=t.right.left;s.left!==null;)s=s.left;s.parent&&(s.parent.left=s.right,i=s.parent,s.left=t.left,s.right=t.right)}t.parent!==null?t.isLeftChild()?t.parent.left=s:t.parent.right=s:this._setRoot(s),i&&this._rebalance(i)}t.dispose()}_rotateLeft(t){const e=t.parent,s=t.isLeftChild(),i=t.right;i&&(t.right=i.left,i.left=t),e!==null?s?e.left=i:e.right=i:this._setRoot(i)}_rotateRight(t){const e=t.parent,s=t.isLeftChild(),i=t.left;i&&(t.left=i.right,i.right=t),e!==null?s?e.left=i:e.right=i:this._setRoot(i)}_rebalance(t){const e=t.getBalance();e>1&&t.left?t.left.getBalance()<0?this._rotateLeft(t.left):this._rotateRight(t):e<-1&&t.right&&(t.right.getBalance()>0?this._rotateRight(t.right):this._rotateLeft(t))}get(t){if(this._root!==null){const e=[];if(this._root.search(t,e),e.length>0){let s=e[0];for(let i=1;i<e.length;i++)e[i].low>s.low&&(s=e[i]);return s.event}}return null}forEach(t){if(this._root!==null){const e=[];this._root.traverse(s=>e.push(s)),e.forEach(s=>{s.event&&t(s.event)})}return this}forEachAtTime(t,e){if(this._root!==null){const s=[];this._root.search(t,s),s.forEach(i=>{i.event&&e(i.event)})}return this}forEachFrom(t,e){if(this._root!==null){const s=[];this._root.searchAfter(t,s),s.forEach(i=>{i.event&&e(i.event)})}return this}dispose(){return super.dispose(),this._root!==null&&this._root.traverse(t=>t.dispose()),this._root=null,this}}class h_{constructor(t,e,s){this._left=null,this._right=null,this.parent=null,this.height=0,this.event=s,this.low=t,this.high=e,this.max=this.high}insert(t){t.low<=this.low?this.left===null?this.left=t:this.left.insert(t):this.right===null?this.right=t:this.right.insert(t)}search(t,e){t>this.max||(this.left!==null&&this.left.search(t,e),this.low<=t&&this.high>t&&e.push(this),!(this.low>t)&&this.right!==null&&this.right.search(t,e))}searchAfter(t,e){this.low>=t&&(e.push(this),this.left!==null&&this.left.searchAfter(t,e)),this.right!==null&&this.right.searchAfter(t,e)}traverse(t){t(this),this.left!==null&&this.left.traverse(t),this.right!==null&&this.right.traverse(t)}updateHeight(){this.left!==null&&this.right!==null?this.height=Math.max(this.left.height,this.right.height)+1:this.right!==null?this.height=this.right.height+1:this.left!==null?this.height=this.left.height+1:this.height=0}updateMax(){this.max=this.high,this.left!==null&&(this.max=Math.max(this.max,this.left.max)),this.right!==null&&(this.max=Math.max(this.max,this.right.max))}getBalance(){let t=0;return this.left!==null&&this.right!==null?t=this.left.height-this.right.height:this.left!==null?t=this.left.height+1:this.right!==null&&(t=-(this.right.height+1)),t}isLeftChild(){return this.parent!==null&&this.parent.left===this}get left(){return this._left}set left(t){this._left=t,t!==null&&(t.parent=this),this.updateHeight(),this.updateMax()}get right(){return this._right}set right(t){this._right=t,t!==null&&(t.parent=this),this.updateHeight(),this.updateMax()}dispose(){this.parent=null,this._left=null,this._right=null,this.event=null}}class f_ extends li{constructor(t){super(),this.name="TimelineValue",this._timeline=new On({memory:10}),this._initialValue=t}set(t,e){return this._timeline.add({value:t,time:e}),this}get(t){const e=this._timeline.get(t);return e?e.value:this._initialValue}}class _s extends ht{constructor(){super(ft(_s.getDefaults(),arguments,["context"]))}connect(t,e=0,s=0){return Xc(this,t,e,s),this}}class Wo extends _s{constructor(){const t=ft(Wo.getDefaults(),arguments,["mapping","length"]);super(t),this.name="WaveShaper",this._shaper=this.context.createWaveShaper(),this.input=this._shaper,this.output=this._shaper,En(t.mapping)||t.mapping instanceof Float32Array?this.curve=Float32Array.from(t.mapping):Ox(t.mapping)&&this.setMap(t.mapping,t.length)}static getDefaults(){return Object.assign(Kt.getDefaults(),{length:1024})}setMap(t,e=1024){const s=new Float32Array(e);for(let i=0,r=e;i<r;i++){const o=i/(r-1)*2-1;s[i]=t(o,i)}return this.curve=s,this}get curve(){return this._shaper.curve}set curve(t){this._shaper.curve=t}get oversample(){return this._shaper.oversample}set oversample(t){const e=["none","2x","4x"].some(s=>s.includes(t));mt(e,"oversampling must be either 'none', '2x', or '4x'"),this._shaper.oversample=t}dispose(){return super.dispose(),this._shaper.disconnect(),this}}class kf extends _s{constructor(){const t=ft(kf.getDefaults(),arguments,["value"]);super(t),this.name="Pow",this._exponentScaler=this.input=this.output=new Wo({context:this.context,mapping:this._expFunc(t.value),length:8192}),this._exponent=t.value}static getDefaults(){return Object.assign(_s.getDefaults(),{value:1})}_expFunc(t){return e=>Math.pow(Math.abs(e),t)}get value(){return this._exponent}set value(t){this._exponent=t,this._exponentScaler.setMap(this._expFunc(this._exponent))}dispose(){return super.dispose(),this._exponentScaler.dispose(),this}}class Hi{constructor(t,e){this.id=Hi._eventId++,this._remainderTime=0;const s=Object.assign(Hi.getDefaults(),e);this.transport=t,this.callback=s.callback,this._once=s.once,this.time=Math.floor(s.time),this._remainderTime=s.time-this.time}static getDefaults(){return{callback:Lt,once:!1,time:0}}get floatTime(){return this.time+this._remainderTime}invoke(t){if(this.callback){const e=this.transport.bpm.getDurationOfTicks(1,t);this.callback(t+this._remainderTime*e),this._once&&this.transport.clear(this.id)}}dispose(){return this.callback=void 0,this}}Hi._eventId=0;class Rf extends Hi{constructor(t,e){super(t,e),this._currentId=-1,this._nextId=-1,this._nextTick=this.time,this._boundRestart=this._restart.bind(this);const s=Object.assign(Rf.getDefaults(),e);this.duration=s.duration,this._interval=s.interval,this._nextTick=s.time,this.transport.on("start",this._boundRestart),this.transport.on("loopStart",this._boundRestart),this.transport.on("ticks",this._boundRestart),this.context=this.transport.context,this._restart()}static getDefaults(){return Object.assign({},Hi.getDefaults(),{duration:1/0,interval:1,once:!1})}invoke(t){this._createEvents(t),super.invoke(t)}_createEvent(){return tc(this._nextTick,this.floatTime+this.duration)?this.transport.scheduleOnce(this.invoke.bind(this),new Jr(this.context,this._nextTick).toSeconds()):-1}_createEvents(t){tc(this._nextTick+this._interval,this.floatTime+this.duration)&&(this._nextTick+=this._interval,this._currentId=this._nextId,this._nextId=this.transport.scheduleOnce(this.invoke.bind(this),new Jr(this.context,this._nextTick).toSeconds()))}_restart(t){this.transport.clear(this._currentId),this.transport.clear(this._nextId),this._nextTick=this.floatTime;const e=this.transport.getTicksAtTime(t);_o(e,this.time)&&(this._nextTick=this.floatTime+Math.ceil((e-this.floatTime)/this._interval)*this._interval),this._currentId=this._createEvent(),this._nextTick+=this._interval,this._nextId=this._createEvent()}dispose(){return super.dispose(),this.transport.clear(this._currentId),this.transport.clear(this._nextId),this.transport.off("start",this._boundRestart),this.transport.off("loopStart",this._boundRestart),this.transport.off("ticks",this._boundRestart),this}}class jc extends un{constructor(){const t=ft(jc.getDefaults(),arguments);super(t),this.name="Transport",this._loop=new f_(!1),this._loopStart=0,this._loopEnd=0,this._scheduledEvents={},this._timeline=new On,this._repeatedEvents=new d_,this._syncedSignals=[],this._swingAmount=0,this._ppq=t.ppq,this._clock=new $c({callback:this._processTick.bind(this),context:this.context,frequency:0,units:"bpm"}),this._bindClockEvents(),this.bpm=this._clock.frequency,this._clock.frequency.multiplier=t.ppq,this.bpm.setValueAtTime(t.bpm,0),Pt(this,"bpm"),this._timeSignature=t.timeSignature,this._swingTicks=t.ppq/2}static getDefaults(){return Object.assign(un.getDefaults(),{bpm:120,loopEnd:"4m",loopStart:0,ppq:192,swing:0,swingSubdivision:"8n",timeSignature:4})}_processTick(t,e){if(this._loop.get(t)&&e>=this._loopEnd&&(this.emit("loopEnd",t),this._clock.setTicksAtTime(this._loopStart,t),e=this._loopStart,this.emit("loopStart",t,this._clock.getSecondsAtTime(t)),this.emit("loop",t)),this._swingAmount>0&&e%this._ppq!==0&&e%(this._swingTicks*2)!==0){const s=e%(this._swingTicks*2)/(this._swingTicks*2),i=Math.sin(s*Math.PI)*this._swingAmount;t+=new Jr(this.context,this._swingTicks*2/3).toSeconds()*i}um(!0),this._timeline.forEachAtTime(e,s=>s.invoke(t)),um(!1)}schedule(t,e){const s=new Hi(this,{callback:t,time:new mA(this.context,e).toTicks()});return this._addEvent(s,this._timeline)}scheduleRepeat(t,e,s,i=1/0){const r=new Rf(this,{callback:t,duration:new Nn(this.context,i).toTicks(),interval:new Nn(this.context,e).toTicks(),time:new mA(this.context,s).toTicks()});return this._addEvent(r,this._repeatedEvents)}scheduleOnce(t,e){const s=new Hi(this,{callback:t,once:!0,time:new mA(this.context,e).toTicks()});return this._addEvent(s,this._timeline)}clear(t){if(this._scheduledEvents.hasOwnProperty(t)){const e=this._scheduledEvents[t.toString()];e.timeline.remove(e.event),e.event.dispose(),delete this._scheduledEvents[t.toString()]}return this}_addEvent(t,e){return this._scheduledEvents[t.id.toString()]={event:t,timeline:e},e.add(t),t.id}cancel(t=0){const e=this.toTicks(t);return this._timeline.forEachFrom(e,s=>this.clear(s.id)),this._repeatedEvents.forEachFrom(e,s=>this.clear(s.id)),this}_bindClockEvents(){this._clock.on("start",(t,e)=>{e=new Jr(this.context,e).toSeconds(),this.emit("start",t,e)}),this._clock.on("stop",t=>{this.emit("stop",t)}),this._clock.on("pause",t=>{this.emit("pause",t)})}get state(){return this._clock.getStateAtTime(this.now())}start(t,e){this.context.resume();let s;return Ft(e)&&(s=this.toTicks(e)),this._clock.start(t,s),this}stop(t){return this._clock.stop(t),this}pause(t){return this._clock.pause(t),this}toggle(t){return t=this.toSeconds(t),this._clock.getStateAtTime(t)!=="started"?this.start(t):this.stop(t),this}get timeSignature(){return this._timeSignature}set timeSignature(t){En(t)&&(t=t[0]/t[1]*4),this._timeSignature=t}get loopStart(){return new Nn(this.context,this._loopStart,"i").toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t)}get loopEnd(){return new Nn(this.context,this._loopEnd,"i").toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t)}get loop(){return this._loop.get(this.now())}set loop(t){this._loop.set(t,this.now())}setLoopPoints(t,e){return this.loopStart=t,this.loopEnd=e,this}get swing(){return this._swingAmount}set swing(t){this._swingAmount=t}get swingSubdivision(){return new Jr(this.context,this._swingTicks).toNotation()}set swingSubdivision(t){this._swingTicks=this.toTicks(t)}get position(){const t=this.now(),e=this._clock.getTicksAtTime(t);return new Jr(this.context,e).toBarsBeatsSixteenths()}set position(t){const e=this.toTicks(t);this.ticks=e}get seconds(){return this._clock.seconds}set seconds(t){const e=this.now(),s=this._clock.frequency.timeToTicks(t,e);this.ticks=s}get progress(){if(this.loop){const t=this.now();return(this._clock.getTicksAtTime(t)-this._loopStart)/(this._loopEnd-this._loopStart)}else return 0}get ticks(){return this._clock.ticks}set ticks(t){if(this._clock.ticks!==t){const e=this.now();if(this.state==="started"){const s=this._clock.getTicksAtTime(e),i=this._clock.frequency.getDurationOfTicks(Math.ceil(s)-s,e),r=e+i;this.emit("stop",r),this._clock.setTicksAtTime(t,r),this.emit("start",r,this._clock.getSecondsAtTime(r))}else this.emit("ticks",e),this._clock.setTicksAtTime(t,e)}}getTicksAtTime(t){return this._clock.getTicksAtTime(t)}getSecondsAtTime(t){return this._clock.getSecondsAtTime(t)}get PPQ(){return this._clock.frequency.multiplier}set PPQ(t){this._clock.frequency.multiplier=t}nextSubdivision(t){if(t=this.toTicks(t),this.state!=="started")return 0;{const e=this.now(),s=this.getTicksAtTime(e),i=t-s%t;return this._clock.nextTickTime(i,e)}}syncSignal(t,e){const s=this.now();let i=this.bpm,r=1/(60/i.getValueAtTime(s)/this.PPQ),o=[];if(t.units==="time"){const a=.015625/r,l=new Tt(a),c=new kf(-1),u=new Tt(a);i.chain(l,c,u),i=u,r=1/r,o=[l,c,u]}e||(t.getValueAtTime(s)!==0?e=t.getValueAtTime(s)/r:e=0);const A=new Tt(e);return i.connect(A),A.connect(t._param),o.push(A),this._syncedSignals.push({initial:t.value,nodes:o,signal:t}),t.value=0,this}unsyncSignal(t){for(let e=this._syncedSignals.length-1;e>=0;e--){const s=this._syncedSignals[e];s.signal===t&&(s.nodes.forEach(i=>i.dispose()),s.signal.value=s.initial,this._syncedSignals.splice(e,1))}return this}dispose(){return super.dispose(),this._clock.dispose(),If(this,"bpm"),this._timeline.dispose(),this._repeatedEvents.dispose(),this}}_f.mixin(jc);Gc(n=>{n.transport=new jc({context:n})});Kc(n=>{n.transport.dispose()});class fn extends ht{constructor(t){super(t),this.input=void 0,this._state=new Qf("stopped"),this._synced=!1,this._scheduled=[],this._syncedStart=Lt,this._syncedStop=Lt,this._state.memory=100,this._state.increasing=!0,this._volume=this.output=new ci({context:this.context,mute:t.mute,volume:t.volume}),this.volume=this._volume.volume,Pt(this,"volume"),this.onstop=t.onstop}static getDefaults(){return Object.assign(ht.getDefaults(),{mute:!1,onstop:Lt,volume:0})}get state(){return this._synced?this.context.transport.state==="started"?this._state.getValueAtTime(this.context.transport.seconds):"stopped":this._state.getValueAtTime(this.now())}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}_clampToCurrentTime(t){return this._synced?t:Math.max(t,this.context.currentTime)}start(t,e,s){let i=Hn(t)&&this._synced?this.context.transport.seconds:this.toSeconds(t);if(i=this._clampToCurrentTime(i),!this._synced&&this._state.getValueAtTime(i)==="started")mt(_o(i,this._state.get(i).time),"Start time must be strictly greater than previous start time"),this._state.cancel(i),this._state.setStateAtTime("started",i),this.log("restart",i),this.restart(i,e,s);else if(this.log("start",i),this._state.setStateAtTime("started",i),this._synced){const r=this._state.get(i);r&&(r.offset=this.toSeconds(co(e,0)),r.duration=s?this.toSeconds(s):void 0);const o=this.context.transport.schedule(A=>{this._start(A,e,s)},i);this._scheduled.push(o),this.context.transport.state==="started"&&this.context.transport.getSecondsAtTime(this.immediate())>i&&this._syncedStart(this.now(),this.context.transport.seconds)}else Kw(this.context),this._start(i,e,s);return this}stop(t){let e=Hn(t)&&this._synced?this.context.transport.seconds:this.toSeconds(t);if(e=this._clampToCurrentTime(e),this._state.getValueAtTime(e)==="started"||Ft(this._state.getNextState("started",e))){if(this.log("stop",e),!this._synced)this._stop(e);else{const s=this.context.transport.schedule(this._stop.bind(this),e);this._scheduled.push(s)}this._state.cancel(e),this._state.setStateAtTime("stopped",e)}return this}restart(t,e,s){return t=this.toSeconds(t),this._state.getValueAtTime(t)==="started"&&(this._state.cancel(t),this._restart(t,e,s)),this}sync(){return this._synced||(this._synced=!0,this._syncedStart=(t,e)=>{if(_o(e,0)){const s=this._state.get(e);if(s&&s.state==="started"&&s.time!==e){const i=e-this.toSeconds(s.time);let r;s.duration&&(r=this.toSeconds(s.duration)-i),this._start(t,this.toSeconds(s.offset)+i,r)}}},this._syncedStop=t=>{const e=this.context.transport.getSecondsAtTime(Math.max(t-this.sampleTime,0));this._state.getValueAtTime(e)==="started"&&this._stop(t)},this.context.transport.on("start",this._syncedStart),this.context.transport.on("loopStart",this._syncedStart),this.context.transport.on("stop",this._syncedStop),this.context.transport.on("pause",this._syncedStop),this.context.transport.on("loopEnd",this._syncedStop)),this}unsync(){return this._synced&&(this.context.transport.off("stop",this._syncedStop),this.context.transport.off("pause",this._syncedStop),this.context.transport.off("loopEnd",this._syncedStop),this.context.transport.off("start",this._syncedStart),this.context.transport.off("loopStart",this._syncedStart)),this._synced=!1,this._scheduled.forEach(t=>this.context.transport.clear(t)),this._scheduled=[],this._state.cancel(0),this._stop(0),this}dispose(){return super.dispose(),this.onstop=Lt,this.unsync(),this._volume.dispose(),this._state.dispose(),this}}class Jc extends Io{constructor(){const t=ft(Jc.getDefaults(),arguments,["url","onload"]);super(t),this.name="ToneBufferSource",this._source=this.context.createBufferSource(),this._internalChannels=[this._source],this._sourceStarted=!1,this._sourceStopped=!1,ri(this._source,this._gainNode),this._source.onended=()=>this._stopSource(),this.playbackRate=new xt({context:this.context,param:this._source.playbackRate,units:"positive",value:t.playbackRate}),this.loop=t.loop,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this._buffer=new ee(t.url,t.onload,t.onerror),this._internalChannels.push(this._source)}static getDefaults(){return Object.assign(Io.getDefaults(),{url:new ee,loop:!1,loopEnd:0,loopStart:0,onload:Lt,onerror:Lt,playbackRate:1})}get fadeIn(){return this._fadeIn}set fadeIn(t){this._fadeIn=t}get fadeOut(){return this._fadeOut}set fadeOut(t){this._fadeOut=t}get curve(){return this._curve}set curve(t){this._curve=t}start(t,e,s,i=1){mt(this.buffer.loaded,"buffer is either not set or not loaded");const r=this.toSeconds(t);this._startGain(r,i),this.loop?e=co(e,this.loopStart):e=co(e,0);let o=Math.max(this.toSeconds(e),0);if(this.loop){const A=this.toSeconds(this.loopEnd)||this.buffer.duration,a=this.toSeconds(this.loopStart),l=A-a;Vd(o,A)&&(o=(o-a)%l+a),Yn(o,this.buffer.duration)&&(o=0)}if(this._source.buffer=this.buffer.get(),this._source.loopEnd=this.toSeconds(this.loopEnd)||this.buffer.duration,tc(o,this.buffer.duration)&&(this._sourceStarted=!0,this._source.start(r,o)),Ft(s)){let A=this.toSeconds(s);A=Math.max(A,0),this.stop(r+A)}return this}_stopSource(t){!this._sourceStopped&&this._sourceStarted&&(this._sourceStopped=!0,this._source.stop(this.toSeconds(t)),this._onended())}get loopStart(){return this._source.loopStart}set loopStart(t){this._source.loopStart=this.toSeconds(t)}get loopEnd(){return this._source.loopEnd}set loopEnd(t){this._source.loopEnd=this.toSeconds(t)}get buffer(){return this._buffer}set buffer(t){this._buffer.set(t)}get loop(){return this._source.loop}set loop(t){this._source.loop=t,this._sourceStarted&&this.cancelStop()}dispose(){return super.dispose(),this._source.onended=null,this._source.disconnect(),this._buffer.dispose(),this.playbackRate.dispose(),this}}function Tr(n,t){return we(this,void 0,void 0,function*(){const e=t/n.context.sampleRate,s=new Ff(1,e,n.context.sampleRate);return new n.constructor(Object.assign(n.get(),{frequency:2/e,detune:0,context:s})).toDestination().start(0),(yield s.render()).getChannelData(0)})}class Hf extends Io{constructor(){const t=ft(Hf.getDefaults(),arguments,["frequency","type"]);super(t),this.name="ToneOscillatorNode",this._oscillator=this.context.createOscillator(),this._internalChannels=[this._oscillator],ri(this._oscillator,this._gainNode),this.type=t.type,this.frequency=new xt({context:this.context,param:this._oscillator.frequency,units:"frequency",value:t.frequency}),this.detune=new xt({context:this.context,param:this._oscillator.detune,units:"cents",value:t.detune}),Pt(this,["frequency","detune"])}static getDefaults(){return Object.assign(Io.getDefaults(),{detune:0,frequency:440,type:"sine"})}start(t){const e=this.toSeconds(t);return this.log("start",e),this._startGain(e),this._oscillator.start(e),this}_stopSource(t){this._oscillator.stop(t)}setPeriodicWave(t){return this._oscillator.setPeriodicWave(t),this}get type(){return this._oscillator.type}set type(t){this._oscillator.type=t}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._oscillator.disconnect(),this.frequency.dispose(),this.detune.dispose(),this}}class Ae extends fn{constructor(){const t=ft(Ae.getDefaults(),arguments,["frequency","type"]);super(t),this.name="Oscillator",this._oscillator=null,this.frequency=new Kt({context:this.context,units:"frequency",value:t.frequency}),Pt(this,"frequency"),this.detune=new Kt({context:this.context,units:"cents",value:t.detune}),Pt(this,"detune"),this._partials=t.partials,this._partialCount=t.partialCount,this._type=t.type,t.partialCount&&t.type!=="custom"&&(this._type=this.baseType+t.partialCount.toString()),this.phase=t.phase}static getDefaults(){return Object.assign(fn.getDefaults(),{detune:0,frequency:440,partialCount:0,partials:[],phase:0,type:"sine"})}_start(t){const e=this.toSeconds(t),s=new Hf({context:this.context,onended:()=>this.onstop(this)});this._oscillator=s,this._wave?this._oscillator.setPeriodicWave(this._wave):this._oscillator.type=this._type,this._oscillator.connect(this.output),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.start(e)}_stop(t){const e=this.toSeconds(t);this._oscillator&&this._oscillator.stop(e)}_restart(t){const e=this.toSeconds(t);return this.log("restart",e),this._oscillator&&this._oscillator.cancelStop(),this._state.cancel(e),this}syncFrequency(){return this.context.transport.syncSignal(this.frequency),this}unsyncFrequency(){return this.context.transport.unsyncSignal(this.frequency),this}_getCachedPeriodicWave(){if(this._type==="custom")return Ae._periodicWaveCache.find(e=>e.phase===this._phase&&Jx(e.partials,this._partials));{const t=Ae._periodicWaveCache.find(e=>e.type===this._type&&e.phase===this._phase);return this._partialCount=t?t.partialCount:this._partialCount,t}}get type(){return this._type}set type(t){this._type=t;const e=["sine","square","sawtooth","triangle"].indexOf(t)!==-1;if(this._phase===0&&e)this._wave=void 0,this._partialCount=0,this._oscillator!==null&&(this._oscillator.type=t);else{const s=this._getCachedPeriodicWave();if(Ft(s)){const{partials:i,wave:r}=s;this._wave=r,this._partials=i,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave)}else{const[i,r]=this._getRealImaginary(t,this._phase),o=this.context.createPeriodicWave(i,r);this._wave=o,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave),Ae._periodicWaveCache.push({imag:r,partialCount:this._partialCount,partials:this._partials,phase:this._phase,real:i,type:this._type,wave:this._wave}),Ae._periodicWaveCache.length>100&&Ae._periodicWaveCache.shift()}}}get baseType(){return this._type.replace(this.partialCount.toString(),"")}set baseType(t){this.partialCount&&this._type!=="custom"&&t!=="custom"?this.type=t+this.partialCount:this.type=t}get partialCount(){return this._partialCount}set partialCount(t){ii(t,0);let e=this._type;const s=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(this._type);if(s&&(e=s[1]),this._type!=="custom")t===0?this.type=e:this.type=e+t.toString();else{const i=new Float32Array(t);this._partials.forEach((r,o)=>i[o]=r),this._partials=Array.from(i),this.type=this._type}}_getRealImaginary(t,e){let i=2048;const r=new Float32Array(i),o=new Float32Array(i);let A=1;if(t==="custom"){if(A=this._partials.length+1,this._partialCount=this._partials.length,i=A,this._partials.length===0)return[r,o]}else{const a=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(t);a?(A=parseInt(a[2],10)+1,this._partialCount=parseInt(a[2],10),t=a[1],A=Math.max(A,2),i=A):this._partialCount=0,this._partials=[]}for(let a=1;a<i;++a){const l=2/(a*Math.PI);let c;switch(t){case"sine":c=a<=A?1:0,this._partials[a-1]=c;break;case"square":c=a&1?2*l:0,this._partials[a-1]=c;break;case"sawtooth":c=l*(a&1?1:-1),this._partials[a-1]=c;break;case"triangle":a&1?c=2*(l*l)*(a-1>>1&1?-1:1):c=0,this._partials[a-1]=c;break;case"custom":c=this._partials[a-1];break;default:throw new TypeError("Oscillator: invalid type: "+t)}c!==0?(r[a]=-c*Math.sin(e*a),o[a]=c*Math.cos(e*a)):(r[a]=0,o[a]=0)}return[r,o]}_inverseFFT(t,e,s){let i=0;const r=t.length;for(let o=0;o<r;o++)i+=t[o]*Math.cos(o*s)+e[o]*Math.sin(o*s);return i}getInitialValue(){const[t,e]=this._getRealImaginary(this._type,0);let s=0;const i=Math.PI*2,r=32;for(let o=0;o<r;o++)s=Math.max(this._inverseFFT(t,e,o/r*i),s);return t_(-this._inverseFFT(t,e,this._phase)/s,-1,1)}get partials(){return this._partials.slice(0,this.partialCount)}set partials(t){this._partials=t,this._partialCount=this._partials.length,t.length&&(this.type="custom")}get phase(){return this._phase*(180/Math.PI)}set phase(t){this._phase=t*Math.PI/180,this.type=this._type}asArray(){return we(this,arguments,void 0,function*(t=1024){return Tr(this,t)})}dispose(){return super.dispose(),this._oscillator!==null&&this._oscillator.dispose(),this._wave=void 0,this.frequency.dispose(),this.detune.dispose(),this}}Ae._periodicWaveCache=[];class ov extends _s{constructor(){super(...arguments),this.name="AudioToGain",this._norm=new Wo({context:this.context,mapping:t=>(t+1)/2}),this.input=this._norm,this.output=this._norm}dispose(){return super.dispose(),this._norm.dispose(),this}}class br extends Kt{constructor(){const t=ft(br.getDefaults(),arguments,["value"]);super(t),this.name="Multiply",this.override=!1,this._mult=this.input=this.output=new Tt({context:this.context,minValue:t.minValue,maxValue:t.maxValue}),this.factor=this._param=this._mult.gain,this.factor.setValueAtTime(t.value,0)}static getDefaults(){return Object.assign(Kt.getDefaults(),{value:0})}dispose(){return super.dispose(),this._mult.dispose(),this}}class Zc extends fn{constructor(){const t=ft(Zc.getDefaults(),arguments,["frequency","type","modulationType"]);super(t),this.name="AMOscillator",this._modulationScale=new ov({context:this.context}),this._modulationNode=new Tt({context:this.context}),this._carrier=new Ae({context:this.context,detune:t.detune,frequency:t.frequency,onstop:()=>this.onstop(this),phase:t.phase,type:t.type}),this.frequency=this._carrier.frequency,this.detune=this._carrier.detune,this._modulator=new Ae({context:this.context,phase:t.phase,type:t.modulationType}),this.harmonicity=new br({context:this.context,units:"positive",value:t.harmonicity}),this.frequency.chain(this.harmonicity,this._modulator.frequency),this._modulator.chain(this._modulationScale,this._modulationNode.gain),this._carrier.chain(this._modulationNode,this.output),Pt(this,["frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(Ae.getDefaults(),{harmonicity:1,modulationType:"square"})}_start(t){this._modulator.start(t),this._carrier.start(t)}_stop(t){this._modulator.stop(t),this._carrier.stop(t)}_restart(t){this._modulator.restart(t),this._carrier.restart(t)}get type(){return this._carrier.type}set type(t){this._carrier.type=t}get baseType(){return this._carrier.baseType}set baseType(t){this._carrier.baseType=t}get partialCount(){return this._carrier.partialCount}set partialCount(t){this._carrier.partialCount=t}get modulationType(){return this._modulator.type}set modulationType(t){this._modulator.type=t}get phase(){return this._carrier.phase}set phase(t){this._carrier.phase=t,this._modulator.phase=t}get partials(){return this._carrier.partials}set partials(t){this._carrier.partials=t}asArray(){return we(this,arguments,void 0,function*(t=1024){return Tr(this,t)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this._modulationScale.dispose(),this}}class tu extends fn{constructor(){const t=ft(tu.getDefaults(),arguments,["frequency","type","modulationType"]);super(t),this.name="FMOscillator",this._modulationNode=new Tt({context:this.context,gain:0}),this._carrier=new Ae({context:this.context,detune:t.detune,frequency:0,onstop:()=>this.onstop(this),phase:t.phase,type:t.type}),this.detune=this._carrier.detune,this.frequency=new Kt({context:this.context,units:"frequency",value:t.frequency}),this._modulator=new Ae({context:this.context,phase:t.phase,type:t.modulationType}),this.harmonicity=new br({context:this.context,units:"positive",value:t.harmonicity}),this.modulationIndex=new br({context:this.context,units:"positive",value:t.modulationIndex}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.frequency.chain(this.modulationIndex,this._modulationNode),this._modulator.connect(this._modulationNode.gain),this._modulationNode.connect(this._carrier.frequency),this._carrier.connect(this.output),this.detune.connect(this._modulator.detune),Pt(this,["modulationIndex","frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(Ae.getDefaults(),{harmonicity:1,modulationIndex:2,modulationType:"square"})}_start(t){this._modulator.start(t),this._carrier.start(t)}_stop(t){this._modulator.stop(t),this._carrier.stop(t)}_restart(t){return this._modulator.restart(t),this._carrier.restart(t),this}get type(){return this._carrier.type}set type(t){this._carrier.type=t}get baseType(){return this._carrier.baseType}set baseType(t){this._carrier.baseType=t}get partialCount(){return this._carrier.partialCount}set partialCount(t){this._carrier.partialCount=t}get modulationType(){return this._modulator.type}set modulationType(t){this._modulator.type=t}get phase(){return this._carrier.phase}set phase(t){this._carrier.phase=t,this._modulator.phase=t}get partials(){return this._carrier.partials}set partials(t){this._carrier.partials=t}asArray(){return we(this,arguments,void 0,function*(t=1024){return Tr(this,t)})}dispose(){return super.dispose(),this.frequency.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this.modulationIndex.dispose(),this}}class Sa extends fn{constructor(){const t=ft(Sa.getDefaults(),arguments,["frequency","width"]);super(t),this.name="PulseOscillator",this._widthGate=new Tt({context:this.context,gain:0}),this._thresh=new Wo({context:this.context,mapping:e=>e<=0?-1:1}),this.width=new Kt({context:this.context,units:"audioRange",value:t.width}),this._triangle=new Ae({context:this.context,detune:t.detune,frequency:t.frequency,onstop:()=>this.onstop(this),phase:t.phase,type:"triangle"}),this.frequency=this._triangle.frequency,this.detune=this._triangle.detune,this._triangle.chain(this._thresh,this.output),this.width.chain(this._widthGate,this._thresh),Pt(this,["width","frequency","detune"])}static getDefaults(){return Object.assign(fn.getDefaults(),{detune:0,frequency:440,phase:0,type:"pulse",width:.2})}_start(t){t=this.toSeconds(t),this._triangle.start(t),this._widthGate.gain.setValueAtTime(1,t)}_stop(t){t=this.toSeconds(t),this._triangle.stop(t),this._widthGate.gain.cancelScheduledValues(t),this._widthGate.gain.setValueAtTime(0,t)}_restart(t){this._triangle.restart(t),this._widthGate.gain.cancelScheduledValues(t),this._widthGate.gain.setValueAtTime(1,t)}get phase(){return this._triangle.phase}set phase(t){this._triangle.phase=t}get type(){return"pulse"}get baseType(){return"pulse"}get partials(){return[]}get partialCount(){return 0}set carrierType(t){this._triangle.type=t}asArray(){return we(this,arguments,void 0,function*(t=1024){return Tr(this,t)})}dispose(){return super.dispose(),this._triangle.dispose(),this.width.dispose(),this._widthGate.dispose(),this._thresh.dispose(),this}}class eu extends fn{constructor(){const t=ft(eu.getDefaults(),arguments,["frequency","type","spread"]);super(t),this.name="FatOscillator",this._oscillators=[],this.frequency=new Kt({context:this.context,units:"frequency",value:t.frequency}),this.detune=new Kt({context:this.context,units:"cents",value:t.detune}),this._spread=t.spread,this._type=t.type,this._phase=t.phase,this._partials=t.partials,this._partialCount=t.partialCount,this.count=t.count,Pt(this,["frequency","detune"])}static getDefaults(){return Object.assign(Ae.getDefaults(),{count:3,spread:20,type:"sawtooth"})}_start(t){t=this.toSeconds(t),this._forEach(e=>e.start(t))}_stop(t){t=this.toSeconds(t),this._forEach(e=>e.stop(t))}_restart(t){this._forEach(e=>e.restart(t))}_forEach(t){for(let e=0;e<this._oscillators.length;e++)t(this._oscillators[e],e)}get type(){return this._type}set type(t){this._type=t,this._forEach(e=>e.type=t)}get spread(){return this._spread}set spread(t){if(this._spread=t,this._oscillators.length>1){const e=-t/2,s=t/(this._oscillators.length-1);this._forEach((i,r)=>i.detune.value=e+s*r)}}get count(){return this._oscillators.length}set count(t){if(ii(t,1),this._oscillators.length!==t){this._forEach(e=>e.dispose()),this._oscillators=[];for(let e=0;e<t;e++){const s=new Ae({context:this.context,volume:-6-t*1.1,type:this._type,phase:this._phase+e/t*360,partialCount:this._partialCount,onstop:e===0?()=>this.onstop(this):Lt});this.type==="custom"&&(s.partials=this._partials),this.frequency.connect(s.frequency),this.detune.connect(s.detune),s.detune.overridden=!1,s.connect(this.output),this._oscillators[e]=s}this.spread=this._spread,this.state==="started"&&this._forEach(e=>e.start())}}get phase(){return this._phase}set phase(t){this._phase=t,this._forEach((e,s)=>e.phase=this._phase+s/this.count*360)}get baseType(){return this._oscillators[0].baseType}set baseType(t){this._forEach(e=>e.baseType=t),this._type=this._oscillators[0].type}get partials(){return this._oscillators[0].partials}set partials(t){this._partials=t,this._partialCount=this._partials.length,t.length&&(this._type="custom",this._forEach(e=>e.partials=t))}get partialCount(){return this._oscillators[0].partialCount}set partialCount(t){this._partialCount=t,this._forEach(e=>e.partialCount=t),this._type=this._oscillators[0].type}asArray(){return we(this,arguments,void 0,function*(t=1024){return Tr(this,t)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this._forEach(t=>t.dispose()),this}}class nu extends fn{constructor(){const t=ft(nu.getDefaults(),arguments,["frequency","modulationFrequency"]);super(t),this.name="PWMOscillator",this.sourceType="pwm",this._scale=new br({context:this.context,value:2}),this._pulse=new Sa({context:this.context,frequency:t.modulationFrequency}),this._pulse.carrierType="sine",this.modulationFrequency=this._pulse.frequency,this._modulator=new Ae({context:this.context,detune:t.detune,frequency:t.frequency,onstop:()=>this.onstop(this),phase:t.phase}),this.frequency=this._modulator.frequency,this.detune=this._modulator.detune,this._modulator.chain(this._scale,this._pulse.width),this._pulse.connect(this.output),Pt(this,["modulationFrequency","frequency","detune"])}static getDefaults(){return Object.assign(fn.getDefaults(),{detune:0,frequency:440,modulationFrequency:.4,phase:0,type:"pwm"})}_start(t){t=this.toSeconds(t),this._modulator.start(t),this._pulse.start(t)}_stop(t){t=this.toSeconds(t),this._modulator.stop(t),this._pulse.stop(t)}_restart(t){this._modulator.restart(t),this._pulse.restart(t)}get type(){return"pwm"}get baseType(){return"pwm"}get partials(){return[]}get partialCount(){return 0}get phase(){return this._modulator.phase}set phase(t){this._modulator.phase=t}asArray(){return we(this,arguments,void 0,function*(t=1024){return Tr(this,t)})}dispose(){return super.dispose(),this._pulse.dispose(),this._scale.dispose(),this._modulator.dispose(),this}}const dm={am:Zc,fat:eu,fm:tu,oscillator:Ae,pulse:Sa,pwm:nu};class nc extends fn{constructor(){const t=ft(nc.getDefaults(),arguments,["frequency","type"]);super(t),this.name="OmniOscillator",this.frequency=new Kt({context:this.context,units:"frequency",value:t.frequency}),this.detune=new Kt({context:this.context,units:"cents",value:t.detune}),Pt(this,["frequency","detune"]),this.set(t)}static getDefaults(){return Object.assign(Ae.getDefaults(),tu.getDefaults(),Zc.getDefaults(),eu.getDefaults(),Sa.getDefaults(),nu.getDefaults())}_start(t){this._oscillator.start(t)}_stop(t){this._oscillator.stop(t)}_restart(t){return this._oscillator.restart(t),this}get type(){let t="";return["am","fm","fat"].some(e=>this._sourceType===e)&&(t=this._sourceType),t+this._oscillator.type}set type(t){t.substr(0,2)==="fm"?(this._createNewOscillator("fm"),this._oscillator=this._oscillator,this._oscillator.type=t.substr(2)):t.substr(0,2)==="am"?(this._createNewOscillator("am"),this._oscillator=this._oscillator,this._oscillator.type=t.substr(2)):t.substr(0,3)==="fat"?(this._createNewOscillator("fat"),this._oscillator=this._oscillator,this._oscillator.type=t.substr(3)):t==="pwm"?(this._createNewOscillator("pwm"),this._oscillator=this._oscillator):t==="pulse"?this._createNewOscillator("pulse"):(this._createNewOscillator("oscillator"),this._oscillator=this._oscillator,this._oscillator.type=t)}get partials(){return this._oscillator.partials}set partials(t){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&(this._oscillator.partials=t)}get partialCount(){return this._oscillator.partialCount}set partialCount(t){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&(this._oscillator.partialCount=t)}set(t){return Reflect.has(t,"type")&&t.type&&(this.type=t.type),super.set(t),this}_createNewOscillator(t){if(t!==this._sourceType){this._sourceType=t;const e=dm[t],s=this.now();if(this._oscillator){const i=this._oscillator;i.stop(s),this.context.setTimeout(()=>i.dispose(),this.blockTime)}this._oscillator=new e({context:this.context}),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.connect(this.output),this._oscillator.onstop=()=>this.onstop(this),this.state==="started"&&this._oscillator.start(s)}}get phase(){return this._oscillator.phase}set phase(t){this._oscillator.phase=t}get sourceType(){return this._sourceType}set sourceType(t){let e="sine";this._oscillator.type!=="pwm"&&this._oscillator.type!=="pulse"&&(e=this._oscillator.type),t==="fm"?this.type="fm"+e:t==="am"?this.type="am"+e:t==="fat"?this.type="fat"+e:t==="oscillator"?this.type=e:t==="pulse"?this.type="pulse":t==="pwm"&&(this.type="pwm")}_getOscType(t,e){return t instanceof dm[e]}get baseType(){return this._oscillator.baseType}set baseType(t){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&t!=="pulse"&&t!=="pwm"&&(this._oscillator.baseType=t)}get width(){if(this._getOscType(this._oscillator,"pulse"))return this._oscillator.width}get count(){if(this._getOscType(this._oscillator,"fat"))return this._oscillator.count}set count(t){this._getOscType(this._oscillator,"fat")&&ni(t)&&(this._oscillator.count=t)}get spread(){if(this._getOscType(this._oscillator,"fat"))return this._oscillator.spread}set spread(t){this._getOscType(this._oscillator,"fat")&&ni(t)&&(this._oscillator.spread=t)}get modulationType(){if(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))return this._oscillator.modulationType}set modulationType(t){(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))&&si(t)&&(this._oscillator.modulationType=t)}get modulationIndex(){if(this._getOscType(this._oscillator,"fm"))return this._oscillator.modulationIndex}get harmonicity(){if(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))return this._oscillator.harmonicity}get modulationFrequency(){if(this._getOscType(this._oscillator,"pwm"))return this._oscillator.modulationFrequency}asArray(){return we(this,arguments,void 0,function*(t=1024){return Tr(this,t)})}dispose(){return super.dispose(),this.detune.dispose(),this.frequency.dispose(),this._oscillator.dispose(),this}}class Of extends Kt{constructor(){super(ft(Of.getDefaults(),arguments,["value"])),this.override=!1,this.name="Add",this._sum=new Tt({context:this.context}),this.input=this._sum,this.output=this._sum,this.addend=this._param,OA(this._constantSource,this._sum)}static getDefaults(){return Object.assign(Kt.getDefaults(),{value:0})}dispose(){return super.dispose(),this._sum.dispose(),this}}class WA extends _s{constructor(){const t=ft(WA.getDefaults(),arguments,["min","max"]);super(t),this.name="Scale",this._mult=this.input=new br({context:this.context,value:t.max-t.min}),this._add=this.output=new Of({context:this.context,value:t.min}),this._min=t.min,this._max=t.max,this.input.connect(this.output)}static getDefaults(){return Object.assign(_s.getDefaults(),{max:1,min:0})}get min(){return this._min}set min(t){this._min=t,this._setRange()}get max(){return this._max}set max(t){this._max=t,this._setRange()}_setRange(){this._add.value=this._min,this._mult.value=this._max-this._min}dispose(){return super.dispose(),this._add.dispose(),this._mult.dispose(),this}}class Vf extends _s{constructor(){super(ft(Vf.getDefaults(),arguments)),this.name="Zero",this._gain=new Tt({context:this.context}),this.output=this._gain,this.input=void 0,ri(this.context.getConstant(0),this._gain)}dispose(){return super.dispose(),rv(this.context.getConstant(0),this._gain),this}}class sc extends ht{constructor(){const t=ft(sc.getDefaults(),arguments,["frequency","min","max"]);super(t),this.name="LFO",this._stoppedValue=0,this._units="number",this.convert=!0,this._fromType=xt.prototype._fromType,this._toType=xt.prototype._toType,this._is=xt.prototype._is,this._clampValue=xt.prototype._clampValue,this._oscillator=new Ae(t),this.frequency=this._oscillator.frequency,this._amplitudeGain=new Tt({context:this.context,gain:t.amplitude,units:"normalRange"}),this.amplitude=this._amplitudeGain.gain,this._stoppedSignal=new Kt({context:this.context,units:"audioRange",value:0}),this._zeros=new Vf({context:this.context}),this._a2g=new ov({context:this.context}),this._scaler=this.output=new WA({context:this.context,max:t.max,min:t.min}),this.units=t.units,this.min=t.min,this.max=t.max,this._oscillator.chain(this._amplitudeGain,this._a2g,this._scaler),this._zeros.connect(this._a2g),this._stoppedSignal.connect(this._a2g),Pt(this,["amplitude","frequency"]),this.phase=t.phase}static getDefaults(){return Object.assign(Ae.getDefaults(),{amplitude:1,frequency:"4n",max:1,min:0,type:"sine",units:"number"})}start(t){return t=this.toSeconds(t),this._stoppedSignal.setValueAtTime(0,t),this._oscillator.start(t),this}stop(t){return t=this.toSeconds(t),this._stoppedSignal.setValueAtTime(this._stoppedValue,t),this._oscillator.stop(t),this}sync(){return this._oscillator.sync(),this._oscillator.syncFrequency(),this}unsync(){return this._oscillator.unsync(),this._oscillator.unsyncFrequency(),this}_setStoppedValue(){this._stoppedValue=this._oscillator.getInitialValue(),this._stoppedSignal.value=this._stoppedValue}get min(){return this._toType(this._scaler.min)}set min(t){t=this._fromType(t),this._scaler.min=t}get max(){return this._toType(this._scaler.max)}set max(t){t=this._fromType(t),this._scaler.max=t}get type(){return this._oscillator.type}set type(t){this._oscillator.type=t,this._setStoppedValue()}get partials(){return this._oscillator.partials}set partials(t){this._oscillator.partials=t,this._setStoppedValue()}get phase(){return this._oscillator.phase}set phase(t){this._oscillator.phase=t,this._setStoppedValue()}get units(){return this._units}set units(t){const e=this.min,s=this.max;this._units=t,this.min=e,this.max=s}get state(){return this._oscillator.state}connect(t,e,s){return(t instanceof xt||t instanceof Kt)&&(this.convert=t.convert,this.units=t.units),Xc(this,t,e,s),this}dispose(){return super.dispose(),this._oscillator.dispose(),this._stoppedSignal.dispose(),this._zeros.dispose(),this._scaler.dispose(),this._a2g.dispose(),this._amplitudeGain.dispose(),this.amplitude.dispose(),this}}function Av(n,t=1/0){const e=new WeakMap;return function(s,i){Reflect.defineProperty(s,i,{configurable:!0,enumerable:!0,get:function(){return e.get(this)},set:function(r){ii(r,n,t),e.set(this,r)}})}}function ui(n,t=1/0){const e=new WeakMap;return function(s,i){Reflect.defineProperty(s,i,{configurable:!0,enumerable:!0,get:function(){return e.get(this)},set:function(r){ii(this.toSeconds(r),n,t),e.set(this,r)}})}}class Ea extends fn{constructor(){const t=ft(Ea.getDefaults(),arguments,["url","onload"]);super(t),this.name="Player",this._activeSources=new Set,this._buffer=new ee({onload:this._onload.bind(this,t.onload),onerror:t.onerror,reverse:t.reverse,url:t.url}),this.autostart=t.autostart,this._loop=t.loop,this._loopStart=t.loopStart,this._loopEnd=t.loopEnd,this._playbackRate=t.playbackRate,this.fadeIn=t.fadeIn,this.fadeOut=t.fadeOut}static getDefaults(){return Object.assign(fn.getDefaults(),{autostart:!1,fadeIn:0,fadeOut:0,loop:!1,loopEnd:0,loopStart:0,onload:Lt,onerror:Lt,playbackRate:1,reverse:!1})}load(t){return we(this,void 0,void 0,function*(){return yield this._buffer.load(t),this._onload(),this})}_onload(t=Lt){t(),this.autostart&&this.start()}_onSourceEnd(t){this.onstop(this),this._activeSources.delete(t),this._activeSources.size===0&&!this._synced&&this._state.getValueAtTime(this.now())==="started"&&(this._state.cancel(this.now()),this._state.setStateAtTime("stopped",this.now()))}start(t,e,s){return super.start(t,e,s),this}_start(t,e,s){this._loop?e=co(e,this._loopStart):e=co(e,0);const i=this.toSeconds(e),r=s;s=co(s,Math.max(this._buffer.duration-i,0));let o=this.toSeconds(s);o=o/this._playbackRate,t=this.toSeconds(t);const A=new Jc({url:this._buffer,context:this.context,fadeIn:this.fadeIn,fadeOut:this.fadeOut,loop:this._loop,loopEnd:this._loopEnd,loopStart:this._loopStart,onended:this._onSourceEnd.bind(this),playbackRate:this._playbackRate}).connect(this.output);!this._loop&&!this._synced&&(this._state.cancel(t+o),this._state.setStateAtTime("stopped",t+o,{implicitEnd:!0})),this._activeSources.add(A),this._loop&&Hn(r)?A.start(t,i):A.start(t,i,o-this.toSeconds(this.fadeOut))}_stop(t){const e=this.toSeconds(t);this._activeSources.forEach(s=>s.stop(e))}restart(t,e,s){return super.restart(t,e,s),this}_restart(t,e,s){var i;(i=[...this._activeSources].pop())===null||i===void 0||i.stop(t),this._start(t,e,s)}seek(t,e){const s=this.toSeconds(e);if(this._state.getValueAtTime(s)==="started"){const i=this.toSeconds(t);this._stop(s),this._start(s,i)}return this}setLoopPoints(t,e){return this.loopStart=t,this.loopEnd=e,this}get loopStart(){return this._loopStart}set loopStart(t){this._loopStart=t,this.buffer.loaded&&ii(this.toSeconds(t),0,this.buffer.duration),this._activeSources.forEach(e=>{e.loopStart=t})}get loopEnd(){return this._loopEnd}set loopEnd(t){this._loopEnd=t,this.buffer.loaded&&ii(this.toSeconds(t),0,this.buffer.duration),this._activeSources.forEach(e=>{e.loopEnd=t})}get buffer(){return this._buffer}set buffer(t){this._buffer.set(t)}get loop(){return this._loop}set loop(t){if(this._loop!==t&&(this._loop=t,this._activeSources.forEach(e=>{e.loop=t}),t)){const e=this._state.getNextState("stopped",this.now());e&&this._state.cancel(e.time)}}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t;const e=this.now(),s=this._state.getNextState("stopped",e);s&&s.implicitEnd&&(this._state.cancel(s.time),this._activeSources.forEach(i=>i.cancelStop())),this._activeSources.forEach(i=>{i.playbackRate.setValueAtTime(t,e)})}get reverse(){return this._buffer.reverse}set reverse(t){this._buffer.reverse=t}get loaded(){return this._buffer.loaded}dispose(){return super.dispose(),this._activeSources.forEach(t=>t.dispose()),this._activeSources.clear(),this._buffer.dispose(),this}}os([ui(0)],Ea.prototype,"fadeIn",void 0);os([ui(0)],Ea.prototype,"fadeOut",void 0);class su extends ht{constructor(){const t=ft(su.getDefaults(),arguments,["urls","onload"],"urls");super(t),this.name="Players",this.input=void 0,this._players=new Map,this._volume=this.output=new ci({context:this.context,volume:t.volume}),this.volume=this._volume.volume,Pt(this,"volume"),this._buffers=new Yc({urls:t.urls,onload:t.onload,baseUrl:t.baseUrl,onerror:t.onerror}),this.mute=t.mute,this._fadeIn=t.fadeIn,this._fadeOut=t.fadeOut}static getDefaults(){return Object.assign(fn.getDefaults(),{baseUrl:"",fadeIn:0,fadeOut:0,mute:!1,onload:Lt,onerror:Lt,urls:{},volume:0})}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}get fadeIn(){return this._fadeIn}set fadeIn(t){this._fadeIn=t,this._players.forEach(e=>{e.fadeIn=t})}get fadeOut(){return this._fadeOut}set fadeOut(t){this._fadeOut=t,this._players.forEach(e=>{e.fadeOut=t})}get state(){return Array.from(this._players).some(([e,s])=>s.state==="started")?"started":"stopped"}has(t){return this._buffers.has(t)}player(t){if(mt(this.has(t),`No Player with the name ${t} exists on this object`),!this._players.has(t)){const e=new Ea({context:this.context,fadeIn:this._fadeIn,fadeOut:this._fadeOut,url:this._buffers.get(t)}).connect(this.output);this._players.set(t,e)}return this._players.get(t)}get loaded(){return this._buffers.loaded}add(t,e,s){return mt(!this._buffers.has(t),"A buffer with that name already exists on this object"),this._buffers.add(t,e,s),this}stopAll(t){return this._players.forEach(e=>e.stop(t)),this}dispose(){return super.dispose(),this._volume.dispose(),this.volume.dispose(),this._players.forEach(t=>t.dispose()),this._buffers.dispose(),this}}class p_ extends _s{constructor(){super(...arguments),this.name="GainToAudio",this._norm=new Wo({context:this.context,mapping:t=>Math.abs(t)*2-1}),this.input=this._norm,this.output=this._norm}dispose(){return super.dispose(),this._norm.dispose(),this}}class qi extends ht{constructor(){const t=ft(qi.getDefaults(),arguments,["attack","decay","sustain","release"]);super(t),this.name="Envelope",this._sig=new Kt({context:this.context,value:0}),this.output=this._sig,this.input=void 0,this.attack=t.attack,this.decay=t.decay,this.sustain=t.sustain,this.release=t.release,this.attackCurve=t.attackCurve,this.releaseCurve=t.releaseCurve,this.decayCurve=t.decayCurve}static getDefaults(){return Object.assign(ht.getDefaults(),{attack:.01,attackCurve:"linear",decay:.1,decayCurve:"exponential",release:1,releaseCurve:"exponential",sustain:.5})}get value(){return this.getValueAtTime(this.now())}_getCurve(t,e){if(si(t))return t;{let s;for(s in Da)if(Da[s][e]===t)return s;return t}}_setCurve(t,e,s){if(si(s)&&Reflect.has(Da,s)){const i=Da[s];fr(i)?t!=="_decayCurve"&&(this[t]=i[e]):this[t]=i}else if(En(s)&&t!=="_decayCurve")this[t]=s;else throw new Error("Envelope: invalid curve: "+s)}get attackCurve(){return this._getCurve(this._attackCurve,"In")}set attackCurve(t){this._setCurve("_attackCurve","In",t)}get releaseCurve(){return this._getCurve(this._releaseCurve,"Out")}set releaseCurve(t){this._setCurve("_releaseCurve","Out",t)}get decayCurve(){return this._getCurve(this._decayCurve,"Out")}set decayCurve(t){this._setCurve("_decayCurve","Out",t)}triggerAttack(t,e=1){this.log("triggerAttack",t,e),t=this.toSeconds(t);let i=this.toSeconds(this.attack);const r=this.toSeconds(this.decay),o=this.getValueAtTime(t);if(o>0){const A=1/i;i=(1-o)/A}if(i<this.sampleTime)this._sig.cancelScheduledValues(t),this._sig.setValueAtTime(e,t);else if(this._attackCurve==="linear")this._sig.linearRampTo(e,i,t);else if(this._attackCurve==="exponential")this._sig.targetRampTo(e,i,t);else{this._sig.cancelAndHoldAtTime(t);let A=this._attackCurve;for(let a=1;a<A.length;a++)if(A[a-1]<=o&&o<=A[a]){A=this._attackCurve.slice(a),A[0]=o;break}this._sig.setValueCurveAtTime(A,t,i,e)}if(r&&this.sustain<1){const A=e*this.sustain,a=t+i;this.log("decay",a),this._decayCurve==="linear"?this._sig.linearRampToValueAtTime(A,r+a):this._sig.exponentialApproachValueAtTime(A,a,r)}return this}triggerRelease(t){this.log("triggerRelease",t),t=this.toSeconds(t);const e=this.getValueAtTime(t);if(e>0){const s=this.toSeconds(this.release);s<this.sampleTime?this._sig.setValueAtTime(0,t):this._releaseCurve==="linear"?this._sig.linearRampTo(0,s,t):this._releaseCurve==="exponential"?this._sig.targetRampTo(0,s,t):(mt(En(this._releaseCurve),"releaseCurve must be either 'linear', 'exponential' or an array"),this._sig.cancelAndHoldAtTime(t),this._sig.setValueCurveAtTime(this._releaseCurve,t,s,e))}return this}getValueAtTime(t){return this._sig.getValueAtTime(t)}triggerAttackRelease(t,e,s=1){return e=this.toSeconds(e),this.triggerAttack(e,s),this.triggerRelease(e+this.toSeconds(t)),this}cancel(t){return this._sig.cancelScheduledValues(this.toSeconds(t)),this}connect(t,e=0,s=0){return Xc(this,t,e,s),this}asArray(){return we(this,arguments,void 0,function*(t=1024){const e=t/this.context.sampleRate,s=new Ff(1,e,this.context.sampleRate),i=this.toSeconds(this.attack)+this.toSeconds(this.decay),r=i+this.toSeconds(this.release),o=r*.1,A=r+o,a=new this.constructor(Object.assign(this.get(),{attack:e*this.toSeconds(this.attack)/A,decay:e*this.toSeconds(this.decay)/A,release:e*this.toSeconds(this.release)/A,context:s}));return a._sig.toDestination(),a.triggerAttackRelease(e*(i+o)/A,0),(yield s.render()).getChannelData(0)})}dispose(){return super.dispose(),this._sig.dispose(),this}}os([ui(0)],qi.prototype,"attack",void 0);os([ui(0)],qi.prototype,"decay",void 0);os([Av(0,1)],qi.prototype,"sustain",void 0);os([ui(0)],qi.prototype,"release",void 0);const Da=(()=>{let t,e;const s=[];for(t=0;t<128;t++)s[t]=Math.sin(t/127*(Math.PI/2));const i=[],r=6.4;for(t=0;t<127;t++){e=t/127;const d=Math.sin(e*(Math.PI*2)*r-Math.PI/2)+1;i[t]=d/10+e*.83}i[127]=1;const o=[],A=5;for(t=0;t<128;t++)o[t]=Math.ceil(t/127*A)/A;const a=[];for(t=0;t<128;t++)e=t/127,a[t]=.5*(1-Math.cos(Math.PI*e));const l=[];for(t=0;t<128;t++){e=t/127;const d=Math.pow(e,3)*4+.2,p=Math.cos(d*Math.PI*2*e);l[t]=Math.abs(p*(1-e))}function c(d){const p=new Array(d.length);for(let f=0;f<d.length;f++)p[f]=1-d[f];return p}function u(d){return d.slice(0).reverse()}return{bounce:{In:c(l),Out:l},cosine:{In:s,Out:u(s)},exponential:"exponential",linear:"linear",ripple:{In:i,Out:c(i)},sine:{In:a,Out:c(a)},step:{In:o,Out:c(o)}}})();class Oi extends ht{constructor(){const t=ft(Oi.getDefaults(),arguments);super(t),this._scheduledEvents=[],this._synced=!1,this._original_triggerAttack=this.triggerAttack,this._original_triggerRelease=this.triggerRelease,this._syncedRelease=e=>this._original_triggerRelease(e),this._volume=this.output=new ci({context:this.context,volume:t.volume}),this.volume=this._volume.volume,Pt(this,"volume")}static getDefaults(){return Object.assign(ht.getDefaults(),{volume:0})}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",0),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}_syncState(){let t=!1;return this._synced||(this._synced=!0,t=!0),t}_syncMethod(t,e){const s=this["_original_"+t]=this[t];this[t]=(...i)=>{const r=i[e],o=this.context.transport.schedule(A=>{i[e]=A,s.apply(this,i)},r);this._scheduledEvents.push(o)}}unsync(){return this._scheduledEvents.forEach(t=>this.context.transport.clear(t)),this._scheduledEvents=[],this._synced&&(this._synced=!1,this.triggerAttack=this._original_triggerAttack,this.triggerRelease=this._original_triggerRelease,this.context.transport.off("stop",this._syncedRelease),this.context.transport.off("pause",this._syncedRelease),this.context.transport.off("loopEnd",this._syncedRelease)),this}triggerAttackRelease(t,e,s,i){const r=this.toSeconds(s),o=this.toSeconds(e);return this.triggerAttack(t,r,i),this.triggerRelease(r+o),this}dispose(){return super.dispose(),this._volume.dispose(),this.unsync(),this._scheduledEvents=[],this}}class yr extends Oi{constructor(){const t=ft(yr.getDefaults(),arguments);super(t),this.portamento=t.portamento,this.onsilence=t.onsilence}static getDefaults(){return Object.assign(Oi.getDefaults(),{detune:0,onsilence:Lt,portamento:0})}triggerAttack(t,e,s=1){this.log("triggerAttack",t,e,s);const i=this.toSeconds(e);return this._triggerEnvelopeAttack(i,s),this.setNote(t,i),this}triggerRelease(t){this.log("triggerRelease",t);const e=this.toSeconds(t);return this._triggerEnvelopeRelease(e),this}setNote(t,e){const s=this.toSeconds(e),i=t instanceof yn?t.toFrequency():t;if(this.portamento>0&&this.getLevelAtTime(s)>.05){const r=this.toSeconds(this.portamento);this.frequency.exponentialRampTo(i,r,s)}else this.frequency.setValueAtTime(i,s);return this}}os([ui(0)],yr.prototype,"portamento",void 0);class Wf extends qi{constructor(){super(ft(Wf.getDefaults(),arguments,["attack","decay","sustain","release"])),this.name="AmplitudeEnvelope",this._gainNode=new Tt({context:this.context,gain:0}),this.output=this._gainNode,this.input=this._gainNode,this._sig.connect(this._gainNode.gain),this.output=this._gainNode,this.input=this._gainNode}dispose(){return super.dispose(),this._gainNode.dispose(),this}}class Fo extends yr{constructor(){const t=ft(Fo.getDefaults(),arguments);super(t),this.name="Synth",this.oscillator=new nc(Object.assign({context:this.context,detune:t.detune,onstop:()=>this.onsilence(this)},t.oscillator)),this.frequency=this.oscillator.frequency,this.detune=this.oscillator.detune,this.envelope=new Wf(Object.assign({context:this.context},t.envelope)),this.oscillator.chain(this.envelope,this.output),Pt(this,["oscillator","frequency","detune","envelope"])}static getDefaults(){return Object.assign(yr.getDefaults(),{envelope:Object.assign(Od(qi.getDefaults(),Object.keys(ht.getDefaults())),{attack:.005,decay:.1,release:1,sustain:.3}),oscillator:Object.assign(Od(nc.getDefaults(),[...Object.keys(fn.getDefaults()),"frequency","detune"]),{type:"triangle"})})}_triggerEnvelopeAttack(t,e){if(this.envelope.triggerAttack(t,e),this.oscillator.start(t),this.envelope.sustain===0){const s=this.toSeconds(this.envelope.attack),i=this.toSeconds(this.envelope.decay);this.oscillator.stop(t+s+i)}}_triggerEnvelopeRelease(t){this.envelope.triggerRelease(t),this.oscillator.stop(t+this.toSeconds(this.envelope.release))}getLevelAtTime(t){return t=this.toSeconds(t),this.envelope.getValueAtTime(t)}dispose(){return super.dispose(),this.oscillator.dispose(),this.envelope.dispose(),this}}class ic extends ht{constructor(){const t=ft(ic.getDefaults(),arguments,["frequency","type"]);super(t),this.name="BiquadFilter",this._filter=this.context.createBiquadFilter(),this.input=this.output=this._filter,this.Q=new xt({context:this.context,units:"number",value:t.Q,param:this._filter.Q}),this.frequency=new xt({context:this.context,units:"frequency",value:t.frequency,param:this._filter.frequency}),this.detune=new xt({context:this.context,units:"cents",value:t.detune,param:this._filter.detune}),this.gain=new xt({context:this.context,units:"decibels",convert:!1,value:t.gain,param:this._filter.gain}),this.type=t.type}static getDefaults(){return Object.assign(ht.getDefaults(),{Q:1,type:"lowpass",frequency:350,detune:0,gain:0})}get type(){return this._filter.type}set type(t){mt(["lowpass","highpass","bandpass","lowshelf","highshelf","notch","allpass","peaking"].indexOf(t)!==-1,`Invalid filter type: ${t}`),this._filter.type=t}getFrequencyResponse(t=128){const e=new Float32Array(t);for(let o=0;o<t;o++){const a=Math.pow(o/t,2)*19980+20;e[o]=a}const s=new Float32Array(t),i=new Float32Array(t),r=this.context.createBiquadFilter();return r.type=this.type,r.Q.value=this.Q.value,r.frequency.value=this.frequency.value,r.gain.value=this.gain.value,r.getFrequencyResponse(e,s,i),s}dispose(){return super.dispose(),this._filter.disconnect(),this.Q.dispose(),this.frequency.dispose(),this.gain.dispose(),this.detune.dispose(),this}}class gA extends ht{constructor(){const t=ft(gA.getDefaults(),arguments,["frequency","type","rolloff"]);super(t),this.name="Filter",this.input=new Tt({context:this.context}),this.output=new Tt({context:this.context}),this._filters=[],this._filters=[],this.Q=new Kt({context:this.context,units:"positive",value:t.Q}),this.frequency=new Kt({context:this.context,units:"frequency",value:t.frequency}),this.detune=new Kt({context:this.context,units:"cents",value:t.detune}),this.gain=new Kt({context:this.context,units:"decibels",convert:!1,value:t.gain}),this._type=t.type,this.rolloff=t.rolloff,Pt(this,["detune","frequency","gain","Q"])}static getDefaults(){return Object.assign(ht.getDefaults(),{Q:1,detune:0,frequency:350,gain:0,rolloff:-12,type:"lowpass"})}get type(){return this._type}set type(t){mt(["lowpass","highpass","bandpass","lowshelf","highshelf","notch","allpass","peaking"].indexOf(t)!==-1,`Invalid filter type: ${t}`),this._type=t,this._filters.forEach(s=>s.type=t)}get rolloff(){return this._rolloff}set rolloff(t){const e=ni(t)?t:parseInt(t,10),s=[-12,-24,-48,-96];let i=s.indexOf(e);mt(i!==-1,`rolloff can only be ${s.join(", ")}`),i+=1,this._rolloff=e,this.input.disconnect(),this._filters.forEach(r=>r.disconnect()),this._filters=new Array(i);for(let r=0;r<i;r++){const o=new ic({context:this.context});o.type=this._type,this.frequency.connect(o.frequency),this.detune.connect(o.detune),this.Q.connect(o.Q),this.gain.connect(o.gain),this._filters[r]=o}this._internalChannels=this._filters,OA(this.input,...this._internalChannels,this.output)}getFrequencyResponse(t=128){const e=new ic({context:this.context,frequency:this.frequency.value,gain:this.gain.value,Q:this.Q.value,type:this._type,detune:this.detune.value}),s=new Float32Array(t).map(()=>1);return this._filters.forEach(()=>{e.getFrequencyResponse(t).forEach((r,o)=>s[o]*=r)}),e.dispose(),s}dispose(){return super.dispose(),this._filters.forEach(t=>{t.dispose()}),If(this,["detune","frequency","gain","Q"]),this.frequency.dispose(),this.Q.dispose(),this.detune.dispose(),this.gain.dispose(),this}}class iu extends Fo{constructor(){const t=ft(iu.getDefaults(),arguments);super(t),this.name="MembraneSynth",this.portamento=0,this.pitchDecay=t.pitchDecay,this.octaves=t.octaves,Pt(this,["oscillator","envelope"])}static getDefaults(){return pr(yr.getDefaults(),Fo.getDefaults(),{envelope:{attack:.001,attackCurve:"exponential",decay:.4,release:1.4,sustain:.01},octaves:10,oscillator:{type:"sine"},pitchDecay:.05})}setNote(t,e){const s=this.toSeconds(e),i=this.toFrequency(t instanceof yn?t.toFrequency():t),r=i*this.octaves;return this.oscillator.frequency.setValueAtTime(r,s),this.oscillator.frequency.exponentialRampToValueAtTime(i,s+this.toSeconds(this.pitchDecay)),this}dispose(){return super.dispose(),this}}os([Av(0)],iu.prototype,"octaves",void 0);os([ui(0)],iu.prototype,"pitchDecay",void 0);const av=new Set;function Gf(n){av.add(n)}function lv(n,t){const e=`registerProcessor("${n}", ${t})`;av.add(e)}const m_=`
	/**
	 * The base AudioWorkletProcessor for use in Tone.js. Works with the {@link ToneAudioWorklet}. 
	 */
	class ToneAudioWorkletProcessor extends AudioWorkletProcessor {

		constructor(options) {
			
			super(options);
			/**
			 * If the processor was disposed or not. Keep alive until it's disposed.
			 */
			this.disposed = false;
		   	/** 
			 * The number of samples in the processing block
			 */
			this.blockSize = 128;
			/**
			 * the sample rate
			 */
			this.sampleRate = sampleRate;

			this.port.onmessage = (event) => {
				// when it receives a dispose 
				if (event.data === "dispose") {
					this.disposed = true;
				}
			};
		}
	}
`;Gf(m_);const g_=`
	/**
	 * Abstract class for a single input/output processor. 
	 * has a 'generate' function which processes one sample at a time
	 */
	class SingleIOProcessor extends ToneAudioWorkletProcessor {

		constructor(options) {
			super(Object.assign(options, {
				numberOfInputs: 1,
				numberOfOutputs: 1
			}));
			/**
			 * Holds the name of the parameter and a single value of that
			 * parameter at the current sample
			 * @type { [name: string]: number }
			 */
			this.params = {}
		}

		/**
		 * Generate an output sample from the input sample and parameters
		 * @abstract
		 * @param input number
		 * @param channel number
		 * @param parameters { [name: string]: number }
		 * @returns number
		 */
		generate(){}

		/**
		 * Update the private params object with the 
		 * values of the parameters at the given index
		 * @param parameters { [name: string]: Float32Array },
		 * @param index number
		 */
		updateParams(parameters, index) {
			for (const paramName in parameters) {
				const param = parameters[paramName];
				if (param.length > 1) {
					this.params[paramName] = parameters[paramName][index];
				} else {
					this.params[paramName] = parameters[paramName][0];
				}
			}
		}

		/**
		 * Process a single frame of the audio
		 * @param inputs Float32Array[][]
		 * @param outputs Float32Array[][]
		 */
		process(inputs, outputs, parameters) {
			const input = inputs[0];
			const output = outputs[0];
			// get the parameter values
			const channelCount = Math.max(input && input.length || 0, output.length);
			for (let sample = 0; sample < this.blockSize; sample++) {
				this.updateParams(parameters, sample);
				for (let channel = 0; channel < channelCount; channel++) {
					const inputSample = input && input.length ? input[channel][sample] : 0;
					output[channel][sample] = this.generate(inputSample, channel, this.params);
				}
			}
			return !this.disposed;
		}
	};
`;Gf(g_);const w_=`
	/**
	 * A multichannel buffer for use within an AudioWorkletProcessor as a delay line
	 */
	class DelayLine {
		
		constructor(size, channels) {
			this.buffer = [];
			this.writeHead = []
			this.size = size;

			// create the empty channels
			for (let i = 0; i < channels; i++) {
				this.buffer[i] = new Float32Array(this.size);
				this.writeHead[i] = 0;
			}
		}

		/**
		 * Push a value onto the end
		 * @param channel number
		 * @param value number
		 */
		push(channel, value) {
			this.writeHead[channel] += 1;
			if (this.writeHead[channel] > this.size) {
				this.writeHead[channel] = 0;
			}
			this.buffer[channel][this.writeHead[channel]] = value;
		}

		/**
		 * Get the recorded value of the channel given the delay
		 * @param channel number
		 * @param delay number delay samples
		 */
		get(channel, delay) {
			let readHead = this.writeHead[channel] - Math.floor(delay);
			if (readHead < 0) {
				readHead += this.size;
			}
			return this.buffer[channel][readHead];
		}
	}
`;Gf(w_);const v_="feedback-comb-filter",B_=`
	class FeedbackCombFilterWorklet extends SingleIOProcessor {

		constructor(options) {
			super(options);
			this.delayLine = new DelayLine(this.sampleRate, options.channelCount || 2);
		}

		static get parameterDescriptors() {
			return [{
				name: "delayTime",
				defaultValue: 0.1,
				minValue: 0,
				maxValue: 1,
				automationRate: "k-rate"
			}, {
				name: "feedback",
				defaultValue: 0.5,
				minValue: 0,
				maxValue: 0.9999,
				automationRate: "k-rate"
			}];
		}

		generate(input, channel, parameters) {
			const delayedSample = this.delayLine.get(channel, parameters.delayTime * this.sampleRate);
			this.delayLine.push(channel, input + delayedSample * parameters.feedback);
			return delayedSample;
		}
	}
`;lv(v_,B_);class Kf extends Oi{constructor(){const t=ft(Kf.getDefaults(),arguments,["voice","options"]);super(t),this.name="PolySynth",this._availableVoices=[],this._activeVoices=[],this._voices=[],this._gcTimeout=-1,this._averageActiveVoices=0,this._syncedRelease=i=>this.releaseAll(i),mt(!ni(t.voice),"DEPRECATED: The polyphony count is no longer the first argument.");const e=t.voice.getDefaults();this.options=Object.assign(e,t.options),this.voice=t.voice,this.maxPolyphony=t.maxPolyphony,this._dummyVoice=this._getNextAvailableVoice();const s=this._voices.indexOf(this._dummyVoice);this._voices.splice(s,1),this._gcTimeout=this.context.setInterval(this._collectGarbage.bind(this),1)}static getDefaults(){return Object.assign(Oi.getDefaults(),{maxPolyphony:32,options:{},voice:Fo})}get activeVoices(){return this._activeVoices.length}_makeVoiceAvailable(t){this._availableVoices.push(t);const e=this._activeVoices.findIndex(s=>s.voice===t);this._activeVoices.splice(e,1)}_getNextAvailableVoice(){if(this._availableVoices.length)return this._availableVoices.shift();if(this._voices.length<this.maxPolyphony){const t=new this.voice(Object.assign(this.options,{context:this.context,onsilence:this._makeVoiceAvailable.bind(this)}));return mt(t instanceof yr,"Voice must extend Monophonic class"),t.connect(this.output),this._voices.push(t),t}else ya("Max polyphony exceeded. Note dropped.")}_collectGarbage(){if(this._averageActiveVoices=Math.max(this._averageActiveVoices*.95,this.activeVoices),this._availableVoices.length&&this._voices.length>Math.ceil(this._averageActiveVoices+1)){const t=this._availableVoices.shift(),e=this._voices.indexOf(t);this._voices.splice(e,1),this.context.isOffline||t.dispose()}}_triggerAttack(t,e,s){t.forEach(i=>{const r=new VA(this.context,i).toMidi(),o=this._getNextAvailableVoice();o&&(o.triggerAttack(i,e,s),this._activeVoices.push({midi:r,voice:o,released:!1}),this.log("triggerAttack",i,e))})}_triggerRelease(t,e){t.forEach(s=>{const i=new VA(this.context,s).toMidi(),r=this._activeVoices.find(({midi:o,released:A})=>o===i&&!A);r&&(r.voice.triggerRelease(e),r.released=!0,this.log("triggerRelease",s,e))})}_scheduleEvent(t,e,s,i){mt(!this.disposed,"Synth was already disposed"),s<=this.now()?t==="attack"?this._triggerAttack(e,s,i):this._triggerRelease(e,s):this.context.setTimeout(()=>{this.disposed||this._scheduleEvent(t,e,s,i)},s-this.now())}triggerAttack(t,e,s){Array.isArray(t)||(t=[t]);const i=this.toSeconds(e);return this._scheduleEvent("attack",t,i,s),this}triggerRelease(t,e){Array.isArray(t)||(t=[t]);const s=this.toSeconds(e);return this._scheduleEvent("release",t,s),this}triggerAttackRelease(t,e,s,i){const r=this.toSeconds(s);if(this.triggerAttack(t,r,i),En(e)){mt(En(t),"If the duration is an array, the notes must also be an array"),t=t;for(let o=0;o<t.length;o++){const A=e[Math.min(o,e.length-1)],a=this.toSeconds(A);mt(a>0,"The duration must be greater than 0"),this.triggerRelease(t[o],r+a)}}else{const o=this.toSeconds(e);mt(o>0,"The duration must be greater than 0"),this.triggerRelease(t,r+o)}return this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}set(t){const e=Od(t,["onsilence","context"]);return this.options=pr(this.options,e),this._voices.forEach(s=>s.set(e)),this._dummyVoice.set(e),this}get(){return this._dummyVoice.get()}releaseAll(t){const e=this.toSeconds(t);return this._activeVoices.forEach(({voice:s})=>{s.triggerRelease(e)}),this}dispose(){return super.dispose(),this._dummyVoice.dispose(),this._voices.forEach(t=>t.dispose()),this._activeVoices=[],this._availableVoices=[],this.context.clearInterval(this._gcTimeout),this}}class ru extends Oi{constructor(){const t=ft(ru.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");super(t),this.name="Sampler",this._activeSources=new Map;const e={};Object.keys(t.urls).forEach(s=>{const i=parseInt(s,10);if(mt(Na(s)||ni(i)&&isFinite(i),`url key is neither a note or midi pitch: ${s}`),Na(s)){const r=new yn(this.context,s).toMidi();e[r]=t.urls[s]}else ni(i)&&isFinite(i)&&(e[i]=t.urls[i])}),this._buffers=new Yc({urls:e,onload:t.onload,baseUrl:t.baseUrl,onerror:t.onerror}),this.attack=t.attack,this.release=t.release,this.curve=t.curve,this._buffers.loaded&&Promise.resolve().then(t.onload)}static getDefaults(){return Object.assign(Oi.getDefaults(),{attack:0,baseUrl:"",curve:"exponential",onload:Lt,onerror:Lt,release:.1,urls:{}})}_findClosest(t){let s=0;for(;s<96;){if(this._buffers.has(t+s))return-s;if(this._buffers.has(t-s))return s;s++}throw new Error(`No available buffers for note: ${t}`)}triggerAttack(t,e,s=1){return this.log("triggerAttack",t,e,s),Array.isArray(t)||(t=[t]),t.forEach(i=>{const r=sv(new yn(this.context,i).toFrequency()),o=Math.round(r),A=r-o,a=this._findClosest(o),l=o-a,c=this._buffers.get(l),u=nv(a+A),d=new Jc({url:c,context:this.context,curve:this.curve,fadeIn:this.attack,fadeOut:this.release,playbackRate:u}).connect(this.output);d.start(e,0,c.duration/u,s),En(this._activeSources.get(o))||this._activeSources.set(o,[]),this._activeSources.get(o).push(d),d.onended=()=>{if(this._activeSources&&this._activeSources.has(o)){const p=this._activeSources.get(o),f=p.indexOf(d);f!==-1&&p.splice(f,1)}}}),this}triggerRelease(t,e){return this.log("triggerRelease",t,e),Array.isArray(t)||(t=[t]),t.forEach(s=>{const i=new yn(this.context,s).toMidi();if(this._activeSources.has(i)&&this._activeSources.get(i).length){const r=this._activeSources.get(i);e=this.toSeconds(e),r.forEach(o=>{o.stop(e)}),this._activeSources.set(i,[])}}),this}releaseAll(t){const e=this.toSeconds(t);return this._activeSources.forEach(s=>{for(;s.length;)s.shift().stop(e)}),this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1)),this}triggerAttackRelease(t,e,s,i=1){const r=this.toSeconds(s);return this.triggerAttack(t,r,i),En(e)?(mt(En(t),"notes must be an array when duration is array"),t.forEach((o,A)=>{const a=e[Math.min(A,e.length-1)];this.triggerRelease(o,r+this.toSeconds(a))})):this.triggerRelease(t,r+this.toSeconds(e)),this}add(t,e,s){if(mt(Na(t)||isFinite(t),`note must be a pitch or midi: ${t}`),Na(t)){const i=new yn(this.context,t).toMidi();this._buffers.add(i,e,s)}else this._buffers.add(t,e,s);return this}get loaded(){return this._buffers.loaded}dispose(){return super.dispose(),this._buffers.dispose(),this._activeSources.forEach(t=>{t.forEach(e=>e.dispose())}),this._activeSources.clear(),this}}os([ui(0)],ru.prototype,"attack",void 0);os([ui(0)],ru.prototype,"release",void 0);class uo extends ht{constructor(){const t=ft(uo.getDefaults(),arguments,["fade"]);super(t),this.name="CrossFade",this._panner=this.context.createStereoPanner(),this._split=this.context.createChannelSplitter(2),this._g2a=new p_({context:this.context}),this.a=new Tt({context:this.context,gain:0}),this.b=new Tt({context:this.context,gain:0}),this.output=new Tt({context:this.context}),this._internalChannels=[this.a,this.b],this.fade=new Kt({context:this.context,units:"normalRange",value:t.fade}),Pt(this,"fade"),this.context.getConstant(1).connect(this._panner),this._panner.connect(this._split),this._panner.channelCount=1,this._panner.channelCountMode="explicit",ri(this._split,this.a.gain,0),ri(this._split,this.b.gain,1),this.fade.chain(this._g2a,this._panner.pan),this.a.connect(this.output),this.b.connect(this.output)}static getDefaults(){return Object.assign(ht.getDefaults(),{fade:.5})}dispose(){return super.dispose(),this.a.dispose(),this.b.dispose(),this.output.dispose(),this.fade.dispose(),this._g2a.dispose(),this._panner.disconnect(),this._split.disconnect(),this}}class hm extends ht{constructor(t){super(t),this.name="Effect",this._dryWet=new uo({context:this.context}),this.wet=this._dryWet.fade,this.effectSend=new Tt({context:this.context}),this.effectReturn=new Tt({context:this.context}),this.input=new Tt({context:this.context}),this.output=this._dryWet,this.input.fan(this._dryWet.a,this.effectSend),this.effectReturn.connect(this._dryWet.b),this.wet.setValueAtTime(t.wet,0),this._internalChannels=[this.effectReturn,this.effectSend],Pt(this,"wet")}static getDefaults(){return Object.assign(ht.getDefaults(),{wet:1})}connectEffect(t){return this._internalChannels.push(t),this.effectSend.chain(t,this.effectReturn),this}dispose(){return super.dispose(),this._dryWet.dispose(),this.effectSend.dispose(),this.effectReturn.dispose(),this.wet.dispose(),this}}class qf extends ht{constructor(){const t=ft(qf.getDefaults(),arguments,["pan"]);super(t),this.name="Panner",this._panner=this.context.createStereoPanner(),this.input=this._panner,this.output=this._panner,this.pan=new xt({context:this.context,param:this._panner.pan,value:t.pan,minValue:-1,maxValue:1}),this._panner.channelCount=t.channelCount,this._panner.channelCountMode="explicit",Pt(this,"pan")}static getDefaults(){return Object.assign(ht.getDefaults(),{pan:0,channelCount:1})}dispose(){return super.dispose(),this._panner.disconnect(),this.pan.dispose(),this}}const C_="bit-crusher",b_=`
	class BitCrusherWorklet extends SingleIOProcessor {

		static get parameterDescriptors() {
			return [{
				name: "bits",
				defaultValue: 12,
				minValue: 1,
				maxValue: 16,
				automationRate: 'k-rate'
			}];
		}

		generate(input, _channel, parameters) {
			const step = Math.pow(0.5, parameters.bits - 1);
			const val = step * Math.floor(input / step + 0.5);
			return val;
		}
	}
`;lv(C_,b_);class zf extends ht{constructor(){const t=ft(zf.getDefaults(),arguments,["channels"]);super(t),this.name="Split",this._splitter=this.input=this.output=this.context.createChannelSplitter(t.channels),this._internalChannels=[this._splitter]}static getDefaults(){return Object.assign(ht.getDefaults(),{channels:2})}dispose(){return super.dispose(),this._splitter.disconnect(),this}}class fm extends hm{constructor(t){super(t),this.name="FeedbackEffect",this._feedbackGain=new Tt({context:this.context,gain:t.feedback,units:"normalRange"}),this.feedback=this._feedbackGain.gain,Pt(this,"feedback"),this.effectReturn.chain(this._feedbackGain,this.effectSend)}static getDefaults(){return Object.assign(hm.getDefaults(),{feedback:.125})}dispose(){return super.dispose(),this._feedbackGain.dispose(),this.feedback.dispose(),this}}class Xf extends fm{constructor(){const t=ft(Xf.getDefaults(),arguments,["delayTime","feedback"]);super(t),this.name="FeedbackDelay",this._delayNode=new Df({context:this.context,delayTime:t.delayTime,maxDelay:t.maxDelay}),this.delayTime=this._delayNode.delayTime,this.connectEffect(this._delayNode),Pt(this,"delayTime")}static getDefaults(){return Object.assign(fm.getDefaults(),{delayTime:.25,maxDelay:1})}dispose(){return super.dispose(),this._delayNode.dispose(),this.delayTime.dispose(),this}}class xa extends ht{constructor(){const t=ft(xa.getDefaults(),arguments,["type","size"]);super(t),this.name="Analyser",this._analysers=[],this._buffers=[],this.input=this.output=this._gain=new Tt({context:this.context}),this._split=new zf({context:this.context,channels:t.channels}),this.input.connect(this._split),ii(t.channels,1);for(let e=0;e<t.channels;e++)this._analysers[e]=this.context.createAnalyser(),this._split.connect(this._analysers[e],e,0);this.size=t.size,this.type=t.type,this.smoothing=t.smoothing}static getDefaults(){return Object.assign(ht.getDefaults(),{size:1024,smoothing:.8,type:"fft",channels:1})}getValue(){return this._analysers.forEach((t,e)=>{const s=this._buffers[e];this._type==="fft"?t.getFloatFrequencyData(s):this._type==="waveform"&&t.getFloatTimeDomainData(s)}),this.channels===1?this._buffers[0]:this._buffers}get size(){return this._analysers[0].frequencyBinCount}set size(t){this._analysers.forEach((e,s)=>{e.fftSize=t*2,this._buffers[s]=new Float32Array(t)})}get channels(){return this._analysers.length}get type(){return this._type}set type(t){mt(t==="waveform"||t==="fft",`Analyser: invalid type: ${t}`),this._type=t}get smoothing(){return this._analysers[0].smoothingTimeConstant}set smoothing(t){this._analysers.forEach(e=>e.smoothingTimeConstant=t)}dispose(){return super.dispose(),this._analysers.forEach(t=>t.disconnect()),this._split.dispose(),this._gain.dispose(),this}}class rc extends ht{constructor(){super(ft(rc.getDefaults(),arguments)),this.name="MeterBase",this.input=this.output=this._analyser=new xa({context:this.context,size:256,type:"waveform"})}dispose(){return super.dispose(),this._analyser.dispose(),this}}class $f extends rc{constructor(){const t=ft($f.getDefaults(),arguments,["smoothing"]);super(t),this.name="Meter",this.input=this.output=this._analyser=new xa({context:this.context,size:256,type:"waveform",channels:t.channelCount}),this.smoothing=t.smoothing,this.normalRange=t.normalRange,this._rms=new Array(t.channelCount),this._rms.fill(0)}static getDefaults(){return Object.assign(rc.getDefaults(),{smoothing:.8,normalRange:!1,channelCount:1})}getLevel(){return ya("'getLevel' has been changed to 'getValue'"),this.getValue()}getValue(){const t=this._analyser.getValue(),s=(this.channels===1?[t]:t).map((i,r)=>{const o=i.reduce((a,l)=>a+l*l,0),A=Math.sqrt(o/i.length);return this._rms[r]=Math.max(A,this._rms[r]*this.smoothing),this.normalRange?this._rms[r]:ev(this._rms[r])});return this.channels===1?s[0]:s}get channels(){return this._analyser.channels}dispose(){return super.dispose(),this._analyser.dispose(),this}}class fe extends ht{constructor(){const t=ft(fe.getDefaults(),arguments,["solo"]);super(t),this.name="Solo",this.input=this.output=new Tt({context:this.context}),fe._allSolos.has(this.context)||fe._allSolos.set(this.context,new Set),fe._allSolos.get(this.context).add(this),this.solo=t.solo}static getDefaults(){return Object.assign(ht.getDefaults(),{solo:!1})}get solo(){return this._isSoloed()}set solo(t){t?this._addSolo():this._removeSolo(),fe._allSolos.get(this.context).forEach(e=>e._updateSolo())}get muted(){return this.input.gain.value===0}_addSolo(){fe._soloed.has(this.context)||fe._soloed.set(this.context,new Set),fe._soloed.get(this.context).add(this)}_removeSolo(){fe._soloed.has(this.context)&&fe._soloed.get(this.context).delete(this)}_isSoloed(){return fe._soloed.has(this.context)&&fe._soloed.get(this.context).has(this)}_noSolos(){return!fe._soloed.has(this.context)||fe._soloed.has(this.context)&&fe._soloed.get(this.context).size===0}_updateSolo(){this._isSoloed()?this.input.gain.value=1:this._noSolos()?this.input.gain.value=1:this.input.gain.value=0}dispose(){return super.dispose(),fe._allSolos.get(this.context).delete(this),this._removeSolo(),this}}fe._allSolos=new Map;fe._soloed=new Map;class Yf extends ht{constructor(){const t=ft(Yf.getDefaults(),arguments,["pan","volume"]);super(t),this.name="PanVol",this._panner=this.input=new qf({context:this.context,pan:t.pan,channelCount:t.channelCount}),this.pan=this._panner.pan,this._volume=this.output=new ci({context:this.context,volume:t.volume}),this.volume=this._volume.volume,this._panner.connect(this._volume),this.mute=t.mute,Pt(this,["pan","volume"])}static getDefaults(){return Object.assign(ht.getDefaults(),{mute:!1,pan:0,volume:0,channelCount:1})}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}dispose(){return super.dispose(),this._panner.dispose(),this.pan.dispose(),this._volume.dispose(),this.volume.dispose(),this}}class Zr extends ht{constructor(){const t=ft(Zr.getDefaults(),arguments,["volume","pan"]);super(t),this.name="Channel",this._solo=this.input=new fe({solo:t.solo,context:this.context}),this._panVol=this.output=new Yf({context:this.context,pan:t.pan,volume:t.volume,mute:t.mute,channelCount:t.channelCount}),this.pan=this._panVol.pan,this.volume=this._panVol.volume,this._solo.connect(this._panVol),Pt(this,["pan","volume"])}static getDefaults(){return Object.assign(ht.getDefaults(),{pan:0,volume:0,mute:!1,solo:!1,channelCount:1})}get solo(){return this._solo.solo}set solo(t){this._solo.solo=t}get muted(){return this._solo.muted||this.mute}get mute(){return this._panVol.mute}set mute(t){this._panVol.mute=t}_getBus(t){return Zr.buses.has(t)||Zr.buses.set(t,new Tt({context:this.context})),Zr.buses.get(t)}send(t,e=0){const s=this._getBus(t),i=new Tt({context:this.context,units:"decibels",gain:e});return this.connect(i),i.connect(s),i}receive(t){return this._getBus(t).connect(this),this}dispose(){return super.dispose(),this._panVol.dispose(),this.pan.dispose(),this.volume.dispose(),this._solo.dispose(),this}}Zr.buses=new Map;class ou extends ht{constructor(){const t=ft(ou.getDefaults(),arguments,["threshold","ratio"]);super(t),this.name="Compressor",this._compressor=this.context.createDynamicsCompressor(),this.input=this._compressor,this.output=this._compressor,this.threshold=new xt({minValue:this._compressor.threshold.minValue,maxValue:this._compressor.threshold.maxValue,context:this.context,convert:!1,param:this._compressor.threshold,units:"decibels",value:t.threshold}),this.attack=new xt({minValue:this._compressor.attack.minValue,maxValue:this._compressor.attack.maxValue,context:this.context,param:this._compressor.attack,units:"time",value:t.attack}),this.release=new xt({minValue:this._compressor.release.minValue,maxValue:this._compressor.release.maxValue,context:this.context,param:this._compressor.release,units:"time",value:t.release}),this.knee=new xt({minValue:this._compressor.knee.minValue,maxValue:this._compressor.knee.maxValue,context:this.context,convert:!1,param:this._compressor.knee,units:"decibels",value:t.knee}),this.ratio=new xt({minValue:this._compressor.ratio.minValue,maxValue:this._compressor.ratio.maxValue,context:this.context,convert:!1,param:this._compressor.ratio,units:"positive",value:t.ratio}),Pt(this,["knee","release","attack","ratio","threshold"])}static getDefaults(){return Object.assign(ht.getDefaults(),{attack:.003,knee:30,ratio:12,release:.25,threshold:-24})}get reduction(){return this._compressor.reduction}dispose(){return super.dispose(),this._compressor.disconnect(),this.attack.dispose(),this.release.dispose(),this.threshold.dispose(),this.ratio.dispose(),this.knee.dispose(),this}}class jf extends ht{constructor(){const t=ft(jf.getDefaults(),arguments,["threshold"]);super(t),this.name="Limiter",this._compressor=this.input=this.output=new ou({context:this.context,ratio:20,attack:.003,release:.01,threshold:t.threshold}),this.threshold=this._compressor.threshold,Pt(this,"threshold")}static getDefaults(){return Object.assign(ht.getDefaults(),{threshold:-12})}get reduction(){return this._compressor.reduction}dispose(){return super.dispose(),this._compressor.dispose(),this.threshold.dispose(),this}}function de(){return ke().now()}const dt=ke().transport;ke().destination;ke().destination;ke().listener;const Qu=ke().draw,GA=ke(),Pn=[{pitch:"C8",flatName:"C8",sharpName:"C8",toneNote:"C8",frequency:4186.01,column:"A",hex:"#fcfcfc",isAccidental:!1,midi:108,pitchClass:0,octave:8},{pitch:"B7",flatName:"B7",sharpName:"B7",toneNote:"B7",frequency:3951.07,column:"B",hex:"#fcf7fc",isAccidental:!1,midi:107,pitchClass:11,octave:7},{pitch:"B/A7",flatName:"B7",sharpName:"A7",toneNote:"Bb7",frequency:3729.31,column:"A",hex:"#f7f5fd",isAccidental:!0,midi:106,pitchClass:10,octave:7},{pitch:"A7",flatName:"A7",sharpName:"A7",toneNote:"A7",frequency:3520,column:"B",hex:"#f0f4ff",isAccidental:!1,midi:105,pitchClass:9,octave:7},{pitch:"A/G7",flatName:"A7",sharpName:"G7",toneNote:"Ab7",frequency:3322.44,column:"A",hex:"#e6f3fd",isAccidental:!0,midi:104,pitchClass:8,octave:7},{pitch:"G7",flatName:"G7",sharpName:"G7",toneNote:"G7",frequency:3135.96,column:"B",hex:"#def3f7",isAccidental:!1,midi:103,pitchClass:7,octave:7},{pitch:"G/F7",flatName:"G7",sharpName:"F7",toneNote:"Gb7",frequency:2959.96,column:"A",hex:"#daf2ec",isAccidental:!0,midi:102,pitchClass:6,octave:7},{pitch:"F7",flatName:"F7",sharpName:"F7",toneNote:"F7",frequency:2793.83,column:"B",hex:"#dcefdf",isAccidental:!1,midi:101,pitchClass:5,octave:7},{pitch:"E7",flatName:"E7",sharpName:"E7",toneNote:"E7",frequency:2637.02,column:"A",hex:"#e3ebd1",isAccidental:!1,midi:100,pitchClass:4,octave:7},{pitch:"E/D7",flatName:"E7",sharpName:"D7",toneNote:"Eb7",frequency:2489.02,column:"B",hex:"#eee4c8",isAccidental:!0,midi:99,pitchClass:3,octave:7},{pitch:"D7",flatName:"D7",sharpName:"D7",toneNote:"D7",frequency:2349.32,column:"A",hex:"#f8dcc6",isAccidental:!1,midi:98,pitchClass:2,octave:7},{pitch:"D/C7",flatName:"D7",sharpName:"C7",toneNote:"Db7",frequency:2217.46,column:"B",hex:"#fcd4cd",isAccidental:!0,midi:97,pitchClass:1,octave:7},{pitch:"C7",flatName:"C7",sharpName:"C7",toneNote:"C7",frequency:2093,column:"A",hex:"#facfdb",isAccidental:!1,midi:96,pitchClass:0,octave:7},{pitch:"B6",flatName:"B6",sharpName:"B6",toneNote:"B6",frequency:1975.53,column:"B",hex:"#efcdeb",isAccidental:!1,midi:95,pitchClass:11,octave:6},{pitch:"B/A6",flatName:"B6",sharpName:"A6",toneNote:"Bb6",frequency:1864.66,column:"A",hex:"#ddcff9",isAccidental:!0,midi:94,pitchClass:10,octave:6},{pitch:"A6",flatName:"A6",sharpName:"A6",toneNote:"A6",frequency:1760,column:"B",hex:"#c4d3ff",isAccidental:!1,midi:93,pitchClass:9,octave:6},{pitch:"A/G6",flatName:"A6",sharpName:"G6",toneNote:"Ab6",frequency:1661.22,column:"A",hex:"#abd9fa",isAccidental:!0,midi:92,pitchClass:8,octave:6},{pitch:"G6",flatName:"G6",sharpName:"G6",toneNote:"G6",frequency:1567.94,column:"B",hex:"#98dde9",isAccidental:!1,midi:91,pitchClass:7,octave:6},{pitch:"G/F6",flatName:"G6",sharpName:"F6",toneNote:"Gb6",frequency:1479.98,column:"A",hex:"#96ddcf",isAccidental:!0,midi:90,pitchClass:6,octave:6},{pitch:"F6",flatName:"F6",sharpName:"F6",toneNote:"F6",frequency:1396.91,column:"B",hex:"#a6d9b0",isAccidental:!1,midi:89,pitchClass:5,octave:6},{pitch:"E6",flatName:"E6",sharpName:"E6",toneNote:"E6",frequency:1318.51,column:"A",hex:"#c0d093",isAccidental:!1,midi:88,pitchClass:4,octave:6},{pitch:"E/D6",flatName:"E6",sharpName:"D6",toneNote:"Eb6",frequency:1244.51,column:"B",hex:"#dbc383",isAccidental:!0,midi:87,pitchClass:3,octave:6},{pitch:"D6",flatName:"D6",sharpName:"D6",toneNote:"D6",frequency:1174.66,column:"A",hex:"#efb586",isAccidental:!1,midi:86,pitchClass:2,octave:6},{pitch:"D/C6",flatName:"D6",sharpName:"C6",toneNote:"Db6",frequency:1108.73,column:"B",hex:"#f8a99c",isAccidental:!0,midi:85,pitchClass:1,octave:6},{pitch:"C6",flatName:"C6",sharpName:"C6",toneNote:"C6",frequency:1046.5,column:"A",hex:"#f3a2bb",isAccidental:!1,midi:84,pitchClass:0,octave:6},{pitch:"B5",flatName:"B5",sharpName:"B5",toneNote:"B5",frequency:987.77,column:"B",hex:"#e1a3db",isAccidental:!1,midi:83,pitchClass:11,octave:5},{pitch:"B/A5",flatName:"B5",sharpName:"A5",toneNote:"Bb5",frequency:932.33,column:"A",hex:"#c3a9f4",isAccidental:!0,midi:82,pitchClass:10,octave:5},{pitch:"A5",flatName:"A5",sharpName:"A5",toneNote:"A5",frequency:880,column:"B",hex:"#9ab2ff",isAccidental:!1,midi:81,pitchClass:9,octave:5},{pitch:"A/G5",flatName:"A5",sharpName:"G5",toneNote:"Ab5",frequency:830.61,column:"A",hex:"#67bdf7",isAccidental:!0,midi:80,pitchClass:8,octave:5},{pitch:"G5",flatName:"G5",sharpName:"G5",toneNote:"G5",frequency:783.99,column:"B",hex:"#30c6dc",isAccidental:!1,midi:79,pitchClass:7,octave:5},{pitch:"G/F5",flatName:"G5",sharpName:"F5",toneNote:"Gb5",frequency:739.99,column:"A",hex:"#32c8b2",isAccidental:!0,midi:78,pitchClass:6,octave:5},{pitch:"F5",flatName:"F5",sharpName:"F5",toneNote:"F5",frequency:698.46,column:"B",hex:"#6dc281",isAccidental:!1,midi:77,pitchClass:5,octave:5},{pitch:"E5",flatName:"E5",sharpName:"E5",toneNote:"E5",frequency:659.25,column:"A",hex:"#a0b556",isAccidental:!1,midi:76,pitchClass:4,octave:5},{pitch:"E/D5",flatName:"E5",sharpName:"D5",toneNote:"Eb5",frequency:622.25,column:"B",hex:"#c5a33f",isAccidental:!0,midi:75,pitchClass:3,octave:5},{pitch:"D5",flatName:"D5",sharpName:"D5",toneNote:"D5",frequency:587.33,column:"A",hex:"#dc9150",isAccidental:!1,midi:74,pitchClass:2,octave:5},{pitch:"D/C5",flatName:"D5",sharpName:"C5",toneNote:"Db5",frequency:554.37,column:"B",hex:"#e38475",isAccidental:!0,midi:73,pitchClass:1,octave:5},{pitch:"C5",flatName:"C5",sharpName:"C5",toneNote:"C5",frequency:523.25,column:"A",hex:"#dc7f9d",isAccidental:!1,midi:72,pitchClass:0,octave:5},{pitch:"B4",flatName:"B4",sharpName:"B4",toneNote:"B4",frequency:493.88,column:"B",hex:"#c781c0",isAccidental:!1,midi:71,pitchClass:11,octave:4},{pitch:"B/A4",flatName:"B4",sharpName:"A4",toneNote:"Bb4",frequency:466.16,column:"A",hex:"#a68ad8",isAccidental:!0,midi:70,pitchClass:10,octave:4},{pitch:"A4",flatName:"A4",sharpName:"A4",toneNote:"A4",frequency:440,column:"B",hex:"#7d94e0",isAccidental:!1,midi:69,pitchClass:9,octave:4},{pitch:"A/G4",flatName:"A4",sharpName:"G4",toneNote:"Ab4",frequency:415.3,column:"A",hex:"#4c9fd5",isAccidental:!0,midi:68,pitchClass:8,octave:4},{pitch:"G4",flatName:"G4",sharpName:"G4",toneNote:"G4",frequency:392,column:"B",hex:"#0fa6ba",isAccidental:!1,midi:67,pitchClass:7,octave:4},{pitch:"G/F4",flatName:"G4",sharpName:"F4",toneNote:"Gb4",frequency:369.99,column:"A",hex:"#24a794",isAccidental:!0,midi:66,pitchClass:6,octave:4},{pitch:"F4",flatName:"F4",sharpName:"F4",toneNote:"F4",frequency:349.23,column:"B",hex:"#5aa26a",isAccidental:!1,midi:65,pitchClass:5,octave:4},{pitch:"E4",flatName:"E4",sharpName:"E4",toneNote:"E4",frequency:329.63,column:"A",hex:"#849646",isAccidental:!1,midi:64,pitchClass:4,octave:4},{pitch:"E/D4",flatName:"E4",sharpName:"D4",toneNote:"Eb4",frequency:311.13,column:"B",hex:"#a38733",isAccidental:!0,midi:63,pitchClass:3,octave:4},{pitch:"D4",flatName:"D4",sharpName:"D4",toneNote:"D4",frequency:293.66,column:"A",hex:"#b67740",isAccidental:!1,midi:62,pitchClass:2,octave:4},{pitch:"D/C4",flatName:"D4",sharpName:"C4",toneNote:"Db4",frequency:277.18,column:"B",hex:"#bc6c5f",isAccidental:!0,midi:61,pitchClass:1,octave:4},{pitch:"C4",flatName:"C4",sharpName:"C4",toneNote:"C4",frequency:261.63,column:"A",hex:"#b56880",isAccidental:!1,midi:60,pitchClass:0,octave:4},{pitch:"B3",flatName:"B3",sharpName:"B3",toneNote:"B3",frequency:246.94,column:"B",hex:"#a3699e",isAccidental:!1,midi:59,pitchClass:11,octave:3},{pitch:"B/A3",flatName:"B3",sharpName:"A3",toneNote:"Bb3",frequency:233.08,column:"A",hex:"#8870b1",isAccidental:!0,midi:58,pitchClass:10,octave:3},{pitch:"A3",flatName:"A3",sharpName:"A3",toneNote:"A3",frequency:220,column:"B",hex:"#6578b7",isAccidental:!1,midi:57,pitchClass:9,octave:3},{pitch:"A/G3",flatName:"A3",sharpName:"G3",toneNote:"Ab3",frequency:207.65,column:"A",hex:"#3c81ad",isAccidental:!0,midi:56,pitchClass:8,octave:3},{pitch:"G3",flatName:"G3",sharpName:"G3",toneNote:"G3",frequency:196,column:"B",hex:"#0e8696",isAccidental:!1,midi:55,pitchClass:7,octave:3},{pitch:"G/F3",flatName:"G3",sharpName:"F3",toneNote:"Gb3",frequency:185,column:"A",hex:"#1b8777",isAccidental:!0,midi:54,pitchClass:6,octave:3},{pitch:"F3",flatName:"F3",sharpName:"F3",toneNote:"F3",frequency:174.61,column:"B",hex:"#478255",isAccidental:!1,midi:53,pitchClass:5,octave:3},{pitch:"E3",flatName:"E3",sharpName:"E3",toneNote:"E3",frequency:164.81,column:"A",hex:"#697836",isAccidental:!1,midi:52,pitchClass:4,octave:3},{pitch:"E/D3",flatName:"E3",sharpName:"D3",toneNote:"Eb3",frequency:155.56,column:"B",hex:"#836b27",isAccidental:!0,midi:51,pitchClass:3,octave:3},{pitch:"D3",flatName:"D3",sharpName:"D3",toneNote:"D3",frequency:146.83,column:"A",hex:"#925e32",isAccidental:!1,midi:50,pitchClass:2,octave:3},{pitch:"D/C3",flatName:"D3",sharpName:"C3",toneNote:"Db3",frequency:138.59,column:"B",hex:"#96554b",isAccidental:!0,midi:49,pitchClass:1,octave:3},{pitch:"C3",flatName:"C3",sharpName:"C3",toneNote:"C3",frequency:130.81,column:"A",hex:"#905165",isAccidental:!1,midi:48,pitchClass:0,octave:3},{pitch:"B2",flatName:"B2",sharpName:"B2",toneNote:"B2",frequency:123.47,column:"B",hex:"#80527c",isAccidental:!1,midi:47,pitchClass:11,octave:2},{pitch:"B/A2",flatName:"B2",sharpName:"A2",toneNote:"Bb2",frequency:116.54,column:"A",hex:"#6a578c",isAccidental:!0,midi:46,pitchClass:10,octave:2},{pitch:"A2",flatName:"A2",sharpName:"A2",toneNote:"A2",frequency:110,column:"B",hex:"#4e5e90",isAccidental:!1,midi:45,pitchClass:9,octave:2},{pitch:"A/G2",flatName:"A2",sharpName:"G2",toneNote:"Ab2",frequency:103.83,column:"A",hex:"#2d6488",isAccidental:!0,midi:44,pitchClass:8,octave:2},{pitch:"G2",flatName:"G2",sharpName:"G2",toneNote:"G2",frequency:98,column:"B",hex:"#096875",isAccidental:!1,midi:43,pitchClass:7,octave:2},{pitch:"G/F2",flatName:"G2",sharpName:"F2",toneNote:"Gb2",frequency:92.5,column:"A",hex:"#13685b",isAccidental:!0,midi:42,pitchClass:6,octave:2},{pitch:"F2",flatName:"F2",sharpName:"F2",toneNote:"F2",frequency:87.31,column:"B",hex:"#356440",isAccidental:!1,midi:41,pitchClass:5,octave:2},{pitch:"E2",flatName:"E2",sharpName:"E2",toneNote:"E2",frequency:82.41,column:"A",hex:"#505c28",isAccidental:!1,midi:40,pitchClass:4,octave:2},{pitch:"E/D2",flatName:"E2",sharpName:"D2",toneNote:"Eb2",frequency:77.78,column:"B",hex:"#63511c",isAccidental:!0,midi:39,pitchClass:3,octave:2},{pitch:"D2",flatName:"D2",sharpName:"D2",toneNote:"D2",frequency:73.42,column:"A",hex:"#6e4724",isAccidental:!1,midi:38,pitchClass:2,octave:2},{pitch:"D/C2",flatName:"D2",sharpName:"C2",toneNote:"Db2",frequency:69.3,column:"B",hex:"#713f37",isAccidental:!0,midi:37,pitchClass:1,octave:2},{pitch:"C2",flatName:"C2",sharpName:"C2",toneNote:"C2",frequency:65.41,column:"A",hex:"#6c3c4b",isAccidental:!1,midi:36,pitchClass:0,octave:2},{pitch:"B1",flatName:"B1",sharpName:"B1",toneNote:"B1",frequency:61.74,column:"B",hex:"#603c5d",isAccidental:!1,midi:35,pitchClass:11,octave:1},{pitch:"B/A1",flatName:"B1",sharpName:"A1",toneNote:"Bb1",frequency:58.27,column:"A",hex:"#4e4068",isAccidental:!0,midi:34,pitchClass:10,octave:1},{pitch:"A1",flatName:"A1",sharpName:"A1",toneNote:"A1",frequency:55,column:"B",hex:"#38446b",isAccidental:!1,midi:33,pitchClass:9,octave:1},{pitch:"A/G1",flatName:"A1",sharpName:"G1",toneNote:"Ab1",frequency:51.91,column:"A",hex:"#1f4964",isAccidental:!0,midi:32,pitchClass:8,octave:1},{pitch:"G1",flatName:"G1",sharpName:"G1",toneNote:"G1",frequency:49,column:"B",hex:"#044b55",isAccidental:!1,midi:31,pitchClass:7,octave:1},{pitch:"G/F1",flatName:"G1",sharpName:"F1",toneNote:"Gb1",frequency:46.25,column:"A",hex:"#0c4b41",isAccidental:!0,midi:30,pitchClass:6,octave:1},{pitch:"F1",flatName:"F1",sharpName:"F1",toneNote:"F1",frequency:43.65,column:"B",hex:"#24472c",isAccidental:!1,midi:29,pitchClass:5,octave:1},{pitch:"E1",flatName:"E1",sharpName:"E1",toneNote:"E1",frequency:41.2,column:"A",hex:"#38401a",isAccidental:!1,midi:28,pitchClass:4,octave:1},{pitch:"E/D1",flatName:"E1",sharpName:"D1",toneNote:"Eb1",frequency:38.89,column:"B",hex:"#463811",isAccidental:!0,midi:27,pitchClass:3,octave:1},{pitch:"D1",flatName:"D1",sharpName:"D1",toneNote:"D1",frequency:36.71,column:"A",hex:"#4d3017",isAccidental:!1,midi:26,pitchClass:2,octave:1},{pitch:"D/C1",flatName:"D1",sharpName:"C1",toneNote:"Db1",frequency:34.65,column:"B",hex:"#4f2a24",isAccidental:!0,midi:25,pitchClass:1,octave:1},{pitch:"C1",flatName:"C1",sharpName:"C1",toneNote:"C1",frequency:32.7,column:"A",hex:"#4a2733",isAccidental:!1,midi:24,pitchClass:0,octave:1},{pitch:"B0",flatName:"B0",sharpName:"B0",toneNote:"B0",frequency:30.87,column:"B",hex:"#41273f",isAccidental:!1,midi:23,pitchClass:11,octave:0},{pitch:"B/A0",flatName:"B0",sharpName:"A0",toneNote:"Bb0",frequency:29.14,column:"A",hex:"#342a46",isAccidental:!0,midi:22,pitchClass:10,octave:0},{pitch:"A0",flatName:"A0",sharpName:"A0",toneNote:"A0",frequency:27.5,column:"B",hex:"#242c48",isAccidental:!1,midi:21,pitchClass:9,octave:0}],cv=new Map,y_=new Map;Pn.forEach((n,t)=>{cv.set(n.toneNote,t),n.midi!==void 0&&y_.set(n.midi,t)});function pm(n){return cv.get(n)??-1}function S_(n,t){const e=pm(n),s=pm(t);return e===-1||s===-1?null:{topIndex:Math.min(e,s),bottomIndex:Math.max(e,s)}}const E_={attack:.01,decay:.1,sustain:.7,release:.3},x_={enabled:!1,blend:.5,cutoff:.5,resonance:0,type:"lowpass",mix:1},__={speed:5,span:0},I_={speed:5,span:0};function F_(){const n=["#4a90e2","#e24a4a","#4ae24a","#e2e24a","#e24ae2","#4ae2e2","#e2a04a","#a04ae2"],t={};return n.forEach(e=>{const s=new Float32Array(32);s[0]=1;const i=new Float32Array(32);t[e]={name:"Sine",adsr:{...E_},coeffs:s,phases:i,filter:{...x_},activePresetName:"sine",gain:1,vibrato:{...__},tremelo:{...I_}}}),t}function T_(){return{macrobeatGroupings:[2,2,2,2],macrobeatBoundaryStyles:["dashed","dashed","dashed","dashed"],hasAnacrusis:!1,baseMicrobeatPx:40,modulationMarkers:[]}}function Q_(){const n=S_("G5","C4");return n||{topIndex:0,bottomIndex:Math.max(0,Pn.length-1)}}function M_(){const n=F_();return{placedNotes:[],placedChords:[],tonicSignGroups:{},sixteenthStampPlacements:[],tripletStampPlacements:[],annotations:[],lassoSelection:{selectedItems:[],convexHull:null,isActive:!1},history:[{notes:[],tonicSignGroups:{},timbres:JSON.parse(JSON.stringify(n)),placedChords:[],sixteenthStampPlacements:[],tripletStampPlacements:[],annotations:[],lassoSelection:{selectedItems:[],convexHull:null,isActive:!1}}],historyIndex:0,fullRowData:[...Pn],pitchRange:Q_(),...T_(),selectedModulationRatio:null,timbres:n,colorPalette:{"#4a90e2":{primary:"#4a90e2",light:"#a8c8f0"},"#e24a4a":{primary:"#e24a4a",light:"#f0a8a8"},"#4ae24a":{primary:"#4ae24a",light:"#a8f0a8"},"#e2e24a":{primary:"#e2e24a",light:"#f0f0a8"},"#e24ae2":{primary:"#e24ae2",light:"#f0a8f0"},"#4ae2e2":{primary:"#4ae2e2",light:"#a8f0f0"},"#e2a04a":{primary:"#e2a04a",light:"#f0d0a8"},"#a04ae2":{primary:"#a04ae2",light:"#d0a8f0"}},selectedTool:"note",previousTool:"note",selectedToolTonicNumber:1,selectedNote:{shape:"circle",color:"#4a90e2"},deviceProfile:{isMobile:!1,isTouch:!1,isCoarsePointer:!1,orientation:"landscape",width:0,height:0},activeChordId:null,activeChordIntervals:["1P"],isIntervalsInverted:!1,chordPositionState:0,gridPosition:0,viewportRows:0,logicRows:0,cellWidth:0,cellHeight:0,columnWidths:[],musicalColumnWidths:[],degreeDisplayMode:"off",accidentalMode:{sharp:!0,flat:!0},showFrequencyLabels:!1,showOctaveLabels:!0,focusColours:!1,isPlaying:!1,isPaused:!1,isLooping:!1,tempo:90,playheadMode:"cursor",waveformExtendedView:!1,adsrTimeAxisScale:1,isPrintPreviewActive:!1,printOptions:{pageSize:"letter",includeButtonGrid:!0,includeDrums:!0,includeLeftLegend:!0,includeRightLegend:!0,orientation:"landscape",colorMode:"color",cropTop:0,cropBottom:1,cropLeft:0,cropRight:1},longNoteStyle:"style1"}}function mm(n){if(!(!n||n.isDrum)&&n.shape==="circle"&&typeof n.startColumnIndex=="number"){const t=n.startColumnIndex+1;(typeof n.endColumnIndex!="number"||n.endColumnIndex<t)&&(n.endColumnIndex=t)}}function Mu(n,t){if(typeof n.row!="number")return;const e=t.length>0?t.length-1:-1;if(e<0)return;const s=typeof n.globalRow=="number"?n.globalRow:n.row,i=Math.max(0,Math.min(e,Math.round(s)));n.globalRow=i,n.row=i}function Uu(){return`uuid-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function U_(n={}){const{getMacrobeatInfo:t,getDegreeForNote:e,hasAccidental:s,log:i=()=>{}}=n;return{addNote(r){const o=this.state.placedNotes.find(a=>!a.isDrum&&a.row===r.row&&a.startColumnIndex===r.startColumnIndex&&a.color===r.color);if(o){if(this.state.degreeDisplayMode!=="off"&&e&&s){const a=e(o,this.state);if(a&&s(a))return o.enharmonicPreference=!o.enharmonicPreference,i("debug","[ENHARMONIC] Toggled enharmonic preference for note",{noteUuid:o.uuid,currentDegree:a,enharmonicPreference:o.enharmonicPreference}),this.emit("notesChanged"),o}return null}const A={...r,uuid:Uu()};return mm(A),Mu(A,this.state.fullRowData),this.state.placedNotes.push(A),this.emit("notesChanged"),A},updateNoteTail(r,o){let A=o;r.shape==="circle"&&(A=Math.max(r.startColumnIndex+1,o)),r.endColumnIndex=A,this.emit("notesChanged")},updateMultipleNoteTails(r,o){r.forEach(A=>{let a=o;A.shape==="circle"&&(a=Math.max(A.startColumnIndex+1,o)),A.endColumnIndex=a}),this.emit("notesChanged")},updateNoteRow(r,o){r.row=o,r.globalRow=o,this.emit("notesChanged")},updateMultipleNoteRows(r,o){r.forEach((A,a)=>{const l=o[a];l!==void 0&&(A.row=l,Mu(A,this.state.fullRowData))}),this.emit("notesChanged")},updateNotePosition(r,o){r.startColumnIndex=o,r.endColumnIndex=r.shape==="circle"?o+1:o,this.emit("notesChanged")},updateMultipleNotePositions(r,o){r.forEach(A=>{A.startColumnIndex=o,A.endColumnIndex=A.shape==="circle"?o+1:o}),this.emit("notesChanged")},removeNote(r){const o=this.state.placedNotes.indexOf(r);o>-1&&(this.state.placedNotes.splice(o,1),this.emit("notesChanged"))},removeMultipleNotes(r){const o=new Set(r);this.state.placedNotes=this.state.placedNotes.filter(A=>!o.has(A)),this.emit("notesChanged")},eraseInPitchArea(r,o,A=1,a=!0){const l=r+A-1,c=o-1,u=o+1;let d=!1;const p=this.state.placedNotes.length;return this.state.placedNotes=this.state.placedNotes.filter(f=>{if(f.isDrum)return!0;if(f.shape==="circle"){const m=f.startColumnIndex+1,g=typeof f.endColumnIndex=="number"?Math.max(m,f.endColumnIndex):m,w=f.startColumnIndex<=l&&g>=r,B=f.row>=c&&f.row<=u;if(w&&B)return!1}else if(f.row>=c&&f.row<=u&&f.startColumnIndex<=l&&f.endColumnIndex>=r)return!1;return!0}),this.state.placedNotes.length<p&&(d=!0),d&&(this.emit("notesChanged"),a&&this.recordState()),d},addTonicSignGroup(r){i("debug","Starting addTonicSignGroup",{tonicSignGroup:r});const o=r[0];if(!o)return;const{preMacrobeatIndex:A}=o;if(i("debug","preMacrobeatIndex",{preMacrobeatIndex:A}),Object.entries(this.state.tonicSignGroups).find(([,p])=>p.some(f=>f.preMacrobeatIndex===A))){i("debug","Existing tonic already present for measure, skipping",{preMacrobeatIndex:A});return}if(!t){i("error","getMacrobeatInfo callback not provided");return}const l=t(this.state,A+1).startColumn;i("debug","Boundary column (canvas-space) for shifting notes",{boundaryColumn:l});const c=this.state.placedNotes.filter(p=>p.startColumnIndex>=l);i("debug","Notes that will be shifted",{noteRanges:c.map(p=>`${p.startColumnIndex}-${p.endColumnIndex}`)}),this.state.placedNotes.forEach(p=>{if(p.startColumnIndex>=l){const f=p.startColumnIndex,m=p.endColumnIndex;p.startColumnIndex=p.startColumnIndex+2,p.endColumnIndex=p.endColumnIndex+2,i("debug",`Shifted note from ${f}-${m} to ${p.startColumnIndex}-${p.endColumnIndex}`)}});const u=Uu(),d=r.map(p=>({...p,uuid:u,globalRow:typeof p.globalRow=="number"?p.globalRow:p.row}));this.state.tonicSignGroups[u]=d,i("debug","Added tonic group",{uuid:u,columns:d.map(p=>p.columnIndex)}),i("debug","Emitting events: notesChanged, rhythmStructureChanged"),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},eraseTonicSignAt(r,o=!0){const A=Object.entries(this.state.tonicSignGroups).find(([,p])=>p.some(f=>f.columnIndex===r));if(!A)return!1;if(!t)return i("error","getMacrobeatInfo callback not provided"),!1;const[a,l]=A,c=l[0];if(!c)return!1;const u=c.preMacrobeatIndex,d=t(this.state,u+1).startColumn;return delete this.state.tonicSignGroups[a],this.state.placedNotes.forEach(p=>{p.startColumnIndex>=d&&(p.startColumnIndex=p.startColumnIndex-2,p.endColumnIndex=p.endColumnIndex-2)}),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),o&&this.recordState(),!0},clearAllNotes(){this.state.placedNotes=[],this.state.tonicSignGroups={},this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},loadNotes(r){const o=(r||[]).map(A=>{const a={...A,uuid:(A==null?void 0:A.uuid)??Uu()};return mm(a),Mu(a,this.state.fullRowData),a});this.state.placedNotes=o,this.emit("notesChanged"),this.recordState()}}}function P_(){return`sixteenth-stamp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function N_(n={}){const{getPlacedTonicSigns:t,isWithinTonicSpan:e,log:s=()=>{}}=n;return{addSixteenthStampPlacement(i,r,o,A="#4a90e2"){const a=r+2;if(t&&e){const d=t(this.state);(e(r,d)||e(r+1,d))&&s("debug","Cannot place sixteenth stamp - overlaps tonic column",{sixteenthStampId:i,startColumn:r,row:o})}const l=this.state.sixteenthStampPlacements.find(d=>d.row===o&&d.startColumn<a&&d.endColumn>r);l&&this.removeSixteenthStampPlacement(l.id);const c=o,u={id:P_(),sixteenthStampId:i,startColumn:r,endColumn:a,row:o,globalRow:c,color:A,timestamp:Date.now(),shapeOffsets:{}};return this.state.sixteenthStampPlacements.push(u),this.emit("sixteenthStampPlacementsChanged"),s("debug",`Added sixteenth stamp ${i} at canvas-space ${r}-${a},${o}`,{sixteenthStampId:i,startColumn:r,endColumn:a,row:o,placementId:u.id}),u},removeSixteenthStampPlacement(i){const r=this.state.sixteenthStampPlacements.findIndex(A=>A.id===i);if(r===-1)return!1;const o=this.state.sixteenthStampPlacements.splice(r,1)[0];return o?(this.emit("sixteenthStampPlacementsChanged"),s("debug",`Removed sixteenth stamp ${o.sixteenthStampId} at ${o.startColumn}-${o.endColumn},${o.row}`,{placementId:i,sixteenthStampId:o.sixteenthStampId,startColumn:o.startColumn,endColumn:o.endColumn,row:o.row}),!0):!1},eraseSixteenthStampsInArea(i,r,o,A){const a=[];for(const c of this.state.sixteenthStampPlacements){const u=c.startColumn<=r&&c.endColumn>=i,d=c.row>=o&&c.row<=A;u&&d&&a.push(c.id)}let l=!1;return a.forEach(c=>{this.removeSixteenthStampPlacement(c)&&(l=!0)}),l},getAllSixteenthStampPlacements(){return[...this.state.sixteenthStampPlacements]},getSixteenthStampAt(i,r){return this.state.sixteenthStampPlacements.find(o=>o.row===r&&i>=o.startColumn&&i<o.endColumn)||null},clearAllSixteenthStamps(){const i=this.state.sixteenthStampPlacements.length>0;this.state.sixteenthStampPlacements=[],i&&(this.emit("sixteenthStampPlacementsChanged"),s("info","Cleared all sixteenth stamp placements"))},getSixteenthStampPlaybackData(){return this.state.sixteenthStampPlacements.map(i=>{const r=this.state.fullRowData[i.row];return{sixteenthStampId:i.sixteenthStampId,column:i.startColumn,startColumn:i.startColumn,endColumn:i.endColumn,row:i.row,pitch:(r==null?void 0:r.toneNote)||"",color:i.color,placement:i}}).filter(i=>i.pitch)},updateSixteenthStampShapeOffset(i,r,o){const A=this.state.sixteenthStampPlacements.find(a=>a.id===i);if(!A){s("warn","[SIXTEENTH STAMP SHAPE OFFSET] Placement not found",{placementId:i});return}A.shapeOffsets||(A.shapeOffsets={}),s("debug","[SIXTEENTH STAMP SHAPE OFFSET] Updating shape offset",{placementId:i,shapeKey:r,oldOffset:A.shapeOffsets[r]||0,newOffset:o,baseRow:A.row,targetRow:A.row+o}),A.shapeOffsets[r]=o,this.emit("sixteenthStampPlacementsChanged")},getSixteenthStampShapeRow(i,r){var A;const o=((A=i.shapeOffsets)==null?void 0:A[r])||0;return i.row+o}}}function D_(){return`triplet-stamp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function L_(n={}){const{canvasToTime:t,timeToCanvas:e,getColumnMap:s,log:i=()=>{}}=n;return{addTripletStampPlacement(r){this.state.tripletStampPlacements||(this.state.tripletStampPlacements=[]);const o=r.startTimeIndex+r.span*2,A=this.state.tripletStampPlacements.find(l=>l.row!==r.row?!1:!(l.startTimeIndex+l.span*2<=r.startTimeIndex||o<=l.startTimeIndex));if(A&&this.removeTripletStampPlacement(A.id),this.state.sixteenthStampPlacements&&t&&s){const l=s(this.state);this.state.sixteenthStampPlacements.filter(u=>{if(u.row!==r.row)return!1;const d=t(u.startColumn,l);return d===null?!0:!(d+2<=r.startTimeIndex||d>=o)}).forEach(u=>{this.removeSixteenthStampPlacement&&this.removeSixteenthStampPlacement(u.id)})}const a={id:D_(),...r,shapeOffsets:r.shapeOffsets||{}};return this.state.tripletStampPlacements.push(a),this.emit("tripletStampPlacementsChanged"),this.emit("rhythmStructureChanged"),i("debug",`Added triplet stamp ${r.tripletStampId} at time ${r.startTimeIndex}, row ${r.row}`,{tripletStampId:r.tripletStampId,startTimeIndex:r.startTimeIndex,span:r.span,row:r.row,placementId:a.id}),a},removeTripletStampPlacement(r){if(!this.state.tripletStampPlacements)return!1;const o=this.state.tripletStampPlacements.findIndex(a=>a.id===r);if(o===-1)return!1;const A=this.state.tripletStampPlacements.splice(o,1)[0];return A?(this.emit("tripletStampPlacementsChanged"),i("debug",`Removed triplet stamp ${A.tripletStampId} at time ${A.startTimeIndex}, row ${A.row}`,{placementId:r,tripletStampId:A.tripletStampId,startTimeIndex:A.startTimeIndex,span:A.span,row:A.row}),!0):!1},eraseTripletStampsInArea(r,o,A,a){if(!this.state.tripletStampPlacements||!e||!s)return!1;const l=s(this.state),c=[];for(const d of this.state.tripletStampPlacements)if(d.row>=A&&d.row<=a){const p=d.span*2,f=e(d.startTimeIndex,l);f+p-1<r||f>o||c.push(d.id)}let u=!1;return c.forEach(d=>{this.removeTripletStampPlacement(d)&&(u=!0)}),u},getAllTripletStampPlacements(){return[...this.state.tripletStampPlacements||[]]},getTripletStampAt(r,o){return this.state.tripletStampPlacements&&this.state.tripletStampPlacements.find(A=>A.row===o&&r>=A.startTimeIndex&&r<A.startTimeIndex+A.span*2)||null},clearAllTripletStamps(){if(!this.state.tripletStampPlacements)return;const r=this.state.tripletStampPlacements.length>0;this.state.tripletStampPlacements=[],r&&(this.emit("tripletStampPlacementsChanged"),i("info","Cleared all triplet stamp placements"))},getTripletStampPlaybackData(){return this.state.tripletStampPlacements?this.state.tripletStampPlacements.map(r=>{const o=this.state.fullRowData[r.row];return{startTimeIndex:r.startTimeIndex,tripletStampId:r.tripletStampId,row:r.row,pitch:(o==null?void 0:o.toneNote)??"",color:r.color,span:r.span,placement:r}}).filter(r=>r.pitch):[]},updateTripletStampShapeOffset(r,o,A){var l;const a=(l=this.state.tripletStampPlacements)==null?void 0:l.find(c=>c.id===r);if(!a){i("warn","[TRIPLET STAMP SHAPE OFFSET] Placement not found",{placementId:r});return}a.shapeOffsets||(a.shapeOffsets={}),i("debug","[TRIPLET STAMP SHAPE OFFSET] Updating shape offset",{placementId:r,shapeKey:o,oldOffset:a.shapeOffsets[o]||0,newOffset:A,baseRow:a.row,targetRow:a.row+A}),a.shapeOffsets[o]=A,this.emit("tripletStampPlacementsChanged")},getTripletStampShapeRow(r,o){var a;const A=((a=r.shapeOffsets)==null?void 0:a[o])||0;return r.row+A}}}const gm={COMPRESSION_2_3:2/3,EXPANSION_3_2:3/2};function k_(n,t,e=null,s=null,i=null){return{id:`mod_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,measureIndex:n,ratio:t,active:!0,xPosition:e,columnIndex:s,macrobeatIndex:i}}const wm=new Array(19).fill(2),R_=["anacrusis","anacrusis","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid"],vm=new Array(16).fill(2),H_=["dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed"];function Bm(n,t){const e=t(n),s=new Map;e.entries.forEach(i=>{i.type==="tonic"&&i.tonicSignUuid&&typeof i.canvasIndex=="number"&&s.set(i.tonicSignUuid,i.canvasIndex)}),Object.entries(n.tonicSignGroups||{}).forEach(([i,r])=>{const o=s.get(i);o!==void 0&&r.forEach(A=>{A.columnIndex=o})})}const O_={entries:[],visualToCanvas:new Map,visualToTime:new Map,canvasToVisual:new Map,canvasToTime:new Map,timeToCanvas:new Map,timeToVisual:new Map,macrobeatBoundaries:[],totalVisualColumns:0,totalCanvasColumns:0,totalTimeColumns:0,totalWidthUnmodulated:0};function V_(n={}){const{getColumnMap:t=()=>O_,visualToTimeIndex:e=()=>null,timeIndexToVisualColumn:s=()=>null,getTimeBoundaryAfterMacrobeat:i=()=>0,log:r=()=>{}}=n;return{setAnacrusis(o){var f,m,g;if(this.state.hasAnacrusis===o)return;const A=[...this.state.macrobeatGroupings],a=[...this.state.macrobeatBoundaryStyles],l=A.reduce((w,B)=>w+B,0);let c,u;if(o){const w=this._anacrusisCache,B=wm.length-vm.length,b=wm.slice(0,B),_=R_.slice(0,B),v=(f=w==null?void 0:w.groupings)!=null&&f.length?[...w.groupings]:[...b],C=(m=w==null?void 0:w.boundaryStyles)!=null&&m.length?[...w.boundaryStyles]:[..._];if(c=[...v,...A],u=[...C,...a],!((g=w==null?void 0:w.boundaryStyles)!=null&&g.length))for(let y=0;y<C.length;y++)u[y]=y<C.length-1?"anacrusis":"solid";this._anacrusisCache=null,r("debug","rhythmActions","Enabled anacrusis",{insertedCount:v.length,insertedColumns:v.reduce((y,S)=>y+S,0)},"state")}else{const w=a.findIndex(v=>v==="solid");let B=0;if(w!==-1)B=w+1;else for(;B<a.length&&a[B]==="anacrusis";)B++;B=Math.min(B,A.length);const b=A.slice(0,B),_=a.slice(0,B);B>0?this._anacrusisCache={groupings:b,boundaryStyles:_}:this._anacrusisCache=null,c=A.slice(B),u=a.slice(B).map(v=>v==="anacrusis"?"dashed":v),c.length===0&&(c=[...vm],u=[...H_]),r("debug","rhythmActions","Disabled anacrusis",{removalCount:B,removedColumns:b.reduce((v,C)=>v+C,0)},"state")}const p=c.reduce((w,B)=>w+B,0)-l;if(this.state.hasAnacrusis=o,this.state.macrobeatGroupings=[...c],this.state.macrobeatBoundaryStyles=[...u],Bm(this.state,t),p!==0){const w=[];this.state.placedNotes.forEach(C=>{const y=e(this.state,C.startColumnIndex,A),S=e(this.state,C.endColumnIndex,A);if(y===null||S===null)return;const F=y+p,x=S+p;if(F<0){w.push(C);return}const Q=s(this.state,F,c),T=s(this.state,x,c);if(Q===null||T===null){w.push(C);return}C.startColumnIndex=Q,C.endColumnIndex=T}),w.forEach(C=>{const y=this.state.placedNotes.indexOf(C);y>-1&&this.state.placedNotes.splice(y,1)});const B=[];this.state.sixteenthStampPlacements.forEach(C=>{const y=e(this.state,C.startColumn,A),S=e(this.state,C.endColumn,A);if(y===null||S===null)return;const F=y+p,x=S+p;if(F<0){B.push(C);return}const Q=s(this.state,F,c),T=s(this.state,x,c);if(Q===null||T===null){B.push(C);return}C.startColumn=Q,C.endColumn=T}),B.forEach(C=>{const y=this.state.sixteenthStampPlacements.indexOf(C);y>-1&&this.state.sixteenthStampPlacements.splice(y,1)});const b=[];this.state.tripletStampPlacements&&(this.state.tripletStampPlacements.forEach(C=>{const y=C.startTimeIndex+p;y<0?b.push(C):C.startTimeIndex=y}),b.forEach(C=>{const y=this.state.tripletStampPlacements.indexOf(C);y>-1&&this.state.tripletStampPlacements.splice(y,1)}));const _=[],v=o?c.length-A.length:-(A.length-c.length);this.state.modulationMarkers.forEach(C=>{const y=C.measureIndex+v;if(y<0){_.push(C);return}C.measureIndex=y,C.columnIndex=null,C.xPosition=null,C.macrobeatIndex=null}),_.forEach(C=>{const y=this.state.modulationMarkers.indexOf(C);y>-1&&this.state.modulationMarkers.splice(y,1)})}this.emit("anacrusisChanged",o),this.emit("notesChanged"),this.emit("sixteenthStampPlacementsChanged"),this.emit("tripletStampPlacementsChanged"),this.emit("modulationMarkersChanged"),this.emit("rhythmStructureChanged"),this.recordState()},toggleMacrobeatGrouping(o){if(o===void 0||o<0||o>=this.state.macrobeatGroupings.length){r("error","rhythmActions",`Invalid index for toggleMacrobeatGrouping: ${o}`,null,"state");return}const A=[...this.state.macrobeatGroupings],a=A[o],l=a===2?3:2,c=l-a,u=[...A];u[o]=l;const d=i(this.state,o,A),p=[];this.state.placedNotes.forEach(f=>{const m=e(this.state,f.startColumnIndex,A),g=e(this.state,f.endColumnIndex,A);if(!(m===null||g===null)&&m>=d){const w=m+c,B=g+c,b=s(this.state,w,u),_=s(this.state,B,u);b!==null&&_!==null?(f.startColumnIndex=b,f.endColumnIndex=_):p.push(f)}}),p.length&&p.forEach(f=>{const m=this.state.placedNotes.indexOf(f);m>-1&&this.state.placedNotes.splice(m,1)}),this.state.macrobeatGroupings=u,Bm(this.state,t),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},cycleMacrobeatBoundaryStyle(o){if(o===void 0||o<0||o>=this.state.macrobeatBoundaryStyles.length){r("error","rhythmActions",`Invalid index for cycleMacrobeatBoundaryStyle: ${o}`,null,"state");return}const A=this._isBoundaryInAnacrusis(o);let a;A?a=["dashed","solid","anacrusis"]:a=["dashed","solid"];const l=this.state.macrobeatBoundaryStyles[o]??"dashed",c=a.indexOf(l),u=c===-1?0:(c+1)%a.length,d=a[u]??"dashed";this.state.macrobeatBoundaryStyles[o]=d,this.emit("rhythmStructureChanged"),this.recordState()},_isBoundaryInAnacrusis(o){if(!this.state.hasAnacrusis)return!1;for(let A=0;A<=o;A++)if(this.state.macrobeatBoundaryStyles[A]==="solid")return A===o;return!0},increaseMacrobeatCount(){this.state.macrobeatGroupings.push(2),this.state.macrobeatBoundaryStyles.push("dashed"),this.emit("rhythmStructureChanged"),this.recordState()},decreaseMacrobeatCount(){if(this.state.macrobeatGroupings.length>1){const o=this.state.macrobeatGroupings.length-1,A=i(this.state,o-1,this.state.macrobeatGroupings),a=[];this.state.placedNotes.forEach(u=>{const d=e(this.state,u.startColumnIndex,this.state.macrobeatGroupings);d!==null&&d>=A&&a.push(u)}),a.forEach(u=>{const d=this.state.placedNotes.indexOf(u);d>-1&&this.state.placedNotes.splice(d,1)});const l=[];this.state.sixteenthStampPlacements.forEach(u=>{const d=e(this.state,u.startColumn,this.state.macrobeatGroupings);d!==null&&d>=A&&l.push(u)}),l.forEach(u=>{const d=this.state.sixteenthStampPlacements.indexOf(u);d>-1&&this.state.sixteenthStampPlacements.splice(d,1)});const c=[];this.state.tripletStampPlacements&&(this.state.tripletStampPlacements.forEach(u=>{u.startTimeIndex>=A&&c.push(u)}),c.forEach(u=>{const d=this.state.tripletStampPlacements.indexOf(u);d>-1&&this.state.tripletStampPlacements.splice(d,1)})),this.state.macrobeatGroupings.pop(),this.state.macrobeatBoundaryStyles.pop(),a.length>0&&this.emit("notesChanged"),l.length>0&&this.emit("sixteenthStampPlacementsChanged"),c.length>0&&this.emit("tripletStampPlacementsChanged"),this.emit("rhythmStructureChanged"),this.recordState()}},updateTimeSignature(o,A){if(!Array.isArray(A)||A.length===0){r("error","rhythmActions","Invalid groupings provided to updateTimeSignature",null,"state");return}let a=0,l=0,c=0;for(let b=0;b<this.state.macrobeatGroupings.length;b++){if(c===o){a=b;break}const _=b===this.state.macrobeatGroupings.length-1;(this.state.macrobeatBoundaryStyles[b]==="solid"||_)&&c++}c=0;for(let b=0;b<this.state.macrobeatGroupings.length;b++)if(c===o){const _=b===this.state.macrobeatGroupings.length-1;if(this.state.macrobeatBoundaryStyles[b]==="solid"||_){l=b;break}}else if(c<o){const _=b===this.state.macrobeatGroupings.length-1;(this.state.macrobeatBoundaryStyles[b]==="solid"||_)&&c++}const u=l-a+1,d=A.length,p=this.state.macrobeatGroupings.slice(a,l+1).reduce((b,_)=>b+_,0),m=A.reduce((b,_)=>b+_,0)-p,g=i(this.state,l,this.state.macrobeatGroupings);if(m!==0){const b=(()=>{const v=[...this.state.macrobeatGroupings];return v.splice(a,u,...A),v})(),_=[];this.state.placedNotes.forEach(v=>{const C=e(this.state,v.startColumnIndex,this.state.macrobeatGroupings),y=e(this.state,v.endColumnIndex,this.state.macrobeatGroupings);if(!(C===null||y===null)&&C>=g){const S=C+m,F=y+m,x=s(this.state,S,b),Q=s(this.state,F,b);x!==null&&Q!==null?(v.startColumnIndex=x,v.endColumnIndex=Q):_.push(v)}}),_.length&&_.forEach(v=>{const C=this.state.placedNotes.indexOf(v);C>-1&&this.state.placedNotes.splice(C,1)})}const w=[...A],B=new Array(Math.max(d-1,0)).fill("dashed");if(l<this.state.macrobeatBoundaryStyles.length){const b=this.state.macrobeatBoundaryStyles[l]??"dashed";B.push(b)}this.state.macrobeatGroupings.splice(a,u,...w),this.state.macrobeatBoundaryStyles.splice(a,u-1,...B),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},addModulationMarker(o,A,a=null,l=null,c=null){if(!Object.values(gm).includes(A))return r("error","rhythmActions",`Invalid modulation ratio: ${A}`,null,"state"),null;const u=this.state.modulationMarkers.findIndex(p=>p.measureIndex===o||c!==null&&p.macrobeatIndex===c||l!==null&&p.columnIndex===l);if(u!==-1){const p=this.state.modulationMarkers[u];return r("info","rhythmActions",`Replacing existing modulation marker ${p.id} at measure ${o} (old ratio: ${p.ratio}, new ratio: ${A})`,null,"state"),p.ratio=A,p.xPosition=a,l!==null&&(p.columnIndex=l),c!==null&&(p.macrobeatIndex=c),this.emit("modulationMarkersChanged"),this.recordState(),p.id}const d=k_(o,A,a,l,c);return this.state.modulationMarkers.push(d),this.state.modulationMarkers.sort((p,f)=>p.measureIndex-f.measureIndex),this.emit("modulationMarkersChanged"),this.recordState(),r("info","rhythmActions",`Added modulation marker ${d.id} at measure ${o} with ratio=${A}, columnIndex=${l}`,null,"state"),d.id},removeModulationMarker(o){const A=this.state.modulationMarkers.findIndex(a=>a.id===o);if(A===-1){r("warn","rhythmActions",`Modulation marker not found: ${o}`,null,"state");return}this.state.modulationMarkers.splice(A,1),this.emit("modulationMarkersChanged"),this.recordState(),r("info","rhythmActions",`Removed modulation marker ${o}`,null,"state")},setModulationRatio(o,A){if(!Object.values(gm).includes(A)){r("error","rhythmActions",`Invalid modulation ratio: ${A}`,null,"state");return}const a=this.state.modulationMarkers.find(l=>l.id===o);if(!a){r("warn","rhythmActions",`Modulation marker not found: ${o}`,null,"state");return}a.ratio=A,this.emit("modulationMarkersChanged"),this.recordState(),r("info","rhythmActions",`Updated modulation marker ${o} ratio to ${A}`,null,"state")},moveModulationMarker(o,A){const a=this.state.modulationMarkers.find(l=>l.id===o);if(!a){r("warn","rhythmActions",`Modulation marker not found: ${o}`,null,"state");return}a.measureIndex=A,this.state.modulationMarkers.sort((l,c)=>l.measureIndex-c.measureIndex),this.emit("modulationMarkersChanged"),this.recordState(),r("info","rhythmActions",`Moved modulation marker ${o} to measure ${A}`,null,"state")},toggleModulationMarker(o){const A=this.state.modulationMarkers.find(a=>a.id===o);if(!A){r("warn","rhythmActions",`Modulation marker not found: ${o}`,null,"state");return}A.active=!A.active,this.emit("modulationMarkersChanged"),this.recordState(),r("info","rhythmActions",`Toggled modulation marker ${o} active state to ${A.active}`,null,"state")},clearModulationMarkers(){const o=this.state.modulationMarkers.length;this.state.modulationMarkers=[],this.emit("modulationMarkersChanged"),this.recordState(),r("info","rhythmActions",`Cleared ${o} modulation markers`,null,"state")}}}function Cm(n){const t=JSON.parse(JSON.stringify(n));for(const e in t){const s=t[e];s.coeffs&&typeof s.coeffs=="object"&&!Array.isArray(s.coeffs)?s.coeffs=new Float32Array(Object.values(s.coeffs)):Array.isArray(s.coeffs)&&(s.coeffs=new Float32Array(s.coeffs)),s.phases&&typeof s.phases=="object"&&!Array.isArray(s.phases)?s.phases=new Float32Array(Object.values(s.phases)):Array.isArray(s.phases)&&(s.phases=new Float32Array(s.phases))}return t}function W_(n,t){if(n)try{const e=n.getItem(t);if(e===null)return;const s=JSON.parse(e);if(s.timbres)for(const i in s.timbres){const r=s.timbres[i];if(r.coeffs&&typeof r.coeffs=="object"){const o=Array.isArray(r.coeffs)?r.coeffs:Object.values(r.coeffs);r.coeffs=new Float32Array(o)}if(r.phases&&typeof r.phases=="object"){const o=Array.isArray(r.phases)?r.phases:Object.values(r.phases);r.phases=new Float32Array(o)}}if(s.pitchRange){const i=Pn.length,r=Math.max(0,i-1),o=Math.max(0,Math.min(r,s.pitchRange.topIndex??0)),A=Math.max(o,Math.min(r,s.pitchRange.bottomIndex??r));s.pitchRange={topIndex:o,bottomIndex:A}}if("playheadMode"in s){const i=s.playheadMode;i!=="cursor"&&i!=="microbeat"&&i!=="macrobeat"&&delete s.playheadMode}return s.fullRowData=[...Pn],s}catch{return}}function G_(n,t,e){var s;if(t)try{const i=JSON.parse(JSON.stringify({placedNotes:n.placedNotes,placedChords:n.placedChords,tonicSignGroups:n.tonicSignGroups,sixteenthStampPlacements:n.sixteenthStampPlacements,tripletStampPlacements:n.tripletStampPlacements,timbres:n.timbres,macrobeatGroupings:n.macrobeatGroupings,macrobeatBoundaryStyles:n.macrobeatBoundaryStyles,hasAnacrusis:n.hasAnacrusis,baseMicrobeatPx:n.baseMicrobeatPx,modulationMarkers:n.modulationMarkers,tempo:n.tempo,activeChordIntervals:n.activeChordIntervals,selectedNote:n.selectedNote,annotations:n.annotations,pitchRange:n.pitchRange,degreeDisplayMode:n.degreeDisplayMode,showOctaveLabels:n.showOctaveLabels,longNoteStyle:n.longNoteStyle,playheadMode:n.playheadMode}));if(n.timbres)for(const o in n.timbres){const A=n.timbres[o],a=(s=i.timbres)==null?void 0:s[o];A!=null&&A.coeffs&&a&&(a.coeffs=Array.from(A.coeffs)),A!=null&&A.phases&&a&&(a.phases=Array.from(A.phases))}const r=JSON.stringify(i);t.setItem(e,r)}catch{}}function K_(n={}){const{storageKey:t="studentNotationState",storage:e,initialState:s,onClearState:i,noteActionCallbacks:r={},sixteenthStampActionCallbacks:o={},tripletStampActionCallbacks:A={},rhythmActionCallbacks:a={}}=n,l={},c=W_(e,t),u=!c,f={state:{...M_(),...c,...s},isColdStart:u,on(m,g){l[m]||(l[m]=[]),l[m].push(g)},off(m,g){if(l[m]){const w=l[m].indexOf(g);w>-1&&l[m].splice(w,1)}},emit(m,g){l[m]&&l[m].forEach(w=>{try{w(g)}catch(B){console.error(`Error in listener for event "${m}"`,B)}})},dispose(){for(const m in l)delete l[m]},saveState(){G_(f.state,e,t)},recordState(){f.state.history=f.state.history.slice(0,f.state.historyIndex+1);const m=JSON.parse(JSON.stringify(f.state.timbres)),g={notes:JSON.parse(JSON.stringify(f.state.placedNotes)),tonicSignGroups:JSON.parse(JSON.stringify(f.state.tonicSignGroups)),placedChords:JSON.parse(JSON.stringify(f.state.placedChords)),sixteenthStampPlacements:JSON.parse(JSON.stringify(f.state.sixteenthStampPlacements)),tripletStampPlacements:JSON.parse(JSON.stringify(f.state.tripletStampPlacements||[])),timbres:m,annotations:f.state.annotations?JSON.parse(JSON.stringify(f.state.annotations)):[],lassoSelection:JSON.parse(JSON.stringify(f.state.lassoSelection))};f.state.history.push(g),f.state.historyIndex++,f.emit("historyChanged"),f.saveState()},undo(){var m;if(f.state.historyIndex>0){f.state.historyIndex--;const g=f.state.history[f.state.historyIndex];if(!g)return;f.state.placedNotes=JSON.parse(JSON.stringify(g.notes)),f.state.tonicSignGroups=JSON.parse(JSON.stringify(g.tonicSignGroups)),f.state.sixteenthStampPlacements=JSON.parse(JSON.stringify(g.sixteenthStampPlacements||[])),f.state.tripletStampPlacements=JSON.parse(JSON.stringify(g.tripletStampPlacements||[])),f.state.timbres=Cm(g.timbres),f.state.annotations=g.annotations?JSON.parse(JSON.stringify(g.annotations)):[],f.emit("notesChanged"),f.emit("sixteenthStampPlacementsChanged"),f.emit("tripletStampPlacementsChanged"),f.emit("rhythmStructureChanged"),(m=f.state.selectedNote)!=null&&m.color&&f.emit("timbreChanged",f.state.selectedNote.color),f.emit("annotationsChanged"),f.emit("historyChanged")}},redo(){var m;if(f.state.historyIndex<f.state.history.length-1){f.state.historyIndex++;const g=f.state.history[f.state.historyIndex];if(!g)return;f.state.placedNotes=JSON.parse(JSON.stringify(g.notes)),f.state.tonicSignGroups=JSON.parse(JSON.stringify(g.tonicSignGroups)),f.state.sixteenthStampPlacements=JSON.parse(JSON.stringify(g.sixteenthStampPlacements||[])),f.state.tripletStampPlacements=JSON.parse(JSON.stringify(g.tripletStampPlacements||[])),f.state.timbres=Cm(g.timbres),f.state.annotations=g.annotations?JSON.parse(JSON.stringify(g.annotations)):[],f.emit("notesChanged"),f.emit("sixteenthStampPlacementsChanged"),f.emit("tripletStampPlacementsChanged"),f.emit("rhythmStructureChanged"),(m=f.state.selectedNote)!=null&&m.color&&f.emit("timbreChanged",f.state.selectedNote.color),f.emit("annotationsChanged"),f.emit("historyChanged")}},clearSavedState(){e&&(e.removeItem(t),e.removeItem("effectDialValues")),i&&i()},setPlaybackState(m,g){f.state.isPlaying=m,f.state.isPaused=g,f.emit("playbackStateChanged",{isPlaying:m,isPaused:g})},setLooping(m){f.state.isLooping=m,f.emit("loopingChanged",m)},setTempo(m){f.state.tempo=m,f.emit("tempoChanged",m)},setPlayheadMode(m){f.state.playheadMode=m,f.emit("playheadModeChanged",m)},setSelectedTool(m,g){const w=f.state.selectedTool;if(f.state.previousTool=w,f.state.selectedTool=m,g!==void 0){const B=typeof g=="string"?parseInt(g,10):g;isNaN(B)||(f.state.selectedToolTonicNumber=B)}f.emit("toolChanged",{newTool:m,oldTool:w})},setSelectedNote(m,g){const w={...f.state.selectedNote};f.state.selectedNote={shape:m,color:g},f.emit("noteChanged",{newNote:f.state.selectedNote,oldNote:w})},setPitchRange(m){f.state.pitchRange={...f.state.pitchRange,...m},f.emit("pitchRangeChanged",f.state.pitchRange)},setDegreeDisplayMode(m){f.state.degreeDisplayMode=m,f.emit("degreeDisplayModeChanged",m)},setLongNoteStyle(m){f.state.longNoteStyle=m,f.emit("longNoteStyleChanged",m)},toggleAccidentalMode(m){f.state.accidentalMode[m]=!f.state.accidentalMode[m],f.emit("accidentalModeChanged",f.state.accidentalMode)},toggleFrequencyLabels(){f.state.showFrequencyLabels=!f.state.showFrequencyLabels,f.emit("frequencyLabelsChanged",f.state.showFrequencyLabels)},toggleOctaveLabels(){f.state.showOctaveLabels=!f.state.showOctaveLabels,f.emit("octaveLabelsChanged",f.state.showOctaveLabels)},toggleFocusColours(){f.state.focusColours=!f.state.focusColours,f.emit("focusColoursChanged",f.state.focusColours)},toggleWaveformExtendedView(){f.state.waveformExtendedView=!f.state.waveformExtendedView,f.emit("waveformExtendedViewChanged",f.state.waveformExtendedView)},setLayoutConfig(m){m.cellWidth!==void 0&&(f.state.cellWidth=m.cellWidth),m.cellHeight!==void 0&&(f.state.cellHeight=m.cellHeight),m.columnWidths!==void 0&&(f.state.columnWidths=m.columnWidths),f.emit("layoutConfigChanged",m)},setDeviceProfile(m){f.state.deviceProfile={...f.state.deviceProfile,...m},f.emit("deviceProfileChanged",f.state.deviceProfile)},setPrintPreviewActive(m){f.state.isPrintPreviewActive=m,f.emit("printPreviewStateChanged",m)},setPrintOptions(m){f.state.printOptions={...f.state.printOptions,...m},f.emit("printOptionsChanged",f.state.printOptions)},setAdsrTimeAxisScale(m){f.state.adsrTimeAxisScale=m,f.emit("adsrTimeAxisScaleChanged",m)},setAdsrComponentWidth(){},shiftGridUp(){},shiftGridDown(){},setGridPosition(){},setKeySignature(m){f.state.keySignature=m,f.emit("keySignatureChanged",m)},setActiveChordIntervals(m){f.state.activeChordIntervals=m,f.emit("activeChordIntervalsChanged",m)},setIntervalsInversion(m){f.state.isIntervalsInverted=m,f.emit("intervalsInversionChanged",m)},setChordPosition(m){f.state.chordPositionState=m,f.emit("chordPositionChanged",m)},setADSR(m,g){f.state.timbres[m]&&(f.state.timbres[m].adsr={...f.state.timbres[m].adsr,...g},f.emit("timbreChanged",m))},setHarmonicCoefficients(m,g){f.state.timbres[m]&&(f.state.timbres[m].coeffs=g,f.emit("timbreChanged",m))},setHarmonicPhases(m,g){f.state.timbres[m]&&(f.state.timbres[m].phases=g,f.emit("timbreChanged",m))},setFilterSettings(m,g){f.state.timbres[m]&&(f.state.timbres[m].filter={...f.state.timbres[m].filter,...g},f.emit("timbreChanged",m))},applyPreset(m,g){f.state.timbres[m]&&(Object.assign(f.state.timbres[m],g),f.emit("timbreChanged",m))},...U_(r),...N_(o),...L_(A),...V_(a)};return e&&(f.on("tempoChanged",()=>f.saveState()),f.on("degreeDisplayModeChanged",()=>f.saveState()),f.on("longNoteStyleChanged",()=>f.saveState()),f.on("playheadModeChanged",()=>f.saveState())),u&&e&&f.saveState(),f}class q_ extends Fo{constructor(e){super(e);I(this,"presetGain");I(this,"vibratoLFO");I(this,"vibratoDepth");I(this,"vibratoGain");I(this,"tremoloLFO");I(this,"tremoloDepth");I(this,"tremoloGain");I(this,"hpFilter");I(this,"lpFilterForBP");I(this,"lpFilterSolo");I(this,"hpOutput");I(this,"bpOutput");I(this,"lpOutput");I(this,"hp_bp_fade");I(this,"main_fade");I(this,"wetDryFade");this.presetGain=new Tt(e.gain||1),this.vibratoLFO=new sc(0,0),this.vibratoDepth=new WA(-1,1),this.vibratoGain=new Tt(0),this.vibratoLFO.connect(this.vibratoDepth),this.vibratoDepth.connect(this.vibratoGain),this.vibratoGain.connect(this.oscillator.frequency),this.tremoloLFO=new sc(0,0),this.tremoloDepth=new WA(0,1),this.tremoloGain=new Tt(1),this.tremoloLFO.connect(this.tremoloDepth),this.tremoloDepth.connect(this.tremoloGain.gain),this.hpFilter=new gA({type:"highpass"}),this.lpFilterForBP=new gA({type:"lowpass"}),this.lpFilterSolo=new gA({type:"lowpass"}),this.hpOutput=new Tt,this.bpOutput=new Tt,this.lpOutput=new Tt,this.hp_bp_fade=new uo(0),this.main_fade=new uo(0),this.wetDryFade=new uo(0),this.oscillator.connect(this.presetGain),this.presetGain.connect(this.wetDryFade.a),this.presetGain.connect(this.hpFilter),this.hpFilter.connect(this.hpOutput),this.hpFilter.connect(this.lpFilterForBP),this.lpFilterForBP.connect(this.bpOutput),this.presetGain.connect(this.lpFilterSolo),this.lpFilterSolo.connect(this.lpOutput),this.hpOutput.connect(this.hp_bp_fade.a),this.bpOutput.connect(this.hp_bp_fade.b),this.lpOutput.connect(this.main_fade.b),this.hp_bp_fade.connect(this.main_fade.a),this.main_fade.connect(this.wetDryFade.b),this.wetDryFade.connect(this.tremoloGain),this.tremoloGain.connect(this.envelope),e.filter&&this._setFilter(e.filter),e.vibrato?this._setVibrato(e.vibrato):this._setVibrato({speed:0,span:0}),e.tremelo?this._setTremolo(e.tremelo):this._setTremolo({speed:0,span:0})}_setPresetGain(e){this.presetGain&&(this.presetGain.gain.value=e)}_setVibrato(e,s=de()){var p,f;if(!this.vibratoLFO||!this.vibratoGain)return;const i=e.speed/100*16,o=(((f=(p=ke())==null?void 0:p.rawContext)==null?void 0:f.state)??GA.state)==="running";if(e.speed===0||e.span===0){o&&this.vibratoLFO.state==="started"&&this.vibratoLFO.stop(s),this.vibratoLFO.frequency.value=0,this.vibratoGain.gain.value=0;return}o&&this.vibratoLFO.state!=="started"&&this.vibratoLFO.start(s),this.vibratoLFO.frequency.value=i;const l=e.span/100*50/1200,d=440*(Math.pow(2,l)-1);this.vibratoGain.gain.value=d}_setTremolo(e,s=de()){var c,u;if(!this.tremoloLFO||!this.tremoloGain)return;const i=e.speed/100*16,o=(((u=(c=ke())==null?void 0:c.rawContext)==null?void 0:u.state)??GA.state)==="running";if(e.speed===0||e.span===0){o&&this.tremoloLFO.state==="started"&&this.tremoloLFO.stop(s),this.tremoloLFO.frequency.value=0,this.tremoloGain.gain.cancelScheduledValues(s),this.tremoloGain.gain.value=1;return}o&&this.tremoloLFO.state!=="started"&&this.tremoloLFO.start(s),this.tremoloLFO.frequency.value=i;const A=e.span/100,a=Math.max(0,1-A),l=1;this.tremoloDepth.min=a,this.tremoloDepth.max=l}_setFilter(e){this.wetDryFade.fade.value=e.enabled?1:0;const s=c_(e.cutoff+35).toFrequency(),i=e.resonance/100*12+.1;this.hpFilter.set({frequency:s,Q:i}),this.lpFilterForBP.set({frequency:s,Q:i}),this.lpFilterSolo.set({frequency:s,Q:i});const r=e.blend;r<=1?(this.main_fade.fade.value=0,this.hp_bp_fade.fade.value=r):(this.main_fade.fade.value=r-1,this.hp_bp_fade.fade.value=1)}}const uv={polyphonyReference:32,smoothingTauMs:200,masterGainRampMs:50,gainUpdateIntervalMs:16};function dv(n=uv.polyphonyReference){return 1/Math.sqrt(n)}class z_{constructor(t,e={}){I(this,"masterGain");I(this,"options");I(this,"perVoiceBaselineGain");I(this,"activeVoiceCount",0);I(this,"smoothedVoiceCount");I(this,"gainUpdateLoopId",null);this.masterGain=t,this.options={...uv,...e},this.perVoiceBaselineGain=dv(this.options.polyphonyReference),this.smoothedVoiceCount=this.options.polyphonyReference}start(){this.stop(),this.gainUpdateLoopId=setInterval(()=>this.updateMasterGain(),this.options.gainUpdateIntervalMs)}stop(){this.gainUpdateLoopId!==null&&(clearInterval(this.gainUpdateLoopId),this.gainUpdateLoopId=null)}noteOn(t=1){t<=0||(this.activeVoiceCount+=t)}noteOff(t=1){t<=0||(this.activeVoiceCount=Math.max(0,this.activeVoiceCount-t))}clampActiveVoiceCountToAtMost(t){Number.isFinite(t)&&(this.activeVoiceCount=Math.max(0,Math.min(this.activeVoiceCount,Math.floor(t))))}resetActiveVoiceCount(){this.activeVoiceCount=0}getActiveVoiceCount(){return this.activeVoiceCount}updateMasterGain(){const{polyphonyReference:t,smoothingTauMs:e,masterGainRampMs:s,gainUpdateIntervalMs:i}=this.options,r=de();if(this.activeVoiceCount===0){this.smoothedVoiceCount=.01*t+(1-.01)*this.smoothedVoiceCount;return}const o=i/1e3,A=1-Math.exp(-o/(e/1e3)),a=Math.max(1,this.activeVoiceCount);this.smoothedVoiceCount=A*a+(1-A)*this.smoothedVoiceCount;const l=Math.sqrt(t/this.smoothedVoiceCount),c=this.perVoiceBaselineGain*l;this.masterGain.gain.rampTo(c,s/1e3,r)}}const X_={clippingWarningThresholdDb:-3,clippingMonitorIntervalMs:500,clippingWarningCooldownMs:2e3};class $_{constructor(t,e={}){I(this,"meter");I(this,"options");I(this,"clippingMonitorId",null);I(this,"lastClippingWarningAt",0);this.meter=t,this.options={...X_,...e}}start(){this.stop(),this.lastClippingWarningAt=0,this.clippingMonitorId=setInterval(()=>{var i,r;const t=this.meter.getValue(),e=Array.isArray(t)?t[0]:t;if(e===void 0||e<=this.options.clippingWarningThresholdDb)return;const s=Date.now();s-this.lastClippingWarningAt<this.options.clippingWarningCooldownMs||(this.lastClippingWarningAt=s,(r=(i=this.options).onWarning)==null||r.call(i,e))},this.options.clippingMonitorIntervalMs)}stop(){this.clippingMonitorId!==null&&(clearInterval(this.clippingMonitorId),this.clippingMonitorId=null)}}function Y_(n){const{timbres:t,masterVolume:e=0,effectsManager:s,harmonicFilter:i,logger:r,audioInit:o,getDrumVolume:A}=n,a={};let l=null,c=null,u=null,d=null,p=null,f={},m=null,g=null;const w={...t},B=r??{debug:()=>{},info:()=>{},warn:()=>{}};function b(C){if(i)return i.getFilteredCoefficients(C);const y=w[C];return y!=null&&y.coeffs?y.coeffs:new Float32Array([0,1])}function _(C){const y=C.reduce((S,F)=>S+Math.abs(F),0);return y>1?Array.from(C).map(S=>S/y):Array.from(C)}const v={init(){this.stopBackgroundMonitors(),l=new Tt(dv()),m=new z_(l),m.start(),c=new ci(e),u=new ou({threshold:-12,ratio:3,attack:.01,release:.1,knee:6}),d=new jf(-3),p=new $f,l.connect(c),c.connect(u),u.connect(d),d.toDestination(),d.connect(p),p&&(g=new $_(p,{onWarning:C=>{B.warn("SynthEngine","Limiter input approaching clipping threshold",{level:C},"audio")}}),g.start());for(const C in w){const y=w[C];if(!y)continue;y.vibrato||(y.vibrato={speed:0,span:0}),y.tremelo||(y.tremelo={speed:0,span:0});const S=b(C),F=_(S),x=y.gain||1,Q=new Kf({voice:q_,options:{oscillator:{type:"custom",partials:F},envelope:y.adsr,filter:y.filter,vibrato:y.vibrato,tremelo:y.tremelo,gain:x}}).connect(l);s&&l&&s.applySynthEffects(Q,C,l);const T=Q.triggerAttack.bind(Q);Q.triggerAttack=function(...U){const P=T(...U);return setTimeout(()=>{const K=this._activeVoices;s?K&&K.size>0?K.forEach(M=>{M.effectsApplied||(s.applyEffectsToVoice(M,C),M.effectsApplied=!0)}):this._voices&&Array.isArray(this._voices)&&this._voices.forEach(M=>{M&&!M.effectsApplied&&(s.applyEffectsToVoice(M,C),M.effectsApplied=!0)}):K&&K.size>0?K.forEach(M=>{M._setVibrato&&M.vibratoApplied!==!0&&(M._setVibrato(this._currentVibrato),M.vibratoApplied=!0),M._setTremolo&&M.tremoloApplied!==!0&&(M._setTremolo(this._currentTremolo),M.tremoloApplied=!0)}):this._voices&&Array.isArray(this._voices)&&this._voices.forEach(M=>{M!=null&&M._setVibrato&&M.vibratoApplied!==!0&&(M._setVibrato(this._currentVibrato),M.vibratoApplied=!0),M!=null&&M._setTremolo&&M.tremoloApplied!==!0&&(M._setTremolo(this._currentTremolo),M.tremoloApplied=!0)})},10),P},Q._currentVibrato=y.vibrato,Q._currentTremolo=y.tremelo,Q._currentFilter=y.filter,a[C]=Q,B.debug("SynthEngine",`Created filtered synth for color: ${C}`,null,"audio")}B.info("SynthEngine","Initialized with multi-timbral support",null,"audio")},updateSynthForColor(C){const y=w[C],S=a[C];if(!S||!y)return;y.vibrato||(y.vibrato={speed:0,span:0}),y.tremelo||(y.tremelo={speed:0,span:0}),B.debug("SynthEngine",`Updating timbre for color ${C}`,null,"audio");const F=b(C),x=_(F);S.set({oscillator:{partials:x},envelope:y.adsr}),s&&l&&s.applySynthEffects(S,C,l),S._currentVibrato=y.vibrato,S._currentTremolo=y.tremelo,S._currentFilter=y.filter;const Q=S._activeVoices;Q&&Q.size>0?Q.forEach(T=>{if(T._setFilter&&T._setFilter(y.filter),T._setVibrato&&(T._setVibrato(y.vibrato),T.vibratoApplied=!0),T._setTremolo&&(T._setTremolo(y.tremelo),T.tremoloApplied=!0),T._setPresetGain){const U=y.gain||1;T._setPresetGain(U)}}):S._voices&&Array.isArray(S._voices)&&S._voices.forEach(T=>{if(T!=null&&T._setVibrato&&(T._setVibrato(y.vibrato),T.vibratoApplied=!0),T!=null&&T._setTremolo&&(T._setTremolo(y.tremelo),T.tremoloApplied=!0),T!=null&&T._setFilter&&T._setFilter(y.filter),T!=null&&T._setPresetGain){const U=y.gain||1;T._setPresetGain(U)}})},setBpm(C){try{dt!=null&&dt.bpm&&(dt.bpm.value=C,B.debug("SynthEngine",`Tone.Transport BPM updated to ${C}`,null,"audio"))}catch(y){B.warn("SynthEngine","Unable to update BPM on Tone.Transport",{tempo:C,error:y},"audio")}},setVolume(C){c&&(c.volume.value=C)},async playNote(C,y,S=de()){await(o||(()=>ec()))();const x=Object.keys(a);if(x.length===0)return;const[Q]=x;if(!Q)return;const T=a[Q];T&&T.triggerAttackRelease(C,y,S)},triggerAttack(C,y,S=de(),F=!1){const x=a[y];if(x)if(m==null||m.noteOn(1),F&&A){const Q=A(),T=x.volume.value,U=T+20*Math.log10(Q);x.volume.value=U,x.triggerAttack(C,S),setTimeout(()=>{x!=null&&x.volume&&(x.volume.value=T)},100)}else x.triggerAttack(C,S)},triggerAttackInteractive(C,y){v.triggerAttack(C,y,de()+.02)},quickReleasePitches(C,y){var x,Q,T;const S=a[y];if(!S||!C||C.length===0)return;let F;try{const U=typeof S.get=="function"?S.get():null,P=(x=U==null?void 0:U.envelope)==null?void 0:x.release;F=typeof P=="number"?P:void 0,S.set({envelope:{release:.01}}),C.forEach(M=>{S.triggerRelease(M,de())});const K=((Q=S._activeVoices)==null?void 0:Q.size)??((T=S._voices)==null?void 0:T.length)??(m==null?void 0:m.getActiveVoiceCount())??0;m==null||m.clampActiveVoiceCountToAtMost(K)}catch(U){B.warn("SynthEngine","quickReleasePitches failed",{err:U,color:y,pitches:C},"audio")}finally{if(F!==void 0)try{S.set({envelope:{release:F}})}catch{}}},triggerRelease(C,y,S=de()){var Q,T;const F=a[y];if(!F)return;F.triggerRelease(C,S),m==null||m.noteOff(1);const x=((Q=F._activeVoices)==null?void 0:Q.size)??((T=F._voices)==null?void 0:T.length)??(m==null?void 0:m.getActiveVoiceCount())??0;m==null||m.clampActiveVoiceCountToAtMost(x)},releaseAll(){var C;for(const y in a)(C=a[y])==null||C.releaseAll();m==null||m.resetActiveVoiceCount()},createWaveformAnalyzer(C){const y=a[C];return y?(f[C]||(f[C]=new xa("waveform",1024),y.connect(f[C]),B.debug("SynthEngine",`Created waveform analyzer for color: ${C}`,null,"waveform")),f[C]):(B.warn("SynthEngine",`No synth found for color: ${C}`,null,"audio"),null)},getWaveformAnalyzer(C){return f[C]||null},getAllWaveformAnalyzers(){const C=new Map;for(const y in f)f[y]&&C.set(y,f[y]);return C},removeWaveformAnalyzer(C){f[C]&&(f[C].dispose(),delete f[C],B.debug("SynthEngine",`Removed waveform analyzer for color: ${C}`,null,"waveform"))},disposeAllWaveformAnalyzers(){for(const C in f)f[C]&&f[C].dispose();f={},B.debug("SynthEngine","Disposed all waveform analyzers",null,"waveform")},getSynth(C){return a[C]||null},getAllSynths(){return{...a}},getMainVolumeNode(){return c||null},getMasterGainNode(){return l||null},stopBackgroundMonitors(){g==null||g.stop(),m==null||m.stop()},dispose(){var C;this.stopBackgroundMonitors(),this.disposeAllWaveformAnalyzers();for(const y in a)(C=a[y])==null||C.dispose();l==null||l.dispose(),c==null||c.dispose(),u==null||u.dispose(),d==null||d.dispose(),p==null||p.dispose(),B.debug("SynthEngine","Disposed SynthEngine",null,"audio")}};return v}const bm=1e-4;function j_(n){const{getMacrobeatInfo:t,getPlacedTonicSigns:e,getTonicSpanColumnIndices:s,updatePlayheadModel:i,logger:r}=n;let o=[],A=0,a=0,l=0;const c=r??{debug:()=>{}};function u(f){return 60/(f*2)}function d(f,m,g){let w=0;c.debug("TimeMapCalculator","[TIMEMAP] Building timeMap",{columnCount:m.length,tonicSignCount:g.length,microbeatDuration:f});const B=m.length,b=s(g);for(let _=0;_<B;_++){o[_]=w;const v=b.has(_);if(v?c.debug("TimeMapCalculator",`[TIMEMAP] Column ${_} is tonic, not advancing time`):w+=(m[_]||0)*f,_<5){const C=o[_];C!==void 0&&c.debug("TimeMapCalculator",`[TIMEMAP] timeMap[${_}] = ${C.toFixed(3)}s (isTonic: ${v})`)}}B>0&&(o[B]=w),c.debug("TimeMapCalculator",`[TIMEMAP] Complete. Total columns: ${B}, Final time: ${w.toFixed(3)}s`)}function p(f){var b;const m=o.length>0?o[o.length-1]??0:0;if(!Number.isFinite(m)||m===0){A=0;return}const g=((b=f.modulationMarkers)==null?void 0:b.filter(_=>_.active))||[];if(g.length===0){A=m;return}const w=[...g].sort((_,v)=>_.measureIndex-v.measureIndex);let B=m;for(const _ of w){const v=t(_.measureIndex);if(v){const C=v.endColumn-1,y=o[C]??m,S=m-y,F=S*_.ratio;B=B-S+F}}A=B}return{getMicrobeatDuration:u,calculate(f){var b,_;c.debug("TimeMapCalculator","calculate",{tempo:`${f.tempo} BPM`}),o=[];const m=u(f.tempo),{columnWidths:g}=f,w=e();d(m,g,w),(_=c.timing)==null||_.call(c,"TimeMapCalculator","calculate",{totalDuration:`${(b=o[o.length-1])==null?void 0:b.toFixed(2)}s`}),p(f);const B=A;i==null||i({timeMap:o,musicalEndTime:B,columnWidths:f.columnWidths,cellWidth:f.cellWidth})},getTimeMap(){return o},getMusicalEndTime(){return A},findNonAnacrusisStart(f){if(!f.hasAnacrusis)return c.debug("TimeMapCalculator","[ANACRUSIS] No anacrusis, starting from time 0"),0;for(let m=0;m<f.macrobeatBoundaryStyles.length;m++)if(f.macrobeatBoundaryStyles[m]==="solid"){const g=t(m+1);if(g){const w=o[g.startColumn]||0;return c.debug("TimeMapCalculator",`[ANACRUSIS] Found solid boundary at macrobeat ${m}, non-anacrusis starts at column ${g.startColumn}, time ${w.toFixed(3)}s`),w}}return c.debug("TimeMapCalculator","[ANACRUSIS] No solid boundary found, starting from time 0"),0},applyModulationToTime(f,m,g){var _;const w=((_=g.modulationMarkers)==null?void 0:_.filter(v=>v.active))||[];if(w.length===0)return f;const B=[...w].sort((v,C)=>v.measureIndex-C.measureIndex);let b=f;m<5&&c.debug("TimeMapCalculator",`[MODULATION] Column ${m}: baseTime ${f.toFixed(3)}s, ${B.length} active markers`);for(const v of B){const C=t(v.measureIndex);if(C){const y=C.endColumn;if(m>y){const S=o[y]!==void 0?o[y]:0,F=f-S,x=F*v.ratio;b=b-F+x,m<5&&c.debug("TimeMapCalculator",`[MODULATION] Column ${m}: Applied marker at measure ${v.measureIndex} (col ${y}), ratio ${v.ratio}, adjustedTime ${b.toFixed(3)}s`)}}}return b},setLoopBounds(f,m,g){const w=u(g),B=Math.max(w,.001),b=Number.isFinite(f)?f:0;let _=Number.isFinite(m)?m:b+B;_<=b&&(_=b+B),a=b,l=_,dt&&(dt.loopStart=b,dt.loopEnd=_)},getConfiguredLoopBounds(){return{loopStart:a,loopEnd:l}},setConfiguredLoopBounds(f,m){a=f,l=m},clearConfiguredLoopBounds(){a=0,l=0},reapplyConfiguredLoopBounds(f){if(l>a){const m=Be(dt.loopStart).toSeconds(),g=Be(dt.loopEnd).toSeconds(),w=Math.abs(m-a),B=Math.abs(g-l);(w>bm||B>bm)&&(dt.loopStart=a,dt.loopEnd=l),dt.loop!==f&&(dt.loop=f)}},updateLoopBoundsFromTimeline(f){const m=this.findNonAnacrusisStart(f),g=A;this.setLoopBounds(m,g,f.tempo)}}}const J_={H:"https://tonejs.github.io/audio/drum-samples/CR78/hihat.mp3",M:"https://tonejs.github.io/audio/drum-samples/CR78/snare.mp3",L:"https://tonejs.github.io/audio/drum-samples/CR78/kick.mp3"},Z_=1e-4;function tI(n={}){var a;const{samples:t=J_,synthEngine:e,initialVolume:s=0}=n;let i=null,r=null;const o=new Map;function A(l,c){let u=Number.isFinite(c)?c:de();const d=o.get(l)??-1/0;return u>d||(u=d+Z_),o.set(l,u),u}if(r=new ci(s),i=new su(t).connect(r),e){const l=(a=e.getMainVolumeNode)==null?void 0:a.call(e);l?r.connect(l):r.toDestination()}else r.toDestination();return{getPlayers(){return i},getVolumeNode(){return r},trigger(l,c){var d;if(!i)return;const u=A(l,c);(d=i.player(l))==null||d.start(u)},reset(){o.clear()},dispose(){i==null||i.dispose(),r==null||r.dispose(),i=null,r=null,o.clear()}}}const ym="",Sm="";function eI(n){const{synthEngine:t,stateCallbacks:e,eventCallbacks:s,visualCallbacks:i,logger:r,audioInit:o,playbackMode:A="standard"}=n,a=r??{debug:()=>{},info:()=>{},warn:()=>{}};let l=null,c=!1,u=null,d=null,p=1;const f=[];function m(x,Q){const T=Q.fullRowData[x];return T?T.toneNote.replace(ym,"b").replace(Sm,"#"):"C4"}function g(x,Q){const T=x.globalRow??x.row,U=Q.fullRowData[T];return U?U.toneNote.replace(ym,"b").replace(Sm,"#"):"C4"}function w(){var M,k,N;if(!u)return;const x=e.getState();a.debug("TransportService","scheduleNotes","Clearing previous transport events and rescheduling all notes"),dt.cancel(),d==null||d.reset(),u.calculate(x),(M=i==null?void 0:i.clearAdsrVisuals)==null||M.call(i);const Q=u.getTimeMap(),{loopEnd:T}=u.getConfiguredLoopBounds(),U=u.findNonAnacrusisStart(x);a.debug("TransportService",`[ANACRUSIS] hasAnacrusis: ${x.hasAnacrusis}, anacrusisOffset: ${U.toFixed(3)}s`),x.placedNotes.forEach((R,J)=>{const tt=R.startColumnIndex,rt=R.endColumnIndex,lt=Q[tt];if(lt===void 0){a.warn("TransportService",`[NOTE SCHEDULE] Note ${J}: timeMap[${tt}] undefined, skipping`);return}const W=u.applyModulationToTime(lt,tt,x),H=Q[rt+1];if(H===void 0){a.warn("TransportService",`Skipping note with invalid endColumnIndex: ${R.endColumnIndex+1}`);return}const $=u.applyModulationToTime(H,rt+1,x)-W;R.isDrum?B(R,W):b(R,W,$,T,x)});const P=((k=e.getStampPlaybackData)==null?void 0:k.call(e))??[];P.forEach(R=>{_(R,Q,x)});const K=((N=e.getTripletPlaybackData)==null?void 0:N.call(e))??[];K.forEach(R=>{v(R,Q,x)}),a.debug("TransportService","scheduleNotes",`Finished scheduling ${x.placedNotes.length} notes, ${P.length} stamps, and ${K.length} triplets`)}function B(x,Q){const T=e.getState();dt.schedule(U=>{if(T.isPaused)return;const P=x.drumTrack;if(P==null)return;const K=String(P);d==null||d.trigger(K,U),Qu.schedule(()=>{var M;(M=i==null?void 0:i.triggerDrumNotePop)==null||M.call(i,x.startColumnIndex,P)},U)},Q)}function b(x,Q,T,U,P){var W;const K=g(x,P),M=x.color,k=x.globalRow??x.row,N=((W=P.fullRowData[k])==null?void 0:W.hex)||"#888888",R=x.uuid,J=P.timbres[M];if(!J){a.warn("TransportService",`Timbre not found for color ${M}. Skipping note ${R}`);return}let tt=Q+T;const lt=U-.001;tt>=U&&(tt=Math.max(Q+.001,lt)),dt.schedule(H=>{e.getState().isPaused||(t.triggerAttack(K,M,H),Qu.schedule(()=>{var O;(O=i==null?void 0:i.triggerAdsrVisual)==null||O.call(i,R,"attack",N,J.adsr),s.emit("noteAttack",{noteId:R,color:M})},H))},Q),dt.schedule(H=>{t.triggerRelease(K,M,H),Qu.schedule(()=>{var O;(O=i==null?void 0:i.triggerAdsrVisual)==null||O.call(i,R,"release",N,J.adsr),s.emit("noteRelease",{noteId:R,color:M})},H)},tt)}function _(x,Q,T){var M;const U=x.column,P=Q[U];if(P===void 0)return;(((M=e.getStampScheduleEvents)==null?void 0:M.call(e,x.sixteenthStampId,x.placement))??[]).forEach(k=>{C(k,P,x.row,x.color,T)})}function v(x,Q,T){var M,k;const U=((M=e.timeToCanvas)==null?void 0:M.call(e,x.startTimeIndex,T))??x.startTimeIndex,P=Q[U];if(P===void 0)return;(((k=e.getTripletScheduleEvents)==null?void 0:k.call(e,x.tripletStampId,x.placement))??[]).forEach(N=>{C(N,P,x.row,x.color,T)})}function C(x,Q,T,U,P){const K=Be(x.offset).toSeconds(),M=Be(x.duration).toSeconds(),k=Q+K,N=k+M,R=T+x.rowOffset,J=m(R,P);dt.schedule(tt=>{e.getState().isPaused||t.triggerAttack(J,U,tt)},k),dt.schedule(tt=>{e.getState().isPaused||t.triggerRelease(J,U,tt)},N)}function y(){var k;const Q=e.getState().tempo,T=1e-4,U=.5,P=N=>(N==null?void 0:N.xPosition)??477.5,K=typeof((k=dt==null?void 0:dt.bpm)==null?void 0:k.value)=="number"?dt.bpm.value:Q;p=Q!==0?K/Q:1,c=!0;function M(){var pt,St,Mt,Et,_t,Jt,ct,Ct,vt,qt,Ge,en,Ur,Pr,Ma;if(!c||!u)return;if(dt.state==="stopped"){l=requestAnimationFrame(M);return}const N=e.getState(),R=Be(dt.loopEnd).toSeconds(),J=N.isLooping,tt=u.getMusicalEndTime(),rt=J&&R>0?R:tt,lt=dt.seconds,W=lt>=rt-.001;if(!J&&W){a.info("TransportService","Playback reached end. Stopping playhead."),F.stop();return}if(N.isPaused){l=requestAnimationFrame(M);return}const H=u.getTimeMap();(pt=i==null?void 0:i.clearPlayheadCanvas)==null||pt.call(i),(St=i==null?void 0:i.clearDrumPlayheadCanvas)==null||St.call(i);let O=lt;if(J){const cs=Be(dt.loopStart).toSeconds(),Nr=Be(dt.loopEnd).toSeconds()-cs;Nr>0&&(O=(lt-cs)%Nr+cs)}const $=((Mt=e.getCanvasWidth)==null?void 0:Mt.call(e))??1e3,L=((Et=e.getPlacedTonicSigns)==null?void 0:Et.call(e))??[],at=((_t=e.getTonicSpanColumnIndices)==null?void 0:_t.call(e,L))??new Set;let G=0,X=0,V=0,Y=-1;for(let cs=0;cs<H.length-1;cs++){const zo=H[cs],Nr=H[cs+1];if(!(zo===void 0||Nr===void 0)&&O>=zo&&O<Nr){let Dr=cs;for(;at.has(Dr)&&Dr<H.length-1;)Dr++;const Iu=((Jt=e.getColumnStartX)==null?void 0:Jt.call(e,Dr))??0,Gp=((ct=e.getColumnWidth)==null?void 0:ct.call(e,Dr))??10;if(X=Iu,V=Gp,Y=Dr,at.has(cs))G=Iu;else{const Kp=Nr-zo,Rb=O-zo,Hb=Kp>0?Rb/Kp:0;G=Iu+Hb*Gp}break}}const nt=Math.min(G,$);S(N,nt,Q,P,T,U);const D=((Ct=i==null?void 0:i.getPlayheadCanvasHeight)==null?void 0:Ct.call(i))??500,q=((vt=i==null?void 0:i.getDrumCanvasHeight)==null?void 0:vt.call(i))??100,z=N.playheadMode==="macrobeat"&&Y>=0?(qt=e.getMacrobeatHighlightRect)==null?void 0:qt.call(e,Y):null,et=(z==null?void 0:z.x)??X,Z=(z==null?void 0:z.width)??V;nt>=0&&(N.playheadMode==="macrobeat"||N.playheadMode==="microbeat"?((Ge=i==null?void 0:i.drawPlayheadHighlight)==null||Ge.call(i,et,Z,D,performance.now()),(en=i==null?void 0:i.drawDrumPlayheadHighlight)==null||en.call(i,et,Z,q,performance.now())):((Ur=i==null?void 0:i.drawPlayheadLine)==null||Ur.call(i,nt,D),(Pr=i==null?void 0:i.drawDrumPlayheadLine)==null||Pr.call(i,nt,q)));const st=N.playheadMode==="macrobeat"||N.playheadMode==="microbeat";(Ma=i==null?void 0:i.updateBeatLineHighlight)==null||Ma.call(i,et,Z,st),l=requestAnimationFrame(M)}M()}function S(x,Q,T,U,P,K){if(!u)return;const k=(Array.isArray(x.modulationMarkers)?x.modulationMarkers:[]).filter(N=>(N==null?void 0:N.active)&&typeof N.ratio=="number"&&N.ratio!==0).sort((N,R)=>U(N)-U(R));if(k.length>0){let N=1;for(const R of k){const J=U(R);if(Q+K>=J)N*=1/R.ratio;else break}if((!Number.isFinite(N)||N<=0)&&(N=1),Math.abs(N-p)>P){const R=T*N;dt.bpm.value=R,u.reapplyConfiguredLoopBounds(x.isLooping),p=N,a.debug("TransportService",`Tempo multiplier updated to ${N.toFixed(3)} (${R.toFixed(2)} BPM)`)}}else Math.abs(p-1)>P&&(dt.bpm.value=T,u.reapplyConfiguredLoopBounds(x.isLooping),p=1,a.debug("TransportService",`Tempo reset to base ${T} BPM`))}const F={init(){const x=e.getState();u=j_({getMacrobeatInfo:e.getMacrobeatInfo??(()=>null),getPlacedTonicSigns:e.getPlacedTonicSigns??(()=>[]),getTonicSpanColumnIndices:e.getTonicSpanColumnIndices??(()=>new Set),logger:a}),d=tI({samples:{H:"/audio/drums/hi.mp3",M:"/audio/drums/mid.mp3",L:"/audio/drums/lo.mp3"},synthEngine:{getMainVolumeNode:()=>t.getMainVolumeNode()}}),dt.bpm.value=x.tempo;const Q=()=>this.handleStateChange(),T=()=>this.handleStateChange(),U=()=>this.handleStateChange(),P=()=>{if(u&&u.getTimeMap().length>0){const N=e.getState();u.calculate(N)}this.handleStateChange()},K=N=>{var tt,rt;const R=((tt=N==null?void 0:N.oldConfig)==null?void 0:tt.columnWidths)||[],J=((rt=N==null?void 0:N.newConfig)==null?void 0:rt.columnWidths)||[];R.length!==J.length&&u&&u.calculate(e.getState())},M=N=>{if(a.info("TransportService",`tempoChanged triggered with new value: ${N} BPM`),dt.state==="started"){const R=dt.position;dt.pause(),l&&(cancelAnimationFrame(l),l=null),dt.bpm.value=N,u==null||u.reapplyConfiguredLoopBounds(e.getState().isLooping),w(),dt.start(void 0,R),A==="standard"&&y()}else dt.bpm.value=N,u==null||u.reapplyConfiguredLoopBounds(e.getState().isLooping),u==null||u.calculate(e.getState())},k=N=>{dt.loop=N;const R=Be(dt.loopStart).toSeconds(),J=Be(dt.loopEnd).toSeconds();N&&J<=R&&u&&(dt.loopEnd=R+Math.max(u.getMicrobeatDuration(e.getState().tempo),.001)),N&&u?u.setConfiguredLoopBounds(Be(dt.loopStart).toSeconds(),Be(dt.loopEnd).toSeconds()):u==null||u.clearConfiguredLoopBounds()};s.on("rhythmStructureChanged",Q),s.on("notesChanged",T),s.on("sixteenthStampPlacementsChanged",U),s.on("modulationMarkersChanged",P),s.on("layoutConfigChanged",K),s.on("tempoChanged",M),s.on("loopingChanged",k),f.push(()=>{}),dt.on("stop",()=>{var N,R;a.info("TransportService","Tone.Transport 'stop' fired. Resetting playback state"),(N=s.setPlaybackState)==null||N.call(s,!1,!1),(R=i==null?void 0:i.clearAdsrVisuals)==null||R.call(i),l&&(cancelAnimationFrame(l),l=null)}),a.info("TransportService","Initialized")},handleStateChange(){if(dt.state==="started"){a.debug("TransportService","handleStateChange: Notes or rhythm changed during playback. Rescheduling");const Q=dt.position;dt.pause(),w(),dt.start(void 0,Q)}else u==null||u.calculate(e.getState())},start(){a.info("TransportService","Starting playback"),(o||(()=>ec()))().then(()=>{w();const Q=e.getState();u==null||u.getTimeMap();const T=(u==null?void 0:u.getMusicalEndTime())??0,U=(u==null?void 0:u.findNonAnacrusisStart(Q))??0;u==null||u.setLoopBounds(U,T,Q.tempo),dt.bpm.value=Q.tempo;const P=de()+.1;dt.start(P,0),A==="standard"&&y(),s.emit("playbackStarted")})},resume(){a.info("TransportService","Resuming playback"),(o||(()=>ec()))().then(()=>{dt.start(),A==="standard"&&y(),s.emit("playbackResumed")})},pause(){a.info("TransportService","Pausing playback"),dt.pause(),l&&(cancelAnimationFrame(l),l=null),s.emit("playbackPaused")},stop(){var Q,T,U;a.info("TransportService","Stopping playback and clearing visuals"),c=!1,l&&(cancelAnimationFrame(l),l=null),dt.stop(),dt.cancel(),d==null||d.reset();const x=e.getState();dt.bpm.value=x.tempo,u==null||u.reapplyConfiguredLoopBounds(x.isLooping),t.releaseAll(),(Q=i==null?void 0:i.clearPlayheadCanvas)==null||Q.call(i),(T=i==null?void 0:i.clearDrumPlayheadCanvas)==null||T.call(i),(U=i==null?void 0:i.updateBeatLineHighlight)==null||U.call(i,0,0,!1),s.emit("playbackStopped")},dispose(){this.stop(),d==null||d.dispose(),f.forEach(x=>x()),a.debug("TransportService","Disposed")}};return F}const nI={latencyHint:"playback",lookAhead:.1};function sI(n={}){const{latencyHint:t,lookAhead:e}={...nI,...n};let s=!1;if(GA.state==="suspended")try{tv(new qc({latencyHint:t})),s=!0}catch(i){console.warn("Failed to create new AudioContext, using default:",i)}return e!==void 0&&(GA.lookAhead=e),s}let iI=class{constructor(){I(this,"logLevel");I(this,"enabledLevels");I(this,"categories");this.logLevel="ERROR",this.enabledLevels={DEBUG:!1,INFO:!1,WARN:!1,ERROR:!0},this.categories={general:!1,state:!1,canvas:!1,audio:!1,ui:!1,layout:!1,harmony:!1,performance:!1,initialization:!1,transport:!1,grid:!1,toolbar:!1,zoom:!1,scroll:!1,keyboard:!1,mouse:!1,adsr:!1,filter:!1,waveform:!1,debug:!1}}enable(...t){t.forEach(e=>{Object.prototype.hasOwnProperty.call(this.categories,e)&&(this.categories[e]=!0)})}disable(...t){t.forEach(e=>{Object.prototype.hasOwnProperty.call(this.categories,e)&&(this.categories[e]=!1)})}enableAll(){Object.keys(this.categories).forEach(t=>{this.categories[t]=!0}),this.setLevel("DEBUG")}disableAll(){Object.keys(this.categories).forEach(t=>{this.categories[t]=!1}),this.setLevel("ERROR")}isCategoryEnabled(t){return this.categories[t]===!0}setLevel(t){const s=["DEBUG","INFO","WARN","ERROR"].indexOf(t);s!==-1&&(this.logLevel=t,this.enabledLevels={DEBUG:s<=0,INFO:s<=1,WARN:s<=2,ERROR:s<=3})}logWithConsole(t,e,s,i=null){if(typeof console<"u"&&console[t]){const r=i!==null?[e,s,i]:[e,s];console[t](...r)}}event(t,e,s="",i="ui"){!this.enabledLevels.INFO||this.isCategoryEnabled(i)}state(t,e,s=null,i="state"){!this.enabledLevels.INFO||this.isCategoryEnabled(i)}debug(t,e,s=null,i="debug"){!this.enabledLevels.DEBUG||!this.isCategoryEnabled(i)||this.logWithConsole("debug",t,e,s)}timing(t,e,s,i="performance"){!this.enabledLevels.DEBUG||!this.isCategoryEnabled(i)||this.logWithConsole("debug",t,e,s)}warn(t,e,s=null,i="general"){!this.enabledLevels.WARN||!this.isCategoryEnabled(i)||this.logWithConsole("warn",t,e,s)}error(t,e,s=null,i="general"){this.enabledLevels.ERROR&&this.logWithConsole("error",t,e,s)}info(t,e,s=null,i="general"){!this.enabledLevels.INFO||!this.isCategoryEnabled(i)||this.logWithConsole("info",t,e,s)}getConfig(){return{logLevel:this.logLevel,enabledLevels:{...this.enabledLevels},enabledCategories:Object.entries(this.categories).filter(([,t])=>t).map(([t])=>t)}}getAvailableCategories(){return Object.keys(this.categories)}section(t){this.enabledLevels.INFO&&this.info("Logger",`===== ${t} =====`,null,"general")}initStart(t){this.enabledLevels.INFO&&this.info(t,"init start",null,"initialization")}initSuccess(t){this.enabledLevels.INFO&&this.info(t,"init success",null,"initialization")}initFailed(t,e){if(this.enabledLevels.ERROR){const s=e?`init failed: ${e}`:"init failed";this.error(t,s,null,"initialization")}}moduleLoaded(t,e="initialization"){this.isCategoryEnabled(e)&&this.enabledLevels.INFO&&this.info(t,"loaded",null,e)}log(t,e,s=null){this.info(t,e,s,"general")}};const E=new iI;typeof window<"u"&&(window.logger=E);E.moduleLoaded("EngineStore","general");function Em(){return{entries:[],visualToCanvas:new Map,visualToTime:new Map,canvasToVisual:new Map,canvasToTime:new Map,timeToCanvas:new Map,timeToVisual:new Map,macrobeatBoundaries:[],totalVisualColumns:0,totalCanvasColumns:0,totalTimeColumns:0,totalWidthUnmodulated:0}}const rI="studentNotationState",oI={getItem:n=>localStorage.getItem(n),setItem:(n,t)=>localStorage.setItem(n,t),removeItem:n=>localStorage.removeItem(n)},La=(n,t,e,s,i)=>{const r=i||"general";switch(n){case"debug":E.debug(t,e,s,r);break;case"info":E.info(t,e,s,r);break;case"warn":E.warn(t,e,s,r);break;case"error":E.error(t,e,s,r);break}};let Gn={};function AI(n){Gn=n,E.info("EngineStore","Column map callbacks registered")}const h=K_({storageKey:rI,storage:oI,onClearState:()=>{localStorage.removeItem("effectDialValues"),window.location.reload()},noteActionCallbacks:{getMacrobeatInfo:(n,t)=>{const e=n.macrobeatGroupings||[];let s=0;for(let r=0;r<t&&r<e.length;r++)s+=e[r]||2;const i=s+(e[t]||2)-1;return{startColumn:s,endColumn:i}},log:(n,t,e)=>La(n,"noteActions",t,e)},rhythmActionCallbacks:{getColumnMap:n=>Gn.getColumnMap?Gn.getColumnMap(n):Em(),visualToTimeIndex:(n,t,e)=>Gn.visualToTimeIndex?Gn.visualToTimeIndex(n,t,e):t,timeIndexToVisualColumn:(n,t,e)=>Gn.timeIndexToVisualColumn?Gn.timeIndexToVisualColumn(n,t,e):t,getTimeBoundaryAfterMacrobeat:(n,t,e)=>{if(Gn.getTimeBoundaryAfterMacrobeat)return Gn.getTimeBoundaryAfterMacrobeat(n,t,e);let s=0;for(let i=0;i<=t&&i<e.length;i++)s+=e[i]||2;return s},log:La},sixteenthStampActionCallbacks:{log:(n,t,e)=>La(n,"sixteenthStampActions",t,e)},tripletStampActionCallbacks:{canvasToTime:(n,t)=>t.canvasToTime.get(n)??null,timeToCanvas:(n,t)=>t.timeToCanvas.get(n)??n,getColumnMap:n=>Gn.getColumnMap?Gn.getColumnMap(n):Em(),log:(n,t,e)=>La(n,"tripletStampActions",t,e)}});function Jf(n){return n!==null&&typeof n=="object"&&"name"in n&&typeof n.name=="string"}function Zf(n){return n!==null&&typeof n=="object"&&"step"in n&&typeof n.step=="number"&&"alt"in n&&typeof n.alt=="number"&&!isNaN(n.step)&&!isNaN(n.alt)}var hv=[0,2,4,-1,1,3,5],fv=hv.map(n=>Math.floor(n*7/12));function pv(n){const{step:t,alt:e,oct:s,dir:i=1}=n,r=hv[t]+7*e;if(s===void 0)return[i*r];const o=s-fv[t]-4*e;return[i*r,i*o]}var aI=[3,0,4,1,5,2,6];function mv(n){const[t,e,s]=n,i=aI[lI(t)],r=Math.floor((t+1)/7);if(e===void 0)return{step:i,alt:r,dir:s};const o=e+4*r+fv[i];return{step:i,alt:r,oct:o,dir:s}}function lI(n){const t=(n+1)%7;return t<0?7+t:t}var xm=(n,t)=>Array(Math.abs(t)+1).join(n),Wd=Object.freeze({empty:!0,name:"",num:NaN,q:"",type:"",step:NaN,alt:NaN,dir:NaN,simple:NaN,semitones:NaN,chroma:NaN,coord:[],oct:NaN}),cI="([-+]?\\d+)(d{1,4}|m|M|P|A{1,4})",uI="(AA|A|P|M|m|d|dd)([-+]?\\d+)",dI=new RegExp("^"+cI+"|"+uI+"$");function hI(n){const t=dI.exec(`${n}`);return t===null?["",""]:t[1]?[t[1],t[2]]:[t[4],t[3]]}var _m={};function Wn(n){return typeof n=="string"?_m[n]||(_m[n]=fI(n)):Zf(n)?Wn(mI(n)):Jf(n)?Wn(n.name):Wd}var Im=[0,2,4,5,7,9,11],gv="PMMPPMM";function fI(n){const t=hI(n);if(t[0]==="")return Wd;const e=+t[0],s=t[1],i=(Math.abs(e)-1)%7,r=gv[i];if(r==="M"&&s==="P")return Wd;const o=r==="M"?"majorable":"perfectable",A=""+e+s,a=e<0?-1:1,l=e===8||e===-8?e:a*(i+1),c=pI(o,s),u=Math.floor((Math.abs(e)-1)/7),d=a*(Im[i]+c+12*u),p=(a*(Im[i]+c)%12+12)%12,f=pv({step:i,alt:c,oct:u,dir:a});return{empty:!1,name:A,num:e,q:s,step:i,alt:c,dir:a,type:o,simple:l,semitones:d,chroma:p,coord:f,oct:u}}function wv(n,t){const[e,s=0]=n,i=e*7+s*12<0,r=t||i?[-e,-s,-1]:[e,s,1];return Wn(mv(r))}function pI(n,t){return t==="M"&&n==="majorable"||t==="P"&&n==="perfectable"?0:t==="m"&&n==="majorable"?-1:/^A+$/.test(t)?t.length:/^d+$/.test(t)?-1*(n==="perfectable"?t.length:t.length+1):0}function mI(n){const{step:t,alt:e,oct:s=0,dir:i}=n;if(!i)return"";const r=t+1+7*s,o=r===0?t+1:r,A=i<0?"-":"",a=gv[t]==="M"?"majorable":"perfectable";return A+o+gI(a,e)}function gI(n,t){return t===0?n==="majorable"?"M":"P":t===-1&&n==="majorable"?"m":t>0?xm("A",t):xm("d",n==="perfectable"?t:t+1)}var Fm=(n,t)=>Array(Math.abs(t)+1).join(n),vv=Object.freeze({empty:!0,name:"",letter:"",acc:"",pc:"",step:NaN,alt:NaN,chroma:NaN,height:NaN,coord:[],midi:null,freq:null}),Tm=new Map,wI=n=>"CDEFGAB".charAt(n),Bv=n=>n<0?Fm("b",-n):Fm("#",n),Cv=n=>n[0]==="b"?-n.length:n.length;function be(n){const t=JSON.stringify(n),e=Tm.get(t);if(e)return e;const s=typeof n=="string"?bI(n):Zf(n)?be(yI(n)):Jf(n)?be(n.name):vv;return Tm.set(t,s),s}var vI=/^([a-gA-G]?)(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)$/;function tp(n){const t=vI.exec(n);return t?[t[1].toUpperCase(),t[2].replace(/x/g,"##"),t[3],t[4]]:["","","",""]}function BI(n){return be(mv(n))}var CI=(n,t)=>(n%t+t)%t,Pu=[0,2,4,5,7,9,11];function bI(n){const t=tp(n);if(t[0]===""||t[3]!=="")return vv;const e=t[0],s=t[1],i=t[2],r=(e.charCodeAt(0)+3)%7,o=Cv(s),A=i.length?+i:void 0,a=pv({step:r,alt:o,oct:A}),l=e+s+i,c=e+s,u=(Pu[r]+o+120)%12,d=A===void 0?CI(Pu[r]+o,12)-1188:Pu[r]+o+12*(A+1),p=d>=0&&d<=127?d:null,f=A===void 0?null:Math.pow(2,(d-69)/12)*440;return{empty:!1,acc:s,alt:o,chroma:u,coord:a,freq:f,height:d,letter:e,midi:p,name:l,oct:A,pc:c,step:r}}function yI(n){const{step:t,alt:e,oct:s}=n,i=wI(t);if(!i)return"";const r=i+Bv(e);return s||s===0?r+s:r}function Au(n,t){const e=be(n),s=Array.isArray(t)?t:Wn(t).coord;if(e.empty||!s||s.length<2)return"";const i=e.coord,r=i.length===1?[i[0]+s[0]]:[i[0]+s[0],i[1]+s[1]];return BI(r).name}function oc(n,t){const e=be(n),s=be(t);if(e.empty||s.empty)return"";const i=e.coord,r=s.coord,o=r[0]-i[0],A=i.length===2&&r.length===2?r[1]-i[1]:-Math.floor(o*7/12),a=s.height===e.height&&s.midi!==null&&e.oct===s.oct&&e.step>s.step;return wv([o,A],a).name}function ep(n,t){const e=t.length,s=(n%e+e)%e;return t.slice(s,e).concat(t.slice(0,s))}function SI(n){return n.filter(t=>t===0||t)}var Sr={empty:!0,name:"",setNum:0,chroma:"000000000000",normalized:"000000000000",intervals:[]},bv=n=>Number(n).toString(2).padStart(12,"0"),Qm=n=>parseInt(n,2),EI=/^[01]{12}$/;function yv(n){return EI.test(n)}var xI=n=>typeof n=="number"&&n>=0&&n<=4095,_I=n=>n&&yv(n.chroma),Mm={[Sr.chroma]:Sr};function np(n){const t=yv(n)?n:xI(n)?bv(n):Array.isArray(n)?UI(n):_I(n)?n.chroma:Sr.chroma;return Mm[t]=Mm[t]||MI(t)}var II=["1P","2m","2M","3m","3M","4P","5d","5P","6m","6M","7m","7M"];function FI(n){const t=[];for(let e=0;e<12;e++)n.charAt(e)==="1"&&t.push(II[e]);return t}function TI(n,t=!0){const s=np(n).chroma.split("");return SI(s.map((i,r)=>{const o=ep(r,s);return t&&o[0]==="0"?null:o.join("")}))}function QI(n){const t=n.split("");return t.map((e,s)=>ep(s,t).join(""))}function MI(n){const t=Qm(n),e=QI(n).map(Qm).filter(r=>r>=2048).sort()[0],s=bv(e),i=FI(n);return{empty:!1,name:"",setNum:t,chroma:n,normalized:s,intervals:i}}function UI(n){if(n.length===0)return Sr.chroma;let t;const e=[0,0,0,0,0,0,0,0,0,0,0,0];for(let s=0;s<n.length;s++)t=be(n[s]),t.empty&&(t=Wn(n[s])),t.empty||(e[t.chroma]=1);return e.join("")}var PI=[["1P 3M 5P","major","M ^  maj"],["1P 3M 5P 7M","major seventh","maj7  ma7 M7 Maj7 ^7"],["1P 3M 5P 7M 9M","major ninth","maj9 9 ^9"],["1P 3M 5P 7M 9M 13M","major thirteenth","maj13 Maj13 ^13"],["1P 3M 5P 6M","sixth","6 add6 add13 M6"],["1P 3M 5P 6M 9M","sixth added ninth","6add9 6/9 69 M69"],["1P 3M 6m 7M","major seventh flat sixth","M7b6 ^7b6"],["1P 3M 5P 7M 11A","major seventh sharp eleventh","maj#4 #4 #11 M7#11 ^7#11 maj7#11"],["1P 3m 5P","minor","m min -"],["1P 3m 5P 7m","minor seventh","m7 min7 mi7 -7"],["1P 3m 5P 7M","minor/major seventh","m/ma7 m/maj7 mM7 mMaj7 m/M7 -7 m -^7 -maj7"],["1P 3m 5P 6M","minor sixth","m6 -6"],["1P 3m 5P 7m 9M","minor ninth","m9 -9"],["1P 3m 5P 7M 9M","minor/major ninth","mM9 mMaj9 -^9"],["1P 3m 5P 7m 9M 11P","minor eleventh","m11 -11"],["1P 3m 5P 7m 9M 13M","minor thirteenth","m13 -13"],["1P 3m 5d","diminished","dim  o"],["1P 3m 5d 7d","diminished seventh","dim7 7 o7"],["1P 3m 5d 7m","half-diminished","m7b5  -7b5 h7 h"],["1P 3M 5P 7m","dominant seventh","7 dom"],["1P 3M 5P 7m 9M","dominant ninth","9"],["1P 3M 5P 7m 9M 13M","dominant thirteenth","13"],["1P 3M 5P 7m 11A","lydian dominant seventh","7#11 7#4"],["1P 3M 5P 7m 9m","dominant flat ninth","7b9"],["1P 3M 5P 7m 9A","dominant sharp ninth","7#9"],["1P 3M 7m 9m","altered","alt7"],["1P 4P 5P","suspended fourth","sus4 sus"],["1P 2M 5P","suspended second","sus2"],["1P 4P 5P 7m","suspended fourth seventh","7sus4 7sus"],["1P 5P 7m 9M 11P","eleventh","11"],["1P 4P 5P 7m 9m","suspended fourth flat ninth","b9sus phryg 7b9sus 7b9sus4"],["1P 5P","fifth","5"],["1P 3M 5A","augmented","aug + +5 ^#5"],["1P 3m 5A","minor augmented","m#5 -#5 m+"],["1P 3M 5A 7M","augmented seventh","maj7#5 maj7+5 +maj7 ^7#5"],["1P 3M 5P 7M 9M 11A","major sharp eleventh (lydian)","maj9#11 9#11 ^9#11"],["1P 2M 4P 5P","","sus24 sus4add9"],["1P 3M 5A 7M 9M","","maj9#5 Maj9#5"],["1P 3M 5A 7m","","7#5 +7 7+ 7aug aug7"],["1P 3M 5A 7m 9A","","7#5#9 7#9#5 7alt"],["1P 3M 5A 7m 9M","","9#5 9+"],["1P 3M 5A 7m 9M 11A","","9#5#11"],["1P 3M 5A 7m 9m","","7#5b9 7b9#5"],["1P 3M 5A 7m 9m 11A","","7#5b9#11"],["1P 3M 5A 9A","","+add#9"],["1P 3M 5A 9M","","M#5add9 +add9"],["1P 3M 5P 6M 11A","","M6#11 M6b5 6#11 6b5"],["1P 3M 5P 6M 7M 9M","","M7add13"],["1P 3M 5P 6M 9M 11A","","69#11"],["1P 3m 5P 6M 9M","","m69 -69"],["1P 3M 5P 6m 7m","","7b6"],["1P 3M 5P 7M 9A 11A","","maj7#9#11"],["1P 3M 5P 7M 9M 11A 13M","","M13#11 maj13#11 M13+4 M13#4"],["1P 3M 5P 7M 9m","","M7b9"],["1P 3M 5P 7m 11A 13m","","7#11b13 7b5b13"],["1P 3M 5P 7m 13M","","7add6 67 7add13"],["1P 3M 5P 7m 9A 11A","","7#9#11 7b5#9 7#9b5"],["1P 3M 5P 7m 9A 11A 13M","","13#9#11"],["1P 3M 5P 7m 9A 11A 13m","","7#9#11b13"],["1P 3M 5P 7m 9A 13M","","13#9"],["1P 3M 5P 7m 9A 13m","","7#9b13"],["1P 3M 5P 7m 9M 11A","","9#11 9+4 9#4"],["1P 3M 5P 7m 9M 11A 13M","","13#11 13+4 13#4"],["1P 3M 5P 7m 9M 11A 13m","","9#11b13 9b5b13"],["1P 3M 5P 7m 9m 11A","","7b9#11 7b5b9 7b9b5"],["1P 3M 5P 7m 9m 11A 13M","","13b9#11"],["1P 3M 5P 7m 9m 11A 13m","","7b9b13#11 7b9#11b13 7b5b9b13"],["1P 3M 5P 7m 9m 13M","","13b9"],["1P 3M 5P 7m 9m 13m","","7b9b13"],["1P 3M 5P 7m 9m 9A","","7b9#9"],["1P 3M 5P 9M","","Madd9 2 add9 add2"],["1P 3M 5P 9m","","Maddb9"],["1P 3M 5d","","Mb5"],["1P 3M 5d 6M 7m 9M","","13b5"],["1P 3M 5d 7M","","M7b5"],["1P 3M 5d 7M 9M","","M9b5"],["1P 3M 5d 7m","","7b5"],["1P 3M 5d 7m 9M","","9b5"],["1P 3M 7m","","7no5"],["1P 3M 7m 13m","","7b13"],["1P 3M 7m 9M","","9no5"],["1P 3M 7m 9M 13M","","13no5"],["1P 3M 7m 9M 13m","","9b13"],["1P 3m 4P 5P","","madd4"],["1P 3m 5P 6m 7M","","mMaj7b6"],["1P 3m 5P 6m 7M 9M","","mMaj9b6"],["1P 3m 5P 7m 11P","","m7add11 m7add4"],["1P 3m 5P 9M","","madd9"],["1P 3m 5d 6M 7M","","o7M7"],["1P 3m 5d 7M","","oM7"],["1P 3m 6m 7M","","mb6M7"],["1P 3m 6m 7m","","m7#5"],["1P 3m 6m 7m 9M","","m9#5"],["1P 3m 5A 7m 9M 11P","","m11A"],["1P 3m 6m 9m","","mb6b9"],["1P 2M 3m 5d 7m","","m9b5"],["1P 4P 5A 7M","","M7#5sus4"],["1P 4P 5A 7M 9M","","M9#5sus4"],["1P 4P 5A 7m","","7#5sus4"],["1P 4P 5P 7M","","M7sus4"],["1P 4P 5P 7M 9M","","M9sus4"],["1P 4P 5P 7m 9M","","9sus4 9sus"],["1P 4P 5P 7m 9M 13M","","13sus4 13sus"],["1P 4P 5P 7m 9m 13m","","7sus4b9b13 7b9b13sus4"],["1P 4P 7m 10m","","4 quartal"],["1P 5P 7m 9m 11P","","11b9"]],NI=PI,DI={...Sr,name:"",quality:"Unknown",intervals:[],aliases:[]},sp=[],wA={};function LI(n){return wA[n]||DI}function kI(){return sp.slice()}function RI(n,t,e){const s=OI(n),i={...np(n),name:e||"",quality:s,intervals:n,aliases:t};sp.push(i),i.name&&(wA[i.name]=i),wA[i.setNum]=i,wA[i.chroma]=i,i.aliases.forEach(r=>HI(i,r))}function HI(n,t){wA[t]=n}function OI(n){const t=e=>n.indexOf(e)!==-1;return t("5A")?"Augmented":t("3M")?"Major":t("5d")?"Diminished":t("3m")?"Minor":"Unknown"}NI.forEach(([n,t,e])=>RI(n.split(" "),e.split(" "),t));sp.sort((n,t)=>n.setNum-t.setNum);var VI=n=>{const t=n.reduce((e,s)=>{const i=be(s).chroma;return i!==void 0&&(e[i]=e[i]||be(s).name),e},{});return e=>t[e]};function WI(n,t={}){const e=n.map(i=>be(i).pc).filter(i=>i);return be.length===0?[]:YI(e,1,t).filter(i=>i.weight).sort((i,r)=>r.weight-i.weight).map(i=>i.name)}var au={anyThirds:384,perfectFifth:16,nonPerfectFifths:40,anySeventh:3},lu=n=>t=>!!(t&n),GI=lu(au.anyThirds),KI=lu(au.perfectFifth),qI=lu(au.anySeventh),zI=lu(au.nonPerfectFifths);function XI(n){const t=parseInt(n.chroma,2);return GI(t)&&KI(t)&&qI(t)}function $I(n){const t=parseInt(n,2);return zI(t)?n:(t|16).toString(2)}function YI(n,t,e){const s=n[0],i=be(s).chroma,r=VI(n),o=TI(n,!1),A=[];return o.forEach((a,l)=>{const c=e.assumePerfectFifth&&$I(a);kI().filter(d=>e.assumePerfectFifth&&XI(d)?d.chroma===c:d.chroma===a).forEach(d=>{const p=d.aliases[0],f=r(l);l!==i?A.push({weight:.5*t,name:`${f}${p}/${s}`}):A.push({weight:1*t,name:`${f}${p}`})})}),A}var jI=Wn;function JI(n){const t=Wn(n);if(t.empty)return"";const e=(7-t.step)%7,s=t.type==="perfectable"?-t.alt:-(t.alt+1);return Wn({step:e,alt:s,oct:t.oct,dir:t.dir}).name}var Um=oc,ZI=tF((n,t)=>[n[0]-t[0],n[1]-t[1]]);function tF(n){return(t,e)=>{const s=Wn(t).coord,i=Wn(e).coord;if(s&&i){const r=n(s,i);return wv(r).name}}}var eF=[["1P 2M 3M 5P 6M","major pentatonic","pentatonic"],["1P 2M 3M 4P 5P 6M 7M","major","ionian"],["1P 2M 3m 4P 5P 6m 7m","minor","aeolian"],["1P 2M 3m 3M 5P 6M","major blues"],["1P 3m 4P 5d 5P 7m","minor blues","blues"],["1P 2M 3m 4P 5P 6M 7M","melodic minor"],["1P 2M 3m 4P 5P 6m 7M","harmonic minor"],["1P 2M 3M 4P 5P 6M 7m 7M","bebop"],["1P 2M 3m 4P 5d 6m 6M 7M","diminished","whole-half diminished"],["1P 2M 3m 4P 5P 6M 7m","dorian"],["1P 2M 3M 4A 5P 6M 7M","lydian"],["1P 2M 3M 4P 5P 6M 7m","mixolydian","dominant"],["1P 2m 3m 4P 5P 6m 7m","phrygian"],["1P 2m 3m 4P 5d 6m 7m","locrian"],["1P 3M 4P 5P 7M","ionian pentatonic"],["1P 3M 4P 5P 7m","mixolydian pentatonic","indian"],["1P 2M 4P 5P 6M","ritusen"],["1P 2M 4P 5P 7m","egyptian"],["1P 3M 4P 5d 7m","neopolitan major pentatonic"],["1P 3m 4P 5P 6m","vietnamese 1"],["1P 2m 3m 5P 6m","pelog"],["1P 2m 4P 5P 6m","kumoijoshi"],["1P 2M 3m 5P 6m","hirajoshi"],["1P 2m 4P 5d 7m","iwato"],["1P 2m 4P 5P 7m","in-sen"],["1P 3M 4A 5P 7M","lydian pentatonic","chinese"],["1P 3m 4P 6m 7m","malkos raga"],["1P 3m 4P 5d 7m","locrian pentatonic","minor seven flat five pentatonic"],["1P 3m 4P 5P 7m","minor pentatonic","vietnamese 2"],["1P 3m 4P 5P 6M","minor six pentatonic"],["1P 2M 3m 5P 6M","flat three pentatonic","kumoi"],["1P 2M 3M 5P 6m","flat six pentatonic"],["1P 2m 3M 5P 6M","scriabin"],["1P 3M 5d 6m 7m","whole tone pentatonic"],["1P 3M 4A 5A 7M","lydian #5P pentatonic"],["1P 3M 4A 5P 7m","lydian dominant pentatonic"],["1P 3m 4P 5P 7M","minor #7M pentatonic"],["1P 3m 4d 5d 7m","super locrian pentatonic"],["1P 2M 3m 4P 5P 7M","minor hexatonic"],["1P 2A 3M 5P 5A 7M","augmented"],["1P 2M 4P 5P 6M 7m","piongio"],["1P 2m 3M 4A 6M 7m","prometheus neopolitan"],["1P 2M 3M 4A 6M 7m","prometheus"],["1P 2m 3M 5d 6m 7m","mystery #1"],["1P 2m 3M 4P 5A 6M","six tone symmetric"],["1P 2M 3M 4A 5A 6A","whole tone","messiaen's mode #1"],["1P 2m 4P 4A 5P 7M","messiaen's mode #5"],["1P 2M 3M 4P 5d 6m 7m","locrian major","arabian"],["1P 2m 3M 4A 5P 6m 7M","double harmonic lydian"],["1P 2m 2A 3M 4A 6m 7m","altered","super locrian","diminished whole tone","pomeroy"],["1P 2M 3m 4P 5d 6m 7m","locrian #2","half-diminished","aeolian b5"],["1P 2M 3M 4P 5P 6m 7m","mixolydian b6","melodic minor fifth mode","hindu"],["1P 2M 3M 4A 5P 6M 7m","lydian dominant","lydian b7","overtone"],["1P 2M 3M 4A 5A 6M 7M","lydian augmented"],["1P 2m 3m 4P 5P 6M 7m","dorian b2","phrygian #6","melodic minor second mode"],["1P 2m 3m 4d 5d 6m 7d","ultralocrian","superlocrian bb7","superlocrian diminished"],["1P 2m 3m 4P 5d 6M 7m","locrian 6","locrian natural 6","locrian sharp 6"],["1P 2A 3M 4P 5P 5A 7M","augmented heptatonic"],["1P 2M 3m 4A 5P 6M 7m","dorian #4","ukrainian dorian","romanian minor","altered dorian"],["1P 2M 3m 4A 5P 6M 7M","lydian diminished"],["1P 2M 3M 4A 5A 7m 7M","leading whole tone"],["1P 2M 3M 4A 5P 6m 7m","lydian minor"],["1P 2m 3M 4P 5P 6m 7m","phrygian dominant","spanish","phrygian major"],["1P 2m 3m 4P 5P 6m 7M","balinese"],["1P 2m 3m 4P 5P 6M 7M","neopolitan major"],["1P 2M 3M 4P 5P 6m 7M","harmonic major"],["1P 2m 3M 4P 5P 6m 7M","double harmonic major","gypsy"],["1P 2M 3m 4A 5P 6m 7M","hungarian minor"],["1P 2A 3M 4A 5P 6M 7m","hungarian major"],["1P 2m 3M 4P 5d 6M 7m","oriental"],["1P 2m 3m 3M 4A 5P 7m","flamenco"],["1P 2m 3m 4A 5P 6m 7M","todi raga"],["1P 2m 3M 4P 5d 6m 7M","persian"],["1P 2m 3M 5d 6m 7m 7M","enigmatic"],["1P 2M 3M 4P 5A 6M 7M","major augmented","major #5","ionian augmented","ionian #5"],["1P 2A 3M 4A 5P 6M 7M","lydian #9"],["1P 2m 2M 4P 4A 5P 6m 7M","messiaen's mode #4"],["1P 2m 3M 4P 4A 5P 6m 7M","purvi raga"],["1P 2m 3m 3M 4P 5P 6m 7m","spanish heptatonic"],["1P 2M 3m 3M 4P 5P 6M 7m","bebop minor"],["1P 2M 3M 4P 5P 5A 6M 7M","bebop major"],["1P 2m 3m 4P 5d 5P 6m 7m","bebop locrian"],["1P 2M 3m 4P 5P 6m 7m 7M","minor bebop"],["1P 2M 3M 4P 5d 5P 6M 7M","ichikosucho"],["1P 2M 3m 4P 5P 6m 6M 7M","minor six diminished"],["1P 2m 3m 3M 4A 5P 6M 7m","half-whole diminished","dominant diminished","messiaen's mode #2"],["1P 3m 3M 4P 5P 6M 7m 7M","kafi raga"],["1P 2M 3M 4P 4A 5A 6A 7M","messiaen's mode #6"],["1P 2M 3m 3M 4P 5d 5P 6M 7m","composite blues"],["1P 2M 3m 3M 4A 5P 6m 7m 7M","messiaen's mode #3"],["1P 2m 2M 3m 4P 4A 5P 6m 6M 7M","messiaen's mode #7"],["1P 2m 2M 3m 3M 4P 5d 5P 6m 6M 7m 7M","chromatic"]],nF=eF,sF={...Sr,intervals:[],aliases:[]},vA={};function Sv(n){return vA[n]||sF}function iF(n,t,e=[]){const s={...np(n),name:t,intervals:n,aliases:e};return vA[s.name]=s,vA[s.setNum]=s,vA[s.chroma]=s,s.aliases.forEach(i=>rF(s,i)),s}function rF(n,t){vA[t]=n}nF.forEach(([n,t,...e])=>iF(n.split(" "),t,e));var Ev={empty:!0,name:"",symbol:"",root:"",bass:"",rootDegree:0,type:"",tonic:null,setNum:NaN,quality:"Unknown",chroma:"",normalized:"",aliases:[],notes:[],intervals:[]};function xv(n){const[t,e,s,i]=tp(n);return t===""?Nu("",n):t==="A"&&i==="ug"?Nu("","aug"):Nu(t+e,s+i)}function Nu(n,t){const e=t.split("/");if(e.length===1)return[n,e[0],""];const[s,i,r,o]=tp(e[1]);return s!==""&&r===""&&o===""?[n,e[0],s+i]:[n,t,""]}function oF(n){if(Array.isArray(n))return Du(n[1]||"",n[0],n[2]);if(n==="")return Ev;{const[t,e,s]=xv(n),i=Du(e,t,s);return i.empty?Du(n):i}}function Du(n,t,e){const s=LI(n),i=be(t||""),r=be(e||"");if(s.empty||t&&i.empty||e&&r.empty)return Ev;const o=oc(i.pc,r.pc),A=s.intervals.indexOf(o),a=A>=0,l=a?r:be(""),c=A===-1?NaN:A+1,u=r.pc&&r.pc!==i.pc,d=Array.from(s.intervals);if(a)for(let g=1;g<c;g++){const w=d[0][0],B=d[0][1],b=parseInt(w,10)+7;d.push(`${b}${B}`),d.shift()}else if(u){const g=ZI(oc(i.pc,r.pc),"8P");g&&d.unshift(g)}const p=i.empty?[]:d.map(g=>Au(i.pc,g));n=s.aliases.indexOf(n)!==-1?n:s.aliases[0];const f=`${i.empty?"":i.pc}${n}${a&&c>1?"/"+l.pc:u?"/"+r.pc:""}`,m=`${t?i.pc+" ":""}${s.name}${a&&c>1?" over "+l.pc:u?" over "+r.pc:""}`;return{...s,name:m,symbol:f,tonic:i.pc,type:s.name,root:l.pc,bass:u?r.pc:"",intervals:d,rootDegree:c,notes:p}}var AF=[[.125,"dl",["large","duplex longa","maxima","octuple","octuple whole"]],[.25,"l",["long","longa"]],[.5,"d",["double whole","double","breve"]],[1,"w",["whole","semibreve"]],[2,"h",["half","minim"]],[4,"q",["quarter","crotchet"]],[8,"e",["eighth","quaver"]],[16,"s",["sixteenth","semiquaver"]],[32,"t",["thirty-second","demisemiquaver"]],[64,"sf",["sixty-fourth","hemidemisemiquaver"]],[128,"h",["hundred twenty-eighth"]],[256,"th",["two hundred fifty-sixth"]]],aF=AF;aF.forEach(([n,t,e])=>void 0);var lF="C C# D D# E F F# G G# A A# B".split(" "),cF="C Db D Eb E F Gb G Ab A Bb B".split(" ");function ip(n,t={}){if(isNaN(n)||n===-1/0||n===1/0)return"";n=Math.round(n);const s=(t.sharps===!0?lF:cF)[n%12];if(t.pitchClass)return s;const i=Math.floor(n/12)-1;return s+i}var KA=be,Gd=n=>KA(n).pc,Lu=n=>KA(n).midi;function uF(n){return ip(n)}var ho=Au,BA=n=>{const t=KA(n);return t.empty?"":ip(t.midi||t.chroma,{sharps:t.alt>0,pitchClass:t.midi===null})};function CA(n,t){const e=KA(n);if(e.empty)return"";const s=KA(t||ip(e.midi||e.chroma,{sharps:e.alt<0,pitchClass:!0}));if(s.empty||s.chroma!==e.chroma)return"";if(e.oct===void 0)return s.pc;const i=e.chroma-e.alt,r=s.chroma-s.alt,o=i>11||r<0?-1:i<0||r>11?1:0,A=e.oct+o;return s.pc+A}var _v={empty:!0,name:"",chordType:""},Pm={};function qA(n){return typeof n=="string"?Pm[n]||(Pm[n]=mF(n)):typeof n=="number"?qA(rp[n]||""):Zf(n)?dF(n):Jf(n)?qA(n.name):_v}function dF(n){return qA(Bv(n.alt)+rp[n.step])}var hF=/^(#{1,}|b{1,}|x{1,}|)(IV|I{1,3}|VI{0,2}|iv|i{1,3}|vi{0,2})([^IViv]*)$/;function fF(n){return hF.exec(n)||["","","",""]}var pF="I II III IV V VI VII",rp=pF.split(" ");function mF(n){const[t,e,s,i]=fF(n);if(!s)return _v;const r=s.toUpperCase(),o=rp.indexOf(r),A=Cv(e),a=1;return{empty:!1,name:t,roman:s,interval:Wn({step:o,alt:A,dir:a}).name,acc:e,chordType:i,alt:A,step:o,major:s===r,oct:0,dir:a}}var op=[[0,2773,0,"ionian","","Maj7","major"],[1,2902,2,"dorian","m","m7"],[2,3418,4,"phrygian","m","m7"],[3,2741,-1,"lydian","","Maj7"],[4,2774,1,"mixolydian","","7"],[5,2906,3,"aeolian","m","m7","minor"],[6,3434,5,"locrian","dim","m7b5"]],Nm={...Sr,name:"",alt:0,modeNum:NaN,triad:"",seventh:"",aliases:[]},gF=op.map(wF),Kd={};gF.forEach(n=>{Kd[n.name]=n,n.aliases.forEach(t=>{Kd[t]=n})});function Iv(n){return typeof n=="string"?Kd[n.toLowerCase()]||Nm:n&&n.name?Iv(n.name):Nm}function wF(n){const[t,e,s,i,r,o,A]=n,a=A?[A]:[],l=Number(e).toString(2);return{empty:!1,intervals:Sv(i).intervals,modeNum:t,chroma:l,normalized:l,name:i,setNum:e,alt:s,triad:r,seventh:o,aliases:a}}function Fv(n){return(t,e)=>{const s=Iv(t);if(s.empty)return[];const i=ep(s.modeNum,n),r=s.intervals.map(o=>Au(e,o));return i.map((o,A)=>r[A]+o)}}Fv(op.map(n=>n[4]));Fv(op.map(n=>n[5]));function vF(n,t){return t.map(e=>{const[s,i]=xv(e),r=oc(n,s);return qA(Wn(r)).name+i})}var BF={empty:!0,name:"",type:"",tonic:null,setNum:NaN,chroma:"",normalized:"",aliases:[],notes:[],intervals:[]};function CF(n){if(typeof n!="string")return["",""];const t=n.indexOf(" "),e=be(n.substring(0,t));if(e.empty){const i=be(n);return i.empty?["",n.toLowerCase()]:[i.name,""]}const s=n.substring(e.name.length+1).toLowerCase();return[e.name,s.length?s:""]}function bF(n){const t=Array.isArray(n)?n:CF(n),e=be(t[0]).name,s=Sv(t[1]);if(s.empty)return BF;const i=s.name,r=e?s.intervals.map(A=>Au(e,A)):[],o=e?e+" "+i:i;return{...s,name:o,type:i,tonic:e,notes:r}}const qs=[{pitch:"C8",flatName:"C8",sharpName:"C8",toneNote:"C8",frequency:4186.01,column:"A",hex:"#fcfcfc",isAccidental:!1},{pitch:"B7",flatName:"B7",sharpName:"B7",toneNote:"B7",frequency:3951.07,column:"B",hex:"#fcf7fc",isAccidental:!1},{pitch:"B/A7",flatName:"B7",sharpName:"A7",toneNote:"Bb7",frequency:3729.31,column:"A",hex:"#f7f5fd",isAccidental:!0},{pitch:"A7",flatName:"A7",sharpName:"A7",toneNote:"A7",frequency:3520,column:"B",hex:"#f0f4ff",isAccidental:!1},{pitch:"A/G7",flatName:"A7",sharpName:"G7",toneNote:"Ab7",frequency:3322.44,column:"A",hex:"#e6f3fd",isAccidental:!0},{pitch:"G7",flatName:"G7",sharpName:"G7",toneNote:"G7",frequency:3135.96,column:"B",hex:"#def3f7",isAccidental:!1},{pitch:"G/F7",flatName:"G7",sharpName:"F7",toneNote:"Gb7",frequency:2959.96,column:"A",hex:"#daf2ec",isAccidental:!0},{pitch:"F7",flatName:"F7",sharpName:"F7",toneNote:"F7",frequency:2793.83,column:"B",hex:"#dcefdf",isAccidental:!1},{pitch:"E7",flatName:"E7",sharpName:"E7",toneNote:"E7",frequency:2637.02,column:"A",hex:"#e3ebd1",isAccidental:!1},{pitch:"E/D7",flatName:"E7",sharpName:"D7",toneNote:"Eb7",frequency:2489.02,column:"B",hex:"#eee4c8",isAccidental:!0},{pitch:"D7",flatName:"D7",sharpName:"D7",toneNote:"D7",frequency:2349.32,column:"A",hex:"#f8dcc6",isAccidental:!1},{pitch:"D/C7",flatName:"D7",sharpName:"C7",toneNote:"Db7",frequency:2217.46,column:"B",hex:"#fcd4cd",isAccidental:!0},{pitch:"C7",flatName:"C7",sharpName:"C7",toneNote:"C7",frequency:2093,column:"A",hex:"#facfdb",isAccidental:!1},{pitch:"B6",flatName:"B6",sharpName:"B6",toneNote:"B6",frequency:1975.53,column:"B",hex:"#efcdeb",isAccidental:!1},{pitch:"B/A6",flatName:"B6",sharpName:"A6",toneNote:"Bb6",frequency:1864.66,column:"A",hex:"#ddcff9",isAccidental:!0},{pitch:"A6",flatName:"A6",sharpName:"A6",toneNote:"A6",frequency:1760,column:"B",hex:"#c4d3ff",isAccidental:!1},{pitch:"A/G6",flatName:"A6",sharpName:"G6",toneNote:"Ab6",frequency:1661.22,column:"A",hex:"#abd9fa",isAccidental:!0},{pitch:"G6",flatName:"G6",sharpName:"G6",toneNote:"G6",frequency:1567.94,column:"B",hex:"#98dde9",isAccidental:!1},{pitch:"G/F6",flatName:"G6",sharpName:"F6",toneNote:"Gb6",frequency:1479.98,column:"A",hex:"#96ddcf",isAccidental:!0},{pitch:"F6",flatName:"F6",sharpName:"F6",toneNote:"F6",frequency:1396.91,column:"B",hex:"#a6d9b0",isAccidental:!1},{pitch:"E6",flatName:"E6",sharpName:"E6",toneNote:"E6",frequency:1318.51,column:"A",hex:"#c0d093",isAccidental:!1},{pitch:"E/D6",flatName:"E6",sharpName:"D6",toneNote:"Eb6",frequency:1244.51,column:"B",hex:"#dbc383",isAccidental:!0},{pitch:"D6",flatName:"D6",sharpName:"D6",toneNote:"D6",frequency:1174.66,column:"A",hex:"#efb586",isAccidental:!1},{pitch:"D/C6",flatName:"D6",sharpName:"C6",toneNote:"Db6",frequency:1108.73,column:"B",hex:"#f8a99c",isAccidental:!0},{pitch:"C6",flatName:"C6",sharpName:"C6",toneNote:"C6",frequency:1046.5,column:"A",hex:"#f3a2bb",isAccidental:!1},{pitch:"B5",flatName:"B5",sharpName:"B5",toneNote:"B5",frequency:987.77,column:"B",hex:"#e1a3db",isAccidental:!1},{pitch:"B/A5",flatName:"B5",sharpName:"A5",toneNote:"Bb5",frequency:932.33,column:"A",hex:"#c3a9f4",isAccidental:!0},{pitch:"A5",flatName:"A5",sharpName:"A5",toneNote:"A5",frequency:880,column:"B",hex:"#9ab2ff",isAccidental:!1},{pitch:"A/G5",flatName:"A5",sharpName:"G5",toneNote:"Ab5",frequency:830.61,column:"A",hex:"#67bdf7",isAccidental:!0},{pitch:"G5",flatName:"G5",sharpName:"G5",toneNote:"G5",frequency:783.99,column:"B",hex:"#30c6dc",isAccidental:!1},{pitch:"G/F5",flatName:"G5",sharpName:"F5",toneNote:"Gb5",frequency:739.99,column:"A",hex:"#32c8b2",isAccidental:!0},{pitch:"F5",flatName:"F5",sharpName:"F5",toneNote:"F5",frequency:698.46,column:"B",hex:"#6dc281",isAccidental:!1},{pitch:"E5",flatName:"E5",sharpName:"E5",toneNote:"E5",frequency:659.25,column:"A",hex:"#a0b556",isAccidental:!1},{pitch:"E/D5",flatName:"E5",sharpName:"D5",toneNote:"Eb5",frequency:622.25,column:"B",hex:"#c5a33f",isAccidental:!0},{pitch:"D5",flatName:"D5",sharpName:"D5",toneNote:"D5",frequency:587.33,column:"A",hex:"#dc9150",isAccidental:!1},{pitch:"D/C5",flatName:"D5",sharpName:"C5",toneNote:"Db5",frequency:554.37,column:"B",hex:"#e38475",isAccidental:!0},{pitch:"C5",flatName:"C5",sharpName:"C5",toneNote:"C5",frequency:523.25,column:"A",hex:"#dc7f9d",isAccidental:!1},{pitch:"B4",flatName:"B4",sharpName:"B4",toneNote:"B4",frequency:493.88,column:"B",hex:"#c781c0",isAccidental:!1},{pitch:"B/A4",flatName:"B4",sharpName:"A4",toneNote:"Bb4",frequency:466.16,column:"A",hex:"#a68ad8",isAccidental:!0},{pitch:"A4",flatName:"A4",sharpName:"A4",toneNote:"A4",frequency:440,column:"B",hex:"#7d94e0",isAccidental:!1},{pitch:"A/G4",flatName:"A4",sharpName:"G4",toneNote:"Ab4",frequency:415.3,column:"A",hex:"#4c9fd5",isAccidental:!0},{pitch:"G4",flatName:"G4",sharpName:"G4",toneNote:"G4",frequency:392,column:"B",hex:"#0fa6ba",isAccidental:!1},{pitch:"G/F4",flatName:"G4",sharpName:"F4",toneNote:"Gb4",frequency:369.99,column:"A",hex:"#24a794",isAccidental:!0},{pitch:"F4",flatName:"F4",sharpName:"F4",toneNote:"F4",frequency:349.23,column:"B",hex:"#5aa26a",isAccidental:!1},{pitch:"E4",flatName:"E4",sharpName:"E4",toneNote:"E4",frequency:329.63,column:"A",hex:"#849646",isAccidental:!1},{pitch:"E/D4",flatName:"E4",sharpName:"D4",toneNote:"Eb4",frequency:311.13,column:"B",hex:"#a38733",isAccidental:!0},{pitch:"D4",flatName:"D4",sharpName:"D4",toneNote:"D4",frequency:293.66,column:"A",hex:"#b67740",isAccidental:!1},{pitch:"D/C4",flatName:"D4",sharpName:"C4",toneNote:"Db4",frequency:277.18,column:"B",hex:"#bc6c5f",isAccidental:!0},{pitch:"C4",flatName:"C4",sharpName:"C4",toneNote:"C4",frequency:261.63,column:"A",hex:"#b56880",isAccidental:!1},{pitch:"B3",flatName:"B3",sharpName:"B3",toneNote:"B3",frequency:246.94,column:"B",hex:"#a3699e",isAccidental:!1},{pitch:"B/A3",flatName:"B3",sharpName:"A3",toneNote:"Bb3",frequency:233.08,column:"A",hex:"#8870b1",isAccidental:!0},{pitch:"A3",flatName:"A3",sharpName:"A3",toneNote:"A3",frequency:220,column:"B",hex:"#6578b7",isAccidental:!1},{pitch:"A/G3",flatName:"A3",sharpName:"G3",toneNote:"Ab3",frequency:207.65,column:"A",hex:"#3c81ad",isAccidental:!0},{pitch:"G3",flatName:"G3",sharpName:"G3",toneNote:"G3",frequency:196,column:"B",hex:"#0e8696",isAccidental:!1},{pitch:"G/F3",flatName:"G3",sharpName:"F3",toneNote:"Gb3",frequency:185,column:"A",hex:"#1b8777",isAccidental:!0},{pitch:"F3",flatName:"F3",sharpName:"F3",toneNote:"F3",frequency:174.61,column:"B",hex:"#478255",isAccidental:!1},{pitch:"E3",flatName:"E3",sharpName:"E3",toneNote:"E3",frequency:164.81,column:"A",hex:"#697836",isAccidental:!1},{pitch:"E/D3",flatName:"E3",sharpName:"D3",toneNote:"Eb3",frequency:155.56,column:"B",hex:"#836b27",isAccidental:!0},{pitch:"D3",flatName:"D3",sharpName:"D3",toneNote:"D3",frequency:146.83,column:"A",hex:"#925e32",isAccidental:!1},{pitch:"D/C3",flatName:"D3",sharpName:"C3",toneNote:"Db3",frequency:138.59,column:"B",hex:"#96554b",isAccidental:!0},{pitch:"C3",flatName:"C3",sharpName:"C3",toneNote:"C3",frequency:130.81,column:"A",hex:"#905165",isAccidental:!1},{pitch:"B2",flatName:"B2",sharpName:"B2",toneNote:"B2",frequency:123.47,column:"B",hex:"#80527c",isAccidental:!1},{pitch:"B/A2",flatName:"B2",sharpName:"A2",toneNote:"Bb2",frequency:116.54,column:"A",hex:"#6a578c",isAccidental:!0},{pitch:"A2",flatName:"A2",sharpName:"A2",toneNote:"A2",frequency:110,column:"B",hex:"#4e5e90",isAccidental:!1},{pitch:"A/G2",flatName:"A2",sharpName:"G2",toneNote:"Ab2",frequency:103.83,column:"A",hex:"#2d6488",isAccidental:!0},{pitch:"G2",flatName:"G2",sharpName:"G2",toneNote:"G2",frequency:98,column:"B",hex:"#096875",isAccidental:!1},{pitch:"G/F2",flatName:"G2",sharpName:"F2",toneNote:"Gb2",frequency:92.5,column:"A",hex:"#13685b",isAccidental:!0},{pitch:"F2",flatName:"F2",sharpName:"F2",toneNote:"F2",frequency:87.31,column:"B",hex:"#356440",isAccidental:!1},{pitch:"E2",flatName:"E2",sharpName:"E2",toneNote:"E2",frequency:82.41,column:"A",hex:"#505c28",isAccidental:!1},{pitch:"E/D2",flatName:"E2",sharpName:"D2",toneNote:"Eb2",frequency:77.78,column:"B",hex:"#63511c",isAccidental:!0},{pitch:"D2",flatName:"D2",sharpName:"D2",toneNote:"D2",frequency:73.42,column:"A",hex:"#6e4724",isAccidental:!1},{pitch:"D/C2",flatName:"D2",sharpName:"C2",toneNote:"Db2",frequency:69.3,column:"B",hex:"#713f37",isAccidental:!0},{pitch:"C2",flatName:"C2",sharpName:"C2",toneNote:"C2",frequency:65.41,column:"A",hex:"#6c3c4b",isAccidental:!1},{pitch:"B1",flatName:"B1",sharpName:"B1",toneNote:"B1",frequency:61.74,column:"B",hex:"#603c5d",isAccidental:!1},{pitch:"B/A1",flatName:"B1",sharpName:"A1",toneNote:"Bb1",frequency:58.27,column:"A",hex:"#4e4068",isAccidental:!0},{pitch:"A1",flatName:"A1",sharpName:"A1",toneNote:"A1",frequency:55,column:"B",hex:"#38446b",isAccidental:!1},{pitch:"A/G1",flatName:"A1",sharpName:"G1",toneNote:"Ab1",frequency:51.91,column:"A",hex:"#1f4964",isAccidental:!0},{pitch:"G1",flatName:"G1",sharpName:"G1",toneNote:"G1",frequency:49,column:"B",hex:"#044b55",isAccidental:!1},{pitch:"G/F1",flatName:"G1",sharpName:"F1",toneNote:"Gb1",frequency:46.25,column:"A",hex:"#0c4b41",isAccidental:!0},{pitch:"F1",flatName:"F1",sharpName:"F1",toneNote:"F1",frequency:43.65,column:"B",hex:"#24472c",isAccidental:!1},{pitch:"E1",flatName:"E1",sharpName:"E1",toneNote:"E1",frequency:41.2,column:"A",hex:"#38401a",isAccidental:!1},{pitch:"E/D1",flatName:"E1",sharpName:"D1",toneNote:"Eb1",frequency:38.89,column:"B",hex:"#463811",isAccidental:!0},{pitch:"D1",flatName:"D1",sharpName:"D1",toneNote:"D1",frequency:36.71,column:"A",hex:"#4d3017",isAccidental:!1},{pitch:"D/C1",flatName:"D1",sharpName:"C1",toneNote:"Db1",frequency:34.65,column:"B",hex:"#4f2a24",isAccidental:!0},{pitch:"C1",flatName:"C1",sharpName:"C1",toneNote:"C1",frequency:32.7,column:"A",hex:"#4a2733",isAccidental:!1},{pitch:"B0",flatName:"B0",sharpName:"B0",toneNote:"B0",frequency:30.87,column:"B",hex:"#41273f",isAccidental:!1},{pitch:"B/A0",flatName:"B0",sharpName:"A0",toneNote:"Bb0",frequency:29.14,column:"A",hex:"#342a46",isAccidental:!0},{pitch:"A0",flatName:"A0",sharpName:"A0",toneNote:"A0",frequency:27.5,column:"B",hex:"#242c48",isAccidental:!1}],yF=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"],Ve=n=>n.tonicSignGroups?Object.values(n.tonicSignGroups).flat():[],dn=(n,t)=>{const e=Fe.getColumnMap(n),{macrobeatGroupings:s}=n,i=s[t]??0;let r=null,o=null;for(const A of e.entries)A.macrobeatIndex===t&&A.type==="beat"&&((r===null||A.canvasIndex!==null&&A.canvasIndex<r)&&(r=A.canvasIndex),(o===null||A.canvasIndex!==null&&A.canvasIndex>o)&&(o=A.canvasIndex));if(r===null||o===null){let A=0;const a=Ve(n);a.some(l=>l.preMacrobeatIndex===-1)&&(A+=2);for(let l=0;l<t;l++)A+=s[l]??0,a.some(c=>c.preMacrobeatIndex===l)&&(A+=2);r=A,o=r+i-1}return{startColumn:r,endColumn:o,grouping:i}},SF=n=>n.placedNotes.filter(t=>!t.isDrum),EF=n=>n.placedNotes.filter(t=>t.isDrum),xF=(n,t)=>{const s=Ve(n).filter(l=>l.columnIndex<=t);if(s.length===0)return{keyTonic:"C",keyMode:"major"};const i=s.reduce((l,c)=>c.columnIndex>l.columnIndex?c:l),r=typeof i.globalRow=="number"?i.globalRow:i.row,o=qs[r]??n.fullRowData[i.row];if(!o)return{keyTonic:"C",keyMode:"major"};const A=Gd(o.toneNote),a=yF[i.tonicNumber-1]||"major";return{keyTonic:A,keyMode:a}},fo=12,_F=50,IF=.5,jn=3,ka=1,bA=30,zA=30,XA=.5,Dm=3,FF=.7,TF=.9,QF=4,MF=1.5,UF=.15,PF=.2,NF=1,$A=1.5,DF="#CCCCCC",Tv=1,Lm=3,km=5,LF=7,xl=16,kF=0,RF=255;class HF{constructor(){I(this,"cachedMap",null);I(this,"cacheKey",null)}getColumnMap(t){const e=this.buildCacheKey(t);return this.cachedMap&&this.isCacheValid(e)?this.cachedMap:(this.cachedMap=this.buildColumnMap(t),this.cacheKey=e,this.cachedMap)}invalidate(){this.cachedMap=null,this.cacheKey=null}buildCacheKey(t){const s=Ve(t).map(i=>`${i.columnIndex}:${i.preMacrobeatIndex}:${i.uuid||""}`).sort().join("|");return{macrobeatGroupings:[...t.macrobeatGroupings],tonicSignsHash:s,macrobeatBoundaryStyles:[...t.macrobeatBoundaryStyles]}}isCacheValid(t){return this.cacheKey?this.cacheKey.tonicSignsHash===t.tonicSignsHash&&JSON.stringify(this.cacheKey.macrobeatGroupings)===JSON.stringify(t.macrobeatGroupings)&&JSON.stringify(this.cacheKey.macrobeatBoundaryStyles)===JSON.stringify(t.macrobeatBoundaryStyles):!1}buildColumnMap(t){const{macrobeatGroupings:e,macrobeatBoundaryStyles:s}=t,r=[...Ve(t)].sort((v,C)=>v.preMacrobeatIndex-C.preMacrobeatIndex),o=[],A=[];let a=0,l=0,c=0,u=0,d=0;const p=v=>{var C;for(;d<r.length;){const y=r[d];if(!y||y.preMacrobeatIndex!==v)break;const S=y.uuid||"";for(let x=0;x<2;x++)o.push({visualIndex:a,canvasIndex:l,timeIndex:null,type:"tonic",widthMultiplier:ka,xOffsetUnmodulated:u,macrobeatIndex:null,beatInMacrobeat:null,isMacrobeatStart:!1,isMacrobeatEnd:!1,isPlayable:!1,tonicSignUuid:x===0?S:null}),a++,l++,u+=ka;const F=S;do d++;while(d<r.length&&(((C=r[d])==null?void 0:C.uuid)||"")===F)}};for(let v=0;v<2;v++)o.push({visualIndex:a,canvasIndex:null,timeIndex:null,type:"legend-left",widthMultiplier:jn,xOffsetUnmodulated:u,macrobeatIndex:null,beatInMacrobeat:null,isMacrobeatStart:!1,isMacrobeatEnd:!1,isPlayable:!1,tonicSignUuid:null}),a++,u+=jn;p(-1),e.forEach((v,C)=>{for(let S=0;S<v;S++)o.push({visualIndex:a,canvasIndex:l,timeIndex:c,type:"beat",widthMultiplier:ka,xOffsetUnmodulated:u,macrobeatIndex:C,beatInMacrobeat:S,isMacrobeatStart:S===0,isMacrobeatEnd:S===v-1,isPlayable:!0,tonicSignUuid:null}),a++,l++,c++,u+=ka;const y=s[C]||"dashed";A.push({macrobeatIndex:C,visualColumn:a-1,canvasColumn:l-1,timeColumn:c-1,boundaryType:y,isMeasureStart:y==="solid"}),p(C)});for(let v=0;v<2;v++)o.push({visualIndex:a,canvasIndex:null,timeIndex:null,type:"legend-right",widthMultiplier:jn,xOffsetUnmodulated:u,macrobeatIndex:null,beatInMacrobeat:null,isMacrobeatStart:!1,isMacrobeatEnd:!1,isPlayable:!1,tonicSignUuid:null}),a++,u+=jn;const f=new Map,m=new Map,g=new Map,w=new Map,B=new Map,b=new Map;return o.forEach(v=>{f.set(v.visualIndex,v.canvasIndex),m.set(v.visualIndex,v.timeIndex),v.canvasIndex!==null&&(g.set(v.canvasIndex,v.visualIndex),w.set(v.canvasIndex,v.timeIndex)),v.timeIndex!==null&&(v.canvasIndex!==null&&B.set(v.timeIndex,v.canvasIndex),b.set(v.timeIndex,v.visualIndex))}),{entries:o,visualToCanvas:f,visualToTime:m,canvasToVisual:g,canvasToTime:w,timeToCanvas:B,timeToVisual:b,macrobeatBoundaries:A,totalVisualColumns:a,totalCanvasColumns:l,totalTimeColumns:c,totalWidthUnmodulated:u}}}const Fe=new HF;function OF(n){n.on("rhythmStructureChanged",()=>{Fe.invalidate()})}function VF(n,t){return Fe.getColumnMap(t).visualToTime.get(n)??null}function Vi(n,t){return Fe.getColumnMap(t).canvasToTime.get(n)??null}function gn(n,t){const s=Fe.getColumnMap(t).timeToCanvas.get(n);return s!==void 0?s:n}function WF(n,t){const s=Fe.getColumnMap(t).timeToVisual.get(n);return s!==void 0?s:n+2}function GF(n,t){const e=Fe.getColumnMap(t),s=e.canvasToVisual.get(n);return s!==void 0&&e.entries[s]||null}function KF(n,t){const e=GF(n,t);return(e==null?void 0:e.isPlayable)??!1}function qF(n){const t=Fe.getColumnMap(n),e=[];for(const s of t.entries)s.canvasIndex!==null&&(e[s.canvasIndex]=s.widthMultiplier);return e}function qd(n,...t){}const Sn={COMPRESSION_2_3:2/3,EXPANSION_3_2:3/2};function zF(n,t){if(!t||!t.macrobeatGroupings)return n*4;if(n===0)return 0;const e=n-1,s=dn(t,e);if(s){const r=s.endColumn+1;return qd("log","[MODULATION] Found measure info, canvas-space endColumn:",s.endColumn,"first column after:",r),r}return n*4}function Qv(n){return Math.abs(n-Sn.COMPRESSION_2_3)<.001?"2:3":Math.abs(n-Sn.EXPANSION_3_2)<.001?"3:2":`${n}`}function Mv(n){const t="#ffc107";return Math.abs(n-Sn.COMPRESSION_2_3)<.001||Math.abs(n-Sn.EXPANSION_3_2)<.001,t}function Rm(){const n=[{startColumn:0,endColumn:1/0,scale:1}];return{segments:n,getScaleForColumn(t){return 1},microbeatToCanvasX(){return 0},canvasXToMicrobeat(){return 0},getSegmentAtX(){return n[0]||null},getGhostGridPositions(){return[]}}}function XF(n,t,e=null){if(!n||n.length===0)return Rm();const s=[...n.filter(l=>l.active)].sort((l,c)=>l.measureIndex-c.measureIndex);if(s.length===0)return Rm();const i=s.map(l=>{const c=zF(l.measureIndex,e);return qd("log",`[MODULATION] Marker at measure ${l.measureIndex} calculated column=${c}`),qd("log","[MODULATION] Final marker position:",{id:l.id,measureIndex:l.measureIndex,columnIndex:c}),{...l,columnIndex:c}}),r=[];let o=1;const A=i[0];if(i.length===0||A&&A.columnIndex>0){const l=A?A.columnIndex:1/0;r.push({startColumn:0,endColumn:l,scale:1})}for(let l=0;l<i.length;l++){const c=i[l],u=i[l+1],d=u?u.columnIndex:1/0;o*=c.ratio,r.push({startColumn:c.columnIndex,endColumn:d,scale:o,marker:c})}return{segments:r,getScaleForColumn(l){for(const c of r)if(l>=c.startColumn&&l<c.endColumn)return c.scale;return 1},microbeatToCanvasX(l){return 0},canvasXToMicrobeat(l){return 0},getSegmentAtX(l){return r[0]||null},getGhostGridPositions(l,c){return[]}}}class $F{constructor(){I(this,"cachedPixelMap",null);I(this,"lastPixelMapHash",null)}getColumnPixelPosition(t,e,s){const i=this.getOrBuildPixelMap(e,s),r=i.columnPositions.get(Math.floor(t));if(r)return r;const o=i.columnPositions.size;return t===o&&i.columnPositions.get(o-1)?{canvasIndex:t,xStart:i.totalPixelWidth,xEnd:i.totalPixelWidth,width:0,modulationScale:1}:this.calculateFallbackPosition(t,e)}columnToPixelX(t,e,s){const i=Math.floor(t),r=t-i,o=this.getColumnPixelPosition(i,e,s);return o.xStart+r*o.width}pixelXToColumn(t,e,s){const i=this.getOrBuildPixelMap(e,s),r=Array.from(i.columnPositions.values()).sort((a,l)=>a.canvasIndex-l.canvasIndex);for(const a of r)if(t>=a.xStart&&t<a.xEnd){const l=(t-a.xStart)/a.width;return a.canvasIndex+l}if(r.length===0)return 0;const o=r[0];if(!o||t<o.xStart)return 0;const A=r[r.length-1];return(A==null?void 0:A.canvasIndex)??0}invalidate(){this.cachedPixelMap=null,this.lastPixelMapHash=null}getOrBuildPixelMap(t,e){const s=this.buildPixelMapHash(t,e);return this.cachedPixelMap&&this.lastPixelMapHash===s?this.cachedPixelMap:(this.cachedPixelMap=this.buildPixelMap(t,e),this.lastPixelMapHash=s,this.cachedPixelMap)}buildPixelMapHash(t,e){const s=t.modulationMarkers?JSON.stringify(t.modulationMarkers.map(i=>({id:i.id,col:i.columnIndex,ratio:i.ratio}))):"none";return JSON.stringify({cellWidth:t.cellWidth,modulation:s,columnCount:e?Fe.getColumnMap(e).totalCanvasColumns:0})}buildPixelMap(t,e){const{cellWidth:s,modulationMarkers:i}=t,r=Fe.getColumnMap(e),o=new Map,A=t.baseMicrobeatPx??s,a=i&&i.length>0?XF(i,A,e):null;let l=0;for(const c of r.entries){if(c.canvasIndex===null)continue;const u=c.widthMultiplier*s,d=a?a.getScaleForColumn(c.canvasIndex):1,p=u*d;o.set(c.canvasIndex,{canvasIndex:c.canvasIndex,xStart:l,xEnd:l+p,width:p,modulationScale:d}),l+=p}return{columnPositions:o,totalPixelWidth:l}}calculateFallbackPosition(t,e){const{cellWidth:s}=e,i=s;return{canvasIndex:t,xStart:t*i,xEnd:(t+1)*i,width:i,modulationScale:1}}}const zi=new $F;function YF(n){n.on("rhythmStructureChanged",()=>{zi.invalidate()})}function jF(n,t){const e=t.state||t;return zi.columnToPixelX(n,t,e)}function Uv(n){const t=n.state||n;return zi.getOrBuildPixelMap(n,t).totalPixelWidth}function JF(n){return qF(n)}function ZF(n,t){return n.reduce((e,s)=>e+s,0)*t}const re=9,tT=2,eT=5;function Ze(n,t,e){return Number.isFinite(n)?Math.max(t,Math.min(e,Math.round(n))):t}function nT(n){return Number.isFinite(n)?Math.max(1,n):1}function Hm(n,t,{maxStep:e=eT}={}){const s=Math.max(1,Math.round(t)),r=Math.max(1,Math.round(n))/s;let o=1;r>=.85?o=5:r>=.65?o=4:r>=.45?o=3:r>=.25?o=2:o=1;const A=Math.max(1,Math.round(e));return Math.max(1,Math.min(A,o))}function Pv(n,t,e){const s=Math.max(0,e-1),i=Math.max(1,Math.round(t)),r=(i-1)/2;let o=Math.round(n-r),A=o+i-1;if(o<0&&(A+=-o,o=0),A>s){const a=A-s;o-=a,A=s}return o=Ze(o,0,s),A=Ze(A,o,s),{topIndex:o,bottomIndex:A}}function Jn(n){return n.bottomIndex-n.topIndex+1}function Nv(n,t){const e=Math.max(0,t-1),s=Ze(n.topIndex??0,0,e),i=Ze(n.bottomIndex??e,0,e);return i<s?{topIndex:i,bottomIndex:s}:{topIndex:s,bottomIndex:i}}function Dn(n,t,e=re){const s=Nv(n,t),i=Math.max(1,Math.round(e));if(Jn(s)>=i)return s;const o=(s.topIndex+s.bottomIndex)/2;return Pv(o,i,t)}function sT(n,t,e,s=re){const i=Math.max(0,e-1),r=Ze(n.bottomIndex,0,i),o=Math.max(1,Math.round(s)),A=Math.max(0,r-(o-1));return{topIndex:Ze(t,0,A),bottomIndex:r}}function iT(n,t,e,s=re){const i=Math.max(0,e-1),r=Ze(n.topIndex,0,i),o=Math.max(1,Math.round(s)),A=Math.min(i,r+(o-1)),a=Ze(t,A,i);return{topIndex:r,bottomIndex:a}}function rT(n,t,e,s=re){const i=Math.max(0,e-1),r=Ze(n,0,i),o=Math.max(1,Math.round(s)),A=Math.max(0,r-(o-1));return Ze(t,0,A)}function oT(n,t,e,s=re){const i=Math.max(0,e-1),r=Ze(n,0,i),o=Math.max(1,Math.round(s)),A=Math.min(i,r+(o-1));return Ze(t,A,i)}function AT(n,t,e){const s=Math.max(0,e-1),i=Math.max(1,Jn(n)),r=Math.max(0,s+1-i),o=Ze(n.topIndex+t,0,r),A=Math.min(s,o+i-1);return{topIndex:o,bottomIndex:A}}function Om(n,t,{totalRanks:e,minSpan:s=re,zoomStep:i=tT}){const r=Math.max(0,e-1),o=Math.max(1,Math.round(s)),A=Math.max(0,Math.round(i)),a=Nv(n,e);if(A===0)return Dn(a,e,o);const l=Jn(a);if(t==="in"){if(l<=o)return Dn(a,e,o);const f=Math.max(o,l-2*A),m=(a.topIndex+a.bottomIndex)/2;return Pv(m,f,e)}const c=a.topIndex-A,u=a.bottomIndex+A,d=Ze(c,0,r),p=Ze(u,0,r);return Dn({topIndex:d,bottomIndex:p},e,o)}function aT(n,t,{baseUnit:e,paddingRows:s=1}){if(!n||n<=0||!t||t<=0)return 1;const i=Math.max(1,Math.round(t)+Math.max(0,Math.round(s))),r=nT(e);return 2*n/(i*r)}let to=1,po=0,Zi,Cs,zd,Xs,$s,Ws,iA,Xd,Dv,Lv,kv,Rv,Kn,ir,$d,ku=null,_l=!1,yA=!1,Ru=!1,Hu=!1,Yd=!1,Vm=0,Ra=null,mo=null,jd=0,Il=null,Ou=!1,Ha=0;const lT=new Promise(n=>{Il=()=>n()});let Vu=0,Wu=0;function Hv(){const n=document.getElementById("pitch-grid-container"),t=po||window.innerHeight||0;return(n==null?void 0:n.clientHeight)||(t?t*.7:0)}function Wm(n,t){return aT(n,t,{baseUnit:bA,paddingRows:1})}function go(){const n=h.state.fullRowData.length,t=Math.max(0,n-1),e=h.state.pitchRange||{topIndex:0,bottomIndex:t};return Dn(e,n,re)}function Fl(){mo!==null&&(cancelAnimationFrame(mo),mo=null),jd+=1,yA=!1}function Oa(n,t){const e=h.state.fullRowData.length,s=go(),i=Dn(n,e,re);if(i.topIndex===s.topIndex&&i.bottomIndex===s.bottomIndex)return;const r=s.topIndex,o=Jn(s);h.setPitchRange(i),h.emit("scrollChanged");const A=i.topIndex-r;if(A!==0&&h.emit("scrollByUnits",A),Jn(i)!==o){Bs(),h.emit("zoomChanged");return}document.dispatchEvent(new CustomEvent("canvasResized",{detail:{source:t}}))}function Va(n,t,e){Fl(),yA=!0;const s=h.state.fullRowData.length,i=go(),r=Dn(n,s,re);if(r.topIndex===i.topIndex&&r.bottomIndex===i.bottomIndex){yA=!1;return}const o=jd,A=performance.now(),a=Math.max(0,Math.round(t));let l=i.topIndex;const c=d=>d<.5?4*d*d*d:1-Math.pow(-2*d+2,3)/2,u=()=>{if(o!==jd)return;const d=performance.now(),p=a>0?(d-A)/a:1,f=Math.max(0,Math.min(1,p)),m=c(f),g=Math.round(i.topIndex+(r.topIndex-i.topIndex)*m),w=Math.round(i.bottomIndex+(r.bottomIndex-i.bottomIndex)*m),B=Dn({topIndex:g,bottomIndex:w},s,re);h.setPitchRange(B),h.emit("scrollChanged");const b=B.topIndex-l;if(b!==0&&(h.emit("scrollByUnits",b),l=B.topIndex),Bs(),h.emit("zoomChanged"),f<1){mo=requestAnimationFrame(u);return}mo=null,yA=!1};mo=requestAnimationFrame(u)}function cT(){try{if(globalThis.__SN_DEBUG_VIEWPORT)return!0}catch{}try{if(new URLSearchParams(window.location.search).get("debugViewport")==="1")return!0}catch{}try{return localStorage.getItem("sn:debugViewport")==="1"}catch{return!1}}let uT=!1;function Ov(n,t){var e;if(cT())try{const s=((e=performance==null?void 0:performance.now)==null?void 0:e.call(performance))??Date.now();if(s-Vm<500)return;Vm=s,uT=!0}catch{}}function dT(){const n=(window==null?void 0:window.devicePixelRatio)??1;return!Number.isFinite(n)||n<=0?1:n}function $i(n,t,e,s,i){if(!n)return!1;const r=Number.isFinite(s)&&s>0?s:1;n.dataset.pixelRatio=`${r}`;let o=!1;if(typeof t=="number"){const A=Math.max(1,Math.round(t*r));Math.abs(n.width-A)>.5&&(n.width=A,o=!0),n.style.width=`${t}px`,n.dataset.logicalWidth=`${t}`}if(typeof e=="number"){const A=Math.max(1,Math.round(e*r));Math.abs(n.height-A)>.5&&(n.height=A,o=!0),n.style.height=`${e}px`,n.dataset.logicalHeight=`${e}`}if(o){const A=i||n.getContext("2d");A&&A.setTransform(r,0,0,r,0,0)}return o}function hT(){Zi=document.getElementById("pitch-grid-wrapper"),Cs=document.getElementById("notation-grid"),Xs=document.getElementById("legend-left-canvas"),$s=document.getElementById("legend-right-canvas"),Ws=document.getElementById("drum-grid-wrapper"),iA=document.getElementById("drum-grid"),Dv=document.getElementById("drum-playhead-canvas"),Lv=document.getElementById("playhead-canvas"),kv=document.getElementById("hover-canvas"),Rv=document.getElementById("drum-hover-canvas"),Kn=document.getElementById("button-grid"),ir=document.getElementById("grid-scrollbar-proxy"),$d=(ir==null?void 0:ir.querySelector(".grid-scrollbar-inner"))||null;const n=document.getElementById("canvas-container");if(!Zi||!Cs||!n)return{};zd=Cs.getContext("2d"),Xd=(iA==null?void 0:iA.getContext("2d"))||null;const t=(Xs==null?void 0:Xs.getContext("2d"))||null,e=($s==null?void 0:$s.getContext("2d"))||null;return{ctx:zd,drumCtx:Xd,legendLeftCtx:t,legendRightCtx:e,canvasContainer:n}}function fT(){var e;if(Yd)return;const n=(((e=h.state.columnWidths)==null?void 0:e.length)||0)>0,t=!!(h.state.cellWidth&&h.state.cellWidth>0);!n||!t||(Yd=!0,Il==null||Il())}function Bs(){var W,H;if(!Zi||Zi.clientHeight===0){Ru||(E.warn("LayoutService","Pitch grid wrapper not ready for layout (height=0). Retrying on next frame.",null,"layout"),Ru=!0),requestAnimationFrame(Bs);return}if(Ru=!1,_l)return;_l=!0;const n=document.getElementById("pitch-grid-container");Zi.clientWidth;const t=window.innerHeight;(Math.abs(t-po)>3||po===0)&&(po=t);const s=bA,i=s*IF,r=go(),o=Hv(),A=Math.max(1,Jn(r));to=Wm(o,A);const a=Math.round(s*to),l=Math.round(i*to);h.setLayoutConfig({cellHeight:a,cellWidth:l});const c=JF(h.state);h.setLayoutConfig({columnWidths:c}),fT(),(!h.state.cellWidth||!c.length)&&E.warn("LayoutService","Unexpected layout configuration",{cellWidth:h.state.cellWidth,columnCount:c.length},"layout");const d=c.reduce((O,$)=>O+$,0)*h.state.cellWidth,p=pe.getModulatedCanvasWidth(),f=h.state.modulationMarkers&&h.state.modulationMarkers.length>0,m=f?p:d,g=jn*2*h.state.cellWidth,w=jn*2*h.state.cellWidth,B=Math.round(m+g+w),b=dT();document.getElementById("drum-grid-wrapper");const _=document.getElementById("grids-wrapper"),v=B+"px";if(n&&(n.style.width=v),Zi&&(Zi.style.width=v),Ws&&(Ws.style.width=v),$d&&ir){$d.style.width=v;const O=(_==null?void 0:_.getBoundingClientRect().width)||0;B>O?ir.style.display="":ir.style.display="none"}const C=Math.max(zA,XA*h.state.cellHeight),y=Dm*C,S=`${y}px`,F=((W=h.state.columnWidths)==null?void 0:W.length)??0;let x=0;if(f){const O={cellWidth:h.state.cellWidth,columnWidths:h.state.columnWidths,modulationMarkers:h.state.modulationMarkers,baseMicrobeatPx:h.state.cellWidth,cellHeight:h.state.cellHeight,state:h.state};x=Uv(O)}else for(let O=0;O<F;O++)x+=(h.state.columnWidths[O]||0)*h.state.cellWidth;if(F===0&&E.warn("LayoutService","Column widths array is empty.",{columnWidthsCount:F,columnWidths:h.state.columnWidths},"layout"),x<50&&F>0&&E.warn("LayoutService","Computed button-grid middle cell width is unexpectedly small.",{middleCellWidth:x,columnWidthsSample:(H=h.state.columnWidths)==null?void 0:H.slice(0,10),cellWidth:h.state.cellWidth,macrobeatGroupings:h.state.macrobeatGroupings},"layout"),Kn){const O=Kn.querySelector(".button-grid-left-cell"),$=Kn.querySelector(".button-grid-middle-cell"),L=Kn.querySelector(".button-grid-right-cell"),at=jn*2*h.state.cellWidth,G=jn*2*h.state.cellWidth;(Math.abs(Wu-y)>5||Wu===0)&&(Kn.style.height=S,Wu=y);const Y=(q,z)=>{if(!q)return;const et=`${Math.max(0,z)}px`;q.style.width=et,q.style.flex=`0 0 ${et}`,q.style.maxWidth=et,q.style.minWidth=et,q.style.height=S};if(O){Y(O,at);const q=O.getBoundingClientRect();at>0&&q.width===0&&E.warn("LayoutService","Left button-grid cell measured width is 0 after assignment.",{assignedWidth:at,measuredWidth:q.width,computedDisplay:window.getComputedStyle(O).display},"layout")}if($){x===0&&E.warn("LayoutService","Calculated middle button-grid width is 0. Check column width data.",{columnWidths:h.state.columnWidths,cellWidth:h.state.cellWidth},"layout"),Y($,x);const q=$.getBoundingClientRect();if(x>0&&q.width===0&&E.warn("LayoutService","Middle button-grid cell assigned width but still measures 0.",{assignedWidth:x,measuredWidth:q.width,computedStyles:window.getComputedStyle($)},"layout"),Math.abs(q.width-x)>5&&(E.warn("LayoutService","Middle cell measured width does not match assigned width.",{assignedWidth:x,measuredWidth:q.width,styleWidth:$.style.width,cellWidth:h.state.cellWidth},"layout"),requestAnimationFrame(()=>{const z=$.getBoundingClientRect();Math.abs(z.width-x)>5&&E.warn("LayoutService","Middle cell still mismatched after RAF.",{assignedWidth:x,measuredWidth:z.width,delta:z.width-x,computedStyles:window.getComputedStyle($)},"layout")})),!Hu){const z=$.querySelector("#beat-line-button-layer");if(z){const et=z.getBoundingClientRect();if(et.width===0){const Z=window.getComputedStyle(z);E.warn("LayoutService","#beat-line-button-layer width is 0 despite middle cell sizing.",{beatLineRect:et,beatLineStyles:{display:Z.display,position:Z.position,flex:{direction:Z.flexDirection,grow:Z.flexGrow,shrink:Z.flexShrink,basis:Z.flexBasis},width:Z.width,minWidth:Z.minWidth,maxWidth:Z.maxWidth},middleRect:q,middleCellComputedWidth:Z.width},"layout"),Hu=!0}}else E.warn("LayoutService","Could not find #beat-line-button-layer inside middle cell to measure.",null,"layout"),Hu=!0}}if(L){Y(L,G);const q=L.getBoundingClientRect();G>0&&q.width===0&&E.warn("LayoutService","Right button-grid cell measured width is 0 after assignment.",{assignedWidth:G,measuredWidth:q.width,computedDisplay:window.getComputedStyle(L).display},"layout")}const nt=at+x+G;Number.isFinite(nt)&&nt>0&&(Kn.style.width=v,Kn.style.maxWidth=v,Kn.style.minWidth=v),Kn.getBoundingClientRect().width===0&&E.warn("LayoutService","Entire button grid wrapper width is 0 after layout pass.",{leftCellWidth:at,middleCellWidth:x,rightCellWidth:G,wrapperStyles:window.getComputedStyle(Kn)},"layout")}const Q=Math.max(zA,XA*h.state.cellHeight),T=Dm*Q,U=`${T}px`,P=(n==null?void 0:n.clientHeight)||0;if(P>0){const O=h.state.cellHeight,$=h.state.cellWidth,L=Math.max(1,Jn(r)),at=Wm(P,L),G=Math.round(s*at),X=Math.round(i*at);h.setLayoutConfig({cellHeight:G,cellWidth:X}),to=at,(G!==O||X!==$)&&(Ou=!0)}const K=Math.round(jn*2*h.state.cellWidth),M=Math.round(jn*2*h.state.cellWidth),k=Math.round(m),N=[{element:Cs,context:zd},{element:Lv},{element:kv}];if(N.forEach(({element:O,context:$})=>{$i(O,k,P,b,$),O&&(O.style.left=`${K}px`)}),$i(Xs,K,P,b,null),$i($s,M,P,b,null),[{element:iA,context:Xd},{element:Dv},{element:Rv}].forEach(({element:O,context:$})=>{$i(O,k,T,b,$)}),Ws){const O=Ws.querySelector(".drum-grid-left-cell"),$=Ws.querySelector(".drum-grid-middle-cell"),L=Ws.querySelector(".drum-grid-right-cell"),at=(X,V)=>{if(!X)return;const Y=`${Math.max(0,Math.round(V))}px`;X.style.width=Y,X.style.flex=`0 0 ${Y}`,X.style.maxWidth=Y,X.style.minWidth=Y,X.style.height=U};at(O,K),at($,k),at(L,M);const G=$==null?void 0:$.querySelector("#drum-canvas-wrapper");G&&(G.style.width="100%",G.style.height=U)}const tt=Math.abs(Vu-T)>5||Vu===0;Ws&&tt&&(Ws.style.height=U,Vu=T);const rt=b,lt=k;Ra&&clearTimeout(Ra),Ra=setTimeout(()=>{var L,at,G;Ra=null;const O=document.getElementById("pitch-grid-container"),$=(O==null?void 0:O.clientHeight)||0;N.forEach(({element:X,context:V})=>{$i(X,lt,$,rt,V),X&&(X.style.left=`${K}px`)}),$i(Xs,K,$,rt,null),$i($s,M,$,rt,null),Ov("deferredResize",{finalContainerHeight:$,pitchCanvasLogicalHeight:(L=Cs==null?void 0:Cs.dataset)==null?void 0:L.logicalHeight,legendLeftLogicalHeight:(at=Xs==null?void 0:Xs.dataset)==null?void 0:at.logicalHeight,legendRightLogicalHeight:(G=$s==null?void 0:$s.dataset)==null?void 0:G.logicalHeight}),document.dispatchEvent(new CustomEvent("canvasResized",{detail:{source:"layoutService-deferred"}}))});try{const O=h.state.fullRowData.length,$=Math.max(0,O-1),L=h.state.pitchRange||{topIndex:0,bottomIndex:$},at=Dn(L,O,re);(L.topIndex!==at.topIndex||L.bottomIndex!==at.bottomIndex)&&h.setPitchRange(at)}catch{}h.emit("layoutConfigChanged"),_l=!1,Ou?(Ou=!1,Ha<1?(Ha+=1,requestAnimationFrame(Bs)):E.warn("LayoutService","Skipped additional layout pass after repeated final zoom adjustments.",{finalRecalcAttempts:Ha},"layout")):Ha=0}const pe={init(){const{ctx:n,drumCtx:t,legendLeftCtx:e,legendRightCtx:s}=hT();requestAnimationFrame(Bs),this.initScrollHandler();const i=()=>{_l||(ku!==null&&clearTimeout(ku),ku=setTimeout(()=>{Bs()},_F))};return window.addEventListener("resize",i),h.on("zoomIn",r=>{this.zoomIn(r)}),h.on("zoomOut",r=>{this.zoomOut(r)}),{ctx:n,drumCtx:t,legendLeftCtx:e,legendRightCtx:s}},waitForInitialLayout(){return Yd?Promise.resolve():lT},getCurrentZoomLevel(){return to},setZoomLevel(n){const t=Number.isFinite(n)&&n>0?n:1,e=Hv(),s=h.state.fullRowData.length,i=Math.max(0,s-1);if(!s||s<=0)return;const r=2*e/(t*bA),o=Math.max(re,Math.min(s,Math.round(r)-1)),A=go(),a=(A.topIndex+A.bottomIndex)/2,l=(o-1)/2;let c=Math.round(a-l),u=c+o-1;if(c<0&&(u+=-c,c=0),u>i){const d=u-i;c-=d,u=i}Oa({topIndex:c,bottomIndex:u},"setZoomLevel")},setPitchViewportRange(n,t={}){const e=t.source??"setPitchViewportRange",s=Math.max(0,Math.round(t.animateMs??0));if(s>0){Va(n,s);return}Oa(n,e)},_canScrollRange(n){const t=h.state.pitchRange;if(!t||!qs||qs.length===0)return!1;const e=qs.length-1,s=typeof n=="string"?n==="up"?-1:1:n,i=s<0&&t.topIndex>0,r=s>0&&t.bottomIndex<e;return i||r},initScrollHandler(){const n=document.getElementById("pitch-grid-wrapper");n&&n.addEventListener("wheel",t=>{if(t.preventDefault(),t.ctrlKey||t.metaKey)t.deltaY<0?this.zoomIn({source:"wheel"}):this.zoomOut({source:"wheel"});else{const e=t.deltaY>0?1:-1;this._canScrollRange(e)&&this.scrollByUnits(e)}},{passive:!1})},zoomIn(n){const t=h.state.fullRowData.length;if(!t)return;const e=go(),s=Jn(e),i=Hm(s,t),r=Om(e,"in",{totalRanks:t,minSpan:re,zoomStep:i}),o=Jn(r),A=(n==null?void 0:n.source)??"unknown",a=A==="wheel"?0:280;E.debug("LayoutService",`[Zoom] Range zoom in (span ${s} -> ${o})`,{source:A},"layout"),a>0?Va(r,a):(Oa(r,`zoomIn:${A}`),h.emit("zoomChanged"))},zoomOut(n){const t=h.state.fullRowData.length;if(!t)return;const e=go(),s=Jn(e),i=Hm(s,t),r=Om(e,"out",{totalRanks:t,minSpan:re,zoomStep:i}),o=Jn(r),A=(n==null?void 0:n.source)??"unknown",a=A==="wheel"?0:280;E.debug("LayoutService",`[Zoom] Range zoom out (span ${s} -> ${o})`,{source:A},"layout"),a>0?Va(r,a):(Oa(r,`zoomOut:${A}`),h.emit("zoomChanged"))},resetZoom(n){const t=h.state.fullRowData.length;if(!t)return;const e=Math.max(0,t-1);n==null||n.source,Va({topIndex:0,bottomIndex:e},320)},scroll(n){const e=this.getViewportInfo().startRank;h.emit("scrollChanged");const r=this.getViewportInfo().startRank-e;r!==0&&h.emit("scrollByUnits",r),h.emit("layoutConfigChanged")},scrollByUnits(n){Fl();const t=h.state.pitchRange;if(!t||!qs||qs.length===0)return;const e=Math.sign(n||0);if(e===0)return;const s=qs.length,i=Dn(t,s,re),r=AT(i,e,s);r.topIndex===i.topIndex&&r.bottomIndex===i.bottomIndex||(h.setPitchRange(r),h.emit("scrollChanged"),h.emit("scrollByUnits",e),document.dispatchEvent(new CustomEvent("canvasResized",{detail:{source:"viewportScroll"}})))},setViewportTopIndex(n){Fl();const t=h.state.pitchRange||{topIndex:0,bottomIndex:Math.max(0,h.state.fullRowData.length-1)},e=h.state.fullRowData.length,s=Dn(t,e,re),i=sT(s,n,e,re),r=i.topIndex-(s.topIndex??0);i.topIndex===s.topIndex&&i.bottomIndex===s.bottomIndex||(h.setPitchRange(i),h.emit("scrollChanged"),r!==0&&h.emit("scrollByUnits",r),Bs(),h.emit("zoomChanged"))},setViewportBottomIndex(n){Fl();const t=h.state.pitchRange||{topIndex:0,bottomIndex:Math.max(0,h.state.fullRowData.length-1)},e=h.state.fullRowData.length,s=Dn(t,e,re),i=iT(s,n,e,re),r=i.topIndex-(s.topIndex??0);E.debug("LayoutService","setViewportBottomIndex",{requestedBottom:n,currentRange:t,normalized:s,nextRange:i,willUpdate:!(i.topIndex===s.topIndex&&i.bottomIndex===s.bottomIndex)},"layout"),!(i.topIndex===s.topIndex&&i.bottomIndex===s.bottomIndex)&&(h.setPitchRange(i),h.emit("scrollChanged"),r!==0&&h.emit("scrollByUnits",r),Bs(),h.emit("zoomChanged"))},scrollByPixels(n,t=0){const s=this.getViewportInfo().startRank;h.state.fullRowData.length,h.state.cellHeight,h.emit("scrollChanged");const o=this.getViewportInfo().startRank-s;o!==0&&h.emit("scrollByUnits",o),h.emit("layoutConfigChanged")},getViewportInfo(){var _,v,C,y,S,F;const n=h.state.fullRowData.length,t=Math.max(0,n-1),e=document.getElementById("pitch-grid-container"),s=(e==null?void 0:e.clientHeight)||po*.7,i=h.state.cellHeight||bA,r=i/2,o=Dn(h.state.pitchRange||{topIndex:0,bottomIndex:t},n,re),A=Math.max(0,Math.min(t,o.topIndex??0)),a=Math.max(A,Math.min(t,o.bottomIndex??t)),l=Math.min(n,a+1),c=A*r,u=document.getElementById("legend-left-canvas"),d=document.getElementById("legend-right-canvas"),p=r?s/r:0,f=Math.max(1,a-A+1),m=f*r,g=h.state.fullRowData[A],w=h.state.fullRowData[a],B=A<=0,b=a>=t;return Ov("getViewportInfo",{containerHeight:s,containerRectHeight:(_=e==null?void 0:e.getBoundingClientRect)==null?void 0:_.call(e).height,cellHeight:i,halfUnit:r,ratio:p,rowCount:f,coveragePx:m,coverageGapPx:s-m,totalRanks:n,pitchRange:o,startRank:A,endRank:l,atTopGamutEdge:B,atBottomGamutEdge:b,scrollOffset:c,startRowSummary:g?{pitch:g.pitch,column:g.column,isBoundary:!!g.isBoundary}:null,endRowSummary:w?{pitch:w.pitch,column:w.column,isBoundary:!!w.isBoundary}:null,pitchCanvasLogicalHeight:(v=Cs==null?void 0:Cs.dataset)==null?void 0:v.logicalHeight,legendLeftLogicalHeight:(C=u==null?void 0:u.dataset)==null?void 0:C.logicalHeight,legendRightLogicalHeight:(y=d==null?void 0:d.dataset)==null?void 0:y.logicalHeight,legendLeftCssHeight:(S=u==null?void 0:u.getBoundingClientRect)==null?void 0:S.call(u).height,legendRightCssHeight:(F=d==null?void 0:d.getBoundingClientRect)==null?void 0:F.call(d).height}),{zoomLevel:to,viewportHeight:po,containerHeight:s,cellHeight:i,halfUnit:r,startRank:A,endRank:l,scrollOffset:c}},getMacrobeatWidthPx(n,t){return t*n.cellWidth},getColumnX(n){const t=h.state.cellWidth||40,e=h.state.columnWidths||[];return jF(n,{cellWidth:t,columnWidths:e,modulationMarkers:h.state.modulationMarkers,baseMicrobeatPx:t,state:h.state})},getCanvasWidth(){return ZF(h.state.columnWidths,h.state.cellWidth)},getModulatedCanvasWidth(){const n=this.getCanvasWidth();if(!h.state.modulationMarkers||h.state.modulationMarkers.length===0)return n;try{const t=h.state.cellWidth||40,e=h.state.columnWidths||[],s={cellWidth:t,columnWidths:e,modulationMarkers:h.state.modulationMarkers,baseMicrobeatPx:t,cellHeight:h.state.cellHeight||40,state:h.state};return Uv(s)}catch{return n}},recalculateLayout(){Bs()},reflow(){Bs()},get isZooming(){return yA}};let Gu=null,Ku=null,qu=null,zu=null;const YA={setContexts({ctx:n,drumCtx:t,legendLeftCtx:e,legendRightCtx:s}){Gu=n??null,Ku=t??null,qu=e??null,zu=s??null},getPitchContext(){return Gu||E.error("CanvasContextService","Pitch context requested before it was set.",null,"canvas"),Gu},getDrumContext(){return Ku||E.error("CanvasContextService","Drum context requested before it was set.",null,"canvas"),Ku},getLegendLeftContext(){return qu||E.error("CanvasContextService","Legend left context requested before it was set.",null,"canvas"),qu},getLegendRightContext(){return zu||E.error("CanvasContextService","Legend right context requested before it was set.",null,"canvas"),zu}},je={getViewportInfo:()=>pe.getViewportInfo(),setViewportTopIndex(n){var t;(t=pe.setViewportTopIndex)==null||t.call(pe,n)},setViewportBottomIndex(n){var t;(t=pe.setViewportBottomIndex)==null||t.call(pe,n)},setPitchViewportRange(n,t={}){var e;(e=pe.setPitchViewportRange)==null||e.call(pe,n,t)}};let wo=null,vo=null;h.on("modulationMarkersChanged",()=>{});h.on("scrollChanged",()=>{wo=null,vo=null});h.on("zoomChanged",()=>{wo=null,vo=null});h.on("pitchRangeChanged",()=>{wo=null,vo=null});function Ap(){const n=performance.now();return(!wo||!vo||n-vo>1)&&(wo=je.getViewportInfo(),vo=n),wo}function it(n,t){const e=h.state,s={cellWidth:t.cellWidth,modulationMarkers:t.modulationMarkers,baseMicrobeatPx:t.baseMicrobeatPx,columnWidths:t.columnWidths,state:e};return zi.columnToPixelX(n,s,e)}function Bt(n,t){const e=Ap(),s=n-e.startRank,i=t.cellHeight/2;return(s+1)*i}function pT(n){let t=(n||"").replace(/\d/g,"").trim();return t=t.replace(/b/g,"b-").replace(/#/g,"b_"),t}function mT(n){switch(n){case"C":return{lineWidth:3.33,dash:[],color:"#adb5bd"};case"E":return{lineWidth:1,dash:[5,5],color:"#adb5bd"};case"G":return{lineWidth:1,dash:[],color:"#dee2e6"};case"B":case"A":case"F":case"Eb/Db":case"Db/C#":return{lineWidth:1,dash:[],color:"#ced4da"};default:return{lineWidth:1,dash:[],color:"#ced4da"}}}function gT(){const n=Ap(),{startRank:t,endRank:e}=n,s=Math.max(t,e-1);return{startRow:t,endRow:s}}function Jd(n,t){const e=h.state,s={cellWidth:t.cellWidth,modulationMarkers:t.modulationMarkers,baseMicrobeatPx:t.baseMicrobeatPx,columnWidths:t.columnWidths,state:e};return zi.pixelXToColumn(n,s,e)}function wT(n,t){const e=Ap(),s=t.cellHeight/2;return n/s-1+e.startRank}function Vv(n,t){return t.some(e=>e.columnIndex===n)}function Zd(n,t){return t.some(e=>n===e.columnIndex||n===e.columnIndex+1)}function jA(n,t){const e=Ve(t);return!Zd(n,e)}function Wv(n,t){for(const e of t)if(n===e.columnIndex+1)return!1;return t.some(e=>n===e.columnIndex+2),!0}function vT(n){const t=new Set;return n.forEach(e=>{t.add(e.columnIndex),t.add(e.columnIndex+1)}),t}function He(n){var s;if(!n)return 0;const t=(s=n.dataset)==null?void 0:s.logicalWidth,e=t!==void 0?Number(t):NaN;return Number.isFinite(e)?e:n.width||0}function ie(n){var s;if(!n)return 0;const t=(s=n.dataset)==null?void 0:s.logicalHeight,e=t!==void 0?Number(t):NaN;return Number.isFinite(e)?e:n.height||0}function BT(n){var s;if(!n)return 1;const t=(s=n.dataset)==null?void 0:s.pixelRatio,e=t!==void 0?Number(t):NaN;return Number.isFinite(e)&&e>0?e:1}const Xu={stroke:"#c7cfd8",background:"rgba(207, 214, 222, 0.32)"};let Wa=null;function Gv(){if(Wa)return Wa;if(typeof window>"u")return Xu;const n=window.getComputedStyle(document.documentElement);return Wa={stroke:n.getPropertyValue("--c-anacrusis-border").trim()||Xu.stroke,background:n.getPropertyValue("--c-anacrusis-bg").trim()||Xu.background},Wa}function CT(n){if(n.length===0)return[];const t=[...n].sort((s,i)=>s.start-i.start),e=[];for(const s of t){if(e.length===0){e.push({...s});continue}const i=e[e.length-1];s.start<=i.end?i.end=Math.max(i.end,s.end):e.push({...s})}return e}function bT(n){const t=[],e=ST();return e!==null&&e>0&&t.push({start:it(0,n),end:it(e,n)}),Ve(h.state).forEach(i=>{const r=it(i.columnIndex,n),o=it(i.columnIndex+2,n);t.push({start:r,end:o})}),CT(t)}function yT(n,t,e){const s=new Set([n,t]);e.forEach(o=>{const A=Math.max(n,Math.min(t,o.start)),a=Math.max(n,Math.min(t,o.end));a>A&&(s.add(A),s.add(a))});const i=Array.from(s).sort((o,A)=>o-A),r=[];for(let o=0;o<i.length-1;o++){const A=i[o],a=i[o+1],l=(A+a)/2,c=e.some(u=>l>=u.start&&l<u.end);a>A&&r.push({from:A,to:a,light:c})}return r}function ST(){const n=h.state;if(!(n!=null&&n.hasAnacrusis)||!Array.isArray(n.macrobeatBoundaryStyles))return null;const t=n.macrobeatBoundaryStyles.findIndex(s=>s==="solid");if(t<0)return null;const e=dn(n,t);return e?e.endColumn+1:null}function ET(n,t,e,s){const i=bT(t),{stroke:r}=Gv();for(let o=e;o<=s;o++){const A=t.fullRowData[o];if(!A||A.isBoundary)continue;const a=Bt(o,t);if(a<-10||a>t.viewportHeight+10)continue;const l=pT(A.pitch);if(["B","A","F","E/D","D/C"].includes(l))continue;const u=mT(l),d=t.musicalColumnWidths&&t.musicalColumnWidths.length>0?t.musicalColumnWidths:t.columnWidths||[],p=it(0,t),f=it(d.length,t),m=yT(p,f,i);l==="G"?m.forEach(g=>{const w=g.to-g.from;w<=0||(n.save(),n.fillStyle=g.light?r:u.color,n.globalAlpha=g.light?.5:1,n.fillRect(g.from,a-t.cellHeight/2,w,t.cellHeight),n.restore())}):m.forEach(g=>{g.to-g.from<=0||(n.beginPath(),n.moveTo(g.from,a),n.lineTo(g.to,a),n.lineWidth=u.lineWidth,n.strokeStyle=g.light?r:u.color,n.setLineDash(u.dash),n.globalAlpha=g.light?.6:1,n.stroke(),n.setLineDash([]),n.globalAlpha=1)})}}function xT(n,t,e,s){ET(n,t,e,s)}function _T(n,t){IT(n,t)}function IT(n,t){const{columnWidths:e,macrobeatGroupings:s,macrobeatBoundaryStyles:i,placedTonicSigns:r}=t,A=(t.musicalColumnWidths&&t.musicalColumnWidths.length>0?t.musicalColumnWidths:e).length,a=s.map((l,c)=>{const{endColumn:u}=dn(h.state,c);return u+1});for(let l=0;l<=A;l++){const c=l===0||l===A,u=Vv(l,r),d=r.some(w=>l===w.columnIndex+2),p=a.includes(l);if(!Wv(l,r))continue;let m=null;if(c||u||d)m={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(p){const w=a.indexOf(l),B=i[w]??"dashed";if(B==="anacrusis"){const{stroke:b}=Gv();m={lineWidth:1,strokeStyle:b,dash:[4,4]}}else m={lineWidth:1,strokeStyle:"#adb5bd",dash:B==="solid"?[]:[5,5]}}if(!m)continue;const g=it(l,t);n.beginPath(),n.moveTo(g,0),n.lineTo(g,ie(n.canvas)),n.lineWidth=m.lineWidth,n.strokeStyle=m.strokeStyle,n.setLineDash(m.dash),n.stroke()}n.setLineDash([])}let Gm=0;function Kv(){try{if(globalThis.__SN_DEBUG_VIEWPORT)return!0}catch{}try{if(new URLSearchParams(window.location.search).get("debugViewport")==="1")return!0}catch{}try{return localStorage.getItem("sn:debugViewport")==="1"}catch{return!1}}let FT=!1;function TT(n,t){var e;if(Kv())try{const s=((e=performance==null?void 0:performance.now)==null?void 0:e.call(performance))??Date.now();if(s-Gm<500)return;Gm=s,FT=!0}catch{}}const Km=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"];function QT(n){const t=n.replace(/\d+$/,"");return t.length>0?t:n}function qv(n,t){return!Number.isFinite(t)||t<=0?n:Math.round(n*t)/t}function MT(n,t,e,s){const i=Math.max(10,Math.min(n*1.2,t*1.2)),r=e<=3?1:.7,o=s<=1?1.08:1;return qv(i*r*o,s)}function UT(n,t){const e=t[n];if(!e)return null;const i=e.pitch.replace(/\d+$/,"");return(i.includes("/")?i.split("/")[0]??i:i).replace(//g,"b").replace(//g,"#")}function PT(n,t){if(!n||!t)return[];const e=t-1;if(e<0||e>=Km.length)return E.warn("LegendRenderer",`Invalid tonic number: ${t}`,null,"grid"),[];const s=Km[e];try{const i=`${n} ${s}`;return bF(i).notes||[]}catch(i){return E.warn("LegendRenderer",`Could not generate ${s} scale`,{tonic:n,error:i},"grid"),[]}}function Ac(n){return n?n.replace(/\d+$/,"").replace(/T-/g,"b").replace(/T_/g,"#").replace(/-/g,"b").replace(/_/g,"#").replace(//g,"b").replace(//g,"#"):""}function NT(n){const t=new Set;return n.forEach(e=>{const s=Ac(e);if(s){t.add(s);try{const i=Ac(CA(s));i&&t.add(i)}catch{}}}),t}function qm(n,t){if(!t.size)return!0;const e=Ac(n.toneNote||n.pitch);if(!e)return!1;if(t.has(e))return!0;try{const s=Ac(CA(e));if(s&&t.has(s))return!0}catch{}return e.includes("/")?e.split("/").some(s=>t.has(s)):!1}function DT(n,t,e,s,i){const{fullRowData:r,columnWidths:o,cellWidth:A,cellHeight:a,colorMode:l}=e,c=l??"color",{sharp:u,flat:d}=h.state.accidentalMode,{focusColours:p,showFrequencyLabels:f}=h.state,m=e.showOctaveLabels??!0,g=S=>m?S:QT(S),w=(S,F)=>{var lt;if(!Kv())return;const x=a/2,Q=ie(S.canvas),T=Bt(i,e),U=T+x,P=((lt=document.getElementById("pitch-grid-container"))==null?void 0:lt.clientHeight)??null,K=r.length,M=s<=0,k=i>=K-1,N=W=>{if(W===null)return null;const H=r[W];return H?{rowIndex:W,pitch:H.pitch,column:H.column,isBoundary:!!H.isBoundary}:{rowIndex:W,exists:!1}},R=W=>{let H=null,O=null;for(let $=s;$<=i;$++){const L=r[$];!L||L.isDummy||L.column===W&&(H===null&&(H=$),O=$)}return{first:H,last:O}},J=R("A"),tt=R("B"),rt=W=>{if(W===null)return null;const H=Bt(W,e);return{rowIndex:W,y:H,topEdge:H-x,bottomEdge:H+x,gapCanvasMinusBottomEdge:Q-(H+x)}};TT("legendCoverage",{side:F,startRow:s,endRow:i,atTopGamutEdge:M,atBottomGamutEdge:k,cellHeight:a,halfUnit:x,yEnd:T,bottomEdge:U,canvasHeight:Q,gapCanvasMinusBottomEdge:Q-U,containerHeight:P,gapCanvasMinusContainer:typeof P=="number"?Q-P:null,startRowSummary:N(s),endRowSummary:N(i),firstLastA:{...J,firstSummary:N(J.first),lastSummary:N(J.last)},firstLastB:{...tt,firstSummary:N(tt.first),lastSummary:N(tt.last)},aLastCoverage:rt(J.last),bLastCoverage:rt(tt.last)})};let B=[],b=new Set;if(p){const S=Ve(h.state),F=new Set;S.length||E.info("LegendRenderer","Focus Colours ON but no tonic placements found",null,"grid"),S.forEach(x=>{const Q=UT(x.row,r),T=PT(Q,x.tonicNumber);E.debug("LegendRenderer","Focus Colours tonic scale",{tonicNote:Q,tonicNumber:x.tonicNumber,scaleNotes:T},"grid"),T.forEach(U=>F.add(U))}),B=Array.from(F),E.debug("LegendRenderer","Focus Colours combined scale",{focusScale:B},"grid"),b=NT(B)}const _=(S,F=[],x=null)=>{if(f){const K=p&&b.size>0,M=x?qm(x,b):!1;return K&&x&&!M?null:x&&x.frequency?String(x.frequency):S}if(!x){if(!S.includes("/"))return g(S);const K=S.slice(-1),M=S.substring(0,S.length-1),[k,N]=M.split("/");return g(u&&d?`${k}/${N}${K}`:u?`${N}${K}`:d?`${k}${K}`:`${N}${K}`)}const{flatName:Q,sharpName:T,isAccidental:U}=x;if(!U)return g(Q);let P;return u&&d?P=x.pitch:u&&!d?P=T:d&&!u?P=Q:P=T,g(P)},v=()=>!u&&!d,C=S=>{S.clearRect(0,0,He(S.canvas),ie(S.canvas))};function y(S,F,x,Q){const T=jn*2*A,U=[T/2,T/2],P=BT(S.canvas),K=R=>qv(R,P);let M=0,k=0,N=0;x.forEach((R,J)=>{const tt=U[J]??0;for(let rt=s;rt<=i;rt++){const lt=r[rt];if(!(!lt||lt.isDummy)&&lt.column===R){const W=Bt(rt,e),H=lt.isAccidental??lt.pitch.includes("/"),O=!f&&H&&v(),$=qm(lt,b),L=_(lt.pitch,Q,lt);if(L===null)continue;const at=!!lt.isBoundary;let G=c==="bw"?"#ffffff":lt.hex||"#ffffff";p&&!$&&!f&&(G="#ffffff");const X=O||at?"00":p&&!$?"55":"FF";p&&b.size>0&&(N+=1,$||(k+=1)),S.fillStyle=O?"rgba(255,255,255,0)":G,S.fillRect(M,W-a/2,tt,a);const V=MT(A,a,L.length,P);S.font=`bold ${V}px 'Atkinson Hyperlegible', sans-serif`,S.textAlign="center",S.textBaseline="middle";const Y=K(M+tt/2),nt=K(W);S.strokeStyle=`#212529${X}`,S.lineWidth=Math.max(1.2,2.5/P),S.lineJoin="round",S.strokeText(L,Y,nt),S.fillStyle=`#ffffff${X}`,S.fillText(L,Y,nt)}}M+=tt}),p&&b.size>0&&E.debug("LegendRenderer","Focus filter summary (separate)",{side:F===0?"left":"right",startCol:F,relevantScale:Q,totalLabels:N,filteredLabels:k},"grid")}n&&(C(n),w(n,"left"),y(n,0,["B","A"],B)),t&&(C(t),w(t,"right"),y(t,o.length,["A","B"],B))}const zv={0:{degree:1,alt:0},1:{degree:2,alt:-1},2:{degree:2,alt:0},3:{degree:3,alt:-1},4:{degree:3,alt:0},5:{degree:4,alt:0},6:{degree:5,alt:-1},7:{degree:5,alt:0},8:{degree:6,alt:-1},9:{degree:6,alt:0},10:{degree:7,alt:-1},11:{degree:7,alt:0}};function LT(n){if(Math.abs(n.num)!==8||n.alt>=0)return null;const e=(n.semitones%12+12)%12;return zv[e]||null}function zm(n){if(!n)return null;const t=jI(n);if((t==null?void 0:t.num)===void 0)return null;const e=LT(t);if(e){const a=e.degree,l=e.alt;let c="";return l<0?c="".repeat(Math.abs(l)):l>0&&(c="".repeat(l)),`${c}${a}`}const s=(t.semitones%12+12)%12,i=zv[s];if(!i){const a=Math.abs(t.num),l=t.alt;let c="";return l<0?c="".repeat(Math.abs(l)):l>0&&(c="".repeat(l)),`${c}${a}`}const r=i.degree,o=i.alt;let A="";return o<0?A="".repeat(Math.abs(o)):o>0&&(A="".repeat(o)),`${A}${r}`}function Xm(n){return n&&{"1":"2","2":"1","2":"3","3":"2","4":"5","5":"4","5":"6","6":"5","6":"7","7":"6"}[n]||null}function $m(n){return!!(n&&(n.includes("")||n.includes("")))}const $u={getEnharmonicDegree:Xm,hasAccidental:$m,getDegreeForNote(n,t){var u;if(!n||!t)return null;const{keyTonic:e,keyMode:s}=xF(t,n.startColumnIndex);if(!e)return null;const i=n.globalRow??n.row,r=(u=t.fullRowData[i])==null?void 0:u.toneNote;if(!r)return null;const o=Gd(r)||r;let A=e;if(t.degreeDisplayMode!=="modal"&&s!=="major"){const p=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"].indexOf(s);if(p>0){const m=["1P","2M","3M","4P","5P","6M","7M"][p];if(m){const g=JI(m);A=ho(e,g)||A}}}const l=Um(A,o),c=zm(l);if(n.enharmonicPreference&&c&&$m(c)){const d=Xm(c);if(d)return d}return c},getDegreesForNotes(n,t){return!n||n.length===0?[]:n.map(e=>{const s=Gd(e)||e,i=Um(t,s);return zm(i)}).filter(e=>e!==null)},getRomanNumeralForNotes(n,t){if(!n||n.length<2)return null;const[e]=WI(n);if(!e)return null;const s=oF(e),i=s==null?void 0:s.symbol;if(!i)return null;const[r]=vF(t,[i]);if(!r)return null;const o=qA(r),A=o==null?void 0:o.roman;if(!A)return null;let a=o.name.replace(A,"");const l=(s==null?void 0:s.tonic)||t;return a==="6"&&(a="add6"),{roman:A,ext:a,root:l}}},th="",eh="",ac="/",_a=()=>window.animationEffectsManager,nh=()=>h.state.placedNotes,lc=n=>{const t=n==null?void 0:n.split("-")[1];return Number.parseInt(t??"0",10)};function Xv(n){if(!n||typeof n.startColumnIndex!="number"||typeof n.endColumnIndex!="number")return!1;const t=n.shape==="circle"?n.startColumnIndex+1:n.startColumnIndex;return n.endColumnIndex>t}function $v(n,t,e){const{cellWidth:s}=e,i=s*.25,r=n.uuid;if(!r)return 0;const o=t.filter(l=>!l.isDrum&&l.row===n.row&&l.startColumnIndex===n.startColumnIndex&&l.uuid&&l.uuid!==r);if(o.length===0)return 0;const A=[n,...o];return A.sort((l,c)=>lc(l.uuid)-lc(c.uuid)),A.findIndex(l=>l.uuid===r)*i}function Yv(n,t){var r,o;const{cellHeight:e}=t,s=_a();return(r=s==null?void 0:s.shouldAnimateNote)!=null&&r.call(s,n)?(((o=s.getVibratoYOffset)==null?void 0:o.call(s,n.color))??0)*e:0}function jv(n,t,e){const s=_a(),i=s==null?void 0:s.hasReverbEffect;if(!(typeof i=="function"?i(t.color):!!i))return{shouldApply:!1,blur:0,spread:0};const{cellWidth:o}=e,A=s==null?void 0:s.getReverbEffect,a=typeof A=="function"?A(t.color):void 0;if(!a)return{shouldApply:!1,blur:0,spread:0};const l=a.blur*(o/2),c=a.spread*(o/3);return{shouldApply:l>0||c>0,blur:l,spread:c}}function Jv(n,t,e,s,i,r,o){var c,u;const A=_a();if(!((c=A==null?void 0:A.hasDelayEffect)!=null&&c.call(A,t.color)))return;const{cellWidth:a}=e,l=(u=A.getDelayEffects)==null?void 0:u.call(A,t.color);!l||l.length===0||l.forEach((d,p)=>{const f=d.delay/500*a*2,m=s+f,g=r*d.scale,w=o*d.scale;n.save(),n.globalAlpha=d.opacity*.6,n.beginPath(),n.ellipse(m,i,g,w,0,0,2*Math.PI),n.strokeStyle=t.color,n.lineWidth=Math.max(.5,g*.1),n.setLineDash([2,2]),n.stroke(),n.restore()})}function Zv(n,t,e,s,i,r){var c,u;const o=_a();if(!((c=o==null?void 0:o.shouldFillNote)!=null&&c.call(o,t)))return;const A=((u=o.getFillLevel)==null?void 0:u.call(o,t))??0;if(A<=0)return;n.save();const a=1-A,l=n.createRadialGradient(e,s,0,e,s,Math.max(i,r));l.addColorStop(0,"transparent"),l.addColorStop(Math.max(0,a-.05),"transparent"),l.addColorStop(a,`${t.color}1F`),l.addColorStop(1,`${t.color}BF`),n.beginPath(),n.ellipse(e,s,i,r,0,0,2*Math.PI),n.clip(),n.fillStyle=l,n.fillRect(e-i-10,s-r-10,(i+10)*2,(r+10)*2),n.restore()}function kT(n,t,e,s,i,r){var p,f;const o=_a();if(!((p=o==null?void 0:o.shouldFillNote)!=null&&p.call(o,t)))return;const A=((f=o.getFillLevel)==null?void 0:f.call(o,t))??0;if(A<=0)return;n.save(),n.beginPath(),n.arc(e,i,r,Math.PI/2,-Math.PI/2,!1),n.lineTo(s,i-r),n.arc(s,i,r,-Math.PI/2,Math.PI/2,!1),n.lineTo(e,i+r),n.closePath(),n.clip();const a=(e+s)/2,l=s-e,c=Math.max(l/2+r,r),u=1-A,d=n.createRadialGradient(a,i,0,a,i,c);d.addColorStop(0,"transparent"),d.addColorStop(Math.max(0,u-.05),"transparent"),d.addColorStop(u,`${t.color}1F`),d.addColorStop(1,`${t.color}BF`),n.fillStyle=d,n.fillRect(e-r-10,i-r-10,l+(r+10)*2,(r+10)*2),n.restore()}function RT(n,t,e,s,i,r,o,A){if(kT(n,t,s,i,r,o),n.save(),n.beginPath(),n.arc(s,r,o,Math.PI/2,-Math.PI/2,!1),n.lineTo(i,r-o),n.arc(i,r,o,-Math.PI/2,Math.PI/2,!1),n.lineTo(s,r+o),n.closePath(),n.strokeStyle=t.color,n.lineWidth=A,n.shadowColor=t.color,n.shadowBlur=$A,n.stroke(),n.shadowBlur=0,n.shadowColor="transparent",n.restore(),e.degreeDisplayMode!=="off"){const a=(s+i)/2;ap(n,t,e,a,r,o)}}function HT(n,t,e){const{cellHeight:s}=e,i=s/2*.12,r=n.uuid;if(!r)return 0;const o=t.filter(l=>!l.isDrum&&l.row===n.row&&l.startColumnIndex===n.startColumnIndex&&l.uuid&&l.uuid!==r&&Xv(l));if(o.length===0)return 0;const A=[n,...o];return A.sort((l,c)=>lc(l.uuid)-lc(c.uuid)),A.findIndex(l=>l.uuid===r)*i}function OT(n,t){const e=$u.getDegreeForNote(n,t);if(!e)return{label:null,isAccidental:!1};if(!$u.hasAccidental(e))return{label:e,isAccidental:!1};const i=h.state.accidentalMode||{},r=i.sharp??!0,o=i.flat??!0;if(!r&&!o)return{label:null,isAccidental:!0};let A=e.includes(th)?e:null,a=e.includes(eh)?e:null;const l=$u.getEnharmonicDegree(e);l&&(l.includes(th)&&!A&&(A=l),l.includes(eh)&&!a&&(a=l));let c=null;if(r&&o){const u=[];A&&u.push(A),a&&(!A||a!==A)&&u.push(a),c=u.join(ac),c||(c=e)}else r?c=A||e:o&&(c=a||e);return{label:c,isAccidental:!0}}function VT(n){if(!n)return{multiplier:1,category:"natural"};const t=n.includes(eh),e=n.includes(th),s=n.includes(ac);return!t&&!e?{multiplier:1,category:"natural"}:s?{multiplier:.75,category:"both-accidentals"}:{multiplier:.88,category:"single-accidental"}}function ap(n,t,e,s,i,r,o){const{label:A}=OT(t,e);if(!A)return;const{multiplier:a,category:l}=VT(A);let c;if(t.shape==="circle"){const d=r*2*TF;switch(l){case"natural":c=d;break;case"single-accidental":c=d*.8;break;case"both-accidentals":c=d*.4;break;default:c=d*a}}else{const d=r*2*FF;switch(l){case"natural":c=d*1.5;break;case"single-accidental":c=d*1.2;break;case"both-accidentals":c=d;break;default:c=d*a}}const u=c;if(!(u<QF))if(n.fillStyle="#212529",n.font=`bold ${u}px 'Atkinson Hyperlegible', sans-serif`,n.textAlign="center",n.textBaseline="middle",t.shape==="oval"&&l==="both-accidentals"&&A.includes(ac)){const d=A.split(ac),p=u*1.1,f=p*(d.length-1),m=i-f/2;d.forEach((g,w)=>{const B=m+w*p,b=u*.08;n.fillText(g.trim(),s,B+b)})}else{const d=u*.08;n.fillText(A,s,i+d)}}function SA(n,t){return Number.isFinite(n)&&n>0&&Number.isFinite(t)&&t>0}function lp(n,t,e,s){const{cellWidth:i,cellHeight:r,modulationMarkers:o}=t,A=Bt(s,t),a=Yv(e,t),l=A+a,c=it(e.startColumnIndex,t);let u;if(o&&o.length>0?u=it(e.startColumnIndex+1,t)-c:u=i,!SA(u,r))return;const d=$v(e,nh(),t),p=c+u+d,f=Math.max(MF,u*UF),m=r/2-f/2,g=Xv(e),w=h.state.longNoteStyle||"style1";if(g&&w==="style2"){const _=p,v=it(e.endColumnIndex,t);if(!SA(v-_,m))return;RT(n,e,t,_,v,l,m,f);return}if(g){const _=it(e.endColumnIndex+1,t),v=HT(e,nh(),t),C=l+v;n.beginPath(),n.moveTo(p,C),n.lineTo(_,C),n.strokeStyle=e.color,n.lineWidth=Math.max(NF,u*PF),n.stroke()}const B=u-f/2;if(!SA(B,m))return;Jv(n,e,t,p,l,B,m),n.save(),Zv(n,e,p,l,B,m);const b=jv(n,e,t);b.shouldApply&&(n.shadowColor=e.color,n.shadowBlur=$A+b.blur,n.shadowOffsetX=b.spread),n.beginPath(),n.ellipse(p,l,B,m,0,0,2*Math.PI),n.strokeStyle=e.color,n.lineWidth=f,b.shouldApply||(n.shadowColor=e.color,n.shadowBlur=$A),n.stroke(),n.shadowBlur=0,n.shadowColor="transparent",n.shadowOffsetX=0,n.restore(),t.degreeDisplayMode!=="off"&&ap(n,e,t,p,l,B)}function cp(n,t,e,s){const{columnWidths:i,cellWidth:r,cellHeight:o,modulationMarkers:A}=t,a=Bt(s,t),l=Yv(e,t),c=a+l,u=it(e.startColumnIndex,t);let d;if(A&&A.length>0?d=it(e.startColumnIndex+1,t)-u:d=((t.musicalColumnWidths&&t.musicalColumnWidths.length>0?t.musicalColumnWidths:i)[e.startColumnIndex]??0)*r,!SA(d,o))return;const p=$v(e,nh(),t),f=Math.max(.5,d*.15),m=u+d/2+p,g=d/2-f/2,w=o/2-f/2;if(!SA(g,w))return;Jv(n,e,t,m,c,g,w),n.save(),Zv(n,e,m,c,g,w);const B=jv(n,e,t);B.shouldApply&&(n.shadowColor=e.color,n.shadowBlur=$A+B.blur,n.shadowOffsetX=B.spread),n.beginPath(),n.ellipse(m,c,g,w,0,0,2*Math.PI),n.strokeStyle=e.color,n.lineWidth=f,B.shouldApply||(n.shadowColor=e.color,n.shadowBlur=$A),n.stroke(),n.shadowBlur=0,n.shadowColor="transparent",n.shadowOffsetX=0,n.restore(),t.degreeDisplayMode!=="off"&&ap(n,e,t,m,c,g)}function tB(n,t,e){const{cellWidth:s,cellHeight:i,modulationMarkers:r}=t,o=Bt(e.globalRow??e.row,t);let A=e.columnIndex;if(e.uuid){const g=Fe.getColumnMap(h.state).entries.find(w=>w.type==="tonic"&&w.tonicSignUuid===e.uuid&&typeof w.canvasIndex=="number");g&&typeof g.canvasIndex=="number"&&(A=g.canvasIndex)}const a=it(A,t);let l;r&&r.length>0?l=it(A+1,t)-a:l=s;const c=l*2,u=a+c/2,d=Math.min(c,i)/2*.9;if(d<2||(n.beginPath(),n.arc(u,o,d,0,2*Math.PI),n.strokeStyle="#212529",n.lineWidth=Math.max(.5,l*.05),n.stroke(),e.tonicNumber==null))return;const p=e.tonicNumber.toString(),f=d*1.5;f<6||(n.fillStyle="#212529",n.font=`bold ${f}px 'Atkinson Hyperlegible', sans-serif`,n.textAlign="center",n.textBaseline="middle",n.fillText(p,u,o))}const sh=[{id:1,diamonds:[0],ovals:[],label:"left 8th"},{id:2,diamonds:[1],ovals:[],label:"e"},{id:3,diamonds:[2],ovals:[],label:"right 8th"},{id:4,diamonds:[3],ovals:[],label:"a"},{id:5,diamonds:[0,1],ovals:[],label:"1 e"},{id:6,diamonds:[1,2],ovals:[],label:"e &"},{id:7,diamonds:[2,3],ovals:[],label:"& a"},{id:8,diamonds:[0,2],ovals:[],label:"two 8ths"},{id:9,diamonds:[1,3],ovals:[],label:"e a"},{id:10,diamonds:[0,1,2],ovals:[],label:"1 e + right 8th"},{id:11,diamonds:[1,2,3],ovals:[],label:"e & a"},{id:12,diamonds:[0,1,3],ovals:[],label:"1 e a"},{id:13,diamonds:[0,2,3],ovals:[],label:"left 8th + & a"},{id:14,diamonds:[0,3],ovals:[],label:"left 8th + a"},{id:15,diamonds:[0,1,2,3],ovals:[],label:"1 e & a"}];function cu(n){return sh.find(t=>t.id===n)}function Ym(n,t,e,s){const i=Math.sqrt(3)/2*e,r=Math.max(1,s-2*i),o=t-(r/2+i),A=o+i,a=A+r,l=a+i,c=n-e/2,u=n+e/2;return`M ${[`${n},${o}`,`${c},${A}`,`${c},${a}`,`${n},${l}`,`${u},${a}`,`${u},${A}`].join(" ")} Z`.replace(/,/g," ")}class WT{constructor(t={}){I(this,"options");this.options={diamondW:30,diamondH:120,ovalRx:30,ovalRy:60,strokeWidth:2,...t}}renderToCanvas(t,e,s,i,r,o,A="#000",a=null,l=null){const c=r/100*.8,u=o/100*.8,d=this.options.diamondW*c,p=this.options.diamondH*u,f=this.options.ovalRx*c,m=this.options.ovalRy*u,g=[.125,.375,.625,.875].map(B=>s+B*r),w=i+o/2;t.save(),t.strokeStyle=A,t.fillStyle=A,t.lineWidth=this.options.strokeWidth,t.lineCap="round",t.lineJoin="round",e.ovals.forEach(B=>{var v;const b=B===0?s+.25*r:s+.75*r;let _=w;if(a&&l){const C=`oval_${B}`,y=((v=a.shapeOffsets)==null?void 0:v[C])||0,S=a.row+y;_=l(S)}t.beginPath(),t.ellipse(b,_,f,m,0,0,Math.PI*2),t.stroke()}),e.diamonds.forEach(B=>{var y;const b=g[B];if(b===void 0)return;let _=w;if(a&&l){const S=`diamond_${B}`,F=((y=a.shapeOffsets)==null?void 0:y[S])||0,x=a.row+F;_=l(x)}const v=Ym(b,_,d,p),C=new Path2D(v);t.stroke(C)}),t.restore()}renderToSVG(t,e=100,s=100){const i=document.createElementNS("http://www.w3.org/2000/svg","svg");i.setAttribute("viewBox",`0 0 ${e} ${s}`),i.style.color="#000000";const r=Math.min(e/100,s/100)*.8,o=this.options.diamondW*r,A=this.options.diamondH*r,a=this.options.ovalRx*r,l=this.options.ovalRy*r,c=[12.5,37.5,62.5,87.5],u=s/2;return t.ovals.forEach(d=>{const p=d===0?25:75,f=document.createElementNS("http://www.w3.org/2000/svg","ellipse");f.setAttribute("cx",String(p)),f.setAttribute("cy",String(u)),f.setAttribute("rx",String(a)),f.setAttribute("ry",String(l)),f.setAttribute("fill","none"),f.setAttribute("stroke","currentColor"),f.setAttribute("stroke-width",String(this.options.strokeWidth*2)),f.setAttribute("stroke-linecap","round"),i.appendChild(f)}),t.diamonds.forEach(d=>{const p=c[d];if(p===void 0)return;const f=Ym(p,u,o,A),m=document.createElementNS("http://www.w3.org/2000/svg","path");m.setAttribute("d",f),m.setAttribute("fill","none"),m.setAttribute("stroke","currentColor"),m.setAttribute("stroke-width",String(this.options.strokeWidth*2)),m.setAttribute("stroke-linejoin","round"),m.setAttribute("stroke-linecap","round"),i.appendChild(m)}),i}}const up=new WT;E.moduleLoaded("SixteenthStampRenderer","stamps");function GT(n,t){var s,i;const e=((s=h.getAllSixteenthStampPlacements)==null?void 0:s.call(h))??((i=h.state)==null?void 0:i.sixteenthStampPlacements)??[];e.length!==0&&(E.debug("SixteenthStampRenderer",`Rendering ${e.length} stamps`,{count:e.length},"stamps"),e.forEach(r=>{KT(n,r,t)}))}function KT(n,t,e){const s=cu(t.sixteenthStampId);if(!s)return;const{startColumn:i,row:r,color:o}=t,A=h.state,a=it(i,e),c=Bt(r,e)-e.cellHeight/2,u=Vi(i,A);let d;if(u!==null){const B=u+2;d=gn(B,A)}else d=i+2;const f=it(d,e)-a,m=e.cellHeight,g=He(n.canvas);if(a+f<0||a>g)return;const w=B=>Bt(B,e);up.renderToCanvas(n,s,a,c,f,m,o,t,w),n.save(),n.globalAlpha=.1,n.fillStyle=o,n.fillRect(a+1,c+1,f-2,m-2),n.restore(),E.debug("SixteenthStampRenderer",`Rendered stamp ${t.sixteenthStampId} at ${i}-${d},${r}`,{sixteenthStampId:t.sixteenthStampId,startColumn:i,effectiveEndColumn:d,row:r,stampX:a,stampY:c,hasOffsets:!!t.shapeOffsets},"stamps")}function qT(n,t,e,s,i){if(!s)return;const r=h.state,o=it(t,i),a=Bt(e,i)-i.cellHeight/2,l=Vi(t,r);let c;if(l!==null){const f=l+2;c=gn(f,r)}else c=t+2;const d=it(c,i)-o,p=i.cellHeight;n.save(),n.globalAlpha=.6,up.renderToCanvas(n,s,o,a,d,p,i.previewColor||"#4a90e2"),n.restore()}function jm(n,t,e){return[{id:t+0,span:n,hits:[0],label:`${e} [1]`},{id:t+1,span:n,hits:[1],label:`${e} [2]`},{id:t+2,span:n,hits:[2],label:`${e} [3]`},{id:t+3,span:n,hits:[0,1],label:`${e} [1 2]`},{id:t+4,span:n,hits:[1,2],label:`${e} [2 3]`},{id:t+5,span:n,hits:[0,2],label:`${e} [1 3]`},{id:t+6,span:n,hits:[0,1,2],label:`${e} [1 2 3]`}]}const Tl=[...jm("eighth",1,"8th triplet"),...jm("quarter",8,"Quarter triplet")],eB={eighth:1,quarter:2},nB=[16.6667,50,83.3333];function uu(n){return Tl.find(t=>t.id===n)}E.moduleLoaded("TripletStampRenderer","triplets");function zT(n,t){var s,i;const e=((s=h.getAllTripletStampPlacements)==null?void 0:s.call(h))??((i=h.state)==null?void 0:i.tripletStampPlacements)??[];e.length!==0&&(E.debug("TripletStampRenderer",`Rendering ${e.length} triplet groups`,{count:e.length},"triplets"),e.forEach(r=>{XT(n,r,t)}))}function XT(n,t,e){const s=uu(t.tripletStampId);if(!s)return;const{startTimeIndex:i,span:r,row:o,color:A}=t,a=r*2,l=gn(i,h.state),c=l+a,u=it(l,e),d=Bt(o,e),p=d-e.cellHeight/2,m=it(c,e)-u,g=e.cellHeight,w=He(n.canvas);if(u+m<0||u>w)return;sB(n,s,u,d,m,g,A,t,b=>Bt(b,e)),n.save(),n.globalAlpha=.1,n.fillStyle=A,n.fillRect(u+1,p+1,m-2,g-2),n.restore()}function sB(n,t,e,s,i,r,o,A=null,a=null){const l=i/100*.8,c=r/100*.8,u=Math.max(1,3*c);t.hits.forEach(d=>{var g;const p=nB[d]??50,f=e+i*p/100;let m=s;if(A&&a){const w=`triplet_${d}`,B=((g=A.shapeOffsets)==null?void 0:g[w])||0,b=A.row+B;m=a(b),B!==0&&E.debug("TripletStampRenderer","Drawing notehead with offset",{slot:d,shapeKey:w,rowOffset:B,baseRow:A.row,shapeRow:b,y:m},"triplets")}$T(n,f,m,o,u,l,c)})}function $T(n,t,e,s="currentColor",i=4,r=1,o=1){const A=20*r,a=60*o;n.strokeStyle=s,n.lineWidth=i,n.fillStyle="none",n.beginPath(),n.ellipse(t,e,A,a,0,0,2*Math.PI),n.stroke()}function YT(n,t,e,s,i){if(!s)return;const o=(s.span==="eighth"?1:2)*2,A=gn(t,h.state),a=it(A,i),l=Bt(e,i),c=A+o,d=it(c,i)-a,p=i.cellHeight;n.save(),n.globalAlpha=.6;const f=i.previewColor||"#4a90e2";sB(n,s,a,l,d,p,f),n.restore()}function jT(n,t){if(n===0)return it(0,t);const e=n-1,s=dn(h.state,e);return s?it(s.endColumn+1,t):(E.warn("ModulationRenderer","Could not find measure info for index",{measureIndex:n},"grid"),n*200)}function iB(n,t){const{modulationMarkers:e}=t;if(!e||e.length===0)return;const s=e.filter(r=>r.active).map(r=>{let o;if(r.columnIndex!==null&&r.columnIndex!==void 0)o=it(r.columnIndex+1,t);else if(r.macrobeatIndex!==null&&r.macrobeatIndex!==void 0&&r.macrobeatIndex>=0){const A=dn(h.state,r.macrobeatIndex);A?o=it(A.endColumn+1,t):(E.warn("ModulationRenderer","Could not find macrobeat info for index",{macrobeatIndex:r.macrobeatIndex},"grid"),o=r.xPosition??0)}else r.measureIndex!==null&&r.measureIndex!==void 0?o=jT(r.measureIndex,t):o=r.xPosition??0;return{...r,xCanvas:o}});n.save();const i=t.showModulationLabel!==!1;s.forEach(r=>{JT(n,r,i)}),n.restore()}function JT(n,t,e){const s=t.xCanvas,i=t.ratio,r=Mv(i),o=Qv(i);ZT(n,s,r),e&&tQ(n,s,o,r)}function ZT(n,t,e){const i=ie(n.canvas);n.beginPath(),n.moveTo(t,0),n.lineTo(t,i),n.lineWidth=3,n.strokeStyle=e,n.setLineDash([]),n.stroke()}function tQ(n,t,e,s){const r="Arial, sans-serif";n.font=`14px ${r}`,n.textAlign="center",n.textBaseline="middle";const c=n.measureText(e).width,u=14,d=c+12,p=u+12,f=t-d/2,m=20;eQ(n,f,m,d,p,8,s),n.fillStyle="#212529",n.fillText(e,t,m+p/2)}function eQ(n,t,e,s,i,r,o){n.beginPath(),n.moveTo(t+r,e),n.lineTo(t+s-r,e),n.quadraticCurveTo(t+s,e,t+s,e+r),n.lineTo(t+s,e+i-r),n.quadraticCurveTo(t+s,e+i,t+s-r,e+i),n.lineTo(t+r,e+i),n.quadraticCurveTo(t,e+i,t,e+i-r),n.lineTo(t,e+r),n.quadraticCurveTo(t,e,t+r,e),n.closePath(),n.fillStyle=o,n.fill(),n.strokeStyle="rgba(0, 0, 0, 0.2)",n.lineWidth=1,n.stroke()}function Jm(n,t,e){const{xCanvas:s}=e,i=6,r=40;return Math.abs(n-s)<=i/2?t<=r?{marker:e,type:"label",canDrag:!1}:{marker:e,type:"barline",canDrag:!0}:null}function Zm(n){if(!n)return"default";switch(n.type){case"label":return"pointer";case"barline":return n.canDrag?"ew-resize":"pointer";default:return"default"}}function ts(n){return n.x??n.col??0}function es(n){return n.y??n.row??0}function JA(n,t){if(!t||t.length<3)return!1;const e=ts(n),s=es(n);let i=!1;for(let r=0,o=t.length-1;r<t.length;o=r++){const A=ts(t[r]),a=es(t[r]),l=ts(t[o]),c=es(t[o]);a>s!=c>s&&e<(l-A)*(s-a)/(c-a)+A&&(i=!i)}return i}function nQ(n){if(!n||n.length<3)return n;const t=n.map(r=>({x:ts(r),y:es(r)}));if(t.length===0)return[];let e=t[0];for(let r=1;r<t.length;r++){const o=t[r];(o.y<e.y||o.y===e.y&&o.x<e.x)&&(e=o)}const s=t.filter(r=>r!==e);if(s.sort((r,o)=>{const A=Math.atan2(r.y-e.y,r.x-e.x),a=Math.atan2(o.y-e.y,o.x-e.x);if(A!==a)return A-a;const l=Math.hypot(r.x-e.x,r.y-e.y),c=Math.hypot(o.x-e.x,o.y-e.y);return l-c}),s.length===0)return[e];const i=[e,s[0]];for(let r=1;r<s.length;r++){const o=s[r];for(;i.length>1&&!sQ(i[i.length-2],i[i.length-1],o);)i.pop();i.push(o)}return i}function sQ(n,t,e){const s=ts(n),i=es(n),r=ts(t),o=es(t),A=ts(e),a=es(e);return(r-s)*(a-i)-(o-i)*(A-s)>0}function iQ(n,t,e,s=10){const i=ts(n),r=es(n),o=ts(t),A=es(t),a=ts(e),l=es(e),c=a-o,u=l-A,d=c*c+u*u;if(d===0)return Math.hypot(i-o,r-A)<=s;let p=((i-o)*c+(r-A)*u)/d;p=Math.max(0,Math.min(1,p));const f=o+p*c,m=A+p*u;return Math.hypot(i-f,r-m)<=s}function tg(n,t,e=10){if(!t||t.length<2)return!1;for(let s=0;s<t.length;s++){const i=t[s],r=t[(s+1)%t.length];if(iQ(n,i,r,e))return!0}return!1}function rQ(n,t){const{centerX:e,centerY:s,rx:i,ry:r}=t,o=16;for(let A=0;A<o;A++){const a=A/o*2*Math.PI,l=e+i*Math.cos(a),c=s+r*Math.sin(a);if(JA({x:l,y:c},n))return!0}return!!JA({x:e,y:s},n)}function eg(n,t){const{x:e,y:s,width:i,height:r}=t,o=[{x:e,y:s},{x:e+i,y:s},{x:e+i,y:s+r},{x:e,y:s+r}];for(const A of o)if(JA(A,n))return!0;for(const A of n){const a=ts(A),l=es(A);if(a>=e&&a<=e+i&&l>=s&&l<=s+r)return!0}return!1}function rB(n,t,e,s,i,r){const o=i-e,A=r-s,a=o*o+A*A;if(a===0){const f=n-e,m=t-s;return Math.sqrt(f*f+m*m)}let l=((n-e)*o+(t-s)*A)/a;l=Math.max(0,Math.min(1,l));const c=e+l*o,u=s+l*A,d=n-c,p=t-u;return Math.sqrt(d*d+p*p)}function oQ(n){const{x:t,y:e,annotations:s,getRenderOptions:i}=n,r=10;let o=!1;const A=i();return{nextAnnotations:s.filter(l=>{let c=!0;if(l.type==="arrow"){const u=it(l.startCol,A),d=Bt(l.startRow,A),p=it(l.endCol,A),f=Bt(l.endRow,A);rB(t,e,u,d,p,f)<r&&(c=!1,o=!0)}else if(l.type==="text"){const u=it(l.col,A),d=Bt(l.row,A),p=it(l.col+l.widthCols,A),f=Bt(l.row+l.heightRows,A);t>=u&&t<=p&&e>=d&&e<=f&&(c=!1,o=!0)}else if(l.type==="marker"||l.type==="highlighter")for(let u=0;u<l.path.length;u++){const d=it(l.path[u].col,A),p=Bt(l.path[u].row,A),f=t-d,m=e-p;if(Math.sqrt(f*f+m*m)<r){c=!1,o=!0;break}}return c}),changed:o}}function AQ(n){const{lassoPath:t,state:e,renderOptions:s,isAdditive:i,existingSelectedItems:r}=n,o=[];i&&Array.isArray(r)&&o.push(...r),e.placedNotes.forEach((a,l)=>{if(a.isDrum)return;const c=a.startColumnIndex,u=it(c,s),d=Bt(a.row,s),{cellWidth:p,cellHeight:f}=s;let m=p;s.modulationMarkers&&s.modulationMarkers.length>0&&(m=it(c+1,s)-u);const g=a.shape==="oval"?u+m:u+m/2,w=d,B=a.shape==="oval"?m:m/2,b=f/2;if(rQ(t,{centerX:g,centerY:w,rx:B,ry:b})){const _=`note-${a.row}-${c}-${a.color}-${a.shape}`;o.find(v=>v.id===_)||o.push({type:"note",id:_,data:a,index:l})}}),e.sixteenthStampPlacements.forEach((a,l)=>{const{cellWidth:c,cellHeight:u}=s,d=it(a.startColumn,s),p=Bt(a.row,s)-u/2,f=c*2;if(eg(t,{x:d,y:p,width:f,height:u})){const g=`sixteenth-stamp-${a.row}-${a.startColumn}-${a.sixteenthStampId}`;o.find(w=>w.id===g)||o.push({type:"sixteenthStamp",id:g,data:a,index:l})}}),e.tripletStampPlacements.forEach((a,l)=>{const{cellHeight:c}=s,u=gn(a.startTimeIndex,e),d=u+a.span*2,p=it(u,s),f=it(d,s)-p,m=Bt(a.row,s)-c/2;if(eg(t,{x:p,y:m,width:f,height:c})){const w=`triplet-stamp-${a.row}-${u}-${a.tripletStampId}`;o.find(B=>B.id===w)||o.push({type:"tripletStamp",id:w,data:a,index:l})}});const A=ZA({selectedItems:o,renderOptions:s,state:e});return{selectedItems:o,convexHull:A,isActive:o.length>0}}function ZA(n){const{selectedItems:t,renderOptions:e,state:s}=n;if(!t.length)return null;const i=s??h.state,r=t.map(o=>{const A=o.type==="note"?o.data.startColumnIndex:o.type==="sixteenthStamp"?o.data.startColumn:gn(o.data.startTimeIndex,i),a=it(A,e),l=Bt(o.data.row,e);return{x:a,y:l}});return nQ(r)}function aQ(n){const{canvasX:t,canvasY:e,state:s,renderOptions:i,selection:r}=n;if(!(r!=null&&r.isActive))return null;const o=n.thresholdPx??15;let A=null;if(s.placedNotes.forEach(c=>{const u=c.startColumnIndex,d=it(u,i),p=Bt(c.row,i);Math.hypot(t-d,e-p)<=o&&(A=`note-${c.row}-${u}-${c.color}-${c.shape}`)}),A||s.sixteenthStampPlacements.forEach(c=>{const u=c.startColumn+1,d=it(u,i),p=Bt(c.row,i);Math.hypot(t-d,e-p)<=o&&(A=`sixteenth-stamp-${c.row}-${c.startColumn}-${c.sixteenthStampId}`)}),A||s.tripletStampPlacements.forEach(c=>{const u=gn(c.startTimeIndex,s),d=u+c.span,p=it(d,i),f=Bt(c.row,i);Math.hypot(t-p,e-f)<=o&&(A=`triplet-stamp-${c.row}-${u}-${c.tripletStampId}`)}),!A)return null;const a=r.selectedItems.filter(c=>c.id!==A),l=ZA({selectedItems:a,renderOptions:i});return{nextSelection:{selectedItems:a,convexHull:l,isActive:a.length>0},changed:!0}}function lQ(n){const{selection:t,selectionDragStart:e,selectionDragTotal:s,currentPointerGrid:i,initialDragStartRank:r,currentStartRank:o,renderOptions:A}=n,a=r!==null?o-r:0,l=i.row-a,c=Math.round(i.col-e.col),u=Math.round(l-e.row),d={col:c-s.col,row:u-s.row};if(d.col===0&&d.row===0)return{moved:!1,nextSelectionDragTotal:s,nextConvexHull:t.convexHull};const p=(w,B)=>typeof B=="number"?B:w,f=(w,B)=>{var v;const b=((v=h.state.columnWidths)==null?void 0:v.length)??0;let _=w;for(;_>=0&&_<b;){const C=Vi(_,h.state);if(C!==null)return C;_+=B}return null};t.selectedItems.forEach(w=>{if(w.type==="note"){const b=p(w.data.row,w.data.globalRow)+d.row;w.data.globalRow=b,w.data.row=b,w.data.startColumnIndex=w.data.startColumnIndex+d.col,w.data.endColumnIndex=w.data.endColumnIndex+d.col}else if(w.type==="sixteenthStamp"){const b=p(w.data.row,w.data.globalRow)+d.row;w.data.globalRow=b,w.data.row=b,w.data.startColumn=w.data.startColumn+d.col,w.data.endColumn=w.data.endColumn+d.col}else if(w.type==="tripletStamp"){const b=p(w.data.row,w.data.globalRow)+d.row;if(w.data.globalRow=b,w.data.row=b,d.col!==0){const v=gn(w.data.startTimeIndex,h.state)+d.col,C=Math.sign(d.col)||1,y=f(v,C);y!==null&&(w.data.startTimeIndex=y)}}});const m={col:c,row:u},g=ZA({selectedItems:t.selectedItems,renderOptions:A,state:h.state});return t.convexHull=g,{moved:!0,nextSelectionDragTotal:m,nextConvexHull:g}}function cQ(n){const{ctx:t,annotation:e,isTemp:s=!1,isSelected:i=!1,isHovered:r=!1,getStrokeWidth:o,getLineDash:A}=n,{startX:a,startY:l,endX:c,endY:u,settings:d}=e;t.save(),i&&(t.strokeStyle="#4a90e2",t.lineWidth=o(d.strokeWeight)+4,t.globalAlpha=.3,t.setLineDash([]),t.beginPath(),t.moveTo(a,l),t.lineTo(c,u),t.stroke(),t.globalAlpha=1),r&&!i&&(t.strokeStyle="#4a90e2",t.lineWidth=o(d.strokeWeight)+4,t.globalAlpha=.15,t.setLineDash([]),t.beginPath(),t.moveTo(a,l),t.lineTo(c,u),t.stroke(),t.globalAlpha=1),t.strokeStyle=s?"rgba(0, 0, 0, 0.5)":"#000000",t.lineWidth=o(d.strokeWeight),t.setLineDash(A(d.lineStyle));const p=Math.atan2(u-l,c-a),f=d.arrowheadSize||12;let m=a,g=l,w=c,B=u;d.startArrowhead!=="none"&&(m=a+Math.cos(p)*f,g=l+Math.sin(p)*f),d.endArrowhead!=="none"&&(w=c-Math.cos(p)*f,B=u-Math.sin(p)*f),t.beginPath(),t.moveTo(m,g),t.lineTo(w,B),t.stroke(),d.startArrowhead!=="none"&&ng({ctx:t,x:a,y:l,angle:p+Math.PI,type:d.startArrowhead,size:f}),d.endArrowhead!=="none"&&ng({ctx:t,x:c,y:u,angle:p,type:d.endArrowhead,size:f}),t.restore()}function ng(n){const{ctx:t,x:e,y:s,angle:i,type:r,size:o}=n;switch(t.save(),t.translate(e,s),t.rotate(i),t.setLineDash([]),r){case"filled":case"filled-arrow":t.beginPath(),t.moveTo(0,0),t.lineTo(-o,-o/2),t.lineTo(-o,o/2),t.closePath(),t.fillStyle=t.strokeStyle,t.fill();break;case"unfilled":case"unfilled-arrow":t.beginPath(),t.moveTo(0,0),t.lineTo(-o,-o/2),t.lineTo(-o,o/2),t.closePath(),t.stroke();break;case"circle":t.beginPath(),t.arc(0,0,o/3,0,Math.PI*2),t.fillStyle=t.strokeStyle,t.fill();break}t.restore()}E.moduleLoaded("AnnotationService","annotation");class uQ{constructor(){I(this,"canvas");I(this,"ctx");I(this,"currentTool");I(this,"toolSettings");I(this,"tempEraserMode");I(this,"isDrawing");I(this,"currentPath");I(this,"startPoint");I(this,"tempAnnotation");I(this,"selectedAnnotation");I(this,"hoverAnnotation");I(this,"eraserCursor");I(this,"isDragging");I(this,"dragOffset");I(this,"isResizing");I(this,"resizeHandle");I(this,"resizeStartBounds");I(this,"isDraggingSelection");I(this,"selectionDragStart");I(this,"selectionDragTotal");I(this,"lastPointerPosition");I(this,"initialDragStartRank");this.toolSettings=null,this.tempEraserMode=!1,this.currentTool=null,this.isDrawing=!1,this.currentPath=[],this.startPoint=null,this.tempAnnotation=null,this.selectedAnnotation=null,this.hoverAnnotation=null,this.eraserCursor=null,this.isDragging=!1,this.dragOffset=null,this.isResizing=!1,this.resizeHandle=null,this.resizeStartBounds=null,this.isDraggingSelection=!1,this.selectionDragStart=null,this.selectionDragTotal=null,this.lastPointerPosition=null,this.initialDragStartRank=null}initialize(){const t=document.getElementById("notation-grid");if(!(t instanceof HTMLCanvasElement)){E.error("AnnotationService","Pitch grid canvas not found",null,"annotation");return}const e=t.getContext("2d");if(!e){E.error("AnnotationService","Pitch grid context not available",null,"annotation");return}this.canvas=t,this.ctx=e,this.setupEventListeners(),h.on("annotationsChanged",()=>{this.selectedAnnotation=null,this.render()}),h.on("scrollByUnits",s=>{typeof s=="number"&&this.handleSelectionScroll(s)}),E.initSuccess("AnnotationService")}setupEventListeners(){this.canvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this.handleMouseMove.bind(this)),this.canvas.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvas.addEventListener("mouseleave",this.handleMouseLeave.bind(this)),this.canvas.addEventListener("dblclick",this.handleDoubleClick.bind(this)),this.canvas.addEventListener("wheel",this.handleWheel.bind(this),{passive:!0}),this.canvas.addEventListener("contextmenu",t=>t.preventDefault()),this.registerScrollSyncTarget(document.getElementById("pitch-grid-wrapper")),this.registerScrollSyncTarget(document.getElementById("canvas-container")),window.addEventListener("scroll",this.handleScroll.bind(this),{passive:!0}),window.addEventListener("wheel",this.handleWheel.bind(this),{passive:!0}),document.addEventListener("keydown",this.handleKeyDown.bind(this))}handleKeyDown(t){if(!this.selectedAnnotation)return;const e=document.activeElement;if(e instanceof HTMLElement){const s=e.isContentEditable,i=e.tagName.toLowerCase();if(["input","textarea"].includes(i)||s)return}(t.key==="Delete"||t.key==="Backspace")&&(t.preventDefault(),this.deleteSelectedAnnotation())}deleteSelectedAnnotation(){if(!this.selectedAnnotation)return;const t=h.state.annotations.indexOf(this.selectedAnnotation);t>-1&&(h.state.annotations.splice(t,1),this.selectedAnnotation=null,h.recordState(),this.render(),E.log("AnnotationService","Deleted annotation","annotation"))}resize(){const t=document.getElementById("notation-grid");t instanceof HTMLCanvasElement&&(this.canvas.width=t.width,this.canvas.height=t.height,this.render())}getRenderOptions(){return{columnWidths:h.state.columnWidths,cellWidth:h.state.cellWidth,cellHeight:h.state.cellHeight,modulationMarkers:h.state.modulationMarkers,baseMicrobeatPx:h.state.cellWidth}}canvasToGrid(t,e){const s=this.getRenderOptions();return{col:Jd(t,s),row:wT(e,s)}}canvasToGridFresh(t,e){const s=this.getRenderOptions(),i=je.getViewportInfo(),r=s.cellHeight/2;return{col:Jd(t,s),row:e/r+i.startRank-1}}gridToCanvas(t,e){const s=this.getRenderOptions();return{x:it(t,s),y:Bt(e,s)}}setTool(t,e){if(this.currentTool=t,this.toolSettings=e,this.canvas)switch(t){case"arrow":case"text":this.canvas.style.cursor="crosshair";break;case"marker":case"highlighter":this.canvas.style.cursor=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16'><circle cx='8' cy='8' r='4' fill='rgba(0,0,0,0.5)'/></svg>") 8 8, crosshair`;break;case"lasso":this.canvas.style.cursor="crosshair";break;default:this.canvas.style.cursor="default"}}handleMouseDown(t){var A,a,l;if(!this.currentTool||!this.toolSettings)return;const e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top;this.lastPointerPosition={clientX:t.clientX,clientY:t.clientY};const r=this.canvasToGridFresh(s,i);if(t.button===2){if(this.currentTool==="lasso"&&((A=h.state.lassoSelection)!=null&&A.isActive)){this.removeFromLassoSelection(s,i);return}this.tempEraserMode=!0,this.isDrawing=!0,this.eraseAtPoint(s,i),this.showEraserCursor(s,i);return}if(((a=this.selectedAnnotation)==null?void 0:a.type)==="text"){const c=this.getResizeHandleAt(s,i,this.selectedAnnotation);if(c){this.isResizing=!0,this.resizeHandle=c,this.resizeStartBounds={col:this.selectedAnnotation.col,row:this.selectedAnnotation.row,widthCols:this.selectedAnnotation.widthCols,heightRows:this.selectedAnnotation.heightRows,mouseCol:r.col,mouseRow:r.row};return}}if((l=h.state.lassoSelection)!=null&&l.isActive&&h.state.lassoSelection.convexHull){const c=tg({x:s,y:i},h.state.lassoSelection.convexHull,10),u=JA({x:s,y:i},h.state.lassoSelection.convexHull);if(c||u){this.isDraggingSelection=!0,this.selectionDragStart={col:r.col,row:r.row},this.selectionDragTotal={col:0,row:0},this.lastPointerPosition={clientX:t.clientX,clientY:t.clientY},this.initialDragStartRank=je.getViewportInfo().startRank;return}}const o=this.getAnnotationAt(s,i);if(o&&(o.type==="arrow"||o.type==="text")){if(this.selectedAnnotation===o){this.isDragging=!0,o.type==="arrow"?this.dragOffset={startCol:r.col-o.startCol,startRow:r.row-o.startRow,endCol:r.col-o.endCol,endRow:r.row-o.endRow}:o.type==="text"&&(this.dragOffset={col:r.col-o.col,row:r.row-o.row});return}if(this.currentTool==="text"&&o.type==="text"){this.editTextAnnotation(o);return}this.selectedAnnotation=o,this.loadAnnotationSettings(o),this.render();return}else this.selectedAnnotation=null;switch(this.isDrawing=!0,this.startPoint=r,this.currentPath=[r],this.currentTool){case"arrow":this.tempAnnotation={type:"arrow",startCol:r.col,startRow:r.row,endCol:r.col,endRow:r.row,settings:{...this.toolSettings.arrow}};break;case"text":this.tempAnnotation={type:"text",startCol:r.col,startRow:r.row,endCol:r.col,endRow:r.row};break;case"marker":case"highlighter":this.tempAnnotation={type:this.currentTool,path:[r],settings:{...this.toolSettings[this.currentTool]}};break;case"lasso":this.tempAnnotation={type:"lasso",path:[{x:s,y:i}]};break}}handleMouseMove(t){var o;const e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top;this.lastPointerPosition={clientX:t.clientX,clientY:t.clientY};const r=this.canvasToGridFresh(s,i);if(this.tempEraserMode){this.eraseAtPoint(s,i),this.showEraserCursor(s,i);return}if(this.isResizing&&((o=this.selectedAnnotation)==null?void 0:o.type)==="text"){if(!this.resizeHandle||!this.resizeStartBounds)return;const A=r.col-this.resizeStartBounds.mouseCol,a=r.row-this.resizeStartBounds.mouseRow;let l=this.resizeStartBounds.col,c=this.resizeStartBounds.row,u=this.resizeStartBounds.widthCols,d=this.resizeStartBounds.heightRows;this.resizeHandle.includes("n")&&(c=this.resizeStartBounds.row+a,d=this.resizeStartBounds.heightRows-a),this.resizeHandle.includes("s")&&(d=this.resizeStartBounds.heightRows+a),this.resizeHandle.includes("w")&&(l=this.resizeStartBounds.col+A,u=this.resizeStartBounds.widthCols-A),this.resizeHandle.includes("e")&&(u=this.resizeStartBounds.widthCols+A);const p=2,f=1;u<p&&(this.resizeHandle.includes("w")&&(l=this.resizeStartBounds.col+this.resizeStartBounds.widthCols-p),u=p),d<f&&(this.resizeHandle.includes("n")&&(c=this.resizeStartBounds.row+this.resizeStartBounds.heightRows-f),d=f),this.selectedAnnotation.col=l,this.selectedAnnotation.row=c,this.selectedAnnotation.widthCols=u,this.selectedAnnotation.heightRows=d,this.render();return}if(this.isDraggingSelection&&this.selectionDragStart&&this.selectionDragTotal){this.applySelectionDrag(s,i);return}if(this.isDragging&&this.selectedAnnotation){this.selectedAnnotation.type==="arrow"?(this.selectedAnnotation.startCol=r.col-this.dragOffset.startCol,this.selectedAnnotation.startRow=r.row-this.dragOffset.startRow,this.selectedAnnotation.endCol=r.col-this.dragOffset.endCol,this.selectedAnnotation.endRow=r.row-this.dragOffset.endRow):this.selectedAnnotation.type==="text"&&(this.selectedAnnotation.col=r.col-this.dragOffset.col,this.selectedAnnotation.row=r.row-this.dragOffset.row),this.render();return}if(!this.isDrawing){this.updateHover(s,i);return}if(this.tempAnnotation)switch(this.currentTool){case"arrow":this.tempAnnotation.endCol=r.col,this.tempAnnotation.endRow=r.row,this.render();break;case"text":this.tempAnnotation.endCol=r.col,this.tempAnnotation.endRow=r.row,this.render();break;case"marker":case"highlighter":if(this.tempAnnotation.path.length>0){const A=this.tempAnnotation.path[this.tempAnnotation.path.length-1],a=this.interpolatePoints(A,r);this.tempAnnotation.path.push(...a)}else this.tempAnnotation.path.push(r);this.render();break;case"lasso":this.tempAnnotation.path.push({x:s,y:i}),this.render();break}}handleMouseUp(t){if(this.isResizing){this.isResizing=!1,this.resizeHandle=null,this.resizeStartBounds=null,h.recordState();return}if(this.isDraggingSelection){this.isDraggingSelection=!1,this.selectionDragStart=null,this.selectionDragTotal=null,this.lastPointerPosition=null,this.initialDragStartRank=null,h.recordState();return}if(this.isDragging){this.isDragging=!1,this.dragOffset=null,h.recordState();return}if(this.isDrawing){if(this.isDrawing=!1,this.tempEraserMode){this.tempEraserMode=!1,this.render();return}if(this.tempAnnotation){if(this.currentTool==="text"){const{startCol:e,startRow:s,endCol:i,endRow:r}=this.tempAnnotation,o=Math.abs(i-e),A=Math.abs(r-s),a=Math.min(e,i),l=Math.min(s,r);o>.5&&A>.2?this.createTextAnnotation(a,l,o,A):this.createTextAnnotation(e,s,8,2),this.tempAnnotation=null,this.render();return}this.currentTool==="lasso"?this.handleLassoSelection(t.shiftKey):(h.state.annotations.push(this.tempAnnotation),this.currentTool==="arrow"&&(this.selectedAnnotation=this.tempAnnotation),h.recordState()),this.tempAnnotation=null,this.render()}}}handleWheel(t){!this.isDraggingSelection||!this.selectionDragStart||!this.selectionDragTotal||((t.clientX!==0||t.clientY!==0)&&(this.lastPointerPosition={clientX:t.clientX,clientY:t.clientY}),requestAnimationFrame(()=>this.applySelectionDragFromLastPointer()))}handleScroll(){!this.isDraggingSelection||!this.selectionDragStart||!this.selectionDragTotal||requestAnimationFrame(()=>this.applySelectionDragFromLastPointer())}applySelectionDragFromLastPointer(){if(!this.canvas||!this.lastPointerPosition)return;const t=this.canvas.getBoundingClientRect(),e=this.lastPointerPosition.clientX-t.left,s=this.lastPointerPosition.clientY-t.top;this.applySelectionDrag(e,s)}registerScrollSyncTarget(t){t&&(t.addEventListener("wheel",this.handleWheel.bind(this),{passive:!0}),t.addEventListener("scroll",this.handleScroll.bind(this),{passive:!0}))}applySelectionDrag(t,e){if(!this.isDraggingSelection||!this.selectionDragStart||!this.selectionDragTotal)return;const s=this.getRenderOptions(),r=je.getViewportInfo().startRank,o=this.canvasToGridFresh(t,e),{moved:A,nextSelectionDragTotal:a}=lQ({selection:h.state.lassoSelection,selectionDragStart:this.selectionDragStart,selectionDragTotal:this.selectionDragTotal,currentPointerGrid:o,initialDragStartRank:this.initialDragStartRank,currentStartRank:r,renderOptions:s});A&&(this.selectionDragTotal.col=a.col,this.selectionDragTotal.row=a.row,this.render())}handleSelectionScroll(t){var s;if(!((s=h.state.lassoSelection)!=null&&s.isActive)||this.isDraggingSelection)return;const e=this.getRenderOptions();h.state.lassoSelection.convexHull=ZA({selectedItems:h.state.lassoSelection.selectedItems,renderOptions:e}),this.render()}handleMouseLeave(t){this.isDrawing&&this.handleMouseUp(t)}handleDoubleClick(t){const e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top,r=this.getAnnotationAt(s,i);(r==null?void 0:r.type)==="text"&&this.editTextAnnotation(r)}editTextAnnotation(t){const{col:e,row:s,widthCols:i,heightRows:r,text:o,settings:A}=t,a=h.state.annotations.indexOf(t);a>-1&&(h.state.annotations.splice(a,1),this.selectedAnnotation=null,this.render()),this.createTextAnnotation(e,s,i,r,o,A)}createTextAnnotation(t,e,s,i,r=null,o=null){this.isDrawing=!1;const A=this.gridToCanvas(t,e),a=this.gridToCanvas(t+s,e+i),l=A.x,c=A.y,u=a.x-l,d=a.y-c,f=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',m=o||this.toolSettings.text,g=document.createElement("div");g.contentEditable="true",g.className="annotation-text-input",g.textContent=r||"Type here...";const w=m.size,B=w*1.2;g.style.width=`${u}px`,g.style.height=`${d}px`,g.style.padding=m.background?"4px 8px":"4px",g.style.border="2px dashed rgba(74, 144, 226, 0.5)",g.style.backgroundColor=m.background?"#ffffff":"transparent",g.style.color=m.color,g.style.fontSize=`${w}px`,g.style.lineHeight=`${B}px`,g.style.fontWeight=m.bold?"bold":"normal",g.style.fontStyle=m.italic?"italic":"normal",g.style.textDecoration=m.underline?"underline":"none",m.superscript?(g.style.fontSize=`${w*.6}px`,g.style.verticalAlign="super"):m.subscript&&(g.style.fontSize=`${w*.6}px`,g.style.verticalAlign="sub"),g.style.outline="none",g.style.zIndex="10000",g.style.position="fixed",g.style.cursor="text",g.style.pointerEvents="auto",g.style.fontFamily=f,g.style.whiteSpace="pre-wrap",g.style.wordWrap="break-word",g.style.overflow="hidden",g.style.boxSizing="border-box";const b=this.canvas.getBoundingClientRect();g.style.left=`${b.left+l}px`,g.style.top=`${b.top+c}px`,document.body.appendChild(g),g.focus();const _=document.createRange();_.selectNodeContents(g);const v=window.getSelection();v&&(v.removeAllRanges(),v.addRange(_));let C=!1;const y=()=>{if(C)return;C=!0;const F=g.textContent.trim();if(F&&F!=="Type here..."){const x={type:"text",col:t,row:e,widthCols:s,heightRows:i,text:F,settings:{...m}};h.state.annotations.push(x),this.selectedAnnotation=h.state.annotations[h.state.annotations.length-1],h.recordState(),this.render()}document.body.contains(g)&&document.body.removeChild(g)};let S=!1;g.addEventListener("input",()=>{!S&&g.textContent==="Type here..."&&(g.textContent="",S=!0)}),setTimeout(()=>{g.addEventListener("blur",y)},100),g.addEventListener("keydown",F=>{F.key==="Enter"&&!F.shiftKey&&(F.preventDefault(),y()),F.key==="Escape"&&(C=!0,document.body.contains(g)&&document.body.removeChild(g))})}handleLassoSelection(t=!1){var s,i;if(!((s=this.tempAnnotation)!=null&&s.path))return;const e=this.getRenderOptions();h.state.lassoSelection=AQ({lassoPath:this.tempAnnotation.path,state:h.state,renderOptions:e,isAdditive:t,existingSelectedItems:(i=h.state.lassoSelection)==null?void 0:i.selectedItems}),h.recordState(),E.log("AnnotationService",`Lasso selection completed: ${h.state.lassoSelection.selectedItems.length} items selected`,"annotation"),this.render()}updateLassoConvexHull(){var e,s;if(!((e=h.state.lassoSelection)!=null&&e.isActive)||!((s=h.state.lassoSelection.selectedItems)!=null&&s.length))return;const t=this.getRenderOptions();h.state.lassoSelection.convexHull=ZA({selectedItems:h.state.lassoSelection.selectedItems,renderOptions:t})}removeFromLassoSelection(t,e){var r;if(!((r=h.state.lassoSelection)!=null&&r.isActive))return;const s=this.getRenderOptions(),i=aQ({canvasX:t,canvasY:e,state:h.state,renderOptions:s,selection:h.state.lassoSelection});i!=null&&i.changed&&(h.state.lassoSelection=i.nextSelection,h.recordState(),this.render(),E.log("AnnotationService",`Removed item from lasso selection. ${i.nextSelection.selectedItems.length} items remain.`,"annotation"))}drawTempAnnotation(){if(this.tempAnnotation)switch(this.tempAnnotation.type){case"arrow":this.drawArrow(this.tempAnnotation,!0);break;case"text":this.drawTextBoxPreview(this.tempAnnotation);break;case"marker":this.drawPath(this.tempAnnotation,!1);break;case"highlighter":this.drawPath(this.tempAnnotation,!0);break;case"lasso":this.drawLassoPath(this.tempAnnotation);break}}drawTextBoxPreview(t){const{startX:e,startY:s,endX:i,endY:r}=t,o=this.ctx,A=Math.min(e,i),a=Math.min(s,r),l=Math.abs(i-e),c=Math.abs(r-s);o.save(),o.strokeStyle="rgba(74, 144, 226, 0.6)",o.lineWidth=2,o.setLineDash([5,5]),o.strokeRect(A,a,l,c),this.toolSettings.text.background&&(o.fillStyle="rgba(255, 255, 255, 0.8)",o.fillRect(A,a,l,c)),o.restore()}render(){ta.render()}drawArrow(t,e=!1,s=!1,i=!1){cQ({ctx:this.ctx,annotation:t,isTemp:e,isSelected:s,isHovered:i,getStrokeWidth:this.getStrokeWidth.bind(this),getLineDash:this.getLineDash.bind(this)})}wrapText(t,e,s){const i=e.split(`
`),r=[];return i.forEach(o=>{if(!o.trim()){r.push("");return}const A=o.split(" ");let a="";A.forEach((l,c)=>{const u=a?a+" "+l:l;t.measureText(u).width>s&&a?(r.push(a),a=l):a=u}),a&&r.push(a)}),r}drawText(t,e=!1,s=!1){const{x:i,y:r,text:o,settings:A}=t,a=this.ctx;a.save();const c=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',u=this.getSizeValue(A.size);a.font=`${A.italic?"italic ":""}${A.bold?"bold ":""}${u} ${c}`,a.textBaseline="top";const d=parseInt(u)*1.2,p=t.width||0,f=t.height||0,m=A.background?16:8,g=p-m,w=this.wrapText(a,o,g);if(A.background){a.fillStyle="#ffffff";const b=8;a.fillRect(i-b/2,r-b/2,p+b,f+b/2)}if(s&&!e){a.fillStyle="rgba(74, 144, 226, 0.1)";const b=A.background?8:2;a.fillRect(i-b/2,r-b/2,p+b,f+b/2)}if(e){a.fillStyle="rgba(74, 144, 226, 0.2)";const b=A.background?8:2;a.fillRect(i-b/2,r-b/2,p+b,f+b/2)}a.fillStyle=A.color;const B=parseInt(u);w.forEach((b,_)=>{const v=r+_*d;this.drawTextWithSuperscripts(a,b,i,v,B,A,c)}),e&&this.drawResizeHandles(i,r,p,f),a.restore()}drawTextWithSuperscripts(t,e,s,i,r,o,A){if(o.superscript||o.subscript){t.save();const u=r*.6,d=o.superscript?-r*.4:r*.3;if(t.font=`${o.italic?"italic ":""}${o.bold?"bold ":""}${u}px ${A}`,t.fillText(e,s,i+d),o.underline){const p=t.measureText(e);t.beginPath(),t.strokeStyle=o.color,t.lineWidth=1,t.moveTo(s,i+d+u*1.2-2),t.lineTo(s+p.width,i+d+u*1.2-2),t.stroke()}t.restore();return}let a=s;const l=this.parseFormattedText(e),c=(u,d)=>{const p=u;if(p){if(t.save(),d==="superscript"){const f=r*.6,m=-r*.4;t.font=`${o.italic?"italic ":""}${o.bold?"bold ":""}${f}px ${A}`,t.fillText(p,a,i+m),a+=t.measureText(p).width}else if(d==="subscript"){const f=r*.6,m=r*.3;t.font=`${o.italic?"italic ":""}${o.bold?"bold ":""}${f}px ${A}`,t.fillText(p,a,i+m),a+=t.measureText(p).width}else{if(t.font=`${o.italic?"italic ":""}${o.bold?"bold ":""}${r}px ${A}`,t.fillText(p,a,i),o.underline){const f=t.measureText(p);t.beginPath(),t.strokeStyle=o.color,t.lineWidth=1,t.moveTo(a,i+r*1.2-2),t.lineTo(a+f.width,i+r*1.2-2),t.stroke()}a+=t.measureText(p).width}t.restore()}};l.forEach(u=>{c(u.text,u.format)})}parseFormattedText(t){const e=[];let s=0,i="",r=!1;for(;s<t.length;){if(t.substr(s,5)==="<sup>"){i&&(e.push({text:i,format:"normal"}),i="");const o=t.indexOf("</sup>",s);if(o!==-1){const A=t.substring(s+5,o);e.push({text:A,format:"superscript"}),s=o+6;continue}}if(t.substr(s,5)==="<sub>"){i&&(e.push({text:i,format:"normal"}),i="");const o=t.indexOf("</sub>",s);if(o!==-1){const A=t.substring(s+5,o);e.push({text:A,format:"subscript"}),s=o+6;continue}}if(t[s]==="^"&&!r){i&&(e.push({text:i,format:"normal"}),i=""),r=!0,s++;continue}if(r&&t[s]===" "){i&&(e.push({text:i,format:"superscript"}),i=""),r=!1,e.push({text:" ",format:"normal"}),s++;continue}i+=t[s],s++}return i&&e.push({text:i,format:r?"superscript":"normal"}),e}drawResizeHandles(t,e,s,i){const r=this.ctx,o=8,A=[{pos:"nw",x:t,y:e},{pos:"n",x:t+s/2,y:e},{pos:"ne",x:t+s,y:e},{pos:"e",x:t+s,y:e+i/2},{pos:"se",x:t+s,y:e+i},{pos:"s",x:t+s/2,y:e+i},{pos:"sw",x:t,y:e+i},{pos:"w",x:t,y:e+i/2}];r.save(),A.forEach(a=>{r.fillStyle="#4a90e2",r.strokeStyle="#ffffff",r.lineWidth=2,r.fillRect(a.x-o/2,a.y-o/2,o,o),r.strokeRect(a.x-o/2,a.y-o/2,o,o)}),r.restore()}drawPath(t,e){const{path:s,settings:i}=t,r=this.ctx;if(!(s.length<2)){r.save(),e&&(r.globalAlpha=.3),r.strokeStyle=i.color,r.lineWidth=this.getStrokeWidth(i.size),r.lineCap="round",r.lineJoin="round",r.beginPath(),r.moveTo(s[0].x,s[0].y);for(let o=1;o<s.length;o++)r.lineTo(s[o].x,s[o].y);r.stroke(),r.restore()}}drawLassoPath(t){const{path:e}=t,s=this.ctx;if(!(e.length<2)){s.save(),s.strokeStyle="rgba(0, 100, 255, 0.8)",s.lineWidth=2,s.setLineDash([5,5]),s.beginPath(),s.moveTo(e[0].x,e[0].y);for(let i=1;i<e.length;i++)s.lineTo(e[i].x,e[i].y);s.lineTo(e[0].x,e[0].y),s.stroke(),s.restore()}}getStrokeWidth(t){if(typeof t=="number")return t;switch(t){case"small":return 2;case"medium":return 4;case"large":return 6;default:return 2}}getLineDash(t){switch(t){case"solid":return[];case"dashed-big":return[10,5];case"dashed-small":return[5,3];case"dotted":return[2,3];default:return[]}}getSizeValue(t){if(typeof t=="number")return`${t}px`;switch(t){case"small":return"14px";case"medium":return"18px";case"large":return"24px";default:return"16px"}}updateHover(t,e){var o,A,a,l;const s=this.hoverAnnotation,i=typeof document<"u"&&((A=(o=document.body)==null?void 0:o.dataset)==null?void 0:A.cursorOverride)==="stamp";if(((a=this.selectedAnnotation)==null?void 0:a.type)==="text"){const c=this.getResizeHandleAt(t,e,this.selectedAnnotation);if(c){const u={nw:"nwse-resize",n:"ns-resize",ne:"nesw-resize",e:"ew-resize",se:"nwse-resize",s:"ns-resize",sw:"nesw-resize",w:"ew-resize"};this.canvas.style.cursor=u[c]??"default";return}}if((l=h.state.lassoSelection)!=null&&l.isActive&&h.state.lassoSelection.convexHull){const c=tg({x:t,y:e},h.state.lassoSelection.convexHull,10),u=JA({x:t,y:e},h.state.lassoSelection.convexHull);if(c||u){this.canvas.style.cursor="move";return}}const r=this.getAnnotationAt(t,e);r&&(r.type==="arrow"||r.type==="text")?(i||(this.currentTool==="text"&&r.type==="text"?this.selectedAnnotation===r?this.canvas.style.cursor="move":this.canvas.style.cursor="pointer":this.canvas.style.cursor="move"),this.hoverAnnotation=r):(i||(this.currentTool?this.setTool(this.currentTool,this.toolSettings):s&&(this.canvas.style.cursor="default")),this.hoverAnnotation=null),s!==this.hoverAnnotation&&this.render()}getResizeHandleAt(t,e,s){if((s==null?void 0:s.type)!=="text")return null;const r=8/2+2,o=this.getRenderOptions(),A=it(s.col,o),a=Bt(s.row,o),l=it(s.col+s.widthCols,o),c=Bt(s.row+s.heightRows,o),u=l-A,d=c-a,p=[{pos:"nw",x:A,y:a},{pos:"n",x:A+u/2,y:a},{pos:"ne",x:A+u,y:a},{pos:"e",x:A+u,y:a+d/2},{pos:"se",x:A+u,y:a+d},{pos:"s",x:A+u/2,y:a+d},{pos:"sw",x:A,y:a+d},{pos:"w",x:A,y:a+d/2}];for(const f of p)if(Math.sqrt(Math.pow(t-f.x,2)+Math.pow(e-f.y,2))<=r)return f.pos;return null}getAnnotationAt(t,e){for(let i=h.state.annotations.length-1;i>=0;i--){const r=h.state.annotations[i];if(r.type==="arrow"){if(rB(t,e,r.startX,r.startY,r.endX,r.endY)<10)return r}else if(r.type==="text"){const o=this.getRenderOptions(),A=it(r.col,o),a=Bt(r.row,o),l=it(r.col+r.widthCols,o),c=Bt(r.row+r.heightRows,o),u=l-A,d=c-a;if(t>=A&&t<=A+u&&e>=a&&e<=a+d)return r}}return null}showEraserCursor(t,e){this.render();const i=(h.state.cellWidth||40)*2;this.ctx.save(),this.ctx.fillStyle="rgba(220, 53, 69, 0.3)",this.ctx.fillRect(t-i/2,e-i/2,i,i),this.ctx.restore()}loadAnnotationSettings(t){if(t.type==="arrow"&&window.drawToolsController){const e=t.settings;window.drawToolsController.settings.arrow={...e},window.drawToolsController.renderArrowOptions()}else if(t.type==="text"&&window.drawToolsController){const e=t.settings;window.drawToolsController.settings.text={...e},window.drawToolsController.renderTextOptions()}}applyCurrentSettingsToSelected(){this.selectedAnnotation&&(this.selectedAnnotation.type==="arrow"&&this.toolSettings.arrow?(this.selectedAnnotation.settings={...this.toolSettings.arrow},this.render()):this.selectedAnnotation.type==="text"&&this.toolSettings.text&&(this.selectedAnnotation.settings={...this.toolSettings.text},this.render()))}clearAnnotations(){h.state.annotations=[],this.render()}eraseAtPoint(t,e){const{nextAnnotations:s,changed:i}=oQ({x:t,y:e,annotations:h.state.annotations,getRenderOptions:()=>this.getRenderOptions()});return h.state.annotations=s,i&&this.render(),i}interpolatePoints(t,e){const s=[],i=e.col-t.col,r=e.row-t.row,o=Math.sqrt(i*i+r*r),A=Math.max(1,Math.floor(o/.1));for(let a=1;a<=A;a++){const l=a/A;s.push({col:t.col+l*i,row:t.row+l*r})}return s}deleteAnnotationAt(t,e){this.eraseAtPoint(t,e)}getAnnotations(){return h.state.annotations}loadAnnotations(t){h.state.annotations=t||[],this.render()}applyInlineFormatting(t){const e=document.querySelector(".annotation-text-input");if(!e)return;const s=window.getSelection();if(!s||!s.rangeCount)return;const i=s.getRangeAt(0),r=i.toString();if(!r)return;let o;if(t==="superscript")o=`<sup>${r}</sup>`;else if(t==="subscript")o=`<sub>${r}</sub>`;else return;i.deleteContents();const A=document.createTextNode(o);i.insertNode(A),i.setStartAfter(A),i.setEndAfter(A),s.removeAllRanges(),s.addRange(i),e instanceof HTMLElement&&e.focus()}}const Yt=new uQ;function sg(n){if((n==null?void 0:n.type)!=="arrow")return!1;const t=n,e=t.settings;return typeof t.startCol=="number"&&typeof t.startRow=="number"&&typeof t.endCol=="number"&&typeof t.endRow=="number"&&!!e&&typeof e.strokeWeight=="number"&&typeof e.lineStyle=="string"}function ig(n){if((n==null?void 0:n.type)!=="text")return!1;const t=n,e=t.settings;return typeof t.col=="number"&&typeof t.row=="number"&&typeof t.widthCols=="number"&&typeof t.heightRows=="number"&&typeof t.text=="string"&&!!e&&typeof e.size=="number"&&typeof e.color=="string"}function dQ(n){if((n==null?void 0:n.type)!=="text")return!1;const t=n,e=typeof n.col=="number";return typeof t.startCol=="number"&&typeof t.startRow=="number"&&typeof t.endCol=="number"&&typeof t.endRow=="number"&&!e}function rg(n){if(!n||n.type!=="marker"&&n.type!=="highlighter")return!1;const t=n,e=t.settings;return Array.isArray(t.path)&&!!e&&typeof e.color=="string"&&(typeof e.size=="number"||e.size==="small"||e.size==="medium"||e.size==="large")}function hQ(n){return(n==null?void 0:n.type)==="lasso"&&Array.isArray(n.path)}function fQ(n,t){const e=h.state.annotations,s=Yt.tempAnnotation,i=Yt.selectedAnnotation,r=Yt.hoverAnnotation;if(e&&e.length>0&&e.forEach(A=>{const a=A===i,l=A===r;switch(A.type){case"arrow":sg(A)&&og(n,A,a,l,t);break;case"text":ig(A)&&ag(n,A,a,l,t);break;case"marker":case"highlighter":rg(A)&&lg(n,A,t);break}}),s)switch(s.type){case"arrow":sg(s)&&og(n,s,!1,!1,t);break;case"text":dQ(s)?vQ(n,s,t):ig(s)&&ag(n,s,!1,!1,t);break;case"marker":case"highlighter":rg(s)&&lg(n,s,t);break;case"lasso":hQ(s)&&CQ(n,s);break}const o=h.state.lassoSelection;o!=null&&o.isActive&&Array.isArray(o.convexHull)&&(Yt.updateLassoConvexHull(),bQ(n,o.convexHull))}function og(n,t,e=!1,s=!1,i){const{startCol:r,startRow:o,endCol:A,endRow:a,settings:l}=t,c=it(r,i),u=Bt(o,i),d=it(A,i),p=Bt(a,i);n.save(),n.strokeStyle=t.color||"#000000",n.lineWidth=ih(l.strokeWeight),n.setLineDash(BQ(l.lineStyle));const f=Math.atan2(p-u,d-c),m=l.arrowheadSize||12;let g=c,w=u,B=d,b=p;l.startArrowhead&&l.startArrowhead!=="none"&&(g=c+Math.cos(f)*m,w=u+Math.sin(f)*m),l.endArrowhead&&l.endArrowhead!=="none"&&(B=d-Math.cos(f)*m,b=p-Math.sin(f)*m),n.beginPath(),n.moveTo(g,w),n.lineTo(B,b),n.stroke(),n.setLineDash([]),l.startArrowhead&&l.startArrowhead!=="none"&&Ag(n,c,u,f+Math.PI,l.startArrowhead,m),l.endArrowhead&&l.endArrowhead!=="none"&&Ag(n,d,p,f,l.endArrowhead,m),(e||s)&&(n.strokeStyle=e?"rgba(74, 144, 226, 0.6)":"rgba(74, 144, 226, 0.3)",n.lineWidth=ih(l.strokeWeight)+4,n.setLineDash([]),n.beginPath(),n.moveTo(c,u),n.lineTo(d,p),n.stroke()),n.restore()}function Ag(n,t,e,s,i,r){switch(n.save(),n.translate(t,e),n.rotate(s),i){case"filled":case"filled-arrow":n.beginPath(),n.moveTo(0,0),n.lineTo(-r,-r/2),n.lineTo(-r,r/2),n.closePath(),n.fillStyle=n.strokeStyle,n.fill();break;case"unfilled":case"unfilled-arrow":n.beginPath(),n.moveTo(0,0),n.lineTo(-r,-r/2),n.lineTo(-r,r/2),n.closePath(),n.stroke();break;case"circle":n.beginPath(),n.arc(0,0,r/3,0,Math.PI*2),n.fillStyle=n.strokeStyle,n.fill();break}n.restore()}function ag(n,t,e=!1,s=!1,i){const{col:r,row:o,text:A,widthCols:a,heightRows:l,settings:c}=t,u=it(r,i),d=Bt(o,i),p=it(r+(typeof a=="number"?a:2),i)-u,f=Bt(o+(typeof l=="number"?l:1),i)-d;n.save(),n.textBaseline="top";const g=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',w=c.size,B=w*1.2,b=c.background?8:4,_=4,v=p-b*2,C=pQ(n,A,v,w,c,g);c.background&&(n.fillStyle="#ffffff",n.fillRect(u,d,p,f)),s&&!e&&(n.fillStyle="rgba(74, 144, 226, 0.1)",n.fillRect(u,d,p,f)),e&&(n.fillStyle="rgba(74, 144, 226, 0.2)",n.fillRect(u,d,p,f)),n.fillStyle=c.color,C.forEach((y,S)=>{const F=d+_+S*B;mQ(n,y,u+b,F,w,c,g)}),e&&wQ(n,u,d,p,f),n.restore()}function pQ(n,t,e,s,i,r){n.font=`${i.italic?"italic ":""}${i.bold?"bold ":""}${s}px ${r}`;const o=t.split(`
`),A=[];return o.forEach(a=>{if(!a.trim()){A.push("");return}const l=a.split(" ");let c="";l.forEach(u=>{const d=c?c+" "+u:u;n.measureText(d).width>e&&c?(A.push(c),c=u):c=d}),c&&A.push(c)}),A}function mQ(n,t,e,s,i,r,o){if(r.superscript||r.subscript){n.save();const l=i*.6,c=r.superscript?-i*.4:i*.3;if(n.font=`${r.italic?"italic ":""}${r.bold?"bold ":""}${l}px ${o}`,n.fillText(t,e,s+c),r.underline){const u=n.measureText(t);n.beginPath(),n.strokeStyle=r.color,n.lineWidth=1,n.moveTo(e,s+c+l*1.2-2),n.lineTo(e+u.width,s+c+l*1.2-2),n.stroke()}n.restore();return}const A=gQ(t);let a=e;A.forEach(l=>{if(n.save(),l.format==="superscript"){const c=i*.6,u=-i*.4;n.font=`${r.italic?"italic ":""}${r.bold?"bold ":""}${c}px ${o}`,n.fillText(l.text,a,s+u),a+=n.measureText(l.text).width}else if(l.format==="subscript"){const c=i*.6,u=i*.3;n.font=`${r.italic?"italic ":""}${r.bold?"bold ":""}${c}px ${o}`,n.fillText(l.text,a,s+u),a+=n.measureText(l.text).width}else{if(n.font=`${r.italic?"italic ":""}${r.bold?"bold ":""}${i}px ${o}`,n.fillText(l.text,a,s),r.underline){const c=n.measureText(l.text);n.beginPath(),n.strokeStyle=r.color,n.lineWidth=1,n.moveTo(a,s+i*1.2-2),n.lineTo(a+c.width,s+i*1.2-2),n.stroke()}a+=n.measureText(l.text).width}n.restore()})}function gQ(n){const t=[];let e=0,s="",i=!1;for(;e<n.length;){if(n.substr(e,5)==="<sup>"){s&&(t.push({text:s,format:"normal"}),s="");const r=n.indexOf("</sup>",e);if(r!==-1){const o=n.substring(e+5,r);t.push({text:o,format:"superscript"}),e=r+6;continue}}if(n.substr(e,5)==="<sub>"){s&&(t.push({text:s,format:"normal"}),s="");const r=n.indexOf("</sub>",e);if(r!==-1){const o=n.substring(e+5,r);t.push({text:o,format:"subscript"}),e=r+6;continue}}if(n[e]==="^"&&!i){s&&(t.push({text:s,format:"normal"}),s=""),i=!0,e++;continue}if(i&&n[e]===" "){s&&(t.push({text:s,format:"superscript"}),s=""),i=!1,t.push({text:" ",format:"normal"}),e++;continue}s+=n[e],e++}return s&&t.push({text:s,format:i?"superscript":"normal"}),t}function wQ(n,t,e,s,i){const o=[{x:t,y:e},{x:t+s/2,y:e},{x:t+s,y:e},{x:t+s,y:e+i/2},{x:t+s,y:e+i},{x:t+s/2,y:e+i},{x:t,y:e+i},{x:t,y:e+i/2}];n.save(),o.forEach(A=>{n.fillStyle="#4a90e2",n.strokeStyle="#ffffff",n.lineWidth=2,n.fillRect(A.x-8/2,A.y-8/2,8,8),n.strokeRect(A.x-8/2,A.y-8/2,8,8)}),n.restore()}function vQ(n,t,e){const{startCol:s,startRow:i,endCol:r,endRow:o}=t,A=it(s,e),a=Bt(i,e),l=it(r,e),c=Bt(o,e),u=Math.min(A,l),d=Math.min(a,c),p=Math.abs(l-A),f=Math.abs(c-a);n.save(),n.strokeStyle="rgba(74, 144, 226, 0.6)",n.lineWidth=2,n.setLineDash([5,5]),n.strokeRect(u,d,p,f),n.restore()}function lg(n,t,e){const{path:s,settings:i,type:r}=t;if(!s||s.length<2)return;const o=s.map(a=>({x:it(a.col,e),y:Bt(a.row,e)}));n.save(),r==="highlighter"&&(n.globalAlpha=.3),n.strokeStyle=i.color,n.lineWidth=typeof i.size=="number"?i.size:ih(i.size),n.lineCap="round",n.lineJoin="round",n.beginPath();const A=o[0];if(!A){n.restore();return}n.moveTo(A.x,A.y);for(let a=1;a<o.length;a++){const l=o[a];l&&n.lineTo(l.x,l.y)}n.stroke(),n.restore()}function ih(n){if(typeof n=="number")return n;switch(n){case"small":return 2;case"medium":return 4;case"large":return 6;default:return 4}}function BQ(n){switch(n){case"solid":return[];case"dashed-big":return[10,5];case"dashed-small":return[5,3];case"dotted":return[2,3];default:return[]}}function CQ(n,t){const e=t.path;if(!e||e.length<2)return;const s=e[0];if(s){n.save(),n.strokeStyle="#4a90e2",n.lineWidth=2,n.setLineDash([5,5]),n.globalAlpha=.7,n.beginPath(),n.moveTo(s.x,s.y);for(let i=1;i<e.length;i++){const r=e[i];r&&n.lineTo(r.x,r.y)}e.length>2&&n.lineTo(s.x,s.y),n.stroke(),n.restore()}}function bQ(n,t){if(!t||t.length<3)return;const e=t[0];if(e){n.save(),n.strokeStyle="#4a90e2",n.lineWidth=2,n.setLineDash([8,4]),n.globalAlpha=.8,n.beginPath(),n.moveTo(e.x,e.y);for(let s=1;s<t.length;s++){const i=t[s];i&&n.lineTo(i.x,i.y)}n.closePath(),n.stroke(),n.fillStyle="rgba(74, 144, 226, 0.1)",n.fill(),n.restore()}}let cg=0;function oB(){try{if(globalThis.__SN_DEBUG_VIEWPORT)return!0}catch{}try{if(new URLSearchParams(window.location.search).get("debugViewport")==="1")return!0}catch{}try{return localStorage.getItem("sn:debugViewport")==="1"}catch{return!1}}let yQ=!1;function SQ(n,t){var e;if(oB())try{const s=((e=performance==null?void 0:performance.now)==null?void 0:e.call(performance))??Date.now();if(s-cg<500)return;cg=s,yQ=!0}catch{}}function EQ(n,t){var m,g,w,B,b,_;const e={...h.state,...t};if(!((m=e.columnWidths)!=null&&m.length)||!((g=e.fullRowData)!=null&&g.length))return;n.clearRect(0,0,He(n.canvas),ie(n.canvas));const{startRow:s,endRow:i}=gT(),r=Math.max(0,s-1),o=Math.max(0,(((w=e.fullRowData)==null?void 0:w.length)??1)-1),A=Math.min(o,i+1);if(oB()){const v=ie(n.canvas),C=e.cellHeight/2,y=Bt(i,e),S=y+C,F=((B=e.fullRowData)==null?void 0:B.length)??0,x=s<=0,Q=F>0?i>=F-1:!1,T=(b=e.fullRowData)==null?void 0:b[s],U=(_=e.fullRowData)==null?void 0:_[i];SQ("pitchCanvasCoverage",{startRow:s,endRow:i,paddedStartRow:r,paddedEndRow:A,atTopGamutEdge:x,atBottomGamutEdge:Q,canvasHeight:v,containerHeight:e.viewportHeight,halfUnit:C,yEnd:y,bottomEdge:S,gapCanvasMinusBottomEdge:v-S,gapCanvasMinusContainer:v-e.viewportHeight,startRowSummary:T?{pitch:T.pitch,column:T.column,isBoundary:!!T.isBoundary}:null,endRowSummary:U?{pitch:U.pitch,column:U.column,isBoundary:!!U.isBoundary}:null})}const a=e.cellHeight,l=v=>{const C=Bt(v,e);return C>=-a&&C<=e.viewportHeight+a},c=e.placedTonicSigns.filter(v=>v.globalRow===void 0?!1:l(v.globalRow)),u=YA.getLegendLeftContext(),d=YA.getLegendRightContext();DT(u,d,e,r,A),xT(n,e,r,A),_T(n,e);const p=t.placedNotes.filter(v=>v.isDrum||v.globalRow===void 0?!1:l(v.globalRow)),f=c;p.forEach(v=>{v.shape==="oval"?cp(n,e,v,v.globalRow):v.shape==="circle"&&lp(n,e,v,v.globalRow)}),f.forEach(v=>{tB(n,e,v)}),GT(n,e),zT(n,e),iB(n,e),fQ(n,e)}const AB={getTimeSignatureSegments(){const n=h.state,t=n.macrobeatGroupings??[],e=n.macrobeatBoundaryStyles??[],s=[];let i=!!n.hasAnacrusis,r=dn(n,0).startColumn,o=0,A=!1;return t.forEach((a,l)=>{o+=a,a===3&&(A=!0);const c=l===t.length-1,d=e[l]==="solid";if(d||c){const f=dn(n,l).endColumn+1,m=Array.isArray(n.modulationMarkers)&&n.modulationMarkers.length>0,g={...n,modulationMarkers:m?n.modulationMarkers:[],cellWidth:n.cellWidth,columnWidths:n.columnWidths,musicalColumnWidths:n.musicalColumnWidths,baseMicrobeatPx:n.cellWidth},w=it(r,g),B=it(f,g),b=A?`${o}/8`:`${o/2}/4`;s.push({label:b,centerX:(w+B)/2,startX:w,endX:B,isAnacrusis:i}),c||(r=f,o=0,A=!1,d&&(i=!1))}}),s},getRhythmUIButtons(){const n=h.state,t=n.macrobeatGroupings??[],e=n.macrobeatBoundaryStyles??[],s=[],i=Ve(n),r=new Set(i.map(o=>o.columnIndex+2));return t.forEach((o,A)=>{const a=dn(n,A),{startColumn:l,endColumn:c}=a,u={...n,modulationMarkers:n.modulationMarkers||[],cellWidth:n.cellWidth,columnWidths:n.columnWidths,musicalColumnWidths:n.columnWidths,baseMicrobeatPx:n.cellWidth},d=it(l,u),p=it(c+1,u),f=(d+p)/2,m=e[A]??null,g=A>0?e[A-1]??null:null,w=g!==null&&r.has(l);s.push({type:"grouping",content:o,x:f,startX:d,endX:p,index:A,nextBoundaryStyle:m,prevBoundaryStyle:g,hasLeftDivider:w}),A<t.length-1&&s.push({type:"boundary",boundaryStyle:m,x:p,index:A})}),s}},xQ="data-rhythm-ui-element",rh=n=>`${Math.round(n*100)/100}px`,_Q=n=>{n.querySelectorAll(`[${xQ}]`).forEach(t=>t.remove())},IQ=n=>{const t=document.getElementById("notation-grid");if(!t)return null;const e=t.getBoundingClientRect(),s=n.getBoundingClientRect();return e.width===0?null:e.left-s.left},FQ=(n,t)=>{const e=document.createElement("button");return e.type="button",e.className="grouping-segment",e.dataset.rhythmUiElement="grouping",e.dataset.index=`${n.index}`,e.textContent=`${n.content}`,e.style.left=rh(t+n.startX),e.style.width=rh(Math.max(0,n.endX-n.startX)),e.dataset.nextBoundaryStyle=`${n.nextBoundaryStyle??""}`,e.dataset.prevBoundaryStyle=`${n.prevBoundaryStyle??""}`,e.dataset.hasLeftDivider=n.hasLeftDivider?"true":"false",e.setAttribute("aria-label",`Toggle macrobeat grouping (${n.content}) at position ${n.index+1}`),e.addEventListener("click",s=>{s.stopPropagation(),h.toggleMacrobeatGrouping(n.index)}),e},TQ=(n,t)=>{const e=document.createElement("button");e.type="button",e.className="buttonGrid-ui-button buttonGrid-ui-button--boundary",e.dataset.rhythmUiElement="boundary",e.dataset.index=`${n.index}`,e.style.left=rh(t+n.x),e.setAttribute("aria-label","Cycle boundary style");const s=document.createElement("span");return s.className="boundary-diamond",s.dataset.style=n.boundaryStyle||"dashed",e.appendChild(s),e.addEventListener("click",i=>{i.stopPropagation(),h.cycleMacrobeatBoundaryStyle(n.index)}),e};function aB(){const n=document.getElementById("beat-line-button-layer");if(!n){E.warn("rhythmUI","Cannot render rhythm UI without beat-line container",null,"ui");return}const t=IQ(n);if(t===null)return;const e=n.querySelector("#grouping-buttons-row"),s=n.querySelector("#boundary-buttons-row");_Q(n);const i=AB.getRhythmUIButtons();if(!Array.isArray(i)||i.length===0)return;const r=document.createDocumentFragment(),o=document.createDocumentFragment();i.forEach(A=>{A.type==="grouping"?r.appendChild(FQ(A,t)):A.type==="boundary"&&o.appendChild(TQ(A,t))}),e?e.appendChild(r):n.appendChild(r),s?s.appendChild(o):n.appendChild(o)}const QQ={init:MQ};function MQ(){aB()}const UQ={getTimeSignatureOptions(){return{"Single Macrobeat":[{label:"1/4",groupings:[2],description:"one 2-beat"},{label:"2/8",groupings:[2],description:"one 2-beat"},{label:"3/8",groupings:[3],description:"one 3-beat"}],"Two Macrobeats":[{label:"2/4",groupings:[2,2],description:"two 2-beats"},{label:"4/8",groupings:[2,2],description:"two 2-beats"},{label:"5/8",groupings:[2,3],description:"2+3"},{label:"5/8",groupings:[3,2],description:"3+2"},{label:"6/8",groupings:[3,3],description:"two 3-beats"}],"Three Macrobeats":[{label:"3/4",groupings:[2,2,2],description:"three 2-beats"},{label:"7/8",groupings:[2,2,3],description:"2+2+3"},{label:"7/8",groupings:[3,2,2],description:"3+2+2"},{label:"7/8",groupings:[2,3,2],description:"2+3+2"},{label:"8/8",groupings:[3,3,2],description:"3+3+2"},{label:"8/8",groupings:[3,2,3],description:"3+2+3"},{label:"8/8",groupings:[2,3,3],description:"2+3+3"},{label:"9/8",groupings:[3,3,3],description:"three 3-beats"}],"Four Macrobeats":[{label:"4/4",groupings:[2,2,2,2],description:"four 2-beats"},{label:"10/8",groupings:[2,2,3,3],description:"2+2+3+3"},{label:"10/8",groupings:[2,3,2,3],description:"2+3+2+3"},{label:"10/8",groupings:[2,3,3,2],description:"2+3+3+2"},{label:"10/8",groupings:[3,2,3,2],description:"3+2+3+2"},{label:"10/8",groupings:[3,3,2,2],description:"3+3+2+2"},{label:"10/8",groupings:[3,2,2,3],description:"3+2+2+3"},{label:"11/8",groupings:[3,3,3,2],description:"3+3+3+2"},{label:"11/8",groupings:[3,3,2,3],description:"3+3+2+3"},{label:"11/8",groupings:[3,2,3,3],description:"3+2+3+3"},{label:"11/8",groupings:[2,3,3,3],description:"2+3+3+3"},{label:"12/8",groupings:[3,3,3,3],description:"four 3-beats"}],"Five Macrobeats":[{label:"5/4",groupings:[2,2,2,2,2],description:"five 2-beats"},{label:"11/8",groupings:[2,2,2,2,3],description:"2+2+2+2+3"},{label:"11/8",groupings:[2,2,2,3,2],description:"2+2+2+3+2"},{label:"11/8",groupings:[2,2,3,2,2],description:"2+2+3+2+2"},{label:"11/8",groupings:[2,3,2,2,2],description:"2+3+2+2+2"},{label:"11/8",groupings:[3,2,2,2,2],description:"3+2+2+2+2"},{label:"12/8",groupings:[2,2,2,3,3],description:"2+2+2+3+3"},{label:"12/8",groupings:[2,2,3,2,3],description:"2+2+3+2+3"},{label:"12/8",groupings:[2,2,3,3,2],description:"2+2+3+3+2"},{label:"12/8",groupings:[2,3,2,2,3],description:"2+3+2+2+3"},{label:"12/8",groupings:[2,3,2,3,2],description:"2+3+2+3+2"},{label:"12/8",groupings:[2,3,3,2,2],description:"2+3+3+2+2"},{label:"12/8",groupings:[3,2,2,2,3],description:"3+2+2+2+3"},{label:"12/8",groupings:[3,2,2,3,2],description:"3+2+2+3+2"},{label:"12/8",groupings:[3,2,3,2,2],description:"3+2+3+2+2"},{label:"12/8",groupings:[3,3,2,2,2],description:"3+3+2+2+2"},{label:"13/8",groupings:[3,2,2,3,3],description:"3+2+2+3+3"},{label:"13/8",groupings:[3,3,2,3,2],description:"3+3+2+3+2"},{label:"13/8",groupings:[3,3,3,2,2],description:"3+3+3+2+2"},{label:"15/8",groupings:[3,3,3,3,3],description:"five 3-beats"}]}},generateDropdownHTML(){const n=this.getTimeSignatureOptions();let t='<div id="time-signature-dropdown" class="time-signature-dropdown hidden">';return Object.entries(n).forEach(([e,s])=>{t+='<div class="dropdown-category">',t+=`<div class="dropdown-category-header">${e}</div>`,s.forEach((i,r)=>{const o=`${e}-${r}`;t+=`<div class="dropdown-option" data-groupings="${JSON.stringify(i.groupings)}" data-key="${o}">`,t+=`<span class="dropdown-label">${i.label}</span>`,t+=`<span class="dropdown-description">${i.description}</span>`,t+="</div>"}),t+="</div>"}),t+="</div>",t},getTimeSignatureLabel(n){const t=n.reduce((s,i)=>s+i,0);return n.includes(3)?`${t}/8`:`${t/2}/4`}};let eo=null;function PQ(){const n=document.getElementById("beat-line-button-layer");if(!n)return;const t=n.querySelector("#time-signature-row")||n;n.querySelectorAll(".time-signature-label").forEach(a=>a.remove());const s=document.getElementById("notation-grid");if(!s)return;const i=s.getBoundingClientRect(),r=n.getBoundingClientRect(),o=i.left-r.left;AB.getTimeSignatureSegments().forEach((a,l)=>{const c=document.createElement("div");c.className="time-signature-label",a.isAnacrusis&&c.classList.add("anacrusis-label"),c.textContent=a.label,c.style.position="absolute",c.style.left=`${o+a.startX}px`,c.style.width=`${Math.max(0,a.endX-a.startX)}px`,c.style.transform="none",c.style.pointerEvents="auto",c.addEventListener("click",u=>{u.stopPropagation(),DQ(c,l)}),t.appendChild(c)}),NQ()}function NQ(){if(!document.getElementById("time-signature-dropdown")){const n=UQ.generateDropdownHTML();document.body.insertAdjacentHTML("beforeend",n);const t=document.getElementById("time-signature-dropdown");t==null||t.addEventListener("click",kQ)}}function DQ(n,t){const e=document.getElementById("time-signature-dropdown");if(!e)return;e.dataset.measureIndex=String(t);const s=n.getBoundingClientRect();e.style.left=`${s.left}px`,e.style.top=`${s.bottom+5}px`;const i=e.getBoundingClientRect(),r=window.innerWidth,o=window.innerHeight;s.left+i.width>r&&(e.style.left=`${r-i.width-10}px`),s.bottom+i.height>o&&(e.style.top=`${s.top-i.height-5}px`),e.classList.remove("hidden"),eo={dropdown:e,measureIndex:t},setTimeout(()=>{document.addEventListener("click",LQ,{once:!0})},0)}function LQ(n){const t=document.getElementById("time-signature-dropdown"),e=n.target;t&&e&&!t.contains(e)&&(t.classList.add("hidden"),eo=null)}function kQ(n){const t=n.target,e=t==null?void 0:t.closest(".dropdown-option");if(!e)return;const s=e.dataset.groupings,i=(eo==null?void 0:eo.measureIndex)??NaN;if(!(!s||Number.isNaN(i)))try{const r=JSON.parse(s);h.updateTimeSignature(i,r);const o=document.getElementById("time-signature-dropdown");o==null||o.classList.add("hidden"),eo=null}catch{}}E.moduleLoaded("PitchGridController","grid");function RQ(){var s,i;const n=YA.getPitchContext();if(!(n!=null&&n.canvas)){E.error("PitchGridController","Pitch grid context not available for rendering",null,"grid");return}const t=je.getViewportInfo(),e={placedNotes:SF(h.state),placedTonicSigns:Ve(h.state),fullRowData:h.state.fullRowData,columnWidths:h.state.columnWidths,cellWidth:h.state.cellWidth,cellHeight:h.state.cellHeight,rowHeight:h.state.cellHeight*.5,macrobeatGroupings:h.state.macrobeatGroupings,macrobeatBoundaryStyles:h.state.macrobeatBoundaryStyles,accidentalMode:h.state.accidentalMode,showFrequencyLabels:h.state.showFrequencyLabels,showOctaveLabels:h.state.showOctaveLabels,colorMode:"color",degreeDisplayMode:h.state.degreeDisplayMode,zoomLevel:t.zoomLevel,viewportHeight:t.containerHeight,modulationMarkers:h.state.modulationMarkers,showModulationLabel:!1};E.debug("PitchGridController","renderPitchGrid options",{columns:(s=e.columnWidths)==null?void 0:s.length,rows:(i=e.fullRowData)==null?void 0:i.length,placedNotes:e.placedNotes.length,tonicSigns:e.placedTonicSigns.length,zoomLevel:e.zoomLevel,viewportHeight:e.viewportHeight},"grid"),EQ(n,e)}const ta={render(){RQ()},renderMacrobeatTools(){aB(),PQ()}};/*!
 * html2canvas 1.4.1 <https://html2canvas.hertzen.com>
 * Copyright (c) 2022 Niklas von Hertzen <https://hertzen.com>
 * Released under MIT License
 *//*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var oh=function(n,t){return oh=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,s){e.__proto__=s}||function(e,s){for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])},oh(n,t)};function As(n,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");oh(n,t);function e(){this.constructor=n}n.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}var Ah=function(){return Ah=Object.assign||function(t){for(var e,s=1,i=arguments.length;s<i;s++){e=arguments[s];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])}return t},Ah.apply(this,arguments)};function qe(n,t,e,s){function i(r){return r instanceof e?r:new e(function(o){o(r)})}return new(e||(e=Promise))(function(r,o){function A(c){try{l(s.next(c))}catch(u){o(u)}}function a(c){try{l(s.throw(c))}catch(u){o(u)}}function l(c){c.done?r(c.value):i(c.value).then(A,a)}l((s=s.apply(n,[])).next())})}function Ne(n,t){var e={label:0,sent:function(){if(r[0]&1)throw r[1];return r[1]},trys:[],ops:[]},s,i,r,o;return o={next:A(0),throw:A(1),return:A(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function A(l){return function(c){return a([l,c])}}function a(l){if(s)throw new TypeError("Generator is already executing.");for(;e;)try{if(s=1,i&&(r=l[0]&2?i.return:l[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,l[1])).done)return r;switch(i=0,r&&(l=[l[0]&2,r.value]),l[0]){case 0:case 1:r=l;break;case 4:return e.label++,{value:l[1],done:!1};case 5:e.label++,i=l[1],l=[0];continue;case 7:l=e.ops.pop(),e.trys.pop();continue;default:if(r=e.trys,!(r=r.length>0&&r[r.length-1])&&(l[0]===6||l[0]===2)){e=0;continue}if(l[0]===3&&(!r||l[1]>r[0]&&l[1]<r[3])){e.label=l[1];break}if(l[0]===6&&e.label<r[1]){e.label=r[1],r=l;break}if(r&&e.label<r[2]){e.label=r[2],e.ops.push(l);break}r[2]&&e.ops.pop(),e.trys.pop();continue}l=t.call(n,e)}catch(c){l=[6,c],i=0}finally{s=r=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}function Ga(n,t,e){if(arguments.length===2)for(var s=0,i=t.length,r;s<i;s++)(r||!(s in t))&&(r||(r=Array.prototype.slice.call(t,0,s)),r[s]=t[s]);return n.concat(r||t)}var oi=(function(){function n(t,e,s,i){this.left=t,this.top=e,this.width=s,this.height=i}return n.prototype.add=function(t,e,s,i){return new n(this.left+t,this.top+e,this.width+s,this.height+i)},n.fromClientRect=function(t,e){return new n(e.left+t.windowBounds.left,e.top+t.windowBounds.top,e.width,e.height)},n.fromDOMRectList=function(t,e){var s=Array.from(e).find(function(i){return i.width!==0});return s?new n(s.left+t.windowBounds.left,s.top+t.windowBounds.top,s.width,s.height):n.EMPTY},n.EMPTY=new n(0,0,0,0),n})(),du=function(n,t){return oi.fromClientRect(n,t.getBoundingClientRect())},HQ=function(n){var t=n.body,e=n.documentElement;if(!t||!e)throw new Error("Unable to get document size");var s=Math.max(Math.max(t.scrollWidth,e.scrollWidth),Math.max(t.offsetWidth,e.offsetWidth),Math.max(t.clientWidth,e.clientWidth)),i=Math.max(Math.max(t.scrollHeight,e.scrollHeight),Math.max(t.offsetHeight,e.offsetHeight),Math.max(t.clientHeight,e.clientHeight));return new oi(0,0,s,i)},hu=function(n){for(var t=[],e=0,s=n.length;e<s;){var i=n.charCodeAt(e++);if(i>=55296&&i<=56319&&e<s){var r=n.charCodeAt(e++);(r&64512)===56320?t.push(((i&1023)<<10)+(r&1023)+65536):(t.push(i),e--)}else t.push(i)}return t},ce=function(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];if(String.fromCodePoint)return String.fromCodePoint.apply(String,n);var e=n.length;if(!e)return"";for(var s=[],i=-1,r="";++i<e;){var o=n[i];o<=65535?s.push(o):(o-=65536,s.push((o>>10)+55296,o%1024+56320)),(i+1===e||s.length>16384)&&(r+=String.fromCharCode.apply(String,s),s.length=0)}return r},ug="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",OQ=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var Ka=0;Ka<ug.length;Ka++)OQ[ug.charCodeAt(Ka)]=Ka;var dg="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",rA=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var qa=0;qa<dg.length;qa++)rA[dg.charCodeAt(qa)]=qa;var VQ=function(n){var t=n.length*.75,e=n.length,s,i=0,r,o,A,a;n[n.length-1]==="="&&(t--,n[n.length-2]==="="&&t--);var l=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u"&&typeof Uint8Array.prototype.slice<"u"?new ArrayBuffer(t):new Array(t),c=Array.isArray(l)?l:new Uint8Array(l);for(s=0;s<e;s+=4)r=rA[n.charCodeAt(s)],o=rA[n.charCodeAt(s+1)],A=rA[n.charCodeAt(s+2)],a=rA[n.charCodeAt(s+3)],c[i++]=r<<2|o>>4,c[i++]=(o&15)<<4|A>>2,c[i++]=(A&3)<<6|a&63;return l},WQ=function(n){for(var t=n.length,e=[],s=0;s<t;s+=2)e.push(n[s+1]<<8|n[s]);return e},GQ=function(n){for(var t=n.length,e=[],s=0;s<t;s+=4)e.push(n[s+3]<<24|n[s+2]<<16|n[s+1]<<8|n[s]);return e},mr=5,dp=11,Yu=2,KQ=dp-mr,lB=65536>>mr,qQ=1<<mr,ju=qQ-1,zQ=1024>>mr,XQ=lB+zQ,$Q=XQ,YQ=32,jQ=$Q+YQ,JQ=65536>>dp,ZQ=1<<KQ,tM=ZQ-1,hg=function(n,t,e){return n.slice?n.slice(t,e):new Uint16Array(Array.prototype.slice.call(n,t,e))},eM=function(n,t,e){return n.slice?n.slice(t,e):new Uint32Array(Array.prototype.slice.call(n,t,e))},nM=function(n,t){var e=VQ(n),s=Array.isArray(e)?GQ(e):new Uint32Array(e),i=Array.isArray(e)?WQ(e):new Uint16Array(e),r=24,o=hg(i,r/2,s[4]/2),A=s[5]===2?hg(i,(r+s[4])/2):eM(s,Math.ceil((r+s[4])/4));return new sM(s[0],s[1],s[2],s[3],o,A)},sM=(function(){function n(t,e,s,i,r,o){this.initialValue=t,this.errorValue=e,this.highStart=s,this.highValueIndex=i,this.index=r,this.data=o}return n.prototype.get=function(t){var e;if(t>=0){if(t<55296||t>56319&&t<=65535)return e=this.index[t>>mr],e=(e<<Yu)+(t&ju),this.data[e];if(t<=65535)return e=this.index[lB+(t-55296>>mr)],e=(e<<Yu)+(t&ju),this.data[e];if(t<this.highStart)return e=jQ-JQ+(t>>dp),e=this.index[e],e+=t>>mr&tM,e=this.index[e],e=(e<<Yu)+(t&ju),this.data[e];if(t<=1114111)return this.data[this.highValueIndex]}return this.errorValue},n})(),fg="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",iM=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var za=0;za<fg.length;za++)iM[fg.charCodeAt(za)]=za;var rM="KwAAAAAAAAAACA4AUD0AADAgAAACAAAAAAAIABAAGABAAEgAUABYAGAAaABgAGgAYgBqAF8AZwBgAGgAcQB5AHUAfQCFAI0AlQCdAKIAqgCyALoAYABoAGAAaABgAGgAwgDKAGAAaADGAM4A0wDbAOEA6QDxAPkAAQEJAQ8BFwF1AH0AHAEkASwBNAE6AUIBQQFJAVEBWQFhAWgBcAF4ATAAgAGGAY4BlQGXAZ8BpwGvAbUBvQHFAc0B0wHbAeMB6wHxAfkBAQIJAvEBEQIZAiECKQIxAjgCQAJGAk4CVgJeAmQCbAJ0AnwCgQKJApECmQKgAqgCsAK4ArwCxAIwAMwC0wLbAjAA4wLrAvMC+AIAAwcDDwMwABcDHQMlAy0DNQN1AD0DQQNJA0kDSQNRA1EDVwNZA1kDdQB1AGEDdQBpA20DdQN1AHsDdQCBA4kDkQN1AHUAmQOhA3UAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AKYDrgN1AHUAtgO+A8YDzgPWAxcD3gPjA+sD8wN1AHUA+wMDBAkEdQANBBUEHQQlBCoEFwMyBDgEYABABBcDSARQBFgEYARoBDAAcAQzAXgEgASIBJAEdQCXBHUAnwSnBK4EtgS6BMIEyAR1AHUAdQB1AHUAdQCVANAEYABgAGAAYABgAGAAYABgANgEYADcBOQEYADsBPQE/AQEBQwFFAUcBSQFLAU0BWQEPAVEBUsFUwVbBWAAYgVgAGoFcgV6BYIFigWRBWAAmQWfBaYFYABgAGAAYABgAKoFYACxBbAFuQW6BcEFwQXHBcEFwQXPBdMF2wXjBeoF8gX6BQIGCgYSBhoGIgYqBjIGOgZgAD4GRgZMBmAAUwZaBmAAYABgAGAAYABgAGAAYABgAGAAYABgAGIGYABpBnAGYABgAGAAYABgAGAAYABgAGAAYAB4Bn8GhQZgAGAAYAB1AHcDFQSLBmAAYABgAJMGdQA9A3UAmwajBqsGqwaVALMGuwbDBjAAywbSBtIG1QbSBtIG0gbSBtIG0gbdBuMG6wbzBvsGAwcLBxMHAwcbByMHJwcsBywHMQcsB9IGOAdAB0gHTgfSBkgHVgfSBtIG0gbSBtIG0gbSBtIG0gbSBiwHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAdgAGAALAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAdbB2MHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsB2kH0gZwB64EdQB1AHUAdQB1AHUAdQB1AHUHfQdgAIUHjQd1AHUAlQedB2AAYAClB6sHYACzB7YHvgfGB3UAzgfWBzMB3gfmB1EB7gf1B/0HlQENAQUIDQh1ABUIHQglCBcDLQg1CD0IRQhNCEEDUwh1AHUAdQBbCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIcAh3CHoIMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIgggwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAALAcsBywHLAcsBywHLAcsBywHLAcsB4oILAcsB44I0gaWCJ4Ipgh1AHUAqgiyCHUAdQB1AHUAdQB1AHUAdQB1AHUAtwh8AXUAvwh1AMUIyQjRCNkI4AjoCHUAdQB1AO4I9gj+CAYJDgkTCS0HGwkjCYIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiAAIAAAAFAAYABgAGIAXwBgAHEAdQBFAJUAogCyAKAAYABgAEIA4ABGANMA4QDxAMEBDwE1AFwBLAE6AQEBUQF4QkhCmEKoQrhCgAHIQsAB0MLAAcABwAHAAeDC6ABoAHDCwMMAAcABwAHAAdDDGMMAAcAB6MM4wwjDWMNow3jDaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAEjDqABWw6bDqABpg6gAaABoAHcDvwOPA+gAaABfA/8DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DpcPAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcAB9cPKwkyCToJMAB1AHUAdQBCCUoJTQl1AFUJXAljCWcJawkwADAAMAAwAHMJdQB2CX4JdQCECYoJjgmWCXUAngkwAGAAYABxAHUApgn3A64JtAl1ALkJdQDACTAAMAAwADAAdQB1AHUAdQB1AHUAdQB1AHUAowYNBMUIMAAwADAAMADICcsJ0wnZCRUE4QkwAOkJ8An4CTAAMAB1AAAKvwh1AAgKDwoXCh8KdQAwACcKLgp1ADYKqAmICT4KRgowADAAdQB1AE4KMAB1AFYKdQBeCnUAZQowADAAMAAwADAAMAAwADAAMAAVBHUAbQowADAAdQC5CXUKMAAwAHwBxAijBogEMgF9CoQKiASMCpQKmgqIBKIKqgquCogEDQG2Cr4KxgrLCjAAMADTCtsKCgHjCusK8Qr5CgELMAAwADAAMAB1AIsECQsRC3UANAEZCzAAMAAwADAAMAB1ACELKQswAHUANAExCzkLdQBBC0kLMABRC1kLMAAwADAAMAAwADAAdQBhCzAAMAAwAGAAYABpC3ELdwt/CzAAMACHC4sLkwubC58Lpwt1AK4Ltgt1APsDMAAwADAAMAAwADAAMAAwAL4LwwvLC9IL1wvdCzAAMADlC+kL8Qv5C/8LSQswADAAMAAwADAAMAAwADAAMAAHDDAAMAAwADAAMAAODBYMHgx1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1ACYMMAAwADAAdQB1AHUALgx1AHUAdQB1AHUAdQA2DDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AD4MdQBGDHUAdQB1AHUAdQB1AEkMdQB1AHUAdQB1AFAMMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQBYDHUAdQB1AF8MMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUA+wMVBGcMMAAwAHwBbwx1AHcMfwyHDI8MMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAYABgAJcMMAAwADAAdQB1AJ8MlQClDDAAMACtDCwHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsB7UMLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AA0EMAC9DDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAsBywHLAcsBywHLAcsBywHLQcwAMEMyAwsBywHLAcsBywHLAcsBywHLAcsBywHzAwwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1ANQM2QzhDDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMABgAGAAYABgAGAAYABgAOkMYADxDGAA+AwADQYNYABhCWAAYAAODTAAMAAwADAAFg1gAGAAHg37AzAAMAAwADAAYABgACYNYAAsDTQNPA1gAEMNPg1LDWAAYABgAGAAYABgAGAAYABgAGAAUg1aDYsGVglhDV0NcQBnDW0NdQ15DWAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAlQCBDZUAiA2PDZcNMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAnw2nDTAAMAAwADAAMAAwAHUArw23DTAAMAAwADAAMAAwADAAMAAwADAAMAB1AL8NMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAB1AHUAdQB1AHUAdQDHDTAAYABgAM8NMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAA1w11ANwNMAAwAD0B5A0wADAAMAAwADAAMADsDfQN/A0EDgwOFA4wABsOMAAwADAAMAAwADAAMAAwANIG0gbSBtIG0gbSBtIG0gYjDigOwQUuDsEFMw7SBjoO0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGQg5KDlIOVg7SBtIGXg5lDm0OdQ7SBtIGfQ6EDooOjQ6UDtIGmg6hDtIG0gaoDqwO0ga0DrwO0gZgAGAAYADEDmAAYAAkBtIGzA5gANIOYADaDokO0gbSBt8O5w7SBu8O0gb1DvwO0gZgAGAAxA7SBtIG0gbSBtIGYABgAGAAYAAED2AAsAUMD9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGFA8sBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAccD9IGLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHJA8sBywHLAcsBywHLAccDywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywPLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAc0D9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAccD9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGFA8sBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHPA/SBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gYUD0QPlQCVAJUAMAAwADAAMACVAJUAlQCVAJUAlQCVAEwPMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAA//8EAAQABAAEAAQABAAEAAQABAANAAMAAQABAAIABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQACgATABcAHgAbABoAHgAXABYAEgAeABsAGAAPABgAHABLAEsASwBLAEsASwBLAEsASwBLABgAGAAeAB4AHgATAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQABYAGwASAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAWAA0AEQAeAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAFAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAJABYAGgAbABsAGwAeAB0AHQAeAE8AFwAeAA0AHgAeABoAGwBPAE8ADgBQAB0AHQAdAE8ATwAXAE8ATwBPABYAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAFAAUABQAFAAUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAB4AHgAeAFAATwBAAE8ATwBPAEAATwBQAFAATwBQAB4AHgAeAB4AHgAeAB0AHQAdAB0AHgAdAB4ADgBQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgBQAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAJAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAkACQAJAAkACQAJAAkABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAFAAHgAeAB4AKwArAFAAUABQAFAAGABQACsAKwArACsAHgAeAFAAHgBQAFAAUAArAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAUAAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAYAA0AKwArAB4AHgAbACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQADQAEAB4ABAAEAB4ABAAEABMABAArACsAKwArACsAKwArACsAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAKwArACsAKwBWAFYAVgBWAB4AHgArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AGgAaABoAGAAYAB4AHgAEAAQABAAEAAQABAAEAAQABAAEAAQAEwAEACsAEwATAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABLAEsASwBLAEsASwBLAEsASwBLABoAGQAZAB4AUABQAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQABMAUAAEAAQABAAEAAQABAAEAB4AHgAEAAQABAAEAAQABABQAFAABAAEAB4ABAAEAAQABABQAFAASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUAAeAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAFAABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQAUABQAB4AHgAYABMAUAArACsABAAbABsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAFAABAAEAAQABAAEAFAABAAEAAQAUAAEAAQABAAEAAQAKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAArACsAHgArAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAUAAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAABAAEAA0ADQBLAEsASwBLAEsASwBLAEsASwBLAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUAArACsAKwBQAFAAUABQACsAKwAEAFAABAAEAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABABQACsAKwArACsAKwArACsAKwAEACsAKwArACsAUABQACsAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAFAAUAAaABoAUABQAFAAUABQAEwAHgAbAFAAHgAEACsAKwAEAAQABAArAFAAUABQAFAAUABQACsAKwArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQACsAUABQACsAKwAEACsABAAEAAQABAAEACsAKwArACsABAAEACsAKwAEAAQABAArACsAKwAEACsAKwArACsAKwArACsAUABQAFAAUAArAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLAAQABABQAFAAUAAEAB4AKwArACsAKwArACsAKwArACsAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQACsAKwAEAFAABAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAArACsAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAB4AGwArACsAKwArACsAKwArAFAABAAEAAQABAAEAAQAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABAArACsAKwArACsAKwArAAQABAAEACsAKwArACsAUABQACsAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAB4AUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAAQAUAArAFAAUABQAFAAUABQACsAKwArAFAAUABQACsAUABQAFAAUAArACsAKwBQAFAAKwBQACsAUABQACsAKwArAFAAUAArACsAKwBQAFAAUAArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArAAQABAAEAAQABAArACsAKwAEAAQABAArAAQABAAEAAQAKwArAFAAKwArACsAKwArACsABAArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAHgAeAB4AHgAeAB4AGwAeACsAKwArACsAKwAEAAQABAAEAAQAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAUAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAAEACsAKwArACsAKwArACsABAAEACsAUABQAFAAKwArACsAKwArAFAAUAAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAKwAOAFAAUABQAFAAUABQAFAAHgBQAAQABAAEAA4AUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAKwArAAQAUAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAAEACsAKwArACsAKwArACsABAAEACsAKwArACsAKwArACsAUAArAFAAUAAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwBQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAFAABAAEAAQABAAEAAQABAArAAQABAAEACsABAAEAAQABABQAB4AKwArACsAKwBQAFAAUAAEAFAAUABQAFAAUABQAFAAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAFAAUABQAFAAUABQAFAAUABQABoAUABQAFAAUABQAFAAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQACsAUAArACsAUABQAFAAUABQAFAAUAArACsAKwAEACsAKwArACsABAAEAAQABAAEAAQAKwAEACsABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArAAQABAAeACsAKwArACsAKwArACsAKwArACsAKwArAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAAqAFwAXAAqACoAKgAqACoAKgAqACsAKwArACsAGwBcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAeAEsASwBLAEsASwBLAEsASwBLAEsADQANACsAKwArACsAKwBcAFwAKwBcACsAXABcAFwAXABcACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACsAXAArAFwAXABcAFwAXABcAFwAXABcAFwAKgBcAFwAKgAqACoAKgAqACoAKgAqACoAXAArACsAXABcAFwAXABcACsAXAArACoAKgAqACoAKgAqACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwBcAFwAXABcAFAADgAOAA4ADgAeAA4ADgAJAA4ADgANAAkAEwATABMAEwATAAkAHgATAB4AHgAeAAQABAAeAB4AHgAeAB4AHgBLAEsASwBLAEsASwBLAEsASwBLAFAAUABQAFAAUABQAFAAUABQAFAADQAEAB4ABAAeAAQAFgARABYAEQAEAAQAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQADQAEAAQABAAEAAQADQAEAAQAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArAA0ADQAeAB4AHgAeAB4AHgAEAB4AHgAeAB4AHgAeACsAHgAeAA4ADgANAA4AHgAeAB4AHgAeAAkACQArACsAKwArACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgBcAEsASwBLAEsASwBLAEsASwBLAEsADQANAB4AHgAeAB4AXABcAFwAXABcAFwAKgAqACoAKgBcAFwAXABcACoAKgAqAFwAKgAqACoAXABcACoAKgAqACoAKgAqACoAXABcAFwAKgAqACoAKgBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKgAqAFwAKgBLAEsASwBLAEsASwBLAEsASwBLACoAKgAqACoAKgAqAFAAUABQAFAAUABQACsAUAArACsAKwArACsAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgBQAFAAUABQAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUAArACsAUABQAFAAUABQAFAAUAArAFAAKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAKwBQACsAUABQAFAAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsABAAEAAQAHgANAB4AHgAeAB4AHgAeAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUAArACsADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAANAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAWABEAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAA0ADQANAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAANAA0AKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUAArAAQABAArACsAKwArACsAKwArACsAKwArACsAKwBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqAA0ADQAVAFwADQAeAA0AGwBcACoAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwAeAB4AEwATAA0ADQAOAB4AEwATAB4ABAAEAAQACQArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUAAEAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAHgArACsAKwATABMASwBLAEsASwBLAEsASwBLAEsASwBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAArACsAXABcAFwAXABcACsAKwArACsAKwArACsAKwArACsAKwBcAFwAXABcAFwAXABcAFwAXABcAFwAXAArACsAKwArAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAXAArACsAKwAqACoAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAArACsAHgAeAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKwAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKwArAAQASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArACoAKgAqACoAKgAqACoAXAAqACoAKgAqACoAKgArACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABABQAFAAUABQAFAAUABQACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwANAA0AHgANAA0ADQANAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAEAAQAHgAeAB4AHgAeAB4AHgAeAB4AKwArACsABAAEAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwAeAB4AHgAeAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArAA0ADQANAA0ADQBLAEsASwBLAEsASwBLAEsASwBLACsAKwArAFAAUABQAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAA0ADQBQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUAAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArAAQABAAEAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAAQAUABQAFAAUABQAFAABABQAFAABAAEAAQAUAArACsAKwArACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsABAAEAAQABAAEAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAKwBQACsAUAArAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgBQAB4AHgAeAFAAUABQACsAHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQACsAKwAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQACsAHgAeAB4AHgAeAB4AHgAOAB4AKwANAA0ADQANAA0ADQANAAkADQANAA0ACAAEAAsABAAEAA0ACQANAA0ADAAdAB0AHgAXABcAFgAXABcAFwAWABcAHQAdAB4AHgAUABQAFAANAAEAAQAEAAQABAAEAAQACQAaABoAGgAaABoAGgAaABoAHgAXABcAHQAVABUAHgAeAB4AHgAeAB4AGAAWABEAFQAVABUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ADQAeAA0ADQANAA0AHgANAA0ADQAHAB4AHgAeAB4AKwAEAAQABAAEAAQABAAEAAQABAAEAFAAUAArACsATwBQAFAAUABQAFAAHgAeAB4AFgARAE8AUABPAE8ATwBPAFAAUABQAFAAUAAeAB4AHgAWABEAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArABsAGwAbABsAGwAbABsAGgAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGgAbABsAGwAbABoAGwAbABoAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAHgAeAFAAGgAeAB0AHgBQAB4AGgAeAB4AHgAeAB4AHgAeAB4AHgBPAB4AUAAbAB4AHgBQAFAAUABQAFAAHgAeAB4AHQAdAB4AUAAeAFAAHgBQAB4AUABPAFAAUAAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAHgBQAFAAUABQAE8ATwBQAFAAUABQAFAATwBQAFAATwBQAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAFAAUABQAFAATwBPAE8ATwBPAE8ATwBPAE8ATwBQAFAAUABQAFAAUABQAFAAUAAeAB4AUABQAFAAUABPAB4AHgArACsAKwArAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB4AHQAdAB4AHgAeAB0AHQAeAB4AHQAeAB4AHgAdAB4AHQAbABsAHgAdAB4AHgAeAB4AHQAeAB4AHQAdAB0AHQAeAB4AHQAeAB0AHgAdAB0AHQAdAB0AHQAeAB0AHgAeAB4AHgAeAB0AHQAdAB0AHgAeAB4AHgAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB4AHgAeAB0AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHgAeAB0AHQAdAB0AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAeAB4AHgAdAB4AHgAeAB4AHgAeAB4AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABYAEQAWABEAHgAeAB4AHgAeAB4AHQAeAB4AHgAeAB4AHgAeACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAWABEAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAFAAHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAeAB4AHQAdAB0AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHQAdAB4AHgAeAB4AHQAdAB0AHgAeAB0AHgAeAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlAB4AHQAdAB4AHgAdAB4AHgAeAB4AHQAdAB4AHgAeAB4AJQAlAB0AHQAlAB4AJQAlACUAIAAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAeAB4AHgAeAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHgAdAB0AHQAeAB0AJQAdAB0AHgAdAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAdAB0AHQAdACUAHgAlACUAJQAdACUAJQAdAB0AHQAlACUAHQAdACUAHQAdACUAJQAlAB4AHQAeAB4AHgAeAB0AHQAlAB0AHQAdAB0AHQAdACUAJQAlACUAJQAdACUAJQAgACUAHQAdACUAJQAlACUAJQAlACUAJQAeAB4AHgAlACUAIAAgACAAIAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AFwAXABcAFwAXABcAHgATABMAJQAeAB4AHgAWABEAFgARABYAEQAWABEAFgARABYAEQAWABEATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABYAEQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAWABEAFgARABYAEQAWABEAFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFgARABYAEQAWABEAFgARABYAEQAWABEAFgARABYAEQAWABEAFgARABYAEQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAWABEAFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAEAAQABAAeAB4AKwArACsAKwArABMADQANAA0AUAATAA0AUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAUAANACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAA0ADQANAA0ADQANAA0ADQAeAA0AFgANAB4AHgAXABcAHgAeABcAFwAWABEAFgARABYAEQAWABEADQANAA0ADQATAFAADQANAB4ADQANAB4AHgAeAB4AHgAMAAwADQANAA0AHgANAA0AFgANAA0ADQANAA0ADQANAA0AHgANAB4ADQANAB4AHgAeACsAKwArACsAKwArACsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwArACsAKwArACsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArAA0AEQARACUAJQBHAFcAVwAWABEAFgARABYAEQAWABEAFgARACUAJQAWABEAFgARABYAEQAWABEAFQAWABEAEQAlAFcAVwBXAFcAVwBXAFcAVwBXAAQABAAEAAQABAAEACUAVwBXAFcAVwA2ACUAJQBXAFcAVwBHAEcAJQAlACUAKwBRAFcAUQBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFEAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBRAFcAUQBXAFEAVwBXAFcAVwBXAFcAUQBXAFcAVwBXAFcAVwBRAFEAKwArAAQABAAVABUARwBHAFcAFQBRAFcAUQBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBRAFcAVwBXAFcAVwBXAFEAUQBXAFcAVwBXABUAUQBHAEcAVwArACsAKwArACsAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwAlACUAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACsAKwArACsAKwArACsAKwArACsAKwArAFEAUQBRAFEAUQBRAFEAUQBRAFEAUQBRAFEAUQBRAFEAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBPAE8ATwBPAE8ATwBPAE8AJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQAlAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAEcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAADQATAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABLAEsASwBLAEsASwBLAEsASwBLAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAABAAEAAQABAAeAAQABAAEAAQABAAEAAQABAAEAAQAHgBQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUABQAAQABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAeAA0ADQANAA0ADQArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAB4AHgAeAB4AHgAeAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAHgAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAeAB4AUABQAFAAUABQAFAAUABQAFAAUABQAAQAUABQAFAABABQAFAAUABQAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAeAB4AHgAeAAQAKwArACsAUABQAFAAUABQAFAAHgAeABoAHgArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAADgAOABMAEwArACsAKwArACsAKwArACsABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwANAA0ASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAFAAUAAeAB4AHgBQAA4AUABQAAQAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAA0ADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArAB4AWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYACsAKwArAAQAHgAeAB4AHgAeAB4ADQANAA0AHgAeAB4AHgArAFAASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArAB4AHgBcAFwAXABcAFwAKgBcAFwAXABcAFwAXABcAFwAXABcAEsASwBLAEsASwBLAEsASwBLAEsAXABcAFwAXABcACsAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArAFAAUABQAAQAUABQAFAAUABQAFAAUABQAAQABAArACsASwBLAEsASwBLAEsASwBLAEsASwArACsAHgANAA0ADQBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKgAqACoAXAAqACoAKgBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAAqAFwAKgAqACoAXABcACoAKgBcAFwAXABcAFwAKgAqAFwAKgBcACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFwAXABcACoAKgBQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAA0ADQBQAFAAUAAEAAQAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUAArACsAUABQAFAAUABQAFAAKwArAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQADQAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAVABVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBUAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVACsAKwArACsAKwArACsAKwArACsAKwArAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAKwArACsAKwBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAKwArACsAKwAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAKwArACsAKwArAFYABABWAFYAVgBWAFYAVgBWAFYAVgBWAB4AVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgArAFYAVgBWAFYAVgArAFYAKwBWAFYAKwBWAFYAKwBWAFYAVgBWAFYAVgBWAFYAVgBWAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAEQAWAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAaAB4AKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAGAARABEAGAAYABMAEwAWABEAFAArACsAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACUAJQAlACUAJQAWABEAFgARABYAEQAWABEAFgARABYAEQAlACUAFgARACUAJQAlACUAJQAlACUAEQAlABEAKwAVABUAEwATACUAFgARABYAEQAWABEAJQAlACUAJQAlACUAJQAlACsAJQAbABoAJQArACsAKwArAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAcAKwATACUAJQAbABoAJQAlABYAEQAlACUAEQAlABEAJQBXAFcAVwBXAFcAVwBXAFcAVwBXABUAFQAlACUAJQATACUAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXABYAJQARACUAJQAlAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAWACUAEQAlABYAEQARABYAEQARABUAVwBRAFEAUQBRAFEAUQBRAFEAUQBRAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAEcARwArACsAVwBXAFcAVwBXAFcAKwArAFcAVwBXAFcAVwBXACsAKwBXAFcAVwBXAFcAVwArACsAVwBXAFcAKwArACsAGgAbACUAJQAlABsAGwArAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwAEAAQABAAQAB0AKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsADQANAA0AKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAB4AHgAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAAQAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAA0AUABQAFAAUAArACsAKwArAFAAUABQAFAAUABQAFAAUAANAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwAeACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAKwArAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUAArACsAKwBQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwANAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAB4AUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAUABQAFAAUABQAAQABAAEACsABAAEACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAKwBQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEACsAKwArACsABABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAA0ADQANAA0ADQANAA0ADQAeACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAArACsAKwArAFAAUABQAFAAUAANAA0ADQANAA0ADQAUACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsADQANAA0ADQANAA0ADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAAQABAAEAAQAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArAAQABAANACsAKwBQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAB4AHgAeAB4AHgArACsAKwArACsAKwAEAAQABAAEAAQABAAEAA0ADQAeAB4AHgAeAB4AKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgANAA0ADQANACsAKwArACsAKwArACsAKwArACsAKwAeACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsASwBLAEsASwBLAEsASwBLAEsASwANAA0ADQANAFAABAAEAFAAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAeAA4AUAArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAADQANAB4ADQAEAAQABAAEAB4ABAAEAEsASwBLAEsASwBLAEsASwBLAEsAUAAOAFAADQANAA0AKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAANAA0AHgANAA0AHgAEACsAUABQAFAAUABQAFAAUAArAFAAKwBQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAA0AKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsABAAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQACsABAAEAFAABAAEAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABAArACsAUAArACsAKwArACsAKwAEACsAKwArACsAKwBQAFAAUABQAFAABAAEACsAKwAEAAQABAAEAAQABAAEACsAKwArAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwArACsABAAEAAQABAAEAAQABABQAFAAUABQAA0ADQANAA0AHgBLAEsASwBLAEsASwBLAEsASwBLAA0ADQArAB4ABABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAFAAUAAeAFAAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAArACsABAAEAAQABAAEAAQABAAEAAQADgANAA0AEwATAB4AHgAeAA0ADQANAA0ADQANAA0ADQANAA0ADQANAA0ADQANAFAAUABQAFAABAAEACsAKwAEAA0ADQAeAFAAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKwArACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBcAFwADQANAA0AKgBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAKwArAFAAKwArAFAAUABQAFAAUABQAFAAUAArAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQAKwAEAAQAKwArAAQABAAEAAQAUAAEAFAABAAEAA0ADQANACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAArACsABAAEAAQABAAEAAQABABQAA4AUAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAFAABAAEAAQABAAOAB4ADQANAA0ADQAOAB4ABAArACsAKwArACsAKwArACsAUAAEAAQABAAEAAQABAAEAAQABAAEAAQAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAA0ADQANAFAADgAOAA4ADQANACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEACsABAAEAAQABAAEAAQABAAEAFAADQANAA0ADQANACsAKwArACsAKwArACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwAOABMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAArACsAKwAEACsABAAEACsABAAEAAQABAAEAAQABABQAAQAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAKwBQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQAKwAEAAQAKwAEAAQABAAEAAQAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAaABoAGgAaAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsADQANAA0ADQANACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAASABIAEgAQwBDAEMAUABQAFAAUABDAFAAUABQAEgAQwBIAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAASABDAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwAJAAkACQAJAAkACQAJABYAEQArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABIAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwANAA0AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEAAQABAANACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAA0ADQANAB4AHgAeAB4AHgAeAFAAUABQAFAADQAeACsAKwArACsAKwArACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAANAA0AHgAeACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwAEAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAARwBHABUARwAJACsAKwArACsAKwArACsAKwArACsAKwAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACsAKwArACsAKwArACsAKwBXAFcAVwBXAFcAVwBXAFcAVwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUQBRAFEAKwArACsAKwArACsAKwArACsAKwArACsAKwBRAFEAUQBRACsAKwArACsAKwArACsAKwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArACsAHgAEAAQADQAEAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArAB4AHgAeAB4AHgAeAB4AKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAAQABAAEAAQABAAeAB4AHgAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAB4AHgAEAAQABAAEAAQABAAEAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQAHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwBQAFAAKwArAFAAKwArAFAAUAArACsAUABQAFAAUAArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAUAArAFAAUABQAFAAUABQAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAHgAeAFAAUABQAFAAUAArAFAAKwArACsAUABQAFAAUABQAFAAUAArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeACsAKwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4ABAAeAB4AHgAeAB4AHgAeAB4AHgAeAAQAHgAeAA0ADQANAA0AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAAQAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArAAQABAAEAAQABAAEAAQAKwAEAAQAKwAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwBQAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArABsAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArAB4AHgAeAB4ABAAEAAQABAAEAAQABABQACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArABYAFgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAGgBQAFAAUAAaAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAKwBQACsAKwBQACsAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwBQACsAUAArACsAKwArACsAKwBQACsAKwArACsAUAArAFAAKwBQACsAUABQAFAAKwBQAFAAKwBQACsAKwBQACsAUAArAFAAKwBQACsAUAArAFAAUAArAFAAKwArAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUAArAFAAUABQAFAAKwBQACsAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAUABQAFAAKwBQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8AJQAlACUAHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB4AHgAeACUAJQAlAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlAB4AHgAlACUAJQAlACUAHgAlACUAJQAlACUAIAAgACAAJQAlACAAJQAlACAAIAAgACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACEAIQAhACEAIQAlACUAIAAgACUAJQAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlACUAIAAlACUAJQAlACAAIAAgACUAIAAgACAAJQAlACUAJQAlACUAJQAgACUAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAlAB4AJQAeACUAJQAlACUAJQAgACUAJQAlACUAHgAlAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAgACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACAAIAAgACUAJQAlACAAIAAgACAAIAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABcAFwAXABUAFQAVAB4AHgAeAB4AJQAlACUAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAgACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAgACUAJQAgACUAJQAlACUAJQAlACUAJQAgACAAIAAgACAAIAAgACAAJQAlACUAJQAlACUAIAAlACUAJQAlACUAJQAlACUAJQAgACAAIAAgACAAIAAgACAAIAAgACUAJQAgACAAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAgACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAlACAAIAAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAgACAAIAAlACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwArAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACUAVwBXACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAA==",pg=50,oM=1,cB=2,uB=3,AM=4,aM=5,mg=7,dB=8,gg=9,_i=10,ah=11,wg=12,lh=13,lM=14,oA=15,ch=16,Xa=17,Xo=18,cM=19,vg=20,uh=21,$o=22,Ju=23,Lr=24,wn=25,AA=26,aA=27,kr=28,uM=29,tr=30,dM=31,$a=32,Ya=33,dh=34,hh=35,fh=36,ea=37,ph=38,Ql=39,Ml=40,Zu=41,hB=42,hM=43,fM=[9001,65288],fB="!",It="",ja="",mh=nM(rM),ks=[tr,fh],gh=[oM,cB,uB,aM],pB=[_i,dB],Bg=[aA,AA],pM=gh.concat(pB),Cg=[ph,Ql,Ml,dh,hh],mM=[oA,lh],gM=function(n,t){t===void 0&&(t="strict");var e=[],s=[],i=[];return n.forEach(function(r,o){var A=mh.get(r);if(A>pg?(i.push(!0),A-=pg):i.push(!1),["normal","auto","loose"].indexOf(t)!==-1&&[8208,8211,12316,12448].indexOf(r)!==-1)return s.push(o),e.push(ch);if(A===AM||A===ah){if(o===0)return s.push(o),e.push(tr);var a=e[o-1];return pM.indexOf(a)===-1?(s.push(s[o-1]),e.push(a)):(s.push(o),e.push(tr))}if(s.push(o),A===dM)return e.push(t==="strict"?uh:ea);if(A===hB||A===uM)return e.push(tr);if(A===hM)return r>=131072&&r<=196605||r>=196608&&r<=262141?e.push(ea):e.push(tr);e.push(A)}),[s,e,i]},td=function(n,t,e,s){var i=s[e];if(Array.isArray(n)?n.indexOf(i)!==-1:n===i)for(var r=e;r<=s.length;){r++;var o=s[r];if(o===t)return!0;if(o!==_i)break}if(i===_i)for(var r=e;r>0;){r--;var A=s[r];if(Array.isArray(n)?n.indexOf(A)!==-1:n===A)for(var a=e;a<=s.length;){a++;var o=s[a];if(o===t)return!0;if(o!==_i)break}if(A!==_i)break}return!1},bg=function(n,t){for(var e=n;e>=0;){var s=t[e];if(s===_i)e--;else return s}return 0},wM=function(n,t,e,s,i){if(e[s]===0)return It;var r=s-1;if(Array.isArray(i)&&i[r]===!0)return It;var o=r-1,A=r+1,a=t[r],l=o>=0?t[o]:0,c=t[A];if(a===cB&&c===uB)return It;if(gh.indexOf(a)!==-1)return fB;if(gh.indexOf(c)!==-1||pB.indexOf(c)!==-1)return It;if(bg(r,t)===dB)return ja;if(mh.get(n[r])===ah||(a===$a||a===Ya)&&mh.get(n[A])===ah||a===mg||c===mg||a===gg||[_i,lh,oA].indexOf(a)===-1&&c===gg||[Xa,Xo,cM,Lr,kr].indexOf(c)!==-1||bg(r,t)===$o||td(Ju,$o,r,t)||td([Xa,Xo],uh,r,t)||td(wg,wg,r,t))return It;if(a===_i)return ja;if(a===Ju||c===Ju)return It;if(c===ch||a===ch)return ja;if([lh,oA,uh].indexOf(c)!==-1||a===lM||l===fh&&mM.indexOf(a)!==-1||a===kr&&c===fh||c===vg||ks.indexOf(c)!==-1&&a===wn||ks.indexOf(a)!==-1&&c===wn||a===aA&&[ea,$a,Ya].indexOf(c)!==-1||[ea,$a,Ya].indexOf(a)!==-1&&c===AA||ks.indexOf(a)!==-1&&Bg.indexOf(c)!==-1||Bg.indexOf(a)!==-1&&ks.indexOf(c)!==-1||[aA,AA].indexOf(a)!==-1&&(c===wn||[$o,oA].indexOf(c)!==-1&&t[A+1]===wn)||[$o,oA].indexOf(a)!==-1&&c===wn||a===wn&&[wn,kr,Lr].indexOf(c)!==-1)return It;if([wn,kr,Lr,Xa,Xo].indexOf(c)!==-1)for(var u=r;u>=0;){var d=t[u];if(d===wn)return It;if([kr,Lr].indexOf(d)!==-1)u--;else break}if([aA,AA].indexOf(c)!==-1)for(var u=[Xa,Xo].indexOf(a)!==-1?o:r;u>=0;){var d=t[u];if(d===wn)return It;if([kr,Lr].indexOf(d)!==-1)u--;else break}if(ph===a&&[ph,Ql,dh,hh].indexOf(c)!==-1||[Ql,dh].indexOf(a)!==-1&&[Ql,Ml].indexOf(c)!==-1||[Ml,hh].indexOf(a)!==-1&&c===Ml||Cg.indexOf(a)!==-1&&[vg,AA].indexOf(c)!==-1||Cg.indexOf(c)!==-1&&a===aA||ks.indexOf(a)!==-1&&ks.indexOf(c)!==-1||a===Lr&&ks.indexOf(c)!==-1||ks.concat(wn).indexOf(a)!==-1&&c===$o&&fM.indexOf(n[A])===-1||ks.concat(wn).indexOf(c)!==-1&&a===Xo)return It;if(a===Zu&&c===Zu){for(var p=e[r],f=1;p>0&&(p--,t[p]===Zu);)f++;if(f%2!==0)return It}return a===$a&&c===Ya?It:ja},vM=function(n,t){t||(t={lineBreak:"normal",wordBreak:"normal"});var e=gM(n,t.lineBreak),s=e[0],i=e[1],r=e[2];(t.wordBreak==="break-all"||t.wordBreak==="break-word")&&(i=i.map(function(A){return[wn,tr,hB].indexOf(A)!==-1?ea:A}));var o=t.wordBreak==="keep-all"?r.map(function(A,a){return A&&n[a]>=19968&&n[a]<=40959}):void 0;return[s,i,o]},BM=(function(){function n(t,e,s,i){this.codePoints=t,this.required=e===fB,this.start=s,this.end=i}return n.prototype.slice=function(){return ce.apply(void 0,this.codePoints.slice(this.start,this.end))},n})(),CM=function(n,t){var e=hu(n),s=vM(e,t),i=s[0],r=s[1],o=s[2],A=e.length,a=0,l=0;return{next:function(){if(l>=A)return{done:!0,value:null};for(var c=It;l<A&&(c=wM(e,r,i,++l,o))===It;);if(c!==It||l===A){var u=new BM(e,c,a,l);return a=l,{value:u,done:!1}}return{done:!0,value:null}}}},bM=1,yM=2,Ia=4,yg=8,cc=10,Sg=47,EA=92,SM=9,EM=32,Ja=34,Yo=61,xM=35,_M=36,IM=37,Za=39,tl=40,jo=41,FM=95,sn=45,TM=33,QM=60,MM=62,UM=64,PM=91,NM=93,DM=61,LM=123,el=63,kM=125,Eg=124,RM=126,HM=128,xg=65533,ed=42,rr=43,OM=44,VM=58,WM=59,na=46,GM=0,KM=8,qM=11,zM=14,XM=31,$M=127,us=-1,mB=48,gB=97,wB=101,YM=102,jM=117,JM=122,vB=65,BB=69,CB=70,ZM=85,tU=90,Le=function(n){return n>=mB&&n<=57},eU=function(n){return n>=55296&&n<=57343},Rr=function(n){return Le(n)||n>=vB&&n<=CB||n>=gB&&n<=YM},nU=function(n){return n>=gB&&n<=JM},sU=function(n){return n>=vB&&n<=tU},iU=function(n){return nU(n)||sU(n)},rU=function(n){return n>=HM},nl=function(n){return n===cc||n===SM||n===EM},uc=function(n){return iU(n)||rU(n)||n===FM},_g=function(n){return uc(n)||Le(n)||n===sn},oU=function(n){return n>=GM&&n<=KM||n===qM||n>=zM&&n<=XM||n===$M},vi=function(n,t){return n!==EA?!1:t!==cc},sl=function(n,t,e){return n===sn?uc(t)||vi(t,e):uc(n)?!0:!!(n===EA&&vi(n,t))},nd=function(n,t,e){return n===rr||n===sn?Le(t)?!0:t===na&&Le(e):Le(n===na?t:n)},AU=function(n){var t=0,e=1;(n[t]===rr||n[t]===sn)&&(n[t]===sn&&(e=-1),t++);for(var s=[];Le(n[t]);)s.push(n[t++]);var i=s.length?parseInt(ce.apply(void 0,s),10):0;n[t]===na&&t++;for(var r=[];Le(n[t]);)r.push(n[t++]);var o=r.length,A=o?parseInt(ce.apply(void 0,r),10):0;(n[t]===BB||n[t]===wB)&&t++;var a=1;(n[t]===rr||n[t]===sn)&&(n[t]===sn&&(a=-1),t++);for(var l=[];Le(n[t]);)l.push(n[t++]);var c=l.length?parseInt(ce.apply(void 0,l),10):0;return e*(i+A*Math.pow(10,-o))*Math.pow(10,a*c)},aU={type:2},lU={type:3},cU={type:4},uU={type:13},dU={type:8},hU={type:21},fU={type:9},pU={type:10},mU={type:11},gU={type:12},wU={type:14},il={type:23},vU={type:1},BU={type:25},CU={type:24},bU={type:26},yU={type:27},SU={type:28},EU={type:29},xU={type:31},wh={type:32},bB=(function(){function n(){this._value=[]}return n.prototype.write=function(t){this._value=this._value.concat(hu(t))},n.prototype.read=function(){for(var t=[],e=this.consumeToken();e!==wh;)t.push(e),e=this.consumeToken();return t},n.prototype.consumeToken=function(){var t=this.consumeCodePoint();switch(t){case Ja:return this.consumeStringToken(Ja);case xM:var e=this.peekCodePoint(0),s=this.peekCodePoint(1),i=this.peekCodePoint(2);if(_g(e)||vi(s,i)){var r=sl(e,s,i)?yM:bM,o=this.consumeName();return{type:5,value:o,flags:r}}break;case _M:if(this.peekCodePoint(0)===Yo)return this.consumeCodePoint(),uU;break;case Za:return this.consumeStringToken(Za);case tl:return aU;case jo:return lU;case ed:if(this.peekCodePoint(0)===Yo)return this.consumeCodePoint(),wU;break;case rr:if(nd(t,this.peekCodePoint(0),this.peekCodePoint(1)))return this.reconsumeCodePoint(t),this.consumeNumericToken();break;case OM:return cU;case sn:var A=t,a=this.peekCodePoint(0),l=this.peekCodePoint(1);if(nd(A,a,l))return this.reconsumeCodePoint(t),this.consumeNumericToken();if(sl(A,a,l))return this.reconsumeCodePoint(t),this.consumeIdentLikeToken();if(a===sn&&l===MM)return this.consumeCodePoint(),this.consumeCodePoint(),CU;break;case na:if(nd(t,this.peekCodePoint(0),this.peekCodePoint(1)))return this.reconsumeCodePoint(t),this.consumeNumericToken();break;case Sg:if(this.peekCodePoint(0)===ed)for(this.consumeCodePoint();;){var c=this.consumeCodePoint();if(c===ed&&(c=this.consumeCodePoint(),c===Sg))return this.consumeToken();if(c===us)return this.consumeToken()}break;case VM:return bU;case WM:return yU;case QM:if(this.peekCodePoint(0)===TM&&this.peekCodePoint(1)===sn&&this.peekCodePoint(2)===sn)return this.consumeCodePoint(),this.consumeCodePoint(),BU;break;case UM:var u=this.peekCodePoint(0),d=this.peekCodePoint(1),p=this.peekCodePoint(2);if(sl(u,d,p)){var o=this.consumeName();return{type:7,value:o}}break;case PM:return SU;case EA:if(vi(t,this.peekCodePoint(0)))return this.reconsumeCodePoint(t),this.consumeIdentLikeToken();break;case NM:return EU;case DM:if(this.peekCodePoint(0)===Yo)return this.consumeCodePoint(),dU;break;case LM:return mU;case kM:return gU;case jM:case ZM:var f=this.peekCodePoint(0),m=this.peekCodePoint(1);return f===rr&&(Rr(m)||m===el)&&(this.consumeCodePoint(),this.consumeUnicodeRangeToken()),this.reconsumeCodePoint(t),this.consumeIdentLikeToken();case Eg:if(this.peekCodePoint(0)===Yo)return this.consumeCodePoint(),fU;if(this.peekCodePoint(0)===Eg)return this.consumeCodePoint(),hU;break;case RM:if(this.peekCodePoint(0)===Yo)return this.consumeCodePoint(),pU;break;case us:return wh}return nl(t)?(this.consumeWhiteSpace(),xU):Le(t)?(this.reconsumeCodePoint(t),this.consumeNumericToken()):uc(t)?(this.reconsumeCodePoint(t),this.consumeIdentLikeToken()):{type:6,value:ce(t)}},n.prototype.consumeCodePoint=function(){var t=this._value.shift();return typeof t>"u"?-1:t},n.prototype.reconsumeCodePoint=function(t){this._value.unshift(t)},n.prototype.peekCodePoint=function(t){return t>=this._value.length?-1:this._value[t]},n.prototype.consumeUnicodeRangeToken=function(){for(var t=[],e=this.consumeCodePoint();Rr(e)&&t.length<6;)t.push(e),e=this.consumeCodePoint();for(var s=!1;e===el&&t.length<6;)t.push(e),e=this.consumeCodePoint(),s=!0;if(s){var i=parseInt(ce.apply(void 0,t.map(function(a){return a===el?mB:a})),16),r=parseInt(ce.apply(void 0,t.map(function(a){return a===el?CB:a})),16);return{type:30,start:i,end:r}}var o=parseInt(ce.apply(void 0,t),16);if(this.peekCodePoint(0)===sn&&Rr(this.peekCodePoint(1))){this.consumeCodePoint(),e=this.consumeCodePoint();for(var A=[];Rr(e)&&A.length<6;)A.push(e),e=this.consumeCodePoint();var r=parseInt(ce.apply(void 0,A),16);return{type:30,start:o,end:r}}else return{type:30,start:o,end:o}},n.prototype.consumeIdentLikeToken=function(){var t=this.consumeName();return t.toLowerCase()==="url"&&this.peekCodePoint(0)===tl?(this.consumeCodePoint(),this.consumeUrlToken()):this.peekCodePoint(0)===tl?(this.consumeCodePoint(),{type:19,value:t}):{type:20,value:t}},n.prototype.consumeUrlToken=function(){var t=[];if(this.consumeWhiteSpace(),this.peekCodePoint(0)===us)return{type:22,value:""};var e=this.peekCodePoint(0);if(e===Za||e===Ja){var s=this.consumeStringToken(this.consumeCodePoint());return s.type===0&&(this.consumeWhiteSpace(),this.peekCodePoint(0)===us||this.peekCodePoint(0)===jo)?(this.consumeCodePoint(),{type:22,value:s.value}):(this.consumeBadUrlRemnants(),il)}for(;;){var i=this.consumeCodePoint();if(i===us||i===jo)return{type:22,value:ce.apply(void 0,t)};if(nl(i))return this.consumeWhiteSpace(),this.peekCodePoint(0)===us||this.peekCodePoint(0)===jo?(this.consumeCodePoint(),{type:22,value:ce.apply(void 0,t)}):(this.consumeBadUrlRemnants(),il);if(i===Ja||i===Za||i===tl||oU(i))return this.consumeBadUrlRemnants(),il;if(i===EA)if(vi(i,this.peekCodePoint(0)))t.push(this.consumeEscapedCodePoint());else return this.consumeBadUrlRemnants(),il;else t.push(i)}},n.prototype.consumeWhiteSpace=function(){for(;nl(this.peekCodePoint(0));)this.consumeCodePoint()},n.prototype.consumeBadUrlRemnants=function(){for(;;){var t=this.consumeCodePoint();if(t===jo||t===us)return;vi(t,this.peekCodePoint(0))&&this.consumeEscapedCodePoint()}},n.prototype.consumeStringSlice=function(t){for(var e=5e4,s="";t>0;){var i=Math.min(e,t);s+=ce.apply(void 0,this._value.splice(0,i)),t-=i}return this._value.shift(),s},n.prototype.consumeStringToken=function(t){var e="",s=0;do{var i=this._value[s];if(i===us||i===void 0||i===t)return e+=this.consumeStringSlice(s),{type:0,value:e};if(i===cc)return this._value.splice(0,s),vU;if(i===EA){var r=this._value[s+1];r!==us&&r!==void 0&&(r===cc?(e+=this.consumeStringSlice(s),s=-1,this._value.shift()):vi(i,r)&&(e+=this.consumeStringSlice(s),e+=ce(this.consumeEscapedCodePoint()),s=-1))}s++}while(!0)},n.prototype.consumeNumber=function(){var t=[],e=Ia,s=this.peekCodePoint(0);for((s===rr||s===sn)&&t.push(this.consumeCodePoint());Le(this.peekCodePoint(0));)t.push(this.consumeCodePoint());s=this.peekCodePoint(0);var i=this.peekCodePoint(1);if(s===na&&Le(i))for(t.push(this.consumeCodePoint(),this.consumeCodePoint()),e=yg;Le(this.peekCodePoint(0));)t.push(this.consumeCodePoint());s=this.peekCodePoint(0),i=this.peekCodePoint(1);var r=this.peekCodePoint(2);if((s===BB||s===wB)&&((i===rr||i===sn)&&Le(r)||Le(i)))for(t.push(this.consumeCodePoint(),this.consumeCodePoint()),e=yg;Le(this.peekCodePoint(0));)t.push(this.consumeCodePoint());return[AU(t),e]},n.prototype.consumeNumericToken=function(){var t=this.consumeNumber(),e=t[0],s=t[1],i=this.peekCodePoint(0),r=this.peekCodePoint(1),o=this.peekCodePoint(2);if(sl(i,r,o)){var A=this.consumeName();return{type:15,number:e,flags:s,unit:A}}return i===IM?(this.consumeCodePoint(),{type:16,number:e,flags:s}):{type:17,number:e,flags:s}},n.prototype.consumeEscapedCodePoint=function(){var t=this.consumeCodePoint();if(Rr(t)){for(var e=ce(t);Rr(this.peekCodePoint(0))&&e.length<6;)e+=ce(this.consumeCodePoint());nl(this.peekCodePoint(0))&&this.consumeCodePoint();var s=parseInt(e,16);return s===0||eU(s)||s>1114111?xg:s}return t===us?xg:t},n.prototype.consumeName=function(){for(var t="";;){var e=this.consumeCodePoint();if(_g(e))t+=ce(e);else if(vi(e,this.peekCodePoint(0)))t+=ce(this.consumeEscapedCodePoint());else return this.reconsumeCodePoint(e),t}},n})(),yB=(function(){function n(t){this._tokens=t}return n.create=function(t){var e=new bB;return e.write(t),new n(e.read())},n.parseValue=function(t){return n.create(t).parseComponentValue()},n.parseValues=function(t){return n.create(t).parseComponentValues()},n.prototype.parseComponentValue=function(){for(var t=this.consumeToken();t.type===31;)t=this.consumeToken();if(t.type===32)throw new SyntaxError("Error parsing CSS component value, unexpected EOF");this.reconsumeToken(t);var e=this.consumeComponentValue();do t=this.consumeToken();while(t.type===31);if(t.type===32)return e;throw new SyntaxError("Error parsing CSS component value, multiple values found when expecting only one")},n.prototype.parseComponentValues=function(){for(var t=[];;){var e=this.consumeComponentValue();if(e.type===32)return t;t.push(e),t.push()}},n.prototype.consumeComponentValue=function(){var t=this.consumeToken();switch(t.type){case 11:case 28:case 2:return this.consumeSimpleBlock(t.type);case 19:return this.consumeFunction(t)}return t},n.prototype.consumeSimpleBlock=function(t){for(var e={type:t,values:[]},s=this.consumeToken();;){if(s.type===32||IU(s,t))return e;this.reconsumeToken(s),e.values.push(this.consumeComponentValue()),s=this.consumeToken()}},n.prototype.consumeFunction=function(t){for(var e={name:t.value,values:[],type:18};;){var s=this.consumeToken();if(s.type===32||s.type===3)return e;this.reconsumeToken(s),e.values.push(this.consumeComponentValue())}},n.prototype.consumeToken=function(){var t=this._tokens.shift();return typeof t>"u"?wh:t},n.prototype.reconsumeToken=function(t){this._tokens.unshift(t)},n})(),Fa=function(n){return n.type===15},Go=function(n){return n.type===17},Vt=function(n){return n.type===20},_U=function(n){return n.type===0},vh=function(n,t){return Vt(n)&&n.value===t},SB=function(n){return n.type!==31},To=function(n){return n.type!==31&&n.type!==4},Ns=function(n){var t=[],e=[];return n.forEach(function(s){if(s.type===4){if(e.length===0)throw new Error("Error parsing function args, zero tokens for arg");t.push(e),e=[];return}s.type!==31&&e.push(s)}),e.length&&t.push(e),t},IU=function(n,t){return t===11&&n.type===12||t===28&&n.type===29?!0:t===2&&n.type===3},Wi=function(n){return n.type===17||n.type===15},ge=function(n){return n.type===16||Wi(n)},EB=function(n){return n.length>1?[n[0],n[1]]:[n[0]]},Te={type:17,number:0,flags:Ia},hp={type:16,number:50,flags:Ia},Ii={type:16,number:100,flags:Ia},lA=function(n,t,e){var s=n[0],i=n[1];return[zt(s,t),zt(typeof i<"u"?i:s,e)]},zt=function(n,t){if(n.type===16)return n.number/100*t;if(Fa(n))switch(n.unit){case"rem":case"em":return 16*n.number;case"px":default:return n.number}return n.number},xB="deg",_B="grad",IB="rad",FB="turn",fu={name:"angle",parse:function(n,t){if(t.type===15)switch(t.unit){case xB:return Math.PI*t.number/180;case _B:return Math.PI/200*t.number;case IB:return t.number;case FB:return Math.PI*2*t.number}throw new Error("Unsupported angle type")}},TB=function(n){return n.type===15&&(n.unit===xB||n.unit===_B||n.unit===IB||n.unit===FB)},QB=function(n){var t=n.filter(Vt).map(function(e){return e.value}).join(" ");switch(t){case"to bottom right":case"to right bottom":case"left top":case"top left":return[Te,Te];case"to top":case"bottom":return Ln(0);case"to bottom left":case"to left bottom":case"right top":case"top right":return[Te,Ii];case"to right":case"left":return Ln(90);case"to top left":case"to left top":case"right bottom":case"bottom right":return[Ii,Ii];case"to bottom":case"top":return Ln(180);case"to top right":case"to right top":case"left bottom":case"bottom left":return[Ii,Te];case"to left":case"right":return Ln(270)}return 0},Ln=function(n){return Math.PI*n/180},Pi={name:"color",parse:function(n,t){if(t.type===18){var e=FU[t.name];if(typeof e>"u")throw new Error('Attempting to parse an unsupported color function "'+t.name+'"');return e(n,t.values)}if(t.type===5){if(t.value.length===3){var s=t.value.substring(0,1),i=t.value.substring(1,2),r=t.value.substring(2,3);return Fi(parseInt(s+s,16),parseInt(i+i,16),parseInt(r+r,16),1)}if(t.value.length===4){var s=t.value.substring(0,1),i=t.value.substring(1,2),r=t.value.substring(2,3),o=t.value.substring(3,4);return Fi(parseInt(s+s,16),parseInt(i+i,16),parseInt(r+r,16),parseInt(o+o,16)/255)}if(t.value.length===6){var s=t.value.substring(0,2),i=t.value.substring(2,4),r=t.value.substring(4,6);return Fi(parseInt(s,16),parseInt(i,16),parseInt(r,16),1)}if(t.value.length===8){var s=t.value.substring(0,2),i=t.value.substring(2,4),r=t.value.substring(4,6),o=t.value.substring(6,8);return Fi(parseInt(s,16),parseInt(i,16),parseInt(r,16),parseInt(o,16)/255)}}if(t.type===20){var A=ti[t.value.toUpperCase()];if(typeof A<"u")return A}return ti.TRANSPARENT}},Ni=function(n){return(255&n)===0},Se=function(n){var t=255&n,e=255&n>>8,s=255&n>>16,i=255&n>>24;return t<255?"rgba("+i+","+s+","+e+","+t/255+")":"rgb("+i+","+s+","+e+")"},Fi=function(n,t,e,s){return(n<<24|t<<16|e<<8|Math.round(s*255)<<0)>>>0},Ig=function(n,t){if(n.type===17)return n.number;if(n.type===16){var e=t===3?1:255;return t===3?n.number/100*e:Math.round(n.number/100*e)}return 0},Fg=function(n,t){var e=t.filter(To);if(e.length===3){var s=e.map(Ig),i=s[0],r=s[1],o=s[2];return Fi(i,r,o,1)}if(e.length===4){var A=e.map(Ig),i=A[0],r=A[1],o=A[2],a=A[3];return Fi(i,r,o,a)}return 0};function sd(n,t,e){return e<0&&(e+=1),e>=1&&(e-=1),e<1/6?(t-n)*e*6+n:e<1/2?t:e<2/3?(t-n)*6*(2/3-e)+n:n}var Tg=function(n,t){var e=t.filter(To),s=e[0],i=e[1],r=e[2],o=e[3],A=(s.type===17?Ln(s.number):fu.parse(n,s))/(Math.PI*2),a=ge(i)?i.number/100:0,l=ge(r)?r.number/100:0,c=typeof o<"u"&&ge(o)?zt(o,1):1;if(a===0)return Fi(l*255,l*255,l*255,1);var u=l<=.5?l*(a+1):l+a-l*a,d=l*2-u,p=sd(d,u,A+1/3),f=sd(d,u,A),m=sd(d,u,A-1/3);return Fi(p*255,f*255,m*255,c)},FU={hsl:Tg,hsla:Tg,rgb:Fg,rgba:Fg},xA=function(n,t){return Pi.parse(n,yB.create(t).parseComponentValue())},ti={ALICEBLUE:4042850303,ANTIQUEWHITE:4209760255,AQUA:16777215,AQUAMARINE:2147472639,AZURE:4043309055,BEIGE:4126530815,BISQUE:4293182719,BLACK:255,BLANCHEDALMOND:4293643775,BLUE:65535,BLUEVIOLET:2318131967,BROWN:2771004159,BURLYWOOD:3736635391,CADETBLUE:1604231423,CHARTREUSE:2147418367,CHOCOLATE:3530104575,CORAL:4286533887,CORNFLOWERBLUE:1687547391,CORNSILK:4294499583,CRIMSON:3692313855,CYAN:16777215,DARKBLUE:35839,DARKCYAN:9145343,DARKGOLDENROD:3095837695,DARKGRAY:2846468607,DARKGREEN:6553855,DARKGREY:2846468607,DARKKHAKI:3182914559,DARKMAGENTA:2332068863,DARKOLIVEGREEN:1433087999,DARKORANGE:4287365375,DARKORCHID:2570243327,DARKRED:2332033279,DARKSALMON:3918953215,DARKSEAGREEN:2411499519,DARKSLATEBLUE:1211993087,DARKSLATEGRAY:793726975,DARKSLATEGREY:793726975,DARKTURQUOISE:13554175,DARKVIOLET:2483082239,DEEPPINK:4279538687,DEEPSKYBLUE:12582911,DIMGRAY:1768516095,DIMGREY:1768516095,DODGERBLUE:512819199,FIREBRICK:2988581631,FLORALWHITE:4294635775,FORESTGREEN:579543807,FUCHSIA:4278255615,GAINSBORO:3705462015,GHOSTWHITE:4177068031,GOLD:4292280575,GOLDENROD:3668254975,GRAY:2155905279,GREEN:8388863,GREENYELLOW:2919182335,GREY:2155905279,HONEYDEW:4043305215,HOTPINK:4285117695,INDIANRED:3445382399,INDIGO:1258324735,IVORY:4294963455,KHAKI:4041641215,LAVENDER:3873897215,LAVENDERBLUSH:4293981695,LAWNGREEN:2096890111,LEMONCHIFFON:4294626815,LIGHTBLUE:2916673279,LIGHTCORAL:4034953471,LIGHTCYAN:3774873599,LIGHTGOLDENRODYELLOW:4210742015,LIGHTGRAY:3553874943,LIGHTGREEN:2431553791,LIGHTGREY:3553874943,LIGHTPINK:4290167295,LIGHTSALMON:4288707327,LIGHTSEAGREEN:548580095,LIGHTSKYBLUE:2278488831,LIGHTSLATEGRAY:2005441023,LIGHTSLATEGREY:2005441023,LIGHTSTEELBLUE:2965692159,LIGHTYELLOW:4294959359,LIME:16711935,LIMEGREEN:852308735,LINEN:4210091775,MAGENTA:4278255615,MAROON:2147483903,MEDIUMAQUAMARINE:1724754687,MEDIUMBLUE:52735,MEDIUMORCHID:3126187007,MEDIUMPURPLE:2473647103,MEDIUMSEAGREEN:1018393087,MEDIUMSLATEBLUE:2070474495,MEDIUMSPRINGGREEN:16423679,MEDIUMTURQUOISE:1221709055,MEDIUMVIOLETRED:3340076543,MIDNIGHTBLUE:421097727,MINTCREAM:4127193855,MISTYROSE:4293190143,MOCCASIN:4293178879,NAVAJOWHITE:4292783615,NAVY:33023,OLDLACE:4260751103,OLIVE:2155872511,OLIVEDRAB:1804477439,ORANGE:4289003775,ORANGERED:4282712319,ORCHID:3664828159,PALEGOLDENROD:4008225535,PALEGREEN:2566625535,PALETURQUOISE:2951671551,PALEVIOLETRED:3681588223,PAPAYAWHIP:4293907967,PEACHPUFF:4292524543,PERU:3448061951,PINK:4290825215,PLUM:3718307327,POWDERBLUE:2967529215,PURPLE:2147516671,REBECCAPURPLE:1714657791,RED:4278190335,ROSYBROWN:3163525119,ROYALBLUE:1097458175,SADDLEBROWN:2336560127,SALMON:4202722047,SANDYBROWN:4104413439,SEAGREEN:780883967,SEASHELL:4294307583,SIENNA:2689740287,SILVER:3233857791,SKYBLUE:2278484991,SLATEBLUE:1784335871,SLATEGRAY:1887473919,SLATEGREY:1887473919,SNOW:4294638335,SPRINGGREEN:16744447,STEELBLUE:1182971135,TAN:3535047935,TEAL:8421631,THISTLE:3636451583,TOMATO:4284696575,TRANSPARENT:0,TURQUOISE:1088475391,VIOLET:4001558271,WHEAT:4125012991,WHITE:4294967295,WHITESMOKE:4126537215,YELLOW:4294902015,YELLOWGREEN:2597139199},TU={name:"background-clip",initialValue:"border-box",prefix:!1,type:1,parse:function(n,t){return t.map(function(e){if(Vt(e))switch(e.value){case"padding-box":return 1;case"content-box":return 2}return 0})}},QU={name:"background-color",initialValue:"transparent",prefix:!1,type:3,format:"color"},pu=function(n,t){var e=Pi.parse(n,t[0]),s=t[1];return s&&ge(s)?{color:e,stop:s}:{color:e,stop:null}},Qg=function(n,t){var e=n[0],s=n[n.length-1];e.stop===null&&(e.stop=Te),s.stop===null&&(s.stop=Ii);for(var i=[],r=0,o=0;o<n.length;o++){var A=n[o].stop;if(A!==null){var a=zt(A,t);a>r?i.push(a):i.push(r),r=a}else i.push(null)}for(var l=null,o=0;o<i.length;o++){var c=i[o];if(c===null)l===null&&(l=o);else if(l!==null){for(var u=o-l,d=i[l-1],p=(c-d)/(u+1),f=1;f<=u;f++)i[l+f-1]=p*f;l=null}}return n.map(function(m,g){var w=m.color;return{color:w,stop:Math.max(Math.min(1,i[g]/t),0)}})},MU=function(n,t,e){var s=t/2,i=e/2,r=zt(n[0],t)-s,o=i-zt(n[1],e);return(Math.atan2(o,r)+Math.PI*2)%(Math.PI*2)},UU=function(n,t,e){var s=typeof n=="number"?n:MU(n,t,e),i=Math.abs(t*Math.sin(s))+Math.abs(e*Math.cos(s)),r=t/2,o=e/2,A=i/2,a=Math.sin(s-Math.PI/2)*A,l=Math.cos(s-Math.PI/2)*A;return[i,r-l,r+l,o-a,o+a]},qn=function(n,t){return Math.sqrt(n*n+t*t)},Mg=function(n,t,e,s,i){var r=[[0,0],[0,t],[n,0],[n,t]];return r.reduce(function(o,A){var a=A[0],l=A[1],c=qn(e-a,s-l);return(i?c<o.optimumDistance:c>o.optimumDistance)?{optimumCorner:A,optimumDistance:c}:o},{optimumDistance:i?1/0:-1/0,optimumCorner:null}).optimumCorner},PU=function(n,t,e,s,i){var r=0,o=0;switch(n.size){case 0:n.shape===0?r=o=Math.min(Math.abs(t),Math.abs(t-s),Math.abs(e),Math.abs(e-i)):n.shape===1&&(r=Math.min(Math.abs(t),Math.abs(t-s)),o=Math.min(Math.abs(e),Math.abs(e-i)));break;case 2:if(n.shape===0)r=o=Math.min(qn(t,e),qn(t,e-i),qn(t-s,e),qn(t-s,e-i));else if(n.shape===1){var A=Math.min(Math.abs(e),Math.abs(e-i))/Math.min(Math.abs(t),Math.abs(t-s)),a=Mg(s,i,t,e,!0),l=a[0],c=a[1];r=qn(l-t,(c-e)/A),o=A*r}break;case 1:n.shape===0?r=o=Math.max(Math.abs(t),Math.abs(t-s),Math.abs(e),Math.abs(e-i)):n.shape===1&&(r=Math.max(Math.abs(t),Math.abs(t-s)),o=Math.max(Math.abs(e),Math.abs(e-i)));break;case 3:if(n.shape===0)r=o=Math.max(qn(t,e),qn(t,e-i),qn(t-s,e),qn(t-s,e-i));else if(n.shape===1){var A=Math.max(Math.abs(e),Math.abs(e-i))/Math.max(Math.abs(t),Math.abs(t-s)),u=Mg(s,i,t,e,!1),l=u[0],c=u[1];r=qn(l-t,(c-e)/A),o=A*r}break}return Array.isArray(n.size)&&(r=zt(n.size[0],s),o=n.size.length===2?zt(n.size[1],i):r),[r,o]},NU=function(n,t){var e=Ln(180),s=[];return Ns(t).forEach(function(i,r){if(r===0){var o=i[0];if(o.type===20&&o.value==="to"){e=QB(i);return}else if(TB(o)){e=fu.parse(n,o);return}}var A=pu(n,i);s.push(A)}),{angle:e,stops:s,type:1}},rl=function(n,t){var e=Ln(180),s=[];return Ns(t).forEach(function(i,r){if(r===0){var o=i[0];if(o.type===20&&["top","left","right","bottom"].indexOf(o.value)!==-1){e=QB(i);return}else if(TB(o)){e=(fu.parse(n,o)+Ln(270))%Ln(360);return}}var A=pu(n,i);s.push(A)}),{angle:e,stops:s,type:1}},DU=function(n,t){var e=Ln(180),s=[],i=1,r=0,o=3,A=[];return Ns(t).forEach(function(a,l){var c=a[0];if(l===0){if(Vt(c)&&c.value==="linear"){i=1;return}else if(Vt(c)&&c.value==="radial"){i=2;return}}if(c.type===18){if(c.name==="from"){var u=Pi.parse(n,c.values[0]);s.push({stop:Te,color:u})}else if(c.name==="to"){var u=Pi.parse(n,c.values[0]);s.push({stop:Ii,color:u})}else if(c.name==="color-stop"){var d=c.values.filter(To);if(d.length===2){var u=Pi.parse(n,d[1]),p=d[0];Go(p)&&s.push({stop:{type:16,number:p.number*100,flags:p.flags},color:u})}}}}),i===1?{angle:(e+Ln(180))%Ln(360),stops:s,type:i}:{size:o,shape:r,stops:s,position:A,type:i}},MB="closest-side",UB="farthest-side",PB="closest-corner",NB="farthest-corner",DB="circle",LB="ellipse",kB="cover",RB="contain",LU=function(n,t){var e=0,s=3,i=[],r=[];return Ns(t).forEach(function(o,A){var a=!0;if(A===0){var l=!1;a=o.reduce(function(u,d){if(l)if(Vt(d))switch(d.value){case"center":return r.push(hp),u;case"top":case"left":return r.push(Te),u;case"right":case"bottom":return r.push(Ii),u}else(ge(d)||Wi(d))&&r.push(d);else if(Vt(d))switch(d.value){case DB:return e=0,!1;case LB:return e=1,!1;case"at":return l=!0,!1;case MB:return s=0,!1;case kB:case UB:return s=1,!1;case RB:case PB:return s=2,!1;case NB:return s=3,!1}else if(Wi(d)||ge(d))return Array.isArray(s)||(s=[]),s.push(d),!1;return u},a)}if(a){var c=pu(n,o);i.push(c)}}),{size:s,shape:e,stops:i,position:r,type:2}},ol=function(n,t){var e=0,s=3,i=[],r=[];return Ns(t).forEach(function(o,A){var a=!0;if(A===0?a=o.reduce(function(c,u){if(Vt(u))switch(u.value){case"center":return r.push(hp),!1;case"top":case"left":return r.push(Te),!1;case"right":case"bottom":return r.push(Ii),!1}else if(ge(u)||Wi(u))return r.push(u),!1;return c},a):A===1&&(a=o.reduce(function(c,u){if(Vt(u))switch(u.value){case DB:return e=0,!1;case LB:return e=1,!1;case RB:case MB:return s=0,!1;case UB:return s=1,!1;case PB:return s=2,!1;case kB:case NB:return s=3,!1}else if(Wi(u)||ge(u))return Array.isArray(s)||(s=[]),s.push(u),!1;return c},a)),a){var l=pu(n,o);i.push(l)}}),{size:s,shape:e,stops:i,position:r,type:2}},kU=function(n){return n.type===1},RU=function(n){return n.type===2},fp={name:"image",parse:function(n,t){if(t.type===22){var e={url:t.value,type:0};return n.cache.addImage(t.value),e}if(t.type===18){var s=HB[t.name];if(typeof s>"u")throw new Error('Attempting to parse an unsupported image function "'+t.name+'"');return s(n,t.values)}throw new Error("Unsupported image type "+t.type)}};function HU(n){return!(n.type===20&&n.value==="none")&&(n.type!==18||!!HB[n.name])}var HB={"linear-gradient":NU,"-moz-linear-gradient":rl,"-ms-linear-gradient":rl,"-o-linear-gradient":rl,"-webkit-linear-gradient":rl,"radial-gradient":LU,"-moz-radial-gradient":ol,"-ms-radial-gradient":ol,"-o-radial-gradient":ol,"-webkit-radial-gradient":ol,"-webkit-gradient":DU},OU={name:"background-image",initialValue:"none",type:1,prefix:!1,parse:function(n,t){if(t.length===0)return[];var e=t[0];return e.type===20&&e.value==="none"?[]:t.filter(function(s){return To(s)&&HU(s)}).map(function(s){return fp.parse(n,s)})}},VU={name:"background-origin",initialValue:"border-box",prefix:!1,type:1,parse:function(n,t){return t.map(function(e){if(Vt(e))switch(e.value){case"padding-box":return 1;case"content-box":return 2}return 0})}},WU={name:"background-position",initialValue:"0% 0%",type:1,prefix:!1,parse:function(n,t){return Ns(t).map(function(e){return e.filter(ge)}).map(EB)}},GU={name:"background-repeat",initialValue:"repeat",prefix:!1,type:1,parse:function(n,t){return Ns(t).map(function(e){return e.filter(Vt).map(function(s){return s.value}).join(" ")}).map(KU)}},KU=function(n){switch(n){case"no-repeat":return 1;case"repeat-x":case"repeat no-repeat":return 2;case"repeat-y":case"no-repeat repeat":return 3;case"repeat":default:return 0}},Bo;(function(n){n.AUTO="auto",n.CONTAIN="contain",n.COVER="cover"})(Bo||(Bo={}));var qU={name:"background-size",initialValue:"0",prefix:!1,type:1,parse:function(n,t){return Ns(t).map(function(e){return e.filter(zU)})}},zU=function(n){return Vt(n)||ge(n)},mu=function(n){return{name:"border-"+n+"-color",initialValue:"transparent",prefix:!1,type:3,format:"color"}},XU=mu("top"),$U=mu("right"),YU=mu("bottom"),jU=mu("left"),gu=function(n){return{name:"border-radius-"+n,initialValue:"0 0",prefix:!1,type:1,parse:function(t,e){return EB(e.filter(ge))}}},JU=gu("top-left"),ZU=gu("top-right"),t3=gu("bottom-right"),e3=gu("bottom-left"),wu=function(n){return{name:"border-"+n+"-style",initialValue:"solid",prefix:!1,type:2,parse:function(t,e){switch(e){case"none":return 0;case"dashed":return 2;case"dotted":return 3;case"double":return 4}return 1}}},n3=wu("top"),s3=wu("right"),i3=wu("bottom"),r3=wu("left"),vu=function(n){return{name:"border-"+n+"-width",initialValue:"0",type:0,prefix:!1,parse:function(t,e){return Fa(e)?e.number:0}}},o3=vu("top"),A3=vu("right"),a3=vu("bottom"),l3=vu("left"),c3={name:"color",initialValue:"transparent",prefix:!1,type:3,format:"color"},u3={name:"direction",initialValue:"ltr",prefix:!1,type:2,parse:function(n,t){switch(t){case"rtl":return 1;case"ltr":default:return 0}}},d3={name:"display",initialValue:"inline-block",prefix:!1,type:1,parse:function(n,t){return t.filter(Vt).reduce(function(e,s){return e|h3(s.value)},0)}},h3=function(n){switch(n){case"block":case"-webkit-box":return 2;case"inline":return 4;case"run-in":return 8;case"flow":return 16;case"flow-root":return 32;case"table":return 64;case"flex":case"-webkit-flex":return 128;case"grid":case"-ms-grid":return 256;case"ruby":return 512;case"subgrid":return 1024;case"list-item":return 2048;case"table-row-group":return 4096;case"table-header-group":return 8192;case"table-footer-group":return 16384;case"table-row":return 32768;case"table-cell":return 65536;case"table-column-group":return 131072;case"table-column":return 262144;case"table-caption":return 524288;case"ruby-base":return 1048576;case"ruby-text":return 2097152;case"ruby-base-container":return 4194304;case"ruby-text-container":return 8388608;case"contents":return 16777216;case"inline-block":return 33554432;case"inline-list-item":return 67108864;case"inline-table":return 134217728;case"inline-flex":return 268435456;case"inline-grid":return 536870912}return 0},f3={name:"float",initialValue:"none",prefix:!1,type:2,parse:function(n,t){switch(t){case"left":return 1;case"right":return 2;case"inline-start":return 3;case"inline-end":return 4}return 0}},p3={name:"letter-spacing",initialValue:"0",prefix:!1,type:0,parse:function(n,t){return t.type===20&&t.value==="normal"?0:t.type===17||t.type===15?t.number:0}},dc;(function(n){n.NORMAL="normal",n.STRICT="strict"})(dc||(dc={}));var m3={name:"line-break",initialValue:"normal",prefix:!1,type:2,parse:function(n,t){switch(t){case"strict":return dc.STRICT;case"normal":default:return dc.NORMAL}}},g3={name:"line-height",initialValue:"normal",prefix:!1,type:4},Ug=function(n,t){return Vt(n)&&n.value==="normal"?1.2*t:n.type===17?t*n.number:ge(n)?zt(n,t):t},w3={name:"list-style-image",initialValue:"none",type:0,prefix:!1,parse:function(n,t){return t.type===20&&t.value==="none"?null:fp.parse(n,t)}},v3={name:"list-style-position",initialValue:"outside",prefix:!1,type:2,parse:function(n,t){switch(t){case"inside":return 0;case"outside":default:return 1}}},Bh={name:"list-style-type",initialValue:"none",prefix:!1,type:2,parse:function(n,t){switch(t){case"disc":return 0;case"circle":return 1;case"square":return 2;case"decimal":return 3;case"cjk-decimal":return 4;case"decimal-leading-zero":return 5;case"lower-roman":return 6;case"upper-roman":return 7;case"lower-greek":return 8;case"lower-alpha":return 9;case"upper-alpha":return 10;case"arabic-indic":return 11;case"armenian":return 12;case"bengali":return 13;case"cambodian":return 14;case"cjk-earthly-branch":return 15;case"cjk-heavenly-stem":return 16;case"cjk-ideographic":return 17;case"devanagari":return 18;case"ethiopic-numeric":return 19;case"georgian":return 20;case"gujarati":return 21;case"gurmukhi":return 22;case"hebrew":return 22;case"hiragana":return 23;case"hiragana-iroha":return 24;case"japanese-formal":return 25;case"japanese-informal":return 26;case"kannada":return 27;case"katakana":return 28;case"katakana-iroha":return 29;case"khmer":return 30;case"korean-hangul-formal":return 31;case"korean-hanja-formal":return 32;case"korean-hanja-informal":return 33;case"lao":return 34;case"lower-armenian":return 35;case"malayalam":return 36;case"mongolian":return 37;case"myanmar":return 38;case"oriya":return 39;case"persian":return 40;case"simp-chinese-formal":return 41;case"simp-chinese-informal":return 42;case"tamil":return 43;case"telugu":return 44;case"thai":return 45;case"tibetan":return 46;case"trad-chinese-formal":return 47;case"trad-chinese-informal":return 48;case"upper-armenian":return 49;case"disclosure-open":return 50;case"disclosure-closed":return 51;case"none":default:return-1}}},Bu=function(n){return{name:"margin-"+n,initialValue:"0",prefix:!1,type:4}},B3=Bu("top"),C3=Bu("right"),b3=Bu("bottom"),y3=Bu("left"),S3={name:"overflow",initialValue:"visible",prefix:!1,type:1,parse:function(n,t){return t.filter(Vt).map(function(e){switch(e.value){case"hidden":return 1;case"scroll":return 2;case"clip":return 3;case"auto":return 4;case"visible":default:return 0}})}},E3={name:"overflow-wrap",initialValue:"normal",prefix:!1,type:2,parse:function(n,t){switch(t){case"break-word":return"break-word";case"normal":default:return"normal"}}},Cu=function(n){return{name:"padding-"+n,initialValue:"0",prefix:!1,type:3,format:"length-percentage"}},x3=Cu("top"),_3=Cu("right"),I3=Cu("bottom"),F3=Cu("left"),T3={name:"text-align",initialValue:"left",prefix:!1,type:2,parse:function(n,t){switch(t){case"right":return 2;case"center":case"justify":return 1;case"left":default:return 0}}},Q3={name:"position",initialValue:"static",prefix:!1,type:2,parse:function(n,t){switch(t){case"relative":return 1;case"absolute":return 2;case"fixed":return 3;case"sticky":return 4}return 0}},M3={name:"text-shadow",initialValue:"none",type:1,prefix:!1,parse:function(n,t){return t.length===1&&vh(t[0],"none")?[]:Ns(t).map(function(e){for(var s={color:ti.TRANSPARENT,offsetX:Te,offsetY:Te,blur:Te},i=0,r=0;r<e.length;r++){var o=e[r];Wi(o)?(i===0?s.offsetX=o:i===1?s.offsetY=o:s.blur=o,i++):s.color=Pi.parse(n,o)}return s})}},U3={name:"text-transform",initialValue:"none",prefix:!1,type:2,parse:function(n,t){switch(t){case"uppercase":return 2;case"lowercase":return 1;case"capitalize":return 3}return 0}},P3={name:"transform",initialValue:"none",prefix:!0,type:0,parse:function(n,t){if(t.type===20&&t.value==="none")return null;if(t.type===18){var e=L3[t.name];if(typeof e>"u")throw new Error('Attempting to parse an unsupported transform function "'+t.name+'"');return e(t.values)}return null}},N3=function(n){var t=n.filter(function(e){return e.type===17}).map(function(e){return e.number});return t.length===6?t:null},D3=function(n){var t=n.filter(function(a){return a.type===17}).map(function(a){return a.number}),e=t[0],s=t[1];t[2],t[3];var i=t[4],r=t[5];t[6],t[7],t[8],t[9],t[10],t[11];var o=t[12],A=t[13];return t[14],t[15],t.length===16?[e,s,i,r,o,A]:null},L3={matrix:N3,matrix3d:D3},Pg={type:16,number:50,flags:Ia},k3=[Pg,Pg],R3={name:"transform-origin",initialValue:"50% 50%",prefix:!0,type:1,parse:function(n,t){var e=t.filter(ge);return e.length!==2?k3:[e[0],e[1]]}},H3={name:"visible",initialValue:"none",prefix:!1,type:2,parse:function(n,t){switch(t){case"hidden":return 1;case"collapse":return 2;case"visible":default:return 0}}},_A;(function(n){n.NORMAL="normal",n.BREAK_ALL="break-all",n.KEEP_ALL="keep-all"})(_A||(_A={}));var O3={name:"word-break",initialValue:"normal",prefix:!1,type:2,parse:function(n,t){switch(t){case"break-all":return _A.BREAK_ALL;case"keep-all":return _A.KEEP_ALL;case"normal":default:return _A.NORMAL}}},V3={name:"z-index",initialValue:"auto",prefix:!1,type:0,parse:function(n,t){if(t.type===20)return{auto:!0,order:0};if(Go(t))return{auto:!1,order:t.number};throw new Error("Invalid z-index number parsed")}},OB={name:"time",parse:function(n,t){if(t.type===15)switch(t.unit.toLowerCase()){case"s":return 1e3*t.number;case"ms":return t.number}throw new Error("Unsupported time type")}},W3={name:"opacity",initialValue:"1",type:0,prefix:!1,parse:function(n,t){return Go(t)?t.number:1}},G3={name:"text-decoration-color",initialValue:"transparent",prefix:!1,type:3,format:"color"},K3={name:"text-decoration-line",initialValue:"none",prefix:!1,type:1,parse:function(n,t){return t.filter(Vt).map(function(e){switch(e.value){case"underline":return 1;case"overline":return 2;case"line-through":return 3;case"none":return 4}return 0}).filter(function(e){return e!==0})}},q3={name:"font-family",initialValue:"",prefix:!1,type:1,parse:function(n,t){var e=[],s=[];return t.forEach(function(i){switch(i.type){case 20:case 0:e.push(i.value);break;case 17:e.push(i.number.toString());break;case 4:s.push(e.join(" ")),e.length=0;break}}),e.length&&s.push(e.join(" ")),s.map(function(i){return i.indexOf(" ")===-1?i:"'"+i+"'"})}},z3={name:"font-size",initialValue:"0",prefix:!1,type:3,format:"length"},X3={name:"font-weight",initialValue:"normal",type:0,prefix:!1,parse:function(n,t){if(Go(t))return t.number;if(Vt(t))switch(t.value){case"bold":return 700;case"normal":default:return 400}return 400}},$3={name:"font-variant",initialValue:"none",type:1,prefix:!1,parse:function(n,t){return t.filter(Vt).map(function(e){return e.value})}},Y3={name:"font-style",initialValue:"normal",prefix:!1,type:2,parse:function(n,t){switch(t){case"oblique":return"oblique";case"italic":return"italic";case"normal":default:return"normal"}}},Ce=function(n,t){return(n&t)!==0},j3={name:"content",initialValue:"none",type:1,prefix:!1,parse:function(n,t){if(t.length===0)return[];var e=t[0];return e.type===20&&e.value==="none"?[]:t}},J3={name:"counter-increment",initialValue:"none",prefix:!0,type:1,parse:function(n,t){if(t.length===0)return null;var e=t[0];if(e.type===20&&e.value==="none")return null;for(var s=[],i=t.filter(SB),r=0;r<i.length;r++){var o=i[r],A=i[r+1];if(o.type===20){var a=A&&Go(A)?A.number:1;s.push({counter:o.value,increment:a})}}return s}},Z3={name:"counter-reset",initialValue:"none",prefix:!0,type:1,parse:function(n,t){if(t.length===0)return[];for(var e=[],s=t.filter(SB),i=0;i<s.length;i++){var r=s[i],o=s[i+1];if(Vt(r)&&r.value!=="none"){var A=o&&Go(o)?o.number:0;e.push({counter:r.value,reset:A})}}return e}},tP={name:"duration",initialValue:"0s",prefix:!1,type:1,parse:function(n,t){return t.filter(Fa).map(function(e){return OB.parse(n,e)})}},eP={name:"quotes",initialValue:"none",prefix:!0,type:1,parse:function(n,t){if(t.length===0)return null;var e=t[0];if(e.type===20&&e.value==="none")return null;var s=[],i=t.filter(_U);if(i.length%2!==0)return null;for(var r=0;r<i.length;r+=2){var o=i[r].value,A=i[r+1].value;s.push({open:o,close:A})}return s}},Ng=function(n,t,e){if(!n)return"";var s=n[Math.min(t,n.length-1)];return s?e?s.open:s.close:""},nP={name:"box-shadow",initialValue:"none",type:1,prefix:!1,parse:function(n,t){return t.length===1&&vh(t[0],"none")?[]:Ns(t).map(function(e){for(var s={color:255,offsetX:Te,offsetY:Te,blur:Te,spread:Te,inset:!1},i=0,r=0;r<e.length;r++){var o=e[r];vh(o,"inset")?s.inset=!0:Wi(o)?(i===0?s.offsetX=o:i===1?s.offsetY=o:i===2?s.blur=o:s.spread=o,i++):s.color=Pi.parse(n,o)}return s})}},sP={name:"paint-order",initialValue:"normal",prefix:!1,type:1,parse:function(n,t){var e=[0,1,2],s=[];return t.filter(Vt).forEach(function(i){switch(i.value){case"stroke":s.push(1);break;case"fill":s.push(0);break;case"markers":s.push(2);break}}),e.forEach(function(i){s.indexOf(i)===-1&&s.push(i)}),s}},iP={name:"-webkit-text-stroke-color",initialValue:"currentcolor",prefix:!1,type:3,format:"color"},rP={name:"-webkit-text-stroke-width",initialValue:"0",type:0,prefix:!1,parse:function(n,t){return Fa(t)?t.number:0}},oP=(function(){function n(t,e){var s,i;this.animationDuration=At(t,tP,e.animationDuration),this.backgroundClip=At(t,TU,e.backgroundClip),this.backgroundColor=At(t,QU,e.backgroundColor),this.backgroundImage=At(t,OU,e.backgroundImage),this.backgroundOrigin=At(t,VU,e.backgroundOrigin),this.backgroundPosition=At(t,WU,e.backgroundPosition),this.backgroundRepeat=At(t,GU,e.backgroundRepeat),this.backgroundSize=At(t,qU,e.backgroundSize),this.borderTopColor=At(t,XU,e.borderTopColor),this.borderRightColor=At(t,$U,e.borderRightColor),this.borderBottomColor=At(t,YU,e.borderBottomColor),this.borderLeftColor=At(t,jU,e.borderLeftColor),this.borderTopLeftRadius=At(t,JU,e.borderTopLeftRadius),this.borderTopRightRadius=At(t,ZU,e.borderTopRightRadius),this.borderBottomRightRadius=At(t,t3,e.borderBottomRightRadius),this.borderBottomLeftRadius=At(t,e3,e.borderBottomLeftRadius),this.borderTopStyle=At(t,n3,e.borderTopStyle),this.borderRightStyle=At(t,s3,e.borderRightStyle),this.borderBottomStyle=At(t,i3,e.borderBottomStyle),this.borderLeftStyle=At(t,r3,e.borderLeftStyle),this.borderTopWidth=At(t,o3,e.borderTopWidth),this.borderRightWidth=At(t,A3,e.borderRightWidth),this.borderBottomWidth=At(t,a3,e.borderBottomWidth),this.borderLeftWidth=At(t,l3,e.borderLeftWidth),this.boxShadow=At(t,nP,e.boxShadow),this.color=At(t,c3,e.color),this.direction=At(t,u3,e.direction),this.display=At(t,d3,e.display),this.float=At(t,f3,e.cssFloat),this.fontFamily=At(t,q3,e.fontFamily),this.fontSize=At(t,z3,e.fontSize),this.fontStyle=At(t,Y3,e.fontStyle),this.fontVariant=At(t,$3,e.fontVariant),this.fontWeight=At(t,X3,e.fontWeight),this.letterSpacing=At(t,p3,e.letterSpacing),this.lineBreak=At(t,m3,e.lineBreak),this.lineHeight=At(t,g3,e.lineHeight),this.listStyleImage=At(t,w3,e.listStyleImage),this.listStylePosition=At(t,v3,e.listStylePosition),this.listStyleType=At(t,Bh,e.listStyleType),this.marginTop=At(t,B3,e.marginTop),this.marginRight=At(t,C3,e.marginRight),this.marginBottom=At(t,b3,e.marginBottom),this.marginLeft=At(t,y3,e.marginLeft),this.opacity=At(t,W3,e.opacity);var r=At(t,S3,e.overflow);this.overflowX=r[0],this.overflowY=r[r.length>1?1:0],this.overflowWrap=At(t,E3,e.overflowWrap),this.paddingTop=At(t,x3,e.paddingTop),this.paddingRight=At(t,_3,e.paddingRight),this.paddingBottom=At(t,I3,e.paddingBottom),this.paddingLeft=At(t,F3,e.paddingLeft),this.paintOrder=At(t,sP,e.paintOrder),this.position=At(t,Q3,e.position),this.textAlign=At(t,T3,e.textAlign),this.textDecorationColor=At(t,G3,(s=e.textDecorationColor)!==null&&s!==void 0?s:e.color),this.textDecorationLine=At(t,K3,(i=e.textDecorationLine)!==null&&i!==void 0?i:e.textDecoration),this.textShadow=At(t,M3,e.textShadow),this.textTransform=At(t,U3,e.textTransform),this.transform=At(t,P3,e.transform),this.transformOrigin=At(t,R3,e.transformOrigin),this.visibility=At(t,H3,e.visibility),this.webkitTextStrokeColor=At(t,iP,e.webkitTextStrokeColor),this.webkitTextStrokeWidth=At(t,rP,e.webkitTextStrokeWidth),this.wordBreak=At(t,O3,e.wordBreak),this.zIndex=At(t,V3,e.zIndex)}return n.prototype.isVisible=function(){return this.display>0&&this.opacity>0&&this.visibility===0},n.prototype.isTransparent=function(){return Ni(this.backgroundColor)},n.prototype.isTransformed=function(){return this.transform!==null},n.prototype.isPositioned=function(){return this.position!==0},n.prototype.isPositionedWithZIndex=function(){return this.isPositioned()&&!this.zIndex.auto},n.prototype.isFloating=function(){return this.float!==0},n.prototype.isInlineLevel=function(){return Ce(this.display,4)||Ce(this.display,33554432)||Ce(this.display,268435456)||Ce(this.display,536870912)||Ce(this.display,67108864)||Ce(this.display,134217728)},n})(),AP=(function(){function n(t,e){this.content=At(t,j3,e.content),this.quotes=At(t,eP,e.quotes)}return n})(),Dg=(function(){function n(t,e){this.counterIncrement=At(t,J3,e.counterIncrement),this.counterReset=At(t,Z3,e.counterReset)}return n})(),At=function(n,t,e){var s=new bB,i=e!==null&&typeof e<"u"?e.toString():t.initialValue;s.write(i);var r=new yB(s.read());switch(t.type){case 2:var o=r.parseComponentValue();return t.parse(n,Vt(o)?o.value:t.initialValue);case 0:return t.parse(n,r.parseComponentValue());case 1:return t.parse(n,r.parseComponentValues());case 4:return r.parseComponentValue();case 3:switch(t.format){case"angle":return fu.parse(n,r.parseComponentValue());case"color":return Pi.parse(n,r.parseComponentValue());case"image":return fp.parse(n,r.parseComponentValue());case"length":var A=r.parseComponentValue();return Wi(A)?A:Te;case"length-percentage":var a=r.parseComponentValue();return ge(a)?a:Te;case"time":return OB.parse(n,r.parseComponentValue())}break}},aP="data-html2canvas-debug",lP=function(n){var t=n.getAttribute(aP);switch(t){case"all":return 1;case"clone":return 2;case"parse":return 3;case"render":return 4;default:return 0}},Ch=function(n,t){var e=lP(n);return e===1||t===e},Ds=(function(){function n(t,e){if(this.context=t,this.textNodes=[],this.elements=[],this.flags=0,Ch(e,3))debugger;this.styles=new oP(t,window.getComputedStyle(e,null)),Sh(e)&&(this.styles.animationDuration.some(function(s){return s>0})&&(e.style.animationDuration="0s"),this.styles.transform!==null&&(e.style.transform="none")),this.bounds=du(this.context,e),Ch(e,4)&&(this.flags|=16)}return n})(),cP="AAAAAAAAAAAAEA4AGBkAAFAaAAACAAAAAAAIABAAGAAwADgACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAIABAAQABIAEQATAAIABAACAAQAAgAEAAIABAAVABcAAgAEAAIABAACAAQAGAAaABwAHgAgACIAI4AlgAIABAAmwCjAKgAsAC2AL4AvQDFAMoA0gBPAVYBWgEIAAgACACMANoAYgFkAWwBdAF8AX0BhQGNAZUBlgGeAaMBlQGWAasBswF8AbsBwwF0AcsBYwHTAQgA2wG/AOMBdAF8AekB8QF0AfkB+wHiAHQBfAEIAAMC5gQIAAsCEgIIAAgAFgIeAggAIgIpAggAMQI5AkACygEIAAgASAJQAlgCYAIIAAgACAAKBQoFCgUTBRMFGQUrBSsFCAAIAAgACAAIAAgACAAIAAgACABdAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABoAmgCrwGvAQgAbgJ2AggAHgEIAAgACADnAXsCCAAIAAgAgwIIAAgACAAIAAgACACKAggAkQKZAggAPADJAAgAoQKkAqwCsgK6AsICCADJAggA0AIIAAgACAAIANYC3gIIAAgACAAIAAgACABAAOYCCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAkASoB+QIEAAgACAA8AEMCCABCBQgACABJBVAFCAAIAAgACAAIAAgACAAIAAgACABTBVoFCAAIAFoFCABfBWUFCAAIAAgACAAIAAgAbQUIAAgACAAIAAgACABzBXsFfQWFBYoFigWKBZEFigWKBYoFmAWfBaYFrgWxBbkFCAAIAAgACAAIAAgACAAIAAgACAAIAMEFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAMgFCADQBQgACAAIAAgACAAIAAgACAAIAAgACAAIAO4CCAAIAAgAiQAIAAgACABAAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAD0AggACAD8AggACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIANYFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAMDvwAIAAgAJAIIAAgACAAIAAgACAAIAAgACwMTAwgACAB9BOsEGwMjAwgAKwMyAwsFYgE3A/MEPwMIAEUDTQNRAwgAWQOsAGEDCAAIAAgACAAIAAgACABpAzQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFIQUoBSwFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABtAwgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABMAEwACAAIAAgACAAIABgACAAIAAgACAC/AAgACAAyAQgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACACAAIAAwAAgACAAIAAgACAAIAAgACAAIAAAARABIAAgACAAIABQASAAIAAgAIABwAEAAjgCIABsAqAC2AL0AigDQAtwC+IJIQqVAZUBWQqVAZUBlQGVAZUBlQGrC5UBlQGVAZUBlQGVAZUBlQGVAXsKlQGVAbAK6wsrDGUMpQzlDJUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAfAKAAuZA64AtwCJALoC6ADwAAgAuACgA/oEpgO6AqsD+AAIAAgAswMIAAgACAAIAIkAuwP5AfsBwwPLAwgACAAIAAgACADRA9kDCAAIAOED6QMIAAgACAAIAAgACADuA/YDCAAIAP4DyQAIAAgABgQIAAgAXQAOBAgACAAIAAgACAAIABMECAAIAAgACAAIAAgACAD8AAQBCAAIAAgAGgQiBCoECAExBAgAEAEIAAgACAAIAAgACAAIAAgACAAIAAgACAA4BAgACABABEYECAAIAAgATAQYAQgAVAQIAAgACAAIAAgACAAIAAgACAAIAFoECAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAOQEIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAB+BAcACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAEABhgSMBAgACAAIAAgAlAQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAwAEAAQABAADAAMAAwADAAQABAAEAAQABAAEAAQABHATAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAdQMIAAgACAAIAAgACAAIAMkACAAIAAgAfQMIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACACFA4kDCAAIAAgACAAIAOcBCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAIcDCAAIAAgACAAIAAgACAAIAAgACAAIAJEDCAAIAAgACADFAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABgBAgAZgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAbAQCBXIECAAIAHkECAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABAAJwEQACjBKoEsgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAC6BMIECAAIAAgACAAIAAgACABmBAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAxwQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAGYECAAIAAgAzgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAigWKBYoFigWKBYoFigWKBd0FXwUIAOIF6gXxBYoF3gT5BQAGCAaKBYoFigWKBYoFigWKBYoFigWKBYoFigXWBIoFigWKBYoFigWKBYoFigWKBYsFEAaKBYoFigWKBYoFigWKBRQGCACKBYoFigWKBQgACAAIANEECAAIABgGigUgBggAJgYIAC4GMwaKBYoF0wQ3Bj4GigWKBYoFigWKBYoFigWKBYoFigWKBYoFigUIAAgACAAIAAgACAAIAAgAigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWLBf///////wQABAAEAAQABAAEAAQABAAEAAQAAwAEAAQAAgAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAQADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAUAAAAFAAUAAAAFAAUAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUAAQAAAAUABQAFAAUABQAFAAAAAAAFAAUAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAFAAUAAQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUABQAFAAAABwAHAAcAAAAHAAcABwAFAAEAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAcABwAFAAUAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAAAAQABAAAAAAAAAAAAAAAFAAUABQAFAAAABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABwAHAAcAAAAHAAcAAAAAAAUABQAHAAUAAQAHAAEABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABwABAAUABQAFAAUAAAAAAAAAAAAAAAEAAQABAAEAAQABAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABQANAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQABAAEAAQABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAABQAHAAUABQAFAAAAAAAAAAcABQAFAAUABQAFAAQABAAEAAQABAAEAAQABAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUAAAAFAAUABQAFAAUAAAAFAAUABQAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAAAAAAAAAAAAUABQAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAUAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABwAHAAcABwAFAAcABwAAAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAUABwAHAAUABQAFAAUAAAAAAAcABwAAAAAABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAABQAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAABwAHAAcABQAFAAAAAAAAAAAABQAFAAAAAAAFAAUABQAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAFAAUABQAFAAUAAAAFAAUABwAAAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAFAAUABwAFAAUABQAFAAAAAAAHAAcAAAAAAAcABwAFAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABwAAAAAAAAAHAAcABwAAAAcABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAABQAHAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAcABwAAAAUABQAFAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABQAHAAcABQAHAAcAAAAFAAcABwAAAAcABwAFAAUAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAFAAcABwAFAAUABQAAAAUAAAAHAAcABwAHAAcABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAHAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAABwAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAUAAAAFAAAAAAAAAAAABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUABQAFAAUAAAAFAAUAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABwAFAAUABQAFAAUABQAAAAUABQAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABQAFAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABQAFAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAHAAUABQAFAAUABQAFAAUABwAHAAcABwAHAAcABwAHAAUABwAHAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABwAHAAcABwAFAAUABwAHAAcAAAAAAAAAAAAHAAcABQAHAAcABwAHAAcABwAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAHAAUABQAFAAUABQAFAAUAAAAFAAAABQAAAAAABQAFAAUABQAFAAUABQAFAAcABwAHAAcABwAHAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAUABQAFAAUABQAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABwAFAAcABwAHAAcABwAFAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAUABQAFAAUABwAHAAUABQAHAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABQAFAAcABwAHAAUABwAFAAUABQAHAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAUABQAFAAUABQAFAAUABQAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAcABQAFAAUABQAFAAUABQAAAAAAAAAAAAUAAAAAAAAAAAAAAAAABQAAAAAABwAFAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUAAAAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAABQAAAAAAAAAFAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAUABQAHAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAHAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABwAFAAUABQAFAAcABwAFAAUABwAHAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAcABwAFAAUABwAHAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAFAAUABQAAAAAABQAFAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAFAAcABwAAAAAAAAAAAAAABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAFAAcABwAFAAcABwAAAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAFAAUABQAAAAUABQAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABwAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABQAFAAUABQAFAAUABQAFAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAHAAcABQAHAAUABQAAAAAAAAAAAAAAAAAFAAAABwAHAAcABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAcABwAAAAAABwAHAAAAAAAHAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABwAHAAUABQAFAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABQAFAAUABQAFAAUABwAFAAcABwAFAAcABQAFAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABQAFAAUABQAAAAAABwAHAAcABwAFAAUABwAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAHAAUABQAFAAUABQAFAAUABQAHAAcABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAFAAcABwAFAAUABQAFAAUABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAcABwAFAAUABQAFAAcABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABQAHAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAAAAAAFAAUABwAHAAcABwAFAAAAAAAAAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABwAHAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAHAAUABQAFAAUABQAFAAUABwAFAAUABwAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAAAAAAAABQAAAAUABQAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAHAAcAAAAFAAUAAAAHAAcABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAAAAAAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAUABQAFAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAABQAFAAUABQAFAAUABQAAAAUABQAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAFAAUABQAFAAUADgAOAA4ADgAOAA4ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAAAAAAAAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAMAAwADAAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkAAAAAAAAAAAAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAAAAAAAAAAAAsADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwACwAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAADgAOAA4AAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAAAA4ADgAOAA4ADgAOAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAA4AAAAOAAAAAAAAAAAAAAAAAA4AAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAADgAAAAAAAAAAAA4AAAAOAAAAAAAAAAAADgAOAA4AAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4AAAAAAA4ADgAOAA4ADgAOAA4ADgAOAAAADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4AAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAOAA4ADgAOAA4ADgAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAAAAAAA=",Lg="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",cA=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var Al=0;Al<Lg.length;Al++)cA[Lg.charCodeAt(Al)]=Al;var uP=function(n){var t=n.length*.75,e=n.length,s,i=0,r,o,A,a;n[n.length-1]==="="&&(t--,n[n.length-2]==="="&&t--);var l=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u"&&typeof Uint8Array.prototype.slice<"u"?new ArrayBuffer(t):new Array(t),c=Array.isArray(l)?l:new Uint8Array(l);for(s=0;s<e;s+=4)r=cA[n.charCodeAt(s)],o=cA[n.charCodeAt(s+1)],A=cA[n.charCodeAt(s+2)],a=cA[n.charCodeAt(s+3)],c[i++]=r<<2|o>>4,c[i++]=(o&15)<<4|A>>2,c[i++]=(A&3)<<6|a&63;return l},dP=function(n){for(var t=n.length,e=[],s=0;s<t;s+=2)e.push(n[s+1]<<8|n[s]);return e},hP=function(n){for(var t=n.length,e=[],s=0;s<t;s+=4)e.push(n[s+3]<<24|n[s+2]<<16|n[s+1]<<8|n[s]);return e},gr=5,pp=11,id=2,fP=pp-gr,VB=65536>>gr,pP=1<<gr,rd=pP-1,mP=1024>>gr,gP=VB+mP,wP=gP,vP=32,BP=wP+vP,CP=65536>>pp,bP=1<<fP,yP=bP-1,kg=function(n,t,e){return n.slice?n.slice(t,e):new Uint16Array(Array.prototype.slice.call(n,t,e))},SP=function(n,t,e){return n.slice?n.slice(t,e):new Uint32Array(Array.prototype.slice.call(n,t,e))},EP=function(n,t){var e=uP(n),s=Array.isArray(e)?hP(e):new Uint32Array(e),i=Array.isArray(e)?dP(e):new Uint16Array(e),r=24,o=kg(i,r/2,s[4]/2),A=s[5]===2?kg(i,(r+s[4])/2):SP(s,Math.ceil((r+s[4])/4));return new xP(s[0],s[1],s[2],s[3],o,A)},xP=(function(){function n(t,e,s,i,r,o){this.initialValue=t,this.errorValue=e,this.highStart=s,this.highValueIndex=i,this.index=r,this.data=o}return n.prototype.get=function(t){var e;if(t>=0){if(t<55296||t>56319&&t<=65535)return e=this.index[t>>gr],e=(e<<id)+(t&rd),this.data[e];if(t<=65535)return e=this.index[VB+(t-55296>>gr)],e=(e<<id)+(t&rd),this.data[e];if(t<this.highStart)return e=BP-CP+(t>>pp),e=this.index[e],e+=t>>gr&yP,e=this.index[e],e=(e<<id)+(t&rd),this.data[e];if(t<=1114111)return this.data[this.highValueIndex]}return this.errorValue},n})(),Rg="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",_P=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var al=0;al<Rg.length;al++)_P[Rg.charCodeAt(al)]=al;var IP=1,od=2,Ad=3,Hg=4,Og=5,FP=7,Vg=8,ad=9,ld=10,Wg=11,Gg=12,Kg=13,qg=14,cd=15,TP=function(n){for(var t=[],e=0,s=n.length;e<s;){var i=n.charCodeAt(e++);if(i>=55296&&i<=56319&&e<s){var r=n.charCodeAt(e++);(r&64512)===56320?t.push(((i&1023)<<10)+(r&1023)+65536):(t.push(i),e--)}else t.push(i)}return t},QP=function(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];if(String.fromCodePoint)return String.fromCodePoint.apply(String,n);var e=n.length;if(!e)return"";for(var s=[],i=-1,r="";++i<e;){var o=n[i];o<=65535?s.push(o):(o-=65536,s.push((o>>10)+55296,o%1024+56320)),(i+1===e||s.length>16384)&&(r+=String.fromCharCode.apply(String,s),s.length=0)}return r},MP=EP(cP),_n="",ud="",UP=function(n){return MP.get(n)},PP=function(n,t,e){var s=e-2,i=t[s],r=t[e-1],o=t[e];if(r===od&&o===Ad)return _n;if(r===od||r===Ad||r===Hg||o===od||o===Ad||o===Hg)return ud;if(r===Vg&&[Vg,ad,Wg,Gg].indexOf(o)!==-1||(r===Wg||r===ad)&&(o===ad||o===ld)||(r===Gg||r===ld)&&o===ld||o===Kg||o===Og||o===FP||r===IP)return _n;if(r===Kg&&o===qg){for(;i===Og;)i=t[--s];if(i===qg)return _n}if(r===cd&&o===cd){for(var A=0;i===cd;)A++,i=t[--s];if(A%2===0)return _n}return ud},NP=function(n){var t=TP(n),e=t.length,s=0,i=0,r=t.map(UP);return{next:function(){if(s>=e)return{done:!0,value:null};for(var o=_n;s<e&&(o=PP(t,r,++s))===_n;);if(o!==_n||s===e){var A=QP.apply(null,t.slice(i,s));return i=s,{value:A,done:!1}}return{done:!0,value:null}}}},DP=function(n){for(var t=NP(n),e=[],s;!(s=t.next()).done;)s.value&&e.push(s.value.slice());return e},LP=function(n){var t=123;if(n.createRange){var e=n.createRange();if(e.getBoundingClientRect){var s=n.createElement("boundtest");s.style.height=t+"px",s.style.display="block",n.body.appendChild(s),e.selectNode(s);var i=e.getBoundingClientRect(),r=Math.round(i.height);if(n.body.removeChild(s),r===t)return!0}}return!1},kP=function(n){var t=n.createElement("boundtest");t.style.width="50px",t.style.display="block",t.style.fontSize="12px",t.style.letterSpacing="0px",t.style.wordSpacing="0px",n.body.appendChild(t);var e=n.createRange();t.innerHTML=typeof"".repeat=="function"?"&#128104;".repeat(10):"";var s=t.firstChild,i=hu(s.data).map(function(a){return ce(a)}),r=0,o={},A=i.every(function(a,l){e.setStart(s,r),e.setEnd(s,r+a.length);var c=e.getBoundingClientRect();r+=a.length;var u=c.x>o.x||c.y>o.y;return o=c,l===0?!0:u});return n.body.removeChild(t),A},RP=function(){return typeof new Image().crossOrigin<"u"},HP=function(){return typeof new XMLHttpRequest().responseType=="string"},OP=function(n){var t=new Image,e=n.createElement("canvas"),s=e.getContext("2d");if(!s)return!1;t.src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'></svg>";try{s.drawImage(t,0,0),e.toDataURL()}catch{return!1}return!0},zg=function(n){return n[0]===0&&n[1]===255&&n[2]===0&&n[3]===255},VP=function(n){var t=n.createElement("canvas"),e=100;t.width=e,t.height=e;var s=t.getContext("2d");if(!s)return Promise.reject(!1);s.fillStyle="rgb(0, 255, 0)",s.fillRect(0,0,e,e);var i=new Image,r=t.toDataURL();i.src=r;var o=bh(e,e,0,0,i);return s.fillStyle="red",s.fillRect(0,0,e,e),Xg(o).then(function(A){s.drawImage(A,0,0);var a=s.getImageData(0,0,e,e).data;s.fillStyle="red",s.fillRect(0,0,e,e);var l=n.createElement("div");return l.style.backgroundImage="url("+r+")",l.style.height=e+"px",zg(a)?Xg(bh(e,e,0,0,l)):Promise.reject(!1)}).then(function(A){return s.drawImage(A,0,0),zg(s.getImageData(0,0,e,e).data)}).catch(function(){return!1})},bh=function(n,t,e,s,i){var r="http://www.w3.org/2000/svg",o=document.createElementNS(r,"svg"),A=document.createElementNS(r,"foreignObject");return o.setAttributeNS(null,"width",n.toString()),o.setAttributeNS(null,"height",t.toString()),A.setAttributeNS(null,"width","100%"),A.setAttributeNS(null,"height","100%"),A.setAttributeNS(null,"x",e.toString()),A.setAttributeNS(null,"y",s.toString()),A.setAttributeNS(null,"externalResourcesRequired","true"),o.appendChild(A),A.appendChild(i),o},Xg=function(n){return new Promise(function(t,e){var s=new Image;s.onload=function(){return t(s)},s.onerror=e,s.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(new XMLSerializer().serializeToString(n))})},Ie={get SUPPORT_RANGE_BOUNDS(){var n=LP(document);return Object.defineProperty(Ie,"SUPPORT_RANGE_BOUNDS",{value:n}),n},get SUPPORT_WORD_BREAKING(){var n=Ie.SUPPORT_RANGE_BOUNDS&&kP(document);return Object.defineProperty(Ie,"SUPPORT_WORD_BREAKING",{value:n}),n},get SUPPORT_SVG_DRAWING(){var n=OP(document);return Object.defineProperty(Ie,"SUPPORT_SVG_DRAWING",{value:n}),n},get SUPPORT_FOREIGNOBJECT_DRAWING(){var n=typeof Array.from=="function"&&typeof window.fetch=="function"?VP(document):Promise.resolve(!1);return Object.defineProperty(Ie,"SUPPORT_FOREIGNOBJECT_DRAWING",{value:n}),n},get SUPPORT_CORS_IMAGES(){var n=RP();return Object.defineProperty(Ie,"SUPPORT_CORS_IMAGES",{value:n}),n},get SUPPORT_RESPONSE_TYPE(){var n=HP();return Object.defineProperty(Ie,"SUPPORT_RESPONSE_TYPE",{value:n}),n},get SUPPORT_CORS_XHR(){var n="withCredentials"in new XMLHttpRequest;return Object.defineProperty(Ie,"SUPPORT_CORS_XHR",{value:n}),n},get SUPPORT_NATIVE_TEXT_SEGMENTATION(){var n=!!(typeof Intl<"u"&&Intl.Segmenter);return Object.defineProperty(Ie,"SUPPORT_NATIVE_TEXT_SEGMENTATION",{value:n}),n}},IA=(function(){function n(t,e){this.text=t,this.bounds=e}return n})(),WP=function(n,t,e,s){var i=qP(t,e),r=[],o=0;return i.forEach(function(A){if(e.textDecorationLine.length||A.trim().length>0)if(Ie.SUPPORT_RANGE_BOUNDS){var a=$g(s,o,A.length).getClientRects();if(a.length>1){var l=mp(A),c=0;l.forEach(function(d){r.push(new IA(d,oi.fromDOMRectList(n,$g(s,c+o,d.length).getClientRects()))),c+=d.length})}else r.push(new IA(A,oi.fromDOMRectList(n,a)))}else{var u=s.splitText(A.length);r.push(new IA(A,GP(n,s))),s=u}else Ie.SUPPORT_RANGE_BOUNDS||(s=s.splitText(A.length));o+=A.length}),r},GP=function(n,t){var e=t.ownerDocument;if(e){var s=e.createElement("html2canvaswrapper");s.appendChild(t.cloneNode(!0));var i=t.parentNode;if(i){i.replaceChild(s,t);var r=du(n,s);return s.firstChild&&i.replaceChild(s.firstChild,s),r}}return oi.EMPTY},$g=function(n,t,e){var s=n.ownerDocument;if(!s)throw new Error("Node has no owner document");var i=s.createRange();return i.setStart(n,t),i.setEnd(n,t+e),i},mp=function(n){if(Ie.SUPPORT_NATIVE_TEXT_SEGMENTATION){var t=new Intl.Segmenter(void 0,{granularity:"grapheme"});return Array.from(t.segment(n)).map(function(e){return e.segment})}return DP(n)},KP=function(n,t){if(Ie.SUPPORT_NATIVE_TEXT_SEGMENTATION){var e=new Intl.Segmenter(void 0,{granularity:"word"});return Array.from(e.segment(n)).map(function(s){return s.segment})}return XP(n,t)},qP=function(n,t){return t.letterSpacing!==0?mp(n):KP(n,t)},zP=[32,160,4961,65792,65793,4153,4241],XP=function(n,t){for(var e=CM(n,{lineBreak:t.lineBreak,wordBreak:t.overflowWrap==="break-word"?"break-word":t.wordBreak}),s=[],i,r=function(){if(i.value){var o=i.value.slice(),A=hu(o),a="";A.forEach(function(l){zP.indexOf(l)===-1?a+=ce(l):(a.length&&s.push(a),s.push(ce(l)),a="")}),a.length&&s.push(a)}};!(i=e.next()).done;)r();return s},$P=(function(){function n(t,e,s){this.text=YP(e.data,s.textTransform),this.textBounds=WP(t,this.text,s,e)}return n})(),YP=function(n,t){switch(t){case 1:return n.toLowerCase();case 3:return n.replace(jP,JP);case 2:return n.toUpperCase();default:return n}},jP=/(^|\s|:|-|\(|\))([a-z])/g,JP=function(n,t,e){return n.length>0?t+e.toUpperCase():n},WB=(function(n){As(t,n);function t(e,s){var i=n.call(this,e,s)||this;return i.src=s.currentSrc||s.src,i.intrinsicWidth=s.naturalWidth,i.intrinsicHeight=s.naturalHeight,i.context.cache.addImage(i.src),i}return t})(Ds),GB=(function(n){As(t,n);function t(e,s){var i=n.call(this,e,s)||this;return i.canvas=s,i.intrinsicWidth=s.width,i.intrinsicHeight=s.height,i}return t})(Ds),KB=(function(n){As(t,n);function t(e,s){var i=n.call(this,e,s)||this,r=new XMLSerializer,o=du(e,s);return s.setAttribute("width",o.width+"px"),s.setAttribute("height",o.height+"px"),i.svg="data:image/svg+xml,"+encodeURIComponent(r.serializeToString(s)),i.intrinsicWidth=s.width.baseVal.value,i.intrinsicHeight=s.height.baseVal.value,i.context.cache.addImage(i.svg),i}return t})(Ds),qB=(function(n){As(t,n);function t(e,s){var i=n.call(this,e,s)||this;return i.value=s.value,i}return t})(Ds),yh=(function(n){As(t,n);function t(e,s){var i=n.call(this,e,s)||this;return i.start=s.start,i.reversed=typeof s.reversed=="boolean"&&s.reversed===!0,i}return t})(Ds),ZP=[{type:15,flags:0,unit:"px",number:3}],t4=[{type:16,flags:0,number:50}],e4=function(n){return n.width>n.height?new oi(n.left+(n.width-n.height)/2,n.top,n.height,n.height):n.width<n.height?new oi(n.left,n.top+(n.height-n.width)/2,n.width,n.width):n},n4=function(n){var t=n.type===s4?new Array(n.value.length+1).join(""):n.value;return t.length===0?n.placeholder||"":t},hc="checkbox",fc="radio",s4="password",Yg=707406591,gp=(function(n){As(t,n);function t(e,s){var i=n.call(this,e,s)||this;switch(i.type=s.type.toLowerCase(),i.checked=s.checked,i.value=n4(s),(i.type===hc||i.type===fc)&&(i.styles.backgroundColor=3739148031,i.styles.borderTopColor=i.styles.borderRightColor=i.styles.borderBottomColor=i.styles.borderLeftColor=2779096575,i.styles.borderTopWidth=i.styles.borderRightWidth=i.styles.borderBottomWidth=i.styles.borderLeftWidth=1,i.styles.borderTopStyle=i.styles.borderRightStyle=i.styles.borderBottomStyle=i.styles.borderLeftStyle=1,i.styles.backgroundClip=[0],i.styles.backgroundOrigin=[0],i.bounds=e4(i.bounds)),i.type){case hc:i.styles.borderTopRightRadius=i.styles.borderTopLeftRadius=i.styles.borderBottomRightRadius=i.styles.borderBottomLeftRadius=ZP;break;case fc:i.styles.borderTopRightRadius=i.styles.borderTopLeftRadius=i.styles.borderBottomRightRadius=i.styles.borderBottomLeftRadius=t4;break}return i}return t})(Ds),zB=(function(n){As(t,n);function t(e,s){var i=n.call(this,e,s)||this,r=s.options[s.selectedIndex||0];return i.value=r&&r.text||"",i}return t})(Ds),XB=(function(n){As(t,n);function t(e,s){var i=n.call(this,e,s)||this;return i.value=s.value,i}return t})(Ds),$B=(function(n){As(t,n);function t(e,s){var i=n.call(this,e,s)||this;i.src=s.src,i.width=parseInt(s.width,10)||0,i.height=parseInt(s.height,10)||0,i.backgroundColor=i.styles.backgroundColor;try{if(s.contentWindow&&s.contentWindow.document&&s.contentWindow.document.documentElement){i.tree=jB(e,s.contentWindow.document.documentElement);var r=s.contentWindow.document.documentElement?xA(e,getComputedStyle(s.contentWindow.document.documentElement).backgroundColor):ti.TRANSPARENT,o=s.contentWindow.document.body?xA(e,getComputedStyle(s.contentWindow.document.body).backgroundColor):ti.TRANSPARENT;i.backgroundColor=Ni(r)?Ni(o)?i.styles.backgroundColor:o:r}}catch{}return i}return t})(Ds),i4=["OL","UL","MENU"],Ul=function(n,t,e,s){for(var i=t.firstChild,r=void 0;i;i=r)if(r=i.nextSibling,JB(i)&&i.data.trim().length>0)e.textNodes.push(new $P(n,i,e.styles));else if(no(i))if(nC(i)&&i.assignedNodes)i.assignedNodes().forEach(function(A){return Ul(n,A,e,s)});else{var o=YB(n,i);o.styles.isVisible()&&(r4(i,o,s)?o.flags|=4:o4(o.styles)&&(o.flags|=2),i4.indexOf(i.tagName)!==-1&&(o.flags|=8),e.elements.push(o),i.slot,i.shadowRoot?Ul(n,i.shadowRoot,o,s):!pc(i)&&!ZB(i)&&!mc(i)&&Ul(n,i,o,s))}},YB=function(n,t){return Eh(t)?new WB(n,t):tC(t)?new GB(n,t):ZB(t)?new KB(n,t):A4(t)?new qB(n,t):a4(t)?new yh(n,t):l4(t)?new gp(n,t):mc(t)?new zB(n,t):pc(t)?new XB(n,t):eC(t)?new $B(n,t):new Ds(n,t)},jB=function(n,t){var e=YB(n,t);return e.flags|=4,Ul(n,t,e,e),e},r4=function(n,t,e){return t.styles.isPositionedWithZIndex()||t.styles.opacity<1||t.styles.isTransformed()||wp(n)&&e.styles.isTransparent()},o4=function(n){return n.isPositioned()||n.isFloating()},JB=function(n){return n.nodeType===Node.TEXT_NODE},no=function(n){return n.nodeType===Node.ELEMENT_NODE},Sh=function(n){return no(n)&&typeof n.style<"u"&&!Pl(n)},Pl=function(n){return typeof n.className=="object"},A4=function(n){return n.tagName==="LI"},a4=function(n){return n.tagName==="OL"},l4=function(n){return n.tagName==="INPUT"},c4=function(n){return n.tagName==="HTML"},ZB=function(n){return n.tagName==="svg"},wp=function(n){return n.tagName==="BODY"},tC=function(n){return n.tagName==="CANVAS"},jg=function(n){return n.tagName==="VIDEO"},Eh=function(n){return n.tagName==="IMG"},eC=function(n){return n.tagName==="IFRAME"},Jg=function(n){return n.tagName==="STYLE"},u4=function(n){return n.tagName==="SCRIPT"},pc=function(n){return n.tagName==="TEXTAREA"},mc=function(n){return n.tagName==="SELECT"},nC=function(n){return n.tagName==="SLOT"},Zg=function(n){return n.tagName.indexOf("-")>0},d4=(function(){function n(){this.counters={}}return n.prototype.getCounterValue=function(t){var e=this.counters[t];return e&&e.length?e[e.length-1]:1},n.prototype.getCounterValues=function(t){var e=this.counters[t];return e||[]},n.prototype.pop=function(t){var e=this;t.forEach(function(s){return e.counters[s].pop()})},n.prototype.parse=function(t){var e=this,s=t.counterIncrement,i=t.counterReset,r=!0;s!==null&&s.forEach(function(A){var a=e.counters[A.counter];a&&A.increment!==0&&(r=!1,a.length||a.push(1),a[Math.max(0,a.length-1)]+=A.increment)});var o=[];return r&&i.forEach(function(A){var a=e.counters[A.counter];o.push(A.counter),a||(a=e.counters[A.counter]=[]),a.push(A.reset)}),o},n})(),t0={integers:[1e3,900,500,400,100,90,50,40,10,9,5,4,1],values:["M","CM","D","CD","C","XC","L","XL","X","IX","V","IV","I"]},e0={integers:[9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,900,800,700,600,500,400,300,200,100,90,80,70,60,50,40,30,20,10,9,8,7,6,5,4,3,2,1],values:["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""]},h4={integers:[1e4,9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,400,300,200,100,90,80,70,60,50,40,30,20,19,18,17,16,15,10,9,8,7,6,5,4,3,2,1],values:["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""]},f4={integers:[1e4,9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,900,800,700,600,500,400,300,200,100,90,80,70,60,50,40,30,20,10,9,8,7,6,5,4,3,2,1],values:["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""]},Hr=function(n,t,e,s,i,r){return n<t||n>e?sa(n,i,r.length>0):s.integers.reduce(function(o,A,a){for(;n>=A;)n-=A,o+=s.values[a];return o},"")+r},sC=function(n,t,e,s){var i="";do e||n--,i=s(n)+i,n/=t;while(n*t>=t);return i},le=function(n,t,e,s,i){var r=e-t+1;return(n<0?"-":"")+(sC(Math.abs(n),r,s,function(o){return ce(Math.floor(o%r)+t)})+i)},Yi=function(n,t,e){e===void 0&&(e=". ");var s=t.length;return sC(Math.abs(n),s,!1,function(i){return t[Math.floor(i%s)]})+e},Xr=1,mi=2,gi=4,uA=8,Rs=function(n,t,e,s,i,r){if(n<-9999||n>9999)return sa(n,4,i.length>0);var o=Math.abs(n),A=i;if(o===0)return t[0]+A;for(var a=0;o>0&&a<=4;a++){var l=o%10;l===0&&Ce(r,Xr)&&A!==""?A=t[l]+A:l>1||l===1&&a===0||l===1&&a===1&&Ce(r,mi)||l===1&&a===1&&Ce(r,gi)&&n>100||l===1&&a>1&&Ce(r,uA)?A=t[l]+(a>0?e[a-1]:"")+A:l===1&&a>0&&(A=e[a-1]+A),o=Math.floor(o/10)}return(n<0?s:"")+A},n0="",s0="",i0="",dd="",sa=function(n,t,e){var s=e?". ":"",i=e?"":"",r=e?", ":"",o=e?" ":"";switch(t){case 0:return""+o;case 1:return""+o;case 2:return""+o;case 5:var A=le(n,48,57,!0,s);return A.length<4?"0"+A:A;case 4:return Yi(n,"",i);case 6:return Hr(n,1,3999,t0,3,s).toLowerCase();case 7:return Hr(n,1,3999,t0,3,s);case 8:return le(n,945,969,!1,s);case 9:return le(n,97,122,!1,s);case 10:return le(n,65,90,!1,s);case 11:return le(n,1632,1641,!0,s);case 12:case 49:return Hr(n,1,9999,e0,3,s);case 35:return Hr(n,1,9999,e0,3,s).toLowerCase();case 13:return le(n,2534,2543,!0,s);case 14:case 30:return le(n,6112,6121,!0,s);case 15:return Yi(n,"",i);case 16:return Yi(n,"",i);case 17:case 48:return Rs(n,"",n0,"",i,mi|gi|uA);case 47:return Rs(n,"",s0,"",i,Xr|mi|gi|uA);case 42:return Rs(n,"",n0,"",i,mi|gi|uA);case 41:return Rs(n,"",s0,"",i,Xr|mi|gi|uA);case 26:return Rs(n,"","",i0,i,0);case 25:return Rs(n,"","",i0,i,Xr|mi|gi);case 31:return Rs(n,"","",dd,r,Xr|mi|gi);case 33:return Rs(n,"","",dd,r,0);case 32:return Rs(n,"","",dd,r,Xr|mi|gi);case 18:return le(n,2406,2415,!0,s);case 20:return Hr(n,1,19999,f4,3,s);case 21:return le(n,2790,2799,!0,s);case 22:return le(n,2662,2671,!0,s);case 22:return Hr(n,1,10999,h4,3,s);case 23:return Yi(n,"");case 24:return Yi(n,"");case 27:return le(n,3302,3311,!0,s);case 28:return Yi(n,"",i);case 29:return Yi(n,"",i);case 34:return le(n,3792,3801,!0,s);case 37:return le(n,6160,6169,!0,s);case 38:return le(n,4160,4169,!0,s);case 39:return le(n,2918,2927,!0,s);case 40:return le(n,1776,1785,!0,s);case 43:return le(n,3046,3055,!0,s);case 44:return le(n,3174,3183,!0,s);case 45:return le(n,3664,3673,!0,s);case 46:return le(n,3872,3881,!0,s);case 3:default:return le(n,48,57,!0,s)}},iC="data-html2canvas-ignore",r0=(function(){function n(t,e,s){if(this.context=t,this.options=s,this.scrolledElements=[],this.referenceElement=e,this.counters=new d4,this.quoteDepth=0,!e.ownerDocument)throw new Error("Cloned element does not have an owner document");this.documentElement=this.cloneNode(e.ownerDocument.documentElement,!1)}return n.prototype.toIFrame=function(t,e){var s=this,i=p4(t,e);if(!i.contentWindow)return Promise.reject("Unable to find iframe window");var r=t.defaultView.pageXOffset,o=t.defaultView.pageYOffset,A=i.contentWindow,a=A.document,l=w4(i).then(function(){return qe(s,void 0,void 0,function(){var c,u;return Ne(this,function(d){switch(d.label){case 0:return this.scrolledElements.forEach(b4),A&&(A.scrollTo(e.left,e.top),/(iPad|iPhone|iPod)/g.test(navigator.userAgent)&&(A.scrollY!==e.top||A.scrollX!==e.left)&&(this.context.logger.warn("Unable to restore scroll position for cloned document"),this.context.windowBounds=this.context.windowBounds.add(A.scrollX-e.left,A.scrollY-e.top,0,0))),c=this.options.onclone,u=this.clonedReferenceElement,typeof u>"u"?[2,Promise.reject("Error finding the "+this.referenceElement.nodeName+" in the cloned document")]:a.fonts&&a.fonts.ready?[4,a.fonts.ready]:[3,2];case 1:d.sent(),d.label=2;case 2:return/(AppleWebKit)/g.test(navigator.userAgent)?[4,g4(a)]:[3,4];case 3:d.sent(),d.label=4;case 4:return typeof c=="function"?[2,Promise.resolve().then(function(){return c(a,u)}).then(function(){return i})]:[2,i]}})})});return a.open(),a.write(B4(document.doctype)+"<html></html>"),C4(this.referenceElement.ownerDocument,r,o),a.replaceChild(a.adoptNode(this.documentElement),a.documentElement),a.close(),l},n.prototype.createElementClone=function(t){if(Ch(t,2))debugger;if(tC(t))return this.createCanvasClone(t);if(jg(t))return this.createVideoClone(t);if(Jg(t))return this.createStyleClone(t);var e=t.cloneNode(!1);return Eh(e)&&(Eh(t)&&t.currentSrc&&t.currentSrc!==t.src&&(e.src=t.currentSrc,e.srcset=""),e.loading==="lazy"&&(e.loading="eager")),Zg(e)?this.createCustomElementClone(e):e},n.prototype.createCustomElementClone=function(t){var e=document.createElement("html2canvascustomelement");return hd(t.style,e),e},n.prototype.createStyleClone=function(t){try{var e=t.sheet;if(e&&e.cssRules){var s=[].slice.call(e.cssRules,0).reduce(function(r,o){return o&&typeof o.cssText=="string"?r+o.cssText:r},""),i=t.cloneNode(!1);return i.textContent=s,i}}catch(r){if(this.context.logger.error("Unable to access cssRules property",r),r.name!=="SecurityError")throw r}return t.cloneNode(!1)},n.prototype.createCanvasClone=function(t){var e;if(this.options.inlineImages&&t.ownerDocument){var s=t.ownerDocument.createElement("img");try{return s.src=t.toDataURL(),s}catch{this.context.logger.info("Unable to inline canvas contents, canvas is tainted",t)}}var i=t.cloneNode(!1);try{i.width=t.width,i.height=t.height;var r=t.getContext("2d"),o=i.getContext("2d");if(o)if(!this.options.allowTaint&&r)o.putImageData(r.getImageData(0,0,t.width,t.height),0,0);else{var A=(e=t.getContext("webgl2"))!==null&&e!==void 0?e:t.getContext("webgl");if(A){var a=A.getContextAttributes();(a==null?void 0:a.preserveDrawingBuffer)===!1&&this.context.logger.warn("Unable to clone WebGL context as it has preserveDrawingBuffer=false",t)}o.drawImage(t,0,0)}return i}catch{this.context.logger.info("Unable to clone canvas as it is tainted",t)}return i},n.prototype.createVideoClone=function(t){var e=t.ownerDocument.createElement("canvas");e.width=t.offsetWidth,e.height=t.offsetHeight;var s=e.getContext("2d");try{return s&&(s.drawImage(t,0,0,e.width,e.height),this.options.allowTaint||s.getImageData(0,0,e.width,e.height)),e}catch{this.context.logger.info("Unable to clone video as it is tainted",t)}var i=t.ownerDocument.createElement("canvas");return i.width=t.offsetWidth,i.height=t.offsetHeight,i},n.prototype.appendChildNode=function(t,e,s){(!no(e)||!u4(e)&&!e.hasAttribute(iC)&&(typeof this.options.ignoreElements!="function"||!this.options.ignoreElements(e)))&&(!this.options.copyStyles||!no(e)||!Jg(e))&&t.appendChild(this.cloneNode(e,s))},n.prototype.cloneChildNodes=function(t,e,s){for(var i=this,r=t.shadowRoot?t.shadowRoot.firstChild:t.firstChild;r;r=r.nextSibling)if(no(r)&&nC(r)&&typeof r.assignedNodes=="function"){var o=r.assignedNodes();o.length&&o.forEach(function(A){return i.appendChildNode(e,A,s)})}else this.appendChildNode(e,r,s)},n.prototype.cloneNode=function(t,e){if(JB(t))return document.createTextNode(t.data);if(!t.ownerDocument)return t.cloneNode(!1);var s=t.ownerDocument.defaultView;if(s&&no(t)&&(Sh(t)||Pl(t))){var i=this.createElementClone(t);i.style.transitionProperty="none";var r=s.getComputedStyle(t),o=s.getComputedStyle(t,":before"),A=s.getComputedStyle(t,":after");this.referenceElement===t&&Sh(i)&&(this.clonedReferenceElement=i),wp(i)&&E4(i);var a=this.counters.parse(new Dg(this.context,r)),l=this.resolvePseudoContent(t,i,o,FA.BEFORE);Zg(t)&&(e=!0),jg(t)||this.cloneChildNodes(t,i,e),l&&i.insertBefore(l,i.firstChild);var c=this.resolvePseudoContent(t,i,A,FA.AFTER);return c&&i.appendChild(c),this.counters.pop(a),(r&&(this.options.copyStyles||Pl(t))&&!eC(t)||e)&&hd(r,i),(t.scrollTop!==0||t.scrollLeft!==0)&&this.scrolledElements.push([i,t.scrollLeft,t.scrollTop]),(pc(t)||mc(t))&&(pc(i)||mc(i))&&(i.value=t.value),i}return t.cloneNode(!1)},n.prototype.resolvePseudoContent=function(t,e,s,i){var r=this;if(s){var o=s.content,A=e.ownerDocument;if(!(!A||!o||o==="none"||o==="-moz-alt-content"||s.display==="none")){this.counters.parse(new Dg(this.context,s));var a=new AP(this.context,s),l=A.createElement("html2canvaspseudoelement");hd(s,l),a.content.forEach(function(u){if(u.type===0)l.appendChild(A.createTextNode(u.value));else if(u.type===22){var d=A.createElement("img");d.src=u.value,d.style.opacity="1",l.appendChild(d)}else if(u.type===18){if(u.name==="attr"){var p=u.values.filter(Vt);p.length&&l.appendChild(A.createTextNode(t.getAttribute(p[0].value)||""))}else if(u.name==="counter"){var f=u.values.filter(To),m=f[0],g=f[1];if(m&&Vt(m)){var w=r.counters.getCounterValue(m.value),B=g&&Vt(g)?Bh.parse(r.context,g.value):3;l.appendChild(A.createTextNode(sa(w,B,!1)))}}else if(u.name==="counters"){var b=u.values.filter(To),m=b[0],_=b[1],g=b[2];if(m&&Vt(m)){var v=r.counters.getCounterValues(m.value),C=g&&Vt(g)?Bh.parse(r.context,g.value):3,y=_&&_.type===0?_.value:"",S=v.map(function(Q){return sa(Q,C,!1)}).join(y);l.appendChild(A.createTextNode(S))}}}else if(u.type===20)switch(u.value){case"open-quote":l.appendChild(A.createTextNode(Ng(a.quotes,r.quoteDepth++,!0)));break;case"close-quote":l.appendChild(A.createTextNode(Ng(a.quotes,--r.quoteDepth,!1)));break;default:l.appendChild(A.createTextNode(u.value))}}),l.className=xh+" "+_h;var c=i===FA.BEFORE?" "+xh:" "+_h;return Pl(e)?e.className.baseValue+=c:e.className+=c,l}}},n.destroy=function(t){return t.parentNode?(t.parentNode.removeChild(t),!0):!1},n})(),FA;(function(n){n[n.BEFORE=0]="BEFORE",n[n.AFTER=1]="AFTER"})(FA||(FA={}));var p4=function(n,t){var e=n.createElement("iframe");return e.className="html2canvas-container",e.style.visibility="hidden",e.style.position="fixed",e.style.left="-10000px",e.style.top="0px",e.style.border="0",e.width=t.width.toString(),e.height=t.height.toString(),e.scrolling="no",e.setAttribute(iC,"true"),n.body.appendChild(e),e},m4=function(n){return new Promise(function(t){if(n.complete){t();return}if(!n.src){t();return}n.onload=t,n.onerror=t})},g4=function(n){return Promise.all([].slice.call(n.images,0).map(m4))},w4=function(n){return new Promise(function(t,e){var s=n.contentWindow;if(!s)return e("No window assigned for iframe");var i=s.document;s.onload=n.onload=function(){s.onload=n.onload=null;var r=setInterval(function(){i.body.childNodes.length>0&&i.readyState==="complete"&&(clearInterval(r),t(n))},50)}})},v4=["all","d","content"],hd=function(n,t){for(var e=n.length-1;e>=0;e--){var s=n.item(e);v4.indexOf(s)===-1&&t.style.setProperty(s,n.getPropertyValue(s))}return t},B4=function(n){var t="";return n&&(t+="<!DOCTYPE ",n.name&&(t+=n.name),n.internalSubset&&(t+=n.internalSubset),n.publicId&&(t+='"'+n.publicId+'"'),n.systemId&&(t+='"'+n.systemId+'"'),t+=">"),t},C4=function(n,t,e){n&&n.defaultView&&(t!==n.defaultView.pageXOffset||e!==n.defaultView.pageYOffset)&&n.defaultView.scrollTo(t,e)},b4=function(n){var t=n[0],e=n[1],s=n[2];t.scrollLeft=e,t.scrollTop=s},y4=":before",S4=":after",xh="___html2canvas___pseudoelement_before",_h="___html2canvas___pseudoelement_after",o0=`{
    content: "" !important;
    display: none !important;
}`,E4=function(n){x4(n,"."+xh+y4+o0+`
         .`+_h+S4+o0)},x4=function(n,t){var e=n.ownerDocument;if(e){var s=e.createElement("style");s.textContent=t,n.appendChild(s)}},rC=(function(){function n(){}return n.getOrigin=function(t){var e=n._link;return e?(e.href=t,e.href=e.href,e.protocol+e.hostname+e.port):"about:blank"},n.isSameOrigin=function(t){return n.getOrigin(t)===n._origin},n.setContext=function(t){n._link=t.document.createElement("a"),n._origin=n.getOrigin(t.location.href)},n._origin="about:blank",n})(),_4=(function(){function n(t,e){this.context=t,this._options=e,this._cache={}}return n.prototype.addImage=function(t){var e=Promise.resolve();return this.has(t)||(pd(t)||Q4(t))&&(this._cache[t]=this.loadImage(t)).catch(function(){}),e},n.prototype.match=function(t){return this._cache[t]},n.prototype.loadImage=function(t){return qe(this,void 0,void 0,function(){var e,s,i,r,o=this;return Ne(this,function(A){switch(A.label){case 0:return e=rC.isSameOrigin(t),s=!fd(t)&&this._options.useCORS===!0&&Ie.SUPPORT_CORS_IMAGES&&!e,i=!fd(t)&&!e&&!pd(t)&&typeof this._options.proxy=="string"&&Ie.SUPPORT_CORS_XHR&&!s,!e&&this._options.allowTaint===!1&&!fd(t)&&!pd(t)&&!i&&!s?[2]:(r=t,i?[4,this.proxy(r)]:[3,2]);case 1:r=A.sent(),A.label=2;case 2:return this.context.logger.debug("Added image "+t.substring(0,256)),[4,new Promise(function(a,l){var c=new Image;c.onload=function(){return a(c)},c.onerror=l,(M4(r)||s)&&(c.crossOrigin="anonymous"),c.src=r,c.complete===!0&&setTimeout(function(){return a(c)},500),o._options.imageTimeout>0&&setTimeout(function(){return l("Timed out ("+o._options.imageTimeout+"ms) loading image")},o._options.imageTimeout)})];case 3:return[2,A.sent()]}})})},n.prototype.has=function(t){return typeof this._cache[t]<"u"},n.prototype.keys=function(){return Promise.resolve(Object.keys(this._cache))},n.prototype.proxy=function(t){var e=this,s=this._options.proxy;if(!s)throw new Error("No proxy defined");var i=t.substring(0,256);return new Promise(function(r,o){var A=Ie.SUPPORT_RESPONSE_TYPE?"blob":"text",a=new XMLHttpRequest;a.onload=function(){if(a.status===200)if(A==="text")r(a.response);else{var u=new FileReader;u.addEventListener("load",function(){return r(u.result)},!1),u.addEventListener("error",function(d){return o(d)},!1),u.readAsDataURL(a.response)}else o("Failed to proxy resource "+i+" with status code "+a.status)},a.onerror=o;var l=s.indexOf("?")>-1?"&":"?";if(a.open("GET",""+s+l+"url="+encodeURIComponent(t)+"&responseType="+A),A!=="text"&&a instanceof XMLHttpRequest&&(a.responseType=A),e._options.imageTimeout){var c=e._options.imageTimeout;a.timeout=c,a.ontimeout=function(){return o("Timed out ("+c+"ms) proxying "+i)}}a.send()})},n})(),I4=/^data:image\/svg\+xml/i,F4=/^data:image\/.*;base64,/i,T4=/^data:image\/.*/i,Q4=function(n){return Ie.SUPPORT_SVG_DRAWING||!U4(n)},fd=function(n){return T4.test(n)},M4=function(n){return F4.test(n)},pd=function(n){return n.substr(0,4)==="blob"},U4=function(n){return n.substr(-3).toLowerCase()==="svg"||I4.test(n)},ot=(function(){function n(t,e){this.type=0,this.x=t,this.y=e}return n.prototype.add=function(t,e){return new n(this.x+t,this.y+e)},n})(),Or=function(n,t,e){return new ot(n.x+(t.x-n.x)*e,n.y+(t.y-n.y)*e)},ll=(function(){function n(t,e,s,i){this.type=1,this.start=t,this.startControl=e,this.endControl=s,this.end=i}return n.prototype.subdivide=function(t,e){var s=Or(this.start,this.startControl,t),i=Or(this.startControl,this.endControl,t),r=Or(this.endControl,this.end,t),o=Or(s,i,t),A=Or(i,r,t),a=Or(o,A,t);return e?new n(this.start,s,o,a):new n(a,A,r,this.end)},n.prototype.add=function(t,e){return new n(this.start.add(t,e),this.startControl.add(t,e),this.endControl.add(t,e),this.end.add(t,e))},n.prototype.reverse=function(){return new n(this.end,this.endControl,this.startControl,this.start)},n})(),Un=function(n){return n.type===1},P4=(function(){function n(t){var e=t.styles,s=t.bounds,i=lA(e.borderTopLeftRadius,s.width,s.height),r=i[0],o=i[1],A=lA(e.borderTopRightRadius,s.width,s.height),a=A[0],l=A[1],c=lA(e.borderBottomRightRadius,s.width,s.height),u=c[0],d=c[1],p=lA(e.borderBottomLeftRadius,s.width,s.height),f=p[0],m=p[1],g=[];g.push((r+a)/s.width),g.push((f+u)/s.width),g.push((o+m)/s.height),g.push((l+d)/s.height);var w=Math.max.apply(Math,g);w>1&&(r/=w,o/=w,a/=w,l/=w,u/=w,d/=w,f/=w,m/=w);var B=s.width-a,b=s.height-d,_=s.width-u,v=s.height-m,C=e.borderTopWidth,y=e.borderRightWidth,S=e.borderBottomWidth,F=e.borderLeftWidth,x=zt(e.paddingTop,t.bounds.width),Q=zt(e.paddingRight,t.bounds.width),T=zt(e.paddingBottom,t.bounds.width),U=zt(e.paddingLeft,t.bounds.width);this.topLeftBorderDoubleOuterBox=r>0||o>0?Zt(s.left+F/3,s.top+C/3,r-F/3,o-C/3,Nt.TOP_LEFT):new ot(s.left+F/3,s.top+C/3),this.topRightBorderDoubleOuterBox=r>0||o>0?Zt(s.left+B,s.top+C/3,a-y/3,l-C/3,Nt.TOP_RIGHT):new ot(s.left+s.width-y/3,s.top+C/3),this.bottomRightBorderDoubleOuterBox=u>0||d>0?Zt(s.left+_,s.top+b,u-y/3,d-S/3,Nt.BOTTOM_RIGHT):new ot(s.left+s.width-y/3,s.top+s.height-S/3),this.bottomLeftBorderDoubleOuterBox=f>0||m>0?Zt(s.left+F/3,s.top+v,f-F/3,m-S/3,Nt.BOTTOM_LEFT):new ot(s.left+F/3,s.top+s.height-S/3),this.topLeftBorderDoubleInnerBox=r>0||o>0?Zt(s.left+F*2/3,s.top+C*2/3,r-F*2/3,o-C*2/3,Nt.TOP_LEFT):new ot(s.left+F*2/3,s.top+C*2/3),this.topRightBorderDoubleInnerBox=r>0||o>0?Zt(s.left+B,s.top+C*2/3,a-y*2/3,l-C*2/3,Nt.TOP_RIGHT):new ot(s.left+s.width-y*2/3,s.top+C*2/3),this.bottomRightBorderDoubleInnerBox=u>0||d>0?Zt(s.left+_,s.top+b,u-y*2/3,d-S*2/3,Nt.BOTTOM_RIGHT):new ot(s.left+s.width-y*2/3,s.top+s.height-S*2/3),this.bottomLeftBorderDoubleInnerBox=f>0||m>0?Zt(s.left+F*2/3,s.top+v,f-F*2/3,m-S*2/3,Nt.BOTTOM_LEFT):new ot(s.left+F*2/3,s.top+s.height-S*2/3),this.topLeftBorderStroke=r>0||o>0?Zt(s.left+F/2,s.top+C/2,r-F/2,o-C/2,Nt.TOP_LEFT):new ot(s.left+F/2,s.top+C/2),this.topRightBorderStroke=r>0||o>0?Zt(s.left+B,s.top+C/2,a-y/2,l-C/2,Nt.TOP_RIGHT):new ot(s.left+s.width-y/2,s.top+C/2),this.bottomRightBorderStroke=u>0||d>0?Zt(s.left+_,s.top+b,u-y/2,d-S/2,Nt.BOTTOM_RIGHT):new ot(s.left+s.width-y/2,s.top+s.height-S/2),this.bottomLeftBorderStroke=f>0||m>0?Zt(s.left+F/2,s.top+v,f-F/2,m-S/2,Nt.BOTTOM_LEFT):new ot(s.left+F/2,s.top+s.height-S/2),this.topLeftBorderBox=r>0||o>0?Zt(s.left,s.top,r,o,Nt.TOP_LEFT):new ot(s.left,s.top),this.topRightBorderBox=a>0||l>0?Zt(s.left+B,s.top,a,l,Nt.TOP_RIGHT):new ot(s.left+s.width,s.top),this.bottomRightBorderBox=u>0||d>0?Zt(s.left+_,s.top+b,u,d,Nt.BOTTOM_RIGHT):new ot(s.left+s.width,s.top+s.height),this.bottomLeftBorderBox=f>0||m>0?Zt(s.left,s.top+v,f,m,Nt.BOTTOM_LEFT):new ot(s.left,s.top+s.height),this.topLeftPaddingBox=r>0||o>0?Zt(s.left+F,s.top+C,Math.max(0,r-F),Math.max(0,o-C),Nt.TOP_LEFT):new ot(s.left+F,s.top+C),this.topRightPaddingBox=a>0||l>0?Zt(s.left+Math.min(B,s.width-y),s.top+C,B>s.width+y?0:Math.max(0,a-y),Math.max(0,l-C),Nt.TOP_RIGHT):new ot(s.left+s.width-y,s.top+C),this.bottomRightPaddingBox=u>0||d>0?Zt(s.left+Math.min(_,s.width-F),s.top+Math.min(b,s.height-S),Math.max(0,u-y),Math.max(0,d-S),Nt.BOTTOM_RIGHT):new ot(s.left+s.width-y,s.top+s.height-S),this.bottomLeftPaddingBox=f>0||m>0?Zt(s.left+F,s.top+Math.min(v,s.height-S),Math.max(0,f-F),Math.max(0,m-S),Nt.BOTTOM_LEFT):new ot(s.left+F,s.top+s.height-S),this.topLeftContentBox=r>0||o>0?Zt(s.left+F+U,s.top+C+x,Math.max(0,r-(F+U)),Math.max(0,o-(C+x)),Nt.TOP_LEFT):new ot(s.left+F+U,s.top+C+x),this.topRightContentBox=a>0||l>0?Zt(s.left+Math.min(B,s.width+F+U),s.top+C+x,B>s.width+F+U?0:a-F+U,l-(C+x),Nt.TOP_RIGHT):new ot(s.left+s.width-(y+Q),s.top+C+x),this.bottomRightContentBox=u>0||d>0?Zt(s.left+Math.min(_,s.width-(F+U)),s.top+Math.min(b,s.height+C+x),Math.max(0,u-(y+Q)),d-(S+T),Nt.BOTTOM_RIGHT):new ot(s.left+s.width-(y+Q),s.top+s.height-(S+T)),this.bottomLeftContentBox=f>0||m>0?Zt(s.left+F+U,s.top+v,Math.max(0,f-(F+U)),m-(S+T),Nt.BOTTOM_LEFT):new ot(s.left+F+U,s.top+s.height-(S+T))}return n})(),Nt;(function(n){n[n.TOP_LEFT=0]="TOP_LEFT",n[n.TOP_RIGHT=1]="TOP_RIGHT",n[n.BOTTOM_RIGHT=2]="BOTTOM_RIGHT",n[n.BOTTOM_LEFT=3]="BOTTOM_LEFT"})(Nt||(Nt={}));var Zt=function(n,t,e,s,i){var r=4*((Math.sqrt(2)-1)/3),o=e*r,A=s*r,a=n+e,l=t+s;switch(i){case Nt.TOP_LEFT:return new ll(new ot(n,l),new ot(n,l-A),new ot(a-o,t),new ot(a,t));case Nt.TOP_RIGHT:return new ll(new ot(n,t),new ot(n+o,t),new ot(a,l-A),new ot(a,l));case Nt.BOTTOM_RIGHT:return new ll(new ot(a,t),new ot(a,t+A),new ot(n+o,l),new ot(n,l));case Nt.BOTTOM_LEFT:default:return new ll(new ot(a,l),new ot(a-o,l),new ot(n,t+A),new ot(n,t))}},gc=function(n){return[n.topLeftBorderBox,n.topRightBorderBox,n.bottomRightBorderBox,n.bottomLeftBorderBox]},N4=function(n){return[n.topLeftContentBox,n.topRightContentBox,n.bottomRightContentBox,n.bottomLeftContentBox]},wc=function(n){return[n.topLeftPaddingBox,n.topRightPaddingBox,n.bottomRightPaddingBox,n.bottomLeftPaddingBox]},D4=(function(){function n(t,e,s){this.offsetX=t,this.offsetY=e,this.matrix=s,this.type=0,this.target=6}return n})(),cl=(function(){function n(t,e){this.path=t,this.target=e,this.type=1}return n})(),L4=(function(){function n(t){this.opacity=t,this.type=2,this.target=6}return n})(),k4=function(n){return n.type===0},oC=function(n){return n.type===1},R4=function(n){return n.type===2},A0=function(n,t){return n.length===t.length?n.some(function(e,s){return e===t[s]}):!1},H4=function(n,t,e,s,i){return n.map(function(r,o){switch(o){case 0:return r.add(t,e);case 1:return r.add(t+s,e);case 2:return r.add(t+s,e+i);case 3:return r.add(t,e+i)}return r})},AC=(function(){function n(t){this.element=t,this.inlineLevel=[],this.nonInlineLevel=[],this.negativeZIndex=[],this.zeroOrAutoZIndexOrTransformedOrOpacity=[],this.positiveZIndex=[],this.nonPositionedFloats=[],this.nonPositionedInlineLevel=[]}return n})(),aC=(function(){function n(t,e){if(this.container=t,this.parent=e,this.effects=[],this.curves=new P4(this.container),this.container.styles.opacity<1&&this.effects.push(new L4(this.container.styles.opacity)),this.container.styles.transform!==null){var s=this.container.bounds.left+this.container.styles.transformOrigin[0].number,i=this.container.bounds.top+this.container.styles.transformOrigin[1].number,r=this.container.styles.transform;this.effects.push(new D4(s,i,r))}if(this.container.styles.overflowX!==0){var o=gc(this.curves),A=wc(this.curves);A0(o,A)?this.effects.push(new cl(o,6)):(this.effects.push(new cl(o,2)),this.effects.push(new cl(A,4)))}}return n.prototype.getEffects=function(t){for(var e=[2,3].indexOf(this.container.styles.position)===-1,s=this.parent,i=this.effects.slice(0);s;){var r=s.effects.filter(function(a){return!oC(a)});if(e||s.container.styles.position!==0||!s.parent){if(i.unshift.apply(i,r),e=[2,3].indexOf(s.container.styles.position)===-1,s.container.styles.overflowX!==0){var o=gc(s.curves),A=wc(s.curves);A0(o,A)||i.unshift(new cl(A,6))}}else i.unshift.apply(i,r);s=s.parent}return i.filter(function(a){return Ce(a.target,t)})},n})(),Ih=function(n,t,e,s){n.container.elements.forEach(function(i){var r=Ce(i.flags,4),o=Ce(i.flags,2),A=new aC(i,n);Ce(i.styles.display,2048)&&s.push(A);var a=Ce(i.flags,8)?[]:s;if(r||o){var l=r||i.styles.isPositioned()?e:t,c=new AC(A);if(i.styles.isPositioned()||i.styles.opacity<1||i.styles.isTransformed()){var u=i.styles.zIndex.order;if(u<0){var d=0;l.negativeZIndex.some(function(f,m){return u>f.element.container.styles.zIndex.order?(d=m,!1):d>0}),l.negativeZIndex.splice(d,0,c)}else if(u>0){var p=0;l.positiveZIndex.some(function(f,m){return u>=f.element.container.styles.zIndex.order?(p=m+1,!1):p>0}),l.positiveZIndex.splice(p,0,c)}else l.zeroOrAutoZIndexOrTransformedOrOpacity.push(c)}else i.styles.isFloating()?l.nonPositionedFloats.push(c):l.nonPositionedInlineLevel.push(c);Ih(A,c,r?c:e,a)}else i.styles.isInlineLevel()?t.inlineLevel.push(A):t.nonInlineLevel.push(A),Ih(A,t,e,a);Ce(i.flags,8)&&lC(i,a)})},lC=function(n,t){for(var e=n instanceof yh?n.start:1,s=n instanceof yh?n.reversed:!1,i=0;i<t.length;i++){var r=t[i];r.container instanceof qB&&typeof r.container.value=="number"&&r.container.value!==0&&(e=r.container.value),r.listValue=sa(e,r.container.styles.listStyleType,!0),e+=s?-1:1}},O4=function(n){var t=new aC(n,null),e=new AC(t),s=[];return Ih(t,e,e,s),lC(t.container,s),e},a0=function(n,t){switch(t){case 0:return kn(n.topLeftBorderBox,n.topLeftPaddingBox,n.topRightBorderBox,n.topRightPaddingBox);case 1:return kn(n.topRightBorderBox,n.topRightPaddingBox,n.bottomRightBorderBox,n.bottomRightPaddingBox);case 2:return kn(n.bottomRightBorderBox,n.bottomRightPaddingBox,n.bottomLeftBorderBox,n.bottomLeftPaddingBox);case 3:default:return kn(n.bottomLeftBorderBox,n.bottomLeftPaddingBox,n.topLeftBorderBox,n.topLeftPaddingBox)}},V4=function(n,t){switch(t){case 0:return kn(n.topLeftBorderBox,n.topLeftBorderDoubleOuterBox,n.topRightBorderBox,n.topRightBorderDoubleOuterBox);case 1:return kn(n.topRightBorderBox,n.topRightBorderDoubleOuterBox,n.bottomRightBorderBox,n.bottomRightBorderDoubleOuterBox);case 2:return kn(n.bottomRightBorderBox,n.bottomRightBorderDoubleOuterBox,n.bottomLeftBorderBox,n.bottomLeftBorderDoubleOuterBox);case 3:default:return kn(n.bottomLeftBorderBox,n.bottomLeftBorderDoubleOuterBox,n.topLeftBorderBox,n.topLeftBorderDoubleOuterBox)}},W4=function(n,t){switch(t){case 0:return kn(n.topLeftBorderDoubleInnerBox,n.topLeftPaddingBox,n.topRightBorderDoubleInnerBox,n.topRightPaddingBox);case 1:return kn(n.topRightBorderDoubleInnerBox,n.topRightPaddingBox,n.bottomRightBorderDoubleInnerBox,n.bottomRightPaddingBox);case 2:return kn(n.bottomRightBorderDoubleInnerBox,n.bottomRightPaddingBox,n.bottomLeftBorderDoubleInnerBox,n.bottomLeftPaddingBox);case 3:default:return kn(n.bottomLeftBorderDoubleInnerBox,n.bottomLeftPaddingBox,n.topLeftBorderDoubleInnerBox,n.topLeftPaddingBox)}},G4=function(n,t){switch(t){case 0:return ul(n.topLeftBorderStroke,n.topRightBorderStroke);case 1:return ul(n.topRightBorderStroke,n.bottomRightBorderStroke);case 2:return ul(n.bottomRightBorderStroke,n.bottomLeftBorderStroke);case 3:default:return ul(n.bottomLeftBorderStroke,n.topLeftBorderStroke)}},ul=function(n,t){var e=[];return Un(n)?e.push(n.subdivide(.5,!1)):e.push(n),Un(t)?e.push(t.subdivide(.5,!0)):e.push(t),e},kn=function(n,t,e,s){var i=[];return Un(n)?i.push(n.subdivide(.5,!1)):i.push(n),Un(e)?i.push(e.subdivide(.5,!0)):i.push(e),Un(s)?i.push(s.subdivide(.5,!0).reverse()):i.push(s),Un(t)?i.push(t.subdivide(.5,!1).reverse()):i.push(t),i},cC=function(n){var t=n.bounds,e=n.styles;return t.add(e.borderLeftWidth,e.borderTopWidth,-(e.borderRightWidth+e.borderLeftWidth),-(e.borderTopWidth+e.borderBottomWidth))},vc=function(n){var t=n.styles,e=n.bounds,s=zt(t.paddingLeft,e.width),i=zt(t.paddingRight,e.width),r=zt(t.paddingTop,e.width),o=zt(t.paddingBottom,e.width);return e.add(s+t.borderLeftWidth,r+t.borderTopWidth,-(t.borderRightWidth+t.borderLeftWidth+s+i),-(t.borderTopWidth+t.borderBottomWidth+r+o))},K4=function(n,t){return n===0?t.bounds:n===2?vc(t):cC(t)},q4=function(n,t){return n===0?t.bounds:n===2?vc(t):cC(t)},md=function(n,t,e){var s=K4($r(n.styles.backgroundOrigin,t),n),i=q4($r(n.styles.backgroundClip,t),n),r=z4($r(n.styles.backgroundSize,t),e,s),o=r[0],A=r[1],a=lA($r(n.styles.backgroundPosition,t),s.width-o,s.height-A),l=X4($r(n.styles.backgroundRepeat,t),a,r,s,i),c=Math.round(s.left+a[0]),u=Math.round(s.top+a[1]);return[l,c,u,o,A]},Vr=function(n){return Vt(n)&&n.value===Bo.AUTO},dl=function(n){return typeof n=="number"},z4=function(n,t,e){var s=t[0],i=t[1],r=t[2],o=n[0],A=n[1];if(!o)return[0,0];if(ge(o)&&A&&ge(A))return[zt(o,e.width),zt(A,e.height)];var a=dl(r);if(Vt(o)&&(o.value===Bo.CONTAIN||o.value===Bo.COVER)){if(dl(r)){var l=e.width/e.height;return l<r!=(o.value===Bo.COVER)?[e.width,e.width/r]:[e.height*r,e.height]}return[e.width,e.height]}var c=dl(s),u=dl(i),d=c||u;if(Vr(o)&&(!A||Vr(A))){if(c&&u)return[s,i];if(!a&&!d)return[e.width,e.height];if(d&&a){var p=c?s:i*r,f=u?i:s/r;return[p,f]}var m=c?s:e.width,g=u?i:e.height;return[m,g]}if(a){var w=0,B=0;return ge(o)?w=zt(o,e.width):ge(A)&&(B=zt(A,e.height)),Vr(o)?w=B*r:(!A||Vr(A))&&(B=w/r),[w,B]}var b=null,_=null;if(ge(o)?b=zt(o,e.width):A&&ge(A)&&(_=zt(A,e.height)),b!==null&&(!A||Vr(A))&&(_=c&&u?b/s*i:e.height),_!==null&&Vr(o)&&(b=c&&u?_/i*s:e.width),b!==null&&_!==null)return[b,_];throw new Error("Unable to calculate background-size for element")},$r=function(n,t){var e=n[t];return typeof e>"u"?n[0]:e},X4=function(n,t,e,s,i){var r=t[0],o=t[1],A=e[0],a=e[1];switch(n){case 2:return[new ot(Math.round(s.left),Math.round(s.top+o)),new ot(Math.round(s.left+s.width),Math.round(s.top+o)),new ot(Math.round(s.left+s.width),Math.round(a+s.top+o)),new ot(Math.round(s.left),Math.round(a+s.top+o))];case 3:return[new ot(Math.round(s.left+r),Math.round(s.top)),new ot(Math.round(s.left+r+A),Math.round(s.top)),new ot(Math.round(s.left+r+A),Math.round(s.height+s.top)),new ot(Math.round(s.left+r),Math.round(s.height+s.top))];case 1:return[new ot(Math.round(s.left+r),Math.round(s.top+o)),new ot(Math.round(s.left+r+A),Math.round(s.top+o)),new ot(Math.round(s.left+r+A),Math.round(s.top+o+a)),new ot(Math.round(s.left+r),Math.round(s.top+o+a))];default:return[new ot(Math.round(i.left),Math.round(i.top)),new ot(Math.round(i.left+i.width),Math.round(i.top)),new ot(Math.round(i.left+i.width),Math.round(i.height+i.top)),new ot(Math.round(i.left),Math.round(i.height+i.top))]}},$4="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",l0="Hidden Text",Y4=(function(){function n(t){this._data={},this._document=t}return n.prototype.parseMetrics=function(t,e){var s=this._document.createElement("div"),i=this._document.createElement("img"),r=this._document.createElement("span"),o=this._document.body;s.style.visibility="hidden",s.style.fontFamily=t,s.style.fontSize=e,s.style.margin="0",s.style.padding="0",s.style.whiteSpace="nowrap",o.appendChild(s),i.src=$4,i.width=1,i.height=1,i.style.margin="0",i.style.padding="0",i.style.verticalAlign="baseline",r.style.fontFamily=t,r.style.fontSize=e,r.style.margin="0",r.style.padding="0",r.appendChild(this._document.createTextNode(l0)),s.appendChild(r),s.appendChild(i);var A=i.offsetTop-r.offsetTop+2;s.removeChild(r),s.appendChild(this._document.createTextNode(l0)),s.style.lineHeight="normal",i.style.verticalAlign="super";var a=i.offsetTop-s.offsetTop+2;return o.removeChild(s),{baseline:A,middle:a}},n.prototype.getMetrics=function(t,e){var s=t+" "+e;return typeof this._data[s]>"u"&&(this._data[s]=this.parseMetrics(t,e)),this._data[s]},n})(),uC=(function(){function n(t,e){this.context=t,this.options=e}return n})(),j4=1e4,J4=(function(n){As(t,n);function t(e,s){var i=n.call(this,e,s)||this;return i._activeEffects=[],i.canvas=s.canvas?s.canvas:document.createElement("canvas"),i.ctx=i.canvas.getContext("2d"),s.canvas||(i.canvas.width=Math.floor(s.width*s.scale),i.canvas.height=Math.floor(s.height*s.scale),i.canvas.style.width=s.width+"px",i.canvas.style.height=s.height+"px"),i.fontMetrics=new Y4(document),i.ctx.scale(i.options.scale,i.options.scale),i.ctx.translate(-s.x,-s.y),i.ctx.textBaseline="bottom",i._activeEffects=[],i.context.logger.debug("Canvas renderer initialized ("+s.width+"x"+s.height+") with scale "+s.scale),i}return t.prototype.applyEffects=function(e){for(var s=this;this._activeEffects.length;)this.popEffect();e.forEach(function(i){return s.applyEffect(i)})},t.prototype.applyEffect=function(e){this.ctx.save(),R4(e)&&(this.ctx.globalAlpha=e.opacity),k4(e)&&(this.ctx.translate(e.offsetX,e.offsetY),this.ctx.transform(e.matrix[0],e.matrix[1],e.matrix[2],e.matrix[3],e.matrix[4],e.matrix[5]),this.ctx.translate(-e.offsetX,-e.offsetY)),oC(e)&&(this.path(e.path),this.ctx.clip()),this._activeEffects.push(e)},t.prototype.popEffect=function(){this._activeEffects.pop(),this.ctx.restore()},t.prototype.renderStack=function(e){return qe(this,void 0,void 0,function(){var s;return Ne(this,function(i){switch(i.label){case 0:return s=e.element.container.styles,s.isVisible()?[4,this.renderStackContent(e)]:[3,2];case 1:i.sent(),i.label=2;case 2:return[2]}})})},t.prototype.renderNode=function(e){return qe(this,void 0,void 0,function(){return Ne(this,function(s){switch(s.label){case 0:if(Ce(e.container.flags,16))debugger;return e.container.styles.isVisible()?[4,this.renderNodeBackgroundAndBorders(e)]:[3,3];case 1:return s.sent(),[4,this.renderNodeContent(e)];case 2:s.sent(),s.label=3;case 3:return[2]}})})},t.prototype.renderTextWithLetterSpacing=function(e,s,i){var r=this;if(s===0)this.ctx.fillText(e.text,e.bounds.left,e.bounds.top+i);else{var o=mp(e.text);o.reduce(function(A,a){return r.ctx.fillText(a,A,e.bounds.top+i),A+r.ctx.measureText(a).width},e.bounds.left)}},t.prototype.createFontStyle=function(e){var s=e.fontVariant.filter(function(o){return o==="normal"||o==="small-caps"}).join(""),i=sN(e.fontFamily).join(", "),r=Fa(e.fontSize)?""+e.fontSize.number+e.fontSize.unit:e.fontSize.number+"px";return[[e.fontStyle,s,e.fontWeight,r,i].join(" "),i,r]},t.prototype.renderTextNode=function(e,s){return qe(this,void 0,void 0,function(){var i,r,o,A,a,l,c,u,d=this;return Ne(this,function(p){return i=this.createFontStyle(s),r=i[0],o=i[1],A=i[2],this.ctx.font=r,this.ctx.direction=s.direction===1?"rtl":"ltr",this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic",a=this.fontMetrics.getMetrics(o,A),l=a.baseline,c=a.middle,u=s.paintOrder,e.textBounds.forEach(function(f){u.forEach(function(m){switch(m){case 0:d.ctx.fillStyle=Se(s.color),d.renderTextWithLetterSpacing(f,s.letterSpacing,l);var g=s.textShadow;g.length&&f.text.trim().length&&(g.slice(0).reverse().forEach(function(w){d.ctx.shadowColor=Se(w.color),d.ctx.shadowOffsetX=w.offsetX.number*d.options.scale,d.ctx.shadowOffsetY=w.offsetY.number*d.options.scale,d.ctx.shadowBlur=w.blur.number,d.renderTextWithLetterSpacing(f,s.letterSpacing,l)}),d.ctx.shadowColor="",d.ctx.shadowOffsetX=0,d.ctx.shadowOffsetY=0,d.ctx.shadowBlur=0),s.textDecorationLine.length&&(d.ctx.fillStyle=Se(s.textDecorationColor||s.color),s.textDecorationLine.forEach(function(w){switch(w){case 1:d.ctx.fillRect(f.bounds.left,Math.round(f.bounds.top+l),f.bounds.width,1);break;case 2:d.ctx.fillRect(f.bounds.left,Math.round(f.bounds.top),f.bounds.width,1);break;case 3:d.ctx.fillRect(f.bounds.left,Math.ceil(f.bounds.top+c),f.bounds.width,1);break}}));break;case 1:s.webkitTextStrokeWidth&&f.text.trim().length&&(d.ctx.strokeStyle=Se(s.webkitTextStrokeColor),d.ctx.lineWidth=s.webkitTextStrokeWidth,d.ctx.lineJoin=window.chrome?"miter":"round",d.ctx.strokeText(f.text,f.bounds.left,f.bounds.top+l)),d.ctx.strokeStyle="",d.ctx.lineWidth=0,d.ctx.lineJoin="miter";break}})}),[2]})})},t.prototype.renderReplacedElement=function(e,s,i){if(i&&e.intrinsicWidth>0&&e.intrinsicHeight>0){var r=vc(e),o=wc(s);this.path(o),this.ctx.save(),this.ctx.clip(),this.ctx.drawImage(i,0,0,e.intrinsicWidth,e.intrinsicHeight,r.left,r.top,r.width,r.height),this.ctx.restore()}},t.prototype.renderNodeContent=function(e){return qe(this,void 0,void 0,function(){var s,i,r,o,A,a,B,B,l,c,u,d,_,p,f,v,m,g,w,B,b,_,v;return Ne(this,function(C){switch(C.label){case 0:this.applyEffects(e.getEffects(4)),s=e.container,i=e.curves,r=s.styles,o=0,A=s.textNodes,C.label=1;case 1:return o<A.length?(a=A[o],[4,this.renderTextNode(a,r)]):[3,4];case 2:C.sent(),C.label=3;case 3:return o++,[3,1];case 4:if(!(s instanceof WB))return[3,8];C.label=5;case 5:return C.trys.push([5,7,,8]),[4,this.context.cache.match(s.src)];case 6:return B=C.sent(),this.renderReplacedElement(s,i,B),[3,8];case 7:return C.sent(),this.context.logger.error("Error loading image "+s.src),[3,8];case 8:if(s instanceof GB&&this.renderReplacedElement(s,i,s.canvas),!(s instanceof KB))return[3,12];C.label=9;case 9:return C.trys.push([9,11,,12]),[4,this.context.cache.match(s.svg)];case 10:return B=C.sent(),this.renderReplacedElement(s,i,B),[3,12];case 11:return C.sent(),this.context.logger.error("Error loading svg "+s.svg.substring(0,255)),[3,12];case 12:return s instanceof $B&&s.tree?(l=new t(this.context,{scale:this.options.scale,backgroundColor:s.backgroundColor,x:0,y:0,width:s.width,height:s.height}),[4,l.render(s.tree)]):[3,14];case 13:c=C.sent(),s.width&&s.height&&this.ctx.drawImage(c,0,0,s.width,s.height,s.bounds.left,s.bounds.top,s.bounds.width,s.bounds.height),C.label=14;case 14:if(s instanceof gp&&(u=Math.min(s.bounds.width,s.bounds.height),s.type===hc?s.checked&&(this.ctx.save(),this.path([new ot(s.bounds.left+u*.39363,s.bounds.top+u*.79),new ot(s.bounds.left+u*.16,s.bounds.top+u*.5549),new ot(s.bounds.left+u*.27347,s.bounds.top+u*.44071),new ot(s.bounds.left+u*.39694,s.bounds.top+u*.5649),new ot(s.bounds.left+u*.72983,s.bounds.top+u*.23),new ot(s.bounds.left+u*.84,s.bounds.top+u*.34085),new ot(s.bounds.left+u*.39363,s.bounds.top+u*.79)]),this.ctx.fillStyle=Se(Yg),this.ctx.fill(),this.ctx.restore()):s.type===fc&&s.checked&&(this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(s.bounds.left+u/2,s.bounds.top+u/2,u/4,0,Math.PI*2,!0),this.ctx.fillStyle=Se(Yg),this.ctx.fill(),this.ctx.restore())),Z4(s)&&s.value.length){switch(d=this.createFontStyle(r),_=d[0],p=d[1],f=this.fontMetrics.getMetrics(_,p).baseline,this.ctx.font=_,this.ctx.fillStyle=Se(r.color),this.ctx.textBaseline="alphabetic",this.ctx.textAlign=eN(s.styles.textAlign),v=vc(s),m=0,s.styles.textAlign){case 1:m+=v.width/2;break;case 2:m+=v.width;break}g=v.add(m,0,0,-v.height/2+1),this.ctx.save(),this.path([new ot(v.left,v.top),new ot(v.left+v.width,v.top),new ot(v.left+v.width,v.top+v.height),new ot(v.left,v.top+v.height)]),this.ctx.clip(),this.renderTextWithLetterSpacing(new IA(s.value,g),r.letterSpacing,f),this.ctx.restore(),this.ctx.textBaseline="alphabetic",this.ctx.textAlign="left"}if(!Ce(s.styles.display,2048))return[3,20];if(s.styles.listStyleImage===null)return[3,19];if(w=s.styles.listStyleImage,w.type!==0)return[3,18];B=void 0,b=w.url,C.label=15;case 15:return C.trys.push([15,17,,18]),[4,this.context.cache.match(b)];case 16:return B=C.sent(),this.ctx.drawImage(B,s.bounds.left-(B.width+10),s.bounds.top),[3,18];case 17:return C.sent(),this.context.logger.error("Error loading list-style-image "+b),[3,18];case 18:return[3,20];case 19:e.listValue&&s.styles.listStyleType!==-1&&(_=this.createFontStyle(r)[0],this.ctx.font=_,this.ctx.fillStyle=Se(r.color),this.ctx.textBaseline="middle",this.ctx.textAlign="right",v=new oi(s.bounds.left,s.bounds.top+zt(s.styles.paddingTop,s.bounds.width),s.bounds.width,Ug(r.lineHeight,r.fontSize.number)/2+1),this.renderTextWithLetterSpacing(new IA(e.listValue,v),r.letterSpacing,Ug(r.lineHeight,r.fontSize.number)/2+2),this.ctx.textBaseline="bottom",this.ctx.textAlign="left"),C.label=20;case 20:return[2]}})})},t.prototype.renderStackContent=function(e){return qe(this,void 0,void 0,function(){var s,i,w,r,o,w,A,a,w,l,c,w,u,d,w,p,f,w,m,g,w;return Ne(this,function(B){switch(B.label){case 0:if(Ce(e.element.container.flags,16))debugger;return[4,this.renderNodeBackgroundAndBorders(e.element)];case 1:B.sent(),s=0,i=e.negativeZIndex,B.label=2;case 2:return s<i.length?(w=i[s],[4,this.renderStack(w)]):[3,5];case 3:B.sent(),B.label=4;case 4:return s++,[3,2];case 5:return[4,this.renderNodeContent(e.element)];case 6:B.sent(),r=0,o=e.nonInlineLevel,B.label=7;case 7:return r<o.length?(w=o[r],[4,this.renderNode(w)]):[3,10];case 8:B.sent(),B.label=9;case 9:return r++,[3,7];case 10:A=0,a=e.nonPositionedFloats,B.label=11;case 11:return A<a.length?(w=a[A],[4,this.renderStack(w)]):[3,14];case 12:B.sent(),B.label=13;case 13:return A++,[3,11];case 14:l=0,c=e.nonPositionedInlineLevel,B.label=15;case 15:return l<c.length?(w=c[l],[4,this.renderStack(w)]):[3,18];case 16:B.sent(),B.label=17;case 17:return l++,[3,15];case 18:u=0,d=e.inlineLevel,B.label=19;case 19:return u<d.length?(w=d[u],[4,this.renderNode(w)]):[3,22];case 20:B.sent(),B.label=21;case 21:return u++,[3,19];case 22:p=0,f=e.zeroOrAutoZIndexOrTransformedOrOpacity,B.label=23;case 23:return p<f.length?(w=f[p],[4,this.renderStack(w)]):[3,26];case 24:B.sent(),B.label=25;case 25:return p++,[3,23];case 26:m=0,g=e.positiveZIndex,B.label=27;case 27:return m<g.length?(w=g[m],[4,this.renderStack(w)]):[3,30];case 28:B.sent(),B.label=29;case 29:return m++,[3,27];case 30:return[2]}})})},t.prototype.mask=function(e){this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(this.canvas.width,0),this.ctx.lineTo(this.canvas.width,this.canvas.height),this.ctx.lineTo(0,this.canvas.height),this.ctx.lineTo(0,0),this.formatPath(e.slice(0).reverse()),this.ctx.closePath()},t.prototype.path=function(e){this.ctx.beginPath(),this.formatPath(e),this.ctx.closePath()},t.prototype.formatPath=function(e){var s=this;e.forEach(function(i,r){var o=Un(i)?i.start:i;r===0?s.ctx.moveTo(o.x,o.y):s.ctx.lineTo(o.x,o.y),Un(i)&&s.ctx.bezierCurveTo(i.startControl.x,i.startControl.y,i.endControl.x,i.endControl.y,i.end.x,i.end.y)})},t.prototype.renderRepeat=function(e,s,i,r){this.path(e),this.ctx.fillStyle=s,this.ctx.translate(i,r),this.ctx.fill(),this.ctx.translate(-i,-r)},t.prototype.resizeImage=function(e,s,i){var r;if(e.width===s&&e.height===i)return e;var o=(r=this.canvas.ownerDocument)!==null&&r!==void 0?r:document,A=o.createElement("canvas");A.width=Math.max(1,s),A.height=Math.max(1,i);var a=A.getContext("2d");return a.drawImage(e,0,0,e.width,e.height,0,0,s,i),A},t.prototype.renderBackgroundImage=function(e){return qe(this,void 0,void 0,function(){var s,i,r,o,A,a;return Ne(this,function(l){switch(l.label){case 0:s=e.styles.backgroundImage.length-1,i=function(c){var u,d,p,x,M,k,U,P,S,f,x,M,k,U,P,m,g,w,B,b,_,v,C,y,S,F,x,Q,T,U,P,K,M,k,N,R,J,tt,rt,lt,W,H;return Ne(this,function(O){switch(O.label){case 0:if(c.type!==0)return[3,5];u=void 0,d=c.url,O.label=1;case 1:return O.trys.push([1,3,,4]),[4,r.context.cache.match(d)];case 2:return u=O.sent(),[3,4];case 3:return O.sent(),r.context.logger.error("Error loading background-image "+d),[3,4];case 4:return u&&(p=md(e,s,[u.width,u.height,u.width/u.height]),x=p[0],M=p[1],k=p[2],U=p[3],P=p[4],S=r.ctx.createPattern(r.resizeImage(u,U,P),"repeat"),r.renderRepeat(x,S,M,k)),[3,6];case 5:kU(c)?(f=md(e,s,[null,null,null]),x=f[0],M=f[1],k=f[2],U=f[3],P=f[4],m=UU(c.angle,U,P),g=m[0],w=m[1],B=m[2],b=m[3],_=m[4],v=document.createElement("canvas"),v.width=U,v.height=P,C=v.getContext("2d"),y=C.createLinearGradient(w,b,B,_),Qg(c.stops,g).forEach(function($){return y.addColorStop($.stop,Se($.color))}),C.fillStyle=y,C.fillRect(0,0,U,P),U>0&&P>0&&(S=r.ctx.createPattern(v,"repeat"),r.renderRepeat(x,S,M,k))):RU(c)&&(F=md(e,s,[null,null,null]),x=F[0],Q=F[1],T=F[2],U=F[3],P=F[4],K=c.position.length===0?[hp]:c.position,M=zt(K[0],U),k=zt(K[K.length-1],P),N=PU(c,M,k,U,P),R=N[0],J=N[1],R>0&&J>0&&(tt=r.ctx.createRadialGradient(Q+M,T+k,0,Q+M,T+k,R),Qg(c.stops,R*2).forEach(function($){return tt.addColorStop($.stop,Se($.color))}),r.path(x),r.ctx.fillStyle=tt,R!==J?(rt=e.bounds.left+.5*e.bounds.width,lt=e.bounds.top+.5*e.bounds.height,W=J/R,H=1/W,r.ctx.save(),r.ctx.translate(rt,lt),r.ctx.transform(1,0,0,W,0,0),r.ctx.translate(-rt,-lt),r.ctx.fillRect(Q,H*(T-lt)+lt,U,P*H),r.ctx.restore()):r.ctx.fill())),O.label=6;case 6:return s--,[2]}})},r=this,o=0,A=e.styles.backgroundImage.slice(0).reverse(),l.label=1;case 1:return o<A.length?(a=A[o],[5,i(a)]):[3,4];case 2:l.sent(),l.label=3;case 3:return o++,[3,1];case 4:return[2]}})})},t.prototype.renderSolidBorder=function(e,s,i){return qe(this,void 0,void 0,function(){return Ne(this,function(r){return this.path(a0(i,s)),this.ctx.fillStyle=Se(e),this.ctx.fill(),[2]})})},t.prototype.renderDoubleBorder=function(e,s,i,r){return qe(this,void 0,void 0,function(){var o,A;return Ne(this,function(a){switch(a.label){case 0:return s<3?[4,this.renderSolidBorder(e,i,r)]:[3,2];case 1:return a.sent(),[2];case 2:return o=V4(r,i),this.path(o),this.ctx.fillStyle=Se(e),this.ctx.fill(),A=W4(r,i),this.path(A),this.ctx.fill(),[2]}})})},t.prototype.renderNodeBackgroundAndBorders=function(e){return qe(this,void 0,void 0,function(){var s,i,r,o,A,a,l,c,u=this;return Ne(this,function(d){switch(d.label){case 0:return this.applyEffects(e.getEffects(2)),s=e.container.styles,i=!Ni(s.backgroundColor)||s.backgroundImage.length,r=[{style:s.borderTopStyle,color:s.borderTopColor,width:s.borderTopWidth},{style:s.borderRightStyle,color:s.borderRightColor,width:s.borderRightWidth},{style:s.borderBottomStyle,color:s.borderBottomColor,width:s.borderBottomWidth},{style:s.borderLeftStyle,color:s.borderLeftColor,width:s.borderLeftWidth}],o=tN($r(s.backgroundClip,0),e.curves),i||s.boxShadow.length?(this.ctx.save(),this.path(o),this.ctx.clip(),Ni(s.backgroundColor)||(this.ctx.fillStyle=Se(s.backgroundColor),this.ctx.fill()),[4,this.renderBackgroundImage(e.container)]):[3,2];case 1:d.sent(),this.ctx.restore(),s.boxShadow.slice(0).reverse().forEach(function(p){u.ctx.save();var f=gc(e.curves),m=p.inset?0:j4,g=H4(f,-m+(p.inset?1:-1)*p.spread.number,(p.inset?1:-1)*p.spread.number,p.spread.number*(p.inset?-2:2),p.spread.number*(p.inset?-2:2));p.inset?(u.path(f),u.ctx.clip(),u.mask(g)):(u.mask(f),u.ctx.clip(),u.path(g)),u.ctx.shadowOffsetX=p.offsetX.number+m,u.ctx.shadowOffsetY=p.offsetY.number,u.ctx.shadowColor=Se(p.color),u.ctx.shadowBlur=p.blur.number,u.ctx.fillStyle=p.inset?Se(p.color):"rgba(0,0,0,1)",u.ctx.fill(),u.ctx.restore()}),d.label=2;case 2:A=0,a=0,l=r,d.label=3;case 3:return a<l.length?(c=l[a],c.style!==0&&!Ni(c.color)&&c.width>0?c.style!==2?[3,5]:[4,this.renderDashedDottedBorder(c.color,c.width,A,e.curves,2)]:[3,11]):[3,13];case 4:return d.sent(),[3,11];case 5:return c.style!==3?[3,7]:[4,this.renderDashedDottedBorder(c.color,c.width,A,e.curves,3)];case 6:return d.sent(),[3,11];case 7:return c.style!==4?[3,9]:[4,this.renderDoubleBorder(c.color,c.width,A,e.curves)];case 8:return d.sent(),[3,11];case 9:return[4,this.renderSolidBorder(c.color,A,e.curves)];case 10:d.sent(),d.label=11;case 11:A++,d.label=12;case 12:return a++,[3,3];case 13:return[2]}})})},t.prototype.renderDashedDottedBorder=function(e,s,i,r,o){return qe(this,void 0,void 0,function(){var A,a,l,c,u,d,p,f,m,g,w,B,b,_,v,C,v,C;return Ne(this,function(y){return this.ctx.save(),A=G4(r,i),a=a0(r,i),o===2&&(this.path(a),this.ctx.clip()),Un(a[0])?(l=a[0].start.x,c=a[0].start.y):(l=a[0].x,c=a[0].y),Un(a[1])?(u=a[1].end.x,d=a[1].end.y):(u=a[1].x,d=a[1].y),i===0||i===2?p=Math.abs(l-u):p=Math.abs(c-d),this.ctx.beginPath(),o===3?this.formatPath(A):this.formatPath(a.slice(0,2)),f=s<3?s*3:s*2,m=s<3?s*2:s,o===3&&(f=s,m=s),g=!0,p<=f*2?g=!1:p<=f*2+m?(w=p/(2*f+m),f*=w,m*=w):(B=Math.floor((p+m)/(f+m)),b=(p-B*f)/(B-1),_=(p-(B+1)*f)/B,m=_<=0||Math.abs(m-b)<Math.abs(m-_)?b:_),g&&(o===3?this.ctx.setLineDash([0,f+m]):this.ctx.setLineDash([f,m])),o===3?(this.ctx.lineCap="round",this.ctx.lineWidth=s):this.ctx.lineWidth=s*2+1.1,this.ctx.strokeStyle=Se(e),this.ctx.stroke(),this.ctx.setLineDash([]),o===2&&(Un(a[0])&&(v=a[3],C=a[0],this.ctx.beginPath(),this.formatPath([new ot(v.end.x,v.end.y),new ot(C.start.x,C.start.y)]),this.ctx.stroke()),Un(a[1])&&(v=a[1],C=a[2],this.ctx.beginPath(),this.formatPath([new ot(v.end.x,v.end.y),new ot(C.start.x,C.start.y)]),this.ctx.stroke())),this.ctx.restore(),[2]})})},t.prototype.render=function(e){return qe(this,void 0,void 0,function(){var s;return Ne(this,function(i){switch(i.label){case 0:return this.options.backgroundColor&&(this.ctx.fillStyle=Se(this.options.backgroundColor),this.ctx.fillRect(this.options.x,this.options.y,this.options.width,this.options.height)),s=O4(e),[4,this.renderStack(s)];case 1:return i.sent(),this.applyEffects([]),[2,this.canvas]}})})},t})(uC),Z4=function(n){return n instanceof XB||n instanceof zB?!0:n instanceof gp&&n.type!==fc&&n.type!==hc},tN=function(n,t){switch(n){case 0:return gc(t);case 2:return N4(t);case 1:default:return wc(t)}},eN=function(n){switch(n){case 1:return"center";case 2:return"right";case 0:default:return"left"}},nN=["-apple-system","system-ui"],sN=function(n){return/iPhone OS 15_(0|1)/.test(window.navigator.userAgent)?n.filter(function(t){return nN.indexOf(t)===-1}):n},iN=(function(n){As(t,n);function t(e,s){var i=n.call(this,e,s)||this;return i.canvas=s.canvas?s.canvas:document.createElement("canvas"),i.ctx=i.canvas.getContext("2d"),i.options=s,i.canvas.width=Math.floor(s.width*s.scale),i.canvas.height=Math.floor(s.height*s.scale),i.canvas.style.width=s.width+"px",i.canvas.style.height=s.height+"px",i.ctx.scale(i.options.scale,i.options.scale),i.ctx.translate(-s.x,-s.y),i.context.logger.debug("EXPERIMENTAL ForeignObject renderer initialized ("+s.width+"x"+s.height+" at "+s.x+","+s.y+") with scale "+s.scale),i}return t.prototype.render=function(e){return qe(this,void 0,void 0,function(){var s,i;return Ne(this,function(r){switch(r.label){case 0:return s=bh(this.options.width*this.options.scale,this.options.height*this.options.scale,this.options.scale,this.options.scale,e),[4,rN(s)];case 1:return i=r.sent(),this.options.backgroundColor&&(this.ctx.fillStyle=Se(this.options.backgroundColor),this.ctx.fillRect(0,0,this.options.width*this.options.scale,this.options.height*this.options.scale)),this.ctx.drawImage(i,-this.options.x*this.options.scale,-this.options.y*this.options.scale),[2,this.canvas]}})})},t})(uC),rN=function(n){return new Promise(function(t,e){var s=new Image;s.onload=function(){t(s)},s.onerror=e,s.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(new XMLSerializer().serializeToString(n))})},oN=(function(){function n(t){var e=t.id,s=t.enabled;this.id=e,this.enabled=s,this.start=Date.now()}return n.prototype.debug=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.enabled&&(typeof window<"u"&&window.console&&typeof console.debug=="function"?console.debug.apply(console,Ga([this.id,this.getTime()+"ms"],t)):this.info.apply(this,t))},n.prototype.getTime=function(){return Date.now()-this.start},n.prototype.info=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.enabled&&typeof window<"u"&&window.console&&typeof console.info=="function"&&console.info.apply(console,Ga([this.id,this.getTime()+"ms"],t))},n.prototype.warn=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.enabled&&(typeof window<"u"&&window.console&&typeof console.warn=="function"?console.warn.apply(console,Ga([this.id,this.getTime()+"ms"],t)):this.info.apply(this,t))},n.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.enabled&&(typeof window<"u"&&window.console&&typeof console.error=="function"?console.error.apply(console,Ga([this.id,this.getTime()+"ms"],t)):this.info.apply(this,t))},n.instances={},n})(),AN=(function(){function n(t,e){var s;this.windowBounds=e,this.instanceName="#"+n.instanceCount++,this.logger=new oN({id:this.instanceName,enabled:t.logging}),this.cache=(s=t.cache)!==null&&s!==void 0?s:new _4(this,t)}return n.instanceCount=1,n})(),aN=function(n,t){return t===void 0&&(t={}),lN(n,t)};typeof window<"u"&&rC.setContext(window);var lN=function(n,t){return qe(void 0,void 0,void 0,function(){var e,s,i,r,o,A,a,l,c,u,d,p,f,m,g,w,B,b,_,v,y,C,y,S,F,x,Q,T,U,P,K,M,k,N,R,J,tt,rt,lt,W;return Ne(this,function(H){switch(H.label){case 0:if(!n||typeof n!="object")return[2,Promise.reject("Invalid element provided as first argument")];if(e=n.ownerDocument,!e)throw new Error("Element is not attached to a Document");if(s=e.defaultView,!s)throw new Error("Document is not attached to a Window");return i={allowTaint:(S=t.allowTaint)!==null&&S!==void 0?S:!1,imageTimeout:(F=t.imageTimeout)!==null&&F!==void 0?F:15e3,proxy:t.proxy,useCORS:(x=t.useCORS)!==null&&x!==void 0?x:!1},r=Ah({logging:(Q=t.logging)!==null&&Q!==void 0?Q:!0,cache:t.cache},i),o={windowWidth:(T=t.windowWidth)!==null&&T!==void 0?T:s.innerWidth,windowHeight:(U=t.windowHeight)!==null&&U!==void 0?U:s.innerHeight,scrollX:(P=t.scrollX)!==null&&P!==void 0?P:s.pageXOffset,scrollY:(K=t.scrollY)!==null&&K!==void 0?K:s.pageYOffset},A=new oi(o.scrollX,o.scrollY,o.windowWidth,o.windowHeight),a=new AN(r,A),l=(M=t.foreignObjectRendering)!==null&&M!==void 0?M:!1,c={allowTaint:(k=t.allowTaint)!==null&&k!==void 0?k:!1,onclone:t.onclone,ignoreElements:t.ignoreElements,inlineImages:l,copyStyles:l},a.logger.debug("Starting document clone with size "+A.width+"x"+A.height+" scrolled to "+-A.left+","+-A.top),u=new r0(a,n,c),d=u.clonedReferenceElement,d?[4,u.toIFrame(e,A)]:[2,Promise.reject("Unable to find element in cloned iframe")];case 1:return p=H.sent(),f=wp(d)||c4(d)?HQ(d.ownerDocument):du(a,d),m=f.width,g=f.height,w=f.left,B=f.top,b=cN(a,d,t.backgroundColor),_={canvas:t.canvas,backgroundColor:b,scale:(R=(N=t.scale)!==null&&N!==void 0?N:s.devicePixelRatio)!==null&&R!==void 0?R:1,x:((J=t.x)!==null&&J!==void 0?J:0)+w,y:((tt=t.y)!==null&&tt!==void 0?tt:0)+B,width:(rt=t.width)!==null&&rt!==void 0?rt:Math.ceil(m),height:(lt=t.height)!==null&&lt!==void 0?lt:Math.ceil(g)},l?(a.logger.debug("Document cloned, using foreign object rendering"),y=new iN(a,_),[4,y.render(d)]):[3,3];case 2:return v=H.sent(),[3,5];case 3:return a.logger.debug("Document cloned, element located at "+w+","+B+" with size "+m+"x"+g+" using computed rendering"),a.logger.debug("Starting DOM parsing"),C=jB(a,d),b===C.styles.backgroundColor&&(C.styles.backgroundColor=ti.TRANSPARENT),a.logger.debug("Starting renderer for element at "+_.x+","+_.y+" with size "+_.width+"x"+_.height),y=new J4(a,_),[4,y.render(C)];case 4:v=H.sent(),H.label=5;case 5:return(!((W=t.removeContainer)!==null&&W!==void 0)||W)&&(r0.destroy(p)||a.logger.error("Cannot detach cloned iframe as it is not in the DOM anymore")),a.logger.debug("Finished rendering"),[2,v]}})})},cN=function(n,t,e){var s=t.ownerDocument,i=s.documentElement?xA(n,getComputedStyle(s.documentElement).backgroundColor):ti.TRANSPARENT,r=s.body?xA(n,getComputedStyle(s.body).backgroundColor):ti.TRANSPARENT,o=typeof e=="string"?xA(n,e):e===null?ti.TRANSPARENT:4294967295;return t===s.documentElement?Ni(i)?Ni(r)?o:r:i:o};const TA={},Bi={},uN=600,gd=.25,c0={letter:{width:8.5,height:11},"11x14":{width:11,height:14},"11x17":{width:11,height:17}};async function dN(n,t){const e=document.getElementById("button-grid");if(!e)return E.warn("PrintService","Button grid element not found",null,"print"),null;const s=e.querySelector(".button-grid-left-cell"),i=e.querySelector(".button-grid-right-cell");try{const r=e.getBoundingClientRect(),o=(s==null?void 0:s.getBoundingClientRect().width)??0,A=(i==null?void 0:i.getBoundingClientRect().width)??0,a=Math.min(window.devicePixelRatio||1,2),l=await aN(e,{scale:a,backgroundColor:"#ffffff",logging:!1,useCORS:!0}),c=r.width>0?l.width/r.width:1,u=n?0:Math.round(o*c),d=t?0:Math.round(A*c),p=Math.max(0,Math.min(l.width-1,u)),f=Math.max(p+1,Math.min(l.width,l.width-d)),m=Math.max(1,f-p),g=document.createElement("canvas");g.width=m,g.height=l.height,(g.getContext("2d",{willReadFrequently:!0})||g.getContext("2d")).drawImage(l,p,0,m,l.height,0,0,m,l.height);const B=gN(g,n,t);return E.debug("PrintService",`Captured button grid: ${B.width}x${B.height}`,null,"print"),B}catch(r){return E.error("PrintService","Failed to capture button grid",r,"print"),null}}function hN(n,t){const e=document.getElementById("notation-grid"),s=document.getElementById("legend-left-canvas"),i=document.getElementById("legend-right-canvas");if(!e)return E.warn("PrintService","Notation grid canvas not found",null,"print"),null;const r=n&&s?s.width:0,o=t&&i?i.width:0,A=r+e.width+o,a=r,l=document.createElement("canvas");l.width=A,l.height=e.height;const c=l.getContext("2d");return n&&s&&r>0&&c.drawImage(s,0,0),c.drawImage(e,a,0),t&&i&&o>0&&c.drawImage(i,a+e.width,0),E.debug("PrintService",`Captured pitch grid: ${l.width}x${l.height}`,null,"print"),l}function fN(n,t){const e=document.getElementById("drum-grid"),s=document.querySelector(".drum-grid-left-cell"),i=document.querySelector(".drum-grid-right-cell");if(!e||e.width===0)return E.debug("PrintService","Drum grid not found or empty",null,"print"),null;const r=e.offsetWidth?e.width/e.offsetWidth:1,o=n?Math.max(0,Math.round(((s==null?void 0:s.offsetWidth)||0)*r)):0,A=t?Math.max(0,Math.round(((i==null?void 0:i.offsetWidth)||0)*r)):0,a=o+e.width+A,l=getComputedStyle(document.documentElement).getPropertyValue("--c-surface")||"#ffffff",c=document.createElement("canvas");c.width=a,c.height=e.height;const u=c.getContext("2d");return u.fillStyle=l.trim()||"#ffffff",u.fillRect(0,0,a,e.height),u.drawImage(e,o,0),E.debug("PrintService",`Captured drum grid: ${c.width}x${c.height}`,null,"print"),c}function pN(n){const t=document.createElement("canvas");t.width=n.width,t.height=n.height;const e=t.getContext("2d");e.drawImage(n,0,0);const s=e.getImageData(0,0,t.width,t.height),i=s.data;for(let r=0;r<i.length;r+=4){const o=i[r]*.299+i[r+1]*.587+i[r+2]*.114;i[r]=o,i[r+1]=o,i[r+2]=o}return e.putImageData(s,0,0),t}async function mN(n,t){E.debug("PrintService","Generating score canvas...",{printOptions:n,targetDimensions:t},"print");const e=[];if(n.includeButtonGrid){const _=await dC(n.includeLeftLegend,n.includeRightLegend);_&&e.push({canvas:_,name:"buttons"})}const s=hN(n.includeLeftLegend,n.includeRightLegend);if(s&&e.push({canvas:s,name:"pitch"}),n.includeDrums){const _=fN(n.includeLeftLegend,n.includeRightLegend);_&&e.push({canvas:_,name:"drums"})}if(e.length===0)return E.warn("PrintService","No content captured for printing",null,"print"),null;n.colorMode==="bw"&&(e.forEach(_=>{_.canvas=pN(_.canvas)}),E.debug("PrintService","Applied black & white filter",null,"print"));const i=Math.max(...e.map(_=>_.canvas.width)),r=e.reduce((_,v)=>_+v.canvas.height,0),o=n.cropTop||0,A=n.cropBottom||1,a=n.cropLeft||0,l=n.cropRight||1,c=r*(A-o),u=i*(l-a),d=r*o,p=i*a;E.debug("PrintService",`Applying crop: top=${o.toFixed(2)}, bottom=${A.toFixed(2)}, left=${a.toFixed(2)}, right=${l.toFixed(2)}`,null,"print");const f=Math.min(t.width/u,t.height/c),m=document.createElement("canvas");m.width=u*f,m.height=c*f;const g=m.getContext("2d");g.fillStyle="#FFFFFF",g.fillRect(0,0,m.width,m.height);const w=document.createElement("canvas");w.width=i,w.height=r;const B=w.getContext("2d");let b=0;return e.forEach(({canvas:_,name:v})=>{B.drawImage(_,0,b),E.debug("PrintService",`Drew ${v} at y=${b}, height=${_.height}`,null,"print"),b+=_.height}),g.drawImage(w,p,d,u,c,0,0,m.width,m.height),E.debug("PrintService",`Generated composite canvas: ${m.width}x${m.height}`,null,"print"),m}const Nl={generateScoreCanvas:mN,async generateAndPrint(){const n=h.state.printOptions,t=300,e=n.pageSize,s=e&&e in c0?e:"letter",i=c0[s],r=n.orientation==="landscape"?i.height:i.width,o=n.orientation==="landscape"?i.width:i.height,A=Math.max(1,r-2*gd),a=Math.max(1,o-2*gd),l=A*t,c=a*t;E.info("PrintService","Generating print canvas at high resolution",{width:l,height:c,options:n},"print");const u=await this.generateScoreCanvas(n,{width:l,height:c});if(!u){E.error("PrintService","Failed to generate print canvas",null,"print");return}const d=document.getElementById("print-staging-area");d.innerHTML="";const p=document.getElementById("print-style-rules");p.textContent=`@page { size: ${r}in ${o}in; margin: ${gd}in; }`;const f=document.createElement("img");f.src=u.toDataURL("image/png"),f.style.width="100%",f.style.height="auto",d.appendChild(f),E.info("PrintService","Opening print dialog",null,"print"),setTimeout(()=>window.print(),100)},async prefetchButtonGridSnapshot(n=!0,t=!0){try{await dC(n,t)}catch(e){E.warn("PrintService","Button grid prefetch failed",e,"print")}},invalidateButtonGridSnapshot(){hC()}};function gN(n,t,e){if(!n)return n;const s=document.getElementById("notation-grid"),i=document.getElementById("legend-left-canvas"),r=document.getElementById("legend-right-canvas"),o=t&&i?i.width:0,A=e&&r?r.width:0,a=((s==null?void 0:s.width)??0)+o+A||n.width;if(!a||a===n.width)return n;const l=a/n.width,c=Math.max(1,Math.round(n.height*l)),u=document.createElement("canvas");return u.width=a,u.height=c,(u.getContext("2d",{willReadFrequently:!0})||u.getContext("2d")).drawImage(n,0,0,u.width,u.height),u}async function dC(n,t){const e=`${n}-${t}`;return TA[e]!==void 0?TA[e]??null:(Bi[e]||(Bi[e]=(async()=>{await wN();const s=await dN(n,t);return TA[e]=s,Bi[e]=null,s})().catch(s=>{throw Bi[e]=null,s})),Bi[e])}function wN(){return new Promise(n=>{typeof window.requestIdleCallback=="function"?requestIdleCallback(()=>n(),{timeout:uN}):requestAnimationFrame(()=>n())})}function hC(){Object.keys(TA).forEach(n=>{delete TA[n]}),Object.keys(Bi).forEach(n=>{delete Bi[n]})}typeof window<"u"&&window.addEventListener("resize",()=>hC());function bs(n,t){if(!n)return`rgba(204, 204, 204, ${t})`;const e=parseInt(n.slice(Tv,Lm),xl),s=parseInt(n.slice(Lm,km),xl),i=parseInt(n.slice(km,LF),xl);return`rgba(${e}, ${s}, ${i}, ${t})`}function bu(n,t){if(!n||typeof n!="string")return DF;const e=parseInt(n.slice(Tv),xl),s=t<0?kF:RF,i=t<0?t*-1:t,r=e>>16,o=e>>8&255,A=e&255;return"#"+(16777216+(Math.round((s-r)*i)+r)*65536+(Math.round((s-o)*i)+o)*256+(Math.round((s-A)*i)+A)).toString(16).slice(1)}const vN=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor"/>\r
</svg>`,BN=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(90, 12, 12)"/>\r
</svg>`,CN=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(180, 12, 12)"/>\r
</svg>`,bN=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(270, 12, 12)"/>\r
</svg>`,fC=fo;function dA(n,t){const{blend:e,cutoff:s,resonance:i}=t,r=(s-1)/30,o=20,A=n-r,a=r-n;let l=1/(1+Math.pow(Math.max(0,A*o),2)),c=1/(1+Math.pow(Math.max(0,a*o),2));const u=.01;l<u&&(l=0),c<u&&(c=0);const d=l*c;let p;e<=1?p=c*(1-e)+d*e:p=d*(2-e)+l*(e-1);const f=1-(i||0)/105,m=Math.max(.01,.2*f*f),g=Math.exp(-Math.pow((n-r)/m,2)),w=(i||0)/100*.6,B=p+g*w,b=Math.max(0,Math.min(1,B));return b<u?0:b}function yN(n,t){const e=t/100;return 1-e+e*n}function ia(n,t){const e=t.mix||0;if(e===0)return new Float32Array(n);const s=new Float32Array(n.length),i=e/100;for(let r=0;r<n.length;r++){const o=n[r]??0,A=(r+.5)/fC,a=dA(A,t);if(a<o){const u=(o-a)*i;s[r]=o-u}else s[r]=o;const l=s[r]??0;s[r]=Math.max(0,l)}return s}function Fh(n){const t=h.state.timbres[n];if(!t)return new Float32Array(fC);const e=t.filter;return e&&e.enabled!==!1&&(e.mix||0)>0?ia(t.coeffs,e):new Float32Array(t.coeffs)}E.moduleLoaded("HarmonicBins with Columnar Structure");function Th(n,...t){}const Dl={0:vN,90:BN,180:CN,270:bN},Is=fo;let Ee=null,ve=null,De=new Float32Array(Is).fill(0),Ht=null,Cn=new Float32Array(Is).fill(0);const vp=[],Qh=[];let so=!1,Mn=null;const hl=new Array(Is).fill(null);let fl=!1;const pl=new Float32Array(Is).fill(1);new Float32Array(Is).fill(0);function Mh(){var A;if(!Ht||((!Ee||!ve||!Mn)&&(Ee=document.getElementById("filter-overlay-canvas"),Mn=document.querySelector(".harmonic-bins-grid"),Ee&&(ve=Ee.getContext("2d"))),!Ee||!ve||!Mn))return;const{width:n,height:t}=Ee;ve.clearRect(0,0,n,t);const s=t*.95,i=t,r=(A=h.state.timbres[Ht])==null?void 0:A.filter,o=r&&r.enabled!==!1;if(r&&o){const a=r.mix||0;if(a===0){pl.fill(1);return}const l=[];for(let f=0;f<Is;f++){const m=(f+.5)/Is,g=dA(m,r);pl[f]=yN(g,a),l.push({bin:f+1,rawFilterAmp:g.toFixed(3),afterMix:(pl[f]??0).toFixed(3)})}ve.beginPath();const c=2;for(let f=0;f<=n;f+=c){const m=f/n,g=dA(m,r),w=i-g*s;f===0?ve.moveTo(f,w):ve.lineTo(f,w)}const d=.4+a/100*.6;ve.strokeStyle=bs(bu(Ht,-.3),d),ve.lineWidth=2.5,ve.stroke();const p=a/100;if(p>0){ve.beginPath(),ve.moveTo(0,0),ve.lineTo(n,0);const f=dA(1,r),m=i-f*s;ve.lineTo(n,m);for(let g=n;g>=0;g-=2){const w=g/n,B=dA(w,r),b=i-B*s;ve.lineTo(g,b)}ve.closePath(),ve.fillStyle=`rgba(255, 255, 255, ${p})`,ve.fill()}}else pl.fill(1)}function QA(){if(!Ht)return;const n=Ht;vp.forEach((t,e)=>{const s=t.sliderTrack.querySelector(".slider-fill"),i=t.sliderTrack.querySelector(".harmonic-label-internal");if(!s||!i)return;const r=De[e]??0;if(s.style.height=`${r*100}%`,r>0){const A=bu(n,-.1);s.style.backgroundColor=bs(A,1)}else s.style.backgroundColor="transparent";const o=s.querySelector("canvas");o&&o.remove(),r>.1?(i.style.color="rgba(255, 255, 255, 0.35)",i.style.textShadow="0 0 2px rgba(0,0,0,0.3)"):(i.style.color="rgba(51, 51, 51, 0.5)",i.style.textShadow="0 0 1px rgba(255,255,255,0.3)")}),Mh()}function u0(n,t=null){var u,d,p,f;if(!Ht||!Mn)return;const e=n.target instanceof Element?n.target:null;if(Th("log","[BINS DRAG] handleBinPointerEvent called",{clientX:n.clientX,clientY:n.clientY}),E.debug("HarmonicBins","handleBinPointerEvent called",{target:e==null?void 0:e.className},"filter"),e!=null&&e.classList.contains("phase-button")||e!=null&&e.closest(".phase-button")||(e==null?void 0:e.tagName)==="path"||(e==null?void 0:e.tagName)==="svg"){E.debug("HarmonicBins","Blocking phase button interaction in handleBinPointerEvent",null,"filter");return}if(t===null){const m=Mn.getBoundingClientRect(),g=n.clientX-m.left,w=m.width/Is,B=Math.floor(g/w);t=Math.max(0,Math.min(Is-1,B))}if(E.debug("HarmonicBins","handleBinPointerEvent - binIndex",{binIndex:t},"filter"),t===null)return;const s=h.state.timbres[Ht];if(!s)return;const i=vp[t];if(!i)return;const o=i.sliderTrack.getBoundingClientRect(),A=n.clientY-o.top,a=o.height,l=(a-A)/a,c=Math.max(0,Math.min(1,l));if(Th("log","[BINS DRAG] Setting bin",t+1,"value:",c.toFixed(3)),c===0){E.debug("HarmonicBins","Setting coefficient to zero immediately for bin",{binIndex:t},"filter");const m=new Float32Array(s.coeffs);m[t]=0,De[t]=0,h.setHarmonicCoefficients(Ht,m);const g=hl[t];typeof g=="number"&&(clearTimeout(g),hl[t]=null),so||(kt.triggerAttack("C4",Ht),h.emit("spacebarPlayback",{color:Ht,isPlaying:!0}),so=!0);const w=(u=h.state.timbres[Ht])==null?void 0:u.filter;w&&w.enabled!==!1&&(w.mix||0)>0&&ia(m,w),(d=window.waveformVisualizer)!=null&&d.generateWaveform&&window.waveformVisualizer.generateWaveform(),E.debug("HarmonicBins",`Set coefficient H${t+1} to 0 for color ${Ht}`,null,"filter")}else{const m=hl[t];typeof m=="number"&&(clearTimeout(m),hl[t]=null),so||(kt.triggerAttack("C4",Ht),h.emit("spacebarPlayback",{color:Ht,isPlaying:!0}),so=!0),E.debug("HarmonicBins","BEFORE creating newCoeffs - store coeffs",{coeffs:s.coeffs},"filter");const g=new Float32Array(s.coeffs);E.debug("HarmonicBins","AFTER copying to newCoeffs",{newCoeffs:g},"filter"),g[t]=c,De[t]=c,E.debug("HarmonicBins",`AFTER setting newCoeffs[${t}] = ${c}`,{newCoeffs:g},"filter"),h.setHarmonicCoefficients(Ht,g);const w=(p=h.state.timbres[Ht])==null?void 0:p.filter;w&&w.enabled!==!1&&(w.mix||0)>0&&ia(g,w),(f=window.waveformVisualizer)!=null&&f.generateWaveform&&window.waveformVisualizer.generateWaveform(),E.debug("HarmonicBins",`Updated coefficient H${t+1} to ${c} for color ${Ht}`,null,"filter"),E.debug("HarmonicBins","All coefficients",{newCoeffs:g},"filter")}QA()}function Uh(n,t,e,s){const i=e.coeffs,r=e.phases||new Float32Array(i.length).fill(0);let o=!0,A=!0;if(n.length!==i.length)o=!1;else for(let l=0;l<n.length;l++){const c=n[l]??0,u=i[l]??0;if(Math.abs(c-u)>.001){o=!1;break}}if(t.length!==r.length)A=!1;else for(let l=0;l<t.length;l++){const c=t[l]??0,u=r[l]??0;if(Math.abs(c-u)>.001){A=!1;break}}return o&&A}function d0(n){if(!n)return;Ht=n;const t=h.state.timbres[n];t&&(t.filter?t.filter.enabled===void 0&&(t.filter.enabled=!0):t.filter={enabled:!0,blend:1,cutoff:16,resonance:0,type:"lowpass",mix:0},E.debug("HarmonicBins","updateForNewColor - timbre.coeffs",{coeffs:t.coeffs},"filter"),E.debug("HarmonicBins","updateForNewColor - timbre.phases",{phases:t.phases},"filter"),De=new Float32Array(t.coeffs),t.phases?Cn=new Float32Array(t.phases):Cn=new Float32Array(De.length).fill(0),Uh(De,Cn,t),E.debug("HarmonicBins","updateForNewColor - final coeffs",{coeffs:De},"filter"),E.debug("HarmonicBins","updateForNewColor - final phases",{phases:Cn},"filter"),Qh.forEach(({phaseBtn:e},s)=>{if(!e)return;let r=(Cn[s]||0)%(2*Math.PI);r<0&&(r+=2*Math.PI);const o=.1;let A=0;Math.abs(r-Math.PI/2)<o?A=90:Math.abs(r-Math.PI)<o?A=180:Math.abs(r-3*Math.PI/2)<o&&(A=270),e.innerHTML=Dl[A]}),QA())}function SN(){var A;const n=document.querySelector(".filter-container"),t=n==null?void 0:n.querySelector(".filter-bins-wrapper"),e=n==null?void 0:n.querySelector(".filter-vertical-blend-wrapper");if(!n||!t||!e){E.error("HarmonicBins","Missing required elements - aborting init",null,"audio");return}Mn=document.createElement("div"),Mn.className="harmonic-bins-grid";for(let a=0;a<Is;a++){const l=document.createElement("div");l.className="slider-column";const c=document.createElement("div");c.className="slider-track";const u=document.createElement("div");u.className="slider-fill",c.appendChild(u);const d=document.createElement("div");d.className="harmonic-label-internal",d.textContent=`${a+1}`,c.appendChild(d),l.appendChild(c);const p=document.createElement("button");p.className="phase-button",p.innerHTML=Dl[0],p.dataset.binIndex=String(a),p.addEventListener("pointerenter",()=>{var f,m,g;if(fl){const B=de(),b=kt.synths,_=Ht;if(_&&((m=(f=b==null?void 0:b[_])==null?void 0:f.activeNotes)!=null&&m.C4)){const v=b[_].activeNotes.C4;(g=v.oscillators)!=null&&g[a]&&v.oscillators[a].volume.linearRampTo(-1/0,.015,B)}setTimeout(()=>{var F;const v=Ht,C=v?h.state.timbres[v]:void 0;if(!v||!C)return;const y=new Float32Array(C.coeffs);y[a]=0,De[a]=0,h.setHarmonicCoefficients(v,y);const S=(F=h.state.timbres[v])==null?void 0:F.filter;S&&S.enabled!==!1&&(S.mix||0)>0&&ia(y,S),QA()},.015*1e3)}}),p.addEventListener("click",f=>{var y;if(fl){f.preventDefault();return}const m=Ht;if(!m)return;E.debug("HarmonicBins","Phase button click handler started",null,"filter"),E.debug("HarmonicBins","Current coeffs before phase change",{coeffs:De},"filter"),f.preventDefault();const g=new Float32Array(Cn),w=new Float32Array(Cn);let b=(w[a]||0)%(2*Math.PI);b<0&&(b+=2*Math.PI);const _=.1;let v=0;Math.abs(b)<_?v=Math.PI/2:Math.abs(b-Math.PI/2)<_?v=Math.PI:Math.abs(b-Math.PI)<_?v=3*Math.PI/2:v=0,w[a]=v,Cn=w,(y=window.waveformVisualizer)!=null&&y.startPhaseTransition&&window.waveformVisualizer.startPhaseTransition(g,w,a),h.setHarmonicPhases(m,w);const C=v===0?0:Math.abs(v-Math.PI/2)<_?90:Math.abs(v-Math.PI)<_?180:270;p.innerHTML=Dl[C],E.debug("HarmonicBins",`Phase button clicked for H${a+1}, new phase: ${C}`,null,"filter")}),l.appendChild(p),Mn.appendChild(l),vp.push({column:l,label:d,sliderTrack:c,sliderFill:u,phaseBtn:p}),Qh.push({phaseBtn:p})}Mn.addEventListener("pointerdown",a=>{const l=a.target instanceof Element?a.target:null;if(Th("log","[BINS DRAG] Pointerdown event fired",{target:l,className:l==null?void 0:l.className}),l!=null&&l.classList.contains("phase-button")||l!=null&&l.closest(".phase-button")){E.debug("HarmonicBins","Pointerdown blocked - phase button clicked",null,"filter");return}if(E.debug("HarmonicBins","Pointerdown - handling bin interaction",null,"filter"),a.preventDefault(),fl=!0,!Ht)return;const c=Ht;kt.triggerAttack("C4",c),h.emit("spacebarPlayback",{color:c,isPlaying:!0}),so=!0,u0(a);const u=p=>u0(p),d=()=>{var f;window.removeEventListener("pointermove",u),window.removeEventListener("pointerup",d),fl=!1;const p=!!((f=window.waveformVisualizer)!=null&&f.generateWaveform);h.recordState(),kt.triggerRelease("C4",c),h.emit("spacebarPlayback",{color:c,isPlaying:!1}),so=!1,p?setTimeout(()=>{var m,g;(g=(m=window.waveformVisualizer)==null?void 0:m.generateWaveform)==null||g.call(m)},0):E.warn("HarmonicBins","Static waveform visualizer not ready when drag ended",null,"audio")};window.addEventListener("pointermove",u),window.addEventListener("pointerup",d)}),Ee=document.createElement("canvas"),Ee.id="filter-overlay-canvas",Ee.className="filter-overlay-canvas",Ee.style.pointerEvents="none",ve=Ee.getContext("2d"),Mn.appendChild(Ee);const s=document.createElement("div");s.className="vertical-blend-wrapper";const i=document.createElement("div");i.id="vertical-blend-track";const r=document.createElement("div");r.id="vertical-blend-thumb",r.textContent="M",i.appendChild(r),s.appendChild(i),t.appendChild(Mn),e.appendChild(s);const o=()=>{if(!Ee)return;const a=Ee.getBoundingClientRect();(Ee.width!==a.width||Ee.height!==a.height)&&(Ee.width=a.width,Ee.height=a.height,Mh())};Ht=((A=h.state.selectedNote)==null?void 0:A.color)||"#4a90e2",d0(Ht),h.on("timbreChanged",a=>{if(a&&a===Ht){E.debug("HarmonicBins","timbreChanged event - checking what changed",null,"filter");const l=h.state.timbres[a];if(!l)return;const c=l.coeffs,u=l.phases;let d=!1;if(E.debug("HarmonicBins","Comparing coefficients...",null,"filter"),E.debug("HarmonicBins","Local coeffs",{coeffs:De},"filter"),E.debug("HarmonicBins","Store coeffs",{newCoeffs:c},"filter"),De.length!==c.length)E.debug("HarmonicBins","Array length mismatch - coeffsChanged = true",null,"filter"),d=!0;else for(let p=0;p<c.length;p++){const f=De[p]??0,m=c[p]??0,g=Math.abs(f-m);if(g>.001){E.debug("HarmonicBins",`Coefficient ${p} changed: ${f} -> ${m} (diff: ${g})`,null,"filter"),d=!0;break}}E.debug("HarmonicBins","Force syncing local coeffs with store",null,"filter"),Uh(De,Cn,l),De=new Float32Array(c),u?Cn=new Float32Array(u):Cn=new Float32Array(De.length).fill(0),Uh(De,Cn,l),d?(E.debug("HarmonicBins","Coefficients changed - updating visuals",null,"filter"),QA()):(E.debug("HarmonicBins","No coefficient changes detected - but local coeffs synced",null,"filter"),Mh()),Qh.forEach(({phaseBtn:p},f)=>{if(!p)return;let g=(Cn[f]||0)%(2*Math.PI);g<0&&(g+=2*Math.PI);const w=.1;let B=0;Math.abs(g-Math.PI/2)<w?B=90:Math.abs(g-Math.PI)<w?B=180:Math.abs(g-3*Math.PI/2)<w&&(B=270),p.innerHTML=Dl[B]})}}),h.on("noteChanged",({newNote:a}={})=>{a!=null&&a.color&&a.color!==Ht&&d0(a.color)}),h.on("filterChanged",a=>{const l=Ht;if(l&&a===l){QA();const c=h.state.timbres[l],u=c==null?void 0:c.filter;if(!c)return;u&&u.enabled!==!1&&(u.mix||0)>0?ia(c.coeffs,u):new Float32Array(c.coeffs)}}),new ResizeObserver(o).observe(Mn),o(),E.info("HarmonicBins","Initialized with columnar div structure and perfect alignment",null,"filter")}E.moduleLoaded("EngineAudio","general");let wt=null;const kt={init(){E.info("EngineAudio","Initializing with engine createSynthEngine()",null,"audio"),wt=Y_({timbres:h.state.timbres,masterVolume:0,harmonicFilter:{getFilteredCoefficients:n=>Fh(n)},effectsManager:window.audioEffectsManager?{applySynthEffects:(n,t,e)=>{var s;(s=window.audioEffectsManager)==null||s.applySynthEffects(n,t,e)},applyEffectsToVoice:(n,t)=>{var e;(e=window.audioEffectsManager)==null||e.applyEffectsToVoice(n,t)}}:void 0,logger:{debug:(n,t,e)=>{E.debug(n,t,e,"audio")},info:(n,t,e)=>{E.info(n,t,e,"audio")},warn:(n,t,e)=>{E.warn(n,t,e,"audio")}}}),wt.init(),h.on("timbreChanged",n=>{n&&this.updateSynthForColor(n)}),h.on("filterChanged",n=>{n&&this.updateSynthForColor(n)}),h.on("audioEffectChanged",n=>{if(!n||!n.color||!n.effectType)return;const{effectType:t,color:e}=n;(t==="vibrato"||t==="tremolo")&&this.updateSynthForColor(e)}),h.on("volumeChanged",n=>{typeof n=="number"&&this.setVolume(n)}),window.synthEngine=this,E.info("EngineAudio","Initialization complete",null,"audio")},updateSynthForColor(n){if(!wt)return;const t=h.state.timbres[n];t&&(t.vibrato||(t.vibrato={speed:0,span:0}),t.tremelo||(t.tremelo={speed:0,span:0}),wt.updateSynthForColor(n))},playNote(n,t,e){wt&&wt.playNote(n,t,e)},triggerAttack(n,t,e,s){wt&&wt.triggerAttack(n,t,e,s)},triggerAttackInteractive(n,t){wt&&wt.triggerAttackInteractive(n,t)},triggerRelease(n,t,e){wt&&wt.triggerRelease(n,t,e)},releaseAll(){wt&&wt.releaseAll()},quickReleasePitches(n,t){wt&&wt.quickReleasePitches(n,t)},setSynth(n,t){var e;wt&&((e=wt.setSynth)==null||e.call(wt,n,t))},getSynth(n){return wt?wt.getSynth(n):null},getAllSynths(){return wt?wt.getAllSynths():{}},setBpm(n){wt&&wt.setBpm(n)},setVolume(n){wt&&wt.setVolume(n)},getMasterGainNode(){return wt?wt.getMasterGainNode():null},getMainVolumeNode(){return wt?wt.getMainVolumeNode():null},createWaveformAnalyzer(n){return wt?wt.createWaveformAnalyzer(n):null},getWaveformAnalyzer(n){return wt?wt.getWaveformAnalyzer(n):null},getAllWaveformAnalyzers(){return wt?wt.getAllWaveformAnalyzers():new Map},removeWaveformAnalyzer(n){wt&&wt.removeWaveformAnalyzer(n)},disposeAllWaveformAnalyzers(){wt&&wt.disposeAllWaveformAnalyzers()},stopBackgroundMonitors(){wt&&wt.stopBackgroundMonitors()},teardown(){this.dispose()},dispose(){wt&&(wt.dispose(),wt=null)}};class EN{constructor(){I(this,"elements",new Map);I(this,"initialized",!1)}init(){this.initialized||(this.cacheElement("notationGrid","notation-grid"),this.cacheElement("playheadCanvas","playhead-canvas"),this.cacheElement("hoverCanvas","hover-canvas"),this.cacheElement("drumGrid","drum-grid"),this.cacheElement("drumPlayheadCanvas","drum-playhead-canvas"),this.cacheElement("drumHoverCanvas","drum-hover-canvas"),this.cacheElement("appContainer","app-container"),this.cacheElement("pitchGridWrapper","pitch-grid-wrapper"),this.cacheElement("drumGridWrapper","drum-grid-wrapper"),this.cacheElement("eraserButton","eraser-tool-button"),this.cacheElement("playButton","play-button"),this.cacheElement("stopButton","stop-button"),this.cacheElement("clearButton","clear-button"),this.cacheElement("loopButton","loop-button"),this.cacheElement("undoButton","undo-button"),this.cacheElement("redoButton","redo-button"),this.cacheElement("noteBankContainer","note-bank-container"),this.cacheElement("tonicModeGrid","tonic-mode-grid"),this.cacheElement("degreeVisibilityToggle","degree-visibility-toggle"),this.cacheElement("degreeModeToggle","degree-mode-toggle"),this.cacheElement("flatBtn","flat-toggle-btn"),this.cacheElement("sharpBtn","sharp-toggle-btn"),this.cacheElement("frequencyBtn","hz-toggle-btn"),this.cacheElement("octaveLabelBtn","spn-octave-toggle-btn"),this.cacheElement("focusColoursToggle","focus-colours-toggle"),this.cacheElement("harmonyContainerMain","chordShape-container"),this.cacheElement("tempoSlider","tempo-slider"),this.cacheElement("volumeSlider","vertical-volume-slider"),this.initialized=!0)}cacheElement(t,e){const s=document.getElementById(e);s&&this.elements.set(t,s)}get(t){return this.initialized?this.elements.get(t)??null:null}getMultiple(...t){const e={};return t.forEach(s=>{e[s]=this.get(s)}),e}has(t){return this.elements.has(t)}refresh(){this.elements.clear(),this.initialized=!1,this.init()}getStats(){const t=this.elements.size,e=Array.from(this.elements.values()).filter(s=>s!==null).length;return{totalCached:t,foundElements:e,missingElements:t-e}}}const Ai=new EN;let xN=[],_N=0,h0=null,Ll=[];function IN(){const n=h.state,t=Fe.getColumnMap(n);if(h0!==t){h0=t,Ll=[];for(const e of t.entries){if(e.type!=="beat"||e.canvasIndex===null||e.macrobeatIndex===null)continue;const s=e.macrobeatIndex,i=Ll[s];if(!i){Ll[s]={start:e.canvasIndex,end:e.canvasIndex};continue}i.start=Math.min(i.start,e.canvasIndex),i.end=Math.max(i.end,e.canvasIndex)}}}function Bp(){return{cellWidth:h.state.cellWidth,modulationMarkers:h.state.modulationMarkers,baseMicrobeatPx:h.state.baseMicrobeatPx}}function f0(){return xN}function FN(){return _N}function Bc(n){const t=Bp(),e=Math.max(0,Math.floor(n)),s=zi.getColumnPixelPosition(e,t,h.state);return(s==null?void 0:s.xStart)??0}function pC(n){const t=Bp(),e=Math.max(0,Math.floor(n)),s=zi.getColumnPixelPosition(e,t,h.state);return(s==null?void 0:s.width)??0}function TN(){return Array.isArray(h.state.columnWidths)?h.state.columnWidths.length:0}function QN(){const n=Bp(),t=TN(),e=zi.getColumnPixelPosition(t,n,h.state);return(e==null?void 0:e.xStart)??0}function Ph(n){const t=h.state;IN();const e=Fe.getColumnMap(t),s=e.canvasToVisual.get(Math.floor(n));if(s===void 0)return null;const i=e.entries[s],r=i==null?void 0:i.macrobeatIndex;if(r==null)return null;const o=Ll[r];if(!o)return null;const A=Bc(o.start),a=Bc(o.end+1);return{x:A,width:Math.max(0,a-A)}}const MN={hz:0,minAlpha:.2,maxAlpha:.2,maxExpandPx:0,colorRgb:"rgb(255, 235, 0)"};function hA(n,t,e,s,i,r,o=MN){if(!Number.isFinite(t)||!Number.isFinite(e)||!Number.isFinite(s)||!Number.isFinite(i)||s<=0||i<=0)return;const A=r/1e3,a=o.hz>0?.5+.5*Math.sin(A*(2*Math.PI)*o.hz):1,l=o.minAlpha+(o.maxAlpha-o.minAlpha)*a,c=Math.min(o.maxExpandPx,Math.max(0,s*.1))*a;n.save(),n.globalAlpha=l,n.fillStyle=o.colorRgb,n.fillRect(t-c/2,e,s+c,i),n.restore()}class UN{constructor(){I(this,"canvas",null);I(this,"ctx",null);I(this,"animationFrameId",null);I(this,"_lastColumnIndex",null);I(this,"_lastColumnProgress",0);I(this,"_lastColumnStartX",0);I(this,"_lastColumnWidth",0);I(this,"_lastDebugLogTime",0);I(this,"activeAnimations",new Map);I(this,"popDuration",{scaleUp:100,scaleDown:300});I(this,"popScale",1.5)}ensureContext(){return this.canvas||(this.canvas=document.getElementById("drum-playhead-canvas")),this.canvas?(this.ctx||(this.ctx=this.canvas.getContext("2d")),this.ctx):null}initialize(){this.canvas=document.getElementById("drum-playhead-canvas"),this.canvas&&(this.ctx=this.canvas.getContext("2d"),h.on("playbackStateChanged",()=>this.handlePlaybackStateChange()),h.on("tempoChanged",()=>this.invalidateTimeMap()))}drawPlayheadLine(t){const e=this.ensureContext();if(!e||!this.canvas)return;const s=ie(this.canvas);e.strokeStyle="rgba(255, 0, 0, 0.8)",e.lineWidth=2,e.beginPath(),e.moveTo(t,0),e.lineTo(t,s),e.stroke()}drawColumnHighlight(t,e,s){const i=this.ensureContext();if(!i||!this.canvas)return;const r=ie(this.canvas);hA(i,t,0,e,r,s)}handlePlaybackStateChange(){h.state.isPlaying&&!h.state.isPaused?this.startRendering():this.stopRendering({clear:!h.state.isPaused})}invalidateTimeMap(){}startRendering(){this.animationFrameId||this.render()}stopRendering({clear:t}={clear:!0}){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),t&&this.ctx&&this.canvas&&this.ctx.clearRect(0,0,He(this.canvas),ie(this.canvas))}render(){if(!h.state.isPlaying||h.state.isPaused||!this.ctx||!this.canvas){this.animationFrameId=null;return}this.ctx.clearRect(0,0,He(this.canvas),ie(this.canvas));const t=Number(dt.seconds||0),e=this.calculateXFromTime(t);if(e===null){this.animationFrameId=requestAnimationFrame(()=>this.render());return}const s=ie(this.canvas);if(h.state.playheadMode==="macrobeat"){const i=this._lastColumnIndex,r=(i!==null?Ph(i):null)??(i!==null?Ph(i+1):null);r?hA(this.ctx,r.x,0,r.width,s,performance.now()):hA(this.ctx,this._lastColumnStartX,0,this._lastColumnWidth,s,performance.now())}else h.state.playheadMode==="microbeat"?hA(this.ctx,this._lastColumnStartX,0,this._lastColumnWidth,s,performance.now()):(this.ctx.strokeStyle="#FF6B35",this.ctx.lineWidth=3,this.ctx.shadowColor="#FF6B35",this.ctx.shadowBlur=6,this.ctx.beginPath(),this.ctx.moveTo(e,0),this.ctx.lineTo(e,s),this.ctx.stroke(),this.ctx.shadowBlur=0);this.debugPlayhead(dt.seconds,e),this.animationFrameId=requestAnimationFrame(()=>this.render())}calculateXFromTime(t){this._lastColumnIndex=null,this._lastColumnProgress=0,this._lastColumnStartX=0,this._lastColumnWidth=0;const e=f0();if(!Array.isArray(e)||e.length<2)return null;for(let s=0;s<e.length-1;s++){const i=e[s],r=e[s+1];if(!(typeof i!="number"||typeof r!="number")&&t>=i&&t<r){const o=r-i,A=t-i,a=Bc(s)??0,l=pC(s)??0;return this._lastColumnIndex=s,this._lastColumnProgress=o>0?A/o:0,this._lastColumnStartX=a,this._lastColumnWidth=l,a+(o>0?A/o*l:0)}}return null}debugPlayhead(t,e){if(!window.__DEBUG_PLAYHEAD_SYNC__)return;const s=performance.now();if(s-this._lastDebugLogTime<250)return;this._lastDebugLogTime=s;const i=f0(),r=this._lastColumnIndex,o=Array.isArray(i)&&r!==null&&r>=0?i[r]:void 0,A=Array.isArray(i)&&r!==null&&r+1<i.length?i[r+1]:void 0,a=Array.isArray(i)?i[i.length-1]??0:0,l=FN(),c={transportSeconds:Number(t.toFixed(3)),drumX:Number((e??0).toFixed(2)),columnIndex:r,columnProgress:Number(this._lastColumnProgress.toFixed(3)),drumStartTime:Number((o==null?void 0:o.toFixed(3))??NaN),transportStartTime:Number((o==null?void 0:o.toFixed(3))??NaN),startDelta:0,drumEndTime:Number((A==null?void 0:A.toFixed(3))??NaN),transportEndTime:Number((A==null?void 0:A.toFixed(3))??NaN),endDelta:0,drumTimelineEnd:Number(a.toFixed(3)),transportTimelineEnd:Number(l.toFixed(3)),timelineDelta:Number((a-l).toFixed(3)),toneLoopStart:Number(Number(dt.loopStart??0).toFixed(3)),toneLoopEnd:Number(Number(dt.loopEnd??0).toFixed(3)),storeLooping:h.state.isLooping};E.debug("DrumPlayheadRenderer","Playhead diagnostics",c,"canvas")}triggerNotePop(t,e){const s=`${t}-${e}`;this.activeAnimations.set(s,{startTime:performance.now(),phase:"scaleUp"}),window.drumGridRenderer&&window.drumGridRenderer.render()}getAnimationScale(t,e){const s=`${t}-${e}`,i=this.activeAnimations.get(s);if(!i)return 1;const r=performance.now(),o=r-i.startTime;if(i.phase==="scaleUp"){if(o>=this.popDuration.scaleUp)return i.phase="scaleDown",i.startTime=r,this.popScale;{const A=o/this.popDuration.scaleUp;return 1+(this.popScale-1)*A}}else if(i.phase==="scaleDown"){if(o>=this.popDuration.scaleDown)return this.activeAnimations.delete(s),1;{const A=o/this.popDuration.scaleDown;return this.popScale-(this.popScale-1)*A}}return 1}hasActiveAnimations(){return this.activeAnimations.size>0}cleanupAnimations(){const t=performance.now();for(const[e,s]of this.activeAnimations.entries()){const i=t-s.startTime,r=s.phase==="scaleUp"?this.popDuration.scaleUp:this.popDuration.scaleUp+this.popDuration.scaleDown;i>r&&this.activeAnimations.delete(e)}}}const ei=new UN;E.moduleLoaded("SixteenthStampPlacements","stamps");function PN(n,t,e,s="#4a90e2"){return cu(n)?h.addSixteenthStampPlacement(n,t,e,s):(E.warn("SixteenthStampPlacements",`Invalid sixteenth stamp ID: ${n}`,{sixteenthStampId:n},"stamps"),null)}function NN(n,t,e,s){return h.eraseSixteenthStampsInArea(n,t,e,s)}function mC(){h.clearAllSixteenthStamps()}function DN(){return h.getSixteenthStampPlaybackData()}E.moduleLoaded("SixteenthStampScheduler","stamps");const p0=["0","16n","8n",{"8n":1,"16n":1}];function gC(n,t=null){const e=cu(n);if(!e)return E.warn("SixteenthStampScheduler",`Unknown sixteenth stamp ID: ${n}`,{sixteenthStampId:n},"stamps"),[];const s=[];return e.ovals.forEach(i=>{var A;const r=`oval_${i}`,o=((A=t==null?void 0:t.shapeOffsets)==null?void 0:A[r])||0;s.push({offset:p0[i],duration:"8n",type:"oval",slot:i,shapeKey:r,rowOffset:o})}),e.diamonds.forEach(i=>{var A;const r=`diamond_${i}`,o=((A=t==null?void 0:t.shapeOffsets)==null?void 0:A[r])||0;s.push({offset:p0[i],duration:"16n",type:"diamond",slot:i,shapeKey:r,rowOffset:o})}),s}E.moduleLoaded("TripletStampPlacements","triplets");function LN(n,t,e,s="#4a90e2"){const i=uu(n);if(!i)return E.warn("TripletStampPlacements",`Invalid triplet stamp ID: ${n}`,{tripletStampId:n},"triplets"),null;const r=eB[i.span]??1;if(!kN(t,r,e))return E.debug("TripletStampPlacements",`Cannot place triplet at time ${t}, row ${e} - collision detected`,{tripletStampId:n,startTimeIndex:t,row:e,span:r},"triplets"),null;const o=e,A={id:`triplet_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,tripletStampId:n,startTimeIndex:t,span:r,row:e,globalRow:o,color:s,timestamp:Date.now()};return h.addTripletStampPlacement(A)}function kN(n,t,e){const s=h.state,i=Ve(s),r=t*2,o=gn(n,s);for(const A of i){const a=A.columnIndex,l=A.columnIndex+1;if(a>=o&&a<o+r||o>=a&&o<=l)return!1}if(s.sixteenthStampPlacements){for(const A of s.sixteenthStampPlacements)if(A.row===e){const a=Vi(A.startColumn,s);if(a===null)return!1;const l=a+2,c=n+r;if(!(l<=n||a>=c))return!1}}if(s.tripletStampPlacements){for(const A of s.tripletStampPlacements)if(A.row===e){const a=A.startTimeIndex+A.span*2;if(!(n+r<=A.startTimeIndex||n>=a))return!1}}return!0}function RN(n,t,e,s){const i=h.state;if(!i.tripletStampPlacements)return!1;const r=[];for(const o of i.tripletStampPlacements)if(o.row>=e&&o.row<=s){const A=o.span*2,a=gn(o.startTimeIndex,i);a+A-1<n||a>t||r.push(o.id)}return r.length>0?(r.forEach(o=>h.removeTripletStampPlacement(o)),E.debug("TripletStampPlacements",`Erased ${r.length} triplet groups`,{removedIds:r,eraseArea:{eraseStartCol:n,eraseEndCol:t,eraseStartRow:e,eraseEndRow:s}},"triplets"),!0):!1}function HN(){return h.getTripletStampPlaybackData()}function wC(){h.clearAllTripletStamps(),E.info("TripletStampPlacements","Cleared all triplet stamp placements",null,"triplets")}E.moduleLoaded("TripletScheduler","triplets");function vC(n,t=null){const e=uu(n);if(!e)return E.warn("TripletScheduler",`Unknown triplet stamp ID: ${n}`,{tripletStampId:n},"triplets"),[];const s=[],i=e.span==="eighth"?"8t":"4t",r=i;return e.hits.forEach(o=>{var c;const A=`triplet_${o}`,a=((c=t==null?void 0:t.shapeOffsets)==null?void 0:c[A])||0;let l;if(o===0)l="0";else if(o===1)l=i;else if(o===2){const u=Be(i).toSeconds();l=Be(u*2).toNotation()}else{const u=Be(i).toSeconds();l=Be(u*o).toNotation()}s.push({offset:l,duration:r,type:e.span==="eighth"?"triplet-eighth":"triplet-quarter",slot:o,shapeKey:A,rowOffset:a}),E.debug("TripletScheduler",`Triplet stamp ${n} ${e.span} at slot ${o} with offset "${l}", rowOffset: ${a}`,"triplets")}),E.debug("TripletScheduler",`Total events for triplet stamp ${n}:`,s.length,"triplets"),s}E.moduleLoaded("EngineTransport","general");let Ke=null;const Jo=()=>Ai.get("playheadCanvas")??document.getElementById("playhead-canvas"),ml=()=>Ai.get("drumPlayheadCanvas")??document.getElementById("drum-playhead-canvas"),ON=()=>Ai.get("beatLineHighlight")??document.getElementById("beat-line-highlight"),Ys={init(){E.info("EngineTransport","Initializing with engine createTransportService()",null,"transport"),Ke=eI({synthEngine:kt,stateCallbacks:{getState:()=>({tempo:h.state.tempo,columnWidths:h.state.columnWidths,hasAnacrusis:h.state.hasAnacrusis,macrobeatBoundaryStyles:h.state.macrobeatBoundaryStyles,modulationMarkers:h.state.modulationMarkers,isLooping:h.state.isLooping,isPaused:h.state.isPaused,cellWidth:h.state.cellWidth,placedNotes:h.state.placedNotes,timbres:h.state.timbres,fullRowData:h.state.fullRowData,playheadMode:h.state.playheadMode}),getStampPlaybackData:()=>DN().map(n=>({sixteenthStampId:String(n.sixteenthStampId),column:n.column,row:n.row,color:n.color,placement:n.placement})),getStampScheduleEvents:(n,t)=>{const e=typeof n=="string"?Number(n):n;return Number.isFinite(e)?gC(e,t??null):[]},getTripletPlaybackData:()=>HN().map(n=>({tripletStampId:String(n.tripletStampId),startTimeIndex:n.startTimeIndex,row:n.row,color:n.color,placement:n.placement})),getTripletScheduleEvents:(n,t)=>{const e=typeof n=="string"?Number(n):n;return Number.isFinite(e)?vC(e,t??null):[]},timeToCanvas:(n,t)=>gn(n,t),getPlacedTonicSigns:()=>Ve(h.state),getTonicSpanColumnIndices:n=>vT(n),getMacrobeatInfo:n=>dn(h.state,n),getColumnStartX:n=>Bc(n),getColumnWidth:n=>pC(n),getCanvasWidth:()=>QN(),getMacrobeatHighlightRect:n=>Ph(n)},eventCallbacks:{on:(n,t)=>h.on(n,t),emit:(n,t)=>h.emit(n,t),setPlaybackState:(n,t)=>h.setPlaybackState(n,t)},visualCallbacks:{clearPlayheadCanvas:()=>{const n=Jo();if(!n)return;const t=n.getContext("2d");if(!t)return;const e=He(n),s=ie(n);t.clearRect(0,0,e,s)},clearDrumPlayheadCanvas:()=>{const n=ml();if(!n)return;const t=n.getContext("2d");if(!t)return;const e=He(n),s=ie(n);t.clearRect(0,0,e,s)},drawPlayheadLine:(n,t)=>{const e=Jo();if(!e)return;const s=e.getContext("2d");s&&(s.strokeStyle="rgba(255, 0, 0, 0.8)",s.lineWidth=2,s.beginPath(),s.moveTo(n,0),s.lineTo(n,t),s.stroke())},drawPlayheadHighlight:(n,t,e,s)=>{const i=Jo();if(!i)return;const r=i.getContext("2d");r&&hA(r,n,0,t,e,s)},drawDrumPlayheadLine:(n,t)=>{ml()&&ei.drawPlayheadLine(n)},drawDrumPlayheadHighlight:(n,t,e,s)=>{ml()&&ei.drawColumnHighlight(n,t,s)},updateBeatLineHighlight:(n,t,e)=>{const s=ON();s&&(e?(s.style.left=`${n}px`,s.style.width=`${t}px`,s.style.display="block"):s.style.display="none")},triggerDrumNotePop:(n,t)=>{ei.triggerNotePop(n,t)},triggerAdsrVisual:(n,t,e,s)=>{window.adsrComponent&&window.adsrComponent.triggerPlayheadVisual(n,t,e,s)},clearAdsrVisuals:()=>{window.adsrComponent&&window.adsrComponent.clearAllPlayheadVisuals()},getPlayheadCanvasWidth:()=>{const n=Jo();return n?He(n):0},getPlayheadCanvasHeight:()=>{const n=Jo();return n?ie(n):0},getDrumCanvasHeight:()=>{const n=ml();return n?ie(n):0}},logger:{debug:(n,t,e)=>{E.debug(n,t,e,"transport")},info:(n,t,e)=>{E.info(n,t,e,"transport")},warn:(n,t,e)=>{E.warn(n,t,e,"transport")}}}),Ke.init(),E.info("EngineTransport","Initialization complete",null,"transport")},handleStateChange(){Ke&&Ke.handleStateChange()},start(){Ke&&Ke.start()},resume(){Ke&&Ke.resume()},pause(){Ke&&Ke.pause()},stop(){Ke&&Ke.stop()},dispose(){Ke&&(Ke.dispose(),Ke=null)}},VN=/(Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini)/i,BC=900;let m0=!1,kl=BC,wd=!1;const WN=Object.freeze({isMobile:!1,isTouch:!1,isCoarsePointer:!1,orientation:"landscape",width:0,height:0});function Cp(){return typeof window<"u"?window:null}function GN(){const n=Cp();if(!n)return{...WN};const{innerWidth:t=0,innerHeight:e=0}=n,s=n.matchMedia?n.matchMedia("(orientation: portrait)"):null,i=s?s.matches?"portrait":"landscape":e>=t?"portrait":"landscape",r=!!(n.matchMedia&&n.matchMedia("(pointer: coarse)").matches),o=!!(n.matchMedia&&n.matchMedia("(hover: none)").matches),A=typeof navigator<"u"?navigator:null,a=(A==null?void 0:A.maxTouchPoints)??(A==null?void 0:A.msMaxTouchPoints)??0,l="ontouchstart"in n||a>0,c=A!=null&&A.userAgent?VN.test(A.userAgent):!1,u=t>0?t<=kl:!1;return{isMobile:!!(c||l&&(r||o||u)),isTouch:l,isCoarsePointer:r,orientation:i,width:t,height:e}}function KN(n){if(typeof document>"u")return;[document.documentElement,document.body].filter(Boolean).forEach(e=>{e.classList.toggle("is-mobile",!!n.isMobile),e.classList.toggle("is-touch",!!n.isTouch),e.classList.toggle("orientation-portrait",n.orientation==="portrait"),e.classList.toggle("orientation-landscape",n.orientation==="landscape")})}function gl(){if(wd)return;const n=Cp();n&&(wd=!0,n.requestAnimationFrame(()=>{wd=!1;const t=GN();h.setDeviceProfile(t),KN(t)}))}function qN(n,t){return n?typeof n.addEventListener=="function"?(n.addEventListener("change",t),()=>n.removeEventListener("change",t)):typeof n.addListener=="function"?(n.addListener(t),()=>n.removeListener(t)):()=>{}:()=>{}}function zN(n={}){const t=Cp();if(!t||m0)return;kl=n.maxMobileWidth??BC,m0=!0;const e=()=>gl(),s=()=>gl();t.addEventListener("resize",e),t.addEventListener("orientationchange",s),[t.matchMedia&&t.matchMedia("(pointer: coarse)"),t.matchMedia&&t.matchMedia("(hover: none)"),t.matchMedia&&t.matchMedia(`(max-width: ${kl}px)`),t.matchMedia&&t.matchMedia("(orientation: portrait)")].filter(Boolean).forEach(r=>{qN(r,gl)}),gl(),E.debug("DeviceProfileService",`Initialized (breakpoint <= ${kl}px)`,null,"ui")}const XN=()=>{const n="/music-learning-tools/student-notation/";return n.endsWith("/")?n:`${n}/`},$N=`${XN()}assets/`;function YN(n=""){const t=n.replace(/^\/+/,"");return`${$N}${t}`}function fs(n){return YN(`icons/${n}`)}class jN{constructor(){I(this,"tasks",[]);I(this,"completedTasks",0);I(this,"totalTasks",0);I(this,"startTime",null);I(this,"loadingScreen",null);I(this,"progressBar",null);I(this,"progressText",null);I(this,"statusText",null);I(this,"initialized",!1);I(this,"cache",{fonts:new Map,icons:new Map,modules:new Map});I(this,"diagnostics",[])}createLoadingScreen(){if(this.loadingScreen)return;const t=document.getElementById("app-loading-screen");t?this.loadingScreen=t:(this.loadingScreen=document.createElement("div"),this.loadingScreen.id="app-loading-screen",this.loadingScreen.innerHTML=`
            <div class="loading-container">
                <div class="loading-logo">
                    <svg viewBox="0 0 100 100" class="logo-svg">
                        <circle cx="50" cy="50" r="45" class="logo-circle" />
                        <path d="M 30 50 Q 50 30, 70 50 T 70 70" class="logo-path" />
                    </svg>
                </div>
                <h1 class="loading-title">Student Notation</h1>
                <div class="loading-progress-container">
                    <div class="loading-progress-bar">
                        <div class="loading-progress-fill" id="loading-progress-fill"></div>
                    </div>
                    <div class="loading-progress-text" id="loading-progress-text">0%</div>
                </div>
                <div class="loading-status" id="loading-status">Initializing...</div>
            </div>
        `,document.body.appendChild(this.loadingScreen)),this.progressBar=this.loadingScreen.querySelector("#loading-progress-fill"),this.progressText=this.loadingScreen.querySelector("#loading-progress-text"),this.statusText=this.loadingScreen.querySelector("#loading-status")}registerTask(t,e=1){this.tasks.push({name:t,weight:e,completed:!1}),this.totalTasks+=e}completeTask(t){const e=this.tasks.find(s=>s.name===t&&!s.completed);e&&(e.completed=!0,this.completedTasks+=e.weight,this.updateProgress())}updateProgress(){if(!this.progressBar||!this.progressText)return;const t=this.totalTasks>0?this.completedTasks/this.totalTasks*100:0;this.progressBar.style.width=`${t}%`,this.progressText.textContent=`${Math.floor(t)}%`,t>=100&&this.completeLoading()}async nextFrame(){await new Promise(t=>{typeof requestAnimationFrame=="function"?requestAnimationFrame(()=>t()):setTimeout(t,0)})}setStatus(t){this.statusText&&(this.statusText.textContent=t)}start(){this.initialized||(this.initialized=!0,this.startTime=performance.now())}completeLoading(){this.loadingScreen&&(this.loadingScreen.classList.add("fade-out"),setTimeout(()=>{var t;(t=this.loadingScreen)==null||t.remove(),this.loadingScreen=null},400))}showError(t){if(this.statusText){const e=t instanceof Error?t.message:String(t);this.statusText.textContent=`Error: ${e}`,this.statusText.style.color="#ff4444"}}init(){this.createLoadingScreen(),this.start()}updateStatus(t){this.setStatus(t)}async complete(){this.completeLoading()}async preloadIcon(t){if(this.cache.icons.has(t))return this.cache.icons.get(t);const e=fs(t);return this.cache.icons.set(t,e),e}getDiagnostics(){return[...this.diagnostics]}}const gt=new jN;let bp=!1,yp=[],Rl=null;function CC(){bp=!0}function JN(){bp=!1}function bC(n){try{return JSON.parse(JSON.stringify(n,(t,e)=>e instanceof Float32Array?{__type:"Float32Array",data:Array.from(e)}:e))}catch{return null}}function Nh(n,t,e="root"){const s=[];if(!n||!t)return s;if(typeof n!=typeof t)return s.push({path:e,type:"type_change",oldValue:typeof n,newValue:typeof t,timestamp:Date.now()}),s;if(typeof n!="object")return n!==t&&s.push({path:e,type:"value_change",oldValue:n,newValue:t,timestamp:Date.now()}),s;if(Array.isArray(n)){if(!Array.isArray(t))return s.push({path:e,type:"array_to_non_array",oldLength:n.length,newType:typeof t,timestamp:Date.now()}),s;n.length!==t.length&&s.push({path:e,type:"array_length_change",oldLength:n.length,newLength:t.length,timestamp:Date.now()});const r=Math.max(n.length,t.length);for(let o=0;o<r;o++){const A=Nh(n[o],t[o],`${e}[${o}]`);s.push(...A)}return s}const i=new Set([...Object.keys(n),...Object.keys(t)]);for(const r of i)if(!(r in n))s.push({path:`${e}.${String(r)}`,type:"property_added",newValue:t[r],timestamp:Date.now()});else if(!(r in t))s.push({path:`${e}.${String(r)}`,type:"property_removed",oldValue:n[r],timestamp:Date.now()});else{const o=Nh(n[r],t[r],`${e}.${String(r)}`);s.push(...o)}return s}function ZN(n){Rl=bC(n)}function tD(n,t="unknown"){if(!bp||!Rl)return;const e=bC(n),s=Nh(Rl,e);if(s.length>0){const i=s.filter(r=>!r.path.includes("tempo")&&!r.path.includes("isPlaying")&&!r.path.includes("fullRowData")&&!r.path.includes("columnWidths"));i.length>0&&yp.push({action:t,mutations:i,timestamp:Date.now()})}Rl=e}function eD(){return[...yp]}function nD(){yp=[]}typeof window<"u"&&(window.stateGuard={enable:CC,disable:JN,getLog:eD,clearLog:nD});E.moduleLoaded("RhythmPlaybackService");class sD{constructor(){I(this,"scheduledEvents",[]);I(this,"isInitialized",!1);this.scheduledEvents=[],this.isInitialized=!1}init(){return this.initialize()}refresh(){this.stopCurrentPattern()}async initialize(){this.isInitialized||(this.isInitialized=!0,E.info("RhythmPlaybackService","Initialized"),window.rhythmPlaybackService=this)}playRhythmPattern(t,e,s,i="oval",r=null){if(!this.isInitialized){E.warn("RhythmPlaybackService","Not initialized, call initialize() first");return}this.stopCurrentPattern();const o=gC(t,r);if(!o||o.length===0){E.warn("RhythmPlaybackService",`No events found for sixteenth stamp ${t}`);return}E.debug("RhythmPlaybackService",`Playing pattern for sixteenth stamp ${t}: ${o.length} notes`,{sixteenthStampId:t,basePitch:e,color:s,events:o,hasShapeOffsets:!!(r!=null&&r.shapeOffsets)});const A=de(),a=(r==null?void 0:r.globalRow)??(r==null?void 0:r.row);o.forEach((l,c)=>{try{const u=Be(String(l.offset)).toSeconds(),d=A+u,p=Be(String(l.duration)).toSeconds(),f=i==="circle"?p*2:p,m=d+f;let g=e;if(a!==void 0&&l.rowOffset!==0){const w=a+l.rowOffset,B=h.state.fullRowData[w];B&&(g=B.toneNote.replace("","b").replace("","#"))}kt.triggerAttack(g,s,d),kt.triggerRelease(g,s,m),this.scheduledEvents.push({pitch:g,color:s,attackTime:d,releaseTime:m})}catch(u){E.warn("RhythmPlaybackService",`Error scheduling note ${c+1}`,u)}}),E.info("RhythmPlaybackService",`Scheduled ${o.length} notes for rhythm pattern ${t}`)}stopCurrentPattern(){this.scheduledEvents.length!==0&&(E.debug("RhythmPlaybackService",`Clearing ${this.scheduledEvents.length} scheduled events`),kt.releaseAll(),this.scheduledEvents=[])}getSixteenthStampAtPosition(t,e){return h.state.sixteenthStampPlacements&&h.state.sixteenthStampPlacements.find(i=>{const r=i.row===e,o=t>=i.startColumn&&t<i.endColumn;return r&&o})||null}playTripletPattern(t,e,s,i=null){if(!this.isInitialized){E.warn("RhythmPlaybackService","Not initialized, call initialize() first");return}this.stopCurrentPattern();const r=vC(t,i);if(!r||r.length===0){E.warn("RhythmPlaybackService",`No events found for triplet ${t}`);return}E.debug("RhythmPlaybackService",`Playing triplet pattern ${t}: ${r.length} notes`,{tripletStampId:t,basePitch:e,color:s,events:r,hasShapeOffsets:!!(i!=null&&i.shapeOffsets)});const o=de(),A=(i==null?void 0:i.globalRow)??(i==null?void 0:i.row);r.forEach((a,l)=>{try{const c=Be(a.offset).toSeconds(),u=o+c,d=Be(a.duration).toSeconds(),p=u+d;let f=e;if(A!==void 0&&a.rowOffset!==0){const m=A+a.rowOffset,g=h.state.fullRowData[m];g&&(f=g.toneNote.replace("?T-","b").replace("?T_","#"))}kt.triggerAttack(f,s,u),kt.triggerRelease(f,s,p),this.scheduledEvents.push({pitch:f,color:s,attackTime:u,releaseTime:p})}catch(c){E.warn("RhythmPlaybackService",`Error scheduling triplet note ${l+1}`,c)}}),E.info("RhythmPlaybackService",`Scheduled ${r.length} notes for triplet pattern ${t}`)}getTripletStampAtPosition(t,e){return h.state.tripletStampPlacements&&h.state.tripletStampPlacements.find(s=>s.row===e&&t>=s.startTimeIndex&&t<s.startTimeIndex+s.span*2)||null}dispose(){this.stopCurrentPattern(),this.isInitialized=!1,E.info("RhythmPlaybackService","Disposed")}}const se=new sD,iD={H:"https://tonejs.github.io/audio/drum-samples/CR78/hihat.mp3",M:"https://tonejs.github.io/audio/drum-samples/CR78/snare.mp3",L:"https://tonejs.github.io/audio/drum-samples/CR78/kick.mp3"};let Wr=null,g0=!1;async function rD(){if(!g0){Wr=new su(iD);try{await Wr.loaded,g0=!0}catch(n){console.warn("Drum sample preloading failed, will load on-demand:",n),Wr==null||Wr.dispose(),Wr=null}}}const yC=[];function te(...n){yC.push(n)}const SC={enableModulationTool(){h.setSelectedTool("modulation"),te("[MODULATION TEST] Modulation tool enabled. Click on the grid to place markers."),te("[MODULATION TEST] Click marker labels to toggle 2:3  3:2"),te("[MODULATION TEST] Drag marker barlines to move them")},addTestMarker(){const t=this.findNearestGridLine(200),e=this.findMeasureIndexForX(t.x),s=h.addModulationMarker(e,Sn.COMPRESSION_2_3,t.x,t.columnIndex);return te("[MODULATION TEST] Added test marker at measure",e,"columnIndex=",t.columnIndex,"x=",t.x,"(snapped from",200,")"),s},addTestMarker2(){const t=this.findNearestGridLine(400),e=this.findMeasureIndexForX(t.x),s=h.addModulationMarker(e,Sn.EXPANSION_3_2,t.x,t.columnIndex);return te("[MODULATION TEST] Added test marker 2 at measure",e,"columnIndex=",t.columnIndex,"x=",t.x,"(snapped from",400,")"),s},findNearestGridLine(n){const t=h.state;let e=0,s=0,i=1/0,r=0;for(let o=0;o<t.columnWidths.length;o++){const A=Math.abs(r-n);A<i&&(i=A,s=r,e=o);const a=t.columnWidths[o]||0;r+=a*t.cellWidth}return te("[MODULATION TEST] findNearestGridLine:",{targetX:n,closestColumnIndex:e,closestX:s,minDistance:i}),{columnIndex:e,x:s}},findMeasureIndexForX(n){const t=h.state.cellWidth||40,e=5,s=Math.round(n/t);return Math.max(1,Math.round(s/e))},clearAllMarkers(){[...h.state.modulationMarkers||[]].forEach(t=>{h.removeModulationMarker(t.id)}),te("[MODULATION TEST] Cleared all markers")},testMapping(){var e;const n=h.state.baseMicrobeatPx||h.state.cellWidth||40;te("[MODULATION TEST] Base microbeat pixels:",n),te("[MODULATION TEST] Modulation markers:",h.state.modulationMarkers);const t=typeof window<"u"?(e=window.getModulationMapping)==null?void 0:e.call(window):void 0;t&&(te("[MODULATION TEST] Coordinate mapping:",t),[0,100,200,300,400,500].forEach(i=>{const r=t.canvasXToMicrobeat(i),o=t.microbeatToCanvasX(r);te(`[MODULATION TEST] x=${i}  microbeat=${r.toFixed(3)}  x=${o.toFixed(1)}`)}))},testVisualExpansion(){var t;te("[MODULATION TEST] Testing visual grid expansion..."),this.clearAllMarkers();const n=this.addTestMarker2();te("[MODULATION TEST] Added 3:2 expansion marker:",n),typeof window<"u"&&((t=window.LayoutService)!=null&&t.recalculateLayout)&&(te("[MODULATION TEST] Manually triggering layout recalculation..."),window.LayoutService.recalculateLayout()),setTimeout(()=>{te("[MODULATION TEST] Grid should now show expansion after x=400"),te("[MODULATION TEST] Container should be wider to accommodate expansion"),te("[MODULATION TEST] Check console for [LAYOUT], [GETCOLX], [GRIDLINES], and [NOTES] logs")},100)},testVisualCompression(){var t;te("[MODULATION TEST] Testing visual grid compression..."),this.clearAllMarkers();const n=this.addTestMarker();te("[MODULATION TEST] Added 2:3 compression marker:",n),typeof window<"u"&&((t=window.LayoutService)!=null&&t.recalculateLayout)&&(te("[MODULATION TEST] Manually triggering layout recalculation..."),window.LayoutService.recalculateLayout()),setTimeout(()=>{te("[MODULATION TEST] Grid should now show compression after x=200"),te("[MODULATION TEST] Container should adjust to accommodate compression"),te("[MODULATION TEST] Check console for [LAYOUT], [GETCOLX], [GRIDLINES], and [NOTES] logs")},100)},logState(){te("[MODULATION TEST] Current state:",{selectedTool:h.state.selectedTool,modulationMarkers:h.state.modulationMarkers,baseMicrobeatPx:h.state.baseMicrobeatPx,cellWidth:h.state.cellWidth})}};typeof window<"u"&&(window.ModulationTest=SC,window.ModulationTestLogs=yC);E.moduleLoaded("ToolbarComponent","toolbar");const oD={init(){E.info("ToolbarComponent","Toolbar init called (all controls managed by Svelte)",null,"toolbar")}},Dh=!1;var AD=Array.isArray,aD=Array.prototype.indexOf,lD=Array.from,cD=Object.defineProperty,MA=Object.getOwnPropertyDescriptor,uD=Object.getOwnPropertyDescriptors,dD=Object.prototype,hD=Array.prototype,EC=Object.getPrototypeOf,w0=Object.isExtensible;function fD(n){for(var t=0;t<n.length;t++)n[t]()}function xC(){var n,t,e=new Promise((s,i)=>{n=s,t=i});return{promise:e,resolve:n,reject:t}}const Me=2,_C=4,Sp=8,pD=1<<24,di=16,hi=32,Qr=64,yu=128,ss=512,Re=1024,pn=2048,Fs=4096,Es=8192,Di=16384,Ep=32768,Qo=65536,v0=1<<17,IC=1<<18,Ko=1<<19,mD=1<<20,Er=32768,Lh=1<<21,xp=1<<22,Li=1<<23,vd=Symbol("$state"),gD=Symbol(""),io=new class extends Error{constructor(){super(...arguments);I(this,"name","StaleReactionError");I(this,"message","The reaction that called `getAbortSignal()` was re-run or destroyed")}};function FC(n){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}function wD(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function vD(n){throw new Error("https://svelte.dev/e/effect_in_teardown")}function BD(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function CD(n){throw new Error("https://svelte.dev/e/effect_orphan")}function bD(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function yD(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function SD(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function ED(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function xD(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}const _D=2,Pe=Symbol(),ID="http://www.w3.org/1999/xhtml";function FD(){console.warn("https://svelte.dev/e/svelte_boundary_reset_noop")}function TC(n){return n===this.v}let TD=!1,mn=null;function Mo(n){mn=n}function as(n,t=!1,e){mn={p:mn,i:!1,c:null,e:null,s:n,x:null,l:null}}function ls(n){var t=mn,e=t.e;if(e!==null){t.e=null;for(var s of e)XC(s)}return t.i=!0,mn=t.p,{}}function QC(){return!0}let ro=[];function QD(){var n=ro;ro=[],fD(n)}function _p(n){if(ro.length===0){var t=ro;queueMicrotask(()=>{t===ro&&QD()})}ro.push(n)}function MC(n){var t=Wt;if(t===null)return Qt.f|=Li,n;if((t.f&Ep)===0){if((t.f&yu)===0)throw n;t.b.error(n)}else Uo(n,t)}function Uo(n,t){for(;t!==null;){if((t.f&yu)!==0)try{t.b.error(n);return}catch(e){n=e}t=t.parent}throw n}const wl=new Set;let Rt=null,me=null,ps=[],Ip=null,kh=!1;var Co,bo,ar,lr,da,yo,So,Qe,Rh,fA,Hh,UC,PC;const Nc=class Nc{constructor(){Ut(this,Qe);I(this,"committed",!1);I(this,"current",new Map);I(this,"previous",new Map);Ut(this,Co,new Set);Ut(this,bo,new Set);Ut(this,ar,0);Ut(this,lr,0);Ut(this,da,null);Ut(this,yo,new Set);Ut(this,So,new Set);I(this,"skipped_effects",new Set);I(this,"is_fork",!1)}is_deferred(){return this.is_fork||j(this,lr)>0}process(t){var s;ps=[],this.apply();var e={parent:null,effect:null,effects:[],render_effects:[]};for(const i of t)ae(this,Qe,Rh).call(this,i,e);this.is_fork||ae(this,Qe,UC).call(this),this.is_deferred()?(ae(this,Qe,fA).call(this,e.effects),ae(this,Qe,fA).call(this,e.render_effects)):(Rt=null,B0(e.render_effects),B0(e.effects),(s=j(this,da))==null||s.resolve()),me=null}capture(t,e){this.previous.has(t)||this.previous.set(t,e),(t.f&Li)===0&&(this.current.set(t,t.v),me==null||me.set(t,t.v))}activate(){Rt=this,this.apply()}deactivate(){Rt===this&&(Rt=null,me=null)}flush(){if(this.activate(),ps.length>0){if(MD(),Rt!==null&&Rt!==this)return}else j(this,ar)===0&&this.process([]);this.deactivate()}discard(){for(const t of j(this,bo))t(this);j(this,bo).clear()}increment(t){yt(this,ar,j(this,ar)+1),t&&yt(this,lr,j(this,lr)+1)}decrement(t){yt(this,ar,j(this,ar)-1),t&&yt(this,lr,j(this,lr)-1),this.revive()}revive(){for(const t of j(this,yo))j(this,So).delete(t),Oe(t,pn),xr(t);for(const t of j(this,So))Oe(t,Fs),xr(t);this.flush()}oncommit(t){j(this,Co).add(t)}ondiscard(t){j(this,bo).add(t)}settled(){return(j(this,da)??yt(this,da,xC())).promise}static ensure(){if(Rt===null){const t=Rt=new Nc;wl.add(Rt),Nc.enqueue(()=>{Rt===t&&t.flush()})}return Rt}static enqueue(t){_p(t)}apply(){}};Co=new WeakMap,bo=new WeakMap,ar=new WeakMap,lr=new WeakMap,da=new WeakMap,yo=new WeakMap,So=new WeakMap,Qe=new WeakSet,Rh=function(t,e){var c;t.f^=Re;for(var s=t.first;s!==null;){var i=s.f,r=(i&(hi|Qr))!==0,o=r&&(i&Re)!==0,A=o||(i&Es)!==0||this.skipped_effects.has(s);if((s.f&yu)!==0&&((c=s.b)!=null&&c.is_pending())&&(e={parent:e,effect:s,effects:[],render_effects:[]}),!A&&s.fn!==null){r?s.f^=Re:(i&_C)!==0?e.effects.push(s):Ta(s)&&((s.f&di)!==0&&j(this,yo).add(s),Aa(s));var a=s.first;if(a!==null){s=a;continue}}var l=s.parent;for(s=s.next;s===null&&l!==null;)l===e.effect&&(ae(this,Qe,fA).call(this,e.effects),ae(this,Qe,fA).call(this,e.render_effects),e=e.parent),s=l.next,l=l.parent}},fA=function(t){for(const e of t)(e.f&pn)!==0?j(this,yo).add(e):(e.f&Fs)!==0&&j(this,So).add(e),ae(this,Qe,Hh).call(this,e.deps),Oe(e,Re)},Hh=function(t){if(t!==null)for(const e of t)(e.f&Me)===0||(e.f&Er)===0||(e.f^=Er,ae(this,Qe,Hh).call(this,e.deps))},UC=function(){if(j(this,lr)===0){for(const t of j(this,Co))t();j(this,Co).clear()}j(this,ar)===0&&ae(this,Qe,PC).call(this)},PC=function(){var r;if(wl.size>1){this.previous.clear();var t=me,e=!0,s={parent:null,effect:null,effects:[],render_effects:[]};for(const o of wl){if(o===this){e=!1;continue}const A=[];for(const[l,c]of this.current){if(o.current.has(l))if(e&&c!==o.current.get(l))o.current.set(l,c);else continue;A.push(l)}if(A.length===0)continue;const a=[...o.current.keys()].filter(l=>!this.current.has(l));if(a.length>0){var i=ps;ps=[];const l=new Set,c=new Map;for(const u of A)NC(u,a,l,c);if(ps.length>0){Rt=o,o.apply();for(const u of ps)ae(r=o,Qe,Rh).call(r,u,s);o.deactivate()}ps=i}}Rt=null,me=t}this.committed=!0,wl.delete(this)};let js=Nc;function MD(){var n=wr;kh=!0;var t=null;try{var e=0;for(Sc(!0);ps.length>0;){var s=js.ensure();if(e++>1e3){var i,r;UD()}s.process(ps),ki.clear()}}finally{kh=!1,Sc(n),Ip=null}}function UD(){try{bD()}catch(n){Uo(n,Ip)}}let Xn=null;function B0(n){var t=n.length;if(t!==0){for(var e=0;e<t;){var s=n[e++];if((s.f&(Di|Es))===0&&Ta(s)&&(Xn=new Set,Aa(s),s.deps===null&&s.first===null&&s.nodes===null&&(s.teardown===null&&s.ac===null?JC(s):s.fn=null),(Xn==null?void 0:Xn.size)>0)){ki.clear();for(const i of Xn){if((i.f&(Di|Es))!==0)continue;const r=[i];let o=i.parent;for(;o!==null;)Xn.has(o)&&(Xn.delete(o),r.push(o)),o=o.parent;for(let A=r.length-1;A>=0;A--){const a=r[A];(a.f&(Di|Es))===0&&Aa(a)}}Xn.clear()}}Xn=null}}function NC(n,t,e,s){if(!e.has(n)&&(e.add(n),n.reactions!==null))for(const i of n.reactions){const r=i.f;(r&Me)!==0?NC(i,t,e,s):(r&(xp|di))!==0&&(r&pn)===0&&DC(i,t,s)&&(Oe(i,pn),xr(i))}}function DC(n,t,e){const s=e.get(n);if(s!==void 0)return s;if(n.deps!==null)for(const i of n.deps){if(t.includes(i))return!0;if((i.f&Me)!==0&&DC(i,t,e))return e.set(i,!0),!0}return e.set(n,!1),!1}function xr(n){for(var t=Ip=n;t.parent!==null;){t=t.parent;var e=t.f;if(kh&&t===Wt&&(e&di)!==0&&(e&IC)===0)return;if((e&(Qr|hi))!==0){if((e&Re)===0)return;t.f^=Re}}ps.push(t)}function PD(n){let t=0,e=Su(0),s;return()=>{ra()&&(ut(e),JD(()=>(t===0&&(s=Qp(()=>n(()=>UA(e)))),t+=1,()=>{_p(()=>{t-=1,t===0&&(s==null||s(),s=void 0,UA(e))})})))}}var ND=Qo|Ko|yu;function DD(n,t,e){new LD(n,t,e)}var Fn,Tn,Af,ms,cr,gs,Qn,nn,ws,zs,Si,ur,Ei,dr,xi,Dc,_e,kD,RD,Oh,Hl,Ol,Vh;class LD{constructor(t,e,s){Ut(this,_e);I(this,"parent");Ut(this,Fn,!1);Ut(this,Tn);Ut(this,Af,null);Ut(this,ms);Ut(this,cr);Ut(this,gs);Ut(this,Qn,null);Ut(this,nn,null);Ut(this,ws,null);Ut(this,zs,null);Ut(this,Si,null);Ut(this,ur,0);Ut(this,Ei,0);Ut(this,dr,!1);Ut(this,xi,null);Ut(this,Dc,PD(()=>(yt(this,xi,Su(j(this,ur))),()=>{yt(this,xi,null)})));yt(this,Tn,t),yt(this,ms,e),yt(this,cr,s),this.parent=Wt.b,yt(this,Fn,!!j(this,ms).pending),yt(this,gs,$C(()=>{Wt.b=this;{var i=ae(this,_e,Oh).call(this);try{yt(this,Qn,Ks(()=>s(i)))}catch(r){this.error(r)}j(this,Ei)>0?ae(this,_e,Ol).call(this):yt(this,Fn,!1)}return()=>{var r;(r=j(this,Si))==null||r.remove()}},ND))}is_pending(){return j(this,Fn)||!!this.parent&&this.parent.is_pending()}has_pending_snippet(){return!!j(this,ms).pending}update_pending_count(t){ae(this,_e,Vh).call(this,t),yt(this,ur,j(this,ur)+t),j(this,xi)&&bc(j(this,xi),j(this,ur))}get_effect_pending(){return j(this,Dc).call(this),ut(j(this,xi))}error(t){var e=j(this,ms).onerror;let s=j(this,ms).failed;if(j(this,dr)||!e&&!s)throw t;j(this,Qn)&&(xn(j(this,Qn)),yt(this,Qn,null)),j(this,nn)&&(xn(j(this,nn)),yt(this,nn,null)),j(this,ws)&&(xn(j(this,ws)),yt(this,ws,null));var i=!1,r=!1;const o=()=>{if(i){FD();return}i=!0,r&&xD(),js.ensure(),yt(this,ur,0),j(this,ws)!==null&&PA(j(this,ws),()=>{yt(this,ws,null)}),yt(this,Fn,this.has_pending_snippet()),yt(this,Qn,ae(this,_e,Hl).call(this,()=>(yt(this,dr,!1),Ks(()=>j(this,cr).call(this,j(this,Tn)))))),j(this,Ei)>0?ae(this,_e,Ol).call(this):yt(this,Fn,!1)};var A=Qt;try{ln(null),r=!0,e==null||e(t,o),r=!1}catch(a){Uo(a,j(this,gs)&&j(this,gs).parent)}finally{ln(A)}s&&_p(()=>{yt(this,ws,ae(this,_e,Hl).call(this,()=>{js.ensure(),yt(this,dr,!0);try{return Ks(()=>{s(j(this,Tn),()=>t,()=>o)})}catch(a){return Uo(a,j(this,gs).parent),null}finally{yt(this,dr,!1)}}))})}}Fn=new WeakMap,Tn=new WeakMap,Af=new WeakMap,ms=new WeakMap,cr=new WeakMap,gs=new WeakMap,Qn=new WeakMap,nn=new WeakMap,ws=new WeakMap,zs=new WeakMap,Si=new WeakMap,ur=new WeakMap,Ei=new WeakMap,dr=new WeakMap,xi=new WeakMap,Dc=new WeakMap,_e=new WeakSet,kD=function(){try{yt(this,Qn,Ks(()=>j(this,cr).call(this,j(this,Tn))))}catch(t){this.error(t)}yt(this,Fn,!1)},RD=function(){const t=j(this,ms).pending;t&&(yt(this,nn,Ks(()=>t(j(this,Tn)))),js.enqueue(()=>{var e=ae(this,_e,Oh).call(this);yt(this,Qn,ae(this,_e,Hl).call(this,()=>(js.ensure(),Ks(()=>j(this,cr).call(this,e))))),j(this,Ei)>0?ae(this,_e,Ol).call(this):(PA(j(this,nn),()=>{yt(this,nn,null)}),yt(this,Fn,!1))}))},Oh=function(){var t=j(this,Tn);return j(this,Fn)&&(yt(this,Si,yc()),j(this,Tn).before(j(this,Si)),t=j(this,Si)),t},Hl=function(t){var e=Wt,s=Qt,i=mn;Ts(j(this,gs)),ln(j(this,gs)),Mo(j(this,gs).ctx);try{return t()}catch(r){return MC(r),null}finally{Ts(e),ln(s),Mo(i)}},Ol=function(){const t=j(this,ms).pending;j(this,Qn)!==null&&(yt(this,zs,document.createDocumentFragment()),j(this,zs).append(j(this,Si)),eb(j(this,Qn),j(this,zs))),j(this,nn)===null&&yt(this,nn,Ks(()=>t(j(this,Tn))))},Vh=function(t){var e;if(!this.has_pending_snippet()){this.parent&&ae(e=this.parent,_e,Vh).call(e,t);return}yt(this,Ei,j(this,Ei)+t),j(this,Ei)===0&&(yt(this,Fn,!1),j(this,nn)&&PA(j(this,nn),()=>{yt(this,nn,null)}),j(this,zs)&&(j(this,Tn).before(j(this,zs)),yt(this,zs,null)))};function HD(n,t,e,s){const i=LC;if(e.length===0&&n.length===0){s(t.map(i));return}var r=Rt,o=Wt,A=OD();function a(){Promise.all(e.map(l=>VD(l))).then(l=>{A();try{s([...t.map(i),...l])}catch(c){(o.f&Di)===0&&Uo(c,o)}r==null||r.deactivate(),Cc()}).catch(l=>{Uo(l,o)})}n.length>0?Promise.all(n).then(()=>{A();try{return a()}finally{r==null||r.deactivate(),Cc()}}):a()}function OD(){var n=Wt,t=Qt,e=mn,s=Rt;return function(r=!0){Ts(n),ln(t),Mo(e),r&&(s==null||s.activate())}}function Cc(){Ts(null),ln(null),Mo(null)}function LC(n){var t=Me|pn,e=Qt!==null&&(Qt.f&Me)!==0?Qt:null;return Wt!==null&&(Wt.f|=Ko),{ctx:mn,deps:null,effects:null,equals:TC,f:t,fn:n,reactions:null,rv:0,v:Pe,wv:0,parent:e??Wt,ac:null}}function VD(n,t){let e=Wt;e===null&&wD();var s=e.b,i=void 0,r=Su(Pe),o=!Qt,A=new Map;return jD(()=>{var d;var a=xC();i=a.promise;try{Promise.resolve(n()).then(a.resolve,a.reject).then(()=>{l===Rt&&l.committed&&l.deactivate(),Cc()})}catch(p){a.reject(p),Cc()}var l=Rt;if(o){var c=!s.is_pending();s.update_pending_count(1),l.increment(c),(d=A.get(l))==null||d.reject(io),A.delete(l),A.set(l,a)}const u=(p,f=void 0)=>{if(l.activate(),f)f!==io&&(r.f|=Li,bc(r,f));else{(r.f&Li)!==0&&(r.f^=Li),bc(r,p);for(const[m,g]of A){if(A.delete(m),m===l)break;g.reject(io)}}o&&(s.update_pending_count(-1),l.decrement(c))};a.promise.then(u,p=>u(null,p||"unknown"))}),$D(()=>{for(const a of A.values())a.reject(io)}),new Promise(a=>{function l(c){function u(){c===i?a(r):l(i)}c.then(u,u)}l(i)})}function Bd(n){const t=LC(n);return nb(t),t}function kC(n){var t=n.effects;if(t!==null){n.effects=null;for(var e=0;e<t.length;e+=1)xn(t[e])}}function WD(n){for(var t=n.parent;t!==null;){if((t.f&Me)===0)return(t.f&Di)===0?t:null;t=t.parent}return null}function Fp(n){var t,e=Wt;Ts(WD(n));try{n.f&=~Er,kC(n),t=ob(n)}finally{Ts(e)}return t}function RC(n){var t=Fp(n);if(n.equals(t)||(Rt!=null&&Rt.is_fork||(n.v=t),n.wv=ib()),!qo)if(me!==null)(ra()||Rt!=null&&Rt.is_fork)&&me.set(n,t);else{var e=(n.f&ss)===0?Fs:Re;Oe(n,e)}}let Wh=new Set;const ki=new Map;let HC=!1;function Su(n,t){var e={f:0,v:n,reactions:null,equals:TC,rv:0,wv:0};return e}function Ot(n,t){const e=Su(n);return nb(e),e}function bt(n,t,e=!1){Qt!==null&&(!ys||(Qt.f&v0)!==0)&&QC()&&(Qt.f&(Me|di|xp|v0))!==0&&!(Je!=null&&Je.includes(n))&&ED();let s=e?Zn(t):t;return bc(n,s)}function bc(n,t){if(!n.equals(t)){var e=n.v;qo?ki.set(n,t):ki.set(n,e),n.v=t;var s=js.ensure();s.capture(n,e),(n.f&Me)!==0&&((n.f&pn)!==0&&Fp(n),Oe(n,(n.f&ss)!==0?Re:Fs)),n.wv=ib(),OC(n,pn),Wt!==null&&(Wt.f&Re)!==0&&(Wt.f&(hi|Qr))===0&&(In===null?nL([n]):In.push(n)),!s.is_fork&&Wh.size>0&&!HC&&GD()}return t}function GD(){HC=!1;var n=wr;Sc(!0);const t=Array.from(Wh);try{for(const e of t)(e.f&Re)!==0&&Oe(e,Fs),Ta(e)&&Aa(e)}finally{Sc(n)}Wh.clear()}function UA(n){bt(n,n.v+1)}function OC(n,t){var e=n.reactions;if(e!==null)for(var s=e.length,i=0;i<s;i++){var r=e[i],o=r.f,A=(o&pn)===0;if(A&&Oe(r,t),(o&Me)!==0){var a=r;me==null||me.delete(a),(o&Er)===0&&(o&ss&&(r.f|=Er),OC(a,Fs))}else A&&((o&di)!==0&&Xn!==null&&Xn.add(r),xr(r))}}function Zn(n){if(typeof n!="object"||n===null||vd in n)return n;const t=EC(n);if(t!==dD&&t!==hD)return n;var e=new Map,s=AD(n),i=Ot(0),r=vr,o=A=>{if(vr===r)return A();var a=Qt,l=vr;ln(null),y0(r);var c=A();return ln(a),y0(l),c};return s&&e.set("length",Ot(n.length)),new Proxy(n,{defineProperty(A,a,l){(!("value"in l)||l.configurable===!1||l.enumerable===!1||l.writable===!1)&&yD();var c=e.get(a);return c===void 0?c=o(()=>{var u=Ot(l.value);return e.set(a,u),u}):bt(c,l.value,!0),!0},deleteProperty(A,a){var l=e.get(a);if(l===void 0){if(a in A){const c=o(()=>Ot(Pe));e.set(a,c),UA(i)}}else bt(l,Pe),UA(i);return!0},get(A,a,l){var p;if(a===vd)return n;var c=e.get(a),u=a in A;if(c===void 0&&(!u||(p=MA(A,a))!=null&&p.writable)&&(c=o(()=>{var f=Zn(u?A[a]:Pe),m=Ot(f);return m}),e.set(a,c)),c!==void 0){var d=ut(c);return d===Pe?void 0:d}return Reflect.get(A,a,l)},getOwnPropertyDescriptor(A,a){var l=Reflect.getOwnPropertyDescriptor(A,a);if(l&&"value"in l){var c=e.get(a);c&&(l.value=ut(c))}else if(l===void 0){var u=e.get(a),d=u==null?void 0:u.v;if(u!==void 0&&d!==Pe)return{enumerable:!0,configurable:!0,value:d,writable:!0}}return l},has(A,a){var d;if(a===vd)return!0;var l=e.get(a),c=l!==void 0&&l.v!==Pe||Reflect.has(A,a);if(l!==void 0||Wt!==null&&(!c||(d=MA(A,a))!=null&&d.writable)){l===void 0&&(l=o(()=>{var p=c?Zn(A[a]):Pe,f=Ot(p);return f}),e.set(a,l));var u=ut(l);if(u===Pe)return!1}return c},set(A,a,l,c){var b;var u=e.get(a),d=a in A;if(s&&a==="length")for(var p=l;p<u.v;p+=1){var f=e.get(p+"");f!==void 0?bt(f,Pe):p in A&&(f=o(()=>Ot(Pe)),e.set(p+"",f))}if(u===void 0)(!d||(b=MA(A,a))!=null&&b.writable)&&(u=o(()=>Ot(void 0)),bt(u,Zn(l)),e.set(a,u));else{d=u.v!==Pe;var m=o(()=>Zn(l));bt(u,m)}var g=Reflect.getOwnPropertyDescriptor(A,a);if(g!=null&&g.set&&g.set.call(c,l),!d){if(s&&typeof a=="string"){var w=e.get("length"),B=Number(a);Number.isInteger(B)&&B>=w.v&&bt(w,B+1)}UA(i)}return!0},ownKeys(A){ut(i);var a=Reflect.ownKeys(A).filter(u=>{var d=e.get(u);return d===void 0||d.v!==Pe});for(var[l,c]of e)c.v!==Pe&&!(l in A)&&a.push(l);return a},setPrototypeOf(){SD()}})}var C0,VC,WC,GC;function KD(){if(C0===void 0){C0=window,VC=/Firefox/.test(navigator.userAgent);var n=Element.prototype,t=Node.prototype,e=Text.prototype;WC=MA(t,"firstChild").get,GC=MA(t,"nextSibling").get,w0(n)&&(n.__click=void 0,n.__className=void 0,n.__attributes=null,n.__style=void 0,n.__e=void 0),w0(e)&&(e.__t=void 0)}}function yc(n=""){return document.createTextNode(n)}function KC(n){return WC.call(n)}function Tp(n){return GC.call(n)}function ji(n,t){return KC(n)}function Zo(n,t=1,e=!1){let s=n;for(;t--;)s=Tp(s);return s}function qD(){return!1}function qC(n){var t=Qt,e=Wt;ln(null),Ts(null);try{return n()}finally{ln(t),Ts(e)}}function zD(n){Wt===null&&(Qt===null&&CD(),BD()),qo&&vD()}function XD(n,t){var e=t.last;e===null?t.last=t.first=n:(e.next=n,n.prev=e,t.last=n)}function Xi(n,t,e){var s=Wt;s!==null&&(s.f&Es)!==0&&(n|=Es);var i={ctx:mn,deps:null,nodes:null,f:n|pn|ss,first:null,fn:t,last:null,next:null,parent:s,b:s&&s.b,prev:null,teardown:null,wv:0,ac:null};if(e)try{Aa(i),i.f|=Ep}catch(A){throw xn(i),A}else t!==null&&xr(i);var r=i;if(e&&r.deps===null&&r.teardown===null&&r.nodes===null&&r.first===r.last&&(r.f&Ko)===0&&(r=r.first,(n&di)!==0&&(n&Qo)!==0&&r!==null&&(r.f|=Qo)),r!==null&&(r.parent=s,s!==null&&XD(r,s),Qt!==null&&(Qt.f&Me)!==0&&(n&Qr)===0)){var o=Qt;(o.effects??(o.effects=[])).push(r)}return i}function ra(){return Qt!==null&&!ys}function $D(n){const t=Xi(Sp,null,!1);return Oe(t,Re),t.teardown=n,t}function zC(n){zD();var t=Wt.f,e=!Qt&&(t&hi)!==0&&(t&Ep)===0;if(e){var s=mn;(s.e??(s.e=[])).push(n)}else return XC(n)}function XC(n){return Xi(_C|mD,n,!1)}function YD(n){js.ensure();const t=Xi(Qr|Ko,n,!0);return(e={})=>new Promise(s=>{e.outro?PA(t,()=>{xn(t),s(void 0)}):(xn(t),s(void 0))})}function jD(n){return Xi(xp|Ko,n,!0)}function JD(n,t=0){return Xi(Sp|t,n,!0)}function Cd(n,t=[],e=[],s=[]){HD(s,t,e,i=>{Xi(Sp,()=>n(...i.map(ut)),!0)})}function $C(n,t=0){var e=Xi(di|t,n,!0);return e}function Ks(n){return Xi(hi|Ko,n,!0)}function YC(n){var t=n.teardown;if(t!==null){const e=qo,s=Qt;b0(!0),ln(null);try{t.call(null)}finally{b0(e),ln(s)}}}function jC(n,t=!1){var e=n.first;for(n.first=n.last=null;e!==null;){const i=e.ac;i!==null&&qC(()=>{i.abort(io)});var s=e.next;(e.f&Qr)!==0?e.parent=null:xn(e,t),e=s}}function ZD(n){for(var t=n.first;t!==null;){var e=t.next;(t.f&hi)===0&&xn(t),t=e}}function xn(n,t=!0){var e=!1;(t||(n.f&IC)!==0)&&n.nodes!==null&&n.nodes.end!==null&&(tL(n.nodes.start,n.nodes.end),e=!0),jC(n,t&&!e),Ec(n,0),Oe(n,Di);var s=n.nodes&&n.nodes.t;if(s!==null)for(const r of s)r.stop();YC(n);var i=n.parent;i!==null&&i.first!==null&&JC(n),n.next=n.prev=n.teardown=n.ctx=n.deps=n.fn=n.nodes=n.ac=null}function tL(n,t){for(;n!==null;){var e=n===t?null:Tp(n);n.remove(),n=e}}function JC(n){var t=n.parent,e=n.prev,s=n.next;e!==null&&(e.next=s),s!==null&&(s.prev=e),t!==null&&(t.first===n&&(t.first=s),t.last===n&&(t.last=e))}function PA(n,t,e=!0){var s=[];ZC(n,s,!0);var i=()=>{e&&xn(n),t&&t()},r=s.length;if(r>0){var o=()=>--r||i();for(var A of s)A.out(o)}else i()}function ZC(n,t,e){if((n.f&Es)===0){n.f^=Es;var s=n.nodes&&n.nodes.t;if(s!==null)for(const A of s)(A.is_global||e)&&t.push(A);for(var i=n.first;i!==null;){var r=i.next,o=(i.f&Qo)!==0||(i.f&hi)!==0&&(n.f&di)!==0;ZC(i,t,o?e:!1),i=r}}}function eL(n){tb(n,!0)}function tb(n,t){if((n.f&Es)!==0){n.f^=Es,(n.f&Re)===0&&(Oe(n,pn),xr(n));for(var e=n.first;e!==null;){var s=e.next,i=(e.f&Qo)!==0||(e.f&hi)!==0;tb(e,i?t:!1),e=s}var r=n.nodes&&n.nodes.t;if(r!==null)for(const o of r)(o.is_global||t)&&o.in()}}function eb(n,t){if(n.nodes)for(var e=n.nodes.start,s=n.nodes.end;e!==null;){var i=e===s?null:Tp(e);t.append(e),e=i}}let wr=!1;function Sc(n){wr=n}let qo=!1;function b0(n){qo=n}let Qt=null,ys=!1;function ln(n){Qt=n}let Wt=null;function Ts(n){Wt=n}let Je=null;function nb(n){Qt!==null&&(Je===null?Je=[n]:Je.push(n))}let Xe=null,vn=0,In=null;function nL(n){In=n}let sb=1,oa=0,vr=oa;function y0(n){vr=n}function ib(){return++sb}function Ta(n){var t=n.f;if((t&pn)!==0)return!0;if(t&Me&&(n.f&=~Er),(t&Fs)!==0){var e=n.deps;if(e!==null)for(var s=e.length,i=0;i<s;i++){var r=e[i];if(Ta(r)&&RC(r),r.wv>n.wv)return!0}(t&ss)!==0&&me===null&&Oe(n,Re)}return!1}function rb(n,t,e=!0){var s=n.reactions;if(s!==null&&!(Je!=null&&Je.includes(n)))for(var i=0;i<s.length;i++){var r=s[i];(r.f&Me)!==0?rb(r,t,!1):t===r&&(e?Oe(r,pn):(r.f&Re)!==0&&Oe(r,Fs),xr(r))}}function ob(n){var f;var t=Xe,e=vn,s=In,i=Qt,r=Je,o=mn,A=ys,a=vr,l=n.f;Xe=null,vn=0,In=null,Qt=(l&(hi|Qr))===0?n:null,Je=null,Mo(n.ctx),ys=!1,vr=++oa,n.ac!==null&&(qC(()=>{n.ac.abort(io)}),n.ac=null);try{n.f|=Lh;var c=n.fn,u=c(),d=n.deps;if(Xe!==null){var p;if(Ec(n,vn),d!==null&&vn>0)for(d.length=vn+Xe.length,p=0;p<Xe.length;p++)d[vn+p]=Xe[p];else n.deps=d=Xe;if(ra()&&(n.f&ss)!==0)for(p=vn;p<d.length;p++)((f=d[p]).reactions??(f.reactions=[])).push(n)}else d!==null&&vn<d.length&&(Ec(n,vn),d.length=vn);if(QC()&&In!==null&&!ys&&d!==null&&(n.f&(Me|Fs|pn))===0)for(p=0;p<In.length;p++)rb(In[p],n);return i!==null&&i!==n&&(oa++,In!==null&&(s===null?s=In:s.push(...In))),(n.f&Li)!==0&&(n.f^=Li),u}catch(m){return MC(m)}finally{n.f^=Lh,Xe=t,vn=e,In=s,Qt=i,Je=r,Mo(o),ys=A,vr=a}}function sL(n,t){let e=t.reactions;if(e!==null){var s=aD.call(e,n);if(s!==-1){var i=e.length-1;i===0?e=t.reactions=null:(e[s]=e[i],e.pop())}}e===null&&(t.f&Me)!==0&&(Xe===null||!Xe.includes(t))&&(Oe(t,Fs),(t.f&ss)!==0&&(t.f^=ss,t.f&=~Er),kC(t),Ec(t,0))}function Ec(n,t){var e=n.deps;if(e!==null)for(var s=t;s<e.length;s++)sL(n,e[s])}function Aa(n){var t=n.f;if((t&Di)===0){Oe(n,Re);var e=Wt,s=wr;Wt=n,wr=!0;try{(t&(di|pD))!==0?ZD(n):jC(n),YC(n);var i=ob(n);n.teardown=typeof i=="function"?i:null,n.wv=sb;var r;Dh&&TD&&(n.f&pn)!==0&&n.deps}finally{wr=s,Wt=e}}}function ut(n){var t=n.f,e=(t&Me)!==0;if(Qt!==null&&!ys){var s=Wt!==null&&(Wt.f&Di)!==0;if(!s&&!(Je!=null&&Je.includes(n))){var i=Qt.deps;if((Qt.f&Lh)!==0)n.rv<oa&&(n.rv=oa,Xe===null&&i!==null&&i[vn]===n?vn++:Xe===null?Xe=[n]:Xe.includes(n)||Xe.push(n));else{(Qt.deps??(Qt.deps=[])).push(n);var r=n.reactions;r===null?n.reactions=[Qt]:r.includes(Qt)||r.push(Qt)}}}if(qo){if(ki.has(n))return ki.get(n);if(e){var o=n,A=o.v;return((o.f&Re)===0&&o.reactions!==null||ab(o))&&(A=Fp(o)),ki.set(o,A),A}}else e&&(!(me!=null&&me.has(n))||Rt!=null&&Rt.is_fork&&!ra())&&(o=n,Ta(o)&&RC(o),wr&&ra()&&(o.f&ss)===0&&Ab(o));if(me!=null&&me.has(n))return me.get(n);if((n.f&Li)!==0)throw n.v;return n.v}function Ab(n){if(n.deps!==null){n.f^=ss;for(const t of n.deps)(t.reactions??(t.reactions=[])).push(n),(t.f&Me)!==0&&(t.f&ss)===0&&Ab(t)}}function ab(n){if(n.v===Pe)return!0;if(n.deps===null)return!1;for(const t of n.deps)if(ki.has(t)||(t.f&Me)!==0&&ab(t))return!0;return!1}function Qp(n){var t=ys;try{return ys=!0,n()}finally{ys=t}}const iL=-7169;function Oe(n,t){n.f=n.f&iL|t}const rL=["touchstart","touchmove"];function oL(n){return rL.includes(n)}const lb=new Set,Gh=new Set;function AL(n){for(var t=0;t<n.length;t++)lb.add(n[t]);for(var e of Gh)e(n)}let S0=null;function vl(n){var g;var t=this,e=t.ownerDocument,s=n.type,i=((g=n.composedPath)==null?void 0:g.call(n))||[],r=i[0]||n.target;S0=n;var o=0,A=S0===n&&n.__root;if(A){var a=i.indexOf(A);if(a!==-1&&(t===document||t===window)){n.__root=t;return}var l=i.indexOf(t);if(l===-1)return;a<=l&&(o=a)}if(r=i[o]||n.target,r!==t){cD(n,"currentTarget",{configurable:!0,get(){return r||e}});var c=Qt,u=Wt;ln(null),Ts(null);try{for(var d,p=[];r!==null;){var f=r.assignedSlot||r.parentNode||r.host||null;try{var m=r["__"+s];m!=null&&(!r.disabled||n.target===r)&&m.call(r,n)}catch(w){d?p.push(w):d=w}if(n.cancelBubble||f===t||f===null)break;r=f}if(d){for(let w of p)queueMicrotask(()=>{throw w});throw d}}finally{n.__root=t,delete n.currentTarget,ln(c),Ts(u)}}}function aL(n){var t=document.createElement("template");return t.innerHTML=n.replaceAll("<!>","<!---->"),t.content}function lL(n,t){var e=Wt;e.nodes===null&&(e.nodes={start:n,end:t,a:null,t:null})}function Mp(n,t){var e=(t&_D)!==0,s,i=!n.startsWith("<!>");return()=>{s===void 0&&(s=aL(i?n:"<!>"+n),s=KC(s));var r=e||VC?document.importNode(s,!0):s.cloneNode(!0);return lL(r,r),r}}function bd(n,t){n!==null&&n.before(t)}function cL(n,t){return uL(n,t)}const Gr=new Map;function uL(n,{target:t,anchor:e,props:s={},events:i,context:r,intro:o=!0}){KD();var A=new Set,a=u=>{for(var d=0;d<u.length;d++){var p=u[d];if(!A.has(p)){A.add(p);var f=oL(p);t.addEventListener(p,vl,{passive:f});var m=Gr.get(p);m===void 0?(document.addEventListener(p,vl,{passive:f}),Gr.set(p,1)):Gr.set(p,m+1)}}};a(lD(lb)),Gh.add(a);var l=void 0,c=YD(()=>{var u=e??t.appendChild(yc());return DD(u,{pending:()=>{}},d=>{if(r){as({});var p=mn;p.c=r}i&&(s.$$events=i),l=n(d,s)||{},r&&ls()}),()=>{var f;for(var d of A){t.removeEventListener(d,vl);var p=Gr.get(d);--p===0?(document.removeEventListener(d,vl),Gr.delete(d)):Gr.set(d,p)}Gh.delete(a),u!==e&&((f=u.parentNode)==null||f.removeChild(u))}});return Kh.set(l,c),l}let Kh=new WeakMap;function dL(n,t){const e=Kh.get(n);return e?(Kh.delete(n),e(t)):Promise.resolve()}var $n,vs,Bn,hr,ha,fa,Lc;class hL{constructor(t,e=!0){I(this,"anchor");Ut(this,$n,new Map);Ut(this,vs,new Map);Ut(this,Bn,new Map);Ut(this,hr,new Set);Ut(this,ha,!0);Ut(this,fa,()=>{var t=Rt;if(j(this,$n).has(t)){var e=j(this,$n).get(t),s=j(this,vs).get(e);if(s)eL(s),j(this,hr).delete(e);else{var i=j(this,Bn).get(e);i&&(j(this,vs).set(e,i.effect),j(this,Bn).delete(e),i.fragment.lastChild.remove(),this.anchor.before(i.fragment),s=i.effect)}for(const[r,o]of j(this,$n)){if(j(this,$n).delete(r),r===t)break;const A=j(this,Bn).get(o);A&&(xn(A.effect),j(this,Bn).delete(o))}for(const[r,o]of j(this,vs)){if(r===e||j(this,hr).has(r))continue;const A=()=>{if(Array.from(j(this,$n).values()).includes(r)){var l=document.createDocumentFragment();eb(o,l),l.append(yc()),j(this,Bn).set(r,{effect:o,fragment:l})}else xn(o);j(this,hr).delete(r),j(this,vs).delete(r)};j(this,ha)||!s?(j(this,hr).add(r),PA(o,A,!1)):A()}}});Ut(this,Lc,t=>{j(this,$n).delete(t);const e=Array.from(j(this,$n).values());for(const[s,i]of j(this,Bn))e.includes(s)||(xn(i.effect),j(this,Bn).delete(s))});this.anchor=t,yt(this,ha,e)}ensure(t,e){var s=Rt,i=qD();if(e&&!j(this,vs).has(t)&&!j(this,Bn).has(t))if(i){var r=document.createDocumentFragment(),o=yc();r.append(o),j(this,Bn).set(t,{effect:Ks(()=>e(o)),fragment:r})}else j(this,vs).set(t,Ks(()=>e(this.anchor)));if(j(this,$n).set(s,t),i){for(const[A,a]of j(this,vs))A===t?s.skipped_effects.delete(a):s.skipped_effects.add(a);for(const[A,a]of j(this,Bn))A===t?s.skipped_effects.delete(a.effect):s.skipped_effects.add(a.effect);s.oncommit(j(this,fa)),s.ondiscard(j(this,Lc))}else j(this,fa).call(this)}}$n=new WeakMap,vs=new WeakMap,Bn=new WeakMap,hr=new WeakMap,ha=new WeakMap,fa=new WeakMap,Lc=new WeakMap;function fL(n,t,e=!1){var s=new hL(n),i=e?Qo:0;function r(o,A){s.ensure(o,A)}$C(()=>{var o=!1;t((A,a=!0)=>{o=!0,r(a,A)}),o||r(!1,null)},i)}const E0=[...` 	
\r\f\v\uFEFF`];function pL(n,t,e){var s=""+n;if(e){for(var i in e)if(e[i])s=s?s+" "+i:i;else if(s.length)for(var r=i.length,o=0;(o=s.indexOf(i,o))>=0;){var A=o+r;(o===0||E0.includes(s[o-1]))&&(A===s.length||E0.includes(s[A]))?s=(o===0?"":s.substring(0,o))+s.substring(A+1):o=A}}return s===""?null:s}function mL(n,t,e,s,i,r){var o=n.__className;if(o!==e||o===void 0){var A=pL(e,s,r);A==null?n.removeAttribute("class"):n.className=A,n.__className=e}else if(r&&i!==r)for(var a in r){var l=!!r[a];(i==null||l!==!!i[a])&&n.classList.toggle(a,l)}return r}const gL=Symbol("is custom element"),wL=Symbol("is html");function Hs(n,t,e,s){var i=vL(n);i[t]!==(i[t]=e)&&(t==="loading"&&(n[gD]=e),e==null?n.removeAttribute(t):typeof e!="string"&&BL(n).includes(t)?n[t]=e:n.setAttribute(t,e))}function vL(n){return n.__attributes??(n.__attributes={[gL]:n.nodeName.includes("-"),[wL]:n.namespaceURI===ID})}var x0=new Map;function BL(n){var t=n.getAttribute("is")||n.nodeName,e=x0.get(t);if(e)return e;x0.set(t,e=[]);for(var s,i=n,r=Element.prototype;r!==i;){s=uD(i);for(var o in s)s[o].set&&e.push(o);i=EC(i)}return e}function Ls(n){mn===null&&FC(),zC(()=>{const t=Qp(n);if(typeof t=="function")return t})}function fi(n){mn===null&&FC(),Ls(()=>()=>Qp(n))}const CL="5";var j0;typeof window<"u"&&((j0=window.__svelte??(window.__svelte={})).v??(j0.v=new Set)).add(CL);var bL=Mp('<img alt="Pause" class="svelte-1sr4oe7"/>'),yL=Mp('<img alt="Play" class="svelte-1sr4oe7"/>'),SL=Mp('<div class="playback-controls svelte-1sr4oe7"><button class="toolbar-button svelte-1sr4oe7"><!></button> <button class="toolbar-button svelte-1sr4oe7" title="Stop"><img alt="Stop" class="svelte-1sr4oe7"/></button> <button><img alt="Loop" class="svelte-1sr4oe7"/></button> <div class="separator svelte-1sr4oe7"></div> <button class="toolbar-button svelte-1sr4oe7" title="Clear All Notes"><img alt="Clear" class="svelte-1sr4oe7"/></button> <div class="separator svelte-1sr4oe7"></div> <button class="toolbar-button svelte-1sr4oe7" title="Undo"><img alt="Undo" class="svelte-1sr4oe7"/></button> <button class="toolbar-button svelte-1sr4oe7" title="Redo"><img alt="Redo" class="svelte-1sr4oe7"/></button></div>');function EL(n,t){as(t,!0);let e=Ot(Zn(h.state.isPlaying)),s=Ot(Zn(h.state.isPaused)),i=Ot(Zn(h.state.isLooping)),r=Ot(h.state.historyIndex>0),o=Ot(h.state.historyIndex<h.state.history.length-1);zC(()=>{const M=R=>{R&&(bt(e,R.isPlaying,!0),bt(s,R.isPaused,!0))},k=R=>{R!==void 0&&bt(i,R,!0)},N=()=>{bt(r,h.state.historyIndex>0),bt(o,h.state.historyIndex<h.state.history.length-1)};return h.on("playbackStateChanged",M),h.on("loopingChanged",k),h.on("historyChanged",N),N(),()=>{}});const A=Bd(()=>fs("play.svg")),a=Bd(()=>fs("pause.svg")),l=Bd(()=>ut(e)&&!ut(s));function c(){ut(e)&&ut(s)?(h.setPlaybackState(!0,!1),Ys.resume()):ut(e)&&!ut(s)?(h.setPlaybackState(!0,!0),Ys.pause()):(h.setPlaybackState(!0,!1),Ys.start())}function u(){h.setPlaybackState(!1,!1),Ys.stop()}function d(){h.clearAllNotes(),mC(),wC()}function p(){h.setLooping(!ut(i))}function f(){h.undo()}function m(){h.redo()}var g=SL(),w=ji(g);w.__click=c;var B=ji(w);{var b=M=>{var k=bL();Cd(()=>Hs(k,"src",ut(a))),bd(M,k)},_=M=>{var k=yL();Cd(()=>Hs(k,"src",ut(A))),bd(M,k)};fL(B,M=>{ut(l)?M(b):M(_,!1)})}var v=Zo(w,2);v.__click=u;var C=ji(v),y=Zo(v,2);let S;y.__click=p;var F=ji(y),x=Zo(y,4);x.__click=d;var Q=ji(x),T=Zo(x,4);T.__click=f;var U=ji(T),P=Zo(T,2);P.__click=m;var K=ji(P);Cd((M,k,N,R,J)=>{Hs(w,"title",ut(l)?"Pause":"Play"),Hs(C,"src",M),S=mL(y,1,"toolbar-button svelte-1sr4oe7",null,S,{active:ut(i)}),Hs(y,"title",ut(i)?"Disable Loop":"Enable Loop"),Hs(F,"src",k),Hs(Q,"src",N),T.disabled=!ut(r),Hs(U,"src",R),P.disabled=!ut(o),Hs(K,"src",J)},[()=>fs("stop.svg"),()=>fs("loop.svg"),()=>fs("clear.svg"),()=>fs("undo.svg"),()=>fs("redo.svg")]),bd(n,g),ls()}AL(["click"]);function xL(n,t){as(t,!0);let e=Ot(Zn(h.state.isPlaying)),s=Ot(Zn(h.state.isPaused)),i=Ot(Zn(h.state.isLooping)),r=Ot(h.state.historyIndex>0),o=Ot(h.state.historyIndex<h.state.history.length-1),A=null,a=null,l=null,c=null,u=null,d=null;function p(){ut(e)&&ut(s)?(h.setPlaybackState(!0,!1),Ys.resume()):ut(e)&&!ut(s)?(h.setPlaybackState(!0,!0),Ys.pause()):(h.setPlaybackState(!0,!1),Ys.start())}function f(){h.setPlaybackState(!1,!1),Ys.stop(),a==null||a.blur()}function m(){c==null||c.classList.add("flash"),setTimeout(()=>c==null?void 0:c.classList.remove("flash"),300),h.clearAllNotes(),mC(),wC(),c==null||c.blur()}function g(){h.setLooping(!ut(i))}function w(){h.undo(),u==null||u.blur()}function B(){h.redo(),d==null||d.blur()}function b(){if(!A)return;const C=`<img src="${fs("play.svg")}" alt="Play">`,y=`<img src="${fs("pause.svg")}" alt="Pause">`;A.innerHTML=ut(e)&&!ut(s)?y:C}function _(){l&&l.classList.toggle("active",ut(i))}function v(){u&&(u.disabled=!ut(r)),d&&(d.disabled=!ut(o))}Ls(()=>{A=document.getElementById("play-button"),a=document.getElementById("stop-button"),l=document.getElementById("loop-button"),c=document.getElementById("clear-button"),u=document.getElementById("undo-button"),d=document.getElementById("redo-button"),A==null||A.addEventListener("click",p),a==null||a.addEventListener("click",f),l==null||l.addEventListener("click",g),c==null||c.addEventListener("click",m),u==null||u.addEventListener("click",w),d==null||d.addEventListener("click",B);const C=F=>{F&&(bt(e,F.isPlaying,!0),bt(s,F.isPaused,!0),b())},y=F=>{F!==void 0&&(bt(i,F,!0),_())},S=()=>{bt(r,h.state.historyIndex>0),bt(o,h.state.historyIndex<h.state.history.length-1),v()};h.on("playbackStateChanged",C),h.on("loopingChanged",y),h.on("historyChanged",S),b(),_(),v(),console.log("[Svelte] PlaybackControlsBridge mounted")}),fi(()=>{A==null||A.removeEventListener("click",p),a==null||a.removeEventListener("click",f),l==null||l.removeEventListener("click",g),c==null||c.removeEventListener("click",m),u==null||u.removeEventListener("click",w),d==null||d.removeEventListener("click",B),console.log("[Svelte] PlaybackControlsBridge unmounted")}),ls()}function _L(n,t){as(t,!0);let e=null,s=null,i=null,r=null;function o(){const f=new Date,m=f.toLocaleDateString("en-US",{month:"long"}),g=f.getDate();return`SN-score-${m}${g}.csv`}async function A(f){try{const m={suggestedName:o(),types:[{description:"Student Notation CSV File",accept:{"text/csv":[".csv"]}}]},w=await(await window.showSaveFilePicker(m)).createWritable();await w.write(f),await w.close()}catch(m){m.name!=="AbortError"&&E.error("FileActionsBridge","Error saving file with picker",m,"toolbar")}}function a(f){const m=document.createElement("a"),g=URL.createObjectURL(f);m.setAttribute("href",g),m.setAttribute("download",o()),document.body.appendChild(m),m.click(),document.body.removeChild(m),URL.revokeObjectURL(g)}function l(){return h.state.placedNotes.map(f=>[f.row,f.startColumnIndex,f.endColumnIndex,f.color,f.shape,f.tonicNumber||"",f.isDrum,f.drumTrack||""].join(",")).join(`
`)}async function c(){const f=l(),m=new Blob([f],{type:"text/csv;charset=utf-8;"});window.showSaveFilePicker?await A(m):a(m)}function u(){const f=document.createElement("input");f.type="file",f.accept=".csv,.txt",f.onchange=m=>{var b;const w=(b=m.target.files)==null?void 0:b[0];if(!w)return;const B=new FileReader;B.onload=_=>{var S;const v=(S=_.target)==null?void 0:S.result;if(!v){E.warn("FileActionsBridge","Imported file was empty",null,"toolbar");return}const C=new Set(["circle","oval","diamond"]),y=[];if(v.split(`
`).map(F=>F.trim()).filter(F=>F.length>0).forEach(F=>{const x=F.split(",");if(x.length<7){E.warn("FileActionsBridge","Skipping invalid note row",{line:F},"toolbar");return}const Q=Number.parseInt(x[0]??"",10),T=Number.parseInt(x[1]??"",10),U=Number.parseInt(x[2]??"",10),P=(x[3]??"").trim(),K=(x[4]??"").trim().toLowerCase(),M=x[5]?Number.parseInt(x[5],10):null,k=(x[6]??"").trim().toLowerCase()==="true",N=x[7]?Number.parseInt(x[7],10):null,R=typeof N=="number"&&Number.isFinite(N)?N:void 0;if(!P){E.warn("FileActionsBridge","Skipping note with missing color",{line:F},"toolbar");return}if(!Number.isFinite(Q)||!Number.isFinite(T)||!Number.isFinite(U)){E.warn("FileActionsBridge","Skipping note with invalid coordinates",{line:F},"toolbar");return}const J=C.has(K)?K:"circle";C.has(K)||E.warn("FileActionsBridge",`Unknown shape "${K}", defaulting to circle`,null,"toolbar"),y.push({row:Q,startColumnIndex:T,endColumnIndex:U,color:P,shape:J,tonicNumber:M,isDrum:k,drumTrack:R})}),y.length===0){E.warn("FileActionsBridge","No valid notes found in imported file",null,"toolbar");return}h.loadNotes(y)},B.readAsText(w)},f.click()}function d(){document.body.classList.remove("sidebar-open"),h.emit("printPreviewStateChanged",!0)}function p(){window.confirm("Are you sure you want to reset the canvas? This will clear all your work and cannot be undone.")&&h.clearSavedState()}Ls(()=>{e=document.getElementById("save-as-button"),s=document.getElementById("import-button"),i=document.getElementById("print-button"),r=document.getElementById("reset-canvas-button"),e==null||e.addEventListener("click",()=>void c()),s==null||s.addEventListener("click",u),i==null||i.addEventListener("click",d),r==null||r.addEventListener("click",p),console.log("[Svelte] FileActionsBridge mounted")}),fi(()=>{e==null||e.removeEventListener("click",()=>void c()),s==null||s.removeEventListener("click",u),i==null||i.removeEventListener("click",d),r==null||r.removeEventListener("click",p),console.log("[Svelte] FileActionsBridge unmounted")}),ls()}function IL(n,t){as(t,!0);let e=null,s=null,i=null,r=null;function o(){const u=document.querySelector('.tab-button[data-tab="pitch"]'),d=document.querySelector('.pitch-tab-button[data-pitch-tab="range"]');u==null||u.click(),d==null||d.click()}function A(){o(),h.emit("zoomIn",{source:"button"}),e==null||e.blur()}function a(){o(),h.emit("zoomOut",{source:"button"}),s==null||s.blur()}function l(){h.increaseMacrobeatCount()}function c(){h.decreaseMacrobeatCount()}Ls(()=>{e=document.getElementById("grid-zoom-in"),s=document.getElementById("grid-zoom-out"),i=document.getElementById("macrobeat-increase"),r=document.getElementById("macrobeat-decrease"),e==null||e.addEventListener("click",A),s==null||s.addEventListener("click",a),i==null||i.addEventListener("click",l),r==null||r.addEventListener("click",c),console.log("[Svelte] GridControlsBridge mounted")}),fi(()=>{e==null||e.removeEventListener("click",A),s==null||s.removeEventListener("click",a),i==null||i.removeEventListener("click",l),r==null||r.removeEventListener("click",c),console.log("[Svelte] GridControlsBridge unmounted")}),ls()}function FL(n,t){as(t,!0);let e=null,s=null,i=null,r=Ot(null);function o(){ut(r)===Sn.COMPRESSION_2_3?(bt(r,null),e==null||e.classList.remove("active"),h.setSelectedTool("note"),E.info("ModulationBridge","2:3 modulation tool deactivated",null,"ui")):(bt(r,Sn.COMPRESSION_2_3,!0),e==null||e.classList.add("active"),s==null||s.classList.remove("active"),h.setSelectedTool("modulation"),h.state.selectedModulationRatio=ut(r),E.info("ModulationBridge","2:3 modulation tool activated",null,"ui"))}function A(){ut(r)===Sn.EXPANSION_3_2?(bt(r,null),s==null||s.classList.remove("active"),h.setSelectedTool("note"),E.info("ModulationBridge","3:2 modulation tool deactivated",null,"ui")):(bt(r,Sn.EXPANSION_3_2,!0),s==null||s.classList.add("active"),e==null||e.classList.remove("active"),h.setSelectedTool("modulation"),h.state.selectedModulationRatio=ut(r),E.info("ModulationBridge","3:2 modulation tool activated",null,"ui"))}function a(){const d=(h.state.modulationMarkers||[]).length;if(d===0){E.info("ModulationBridge","No modulation markers to clear",null,"ui");return}h.clearModulationMarkers(),E.info("ModulationBridge",`Cleared ${d} modulation markers`,null,"ui")}function l(){if(!i)return;const d=(h.state.modulationMarkers||[]).length;d===0?(i.disabled=!0,i.style.opacity="0.5"):(i.disabled=!1,i.style.opacity="1"),i.textContent=d>0?`Clear (${d})`:"Clear"}function c(d){const p=d;(typeof p=="string"?p:p.newTool||p)!=="modulation"&&(bt(r,null),e==null||e.classList.remove("active"),s==null||s.classList.remove("active"))}function u(){l()}Ls(()=>{if(e=document.getElementById("modulation-2-3-btn"),s=document.getElementById("modulation-3-2-btn"),i=document.getElementById("modulation-clear-btn"),!e||!s||!i){E.warn("ModulationBridge","Modulation control buttons not found in DOM",null,"ui");return}e.addEventListener("click",o),s.addEventListener("click",A),i.addEventListener("click",a),h.on("toolChanged",c),h.on("modulationMarkersChanged",u),l(),E.info("ModulationBridge","Modulation controls initialized",null,"ui"),console.log("[Svelte] ModulationBridge mounted")}),fi(()=>{e==null||e.removeEventListener("click",o),s==null||s.removeEventListener("click",A),i==null||i.removeEventListener("click",a),console.log("[Svelte] ModulationBridge unmounted")}),ls()}const TL=1,QL="mlt-handoff",ML=1,xc="handoff-slots",UL="mlt-handoff-slot";function cb(){return new Promise((n,t)=>{const e=indexedDB.open(QL,ML);e.onerror=()=>{t(new Error("Failed to open IndexedDB"))},e.onsuccess=()=>{n(e.result)},e.onupgradeneeded=s=>{const i=s.target.result;i.objectStoreNames.contains(xc)||i.createObjectStore(xc,{keyPath:"handoffId"})}})}async function PL(){if(typeof indexedDB>"u")return!1;try{return(await cb()).close(),!0}catch{return!1}}function NL(){const n=Date.now().toString(36),t=Math.random().toString(36).substring(2,10);return`handoff-${n}-${t}`}async function DL(n){const t=await cb();return new Promise((e,s)=>{const i=t.transaction(xc,"readwrite"),r=i.objectStore(xc),o=r.clear();o.onsuccess=()=>{const A=r.add(n);A.onsuccess=()=>{e()},A.onerror=()=>{s(new Error("Failed to write to IndexedDB"))}},o.onerror=()=>{s(new Error("Failed to clear IndexedDB"))},i.oncomplete=()=>{t.close()}})}function _0(n){try{const t=JSON.stringify(n);localStorage.setItem(UL,t)}catch(t){throw new Error(`Failed to write to localStorage: ${t}`)}}async function LL(n){const t=NL(),e={snapshot:n,writtenAt:Date.now(),handoffId:t};if(await PL())try{return await DL(e),t}catch{return _0(e),t}else return _0(e),t}function kL(n,t){const e=n.endMicrobeatCol<t.startMicrobeatCol,s=t.endMicrobeatCol<n.startMicrobeatCol;return!e&&!s}function RL(n,t){const e=Math.max(n.startMicrobeatCol,t.startMicrobeatCol),s=Math.min(n.endMicrobeatCol,t.endMicrobeatCol);if(e>s)return[];const i=[];for(let r=e;r<=s;r++)i.push(r);return i}function HL(n){const t=[],e=n.notes;for(let s=0;s<e.length;s++)for(let i=s+1;i<e.length;i++){const r=e[s],o=e[i];if(kL(r,o)){const A=RL(r,o);t.push({voiceId:n.voiceId,color:n.color,conflictColumns:A,note1:{startMicrobeatCol:r.startMicrobeatCol,endMicrobeatCol:r.endMicrobeatCol,midiPitch:r.midiPitch},note2:{startMicrobeatCol:o.startMicrobeatCol,endMicrobeatCol:o.endMicrobeatCol,midiPitch:o.midiPitch}})}}return t}function OL(n){const t=`Note 1: cols ${n.note1.startMicrobeatCol}-${n.note1.endMicrobeatCol}, MIDI ${n.note1.midiPitch}`,e=`Note 2: cols ${n.note2.startMicrobeatCol}-${n.note2.endMicrobeatCol}, MIDI ${n.note2.midiPitch}`,s=n.conflictColumns.length===1?`column ${n.conflictColumns[0]}`:`columns ${n.conflictColumns[0]}-${n.conflictColumns[n.conflictColumns.length-1]}`;return`Voice "${n.voiceId}" (${n.color}): Overlap at ${s}
  ${t}
  ${e}`}function VL(n){const t=[],e=[];if(n.schemaVersion!==1&&e.push(`Unsupported schema version: ${n.schemaVersion}. Expected: 1`),n.timeGrid||e.push("Missing required field: timeGrid"),(!n.voices||!Array.isArray(n.voices))&&e.push("Missing or invalid field: voices"),n.clefPitchRange){const{minMidi:s,maxMidi:i}=n.clefPitchRange;!Number.isFinite(s)||!Number.isFinite(i)?e.push("Invalid clefPitchRange: MIDI values must be finite numbers"):s>i&&e.push("Invalid clefPitchRange: minMidi exceeds maxMidi")}if(n.voices)for(const s of n.voices){const i=HL(s);t.push(...i)}for(const s of t)e.push(OL(s));return{isValid:t.length===0&&e.length===0,conflicts:t,errorMessages:e}}function WL(n){const t=VL(n);if(t.isValid)return{isValid:!0,summary:"Validation passed. Ready to export to Singing Trainer.",details:t};const e=new Set(t.conflicts.map(i=>i.voiceId));return{isValid:!1,summary:`Cannot export: ${t.conflicts.length} overlap(s) found in ${e.size} voice(s).`,details:t}}function GL(n){return n.reduce((t,e)=>t+e,0)}function KL(n){if(n.length===0)return 2;const t=n.filter(s=>s===2).length;return n.filter(s=>s===3).length>t?3:2}function qL(n,t,e){const s=e.topIndex+n;if(s<0||s>=t.length)return-1;const i=t[s];return(i==null?void 0:i.midi)??-1}function zL(n,t,e){const s=e.topIndex+n;if(s<0||s>=t.length)return"Unknown";const i=t[s];return(i==null?void 0:i.toneNote)??"Unknown"}function XL(n,t){const e=n[t.topIndex],s=n[t.bottomIndex],i=e==null?void 0:e.midi,r=s==null?void 0:s.midi;return typeof i!="number"||typeof r!="number"?null:{minMidi:Math.min(i,r),maxMidi:Math.max(i,r)}}function $L(n,t,e={}){const s=n.placedNotes.filter(d=>!d.isDrum),i=new Map;for(const d of s){const p=d.color;i.has(p)||i.set(p,[]),i.get(p).push(d)}const r=[];let o=1/0,A=-1/0;for(const[d,p]of i){const f=[];for(const m of p){const g=qL(m.row,n.fullRowData,n.pitchRange),w=zL(m.row,n.fullRowData,n.pitchRange);g>0&&(o=Math.min(o,g),A=Math.max(A,g)),f.push({startMicrobeatCol:m.startColumnIndex,endMicrobeatCol:m.endColumnIndex,midiPitch:g,pitchName:w,shape:m.shape})}f.sort((m,g)=>m.startMicrobeatCol-g.startMicrobeatCol),r.push({voiceId:d,color:d,notes:f})}const a={microbeatCount:GL(n.macrobeatGroupings),microbeatsPerMacrobeat:KL(n.macrobeatGroupings),macrobeatGroupings:[...n.macrobeatGroupings],macrobeatBoundaryStyles:[...n.macrobeatBoundaryStyles]},l=[];if(n.annotations&&Array.isArray(n.annotations))for(const d of n.annotations)l.push({type:"freehand",id:d.id??`overlay-${Date.now()}`,data:d,coordinateSystem:"pixel"});const c=e.includeClefPitchRange===!1?null:XL(n.fullRowData,n.pitchRange),u={schemaVersion:TL,createdAt:Date.now(),sourceFileId:t,sourceApp:"student-notation",timeGrid:a,voices:r,tempo:n.tempo,minMidiPitch:o===1/0?void 0:o,maxMidiPitch:A===-1/0?void 0:A};return c&&(u.clefPitchRange=c),e.preferredPitchRangeSource&&(u.preferredPitchRangeSource=e.preferredPitchRangeSource),l.length>0&&(u.visualOverlays=l),e.tonalCenter&&(u.tonalCenter=e.tonalCenter),u}function YL(n){switch(n){case"student-notation":return"/student-notation/";case"singing-trainer":return"/singing-trainer/";default:throw new Error(`Unknown app: ${n}`)}}function jL(n,t){let e=YL(n);if(t&&Object.keys(t).length>0){const s=new URLSearchParams(t);e+=`?${s.toString()}`}window.location.href=e}function JL(n){const t={};n&&(t.handoff=n),t.from="student-notation",jL("singing-trainer",t)}function ZL(n,t){as(t,!0);let e=null,s=null,i=null,r=null,o=null,A=null,a=null,l=null,c=null,u=null,d=null,p=null,f=null,m=null,g=null,w=null,B=null,b=null,_=null,v=null,C=null,y=null,S=Ot(!0),F=Ot(!0),x=Ot(!0),Q=Ot(!0);const T="app.volumeSliderValue";function U(z){return Math.min(100,Math.max(0,z))}function P(){try{const z=window.localStorage.getItem(T);if(z!==null){const et=Number(z);if(!Number.isNaN(et))return U(et)}}catch{}return 70}function K(z){try{window.localStorage.setItem(T,String(U(z)))}catch{}}function M(){document.body.classList.toggle("sidebar-open")}function k(z){if(z.stopPropagation(),!o||!r)return;const et=o.classList.toggle("visible");r.classList.toggle("active",et)}function N(){const z=parseInt(this.value,10),et=z===0?-1/0:z/100*37.5-50;h.emit("volumeChanged",et),K(z)}function R(z){!o||!r||!o.contains(z.target)&&z.target!==r&&(o.classList.remove("visible"),r.classList.remove("active"))}function J(){h.setAnacrusis(!0)}function tt(){h.setAnacrusis(!1)}function rt(z){const et=z;a==null||a.classList.toggle("active",et),l==null||l.classList.toggle("active",!et)}function lt(){h.setLongNoteStyle("style1")}function W(){h.setLongNoteStyle("style2")}function H(z){const et=z;c==null||c.classList.toggle("active",et==="style1"),u==null||u.classList.toggle("active",et==="style2")}function O(){h.setPlayheadMode("cursor")}function $(){h.setPlayheadMode("microbeat")}function L(){h.setPlayheadMode("macrobeat")}function at(z){const et=z==="macrobeat"?"macrobeat":z==="microbeat"?"microbeat":"cursor";d==null||d.classList.toggle("active",et==="cursor"),p==null||p.classList.toggle("active",et==="microbeat"),f==null||f.classList.toggle("active",et==="macrobeat")}function G(){bt(S,!ut(S)),g&&(g.style.display=ut(S)?"flex":"none");const z=m==null?void 0:m.querySelector(".sidebar-button-text");z&&(z.textContent=ut(S)?"Hide Drum Grid":"Show Drum Grid"),setTimeout(()=>pe.recalculateLayout(),10)}function X(){bt(F,!ut(F)),B&&(B.style.display=ut(F)?"flex":"none");const z=w==null?void 0:w.querySelector(".sidebar-button-text");z&&(z.textContent=ut(F)?"Hide Button Grid":"Show Button Grid"),setTimeout(()=>pe.recalculateLayout(),10)}function V(){bt(x,!ut(x)),_&&(_.style.display=ut(x)?"block":"none"),b&&(b.textContent=ut(x)?"Hide Left Legend":"Show Left Legend"),setTimeout(()=>pe.recalculateLayout(),10)}function Y(){bt(Q,!ut(Q)),C&&(C.style.display=ut(Q)?"block":"none"),v&&(v.textContent=ut(Q)?"Hide Right Legend":"Show Right Legend"),setTimeout(()=>pe.recalculateLayout(),10)}function nt(z,et,Z=[]){const st=document.getElementById("notification-overlay"),pt=st==null?void 0:st.querySelector(".notification-message"),St=st==null?void 0:st.querySelector(".notification-title");if(!st||!pt){alert(`${z}

${et}${Z.length>0?`

`+Z.join(`
`):""}`);return}St&&(St.textContent=z);const Mt=Z.length>0?`<ul style="text-align: left; margin-top: 8px; padding-left: 20px;">${Z.map(ct=>`<li style="margin-bottom: 4px;">${ct.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</li>`).join("")}</ul>`:"";pt.innerHTML=`<p>${et.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</p>${Mt}`,st.classList.add("visible");const Et=st.querySelector(".notification-close"),_t=st.querySelector(".notification-button"),Jt=()=>{st.classList.remove("visible"),Et==null||Et.removeEventListener("click",Jt),_t==null||_t.removeEventListener("click",Jt)};Et==null||Et.addEventListener("click",Jt),_t==null||_t.addEventListener("click",Jt)}function D(){return h.state.placedNotes.some(z=>!z.isDrum)}async function q(){if(console.log("[Svelte] Take to Singing Trainer clicked"),!D()){nt("Cannot Export","No notes to export. Add some pitch notes to the grid before exporting to Singing Trainer.");return}const z={placedNotes:h.state.placedNotes,macrobeatGroupings:h.state.macrobeatGroupings,macrobeatBoundaryStyles:h.state.macrobeatBoundaryStyles,fullRowData:h.state.fullRowData,pitchRange:h.state.pitchRange,tempo:h.state.tempo,annotations:h.state.annotations},et=$L(z),Z=WL(et);if(!Z.isValid){console.warn("[Svelte] Handoff validation failed",Z.details);const st=[];for(const pt of Z.details.conflicts){const St=pt.conflictColumns.length===1?`column ${pt.conflictColumns[0]}`:`columns ${pt.conflictColumns[0]}-${pt.conflictColumns[pt.conflictColumns.length-1]}`;st.push(`Voice "${pt.color}": Overlap at ${St}`)}nt("Cannot Export to Singing Trainer",Z.summary,st);return}try{const st=await LL(et);console.log("[Svelte] Handoff slot written",st),JL(st)}catch(st){console.error("[Svelte] Failed to write handoff slot",st),nt("Export Failed","An error occurred while preparing the handoff. Please try again.")}}Ls(()=>{if(e=document.getElementById("settings-button"),s=document.getElementById("sidebar"),i=document.getElementById("sidebar-overlay"),r=document.getElementById("volume-icon-button"),o=document.getElementById("volume-popup"),A=document.getElementById("vertical-volume-slider"),a=document.getElementById("anacrusis-on-btn"),l=document.getElementById("anacrusis-off-btn"),c=document.getElementById("long-note-style1-btn"),u=document.getElementById("long-note-style2-btn"),d=document.getElementById("playhead-mode-cursor-btn"),p=document.getElementById("playhead-mode-microbeat-btn"),f=document.getElementById("playhead-mode-macrobeat-btn"),m=document.getElementById("hide-drumgrid-toggle"),g=document.getElementById("drum-grid-wrapper"),w=document.getElementById("hide-buttongrid-toggle"),B=document.getElementById("button-grid"),b=document.getElementById("hide-leftlegend-toggle"),_=document.getElementById("legend-left-canvas"),v=document.getElementById("hide-rightlegend-toggle"),C=document.getElementById("legend-right-canvas"),y=document.getElementById("take-to-singing-trainer-button"),e&&s&&i&&(e.addEventListener("click",M),i.addEventListener("click",M)),r&&o&&A){const z=P();A.value=String(z),r.addEventListener("click",k),A.addEventListener("input",N),document.addEventListener("click",R),A.dispatchEvent(new Event("input"))}if(a&&l&&(a.addEventListener("click",J),l.addEventListener("click",tt),h.on("anacrusisChanged",rt),a.classList.toggle("active",h.state.hasAnacrusis),l.classList.toggle("active",!h.state.hasAnacrusis)),c&&u){c.addEventListener("click",lt),u.addEventListener("click",W),h.on("longNoteStyleChanged",H);const z=h.state.longNoteStyle||"style1";c.classList.toggle("active",z==="style1"),u.classList.toggle("active",z==="style2")}if(d&&p&&f){d.addEventListener("click",O),p.addEventListener("click",$),f.addEventListener("click",L),h.on("playheadModeChanged",at);const z=h.state.playheadMode||"cursor";d.classList.toggle("active",z==="cursor"),p.classList.toggle("active",z==="microbeat"),f.classList.toggle("active",z==="macrobeat")}m&&g&&m.addEventListener("click",G),w&&B&&w.addEventListener("click",X),b&&_&&b.addEventListener("click",V),v&&C&&v.addEventListener("click",Y),y&&y.addEventListener("click",()=>{q()}),console.log("[Svelte] SidebarBridge mounted")}),fi(()=>{e==null||e.removeEventListener("click",M),i==null||i.removeEventListener("click",M),r==null||r.removeEventListener("click",k),A==null||A.removeEventListener("input",N),document.removeEventListener("click",R),a==null||a.removeEventListener("click",J),l==null||l.removeEventListener("click",tt),c==null||c.removeEventListener("click",lt),u==null||u.removeEventListener("click",W),d==null||d.removeEventListener("click",O),p==null||p.removeEventListener("click",$),f==null||f.removeEventListener("click",L),m==null||m.removeEventListener("click",G),w==null||w.removeEventListener("click",X),b==null||b.removeEventListener("click",V),v==null||v.removeEventListener("click",Y),console.log("[Svelte] SidebarBridge unmounted")}),ls()}const Eu={selectedSixteenthStampId:1,updateSixteenthStampColors:n=>{},init(){this.render(),this.bindEvents(),E.info("SixteenthStampsToolbar","Sixteenth stamps toolbar initialized",null,"stamps")},render(){const n=document.getElementById("sixteenth-stamps-toolbar-container");if(!n){E.warn("SixteenthStampsToolbar","Container not found",null,"stamps");return}n.innerHTML="";const t=document.createElement("div");t.className="sixteenth-stamps-grid",[[1,2,3,4],[5,8,14,6,9,7],[10,13,12,11,15]].forEach((s,i)=>{const r=document.createElement("div");r.className=`sixteenth-stamps-row sixteenth-stamps-row-${i+1}`,s.forEach(o=>{const A=sh.find(a=>a.id===o);if(A){const a=this.createSixteenthStampButton(A);r.appendChild(a)}}),t.appendChild(r)}),n.appendChild(t),this.setInitialSelection(this.selectedSixteenthStampId)},createSixteenthStampButton(n){const t=document.createElement("button");t.className="sixteenth-stamp-button",t.dataset.sixteenthStampId=`${n.id}`,t.setAttribute("title",`${n.id}: ${n.label}`);const e=this.createSixteenthStampPreview(n);return t.appendChild(e),t},createSixteenthStampPreview(n){const t=up.renderToSVG(n,100,100);return t.setAttribute("width","40"),t.setAttribute("height","40"),t},bindEvents(){const n=document.getElementById("sixteenth-stamps-toolbar-container");if(!n)return;n.addEventListener("click",e=>{var i;const s=(i=e.target)==null?void 0:i.closest(".sixteenth-stamp-button");if(s){const r=parseInt(s.dataset.sixteenthStampId||"",10);Number.isNaN(r)||this.selectSixteenthStamp(r)}}),this.updateSixteenthStampColors=e=>{if(!e||!n)return;const s=(l,c=50)=>{const u=parseInt(l.slice(1,3),16),d=parseInt(l.slice(3,5),16),p=parseInt(l.slice(5,7),16),f=Math.min(255,Math.floor(u+(255-u)*(c/100))),m=Math.min(255,Math.floor(d+(255-d)*(c/100))),g=Math.min(255,Math.floor(p+(255-p)*(c/100)));return`#${f.toString(16).padStart(2,"0")}${m.toString(16).padStart(2,"0")}${g.toString(16).padStart(2,"0")}`},i=(l,c=20)=>{const u=parseInt(l.slice(1,3),16),d=parseInt(l.slice(3,5),16),p=parseInt(l.slice(5,7),16),f=Math.max(0,Math.floor(u*(1-c/100))),m=Math.max(0,Math.floor(d*(1-c/100))),g=Math.max(0,Math.floor(p*(1-c/100)));return`#${f.toString(16).padStart(2,"0")}${m.toString(16).padStart(2,"0")}${g.toString(16).padStart(2,"0")}`},r=h.state.colorPalette[e]||{primary:e,light:e},o=s(r.light,60),A=r.primary,a=i(A,20);n.style.setProperty("--c-accent",A),n.style.setProperty("--c-accent-light",o),n.style.setProperty("--c-accent-hover",a)},h.on("noteChanged",({newNote:e}={})=>{e!=null&&e.color&&this.updateSixteenthStampColors(e.color)});const t=h.state.selectedNote;t!=null&&t.color&&this.updateSixteenthStampColors(t.color),h.on("toolChanged",({newTool:e}={})=>{e&&e!=="sixteenthStamp"&&this.clearSelection()}),h.on("tripletStampToolSelected",()=>{this.clearSelection()})},setInitialSelection(n){this.selectedSixteenthStampId=n;const t=document.getElementById("sixteenth-stamps-toolbar-container");t&&t.querySelectorAll(".sixteenth-stamp-button").forEach(e=>{const s=e;s.classList.toggle("active",parseInt(s.dataset.sixteenthStampId||"",10)===n)})},selectSixteenthStamp(n){this.selectedSixteenthStampId=n;const t=document.getElementById("sixteenth-stamps-toolbar-container");t&&t.querySelectorAll(".sixteenth-stamp-button").forEach(e=>{const s=e;s.classList.toggle("active",parseInt(s.dataset.sixteenthStampId||"",10)===n)}),h.setSelectedTool("sixteenthStamp"),h.emit("sixteenthStampSelected",n),h.emit("sixteenthStampToolSelected")},clearSelection(){const n=document.getElementById("sixteenth-stamps-toolbar-container");n&&n.querySelectorAll(".sixteenth-stamp-button").forEach(t=>{t.classList.remove("active")})},getSelectedSixteenthStamp(){return sh.find(t=>t.id===this.selectedSixteenthStampId)}};class t5{constructor(){I(this,"overlay");I(this,"modal");I(this,"title");I(this,"message");I(this,"actionsContainer");I(this,"closeButton");var t,e,s,i,r;this.overlay=document.getElementById("notification-overlay"),this.modal=(t=this.overlay)==null?void 0:t.querySelector(".notification-modal"),this.title=(e=this.overlay)==null?void 0:e.querySelector(".notification-title"),this.message=(s=this.overlay)==null?void 0:s.querySelector(".notification-message"),this.actionsContainer=(i=this.overlay)==null?void 0:i.querySelector(".notification-actions"),this.closeButton=(r=this.overlay)==null?void 0:r.querySelector(".notification-close"),this.setupEventListeners()}setupEventListeners(){var t;this.overlay&&((t=this.closeButton)==null||t.addEventListener("click",()=>this.hide()),this.overlay.addEventListener("click",e=>{e.target===this.overlay&&this.hide()}),document.addEventListener("keydown",e=>{var s;e.key==="Escape"&&((s=this.overlay)!=null&&s.classList.contains("visible"))&&this.hide()}))}show(t={}){const e=this.overlay;if(!e)return;const{title:s="Notice",message:i="",buttons:r=[{text:"OK",primary:!0,action:()=>this.hide()}]}=t;this.title&&(this.title.textContent=s),this.message&&(this.message.textContent=i);const o=this.actionsContainer;o&&(o.innerHTML="",r.forEach(A=>{const a=document.createElement("button");a.className=`notification-button ${A.primary?"":"secondary"}`,a.textContent=A.text,a.addEventListener("click",()=>{A.action?A.action():this.hide()}),o.appendChild(a)})),e.classList.add("visible"),setTimeout(()=>{var a;const A=(a=this.actionsContainer)==null?void 0:a.querySelector(".notification-button");A==null||A.focus()},100)}hide(){this.overlay&&this.overlay.classList.remove("visible")}alert(t,e="Notice"){this.show({title:e,message:t,buttons:[{text:"OK",primary:!0,action:()=>this.hide()}]})}confirm(t,e="Confirm"){return new Promise(s=>{this.show({title:e,message:t,buttons:[{text:"Cancel",primary:!1,action:()=>{this.hide(),s(!1)}},{text:"OK",primary:!0,action:()=>{this.hide(),s(!0)}}]})})}}const I0=new t5,qh=40,e5=qh;class F0{constructor(t,e,s,i,r){I(this,"element");I(this,"viewportEl");I(this,"optionsEl");I(this,"onChange");I(this,"onBeforeChange");I(this,"options");I(this,"optionNodes",[]);I(this,"selectedIndex",0);I(this,"pointerActive",!1);I(this,"pointerId",null);I(this,"lastPointerY",0);I(this,"deltaBuffer",0);I(this,"optionHeight",qh);I(this,"resizeObserver",null);this.element=t,this.viewportEl=t==null?void 0:t.querySelector(".clef-wheel-viewport"),this.optionsEl=t==null?void 0:t.querySelector(".clef-wheel-options"),this.onChange=i,this.onBeforeChange=r||null,this.options=e,!(!t||!this.viewportEl||!this.optionsEl)&&(this.renderOptions(),this.setIndex(s,{silent:!0}),this.attachEvents(),this.observeSize())}renderOptions(){const t=this.optionsEl;t&&(t.innerHTML="",this.optionNodes=this.options.map((e,s)=>{const i=document.createElement("div");return i.className="clef-wheel-option",i.dataset.index=s.toString(),i.textContent=e.label,t.appendChild(i),i}))}attachEvents(){if(!this.element)return;this.element.addEventListener("wheel",e=>{e.preventDefault(),e.stopPropagation();const s=Math.sign(e.deltaY);s!==0&&this.increment(s)},{passive:!1}),this.element.addEventListener("keydown",e=>{e.key==="ArrowUp"?(e.preventDefault(),this.increment(-1)):e.key==="ArrowDown"?(e.preventDefault(),this.increment(1)):e.key==="Home"?(e.preventDefault(),this.setIndex(0)):e.key==="End"&&(e.preventDefault(),this.setIndex(this.options.length-1))}),this.element.addEventListener("pointerdown",e=>{var s;if(this.pointerActive=!0,this.pointerId=e.pointerId,this.lastPointerY=e.clientY,this.deltaBuffer=0,typeof((s=this.element)==null?void 0:s.setPointerCapture)=="function")try{this.element.setPointerCapture(this.pointerId)}catch{}}),this.element.addEventListener("pointermove",e=>{if(!this.pointerActive||e.pointerId!==this.pointerId)return;const s=e.clientY-this.lastPointerY;if(this.lastPointerY=e.clientY,s===0)return;this.deltaBuffer+=s;const i=this.optionHeight||e5;for(;Math.abs(this.deltaBuffer)>=i;){const r=-Math.sign(this.deltaBuffer);this.increment(r),this.deltaBuffer-=Math.sign(this.deltaBuffer)*i}});const t=e=>{var s,i;this.pointerActive&&e.pointerId===this.pointerId&&(this.pointerActive=!1,this.pointerId=null,this.deltaBuffer=0,(i=(s=this.element)==null?void 0:s.hasPointerCapture)!=null&&i.call(s,e.pointerId)&&this.element.releasePointerCapture(e.pointerId))};this.element.addEventListener("pointerup",t),this.element.addEventListener("pointercancel",t),this.element.addEventListener("pointerleave",t)}observeSize(){this.element&&(typeof ResizeObserver=="function"?(this.resizeObserver=new ResizeObserver(t=>{for(const e of t)e.target===this.element&&e.contentRect.height>0&&this.updateVisuals()}),this.resizeObserver.observe(this.element)):window.addEventListener("resize",()=>this.updateVisuals()))}getIndex(){return this.selectedIndex}increment(t){t===0||!this.options||this.options.length===0||this.setIndex(this.selectedIndex+t)}setIndex(t,{silent:e=!1}={}){if(!this.optionsEl)return;let s=t;!e&&typeof this.onBeforeChange=="function"&&(s=this.onBeforeChange(t));const i=Math.max(0,Math.min(this.options.length-1,s));if(i===this.selectedIndex){this.updateVisuals();return}if(this.selectedIndex=i,this.updateVisuals(),!e&&typeof this.onChange=="function"){const r=this.options[i];r&&this.onChange(i,r)}}updateVisuals(){var a,l,c;if(!this.optionsEl||!this.viewportEl)return;const t=this.viewportEl.clientHeight||0,e=(a=this.optionNodes)==null?void 0:a[this.selectedIndex],s=(l=this.optionNodes)==null?void 0:l[0],i=(e==null?void 0:e.offsetHeight)||(s==null?void 0:s.offsetHeight)||qh;if(this.optionHeight=i,(c=this.optionNodes)==null||c.forEach((u,d)=>{const p=Math.abs(d-this.selectedIndex);u.dataset.distance=String(Math.min(p,3))}),t===0||i===0)return;const r=Math.max(0,(t-i)/2);this.optionsEl.style.paddingTop=`${r}px`,this.optionsEl.style.paddingBottom=`${r}px`;const o=e?e.offsetTop+i/2:r+i/2,A=t/2-o;this.optionsEl.style.transform=`translateY(${A}px)`}}class n5{constructor(){I(this,"initialized",!1);I(this,"topPicker",null);I(this,"bottomPicker",null);I(this,"topWheel",null);I(this,"bottomWheel",null);I(this,"rangeLabel",null);I(this,"rangeCount",null);I(this,"fullRangeButton",null);I(this,"trebleButton",null);I(this,"altoButton",null);I(this,"bassButton",null);I(this,"presetContainer",null);I(this,"presetButtons",[]);I(this,"activePresetId",null);I(this,"masterOptions",[]);I(this,"presetRanges",{});I(this,"constrainTopIndex",t=>{if(!this.bottomPicker)return t;const e=this.bottomPicker.getIndex(),s=this.masterOptions.length;return rT(e,t,s,re)});I(this,"constrainBottomIndex",t=>{if(!this.topPicker)return t;const e=this.topPicker.getIndex(),s=this.masterOptions.length;return oT(e,t,s,re)})}init(){if(this.initialized)return;if(this.topWheel=document.getElementById("clef-top-wheel"),this.bottomWheel=document.getElementById("clef-bottom-wheel"),this.rangeLabel=document.getElementById("clef-range-label"),this.rangeCount=document.getElementById("clef-range-count"),this.fullRangeButton=document.getElementById("clef-full-range-button"),this.trebleButton=document.getElementById("clef-treble-button"),this.altoButton=document.getElementById("clef-alto-button"),this.bassButton=document.getElementById("clef-bass-button"),this.presetContainer=document.querySelector(".clef-preset-buttons"),this.presetButtons=Array.from(document.querySelectorAll(".clef-preset-button")),!this.topWheel||!this.bottomWheel){E.warn("ClefViewportController","Clef tab elements not found; skipping initialization",null,"ui");return}this.masterOptions=qs.map((e,s)=>({index:s,label:e.pitch,toneNote:e.toneNote,frequency:e.frequency}));const t=this.getViewportRange();this.topPicker=new F0(this.topWheel,this.masterOptions,t.topIndex,e=>this.handleTopSelection(e),e=>this.constrainTopIndex(e)),this.bottomPicker=new F0(this.bottomWheel,this.masterOptions,t.bottomIndex,e=>this.handleBottomSelection(e),e=>this.constrainBottomIndex(e)),this.computePresetRanges(),this.fullRangeButton&&this.fullRangeButton.addEventListener("click",()=>this.applyPresetView("full")),this.trebleButton&&this.trebleButton.addEventListener("click",()=>this.applyPresetView("treble")),this.altoButton&&this.altoButton.addEventListener("click",()=>this.applyPresetView("alto")),this.bassButton&&this.bassButton.addEventListener("click",()=>this.applyPresetView("bass")),h.on("pitchRangeChanged",()=>{this.syncFromViewport()}),h.on("zoomChanged",()=>{this.syncFromViewport()}),this.calculateAndSetWheelHeight(),window.addEventListener("resize",()=>this.calculateAndSetWheelHeight()),this.syncFromViewport(),this.initialized=!0,E.moduleLoaded("ClefViewportController","ui")}refreshWheelVisuals(){var t,e;(t=this.topPicker)==null||t.updateVisuals(),(e=this.bottomPicker)==null||e.updateVisuals()}getViewportRange(){var A;const t=Math.max(0,this.masterOptions.length-1),e=je.getViewportInfo(),s=(e==null?void 0:e.startRank)??((A=h.state.pitchRange)==null?void 0:A.topIndex)??0,i=(e==null?void 0:e.endRank)??s+1,r=Math.max(0,Math.min(t,s)),o=Math.max(r,Math.min(t,i-1));return{topIndex:r,bottomIndex:o}}syncFromViewport(){if(!this.topPicker||!this.bottomPicker)return;const{topIndex:t,bottomIndex:e}=this.getViewportRange();this.topPicker.setIndex(t,{silent:!0}),this.bottomPicker.setIndex(e,{silent:!0}),this.updateSummary(t,e),this.updatePresetHighlight(t,e)}handleTopSelection(t){E.debug("ClefViewportController","handleTopSelection called",{newTopIndex:t},"ui"),je.setViewportTopIndex(t)}handleBottomSelection(t){E.debug("ClefViewportController","handleBottomSelection called",{newBottomIndex:t},"ui"),je.setViewportBottomIndex(t)}updateSummary(t,e){const s=this.masterOptions[t],i=this.masterOptions[e],r=e-t+1;this.rangeLabel&&s&&i&&(this.rangeLabel.textContent=`${s.label}  ${i.label}`),this.rangeCount&&(this.rangeCount.textContent=`${r} ${r===1?"pitch":"pitches"}`)}computePresetRanges(){const t=(e,s)=>{const i=this.findToneNoteIndex(e),r=this.findToneNoteIndex(s);return i===-1||r===-1?null:{topIndex:Math.min(i,r),bottomIndex:Math.max(i,r)}};this.presetRanges={full:{topIndex:0,bottomIndex:Math.max(0,this.masterOptions.length-1)},treble:t("G5","C4"),alto:t("A4","D3"),bass:t("C4","E2"),voice1:t("A5","A3"),voice2:t("C5","C3"),voice3:t("E4","E2")}}updatePresetHighlight(t,e){var i;let s=null;Object.entries(this.presetRanges).forEach(([r,o])=>{o&&o.topIndex===t&&o.bottomIndex===e&&(s=r)}),this.activePresetId=s,(i=this.presetButtons)!=null&&i.length&&(this.presetButtons.forEach(r=>{var a;const o=(a=r.dataset)!=null&&a.preset?r.dataset.preset??"":(r.id||"").replace(/^clef-/,"").replace(/-button$/,"").replace(/-range$/,"").replace(/-/g,""),A=this.activePresetId&&o===this.activePresetId;r.classList.toggle("active",!!A)}),this.presetContainer&&this.presetContainer.classList.toggle("locked",!1))}applyPresetView(t){const e=this.presetRanges[t];if(!e){E.warn("ClefViewportController","Preset range could not be resolved",{preset:t},"ui");return}const s=t==="full"?420:280;je.setPitchViewportRange(e,{animateMs:s,source:`preset:${t}`})}findNoteIndex(t){return this.masterOptions.findIndex(e=>e.label===t)}findToneNoteIndex(t){return this.masterOptions.findIndex(e=>e.toneNote===t)}calculateAndSetWheelHeight(){const t=document.querySelector(".range-panel-section.wheels-section"),e=t==null?void 0:t.querySelector(".panel-section-title");if(!t||!this.topWheel||!this.bottomWheel)return;const s=t.clientHeight,i=(e==null?void 0:e.offsetHeight)||0,o=s-i-15,A=Math.max(120,Math.min(o,300));this.topWheel.style.setProperty("--clef-wheel-height",`${A}px`),this.bottomWheel.style.setProperty("--clef-wheel-height",`${A}px`),setTimeout(()=>{var a,l;(a=this.topPicker)==null||a.updateVisuals(),(l=this.bottomPicker)==null||l.updateVisuals()},0)}}const T0=new n5,s5={X:["1P","3M","5P"],x:["1P","3m","5P"],"x":["1P","3m","5d"],"X+":["1P","3M","5A"],"X":["1P","3M","5P","7m"],"x":["1P","3m","5P","7m"],"Xmaj":["1P","3M","5P","7M"],"":["1P","3m","5d","7m"],"x":["1P","3m","5d","6M"],"X":["1P","3M","5P","6M"],Xsus2:["1P","2M","5P"],Xsus4:["1P","4P","5P"]},i5={"xmaj":["1P","3m","5P","7M"],Xadd9:["1P","3M","5P","9M"],xadd9:["1P","3m","5P","9M"],"X6/9":["1P","3M","5P","6M","9M"],X9:["1P","3M","5P","7m","9M"],X11:["1P","3M","5P","7m","9M","11P"],X13:["1P","3M","5P","7m","9M","13M"],Xmaj9:["1P","3M","5P","7M","9M"],"x":["1P","3m","5P","7m","9M"],"x":["1P","3m","5P","6M"],"x":["1P","3m","5P","7m","9M","11P"],"Xmaj711":["1P","3M","5P","7M","11A"]},Q0={...s5,...i5},M0={M6:["6M"],A6:["6A"],m7:["7m"],M7:["7M"],d5:["5d"],P5:["5P"],A5:["5A"],m6:["6m"],m3:["3m"],M3:["3M"],P4:["4P"],A4:["4A"],U:["1P"],m2:["2m"],M2:["2M"],A2:["2A"]},r5={"9m":"2m","9M":"2M","9A":"2A","11P":"4P","11A":"4A","13m":"6m","13M":"6M","13A":"6A"};function yd(n){return r5[n]??n}function o5(n,t){as(t,!0);const e=15;let s=Ot("diatonic"),i=Ot("position"),r=null,o=null,A=null,a=null,l=null,c=null,u=null,d=null,p=null,f=null,m=null,g=null,w=null,B=null,b=[];function _(){return Object.keys(h.state.tonicSignGroups).length>0}function v(G=h.state.degreeDisplayMode){const X=A==null?void 0:A.querySelector('[data-mode="diatonic"]'),V=A==null?void 0:A.querySelector('[data-mode="modal"]');if(!X||!V)return;G!=="off"&&bt(s,G,!0);const Y=G==="off"?ut(s):G,nt=G==="off";[X,V].forEach(D=>{D.disabled=nt,D.classList.toggle("disabled",nt)}),A&&A.classList.toggle("disabled",nt),X.classList.toggle("active",Y==="diatonic"),X.setAttribute("aria-pressed",Y==="diatonic"?"true":"false"),V.classList.toggle("active",Y==="modal"),V.setAttribute("aria-pressed",Y==="modal"?"true":"false")}function C(G,X){if(!X)return;const V=G!=="off";X.classList.toggle("active",V),X.setAttribute("aria-pressed",V?"true":"false")}function y(){var G;if(w&&(w.querySelectorAll(".harmony-preset-button").forEach(X=>{X.classList.remove("selected","partial-match")}),h.state.activeChordIntervals)){const X=h.state.activeChordIntervals,V=X.toString(),Y=X.map(yd),nt=w.querySelectorAll(".harmony-preset-button");for(const D of nt){const q=((G=D.textContent)==null?void 0:G.trim())??"",z=Q0[q];if(!z)continue;const et=z.toString(),Z=z.map(yd);if(et===V){D.classList.add("selected");continue}Y.every(pt=>Z.includes(pt))&&D.classList.add("partial-match")}}}function S(){if(B&&(B.querySelectorAll(".harmony-preset-button").forEach(G=>G.classList.remove("selected")),h.state.activeChordIntervals)){const X=h.state.activeChordIntervals.map(yd);B.querySelectorAll(".harmony-preset-button").forEach(V=>{var q;const Y=((q=V.textContent)==null?void 0:q.trim())??"",nt=M0[Y],D=nt==null?void 0:nt[0];D&&X.includes(D)&&V.classList.add("selected")})}}const F=(G,X=50)=>{const V=parseInt(G.slice(1,3),16),Y=parseInt(G.slice(3,5),16),nt=parseInt(G.slice(5,7),16),D=Math.min(255,Math.floor(V+(255-V)*(X/100))),q=Math.min(255,Math.floor(Y+(255-Y)*(X/100))),z=Math.min(255,Math.floor(nt+(255-nt)*(X/100)));return`#${D.toString(16).padStart(2,"0")}${q.toString(16).padStart(2,"0")}${z.toString(16).padStart(2,"0")}`},x=(G,X=1)=>{const V=G.startsWith("#")?G.slice(1):G;if(V.length!==6)return G;const Y=parseInt(V.slice(0,2),16),nt=parseInt(V.slice(2,4),16),D=parseInt(V.slice(4,6),16);return`rgba(${Y}, ${nt}, ${D}, ${X})`},Q=(G,X)=>{if(!G)return;const V=F(X,50),Y=F(V,60);G.style.setProperty("--c-accent",X),G.style.setProperty("--c-accent-light",Y),G.style.setProperty("--harmony-partial-bg",x(Y,.25)),G.style.setProperty("--harmony-partial-border",x(X,.4)),G.style.setProperty("--harmony-partial-bg-hover",x(Y,.4)),G.style.setProperty("--harmony-partial-border-hover",x(X,.6))};function T(){var X;return(((X=h.state.activeChordIntervals)==null?void 0:X.length)??0)===2?"inversion":"position"}function U(){var X;const G=((X=h.state.activeChordIntervals)==null?void 0:X.length)??1;return G===2?2:Math.max(1,G)}function P(){return T()==="inversion"?h.state.isIntervalsInverted?1:0:h.state.chordPositionState}function K(G){T()==="inversion"?h.setIntervalsInversion(G===1):h.setChordPosition(G)}function M(){var Y;if(!g)return;const G=T(),X=P(),V=((Y=h.state.activeChordIntervals)==null?void 0:Y.length)??1;g.classList.toggle("inversion-mode",G==="inversion"),g.classList.toggle("position-mode",G==="position"),g.classList.remove("state-1","state-2","state-3","state-4","state-5"),X>=1&&X<=5&&g.classList.add(`state-${X}`);for(let nt=1;nt<=5;nt++)g.classList.remove(`disabled-state-${nt}`);G==="position"&&(V<=1?g.classList.add("disabled-state-1"):V===2?g.classList.add("disabled-state-2"):V===3?g.classList.add("disabled-state-3"):V===4?g.classList.add("disabled-state-4"):V===5&&g.classList.add("disabled-state-5"))}function k(){var V;const G=T(),X=((V=h.state.activeChordIntervals)==null?void 0:V.length)??1;if(ut(i)!==G){if(G==="inversion"){const Y=h.state.chordPositionState===0;h.setIntervalsInversion(!Y)}else h.setChordPosition(0);bt(i,G,!0)}else if(G==="position"){const Y=Math.max(0,X-1);h.state.chordPositionState>Y&&h.setChordPosition(0)}M()}function N(){k()}function R(G=h.state.selectedToolTonicNumber){if(!b.length)return;const X=b[0]?parseInt(b[0].dataset.tonic??"1",10):1,V=typeof G=="number"?G:parseInt(String(G??""),10),Y=Number.isNaN(V)?X:V;b.forEach(nt=>{const D=nt.dataset.tonic,z=(D?parseInt(D,10):NaN)===Y;nt.classList.toggle("selected",z),nt.setAttribute("aria-pressed",z?"true":"false")})}function J(){return l!=null&&l.classList.contains("active")?"modal":a!=null&&a.classList.contains("active")?"diatonic":ut(s)}function tt(){const G=document.querySelector('[data-tab="rhythm"]');G&&!G.classList.contains("active")&&G.click();const X=document.querySelector('[data-rhythm-stamp-tab="sixteenth"]');X&&!X.classList.contains("active")&&X.click()}const rt=G=>{[c,u,p].forEach(X=>{X&&(X.classList.toggle("accidental-btn--disabled",G),X.setAttribute("aria-disabled",G?"true":"false"))})},lt=G=>{G!==void 0&&(d&&(d.classList.toggle("active",G),d.setAttribute("aria-pressed",G?"true":"false")),rt(G))},W=G=>{G!==void 0&&p&&(p.classList.toggle("active",G),p.setAttribute("aria-pressed",G?"true":"false"))};function H({newTool:G}={}){var X;if(r==null||r.classList.remove("selected"),m&&m.classList.remove("active-tool"),G==="eraser")r==null||r.classList.add("selected");else if(G==="chord")m==null||m.classList.add("active-tool");else if(G==="note"){const V=h.state.selectedNote;if(V){const Y=document.querySelector(`.note-pair[data-color='${V.color}']`);Y==null||Y.classList.add("selected"),(X=Y==null?void 0:Y.querySelector(`.note[data-type='${V.shape}']`))==null||X.classList.add("selected")}}R()}function O(){y(),S(),N()}function $({newNote:G}={}){var D;if(!(G!=null&&G.color)||!G.shape)return;const{color:X,shape:V}=G;document.querySelectorAll(".note, .note-pair").forEach(q=>q.classList.remove("selected"));const Y=document.querySelector(`.note[data-color='${X}'][data-type='${V}']`);if(Y)Y.classList.add("selected");else{const q=document.querySelector(`.note-pair[data-color='${X}']`);q==null||q.classList.add("selected"),(D=q==null?void 0:q.querySelector(`.note[data-type='${V}']`))==null||D.classList.add("selected")}Q(m,X);const nt=document.querySelector(".tab-sidebar");nt&&nt.style.setProperty("--c-accent",X)}function L(G){G&&(C(G,o),v(G))}function at(G){G&&(u==null||u.classList.toggle("active",G.sharp),c==null||c.classList.toggle("active",G.flat))}Ls(()=>{var _t,Jt;const G=Ai.getMultiple("noteBankContainer","eraserButton","degreeVisibilityToggle","degreeModeToggle","flatBtn","sharpBtn","frequencyBtn","octaveLabelBtn","focusColoursToggle");r=G.eraserButton,o=G.degreeVisibilityToggle??null,A=G.degreeModeToggle,a=(A==null?void 0:A.querySelector('[data-mode="diatonic"]'))??null,l=(A==null?void 0:A.querySelector('[data-mode="modal"]'))??null,c=G.flatBtn,u=G.sharpBtn,d=G.frequencyBtn,p=G.octaveLabelBtn,f=G.focusColoursToggle,m=document.querySelector(".pitch-tabs-container"),g=document.getElementById("unified-position-toggle"),w=document.querySelector("#chords-panel .chords-grid"),B=document.querySelector("#chords-panel .intervals-4x4-grid"),b=Array.from(document.querySelectorAll(".tonic-mode-button")),T0.init(),document.querySelectorAll(".note").forEach(ct=>{ct.addEventListener("click",()=>{var qt;const Ct=ct.dataset.type,vt=ct.dataset.color||((qt=ct.closest(".note-pair"))==null?void 0:qt.dataset.color);if(!(!Ct||!vt)){if(Ct==="diamond"){h.setSelectedNote("diamond",vt);const Ge=document.querySelector(".sixteenth-stamp-button.active"),en=Ge?parseInt(Ge.dataset.sixteenthStampId??"",10):NaN;if(h.state.selectedTool==="sixteenthStamp"&&Ge&&!Number.isNaN(en)&&en!==e)return;tt(),Eu.selectSixteenthStamp(e);return}h.setSelectedNote(Ct,vt),h.setSelectedTool("note")}})}),r&&r.addEventListener("click",()=>{if(h.state.selectedTool==="eraser"){h.setSelectedTool(h.state.previousTool||"note");return}h.setSelectedTool("eraser")});const V=document.getElementById("lasso-shortcut-button");V&&V.addEventListener("click",()=>{var ct,Ct,vt;(ct=document.querySelector('[data-tab="pitch"]'))==null||ct.click(),(Ct=document.querySelector('[data-pitch-tab="draw"]'))==null||Ct.click(),(vt=document.querySelector('button.draw-tool-button[data-draw-tool="lasso"]'))==null||vt.click()});const Y=document.getElementById("marker-shortcut-button");Y&&Y.addEventListener("click",()=>{var ct,Ct,vt;(ct=document.querySelector('[data-tab="pitch"]'))==null||ct.click(),(Ct=document.querySelector('[data-pitch-tab="draw"]'))==null||Ct.click(),(vt=document.querySelector('button.draw-tool-button[data-draw-tool="marker"]'))==null||vt.click()}),b.length&&(b.forEach(ct=>{ct.addEventListener("click",()=>{const Ct=ct.getAttribute("data-tonic");if(!Ct)return;const vt=parseInt(Ct,10);h.setSelectedTool("tonicization",vt),R(vt)})}),R()),w&&w.querySelectorAll(".harmony-preset-button").forEach(ct=>{ct.addEventListener("click",()=>{var qt;const Ct=((qt=ct.textContent)==null?void 0:qt.trim())??"",vt=Q0[Ct];vt&&vt.length>0&&(h.setActiveChordIntervals(vt),h.setSelectedTool("chord")),ct.blur()}),ct.addEventListener("dblclick",()=>{ct.classList.contains("selected")&&h.setSelectedTool("note"),ct.blur()})}),B&&B.querySelectorAll(".harmony-preset-button").forEach(ct=>{ct.addEventListener("click",()=>{var qt;const Ct=((qt=ct.textContent)==null?void 0:qt.trim())??"",vt=M0[Ct];if(vt&&vt.length>0){const Ge=vt[0];if(!Ge)return;let en=h.state.selectedTool==="chord"&&h.state.activeChordIntervals?[...h.state.activeChordIntervals]:["1P"];en.includes(Ge)?Ge!=="1P"&&(en=en.filter(Pr=>Pr!==Ge)):en.push(Ge),en.includes("1P")||en.unshift("1P");const Ur=["1P","2m","2M","2A","3m","3M","4P","4A","5d","5P","5A","6m","6M","6A","7m","7M","9M","11P","11A","13M"];en.sort((Pr,Ma)=>Ur.indexOf(Pr)-Ur.indexOf(Ma)),h.setActiveChordIntervals(en),h.setSelectedTool("chord")}ct.blur()}),ct.addEventListener("dblclick",()=>{h.setActiveChordIntervals(["1P"]),h.setSelectedTool("chord"),ct.blur()})});const nt=document.querySelectorAll(".pitch-tab-button"),D=document.querySelectorAll(".pitch-tab-panel");nt.forEach(ct=>{ct.addEventListener("click",()=>{var vt;const Ct=ct.dataset.pitchTab;Ct&&(nt.forEach(qt=>qt.classList.remove("active")),ct.classList.add("active"),D.forEach(qt=>qt.classList.remove("active")),(vt=document.getElementById(`${Ct}-panel`))==null||vt.classList.add("active"),localStorage.setItem("selectedPitchTab",Ct),Ct==="chords"&&N(),Ct==="range"&&setTimeout(()=>T0.refreshWheelVisuals(),0))})});const q=localStorage.getItem("selectedPitchTab")||"chords",z=document.querySelector(`[data-pitch-tab="${q}"]`);z&&(nt.forEach(ct=>ct.classList.remove("active")),D.forEach(ct=>ct.classList.remove("active")),z.classList.add("active"),(_t=document.getElementById(`${q}-panel`))==null||_t.classList.add("active"));const et=document.querySelectorAll(".rhythm-stamp-tab-button"),Z=document.querySelectorAll(".rhythm-stamp-tab-panel");et.forEach(ct=>{ct.addEventListener("click",()=>{var vt;const Ct=ct.dataset.rhythmStampTab;Ct&&(et.forEach(qt=>qt.classList.remove("active")),ct.classList.add("active"),Z.forEach(qt=>qt.classList.remove("active")),(vt=document.getElementById(`${Ct}-stamps-panel`))==null||vt.classList.add("active"),localStorage.setItem("selectedRhythmStampTab",Ct))})});const st=localStorage.getItem("selectedRhythmStampTab")||localStorage.getItem("selectedRhythmTab"),pt=st==="stamps"?"sixteenth":st==="triplets"?"triplet":st||"sixteenth",St=document.querySelector(`[data-rhythm-stamp-tab="${pt}"]`);if(St&&(et.forEach(ct=>ct.classList.remove("active")),Z.forEach(ct=>ct.classList.remove("active")),St.classList.add("active"),(Jt=document.getElementById(`${pt}-stamps-panel`))==null||Jt.classList.add("active")),g){const ct=g.querySelector(".toggle-track");ct==null||ct.addEventListener("click",()=>{const Ct=P(),vt=U();K((Ct+1)%vt),g==null||g.blur()}),g.querySelectorAll(".left-labels .state-label").forEach(Ct=>{Ct.addEventListener("click",()=>{T()==="inversion"&&K(parseInt(Ct.dataset.step??"0",10))})}),g.querySelectorAll(".right-labels .state-label").forEach(Ct=>{Ct.addEventListener("click",()=>{if(T()!=="position")return;const vt=parseInt(Ct.dataset.step??"0",10);vt<U()&&K(vt)})}),h.on("chordPositionChanged",M),h.on("intervalsInversionChanged",M),M()}o&&o.addEventListener("click",()=>{if(h.state.degreeDisplayMode==="off"){if(!_()){I0.alert("Please place a tonal center on the canvas before showing degrees.","Tonal Center Required");return}h.setDegreeDisplayMode(J())}else h.setDegreeDisplayMode("off");o==null||o.blur()}),a&&a.addEventListener("click",()=>{h.state.degreeDisplayMode!=="off"&&h.state.degreeDisplayMode!=="diatonic"&&h.setDegreeDisplayMode("diatonic"),a==null||a.blur()}),l&&l.addEventListener("click",()=>{h.state.degreeDisplayMode!=="off"&&h.state.degreeDisplayMode!=="modal"&&h.setDegreeDisplayMode("modal"),l==null||l.blur()}),c&&c.addEventListener("click",()=>{h.state.showFrequencyLabels&&h.toggleFrequencyLabels(),h.toggleAccidentalMode("flat"),c==null||c.blur()}),u&&u.addEventListener("click",()=>{h.state.showFrequencyLabels&&h.toggleFrequencyLabels(),h.toggleAccidentalMode("sharp"),u==null||u.blur()}),d&&d.addEventListener("click",()=>{h.toggleFrequencyLabels(),d==null||d.blur()}),p&&p.addEventListener("click",()=>{h.state.showFrequencyLabels&&h.toggleFrequencyLabels(),h.toggleOctaveLabels(),p==null||p.blur()}),f&&f.addEventListener("change",()=>{if(!h.state.focusColours&&!_()){I0.alert("Please place a tonal center on the canvas before enabling focus colours.","Tonal Center Required"),f&&(f.checked=!1);return}h.toggleFocusColours()}),h.on("toolChanged",H),h.on("activeChordIntervalsChanged",O),h.on("noteChanged",$),h.on("degreeDisplayModeChanged",L),h.on("accidentalModeChanged",at),h.on("frequencyLabelsChanged",lt),h.on("octaveLabelsChanged",W),lt(h.state.showFrequencyLabels),W(h.state.showOctaveLabels),m&&h.state.selectedNote&&Q(m,h.state.selectedNote.color);const Mt=document.querySelector(".tab-sidebar");Mt&&h.state.selectedNote&&Mt.style.setProperty("--c-accent",h.state.selectedNote.color),setTimeout(()=>N(),50);const Et=h.state.degreeDisplayMode;C(Et,o),v(Et),y(),S(),N(),console.log("[Svelte] ToolSelectorBridge mounted")}),fi(()=>{console.log("[Svelte] ToolSelectorBridge unmounted")}),ls()}class Sd{constructor(t,e={}){I(this,"parent");I(this,"settings");I(this,"_em");I(this,"_value");I(this,"decimalPlaces");I(this,"colors");I(this,"element");I(this,"_minDimension");I(this,"actual",0);I(this,"hasMoved",!1);I(this,"clicked",!1);I(this,"_start",{y:0});I(this,"_changeFactor",1);var a,l,c,u;const s=typeof t=="string"?document.querySelector(t):t;if(this.parent=s,!this.parent)throw new Error("DraggableNumber: parent element not found");const i={size:[60,30],value:0,min:0,max:2e4,step:1,decimalPlaces:2,colors:{fill:"#e7e7e7",dark:"#333",light:"#fff",accent:"#b35"},useAppStyling:!1},r={fill:((a=e.colors)==null?void 0:a.fill)??i.colors.fill,dark:((l=e.colors)==null?void 0:l.dark)??i.colors.dark,light:((c=e.colors)==null?void 0:c.light)??i.colors.light,accent:((u=e.colors)==null?void 0:u.accent)??i.colors.accent};this.settings={...i,...e,colors:r},this._em=new a5,this._value=new A5(this.settings.min,this.settings.max,this.settings.step,this.settings.value),this.decimalPlaces=this.settings.decimalPlaces,this.colors=this.settings.colors,this.element=document.createElement("input"),this.element.type="text",this.parent.appendChild(this.element);const[o,A]=this.settings.size;this._minDimension=Math.min(o,A),this.settings.useAppStyling?(this.element.className="draggable-number-input",this.element.style.cssText=[`width:${o}px`,`height:${A}px`,"background-color: var(--c-surface)","color: var(--c-text)","border: 1px solid var(--c-border)","border-radius: var(--border-radius-sm)","font-family: var(--main-font)","font-weight: 400","font-size: 14px","text-align: center","outline: none","padding: 0","box-sizing: border-box","user-select: text"].join(";")):this.element.style.cssText=[`width:${o}px`,`height:${A}px`,`background-color:${this.colors.fill}`,`color:${this.colors.dark}`,"font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif","font-weight:500",`font-size:${this._minDimension/2}px`,"border: none","outline: none",`padding:${this._minDimension/4}px ${this._minDimension/4}px`,"box-sizing:border-box","user-select:text"].join(";"),c5(this.element,d=>/^-?\d*\.?\d*$/.test(d)),this.actual=0,this.hasMoved=!1,this.clicked=!1,this.element.value=U0(this._value.value,this.decimalPlaces),this._bind()}on(t,e){return this._em.on(t,e),()=>this._em.off(t,e)}emit(t,e){this._em.emit(t,e)}get value(){return this._value.value}set value(t){this._value.update(t),this.emit("change",this._value.value),this._render()}get min(){return this._value.min}set min(t){this._value.min=t,this._render()}get max(){return this._value.max}set max(t){this._value.max=t,this._render()}get step(){return this._value.step}set step(t){this._value.step=t,this._render()}passiveUpdate(t){this._value.update(t),this._render()}link(t){this.min=t.min,this.max=t.max,this.step=t.step,typeof t.on=="function"&&t.on("change",e=>this.passiveUpdate(e)),this.on("change",e=>{"value"in t&&(t.value=e)}),this.value=t.value}_bind(){this.element.addEventListener("blur",()=>{this.settings.useAppStyling?(this.element.style.backgroundColor="var(--c-surface)",this.element.style.color="var(--c-text)"):(this.element.style.backgroundColor=this.colors.fill,this.element.style.color=this.colors.dark);const t=parseFloat(this.element.value);!Number.isNaN(t)&&t!==this.value?this.value=t:this._render()}),this.element.addEventListener("keydown",t=>{if(t.key==="Enter"){this.element.blur();const e=parseFloat(this.element.value);Number.isNaN(e)||(this.value=e)}},!0),this.element.addEventListener("mousedown",t=>this._onMouseDown(t)),this.element.addEventListener("dragstart",t=>t.preventDefault())}_onMouseDown(t){this.hasMoved=!1,this.clicked=!0,this.element.readOnly=!0,this.actual=this.value,this._start={y:t.clientY};const e=this.element.getBoundingClientRect(),s=(t.clientX-e.left)/e.width;this._changeFactor=l5(s);const i=o=>this._onMouseMove(o),r=()=>this._onMouseUp(i,r);window.addEventListener("mousemove",i),window.addEventListener("mouseup",r)}_onMouseMove(t){if(!this.clicked)return;this.hasMoved=!0;const e=t.clientY-this._start.y,i=Up(this.max-this.min,0,1e3)/200*Math.pow(this._changeFactor,2),r=this.actual-e*i;this._value.update(r),this._render(),this._value.changed&&this.emit("change",this._value.value)}_onMouseUp(t,e){this.clicked=!1,window.removeEventListener("mousemove",t),window.removeEventListener("mouseup",e),this.hasMoved?document.body.focus():(this.element.readOnly=!1,this.element.focus(),this.element.setSelectionRange(0,this.element.value.length),this.settings.useAppStyling?(this.element.style.backgroundColor="var(--c-accent)",this.element.style.color="var(--c-surface)"):(this.element.style.backgroundColor=this.colors.accent,this.element.style.color=this.colors.light))}_render(){this.element.value=U0(this._value.value,this.decimalPlaces)}}class A5{constructor(t,e,s,i){I(this,"min");I(this,"max");I(this,"step");I(this,"_value");I(this,"changed");this.min=Number(t),this.max=Number(e),this.step=Number(s)||1,this._value=0,this.changed=!1,this.update(i)}get value(){return this._value}update(t){const e=Up(Number(t),this.min,this.max),s=this._stepTo(e),i=this._value;this._value=s,this.changed=s!==i}_stepTo(t){if(!isFinite(this.step)||this.step<=0)return t;const e=Math.round((t-this.min)/this.step);return this.min+e*this.step}}class a5{constructor(){I(this,"_m");this._m=new Map}on(t,e){const s=this._m.get(t)||[];s.push(e),this._m.set(t,s)}off(t,e){const s=this._m.get(t);if(!s)return;const i=s.indexOf(e);i>=0&&s.splice(i,1)}emit(t,e){const s=this._m.get(t);if(s)for(const i of s.slice())i(e)}}function Up(n,t,e){return Math.max(t,Math.min(e,n))}function l5(n){return 1-Up(n,0,1)}function U0(n,t=2){return isFinite(n)?Number(n).toFixed(Math.max(0,t)).replace(/\.0+$/,"").replace(/(\.\d*?)0+$/,"$1"):""}function c5(n,t){let e=n.value;n.addEventListener("input",()=>{t(n.value)?e=n.value:n.value=e})}class u5{constructor(){I(this,"isActive",!1);I(this,"pulseIntervals",new Map);I(this,"tempoElements",new Map);I(this,"popDuration",{scaleUp:40,scaleDown:80});I(this,"popScale",1.4);I(this,"activeAnimations",new Map);this.initElements()}initElements(){[{type:"eighth",containerId:"eighth-note-tempo",bpmMultiplier:2},{type:"quarter",containerId:"quarter-note-tempo",bpmMultiplier:1},{type:"dottedQuarter",containerId:"dotted-quarter-tempo",bpmMultiplier:.666}].forEach(({type:e,containerId:s,bpmMultiplier:i})=>{const r=document.getElementById(s),o=r==null?void 0:r.parentElement,A=o==null?void 0:o.querySelector(".tempo-label-icon");r&&A?this.tempoElements.set(e,{container:r,icon:A,bpmMultiplier:i,originalTransform:r.style.transform||"",originalIconTransform:A.style.transform||""}):E.warn("TempoVisualizer",`Could not find elements for ${e} tempo`,{container:!!r,icon:!!A,tempoGroup:!!o},"toolbar")})}start(){this.isActive||(this.isActive=!0,this.tempoElements.size===0&&this.initElements(),this.tempoElements.forEach((t,e)=>{this.startPulseForType(e)}))}stop(){this.isActive&&(this.isActive=!1,this.pulseIntervals.forEach(t=>{clearInterval(t)}),this.pulseIntervals.clear(),this.activeAnimations.clear(),this.tempoElements.forEach(t=>{t.container.style.transform=t.originalTransform,t.icon.style.transform=t.originalIconTransform}))}startPulseForType(t){const e=this.tempoElements.get(t);if(!e)return;const r=60/(h.state.tempo*e.bpmMultiplier)*1e3;this.triggerPulse(t);const o=setInterval(()=>{this.isActive&&this.triggerPulse(t)},r);this.pulseIntervals.set(t,o)}triggerPulse(t){const s={startTime:performance.now(),phase:"scaleUp"};this.activeAnimations.set(t,s);const i=this.isActive;this.isActive=!0,this.activeAnimations.size===1&&this.animationLoop(),i||setTimeout(()=>{this.activeAnimations.size===0&&(this.isActive=!1)},this.popDuration.scaleUp+this.popDuration.scaleDown+50)}animationLoop(){if(this.activeAnimations.size===0||!this.isActive)return;const t=performance.now();this.activeAnimations.forEach((e,s)=>{const i=this.calculateScale(e,t);this.applyScale(s,i),i===1&&e.phase==="complete"&&this.activeAnimations.delete(s)}),this.activeAnimations.size>0&&requestAnimationFrame(()=>this.animationLoop())}calculateScale(t,e){const s=e-t.startTime;if(t.phase==="scaleUp"){if(s>=this.popDuration.scaleUp)return t.phase="scaleDown",t.startTime=e,this.popScale;{const i=Math.min(s/this.popDuration.scaleUp,1);return 1+(this.popScale-1)*i}}else if(t.phase==="scaleDown"){if(s>=this.popDuration.scaleDown)return t.phase="complete",1;{const i=Math.min(s/this.popDuration.scaleDown,1);return this.popScale-(this.popScale-1)*i}}return 1}applyScale(t,e){const s=this.tempoElements.get(t);if(!s)return;const i=`scale(${e})`;s.container.style.transform=s.originalTransform+" "+i,s.icon.style.transform=s.originalIconTransform+" "+i;const r=e<this.popScale?"transform 0.08s ease-out":"none";s.container.style.transition=r,s.icon.style.transition=r}updateTempo(){this.isActive&&(this.stop(),this.start())}}const Kr=new u5,_r=fo,ds={blend:2,cutoff:31,resonance:0,type:"lowpass"};function Qa(){return{coeffs:new Float32Array(_r).fill(0),phases:new Float32Array(_r).fill(0)}}function d5(){const n=Qa();return n.coeffs[0]=1,n}function h5(){const n=Qa();for(let t=1;t<=_r;t+=2){const e=t-1;n.coeffs[e]=1/t,n.phases[e]=0}return n}function f5(){const n=Qa();for(let t=1;t<=_r;t+=2){const e=t-1;n.coeffs[e]=1/(t*t),n.phases[e]=Math.PI/2}return n}function p5(){const n=Qa();for(let t=1;t<=_r;t++){const e=t-1;n.coeffs[e]=1/t,n.phases[e]=t&1?0:Math.PI}return n}const m5={strings:{amps:[.995,.94,.425,.48,0,.365,.04,.085,0,.09,0,0],phases:[0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,0]},piano:{amps:[1,.7,.6,.5,.4,.32,.25,.2,.17,.14,.12,.1],phases:Array(12).fill(0)},marimba:{amps:[1,.2,.15,.7,.05,.18,.03,.05,.02,.01,0,0],phases:Array(12).fill(0)},woodwind:{amps:[1,.05,.5,.05,.3,.05,.2,.05,.12,.05,.08,.05],phases:Array(12).fill(0)}};function Bl(n){const t=Qa(),e=m5[n];if(!e)return t;const s=Math.min(_r,e.amps.length);for(let i=0;i<s;i++)t.coeffs[i]=e.amps[i]||0,t.phases[i]=e.phases[i]||0;return t}const tA={attack:.1,decay:.2,sustain:.8,release:.3},g5={sine:{name:"sine",gain:1,adsr:tA,...d5(),filter:{...ds}},triangle:{name:"triangle",gain:.81,adsr:tA,...f5(),filter:{...ds}},square:{name:"square",gain:4/Math.PI,adsr:tA,...h5(),filter:{...ds}},sawtooth:{name:"sawtooth",gain:2/Math.PI,adsr:tA,...p5(),filter:{...ds}},trapezium:{name:"trapezium",gain:4/Math.PI,adsr:tA,coeffs:new Float32Array([.993,0,.314,0,.168,0,.101,0,.06,0,.033,0]),phases:new Float32Array(_r).fill(0),filter:{...ds}},impulse:{name:"impulse",gain:.18,adsr:{attack:.01,decay:.3,sustain:0,release:.2},coeffs:new Float32Array([1,.9,.8,.7,.6,.5,.4,.3,.2,.1,0,0]),phases:new Float32Array([0,Math.PI*1.5,Math.PI,Math.PI/2,0,Math.PI*1.5,Math.PI,Math.PI/2,0,Math.PI*1.5,Math.PI,0]),filter:{...ds}},strings:{name:"strings",gain:.49,adsr:{attack:.08,decay:.4,sustain:.7,release:.5},...Bl("strings"),filter:{...ds,cutoff:28}},piano:{name:"piano",gain:.8,adsr:{attack:.01,decay:1.5,sustain:0,release:.4},...Bl("piano"),filter:{...ds,cutoff:28}},marimba:{name:"marimba",gain:.9,adsr:{attack:.01,decay:.8,sustain:0,release:.4},...Bl("marimba"),filter:{...ds,cutoff:25}},woodwind:{name:"woodwind",gain:.6,adsr:{attack:.1,decay:.2,sustain:.8,release:.3},...Bl("woodwind"),filter:{...ds}}};function w5(n,t){as(t,!0);let e=null,s=null,i=null,r=null,o=null,A=Ot(!1);const a=(y,S=20)=>{const F=parseInt(y.slice(1,3),16),x=parseInt(y.slice(3,5),16),Q=parseInt(y.slice(5,7),16),T=Math.max(0,Math.floor(F*(1-S/100))),U=Math.max(0,Math.floor(x*(1-S/100))),P=Math.max(0,Math.floor(Q*(1-S/100)));return`#${T.toString(16).padStart(2,"0")}${U.toString(16).padStart(2,"0")}${P.toString(16).padStart(2,"0")}`},l=(y,S=50)=>{const F=parseInt(y.slice(1,3),16),x=parseInt(y.slice(3,5),16),Q=parseInt(y.slice(5,7),16),T=Math.min(255,Math.floor(F+(255-F)*(S/100))),U=Math.min(255,Math.floor(x+(255-x)*(S/100))),P=Math.min(255,Math.floor(Q+(255-Q)*(S/100)));return`#${T.toString(16).padStart(2,"0")}${U.toString(16).padStart(2,"0")}${P.toString(16).padStart(2,"0")}`};function c(y){const S=Math.round(y),F=e||document.getElementById("tempo-slider");F&&parseInt(F.value,10)!==S&&(F.value=`${S}`);const x=S*2,Q=Math.round(S/1.5);s&&s.value!==x&&s.passiveUpdate(x),i&&i.value!==S&&i.passiveUpdate(S),r&&r.value!==Q&&r.passiveUpdate(Q),h.state.tempo!==S&&(h.setTempo(S),Kr.updateTempo())}function u(y){if(!y)return;const S=y.closest(".tempo-slider-container");if(!S||S.querySelector(".tempo-slider-marks"))return;const F=[60,90,120,160,200],x=document.createElement("div");x.className="tempo-slider-marks",S.appendChild(x);const Q=Number(y.min)||0,T=Number(y.max)||1,U=Math.max(T-Q,1),P=[],K=()=>{const N=y.getBoundingClientRect().height||y.clientHeight,R=getComputedStyle(y),J=parseFloat(R.getPropertyValue("--slider-thumb-size"))||0,tt=parseFloat(R.getPropertyValue("--slider-thumb-border"))||0,rt=J+tt*2,lt=Math.max(N-rt,1),W=rt/2;P.forEach(({el:H,bpm:O})=>{if(O<Q||O>T){H.style.display="none";return}H.style.display="";const $=(O-Q)/U,L=W+lt*$;H.style.bottom=`${L}px`})};F.forEach(k=>{const N=document.createElement("span");N.className="tempo-slider-mark",N.setAttribute("aria-hidden","true"),x.appendChild(N),P.push({el:N,bpm:k})}),K(),new ResizeObserver(K).observe(y)}function d(y){if(!y||!o)return;const S=h.state.timbres[y],F=h.state.colorPalette[y]||{primary:y,light:y},x=F.light,Q=F.primary;document.querySelectorAll(".preset-button").forEach(U=>{const P=U,K=P.id.replace("preset-",""),M=(S==null?void 0:S.activePresetName)===K;P.classList.toggle("selected",M)});const T=l(x,60);o.style.setProperty("--c-accent",Q),o.style.setProperty("--c-accent-light",T),o.style.setProperty("--c-accent-hover",a(Q,20))}function p(){bt(A,!0),Kr.start()}function f(){bt(A,!0),Kr.start()}function m(y){const S=y.target,F=S?parseInt(S.value,10):NaN;c(F)}function g(){e==null||e.blur()}function w(){ut(A)&&(bt(A,!1),Kr.stop())}function B(){ut(A)&&(bt(A,!1),Kr.stop())}function b(){ut(A)&&(bt(A,!1),Kr.stop())}function _(y){var S;(S=y==null?void 0:y.newNote)!=null&&S.color?d(y.newNote.color):(document.querySelectorAll(".preset-button").forEach(F=>F.classList.remove("selected")),o&&(o.style.setProperty("--c-accent","#4A90E2"),o.style.setProperty("--c-accent-hover","#357ABD")))}function v(y){var S;y&&y===((S=h.state.selectedNote)==null?void 0:S.color)&&d(y)}function C(y){y!==void 0&&c(y)}Ls(()=>{var F;e=document.getElementById("tempo-slider"),o=document.querySelector(".preset-effects-container");const y={size:[45,24],step:1,decimalPlaces:0,useAppStyling:!0};s=new Sd("#eighth-note-tempo",{...y,value:180,min:60,max:480}),i=new Sd("#quarter-note-tempo",{...y,value:90,min:30,max:240}),r=new Sd("#dotted-quarter-tempo",{...y,value:60,min:20,max:160}),s.on("change",x=>{!isNaN(x)&&x>0&&c(x/2)}),i.on("change",x=>{!isNaN(x)&&x>0&&c(x)}),r.on("change",x=>{!isNaN(x)&&x>0&&c(x*1.5)}),c(h.state.tempo),e?(u(e),e.addEventListener("mousedown",p),e.addEventListener("touchstart",f),e.addEventListener("input",m),e.addEventListener("mouseup",g),c(h.state.tempo)):E.warn("AudioControlsBridge","Tempo slider not found - will initialize when rhythm tab is opened",null,"toolbar"),document.addEventListener("mouseup",w),document.addEventListener("touchend",B),document.addEventListener("touchcancel",b),document.querySelectorAll(".preset-button").forEach(x=>{const Q=x,T=Q.id.replace("preset-",""),U=g5[T];U&&Q.addEventListener("click",()=>{var K;const P=(K=h.state.selectedNote)==null?void 0:K.color;P&&(h.applyPreset(P,U),setTimeout(()=>d(P),10)),Q.blur()})}),h.on("noteChanged",_),h.on("timbreChanged",v),h.on("tempoChanged",C);const S=(F=h.state.selectedNote)==null?void 0:F.color;S&&d(S),console.log("[Svelte] AudioControlsBridge mounted")}),fi(()=>{e==null||e.removeEventListener("mousedown",p),e==null||e.removeEventListener("touchstart",f),e==null||e.removeEventListener("input",m),e==null||e.removeEventListener("mouseup",g),document.removeEventListener("mouseup",w),document.removeEventListener("touchend",B),document.removeEventListener("touchcancel",b),console.log("[Svelte] AudioControlsBridge unmounted")}),ls()}function v5(n,t){as(t,!0);const e="selectedTab",s="selectedPresetTab",i="timbre",r="presets";function o(W){try{localStorage.setItem(e,W),E.debug("TabManagement",`Saved tab to localStorage: ${W}`,void 0,"ui")}catch(H){E.warn("TabManagement","Failed to save tab to localStorage",H,"ui")}}function A(){try{return localStorage.getItem(e)||i}catch(W){return E.warn("TabManagement","Failed to read tab from localStorage",W,"ui"),i}}function a(W){try{localStorage.setItem(s,W),E.debug("TabManagement",`Saved preset tab to localStorage: ${W}`,void 0,"ui")}catch(H){E.warn("TabManagement","Failed to save preset tab to localStorage",H,"ui")}}function l(){try{return localStorage.getItem(s)||r}catch(W){return E.warn("TabManagement","Failed to read preset tab from localStorage",W,"ui"),r}}let c=null,u=null,d=null;const p=new Map,f=new Map,m=new Map,g=[{label:"effectsPanelActive",selector:"#effects-panel.preset-tab-panel.active"},{label:"effectsPanel",selector:"#effects-panel"},{label:"effectsContentBox",selector:"#effects-panel .effects-content-box"},{label:"presetsPanelActive",selector:"#presets-panel.preset-tab-panel.active"},{label:"presetsPanel",selector:"#presets-panel"},{label:"presetContentBox",selector:"#presets-panel .preset-content-box"},{label:"presetEffectsContent",selector:".preset-effects-content"},{label:"presetEffectsControls",selector:".preset-effects-controls"},{label:"presetEffectsContainer",selector:".preset-effects-container"},{label:"presetEffectsTabs",selector:".preset-effects-tabs"}];let w=null,B=null;const b=new Map;let _=null,v="",C=!1,y=null;function S(W,H){if(!W)return{selector:H,missing:!0};const O=W,$=O.getBoundingClientRect(),L=window.getComputedStyle(O),at=O.parentElement,G=at==null?void 0:at.getBoundingClientRect(),X=at?window.getComputedStyle(at):null;return{selector:H,tag:O.tagName.toLowerCase(),id:O.id||null,className:O.className||null,rectWidth:Number($.width.toFixed(1)),rectHeight:Number($.height.toFixed(1)),offsetWidth:O.offsetWidth,clientWidth:O.clientWidth,scrollWidth:O.scrollWidth,computed:{display:L.display,position:L.position,width:L.width,minWidth:L.minWidth,maxWidth:L.maxWidth,flex:L.flex,flexGrow:L.flexGrow,flexShrink:L.flexShrink,flexBasis:L.flexBasis,alignSelf:L.alignSelf,alignItems:L.alignItems,justifyContent:L.justifyContent,justifySelf:L.justifySelf,gap:L.gap,boxSizing:L.boxSizing,paddingLeft:L.paddingLeft,paddingRight:L.paddingRight,borderLeftWidth:L.borderLeftWidth,borderRightWidth:L.borderRightWidth,overflowX:L.overflowX,overflowY:L.overflowY},parent:at?{tag:at.tagName.toLowerCase(),id:at.id||null,className:at.className||null,rectWidth:Number(((G==null?void 0:G.width)||0).toFixed(1)),computedWidth:X==null?void 0:X.width,display:X==null?void 0:X.display,flex:X==null?void 0:X.flex}:null}}function F(W){const H=Array.from(document.querySelectorAll(W));return{selector:W,count:H.length,entries:H.map((O,$)=>({index:$,...S(O,W)}))}}function x(W,H,O=4){if(!W)return{selector:H,missing:!0,chain:[]};const $=[];let L=W,at=0;for(;L&&at<O;){const G=L.getBoundingClientRect(),X=window.getComputedStyle(L);$.push({tag:L.tagName.toLowerCase(),id:L.id||null,className:L.className||null,rectWidth:Number(G.width.toFixed(1)),offsetWidth:L.offsetWidth,clientWidth:L.clientWidth,computed:{display:X.display,width:X.width,minWidth:X.minWidth,maxWidth:X.maxWidth,flex:X.flex,flexGrow:X.flexGrow,flexShrink:X.flexShrink,flexBasis:X.flexBasis,alignItems:X.alignItems,justifyContent:X.justifyContent,alignSelf:X.alignSelf,boxSizing:X.boxSizing,paddingLeft:X.paddingLeft,paddingRight:X.paddingRight,gap:X.gap}}),L=L.parentElement,at+=1}return{selector:H,missing:!1,chain:$}}function Q(W){const H=Object.keys(W.elements).sort(),O={activePresetTab:W.activePresetTab,activePresetPanelId:W.activePresetPanelId};return H.forEach($=>{const L=W.elements[$];if(!L||L.missing){O[$]="missing";return}O[$]={rectWidth:L.rectWidth,rectHeight:L.rectHeight,offsetWidth:L.offsetWidth,clientWidth:L.clientWidth,scrollWidth:L.scrollWidth}}),JSON.stringify(O)}function T(W,H,O,$){if(H.missing||$.missing)return{pair:`${W} vs ${O}`,missing:!0};const L=["rectWidth","offsetWidth","clientWidth","scrollWidth"],at=["display","position","width","minWidth","maxWidth","flex","alignSelf","boxSizing","paddingLeft","paddingRight","borderLeftWidth","borderRightWidth","overflowX","overflowY"],G=["computedWidth","display","flex"],X=[];return L.forEach(V=>{const Y=H[V],nt=$[V];Y!==nt&&X.push({property:V,[W]:Y,[O]:nt})}),at.forEach(V=>{var D,q;const Y=(D=H.computed)==null?void 0:D[V],nt=(q=$.computed)==null?void 0:q[V];Y!==nt&&X.push({property:`computed.${V}`,[W]:Y,[O]:nt})}),G.forEach(V=>{var D,q;const Y=(D=H.parent)==null?void 0:D[V],nt=(q=$.parent)==null?void 0:q[V];Y!==nt&&X.push({property:`parent.${V}`,[W]:Y,[O]:nt})}),{pair:`${W} vs ${O}`,missing:!1,differences:X}}function U(W){C&&(v=v?`${v}; ${W}`:W,_===null&&(_=requestAnimationFrame(()=>{const H=v||"auto";_=null,v="",k(H)})))}function P(){w&&g.forEach(W=>{document.querySelectorAll(W.selector).forEach(H=>{b.has(H)||(b.set(H,W.label),w.observe(H))})})}function K(){w||(C=!0,y=null,w=new ResizeObserver(W=>{const H=W.map(O=>b.get(O.target)||O.target.id||O.target.tagName.toLowerCase()).filter(Boolean);H.length&&U(`Resize: ${H.join(", ")}`)}),B=new MutationObserver(()=>P()),document.body?B.observe(document.body,{childList:!0,subtree:!0}):document.addEventListener("DOMContentLoaded",()=>{B==null||B.observe(document.body,{childList:!0,subtree:!0}),P(),U("init")},{once:!0}),window.addEventListener("resize",()=>U("window resize")),P(),U("init"))}function M(){C=!1,y=null,w&&(w.disconnect(),w=null),B&&(B.disconnect(),B=null),b.clear(),_!==null&&(cancelAnimationFrame(_),_=null),v=""}function k(W){requestAnimationFrame(()=>{var st;const H=document.querySelector(".preset-tab-button.active"),O=document.querySelector(".preset-tab-panel.active"),$=S(document.querySelector("#effects-panel.preset-tab-panel.active"),"#effects-panel.preset-tab-panel.active"),L=S(document.getElementById("effects-panel"),"#effects-panel"),at=S(document.querySelector("#effects-panel .effects-content-box"),"#effects-panel .effects-content-box"),G=S(document.querySelector("#presets-panel.preset-tab-panel.active"),"#presets-panel.preset-tab-panel.active"),X=S(document.getElementById("presets-panel"),"#presets-panel"),V=S(document.querySelector("#presets-panel .preset-content-box"),"#presets-panel .preset-content-box"),Y=S(document.querySelector(".preset-effects-content"),".preset-effects-content"),nt=S(document.querySelector(".preset-effects-controls"),".preset-effects-controls"),D=S(document.querySelector(".preset-effects-container"),".preset-effects-container"),q=S(document.querySelector(".preset-effects-tabs"),".preset-effects-tabs"),z={reason:W,activePresetTab:((st=H==null?void 0:H.dataset)==null?void 0:st.presetTab)||null,activePresetPanelId:(O==null?void 0:O.id)||null,elements:{effectsPanelActive:$,effectsPanel:L,effectsContentBox:at,presetsPanelActive:G,presetsPanel:X,presetContentBox:V,presetEffectsContent:Y,presetEffectsControls:nt,presetEffectsContainer:D,presetEffectsTabs:q},comparisons:{activePanelVsEffectsContent:T("effectsPanelActive",$.missing?L:$,"effectsContentBox",at),panelVsEffectsContent:T("effectsPanel",L,"effectsContentBox",at),contentBoxes:T("effectsContentBox",at,"presetContentBox",V),panels:T("effectsPanel",L,"presetsPanel",X),tabsVsEffectsContent:T("presetEffectsTabs",q,"effectsContentBox",at)},chains:{effectsPanelActive:x(document.querySelector("#effects-panel.preset-tab-panel.active"),"#effects-panel.preset-tab-panel.active"),effectsContentBox:x(document.querySelector("#effects-panel .effects-content-box"),"#effects-panel .effects-content-box"),presetEffectsContent:x(document.querySelector(".preset-effects-content"),".preset-effects-content")},lists:{presetTabButtons:F(".preset-effects-tabs .preset-tab-button")}},et=Q(z);(W.startsWith("Resize")||W==="auto"||W==="init"||W==="window resize")&&et===y||(y=et,console.groupCollapsed(`[Sizing] Preset/Effects widths (${W})`),console.log(z),console.groupEnd())})}function N(W){window.enablePresetEffectsSizingDiagnostics&&k(W)}function R(){const W=A();document.querySelectorAll(".tab-button").forEach($=>$.classList.remove("active")),document.querySelectorAll(".tab-panel").forEach($=>$.classList.remove("active"));const H=document.querySelector(`[data-tab="${W}"]`),O=document.getElementById(`${W}-panel`);H&&O?(H.classList.add("active"),O.classList.add("active"),W==="rhythm"&&setTimeout(()=>{const $=window.initTempoSliderIfNeeded;typeof $=="function"&&$()},200)):E.warn("TabManagement",`Could not restore tab: ${W}. Tab button or panel not found.`)}function J(){const W=l();document.querySelectorAll(".preset-tab-button:not([disabled])").forEach($=>$.classList.remove("active")),document.querySelectorAll(".preset-tab-panel").forEach($=>$.classList.remove("active"));const H=document.querySelector(`[data-preset-tab="${W}"]`),O=document.getElementById(`${W}-panel`);if(H&&O&&!H.hasAttribute("disabled")){H.classList.add("active"),O.classList.add("active");const $=document.querySelector(".harmonic-bins-container");$&&(W==="effects"?$.style.display="none":$.style.display="flex")}else E.warn("TabManagement",`Could not restore preset tab: ${W}. Tab button or panel not found.`);N("restore preset tab")}function tt(){R(),c=document.querySelectorAll(".tab-button"),c.forEach(W=>{const H=()=>{const O=W.dataset.tab;if(!O)return;document.querySelectorAll(".tab-button").forEach(L=>L.classList.remove("active")),W.classList.add("active"),document.querySelectorAll(".tab-panel").forEach(L=>L.classList.remove("active"));const $=document.getElementById(`${O}-panel`);$&&$.classList.add("active"),o(O),O==="rhythm"&&setTimeout(()=>{const L=window.initTempoSliderIfNeeded;typeof L=="function"&&L()},50)};W.addEventListener("click",H),p.set(W,H)}),E.info("TabManagementBridge","Main tabs initialized",null,"ui")}function rt(){J(),u=document.querySelectorAll(".preset-tab-button"),u.forEach(W=>{const H=()=>{const O=W.dataset.presetTab;if(!O)return;document.querySelectorAll(".preset-tab-button:not([disabled])").forEach(at=>at.classList.remove("active")),W.classList.add("active"),document.querySelectorAll(".preset-tab-panel").forEach(at=>at.classList.remove("active"));const $=document.getElementById(`${O}-panel`);$&&$.classList.add("active"),a(O);const L=document.querySelector(".harmonic-bins-container");L&&(O==="effects"?L.style.display="none":L.style.display="flex"),N(`preset tab click: ${O}`)};W.addEventListener("click",H),f.set(W,H)}),E.info("TabManagementBridge","Preset tabs initialized",null,"ui")}function lt(){d=document.querySelectorAll(".pitch-tab-button"),d.forEach(W=>{const H=()=>{const O=W.dataset.pitchTab;if(!O)return;document.querySelectorAll(".pitch-tab-button").forEach(L=>L.classList.remove("active")),W.classList.add("active"),document.querySelectorAll(".pitch-tab-panel").forEach(L=>L.classList.remove("active"));const $=document.getElementById(`${O}-panel`);$&&$.classList.add("active")};W.addEventListener("click",H),m.set(W,H)}),E.info("TabManagementBridge","Pitch tabs initialized",null,"ui")}Ls(()=>{tt(),rt(),lt(),window.logPresetEffectsSizing=(W="manual")=>{k(W)},window.enablePresetEffectsSizingAutoLog=()=>{window.enablePresetEffectsSizingDiagnostics=!0,K()},window.disablePresetEffectsSizingAutoLog=()=>{window.enablePresetEffectsSizingDiagnostics=!1,M()},window.enablePresetEffectsSizingDiagnostics&&K(),console.log("[Svelte] TabManagementBridge mounted")}),fi(()=>{p.forEach((W,H)=>{H.removeEventListener("click",W)}),p.clear(),f.forEach((W,H)=>{H.removeEventListener("click",W)}),f.clear(),m.forEach((W,H)=>{H.removeEventListener("click",W)}),m.clear(),console.log("[Svelte] TabManagementBridge unmounted")}),ls()}function B5(n,t){as(t,!0);const e=16,s={letter:{width:8.5,height:11},"11x14":{width:11,height:14},"11x17":{width:11,height:17}};let i=null,r=null,o=null,A=null,a=null,l=null,c=null,u=null,d=null,p=null,f=null,m=null,g=null,w=Ot(!1),B=Ot(null);const b=20,_=5;let v=null,C=null;function y(){h.state.isPrintPreviewActive||h.setPrintPreviewActive(!0),i==null||i.classList.remove("hidden");const V=Z=>Z?getComputedStyle(Z).display!=="none":!1,Y=h.state.printOptions.pageSize,nt=Y&&Y in s?Y:"letter",D=V(document.getElementById("button-grid")),q=V(document.getElementById("drum-grid-wrapper")),z=V(document.getElementById("legend-left-canvas")),et=V(document.getElementById("legend-right-canvas"));h.setPrintOptions({pageSize:nt,cropTop:0,cropBottom:1,cropLeft:0,cropRight:1,includeButtonGrid:D,includeDrums:q,includeLeftLegend:z,includeRightLegend:et}),D&&Nl.prefetchButtonGridSnapshot(z,et),Q()}function S(){h.state.isPrintPreviewActive&&h.setPrintPreviewActive(!1),i==null||i.classList.add("hidden")}function F(V,Y){const D=h.state.printOptions[V]===Y[0]?Y[1]:Y[0];h.setPrintOptions({[V]:D})}function x(){if([u,d,p,f,m,g].some(pt=>pt===null))return;const Y=h.state.printOptions.pageSize,nt=Y&&Y in s?Y:"letter",{orientation:D,colorMode:q,includeButtonGrid:z,includeDrums:et,includeLeftLegend:Z,includeRightLegend:st}=h.state.printOptions;c&&(c.value=nt),u&&(u.textContent=D.charAt(0).toUpperCase()+D.slice(1)),d&&(d.textContent=q==="color"?"Color":"B&W",d.classList.toggle("active",q==="color")),p&&(p.textContent=z?"Include":"Exclude",p.classList.toggle("active",z)),f&&(f.textContent=et?"Include":"Exclude",f.classList.toggle("active",et)),m&&(m.textContent=Z?"Include":"Exclude",m.classList.toggle("active",Z)),g&&(g.textContent=st?"Include":"Exclude",g.classList.toggle("active",st))}async function Q(){if(!h.state.isPrintPreviewActive||!r||!o)return;x();const V=(l==null?void 0:l.clientWidth)??0,Y=(l==null?void 0:l.clientHeight)??0;if(V===0||Y===0)return;const{orientation:nt}=h.state.printOptions,D=h.state.printOptions.pageSize,q=D&&D in s?D:"letter",z=s[q],et=nt==="landscape"?z.height:z.width,Z=nt==="landscape"?z.width:z.height,st=.25,pt=et/Z,St=e*2;let Mt=Math.max(V-St,100),Et=Math.max(Y-St,100);Mt/Et>pt?Mt=Et*pt:Et=Mt/pt;const _t=st/et*Mt,Jt=Mt-2*_t,ct=Et-2*_t,Ct={...h.state.printOptions,cropTop:0,cropBottom:1,cropLeft:0,cropRight:1},vt=await Nl.generateScoreCanvas(Ct,{width:Jt,height:ct});if(!vt)return;r.width=Mt,r.height=Et,o.fillStyle="#FFFFFF",o.fillRect(0,0,Mt,Et),o.strokeStyle="#E0E0E0",o.lineWidth=1,o.strokeRect(_t,_t,Jt,ct);const qt=_t+Math.max(0,(Jt-vt.width)/2),Ge=_t+Math.max(0,(ct-vt.height)/2);o.drawImage(vt,qt,Ge),T(_t,Jt,ct),U(Mt,Et,{contentTop:Ge,contentLeft:qt,contentWidth:vt.width,contentHeight:vt.height})}function T(V,Y,nt){if(!o)return;o.strokeStyle="#CCCCCC",o.lineWidth=1;const D=10,q=V+Y,z=V+nt;o.beginPath(),o.moveTo(V,V-D),o.lineTo(V,V+D),o.moveTo(V-D,V),o.lineTo(V+D,V),o.moveTo(q,V-D),o.lineTo(q,V+D),o.moveTo(q-D,V),o.lineTo(q+D,V),o.moveTo(V,z-D),o.lineTo(V,z+D),o.moveTo(V-D,z),o.lineTo(V+D,z),o.moveTo(q,z-D),o.lineTo(q,z+D),o.moveTo(q-D,z),o.lineTo(q+D,z),o.stroke()}function U(V,Y,nt){const D=r==null?void 0:r.getBoundingClientRect(),q=l==null?void 0:l.getBoundingClientRect();if(!D||!q||!A||!a)return;A.width=V,A.height=Y,A.style.left=`${D.left-q.left}px`,A.style.top=`${D.top-q.top}px`,A.style.width=`${V}px`,A.style.height=`${Y}px`;const{cropTop:z,cropBottom:et,cropLeft:Z,cropRight:st}=h.state.printOptions,{contentTop:pt,contentLeft:St,contentHeight:Mt,contentWidth:Et}=nt,_t=pt+z*Mt,Jt=pt+et*Mt,ct=St+Z*Et,Ct=St+st*Et,vt=pt+Mt,qt=St+Et;a.clearRect(0,0,V,Y),a.fillStyle="rgba(0, 0, 0, 0.5)",z>0&&a.fillRect(St,pt,Et,_t-pt),et<1&&a.fillRect(St,Jt,Et,vt-Jt),Z>0&&a.fillRect(St,_t,ct-St,Jt-_t),st<1&&a.fillRect(Ct,_t,qt-Ct,Jt-_t),P(_t,St,qt,"top"),P(Jt,St,qt,"bottom"),K(ct,pt,vt,"left"),K(Ct,pt,vt,"right"),v={pageWidth:V,pageHeight:Y,contentTop:pt,contentLeft:St,contentHeight:Mt,contentWidth:Et,cropTopY:_t,cropBottomY:Jt,cropLeftX:ct,cropRightX:Ct}}function P(V,Y,nt,D){if(!a)return;const q=60,z=nt-Y,et=Y+(z-q)/2,Z=D==="top"?V-b-4:V+4;a.fillStyle="#4a90e2",a.fillRect(Y,V-1,z,2),a.fillRect(et,Z,q,b),a.strokeStyle="#FFFFFF",a.lineWidth=2,a.strokeRect(et,Z,q,b),a.strokeStyle="#FFFFFF",a.lineWidth=1;const st=3,pt=6,St=30,Mt=Y+(z-St)/2;for(let Et=0;Et<st;Et++){const _t=Z+b/2+(Et-1)*pt;a.beginPath(),a.moveTo(Mt,_t),a.lineTo(Mt+St,_t),a.stroke()}}function K(V,Y,nt,D){if(!a)return;const q=60,z=nt-Y,et=Y+(z-q)/2,Z=D==="left"?V-b-4:V+4;a.fillStyle="#4a90e2",a.fillRect(V-1,Y,2,z),a.fillRect(Z,et,b,q),a.strokeStyle="#FFFFFF",a.lineWidth=2,a.strokeRect(Z,et,b,q),a.strokeStyle="#FFFFFF",a.lineWidth=1;const st=3,pt=6,St=30,Mt=Y+(z-St)/2;for(let Et=0;Et<st;Et++){const _t=Z+b/2+(Et-1)*pt;a.beginPath(),a.moveTo(_t,Mt),a.lineTo(_t,Mt+St),a.stroke()}}function M(V){if(!v||!A)return;const Y=A.getBoundingClientRect(),nt=V.clientX-Y.left,D=V.clientY-Y.top,q=nt>=v.contentLeft&&nt<=v.contentLeft+v.contentWidth,z=D>=v.contentTop&&D<=v.contentTop+v.contentHeight,et=q&&Math.abs(D-v.cropTopY)<b+_,Z=q&&Math.abs(D-v.cropBottomY)<b+_,st=z&&Math.abs(nt-v.cropLeftX)<b+_,pt=z&&Math.abs(nt-v.cropRightX)<b+_;et?(bt(w,!0),bt(B,"top"),A.style.cursor="ns-resize"):Z?(bt(w,!0),bt(B,"bottom"),A.style.cursor="ns-resize"):st?(bt(w,!0),bt(B,"left"),A.style.cursor="ew-resize"):pt&&(bt(w,!0),bt(B,"right"),A.style.cursor="ew-resize")}function k(V){if(!v||!A)return;const Y=A.getBoundingClientRect(),nt=V.clientX-Y.left,D=V.clientY-Y.top;if(ut(w)&&ut(B)){N(nt,D);return}const q=nt>=v.contentLeft&&nt<=v.contentLeft+v.contentWidth,z=D>=v.contentTop&&D<=v.contentTop+v.contentHeight,et=q&&Math.abs(D-v.cropTopY)<b+_,Z=q&&Math.abs(D-v.cropBottomY)<b+_,st=z&&Math.abs(nt-v.cropLeftX)<b+_,pt=z&&Math.abs(nt-v.cropRightX)<b+_;et||Z?A.style.cursor="ns-resize":st||pt?A.style.cursor="ew-resize":A.style.cursor="default"}function N(V,Y){if(!v)return;const{contentTop:nt,contentLeft:D,contentHeight:q,contentWidth:z}=v,et=.05;if(ut(B)==="top"){const Z=Math.max(0,Math.min(1,(Y-nt)/q)),st=h.state.printOptions.cropBottom;Z<st-et&&h.setPrintOptions({cropTop:Z})}else if(ut(B)==="bottom"){const Z=Math.max(0,Math.min(1,(Y-nt)/q)),st=h.state.printOptions.cropTop;Z>st+et&&h.setPrintOptions({cropBottom:Z})}else if(ut(B)==="left"){const Z=Math.max(0,Math.min(1,(V-D)/z)),st=h.state.printOptions.cropRight;Z<st-et&&h.setPrintOptions({cropLeft:Z})}else if(ut(B)==="right"){const Z=Math.max(0,Math.min(1,(V-D)/z)),st=h.state.printOptions.cropLeft;Z>st+et&&h.setPrintOptions({cropRight:Z})}}function R(){bt(w,!1),bt(B,null),A&&(A.style.cursor="default")}function J(){S()}function tt(){Nl.generateAndPrint(),S()}function rt(){F("orientation",["landscape","portrait"])}function lt(){F("colorMode",["color","bw"])}function W(){F("includeButtonGrid",[!0,!1])}function H(){F("includeDrums",[!0,!1])}function O(){F("includeLeftLegend",[!0,!1])}function $(){F("includeRightLegend",[!0,!1])}function L(){if(!c)return;const V=c.value;V in s&&h.setPrintOptions({pageSize:V})}function at(V){V!==void 0&&(V?y():S())}function G(){Q()}function X(){h.state.isPrintPreviewActive&&Q()}Ls(()=>{var V,Y;i=document.getElementById("print-preview-overlay"),r=document.getElementById("print-preview-canvas"),o=(r==null?void 0:r.getContext("2d"))??null,A=document.getElementById("print-crop-overlay"),a=(A==null?void 0:A.getContext("2d"))??null,l=(r==null?void 0:r.parentElement)??null,c=document.getElementById("print-page-size"),u=document.getElementById("print-orientation-toggle"),d=document.getElementById("print-color-mode-toggle"),p=document.getElementById("print-button-grid-toggle"),f=document.getElementById("print-drum-grid-toggle"),m=document.getElementById("print-left-legend-toggle"),g=document.getElementById("print-right-legend-toggle"),(V=document.getElementById("print-close-button"))==null||V.addEventListener("click",J),(Y=document.getElementById("print-confirm-button"))==null||Y.addEventListener("click",tt),u==null||u.addEventListener("click",rt),d==null||d.addEventListener("click",lt),p==null||p.addEventListener("click",W),f==null||f.addEventListener("click",H),m==null||m.addEventListener("click",O),g==null||g.addEventListener("click",$),c==null||c.addEventListener("change",L),A==null||A.addEventListener("mousedown",M),A==null||A.addEventListener("mousemove",k),A==null||A.addEventListener("mouseup",R),A==null||A.addEventListener("mouseleave",R),h.on("printPreviewStateChanged",at),h.on("printOptionsChanged",G),h.on("notesChanged",X),l&&(C=new ResizeObserver(()=>{h.state.isPrintPreviewActive&&Q()}),C.observe(l)),console.log("[Svelte] PrintPreviewBridge mounted")}),fi(()=>{var V,Y;(V=document.getElementById("print-close-button"))==null||V.removeEventListener("click",J),(Y=document.getElementById("print-confirm-button"))==null||Y.removeEventListener("click",tt),u==null||u.removeEventListener("click",rt),d==null||d.removeEventListener("click",lt),p==null||p.removeEventListener("click",W),f==null||f.removeEventListener("click",H),m==null||m.removeEventListener("click",O),g==null||g.removeEventListener("click",$),c==null||c.removeEventListener("change",L),A==null||A.removeEventListener("mousedown",M),A==null||A.removeEventListener("mousemove",k),A==null||A.removeEventListener("mouseup",R),A==null||A.removeEventListener("mouseleave",R),C==null||C.disconnect(),console.log("[Svelte] PrintPreviewBridge unmounted")}),ls()}const C5={"playback-controls":EL,"playback-controls-bridge":xL,"file-actions-bridge":_L,"grid-controls-bridge":IL,"modulation-bridge":FL,"sidebar-bridge":ZL,"tool-selector-bridge":o5,"audio-controls-bridge":w5,"tab-management-bridge":v5,"print-preview-bridge":B5},zh=[];function b5(){document.querySelectorAll("[data-svelte-component]").forEach(t=>{const e=t.getAttribute("data-svelte-component");if(!e)return;const s=C5[e];if(!s){console.warn(`[Svelte] Unknown component: ${e}`);return}try{t.innerHTML="";const i=cL(s,{target:t});zh.push({target:t,component:i}),console.log(`[Svelte] Mounted: ${e}`)}catch(i){console.error(`[Svelte] Failed to mount ${e}:`,i)}})}function y5(){zh.forEach(({component:n})=>{try{dL(n)}catch(t){console.error("[Svelte] Failed to unmount component:",t)}}),zh.length=0}function S5(){oD.init(),b5(),E.initSuccess("UiComponents")}function xu(n,t){if(!(typeof window>"u"||!window.__adsrFlowDebug)){if(t===void 0){console.log("[ADSR Flow]",n);return}console.log("[ADSR Flow]",n,t)}}const zn={container:null,parentContainer:null,sustainTrack:null,sustainThumb:null,multiSliderContainer:null,thumbA:null,thumbD:null,thumbR:null};function E5(){var n;return zn.container=document.querySelector("#adsr-envelope"),zn.parentContainer=((n=zn.container)==null?void 0:n.closest(".adsr-container"))||null,zn.sustainTrack=document.getElementById("sustain-slider-track"),zn.sustainThumb=document.getElementById("sustain-slider-thumb"),zn.multiSliderContainer=document.getElementById("multi-thumb-slider-container"),zn.thumbA=document.getElementById("thumb-a"),zn.thumbD=document.getElementById("thumb-d"),zn.thumbR=document.getElementById("thumb-r"),zn}const x5={init:E5,get elements(){return zn}};function ub(){return hb*h.state.adsrTimeAxisScale}function db(n,t){const e=h.state.timbres[t.currentColor];if(!e)return;const{sustain:s}=e.adsr,i=.01;n.d=Math.max(n.a+i,n.d),n.r=Math.max(n.d+i,n.r);const r=n.a,o=n.d-n.a,A=n.r-n.d;if(isNaN(r)||isNaN(o)||isNaN(A)){E.error("AdsrInteractions","NaN value detected before setting ADSR. Aborting update.",{newAttack:r,newDecay:o,newRelease:A},"audio");return}const a={attack:r,decay:o,release:A,sustain:s};h.setADSR(t.currentColor,a),xu("adsrInteractions:updateADSRFromAbsoluteTimes",{color:t.currentColor,adsr:a})}function _5(n,t){var o;let e=!1;const s=A=>{var m;if(!e||!n.sustainTrack)return;const a=n.sustainTrack.getBoundingClientRect();let c=100-(A.clientY-a.top)/a.height*100;c=Math.max(0,Math.min(100,c));const d=(((m=window.waveformVisualizer)==null?void 0:m.getNormalizedAmplitude())||1)*100;c=Math.min(c,d);const p=h.state.timbres[t.currentColor];if(!p)return;const f={...p.adsr,sustain:c/100};h.setADSR(t.currentColor,f),xu("adsrInteractions:sustainSlider",{color:t.currentColor,adsr:f})},i=A=>{e=!0,s(A)},r=()=>{e=!1};(o=n.sustainTrack)==null||o.addEventListener("pointerdown",i),document.addEventListener("pointermove",s),document.addEventListener("pointerup",r)}function I5(n,t){var o;let e=null;const s=A=>{if(!e||!n.multiSliderContainer)return;const a=n.multiSliderContainer.getBoundingClientRect();let c=(A.clientX-a.left)/a.width*100;c=Math.max(0,Math.min(100,c));const u=c/100*ub(),d=h.state.timbres[t.currentColor];if(!d)return;const{attack:p,decay:f,release:m}=d.adsr,g={a:p,d:p+f,r:p+f+m};e.id==="thumb-a"&&(g.a=u),e.id==="thumb-d"&&(g.d=u),e.id==="thumb-r"&&(g.r=u),db(g,t)},i=A=>{const a=A.target;a.classList.contains("time-slider-thumb")&&(e=a,s(A))},r=()=>{e=null};(o=n.multiSliderContainer)==null||o.addEventListener("pointerdown",i),document.addEventListener("pointermove",s),document.addEventListener("pointerup",r)}function F5(n,t){let e=null;const s=o=>{var C;if(!e)return;const A=t.svgContainer,a=A.createSVGPoint();a.x=o.clientX,a.y=o.clientY;const l=A.getScreenCTM();if(!l)return;const c=a.matrixTransform(l.inverse());let u=c.x/t.width*100,d=1-c.y/t.height;u=Math.max(0,Math.min(100,u)),d=Math.max(0,Math.min(1,d));const p=u/100*ub(),f=h.state.timbres[t.currentColor];if(!f)return;const{attack:m,decay:g,release:w}=f.adsr;let B=f.adsr.sustain;const b={a:m,d:m+g,r:m+g+w};switch(e.id){case"attack-node":b.a=p;break;case"decay-sustain-node":{b.d=p;const y=((C=window.waveformVisualizer)==null?void 0:C.getNormalizedAmplitude())||1;B=Math.min(d,y);break}case"release-node":b.r=p;break}const _=h.state.timbres[t.currentColor];if(!_)return;const v=_.adsr.sustain;if(B!==v){const y={attack:m,decay:g,release:w,sustain:B};h.setADSR(t.currentColor,y),xu("adsrInteractions:nodeDragSustain",{color:t.currentColor,adsr:y})}db(b,t)},i=o=>{const A=o.target;A.classList.contains("adsr-node")&&(e=A,e.style.cursor="grabbing",s(o))},r=()=>{e&&(e.style.cursor="grab",e=null)};t.nodeLayer.addEventListener("pointerdown",i),document.addEventListener("pointermove",s),document.addEventListener("pointerup",r)}function T5(n){const t=n.ui;_5(t,n),I5(t,n),F5(t,n)}function Q5(n,{width:t,height:e},s){for(;n.firstChild;)n.removeChild(n.firstChild);if(s>0){for(let A=1;A<=5;A++)if(A<=s){const a=A/s*t,l=document.createElementNS("http://www.w3.org/2000/svg","text");l.setAttribute("x",String(a)),l.setAttribute("y",String(e-5)),l.setAttribute("fill","#d0d0d0"),l.setAttribute("font-size","24"),l.setAttribute("font-weight","bold"),l.setAttribute("text-anchor","middle"),l.setAttribute("dominant-baseline","auto"),l.setAttribute("opacity","0.3"),l.textContent=`${A}s`,n.appendChild(l)}}const i=h.state.tempo;if(i<=0||s<=0)return;const r=30/i;let o=0;for(let A=r;A<s;A+=r){const a=A/s*t,l=document.createElementNS("http://www.w3.org/2000/svg","line");l.setAttribute("x1",String(a)),l.setAttribute("y1","0"),l.setAttribute("x2",String(a)),l.setAttribute("y2",String(e));const c=(o+1)%2===0;l.setAttribute("stroke",c?"#adb5bd":"#ced4da"),l.setAttribute("stroke-width",c?"1":"0.5"),l.setAttribute("stroke-dasharray","3,3"),n.appendChild(l),o++}}function M5(n,t,e,{height:s,width:i},r,o,A){for(;n.firstChild;)n.removeChild(n.firstChild);for(;t.firstChild;)t.removeChild(t.firstChild);if(e.length<4)return;const a=e[0],l=e[1],c=e[2],u=e[3];if(!a||!l||!c||!u)return;const d=h.state.colorPalette[r]||{primary:r,light:r},p=d.primary,f=d.light;let m={time:0,feedback:0};if(window.effectsCoordinator&&(m=window.effectsCoordinator.getEffectParameters(r,"delay")),A&&A.clearRect(0,0,i,s),(m.time||0)>0&&(m.feedback||0)>0&&o){const S=Math.max(.01,(m.time||0)/100*.5),F=Math.min(.95,(m.feedback||0)/100),x=.05;let Q=F,T=0;for(;Q>x&&T<10;){T++;const U=S*T/o*i,P=e.map(k=>({x:k.x+U,y:k.y})),K=P[0],M=P[3];if(!(!K||!M)){if(K.x<i){const k=document.createElementNS("http://www.w3.org/2000/svg","polygon"),N=`${K.x},${s} `+P.map(J=>`${J.x},${J.y}`).join(" ")+` ${Math.min(M.x,i)},${s}`;k.setAttribute("points",N),k.setAttribute("fill",bs(f,.7*Q)),k.setAttribute("class","delay-echo"),n.appendChild(k);const R=document.createElementNS("http://www.w3.org/2000/svg","polyline");R.setAttribute("points",P.map(J=>`${J.x},${J.y}`).join(" ")),R.setAttribute("stroke-width","2"),R.setAttribute("fill","none"),R.setAttribute("stroke",bs(p,Q)),R.setAttribute("class","delay-echo"),n.appendChild(R)}Q*=F}}}const g=document.createElementNS("http://www.w3.org/2000/svg","polygon"),w=`0,${s} `+e.map(S=>`${S.x},${S.y}`).join(" ")+` ${i},${s}`;g.setAttribute("points",w),g.setAttribute("fill",bs(f,.7)),n.appendChild(g);const B=document.createElementNS("http://www.w3.org/2000/svg","line");B.setAttribute("x1",String(a.x)),B.setAttribute("y1",String(a.y)),B.setAttribute("x2",String(l.x)),B.setAttribute("y2",String(l.y)),B.setAttribute("stroke",p),B.setAttribute("stroke-width","2"),n.appendChild(B);const b=document.createElementNS("http://www.w3.org/2000/svg","line");b.setAttribute("x1",String(l.x)),b.setAttribute("y1",String(l.y)),b.setAttribute("x2",String(c.x)),b.setAttribute("y2",String(c.y)),b.setAttribute("stroke",p),b.setAttribute("stroke-width","2"),n.appendChild(b);const _=1,v=document.createElementNS("http://www.w3.org/2000/svg","line");v.setAttribute("x1",String(c.x)),v.setAttribute("y1",String(c.y)),v.setAttribute("x2",String(u.x)),v.setAttribute("y2",String(u.y)),v.setAttribute("stroke",bs(p,_)),v.setAttribute("stroke-width","2"),n.appendChild(v);const C=["attack-node","decay-sustain-node","release-node"];[l,c,u].forEach((S,F)=>{const x=document.createElementNS("http://www.w3.org/2000/svg","circle");x.setAttribute("id",C[F]),x.setAttribute("class","adsr-node"),x.setAttribute("cx",String(S.x)),x.setAttribute("cy",String(S.y)),x.setAttribute("r","8"),x.setAttribute("fill",p),x.setAttribute("stroke",bu(p,-.3)),x.setAttribute("stroke-width","2"),x.style.cursor="grab";const Q=document.createElementNS("http://www.w3.org/2000/svg","title");x.appendChild(Q),t.appendChild(x)})}function U5(n,t){if(!n)return;const e=bu(t,-.2);n.style.setProperty("--c-accent",t),n.style.setProperty("--c-accent-hover",e)}const ue={};let Vn=null,Mr=!1;function P5(n,t){const e=document.createElementNS("http://www.w3.org/2000/svg","g");e.setAttribute("data-playhead-id",n);const s=document.createElementNS("http://www.w3.org/2000/svg","line");s.setAttribute("stroke",t),s.setAttribute("stroke-width","2"),s.setAttribute("stroke-dasharray","3,3"),e.appendChild(s);const i=document.createElementNS("http://www.w3.org/2000/svg","circle");return i.setAttribute("r","5"),i.setAttribute("fill",t),e.appendChild(i),e}function N5(n,t,e,s=null){if(!(!Vn||!s)){if(t==="attack"){ue[n]&&(ue[n].requestId!==null&&cancelAnimationFrame(ue[n].requestId),ue[n].group.remove());const i=P5(n,e);Vn.playheadLayer.appendChild(i),ue[n]={group:i,phase:t,color:e,adsr:s,requestId:null,startTimestamp:de(),elapsed:0},Pp(n)}else if(t==="release"){if(Mr)return;const i=ue[n];if(!i)return;i.requestId!==null&&cancelAnimationFrame(i.requestId),i.phase="release",i.adsr=s,i.startTimestamp=de(),i.elapsed=0,Dp(n)}}}function Pp(n){if(!ue[n]||Mr||!Vn)return;const t=ue[n];if(!t.adsr)return;const{attack:e,decay:s}=t.adsr,i=Vn.calculateEnvelopePoints(t.adsr);if(i.length<4)return;const r=i[0],o=i[1],A=i[2],a=de()-t.startTimestamp;t.elapsed=a;const l=e+s,c=Math.min(a,l);let u,d;if(c<=e){const m=e>0?c/e:1;u=r.x+m*(o.x-r.x),d=r.y+m*(o.y-r.y)}else{const m=c-e,g=s>0?m/s:1;u=o.x+g*(A.x-o.x),d=o.y+g*(A.y-o.y)}const[p,f]=t.group.children;p.setAttribute("x1",String(u)),p.setAttribute("y1","0"),p.setAttribute("x2",String(u)),p.setAttribute("y2",String(Vn.height)),f.setAttribute("cx",String(u)),f.setAttribute("cy",String(d)),c<l?t.requestId=requestAnimationFrame(()=>Pp(n)):(t.phase="sustain",Np(n))}function Np(n){if(!ue[n]||Mr||!Vn)return;const t=ue[n];if(!t.adsr)return;const e=Vn.calculateEnvelopePoints(t.adsr);if(e.length<4)return;const s=e[2],[i,r]=t.group.children;i.setAttribute("x1",String(s.x)),i.setAttribute("y1","0"),i.setAttribute("x2",String(s.x)),i.setAttribute("y2",String(Vn.height)),r.setAttribute("cx",String(s.x)),r.setAttribute("cy",String(s.y)),t.requestId=requestAnimationFrame(()=>Np(n))}function Dp(n){if(!ue[n]||Mr||!Vn)return;const t=ue[n];if(!t.adsr)return;const{release:e}=t.adsr,s=Vn.calculateEnvelopePoints(t.adsr);if(s.length<4)return;const i=s[2],r=s[3],o=de()-t.startTimestamp;t.elapsed=o;const A=Math.min(o,e),a=e>0?A/e:1,l=i.x+a*(r.x-i.x),c=i.y+a*(r.y-i.y),[u,d]=t.group.children;u.setAttribute("x1",String(l)),u.setAttribute("y1","0"),u.setAttribute("x2",String(l)),u.setAttribute("y2",String(Vn.height)),d.setAttribute("cx",String(l)),d.setAttribute("cy",String(c)),A<e?t.requestId=requestAnimationFrame(()=>Dp(n)):(t.group.remove(),delete ue[n])}function D5(){Mr=!0;for(const n in ue){const t=ue[n];t&&t.requestId!==null&&(cancelAnimationFrame(t.requestId),t.requestId=null)}}function L5(){Mr=!1;for(const n in ue){const t=ue[n];t&&(t.startTimestamp=de()-t.elapsed,t.phase==="attack"?Pp(n):t.phase==="sustain"?Np(n):t.phase==="release"&&Dp(n))}}function k5(){Mr=!1;for(const n in ue){const t=ue[n];t&&(t.requestId!==null&&cancelAnimationFrame(t.requestId),t.group.remove())}for(const n in ue)delete ue[n]}function R5(n){return Vn=n,{trigger:N5,pause:D5,resume:L5,clearAll:k5}}const Rn={adsrComponent:null},hb=2.5;class H5{constructor(){I(this,"ui");I(this,"currentColor");I(this,"attack");I(this,"decay");I(this,"sustain");I(this,"release");I(this,"width");I(this,"height");I(this,"reverbCanvas",null);I(this,"reverbCtx",null);I(this,"svgContainer");I(this,"gridLayer");I(this,"envelopeLayer");I(this,"nodeLayer");I(this,"playheadLayer");I(this,"playheadManager");var e;if(this.ui=x5.init(),!this.ui.container)throw E.error("AdsrComponent","ADSR container element not found",null,"adsr"),new Error("ADSR container element not found");this.currentColor=((e=h.state.selectedNote)==null?void 0:e.color)||"#4a90e2",this.attack=0,this.decay=0,this.sustain=0,this.release=0,this.width=0,this.height=0,this.createSVGLayers(),this.resize(),this.playheadManager=R5(this),Rn.adsrComponent=this,T5(this),this.listenForStoreChanges(),this.initControls();const t=this.ui.container;t&&new ResizeObserver(()=>this.resize()).observe(t),this.updateFromStore(),E.info("ADSR Component","Initialized",null,"adsr")}resize(){if(this.ui.container){if(this.width=this.ui.container.clientWidth,this.height=this.ui.container.clientHeight,this.reverbCanvas){const t=window.devicePixelRatio||1;this.reverbCanvas.width=this.width*t,this.reverbCanvas.height=this.height*t,this.reverbCtx&&(this.reverbCtx.setTransform(1,0,0,1,0,0),this.reverbCtx.scale(t,t))}this.svgContainer&&this.svgContainer.setAttribute("viewBox",`0 0 ${this.width} ${this.height}`),this.render()}}updateFromStore(){const t=h.state.timbres[this.currentColor];if(!t)return;const{attack:e,decay:s,sustain:i,release:r}=t.adsr;this.attack=e,this.decay=s,this.sustain=i,this.release=r,this.render(),this.updateControls()}getCurrentMaxTime(){return hb*h.state.adsrTimeAxisScale}initControls(){const t=document.getElementById("adsr-time-scale"),e=document.getElementById("adsr-time-scale-value");t&&e&&(t.value=String(h.state.adsrTimeAxisScale),e.textContent=`${h.state.adsrTimeAxisScale}x`,t.addEventListener("input",s=>{const i=s.currentTarget;if(!i)return;const r=parseFloat(i.value);Number.isFinite(r)&&(h.setAdsrTimeAxisScale(r),e.textContent=`${r}x`)}))}listenForStoreChanges(){h.on("noteChanged",t=>{var s;const e=(s=t==null?void 0:t.newNote)==null?void 0:s.color;e&&e!==this.currentColor&&(this.currentColor=e,this.updateFromStore())}),h.on("timbreChanged",t=>{t===this.currentColor&&this.updateFromStore()}),h.on("tempoChanged",()=>this.render()),h.on("adsrTimeAxisScaleChanged",()=>{this.render(),this.updateControls()}),h.on("tremoloAmplitudeUpdate",t=>{const e=t==null?void 0:t.activeColors;e!=null&&e.includes(this.currentColor)&&this.render()}),h.on("playbackStateChanged",t=>{if(!t)return;const{isPlaying:e,isPaused:s}=t;e?s?this.playheadManager.pause():this.playheadManager.resume():this.playheadManager.clearAll()}),h.on("audioEffectChanged",t=>{if(!t)return;const{effectType:e,color:s}=t;s===this.currentColor&&(e==="delay"||e==="reverb")&&this.render()})}createSVGLayers(){this.ui.container&&(this.reverbCanvas=document.createElement("canvas"),this.reverbCanvas.className="adsr-reverb-canvas",this.reverbCanvas.style.position="absolute",this.reverbCanvas.style.top="0",this.reverbCanvas.style.left="0",this.reverbCanvas.style.width="100%",this.reverbCanvas.style.height="100%",this.reverbCanvas.style.pointerEvents="none",this.ui.container.appendChild(this.reverbCanvas),this.reverbCtx=this.reverbCanvas.getContext("2d"),this.svgContainer=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svgContainer.setAttribute("width","100%"),this.svgContainer.setAttribute("height","100%"),this.ui.container.appendChild(this.svgContainer),this.gridLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.gridLayer),this.envelopeLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.envelopeLayer),this.nodeLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.nodeLayer),this.playheadLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.playheadLayer))}calculateEnvelopePoints(t){var m,g;const{attack:e,decay:s,sustain:i,release:r}=t??{attack:this.attack,decay:this.decay,sustain:this.sustain,release:this.release};if(!this.width||!this.height)return[];const o=w=>w/this.getCurrentMaxTime()*this.width;let A=1;const a=window.animationEffectsManager;(m=a==null?void 0:a.shouldTremoloBeRunning)!=null&&m.call(a)&&(A=a.getADSRTremoloAmplitudeMultiplier(this.currentColor));const l=((g=window.waveformVisualizer)==null?void 0:g.calculatedAmplitude)??1,c=l*A;E.debug("AdsrComponent","[ADSR] Amplitude calculation",{originalAmplitude:l,tremoloMultiplier:A,normalizedAmplitude:c});const u={x:0,y:this.height},d={x:o(e),y:this.height*(1-c)},p={x:o(e+s),y:this.height*(1-Math.min(i*c,c))},f={x:o(e+s+r),y:this.height};return[u,d,p,f]}render(){if(!this.width||!this.height||!this.gridLayer||!this.envelopeLayer||!this.nodeLayer)return;const t={width:this.width,height:this.height},e=this.calculateEnvelopePoints(),s=this.getCurrentMaxTime();Q5(this.gridLayer,t,s),M5(this.envelopeLayer,this.nodeLayer,e,t,this.currentColor,s,this.reverbCtx),U5(this.ui.parentContainer,this.currentColor)}updateControls(){var S,F;const{sustainThumb:t,sustainTrack:e,thumbA:s,thumbD:i,thumbR:r,multiSliderContainer:o}=this.ui;if(!t||!e||!s||!i||!r||!o)return;const A=h.state.timbres[this.currentColor];if(!A)return;let a=1;const l=window.animationEffectsManager;(S=l==null?void 0:l.shouldTremoloBeRunning)!=null&&S.call(l)&&(a=l.getADSRTremoloAmplitudeMultiplier(this.currentColor));const u=(((F=window.waveformVisualizer)==null?void 0:F.calculatedAmplitude)||1)*a,d=u*100;if(this.sustain>u){const x={...A.adsr,sustain:u};h.setADSR(this.currentColor,x),xu("adsrComponent:clampSustain",{color:this.currentColor,adsr:x,normalizedAmplitude:u}),this.sustain=u}const p=this.sustain*100;t.style.bottom=`${p}%`,e.style.setProperty("--sustain-progress",`${p}%`);const f=100-d;e.style.setProperty("--ineligible-height",`${f}%`);const m=this.getCurrentMaxTime(),g=this.attack/m*100,w=(this.attack+this.decay)/m*100,B=(this.attack+this.decay+this.release)/m*100;s.style.left=`${g}%`,i.style.left=`${w}%`,r.style.left=`${B}%`,o.style.setProperty("--adr-progress",`${B}%`);const b=x=>`${x.toFixed(3)}s`,_=x=>`${(x*100).toFixed(0)}%`;s.title=`Attack: ${b(this.attack)}`,i.title=`Decay: ${b(this.decay)}`,r.title=`Release: ${b(this.release)}`,t.title=`Sustain: ${_(this.sustain)}`;const v=this.nodeLayer.querySelector("#attack-node > title");v&&(v.textContent=`Attack: ${b(this.attack)}`);const C=this.nodeLayer.querySelector("#decay-sustain-node > title");C&&(C.textContent=`Decay: ${b(this.decay)}
Sustain: ${_(this.sustain)}`);const y=this.nodeLayer.querySelector("#release-node > title");y&&(y.textContent=`Release: ${b(this.release)}`)}}function O5(){return document.getElementById("adsr-envelope")?new H5:null}function Xh(n,...t){}let oo,aa,Ti,la,NA,DA,Po,$h=!1,Yh=!1,jh=!1,cn;const _c=1,fb=31,pb=0,Ic=2;function V5(){if(!cn)return null;const n=h.state.timbres[cn];return n?(n.filter?n.filter.enabled===void 0&&(n.filter.enabled=!0):n.filter={enabled:!0,blend:1,cutoff:16,resonance:0,type:"lowpass",mix:0},n.filter):null}function Ed(){const n=V5();if(!n)return;const{cutoff:t=16,blend:e=0,mix:s=0}=n;if(oo&&aa){const i=(Ic-e)/(Ic-pb);oo.style.left=`${i*100}%`,aa.style.setProperty("--progress",`${i*100}%`)}if(DA&&Po){const i=(s||0)/100;DA.style.bottom=`${i*100}%`,Po.style.setProperty("--blend-progress",`${i*100}%`)}if(Ti&&la){const i=(t-_c)/(fb-_c);Ti.style.left=`${i*100}%`,Ti.style.top="50%",Ti.style.transform="translate(-50%, -50%)",la.style.setProperty("--progress",`${i*100}%`)}NA&&cn&&NA.style.setProperty("--c-accent",cn)}function W5(n){if(!$h||!cn||!la)return;const t=la.getBoundingClientRect(),e=n.clientX-t.left,s=t.width;let i=e/s;i=Math.max(0,Math.min(1,i));const r=i*(fb-_c)+_c;h.setFilterSettings(cn,{cutoff:r})}function G5(n){if(!Yh||!cn||!aa)return;const t=aa.getBoundingClientRect(),e=n.clientX-t.left,s=t.width;let i=e/s;i=Math.max(0,Math.min(1,i));const r=Ic-i*(Ic-pb);h.setFilterSettings(cn,{blend:r})}function K5(n){if(!jh||!cn||!Po)return;const t=Po.getBoundingClientRect(),e=n.clientY-t.top,s=t.height;let i=1-e/s;i=Math.max(0,Math.min(1,i));const r=i*100;h.setFilterSettings(cn,{mix:r})}function q5(){var n;if(NA=document.querySelector(".filter-container"),oo=document.getElementById("thumb-b"),aa=document.getElementById("blend-slider-container"),Ti=document.getElementById("thumb-c"),la=document.getElementById("cutoff-slider-container"),!NA||!oo||!Ti){E.error("FilterControls","Missing required elements",{container:NA,blendThumb:oo,cutoffThumb:Ti},"filter");return}z5(),oo.addEventListener("pointerdown",t=>{t.preventDefault(),Yh=!0,document.body.style.cursor="ew-resize";const e=i=>{Xh("log","[BLEND SLIDER] Moving",{clientX:i.clientX}),G5(i)},s=()=>{Yh=!1,document.body.style.cursor="default",window.removeEventListener("pointermove",e),window.removeEventListener("pointerup",s),h.recordState()};window.addEventListener("pointermove",e),window.addEventListener("pointerup",s)}),Ti.addEventListener("pointerdown",t=>{t.preventDefault(),$h=!0,document.body.style.cursor="ew-resize";const e=i=>{Xh("log","[CUTOFF SLIDER] Moving",{clientX:i.clientX}),W5(i)},s=()=>{$h=!1,document.body.style.cursor="default",window.removeEventListener("pointermove",e),window.removeEventListener("pointerup",s),h.recordState()};window.addEventListener("pointermove",e),window.addEventListener("pointerup",s)}),h.on("noteChanged",({newNote:t}={})=>{t!=null&&t.color&&t.color!==cn&&(cn=t.color,Ed())}),h.on("timbreChanged",t=>{t&&t===cn&&Ed()}),cn=((n=h.state.selectedNote)==null?void 0:n.color)||"#4a90e2",Ed()}function z5(){if(Po=document.getElementById("vertical-blend-track"),DA=document.getElementById("vertical-blend-thumb"),!Po||!DA){E.error("FilterControls","Vertical blend slider elements not found",null,"filter");return}DA.addEventListener("pointerdown",n=>{n.preventDefault(),jh=!0,document.body.style.cursor="ns-resize";const t=s=>{Xh("log","[VERTICAL BLEND] Moving",{clientY:s.clientY}),K5(s)},e=()=>{jh=!1,document.body.style.cursor="default",window.removeEventListener("pointermove",t),window.removeEventListener("pointerup",e),h.recordState()};window.addEventListener("pointermove",t),window.addEventListener("pointerup",e)})}const xd=()=>window.synthEngine??null,P0=()=>window.animationEffectsManager??null;E.moduleLoaded("DynamicWaveformVisualizer");class X5{constructor(){I(this,"canvas",null);I(this,"ctx",null);I(this,"currentColor",null);I(this,"isPlaybackActive",!1);I(this,"liveAnalysers",new Map);I(this,"liveWaveforms",new Map);I(this,"playbackAnimationId",null);I(this,"animationSpeed",100);I(this,"frameSkipCounter",0);I(this,"onWaveformUpdate")}initialize(t,e){var s;return this.canvas=t,this.ctx=e,this.currentColor=((s=h.state.selectedNote)==null?void 0:s.color)||"#4a90e2",this.setupEventListeners(),E.info("DynamicWaveformVisualizer","Initialized with canvas context",null,"waveform"),!0}setupEventListeners(){h.on("noteChanged",({newNote:t}={})=>{t!=null&&t.color&&t.color!==this.currentColor&&(this.currentColor=t.color)}),h.on("playbackStateChanged",({isPlaying:t=!1,isPaused:e=!1}={})=>{t&&!e?this.startLiveVisualization():this.stopLiveVisualization()}),h.on("spacebarPlayback",({color:t,isPlaying:e=!1}={})=>{e&&t?this.startSingleNoteVisualization(t):this.stopLiveVisualization()}),h.on("tremoloAmplitudeUpdate",({activeColors:t}={})=>{this.isPlaybackActive&&(t!=null&&t.some(e=>this.liveWaveforms.has(e)))&&E.debug("DynamicWaveformVisualizer","Tremolo update received for active colors",t,"waveform")}),E.info("DynamicWaveformVisualizer","Event subscriptions established",null,"waveform")}setAnimationSpeed(t){this.animationSpeed=t,this.frameSkipCounter=0}startLiveVisualization(){this.isPlaybackActive||(this.isPlaybackActive=!0,this.setupLiveAnalysers(),this.updateContainerState(!0),this.animateLiveWaveforms(),E.debug("DynamicWaveformVisualizer","Started live visualization",null,"waveform"))}startSingleNoteVisualization(t){this.isPlaybackActive||(this.isPlaybackActive=!0,this.setupSingleAnalyser(t),this.updateContainerState(!0),this.animateLiveWaveforms(),E.debug("DynamicWaveformVisualizer",`Started single note visualization for ${t}`,null,"waveform"))}stopLiveVisualization(){this.isPlaybackActive=!1;const t=xd();this.liveAnalysers.forEach((e,s)=>{var i;(i=t==null?void 0:t.removeWaveformAnalyzer)==null||i.call(t,s)}),this.liveAnalysers.clear(),this.liveWaveforms.clear(),this.playbackAnimationId&&(cancelAnimationFrame(this.playbackAnimationId),this.playbackAnimationId=null),this.updateContainerState(!1),E.debug("DynamicWaveformVisualizer","Stopped live visualization",null,"waveform")}updateContainerState(t){var s;const e=(s=this.canvas)==null?void 0:s.parentElement;e&&(t?(e.classList.add("live-mode"),h.state.isPlaying&&!h.state.isPaused&&e.classList.add("pulsing")):e.classList.remove("live-mode","pulsing"))}setupLiveAnalysers(){const t=xd();if(!t){E.warn("DynamicWaveformVisualizer","SynthEngine not available for live analysis",null,"waveform");return}this.getActivePlayingColors().forEach(s=>{var r;const i=(r=t.createWaveformAnalyzer)==null?void 0:r.call(t,s);i&&(this.liveAnalysers.set(s,i),this.liveWaveforms.set(s,new Float32Array(1024)),E.debug("DynamicWaveformVisualizer",`Created analyser for ${s}`,null,"waveform"))})}setupSingleAnalyser(t){var i;const e=xd();if(!e)return;const s=(i=e.createWaveformAnalyzer)==null?void 0:i.call(e,t);s&&(this.liveAnalysers.set(t,s),this.liveWaveforms.set(t,new Float32Array(1024)),E.debug("DynamicWaveformVisualizer",`Created single analyser for ${t}`,null,"waveform"))}getActivePlayingColors(){const t=new Set,e=h.state.placedNotes;h.state.isPlaying&&e.forEach(i=>{!i.isDrum&&i.color&&t.add(i.color)}),t.size===0&&this.currentColor&&t.add(this.currentColor);const s=Array.from(t);return E.debug("DynamicWaveformVisualizer","Active playing colors detected",s,"waveform"),s}animateLiveWaveforms(){var e;if(!this.isPlaybackActive)return;this.frameSkipCounter++;const t=Math.max(1,Math.floor(100/Math.max(this.animationSpeed,1)));if(this.frameSkipCounter%t!==0){this.playbackAnimationId=requestAnimationFrame(()=>this.animateLiveWaveforms());return}this.liveAnalysers.forEach((s,i)=>{const r=s.getValue();this.liveWaveforms.set(i,r)}),(e=this.onWaveformUpdate)==null||e.call(this),this.playbackAnimationId=requestAnimationFrame(()=>this.animateLiveWaveforms())}drawLiveWaveforms(t,e,s){if(!this.ctx)return;const r=Array.from(this.liveWaveforms.keys());if(r.length===1){const o=r[0];if(!o)return;const A=this.liveWaveforms.get(o);this.drawSingleLiveWaveform(A,o,t,e,s)}else r.length>1&&r.forEach(o=>{if(!o)return;const A=this.liveWaveforms.get(o);this.drawLayeredLiveWaveform(A,o,t,e,s,r.length)})}drawSingleLiveWaveform(t,e,s,i,r){const o=this.ctx;if(!o||!t||t.length===0)return;const A=P0();let a=r;if(A){const g=A.getTremoloAmplitudeMultiplier(e);a*=g}let l=0;const c=A==null?void 0:A.vibratoCanvasEffect,u=c==null?void 0:c.animations.get(e);c&&u&&c.shouldBeRunning()&&(l=Math.sin(u.phase)*u.amplitude*.4);let d=0;for(let g=0;g<t.length;g++){const w=t[g]??0;d=Math.max(d,Math.abs(w))}const p=d>1?1/d:1;o.strokeStyle=e,o.lineWidth=2,o.beginPath();const m=t.length/s*(1+l);for(let g=0;g<s;g++){const w=l*s*.3,B=g+w,b=Math.floor(B*m),_=Math.max(0,Math.min(t.length-1,b)),v=(t[_]??0)*p,C=i-v*a;g===0?o.moveTo(g,C):o.lineTo(g,C)}o.stroke(),E.debug("DynamicWaveformVisualizer",`Drew single live waveform for ${e} with tremolo and vibrato stretch`,{amplitudeRatio:a/r,vibratoStretch:l},"waveform")}drawLayeredLiveWaveform(t,e,s,i,r,o){const A=this.ctx;if(!A||!t||t.length===0)return;const a=P0();let l=r;a&&(l*=a.getTremoloAmplitudeMultiplier(e));let c=0;const u=a==null?void 0:a.vibratoCanvasEffect,d=u==null?void 0:u.animations.get(e);u&&d&&u.shouldBeRunning()&&(c=Math.sin(d.phase)*d.amplitude*.4);let p=0;for(let B=0;B<t.length;B++){const b=t[B]??0;p=Math.max(p,Math.abs(b))}const f=p>1?1/p:1,m=Math.max(.4,1/o);A.strokeStyle=bs(e,m*2),A.lineWidth=1.5,A.beginPath();const w=t.length/s*(1+c);for(let B=0;B<s;B++){const b=c*s*.3,_=B+b,v=Math.floor(_*w),C=Math.max(0,Math.min(t.length-1,v)),y=(t[C]??0)*f,S=i-y*l*.7;B===0?A.moveTo(B,S):A.lineTo(B,S)}A.stroke()}isLiveMode(){return this.isPlaybackActive}getLiveColors(){return Array.from(this.liveWaveforms.keys())}dispose(){this.stopLiveVisualization(),E.info("DynamicWaveformVisualizer","Disposed",null,"waveform")}}const $5=512,Ji=360,eA=480,Y5=()=>window.animationEffectsManager;E.moduleLoaded("StaticWaveformVisualizer");class j5{constructor(){I(this,"canvas",null);I(this,"ctx",null);I(this,"currentColor",null);I(this,"animationFrameId",null);I(this,"waveformData",new Float32Array($5));I(this,"isInitialized",!1);I(this,"isTransitioning",!1);I(this,"transitionStartTime",0);I(this,"transitionDuration",300);I(this,"fromWaveform",null);I(this,"toWaveform",null);I(this,"transitionAnimationId",null);I(this,"dynamicVisualizer",new X5);I(this,"animationSpeed",100);I(this,"frameSkipCounter",0);I(this,"resizeObserver",null);I(this,"calculatedAmplitude",0);E.info("StaticWaveformVisualizer","Initialized with dynamic visualizer integration",null,"waveform")}initialize(){var s,i;if(this.canvas=document.getElementById("static-waveform-canvas"),!this.canvas)return!1;const t=this.canvas.getContext("2d");if(!t)return!1;this.ctx=t,this.currentColor=((s=h.state.selectedNote)==null?void 0:s.color)||"#4a90e2";const e=this.canvas.parentElement;return e&&typeof ResizeObserver<"u"&&((i=this.resizeObserver)==null||i.disconnect(),this.resizeObserver=new ResizeObserver(()=>this.resize()),this.resizeObserver.observe(e)),this.resize(),this.setupEventListeners(),this.dynamicVisualizer.initialize(this.canvas,this.ctx),this.dynamicVisualizer.onWaveformUpdate=()=>this.draw(),this.generateWaveform(),this.isInitialized=!0,!0}resize(){if(!this.canvas||!this.ctx)return;const t=this.canvas.parentElement;if(!t)return;const{clientWidth:e,clientHeight:s}=t,i=this.canvas.width,r=this.canvas.height;if((e===0||s===0)&&this.canvas.width>0&&this.canvas.height>0)return;const A=Math.abs(e-i),a=Math.abs(s-r);(A>2||a>2)&&(this.canvas.width=e,this.canvas.height=s,this.draw())}setupEventListeners(){h.on("noteChanged",(e={})=>{var i;const s=(i=e.newNote)==null?void 0:i.color;s&&s!==this.currentColor&&(this.currentColor=s,this.generateWaveform())}),h.on("timbreChanged",e=>{e&&e===this.currentColor&&this.generateWaveform()}),h.on("waveformExtendedViewChanged",()=>{this.generateWaveform(),this.updateToggleButton()}),document.querySelectorAll(".tab-button").forEach(e=>{e.addEventListener("click",()=>{e.dataset.tab==="timbre"&&setTimeout(()=>this.resize(),100)})}),this.setupSpeedControls(),this.setupExtendToggle()}setupSpeedControls(){const t=Array.from(document.querySelectorAll(".waveform-speed-btn"));t.length!==0&&t.forEach(e=>{e.addEventListener("click",()=>{const s=e.dataset.speed,i=s?parseInt(s,10):NaN;Number.isFinite(i)&&(e.classList.contains("active")?(e.classList.remove("active"),this.setAnimationSpeed(100)):(t.forEach(r=>r.classList.remove("active")),e.classList.add("active"),this.setAnimationSpeed(i)))})})}setAnimationSpeed(t){Number.isFinite(t)&&(this.animationSpeed=t,this.frameSkipCounter=0,this.dynamicVisualizer.setAnimationSpeed(t))}setupExtendToggle(){const t=document.getElementById("waveform-extend-toggle");t instanceof HTMLElement&&(t.addEventListener("click",()=>{h.toggleWaveformExtendedView()}),this.updateToggleButton())}updateToggleButton(){const t=document.getElementById("waveform-extend-toggle");if(!(t instanceof HTMLElement))return;const e=h.state.waveformExtendedView;t.classList.toggle("extended",e),t.textContent=e?"480 View":"360 View",t.title=e?"Switch to 360 waveform view":"Switch to 480 waveform view (shows extra 120)"}generateWaveform(){if(this.isTransitioning||!this.currentColor)return;const t=h.state.timbres[this.currentColor];if(!(t!=null&&t.coeffs))return;const e=Fh(this.currentColor),s=t.phases??new Float32Array(fo),i=this.waveformData.length;this.waveformData.fill(0);let r=0;for(let o=0;o<i;o++){const a=(h.state.waveformExtendedView?eA:Ji)/Ji,l=o/i*a*2*Math.PI;let c=0;for(let u=0;u<fo;u++){const d=e[u]??0;if(d<=.001)continue;const p=s[u]??0,f=u+1;c+=d*Math.sin(f*l+p)}this.waveformData[o]=c,r=Math.max(r,Math.abs(c))}if(this.calculatedAmplitude=Math.min(1,r),r>1){const o=1/r;for(let A=0;A<this.waveformData.length;A++){const a=this.waveformData[A]??0;this.waveformData[A]=a*o}}this.draw()}startPhaseTransition(t,e,s){!this.isInitialized||!this.currentColor||(this.isTransitioning&&this.transitionAnimationId&&cancelAnimationFrame(this.transitionAnimationId),this.fromWaveform=new Float32Array(this.waveformData),this.generateTargetWaveform(e),this.toWaveform=new Float32Array(this.waveformData),this.waveformData=this.fromWaveform,this.isTransitioning=!0,this.transitionStartTime=performance.now(),this.animateTransition())}generateTargetWaveform(t){if(!this.currentColor||!t)return;const e=h.state.timbres[this.currentColor];if(!(e!=null&&e.coeffs))return;const s=Fh(this.currentColor),i=t instanceof Float32Array?t:new Float32Array(t),r=this.waveformData.length;this.waveformData.fill(0);let o=0;for(let A=0;A<r;A++){const l=(h.state.waveformExtendedView?eA:Ji)/Ji,c=A/r*l*2*Math.PI;let u=0;for(let d=0;d<fo;d++){const p=s[d]??0;if(p<=.001)continue;const f=i[d]??0,m=d+1;u+=p*Math.sin(m*c+f)}this.waveformData[A]=u,o=Math.max(o,Math.abs(u))}if(this.calculatedAmplitude=Math.min(1,o),o>1){const A=1/o;for(let a=0;a<this.waveformData.length;a++){const l=this.waveformData[a]??0;this.waveformData[a]=l*A}}}animateTransition(){const t=this.fromWaveform,e=this.toWaveform;if(!this.isTransitioning||!t||!e)return;const s=performance.now()-this.transitionStartTime,i=Math.min(s/this.transitionDuration,1),r=1-Math.pow(1-i,3);for(let o=0;o<this.waveformData.length;o++){const A=t[o]??0,a=e[o]??0;this.waveformData[o]=A+(a-A)*r}this.draw(),i>=1?(this.isTransitioning=!1,this.fromWaveform=null,this.toWaveform=null,this.transitionAnimationId=null):this.transitionAnimationId=requestAnimationFrame(()=>this.animateTransition())}normalizeWaveform(){let t=0;for(let e=0;e<this.waveformData.length;e++){const s=this.waveformData[e]??0;t=Math.max(t,Math.abs(s))}if(t>0){const e=.9/t;for(let s=0;s<this.waveformData.length;s++){const i=this.waveformData[s]??0;this.waveformData[s]=i*e}}}draw(){const t=this.ctx,e=this.canvas;if(!t||!e)return;const{width:s,height:i}=e,r=i/2,o=i/2;t.fillStyle="#ffffff",t.fillRect(0,0,s,i),this.drawGrid(s,i,r,o),this.dynamicVisualizer.isLiveMode()?this.dynamicVisualizer.drawLiveWaveforms(s,r,o):this.drawWaveform(s,r,o),s>200&&i>100&&this.drawLabels(s,i)}drawGrid(t,e,s,i){const r=this.ctx;if(!r)return;r.strokeStyle="#ced4da",r.lineWidth=1,r.setLineDash([2,2]),r.beginPath(),r.moveTo(0,s),r.lineTo(t,s),r.stroke();const o=h.state.waveformExtendedView?eA:Ji;if((h.state.waveformExtendedView?[90,180,270,360,450]:[90,180,270]).forEach(u=>{const d=t/o*u;r.beginPath(),r.moveTo(d,0),r.lineTo(d,e),r.stroke()}),h.state.waveformExtendedView){const u=t/eA*Ji;r.fillStyle="rgba(128, 128, 128, 0.15)",r.fillRect(u,0,t-u,e)}[.5].forEach(u=>{const d=s-i*u,p=s+i*u;r.beginPath(),r.moveTo(0,d),r.lineTo(t,d),r.moveTo(0,p),r.lineTo(t,p),r.stroke()}),r.setLineDash([]),r.strokeStyle="#999999",r.lineWidth=1;const l=s-i,c=s+i;r.beginPath(),r.moveTo(0,l),r.lineTo(t,l),r.stroke(),r.beginPath(),r.moveTo(0,c),r.lineTo(t,c),r.stroke()}drawWaveform(t,e,s){const i=this.ctx;if(!i||this.waveformData.length===0)return;const r=this.currentColor||"#4a90e2";i.strokeStyle=r,i.lineWidth=2,i.beginPath();const o=this.waveformData.length/t;for(let a=0;a<t;a++){const l=Math.floor(a*o),c=this.waveformData[l]||0,u=e-c*s;a===0?i.moveTo(a,u):i.lineTo(a,u)}i.stroke(),i.lineTo(t,e),i.lineTo(0,e),i.closePath();const A=i.createLinearGradient(0,e-s,0,e+s);A.addColorStop(0,bs(r,.3)),A.addColorStop(.5,bs(r,.1)),A.addColorStop(1,bs(r,.3)),i.fillStyle=A,i.fill()}drawLabels(t,e){const s=this.ctx;if(!s)return;const i=h.state.waveformExtendedView,r=i?eA:Ji,o=i?["0","90","180","270","360","450"]:["0","90","180","270","360"],A=i?[0,90,180,270,360,450]:[0,90,180,270,360];s.fillStyle="#666666",s.font='12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',s.textAlign="center",o.forEach((a,l)=>{const c=A[l]??0,u=t/r*c+10;s.fillText(a,u,e/2+4)}),s.textAlign="left",s.fillText("+1.0",5,15),s.fillText("-1.0",5,e-8)}getNormalizedAmplitude(){return this.calculatedAmplitude||0}getADSRTremoloAmplitude(){const t=this.calculatedAmplitude||0,e=Y5();if(this.currentColor&&(e!=null&&e.getADSRTremoloAmplitudeMultiplier)){const s=e.getADSRTremoloAmplitudeMultiplier(this.currentColor);return t*s}return t}startSingleNoteVisualization(t){this.dynamicVisualizer.startSingleNoteVisualization(t)}stopLiveVisualization(){this.dynamicVisualizer.stopLiveVisualization()}startLiveVisualization(){this.dynamicVisualizer.startLiveVisualization()}dispose(){var t;this.dynamicVisualizer.dispose(),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.transitionAnimationId&&(cancelAnimationFrame(this.transitionAnimationId),this.transitionAnimationId=null),(t=this.resizeObserver)==null||t.disconnect(),this.resizeObserver=null,this.isTransitioning=!1,this.fromWaveform=null,this.toWaveform=null,this.isInitialized=!1}}const mb=new j5;window.waveformVisualizer=mb;function J5(){return mb.initialize()}class Lp{constructor(t){I(this,"effectName");I(this,"animations");I(this,"activeNoteAnimations");I(this,"ghostNoteAnimation");I(this,"activeSoundingNotes");I(this,"isPlaybackActive");I(this,"hasActiveInteraction");I(this,"hasDialInteraction");this.effectName=t,this.animations=new Map,this.activeNoteAnimations=new Map,this.ghostNoteAnimation=null,this.activeSoundingNotes=new Map,this.isPlaybackActive=!1,this.hasActiveInteraction=!1,this.hasDialInteraction=!1,E.info(`${t}AnimationEffect`,"Base initialized",null,"animation")}initBase(){h.on("visualEffectChanged",t=>{if(!t)return;const{effectType:e,color:s,effectParams:i}=t;e===this.effectName.toLowerCase()&&this.updateAnimationParameters(s,i)}),h.on("playbackStarted",()=>{this.isPlaybackActive=!0,this.requestAnimationStateUpdate()}),h.on("playbackStopped",()=>{this.isPlaybackActive=!1,this.activeNoteAnimations.clear(),this.activeSoundingNotes.clear(),this.requestAnimationStateUpdate()}),h.on("noteInteractionStart",t=>{t&&this.onNoteInteractionStart(t.noteId,t.color)}),h.on("noteInteractionEnd",t=>{const e=t==null?void 0:t.noteId;e&&this.onNoteInteractionEnd(e)}),h.on("ghostNoteUpdated",t=>{t&&this.onGhostNoteUpdated(t.color)}),h.on("ghostNoteCleared",()=>this.onGhostNoteCleared()),h.on("spacebarPlayback",t=>{t&&(this.isPlaybackActive=t.isPlaying,this.requestAnimationStateUpdate())}),h.on("noteAttack",t=>{t&&this.onNoteAttack(t.noteId,t.color)}),h.on("noteRelease",t=>{t&&this.onNoteRelease(t.noteId,t.color)}),h.on("effectDialInteractionStart",t=>{t&&t.effectType===this.effectName.toLowerCase()&&this.onDialInteractionStart(t.color)}),h.on("effectDialInteractionEnd",t=>{t&&t.effectType===this.effectName.toLowerCase()&&this.onDialInteractionEnd(t.color)}),E.info(`${this.effectName}AnimationEffect`,"Base event subscriptions established",null,"animation")}shouldAnimateColor(t){return this.animations.has(t)}shouldAnimateNote(t){if(!(t!=null&&t.color)||!this.shouldAnimateColor(t.color))return!1;if(this.hasDialInteraction&&this.activeNoteAnimations.has("dial-preview")){const e=this.activeNoteAnimations.get("dial-preview");if(e&&t.color===e)return!0}return!!(this.isPlaybackActive&&t.uuid&&this.activeSoundingNotes.has(t.uuid)||this.hasActiveInteraction&&t.uuid&&this.activeNoteAnimations.has(t.uuid)||!t.uuid&&this.ghostNoteAnimation&&this.ghostNoteAnimation.color===t.color&&this.isPlaybackActive)}shouldBeRunning(){const t=this.animations.size>0;return t?!!(this.isPlaybackActive||this.hasActiveInteraction||this.hasDialInteraction||this.ghostNoteAnimation!==null||t):!1}onNoteInteractionStart(t,e){this.shouldAnimateColor(e)&&(this.activeNoteAnimations.set(t,e),this.hasActiveInteraction=!0,E.debug(`${this.effectName}AnimationEffect`,`Started interaction animation for note ${t} (${e})`,null,"animation"),this.requestAnimationStateUpdate())}onNoteInteractionEnd(t){this.activeNoteAnimations.delete(t),this.hasActiveInteraction=this.activeNoteAnimations.size>0,E.debug(`${this.effectName}AnimationEffect`,`Ended interaction animation for note ${t}`,null,"animation"),this.requestAnimationStateUpdate()}onGhostNoteUpdated(t){this.shouldAnimateColor(t)?(this.ghostNoteAnimation={color:t,active:!0},E.debug(`${this.effectName}AnimationEffect`,`Ghost note animation updated for color ${t}`,null,"animation")):this.ghostNoteAnimation=null}onGhostNoteCleared(){this.ghostNoteAnimation=null,E.debug(`${this.effectName}AnimationEffect`,"Ghost note animation cleared",null,"animation")}onNoteAttack(t,e){this.shouldAnimateColor(e)&&(this.activeSoundingNotes.set(t,e),E.debug(`${this.effectName}AnimationEffect`,`Note attack: ${t} (${e}) added to active sounding notes`,null,"animation"),this.requestAnimationStateUpdate())}onNoteRelease(t,e){this.activeSoundingNotes.delete(t),E.debug(`${this.effectName}AnimationEffect`,`Note release: ${t} (${e}) removed from active sounding notes`,null,"animation"),this.requestAnimationStateUpdate()}onDialInteractionStart(t){this.shouldAnimateColor(t)&&(this.hasDialInteraction=!0,this.activeNoteAnimations.set("dial-preview",t),E.debug(`${this.effectName}AnimationEffect`,`Dial interaction started for ${t}`,null,"animation"),this.requestAnimationStateUpdate())}onDialInteractionEnd(t){this.hasDialInteraction=!1,this.activeNoteAnimations.delete("dial-preview"),E.debug(`${this.effectName}AnimationEffect`,`Dial interaction ended for ${t}`,null,"animation"),this.requestAnimationStateUpdate()}getActiveColors(){const t=new Set;for(const[,e]of this.activeSoundingNotes.entries())this.shouldAnimateColor(e)&&t.add(e);for(const[,e]of this.activeNoteAnimations.entries())this.shouldAnimateColor(e)&&t.add(e);return this.ghostNoteAnimation&&this.shouldAnimateColor(this.ghostNoteAnimation.color)&&t.add(this.ghostNoteAnimation.color),Array.from(t)}disposeBase(){this.animations.clear(),this.activeNoteAnimations.clear(),this.activeSoundingNotes.clear(),this.ghostNoteAnimation=null,E.info(`${this.effectName}AnimationEffect`,"Base disposed",null,"animation")}requestAnimationStateUpdate(){var t;(t=window.animationEffectsManager)==null||t.updateAnimationState()}}E.moduleLoaded("VibratoCanvasEffect");class Z5 extends Lp{constructor(){super("Vibrato"),E.info("VibratoCanvasEffect","Initialized for canvas note positions",null,"animation")}init(){return this.initBase(),E.info("VibratoCanvasEffect","Ready for canvas animation",null,"animation"),!0}updateAnimationParameters(t,e){const{speed:s,span:i}=e;if(s===0||i===0)this.animations.delete(t),E.debug("VibratoCanvasEffect",`Disabled vibrato animation for ${t}`,null,"animation");else{const r=this.animations.get(t),o=s/100*16,A=i/100*.5,a={frequency:o,amplitude:A,phase:(r==null?void 0:r.phase)||0,lastUpdate:performance.now()};this.animations.set(t,a),E.debug("VibratoCanvasEffect",`Updated vibrato animation for ${t}`,{frequency:o,amplitude:A,preservedPhase:!!r},"animation")}}updateAnimationPhases(t){this.animations.forEach(e=>{const s=(t-e.lastUpdate)/1e3;e.phase+=e.frequency*s*2*Math.PI,e.lastUpdate=t,e.phase>4*Math.PI&&(e.phase-=4*Math.PI)})}getVibratoYOffset(t){if(!t)return 0;const e=this.animations.get(t);if(!e||window.animationEffectsManager&&!window.animationEffectsManager.shouldVibratoBeRunning())return 0;const s=Math.sin(e.phase),i=-s*e.amplitude;return E.debug("VibratoCanvasEffect","Visual vibrato",{sine:s.toFixed(3),offset:i.toFixed(3),phase:e.phase.toFixed(3)},"effects"),i}shouldBeRunning(){return this.animations.size>0?this.isPlaybackActive||this.hasActiveInteraction||this.hasDialInteraction||this.ghostNoteAnimation!==null&&this.isPlaybackActive:!1}shouldAnimateColor(t){const e=this.animations.get(t);return e?e.frequency>0&&e.amplitude>0:!1}dispose(){this.disposeBase(),E.info("VibratoCanvasEffect","Disposed",null,"animation")}}E.moduleLoaded("TremoloWaveformEffect");class tk extends Lp{constructor(){super("Tremolo"),E.info("TremoloWaveformEffect","Initialized for waveform/ADSR amplitude",null,"animation")}init(){return this.initBase(),E.info("TremoloWaveformEffect","Ready for waveform/ADSR animation",null,"animation"),!0}updateAnimationParameters(t,e){var r,o;const{speed:s,span:i}=e;if(s===0||i===0)this.animations.delete(t),E.debug("TremoloWaveformEffect",`Disabled tremolo animation for ${t}`,null,"animation");else{const A=this.animations.get(t),a=s/100*16,l=i/100,c=(o=(r=window.Tone)==null?void 0:r.now)==null?void 0:o.call(r),u=typeof c=="number"?c*1e3:performance.now(),d={frequency:a,span:l,phase:(A==null?void 0:A.phase)||0,lastUpdate:u};this.animations.set(t,d),E.debug("TremoloWaveformEffect",`Updated tremolo animation for ${t}`,{frequency:a,span:l,preservedPhase:!!A},"animation")}}updateAnimationPhases(t){var r,o,A,a;let e=0;const s=(o=(r=window.Tone)==null?void 0:r.now)==null?void 0:o.call(r),i=typeof s=="number"?s*1e3:t;if(this.animations.forEach((l,c)=>{const u=(i-l.lastUpdate)/1e3,d=l.phase;l.phase+=l.frequency*u*2*Math.PI,l.lastUpdate=i,e++,Math.abs(l.phase-d)<.001&&E.warn("TremoloWaveformEffect",`Phase not advancing for ${c}`,{deltaSeconds:Number(u.toFixed(4)),frequency:l.frequency},"animation"),l.phase>4*Math.PI&&(l.phase-=4*Math.PI)}),e>0&&Math.random()<.05){const l=(A=window.Tone)!=null&&A.now?"Tone.js":"performance";E.debug("TremoloWaveformEffect","Timing sample",{hasTone:!!window.Tone,hasToneNow:!!((a=window.Tone)!=null&&a.now),toneTime:i,currentTime:t,timingSource:l},"animation")}}getTremoloAmplitudeMultiplier(t){var m,g,w;const e=this.animations.get(t);if(!e||window.animationEffectsManager&&!window.animationEffectsManager.shouldTremoloBeRunning())return 1;const s=((m=window.waveformVisualizer)==null?void 0:m.calculatedAmplitude)??1,i=Math.sin(e.phase),r=e.span,o=s,A=s*(1-r),a=(o+A)/2,l=(o-A)/2,u=(a+i*l)/s,d=(w=(g=window.Tone)==null?void 0:g.now)==null?void 0:w.call(g),f=(typeof d=="number"?d*1e3:performance.now())-e.lastUpdate;if(f>100&&e.span>0){const B=e.frequency*(f/1e3)*2*Math.PI;B>.1&&E.warn("TremoloWaveformEffect",`Phase stagnation detected for ${t}`,{phase:Number(e.phase.toFixed(3)),millisecondsSinceUpdate:Number(f.toFixed(1)),expectedAdvancement:Number(B.toFixed(3))},"animation")}return Math.max(0,Math.min(1,u))}getADSRTremoloAmplitudeMultiplier(t){return this.getTremoloAmplitudeMultiplier(t)}shouldAnimateColor(t){const e=this.animations.get(t);return e?e.frequency>0&&e.span>0:!1}dispose(){this.disposeBase(),E.info("TremoloWaveformEffect","Disposed",null,"animation")}}E.moduleLoaded("EnvelopeFillEffect");class ek{constructor(){I(this,"activeFills");I(this,"instanceId");this.activeFills=new Map,this.instanceId=Math.random().toString(36).substring(7),E.info("EnvelopeFillEffect","Initialized",null,"animation")}init(){h.on("noteAttack",t=>{var r,o;const e=t==null?void 0:t.noteId,s=t==null?void 0:t.color;if(!e||!s)return;const i=(r=h.state.timbres)==null?void 0:r[s];if(!i){E.warn("EnvelopeFillEffect","No timbre found for color",{color:s},"effects");return}this.activeFills.set(e,{fillLevel:0,color:s,startTime:de(),adsr:i.adsr,phase:"attack"}),E.debug("EnvelopeFillEffect",`Started fill animation for note ${e}`,null,"animation"),(o=window.animationEffectsManager)==null||o.updateAnimationState()}),h.on("noteRelease",t=>{const e=t==null?void 0:t.noteId;if(!e)return;const s=this.activeFills.get(e);s?(s.phase="release",s.releaseStartTime=de(),s.releaseStartLevel=s.fillLevel,E.debug("EnvelopeFillEffect",`Started release phase for note ${e}`,null,"animation")):E.warn("EnvelopeFillEffect","No fill data found for release",{noteId:e},"effects")}),h.on("playbackStopped",()=>{var t;this.activeFills.clear(),(t=window.animationEffectsManager)==null||t.updateAnimationState(),h.emit("animationUpdate",{type:"envelopeFill",activeColors:[],hasEnvelopeFills:!1})}),E.info("EnvelopeFillEffect","Event subscriptions established",null,"animation")}updateAnimationPhases(t){var s;const e=de();for(const[i,r]of this.activeFills.entries()){const{adsr:o,startTime:A,phase:a,releaseStartTime:l,releaseStartLevel:c}=r,u=e-A;if(a==="attack"){const d=o.attack||.01;u<d?r.fillLevel=u/d:(r.phase="decay",r.decayStartTime=e)}else if(a==="decay"){const d=o.decay||.1,p=e-(r.decayStartTime??e),f=o.sustain??.5;if(p<d){const m=p/d;r.fillLevel=1-m*(1-f)}else r.phase="sustain",r.fillLevel=f}else if(a==="sustain"){const d=o.sustain??.5;r.fillLevel=d}else if(a==="release"){const d=o.release||.5,p=l?e-l:0,f=c??r.fillLevel;if(p<d){const m=p/d;r.fillLevel=f*(1-m)}else this.activeFills.delete(i),E.debug("EnvelopeFillEffect",`Completed fill animation for note ${i}`,null,"animation"),this.activeFills.size===0&&((s=window.animationEffectsManager)==null||s.updateAnimationState())}}}getFillLevel(t){if(!t.uuid)return 0;const e=this.activeFills.get(t.uuid);return e?e.fillLevel:0}shouldFillNote(t){return t.uuid?this.activeFills.has(t.uuid):!1}shouldBeRunning(){return this.activeFills.size>0}dispose(){this.activeFills.clear(),E.info("EnvelopeFillEffect","Disposed",null,"animation")}}E.moduleLoaded("DelayADSREffect");class nk extends Lp{constructor(){super("Delay"),E.info("DelayADSREffect","Initialized for delay visualization (PLACEHOLDER)",null,"animation")}init(){return this.initBase(),E.info("DelayADSREffect","Ready for delay animation (PLACEHOLDER)",null,"animation"),!0}updateAnimationParameters(t,e){const{time:s,feedback:i}=e;if(s===0&&i===0)this.animations.delete(t),E.debug("DelayADSREffect",`Disabled delay animation for ${t}`,null,"animation");else{const r=s/100*500,o=i/100,A={delayTime:r,feedback:o,echoCount:Math.floor(o*5),lastTrigger:0,echoPhases:[],lastUpdate:performance.now()};this.animations.set(t,A),E.debug("DelayADSREffect",`Updated delay animation for ${t} (PLACEHOLDER)`,{delayTime:r,feedback:o},"animation")}}updateAnimationPhases(t){this.animations.forEach(e=>{e.lastUpdate=t})}getDelayEffects(t){const e=this.animations.get(t);if(!e)return[];const s=[];for(let i=0;i<e.echoCount;i++)s.push({delay:e.delayTime*(i+1),opacity:1-i*.3,scale:1-i*.1,active:!1});return s}triggerDelay(t,e){const s=this.animations.get(t);s&&(s.lastTrigger=e,E.debug("DelayADSREffect",`Triggered delay for ${t} (PLACEHOLDER)`,null,"animation"))}shouldBeRunning(){return this.animations.size>0?this.isPlaybackActive||this.hasActiveInteraction||this.ghostNoteAnimation!==null:!1}shouldAnimateColor(t){const e=this.animations.get(t);return e?e.delayTime>0||e.feedback>0:!1}dispose(){this.disposeBase(),E.info("DelayADSREffect","Disposed",null,"animation")}}E.moduleLoaded("AnimationEffectsManager");class sk{constructor(){I(this,"vibratoEffect");I(this,"tremoloEffect");I(this,"envelopeFillEffect");I(this,"delayEffect");I(this,"isRunning");I(this,"animationFrameId");I(this,"lastTime");I(this,"lastRenderTrigger");this.vibratoEffect=new Z5,this.tremoloEffect=new tk,this.envelopeFillEffect=new ek,this.delayEffect=new nk,this.isRunning=!1,this.animationFrameId=null,this.lastTime=0,this.lastRenderTrigger=0,E.info("AnimationEffectsManager","Initialized with single animation loop",null,"animation")}init(){return this.vibratoEffect.init(),this.tremoloEffect.init(),this.envelopeFillEffect.init(),this.delayEffect.init(),h.on("visualEffectChanged",t=>{const e=t==null?void 0:t.effectType;(e==="vibrato"||e==="tremolo")&&(setTimeout(()=>this.updateAnimationState(),0),e==="tremolo"&&setTimeout(()=>this.triggerTremoloAmplitudeUpdate(),0))}),h.on("audioEffectChanged",t=>{if(!t)return;const{effectType:e,color:s,effectParams:i}=t;!s||!i||e==="delay"&&this.delayEffect.updateAnimationParameters(s,i)}),E.info("AnimationEffectsManager","Event subscriptions established",null,"animation"),!0}animate(t){this.isRunning&&(this.lastTime=t,this.vibratoEffect.updateAnimationPhases(t),this.tremoloEffect.updateAnimationPhases(t),this.envelopeFillEffect.updateAnimationPhases(t),this.triggerVisualUpdates(t),this.animationFrameId=requestAnimationFrame(e=>this.animate(e)))}start(){this.isRunning||(this.isRunning=!0,this.lastTime=performance.now(),this.animationFrameId=requestAnimationFrame(t=>this.animate(t)),E.debug("AnimationEffectsManager","Single animation loop started",null,"animation"))}stop(){this.isRunning&&(this.isRunning=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.triggerFinalUpdates(),E.debug("AnimationEffectsManager","Animation loop stopped",null,"animation"))}shouldTremoloBeRunning(){if(!(this.tremoloEffect.animations.size>0))return!1;const e=this.tremoloEffect.activeSoundingNotes.size>0,s=this.tremoloEffect.hasDialInteraction;return e||s}shouldVibratoBeRunning(){return this.vibratoEffect.animations.size>0?this.vibratoEffect.isPlaybackActive||this.vibratoEffect.hasActiveInteraction||this.vibratoEffect.hasDialInteraction||this.vibratoEffect.ghostNoteAnimation!==null:!1}shouldEnvelopeFillBeRunning(){return this.envelopeFillEffect.shouldBeRunning()}updateAnimationState(){const t=this.shouldVibratoBeRunning(),e=this.shouldTremoloBeRunning(),s=this.shouldEnvelopeFillBeRunning(),i=t||e||s;i&&!this.isRunning?this.start():!i&&this.isRunning&&this.stop()}triggerVisualUpdates(t){if(!this.lastRenderTrigger||t-this.lastRenderTrigger>=16.67){this.lastRenderTrigger=t;const e=this.vibratoEffect.getActiveColors(),s=this.tremoloEffect.getActiveColors(),i=this.envelopeFillEffect.activeFills.size>0;(e.length>0||i)&&h.emit("animationUpdate",{type:e.length>0?"vibrato":"envelopeFill",activeColors:e,hasEnvelopeFills:i}),s.length>0&&h.emit("tremoloAmplitudeUpdate",{activeColors:s})}}triggerFinalUpdates(){const t=Array.from(this.vibratoEffect.animations.keys());t.length>0&&h.emit("animationUpdate",{type:"vibrato",activeColors:t});const e=Array.from(this.tremoloEffect.animations.keys());e.length>0&&h.emit("tremoloAmplitudeUpdate",{activeColors:e})}shouldAnimateNote(t){return this.vibratoEffect.shouldAnimateNote(t)}getVibratoYOffset(t){return this.vibratoEffect.getVibratoYOffset(t)}getTremoloAmplitudeMultiplier(t){return this.tremoloEffect.getTremoloAmplitudeMultiplier(t)}getADSRTremoloAmplitudeMultiplier(t){return this.tremoloEffect.getADSRTremoloAmplitudeMultiplier(t)}getFillLevel(t){return this.envelopeFillEffect.getFillLevel(t)}shouldFillNote(t){return this.envelopeFillEffect.shouldFillNote(t)}getDelayEffects(t){return this.delayEffect.getDelayEffects(t)}hasDelayEffect(t){return this.delayEffect.shouldAnimateColor(t)}triggerTremoloAmplitudeUpdate(){const t=this.tremoloEffect.getActiveColors();t.length>0&&h.emit("tremoloAmplitudeUpdate",{activeColors:t})}getAllActiveColors(){const t=this.vibratoEffect.getActiveColors(),e=this.tremoloEffect.getActiveColors();return[...new Set([...t,...e])]}dispose(){this.stop(),this.vibratoEffect.dispose(),this.tremoloEffect.dispose(),this.envelopeFillEffect.dispose(),this.delayEffect.dispose(),E.info("AnimationEffectsManager","Disposed",null,"animation")}}const N0=new sk;E.moduleLoaded("VibratoAudioEffect");class ik{constructor(){I(this,"currentSettings",new Map);E.info("VibratoAudioEffect","Initialized",null,"audio")}init(){return E.info("VibratoAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(t,e){const{speed:s,span:i}=t;this.currentSettings.set(e,{speed:s,span:i}),E.debug("VibratoAudioEffect",`Updated parameters for ${e}`,{speed:s,span:i},"audio")}applyToVoice(t,e){if(!t||typeof t._setVibrato!="function")return;const s=this.currentSettings.get(e);if(!s){E.debug("VibratoAudioEffect",`No vibrato settings found for color ${e}`,null,"audio");return}try{t._setVibrato(s),t.vibratoApplied=!0,E.debug("VibratoAudioEffect",`Applied vibrato to voice for ${e}`,s,"audio")}catch(i){E.warn("VibratoAudioEffect",`Failed to apply vibrato to voice for ${e}`,i,"audio")}}getCurrentSettings(t){return this.currentSettings.get(t)??{speed:0,span:0}}getEffectInstance(){return null}createVibratoSettings(t,e){if(t===0||e===0)return null;const s=t/100*16,i=e/100*50;return{frequency:s,depth:i}}disableForColor(t){this.updateParameters({speed:0,span:0},t)}dispose(){this.currentSettings.clear(),E.info("VibratoAudioEffect","Disposed",null,"audio")}}E.moduleLoaded("TremoloAudioEffect");class rk{constructor(){I(this,"currentSettings",new Map);E.info("TremoloAudioEffect","Initialized",null,"audio")}init(){return E.info("TremoloAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(t,e){const{speed:s,span:i}=t;this.currentSettings.set(e,{speed:s,span:i}),E.debug("TremoloAudioEffect",`Updated parameters for ${e}`,{speed:s,span:i},"audio")}applyToVoice(t,e){if(!t||typeof t._setTremolo!="function")return;const s=this.currentSettings.get(e);if(!s){E.debug("TremoloAudioEffect",`No tremolo settings found for color ${e}`,null,"audio");return}try{t._setTremolo(s),t.tremoloApplied=!0,E.debug("TremoloAudioEffect",`Applied tremolo to voice for ${e}`,s,"audio")}catch(i){E.warn("TremoloAudioEffect",`Failed to apply tremolo to voice for ${e}`,i,"audio")}}getCurrentSettings(t){return this.currentSettings.get(t)??{speed:0,span:0}}getEffectInstance(){return null}createTremoloSettings(t,e){if(t===0||e===0)return null;const s=t/100*16,i=e/100;return{frequency:s,depth:i}}disableForColor(t){this.updateParameters({speed:0,span:0},t)}dispose(){this.currentSettings.clear(),E.info("TremoloAudioEffect","Disposed",null,"audio")}}E.moduleLoaded("DelayAudioEffect");const ok=()=>window.synthEngine;class Ak{constructor(){I(this,"currentSettings",new Map);I(this,"delayInstances",new Map)}init(){return E.info("DelayAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(t,e){var A,a;const{time:s,feedback:i,wet:r}=t;this.currentSettings.set(e,{time:s,feedback:i,wet:r}),E.debug("DelayAudioEffect",`Updated parameters for ${e}`,{time:s,feedback:i,wet:r},"audio");let o=this.delayInstances.get(e);o?this.updateDelayInstance(o,s,i,r):(s>0||i>0)&&(o=this.createDelayInstance(s,i,r),o&&(this.delayInstances.set(e,o),E.debug("DelayAudioEffect",`Created new delay instance for ${e}`,{time:s,feedback:i,wet:r},"audio"),(a=(A=ok())==null?void 0:A.updateSynthForColor)==null||a.call(A,e)))}applyToVoice(t,e){var i,r,o;if(!t)return;const s=this.currentSettings.get(e);if(!(!s||s.time===0&&s.feedback===0))try{let A=this.delayInstances.get(e);if(!A){if(A=this.createDelayInstance(s.time,s.feedback,s.wet),!A)return;this.delayInstances.set(e,A)}if(typeof t.isDisposed=="function"&&t.isDisposed())return;try{(i=t.connect)==null||i.call(t,A)}catch{(o=(r=t.output)==null?void 0:r.connect)==null||o.call(r,A)}E.debug("DelayAudioEffect",`Applied delay to voice for ${e}`,s,"audio")}catch(A){E.warn("DelayAudioEffect",`Failed to apply delay to voice for ${e}`,A,"audio")}}getCurrentSettings(t){return this.currentSettings.get(t)??{time:0,feedback:0,wet:0}}getEffectInstance(t){const e=this.getCurrentSettings(t);return e.time>0&&e.wet>0?this.delayInstances.get(t)??null:null}createDelayInstance(t,e,s=30){if(t===0&&e===0)return null;const i=Math.max(.01,t/100*.5),r=Math.min(.95,e/100),o=s/100,A=new Xf({delayTime:i,feedback:r,wet:o});return A._wetAmount=o,E.debug("DelayAudioEffect","Created delay instance",{delayTime:i,feedbackAmount:r,wetAmount:o},"audio"),A}updateDelayInstance(t,e,s,i=15){const r=Math.max(.01,e/100*.5),o=Math.min(.95,s/100),A=i/100;try{t.delayTime.value=r,t.feedback.value=o,t._crossFade&&(t._crossFade.fade.value=A),t._wetAmount=A,E.debug("DelayAudioEffect","Updated delay instance",{delayTime:r,feedbackAmount:o,wetAmount:A},"audio")}catch(a){E.warn("DelayAudioEffect","Failed to update delay instance",a,"audio")}}createDelaySettings(t,e,s=30){if(t===0&&e===0)return null;const i=Math.max(.01,t/100*.5),r=Math.min(.95,e/100),o=s/100;return{time:i,feedback:r,wet:o}}disableForColor(t){var s;this.updateParameters({time:0,feedback:0,wet:0},t);const e=this.delayInstances.get(t);if(e)try{(s=e._crossFade)==null||s.dispose(),e.dispose()}finally{this.delayInstances.delete(t)}}dispose(){this.delayInstances.forEach((t,e)=>{var s;try{(s=t._crossFade)==null||s.dispose(),t.dispose()}catch(i){E.warn("DelayAudioEffect",`Failed to dispose delay for ${e}`,i,"audio")}}),this.currentSettings.clear(),this.delayInstances.clear(),E.info("DelayAudioEffect","Disposed",null,"audio")}}E.moduleLoaded("AudioEffectsManager");const ak=()=>window.synthEngine;class lk{constructor(){I(this,"vibratoEffect",new ik);I(this,"tremoloEffect",new rk);I(this,"delayEffect",new Ak)}init(){return this.vibratoEffect.init(),this.tremoloEffect.init(),this.delayEffect.init(),h.on("audioEffectChanged",t=>{if(!t)return;const{effectType:e,parameter:s,value:i,color:r,effectParams:o}=t;this.handleAudioEffectChange(e,s,i,r,o)}),E.info("AudioEffectsManager","Event subscriptions established",null,"audio"),!0}handleAudioEffectChange(t,e,s,i,r){switch(E.debug("AudioEffectsManager",`Processing audio effect: ${t}.${e} = ${s} for ${i}`,null,"audio"),t){case"vibrato":this.vibratoEffect.updateParameters(r,i);break;case"tremolo":this.tremoloEffect.updateParameters(r,i);break;case"delay":this.delayEffect.updateParameters(r,i);break;default:E.debug("AudioEffectsManager",`Effect type ${t} not handled by audio system`,null,"audio")}}getEffectHandler(t){switch(t){case"vibrato":return this.vibratoEffect;case"tremolo":return this.tremoloEffect;case"delay":return this.delayEffect;default:return null}}applySynthEffects(t,e,s){var o,A;const i=this.delayEffect.getEffectInstance(e);try{t.disconnect()}catch{}let r=t;if(i)try{r.connect(i),r=i}catch(a){E.error("AudioEffectsManager","Delay connection error",a,"audio")}try{r.connect(s);const a=(A=(o=ak())==null?void 0:o.getWaveformAnalyzer)==null?void 0:A.call(o,e);a&&t.connect(a)}catch(a){E.error("AudioEffectsManager","masterGain connection error",a,"audio")}}applyEffectsToVoice(t,e){this.vibratoEffect.applyToVoice(t,e),this.tremoloEffect.applyToVoice(t,e)}dispose(){this.vibratoEffect.dispose(),this.tremoloEffect.dispose(),this.delayEffect.dispose(),E.info("AudioEffectsManager","Disposed",null,"audio")}}const D0=new lk;E.moduleLoaded("EffectsCoordinator");class ck{constructor(){this.effectParameters=new Map,this.defaultEffects={vibrato:{speed:0,span:0,wet:100},tremolo:{speed:0,span:0,wet:100},delay:{time:0,feedback:0,wet:20}},E.info("EffectsCoordinator","Initialized as main coordinator",null,"effects")}init(){return Object.keys(h.state.timbres).forEach(t=>{this.initializeColorEffects(t)}),h.on("timbreCreated",({color:t})=>{this.initializeColorEffects(t)}),this.loadSavedValues(),E.info("EffectsCoordinator","Event subscriptions established",null,"effects"),!0}initializeColorEffects(t){if(!this.effectParameters.has(t)){const e={};Object.entries(this.defaultEffects).forEach(([i,r])=>{e[i]={...r}}),this.effectParameters.set(t,e);const s=h.state.timbres[t];s&&(s.vibrato&&(e.vibrato={...s.vibrato}),s.tremelo&&(e.tremolo={...s.tremelo})),E.debug("EffectsCoordinator",`Initialized effects for color ${t}`,e,"effects")}}updateParameter(t,e,s,i){if(!i){E.warn("EffectsCoordinator","Cannot update parameter: no color provided",{effectType:t,parameter:e,value:s},"effects");return}this.initializeColorEffects(i);const r=this.effectParameters.get(i);r[t]||(r[t]={...this.defaultEffects[t]}),r[t][e]=s,this.notifyAudioSystem(t,e,s,i,r[t]),this.notifyAnimationSystem(t,e,s,i,r[t]),this.updateTimbreState(t,r[t],i),this.saveValues()}notifyAudioSystem(t,e,s,i,r){h.emit("audioEffectChanged",{effectType:t,parameter:e,value:s,color:i,effectParams:{...r}}),E.debug("EffectsCoordinator",`Notified audio system: ${t}.${e} = ${s} for ${i}`,null,"effects")}notifyAnimationSystem(t,e,s,i,r){(t==="vibrato"||t==="tremolo")&&(h.emit("visualEffectChanged",{effectType:t,parameter:e,value:s,color:i,effectParams:{...r}}),E.debug("EffectsCoordinator",`Notified animation system: ${t}.${e} = ${s} for ${i}`,null,"effects"))}updateTimbreState(t,e,s){const i=h.state.timbres[s];if(!i)return;const o={vibrato:"vibrato",tremolo:"tremelo"}[t];o&&(i[o]||(i[o]={}),Object.assign(i[o],e),h.recordState())}getEffectParameters(t,e){const s=this.effectParameters.get(t);return s!=null&&s[e]?{...s[e]}:{...this.defaultEffects[e]}}getAllEffectParameters(t){const e=this.effectParameters.get(t);return e?{...e}:{...this.defaultEffects}}resetColorEffects(t){const e={};Object.entries(this.defaultEffects).forEach(([s,i])=>{e[s]={...i}}),this.effectParameters.set(t,e),Object.keys(e).forEach(s=>{Object.keys(e[s]).forEach(i=>{this.notifyAudioSystem(s,i,e[s][i],t,e[s]),this.notifyAnimationSystem(s,i,e[s][i],t,e[s])})}),E.info("EffectsCoordinator",`Reset all effects for color ${t}`,e,"effects")}saveValues(){const t={};Object.keys(h.state.timbres).forEach(e=>{const s=this.effectParameters.get(e);s&&(t[e]={vibrato:s.vibrato||{speed:0,span:0,wet:100},tremelo:s.tremolo||{speed:0,span:0,wet:100},delay:s.delay||{time:0,feedback:0,wet:20}})});try{localStorage.setItem("effectDialValues",JSON.stringify(t)),E.debug("EffectsCoordinator","Saved effect values to localStorage",null,"effects")}catch(e){E.warn("EffectsCoordinator","Failed to save effect values to localStorage",e,"effects")}}loadSavedValues(){try{const t=localStorage.getItem("effectDialValues");if(!t){E.debug("EffectsCoordinator","No saved effect values found",null,"effects");return}const e=JSON.parse(t);E.debug("EffectsCoordinator","Loading saved effect values",null,"effects"),Object.keys(e).forEach(s=>{const i=h.state.timbres[s],r=e[s];i&&r&&(r.vibrato&&Object.entries(r.vibrato).forEach(([o,A])=>{typeof A=="number"&&this.updateParameter("vibrato",o,A,s)}),r.tremelo&&Object.entries(r.tremelo).forEach(([o,A])=>{typeof A=="number"&&this.updateParameter("tremolo",o,A,s)}),r.delay&&Object.entries(r.delay).forEach(([o,A])=>{typeof A=="number"&&this.updateParameter("delay",o,A,s)}))}),E.info("EffectsCoordinator","Applied saved effect values",null,"effects"),window.synthEngine&&Object.keys(e).forEach(s=>{const i=e[s];i.delay&&(i.delay.time>0||i.delay.feedback>0)&&(window.synthEngine.updateSynthForColor(s),E.debug("EffectsCoordinator",`Re-applied effects to synth for ${s}`,null,"effects"))})}catch(t){E.warn("EffectsCoordinator","Failed to load saved effect values",t,"effects")}}dispose(){this.effectParameters.clear(),E.info("EffectsCoordinator","Disposed",null,"effects")}}const Ci=new ck;class uk{constructor(){I(this,"currentEffect",null);I(this,"effectControlsContainer",null);I(this,"effectButtons",[]);I(this,"dials",[]);I(this,"currentColor",null);I(this,"isDialInteractionActive",!1);I(this,"lastPreviewAt",{});I(this,"previewThrottleMs",180);I(this,"previewDurationMs",220);I(this,"previewPitch","C4");I(this,"holdPreviews",{});I(this,"effectConfigs",{delay:{name:"Delay",controls:{time:{label:"Time",min:0,max:100,default:0,unit:"%"},feedback:{label:"Echoes",min:0,max:95,default:0,unit:"%"},wet:{label:"Mix",min:0,max:100,default:15,unit:"%"}}},vibrato:{name:"Vibrato",controls:{speed:{label:"Speed",min:0,max:100,default:0,unit:"%"},span:{label:"Span",min:0,max:100,default:0,unit:"%"}}},tremolo:{name:"Tremolo",controls:{speed:{label:"Speed",min:0,max:100,default:0,unit:"%"},span:{label:"Span",min:0,max:100,default:0,unit:"%"}}}})}init(){return E.initStart("Effects Controller"),this.effectControlsContainer=document.getElementById("effect-controls"),this.effectButtons=document.querySelectorAll(".effect-button[data-effect]"),this.effectButtons.length>0&&this.setupEventListeners(),this.initializeSelectedColorTracking(),this.setupGlobalMouseUpHandler(),E.initSuccess("Effects Controller"),!0}setupGlobalMouseUpHandler(){document.addEventListener("mouseup",()=>{this.isDialInteractionActive&&this.onDialInteractionEnd(this.currentEffect)})}setupEventListeners(){this.effectButtons.forEach(t=>{t.addEventListener("click",e=>{const i=e.currentTarget.dataset.effect;i&&this.selectEffect(i)})})}selectEffect(t){if(E.debug("Effects",`Selecting effect: ${t}`,null,"ui"),!this.effectConfigs[t]){E.info("Effects",`Effect ${t} not configured`,null,"ui");return}if(this.effectButtons.forEach(e=>{e.classList.remove("active"),e.dataset.effect===t&&e.classList.add("active")}),this.currentEffect===t){this.currentEffect=null,this.hideEffectControls();return}this.currentEffect=t,this.showEffectControls(t)}showEffectControls(t){const e=this.effectConfigs[t];if(!e||!this.effectControlsContainer){E.warn("Effects",`No configuration found for effect: ${t}`,null,"ui");return}this.clearControls(),this.effectControlsContainer.innerHTML='<div class="effect-controls"></div>';const s=this.effectControlsContainer.querySelector(".effect-controls");s&&Object.entries(e.controls).forEach(([i,r])=>{var f;const o=this.currentColor?(f=Ci.getEffectParameters)==null?void 0:f.call(Ci,this.currentColor,t):null,A=(o==null?void 0:o[i])??r.default??0,a=document.createElement("div");a.className="effect-slider-group",a.style.cssText="margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;",s.appendChild(a);const l=document.createElement("label");l.className="effect-slider-label",l.textContent=r.label,l.style.cssText="display: block; margin-bottom: 5px; font-weight: bold; color: #333;",a.appendChild(l);const c=document.createElement("input");c.type="range",c.min=`${r.min}`,c.max=`${r.max}`,c.value=`${A}`,c.className="effect-slider",c.style.cssText="width: 100%; margin: 5px 0;",a.appendChild(c);const u=document.createElement("div");u.className="effect-slider-value";const d=r.unit?`${Math.round(A)}${r.unit}`:Math.round(A);u.textContent=`${d}`,u.style.cssText="text-align: center; font-size: 12px; color: #666;",a.appendChild(u),this.dials.push({dial:{element:c,value:A,destroy:()=>{}},control:i,effectType:t,valueDisplay:u,controlConfig:r});const p=m=>{const g=m.target;if(!g)return;const w=parseFloat(g.value),B=r.unit?`${Math.round(w)}${r.unit}`:Math.round(w);u.textContent=`${B}`,E.debug("Effects",`${t} ${i}: ${w}`,null,"audio"),this.onEffectParameterChange(t,i,w)};c.addEventListener("input",p),c.addEventListener("change",p),c.addEventListener("mousedown",()=>this.onDialInteractionStart(t)),c.addEventListener("mouseup",()=>this.onDialInteractionEnd(t)),c.addEventListener("mouseleave",m=>{(m.buttons&1)===1&&this.onDialInteractionEnd(t)})})}hideEffectControls(){this.clearControls(),this.currentEffect=null}clearControls(){this.dials.forEach(t=>t.dial.destroy()),this.dials=[],this.effectControlsContainer&&(this.effectControlsContainer.innerHTML="")}onEffectParameterChange(t,e,s){var r;const i=this.currentColor||((r=h.state.selectedNote)==null?void 0:r.color);i&&Ci.updateParameter(t,e,s,i)}updateEffect(t,e){var i;const s=this.currentColor||((i=h.state.selectedNote)==null?void 0:i.color);s&&Object.entries(e).forEach(([r,o])=>{typeof o=="number"&&Ci.updateParameter(t,r,o,s)})}getEffectState(t){var s;const e=this.currentColor||((s=h.state.selectedNote)==null?void 0:s.color);return e?Ci.getEffectParameters(e,t)||{}:{}}getActiveColor(){var t;return this.currentColor||((t=h.state.selectedNote)==null?void 0:t.color)||null}getPreviewNotes(){var o;const t=this.getActiveColor();if(!t)return null;const e=h.state.placedNotes.slice().reverse().find(A=>!A.isDrum),s=e?((o=h.state.fullRowData[e.row])==null?void 0:o.toneNote)||this.previewPitch:this.previewPitch,i=h.state.selectedTool;let r=[s];return i==="chord"&&Array.isArray(h.state.activeChordIntervals)&&(r=h.state.activeChordIntervals.map(a=>BA(ho(s,a)))),{pitches:r,root:s,color:t}}previewEffect(t){var a;const e=this.getActiveColor();if(!e)return;const s=Date.now(),i=this.lastPreviewAt[t]??0;if(s-i<this.previewThrottleMs)return;this.lastPreviewAt[t]=s;const{isPlaying:r,isPaused:o}=h.state;if(r&&!o)return;const A=`effect-preview-${t}`;(a=h.emit)==null||a.call(h,"noteAttack",{noteId:A,color:e});try{kt.triggerAttack(this.previewPitch,e),setTimeout(()=>kt.triggerRelease(this.previewPitch,e),this.previewDurationMs)}catch(l){E.warn("Effects","Preview trigger failed",{err:l},"audio")}finally{setTimeout(()=>{var l;return(l=h.emit)==null?void 0:l.call(h,"noteRelease",{noteId:A,color:e})},this.previewDurationMs)}}startHoldPreview(t){var d;if(this.holdPreviews[t])return;const e=this.getPreviewNotes();if(!e)return;const{pitches:s,root:i,color:r}=e,o=`effect-hold-${t}-${Date.now()}`;this.holdPreviews[t]={pitches:s,root:i,color:r,noteId:o};const{isPlaying:A,isPaused:a}=h.state;if(A&&!a)return;s.forEach(p=>kt.triggerAttack(p,r));const l=h.state.fullRowData.find(p=>p.toneNote===i),c=l?l.hex:"#888888",u=h.state.timbres[r];u&&((d=Rn.adsrComponent)==null||d.playheadManager.trigger(o,"attack",c,u.adsr)),h.emit("spacebarPlayback",{note:i,color:r,isPlaying:!0}),h.emit("noteAttack",{noteId:o,color:r})}stopHoldPreview(t){var c;const e=this.holdPreviews[t];if(!e)return;delete this.holdPreviews[t];const{pitches:s,root:i,color:r,noteId:o}=e;s.forEach(u=>kt.triggerRelease(u,r));const A=h.state.fullRowData.find(u=>u.toneNote===i),a=A?A.hex:"#888888",l=h.state.timbres[r];l&&((c=Rn.adsrComponent)==null||c.playheadManager.trigger(o,"release",a,l.adsr)),h.emit("spacebarPlayback",{note:i,color:r,isPlaying:!1}),h.emit("noteRelease",{noteId:o,color:r})}initializeSelectedColorTracking(){var t;h.on("noteChanged",({newNote:e}={})=>{this.currentColor=(e==null?void 0:e.color)||null,this.currentColor&&this.currentEffect&&this.showEffectControls(this.currentEffect)}),this.currentColor=((t=h.state.selectedNote)==null?void 0:t.color)||null}onDialInteractionStart(t){if(this.isDialInteractionActive=!0,t){E.debug("Effects",`Dial interaction start for ${t}`,null,"ui");const e=this.getActiveColor();e&&h.emit("effectDialInteractionStart",{effectType:t,color:e}),this.startHoldPreview(t)}}onDialInteractionEnd(t){if(this.isDialInteractionActive=!1,t){E.debug("Effects",`Dial interaction end for ${t}`,null,"ui");const e=this.getActiveColor();e&&h.emit("effectDialInteractionEnd",{effectType:t,color:e}),this.stopHoldPreview(t)}}}const bi=new uk;class dk{constructor(){I(this,"listeners",new Map)}on(t,e){const s=this.listeners.get(t)||[];s.push(e),this.listeners.set(t,s)}off(t,e){const s=this.listeners.get(t);if(!s)return;const i=s.indexOf(e);i>=0&&s.splice(i,1)}emit(t,e){const s=this.listeners.get(t);s&&s.slice().forEach(i=>i(e))}}class gb{constructor(t,e={}){I(this,"_root");I(this,"_svgWrapper");I(this,"_bg");I(this,"_gridFill");I(this,"_gridPatternRect");I(this,"_dial");I(this,"_crosshairV");I(this,"_crosshairH");I(this,"_label");I(this,"_em",new dk);I(this,"_patternId");I(this,"_size");I(this,"_mode");I(this,"_minX");I(this,"_maxX");I(this,"_stepX");I(this,"_minY");I(this,"_maxY");I(this,"_stepY");I(this,"_reverseX");I(this,"_x");I(this,"_y");I(this,"_normX");I(this,"_normY");I(this,"_dragging",!1);I(this,"colors",{accent:"#4a90e2",fill:"#1f1f1f",stroke:"#555",grid:"#333",text:"#fff"});if(this._root=typeof t=="string"?document.querySelector(t):t,!this._root)throw new Error("Position: target not found");const{size:s=[200,200],mode:i="absolute",x:r=.5,minX:o=0,maxX:A=1,stepX:a=0,y:l=.5,minY:c=0,maxY:u=1,stepY:d=0,reverseX:p=!1,colors:f}=e;this._patternId=`pos-grid-${Math.random().toString(36).slice(2,8)}`;try{const w=getComputedStyle(document.documentElement),B=w.getPropertyValue("--c-surface").trim(),b=w.getPropertyValue("--c-border").trim(),_=w.getPropertyValue("--c-border-strong").trim(),v=w.getPropertyValue("--c-text").trim();this.colors={...this.colors,fill:B||this.colors.fill,stroke:b||this.colors.stroke,grid:_||this.colors.grid,text:v||this.colors.text}}catch{}this._size=s,this._mode=i,this._minX=o,this._maxX=A,this._stepX=a,this._minY=c,this._maxY=u,this._stepY=d,this._reverseX=p,f&&(this.colors={...this.colors,...f}),this._x=r,this._y=l,this._normX=0,this._normY=0,this._svgWrapper=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._svgWrapper.setAttribute("width",`${s[0]}`),this._svgWrapper.setAttribute("height",`${s[1]}`),this._svgWrapper.setAttribute("viewBox",`0 0 ${s[0]} ${s[1]}`),this._svgWrapper.style.touchAction="none";const m=document.createElementNS("http://www.w3.org/2000/svg","defs"),g=document.createElementNS("http://www.w3.org/2000/svg","pattern");g.setAttribute("id",this._patternId),g.setAttribute("width","20"),g.setAttribute("height","20"),g.setAttribute("patternUnits","userSpaceOnUse"),this._gridPatternRect=document.createElementNS("http://www.w3.org/2000/svg","rect"),this._gridPatternRect.setAttribute("width","20"),this._gridPatternRect.setAttribute("height","20"),this._gridPatternRect.setAttribute("fill","none"),this._gridPatternRect.setAttribute("stroke",this.colors.grid),this._gridPatternRect.setAttribute("stroke-width","1"),g.appendChild(this._gridPatternRect),m.appendChild(g),this._svgWrapper.appendChild(m),this._bg=document.createElementNS("http://www.w3.org/2000/svg","rect"),this._bg.setAttribute("x","0"),this._bg.setAttribute("y","0"),this._bg.setAttribute("width",`${s[0]}`),this._bg.setAttribute("height",`${s[1]}`),this._bg.setAttribute("fill",this.colors.fill),this._bg.setAttribute("stroke",this.colors.stroke),this._svgWrapper.appendChild(this._bg),this._gridFill=document.createElementNS("http://www.w3.org/2000/svg","rect"),this._gridFill.setAttribute("x","0"),this._gridFill.setAttribute("y","0"),this._gridFill.setAttribute("width",`${s[0]}`),this._gridFill.setAttribute("height",`${s[1]}`),this._gridFill.setAttribute("fill",`url(#${this._patternId})`),this._gridFill.setAttribute("opacity","0.2"),this._svgWrapper.appendChild(this._gridFill),this._crosshairV=document.createElementNS("http://www.w3.org/2000/svg","line"),this._crosshairH=document.createElementNS("http://www.w3.org/2000/svg","line"),[this._crosshairV,this._crosshairH].forEach(w=>{w.setAttribute("stroke",this.colors.grid),w.setAttribute("stroke-width","1"),w.setAttribute("opacity","0.6"),this._svgWrapper.appendChild(w)}),this._dial=document.createElementNS("http://www.w3.org/2000/svg","circle"),this._dial.setAttribute("r","10"),this._dial.setAttribute("fill",this.colors.accent),this._dial.setAttribute("stroke","#fff"),this._dial.setAttribute("stroke-width","2"),this._svgWrapper.appendChild(this._dial),this._label=document.createElementNS("http://www.w3.org/2000/svg","text"),this._label.setAttribute("x","8"),this._label.setAttribute("y",`${s[1]-8}`),this._label.setAttribute("fill",this.colors.text),this._label.setAttribute("font-size","12"),this._label.setAttribute("font-family","monospace"),this._label.setAttribute("opacity","0"),this._label.textContent="",this._svgWrapper.appendChild(this._label),this._root.innerHTML="",this._root.appendChild(this._svgWrapper),this._bind(),this.setColors(),this._updateFromValues()}debugLog(...t){}on(t,e){return this._em.on(t,e),()=>this._em.off(t,e)}get value(){return{x:this._x,y:this._y}}get normalized(){return{x:this._normX,y:this._normY}}set x(t){this._x=this._clamp(this._maybeStep(t,this._minX,this._maxX,this._stepX),this._minX,this._maxX),this._updateFromValues()}get x(){return this._x}set y(t){this._y=this._clamp(this._maybeStep(t,this._minY,this._maxY,this._stepY),this._minY,this._maxY),this._updateFromValues()}get y(){return this._y}set minX(t){this._minX=t,this._updateFromValues()}set maxX(t){this._maxX=t,this._updateFromValues()}set minY(t){this._minY=t,this._updateFromValues()}set maxY(t){this._maxY=t,this._updateFromValues()}set stepX(t){this._stepX=t}set stepY(t){this._stepY=t}resize(t,e){this._size=[t,e],this._svgWrapper.setAttribute("width",`${t}`),this._svgWrapper.setAttribute("height",`${e}`),this._svgWrapper.setAttribute("viewBox",`0 0 ${t} ${e}`),this._label.setAttribute("y",`${e-8}`),this._updateFromValues()}destroy(){this._root.innerHTML=""}setColors(t={}){this.colors={...this.colors,...t},this._bg.setAttribute("fill",this.colors.fill),this._bg.setAttribute("stroke",this.colors.stroke),this._gridPatternRect.setAttribute("stroke",this.colors.grid),this._gridFill.setAttribute("fill",`url(#${this._patternId})`),this._crosshairV.setAttribute("stroke",this.colors.grid),this._crosshairH.setAttribute("stroke",this.colors.grid),this._dial.setAttribute("fill",this.colors.accent),this._label.setAttribute("fill",this.colors.text)}_updateFromValues(){if(this._x===this._minX&&this._y===this._minY)this.debugLog("At origin (off state)",{x:this._x,y:this._y});else{const s=this._x,i=this._y;if(this._x===this._minX){const r=this._stepX>0?this._stepX:Math.max((this._maxX-this._minX)/100,.01);this._x=this._minX+r}if(this._y===this._minY){const r=this._stepY>0?this._stepY:Math.max((this._maxY-this._minY)/100,.01);this._y=this._minY+r}this.debugLog("Adjusted single-axis zero",{from:{x:s,y:i},to:{x:this._x,y:this._y}})}const t=(this._x-this._minX)/(this._maxX-this._minX||1),e=(this._y-this._minY)/(this._maxY-this._minY||1);this._normX=this._clamp(t,0,1),this._normY=this._clamp(e,0,1),this._updateGraphics(),this._em.emit("change",{x:this._x,y:this._y})}_updateGraphics(){const[t,e]=this._size,s=this._reverseX?(1-this._normX)*t:this._normX*t,i=this._mode==="absolute"?this._normY*e:(1-this._normY)*e;this._dial.setAttribute("cx",`${s}`),this._dial.setAttribute("cy",`${i}`),this._crosshairV.setAttribute("x1",`${s}`),this._crosshairV.setAttribute("x2",`${s}`),this._crosshairV.setAttribute("y1","0"),this._crosshairV.setAttribute("y2",`${e}`),this._crosshairH.setAttribute("x1","0"),this._crosshairH.setAttribute("x2",`${t}`),this._crosshairH.setAttribute("y1",`${i}`),this._crosshairH.setAttribute("y2",`${i}`),this._label.textContent=`x:${this._x.toFixed(3)} y:${this._y.toFixed(3)}`}_bind(){const t=i=>{var r,o;this._dragging=!0,this._handlePointer(i),(o=(r=i.target).setPointerCapture)==null||o.call(r,i.pointerId)},e=i=>{this._dragging&&this._handlePointer(i)},s=i=>{var r,o;this._dragging=!1,(o=(r=i.target).releasePointerCapture)==null||o.call(r,i.pointerId)};this._svgWrapper.addEventListener("pointerdown",t),this._svgWrapper.addEventListener("pointermove",e),this._svgWrapper.addEventListener("pointerup",s),this._svgWrapper.addEventListener("pointercancel",s)}_handlePointer(t){const e=this._svgWrapper.getBoundingClientRect(),s=(t.clientX-e.left)/e.width,i=this._reverseX?1-s:s,r=(t.clientY-e.top)/e.height;this._normX=this._clamp(i,0,1);const o=this._mode==="relative"?1-r:r;if(this._normY=this._clamp(o,0,1),this._x=this._minX+this._normX*(this._maxX-this._minX),this._y=this._minY+this._normY*(this._maxY-this._minY),this.debugLog("Pointer move",{raw:{nx:i,ny:r},norm:{x:this._normX,y:this._normY},value:{x:this._x,y:this._y},mode:this._mode}),this._stepX>0){const A=this._maybeStep(this._x,this._minX,this._maxX,this._stepX);this._x=A}if(this._stepY>0){const A=this._maybeStep(this._y,this._minY,this._maxY,this._stepY);this._y=A}if(!(this._x===this._minX&&this._y===this._minY)){if(this._x===this._minX){const A=this._stepX>0?this._stepX:Math.max((this._maxX-this._minX)/100,.01);this._x=this._minX+A}if(this._y===this._minY){const A=this._stepY>0?this._stepY:Math.max((this._maxY-this._minY)/100,.01);this._y=this._minY+A}}this._normX=this._clamp((this._x-this._minX)/(this._maxX-this._minX||1),0,1),this._normY=this._clamp((this._y-this._minY)/(this._maxY-this._minY||1),0,1),this._updateGraphics(),this._em.emit("change",{x:this._x,y:this._y})}_maybeStep(t,e,s,i){if(i<=0)return t;const r=t-e,o=Math.round(r/i),A=e+o*i;return this._clamp(A,e,s)}_clamp(t,e,s){return Math.max(e,Math.min(s,t))}}I(gb,"DEBUG",!1);E.moduleLoaded("CartesianSliderController");class hk{constructor(){I(this,"sliders",{});I(this,"resizeObservers",[]);I(this,"effectConfigs");I(this,"isDragging",{});this.effectConfigs={delay:{containerId:"delay-position",xParam:"time",yParam:"feedback",xRange:{min:0,max:100,step:1},yRange:{min:0,max:95,step:1},backgroundOpacity:.2},vibrato:{containerId:"vibrato-position",xParam:"speed",yParam:"span",xRange:{min:0,max:100,step:1},yRange:{min:0,max:100,step:1},backgroundOpacity:.5},tremolo:{containerId:"tremolo-position",xParam:"speed",yParam:"span",xRange:{min:0,max:100,step:1},yRange:{min:0,max:100,step:1},backgroundOpacity:.5}},E.info("CartesianSliderController","Initialized",null,"ui")}init(){return E.initStart("Cartesian Slider Controller"),Object.entries(this.effectConfigs).forEach(([t,e])=>{this.createSliderComponent(t,e)}),this.initializeColorTracking(),E.initSuccess("Cartesian Slider Controller"),!0}createSliderComponent(t,e){const s=document.getElementById(e.containerId);if(!s){E.warn("CartesianSliderController",`Container not found for ${t}`,{containerId:e.containerId},"ui");return}try{t==="delay"&&setTimeout(()=>{console.group("[Effects Width Debug]");const l=document.querySelector(".position-controls-container"),c=document.querySelector(".effects-content-box"),u=document.getElementById("effects-panel"),d=document.querySelector(".preset-effects-content"),p=document.querySelector(".preset-effects-controls"),f=(m,g)=>{if(!g){console.log(`${m}: NOT FOUND`);return}const w=getComputedStyle(g),B=g.getBoundingClientRect();console.log(`${m}:`,{actualWidth:B.width,computedWidth:w.width,flex:`${w.flexGrow} ${w.flexShrink} ${w.flexBasis}`,minWidth:w.minWidth,maxWidth:w.maxWidth})};f("position-controls-container",l),f("effects-content-box",c),f("effects-panel",u),f("preset-effects-content",d),f("preset-effects-controls",p),console.groupEnd()},100);const[i,r]=this.getSliderComponentSize(s),o=new gb(s,{size:[i,r],mode:"relative",x:e.xRange.min,minX:e.xRange.min,maxX:e.xRange.max,stepX:e.xRange.step,y:e.yRange.min,minY:e.yRange.min,maxY:e.yRange.max,stepY:e.yRange.step});this.sliders[t]=o,this.observeSliderResize(s,o,i,r),o.on("change",({x:l,y:c})=>{this.onSliderChange(t,e.xParam,l,e.yParam,c)});const A=()=>{this.isDragging[t]=!0,this.onSliderInteractionStart(t),bi.startHoldPreview(t)},a=()=>{this.isDragging[t]&&(this.isDragging[t]=!1,this.onSliderInteractionEnd(t),bi.stopHoldPreview(t))};s.addEventListener("pointerdown",A),["pointerup","pointerleave","pointercancel"].forEach(l=>{s.addEventListener(l,a)}),this.loadInitialValues(t,e,o),E.debug("CartesianSliderController",`Created slider component for ${t}`,null,"ui")}catch(i){E.error("CartesianSliderController",`Failed to create slider component for ${t}`,i,"ui")}}getSliderComponentSize(t){const s=t.getBoundingClientRect();let i=(s==null?void 0:s.width)||t.clientWidth||t.offsetWidth||120,r=(s==null?void 0:s.height)||t.clientHeight||t.offsetHeight||i;return(!i||i<10)&&(i=120),(!r||r<10)&&(r=i),[Math.round(i),Math.round(r)]}observeSliderResize(t,e,s,i){if(typeof ResizeObserver>"u")return;const r={currentWidth:Math.round(s)||0,currentHeight:Math.round(i)||0},o=new ResizeObserver(A=>{for(const a of A){const{width:l,height:c}=a.contentRect,u=Math.round(l),d=Math.round(c||l);!u||!d||u===r.currentWidth&&d===r.currentHeight||(r.currentWidth=u,r.currentHeight=d,e.resize(u,d))}});o.observe(t),this.resizeObservers.push(o)}onSliderChange(t,e,s,i,r){bi.updateEffect(t,{[e]:s,[i]:r})}onSliderInteractionStart(t){const e=bi.getActiveColor();E.debug("CartesianSliderController",`Interaction start for ${t}`,null,"ui"),h.emit("effectDialInteractionStart",{effectType:t,color:e})}onSliderInteractionEnd(t){const e=bi.getActiveColor();E.debug("CartesianSliderController",`Interaction end for ${t}`,null,"ui"),h.emit("effectDialInteractionEnd",{effectType:t,color:e})}loadInitialValues(t,e,s){const i=bi.getEffectState(t)||{},r=i[e.xParam],o=i[e.yParam],A=typeof r=="number"?r:e.xRange.min,a=typeof o=="number"?o:e.yRange.min;s.x=A,s.y=a}initializeColorTracking(){var t;h.on("noteChanged",({newNote:e}={})=>{e!=null&&e.color&&this.applyColorPalette(e.color)}),(t=h.state.selectedNote)!=null&&t.color&&this.applyColorPalette(h.state.selectedNote.color)}applyColorPalette(t){const e=h.state.colorPalette[t]||{primary:t,light:t},s=(A,a)=>{const l=f=>Math.max(0,Math.min(255,f)),c=A.replace("#",""),u=l(parseInt(c.slice(0,2),16)+a),d=l(parseInt(c.slice(2,4),16)+a),p=l(parseInt(c.slice(4,6),16)+a);return`#${u.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}${p.toString(16).padStart(2,"0")}`},i=e.primary,r=e.light||s(i,80),o=(A,a)=>{const l=A.replace("#",""),c=parseInt(l.slice(0,2),16),u=parseInt(l.slice(2,4),16),d=parseInt(l.slice(4,6),16);return`rgba(${c}, ${u}, ${d}, ${a})`};Object.entries(this.sliders).forEach(([A,a])=>{const l=this.effectConfigs[A],c=(l==null?void 0:l.backgroundOpacity)??.5;a.setColors({accent:e.primary,fill:o(r,c),stroke:"#c3c9d0",grid:"#d7dce4",text:"#3c4048"})})}}const L0=new hk;function fk(){O5(),SN(),q5(),E.initStart("Waveform Visualizer"),J5()?E.initSuccess("Waveform Visualizer"):E.initFailed("Waveform Visualizer"),E.initStart("Effects Managers"),N0.init(),D0.init(),Ci.init(),bi.init(),L0.init();const n=window;n.effectsCoordinator=Ci,n.animationEffectsManager=N0,n.audioEffectsManager=D0,n.effectsController=bi,n.cartesianSliderController=L0,E.initSuccess("Effects Managers")}function pk({cx:n,cy:t,rx:e,ry:s,stroke:i="currentColor",strokeWidth:r=3}){const o=document.createElementNS("http://www.w3.org/2000/svg","ellipse");return o.setAttribute("cx",`${n}`),o.setAttribute("cy",`${t}`),o.setAttribute("rx",`${e}`),o.setAttribute("ry",`${s}`),o.setAttribute("fill","none"),o.setAttribute("stroke",i),o.setAttribute("stroke-width",`${r}`),o.setAttribute("stroke-linecap","round"),o}function mk(n,t=48,e=48){const s=document.createElementNS("http://www.w3.org/2000/svg","svg"),i=n.span==="quarter",r=i?200:100;s.setAttribute("viewBox",`0 0 ${r} 100`),s.setAttribute("width",`${t}`),s.setAttribute("height",`${e}`),s.setAttribute("aria-label",n.label),s.style.color="#000000";const A=50,a=i?32:16,l=40,c=i?[33.33,100,166.67]:[16.67,50,83.33];return n.hits.forEach(u=>{const d=pk({cx:c[u]??0,cy:A,rx:a,ry:l,stroke:"currentColor",strokeWidth:3});s.appendChild(d)}),s}const ca={selectedTripletStampId:1,init(){this.render(),this.bindEvents(),E.info("TripletStampsToolbar","Triplet stamps toolbar initialized",null,"triplets")},render(){const n=document.getElementById("triplet-stamps-toolbar-container");if(!n){E.warn("TripletStampsToolbar","Container not found",null,"triplets");return}n.innerHTML="";const t=Tl.filter(i=>i.span==="eighth"),e=Tl.filter(i=>i.span==="quarter"),s=document.createElement("div");if(s.className="triplet-stamps-grid",t.length>0){const i=document.createElement("div");i.className="triplet-stamps-row triplet-stamps-eighth-row",t.forEach(r=>{const o=this.createTripletStampButton(r);i.appendChild(o)}),s.appendChild(i)}if(e.length>0){const i=document.createElement("div");if(i.className="triplet-stamps-row triplet-stamps-quarter-row",e.slice(0,3).forEach(r=>{const o=this.createTripletStampButton(r);o.classList.add("triplet-stamp-button-wide"),i.appendChild(o)}),s.appendChild(i),e.length>3){const r=document.createElement("div");r.className="triplet-stamps-row triplet-stamps-quarter-row",e.slice(3).forEach(o=>{const A=this.createTripletStampButton(o);A.classList.add("triplet-stamp-button-wide"),r.appendChild(A)}),s.appendChild(r)}}n.appendChild(s),this.setInitialSelection(this.selectedTripletStampId)},createTripletStampButton(n){const t=document.createElement("button");t.className="triplet-stamp-button",t.dataset.tripletStampId=`${n.id}`,t.setAttribute("title",n.label||`Triplet ${n.id}`);const s=n.span==="quarter"?80:40,r=mk(n,s,40);return r.style.width="100%",r.style.height="100%",r.style.maxWidth="100%",r.style.maxHeight="100%",t.appendChild(r),t},bindEvents(){const n=document.getElementById("triplet-stamps-toolbar-container");n&&(n.addEventListener("click",t=>{var i;const e=(i=t.target)==null?void 0:i.closest(".triplet-stamp-button");if(!e)return;const s=parseInt(e.dataset.tripletStampId||"",10);Number.isNaN(s)||this.selectTripletStamp(s)}),h.on("toolChanged",({newTool:t}={})=>{t&&t!=="tripletStamp"&&this.clearSelection()}),h.on("sixteenthStampToolSelected",()=>{this.clearSelection()}))},setInitialSelection(n){this.selectedTripletStampId=n;const t=document.getElementById("triplet-stamps-toolbar-container");t&&t.querySelectorAll(".triplet-stamp-button").forEach(e=>{const s=e;s.classList.toggle("active",parseInt(s.dataset.tripletStampId||"",10)===n)})},selectTripletStamp(n){this.selectedTripletStampId=n;const t=document.getElementById("triplet-stamps-toolbar-container");t&&t.querySelectorAll(".triplet-stamp-button").forEach(e=>{const s=e;s.classList.toggle("active",parseInt(s.dataset.tripletStampId||"",10)===n)}),h.setSelectedTool("tripletStamp"),h.emit("tripletStampSelected",n),h.emit("tripletStampToolSelected")},clearSelection(){const n=document.getElementById("triplet-stamps-toolbar-container");n&&n.querySelectorAll(".triplet-stamp-button").forEach(t=>{t.classList.remove("active")})},getSelectedTripletStamp(){return Tl.find(t=>t.id===this.selectedTripletStampId)}};function gk(){var n,t;QQ.init(),((n=se.initialize)==null?void 0:n.call(se))??((t=se.init)==null||t.call(se)),Eu.init(),ca.init(),E.initSuccess("RhythmUi")}class wk{constructor(){I(this,"gridsWrapper",null);I(this,"pitchGridWrapper",null);I(this,"drumGridWrapper",null);I(this,"gridScrollbarProxy",null);I(this,"isInitialized",!1);I(this,"lastScrollTime",0);I(this,"isSyncingFromProxy",!1);I(this,"isSyncingFromWrapper",!1);I(this,"handleWrapperScroll");I(this,"handleProxyScroll")}init(){if(this.gridsWrapper=document.getElementById("grids-wrapper"),this.pitchGridWrapper=document.getElementById("pitch-grid-wrapper"),this.drumGridWrapper=document.getElementById("drum-grid-wrapper"),this.gridScrollbarProxy=document.getElementById("grid-scrollbar-proxy"),!this.gridsWrapper||!this.pitchGridWrapper||!this.drumGridWrapper){E.error("ScrollSyncService","Required elements not found for scroll sync",null,"scroll");return}this.setupScrollSynchronization(),this.isInitialized=!0,E.info("ScrollSyncService","Initialized with unified grids-wrapper structure",null,"scroll")}setupScrollSynchronization(){this.handleWrapperScroll=this.handleWrapperScrollInternal.bind(this),this.handleProxyScroll=this.handleProxyScrollInternal.bind(this),this.gridsWrapper.addEventListener("scroll",this.handleWrapperScroll,{passive:!0}),this.gridScrollbarProxy?this.gridScrollbarProxy.addEventListener("scroll",this.handleProxyScroll,{passive:!0}):E.warn("ScrollSyncService","Grid scrollbar proxy not found; falling back to native scrollbars.",null,"scroll")}handleWrapperScrollInternal(t){if(this.isSyncingFromProxy||!this.gridsWrapper)return;const e=Date.now();if(this.lastScrollTime=e,this.gridScrollbarProxy){const i=this.gridsWrapper.scrollLeft;Math.abs(this.gridScrollbarProxy.scrollLeft-i)>.5&&(this.isSyncingFromWrapper=!0,this.gridScrollbarProxy.scrollLeft=i,this.isSyncingFromWrapper=!1)}const s=t.target;E.debug("ScrollSyncService",`Unified scroll: ${(s==null?void 0:s.scrollLeft)??0}px`,null,"scroll")}handleProxyScrollInternal(){if(this.isSyncingFromWrapper||!this.gridScrollbarProxy)return;const t=this.gridScrollbarProxy.scrollLeft;this.gridsWrapper&&Math.abs(this.gridsWrapper.scrollLeft-t)>.5&&(this.isSyncingFromProxy=!0,this.gridsWrapper.scrollLeft=t,this.isSyncingFromProxy=!1)}syncScrollTo(t){!this.isInitialized||!this.gridsWrapper||(this.isSyncingFromProxy=!0,this.isSyncingFromWrapper=!0,this.gridsWrapper.scrollLeft=t,this.gridScrollbarProxy&&(this.gridScrollbarProxy.scrollLeft=t),this.isSyncingFromProxy=!1,this.isSyncingFromWrapper=!1)}}const vk=new wk,_d={stroke:"#c7cfd8",background:"rgba(207, 214, 222, 0.32)"};let Cl=null;function wb(){if(Cl)return Cl;if(typeof window>"u")return _d;const n=window.getComputedStyle(document.documentElement);return Cl={stroke:n.getPropertyValue("--c-anacrusis-border").trim()||_d.stroke,background:n.getPropertyValue("--c-anacrusis-bg").trim()||_d.background},Cl}function Bk(n){if(n.length===0)return[];const t=[...n].sort((s,i)=>s.start-i.start),e=[];for(const s of t){if(e.length===0){e.push({...s});continue}const i=e[e.length-1];s.start<=i.end?i.end=Math.max(i.end,s.end):e.push({...s})}return e}function Ck(n){const t=[],e=yk(h.state);return e!==null&&e>0&&t.push({start:or(0,n),end:or(e,n)}),n.placedTonicSigns.forEach(s=>{const i=or(s.columnIndex,n),r=or(s.columnIndex+2,n);t.push({start:i,end:r})}),Bk(t)}function bk(n,t,e){const s=new Set([n,t]);e.forEach(o=>{const A=Math.max(n,Math.min(t,o.start)),a=Math.max(n,Math.min(t,o.end));a>A&&(s.add(A),s.add(a))});const i=Array.from(s).sort((o,A)=>o-A),r=[];for(let o=0;o<i.length-1;o++){const A=i[o],a=i[o+1],l=(A+a)/2,c=e.some(u=>l>=u.start&&l<u.end);a>A&&r.push({from:A,to:a,light:c})}return r}function yk(n){if(!n.hasAnacrusis||!Array.isArray(n.macrobeatBoundaryStyles))return null;const t=n.macrobeatBoundaryStyles.findIndex(s=>s==="solid");if(t<0)return null;const e=dn(n,t);return e?e.endColumn+1:null}function or(n,t){return it(n,t)}function vb(n,t,e,s,i,r,o=1){const A=e+i/2,a=s+r/2,l=Math.min(i,r)*.4*o;if(n.beginPath(),t===0)n.moveTo(A,a-l),n.lineTo(A-l,a+l),n.lineTo(A+l,a+l),n.closePath();else if(t===1)n.moveTo(A,a-l),n.lineTo(A+l,a),n.lineTo(A,a+l),n.lineTo(A-l,a),n.closePath();else{for(let u=0;u<5;u++){const d=2*Math.PI/5*u-Math.PI/2,p=A+l*Math.cos(d),f=a+l*Math.sin(d);u===0?n.moveTo(p,f):n.lineTo(p,f)}n.closePath()}n.fill()}function Sk(n,t){const{columnWidths:e,musicalColumnWidths:s,macrobeatGroupings:i,macrobeatBoundaryStyles:r,placedTonicSigns:o}=t,a=(s&&s.length>0?s:e).length,l=i.map((c,u)=>{const{endColumn:d}=dn(h.state,u);return d+1});for(let c=0;c<=a;c++){const u=c===0||c===a,d=Vv(c,o),p=o.some(B=>c===B.columnIndex+2),f=l.includes(c);if(!Wv(c,o))continue;let g=null;if(u||d||p)g={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(f){const B=l.indexOf(c),b=r[B];if(b==="anacrusis"){const{stroke:_}=wb();g={lineWidth:1,strokeStyle:_,dash:[4,4]}}else g={lineWidth:1,strokeStyle:"#adb5bd",dash:b==="solid"?[]:[5,5]}}if(!g)continue;const w=or(c,t);n.beginPath(),n.moveTo(w,0),n.lineTo(w,ie(n.canvas)),n.lineWidth=g.lineWidth,n.strokeStyle=g.strokeStyle,n.setLineDash(g.dash),n.stroke()}n.setLineDash([])}function Ek(n,t){const{placedNotes:e,columnWidths:s,cellWidth:i,cellHeight:r,placedTonicSigns:o}=t;n.clearRect(0,0,He(n.canvas),ie(n.canvas));const A=Math.max(zA,XA*r),a=s.length,l=["H","M","L"],c=Ck(t),u=bk(0,He(n.canvas),c),{stroke:d}=wb();for(let p=0;p<4;p++){const f=p*A;u.forEach(m=>{m.to<=m.from||(n.beginPath(),n.moveTo(m.from,f),n.lineTo(m.to,f),n.strokeStyle=m.light?d:"#ced4da",n.lineWidth=1,n.globalAlpha=m.light?.6:1,n.stroke(),n.globalAlpha=1)})}Sk(n,t);for(let p=0;p<a;p++){if(o.some(g=>p===g.columnIndex||p===g.columnIndex+1))continue;const f=or(p,t);let m;t.modulationMarkers&&t.modulationMarkers.length>0?m=or(p+1,t)-f:m=(s[p]??0)*i;for(let g=0;g<3;g++){const w=g*A,B=l[g],b=e.find(_=>_.isDrum&&(typeof _.drumTrack=="number"?String(_.drumTrack):_.drumTrack)===B&&_.startColumnIndex===p);if(b){n.fillStyle=b.color;const _=ei.getAnimationScale(p,B);vb(n,g,f,w,m,A,_)}else n.fillStyle="#ced4da",n.beginPath(),n.arc(f+m/2,w+A/2,2,0,Math.PI*2),n.fill()}}t.modulationMarkers&&t.modulationMarkers.length>0&&iB(n,t)}const Qs={getColumnIndex(n){const{cellWidth:t,modulationMarkers:e,cellHeight:s,musicalColumnWidths:i}=h.state,r=h.state.columnWidths||[];if(t===0)return 0;const o={...h.state,modulationMarkers:e,cellWidth:t,columnWidths:r,baseMicrobeatPx:h.state.baseMicrobeatPx||t},A=Jd(n,o),a=Math.floor(A);return a},getPitchRowIndex(n){const t=je.getViewportInfo();if(!(t!=null&&t.halfUnit)||t.halfUnit===0)return-1;const e=t.halfUnit,s=Math.round(n/e-1),i=t.startRank+s,r=t.startRank,o=Math.max(r,(t.endRank??r+1)-1);return Math.max(r,Math.min(o,i))},getDrumRowIndex(n){const t=Math.max(zA,XA*h.state.cellHeight);return t===0?-1:Math.floor(n/t)}},kp=["H","M","L"],xk="canvas-container",_k="drum-grid-wrapper",Bb="eraser-tool-button",Ik="drum-grid",Fk="drum-hover-canvas";let An=null,Fc=!1,ua=!1,Vl=1,Os=null,k0=0;const Tk=500,Tc=n=>{h.state.musicalColumnWidths&&h.state.musicalColumnWidths.length>0?h.state.musicalColumnWidths:h.state.columnWidths;const t={modulationMarkers:h.state.modulationMarkers||[],columnWidths:h.state.columnWidths,cellWidth:h.state.cellWidth,cellHeight:h.state.cellHeight,baseMicrobeatPx:h.state.baseMicrobeatPx||h.state.cellWidth||40};return it(n,t)},Cb=n=>{if(h.state.modulationMarkers&&h.state.modulationMarkers.length>0){const i=Tc(n);return Tc(n+1)-i}return((h.state.musicalColumnWidths&&h.state.musicalColumnWidths.length>0?h.state.musicalColumnWidths:h.state.columnWidths)[n]??1)*h.state.cellWidth},Qc=()=>Math.max(zA,XA*h.state.cellHeight),Rp=()=>{An&&An.clearRect(0,0,He(An.canvas),ie(An.canvas))};function Jh(n,t,e){if(!An)return;const s=Tc(n),i=t*Qc(),r=Cb(n);An.fillStyle=e,An.fillRect(s,i,r,Qc())}function Qk(n,t){var a;if(!An)return;const e=Tc(n),s=t*Qc(),i=Cb(n),r=kp[t];if(!r)return;const o=ei.getAnimationScale(n,r),A=((a=h.state.selectedTool)==null?void 0:a.color)??"#212529";An.globalAlpha=.4,An.fillStyle=A,vb(An,t,e,s,i,Qc(),o),An.globalAlpha=1}const bb=()=>{const n=document.getElementById(xk);return(n==null?void 0:n.scrollLeft)??0};function Mk(n){var l;const t=n.currentTarget;if(!t)return;const e=t.getBoundingClientRect(),s=n.clientX-e.left,i=n.clientY-e.top,r=Qs.getColumnIndex(s+bb()),o=Qs.getDrumRowIndex(i),A=h.state.musicalColumnWidths&&h.state.musicalColumnWidths.length>0?h.state.musicalColumnWidths.length:h.state.columnWidths.length;if(!An||r<0||r>=A||o<0||o>2){Hp();return}Rp();const a=kp[o];a&&(Fc?((l=h.eraseDrumNoteAt)!=null&&l.call(h,r,a,!1)&&(ua=!0),Jh(r,o,"rgba(220, 53, 69, 0.3)")):(Jh(r,o,"rgba(74, 144, 226, 0.2)"),Qk(r,o)))}function Hp(){Rp()}function Uk(n){var l,c,u,d;n.preventDefault();const t=n.currentTarget;if(!t)return;const e=t.getBoundingClientRect(),s=n.clientX-e.left,i=n.clientY-e.top,r=Qs.getColumnIndex(s+bb()),o=h.state.musicalColumnWidths&&h.state.musicalColumnWidths.length>0?h.state.musicalColumnWidths.length:h.state.columnWidths.length;if(r<0||r>=o||!KF(r,h.state))return;const A=Qs.getDrumRowIndex(i);if(A<0||A>2)return;const a=kp[A];if(a){if(n.button===2){Fc=!0,ua=!1,(l=document.getElementById(Bb))==null||l.classList.add("erasing-active"),(c=h.eraseDrumNoteAt)!=null&&c.call(h,r,a,!1)&&(ua=!0),Rp(),Jh(r,A,"rgba(220, 53, 69, 0.3)");return}if(n.button===0){const p=((u=h.state.selectedTool)==null?void 0:u.color)??"#000000",f={isDrum:!0,drumTrack:a,startColumnIndex:r,endColumnIndex:r,color:p,shape:a==="H"?"triangle":a==="M"?"square":"pentagon"};(d=h.toggleDrumNote)==null||d.call(h,f);const m=window.transportService,g=m==null?void 0:m.drumPlayers;g!=null&&g.player&&(g.player(a).start(),ei.triggerNotePop(r,a))}}}function Pk(){var n,t;Fc&&(ua&&((n=h.recordState)==null||n.call(h)),Fc=!1,ua=!1,(t=document.getElementById(Bb))==null||t.classList.remove("erasing-active")),Hp()}function Nk(){const n=document.getElementById(_k),t=n==null?void 0:n.querySelector(".drum-grid-left-cell");if(!n||!t)return;let e=t.querySelector(".drum-left-content");if(!e){e=document.createElement("div"),e.className="drum-left-content";const o=e,A=document.createElement("button");A.className="drum-volume-button",A.type="button",A.setAttribute("aria-label","Drum volume"),A.innerHTML=`
      <span class="drum-volume-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" focusable="false" role="img">
          <path d="M3 10v4h4l5 5V5L7 10H3z" fill="currentColor"></path>
          <path d="M16 8.82v6.36c1.18-.85 2-2.22 2-3.64s-.82-2.79-2-3.64z" fill="currentColor"></path>
          <path d="M16 4v2c2.9 1.06 5 3.86 5 7s-2.1 5.94-5 7v2c4.01-1.15 7-4.97 7-9s-2.99-7.85-7-9z" fill="currentColor"></path>
        </svg>
      </span>
    `,A.style.gridRow="1 / span 3",A.style.gridColumn="1",["H","M","L"].forEach((a,l)=>{const c=document.createElement("span");c.className="drum-track-label",c.textContent=a,c.style.gridColumn="2",c.style.gridRow=`${l+1}`,o.appendChild(c)}),o.appendChild(A),t.appendChild(o)}const s=document.createElement("div");s.className="drum-volume-control",Os=document.createElement("input"),Os.type="range",Os.min="0",Os.max="100",Os.value="100",Os.className="drum-volume-slider",Os.style.cssText="width: 80px; margin: 0;",Os.addEventListener("input",o=>{const A=o.currentTarget;Vl=Number(A.value)/100;const a=window.drumVolumeNode;if(a!=null&&a.volume){const l=Vl===0?-60:20*Math.log10(Vl);a.volume.value=l;const c=window.transportService,u=c==null?void 0:c.drumPlayers,d=Date.now();u!=null&&u.player&&d-k0>=Tk&&(u.player("M").start("+0.1"),k0=d)}}),s.appendChild(Os),t.appendChild(s);const i=()=>{if(!s)return;s.classList.contains("visible")?s.classList.remove("visible"):s.classList.add("visible")},r=t.querySelector(".drum-volume-button");r&&r.addEventListener("click",o=>{o.stopPropagation(),i()}),document.addEventListener("click",o=>{const A=o.target,a=A==null?void 0:A.closest(".drum-volume-control"),l=A==null?void 0:A.closest(".drum-volume-button");!a&&!l&&s.classList.remove("visible")})}function Dk(){return Vl}window.getDrumVolume=Dk;function Lk(){const n=document.getElementById(Ik),t=document.getElementById(Fk);!n||!t||(An=t.getContext("2d"),n.addEventListener("mousedown",Uk),n.addEventListener("mousemove",Mk),n.addEventListener("mouseleave",Hp),n.addEventListener("contextmenu",e=>e.preventDefault()),window.addEventListener("mouseup",Pk),Nk())}function R0(){const n=YA.getDrumContext();if(!(n!=null&&n.canvas))return;const t={placedNotes:EF(h.state),placedTonicSigns:Ve(h.state),columnWidths:h.state.columnWidths,musicalColumnWidths:h.state.musicalColumnWidths,cellWidth:h.state.cellWidth,cellHeight:h.state.cellHeight,macrobeatGroupings:h.state.macrobeatGroupings,macrobeatBoundaryStyles:h.state.macrobeatBoundaryStyles,modulationMarkers:h.state.modulationMarkers,baseMicrobeatPx:h.state.cellWidth};Ek(n,t)}const ze={animationFrameId:null,render(){R0(),ei.hasActiveAnimations()?ze.animationFrameId||ze.startAnimationLoop():ze.stopAnimationLoop()},startAnimationLoop(){if(ze.animationFrameId)return;const n=()=>{ei.cleanupAnimations(),R0(),ei.hasActiveAnimations()?ze.animationFrameId=requestAnimationFrame(n):ze.animationFrameId=null};ze.animationFrameId=requestAnimationFrame(n)},stopAnimationLoop(){ze.animationFrameId&&(cancelAnimationFrame(ze.animationFrameId),ze.animationFrameId=null)}};window.drumGridRenderer=ze;function H0(n){if(n)return n.uuid}function yb(n,t=null){const e=Array.isArray(t)?t:n.macrobeatGroupings||[],i=[...Ve(n)].sort((c,u)=>c.preMacrobeatIndex-u.preMacrobeatIndex);let r=0;const o=[];let A=0;const a=c=>{o.push({visualIndex:o.length,type:`legend-${c}`,timeIndex:null})},l=c=>{for(;r<i.length;){const u=i[r];if((u==null?void 0:u.preMacrobeatIndex)!==c)break;o.push({visualIndex:o.length,type:"tonic",timeIndex:null}),o.push({visualIndex:o.length,type:"tonic",timeIndex:null});const d=H0(u);if(d)do r++;while(r<i.length&&H0(i[r])===d);else r++}};return a("left"),a("left"),l(-1),e.forEach((c,u)=>{for(let d=0;d<c;d++)o.push({visualIndex:o.length,type:"time",timeIndex:A++});l(u)}),a("right"),a("right"),{entries:o,totalTimeColumns:A}}function kk(n,t,e=null){if(e!==null){const{entries:s}=yb(n,e),i=s[t];return i?i.timeIndex:null}return VF(t,n)}function Rk(n,t,e=null){if(t==null)return null;if(e!==null){const{entries:s,totalTimeColumns:i}=yb(n,e);if(t<0||t>=i)return null;const r=s.find(o=>o.timeIndex===t);return r?r.visualIndex:null}return WF(t,n)}let bl=!1,yi="C4",Mc=null;function Wl(){var n;return{pitches:[],rootNote:yi,color:((n=h.state.selectedNote)==null?void 0:n.color)||"#000000"}}let hs=Wl();function Hk(){const n=document.activeElement;if(!(n instanceof HTMLElement))return!0;const t=n.tagName.toLowerCase();return!(["input","textarea","select"].includes(t)||n.isContentEditable)}function Ok(n){const t=n.globalRow??n.row,e=h.state.fullRowData[t];return e?e.toneNote:"C4"}function O0(){const n=h.state.placedNotes.slice().reverse().find(t=>!t.isDrum);yi=n?Ok(n):"C4"}function V0(n){const{activeChordIntervals:t}=h.state;return!n||!(t!=null&&t.length)?[]:t.map(e=>{const s=ho(n,e);return BA(s)})}function Vk(){O0(),h.on("notesChanged",O0),document.addEventListener("keydown",n=>{var i,r;if(n.code!=="Enter"||bl||n.repeat||!Hk())return;n.preventDefault(),bl=!0;const t=(i=h.state.selectedNote)==null?void 0:i.color;let e,s=[];if(Mc&&t){const o=h.state.fullRowData[Mc.row];e=o?o.toneNote:yi,h.state.selectedTool==="chord"?s=V0(e):s=[e]}else t&&yi&&(e=yi,h.state.selectedTool==="chord"?s=V0(yi):s=[yi]);if(s.length>0&&t&&e){hs={pitches:[...s],rootNote:e,color:t},s.forEach(u=>{kt.triggerAttack(u,t)});const o=h.state.fullRowData.find(u=>u.toneNote===e),A=o?o.hex:"#888888",a=h.state.timbres[t];if(!a)return;const l=a.adsr;(r=Rn.adsrComponent)==null||r.playheadManager.trigger("spacebar","attack",A,l),h.emit("spacebarPlayback",{note:e,color:t,isPlaying:!0});const c=`spacebar-${Date.now()}`;h.emit("noteAttack",{noteId:c,color:t}),hs.noteId=c}}),document.addEventListener("keyup",n=>{var s;if(n.code!=="Enter"||!bl)return;n.preventDefault(),bl=!1;const t=hs.pitches;if(!Array.isArray(t)||t.length===0){hs=Wl();return}const e=hs.color;if(e){t.forEach(l=>{kt.triggerRelease(l,e)});const i=hs.rootNote??yi,r=h.state.fullRowData.find(l=>l.toneNote===i),o=r?r.hex:"#888888",A=h.state.timbres[e];if(!A){hs=Wl();return}const a=A.adsr;(s=Rn.adsrComponent)==null||s.playheadManager.trigger("spacebar","release",o,a),h.emit("spacebarPlayback",{note:i,color:e,isPlaying:!1}),hs.noteId&&h.emit("noteRelease",{noteId:hs.noteId,color:e})}hs=Wl()})}function Sb(n,t){var s;Mc={col:n,row:t};const e=(s=h.state.selectedNote)==null?void 0:s.color;e&&h.emit("ghostNoteUpdated",{color:e})}function Eb(){Mc=null,h.emit("ghostNoteCleared")}const Wk={single:40,chord:20,transient:30};function xb(n){return String(n)}function Gk(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}const W0={single:0,chord:0,transient:0},Qi=new Map;function G0(n,t){const e=xb(t),s=Qi.get(n)??new Set;s.add(e),Qi.set(n,s)}function K0(n,t){const e=Qi.get(n);e&&(e.delete(xb(t)),e.size===0&&Qi.delete(n))}const on={shouldPlayPreview(n){const t=Gk(),e=Wk[n],s=W0[n];return t-s<e?!1:(W0[n]=t,!0)},triggerAttack(n,t,e={}){const s=e.kind??"single";return!e.bypassThrottle&&!this.shouldPlayPreview(s)?!1:(kt.triggerAttack(n,t),G0(t,n),!0)},triggerAttacks(n,t,e={}){const s=e.kind??"chord";return!e.bypassThrottle&&!this.shouldPlayPreview(s)?!1:(n.forEach(i=>{kt.triggerAttack(i,t),G0(t,i)}),!0)},triggerRelease(n,t){kt.triggerRelease(n,t),K0(t,n)},releasePitches(n,t){n.forEach(e=>{this.triggerRelease(e,t)})},quickReleasePitches(n,t){!n||n.length===0||(kt.quickReleasePitches(n,t),n.forEach(e=>K0(t,e)))},playTransient(n,t,e=100){this.triggerAttack(n,t,{kind:"transient"})&&setTimeout(()=>this.triggerRelease(n,t),e)},releaseAll(n){if(typeof n=="string"){const t=Qi.get(n);if(!t)return;Array.from(t.values()).forEach(e=>{kt.triggerRelease(e,n)}),Qi.delete(n);return}for(const[t,e]of Qi.entries())Array.from(e.values()).forEach(s=>{kt.triggerRelease(s,t)});Qi.clear()}};class Kk{constructor(){I(this,"isDragging",!1);I(this,"draggedModulationMarker",null);I(this,"lastModulationHoverResult",null)}handleMouseDown(t,e){for(const s of h.state.modulationMarkers||[]){const i=s.xCanvas??s.xPosition??0,r=Jm(t,e,{...s,xCanvas:i});if(r){if(r.type==="label"){const o=s.ratio===Sn.COMPRESSION_2_3?Sn.EXPANSION_3_2:Sn.COMPRESSION_2_3;return h.setModulationRatio(s.id,o),!0}if(r.type==="barline"&&r.canDrag)return this.isDragging=!0,this.draggedModulationMarker=s,document.body.style.cursor=Zm(r),!0}}return!1}handlePlacementClick(t,e){if(h.state.selectedTool!=="modulation")return!1;const s=h.state.selectedModulationRatio;if(typeof s!="number")return E.warn("PitchGridModulationToolInteractor","No modulation ratio selected before placement",null,"grid"),!0;const i=e(t);if(!i)return E.warn("PitchGridModulationToolInteractor","Modulation placement must be near a measure boundary",{clickX:t},"grid"),!0;E.debug("PitchGridModulationToolInteractor","Placing modulation marker at boundary",{measureIndex:i.measureIndex,ratio:s,clickX:t,boundaryX:i.xPosition},"grid");const r=h.addModulationMarker(i.measureIndex,s,i.xPosition,null,i.macrobeatIndex);return E.debug("PitchGridModulationToolInteractor","Modulation marker placed",{markerId:r,measureIndex:i.measureIndex,ratio:s},"grid"),!0}handleMouseMove(t){if(!this.isDragging||!this.draggedModulationMarker)return!1;const e=h.state.baseMicrobeatPx||h.state.cellWidth||40,s=Math.round(t/e)*e;return h.moveModulationMarker(this.draggedModulationMarker.id,s),!0}getHoveredMarker(t,e){for(const s of h.state.modulationMarkers||[]){const i=s.xCanvas??s.xPosition??0,r=Jm(t,e,{...s,xCanvas:i});if(r)return r}return null}updateCursor(t,e){if(e){t.style.cursor=Zm(e),this.lastModulationHoverResult=e;return}this.lastModulationHoverResult&&(t.style.cursor="default",this.lastModulationHoverResult=null)}handleMouseUp(){return this.isDragging?(this.isDragging=!1,this.draggedModulationMarker=null,!0):!1}}class qk{handleExistingNoteMouseDown(t,e,s,i){var u,d,p;if(h.state.selectedTool!=="note")return{handled:!1,state:s};const r=h.state.placedNotes.find(f=>!f.isDrum&&f.row===e&&t>=f.startColumnIndex&&t<=f.endColumnIndex);if(!r)return{handled:!1,state:s};const o=i.getPitchForRow(e);if(!o)return{handled:!0,state:s};const A=window.waveformVisualizer;A&&(A.currentColor=r.color,A.generateWaveform(),A.startSingleNoteVisualization(r.color));const a=se.getSixteenthStampAtPosition(t,e);if(a)return se.playRhythmPattern(a.sixteenthStampId,o,r.color,r.shape,a),{handled:!0,state:{...s,activePreviewPitches:[o],activeNote:r}};on.triggerAttack(o,r.color,{kind:"single",bypassThrottle:!0});const l=((u=h.state.fullRowData[e])==null?void 0:u.hex)||"#888888",c=(d=h.state.timbres[r.color])==null?void 0:d.adsr;return c&&((p=Rn.adsrComponent)==null||p.playheadManager.trigger(r.uuid,"attack",l,c)),{handled:!0,state:{...s,activePreviewPitches:[o],activeNote:r}}}attemptPlaceNoteAt(t,e,s,i,r){var f,m,g;if(h.state.selectedTool!=="note")return{placed:!1,state:s,shouldStartDragging:!1};if(!jA(t,h.state))return{placed:!1,state:s,shouldStartDragging:!1};const o=h.state.selectedNote;if(!o)return{placed:!1,state:s,shouldStartDragging:!1};const{shape:A,color:a}=o;if(A==="circle"&&!jA(t+1,h.state))return{placed:!1,state:s,shouldStartDragging:!1};const l=A==="circle"?t+1:t,c={row:e,startColumnIndex:t,endColumnIndex:l,color:a,shape:A,isDrum:!1},u=h.addNote(c);if(!u)return{placed:!1,state:s,shouldStartDragging:!1};const d={...s,activeNote:u,lastDragRow:e};u.uuid&&h.emit("noteInteractionStart",{noteId:u.uuid,color:u.color});const p=r.getPitchForRow(e);if(p){u.uuid&&(i.add(u.uuid),h.emit("noteAttack",{noteId:u.uuid,color:u.color})),d.activePreviewPitches=[p],on.triggerAttack(p,u.color,{kind:"single",bypassThrottle:!0});const w=((f=h.state.fullRowData[e])==null?void 0:f.hex)||"#888888",B=(m=h.state.timbres[u.color])==null?void 0:m.adsr;B&&((g=Rn.adsrComponent)==null||g.playheadManager.trigger(u.uuid,"attack",w,B));const b=window.waveformVisualizer;b&&(b.currentColor=u.color,b.generateWaveform(),b.startSingleNoteVisualization(u.color))}return{placed:!0,state:d,shouldStartDragging:!0}}handleActiveNoteDrag(t,e,s,i){var l,c,u,d,p,f;const r=s.activeNote;if(!r)return s;const o=t,A=e,a=r.uuid;if(r.shape==="circle"){if(o!==r.endColumnIndex&&h.updateNoteTail(r,o),A!==s.lastDragRow){const m=i.getPitchForRow(A);if(!m)return s;s.activePreviewPitches.length>0&&on.quickReleasePitches(s.activePreviewPitches,r.color);const g=h.state.placedNotes.find(C=>C.uuid===a);g&&h.updateNoteRow(g,A);const B=h.state.placedNotes.find(C=>C.uuid===a)||g||r;let b=s.activePreviewPitches;on.triggerAttack(m,B.color,{kind:"single"})&&(b=[m]);const _=((l=h.state.fullRowData[A])==null?void 0:l.hex)||"#888888",v=(c=h.state.timbres[B.color])==null?void 0:c.adsr;return v&&B.uuid&&((u=Rn.adsrComponent)==null||u.playheadManager.trigger(B.uuid,"attack",_,v)),{...s,activeNote:B,lastDragRow:A,activePreviewPitches:b}}return s}if(r.shape==="oval"){const m=t;if(m!==r.startColumnIndex&&h.updateNotePosition(r,m),A!==s.lastDragRow){const g=i.getPitchForRow(A);if(!g)return s;s.activePreviewPitches.length>0&&on.quickReleasePitches(s.activePreviewPitches,r.color);const w=h.state.placedNotes.find(y=>y.uuid===a);w&&h.updateNoteRow(w,A);const b=h.state.placedNotes.find(y=>y.uuid===a)||w||r;let _=s.activePreviewPitches;on.triggerAttack(g,b.color,{kind:"single"})&&(_=[g]);const v=((d=h.state.fullRowData[A])==null?void 0:d.hex)||"#888888",C=(p=h.state.timbres[b.color])==null?void 0:p.adsr;return C&&b.uuid&&((f=Rn.adsrComponent)==null||f.playheadManager.trigger(b.uuid,"attack",v,C)),{...s,activeNote:b,lastDragRow:A,activePreviewPitches:_}}}return s}}class zk{handleMouseDown(t,e){if(h.state.selectedTool!=="eraser")return{handled:!1,shouldStartDrag:!1};h.eraseInPitchArea(t,e,2,!1);const s=t+2-1,i=e-1,r=e+1;return NN(t,s,i,r),RN(t,s,i,r),{handled:!0,shouldStartDrag:!0}}handleMouseMove(t,e,s){if(!s)return!1;h.eraseInPitchArea(t,e,2,!1);const i=t+2-1,r=e-1,o=e+1;return h.eraseSixteenthStampsInArea(t,i,r,o),h.eraseTripletStampsInArea(t,i,r,o),!0}}class Xk{handleMouseDown(t,e,s,i,r){var f,m,g;if(h.state.selectedTool!=="chord")return{handled:!1,state:s,shouldStartDragging:!1};if(!jA(t,h.state))return{handled:!0,state:s,shouldStartDragging:!1};const o=r.getPitchForRow(e);if(!o)return{handled:!0,state:s,shouldStartDragging:!1};const A=r.getChordPitchesForRootPitch(o),a=h.state.selectedNote;if(!a)return{handled:!0,state:s,shouldStartDragging:!1};const{shape:l,color:c}=a;on.triggerAttacks(A,c,{kind:"chord",bypassThrottle:!0});const u=((f=h.state.fullRowData[e])==null?void 0:f.hex)||"#888888",d=(m=h.state.timbres[c])==null?void 0:m.adsr;d&&((g=Rn.adsrComponent)==null||g.playheadManager.trigger("chord_preview","attack",u,d));const p=[];return A.forEach(w=>{const B=h.state.fullRowData.findIndex(C=>C.toneNote===w);if(B===-1)return;const b=l==="circle"?t+1:t,_={row:B,startColumnIndex:t,endColumnIndex:b,color:c,shape:l,isDrum:!1},v=h.addNote(_);v&&(p.push(v),v.uuid&&(i.add(v.uuid),h.emit("noteAttack",{noteId:v.uuid,color:v.color}),h.emit("noteInteractionStart",{noteId:v.uuid,color:v.color})))}),{handled:!0,shouldStartDragging:!0,state:{...s,activeChordNotes:p,activePreviewPitches:[...A],lastDragRow:e}}}handleActiveChordDrag(t,e,s,i){if(!s.activeChordNotes||s.activeChordNotes.length===0)return s;const r=s.activeChordNotes[0];if(!r)return s;const o=r.color,A=e;if(r.shape==="circle"){const a=t,l=s.activeChordNotes.filter(c=>a!==c.endColumnIndex);if(l.length>0&&h.updateMultipleNoteTails(l,a),A!==s.lastDragRow){const c=s.lastDragRow??r.row,u=A-c;if(u===0)return s;on.quickReleasePitches(s.activePreviewPitches,o);const d=s.activeChordNotes.map(m=>m.row+u);if(!d.every(m=>i.getPitchForRow(m)!==null))return s;h.updateMultipleNoteRows(s.activeChordNotes,d);const f=d.map(m=>i.getPitchForRow(m)).filter(m=>typeof m=="string");return on.triggerAttacks(f,o,{kind:"chord"}),{...s,activePreviewPitches:f,lastDragRow:A}}return s}if(r.shape==="oval"){const a=t,l=s.activeChordNotes.filter(m=>a!==m.startColumnIndex);l.length>0&&h.updateMultipleNotePositions(l,a);const c=s.lastDragRow!==null?s.lastDragRow:r.row,u=A-c;if(u===0)return s;on.quickReleasePitches(s.activePreviewPitches,o);const d=s.activeChordNotes.map(m=>m.row+u);if(!d.every(m=>i.getPitchForRow(m)!==null))return s;h.updateMultipleNoteRows(s.activeChordNotes,d);const f=d.map(m=>i.getPitchForRow(m)).filter(m=>typeof m=="string");return on.triggerAttacks(f,o,{kind:"chord"}),{...s,activePreviewPitches:f,lastDragRow:A}}return s}}function $k(n,t,e,s){var l,c;const i=cu(e.sixteenthStampId);if(!i)return null;const r=it(e.startColumn,s),o=s.cellWidth*2,A=s.cellHeight,a=[.125,.375,.625,.875].map(u=>r+u*o);for(const u of i.diamonds){const d=`diamond_${u}`,p=((l=e.shapeOffsets)==null?void 0:l[d])||0,f=e.row+p,m=Bt(f,s),g=a[u];if(g===void 0)continue;const w=Math.sqrt(Math.pow(n-g,2)+Math.pow(t-m,2)),B=Math.min(o*.2,A*1);if(w<B)return{type:"diamond",slot:u??0,shapeKey:d,cx:g,cy:m,placement:e}}for(const u of i.ovals){const d=`oval_${u}`,p=((c=e.shapeOffsets)==null?void 0:c[d])||0,f=e.row+p,m=Bt(f,s),g=u===0?r+.25*o:r+.75*o,w=Math.sqrt(Math.pow(n-g,2)+Math.pow(t-m,2)),B=Math.min(o*.25,A*1);if(w<B)return{type:"oval",slot:u,shapeKey:d,cx:g,cy:m,placement:e}}return null}function q0(n,t,e,s){for(const i of e){const r=$k(n,t,i,s);if(r)return r}return null}class Yk{constructor(){I(this,"draggedStampShape",null)}isDraggingShape(){return this.draggedStampShape!==null}tryStartShapeDrag(t){const e=h.getAllSixteenthStampPlacements(),s={...h.state},i=q0(t.actualX,t.canvasY,e,s);return i?(this.draggedStampShape={...i,startRow:h.getSixteenthStampShapeRow(i.placement,i.shapeKey),startMouseY:t.canvasY},!0):!1}handleMouseDown(t){if(this.tryStartShapeDrag({actualX:t.actualX,canvasY:t.canvasY}))return{handled:!0};if(h.state.selectedTool!=="sixteenthStamp")return{handled:!1};const e=se.getSixteenthStampAtPosition(t.colIndex,t.rowIndex);if(e){const l=t.getPitchForRow(t.rowIndex);if(!l)return{handled:!0};const c=h.state.placedNotes.find(d=>!d.isDrum&&d.row===t.rowIndex&&t.colIndex>=d.startColumnIndex&&t.colIndex<=d.endColumnIndex),u=c?c.shape:"oval";return se.playRhythmPattern(e.sixteenthStampId,l,e.color,u,e),{handled:!0,activePreviewPitches:[l]}}const s=Eu.getSelectedSixteenthStamp();if(!s)return{handled:!0};const i=t.getTimeAlignedCanvasColumn(t.colIndex);if(i===null)return{handled:!0};const r=h.state.selectedNote;if(!r)return{handled:!0};const{color:o,shape:A}=r;PN(s.id,i,t.rowIndex,o);const a=t.getPitchForRow(t.rowIndex);return a?(se.playRhythmPattern(s.id,a,o,A),h.recordState(),{handled:!0,activePreviewPitches:[a]}):(h.recordState(),{handled:!0})}handleMouseMove(t){var s;if(!this.draggedStampShape)return!1;const e=t.rowIndex-this.draggedStampShape.placement.row;if(h.updateSixteenthStampShapeOffset(this.draggedStampShape.placement.id,this.draggedStampShape.shapeKey,e),t.rowIndex!==this.draggedStampShape.startRow){const i=t.getPitchForRow(t.rowIndex);if(i){const r=this.draggedStampShape.placement.color||((s=h.state.selectedNote)==null?void 0:s.color);r&&on.playTransient(i,r,100)}this.draggedStampShape.startRow=t.rowIndex}return t.canvasEl&&(t.canvasEl.style.cursor="ns-resize"),!0}updateHoverCursor(t){if(h.state.selectedTool!=="sixteenthStamp"||this.draggedStampShape)return;const e=t.canvasEl;if(!e)return;const s=h.getAllSixteenthStampPlacements(),i={...h.state};q0(t.actualX,t.canvasY,s,i)||jk(t.actualX,t.canvasY,s,i)?e.style.cursor="grab":e.style.cursor="default"}handleMouseUp(){if(!this.draggedStampShape)return!1;this.draggedStampShape=null,h.recordState();const t=document.getElementById("notation-grid");return t&&(t.style.cursor="default"),!0}}function jk(n,t,e,s){const i=s.columnWidths||[];for(const r of e){const o=r.startColumn,A=Math.min(r.endColumn,i.length),a=it(o,s),l=it(A,s),u=Bt(r.row,s)-s.cellHeight/2;if(n>=a&&n<=l&&t>=u&&t<=u+s.cellHeight)return!0}return!1}function Jk(n,t,e,s){var d;const i=uu(e.tripletStampId);if(!i)return null;const r=e.span*2,o=gn(e.startTimeIndex,h.state),A=o+r,a=it(o,s),c=it(A,s)-a,u=s.cellHeight;for(const p of i.hits){const f=`triplet_${p}`,m=((d=e.shapeOffsets)==null?void 0:d[f])||0,g=e.row+m,w=Bt(g,s),B=nB[p];if(B===void 0)continue;const b=a+c*B/100,_=Math.sqrt(Math.pow(n-b,2)+Math.pow(t-w,2)),v=Math.min(c*.15,u*1);if(_<v)return{type:"tripletStamp",slot:p,shapeKey:f,cx:b,cy:w,placement:e}}return null}function z0(n,t,e,s){for(const i of e){const r=Jk(n,t,i,s);if(r)return r}return null}class Zk{constructor(){I(this,"draggedTripletShape",null)}isDraggingShape(){return this.draggedTripletShape!==null}tryStartShapeDrag(t){const e=h.getAllTripletStampPlacements(),s={...h.state},i=z0(t.actualX,t.canvasY,e,s);return i?(this.draggedTripletShape={...i,startRow:h.getTripletStampShapeRow(i.placement,i.shapeKey),startMouseY:t.canvasY},!0):!1}handleMouseDown(t){if(this.tryStartShapeDrag({actualX:t.actualX,canvasY:t.canvasY}))return{handled:!0};if(h.state.selectedTool!=="tripletStamp")return{handled:!1};const e=Vi(t.colIndex,h.state);if(e===null)return{handled:!0};const s=e,i=se.getTripletStampAtPosition(s,t.rowIndex);if(i){const a=t.getPitchForRow(t.rowIndex);return a?(se.playTripletPattern(i.tripletStampId,a,i.color,i),{handled:!0,activePreviewPitches:[a]}):{handled:!0}}const r=ca.getSelectedTripletStamp();if(!r||!h.state.selectedNote)return{handled:!0};const o=LN(r.id,s,t.rowIndex,h.state.selectedNote.color),A=t.getPitchForRow(t.rowIndex);return A&&o?(se.playTripletPattern(r.id,A,h.state.selectedNote.color,o),h.recordState(),{handled:!0,activePreviewPitches:[A]}):(h.recordState(),{handled:!0})}handleMouseMove(t){var s;if(!this.draggedTripletShape)return!1;const e=t.rowIndex-this.draggedTripletShape.placement.row;if(h.updateTripletStampShapeOffset(this.draggedTripletShape.placement.id,this.draggedTripletShape.shapeKey,e),t.rowIndex!==this.draggedTripletShape.startRow){const i=t.getPitchForRow(t.rowIndex);if(i){const r=this.draggedTripletShape.placement.color||((s=h.state.selectedNote)==null?void 0:s.color);r&&on.playTransient(i,r,100)}this.draggedTripletShape.startRow=t.rowIndex}return t.canvasEl&&(t.canvasEl.style.cursor="ns-resize"),!0}updateHoverCursor(t){if(h.state.selectedTool!=="tripletStamp"||this.draggedTripletShape)return;const e=t.canvasEl;if(!e)return;const s=h.getAllTripletStampPlacements(),i={...h.state};z0(t.actualX,t.canvasY,s,i)||tR(t.actualX,t.canvasY,s,i)?e.style.cursor="grab":e.style.cursor="default"}handleMouseUp(){if(!this.draggedTripletShape)return!1;this.draggedTripletShape=null,h.recordState();const t=document.getElementById("notation-grid");return t&&(t.style.cursor="default"),!0}}function tR(n,t,e,s){for(const i of e){const r=i.span*2,o=gn(i.startTimeIndex,h.state),A=o+r,a=it(o,s),l=it(A,s),u=Bt(i.row,s)-s.cellHeight/2;if(n>=a&&n<=l&&t>=u&&t<=u+s.cellHeight)return!0}return!1}function eR(n){const{macrobeatGroupings:t,macrobeatBoundaryStyles:e,columnWidths:s}=h.state,i=s.length;if(n<0||n>=i)return null;let r=-1;for(let u=0;u<t.length;u++){const{startColumn:d,endColumn:p}=dn(h.state,u);if(n>=d&&n<=p){r=u;break}}if(r===-1)return null;let o=0;for(let u=r-1;u>=0;u--)if(e[u]==="solid"){o=u+1;break}const A=o-1;return(u=>u<=0?!0:e[u-1]==="solid")(o)?{drawColumn:dn(h.state,o).startColumn,preMacrobeatIndex:A}:null}function X0(n){return n.replace(/\d+$/,"")}class nR{constructor(){I(this,"lastHoveredTonicPoint",null);I(this,"lastHoveredOctaveRows",[])}resetHoverState(){this.lastHoveredTonicPoint=null,this.lastHoveredOctaveRows=[]}handleMouseMove(t){if(h.state.selectedTool!=="tonicization")return(this.lastHoveredTonicPoint||this.lastHoveredOctaveRows.length>0)&&this.resetHoverState(),!1;const e=eR(t.colIndex);if(!e)return this.resetHoverState(),!0;if(Ve(h.state).some(c=>c.preMacrobeatIndex===e.preMacrobeatIndex))return this.resetHoverState(),!0;const r=t.getPitchForRow(t.rowIndex);if(!r)return this.resetHoverState(),!0;const o=X0(r),A=qs.map((c,u)=>({rowData:c,masterIndex:u})).filter(({rowData:c})=>c.toneNote&&X0(c.toneNote)===o).map(({masterIndex:c})=>c);this.lastHoveredTonicPoint=e,this.lastHoveredOctaveRows=A;const a=A.filter(c=>c>=0&&c<h.state.fullRowData.length);t.hoverCtx.globalAlpha=.5;const l={...h.state,zoomLevel:je.getViewportInfo().zoomLevel};return a.forEach(c=>{const u={row:c,globalRow:c,columnIndex:e.drawColumn,tonicNumber:h.state.selectedToolTonicNumber,preMacrobeatIndex:e.preMacrobeatIndex};tB(t.hoverCtx,l,u)}),t.hoverCtx.globalAlpha=1,!0}handleMouseDown(){if(h.state.selectedTool!=="tonicization")return!1;if(!this.lastHoveredTonicPoint||this.lastHoveredOctaveRows.length===0)return!0;const t=this.lastHoveredTonicPoint;if(Ve(h.state).some(r=>r.preMacrobeatIndex===t.preMacrobeatIndex))return this.resetHoverState(),!0;const i=this.lastHoveredOctaveRows.map(r=>({row:r,tonicNumber:h.state.selectedToolTonicNumber,preMacrobeatIndex:t.preMacrobeatIndex,columnIndex:t.drawColumn}));return h.addTonicSignGroup(i),this.resetHoverState(),!0}}class sR{constructor(t){this.deps=t}handleToolMouseDown(t){const{toolType:e,colIndex:s,rowIndex:i,actualX:r,canvasY:o}=t,A=t.state;if(e==="chord"){const a=this.deps.chordToolInteractor.handleMouseDown(s,i,{activeChordNotes:A.activeChordNotes,lastDragRow:A.lastDragRow,activePreviewPitches:A.activePreviewPitches},this.deps.placementFillNoteIds,{getPitchForRow:this.deps.getPitchForRow,getChordPitchesForRootPitch:this.deps.getChordPitchesForRootPitch});return{handled:a.handled,state:{...A,isDragging:a.shouldStartDragging?!0:A.isDragging,activeChordNotes:a.state.activeChordNotes,lastDragRow:a.state.lastDragRow,activePreviewPitches:a.state.activePreviewPitches}}}if(e==="tonicization")return this.deps.tonicizationToolInteractor.handleMouseDown(),{handled:!0,state:A};if(e==="eraser"){const a=this.deps.eraserToolInteractor.handleMouseDown(s,i);return{handled:a.handled,state:{...A,isEraserDragActive:a.handled?a.shouldStartDrag:A.isEraserDragActive}}}if(e==="sixteenthStamp"){const a=this.deps.stampToolInteractor.handleMouseDown({colIndex:s,rowIndex:i,actualX:r,canvasY:o,getPitchForRow:this.deps.getPitchForRow,getTimeAlignedCanvasColumn:this.deps.getTimeAlignedCanvasColumn});return{handled:a.handled,state:{...A,activePreviewPitches:a.activePreviewPitches??A.activePreviewPitches}}}if(e==="tripletStamp"){const a=this.deps.tripletToolInteractor.handleMouseDown({colIndex:s,rowIndex:i,actualX:r,canvasY:o,getPitchForRow:this.deps.getPitchForRow});return{handled:a.handled,state:{...A,activePreviewPitches:a.activePreviewPitches??A.activePreviewPitches}}}if(e==="modulation")return this.deps.modulationToolInteractor.handlePlacementClick(r,this.deps.findNearestMeasureBoundary),{handled:!0,state:A};if(e==="note"){const a=this.deps.noteToolInteractor.attemptPlaceNoteAt(s,i,{activeNote:A.activeNote,lastDragRow:A.lastDragRow,activePreviewPitches:A.activePreviewPitches},this.deps.placementFillNoteIds,{getPitchForRow:this.deps.getPitchForRow});return{handled:!0,state:{...A,isDragging:a.placed&&a.shouldStartDragging?!0:A.isDragging,activeNote:a.state.activeNote,lastDragRow:a.state.lastDragRow,activePreviewPitches:a.state.activePreviewPitches}}}return{handled:!1,state:A}}handleToolMouseMoveBeforeBoundsCheck(t){const{actualX:e,rowIndex:s,canvasEl:i,state:r}=t;return this.deps.modulationToolInteractor.handleMouseMove(e)?{handled:!0,state:r}:this.deps.stampToolInteractor.handleMouseMove({rowIndex:s,canvasEl:i,getPitchForRow:this.deps.getPitchForRow})?{handled:!0,state:r}:this.deps.tripletToolInteractor.handleMouseMove({rowIndex:s,canvasEl:i,getPitchForRow:this.deps.getPitchForRow})?{handled:!0,state:r}:{handled:!1,state:r}}handleNoteOrChordDragMouseMove(t){const{colIndex:e,rowIndex:s}=t,i=t.state;if(!i.isDragging||!i.activeNote&&i.activeChordNotes.length===0)return{handled:!1,state:i};if(i.activeNote){const o=this.deps.noteToolInteractor.handleActiveNoteDrag(e,s,{activeNote:i.activeNote,lastDragRow:i.lastDragRow,activePreviewPitches:i.activePreviewPitches},{getPitchForRow:this.deps.getPitchForRow});return{handled:!0,state:{...i,activeNote:o.activeNote,lastDragRow:o.lastDragRow,activePreviewPitches:o.activePreviewPitches}}}const r=this.deps.chordToolInteractor.handleActiveChordDrag(e,s,{activeChordNotes:i.activeChordNotes,lastDragRow:i.lastDragRow,activePreviewPitches:i.activePreviewPitches},{getPitchForRow:this.deps.getPitchForRow});return{handled:!0,state:{...i,activeChordNotes:r.activeChordNotes,lastDragRow:r.lastDragRow,activePreviewPitches:r.activePreviewPitches}}}handleToolHoverVisuals(t){const{toolType:e,actualX:s,canvasY:i,pitchHoverCtx:r,canvasEl:o}=t;e==="sixteenthStamp"?this.deps.stampToolInteractor.updateHoverCursor({actualX:s,canvasY:i,canvasEl:o}):e==="tripletStamp"&&this.deps.tripletToolInteractor.updateHoverCursor({actualX:s,canvasY:i,canvasEl:o});const A=this.deps.modulationToolInteractor.getHoveredMarker(s,i);if(e==="modulation"&&!A&&r){const a=t.findNearestMeasureBoundary(s),l=t.selectedModulationRatio;a&&typeof l=="number"&&t.drawModulationPreview(r,a.xPosition,l)}o&&this.deps.modulationToolInteractor.updateCursor(o,A)}handleToolMouseUp(){return!!(this.deps.stampToolInteractor.handleMouseUp()||this.deps.tripletToolInteractor.handleMouseUp()||this.deps.modulationToolInteractor.handleMouseUp())}handleChordToolHover(t){if(h.state.selectedTool!=="chord")return!1;const e=this.deps.getPitchForRow(t.rowIndex);if(!e)return!0;const s=this.deps.getChordPitchesForRootPitch(e),i=h.state.selectedNote;if(!i)return!0;const{shape:r,color:o}=i;return t.pitchHoverCtx.globalAlpha=.4,s.forEach(A=>{const a=h.state.fullRowData.findIndex(d=>d.toneNote===A);if(a<=-1)return;const l=r==="circle"?t.colIndex+1:t.colIndex,c={row:a,startColumnIndex:t.colIndex,endColumnIndex:l,color:o,shape:r,isDrum:!1},u={...h.state,zoomLevel:t.zoomLevel};r==="oval"?t.drawSingleColumnOvalNote(t.pitchHoverCtx,u,c,a):t.drawTwoColumnOvalNote(t.pitchHoverCtx,u,c,a)}),t.pitchHoverCtx.globalAlpha=1,!0}}class iR{constructor(){I(this,"isActive",!1);I(this,"actionTaken",!1);I(this,"previousTool",null)}getIsActive(){return this.isActive}handleMouseDown(t){var c;const{event:e,colIndex:s,rowIndex:i,annotationService:r}=t;if(e.button!==2)return!1;e.preventDefault(),this.isActive=!0,this.actionTaken=!1,h.state.selectedTool!=="eraser"&&(this.previousTool=h.state.selectedTool,h.setSelectedTool("eraser")),(c=Ai.get("eraserButton"))==null||c.classList.add("erasing-active"),this.actionTaken||(this.actionTaken=!!h.eraseInPitchArea(s,i,2,!1)),this.actionTaken||(this.actionTaken=!!h.eraseTonicSignAt(s,!1));const o=s+2-1,A=i-1,a=i+1;this.actionTaken||(this.actionTaken=!!h.eraseSixteenthStampsInArea(s,o,A,a)),this.actionTaken||(this.actionTaken=!!h.eraseTripletStampsInArea(s,o,A,a));const l=e.target instanceof Element?e.target:null;if(l){const u=l.getBoundingClientRect(),d=e.clientX-u.left,p=e.clientY-u.top;this.actionTaken||(this.actionTaken=!!r.eraseAtPoint(d,p))}return!0}handleMouseMove(t){if(!this.isActive)return!1;const{event:e,colIndex:s,rowIndex:i,annotationService:r}=t;this.actionTaken||(this.actionTaken=!!h.eraseInPitchArea(s,i,2,!1)),this.actionTaken||(this.actionTaken=!!h.eraseTonicSignAt(s,!1));const o=s+2-1,A=i-1,a=i+1;this.actionTaken||(this.actionTaken=!!h.eraseSixteenthStampsInArea(s,o,A,a)),this.actionTaken||(this.actionTaken=!!h.eraseTripletStampsInArea(s,o,A,a));const l=e.target instanceof Element?e.target:null;if(l){const c=l.getBoundingClientRect(),u=e.clientX-c.left,d=e.clientY-c.top;this.actionTaken||(this.actionTaken=!!r.eraseAtPoint(u,d))}return!0}handleGlobalMouseUp(){var t;return this.isActive?(this.actionTaken&&h.recordState(),this.isActive=!1,this.actionTaken=!1,this.previousTool&&(h.setSelectedTool(this.previousTool),this.previousTool=null),(t=Ai.get("eraserButton"))==null||t.classList.remove("erasing-active"),!0):!1}}class rR{constructor(t,e){I(this,"pitchCanvasElement",null);I(this,"mobileLongPressTimer",null);I(this,"mobileTouchState",null);I(this,"mobileGhostActive",!1);this.deps=t,this.options=e}setPitchCanvasElement(t){this.pitchCanvasElement=t}handleTouchStart(t){var i;if(!this.deps.shouldUseMobileLongPress()||this.mobileTouchState)return;const e=(i=t.changedTouches)==null?void 0:i[0];if(!e)return;const s=this.getTouchGridPosition(e);!s||!this.deps.isPositionWithinPitchGrid(s.colIndex,s.rowIndex)||(t.preventDefault(),this.mobileTouchState={identifier:e.identifier,colIndex:s.colIndex,rowIndex:s.rowIndex},this.mobileLongPressTimer=window.setTimeout(()=>{this.activateMobileGhostPreview()},this.options.longPressDelayMs))}handleTouchMove(t){if(!this.mobileTouchState)return;const e=this.findTouchById(t.changedTouches,this.mobileTouchState.identifier)||this.findTouchById(t.touches,this.mobileTouchState.identifier);if(!e)return;const s=this.getTouchGridPosition(e);if(!s){this.resetMobileTouchState({clearOverlay:this.mobileGhostActive});return}if(!this.deps.isPositionWithinPitchGrid(s.colIndex,s.rowIndex)){this.resetMobileTouchState({clearOverlay:this.mobileGhostActive});return}t.preventDefault(),this.mobileTouchState.colIndex=s.colIndex,this.mobileTouchState.rowIndex=s.rowIndex,this.mobileGhostActive&&this.renderMobileGhostPreview()}handleTouchEnd(t){if(!this.mobileTouchState||!this.findTouchById(t.changedTouches,this.mobileTouchState.identifier))return;t.preventDefault();const s=this.mobileGhostActive,i=this.mobileTouchState.colIndex,r=this.mobileTouchState.rowIndex;if(this.resetMobileTouchState(),!s||this.deps.getSelectedTool()!=="note")return;this.deps.attemptPlaceNoteAt(i,r)?this.deps.onNotePlaced():this.deps.onNoteNotPlaced()}handleTouchCancel(){this.resetMobileTouchState({clearOverlay:this.mobileGhostActive})}getTouchGridPosition(t){var a;if(!this.pitchCanvasElement)return null;const e=this.pitchCanvasElement.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top,r=((a=document.getElementById("canvas-container"))==null?void 0:a.scrollLeft)??0,o=Qs.getColumnIndex(s+r),A=Qs.getPitchRowIndex(i);return{colIndex:o,rowIndex:A}}findTouchById(t,e){if(!t)return null;for(let s=0;s<t.length;s++){const i=t.item(s);if(i&&i.identifier===e)return i}return null}renderMobileGhostPreview(){const t=this.deps.getPitchHoverCtx();!t||!this.mobileTouchState||(t.clearRect(0,0,He(t.canvas),ie(t.canvas)),this.deps.drawHoverHighlight(this.mobileTouchState.colIndex,this.mobileTouchState.rowIndex,this.deps.getNoteHoverColor(this.options.ghostAlpha)),this.deps.drawGhostNote(this.mobileTouchState.colIndex,this.mobileTouchState.rowIndex),this.deps.setGhostNotePosition(this.mobileTouchState.colIndex,this.mobileTouchState.rowIndex))}activateMobileGhostPreview(){if(this.mobileTouchState){if(!this.deps.isPositionWithinPitchGrid(this.mobileTouchState.colIndex,this.mobileTouchState.rowIndex)){this.resetMobileTouchState({clearOverlay:!1});return}this.mobileGhostActive=!0,this.renderMobileGhostPreview()}}resetMobileTouchState({clearOverlay:t=!1}={}){this.mobileLongPressTimer&&(clearTimeout(this.mobileLongPressTimer),this.mobileLongPressTimer=null),t&&this.mobileGhostActive&&this.deps.clearOverlay(),this.mobileTouchState=null,this.mobileGhostActive=!1}}function oR(n,t){const{activeChordIntervals:e,isIntervalsInverted:s,chordPositionState:i}=t;if(!n||!e||e.length===0)return[];if(s&&e.length===2&&e[0]==="1P"){const A="-"+e[1],a=ho(n,A),l=BA(a),c=l.includes("#")&&CA(l).includes("b")?CA(l):l;return[n,c]}const r=e.map(o=>{const A=ho(n,o),a=BA(A);if(a.includes("#")){const l=CA(a);if(l.includes("b"))return l}return a});if(e.length>=3&&i>0){const o=[...r];for(let p=0;p<i;p++){const f=o.shift();if(!f)break;const m=ho(f,"8P");o.push(BA(m)??f)}const A=o[0],a=n;if(!A)return r;const l=Lu(A),c=Lu(a);if(l===null||c===null)return r;let u=0,d=l;for(;d>c;)d-=12,u-=12;for(;d+12<=c;)d+=12,u+=12;return o.map(p=>{const f=Lu(p);if(f===null)return p;const m=f+u;return uF(m)??p})}return r}let Uc=!1,Zh=null,tf=null,ef=null,pA=null;const Ar="grab";function AR(n){if(Uc){n&&(n.style.cursor=Ar);return}Zh=document.body.style.cursor||null,tf=document.documentElement.style.cursor||null,ef=(n==null?void 0:n.style.cursor)??null,pA=n??null,n&&(n.style.cursor=Ar),document.body.style.cursor=Ar,document.documentElement.style.cursor=Ar,document.body.dataset.cursorOverride="stamp",Uc=!0}function _b(){Uc&&(pA&&pA.style.cursor===Ar&&(pA.style.cursor=ef??""),document.body.style.cursor===Ar&&(document.body.style.cursor=Zh??""),document.documentElement.style.cursor===Ar&&(document.documentElement.style.cursor=tf??""),document.body.dataset.cursorOverride==="stamp"&&delete document.body.dataset.cursorOverride,Uc=!1,Zh=null,tf=null,ef=null,pA=null)}let Dt=null,Ri=!1,$t=null,Js=[],an=[];const Ao=new Set;let Mi=!1,Ss=null;const Ib=new Kk,Op=new qk,Fb=new zk,aR=new Xk,Vp=new Yk,Wp=new Zk,Pc=new nR,_u=new iR,ao=new sR({noteToolInteractor:Op,chordToolInteractor:aR,eraserToolInteractor:Fb,stampToolInteractor:Vp,tripletToolInteractor:Wp,modulationToolInteractor:Ib,tonicizationToolInteractor:Pc,placementFillNoteIds:Ao,getPitchForRow:No,getTimeAlignedCanvasColumn:nf,getChordPitchesForRootPitch:n=>oR(n,h.state),findNearestMeasureBoundary:Db}),lR=275,cR=.25,nA=new rR({shouldUseMobileLongPress:hR,isPositionWithinPitchGrid:Ub,getSelectedTool:()=>h.state.selectedTool,getPitchHoverCtx:()=>Dt,clearOverlay:Do,drawHoverHighlight:LA,getNoteHoverColor:Qb,drawGhostNote:Pb,setGhostNotePosition:Sb,attemptPlaceNoteAt:dR,onNotePlaced:Nb,onNoteNotPlaced:Do},{longPressDelayMs:lR,ghostAlpha:cR}),Tb="#4a90e2";function uR(n,t=1){const e=n.startsWith("#")?n.slice(1):n;if(e.length!==6)return n;const s=parseInt(e.slice(0,2),16),i=parseInt(e.slice(2,4),16),r=parseInt(e.slice(4,6),16);return`rgba(${s}, ${i}, ${r}, ${t})`}function Qb(n=.2){var e;const t=((e=h.state.selectedNote)==null?void 0:e.color)||Tb;return uR(t,n)}function $0(){var n;return((n=h.state.selectedNote)==null?void 0:n.color)||Tb}function Mb(){return!!Yt.currentTool}function No(n){const t=h.state.fullRowData[n];return!t||t.isBoundary?null:t.toneNote}function nf(n){const t=n+2,e=kk(h.state,t);if(e===null)return null;const s=Rk(h.state,e);return s===null?null:Math.max(0,s-2)}function Ub(n,t){var o;const e=(h.state.selectedTool==="note"||h.state.selectedTool==="chord")&&((o=h.state.selectedNote)==null?void 0:o.shape)==="circle",i=(h.state.musicalColumnWidths&&h.state.musicalColumnWidths.length>0?h.state.musicalColumnWidths:h.state.columnWidths||[]).length,r=e?i-1:i;return n<0||n>=r?!1:No(t)!==null}function LA(n,t,e){var l;if(!Dt)return;const s={...h.state,zoomLevel:je.getViewportInfo().zoomLevel},i=it(n,s),o=Bt(t,h.state)-h.state.cellHeight/2,A=h.state.selectedTool;let a;if(h.state.modulationMarkers&&h.state.modulationMarkers.length>0?a=it(n+1,s)-i:a=(h.state.columnWidths[n]??1)*h.state.cellWidth,A==="eraser"||_u.getIsActive())h.state.modulationMarkers&&h.state.modulationMarkers.length>0?a=it(n+2,s)-i:a=h.state.cellWidth*2;else if(A==="note"&&((l=h.state.selectedNote)==null?void 0:l.shape)==="circle")h.state.modulationMarkers&&h.state.modulationMarkers.length>0?a=it(n+2,s)-i:a=h.state.cellWidth*2;else if(A==="sixteenthStamp")h.state.modulationMarkers&&h.state.modulationMarkers.length>0?a=it(n+2,s)-i:a=h.state.cellWidth*2;else if(A==="tripletStamp"){const c=ca.getSelectedTripletStamp();if(c){const d=2*(c.span==="eighth"?1:2);h.state.modulationMarkers&&h.state.modulationMarkers.length>0?a=it(n+d,s)-i:a=h.state.cellWidth*d}else a=h.state.cellWidth*2}else A==="tonicization"&&(h.state.modulationMarkers&&h.state.modulationMarkers.length>0?a=it(n+2,s)-i:a=h.state.cellWidth*2);Dt.fillStyle=e,Dt.fillRect(i,o,a,h.state.cellHeight)}function Pb(n,t,e=!1){if(!Dt||!h.state.selectedNote)return;const s=h.state.selectedTool,{shape:i,color:r}=h.state.selectedNote;if(Dt.globalAlpha=e?.2:.4,s==="note"){const o=i==="circle"?n+1:n,A={uuid:"ghost-note",globalRow:t,row:t,startColumnIndex:n,endColumnIndex:o,color:r,shape:i,isDrum:!1},a={...h.state,zoomLevel:je.getViewportInfo().zoomLevel};i==="oval"?cp(Dt,a,A,t):lp(Dt,a,A,t)}Dt.globalAlpha=1}function dR(n,t){const e=Op.attemptPlaceNoteAt(n,t,{activeNote:$t,lastDragRow:Ss,activePreviewPitches:an},Ao,{getPitchForRow:No});return $t=e.state.activeNote,Ss=e.state.lastDragRow,an=e.state.activePreviewPitches,e.placed&&e.shouldStartDragging&&(Ri=!0),e.placed}function hR(){if(h.state.selectedTool!=="note")return!1;const n=h.state.deviceProfile;if(n&&typeof n.isMobile=="boolean")return n.isMobile;if(typeof window<"u"&&typeof window.matchMedia=="function")try{return window.matchMedia("(pointer: coarse)").matches}catch{return!1}return!1}function fR(n){var a;if(Mb()){Do();return}if(!Dt)return;const t=n.target instanceof Element?n.target:null;if(!t)return;const e=t.getBoundingClientRect(),s=n.clientX-e.left,i=n.clientY-e.top,r=((a=document.getElementById("canvas-container"))==null?void 0:a.scrollLeft)??0,o=Qs.getColumnIndex(s+r),A=Qs.getPitchRowIndex(i);if(!Ub(o,A)){h.state.selectedTool;return}if(n.button===2&&_u.handleMouseDown({event:n,colIndex:o,rowIndex:A,annotationService:Yt})){Dt.clearRect(0,0,He(Dt.canvas),ie(Dt.canvas)),LA(o,A,"rgba(220, 53, 69, 0.3)");return}if(n.button===0){const l=s+r;if(Ib.handleMouseDown(l,i))return;const c=Op.handleExistingNoteMouseDown(o,A,{activeNote:$t,lastDragRow:Ss,activePreviewPitches:an},{getPitchForRow:No});if(c.handled){$t=c.state.activeNote,Ss=c.state.lastDragRow,an=c.state.activePreviewPitches;return}const u=h.state.selectedTool;if(u==="note"||u==="chord"){const p=Vp.tryStartShapeDrag({actualX:s+r,canvasY:i}),f=!p&&Wp.tryStartShapeDrag({actualX:s+r,canvasY:i});if(p||f)return;const m=se.getSixteenthStampAtPosition(o,A),g=Vi(o,h.state),w=g===null?null:se.getTripletStampAtPosition(g,A);if(m||w)return}const d=ao.handleToolMouseDown({toolType:u,colIndex:o,rowIndex:A,actualX:s+r,canvasY:i,state:{isDragging:Ri,isEraserDragActive:Mi,activeNote:$t,activeChordNotes:Js,activePreviewPitches:an,lastDragRow:Ss}});if(d.handled){Ri=d.state.isDragging,Mi=d.state.isEraserDragActive,$t=d.state.activeNote,Js=d.state.activeChordNotes,an=d.state.activePreviewPitches,Ss=d.state.lastDragRow;return}}}function pR(n){var U,P,K;if(Mb()){Do();return}if(!Dt)return;const t=n.target instanceof Element?n.target:null;if(!t)return;const e=t.getBoundingClientRect(),s=n.clientX-e.left,i=n.clientY-e.top,r=((U=document.getElementById("canvas-container"))==null?void 0:U.scrollLeft)??0,o=Qs.getColumnIndex(s+r),A=Qs.getPitchRowIndex(i);if(!Dt)return;Dt.clearRect(0,0,He(Dt.canvas),ie(Dt.canvas));const a=n.target instanceof HTMLElement?n.target:null,l=h.state.selectedTool,c=s+r,u=Vi(o,h.state);if(ao.handleToolMouseMoveBeforeBoundsCheck({actualX:c,rowIndex:A,canvasEl:a,state:{isDragging:Ri,isEraserDragActive:Mi,activeNote:$t,activeChordNotes:Js,activePreviewPitches:an,lastDragRow:Ss}}).handled)return;ao.handleToolHoverVisuals({toolType:l,actualX:c,canvasY:i,pitchHoverCtx:Dt,canvasEl:a,selectedModulationRatio:h.state.selectedModulationRatio,findNearestMeasureBoundary:Db,drawModulationPreview:mR});const p=(h.state.selectedTool==="note"||h.state.selectedTool==="chord")&&((P=h.state.selectedNote)==null?void 0:P.shape)==="circle",f=h.state.columnWidths.length,m=p?f-1:f;if(o<0||o>=m||No(A)===null){Pc.resetHoverState(),Eb();return}Sb(o,A);const g=se.getSixteenthStampAtPosition(o,A),w=u===null?null:se.getTripletStampAtPosition(u,A),B=!!(g||w),b=B&&(l==="note"||l==="chord");if(B&&l!=="eraser"&&!Vp.isDraggingShape()&&!Wp.isDraggingShape()?AR(a):_b(),(l==="sixteenthStamp"||l==="tripletStamp")&&B)return;const C=ao.handleNoteOrChordDragMouseMove({colIndex:o,rowIndex:A,state:{isDragging:Ri,isEraserDragActive:Mi,activeNote:$t,activeChordNotes:Js,activePreviewPitches:an,lastDragRow:Ss}});if(C.handled){Ri=C.state.isDragging,Mi=C.state.isEraserDragActive,$t=C.state.activeNote,Js=C.state.activeChordNotes,an=C.state.activePreviewPitches,Ss=C.state.lastDragRow;return}if(!b&&ao.handleChordToolHover({colIndex:o,rowIndex:A,pitchHoverCtx:Dt,zoomLevel:je.getViewportInfo().zoomLevel,drawSingleColumnOvalNote:cp,drawTwoColumnOvalNote:lp}))return;if(_u.handleMouseMove({event:n,colIndex:o,rowIndex:A,annotationService:Yt})){LA(o,A,"rgba(220, 53, 69, 0.3)");return}if(Fb.handleMouseMove(o,A,Mi)){LA(o,A,"rgba(220, 53, 69, 0.3)");return}if(Dt&&Pc.handleMouseMove({colIndex:o,rowIndex:A,hoverCtx:Dt,getPitchForRow:No})||b)return;const y=Ve(h.state),S=((K=h.state.selectedNote)==null?void 0:K.shape)==="circle";let F=null,x=!0;if(h.state.selectedTool==="note"||h.state.selectedTool==="chord")x=jA(o,h.state)&&(!S||jA(o+1,h.state));else if(h.state.selectedTool==="sixteenthStamp"){const M=nf(o);x=M!==null&&!Zd(M,y)&&!Zd(M+1,y)}else if(h.state.selectedTool==="tripletStamp"){const M=ca.getSelectedTripletStamp();if(M){const k=Vi(o,h.state);if(k===null)x=!1;else{F=k;const R=(eB[M.span]??1)*2,J=gn(F,h.state);x=!0;for(const tt of y){const rt=tt.columnIndex,lt=tt.columnIndex+1;if(rt>=J&&rt<J+R){x=!1;break}if(J>=rt&&J<=lt){x=!1;break}}}}}const Q=h.state.selectedTool==="eraser"?"rgba(220, 53, 69, 0.3)":x?Qb(.2):"rgba(220, 53, 69, 0.15)";if(LA(o,A,Q),h.state.selectedTool==="sixteenthStamp"){const M=Eu.getSelectedSixteenthStamp();if(M&&x){const k=nf(o);if(k===null)return;const N={cellWidth:h.state.cellWidth,cellHeight:h.state.cellHeight,columnWidths:h.state.columnWidths,musicalColumnWidths:h.state.columnWidths,modulationMarkers:h.state.modulationMarkers,baseMicrobeatPx:h.state.cellWidth,macrobeatGroupings:h.state.macrobeatGroupings,previewColor:$0()};qT(Dt,k,A,M,N)}}else if(h.state.selectedTool==="tripletStamp"){const M=ca.getSelectedTripletStamp();if(M&&x&&F!==null){const k={cellWidth:h.state.cellWidth,cellHeight:h.state.cellHeight,columnWidths:h.state.columnWidths,musicalColumnWidths:h.state.columnWidths,modulationMarkers:h.state.modulationMarkers,baseMicrobeatPx:h.state.cellWidth,macrobeatGroupings:h.state.macrobeatGroupings,previewColor:$0()};YT(Dt,F,A,M,k)}}else x&&Pb(o,A)}function Do(){Dt&&Dt.clearRect(0,0,He(Dt.canvas),ie(Dt.canvas)),_b(),Pc.resetHoverState(),Eb()}function Nb(){var n,t,e,s,i,r,o;if(!ao.handleToolMouseUp()){if(an.length>0){se.stopCurrentPattern();const A=($t==null?void 0:$t.color)??((n=Js[0])==null?void 0:n.color)??((t=h.state.selectedNote)==null?void 0:t.color);A&&on.releasePitches(an,A);const a=$t;if(a&&A){const c=(e=h.state.timbres[A])==null?void 0:e.adsr;if(c){const u=((s=h.state.fullRowData[a.row])==null?void 0:s.hex)||"#888888";(i=Rn.adsrComponent)==null||i.playheadManager.trigger(a.uuid,"release",u,c)}}else if(A){const c=an[0];if(!c){an=[];return}const u=h.state.fullRowData.find(d=>d.toneNote===c);if(u){const d=(r=h.state.timbres[A])==null?void 0:r.adsr;if(d){const p=u.hex;(o=Rn.adsrComponent)==null||o.playheadManager.trigger("chord_preview","release",p,d)}}}an=[];const l=window.waveformVisualizer;l&&l.stopLiveVisualization()}$t!=null&&$t.uuid&&Ao.has($t.uuid)&&(h.emit("noteRelease",{noteId:$t.uuid,color:$t.color}),Ao.delete($t.uuid)),Js.forEach(A=>{A!=null&&A.uuid&&Ao.has(A.uuid)&&(h.emit("noteRelease",{noteId:A.uuid,color:A.color}),Ao.delete(A.uuid))}),Ri&&h.recordState(),Ri=!1,Ss=null,$t!=null&&$t.uuid&&h.emit("noteInteractionEnd",{noteId:$t.uuid}),Js.forEach(A=>{A.uuid&&h.emit("noteInteractionEnd",{noteId:A.uuid})}),$t=null,Js=[],Mi&&(h.recordState(),Mi=!1),_u.handleGlobalMouseUp(),Do()}}function Db(n){const{macrobeatBoundaryStyles:t}=h.state,e=100,s=[],i=h.state.modulationMarkers&&h.state.modulationMarkers.length>0;E.debug("PitchGridInteractor","Boundary calculation modulation state",{hasModulation:i},"grid");for(let a=0;a<t.length;a++)if(t[a]==="solid"){const l=dn(h.state,a);if(l){const c=l.endColumn+1,u=it(c,{...h.state,modulationMarkers:h.state.modulationMarkers||[],cellWidth:h.state.cellWidth,columnWidths:h.state.columnWidths,musicalColumnWidths:h.state.columnWidths,baseMicrobeatPx:h.state.cellWidth});E.debug("PitchGridInteractor","Computed measure boundary",{boundaryIndex:a,endColumn:l.endColumn,calculatedX:u,method:"canvas-space"},"grid"),s.push({measureIndex:a+1,xPosition:u,macrobeatIndex:a})}}const r=it(0,{...h.state,modulationMarkers:h.state.modulationMarkers||[],cellWidth:h.state.cellWidth,columnWidths:h.state.columnWidths,musicalColumnWidths:h.state.columnWidths,baseMicrobeatPx:h.state.cellWidth});E.debug("PitchGridInteractor","Start boundary position",{startBoundaryX:r,method:"canvas-space"},"grid"),s.unshift({measureIndex:0,xPosition:r,macrobeatIndex:-1}),E.debug("PitchGridInteractor","Available measure boundaries",{boundaries:s},"grid"),E.debug("PitchGridInteractor","Modulation click context",{clickX:n,tolerance:e},"grid");let o=null,A=1/0;return s.forEach(a=>{const l=Math.abs(n-a.xPosition);E.debug("PitchGridInteractor","Boundary distance check",{boundaryX:a.xPosition,distance:l},"grid"),l<=e&&l<A&&(A=l,o=a)}),o?E.debug("PitchGridInteractor","Found closest boundary",{boundary:o,distance:A},"grid"):E.debug("PitchGridInteractor","No boundary found within tolerance",{tolerance:e},"grid"),o}function mR(n,t,e){if(!e)return;const s=Mv(e),i=Qv(e);n.save();const r=3,o=2,A=ie(n.canvas);n.strokeStyle=s,n.lineWidth=o,n.globalAlpha=.7,n.setLineDash([]);for(let a=-1;a<=1;a++){const l=t+a*r;n.beginPath(),n.moveTo(l,0),n.lineTo(l,A),n.stroke()}n.globalAlpha=.8,n.font="12px Arial, sans-serif",n.textAlign="center",n.textBaseline="top",n.fillStyle=s,n.fillText(`Preview: ${i}`,t,10),n.restore()}function gR(){const n=document.getElementById("notation-grid"),t=document.getElementById("hover-canvas");if(!n||!t){E.error("PitchGridInteractor","Could not find required canvas elements.",{hasPitchCanvas:!!n,hasHoverCanvas:!!t},"grid");return}if(Dt=t.getContext("2d"),!Dt){E.error("PitchGridInteractor","Could not get hover canvas context.",null,"grid");return}nA.setPitchCanvasElement(n),n.addEventListener("mousedown",fR),n.addEventListener("mousemove",pR),n.addEventListener("mouseleave",Do),n.addEventListener("contextmenu",e=>e.preventDefault()),n.addEventListener("touchstart",e=>nA.handleTouchStart(e),{passive:!1}),n.addEventListener("touchmove",e=>nA.handleTouchMove(e),{passive:!1}),n.addEventListener("touchend",e=>nA.handleTouchEnd(e),{passive:!1}),n.addEventListener("touchcancel",()=>nA.handleTouchCancel(),{passive:!1}),window.addEventListener("mouseup",Nb)}const wR={init(){gR(),Lk(),document.addEventListener("canvasResized",()=>{this.renderPitchGrid(),this.renderDrumGrid()}),h.on("animationUpdate",n=>{n.type==="vibrato"&&n.activeColors&&n.activeColors.length>0?this.renderPitchGrid():n.type==="envelopeFill"||n.hasEnvelopeFills?this.renderPitchGrid():n.type==="combined"&&n.vibratoColors&&n.vibratoColors.length>0&&this.renderPitchGrid()}),E.debug("GridManager","Initialized pitch and drum grid interactions",null,"grid")},renderPitchGrid:ta.render,renderDrumGrid:ze.render};function vR(){const n=pe.init();return YA.setContexts(n),vk.init(),wR.init(),n}class BR{constructor(){I(this,"currentTool",null);I(this,"toolButtons",[]);I(this,"toolPanels",[]);I(this,"lastSelectedNote",null);I(this,"optionsContainers",{arrow:null,text:null,marker:null,highlighter:null,lasso:null});I(this,"settings",{arrow:{lineStyle:"solid",strokeWeight:4,startArrowhead:"none",endArrowhead:"filled-arrow",arrowheadSize:12},text:{color:"#000000",size:16,bold:!1,italic:!1,underline:!1,background:!1,superscript:!1,subscript:!1},marker:{color:"#4a90e2",size:6},highlighter:{color:"#4a90e2",size:10},lasso:{}})}initialize(){if(this.toolButtons=document.querySelectorAll(".draw-tool-button"),this.toolPanels=document.querySelectorAll(".draw-tool-panel"),this.optionsContainers={arrow:document.getElementById("arrow-tool-options"),text:document.getElementById("text-tool-options"),marker:document.getElementById("marker-tool-options"),highlighter:document.getElementById("highlighter-tool-options"),lasso:document.getElementById("lasso-tool-options")},!this.toolButtons.length||!this.optionsContainers.arrow){E.warn("DrawToolsController","Could not find draw tool elements",null,"draw");return}this.attachEventListeners(),this.setupChordTabListeners(),this.setupMainTabListeners(),this.populateAllPanels(),this.initializePanelWidthSync(),this.logPanelMetrics(),window.addEventListener("resize",()=>this.logPanelMetrics(),{passive:!0}),h.on("noteChanged",({newNote:t}={})=>{this.lastSelectedNote=t??null,this.currentTool&&this.deselectAllTools()})}attachEventListeners(){this.toolButtons.forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.drawTool;this.selectTool(e)})})}setupMainTabListeners(){document.querySelectorAll(".tab-button").forEach(e=>{e.addEventListener("click",()=>{e.dataset.tab!=="pitch"&&this.currentTool&&(this.deselectAllTools(),this.restoreLastSelectedNote())})})}setupChordTabListeners(){document.querySelectorAll(".pitch-tab-button").forEach(e=>{e.addEventListener("click",()=>{e.dataset.pitchTab!=="draw"&&this.currentTool&&(this.deselectAllTools(),this.restoreLastSelectedNote())})})}restoreLastSelectedNote(){this.lastSelectedNote?(h.setSelectedNote(this.lastSelectedNote.shape,this.lastSelectedNote.color),h.setSelectedTool("note")):h.state.selectedNote&&(h.setSelectedNote(h.state.selectedNote.shape,h.state.selectedNote.color),h.setSelectedTool("note"))}deselectAllTools(){this.toolButtons.forEach(t=>t.classList.remove("active")),this.toolPanels.forEach(t=>t.classList.remove("active")),this.currentTool=null,Yt.setTool(null,null),h.state.selectedTool==="draw"&&h.setSelectedTool("note")}selectTool(t){var s;this.toolButtons.forEach(i=>i.classList.remove("active")),this.toolPanels.forEach(i=>i.classList.remove("active"));const e=Array.from(this.toolButtons).find(i=>i.dataset.drawTool===t);if(e){e.classList.add("active");const i=e.closest(".draw-tool-panel");i==null||i.classList.add("active")}this.currentTool=t,Yt.setTool(t,this.settings),h.setSelectedTool("draw"),h.state.selectedNote={shape:"circle",color:((s=h.state.selectedNote)==null?void 0:s.color)||"#4a90e2"}}populateAllPanels(){this.populateArrowOptions(),this.populateTextOptions(),this.populateMarkerOptions(),this.populateHighlighterOptions()}initializePanelWidthSync(){const t=Array.from(this.toolPanels);t.length&&t.forEach(e=>{e.style.minWidth="",e.style.width="fit-content",e.style.maxWidth="100%",e.style.flex="0 0 auto"})}logPanelMetrics(){try{const t=document.querySelector(".draw-layout-grid");Array.from(this.toolPanels??[]).forEach(s=>{s.getBoundingClientRect()}),t==null||t.getBoundingClientRect()}catch{}}populateArrowOptions(){const t=this.optionsContainers.arrow;if(!t)return;const e=t.querySelector("#arrow-start-head-trigger"),s=t.querySelector("#arrow-end-head-trigger"),i=(d,p)=>p!=="filled-arrow"?`
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="4" y1="12" x2="20" y2="12"/>
          </svg>
        `:d==="start"?`
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9,5 3,12 9,19"/>
            <line x1="3" y1="12" x2="21" y2="12"/>
          </svg>
        `:`
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15,5 21,12 15,19"/>
          <line x1="3" y1="12" x2="21" y2="12"/>
        </svg>
      `,r=(d,p,f)=>{d&&(d.innerHTML=i(p,f))},o=t.querySelector("#arrow-stroke-weight");o&&(o.value=`${this.settings.arrow.strokeWeight}`,o.addEventListener("input",()=>{this.settings.arrow.strokeWeight=parseInt(o.value,10),Yt.setTool("arrow",this.settings)}));const A=t.querySelector("#arrow-head-size");A&&(A.value=`${this.settings.arrow.arrowheadSize}`,A.addEventListener("input",()=>{this.settings.arrow.arrowheadSize=parseInt(A.value,10),Yt.setTool("arrow",this.settings)}));const a=Array.from(t.querySelectorAll("[data-line-style]"));if(a.length){const d=p=>{a.forEach(f=>f.classList.toggle("active",f.dataset.lineStyle===p))};d(this.settings.arrow.lineStyle),a.forEach(p=>{p.addEventListener("click",()=>{const f=p.dataset.lineStyle;f&&(this.settings.arrow.lineStyle=f,d(f),Yt.setTool("arrow",this.settings))})})}const l=Array.from(t.querySelectorAll("[data-arrow-start]"));if(l.length){const d=p=>{l.forEach(f=>f.classList.toggle("active",f.dataset.arrowStart===p)),r(e,"start",p)};d(this.settings.arrow.startArrowhead),l.forEach(p=>{p.addEventListener("click",()=>{const f=p.dataset.arrowStart;f&&(this.settings.arrow.startArrowhead=f,d(f),Yt.setTool("arrow",this.settings))})})}const c=Array.from(t.querySelectorAll("[data-arrow-end]"));if(c.length){const d=p=>{c.forEach(f=>f.classList.toggle("active",f.dataset.arrowEnd===p)),r(s,"end",p)};d(this.settings.arrow.endArrowhead),c.forEach(p=>{p.addEventListener("click",()=>{const f=p.dataset.arrowEnd;f&&(this.settings.arrow.endArrowhead=f,d(f),Yt.setTool("arrow",this.settings))})})}const u=t.querySelector("#arrow-swap-heads");u&&u.addEventListener("click",()=>{const d=this.settings.arrow.startArrowhead;if(this.settings.arrow.startArrowhead=this.settings.arrow.endArrowhead,this.settings.arrow.endArrowhead=d,l.length){const p=this.settings.arrow.startArrowhead;l.forEach(f=>f.classList.toggle("active",f.dataset.arrowStart===p)),r(e,"start",p)}if(c.length){const p=this.settings.arrow.endArrowhead;c.forEach(f=>f.classList.toggle("active",f.dataset.arrowEnd===p)),r(s,"end",p)}Yt.setTool("arrow",this.settings)})}populateTextOptions(){const t=this.optionsContainers.text;if(!t)return;const e=t.querySelector("#text-size-input");e&&(e.value=`${this.settings.text.size}`,e.addEventListener("input",()=>{this.settings.text.size=parseInt(e.value,10),Yt.setTool("text",this.settings)}));const s=Array.from(t.querySelectorAll(".draw-color-button"));if(s.length){const r=o=>{s.forEach(A=>{const a=A.dataset.color||"";A.classList.toggle("active",a.toLowerCase()===o.toLowerCase())})};r(this.settings.text.color),s.forEach(o=>{o.addEventListener("click",()=>{const A=o.dataset.color;A&&(this.settings.text.color=A,r(A),Yt.setTool("text",this.settings))})})}const i=Array.from(t.querySelectorAll("[data-text-style]"));if(i.length){const r=["bold","italic","underline","background","superscript","subscript"],o=A=>{this.settings.text[A]=!this.settings.text[A],Yt.setTool("text",this.settings)};i.forEach(A=>{const a=A.dataset.textStyle;a&&r.includes(a)&&A.classList.toggle("active",!!this.settings.text[a])}),i.forEach(A=>{A.addEventListener("click",()=>{const a=A.dataset.textStyle;!a||!r.includes(a)||(o(a),A.classList.toggle("active",!!this.settings.text[a]))})})}}populateMarkerOptions(){const t=this.optionsContainers.marker;if(!t)return;const e=t.querySelector("#marker-size-input");e&&(e.value=`${this.settings.marker.size}`,e.addEventListener("input",()=>{this.settings.marker.size=parseInt(e.value,10),Yt.setTool("marker",this.settings)}));const s=Array.from(t.querySelectorAll(".draw-color-button"));if(s.length){const i=r=>{s.forEach(o=>{const A=o.dataset.color||"";o.classList.toggle("active",A.toLowerCase()===r.toLowerCase())})};i(this.settings.marker.color),s.forEach(r=>{r.addEventListener("click",()=>{const o=r.dataset.color;o&&(this.settings.marker.color=o,i(o),Yt.setTool("marker",this.settings))})})}}populateHighlighterOptions(){const t=this.optionsContainers.highlighter;if(!t)return;const e=t.querySelector("#highlighter-size-input");e&&(e.value=`${this.settings.highlighter.size}`,e.addEventListener("input",()=>{this.settings.highlighter.size=parseInt(e.value,10),Yt.setTool("highlighter",this.settings)}));const s=Array.from(t.querySelectorAll(".draw-color-button"));if(s.length){const i=r=>{s.forEach(o=>{const A=o.dataset.color||"";o.classList.toggle("active",A.toLowerCase()===r.toLowerCase())})};i(this.settings.highlighter.color),s.forEach(r=>{r.addEventListener("click",()=>{const o=r.dataset.color;o&&(this.settings.highlighter.color=o,i(o),Yt.setTool("highlighter",this.settings))})})}}}const Id=new BR;function CR(){var n;return Yt.initialize(),(n=Id.initialize)==null||n.call(Id),E.initSuccess("DrawSystem"),typeof window<"u"&&(window.annotationService=Yt),{annotationService:Yt}}E.moduleLoaded("KeyboardHandler","keyboard");function bR(){document.addEventListener("keydown",n=>{var r;const t=document.activeElement;if(!t)return;const e=t.tagName.toLowerCase(),s=t.contentEditable==="true";if(["input","textarea"].includes(e)||s)return;if(n.ctrlKey&&n.key.toLowerCase()==="p"){n.preventDefault(),E.info("KeyboardHandler","Ctrl+P pressed. Opening print preview",null,"keyboard"),h.emit("printPreviewStateChanged",!0);return}if(n.ctrlKey&&n.key.toLowerCase()==="z"){n.preventDefault(),h.undo();return}if(n.ctrlKey&&n.key.toLowerCase()==="y"){n.preventDefault(),h.redo();return}let i=!1;switch(n.key){case"Backspace":case"Delete":if((r=h.state.lassoSelection)!=null&&r.isActive){const o=h.state.lassoSelection.selectedItems;o.forEach(A=>{if(A.type==="note"){const a=A.data,l=h.state.placedNotes.findIndex(c=>c.uuid===a.uuid);l!==-1&&h.state.placedNotes.splice(l,1)}else if(A.type==="sixteenthStamp"){const a=A.data,l=h.state.sixteenthStampPlacements.findIndex(c=>c.id===a.id);l!==-1&&h.state.sixteenthStampPlacements.splice(l,1)}else if(A.type==="tripletStamp"){const a=A.data,l=h.state.tripletStampPlacements.findIndex(c=>c.id===a.id);l!==-1&&h.state.tripletStampPlacements.splice(l,1)}}),h.state.lassoSelection={selectedItems:[],convexHull:null,isActive:!1},h.recordState(),h.emit("render"),i=!0,E.info("KeyboardHandler",`Deleted ${o.length} items from lasso selection`,null,"keyboard")}break}i&&n.preventDefault()}),E.info("KeyboardHandler","Initialized",null,"keyboard")}E.moduleLoaded("TransportKeyboardShortcuts","keyboard");function yR(){const n=document.activeElement;if(!(n instanceof HTMLElement))return!0;const t=n.tagName.toLowerCase();return!(["input","textarea","select"].includes(t)||n.isContentEditable)}function SR(){let n=!1;document.addEventListener("keydown",t=>{if(t.code!=="Space"||n||t.repeat||!yR())return;const e=document.getElementById("play-button");e&&(t.preventDefault(),n=!0,e.click())}),document.addEventListener("keyup",t=>{t.code==="Space"&&(n=!1)}),E.info("TransportKeyboardShortcuts","Initialized",null,"keyboard")}const ER=[{label:"Toolbar",selector:"#toolbar"},{label:"Toolbar Primary",selector:"#toolbar-primary"},{label:"Primary Actions Grid",selector:"#toolbar-primary .primary-toolbar-actions"},{label:"Primary Playback Row",selector:"#toolbar-primary .primary-toolbar-playback"},{label:"Toolbar Secondary",selector:"#toolbar-secondary"},{label:"Toolbar Preset Controls",selector:"#toolbar-secondary .preset-effects-controls"},{label:"Toolbar Tab Sidebar",selector:"#toolbar-secondary .tab-sidebar"},{label:"Sidebar",selector:"#sidebar"},{label:"Timbre Tab Panel",selector:"#timbre-panel"},{label:"Pitch Tab Panel",selector:"#pitch-panel"},{label:"Rhythm Tab Panel",selector:"#rhythm-panel"},{label:"Macrobeat Tools",selector:"#canvas-macrobeat-tools, #macrobeat-tools"},{label:"Waveform Card",selector:"#timbre-panel .waveform-content-box"},{label:"Preset Card",selector:"#timbre-panel .preset-content-box"},{label:"Effects Card",selector:"#timbre-panel #effects-panel .effects-content-box"},{label:"Envelope Card",selector:"#adsr-envelope"},{label:"Harmonics Card",selector:".harmonic-bins-container"},{label:"Canvas Container",selector:"#canvas-container"},{label:"Pitch Grid Wrapper",selector:"#pitch-grid-wrapper"},{label:"Pitch Grid Container",selector:"#pitch-grid-container"},{label:"Drum Grid Wrapper",selector:"#drum-grid-wrapper"},{label:"Drum Grid",selector:"#drum-grid"}],sf=new Map;let rf,Fd,Td=null,sA="",lo=!1;function yl(n){return Number.isFinite(n)?Number(n.toFixed(1)):n}function xR(n){const t=n.getBoundingClientRect(),e=window.getComputedStyle(n);return{tag:n.tagName.toLowerCase(),id:n.id||null,class:n.className||null,top:yl(t.top),left:yl(t.left),width:yl(t.width),height:yl(t.height),offsetWidth:n.offsetWidth,offsetHeight:n.offsetHeight,scrollWidth:n.scrollWidth,scrollHeight:n.scrollHeight,clientWidth:n.clientWidth,clientHeight:n.clientHeight,display:e.display,position:e.position,overflowX:e.overflowX,overflowY:e.overflowY,transform:e.transform!=="none"?e.transform:void 0}}function Lb(n="manual"){const t=window.__uiDiagnosticsTrackedElements;if(!t)return[];if(!lo&&n!=="manual")return[];Gl();const e=[];return t.forEach(s=>{const i=Array.from(document.querySelectorAll(s.selector));if(!i.length){e.push({label:s.label,selector:s.selector,missing:!0});return}i.forEach((r,o)=>{const A=i.length>1?`${s.label} [${o}]`:s.label,a=xR(r);e.push({label:A,selector:s.selector,info:a})})}),window.__uiDiagnosticsLastSnapshot=e,e}function Yr(n){lo&&(sA=sA?`${sA}; ${n}`:n,Td===null&&(Td=requestAnimationFrame(()=>{const t=sA||"auto";Td=null,sA="",Lb(t)})))}function Gl(){const n=window.__uiDiagnosticsTrackedElements;!n||!rf||n.forEach(t=>{document.querySelectorAll(t.selector).forEach(s=>{sf.has(s)||(sf.set(s,t.label),rf.observe(s),s.addEventListener("scroll",()=>Yr(`${t.label} scroll`),{passive:!0}))})})}function _R(n={}){if(window.__uiDiagnosticsInitialized)return;window.__uiDiagnosticsInitialized=!0;const{elements:t,autoLog:e=!1}=n;lo=!!e,window.__uiDiagnosticsAutoLog=lo;const s=t||ER;window.__uiDiagnosticsTrackedElements=s,rf=new ResizeObserver(i=>{const r=i.map(o=>sf.get(o.target)||o.target.id||o.target.tagName.toLowerCase()).filter(Boolean);r.length&&Yr(`Resize: ${r.join(", ")}`)}),Fd=new MutationObserver(()=>Gl()),document.body?Fd.observe(document.body,{childList:!0,subtree:!0}):document.addEventListener("DOMContentLoaded",()=>{Fd.observe(document.body,{childList:!0,subtree:!0}),Gl(),Yr("init")},{once:!0}),window.addEventListener("resize",()=>Yr("window resize")),Gl(),Yr("init"),window.logUIState=(i="manual")=>Lb(i),window.enableUIDiagnosticsAutoLog=()=>{lo=!0,window.__uiDiagnosticsAutoLog=!0,Yr("auto-log enabled")},window.disableUIDiagnosticsAutoLog=()=>{lo=!1,window.__uiDiagnosticsAutoLog=!1}}function IR(){E.section("SETTING UP INPUT HANDLERS"),bR(),SR(),Vk(),window.enableUIDiagnostics&&_R()}function FR(){h.on("tempoChanged",()=>{kt.setBpm(h.state.tempo)}),h.on("layoutChanged",()=>{pe.reflow()}),h.on("rhythmPatternChanged",()=>{se.refresh&&se.refresh()});const n=()=>{var t;try{ta.render(),(t=ze.render)==null||t.call(ze),E.debug("StateSubscriptions","renderAll invoked",null,"grid")}catch(e){E.error("StateSubscriptions","renderAll failed",e,"grid")}};return h.on("notesChanged",n),h.on("sixteenthStampPlacementsChanged",n),h.on("tripletStampPlacementsChanged",n),h.on("accidentalModeChanged",n),h.on("frequencyLabelsChanged",n),h.on("focusColoursChanged",n),h.on("octaveLabelsChanged",n),h.on("degreeDisplayModeChanged",n),h.on("longNoteStyleChanged",n),h.on("layoutConfigChanged",()=>{ta.renderMacrobeatTools()}),h.on("rhythmStructureChanged",()=>{pe.reflow()}),h.on("modulationMarkersChanged",()=>{pe.reflow(),n()}),E.initSuccess("StateSubscriptions"),{renderAll:n}}let of=!1,er=[],Qd=!1,qr=null,Md=!1;function TR(){Qd=!1,qr=null,Md=!1,window.initAudio=async()=>{if(!Qd)return qr||(qr=(async()=>{try{GA.state!=="running"&&(await ec(),E.info("Main.js","AudioContext started successfully")),Qd=!0}catch(e){throw E.error("Main.js","Could not start AudioContext",e),qr=null,e}})(),qr)};const n=()=>{var e;Md||(Md=!0,(e=window.initAudio)==null||e.call(window).catch(s=>E.warn("Main.js","Failed to initialize audio after user interaction",s,"initialization")),document.removeEventListener("click",n,!0),document.removeEventListener("keydown",n,!0),document.removeEventListener("touchstart",n,!0))},t=()=>{typeof kt.teardown=="function"&&kt.teardown()};document.addEventListener("click",n,!0),document.addEventListener("keydown",n,!0),document.addEventListener("touchstart",n,!0),window.addEventListener("beforeunload",t),er.push(()=>document.removeEventListener("click",n,!0)),er.push(()=>document.removeEventListener("keydown",n,!0)),er.push(()=>document.removeEventListener("touchstart",n,!0)),er.push(()=>window.removeEventListener("beforeunload",t)),er.push(()=>{delete window.initAudio})}const Lo={domCache:!1,layoutService:!1,canvasContextService:!1,synthEngine:!1,transportService:!1,scrollSync:!1,uiComponents:!1,audioComponents:!1,rhythmPlaybackService:!1,initialized:!1},QR={top:"G5",bottom:"C4"};function MR(n){if(!(n!=null&&n.top)||!(n!=null&&n.bottom))return null;const t=Pn.findIndex(s=>s.toneNote===n.top),e=Pn.findIndex(s=>s.toneNote===n.bottom);return t===-1||e===-1?(E.warn("Main.js","Failed to resolve preset range from tone notes",n),null):{topIndex:Math.min(t,e),bottomIndex:Math.max(t,e)}}function UR(){return MR(QR)}function Vs(n){Lo[n]=!0}function Y0(n,t=5e3){return new Promise((e,s)=>{if(Lo[n]){e();return}const i=Date.now(),r=()=>{Lo[n]?e():Date.now()-i>t?s(new Error(`Component ${n} not ready within ${t}ms`)):setTimeout(r,50)};r()})}function kb(){Object.keys(Lo).forEach(n=>{Lo[n]=!1})}async function PR(){window.initStartTime=Date.now(),E.info("Main.js","Initialization triggered"),E.section("STARTING INITIALIZATION");const n=["dom-cache","drum-samples","state-setup","canvas-services","layout-ready","synth-engine","rhythm-playback","transport-service","input-handlers","store-hooks","ui-components","audio-components","state-subscriptions","initial-render","finalize"];try{gt.init(),n.forEach(o=>gt.registerTask(o)),await gt.nextFrame(),zN(),sI({latencyHint:"playback",lookAhead:.1}),E.info("Main.js","AudioContext configured with latencyHint: playback"),(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&CC(),gt.updateStatus("Initializing interface..."),Ai.init(),Vs("domCache"),gt.completeTask("dom-cache"),await gt.nextFrame(),gt.updateStatus("Loading audio samples..."),await rD(),gt.completeTask("drum-samples"),E.info("Main.js","Drum samples preloaded"),await gt.nextFrame(),(()=>{const o=Ai.get("appContainer")||document.getElementById("app-container");if(o){const A=["click","keydown","touchstart"],a=()=>{var l;(l=window.initAudio)==null||l.call(window)};A.forEach(l=>{o.addEventListener(l,a,{once:!0})})}})(),gt.updateStatus("Preparing core systems..."),ZN(h.state);const e=h.state.pitchRange||{topIndex:0,bottomIndex:Pn.length-1},s=Math.max(0,Math.min(Pn.length-1,e.topIndex??0)),i=Math.max(s,Math.min(Pn.length-1,e.bottomIndex??Pn.length-1));h.state.pitchRange={topIndex:s,bottomIndex:i},h.state.fullRowData=[...Pn],gt.completeTask("state-setup"),await gt.nextFrame(),gt.updateStatus("Sizing canvas..."),vR(),Vs("layoutService"),Vs("canvasContextService"),gt.completeTask("canvas-services"),await gt.nextFrame(),gt.updateStatus("Calculating layout..."),await pe.waitForInitialLayout(),gt.completeTask("layout-ready"),await gt.nextFrame(),gt.updateStatus("Initializing synth engine..."),kt.init(),Vs("synthEngine"),gt.completeTask("synth-engine"),await gt.nextFrame(),gt.updateStatus("Preparing rhythm playback..."),se.initialize().catch(o=>{E.warn("Main.js","RhythmPlaybackService initialization deferred (needs user interaction)",o,"initialization")}),Vs("rhythmPlaybackService"),gt.completeTask("rhythm-playback"),await gt.nextFrame(),gt.updateStatus("Configuring transport..."),Ys.init(),Vs("transportService"),gt.completeTask("transport-service"),await gt.nextFrame(),gt.updateStatus("Registering input handlers..."),IR(),gt.completeTask("input-handlers"),await gt.nextFrame(),gt.updateStatus("Syncing state services..."),OF(h),YF(h),AI({getColumnMap:o=>Fe.getColumnMap(o),visualToTimeIndex:(o,A)=>Fe.getColumnMap(o).visualToTime.get(A)??null,timeIndexToVisualColumn:(o,A)=>Fe.getColumnMap(o).timeToVisual.get(A)??null,getTimeBoundaryAfterMacrobeat:(o,A)=>{const l=Fe.getColumnMap(o).macrobeatBoundaries.find(c=>c.macrobeatIndex===A);return l?l.timeColumn+1:0}}),gt.completeTask("store-hooks"),await gt.nextFrame(),gt.updateStatus("Loading interface components..."),S5(),Vs("uiComponents"),gt.completeTask("ui-components"),await gt.nextFrame(),await Y0("uiComponents"),gt.updateStatus("Preparing audio components..."),fk(),Vs("audioComponents"),gt.completeTask("audio-components"),await gt.nextFrame(),tD(h.state,"audio-components-initialization"),gk(),CR(),await Y0("audioComponents"),E.section("SETTING UP STATE SUBSCRIPTIONS"),gt.updateStatus("Binding state subscriptions...");const{renderAll:r}=FR();if(gt.completeTask("state-subscriptions"),await gt.nextFrame(),E.section("PERFORMING INITIAL RENDER"),h.setSelectedTool("note"),h.setSelectedNote("circle","#4a90e2"),gt.updateStatus("Rendering workspace..."),r(),ta.renderMacrobeatTools(),gt.completeTask("initial-render"),Nl.prefetchButtonGridSnapshot(),await gt.nextFrame(),Vs("initialized"),E.section("INITIALIZATION COMPLETE"),gt.updateStatus("Finalizing..."),gt.completeTask("finalize"),await gt.nextFrame(),h.isColdStart){const o=UR();o?je.setPitchViewportRange(o,{animateMs:0,source:"coldStart:treble"}):E.warn("Main.js","Treble Clef preset range could not be resolved during cold start")}await gt.complete(),window.ModulationTest=SC}catch(t){E.error("Main.js","Initialization failed",t,"initialization"),E.error("Main.js","Component readiness snapshot at failure",{...Lo},"initialization");const e=t instanceof Error?t:new Error(String(t));gt.showError(e);const s=document.createElement("div");s.style.cssText=`
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #ff4444; color: white; padding: 20px; border-radius: 8px;
            z-index: 10000; font-family: monospace; max-width: 80vw;
        `,s.innerHTML=`
            <h3>Initialization Error</h3>
            <p>The application failed to initialize properly.</p>
            <details>
                <summary>Technical Details</summary>
                <pre>${e.message}</pre>
                <pre>Stack: ${e.stack}</pre>
            </details>
            <button onclick="location.reload()">Reload Page</button>
        `,document.body.appendChild(s)}}function NR(){of||(of=!0,kb(),TR(),Ai.refresh(),PR())}function DR(){er.forEach(t=>t()),er=[];try{y5()}catch(t){E.warn("Main.js","Failed to unmount Svelte components",t,"cleanup")}typeof kt.teardown=="function"&&kt.teardown(),typeof se.dispose=="function"&&se.dispose();const n=["is-mobile","is-touch","orientation-portrait","orientation-landscape"];[document.documentElement,document.body].forEach(t=>{n.forEach(e=>t==null?void 0:t.classList.remove(e))}),kb(),of=!1}const LR=Object.assign({"../public/apple-touch-icon.png":Wb,"../public/assets/icons/clear.svg":Gb,"../public/assets/icons/diamond-note.svg":Kb,"../public/assets/icons/eraser.svg":qb,"../public/assets/icons/lasso-tool.svg":zb,"../public/assets/icons/loop.svg":Xb,"../public/assets/icons/marker-tool.svg":$b,"../public/assets/icons/pause.svg":Yb,"../public/assets/icons/play.svg":jb,"../public/assets/icons/redo.svg":Jb,"../public/assets/icons/settings.svg":Zb,"../public/assets/icons/stop.svg":t2,"../public/assets/icons/undo.svg":e2,"../public/assets/icons/volume.svg":n2,"../public/assets/icons/zoomIn.svg":s2,"../public/assets/icons/zoomOut.svg":i2,"../public/assets/sidebar/hideAnalysis.svg":r2,"../public/assets/sidebar/hideDrums.svg":o2,"../public/assets/sidebar/newPage.svg":A2,"../public/assets/sidebar/open.svg":a2,"../public/assets/sidebar/print.svg":l2,"../public/assets/sidebar/saveAs.svg":c2,"../public/assets/tabicons/dottedQuarterNote.svg":u2,"../public/assets/tabicons/eigthNote.svg":d2,"../public/assets/tabicons/phaseButton_0.svg":h2,"../public/assets/tabicons/phaseButton_180.svg":f2,"../public/assets/tabicons/phaseButton_270.svg":p2,"../public/assets/tabicons/phaseButton_90.svg":m2,"../public/assets/tabicons/quarterNote.svg":g2,"../public/assets/tabicons/tonicShape_1.svg":w2,"../public/assets/tabicons/tonicShape_2.svg":v2,"../public/assets/tabicons/tonicShape_3.svg":B2,"../public/assets/tabicons/tonicShape_4.svg":C2,"../public/assets/tabicons/tonicShape_5.svg":b2,"../public/assets/tabicons/tonicShape_6.svg":y2,"../public/assets/tabicons/tonicShape_7.svg":S2,"../public/favicon-96x96.png":E2,"../public/favicon.ico":x2,"../public/favicon.svg":_2,"../public/fonts/atkinsonHyperlegibleNextBold.otf":I2,"../public/fonts/atkinsonHyperlegibleNextRegular.otf":F2,"../public/fonts/atkinsonHyperlegibleNextRegularItalic.otf":T2,"../public/site.webmanifest":Q2,"../public/web-app-manifest-192x192.png":M2,"../public/web-app-manifest-512x512.png":U2}),kR="../public/";function RR(n){const t=n.replace(/^\/+/,""),e=`${kR}${t}`;return LR[e]??n}function HR(n){n.querySelectorAll("[src], [href]").forEach(e=>{const s=e.hasAttribute("src")?"src":"href",i=e.getAttribute(s);!i||i.startsWith("http")||i.startsWith("data:")||i.startsWith("#")||!i.startsWith("assets/")&&!i.startsWith("fonts/")&&!i.startsWith("favicon")||e.setAttribute(s,RR(i))})}function OR(n){return n.innerHTML=P2,HR(n),NR(),{destroy:()=>{DR(),n.innerHTML=""}}}OR(document.getElementById("app"));
//# sourceMappingURL=index-YpNjZHnE.js.map
