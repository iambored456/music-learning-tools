{"version":3,"file":"KeyboardManager-BfTR6Wkb.js","sources":["../src/accessibility/KeyboardManager.ts"],"sourcesContent":["// (file path: src/accessibility/KeyboardManager.ts)\r\n\r\nimport { ActionController } from '../core/ActionController.ts';\r\nimport { ErrorHandler } from '../utils/ErrorHandler.ts';\r\nimport { CONFIG, DIATONIC_DEGREE_INDICES, MAJOR_SCALE_INTERVAL_STEPS, ANGLE_STEP } from '../core/constants.ts';\r\nimport { normAngle } from '../core/math.ts';\r\nimport { appState } from '../state/appState.ts';\r\nimport { snapRing, snapDegreeToDiatonic, snapChromaticAndSettleMode, startSnap } from '../core/animation.ts';\nimport { setRingAngle } from '../core/actions.ts';\nimport { indexAtTop } from '../core/math.ts';\n\ntype ActiveRing = 'pitch' | 'degree' | 'chromatic';\ntype AriaLive = 'polite' | 'assertive';\ntype NavigationMode = 'normal' | 'fine' | 'help';\ntype RotatableRing = 'pitchClass' | 'degree';\ntype KeyAction =\n  | 'rotatePitchClass'\n  | 'rotateDegree'\n  | 'rotateChromatic'\n  | 'selectNote'\n  | 'togglePlayback'\n  | 'toggleSidebar'\n  | 'closeSidebar'\n  | 'toggleDarkMode'\n  | 'toggleOrientation'\n  | 'toggleFlat'\n  | 'toggleSharp'\n  | 'resetRings'\n  | 'toggleFineMode'\n  | 'toggleHelp';\n\ntype KeyCommand = {\n  action: KeyAction;\n  description?: string;\n  direction?: number;\n  noteIndex?: number;\n};\n\n/**\n * Comprehensive keyboard navigation manager for Diatonic Compass\n * Provides full keyboard access to all interactive features\n */\nexport class KeyboardManager {\n  static isEnabled = true;\n  static keyMap: Map<string, KeyCommand> = new Map();\n  static activeRing: ActiveRing = 'pitch'; // Track which ring is active for keyboard control\n  static navigationMode: NavigationMode = 'normal'; // 'normal', 'fine', 'help'\n\r\n  /**\n   * Set the currently active ring for keyboard control\n   */\n  static setActiveRing(ringType: ActiveRing) {\n    this.activeRing = ringType;\n    // Highlights removed - no visual indication needed\n  }\n\r\n\r\n  /**\r\n   * Initialize keyboard management\r\n   */\r\n  static init() {\r\n    try {\r\n      this.setupKeyMap();\r\n      this.bindEvents();\r\n      this.initFocusManagement();\r\n      \r\n      // Don't show ring highlighting by default - only when keyboard is actually used\r\n      console.log('Keyboard navigation initialized');\r\n    } catch (error) {\r\n      ErrorHandler.handle(error, CONFIG.ERROR_HANDLING.CONTEXTS.UI);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set up keyboard command mappings\r\n   */\r\n  static setupKeyMap() {\r\n    // Ring navigation\r\n    this.keyMap.set('ArrowLeft', { action: 'rotatePitchClass', direction: -1, description: 'Rotate pitch ring left' });\r\n    this.keyMap.set('ArrowRight', { action: 'rotatePitchClass', direction: 1, description: 'Rotate pitch ring right' });\r\n    this.keyMap.set('ArrowUp', { action: 'rotateDegree', direction: 1, description: 'Rotate degree ring up' });\r\n    this.keyMap.set('ArrowDown', { action: 'rotateDegree', direction: -1, description: 'Rotate degree ring down' });\r\n    \r\n    // Chromatic ring (Shift + arrows)\r\n    this.keyMap.set('Shift+ArrowLeft', { action: 'rotateChromatic', direction: -1, description: 'Rotate chromatic ring left' });\r\n    this.keyMap.set('Shift+ArrowRight', { action: 'rotateChromatic', direction: 1, description: 'Rotate chromatic ring right' });\r\n    this.keyMap.set('Shift+ArrowUp', { action: 'rotateChromatic', direction: 1, description: 'Rotate chromatic ring up' });\r\n    this.keyMap.set('Shift+ArrowDown', { action: 'rotateChromatic', direction: -1, description: 'Rotate chromatic ring down' });\r\n\r\n    // Quick navigation (Ctrl + arrows) - larger steps\r\n    this.keyMap.set('Ctrl+ArrowLeft', { action: 'rotatePitchClass', direction: -3, description: 'Rotate pitch ring left (large step)' });\r\n    this.keyMap.set('Ctrl+ArrowRight', { action: 'rotatePitchClass', direction: 3, description: 'Rotate pitch ring right (large step)' });\r\n    this.keyMap.set('Ctrl+ArrowUp', { action: 'rotateDegree', direction: 3, description: 'Rotate degree ring up (large step)' });\r\n    this.keyMap.set('Ctrl+ArrowDown', { action: 'rotateDegree', direction: -3, description: 'Rotate degree ring down (large step)' });\r\n\r\n    // Audio and UI controls\r\n    this.keyMap.set(' ', { action: 'togglePlayback', description: 'Play/pause scale (Space)' });\r\n    this.keyMap.set('Enter', { action: 'togglePlayback', description: 'Play/pause scale' });\r\n    this.keyMap.set('Escape', { action: 'closeSidebar', description: 'Close sidebar' });\r\n    \r\n    // Settings shortcuts - match sidebar documentation\r\n    this.keyMap.set('F1', { action: 'toggleSidebar', description: 'Open/close settings' });\r\n    this.keyMap.set('v', { action: 'toggleOrientation', description: 'Toggle vertical/horizontal layout' });\r\n    this.keyMap.set('V', { action: 'toggleOrientation', description: 'Toggle vertical/horizontal layout' });\r\n    this.keyMap.set('d', { action: 'toggleDarkMode', description: 'Toggle dark mode' });\r\n    this.keyMap.set('h', { action: 'toggleHelp', description: 'Show/hide keyboard shortcuts' });\r\n    \r\n    // Accidental toggles - match sidebar documentation  \r\n    this.keyMap.set('f', { action: 'toggleFlat', description: 'Toggle flat note names' });\r\n    this.keyMap.set('F', { action: 'toggleFlat', description: 'Toggle flat note names' });\r\n    this.keyMap.set('s', { action: 'toggleSharp', description: 'Toggle sharp note names' });\r\n    this.keyMap.set('S', { action: 'toggleSharp', description: 'Toggle sharp note names' });\r\n    \r\n    // Reset and utility\r\n    this.keyMap.set('r', { action: 'resetRings', description: 'Reset all rings to starting position' });\r\n    this.keyMap.set('Home', { action: 'resetRings', description: 'Reset all rings to starting position' });\r\n    \r\n    // Fine control mode toggle\r\n    this.keyMap.set('Shift+f', { action: 'toggleFineMode', description: 'Toggle fine control mode' });\r\n    \r\n    // Number keys for direct note selection (1-12)\r\n    for (let i = 1; i <= 12; i++) {\r\n      this.keyMap.set(i.toString(), { \r\n        action: 'selectNote', \r\n        noteIndex: i - 1, \r\n        description: `Select note ${i}` \r\n      });\r\n    }\r\n  }\r\n\r\n  /**\n   * Bind keyboard event listeners\n   */\n  static bindEvents() {\n    document.addEventListener('keydown', this.handleKeyDown.bind(this));\n    document.addEventListener('keyup', this.handleKeyUp.bind(this));\n    \r\n    // Prevent default behavior for our handled keys only when appropriate\r\n    document.addEventListener('keydown', (e: KeyboardEvent) => {\n      if (this.shouldPreventDefault(e)) {\n        e.preventDefault();\n      }\n    }, { capture: true });\n  }\n\r\n  /**\r\n   * Initialize focus management\r\n   */\r\n  static initFocusManagement() {\r\n    // Set up focus indicators (just for keyboard help overlay)\r\n    this.setupFocusIndicators();\r\n  }\r\n\r\n  /**\r\n   * Set up visual focus indicators\r\n   */\r\n  static setupFocusIndicators() {\r\n    const style = document.createElement('style');\r\n    style.textContent = `\r\n      .keyboard-help-overlay {\r\n        position: fixed;\r\n        top: 50%;\r\n        left: 50%;\r\n        transform: translate(-50%, -50%);\r\n        background: var(--color-surface);\r\n        color: var(--color-text-primary);\r\n        padding: 2rem;\r\n        border-radius: var(--radius-medium);\r\n        box-shadow: 0 10px 30px rgba(0,0,0,0.3);\r\n        z-index: 3000;\r\n        max-width: 90vw;\r\n        max-height: 90vh;\r\n        overflow-y: auto;\r\n        border: 2px solid #33c6dc;\r\n      }\r\n\r\n      .keyboard-help-overlay h2 {\r\n        margin-top: 0;\r\n        color: #33c6dc;\r\n      }\r\n\r\n      .keyboard-help-shortcuts {\r\n        display: grid;\r\n        grid-template-columns: auto 1fr;\r\n        gap: 0.5rem 1rem;\r\n        margin: 1rem 0;\r\n      }\r\n\r\n      .keyboard-help-key {\r\n        background: #f0f0f0;\r\n        color: #333;\r\n        padding: 0.25rem 0.5rem;\r\n        border-radius: 4px;\r\n        font-family: monospace;\r\n        font-weight: bold;\r\n        text-align: center;\r\n        min-width: 3rem;\r\n      }\r\n\r\n      .keyboard-help-description {\r\n        padding: 0.25rem 0;\r\n      }\r\n\r\n      .keyboard-help-close {\r\n        background: #33c6dc;\r\n        color: white;\r\n        border: none;\r\n        padding: 0.5rem 1rem;\r\n        border-radius: 4px;\r\n        cursor: pointer;\r\n        margin-top: 1rem;\r\n      }\r\n    `;\r\n    document.head.appendChild(style);\r\n  }\r\n\r\n  /**\n   * Handle keydown events\n   */\n  static handleKeyDown(e: KeyboardEvent) {\n    try {\r\n      console.log('=== KeyboardManager.handleKeyDown ===');\r\n      console.log('Key pressed:', e.key);\r\n      console.log('isEnabled:', this.isEnabled);\r\n\r\n      if (!this.isEnabled) {\r\n        console.log('Keyboard manager disabled, returning');\r\n        return;\r\n      }\r\n\r\n      // Don't interfere with text inputs\r\n      const isTextInput = this.isTextInputActive();\r\n      console.log('isTextInputActive:', isTextInput);\r\n      if (isTextInput) {\r\n        console.log('Text input active, returning');\r\n        return;\r\n      }\r\n\r\n      const key = this.getKeyString(e);\r\n      console.log('Key string with modifiers:', key);\r\n\r\n      const command = this.keyMap.get(key);\r\n      console.log('Command found:', command);\r\n\r\n      if (command) {\r\n        console.log('Executing command:', command.action);\r\n        this.executeCommand(command, e);\r\n      } else {\r\n        console.log('No command mapped for key:', key);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error in handleKeyDown:', error);\r\n      ErrorHandler.handle(error, CONFIG.ERROR_HANDLING.CONTEXTS.UI);\r\n    }\r\n  }\r\n\r\n  /**\n   * Handle keyup events\n   */\n  static handleKeyUp(e: KeyboardEvent) {\n    // Currently unused but available for future enhancements\n  }\n\r\n  /**\n   * Get key string including modifiers\n   */\n  static getKeyString(e: KeyboardEvent) {\n    const parts = [];\n    if (e.ctrlKey) parts.push('Ctrl');\n    if (e.shiftKey) parts.push('Shift');\n    if (e.altKey) parts.push('Alt');\n    if (e.metaKey) parts.push('Meta');\r\n    parts.push(e.key);\r\n    return parts.join('+');\r\n  }\r\n\r\n  /**\n   * Check if text input is currently active\n   */\n  static isTextInputActive() {\n    const activeElement = document.activeElement as HTMLElement | null;\n    const textInputs = ['INPUT', 'TEXTAREA', 'SELECT'];\n    return textInputs.includes(activeElement?.tagName ?? '') ||\n           activeElement?.contentEditable === 'true';\n  }\n\r\n  /**\n   * Check if we should prevent default for this key event\n   */\n  static shouldPreventDefault(e: KeyboardEvent) {\n    console.log('=== shouldPreventDefault ===');\r\n    console.log('Key:', e.key);\r\n\r\n    if (this.isTextInputActive()) {\r\n      console.log('Text input active, not preventing default');\r\n      return false;\r\n    }\r\n\r\n    const key = this.getKeyString(e);\r\n    const command = this.keyMap.get(key);\r\n\r\n    const shouldPrevent = !!command && !['Escape'].includes(e.key);\r\n    console.log('Command found:', !!command);\r\n    console.log('Should prevent default:', shouldPrevent);\r\n\r\n    // Prevent default for our handled keys, but allow normal browser behavior for others\r\n    return shouldPrevent;\r\n  }\r\n\r\n  /**\n   * Execute a keyboard command\n   */\n  static executeCommand(command: KeyCommand, event: KeyboardEvent) {\n    const stepSize = this.navigationMode === 'fine' ? 0.5 : 1;\n    const direction = command.direction ?? 0;\n\n    switch (command.action) {\n      case 'rotatePitchClass':\n        this.setActiveRing('pitch');\n        this.rotateRingAndSnap('pitchClass', direction * stepSize);\n        this.announceRingPosition('pitch');\n        break;\n\n      case 'rotateDegree':\n        this.setActiveRing('degree');\n        this.rotateRingAndSnap('degree', direction * stepSize);\n        this.announceRingPosition('degree');\n        break;\n\n      case 'rotateChromatic':\n        this.setActiveRing('chromatic');\n        this.rotateAllRingsAndSnap(direction * stepSize);\n        this.announceRingPosition('chromatic');\n        break;\n        \r\n      case 'selectNote':\n        if (typeof command.noteIndex === 'number') {\n          this.selectNoteDirectly(command.noteIndex);\n        }\n        break;\n        \r\n      case 'togglePlayback':\r\n        ActionController.togglePlayback();\r\n        this.announcePlaybackState();\r\n        break;\r\n        \r\n      case 'toggleSidebar':\r\n        ActionController.toggleSidebar();\r\n        this.announceSidebarState();\r\n        break;\r\n        \r\n      case 'closeSidebar':\r\n        ActionController.toggleSidebar(false);\r\n        this.announce('Settings closed');\r\n        break;\r\n        \r\n      case 'toggleDarkMode':\r\n        ActionController.toggleDarkMode();\r\n        this.announce(appState.ui.darkMode ? 'Dark mode enabled' : 'Light mode enabled');\r\n        break;\r\n        \r\n      case 'toggleOrientation':\r\n        const newOrientation = appState.belts.orientation === 'horizontal' ? 'vertical' : 'horizontal';\r\n        ActionController.setOrientation(newOrientation);\r\n        this.announce(`Layout changed to ${newOrientation}`);\r\n        break;\r\n        \r\n      case 'toggleFlat':\r\n        ActionController.toggleAccidental('flat');\r\n        this.announce(appState.display.flat ? 'Flat names enabled' : 'Flat names disabled');\r\n        break;\r\n        \r\n      case 'toggleSharp':\r\n        ActionController.toggleAccidental('sharp');\r\n        this.announce(appState.display.sharp ? 'Sharp names enabled' : 'Sharp names disabled');\r\n        break;\r\n        \r\n      case 'resetRings':\r\n        ActionController.resetRings();\r\n        this.announce('All rings reset to starting position');\r\n        break;\r\n        \r\n      case 'toggleFineMode':\r\n        this.navigationMode = this.navigationMode === 'fine' ? 'normal' : 'fine';\r\n        this.announce(`Fine control mode ${this.navigationMode === 'fine' ? 'enabled' : 'disabled'}`);\r\n        break;\r\n        \r\n      case 'toggleHelp':\r\n        this.toggleKeyboardHelp();\r\n        break;\r\n        \r\n    }\r\n  }\r\n\r\n  /**\n   * Rotate a specific ring by steps and snap to nearest position\n   */\n  static rotateRingAndSnap(ringName: RotatableRing, steps: number) {\n    if (ringName === 'degree') {\r\n      // For degree ring, jump to next/previous diatonic degree with animation\r\n      this.rotateDegreeRingDiatonically(steps);\r\n    } else if (ringName === 'pitchClass') {\r\n      // For pitch class ring, move by semitone steps with animation\r\n      const stepAngle = steps * (Math.PI * 2 / 12);\r\n      const currentAngle = appState.rings.pitchClass;\r\n      const targetAngle = normAngle(currentAngle + stepAngle);\r\n\r\n      // Calculate the snapped target (nearest semitone)\r\n      const targetIndex = Math.round(-targetAngle / ANGLE_STEP);\r\n      const snappedTarget = normAngle(-targetIndex * ANGLE_STEP);\r\n\r\n      // Animate to the snapped position\r\n      startSnap({\r\n        pitchClass: snappedTarget\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\n   * Rotate the degree ring to the next/previous diatonic degree\n   * Follows the major scale interval pattern: +2, +2, +1, +2, +2, +2, +1\n   */\n  static rotateDegreeRingDiatonically(steps: number) {\n    const { degree, chromatic } = appState.rings;\r\n    const effectiveDegreeRotation = normAngle(degree - chromatic);\r\n\r\n    // Find current diatonic degree index (0-6)\r\n    const currentRelativeIndexFloat = normAngle(-effectiveDegreeRotation) / ANGLE_STEP;\r\n\r\n    // Find the closest current diatonic index\r\n    let currentDiatonicIndex = 0;\r\n    let minDiff = Infinity;\r\n\r\n    DIATONIC_DEGREE_INDICES.forEach((validIndex, i) => {\r\n      const diff = Math.abs(currentRelativeIndexFloat - validIndex);\r\n      const circularDiff = Math.min(diff, 12 - diff);\r\n\r\n      if (circularDiff < minDiff) {\r\n        minDiff = circularDiff;\r\n        currentDiatonicIndex = i; // Store the index in DIATONIC_DEGREE_INDICES array (0-6)\r\n      }\r\n    });\r\n\r\n    // Move to next/previous diatonic degree based on direction\r\n    const direction = steps > 0 ? 1 : -1;\r\n    const targetDiatonicIndex = (currentDiatonicIndex + direction + 7) % 7;\r\n    const targetSemitoneIndex = DIATONIC_DEGREE_INDICES[targetDiatonicIndex];\r\n\r\n    // Calculate target angle\r\n    const targetEffectiveRotation = normAngle(-targetSemitoneIndex * ANGLE_STEP);\r\n    const targetDegree = normAngle(targetEffectiveRotation + chromatic);\r\n\r\n    // Animate to the target position\r\n    startSnap({\r\n      degree: targetDegree,\r\n      highlightPosition: targetDegree\r\n    });\r\n  }\r\n\r\n  /**\n   * Rotate all rings together (chromatic control) and snap\n   */\n  static rotateAllRingsAndSnap(steps: number) {\n    const stepAngle = steps * (Math.PI * 2 / 12);\r\n\r\n    // Calculate target angles for all rings\r\n    const targetPitchClass = normAngle(appState.rings.pitchClass + stepAngle);\r\n    const targetDegree = normAngle(appState.rings.degree + stepAngle);\r\n    const targetChromatic = normAngle(appState.rings.chromatic + stepAngle);\r\n\r\n    // Calculate snapped chromatic position\r\n    const chromIdx = Math.round(-targetChromatic / ANGLE_STEP);\r\n    const snappedChromatic = normAngle(-chromIdx * ANGLE_STEP);\r\n\r\n    // Calculate how much the chromatic ring needs to snap\r\n    const snapDelta = snappedChromatic - targetChromatic;\r\n\r\n    // Apply the snap delta to pitch and degree rings too\r\n    const snappedPitchClass = normAngle(targetPitchClass + snapDelta);\r\n    const snappedDegree = normAngle(targetDegree + snapDelta);\r\n\r\n    // Animate all rings to their snapped positions\r\n    startSnap({\r\n      pitchClass: snappedPitchClass,\r\n      degree: snappedDegree,\r\n      chromatic: snappedChromatic,\r\n      highlightPosition: snappedDegree\r\n    });\r\n  }\r\n\r\n  /**\n   * Select a note directly by index\n   */\n  static selectNoteDirectly(noteIndex: number) {\n    const targetAngle = normAngle(-noteIndex * (Math.PI * 2 / 12));\r\n    ActionController.setRingAngle('chromatic', targetAngle);\r\n    this.announce(`Selected note ${noteIndex + 1}`);\r\n  }\r\n\r\n\r\n  /**\r\n   * Toggle keyboard help overlay\r\n   */\r\n  static toggleKeyboardHelp() {\n    let helpOverlay = document.querySelector<HTMLElement>('.keyboard-help-overlay');\n    \r\n    if (helpOverlay) {\r\n      helpOverlay.remove();\r\n      this.announce('Keyboard help closed');\r\n      return;\r\n    }\r\n    \r\n    helpOverlay = document.createElement('div');\r\n    helpOverlay.className = 'keyboard-help-overlay';\r\n    helpOverlay.innerHTML = this.generateHelpContent();\r\n    \r\n    // Close on escape or click outside\r\n    const closeHelp = () => {\r\n      helpOverlay.remove();\r\n      this.announce('Keyboard help closed');\r\n    };\r\n    \r\n    const closeButton = helpOverlay.querySelector<HTMLButtonElement>('.keyboard-help-close');\n    if (closeButton) {\n      closeButton.addEventListener('click', closeHelp);\n    }\n    \r\n    document.addEventListener('keydown', (e) => {\r\n      if (e.key === 'Escape' && document.querySelector('.keyboard-help-overlay')) {\r\n        closeHelp();\r\n      }\r\n    }, { once: true });\r\n    \r\n    document.body.appendChild(helpOverlay);\n    closeButton?.focus();\n    this.announce('Keyboard help opened');\n  }\n\r\n  /**\r\n   * Generate help content HTML\r\n   */\r\n  static generateHelpContent() {\r\n    const shortcuts = Array.from(this.keyMap.entries())\r\n      .filter(([key, command]) => command.description)\r\n      .sort(([a], [b]) => a.localeCompare(b));\r\n    \r\n    const shortcutHTML = shortcuts.map(([key, command]) => \r\n      `<div class=\"keyboard-help-key\">${key}</div>\r\n       <div class=\"keyboard-help-description\">${command.description}</div>`\r\n    ).join('');\r\n    \r\n    return `\r\n      <h2>Keyboard Shortcuts</h2>\r\n      <div class=\"keyboard-help-shortcuts\">\r\n        ${shortcutHTML}\r\n      </div>\r\n      <button class=\"keyboard-help-close\">Close (Esc)</button>\r\n    `;\r\n  }\r\n\r\n  /**\n   * Announce ring position for screen readers\n   */\n  static announceRingPosition(ringType: ActiveRing) {\n    // This will be enhanced with actual musical information\n    const ringKey = ringType === 'pitch' ? 'pitchClass' : ringType;\n    const position = Math.round((appState.rings[ringKey] || 0) * 180 / Math.PI);\n    this.announce(`${ringType} ring at ${position} degrees`);\n  }\n\r\n  /**\r\n   * Announce playback state\r\n   */\r\n  static announcePlaybackState() {\r\n    const message = appState.playback.isPlaying ? 'Scale playing' : 'Playback stopped';\r\n    this.announce(message);\r\n  }\r\n\r\n  /**\r\n   * Announce sidebar state\r\n   */\r\n  static announceSidebarState() {\r\n    const message = appState.ui.sidebarOpen ? 'Settings opened' : 'Settings closed';\r\n    this.announce(message);\r\n  }\r\n\r\n\r\n  /**\n   * Announce message to screen readers\n   */\n  static announce(message: string, priority: AriaLive = 'polite') {\n    const announcer = document.createElement('div');\r\n    announcer.setAttribute('aria-live', priority);\r\n    announcer.setAttribute('aria-atomic', 'true');\r\n    announcer.className = 'sr-only';\r\n    announcer.textContent = message;\r\n    \r\n    // Add screen reader only styles\r\n    announcer.style.position = 'absolute';\r\n    announcer.style.left = '-10000px';\r\n    announcer.style.width = '1px';\r\n    announcer.style.height = '1px';\r\n    announcer.style.overflow = 'hidden';\r\n    \r\n    document.body.appendChild(announcer);\r\n    \r\n    // Remove after announcement\r\n    setTimeout(() => {\r\n      if (announcer.parentNode) {\r\n        announcer.parentNode.removeChild(announcer);\r\n      }\r\n    }, 1000);\r\n  }\r\n\r\n  /**\r\n   * Enable keyboard navigation\r\n   */\r\n  static enable() {\r\n    this.isEnabled = true;\r\n    this.announce('Keyboard navigation enabled');\r\n  }\r\n\r\n  /**\r\n   * Disable keyboard navigation\r\n   */\r\n  static disable() {\r\n    this.isEnabled = false;\r\n    this.announce('Keyboard navigation disabled');\r\n  }\r\n\r\n  /**\r\n   * Get current keyboard shortcuts\r\n   */\r\n  static getShortcuts() {\r\n    return Array.from(this.keyMap.entries()).map(([key, command]) => ({\r\n      key,\r\n      description: command.description,\r\n      action: command.action\r\n    }));\r\n  }\r\n}\r\n"],"names":["KeyboardManager","ringType","error","ErrorHandler","CONFIG","i","style","isTextInput","key","command","parts","activeElement","shouldPrevent","event","stepSize","direction","ActionController","appState","newOrientation","ringName","steps","stepAngle","currentAngle","targetAngle","normAngle","targetIndex","ANGLE_STEP","snappedTarget","startSnap","degree","chromatic","effectiveDegreeRotation","currentRelativeIndexFloat","currentDiatonicIndex","minDiff","DIATONIC_DEGREE_INDICES","validIndex","diff","circularDiff","targetDiatonicIndex","targetSemitoneIndex","targetEffectiveRotation","targetDegree","targetPitchClass","targetChromatic","chromIdx","snappedChromatic","snapDelta","snappedPitchClass","snappedDegree","noteIndex","helpOverlay","closeHelp","closeButton","e","a","b","ringKey","position","message","priority","announcer","__publicField"],"mappings":"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"}