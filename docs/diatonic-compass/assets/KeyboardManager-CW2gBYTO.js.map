{"version":3,"file":"KeyboardManager-CW2gBYTO.js","sources":["../../../../packages/diatonic-compass-ui/src/accessibility/KeyboardManager.ts"],"sourcesContent":["// (file path: src/accessibility/KeyboardManager.ts)\r\n\r\nimport { ActionController } from '../core/ActionController.ts';\r\nimport { ErrorHandler } from '../utils/ErrorHandler.ts';\r\nimport { CONFIG, DIATONIC_DEGREE_INDICES, MAJOR_SCALE_INTERVAL_STEPS, ANGLE_STEP } from '../core/constants.ts';\r\nimport { normAngle } from '../core/math.ts';\r\nimport { appState } from '../state/appState.ts';\r\nimport { snapRing, snapDegreeToDiatonic, snapChromaticAndSettleMode, startSnap } from '../core/animation.ts';\nimport { setRingAngle } from '../core/actions.ts';\nimport { indexAtTop } from '../core/math.ts';\n\ntype ActiveRing = 'pitch' | 'degree' | 'chromatic';\ntype AriaLive = 'polite' | 'assertive';\ntype NavigationMode = 'normal' | 'fine' | 'help';\ntype RotatableRing = 'pitchClass' | 'degree';\ntype KeyAction =\n  | 'rotatePitchClass'\n  | 'rotateDegree'\n  | 'rotateChromatic'\n  | 'selectNote'\n  | 'togglePlayback'\n  | 'toggleSidebar'\n  | 'closeSidebar'\n  | 'toggleDarkMode'\n  | 'toggleOrientation'\n  | 'toggleFlat'\n  | 'toggleSharp'\n  | 'resetRings'\n  | 'toggleFineMode'\n  | 'toggleHelp';\n\ntype KeyCommand = {\n  action: KeyAction;\n  description?: string;\n  direction?: number;\n  noteIndex?: number;\n};\n\n/**\n * Comprehensive keyboard navigation manager for Diatonic Compass\n * Provides full keyboard access to all interactive features\n */\nexport class KeyboardManager {\n  static isEnabled = true;\n  static keyMap: Map<string, KeyCommand> = new Map();\n  static activeRing: ActiveRing = 'pitch'; // Track which ring is active for keyboard control\n  static navigationMode: NavigationMode = 'normal'; // 'normal', 'fine', 'help'\n\r\n  /**\n   * Set the currently active ring for keyboard control\n   */\n  static setActiveRing(ringType: ActiveRing) {\n    this.activeRing = ringType;\n    // Highlights removed - no visual indication needed\n  }\n\r\n\r\n  /**\r\n   * Initialize keyboard management\r\n   */\r\n  static init() {\r\n    try {\r\n      this.setupKeyMap();\r\n      this.bindEvents();\r\n      this.initFocusManagement();\r\n      \r\n      // Don't show ring highlighting by default - only when keyboard is actually used\r\n      console.log('Keyboard navigation initialized');\r\n    } catch (error) {\r\n      ErrorHandler.handle(error, CONFIG.ERROR_HANDLING.CONTEXTS.UI);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set up keyboard command mappings\r\n   */\r\n  static setupKeyMap() {\r\n    // Ring navigation\r\n    this.keyMap.set('ArrowLeft', { action: 'rotatePitchClass', direction: -1, description: 'Rotate pitch ring left' });\r\n    this.keyMap.set('ArrowRight', { action: 'rotatePitchClass', direction: 1, description: 'Rotate pitch ring right' });\r\n    this.keyMap.set('ArrowUp', { action: 'rotateDegree', direction: 1, description: 'Rotate degree ring up' });\r\n    this.keyMap.set('ArrowDown', { action: 'rotateDegree', direction: -1, description: 'Rotate degree ring down' });\r\n    \r\n    // Chromatic ring (Shift + arrows)\r\n    this.keyMap.set('Shift+ArrowLeft', { action: 'rotateChromatic', direction: -1, description: 'Rotate chromatic ring left' });\r\n    this.keyMap.set('Shift+ArrowRight', { action: 'rotateChromatic', direction: 1, description: 'Rotate chromatic ring right' });\r\n    this.keyMap.set('Shift+ArrowUp', { action: 'rotateChromatic', direction: 1, description: 'Rotate chromatic ring up' });\r\n    this.keyMap.set('Shift+ArrowDown', { action: 'rotateChromatic', direction: -1, description: 'Rotate chromatic ring down' });\r\n\r\n    // Quick navigation (Ctrl + arrows) - larger steps\r\n    this.keyMap.set('Ctrl+ArrowLeft', { action: 'rotatePitchClass', direction: -3, description: 'Rotate pitch ring left (large step)' });\r\n    this.keyMap.set('Ctrl+ArrowRight', { action: 'rotatePitchClass', direction: 3, description: 'Rotate pitch ring right (large step)' });\r\n    this.keyMap.set('Ctrl+ArrowUp', { action: 'rotateDegree', direction: 3, description: 'Rotate degree ring up (large step)' });\r\n    this.keyMap.set('Ctrl+ArrowDown', { action: 'rotateDegree', direction: -3, description: 'Rotate degree ring down (large step)' });\r\n\r\n    // Audio and UI controls\r\n    this.keyMap.set(' ', { action: 'togglePlayback', description: 'Play/pause scale (Space)' });\r\n    this.keyMap.set('Enter', { action: 'togglePlayback', description: 'Play/pause scale' });\r\n    this.keyMap.set('Escape', { action: 'closeSidebar', description: 'Close sidebar' });\r\n    \r\n    // Settings shortcuts - match sidebar documentation\r\n    this.keyMap.set('F1', { action: 'toggleSidebar', description: 'Open/close settings' });\r\n    this.keyMap.set('v', { action: 'toggleOrientation', description: 'Toggle vertical/horizontal layout' });\r\n    this.keyMap.set('V', { action: 'toggleOrientation', description: 'Toggle vertical/horizontal layout' });\r\n    this.keyMap.set('d', { action: 'toggleDarkMode', description: 'Toggle dark mode' });\r\n    this.keyMap.set('h', { action: 'toggleHelp', description: 'Show/hide keyboard shortcuts' });\r\n    \r\n    // Accidental toggles - match sidebar documentation  \r\n    this.keyMap.set('f', { action: 'toggleFlat', description: 'Toggle flat note names' });\r\n    this.keyMap.set('F', { action: 'toggleFlat', description: 'Toggle flat note names' });\r\n    this.keyMap.set('s', { action: 'toggleSharp', description: 'Toggle sharp note names' });\r\n    this.keyMap.set('S', { action: 'toggleSharp', description: 'Toggle sharp note names' });\r\n    \r\n    // Reset and utility\r\n    this.keyMap.set('r', { action: 'resetRings', description: 'Reset all rings to starting position' });\r\n    this.keyMap.set('Home', { action: 'resetRings', description: 'Reset all rings to starting position' });\r\n    \r\n    // Fine control mode toggle\r\n    this.keyMap.set('Shift+f', { action: 'toggleFineMode', description: 'Toggle fine control mode' });\r\n    \r\n    // Number keys for direct note selection (1-12)\r\n    for (let i = 1; i <= 12; i++) {\r\n      this.keyMap.set(i.toString(), { \r\n        action: 'selectNote', \r\n        noteIndex: i - 1, \r\n        description: `Select note ${i}` \r\n      });\r\n    }\r\n  }\r\n\r\n  /**\n   * Bind keyboard event listeners\n   */\n  static bindEvents() {\n    document.addEventListener('keydown', this.handleKeyDown.bind(this));\n    document.addEventListener('keyup', this.handleKeyUp.bind(this));\n    \r\n    // Prevent default behavior for our handled keys only when appropriate\r\n    document.addEventListener('keydown', (e: KeyboardEvent) => {\n      if (this.shouldPreventDefault(e)) {\n        e.preventDefault();\n      }\n    }, { capture: true });\n  }\n\r\n  /**\r\n   * Initialize focus management\r\n   */\r\n  static initFocusManagement() {\r\n    // Set up focus indicators (just for keyboard help overlay)\r\n    this.setupFocusIndicators();\r\n  }\r\n\r\n  /**\r\n   * Set up visual focus indicators\r\n   */\r\n  static setupFocusIndicators() {\r\n    const style = document.createElement('style');\r\n    style.textContent = `\r\n      .keyboard-help-overlay {\r\n        position: fixed;\r\n        top: 50%;\r\n        left: 50%;\r\n        transform: translate(-50%, -50%);\r\n        background: var(--color-surface);\r\n        color: var(--color-text-primary);\r\n        padding: 2rem;\r\n        border-radius: var(--radius-medium);\r\n        box-shadow: 0 10px 30px rgba(0,0,0,0.3);\r\n        z-index: 3000;\r\n        max-width: 90vw;\r\n        max-height: 90vh;\r\n        overflow-y: auto;\r\n        border: 2px solid #33c6dc;\r\n      }\r\n\r\n      .keyboard-help-overlay h2 {\r\n        margin-top: 0;\r\n        color: #33c6dc;\r\n      }\r\n\r\n      .keyboard-help-shortcuts {\r\n        display: grid;\r\n        grid-template-columns: auto 1fr;\r\n        gap: 0.5rem 1rem;\r\n        margin: 1rem 0;\r\n      }\r\n\r\n      .keyboard-help-key {\r\n        background: #f0f0f0;\r\n        color: #333;\r\n        padding: 0.25rem 0.5rem;\r\n        border-radius: 4px;\r\n        font-family: monospace;\r\n        font-weight: bold;\r\n        text-align: center;\r\n        min-width: 3rem;\r\n      }\r\n\r\n      .keyboard-help-description {\r\n        padding: 0.25rem 0;\r\n      }\r\n\r\n      .keyboard-help-close {\r\n        background: #33c6dc;\r\n        color: white;\r\n        border: none;\r\n        padding: 0.5rem 1rem;\r\n        border-radius: 4px;\r\n        cursor: pointer;\r\n        margin-top: 1rem;\r\n      }\r\n    `;\r\n    document.head.appendChild(style);\r\n  }\r\n\r\n  /**\n   * Handle keydown events\n   */\n  static handleKeyDown(e: KeyboardEvent) {\n    try {\r\n      console.log('=== KeyboardManager.handleKeyDown ===');\r\n      console.log('Key pressed:', e.key);\r\n      console.log('isEnabled:', this.isEnabled);\r\n\r\n      if (!this.isEnabled) {\r\n        console.log('Keyboard manager disabled, returning');\r\n        return;\r\n      }\r\n\r\n      // Don't interfere with text inputs\r\n      const isTextInput = this.isTextInputActive();\r\n      console.log('isTextInputActive:', isTextInput);\r\n      if (isTextInput) {\r\n        console.log('Text input active, returning');\r\n        return;\r\n      }\r\n\r\n      const key = this.getKeyString(e);\r\n      console.log('Key string with modifiers:', key);\r\n\r\n      const command = this.keyMap.get(key);\r\n      console.log('Command found:', command);\r\n\r\n      if (command) {\r\n        console.log('Executing command:', command.action);\r\n        this.executeCommand(command, e);\r\n      } else {\r\n        console.log('No command mapped for key:', key);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error in handleKeyDown:', error);\r\n      ErrorHandler.handle(error, CONFIG.ERROR_HANDLING.CONTEXTS.UI);\r\n    }\r\n  }\r\n\r\n  /**\n   * Handle keyup events\n   */\n  static handleKeyUp(e: KeyboardEvent) {\n    // Currently unused but available for future enhancements\n  }\n\r\n  /**\n   * Get key string including modifiers\n   */\n  static getKeyString(e: KeyboardEvent) {\n    const parts = [];\n    if (e.ctrlKey) parts.push('Ctrl');\n    if (e.shiftKey) parts.push('Shift');\n    if (e.altKey) parts.push('Alt');\n    if (e.metaKey) parts.push('Meta');\r\n    parts.push(e.key);\r\n    return parts.join('+');\r\n  }\r\n\r\n  /**\n   * Check if text input is currently active\n   */\n  static isTextInputActive() {\n    const activeElement = document.activeElement as HTMLElement | null;\n    const textInputs = ['INPUT', 'TEXTAREA', 'SELECT'];\n    return textInputs.includes(activeElement?.tagName ?? '') ||\n           activeElement?.contentEditable === 'true';\n  }\n\r\n  /**\n   * Check if we should prevent default for this key event\n   */\n  static shouldPreventDefault(e: KeyboardEvent) {\n    console.log('=== shouldPreventDefault ===');\r\n    console.log('Key:', e.key);\r\n\r\n    if (this.isTextInputActive()) {\r\n      console.log('Text input active, not preventing default');\r\n      return false;\r\n    }\r\n\r\n    const key = this.getKeyString(e);\r\n    const command = this.keyMap.get(key);\r\n\r\n    const shouldPrevent = !!command && !['Escape'].includes(e.key);\r\n    console.log('Command found:', !!command);\r\n    console.log('Should prevent default:', shouldPrevent);\r\n\r\n    // Prevent default for our handled keys, but allow normal browser behavior for others\r\n    return shouldPrevent;\r\n  }\r\n\r\n  /**\n   * Execute a keyboard command\n   */\n  static executeCommand(command: KeyCommand, event: KeyboardEvent) {\n    const stepSize = this.navigationMode === 'fine' ? 0.5 : 1;\n    const direction = command.direction ?? 0;\n\n    switch (command.action) {\n      case 'rotatePitchClass':\n        this.setActiveRing('pitch');\n        this.rotateRingAndSnap('pitchClass', direction * stepSize);\n        this.announceRingPosition('pitch');\n        break;\n\n      case 'rotateDegree':\n        this.setActiveRing('degree');\n        this.rotateRingAndSnap('degree', direction * stepSize);\n        this.announceRingPosition('degree');\n        break;\n\n      case 'rotateChromatic':\n        this.setActiveRing('chromatic');\n        this.rotateAllRingsAndSnap(direction * stepSize);\n        this.announceRingPosition('chromatic');\n        break;\n        \r\n      case 'selectNote':\n        if (typeof command.noteIndex === 'number') {\n          this.selectNoteDirectly(command.noteIndex);\n        }\n        break;\n        \r\n      case 'togglePlayback':\r\n        ActionController.togglePlayback();\r\n        this.announcePlaybackState();\r\n        break;\r\n        \r\n      case 'toggleSidebar':\r\n        ActionController.toggleSidebar();\r\n        this.announceSidebarState();\r\n        break;\r\n        \r\n      case 'closeSidebar':\r\n        ActionController.toggleSidebar(false);\r\n        this.announce('Settings closed');\r\n        break;\r\n        \r\n      case 'toggleDarkMode':\r\n        ActionController.toggleDarkMode();\r\n        this.announce(appState.ui.darkMode ? 'Dark mode enabled' : 'Light mode enabled');\r\n        break;\r\n        \r\n      case 'toggleOrientation':\r\n        const newOrientation = appState.belts.orientation === 'horizontal' ? 'vertical' : 'horizontal';\r\n        ActionController.setOrientation(newOrientation);\r\n        this.announce(`Layout changed to ${newOrientation}`);\r\n        break;\r\n        \r\n      case 'toggleFlat':\r\n        ActionController.toggleAccidental('flat');\r\n        this.announce(appState.display.flat ? 'Flat names enabled' : 'Flat names disabled');\r\n        break;\r\n        \r\n      case 'toggleSharp':\r\n        ActionController.toggleAccidental('sharp');\r\n        this.announce(appState.display.sharp ? 'Sharp names enabled' : 'Sharp names disabled');\r\n        break;\r\n        \r\n      case 'resetRings':\r\n        ActionController.resetRings();\r\n        this.announce('All rings reset to starting position');\r\n        break;\r\n        \r\n      case 'toggleFineMode':\r\n        this.navigationMode = this.navigationMode === 'fine' ? 'normal' : 'fine';\r\n        this.announce(`Fine control mode ${this.navigationMode === 'fine' ? 'enabled' : 'disabled'}`);\r\n        break;\r\n        \r\n      case 'toggleHelp':\r\n        this.toggleKeyboardHelp();\r\n        break;\r\n        \r\n    }\r\n  }\r\n\r\n  /**\n   * Rotate a specific ring by steps and snap to nearest position\n   */\n  static rotateRingAndSnap(ringName: RotatableRing, steps: number) {\n    if (ringName === 'degree') {\r\n      // For degree ring, jump to next/previous diatonic degree with animation\r\n      this.rotateDegreeRingDiatonically(steps);\r\n    } else if (ringName === 'pitchClass') {\r\n      // For pitch class ring, move by semitone steps with animation\r\n      const stepAngle = steps * (Math.PI * 2 / 12);\r\n      const currentAngle = appState.rings.pitchClass;\r\n      const targetAngle = normAngle(currentAngle + stepAngle);\r\n\r\n      // Calculate the snapped target (nearest semitone)\r\n      const targetIndex = Math.round(-targetAngle / ANGLE_STEP);\r\n      const snappedTarget = normAngle(-targetIndex * ANGLE_STEP);\r\n\r\n      // Animate to the snapped position\r\n      startSnap({\r\n        pitchClass: snappedTarget\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\n   * Rotate the degree ring to the next/previous diatonic degree\n   * Follows the major scale interval pattern: +2, +2, +1, +2, +2, +2, +1\n   */\n  static rotateDegreeRingDiatonically(steps: number) {\n    const { degree, chromatic } = appState.rings;\r\n    const effectiveDegreeRotation = normAngle(degree - chromatic);\r\n\r\n    // Find current diatonic degree index (0-6)\r\n    const currentRelativeIndexFloat = normAngle(-effectiveDegreeRotation) / ANGLE_STEP;\r\n\r\n    // Find the closest current diatonic index\r\n    let currentDiatonicIndex = 0;\r\n    let minDiff = Infinity;\r\n\r\n    DIATONIC_DEGREE_INDICES.forEach((validIndex, i) => {\r\n      const diff = Math.abs(currentRelativeIndexFloat - validIndex);\r\n      const circularDiff = Math.min(diff, 12 - diff);\r\n\r\n      if (circularDiff < minDiff) {\r\n        minDiff = circularDiff;\r\n        currentDiatonicIndex = i; // Store the index in DIATONIC_DEGREE_INDICES array (0-6)\r\n      }\r\n    });\r\n\r\n    // Move to next/previous diatonic degree based on direction\r\n    const direction = steps > 0 ? 1 : -1;\r\n    const targetDiatonicIndex = (currentDiatonicIndex + direction + 7) % 7;\r\n    const targetSemitoneIndex = DIATONIC_DEGREE_INDICES[targetDiatonicIndex];\r\n\r\n    // Calculate target angle\r\n    const targetEffectiveRotation = normAngle(-targetSemitoneIndex * ANGLE_STEP);\r\n    const targetDegree = normAngle(targetEffectiveRotation + chromatic);\r\n\r\n    // Animate to the target position\r\n    startSnap({\r\n      degree: targetDegree,\r\n      highlightPosition: targetDegree\r\n    });\r\n  }\r\n\r\n  /**\n   * Rotate all rings together (chromatic control) and snap\n   */\n  static rotateAllRingsAndSnap(steps: number) {\n    const stepAngle = steps * (Math.PI * 2 / 12);\r\n\r\n    // Calculate target angles for all rings\r\n    const targetPitchClass = normAngle(appState.rings.pitchClass + stepAngle);\r\n    const targetDegree = normAngle(appState.rings.degree + stepAngle);\r\n    const targetChromatic = normAngle(appState.rings.chromatic + stepAngle);\r\n\r\n    // Calculate snapped chromatic position\r\n    const chromIdx = Math.round(-targetChromatic / ANGLE_STEP);\r\n    const snappedChromatic = normAngle(-chromIdx * ANGLE_STEP);\r\n\r\n    // Calculate how much the chromatic ring needs to snap\r\n    const snapDelta = snappedChromatic - targetChromatic;\r\n\r\n    // Apply the snap delta to pitch and degree rings too\r\n    const snappedPitchClass = normAngle(targetPitchClass + snapDelta);\r\n    const snappedDegree = normAngle(targetDegree + snapDelta);\r\n\r\n    // Animate all rings to their snapped positions\r\n    startSnap({\r\n      pitchClass: snappedPitchClass,\r\n      degree: snappedDegree,\r\n      chromatic: snappedChromatic,\r\n      highlightPosition: snappedDegree\r\n    });\r\n  }\r\n\r\n  /**\n   * Select a note directly by index\n   */\n  static selectNoteDirectly(noteIndex: number) {\n    const targetAngle = normAngle(-noteIndex * (Math.PI * 2 / 12));\r\n    ActionController.setRingAngle('chromatic', targetAngle);\r\n    this.announce(`Selected note ${noteIndex + 1}`);\r\n  }\r\n\r\n\r\n  /**\r\n   * Toggle keyboard help overlay\r\n   */\r\n  static toggleKeyboardHelp() {\n    let helpOverlay = document.querySelector<HTMLElement>('.keyboard-help-overlay');\n    \r\n    if (helpOverlay) {\r\n      helpOverlay.remove();\r\n      this.announce('Keyboard help closed');\r\n      return;\r\n    }\r\n    \r\n    helpOverlay = document.createElement('div');\r\n    helpOverlay.className = 'keyboard-help-overlay';\r\n    helpOverlay.innerHTML = this.generateHelpContent();\r\n    \r\n    // Close on escape or click outside\r\n    const closeHelp = () => {\r\n      helpOverlay.remove();\r\n      this.announce('Keyboard help closed');\r\n    };\r\n    \r\n    const closeButton = helpOverlay.querySelector<HTMLButtonElement>('.keyboard-help-close');\n    if (closeButton) {\n      closeButton.addEventListener('click', closeHelp);\n    }\n    \r\n    document.addEventListener('keydown', (e) => {\r\n      if (e.key === 'Escape' && document.querySelector('.keyboard-help-overlay')) {\r\n        closeHelp();\r\n      }\r\n    }, { once: true });\r\n    \r\n    document.body.appendChild(helpOverlay);\n    closeButton?.focus();\n    this.announce('Keyboard help opened');\n  }\n\r\n  /**\r\n   * Generate help content HTML\r\n   */\r\n  static generateHelpContent() {\r\n    const shortcuts = Array.from(this.keyMap.entries())\r\n      .filter(([key, command]) => command.description)\r\n      .sort(([a], [b]) => a.localeCompare(b));\r\n    \r\n    const shortcutHTML = shortcuts.map(([key, command]) => \r\n      `<div class=\"keyboard-help-key\">${key}</div>\r\n       <div class=\"keyboard-help-description\">${command.description}</div>`\r\n    ).join('');\r\n    \r\n    return `\r\n      <h2>Keyboard Shortcuts</h2>\r\n      <div class=\"keyboard-help-shortcuts\">\r\n        ${shortcutHTML}\r\n      </div>\r\n      <button class=\"keyboard-help-close\">Close (Esc)</button>\r\n    `;\r\n  }\r\n\r\n  /**\n   * Announce ring position for screen readers\n   */\n  static announceRingPosition(ringType: ActiveRing) {\n    // This will be enhanced with actual musical information\n    const ringKey = ringType === 'pitch' ? 'pitchClass' : ringType;\n    const position = Math.round((appState.rings[ringKey] || 0) * 180 / Math.PI);\n    this.announce(`${ringType} ring at ${position} degrees`);\n  }\n\r\n  /**\r\n   * Announce playback state\r\n   */\r\n  static announcePlaybackState() {\r\n    const message = appState.playback.isPlaying ? 'Scale playing' : 'Playback stopped';\r\n    this.announce(message);\r\n  }\r\n\r\n  /**\r\n   * Announce sidebar state\r\n   */\r\n  static announceSidebarState() {\r\n    const message = appState.ui.sidebarOpen ? 'Settings opened' : 'Settings closed';\r\n    this.announce(message);\r\n  }\r\n\r\n\r\n  /**\n   * Announce message to screen readers\n   */\n  static announce(message: string, priority: AriaLive = 'polite') {\n    const announcer = document.createElement('div');\r\n    announcer.setAttribute('aria-live', priority);\r\n    announcer.setAttribute('aria-atomic', 'true');\r\n    announcer.className = 'sr-only';\r\n    announcer.textContent = message;\r\n    \r\n    // Add screen reader only styles\r\n    announcer.style.position = 'absolute';\r\n    announcer.style.left = '-10000px';\r\n    announcer.style.width = '1px';\r\n    announcer.style.height = '1px';\r\n    announcer.style.overflow = 'hidden';\r\n    \r\n    document.body.appendChild(announcer);\r\n    \r\n    // Remove after announcement\r\n    setTimeout(() => {\r\n      if (announcer.parentNode) {\r\n        announcer.parentNode.removeChild(announcer);\r\n      }\r\n    }, 1000);\r\n  }\r\n\r\n  /**\r\n   * Enable keyboard navigation\r\n   */\r\n  static enable() {\r\n    this.isEnabled = true;\r\n    this.announce('Keyboard navigation enabled');\r\n  }\r\n\r\n  /**\r\n   * Disable keyboard navigation\r\n   */\r\n  static disable() {\r\n    this.isEnabled = false;\r\n    this.announce('Keyboard navigation disabled');\r\n  }\r\n\r\n  /**\r\n   * Get current keyboard shortcuts\r\n   */\r\n  static getShortcuts() {\r\n    return Array.from(this.keyMap.entries()).map(([key, command]) => ({\r\n      key,\r\n      description: command.description,\r\n      action: command.action\r\n    }));\r\n  }\r\n}\r\n"],"names":["KeyboardManager","ringType","error","ErrorHandler","CONFIG","i","style","isTextInput","key","command","parts","activeElement","shouldPrevent","event","stepSize","direction","ActionController","appState","newOrientation","ringName","steps","stepAngle","currentAngle","targetAngle","normAngle","targetIndex","ANGLE_STEP","snappedTarget","startSnap","degree","chromatic","effectiveDegreeRotation","currentRelativeIndexFloat","currentDiatonicIndex","minDiff","DIATONIC_DEGREE_INDICES","validIndex","diff","circularDiff","targetDiatonicIndex","targetSemitoneIndex","targetEffectiveRotation","targetDegree","targetPitchClass","targetChromatic","chromIdx","snappedChromatic","snapDelta","snappedPitchClass","snappedDegree","noteIndex","helpOverlay","closeHelp","closeButton","e","a","b","ringKey","position","message","priority","announcer","__publicField"],"mappings":"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"}