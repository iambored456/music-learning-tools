import"./modulepreload-polyfill-B5Qt9EMX.js";import{S as Ll,G as je,L as Hs,a as qs,F as pi,C as gi,n as Rt,g as Gs,c as Pe,M as kl,A as Nl,D as _n,s as Xo,T as rt,V as Cs,b as Rl,d as Bl,e as Dl,P as Fl,f as Nt,h as As,i as Wl,j as Ol,k as _l}from"./vendor-tone-Cer4uW5H.js";import{B as zl,f as ue,r as $l,c as Hl,n as Te,s as ql,a as Gl,b as Vl,g as _e,d as Vs,z as Us,D as _t,e as Ul,i as co,h as ar,o as Re,j as Ge,k as Ve,S as Xl,w as Yl,l as Ql,m as jl,p as Zl,q as dn,t as ie}from"./navigation-Bl6AO8PX.js";import{p as Hi,g as Kl,e as zn,d as Jl,a as tc,t as ec,b as nc,c as Xs,i as oc,f as bn,h as ic,s as $n,m as vi,j as sc}from"./vendor-tonal-NhM_OQIN.js";import{h as ac}from"./vendor-html2canvas-k0ITeQhV.js";import{j as rc,E as lc,k as vt,g as V,l as cc,n as li,p as Wt,o as Tt,q as sn,u as ae,f as Ue,c as Dt,s as $t,t as an,a as oe,r as Ot,h as wt,v as Je,w as dc,x as Yo,y as Zn,z as uc,d as hc,A as hn,$ as fc,e as mc,i as pc,b as Bo,B as gc,m as rr}from"./legacy-BhVoqlM1.js";function vc(n,t,...e){var o=new zl(n);rc(()=>{const i=t()??null;o.ensure(i,i&&(s=>i(s,...e)))},lc)}function bc(n){var t=cc(0);return function(){return arguments.length===1?(vt(t,V(t)+1),arguments[0]):(V(t),n())}}const wc="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAAAXNSR0IArs4c6QAACC9JREFUeF7tnU9rXFUcQH93Jgm0iVXQrQtFIaAJdSvu9QNY/PMt/Br6BRR1objShXRjSlxLK1QRBXEnqYKplNTWRsR05sqb9KWvw5vJmzb32HFONk0mM+/enHc4eZle7kvb79/M4UdRAsNI8eyfP8cw9YqO48EjkkKX10ChyzOuR1BogLVCA5DvDKHQAGuFBiArNAdZoTnWFhpgrdAAZAvNQVZojrWFBlgrNADZQnOQFZpjbaEB1goNQLbQHGSF5lhbaIC1QgOQLTQHWaE51hYaYK3QAGQLzUEeRIqnb+242g5AbqEByL2c46e1U9EfjZUiolqxW/3b9tH83vjzpr2ueaxpr5tl7Hq+1b+zvK75s7FzVmhI6O8ePXNHaGDABR5CoYGTXxVaoQHQ1e89F/iXB63Q5RnXIyg0wFqhAci+y8FBVmiOtYUGWCs0ANlCc5AVmmNtoQHWCg1AttAcZIXmWFtogLVCA5AtNAdZoTnWFhpgrdAAZAvNQVZojnX64oObuV4bNR/rqQ7hzNOcK6F/OOPiJELr9Nb5/dHuoylHHJndGHn88ebX9eeTntPl8Unjjv/wbWPNy5yHOcdTf6+28iVO8iKNkV6/8Jfb6RY+44PI8dIfp2M4aQl04fEX6fAKDZxthQYg138UWujysBW6PON6BAsNsFZoALKF5iArNMfaQgOsFRqAbKE5yArNsbbQAGuFBiBbaA6yQnOsLTTAWqEByBaag6zQHGsLDbBWaACyheYgKzTH2kIDrCuhX7xxKgaNxUnTVhlW32v7aFsNOWn6sx6jy6rHeZizQgNCL+UUF9auxHK+e/P649aet01rlsV6k5ZQdtnzdBKSeZizQgNC93OKrbWdWIq7QgPDLuQQCg2cdoUGIPtHIQdZoTnWFhpgrdAAZAvNQVZojrWFBlgrNADZQnOQFZpjbaEB1goNQLbQHGSF5lhbaIC1QgOQLTQHWaE51hYaYK3QAGQLzUFWaI51enX7+mhh1v3ckbl+zaQ7S3d5vOvdrNvGmpc5V0J/eXrXxUmA1+mFi1tu1lgc9CB+PViPlIbFR1r0AdLGpfMKXdiCFIP47Z9NhS7MuTq8QhOQFRqgfDiEQgOoLTQAuX6Xw0uO8rAVujzjegQLDbBWaACyhQYhew2NwbbQAGoLDUC20CBkC43BttAAagsNQLbQIGQLjcG20ABqCw1AttAgZAuNwbbQAGoLDUC20CDkUaE3oudqu+LQLXRxxBGDSLF+cC1ySpGj3v+zuchx2mNtE6xf29xLtO2x8dceN2b1/OqYzZXm458f/SfznU/ajvnfzVmhAaFvRy9eObgcg9QHRlvsIRQaOP8KDUD2GpqDrNAcawsNsFZoALKF5iArNMfaQgOsFRqAbKE5yArNsbbQAGuFBiBbaA6yQnOsLTTAWqEByBaag6zQHGsLDbBWaACyheYgKzTHOp299Pk9e9vNw/2cx/E87HM+iF68fPBt3HZxUnGz00fbb9wjdL14sG3kaTc+7zrTWY8xbT71mA/7nPt5EBdXN6Mf7j7a1ZP7fV76ZPs1dx+9X3odX9fLg/hq9axCd+T1IE9T6Aeh1/G1Ct0R1Ak8TaFPAOJxh1Do4wid3PcV+uRYTjySQgOQ67ftvIYuD1uhyzM+eoNAocvDVujyjBWaYxwKzcH2GhpgrdAAZK+hOcgKzbG20ABrhQYgW2gOskJzrC00wFqhAcgWmoOs0BxrCw2wrlbbfX16w8VJAGuFBiAPUopnblyPYaoXzx634LW5k+j47p5dFkeOH7/59SxjV3AmzaUJbtrxuywAro51MnNWaEjozb3dGKYeMNpiD6HQwPmvCq3QAOiq867lKA9aocszdi0HxzgUmoNtoQHWCg1A9n1oDrJCc6wtNMBaoQHIFpqDrNAcawsNsFZoALKF5iArNMfaQgOsFRqAbKE5yArNsbbQAGuFBiDXhf50y73tSuMepIj1G1ddnFQadLWWY+fDc/noXuXjKxOPu8/6+Fais9xTfdI90asfum3F4aR7qs/BnFNOcfWx36OXXW1X2um0+965LgtsS8/jf338NExx5QmFJk6yQgOUFRqAXF9DW+jysBW6PON6BAsNsFZoALKFBiF7DY3BttAAagsNQLbQIGQLjcG20ABqCw1AttAgZAuNwbbQAGoLDUC20CBkC43BttAAagsNQLbQIGQLjcG20ADqqtC/PH4tennSnc6BSSzIEAoNnOgcw1jbfy4iefP60rgVujTh0Ya0w3jk1vMKDbBWaACyQgOQ/aOQg6zQHGsLDbBWaACyheYgKzTH2kIDrBUagGyhOcgKzbG20ABrhQYgW2gOskJzrC00wFqhAcgWmoOs0BxrCw2wVmgAsoXmICs0xzrtvvtmPryf87QdEpsTau7gWGK3xrYdIqvxZ9mtcdoOjvycR0Lvr7s4CfA67b3zsZs1Fgfdi5X+jxHRLz7Sog+Qrr/9mUIXtiDnXqwsf6PQhTmPfo8rdHnKCl2ecT2CQgOsFRqAXL/LYaHLw1bo8owtNMc4FJqD7SUHwFqhAchecnCQFZpjbaEB1goNQLbQHGSF5lhbaIC1QgOQLTQHWaE51hYaYK3QAGQLzUFWaI61hQZYV0IvLX/v4iSAtUITkPMw9laejBTuPloat0KXJlwtacyDuLqyGT2FLk5boYsjVmgA8dEQCg3QttAAZN/lACF7yYHBttAAagsNQLbQIGQLjcG20ABqCw1AttAgZAuNwbbQAGoLDUC20CBkC43BttAAagsNQLbQIGQLjcG20ABqCw1AttAgZAuNwf4X8h6Lm5rywjsAAAAASUVORK5CYII=",yc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20372%20372'%20fill='none'%20aria-hidden='true'%3e%3cpath%20fill='currentColor'%20fill-rule='evenodd'%20d='M%20167.00%20326.50%20L%20156.00%20324.50%20L%2045.50%20215.00%20L%2042.50%20210.00%20L%2043.50%20199.00%20L%2049.00%20192.50%20L%20128.00%20151.50%20L%20147.00%20132.50%20L%20151.00%20130.50%20L%20163.00%20129.50%20L%20169.00%20131.50%20L%20189.00%20149.50%20L%20291.00%2046.50%20L%20298.00%2043.50%20L%20307.00%2043.50%20L%20312.00%2045.50%20L%20321.50%2054.00%20L%20326.50%2063.00%20L%20327.50%2070.00%20L%20323.50%2081.00%20L%20221.50%20184.00%20L%20238.50%20202.00%20L%20240.50%20207.00%20L%20239.50%20219.00%20L%20222.50%20236.00%20L%20179.50%20316.00%20L%20172.00%20324.50%20L%20167.00%20326.50%20Z%20M%20210.50%20172.00%20L%20309.50%2073.00%20L%20310.50%2068.00%20L%20304.00%2060.50%20L%20300.00%2060.50%20L%20198.50%20161.00%20L%20209.00%20172.50%20L%20210.50%20172.00%20Z%20M%20215.50%20221.00%20L%20224.50%20212.00%20L%20224.50%20209.00%20L%20160.00%20145.50%20L%20158.00%20145.50%20L%20148.50%20155.00%20L%20148.50%20157.00%20L%20212.00%20219.50%20L%20215.50%20221.00%20Z%20M%20164.50%20308.00%20L%20204.50%20235.00%20L%20137.00%20167.50%20L%20134.00%20165.50%20L%2059.50%20206.00%20L%2088.00%20234.50%20L%20116.00%20215.50%20L%20120.00%20213.50%20L%20127.00%20214.50%20L%20129.50%20218.00%20L%20129.50%20224.00%20L%20100.50%20247.00%20L%20124.00%20270.50%20L%20145.00%20248.50%20L%20153.00%20248.50%20L%20157.50%20254.00%20L%20156.50%20259.00%20L%20136.50%20281.00%20L%20136.50%20283.00%20L%20162.00%20308.50%20L%20164.50%20308.00%20Z%20M%20252.00%20295.50%20L%20245.00%20295.50%20L%20238.50%20289.00%20L%20239.50%20280.00%20L%20248.00%20274.50%20L%20253.00%20275.50%20L%20258.50%20281.00%20L%20259.50%20285.00%20L%20257.50%20291.00%20L%20252.00%20295.50%20Z%20M%20218.00%20326.50%20L%20211.00%20325.50%20L%20205.50%20318.00%20L%20206.50%20312.00%20L%20212.00%20306.50%20L%20220.00%20306.50%20L%20225.50%20312.00%20L%20225.50%20321.00%20L%20218.00%20326.50%20Z'/%3e%3c/svg%3e",Sc="data:image/svg+xml,%3csvg%20class='diamond-icon'%20viewBox='0%200%20120%20120'%20aria-hidden='true'%20focusable='false'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M60%205%20L35%2048.3%20L35%2071.7%20L60%20115%20L85%2071.7%20L85%2048.3%20Z'%20/%3e%3c/svg%3e",Cc="/music-learning-tools/assets/eraser-vjnwKGf-.svg",Ac="data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20fill='none'%20stroke='currentColor'%20stroke-width='2'%20stroke-dasharray='3%202'%20xmlns='http://www.w3.org/2000/svg'%3e%3cellipse%20cx='12'%20cy='12'%20rx='8'%20ry='6'%20transform='rotate(-15%2012%2012)'/%3e%3c/svg%3e",xc="/music-learning-tools/assets/loop-DCKCNdJ9.svg",Mc="data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20fill='none'%20stroke='currentColor'%20stroke-width='2'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M18%202L6%2014l-2%206%206-2L22%206l-4-4z'/%3e%3cline%20x1='14'%20y1='6'%20x2='18'%20y2='10'/%3e%3c/svg%3e",lr="/music-learning-tools/assets/pause-BvM7-xog.svg",cr="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20512%20512'%20fill='none'%20aria-hidden='true'%3e%3cpath%20fill='currentColor'%20d='M%20152%20104%20L%20144%20106%20L%20143%20108%20L%20141%20108%20L%20133%20114%20L%20130%20120%20L%20128%20130%20L%20128%20382%20L%20132%20396%20L%20140%20404%20L%20147%20406%20L%20149%20408%20L%20164%20408%20L%20165%20406%20L%20168%20406%20L%20178%20401%20L%20180%20398%20L%20184%20397%20L%20207%20381%20L%20224%20372%20L%20229%20367%20L%20240%20362%20L%20242%20359%20L%20249%20356%20L%20254%20351%20L%20267%20345%20L%20269%20342%20L%20286%20333%20L%20293%20327%20L%20304%20322%20L%20306%20319%20L%20316%20314%20L%20322%20309%20L%20326%20308%20L%20331%20303%20L%20335%20302%20L%20344%20295%20L%20354%20290%20L%20356%20287%20L%20367%20282%20L%20378%20271%20L%20381%20265%20L%20382%20250%20L%20377%20239%20L%20367%20230%20L%20363%20229%20L%20343%20215%20L%20325%20205%20L%20318%20199%20L%20309%20195%20L%20308%20193%20L%20301%20190%20L%20287%20180%20L%20283%20179%20L%20281%20176%20L%20274%20173%20L%20268%20168%20L%20259%20164%20L%20257%20161%20L%20246%20156%20L%20244%20153%20L%20237%20150%20L%20232%20145%20L%20221%20140%20L%20217%20136%20L%20210%20133%20L%20201%20126%20L%20197%20125%20L%20195%20122%20L%20183%20116%20L%20177%20111%20L%20164%20105%20Z'/%3e%3c/svg%3e",Ec="/music-learning-tools/assets/redo-C3TqBHBd.svg",Pc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%20fill='none'%20stroke='currentColor'%20stroke-width='2'%20stroke-linecap='round'%20stroke-linejoin='round'%20aria-hidden='true'%3e%3ccircle%20cx='12'%20cy='12'%20r='3'/%3e%3cpath%20d='M19.4%2015a1.65%201.65%200%200%200%20.33%201.82l.06.06a2%202%200%200%201%200%202.83%202%202%200%200%201-2.83%200l-.06-.06a1.65%201.65%200%200%200-1.82-.33%201.65%201.65%200%200%200-1%201.51V21a2%202%200%200%201-2%202%202%202%200%200%201-2-2v-.09a1.65%201.65%200%200%200-1-1.51%201.65%201.65%200%200%200-1.82.33l-.06.06a2%202%200%200%201-2.83%200%202%202%200%200%201%200-2.83l.06-.06A1.65%201.65%200%200%200%204.6%2015a1.65%201.65%200%200%200-1.51-1H3a2%202%200%200%201-2-2%202%202%200%200%201%202-2h.09A1.65%201.65%200%200%200%204.6%209a1.65%201.65%200%200%200-.33-1.82l-.06-.06a2%202%200%200%201%200-2.83%202%202%200%200%201%202.83%200l.06.06A1.65%201.65%200%200%200%209%204.6a1.65%201.65%200%200%200%201-1.51V3a2%202%200%200%201%202-2%202%202%200%200%201%202%202v.09A1.65%201.65%200%200%200%2015%204.6a1.65%201.65%200%200%200%201.82-.33l.06-.06a2%202%200%200%201%202.83%200%202%202%200%200%201%200%202.83l-.06.06A1.65%201.65%200%200%200%2019.4%209a1.65%201.65%200%200%200%201.51%201H21a2%202%200%200%201%202%202%202%202%200%200%201-2%202h-.09A1.65%201.65%200%200%200%2019.4%2015z'/%3e%3c/svg%3e",Tc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%20fill='currentColor'%20aria-hidden='true'%3e%3c!--%20Rounded%20stop%20square%20--%3e%3crect%20x='5'%20y='5'%20width='14'%20height='14'%20rx='3'%20ry='3'%20/%3e%3c/svg%3e",Ic="/music-learning-tools/assets/undo-D1s0pqx2.svg",Lc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%20fill='currentColor'%20aria-hidden='true'%3e%3c!--%20Rounded%20speaker%20--%3e%3cpath%20d='%20M4%209.5%20Q4%209%204.5%209%20H7.3%20L11.4%205.6%20Q12%205.1%2012.5%205.4%20Q13%205.7%2013%206.3%20V17.7%20Q13%2018.3%2012.5%2018.6%20Q12%2018.9%2011.4%2018.4%20L7.3%2015%20H4.5%20Q4%2015%204%2014.5%20Z%20'/%3e%3c!--%20Inner%20rounded%20wave%20--%3e%3cpath%20d='%20M15.7%209.7%20Q17.5%2012%2015.7%2014.3%20Q15.3%2014.8%2014.8%2014.4%20Q14.3%2014%2014.8%2013.4%20Q15.9%2012%2014.8%2010.6%20Q14.3%2010%2014.8%209.6%20Q15.3%209.2%2015.7%209.7%20Z%20'/%3e%3c!--%20Outer%20rounded%20wave%20--%3e%3cpath%20d='%20M18.7%207.5%20Q22%2012%2018.7%2016.5%20Q18.3%2017%2017.8%2016.6%20Q17.3%2016.2%2017.7%2015.6%20Q20.3%2012%2017.7%208.4%20Q17.3%207.8%2017.8%207.4%20Q18.3%207%2018.7%207.5%20Z%20'/%3e%3c/svg%3e",kc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%20fill='currentColor'%20aria-hidden='true'%3e%3c!--%20Magnifying%20glass%20--%3e%3cpath%20d='%20M10.5%204%20C6.9%204%204%206.9%204%2010.5%20C4%2014.1%206.9%2017%2010.5%2017%20C12.0%2017%2013.4%2016.5%2014.5%2015.6%20L18.6%2019.7%20Q19%2020.1%2019.5%2019.7%20Q20%2019.3%2019.6%2018.9%20L15.5%2014.8%20C16.5%2013.7%2017%2012.2%2017%2010.5%20C17%206.9%2014.1%204%2010.5%204%20Z%20M10.5%206%20C13.0%206%2015%208.0%2015%2010.5%20C15%2013.0%2013.0%2015%2010.5%2015%20C8.0%2015%206%2013.0%206%2010.5%20C6%208.0%208.0%206%2010.5%206%20Z%20'/%3e%3c!--%20Plus%20sign%20--%3e%3cpath%20d='%20M10%208.3%20Q10%208%2010.3%208%20H10.7%20Q11%208%2011%208.3%20V10%20H12.7%20Q13%2010%2013%2010.3%20V10.7%20Q13%2011%2012.7%2011%20H11%20V12.7%20Q11%2013%2010.7%2013%20H10.3%20Q10%2013%2010%2012.7%20V11%20H8.3%20Q8%2011%208%2010.7%20V10.3%20Q8%2010%208.3%2010%20H10%20Z%20'/%3e%3c/svg%3e",Nc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%20fill='currentColor'%20aria-hidden='true'%3e%3c!--%20Magnifying%20glass%20--%3e%3cpath%20d='%20M10.5%204%20C6.9%204%204%206.9%204%2010.5%20C4%2014.1%206.9%2017%2010.5%2017%20C12.0%2017%2013.4%2016.5%2014.5%2015.6%20L18.6%2019.7%20Q19%2020.1%2019.5%2019.7%20Q20%2019.3%2019.6%2018.9%20L15.5%2014.8%20C16.5%2013.7%2017%2012.2%2017%2010.5%20C17%206.9%2014.1%204%2010.5%204%20Z%20M10.5%206%20C13.0%206%2015%208.0%2015%2010.5%20C15%2013.0%2013.0%2015%2010.5%2015%20C8.0%2015%206%2013.0%206%2010.5%20C6%208.0%208.0%206%2010.5%206%20Z%20'/%3e%3c!--%20Minus%20sign%20--%3e%3cpath%20d='%20M8.3%2010%20Q8%2010%208%2010.3%20V10.7%20Q8%2011%208.3%2011%20H12.7%20Q13%2011%2013%2010.7%20V10.3%20Q13%2010%2012.7%2010%20H8.3%20Z%20'/%3e%3c/svg%3e",Rc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%20fill='none'%20stroke='currentColor'%20stroke-width='2'%20stroke-linecap='round'%20stroke-linejoin='round'%3e%3c!--%20Grid%20pattern%20--%3e%3cline%20x1='3'%20y1='3'%20x2='3'%20y2='21'%20/%3e%3cline%20x1='9'%20y1='3'%20x2='9'%20y2='21'%20/%3e%3cline%20x1='15'%20y1='3'%20x2='15'%20y2='21'%20/%3e%3cline%20x1='21'%20y1='3'%20x2='21'%20y2='21'%20/%3e%3cline%20x1='3'%20y1='6'%20x2='21'%20y2='6'%20/%3e%3cline%20x1='3'%20y1='12'%20x2='21'%20y2='12'%20/%3e%3cline%20x1='3'%20y1='18'%20x2='21'%20y2='18'%20/%3e%3c!--%20Eye%20with%20slash%20(hide)%20--%3e%3cpath%20d='M1%201%20L23%2023'%20stroke-width='2.5'/%3e%3c/svg%3e",Bc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%20fill='none'%20stroke='currentColor'%20stroke-width='2'%20stroke-linecap='round'%20stroke-linejoin='round'%3e%3c!--%20Drum%20pattern%20--%3e%3cellipse%20cx='12'%20cy='7'%20rx='7'%20ry='3'/%3e%3cpath%20d='M%205%207%20L%205%2017%20Q%205%2020%2012%2020%20Q%2019%2020%2019%2017%20L%2019%207'/%3e%3cline%20x1='8'%20y1='10'%20x2='8'%20y2='16'/%3e%3cline%20x1='16'%20y1='10'%20x2='16'%20y2='16'/%3e%3c!--%20Slash%20(hide)%20--%3e%3cpath%20d='M2%202%20L22%2022'%20stroke-width='2.5'/%3e%3c/svg%3e",Dc="/music-learning-tools/assets/newPage-C3DkqRnq.svg",Fc="/music-learning-tools/assets/open-yWU2irvQ.svg",Wc="/music-learning-tools/assets/print-y0OmDKSR.svg",Oc="/music-learning-tools/assets/saveAs-DyEXJ3e_.svg",_c="/music-learning-tools/assets/dottedQuarterNote-Cf79kpGq.svg",zc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='168'%20zoomAndPan='magnify'%20viewBox='0%200%20126%20231.75'%20height='309'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='f11b48ab54'%3e%3cpath%20d='M%200.0664062%200%20L%20125%200%20L%20125%20230.75%20L%200.0664062%20230.75%20Z%20M%200.0664062%200%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='9738701237'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23f11b48ab54)'%3e%3cpath%20style='%20stroke:none;fill-rule:nonzero;fill:%23000000;fill-opacity:1;'%20d='M%208.109375%20225.367188%20C%20-6.25%20212.289062%201.699219%20191.523438%2025.289062%20179.214844%20C%2033.234375%20175.371094%2039.132812%20173.574219%2049.386719%20173.832031%20C%2055.796875%20174.089844%2062.976562%20177.679688%2062.976562%20177.679688%20C%2062.976562%20131.273438%2062.71875%2043.585938%2062.71875%200.511719%20C%2065.285156%200.511719%2067.078125%200.257812%2070.667969%200.257812%20C%2070.667969%202.820312%2070.667969%204.871094%2070.667969%206.921875%20C%2070.667969%209.230469%2070.667969%2010.511719%2070.925781%2012.050781%20C%2073.488281%2028.203125%2077.078125%2034.613281%2095.023438%2054.355469%20C%20117.84375%2079.738281%20124.511719%2094.863281%20124.511719%20115.121094%20C%20124.253906%20134.09375%20107.589844%20174.601562%20104%20173.0625%20C%20109.125%20158.707031%20116.304688%20143.320312%20118.101562%20130.503906%20C%20120.40625%20114.863281%20114%2092.8125%20103.742188%2081.277344%20C%2095.539062%2071.53125%2076.050781%2063.070312%2070.667969%2063.070312%20C%2070.667969%2063.070312%2070.410156%20156.398438%2070.410156%20191.78125%20C%2070.410156%20197.675781%2065.027344%20208.1875%2061.949219%20211.777344%20C%2047.847656%20228.699219%2020.414062%20236.390625%208.109375%20225.367188%20Z%20M%208.109375%20225.367188%20'/%3e%3c/g%3e%3c/g%3e%3c/svg%3e",$c="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%3e%3ccircle%20cx='12'%20cy='12'%20r='10'%20stroke='currentColor'%20stroke-width='1.5'%20fill='none'/%3e%3cpath%20d='M%2012%2012%20L%2022%2012%20A%2010%2010%200%200%200%2012%202%20Z'%20fill='currentColor'/%3e%3c/svg%3e",Hc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%3e%3ccircle%20cx='12'%20cy='12'%20r='10'%20stroke='currentColor'%20stroke-width='1.5'%20fill='none'/%3e%3cpath%20d='M%2012%2012%20L%2022%2012%20A%2010%2010%200%200%200%2012%202%20Z'%20fill='currentColor'%20transform='rotate(180,%2012,%2012)'/%3e%3c/svg%3e",qc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%3e%3ccircle%20cx='12'%20cy='12'%20r='10'%20stroke='currentColor'%20stroke-width='1.5'%20fill='none'/%3e%3cpath%20d='M%2012%2012%20L%2022%2012%20A%2010%2010%200%200%200%2012%202%20Z'%20fill='currentColor'%20transform='rotate(270,%2012,%2012)'/%3e%3c/svg%3e",Gc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%3e%3ccircle%20cx='12'%20cy='12'%20r='10'%20stroke='currentColor'%20stroke-width='1.5'%20fill='none'/%3e%3cpath%20d='M%2012%2012%20L%2022%2012%20A%2010%2010%200%200%200%2012%202%20Z'%20fill='currentColor'%20transform='rotate(90,%2012,%2012)'/%3e%3c/svg%3e",Vc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='111'%20zoomAndPan='magnify'%20viewBox='0%200%2083.25%20230.999992'%20height='308'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='084e4edff4'%3e%3cpath%20d='M%201%20165%20L%2081.761719%20165%20L%2081.761719%20229.226562%20L%201%20229.226562%20Z%20M%201%20165%20'/%3e%3c/clipPath%3e%3cclipPath%20id='fdeab4882e'%3e%3cpath%20d='M%2073%201.03125%20L%2081.761719%201.03125%20L%2081.761719%20192%20L%2073%20192%20Z%20M%2073%201.03125%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='45713f1632'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23084e4edff4)'%3e%3cpath%20style='%20stroke:none;fill-rule:evenodd;fill:%23000000;fill-opacity:0.9;'%20d='M%2057.546875%20222.390625%20C%2076.429688%20212.289062%2086.492188%20194.003906%2080.304688%20180.25%20C%2073.699219%20165.578125%2051.011719%20161.4375%2029.660156%20171.003906%20C%208.308594%20180.574219%20-3.664062%20200.25%202.9375%20214.921875%20C%209.542969%20229.59375%2032.230469%20233.734375%2053.582031%20224.164062%20C%2054.917969%20223.566406%2056.285156%20223.0625%2057.546875%20222.390625%20Z%20M%2057.546875%20222.390625%20'/%3e%3c/g%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23fdeab4882e)'%3e%3cpath%20style='fill:none;stroke-width:1.5;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%20299.504676%20305.984569%20L%20299.504676%20339.572267%20'%20transform='matrix(-5.561147,0,0,-5.549953,1743.335656,1885.43835)'/%3e%3c/g%3e%3c/g%3e%3c/svg%3e",Uc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='456e80bb30'%3e%3cpath%20d='M%2017.898438%2024.675781%20L%20111.859375%2024.675781%20L%20111.859375%20118.640625%20L%2017.898438%20118.640625%20Z%20M%2017.898438%2024.675781%20'/%3e%3c/clipPath%3e%3cclipPath%20id='87c9148330'%3e%3cpath%20d='M%2064.878906%2024.675781%20C%2038.933594%2024.675781%2017.898438%2045.710938%2017.898438%2071.660156%20C%2017.898438%2097.605469%2038.933594%20118.640625%2064.878906%20118.640625%20C%2090.828125%20118.640625%20111.859375%2097.605469%20111.859375%2071.660156%20C%20111.859375%2045.710938%2090.828125%2024.675781%2064.878906%2024.675781%20Z%20M%2064.878906%2024.675781%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='d7032f28cc'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23456e80bb30)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%2387c9148330)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%20-0.00202662%20C%2028.250074%20-0.00202662%200.0009548%2028.247092%200.0009548%2063.095541%20C%200.0009548%2097.938745%2028.250074%20126.187864%2063.093277%20126.187864%20C%2097.941726%20126.187864%20126.185599%2097.938745%20126.185599%2063.095541%20C%20126.185599%2028.247092%2097.941726%20-0.00202662%2063.093277%20-0.00202662%20Z%20M%2063.093277%20-0.00202662%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.67729)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(44.895794,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%2017.8125%200%20L%2017.8125%20-40.09375%20L%204.203125%20-40.09375%20L%204.203125%20-51.09375%20C%207.367188%20-51.09375%209.992188%20-51.253906%2012.078125%20-51.578125%20C%2014.171875%20-51.910156%2015.914062%20-52.6875%2017.3125%20-53.90625%20C%2018.71875%20-55.132812%2019.957031%20-57.09375%2021.03125%20-59.78125%20L%2031.3125%20-59.78125%20L%2031.3125%200%20Z%20M%2017.8125%200%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",Xc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='af2f53afe5'%3e%3cpath%20d='M%2017.898438%2024.566406%20L%20111.859375%2024.566406%20L%20111.859375%20118.527344%20L%2017.898438%20118.527344%20Z%20M%2017.898438%2024.566406%20'/%3e%3c/clipPath%3e%3cclipPath%20id='c8dd529e93'%3e%3cpath%20d='M%2064.878906%2024.566406%20C%2038.933594%2024.566406%2017.898438%2045.601562%2017.898438%2071.546875%20C%2017.898438%2097.496094%2038.933594%20118.527344%2064.878906%20118.527344%20C%2090.828125%20118.527344%20111.859375%2097.496094%20111.859375%2071.546875%20C%20111.859375%2045.601562%2090.828125%2024.566406%2064.878906%2024.566406%20Z%20M%2064.878906%2024.566406%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='4829c2bf70'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23af2f53afe5)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23c8dd529e93)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%200.00130943%20C%2028.250074%200.00130943%200.0009548%2028.250428%200.0009548%2063.093632%20C%200.0009548%2097.942081%2028.250074%20126.185954%2063.093277%20126.185954%20C%2097.941726%20126.185954%20126.185599%2097.942081%20126.185599%2063.093632%20C%20126.185599%2028.250428%2097.941726%200.00130943%2063.093277%200.00130943%20Z%20M%2063.093277%200.00130943%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.565431)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(38.720147,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%203.046875%200%20L%203.046875%20-11.1875%20C%2010.921875%20-16.726562%2017.179688%20-21.421875%2021.828125%20-25.265625%20C%2026.484375%20-29.117188%2029.835938%20-32.507812%2031.890625%20-35.4375%20C%2033.953125%20-38.363281%2034.984375%20-41.109375%2034.984375%20-43.671875%20C%2034.984375%20-45.992188%2034.160156%20-47.75%2032.515625%20-48.9375%20C%2030.878906%20-50.132812%2028.957031%20-50.734375%2026.75%20-50.734375%20C%2024.90625%20-50.734375%2023.085938%20-50.210938%2021.296875%20-49.171875%20C%2019.503906%20-48.128906%2018.28125%20-46.207031%2017.625%20-43.40625%20L%205.28125%20-47.875%20C%206.894531%20-52.050781%209.664062%20-55.253906%2013.59375%20-57.484375%20C%2017.53125%20-59.722656%2022.125%20-60.84375%2027.375%20-60.84375%20C%2031.4375%20-60.84375%2035.078125%20-60.171875%2038.296875%20-58.828125%20C%2041.515625%20-57.492188%2044.046875%20-55.523438%2045.890625%20-52.921875%20C%2047.742188%20-50.328125%2048.671875%20-47.15625%2048.671875%20-43.40625%20C%2048.671875%20-37.375%2046.148438%20-31.773438%2041.109375%20-26.609375%20C%2036.078125%20-21.453125%2029.175781%20-16.3125%2020.40625%20-11.1875%20L%2048.953125%20-11.1875%20L%2048.953125%200%20Z%20M%203.046875%200%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",Yc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='0551ece328'%3e%3cpath%20d='M%2017.898438%2024.675781%20L%20111.859375%2024.675781%20L%20111.859375%20118.640625%20L%2017.898438%20118.640625%20Z%20M%2017.898438%2024.675781%20'/%3e%3c/clipPath%3e%3cclipPath%20id='073daee785'%3e%3cpath%20d='M%2064.878906%2024.675781%20C%2038.933594%2024.675781%2017.898438%2045.710938%2017.898438%2071.660156%20C%2017.898438%2097.605469%2038.933594%20118.640625%2064.878906%20118.640625%20C%2090.828125%20118.640625%20111.859375%2097.605469%20111.859375%2071.660156%20C%20111.859375%2045.710938%2090.828125%2024.675781%2064.878906%2024.675781%20Z%20M%2064.878906%2024.675781%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='04a7d7f831'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%230551ece328)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23073daee785)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%20-0.00202662%20C%2028.250074%20-0.00202662%200.0009548%2028.247092%200.0009548%2063.095541%20C%200.0009548%2097.938745%2028.250074%20126.187864%2063.093277%20126.187864%20C%2097.941726%20126.187864%20126.185599%2097.938745%20126.185599%2063.095541%20C%20126.185599%2028.247092%2097.941726%20-0.00202662%2063.093277%20-0.00202662%20Z%20M%2063.093277%20-0.00202662%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.67729)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(37.869539,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%2026.046875%201.078125%20C%2022.703125%201.078125%2019.492188%200.597656%2016.421875%20-0.359375%20C%2013.347656%20-1.316406%2010.644531%20-2.789062%208.3125%20-4.78125%20C%205.988281%20-6.78125%204.203125%20-9.363281%202.953125%20-12.53125%20L%2015.296875%20-17%20C%2016.078125%20-14.082031%2017.507812%20-12.023438%2019.59375%20-10.828125%20C%2021.6875%20-9.628906%2023.953125%20-9.03125%2026.390625%20-9.03125%20C%2029.203125%20-9.03125%2031.441406%20-9.71875%2033.109375%20-11.09375%20C%2034.773438%20-12.46875%2035.609375%20-14.378906%2035.609375%20-16.828125%20C%2035.609375%20-19.265625%2034.832031%20-21.15625%2033.28125%20-22.5%20C%2031.738281%20-23.84375%2029.695312%20-24.769531%2027.15625%20-25.28125%20C%2024.625%20-25.789062%2021.863281%20-26.046875%2018.875%20-26.046875%20L%2018.875%20-35.53125%20C%2024.007812%20-35.53125%2027.960938%20-36.242188%2030.734375%20-37.671875%20C%2033.515625%20-39.109375%2034.90625%20-41.140625%2034.90625%20-43.765625%20C%2034.90625%20-46.085938%2033.960938%20-47.828125%2032.078125%20-48.984375%20C%2030.203125%20-50.148438%2028.039062%20-50.734375%2025.59375%20-50.734375%20C%2023.382812%20-50.734375%2021.351562%20-50.195312%2019.5%20-49.125%20C%2017.65625%20-48.050781%2016.4375%20-46.144531%2015.84375%20-43.40625%20L%203.578125%20-47.875%20C%204.773438%20-50.914062%206.535156%20-53.390625%208.859375%20-55.296875%20C%2011.179688%20-57.210938%2013.863281%20-58.613281%2016.90625%20-59.5%20C%2019.945312%20-60.394531%2023.109375%20-60.84375%2026.390625%20-60.84375%20C%2029.140625%20-60.84375%2031.828125%20-60.546875%2034.453125%20-59.953125%20C%2037.078125%20-59.359375%2039.445312%20-58.421875%2041.5625%20-57.140625%20C%2043.6875%20-55.859375%2045.390625%20-54.242188%2046.671875%20-52.296875%20C%2047.953125%20-50.359375%2048.59375%20-48.050781%2048.59375%20-45.375%20C%2048.59375%20-42.144531%2047.726562%20-39.320312%2046%20-36.90625%20C%2044.269531%20-34.488281%2042.359375%20-32.6875%2040.265625%20-31.5%20C%2042.234375%20-30.78125%2043.914062%20-29.644531%2045.3125%20-28.09375%20C%2046.71875%20-26.539062%2047.78125%20-24.835938%2048.5%20-22.984375%20C%2049.21875%20-21.140625%2049.578125%20-19.296875%2049.578125%20-17.453125%20C%2049.578125%20-13.273438%2048.472656%20-9.828125%2046.265625%20-7.109375%20C%2044.054688%20-4.398438%2041.160156%20-2.359375%2037.578125%20-0.984375%20C%2034.003906%200.390625%2030.160156%201.078125%2026.046875%201.078125%20Z%20M%2026.046875%201.078125%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",Qc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='0f524ef70a'%3e%3cpath%20d='M%2017.898438%2024.675781%20L%20111.859375%2024.675781%20L%20111.859375%20118.640625%20L%2017.898438%20118.640625%20Z%20M%2017.898438%2024.675781%20'/%3e%3c/clipPath%3e%3cclipPath%20id='786a2dceed'%3e%3cpath%20d='M%2064.878906%2024.675781%20C%2038.933594%2024.675781%2017.898438%2045.710938%2017.898438%2071.660156%20C%2017.898438%2097.605469%2038.933594%20118.640625%2064.878906%20118.640625%20C%2090.828125%20118.640625%20111.859375%2097.605469%20111.859375%2071.660156%20C%20111.859375%2045.710938%2090.828125%2024.675781%2064.878906%2024.675781%20Z%20M%2064.878906%2024.675781%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='1bb9b822db'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%230f524ef70a)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23786a2dceed)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%20-0.00202662%20C%2028.250074%20-0.00202662%200.0009548%2028.247092%200.0009548%2063.095541%20C%200.0009548%2097.938745%2028.250074%20126.187864%2063.093277%20126.187864%20C%2097.941726%20126.187864%20126.185599%2097.938745%20126.185599%2063.095541%20C%20126.185599%2028.247092%2097.941726%20-0.00202662%2063.093277%20-0.00202662%20Z%20M%2063.093277%20-0.00202662%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.67729)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(36.937365,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%2031.140625%200%20L%2031.140625%20-12.625%20L%202.0625%20-12.625%20L%202.0625%20-22.546875%20L%2031.140625%20-59.78125%20L%2044.75%20-59.78125%20L%2044.75%20-24.609375%20L%2052.96875%20-24.609375%20L%2052.96875%20-12.625%20L%2044.75%20-12.625%20L%2044.75%200%20Z%20M%2016.828125%20-24.609375%20L%2031.140625%20-24.609375%20L%2031.140625%20-41.96875%20Z%20M%2016.828125%20-24.609375%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",jc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='0d82974cc8'%3e%3cpath%20d='M%2017.898438%2024.789062%20L%20111.859375%2024.789062%20L%20111.859375%20118.753906%20L%2017.898438%20118.753906%20Z%20M%2017.898438%2024.789062%20'/%3e%3c/clipPath%3e%3cclipPath%20id='37694f020a'%3e%3cpath%20d='M%2064.878906%2024.789062%20C%2038.933594%2024.789062%2017.898438%2045.824219%2017.898438%2071.769531%20C%2017.898438%2097.71875%2038.933594%20118.753906%2064.878906%20118.753906%20C%2090.828125%20118.753906%20111.859375%2097.71875%20111.859375%2071.769531%20C%20111.859375%2045.824219%2090.828125%2024.789062%2064.878906%2024.789062%20Z%20M%2064.878906%2024.789062%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='22003a5ccc'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%230d82974cc8)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%2337694f020a)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%20-0.000119013%20C%2028.250074%20-0.000119013%200.0009548%2028.249%200.0009548%2063.092203%20C%200.0009548%2097.940652%2028.250074%20126.189771%2063.093277%20126.189771%20C%2097.941726%20126.189771%20126.185599%2097.940652%20126.185599%2063.092203%20C%20126.185599%2028.249%2097.941726%20-0.000119013%2063.093277%20-0.000119013%20Z%20M%2063.093277%20-0.000119013%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.789151)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(37.55493,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%2026.390625%201.078125%20C%2021.203125%201.078125%2016.59375%20-0.0664062%2012.5625%20-2.359375%20C%208.539062%20-4.660156%205.578125%20-8.019531%203.671875%20-12.4375%20L%2015.484375%20-16.734375%20C%2016.316406%20-13.804688%2017.671875%20-11.789062%2019.546875%20-10.6875%20C%2021.429688%20-9.582031%2023.476562%20-9.03125%2025.6875%20-9.03125%20C%2028.84375%20-9.03125%2031.4375%20-9.957031%2033.46875%20-11.8125%20C%2035.5%20-13.664062%2036.515625%20-16.320312%2036.515625%20-19.78125%20C%2036.515625%20-23.476562%2035.453125%20-26.191406%2033.328125%20-27.921875%20C%2031.210938%20-29.648438%2028.753906%20-30.515625%2025.953125%20-30.515625%20C%2021.535156%20-30.515625%2018.253906%20-28.578125%2016.109375%20-24.703125%20L%204.03125%20-29.171875%20L%207.78125%20-59.78125%20L%2047.78125%20-59.78125%20L%2047.78125%20-48.671875%20L%2019.0625%20-48.671875%20L%2017.71875%20-37.5%20C%2019.09375%20-38.507812%2020.894531%20-39.28125%2023.125%20-39.8125%20C%2025.363281%20-40.351562%2027.53125%20-40.625%2029.625%20-40.625%20C%2033.195312%20-40.625%2036.578125%20-39.847656%2039.765625%20-38.296875%20C%2042.960938%20-36.742188%2045.5625%20-34.429688%2047.5625%20-31.359375%20C%2049.5625%20-28.285156%2050.5625%20-24.425781%2050.5625%20-19.78125%20C%2050.5625%20-15.238281%2049.441406%20-11.414062%2047.203125%20-8.3125%20C%2044.960938%20-5.21875%2042.007812%20-2.878906%2038.34375%20-1.296875%20C%2034.675781%200.285156%2030.691406%201.078125%2026.390625%201.078125%20Z%20M%2026.390625%201.078125%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",Zc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='2a134d5da5'%3e%3cpath%20d='M%2017.898438%2024.675781%20L%20111.859375%2024.675781%20L%20111.859375%20118.640625%20L%2017.898438%20118.640625%20Z%20M%2017.898438%2024.675781%20'/%3e%3c/clipPath%3e%3cclipPath%20id='1436cb12ac'%3e%3cpath%20d='M%2064.878906%2024.675781%20C%2038.933594%2024.675781%2017.898438%2045.710938%2017.898438%2071.660156%20C%2017.898438%2097.605469%2038.933594%20118.640625%2064.878906%20118.640625%20C%2090.828125%20118.640625%20111.859375%2097.605469%20111.859375%2071.660156%20C%20111.859375%2045.710938%2090.828125%2024.675781%2064.878906%2024.675781%20Z%20M%2064.878906%2024.675781%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='0d388df51e'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%232a134d5da5)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%231436cb12ac)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%20-0.00202662%20C%2028.250074%20-0.00202662%200.0009548%2028.247092%200.0009548%2063.095541%20C%200.0009548%2097.938745%2028.250074%20126.187864%2063.093277%20126.187864%20C%2097.941726%20126.187864%20126.185599%2097.938745%20126.185599%2063.095541%20C%20126.185599%2028.247092%2097.941726%20-0.00202662%2063.093277%20-0.00202662%20Z%20M%2063.093277%20-0.00202662%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.67729)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(36.669365,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%2028.71875%201.078125%20C%2023%201.078125%2018.363281%20-0.113281%2014.8125%20-2.5%20C%2011.257812%20-4.882812%208.660156%20-8.222656%207.015625%20-12.515625%20C%205.378906%20-16.816406%204.5625%20-21.769531%204.5625%20-27.375%20C%204.5625%20-31.675781%205.035156%20-35.820312%205.984375%20-39.8125%20C%206.941406%20-43.8125%208.453125%20-47.390625%2010.515625%20-50.546875%20C%2012.578125%20-53.710938%2015.242188%20-56.21875%2018.515625%20-58.0625%20C%2021.796875%20-59.914062%2025.765625%20-60.84375%2030.421875%20-60.84375%20C%2034.953125%20-60.84375%2038.738281%20-60.050781%2041.78125%20-58.46875%20C%2044.832031%20-56.894531%2047.128906%20-54.796875%2048.671875%20-52.171875%20L%2036.515625%20-47.78125%20C%2035.910156%20-48.800781%2034.984375%20-49.59375%2033.734375%20-50.15625%20C%2032.484375%20-50.71875%2031.082031%20-51%2029.53125%20-51%20C%2026.363281%20-51%2023.78125%20-49.789062%2021.78125%20-47.375%20C%2019.789062%20-44.96875%2018.796875%20-41.195312%2018.796875%20-36.0625%20C%2020.285156%20-37.4375%2022.054688%20-38.507812%2024.109375%20-39.28125%20C%2026.171875%20-40.0625%2028.664062%20-40.453125%2031.59375%20-40.453125%20C%2035.113281%20-40.453125%2038.40625%20-39.628906%2041.46875%20-37.984375%20C%2044.539062%20-36.347656%2047.015625%20-34.019531%2048.890625%20-31%20C%2050.773438%20-27.988281%2051.71875%20-24.425781%2051.71875%20-20.3125%20C%2051.71875%20-16.195312%2050.734375%20-12.523438%2048.765625%20-9.296875%20C%2046.796875%20-6.078125%2044.082031%20-3.539062%2040.625%20-1.6875%20C%2037.164062%200.15625%2033.195312%201.078125%2028.71875%201.078125%20Z%20M%2028.640625%20-9.03125%20C%2031.554688%20-9.03125%2033.847656%20-10%2035.515625%20-11.9375%20C%2037.191406%20-13.882812%2038.03125%20-16.4375%2038.03125%20-19.59375%20C%2038.03125%20-22.757812%2037.191406%20-25.328125%2035.515625%20-27.296875%20C%2033.847656%20-29.265625%2031.523438%20-30.25%2028.546875%20-30.25%20C%2025.679688%20-30.25%2023.367188%20-29.289062%2021.609375%20-27.375%20C%2019.847656%20-25.46875%2018.96875%20-22.90625%2018.96875%20-19.6875%20C%2018.96875%20-16.46875%2019.847656%20-13.882812%2021.609375%20-11.9375%20C%2023.367188%20-10%2025.710938%20-9.03125%2028.640625%20-9.03125%20Z%20M%2028.640625%20-9.03125%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",Kc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='d5d49c9923'%3e%3cpath%20d='M%2017.898438%2024.675781%20L%20111.859375%2024.675781%20L%20111.859375%20118.640625%20L%2017.898438%20118.640625%20Z%20M%2017.898438%2024.675781%20'/%3e%3c/clipPath%3e%3cclipPath%20id='0ef729529e'%3e%3cpath%20d='M%2064.878906%2024.675781%20C%2038.933594%2024.675781%2017.898438%2045.710938%2017.898438%2071.660156%20C%2017.898438%2097.605469%2038.933594%20118.640625%2064.878906%20118.640625%20C%2090.828125%20118.640625%20111.859375%2097.605469%20111.859375%2071.660156%20C%20111.859375%2045.710938%2090.828125%2024.675781%2064.878906%2024.675781%20Z%20M%2064.878906%2024.675781%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='926e811c6f'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23d5d49c9923)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%230ef729529e)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%20-0.00202662%20C%2028.250074%20-0.00202662%200.0009548%2028.247092%200.0009548%2063.095541%20C%200.0009548%2097.938745%2028.250074%20126.187864%2063.093277%20126.187864%20C%2097.941726%20126.187864%20126.185599%2097.938745%20126.185599%2063.095541%20C%20126.185599%2028.247092%2097.941726%20-0.00202662%2063.093277%20-0.00202662%20Z%20M%2063.093277%20-0.00202662%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.67729)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(40.642754,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%207.421875%200%20L%2031.671875%20-48.59375%20L%201.34375%20-48.59375%20L%201.34375%20-59.78125%20L%2046.078125%20-59.78125%20L%2046.078125%20-48.59375%20L%2023.09375%200%20Z%20M%207.421875%200%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",Jc="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAYAAADimHc4AAAAAXNSR0IArs4c6QAABFNJREFUeF7tnU1rFEEQhqvBrOQbveshCupiUG/iSfwNfgRP/h7Be0RBEG8q6EExAQ+5SMRLFBWPEjeiyWqCaxQSoaXdDNszzi61U907U8u7t52pqp59n+nu6o+ZNYu3flhS+rFkaab1icgo/QFEZACgXHgAUK7+qAEl6w8AACBQAJ2wQLwQrgAQQkVBDJc/H9puEBlGHmotz05wPUVcVWdBRJZWR2tFfndlfHQDsJbeTU9VRswiF6IewNvpKc0DYd1pKFlLAFCk3oXyAYBQShaMAwAFhQvlNgwAHt5JT0e7jDo7P513LE/DxK5XjH5j+eVkfY0l+jg+qbsTvvbkV0fvPAX9Y74azit7zj/GJSSI70bCp1tjutcD5p55AEI1DQOK4wCc3QKAAcn9fzEAUJr07YIBAADEChj0AWINRQEAQCSf3Fk9gNmWNx3NWBbY6zzCp65JCs5h4tmqBuAGYkvja2QUD8VUA3BD9ucTDcXyEwEAp8mIaAMAEcXlhAYAjkoRbQAgoric0ADAUSmijbm4sKV2e7qbDVoaW9edhp55sZABkHz1RzV5SzTt6bD2p9sSjH/r9FrmScrqVk62rM73xp8Z1r6siDexKLSZXX6sugZ83amHH9WKJO3PGQD60yu4NQAEl7S/gADQn17BrQEguKT9BQSA/vQKbq0ewMbOcWRBwW8LZkCXP5/b/VDBBy/4qzOqa4D7mRd2VyoIgHkHuSGs5oEYAPBBR7EEgCiy8oMCAF+rKJYAEEVWftChAHBq+ZE3G9otfeo1TdxNsFg+nWt0e0PP777RnQXdXZzzlOr2+ER2xxNnBjuWT/oaX43VdW9Lubd4haMmv10YpKW19HL8JAAMUvNUWQBQmvTtggEAAKQKGPQBUgll/gAg00/srR7AyugxVhZk/+0eql7CpxqAk/NwqyW+C8sMoB5AfWujTP3EZesHsLmhe0lScxbkmqA6AIhrYeEAAFBYujCOABBGx8JRhgLAg6eXU8mxy5fdtvP05vT0FHB2M3nnbOfdM9mcO4mbbGX3I+ZvTk/n7e2L7BxLLnqm1dTdCa/evlS90Qm3Tlii9emm7gc0vtzUDWDtYHPvAREutWrZGQAoFwgAlKs/AQAACBSwROgDBPqJXQFALKEsgCX6fGCTtR4gKyiet+o+wG3MGv19lMi9OCj1EtNezy+3B3T5zzhnX5zqDxF7vVQ1G9MHlleWN2DVnIY6AJM/T+geCQNAvOaFE1l9E4QawMEcyQZNUCRhuWEBgKtUJLvhADB/Ve90NFma2HZpaCTCAwhrvt2YVwyAaL9p6J6O3rx+Xy0A9+d4tZHXADCAmppbBACUpfxeuQAAAGIFDPoAsYaiAAAgkk/urB7AvpH3yILk90HBCNbS99qRnLn9bnPwfjnZNQR3zj+Wd03h/2hNdQ1wT0k2a/WC9KrhBgAlcwAAABAogCZIIF4IVwAIoaIgBgAIxAvhOgQA/gLvdplS6vruLgAAAABJRU5ErkJggg==",td="/music-learning-tools/assets/favicon-Bc4v39Jn.ico",ed="/music-learning-tools/assets/favicon-BsWgUeI5.svg",nd="/music-learning-tools/assets/atkinsonHyperlegibleNextBold-CRDaWt1k.otf",od="/music-learning-tools/assets/atkinsonHyperlegibleNextRegular-DOJsAlq1.otf",id="/music-learning-tools/assets/atkinsonHyperlegibleNextRegularItalic-DruWc0Qu.otf",sd="data:application/manifest+json;base64,ew0KICAibmFtZSI6ICJTdHVkZW50Tm90YXRpb24iLA0KICAic2hvcnRfbmFtZSI6ICJTTiIsDQogICJpY29ucyI6IFsNCiAgICB7DQogICAgICAic3JjIjogIi93ZWItYXBwLW1hbmlmZXN0LTE5MngxOTIucG5nIiwNCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwNCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIsDQogICAgICAicHVycG9zZSI6ICJtYXNrYWJsZSINCiAgICB9LA0KICAgIHsNCiAgICAgICJzcmMiOiAiL3dlYi1hcHAtbWFuaWZlc3QtNTEyeDUxMi5wbmciLA0KICAgICAgInNpemVzIjogIjUxMng1MTIiLA0KICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIiwNCiAgICAgICJwdXJwb3NlIjogIm1hc2thYmxlIg0KICAgIH0NCiAgXSwNCiAgInRoZW1lX2NvbG9yIjogIiNmZmZmZmYiLA0KICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmZmZmIiwNCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSINCn0=",ad="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAAAXNSR0IArs4c6QAACJhJREFUeF7tncFuG1UYRv9rO0ElaRFSt0gsCgKhNu0esUasQeQ9eAvEA4DoBsQKNmUBgWwRVSWKEEKCZUkXNICUJhAQajIedF1PNRnZjok6OmN8solke+Zen29OPju6vk7b7/9Rhj8IgSJSPP/nnRimHjK+g0YkBeAuAwXg2FcjKwCYgQKA8MdDKwCYgQKA8BWAh68AfAY2AJiBAoDwbQAevgLwGdgAYAYKAMK3AXj4CsBnYAOAGSgACN8G4OErAJ+BDQBmoAAgfBuAh68AfAY2AJiBAoDwbQAevgLwGdgAYAZF9OLS4Z0oXA6NpaAAGPqIflnGT+vnYjCeQ/5gRoqI6ne+uX5bfar1x1Uf6Gge23xqnv8k28xHAWABvnvqQvTBOSz70AoAXgG5ARQADMAGYOErAMvfl0AwfwWAA7AB2AAUgOVvA8D8FQAOwAZgA1AAlr8NAPNXADgAG4ANQAFY/jYAzF8B4ABsADYABWD52wAwfwWAA7AB2AAUgOVvA8D8FQAOIDfA59fdHp2KIQvwwwVXg1L8Rw3w1o2//H4AKIFhDOPZf9ZjmBfy+4MQSJtf/K0ACPqI4yjjlf0no1AAKIEIBcDQKwCI/tHQCgCmYAOA8MdDKwCYgQKA8BWAh68AfAY2AJiBAoDwbQAevgLwGdgAYAYKAMK3AXj4CsBnYAOAGSgACN8G4OErAJ+BDQBmoAAgfBuAh68AfAY2AJiBAoDwbQAefhbg5f1zrgYFo7ABQPiDMsXW+k6sRO/hNwPUvxigPq/mgvV5lk+3dcy0Oeb5LuD8FQAVoBefrf88FgCcyBIPrQBg+INSAUD8o6EVAExAAUD4vgnm4SsAn4ENAGagACB8G4CHrwB8BjYAmIECgPBtAB6+AvAZ2ABgBgoAwrcBePgKwGdgA4AZKAAI3wbg4SsAn4ENAGagACB8G4CHrwB8Bun17fvuDg3lMBj24su1e64GhfjnYdO1m1sKAAWQooi7xy9GLxXQDBw2Xb71qQJA10EW4JcHGwoA8R81gAJw9BWAY1+NrABgBgoAwq/+C2QDcCEoAMfeBuDZhwLwIfgSCMxAAUD4vgTqAHz/C4SHYAOAEdgAIHwboAPwbQA8BBsAjMAGAOHbAB2AbwPgIdgAYAQ2AAjfBugAfBsAD8EGACOwAUD4NkAH4EcR9x5ccTUoGIUNAMLPnwJ47ugghqm+4f+kTfZnbcpffwLV42ad47+ea9L5Z0FbrPkrACjAUfTjtaNv4jj1wVks99AKAOavACB83wPw8BWAz8AGADNQABC+DcDDVwA+AxsAzEABQPg2AA9fAfgMbAAwAwUA4dsAPHwF4DOwAcAMFACEbwPw8BWAz8AGADNQABC+DcDDVwA+AxsAzEABQPhVA2zculHbHXraUtnmBtL15bvTnkRbx8xazrtY8z+KXrx69K2rQUEP0ofbm7UrNV/Yk3ZLb17w8+yo3tYx0+aYKS7W/PtlEV+vXY1B+P0AlAPpo+0357maqfn9r8fNAny1dk0BwJQVAISvACD86j2ADcCFoAAc+2pkGwDMQAFA+DYAD18B+AxsADADBQDh2wA8fAXgM7ABwAwUAIRvA/DwFYDPwAYAM1AAEL4NwMNXAD4DGwDMQAFA+DYAD18B+AxsADADBQDh2wA8/H55HDfzcujS5dBUGjYART4iipTi0sH+6Hf+mfVJh/o0q8fVf+f7698OMOlpNY+rj1kf+yyfuFjU+SsAKMBxSnF1bzeK1ANnsdxDKwCYvwKA8H0PwMNXAD4DGwDMQAFA+DYAD18B+AxsADADBQDh2wA8fAXgM7ABwAwUAIRvA/DwFYDPwAYAM1AAEL4NwMNXAD4DGwDMQAFA+DYAD18B+AxsADADBQDhVw3w8Za7Q1Mx5GXQLxzsxtDVoFQEkXauv3Fie/RqV//6jdN2+q8/9rRvA5h0f3OsWeeYNK9J1BZp/r1hit2nf4te6XJoyoC0+95JAaiJLOO4WYCdiwpAZq8AIH0FAOFX7wFsAC4EBeDYVyPbAGAGCgDCtwF4+ArAZ2ADgBkoAAjfBuDhKwCfgQ0AZqAAIHwbgIevAHwGNgCYgQKA8G0AHr4C8BnYAGAGCgDCtwF4+ArAZ2ADgBkoAAjfBugA/GGKuxd/j361HLra37w5tRML1sf7qJ82/baOmTbHPJ8FnL8NcNqF1OL9ZRRx/vBylGn8BRnTNuY/7cMWk+bY1jFn+fKAtubSfN7zjNOYvwK0eIGfduqHAlyJqAQ47QDvf+wEFOCxI53/hAowP6u2HqkAbZGd47wKMAeklh+iAC0DnnV6BQDh+18gHr4C8BnYAGAGCgDCtwF4+ArAZ2ADgBkoAAjfBuDhKwCfgQ0AZqAAIHwbgIevAHwGNgCYgQKA8G0AHr4C8BnYAGAGCgDCf9QA7242V47zs1qSGeRl0OcPX3I1KJh32nvng5oAsxZ712dZPa7+O99ffSJimlPN4/Ixs26bROYsC9Kb5+nG/MuyH0/0f4yIPngJLPfQ6f7bn9gA0DWQBVhdua0AEP/Rn18F4OgrAMe+GlkBwAwUAIRfvQm2AbgQFIBjbwPw7EMB+BB8CQRmoAAgfF8C8fAVgM/ABgAzUAAQvg3Aw1cAPgMbAMxAAUD4NgAPXwH4DGwAMAMFAOHbADx8BeAzsAHADBQAhG8D8PCzAIOV7yNiMJ7MvJvv15edV3uCT7qt+Ryby9WnLQufxWbeOU4bO9/enfnbAKAHqSxib/WZSKMLwh+CgAIQ1Kv6LYv4dXUjejH+ggxwLss6tAKAyecGUAAwAD8QA8NXADYABWD52wAs/zy6L4HADBQAhO+/QTsA35dAeAg2ABiBDQDCtwE6AN8GwEOwAcAIbAAQvg3QAfg2AB6CDQBGYAOA8G2ADsC3AfAQbAAwAhsAhG8DdAC+DYCHYAOAEdgAIPzx0P8CpKm0wymYN9kAAAAASUVORK5CYII=",rd="/music-learning-tools/assets/web-app-manifest-512x512-Dz8l3SBy.png",bi=`<div id="app-loading-screen">\r
  <div class="loading-container">\r
    <div class="loading-logo">\r
      <svg viewBox="0 0 100 100" class="logo-svg">\r
        <circle cx="50" cy="50" r="45" class="logo-circle" />\r
        <path d="M 30 50 Q 50 30, 70 50 T 70 70" class="logo-path" />\r
      </svg>\r
    </div>\r
    <h1 class="loading-title">Student Notation</h1>\r
    <div class="loading-progress-container">\r
      <div class="loading-progress-bar">\r
        <div class="loading-progress-fill" id="loading-progress-fill"></div>\r
      </div>\r
      <div class="loading-progress-text" id="loading-progress-text">0%</div>\r
    </div>\r
    <div class="loading-status" id="loading-status">Initializing...</div>\r
  </div>\r
</div>\r
<!-- Sidebar for File/App Actions -->\r
<div id="sidebar-overlay"></div>\r
<aside id="sidebar" role="complementary" aria-label="Application settings and controls">\r
<div class="sidebar-container">\r
<div class="app-title">Student Notation</div>\r
</div>\r
<div class="sidebar-container">\r
<button class="sidebar-button" id="save-as-button" title="Save As"><img src="assets/sidebar/saveAs.svg" alt="Save As"><span class="sidebar-button-text">Save As</span></button>\r
<button class="sidebar-button" id="import-button" title="Open"><img src="assets/sidebar/open.svg" alt="Open"><span class="sidebar-button-text">Open</span></button>\r
<button class="sidebar-button" id="print-button" title="Print"><img src="assets/sidebar/print.svg" alt="Print"><span class="sidebar-button-text">Print</span></button>\r
<button class="sidebar-button" id="reset-canvas-button" title="New File"><img src="assets/sidebar/newPage.svg" alt="New Page"><span class="sidebar-button-text">New Page</span></button>\r
</div>\r
<div class="sidebar-container">\r
<h4 class="sidebar-section-header">Handoff</h4>\r
<button class="sidebar-button" id="take-to-singing-trainer-button" title="Take to Singing Trainer">\r
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\r
<path d="M7 17L17 7"/><path d="M7 7h10v10"/>\r
</svg>\r
<span class="sidebar-button-text">Take to Singing Trainer</span></button>\r
</div>\r
<div class="sidebar-container">\r
<button class="sidebar-button" id="hide-drumgrid-toggle" title="Toggle Drum Grid"><img src="assets/sidebar/hideDrums.svg" alt="Toggle Drum Grid"><span class="sidebar-button-text">Hide Drum Grid</span></button>\r
<button class="sidebar-button" id="hide-buttongrid-toggle" title="Toggle Button Grid"><img src="assets/sidebar/hideAnalysis.svg" alt="Toggle Button Grid"><span class="sidebar-button-text">Hide Button Grid</span></button>\r
<div class="sidebar-legend-toggle-row" role="group" aria-label="Legend visibility">\r
  <button class="sidebar-toggle-button" id="hide-leftlegend-toggle" type="button">Hide Left Legend</button>\r
  <button class="sidebar-toggle-button" id="hide-rightlegend-toggle" type="button">Hide Right Legend</button>\r
</div>\r
</div>\r
<div class="sidebar-container">\r
<h4 class="sidebar-section-header">Long Notes Style</h4>\r
<div class="toggle-button-group"><button class="sidebar-toggle-button active" id="long-note-style1-btn">Circle & Tails</button><button class="sidebar-toggle-button" id="long-note-style2-btn">Stadium</button></div>\r
</div>\r
<div class="sidebar-container">\r
<h4 class="sidebar-section-header">Playhead</h4>\r
<div class="toggle-button-group"><button class="sidebar-toggle-button active" id="playhead-mode-cursor-btn">Cursor Playhead</button><button class="sidebar-toggle-button" id="playhead-mode-microbeat-btn">Pulsing Microbeat</button><button class="sidebar-toggle-button" id="playhead-mode-macrobeat-btn">Pulsing Macrobeat</button></div>\r
</div>\r
</aside>\r
<main id="app-container" role="main">\r
  <!-- Toolbar Container -->\r
  <nav id="toolbar" role="navigation" aria-label="Music notation tools">\r
    <!-- Primary Toolbar -->\r
    <div id="toolbar-primary" class="toolbar-primary">\r
        <div class="primary-toolbar-grid-5x5">\r
            <!-- Row 1: settings, volume, blue notes -->\r
            <button class="toolkit-icon-button" id="settings-button" title="Settings"><img src="assets/icons/settings.svg" alt="Settings"></button>\r
            <div id="volume-control-wrapper">\r
                <button class="toolkit-icon-button" id="volume-icon-button" aria-label="Volume" title="Volume"><img src="assets/icons/volume.svg" alt="Volume"></button>\r
                <div id="volume-popup">\r
                    <input type="range" id="vertical-volume-slider" orient="vertical" min="0" max="100" value="70" step="1" />\r
                </div>\r
            </div>\r
            <div class="note circle-note" data-type="circle" data-color="#4a90e2"></div>\r
            <div class="note oval-note" data-type="oval" data-color="#4a90e2"></div>\r
            <div class="note diamond-note" data-type="diamond" data-color="#4a90e2" aria-label="Sixteenth note jewel">\r
                <svg class="diamond-icon" viewBox="0 0 120 120" aria-hidden="true" focusable="false">\r
                    <path d="M60 5 L35 48.3 L35 71.7 L60 115 L85 71.7 L85 48.3 Z" />\r
                </svg>\r
            </div>\r
            <!-- Row 2: zoom in/out, black notes -->\r
            <button class="toolkit-icon-button" id="grid-zoom-in" title="Zoom In"><img src="assets/icons/zoomIn.svg" alt="Zoom In"></button>\r
            <button class="toolkit-icon-button" id="grid-zoom-out" title="Zoom Out"><img src="assets/icons/zoomOut.svg" alt="Zoom Out"></button>\r
            <div class="note circle-note" data-type="circle" data-color="#2d2d2d"></div>\r
            <div class="note oval-note" data-type="oval" data-color="#2d2d2d"></div>\r
            <div class="note diamond-note" data-type="diamond" data-color="#2d2d2d" aria-label="Sixteenth note jewel">\r
                <svg class="diamond-icon" viewBox="0 0 120 120" aria-hidden="true" focusable="false">\r
                    <path d="M60 5 L35 48.3 L35 71.7 L60 115 L85 71.7 L85 48.3 Z" />\r
                </svg>\r
            </div>\r
            <!-- Row 3: redo/undo, red notes -->\r
            <button class="toolkit-icon-button" id="redo-button" title="Redo"><img src="assets/icons/redo.svg" alt="Redo"></button>\r
            <button class="toolkit-icon-button" id="undo-button" title="Undo"><img src="assets/icons/undo.svg" alt="Undo"></button>\r
            <div class="note circle-note" data-type="circle" data-color="#d66573"></div>\r
            <div class="note oval-note" data-type="oval" data-color="#d66573"></div>\r
            <div class="note diamond-note" data-type="diamond" data-color="#d66573" aria-label="Sixteenth note jewel">\r
                <svg class="diamond-icon" viewBox="0 0 120 120" aria-hidden="true" focusable="false">\r
                    <path d="M60 5 L35 48.3 L35 71.7 L60 115 L85 71.7 L85 48.3 Z" />\r
                </svg>\r
            </div>\r
            <!-- Row 4: clear/eraser, green notes -->\r
            <button class="toolkit-icon-button" id="clear-button" title="Clear"><img src="assets/icons/clear.svg" alt="Clear"></button>\r
            <button class="toolkit-icon-button eraser-button" id="eraser-tool-button" title="Eraser">\r
                <img src="assets/icons/eraser.svg" alt="Eraser" class="eraser-icon">\r
            </button>\r
            <div class="note circle-note" data-type="circle" data-color="#68a03f"></div>\r
            <div class="note oval-note" data-type="oval" data-color="#68a03f"></div>\r
            <div class="note diamond-note" data-type="diamond" data-color="#68a03f" aria-label="Sixteenth note jewel">\r
                <svg class="diamond-icon" viewBox="0 0 120 120" aria-hidden="true" focusable="false">\r
                    <path d="M60 5 L35 48.3 L35 71.7 L60 115 L85 71.7 L85 48.3 Z" />\r
                </svg>\r
            </div>\r
            <!-- Row 5: lasso/marker shortcuts, playback controls -->\r
            <button class="toolkit-icon-button" id="lasso-shortcut-button" title="Lasso Tool">\r
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="3 2">\r
                    <ellipse cx="12" cy="12" rx="8" ry="6" transform="rotate(-15 12 12)"/>\r
                </svg>\r
            </button>\r
            <button class="toolkit-icon-button" id="marker-shortcut-button" title="Marker Tool">\r
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                    <path d="M18 2L6 14l-2 6 6-2L22 6l-4-4z"/>\r
                    <line x1="14" y1="6" x2="18" y2="10"/>\r
                </svg>\r
            </button>\r
            <button class="toolkit-icon-button" id="play-button" title="Play"><img src="assets/icons/play.svg" alt="Play"></button>\r
            <button class="toolkit-icon-button" id="stop-button" title="Stop"><img src="assets/icons/stop.svg" alt="Stop"></button>\r
            <button class="toolkit-icon-button" id="loop-button" title="Loop"><img src="assets/icons/loop.svg" alt="Loop"></button>\r
        </div>\r
    </div>\r
    <!-- Secondary Toolbar -->\r
    <div id="toolbar-secondary" class="toolbar-secondary">\r
        <div class="tab-sidebar">\r
            <button class="tab-button" data-tab="timbre">Timbre</button>\r
            <button class="tab-button" data-tab="pitch">Pitch</button>\r
            <button class="tab-button" data-tab="rhythm">Rhythm</button>\r
        </div>\r
        <div class="tab-content">\r
            <!-- Timbre Tab -->\r
            <div class="tab-panel" id="timbre-panel">\r
                <!-- Presets/Effects Section (Separate) -->\r
                <div class="control-section preset-effects-container">\r
                    <div class="preset-effects-controls">\r
                            <div class="preset-effects-tabs">\r
                                <button class="preset-tab-button active" data-preset-tab="presets">Presets</button>\r
                                <button class="preset-tab-button" data-preset-tab="effects">Effects</button>\r
                            </div>\r
                            <div class="preset-effects-content">\r
                                <!-- Presets Tab -->\r
                                <div class="preset-tab-panel active" id="presets-panel">\r
                            <div class="preset-content-box">\r
                                <div class="preset-grid" id="preset-buttons">\r
                                    <div class="preset-column">\r
                                        <button class="preset-button" id="preset-sine">Sine</button>\r
                                        <button class="preset-button" id="preset-triangle">Triangle</button>\r
                                        <button class="preset-button" id="preset-square">Square</button>\r
                                        <button class="preset-button" id="preset-sawtooth">Sawtooth</button>\r
                                    </div>\r
                                    <div class="preset-column">\r
                                        <button class="preset-button" id="preset-piano">Piano</button>\r
                                        <button class="preset-button" id="preset-marimba">Marimba</button>\r
                                        <button class="preset-button" id="preset-woodwind">Woodwind</button>\r
                                        <button class="preset-button" id="preset-strings">Strings</button>\r
                                    </div>\r
                                </div>\r
                            </div>\r
                        </div>\r
                        <!-- Effects Tab -->\r
                        <div class="preset-tab-panel" id="effects-panel">\r
                            <div class="effects-content-box">\r
                                <div class="position-controls-container">\r
                                    <div class="position-control-group">\r
                                        <h5 class="position-label">Delay</h5>\r
                                        <div class="position-component-wrapper">
                                            <div class="position-component" id="delay-position" data-svelte-component="effects-cartesian-slider" data-effect="delay"></div>
                                            <div id="delay-mix-wrapper"></div>
                                        </div>
                                        <div class="position-axis-labels" data-axis-x="Time" data-axis-y="Echoes"></div>\r
                                    </div>\r
                                    <div class="position-control-group">\r
                                        <h5 class="position-label">Vibrato</h5>\r
                                        <div class="position-component-wrapper">
                                            <div class="position-component" id="vibrato-position" data-svelte-component="effects-cartesian-slider" data-effect="vibrato"></div>
                                            <div id="vibrato-mix-wrapper"></div>
                                        </div>
                                        <div class="position-axis-labels" data-axis-x="Speed" data-axis-y="Span"></div>\r
                                    </div>\r
                                    <div class="position-control-group">\r
                                        <h5 class="position-label">Tremolo</h5>\r
                                        <div class="position-component-wrapper">
                                            <div class="position-component" id="tremolo-position" data-svelte-component="effects-cartesian-slider" data-effect="tremolo"></div>
                                            <div id="tremolo-mix-wrapper"></div>
                                        </div>
                                        <div class="position-axis-labels" data-axis-x="Speed" data-axis-y="Span"></div>\r
                                    </div>\r
                                </div>\r
                            </div>\r
                        </div>                        \r
                        <div class="effect-controls-container" id="effect-controls" style="display: none;">\r
                            <!-- Effect controls will be dynamically inserted here for data synchronization -->\r
                        </div>\r
                            </div>\r
                    </div>\r
                </div>\r
                <div class="control-section filter-container">\r
                    <!-- Row 1, Col 1: Blend slider -->\r
                    <div class="blend-slider-container"><div id="blend-slider-container"><div class="filter-blend-thumb" id="thumb-b" tabindex="0">B</div></div></div>\r
                    <!-- Row 2, Col 1: Bins grid (appended via JS) -->\r
                    <div class="filter-bins-wrapper"></div>\r
                    <!-- Row 3, Col 1: Cutoff slider -->\r
                    <div id="cutoff-slider-container"><div class="filter-cutoff-thumb" id="thumb-c" tabindex="0">C</div></div>\r
                    <!-- Row 2, Col 2: Vertical M slider (appended via JS) -->\r
                    <div class="filter-vertical-blend-wrapper"></div>\r
                </div>\r
                <div class="control-section adsr-container">\r
                    <!-- Row 1, Col 1: ADSR graph -->\r
                    <div class="adsr-graph-wrapper"><div id="adsr-envelope"></div></div>\r
                    <!-- Row 1, Col 2: Sustain slider -->\r
                    <div class="sustain-slider-wrapper"><div id="sustain-slider-track"><div id="sustain-slider-thumb" tabindex="0">S</div></div></div>\r
                    <!-- Row 2, Col 1: ADR slider -->\r
                    <div id="multi-thumb-slider-container"><div class="time-slider-thumb" id="thumb-a" tabindex="0">A</div><div class="time-slider-thumb" id="thumb-d" tabindex="0">D</div><div class="time-slider-thumb" id="thumb-r" tabindex="0">R</div></div>\r
                </div>\r
                  <!-- Waveform Section (Separate) -->\r
                  <div class="control-section">\r
                      <div class="waveform-section">\r
                          <div class="waveform-content-box">\r
                              <div class="waveform-display-wrapper">\r
                                  <canvas id="static-waveform-canvas"></canvas>\r
                                  <div class="waveform-speed-controls">\r
                                      <button class="waveform-speed-btn" data-speed="50">50%</button>\r
                                      <button class="waveform-speed-btn" data-speed="10">10%</button>\r
                                  </div>\r
                              </div>\r
                          </div>\r
                      </div>\r
                  </div>\r
              </div>\r
              <!-- Pitch Tab -->\r
            <div class="tab-panel" id="pitch-panel">\r
                <div class="control-section pitch-tabs-container">\r
                    <div class="pitch-tabs">\r
                        <button class="pitch-tab-button active" data-pitch-tab="range">Range</button>\r
                        <button class="pitch-tab-button" data-pitch-tab="chords">Chords</button>\r
                        <button class="pitch-tab-button" data-pitch-tab="draw">Draw</button>\r
                    </div>\r
                    <div class="pitch-tab-content">\r
                        <div class="pitch-tab-panel active" id="range-panel">\r
                            <div class="range-content-box">\r
                                <div class="range-layout">\r
                                   <div class="range-panel-section modes-section">\r
                                       <!-- <h4 class="panel-section-title">Modes</h4> -->\r
                                       <div class="tonic-modes-container">\r
                                           <div class="tonic-modes-grid">\r
                                               <button class="tonic-mode-button" data-tonic="1">\r
                                                   <img src="assets/tabicons/tonicShape_1.svg" alt="Major" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Major</span>\r
                                               </button>\r
                                               <button class="tonic-mode-button" data-tonic="2">\r
                                                   <img src="assets/tabicons/tonicShape_2.svg" alt="Dorian" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Dorian</span>\r
                                               </button>\r
                                               <button class="tonic-mode-button" data-tonic="3">\r
                                                   <img src="assets/tabicons/tonicShape_3.svg" alt="Phrygian" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Phrygian</span>\r
                                               </button>\r
                                               <button class="tonic-mode-button" data-tonic="4">\r
                                                   <img src="assets/tabicons/tonicShape_4.svg" alt="Lydian" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Lydian</span>\r
                                               </button>\r
                                               <button class="tonic-mode-button" data-tonic="5">\r
                                                   <img src="assets/tabicons/tonicShape_5.svg" alt="Mixolydian" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Mixolydian</span>\r
                                               </button>\r
                                               <button class="tonic-mode-button" data-tonic="6">\r
                                                   <img src="assets/tabicons/tonicShape_6.svg" alt="Minor" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Minor</span>\r
                                               </button>\r
                                               <button class="tonic-mode-button" data-tonic="7">\r
                                                   <img src="assets/tabicons/tonicShape_7.svg" alt="Locrian" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Locrian</span>\r
                                               </button>\r
                                           </div>\r
                                       </div>\r
                                   </div>\r
                                   <div class="range-panel-section degrees-section">\r
                                       <!-- <h4 class="panel-section-title">Degrees</h4> -->\r
                                       <div class="degree-visibility-toggle-container">\r
                                           <button class="degree-visibility-button" id="degree-visibility-toggle" type="button">\r
                                               Show Degrees\r
                                           </button>\r
                                       </div>\r
                                       <div class="degree-mode-toggle-container" id="degree-mode-toggle">\r
                                           <button class="degree-mode-button" data-mode="diatonic" type="button">Scale</button>\r
                                           <button class="degree-mode-button" data-mode="modal" type="button">Mode</button>\r
                                       </div>\r
                                       <label class="checkbox-label">\r
                                            <input type="checkbox" id="focus-colours-toggle">\r
                                            <span class="checkbox-text">Focus Colours</span>\r
                                        </label>\r
                                   </div>\r
                                   <div class="range-panel-section wheels-section">\r
                                       <!-- <h4 class="panel-section-title">Select Range</h4> -->\r
                                       <div class="clef-wheels-wrapper">\r
                                           <div class="clef-picker-column">\r
                                               <div class="clef-wheel" id="clef-top-wheel" tabindex="0" aria-label="Select top note">\r
                                                   <div class="clef-wheel-viewport">\r
                                                       <div class="clef-wheel-options"></div>\r
                                                   </div>\r
                                                   <div class="clef-wheel-overlay"></div>\r
                                               </div>\r
                                           </div>\r
                                           <div class="clef-picker-column">\r
                                               <div class="clef-wheel" id="clef-bottom-wheel" tabindex="0" aria-label="Select bottom note">\r
                                                   <div class="clef-wheel-viewport">\r
                                                       <div class="clef-wheel-options"></div>\r
                                                   </div>\r
                                                   <div class="clef-wheel-overlay"></div>\r
                                               </div>\r
                                           </div>\r
                                       </div>\r
                                   </div>\r
                                   <div class="range-panel-section presets-section">\r
                                       <!-- <h4 class="panel-section-title">Presets</h4> -->\r
                                       <div class="clef-presets-column">\r
                                           <div class="clef-preset-buttons">\r
                                               <button class="toolkit-button clef-preset-button" id="clef-full-range-button" type="button">\r
                                                   Full Range\r
                                               </button>\r
                                               <button class="toolkit-button clef-preset-button" id="clef-treble-button" type="button">\r
                                                   Treble\r
                                               </button>\r
                                               <button class="toolkit-button clef-preset-button" id="clef-alto-button" type="button">\r
                                                   Alto\r
                                               </button>\r
                                               <button class="toolkit-button clef-preset-button" id="clef-bass-button" type="button">\r
                                                   Bass\r
                                               </button>\r
                                               <button class="toolkit-button clef-preset-button" id="clef-voice1-button" type="button">\r
                                                   Voice I\r
                                               </button>\r
                                               <button class="toolkit-button clef-preset-button" id="clef-voice2-button" type="button">\r
                                                   Voice II\r
                                               </button>\r
                                               <button class="toolkit-button clef-preset-button" id="clef-voice3-button" type="button">\r
                                                   Voice III\r
                                               </button>\r
                                           </div>\r
                                       </div>\r
                                   </div>\r
                                </div>\r
                        </div>\r
                    </div>\r
                        <div class="pitch-tab-panel" id="chords-panel">\r
            <div class="chords-content-box">\r
                <div class="chords-layout">\r
                    <div class="chords-panel-section intervals-grid-section">\r
                        <h4 class="panel-section-title">Intervals</h4>\r
                        <div class="intervals-grid-column">\r
                            <div class="harmony-preset-grid intervals-4x4-grid">\r
                                <button class="harmony-preset-button">M6</button>\r
                                <button class="harmony-preset-button">A6</button>\r
                                <button class="harmony-preset-button">m7</button>\r
                                <button class="harmony-preset-button">M7</button>\r
                                <button class="harmony-preset-button">d5</button>\r
                                <button class="harmony-preset-button">P5</button>\r
                                <button class="harmony-preset-button">A5</button>\r
                                <button class="harmony-preset-button">m6</button>\r
                                <button class="harmony-preset-button">m3</button>\r
                                <button class="harmony-preset-button">M3</button>\r
                                <button class="harmony-preset-button">P4</button>\r
                                <button class="harmony-preset-button">A4</button>\r
                                <button class="harmony-preset-button">U</button>\r
                                <button class="harmony-preset-button">m2</button>\r
                                <button class="harmony-preset-button">M2</button>\r
                                <button class="harmony-preset-button">A2</button>\r
                            </div>\r
                        </div>\r
                    </div>\r
                    <div class="chords-panel-section unified-position-section">\r
                        <h4 class="panel-section-title">Position</h4>\r
                        <div class="unified-position-column">\r
                            <div class="unified-position-toggle" id="unified-position-toggle">\r
                                <div class="left-labels">\r
                                    <span class="state-label" data-step="0">Asc.</span>\r
                                    <span class="state-label" data-step="1">Desc.</span>\r
                                </div>\r
                                <div class="toggle-track">\r
                                    <div class="unified-slider"></div>\r
                                </div>\r
                                <div class="right-labels">\r
                                    <span class="state-label" data-step="0">Root</span>\r
                                    <span class="state-label" data-step="1">1st</span>\r
                                    <span class="state-label" data-step="2">2nd</span>\r
                                    <span class="state-label" data-step="3">3rd</span>\r
                                    <span class="state-label" data-step="4">4th</span>\r
                                    <span class="state-label" data-step="5">5th</span>\r
                                </div>\r
                            </div>\r
                        </div>\r
                    </div>\r
                    <div class="chords-panel-section chords-grid-section">\r
                        <h4 class="panel-section-title">Chords</h4>\r
                        <div class="chords-grid-column">\r
                            <div class="harmony-preset-grid chords-grid chords-grid-6col" id="chords-preset-grid">\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;]" title="Major triad">X</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;]" title="Minor triad">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5d&quot;]" title="Diminished triad">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;6m&quot;]" title="Augmented triad">X+</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7m&quot;]" title="Dominant 7">X</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;7m&quot;]" title="Minor 7">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7M&quot;]" title="Major 7">Xmaj</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5d&quot;, &quot;7m&quot;]" title="Half-diminished 7"></button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5d&quot;, &quot;6M&quot;]" title="Fully diminished 7">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;6M&quot;]" title="Major 6">X</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;2M&quot;, &quot;5P&quot;]" title="Suspended 2">Xsus2</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;4P&quot;, &quot;5P&quot;]" title="Suspended 4">Xsus4</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;7M&quot;]" title="Minor-major 7">xmaj</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;9M&quot;]" title="Major add 9">Xadd9</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;9M&quot;]" title="Minor add 9">xadd9</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;6M&quot;, &quot;9M&quot;]" title="Major 6/9">X6/9</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7m&quot;, &quot;9M&quot;]" title="Dominant 9">X9</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7m&quot;, &quot;9M&quot;, &quot;11P&quot;]" title="Dominant 11">X11</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7m&quot;, &quot;9M&quot;, &quot;13M&quot;]" title="Dominant 13">X13</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7M&quot;, &quot;9M&quot;]" title="Major 9">Xmaj9</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;7m&quot;, &quot;9M&quot;]" title="Minor 9">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;6M&quot;]" title="Minor 6">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;7m&quot;, &quot;9M&quot;, &quot;11P&quot;]" title="Minor 11">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7M&quot;, &quot;11A&quot;]" title="Major 7 sharp 11 (Lydian)">Xmaj711</button>\r
                            </div>\r
                        </div>\r
                    </div>\r
                </div>\r
            </div>\r
        </div>\r
                        <div class="pitch-tab-panel" id="draw-panel">\r
                            <div class="draw-content-box">\r
                                <div class="draw-layout-grid">\r
                                    <!-- Arrow Tool Panel -->\r
                                    <div class="draw-tool-panel" id="draw-arrow-controls" data-draw-tool="arrow">\r
                                        <div class="draw-tool-header">\r
                                            <button class="draw-tool-button" data-draw-tool="arrow" title="Arrow Tool">\r
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                    <line x1="4" y1="20" x2="20" y2="4"/>\r
                                                    <polyline points="14,4 20,4 20,10"/>\r
                                                </svg>\r
                                            </button>\r
                                        </div>\r
                                        <div class="draw-tool-options" id="arrow-tool-options">\r
                                            <div class="draw-option-group">\r
                                                <div class="draw-toolbar-row">\r
                                                    <!-- Stroke weight popup -->\r
                                                    <div class="draw-popup-trigger">\r
                                                        <button class="draw-toolbar-button" title="Stroke width">\r
                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                                <line x1="4" y1="12" x2="20" y2="12"/>\r
                                                            </svg>\r
                                                        </button>\r
                                                        <div class="draw-popup-menu">\r
                                                            <div class="draw-option-label">Stroke</div>\r
                                                            <input type="range" id="arrow-stroke-weight" min="1" max="20" value="4" aria-label="Arrow stroke weight">\r
                                                        </div>\r
                                                    </div>\r
\r
                                                    <!-- Line style popup -->\r
                                                    <div class="draw-popup-trigger">\r
                                                        <button class="draw-toolbar-button" title="Line style">\r
                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                                <line x1="4" y1="8" x2="20" y2="8" stroke-dasharray="4 3"/>\r
                                                                <line x1="4" y1="16" x2="20" y2="16"/>\r
                                                            </svg>\r
                                                        </button>\r
                                                        <div class="draw-popup-menu">\r
                                                            <div class="draw-option-label">Line Style</div>\r
                                                            <div class="draw-button-group">\r
                                                                <button class="draw-option-button active" data-line-style="solid">Solid</button>\r
                                                                <button class="draw-option-button" data-line-style="dashed">Dashed</button>\r
                                                            </div>\r
                                                        </div>\r
                                                    </div>\r
                                                </div>\r
                                                <div class="draw-toolbar-row">\r
                                                    <!-- Left arrowhead popup -->\r
                                                    <div class="draw-popup-trigger">\r
                                                        <button class="draw-toolbar-button" id="arrow-start-head-trigger" title="Start head">\r
                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                                <polyline points="9,5 3,12 9,19"/>\r
                                                                <line x1="3" y1="12" x2="21" y2="12"/>\r
                                                            </svg>\r
                                                        </button>\r
                                                                <div class="draw-popup-menu">\r
                                                                    <div class="draw-option-label">Start</div>\r
                                                                    <div class="draw-button-group">\r
                                                                    <button class="draw-option-button active" data-arrow-start="none">No head</button>\r
                                                                    <button class="draw-option-button" data-arrow-start="filled-arrow">Arrow</button>\r
                                                                    </div>\r
                                                                </div>\r
                                                            </div>\r
                                                    <!-- Swap heads -->\r
                                                    <button class="draw-toolbar-button" id="arrow-swap-heads" title="Swap heads">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <polyline points="9 5 15 5 15 11"/>\r
                                                            <polyline points="15 19 9 19 9 13"/>\r
                                                            <line x1="9" y1="5" x2="5" y2="9"/>\r
                                                            <line x1="15" y1="19" x2="19" y2="15"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <!-- Right arrowhead popup -->\r
                                                    <div class="draw-popup-trigger">\r
                                                        <button class="draw-toolbar-button" id="arrow-end-head-trigger" title="End head">\r
                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                                <polyline points="15,5 21,12 15,19"/>\r
                                                                <line x1="3" y1="12" x2="21" y2="12"/>\r
                                                            </svg>\r
                                                        </button>\r
                                                                <div class="draw-popup-menu">\r
                                                                    <div class="draw-option-label">End</div>\r
                                                                    <div class="draw-button-group">\r
                                                                    <button class="draw-option-button active" data-arrow-end="filled-arrow">Arrow</button>\r
                                                                    <button class="draw-option-button" data-arrow-end="none">No head</button>\r
                                                                    </div>\r
                                                                    <div class="draw-option-label">Head Size</div>\r
                                                                    <input type="range" id="arrow-head-size" min="8" max="32" value="12" aria-label="Arrowhead size">\r
                                                                </div>\r
                                                            </div>\r
                                                </div>\r
                                            </div>\r
                                        </div>\r
                                    </div>\r
                                    <!-- Text Tool Panel -->\r
                                    <div class="draw-tool-panel" id="draw-text-controls" data-draw-tool="text">\r
                                        <div class="draw-tool-header">\r
                                            <button class="draw-tool-button" data-draw-tool="text" title="Text Tool">\r
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                    <polyline points="4,7 4,4 20,4 20,7"/>\r
                                                    <line x1="12" y1="4" x2="12" y2="20"/>\r
                                                    <line x1="9" y1="20" x2="15" y2="20"/>\r
                                                </svg>\r
                                            </button>\r
                                        </div>\r
                                        <div class="draw-tool-options" id="text-tool-options">\r
                                            <div class="draw-option-group draw-toolbar-row">\r
                                                <!-- Size popup -->\r
                                                <div class="draw-popup-trigger">\r
                                                    <button class="draw-toolbar-button" title="Text size">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <path d="M4 18h16"/>\r
                                                            <path d="M8 18l4-12 4 12"/>\r
                                                            <path d="M10 12h4"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <div class="draw-popup-menu">\r
                                                        <div class="draw-option-label">Size (px)</div>\r
                                                        <input type="number" id="text-size-input" min="8" max="72" value="16" aria-label="Text size (px)">\r
                                                    </div>\r
                                                </div>\r
                                                <!-- Colour popup -->\r
                                                <div class="draw-popup-trigger">\r
                                                    <button class="draw-toolbar-button" title="Text colour">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <path d="M12 3l6 16"/>\r
                                                            <path d="M6 19l6-16"/>\r
                                                            <path d="M10 12h4"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <div class="draw-popup-menu">\r
                                                        <div class="draw-option-label">Colour</div>\r
                                                        <div class="draw-color-picker">\r
                                                            <button class="draw-color-button active" data-color="#000000" style="background-color: #000000;" aria-label="Black text"></button>\r
                                                            <button class="draw-color-button" data-color="#4a90e2" style="background-color: #4a90e2;" aria-label="Blue text"></button>\r
                                                            <button class="draw-color-button" data-color="#d66573" style="background-color: #d66573;" aria-label="Red text"></button>\r
                                                            <button class="draw-color-button" data-color="#68a03f" style="background-color: #68a03f;" aria-label="Green text"></button>\r
                                                        </div>\r
                                                    </div>\r
                                                </div>\r
                                                <!-- Style buttons -->\r
                                                <div class="text-style-rows">\r
                                                    <div class="draw-button-group">\r
                                                        <button class="draw-option-button" data-text-style="bold">B</button>\r
                                                        <button class="draw-option-button" data-text-style="italic">I</button>\r
                                                        <button class="draw-option-button" data-text-style="underline">U</button>\r
                                                    </div>\r
                                                    <div class="draw-button-group">\r
                                                        <button class="draw-option-button" data-text-style="background">Bg</button>\r
                                                        <button class="draw-option-button" data-text-style="superscript">x<sup>2</sup></button>\r
                                                        <button class="draw-option-button" data-text-style="subscript">x<sub>2</sub></button>\r
                                                    </div>\r
                                                </div>\r
                                            </div>\r
                                        </div>\r
                                    </div>\r
                                    <!-- Marker Tool Panel -->\r
                                    <div class="draw-tool-panel" id="draw-marker-controls" data-draw-tool="marker">\r
                                        <div class="draw-tool-header">\r
                                            <button class="draw-tool-button" data-draw-tool="marker" title="Marker Tool">\r
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                    <!-- Pointed marker tip -->\r
                                                    <path d="M18 2L6 14l-2 6 6-2L22 6l-4-4z"/>\r
                                                    <line x1="10" y1="18" x2="6" y2="14"/>\r
                                                </svg>\r
                                            </button>\r
                                        </div>\r
                                        <div class="draw-tool-options" id="marker-tool-options">\r
                                            <div class="draw-option-group draw-toolbar-row">\r
                                                <!-- Size popup -->\r
                                                <div class="draw-popup-trigger">\r
                                                    <button class="draw-toolbar-button" title="Marker size">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <path d="M6 19l12-14"/>\r
                                                            <path d="M6 19l-2 4 4-2"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <div class="draw-popup-menu">\r
                                                        <div class="draw-option-label">Size</div>\r
                                                        <input type="range" id="marker-size-input" min="2" max="20" value="6" aria-label="Marker size">\r
                                                    </div>\r
                                                </div>\r
                                                <!-- Colours popup -->\r
                                                <div class="draw-popup-trigger">\r
                                                    <button class="draw-toolbar-button" title="Marker colour">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <path d="M19 4l-7 7"/>\r
                                                            <path d="M5 20l3.5-1.5"/>\r
                                                            <path d="M16 7l1.5 1.5"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <div class="draw-popup-menu">\r
                                                        <div class="draw-option-label">Colours</div>\r
                                                        <div class="draw-color-picker">\r
                                                            <button class="draw-color-button" data-color="#4a90e2" style="background-color: #4a90e2;" aria-label="Blue marker"></button>\r
                                                            <button class="draw-color-button" data-color="#2d2d2d" style="background-color: #2d2d2d;" aria-label="Black marker"></button>\r
                                                            <button class="draw-color-button" data-color="#d66573" style="background-color: #d66573;" aria-label="Red marker"></button>\r
                                                            <button class="draw-color-button" data-color="#68a03f" style="background-color: #68a03f;" aria-label="Green marker"></button>\r
                                                        </div>\r
                                                    </div>\r
                                                </div>\r
                                            </div>\r
                                        </div>\r
                                    </div>\r
                                    <!-- Highlighter Tool Panel -->\r
                                    <div class="draw-tool-panel" id="draw-highlighter-controls" data-draw-tool="highlighter">\r
                                        <div class="draw-tool-header">\r
                                            <button class="draw-tool-button" data-draw-tool="highlighter" title="Highlighter Tool">\r
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity="0.5">\r
                                                    <!-- Flat highlighter head -->\r
                                                    <rect x="3" y="3" width="4" height="18" rx="1"/>\r
                                                    <path d="M7 5h12l-2 14H7z"/>\r
                                                </svg>\r
                                            </button>\r
                                        </div>\r
                                        <div class="draw-tool-options" id="highlighter-tool-options">\r
                                            <div class="draw-option-group draw-toolbar-row">\r
                                                <!-- Size popup -->\r
                                                <div class="draw-popup-trigger">\r
                                                    <button class="draw-toolbar-button" title="Highlighter size">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <rect x="5" y="5" width="10" height="10" rx="2"/>\r
                                                            <path d="M9 15l-2 4"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <div class="draw-popup-menu">\r
                                                        <div class="draw-option-label">Size</div>\r
                                                        <input type="range" id="highlighter-size-input" min="4" max="30" value="10" aria-label="Highlighter size">\r
                                                    </div>\r
                                                </div>\r
                                                <!-- Colours popup -->\r
                                                <div class="draw-popup-trigger">\r
                                                    <button class="draw-toolbar-button" title="Highlighter colour">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <rect x="7" y="7" width="10" height="10" rx="2"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <div class="draw-popup-menu">\r
                                                        <div class="draw-option-label">Colours</div>\r
                                                        <div class="draw-color-picker">\r
                                                            <button class="draw-color-button" data-color="#9fc5ff" style="background-color: #9fc5ff;" aria-label="Light blue highlighter"></button>\r
                                                            <button class="draw-color-button" data-color="#c2c2c2" style="background-color: #c2c2c2;" aria-label="Gray highlighter"></button>\r
                                                            <button class="draw-color-button" data-color="#ffd166" style="background-color: #ffd166;" aria-label="Yellow highlighter"></button>\r
                                                        </div>\r
                                                    </div>\r
                                                </div>\r
                                            </div>\r
                                        </div>\r
                                    </div>\r
                                    <!-- Lasso Tool Panel -->\r
                                    <div class="draw-tool-panel" id="draw-lasso-controls" data-draw-tool="lasso">\r
                                        <div class="draw-tool-header">\r
                                            <button class="draw-tool-button" data-draw-tool="lasso" title="Lasso Select">\r
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="3 2">\r
                                                    <ellipse cx="12" cy="12" rx="8" ry="6" transform="rotate(-15 12 12)"/>\r
                                                </svg>\r
                                            </button>\r
                                        </div>\r
                                        <div class="draw-tool-options" id="lasso-tool-options">\r
                                            <div class="draw-option-group draw-toolbar-row">\r
                                                <div class="draw-option-help">\r
                                                    Draw around notes to select and drag them as a group.\r
                                                </div>\r
                                            </div>\r
                                        </div>\r
                                    </div>\r
                                </div>\r
                            </div>\r
                        </div>\r
                    </div>\r
                </div>\r
            </div>\r
            <!-- Rhythm Tab -->\r
            <div class="tab-panel" id="rhythm-panel">\r
\r
                <!-- Stamps/Triplets Section (Separate) -->\r
                <div class="control-section rhythm-stamp-tabs-container">\r
                    <div class="rhythm-stamp-tabs-controls">\r
                        <div class="rhythm-tab-stamps">\r
                            <button class="rhythm-tab-button rhythm-stamp-tab-button active" data-rhythm-stamp-tab="sixteenth">Sixteenths</button>\r
                            <button class="rhythm-tab-button rhythm-stamp-tab-button" data-rhythm-stamp-tab="triplet">Triplets</button>\r
                        </div>\r
                        <div class="rhythm-stamp-tab-content">\r
                            <div class="rhythm-stamp-tab-panel active" id="sixteenth-stamps-panel">\r
                                <div id="sixteenth-stamps-toolbar-container" class="sixteenth-stamps-toolbar-container">\r
                                    <!-- Stamps toolbar will be rendered here by JavaScript -->\r
                                </div>\r
                            </div>\r
                            <div class="rhythm-stamp-tab-panel" id="triplet-stamps-panel">\r
                                <div id="triplet-stamps-toolbar-container" class="triplet-stamps-toolbar-container">\r
                                    <!-- Triplets toolbar will be rendered here by JavaScript -->\r
                                </div>\r
                            </div>\r
                        </div>\r
                    </div>\r
                </div>\r
                                <!-- Controls Section (Separate) -->\r
                <div class="control-section rhythm-controls-container">\r
                    <div class="rhythm-controls-section">\r
                        <button class="rhythm-tab-button rhythm-controls-tab-button active" disabled>Controls</button>\r
                        <div class="rhythm-controls-content-box">\r
                            <div class="tempo-content-box">\r
                                <div class="tempo-container">\r
                                    <div class="tempo-boxes-container">\r
                                        <div class="tempo-input-group tempo-row">\r
                                            <img src="assets/tabicons/eigthNote.svg" alt="Eighth Note Tempo" class="tempo-label-icon">\r
                                            <div id="eighth-note-tempo"></div>\r
                                        </div>\r
                                        <div class="tempo-input-group tempo-row">\r
                                            <img src="assets/tabicons/quarterNote.svg" alt="Quarter Note Tempo" class="tempo-label-icon">\r
                                            <div id="quarter-note-tempo"></div>\r
                                        </div>\r
                                        <div class="tempo-input-group tempo-row">\r
                                            <img src="assets/tabicons/dottedQuarterNote.svg" alt="Dotted Quarter Note Tempo" class="tempo-label-icon">\r
                                            <div id="dotted-quarter-tempo"></div>\r
                                        </div>\r
                                    </div>\r
                                    <div class="tempo-slider-container tempo-column-2">\r
                                        <input type="range" id="tempo-slider" min="30" max="240" value="90">\r
                                    </div>\r
                                </div>\r
                            </div>\r
                            <div class="rhythm-structure-container">\r
                                <div class="control-subsection">\r
                                    <h4>Add/Del Beat</h4>\r
                                    <div class="macrobeat-adjust-group">\r
                                        <button class="toolkit-button" id="macrobeat-decrease"></button>\r
                                        <button class="toolkit-button" id="macrobeat-increase">+</button>\r
                                    </div>\r
                                </div>\r
                                <div class="control-subsection">\r
                                    <h4>Pickup</h4>\r
                                    <div class="toggle-button-group"><button class="sidebar-toggle-button" id="anacrusis-on-btn">On</button><button class="sidebar-toggle-button" id="anacrusis-off-btn">Off</button></div>\r
                                </div>\r
                            </div>\r
                            <div class="modulation-container">\r
                                <div class="control-subsection">\r
                                    <h4>Modulation</h4>\r
                                    <div class="modulation-controls">\r
                                        <button class="toolkit-button modulation-ratio-btn" id="modulation-2-3-btn" data-ratio="2:3" title="Place 2:3 modulation marker (33% faster)">2:3 - 33% faster</button>\r
                                        <button class="toolkit-button modulation-ratio-btn" id="modulation-3-2-btn" data-ratio="3:2" title="Place 3:2 modulation marker (33% slower)">3:2 - 33% slower</button>\r
                                        <button class="toolkit-button" id="modulation-clear-btn" title="Clear all modulation markers">Clear</button>\r
                                    </div>\r
                                </div>\r
                            </div>\r
                        </div>\r
                    </div>\r
                </div>\r
            </div>\r
        </div>\r
    </div>\r
  </nav>\r
  <div id="canvas-container" role="region" aria-label="Musical notation canvas">\r
    <div id="canvas-content">\r
        <div id="grids-wrapper">\r
            <div id="button-grid">\r
                <div class="button-grid-left-cell">\r
                    <div class="left-cell-grid">\r
                        <div id="flat-toggle-btn" class="accidental-btn active" role="button" tabindex="0" aria-pressed="true"></div>\r
                        <div id="sharp-toggle-btn" class="accidental-btn active" role="button" tabindex="0" aria-pressed="true"></div>\r
                        <div id="hz-toggle-btn" class="accidental-btn" role="button" tabindex="0" aria-pressed="false">Hz</div>\r
                        <div id="spn-octave-toggle-btn" class="accidental-btn octave-toggle-btn active" role="button" tabindex="0" aria-pressed="true" title="Show SPN octave digits" aria-label="Toggle SPN octave digits">\r
                            <span class="octave-label">\r
                                A<span class="octave-digit">1</span>\r
                            </span>\r
                        </div>\r
                    </div>\r
                </div>\r
                <div class="button-grid-middle-cell">\r
                    <div id="beat-line-button-layer">\r
                        <div id="time-signature-row" class="beat-line-row"></div>\r
                        <div id="grouping-buttons-row" class="beat-line-row"></div>\r
                        <div id="boundary-buttons-row" class="beat-line-row"></div>\r
                    </div>\r
                </div>\r
                <div class="button-grid-right-cell">\r
                    <!-- Null/empty cell for alignment with pitch grid right legend -->\r
                </div>\r
            </div>\r
            <div id="pitch-grid-wrapper">\r
                <div id="pitch-grid-container">\r
                    <div id="grid-container">\r
                        <div id="pitch-canvas-wrapper">\r
                            <canvas id="legend-left-canvas"></canvas>\r
                            <canvas id="notation-grid"></canvas>\r
                            <canvas id="note-animation-canvas"></canvas>\r
                            <canvas id="legend-right-canvas"></canvas>\r
                            <canvas id="playhead-canvas"></canvas>\r
                            <canvas id="hover-canvas"></canvas>\r
                        </div>\r
                    </div>\r
                </div>\r
            </div>\r
            <div id="grid-scrollbar-proxy" role="scrollbar" aria-label="Horizontal scroll for notation grids" tabindex="0">\r
                <div class="grid-scrollbar-inner"></div>\r
            </div>\r
            <div id="drum-grid-wrapper">\r
                <div class="drum-grid-left-cell">\r
                    <!-- Reserved for future drum legends/controls -->\r
                </div>\r
                <div class="drum-grid-middle-cell">\r
                    <div id="drum-canvas-wrapper">\r
                        <canvas id="drum-grid"></canvas>\r
                        <canvas id="drum-playhead-canvas"></canvas>\r
                        <canvas id="drum-hover-canvas"></canvas>\r
                    </div>\r
                </div>\r
                <div class="drum-grid-right-cell">\r
                    <!-- Placeholder for alignment with right legend spacing -->\r
                </div>\r
            </div>\r
        </div>\r
    </div>\r
</div>\r
</main>\r
<!-- Notification Overlay -->\r
<div id="notification-overlay">\r
    <div class="notification-modal">\r
        <div class="notification-header">\r
            <h3 class="notification-title">Notice</h3>\r
            <button class="notification-close"></button>\r
        </div>\r
        <div class="notification-message"></div>\r
        <div class="notification-actions">\r
            <button class="notification-button">OK</button>\r
        </div>\r
    </div>\r
</div>\r
<!-- ... (Print Preview Modal remains the same) ... -->\r
<div id="print-preview-overlay" class="hidden">\r
    <div id="print-preview-modal">\r
        <div class="print-preview-header">\r
            <h2>Print Preview</h2>\r
            <button id="print-close-button" class="close-button"></button>\r
        </div>\r
        <div class="print-preview-content">\r
            <div class="print-preview-canvas-wrapper">\r
                <canvas id="print-preview-canvas"></canvas>\r
                <canvas id="print-crop-overlay"></canvas>\r
            </div>\r
                <div class="print-preview-options">\r
                <div class="print-info-box">\r
                    <p>Use the crop handles on the preview to trim what gets sent to the printer.</p>\r
                </div>\r
                <h3>Layout</h3>\r
                <div class="print-option-row">\r
                    <label>Paper</label>\r
                    <select id="print-page-size" class="print-select">\r
                        <option value="letter">Letter (8.511)</option>\r
                        <option value="11x14">1114</option>\r
                        <option value="11x17">1117</option>\r
                    </select>\r
                </div>\r
                <div class="print-option-row">\r
                    <label>Orientation</label>\r
                    <button id="print-orientation-toggle" class="toggle-button">Landscape</button>\r
                </div>\r
                <div class="print-option-row">\r
                    <label>Buttons</label>\r
                    <button id="print-button-grid-toggle" class="toggle-button active">Include</button>\r
                </div>\r
                <div class="print-option-row">\r
                    <label>Drums</label>\r
                    <button id="print-drum-grid-toggle" class="toggle-button active">Include</button>\r
                </div>\r
                <div class="print-option-row">\r
                    <label>Left Legend</label>\r
                    <button id="print-left-legend-toggle" class="toggle-button active">Include</button>\r
                </div>\r
                <div class="print-option-row">\r
                    <label>Right Legend</label>\r
                    <button id="print-right-legend-toggle" class="toggle-button active">Include</button>\r
                </div>\r
                <div class="print-option-row">\r
                    <label>Color</label>\r
                    <button id="print-color-mode-toggle" class="toggle-button active">Color</button>\r
                </div>\r
            </div>\r
        </div>\r
        <div class="print-preview-footer">\r
            <button id="print-confirm-button" class="confirm-button">Print</button>\r
        </div>\r
    </div>\r
</div>\r
<div id="print-staging-area"></div>\r
\r
<!-- Svelte component mount points (headless components) -->\r
<!-- Toolbar bridges -->\r
<div data-svelte-component="playback-controls-bridge" style="display: none;"></div>\r
<div data-svelte-component="file-actions-bridge" style="display: none;"></div>\r
<div data-svelte-component="grid-controls-bridge" style="display: none;"></div>\r
<div data-svelte-component="modulation-bridge" style="display: none;"></div>\r
<div data-svelte-component="sidebar-bridge" style="display: none;"></div>\r
<div data-svelte-component="tool-selector-bridge" style="display: none;"></div>\r
<div data-svelte-component="audio-controls-bridge" style="display: none;"></div>\r
<!-- Tab management bridge -->\r
<div data-svelte-component="tab-management-bridge" style="display: none;"></div>\r
<!-- Modal bridges -->\r
<div data-svelte-component="print-preview-bridge" style="display: none;"></div>\r
<!-- Phase 3: Modernized Svelte 5 components -->\r
<div data-svelte-component="store-context" style="display: none;"></div>
<div data-svelte-component="notification-modal"></div>
<div data-svelte-component="zoom-indicator"></div>
`,ld={attack:.1,decay:.2,sustain:.8,release:.3},cd={enabled:!1,blend:.5,cutoff:.5,resonance:0,type:"lowpass",mix:1},dd={speed:5,span:0},ud={speed:5,span:0};function hd(){const n=["#4a90e2","#e24a4a","#4ae24a","#e2e24a","#e24ae2","#4ae2e2","#e2a04a","#a04ae2"],t={};return n.forEach(e=>{const o=new Float32Array(32);o[0]=1;const i=new Float32Array(32);t[e]={name:"Sine",adsr:{...ld},coeffs:o,phases:i,filter:{...cd},activePresetName:"sine",gain:1,vibrato:{...dd},tremelo:{...ud}}}),t}function fd(){const n=new Array(16).fill(2),t=n.slice(0,-1).map((e,o)=>(o+1)%4===0?"solid":"dashed");return{macrobeatGroupings:n,macrobeatBoundaryStyles:t,hasAnacrusis:!1,baseMicrobeatPx:40,tempoModulationMarkers:[]}}function md(){const n=$l("G5","C4");return n||{topIndex:0,bottomIndex:Math.max(0,ue.length-1)}}function pd(){const n=hd();return{placedNotes:[],placedChords:[],tonicSignGroups:{},sixteenthStampPlacements:[],tripletStampPlacements:[],annotations:[],lassoSelection:{selectedItems:[],convexHull:null,isActive:!1},history:[{notes:[],tonicSignGroups:{},timbres:JSON.parse(JSON.stringify(n)),placedChords:[],sixteenthStampPlacements:[],tripletStampPlacements:[],annotations:[],lassoSelection:{selectedItems:[],convexHull:null,isActive:!1}}],historyIndex:0,fullRowData:[...ue],pitchRange:md(),...fd(),selectedModulationRatio:null,timbres:n,colorPalette:{"#4a90e2":{primary:"#4a90e2",light:"#a8c8f0"},"#e24a4a":{primary:"#e24a4a",light:"#f0a8a8"},"#4ae24a":{primary:"#4ae24a",light:"#a8f0a8"},"#e2e24a":{primary:"#e2e24a",light:"#f0f0a8"},"#e24ae2":{primary:"#e24ae2",light:"#f0a8f0"},"#4ae2e2":{primary:"#4ae2e2",light:"#a8f0f0"},"#e2a04a":{primary:"#e2a04a",light:"#f0d0a8"},"#a04ae2":{primary:"#a04ae2",light:"#d0a8f0"}},selectedTool:"note",previousTool:"note",selectedToolTonicNumber:1,selectedNote:{shape:"circle",color:"#4a90e2"},deviceProfile:{isMobile:!1,isTouch:!1,isCoarsePointer:!1,orientation:"landscape",width:0,height:0},activeChordId:null,activeChordIntervals:["1P"],isIntervalsInverted:!1,chordPositionState:0,gridPosition:0,viewportRows:0,logicRows:0,cellWidth:0,cellHeight:0,columnWidths:[],musicalColumnWidths:[],degreeDisplayMode:"off",accidentalMode:{sharp:!0,flat:!0},showFrequencyLabels:!1,showOctaveLabels:!0,focusColours:!1,isPlaying:!1,isPaused:!1,isLooping:!1,tempo:90,playheadMode:"cursor",waveformExtendedView:!1,adsrTimeAxisScale:1,isPrintPreviewActive:!1,printOptions:{pageSize:"letter",includeButtonGrid:!0,includeDrums:!0,includeLeftLegend:!0,includeRightLegend:!0,orientation:"landscape",colorMode:"color",cropTop:0,cropBottom:1,cropLeft:0,cropRight:1},longNoteStyle:"style1"}}function Ys(n){if(!(!n||n.isDrum)&&n.shape==="circle"&&typeof n.startColumnIndex=="number"){const t=n.startColumnIndex+1;(typeof n.endColumnIndex!="number"||n.endColumnIndex<t)&&(n.endColumnIndex=t)}}function wi(n,t){if(typeof n.row!="number")return;const e=t.length>0?t.length-1:-1;if(e<0)return;const o=typeof n.globalRow=="number"?n.globalRow:n.row,i=Math.max(0,Math.min(e,Math.round(o)));n.globalRow=i,n.row=i}function mo(){return`uuid-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function gd(n={}){const{getMacrobeatInfo:t,getDegreeForNote:e,hasAccidental:o,log:i=()=>{}}=n;return{addNote(s){const a=this.state.placedNotes.find(c=>!c.isDrum&&c.row===s.row&&c.startColumnIndex===s.startColumnIndex&&c.color===s.color);if(a){if(this.state.degreeDisplayMode!=="off"&&e&&o){const c=e(a,this.state);if(c&&o(c))return a.enharmonicPreference=!a.enharmonicPreference,i("debug","[ENHARMONIC] Toggled enharmonic preference for note",{noteUuid:a.uuid,currentDegree:c,enharmonicPreference:a.enharmonicPreference}),this.emit("notesChanged"),a}return null}const r={...s,uuid:mo()};return Ys(r),wi(r,this.state.fullRowData),this.state.placedNotes.push(r),this.emit("notesChanged"),r},updateNoteTail(s,a){let r=a;s.shape==="circle"&&(r=Math.max(s.startColumnIndex+1,a)),s.endColumnIndex=r,this.emit("notesChanged")},updateMultipleNoteTails(s,a){s.forEach(r=>{let c=a;r.shape==="circle"&&(c=Math.max(r.startColumnIndex+1,a)),r.endColumnIndex=c}),this.emit("notesChanged")},updateNoteRow(s,a){s.row=a,s.globalRow=a,this.emit("notesChanged")},updateMultipleNoteRows(s,a){s.forEach((r,c)=>{const d=a[c];d!==void 0&&(r.row=d,wi(r,this.state.fullRowData))}),this.emit("notesChanged")},updateNotePosition(s,a){s.startColumnIndex=a,s.endColumnIndex=s.shape==="circle"?a+1:a,this.emit("notesChanged")},updateMultipleNotePositions(s,a){s.forEach(r=>{r.startColumnIndex=a,r.endColumnIndex=r.shape==="circle"?a+1:a}),this.emit("notesChanged")},removeNote(s){const a=this.state.placedNotes.indexOf(s);a>-1&&(this.state.placedNotes.splice(a,1),this.emit("notesChanged"))},removeMultipleNotes(s){const a=new Set(s);this.state.placedNotes=this.state.placedNotes.filter(r=>!a.has(r)),this.emit("notesChanged")},eraseInPitchArea(s,a,r=1,c=!0){const d=s+r-1,u=a-1,h=a+1;let m=!1;const g=this.state.placedNotes.length;return this.state.placedNotes=this.state.placedNotes.filter(f=>{if(f.isDrum)return!0;if(f.shape==="circle"){const p=f.startColumnIndex+1,v=typeof f.endColumnIndex=="number"?Math.max(p,f.endColumnIndex):p,w=f.startColumnIndex<=d&&v>=s,y=f.row>=u&&f.row<=h;if(w&&y)return!1}else if(f.row>=u&&f.row<=h&&f.startColumnIndex<=d&&f.endColumnIndex>=s)return!1;return!0}),this.state.placedNotes.length<g&&(m=!0),m&&(this.emit("notesChanged"),c&&this.recordState()),m},eraseDrumNoteAt(s,a,r=!0){const c=String(a),d=this.state.placedNotes.length;this.state.placedNotes=this.state.placedNotes.filter(h=>!(h.isDrum&&String(h.drumTrack)===c&&h.startColumnIndex===s));const u=this.state.placedNotes.length<d;return u&&(this.emit("notesChanged"),r&&this.recordState()),u},toggleDrumNote(s){const a=String(s.drumTrack),r=this.state.placedNotes.findIndex(c=>c.isDrum&&String(c.drumTrack)===a&&c.startColumnIndex===s.startColumnIndex);if(r>=0)this.state.placedNotes.splice(r,1);else{const c={...s,uuid:mo(),isDrum:!0,endColumnIndex:s.endColumnIndex??s.startColumnIndex};this.state.placedNotes.push(c)}this.emit("notesChanged"),this.recordState()},addTonicSignGroup(s){i("debug","Starting addTonicSignGroup",{tonicSignGroup:s});const a=s[0];if(!a)return;const{preMacrobeatIndex:r}=a;if(i("debug","preMacrobeatIndex",{preMacrobeatIndex:r}),Object.entries(this.state.tonicSignGroups).find(([,g])=>g.some(f=>f.preMacrobeatIndex===r))){i("debug","Existing tonic already present for measure, skipping",{preMacrobeatIndex:r});return}if(!t){i("error","getMacrobeatInfo callback not provided");return}const d=t(this.state,r+1).startColumn;i("debug","Boundary column (canvas-space) for shifting notes",{boundaryColumn:d});const u=this.state.placedNotes.filter(g=>g.startColumnIndex>=d);i("debug","Notes that will be shifted",{noteRanges:u.map(g=>`${g.startColumnIndex}-${g.endColumnIndex}`)}),this.state.placedNotes.forEach(g=>{if(g.startColumnIndex>=d){const f=g.startColumnIndex,p=g.endColumnIndex;g.startColumnIndex=g.startColumnIndex+2,g.endColumnIndex=g.endColumnIndex+2,i("debug",`Shifted note from ${f}-${p} to ${g.startColumnIndex}-${g.endColumnIndex}`)}});const h=mo(),m=s.map(g=>({...g,uuid:h,globalRow:typeof g.globalRow=="number"?g.globalRow:g.row}));this.state.tonicSignGroups[h]=m,i("debug","Added tonic group",{uuid:h,columns:m.map(g=>g.columnIndex)}),i("debug","Emitting events: notesChanged, rhythmStructureChanged"),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},eraseTonicSignAt(s,a=!0){const r=Object.entries(this.state.tonicSignGroups).find(([,g])=>g.some(f=>f.columnIndex===s));if(!r)return!1;if(!t)return i("error","getMacrobeatInfo callback not provided"),!1;const[c,d]=r,u=d[0];if(!u)return!1;const h=u.preMacrobeatIndex,m=t(this.state,h+1).startColumn;return delete this.state.tonicSignGroups[c],this.state.placedNotes.forEach(g=>{g.startColumnIndex>=m&&(g.startColumnIndex=g.startColumnIndex-2,g.endColumnIndex=g.endColumnIndex-2)}),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),a&&this.recordState(),!0},clearAllNotes(){this.state.placedNotes=[],this.state.tonicSignGroups={},this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},loadNotes(s){const a=(s||[]).map(r=>{const c={...r,uuid:r?.uuid??mo()};return Ys(c),wi(c,this.state.fullRowData),c});this.state.placedNotes=a,this.emit("notesChanged"),this.recordState()}}}function vd(){return`sixteenth-stamp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function bd(n={}){const{getPlacedTonicSigns:t,isWithinTonicSpan:e,log:o=()=>{}}=n;return{addSixteenthStampPlacement(i,s,a,r="#4a90e2"){const c=s+2;if(t&&e){const m=t(this.state);(e(s,m)||e(s+1,m))&&o("debug","Cannot place sixteenth stamp - overlaps tonic column",{sixteenthStampId:i,startColumn:s,row:a})}const d=this.state.sixteenthStampPlacements.find(m=>m.row===a&&m.startColumn<c&&m.endColumn>s);d&&this.removeSixteenthStampPlacement(d.id);const u=a,h={id:vd(),sixteenthStampId:i,startColumn:s,endColumn:c,row:a,globalRow:u,color:r,timestamp:Date.now(),shapeOffsets:{}};return this.state.sixteenthStampPlacements.push(h),this.emit("sixteenthStampPlacementsChanged"),o("debug",`Added sixteenth stamp ${i} at canvas-space ${s}-${c},${a}`,{sixteenthStampId:i,startColumn:s,endColumn:c,row:a,placementId:h.id}),h},removeSixteenthStampPlacement(i){const s=this.state.sixteenthStampPlacements.findIndex(r=>r.id===i);if(s===-1)return!1;const a=this.state.sixteenthStampPlacements.splice(s,1)[0];return a?(this.emit("sixteenthStampPlacementsChanged"),o("debug",`Removed sixteenth stamp ${a.sixteenthStampId} at ${a.startColumn}-${a.endColumn},${a.row}`,{placementId:i,sixteenthStampId:a.sixteenthStampId,startColumn:a.startColumn,endColumn:a.endColumn,row:a.row}),!0):!1},eraseSixteenthStampsInArea(i,s,a,r){const c=[];for(const u of this.state.sixteenthStampPlacements){const h=u.startColumn<=s&&u.endColumn>=i,m=u.row>=a&&u.row<=r;h&&m&&c.push(u.id)}let d=!1;return c.forEach(u=>{this.removeSixteenthStampPlacement(u)&&(d=!0)}),d},getAllSixteenthStampPlacements(){return[...this.state.sixteenthStampPlacements]},getSixteenthStampAt(i,s){return this.state.sixteenthStampPlacements.find(a=>a.row===s&&i>=a.startColumn&&i<a.endColumn)||null},clearAllSixteenthStamps(){const i=this.state.sixteenthStampPlacements.length>0;this.state.sixteenthStampPlacements=[],i&&(this.emit("sixteenthStampPlacementsChanged"),o("info","Cleared all sixteenth stamp placements"))},getSixteenthStampPlaybackData(){return this.state.sixteenthStampPlacements.map(i=>{const s=this.state.fullRowData[i.row];return{sixteenthStampId:i.sixteenthStampId,column:i.startColumn,startColumn:i.startColumn,endColumn:i.endColumn,row:i.row,pitch:s?.toneNote||"",color:i.color,placement:i}}).filter(i=>i.pitch)},updateSixteenthStampShapeOffset(i,s,a){const r=this.state.sixteenthStampPlacements.find(c=>c.id===i);if(!r){o("warn","[SIXTEENTH STAMP SHAPE OFFSET] Placement not found",{placementId:i});return}r.shapeOffsets||(r.shapeOffsets={}),o("debug","[SIXTEENTH STAMP SHAPE OFFSET] Updating shape offset",{placementId:i,shapeKey:s,oldOffset:r.shapeOffsets[s]||0,newOffset:a,baseRow:r.row,targetRow:r.row+a}),r.shapeOffsets[s]=a,this.emit("sixteenthStampPlacementsChanged")},getSixteenthStampShapeRow(i,s){const a=i.shapeOffsets?.[s]||0;return i.row+a}}}function wd(){return`triplet-stamp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function yd(n={}){const{canvasToTime:t,timeToCanvas:e,getColumnMap:o,log:i=()=>{}}=n;return{addTripletStampPlacement(s){this.state.tripletStampPlacements||(this.state.tripletStampPlacements=[]);const a=s.startTimeIndex+s.span*2,r=this.state.tripletStampPlacements.find(d=>d.row!==s.row?!1:!(d.startTimeIndex+d.span*2<=s.startTimeIndex||a<=d.startTimeIndex));if(r&&this.removeTripletStampPlacement(r.id),this.state.sixteenthStampPlacements&&t&&o){const d=o(this.state);this.state.sixteenthStampPlacements.filter(h=>{if(h.row!==s.row)return!1;const m=t(h.startColumn,d);return m===null?!0:!(m+2<=s.startTimeIndex||m>=a)}).forEach(h=>{this.removeSixteenthStampPlacement&&this.removeSixteenthStampPlacement(h.id)})}const c={id:wd(),...s,shapeOffsets:s.shapeOffsets||{}};return this.state.tripletStampPlacements.push(c),this.emit("tripletStampPlacementsChanged"),this.emit("rhythmStructureChanged"),i("debug",`Added triplet stamp ${s.tripletStampId} at time ${s.startTimeIndex}, row ${s.row}`,{tripletStampId:s.tripletStampId,startTimeIndex:s.startTimeIndex,span:s.span,row:s.row,placementId:c.id}),c},removeTripletStampPlacement(s){if(!this.state.tripletStampPlacements)return!1;const a=this.state.tripletStampPlacements.findIndex(c=>c.id===s);if(a===-1)return!1;const r=this.state.tripletStampPlacements.splice(a,1)[0];return r?(this.emit("tripletStampPlacementsChanged"),i("debug",`Removed triplet stamp ${r.tripletStampId} at time ${r.startTimeIndex}, row ${r.row}`,{placementId:s,tripletStampId:r.tripletStampId,startTimeIndex:r.startTimeIndex,span:r.span,row:r.row}),!0):!1},eraseTripletStampsInArea(s,a,r,c){if(!this.state.tripletStampPlacements||!e||!o)return!1;const d=o(this.state),u=[];for(const m of this.state.tripletStampPlacements)if(m.row>=r&&m.row<=c){const g=m.span*2,f=e(m.startTimeIndex,d);f+g-1<s||f>a||u.push(m.id)}let h=!1;return u.forEach(m=>{this.removeTripletStampPlacement(m)&&(h=!0)}),h},getAllTripletStampPlacements(){return[...this.state.tripletStampPlacements||[]]},getTripletStampAt(s,a){return this.state.tripletStampPlacements&&this.state.tripletStampPlacements.find(r=>r.row===a&&s>=r.startTimeIndex&&s<r.startTimeIndex+r.span*2)||null},clearAllTripletStamps(){if(!this.state.tripletStampPlacements)return;const s=this.state.tripletStampPlacements.length>0;this.state.tripletStampPlacements=[],s&&(this.emit("tripletStampPlacementsChanged"),i("info","Cleared all triplet stamp placements"))},getTripletStampPlaybackData(){return this.state.tripletStampPlacements?this.state.tripletStampPlacements.map(s=>{const a=this.state.fullRowData[s.row];return{startTimeIndex:s.startTimeIndex,tripletStampId:s.tripletStampId,row:s.row,pitch:a?.toneNote??"",color:s.color,span:s.span,placement:s}}).filter(s=>s.pitch):[]},updateTripletStampShapeOffset(s,a,r){const c=this.state.tripletStampPlacements?.find(d=>d.id===s);if(!c){i("warn","[TRIPLET STAMP SHAPE OFFSET] Placement not found",{placementId:s});return}c.shapeOffsets||(c.shapeOffsets={}),i("debug","[TRIPLET STAMP SHAPE OFFSET] Updating shape offset",{placementId:s,shapeKey:a,oldOffset:c.shapeOffsets[a]||0,newOffset:r,baseRow:c.row,targetRow:c.row+r}),c.shapeOffsets[a]=r,this.emit("tripletStampPlacementsChanged")},getTripletStampShapeRow(s,a){const r=s.shapeOffsets?.[a]||0;return s.row+r}}}function Qs(n){const t=JSON.parse(JSON.stringify(n));for(const e in t){const o=t[e];o.coeffs&&typeof o.coeffs=="object"&&!Array.isArray(o.coeffs)?o.coeffs=new Float32Array(Object.values(o.coeffs)):Array.isArray(o.coeffs)&&(o.coeffs=new Float32Array(o.coeffs)),o.phases&&typeof o.phases=="object"&&!Array.isArray(o.phases)?o.phases=new Float32Array(Object.values(o.phases)):Array.isArray(o.phases)&&(o.phases=new Float32Array(o.phases))}return t}const Sd=new Set(["dashed","solid","anacrusis"]);function Cd(n){return Array.isArray(n)&&n.length>0&&n.every(t=>t===2||t===3)}function Ad(n,t){return Array.isArray(n)&&n.length===Math.max(t-1,0)&&n.every(e=>Sd.has(e))}function xd(n,t){if(n)try{const e=n.getItem(t);if(e===null)return;const o=JSON.parse(e),i=o.macrobeatGroupings;if(!Cd(i)){n.removeItem(t);return}if(!Ad(o.macrobeatBoundaryStyles,i.length)){n.removeItem(t);return}if(delete o.timbres,o.pitchRange){const s=ue.length,a=Math.max(0,s-1),r=Math.max(0,Math.min(a,o.pitchRange.topIndex??0)),c=Math.max(r,Math.min(a,o.pitchRange.bottomIndex??a));o.pitchRange={topIndex:r,bottomIndex:c}}if("playheadMode"in o){const s=o.playheadMode;s!=="cursor"&&s!=="microbeat"&&s!=="macrobeat"&&delete o.playheadMode}return o.fullRowData=[...ue],o}catch{return}}function Md(n,t,e){if(t)try{const o=JSON.parse(JSON.stringify({placedNotes:n.placedNotes,placedChords:n.placedChords,tonicSignGroups:n.tonicSignGroups,sixteenthStampPlacements:n.sixteenthStampPlacements,tripletStampPlacements:n.tripletStampPlacements,macrobeatGroupings:n.macrobeatGroupings,macrobeatBoundaryStyles:n.macrobeatBoundaryStyles,hasAnacrusis:n.hasAnacrusis,baseMicrobeatPx:n.baseMicrobeatPx,tempoModulationMarkers:n.tempoModulationMarkers,tempo:n.tempo,activeChordIntervals:n.activeChordIntervals,selectedNote:n.selectedNote,annotations:n.annotations,pitchRange:n.pitchRange,degreeDisplayMode:n.degreeDisplayMode,showOctaveLabels:n.showOctaveLabels,longNoteStyle:n.longNoteStyle,playheadMode:n.playheadMode})),i=JSON.stringify(o);t.setItem(e,i)}catch{}}function Ed(n={}){const{storageKey:t="studentNotationState",storage:e,initialState:o,onClearState:i,noteActionCallbacks:s={},sixteenthStampActionCallbacks:a={},tripletStampActionCallbacks:r={},rhythmActionCallbacks:c={}}=n,d={},u=xd(e,t),h=!u,f={state:{...pd(),...u,...o},isColdStart:h,on(p,v){d[p]||(d[p]=[]),d[p].push(v)},off(p,v){if(d[p]){const w=d[p].indexOf(v);w>-1&&d[p].splice(w,1)}},emit(p,v){d[p]&&d[p].forEach(w=>{try{w(v)}catch(y){console.error(`Error in listener for event "${p}"`,y)}})},dispose(){for(const p in d)delete d[p]},saveState(){Md(f.state,e,t)},recordState(){f.state.history=f.state.history.slice(0,f.state.historyIndex+1);const p=JSON.parse(JSON.stringify(f.state.timbres)),v={notes:JSON.parse(JSON.stringify(f.state.placedNotes)),tonicSignGroups:JSON.parse(JSON.stringify(f.state.tonicSignGroups)),placedChords:JSON.parse(JSON.stringify(f.state.placedChords)),sixteenthStampPlacements:JSON.parse(JSON.stringify(f.state.sixteenthStampPlacements)),tripletStampPlacements:JSON.parse(JSON.stringify(f.state.tripletStampPlacements||[])),timbres:p,annotations:f.state.annotations?JSON.parse(JSON.stringify(f.state.annotations)):[],lassoSelection:JSON.parse(JSON.stringify(f.state.lassoSelection))};f.state.history.push(v),f.state.historyIndex++,f.emit("historyChanged"),f.saveState()},undo(){if(f.state.historyIndex>0){f.state.historyIndex--;const p=f.state.history[f.state.historyIndex];if(!p)return;f.state.placedNotes=JSON.parse(JSON.stringify(p.notes)),f.state.tonicSignGroups=JSON.parse(JSON.stringify(p.tonicSignGroups)),f.state.sixteenthStampPlacements=JSON.parse(JSON.stringify(p.sixteenthStampPlacements||[])),f.state.tripletStampPlacements=JSON.parse(JSON.stringify(p.tripletStampPlacements||[])),f.state.timbres=Qs(p.timbres),f.state.annotations=p.annotations?JSON.parse(JSON.stringify(p.annotations)):[],f.emit("notesChanged"),f.emit("sixteenthStampPlacementsChanged"),f.emit("tripletStampPlacementsChanged"),f.emit("rhythmStructureChanged"),f.state.selectedNote?.color&&f.emit("timbreChanged",f.state.selectedNote.color),f.emit("annotationsChanged"),f.emit("historyChanged")}},redo(){if(f.state.historyIndex<f.state.history.length-1){f.state.historyIndex++;const p=f.state.history[f.state.historyIndex];if(!p)return;f.state.placedNotes=JSON.parse(JSON.stringify(p.notes)),f.state.tonicSignGroups=JSON.parse(JSON.stringify(p.tonicSignGroups)),f.state.sixteenthStampPlacements=JSON.parse(JSON.stringify(p.sixteenthStampPlacements||[])),f.state.tripletStampPlacements=JSON.parse(JSON.stringify(p.tripletStampPlacements||[])),f.state.timbres=Qs(p.timbres),f.state.annotations=p.annotations?JSON.parse(JSON.stringify(p.annotations)):[],f.emit("notesChanged"),f.emit("sixteenthStampPlacementsChanged"),f.emit("tripletStampPlacementsChanged"),f.emit("rhythmStructureChanged"),f.state.selectedNote?.color&&f.emit("timbreChanged",f.state.selectedNote.color),f.emit("annotationsChanged"),f.emit("historyChanged")}},clearSavedState(){e&&(e.removeItem(t),e.removeItem("effectDialValues")),i&&i()},setPlaybackState(p,v){f.state.isPlaying=p,f.state.isPaused=v,f.emit("playbackStateChanged",{isPlaying:p,isPaused:v})},setLooping(p){f.state.isLooping=p,f.emit("loopingChanged",p)},setTempo(p){f.state.tempo=p,f.emit("tempoChanged",p)},setPlayheadMode(p){f.state.playheadMode=p,f.emit("playheadModeChanged",p)},setSelectedTool(p,v){const w=f.state.selectedTool;if(f.state.previousTool=w,f.state.selectedTool=p,v!==void 0){const y=typeof v=="string"?parseInt(v,10):v;isNaN(y)||(f.state.selectedToolTonicNumber=y)}f.emit("toolChanged",{newTool:p,oldTool:w})},setSelectedNote(p,v){const w={...f.state.selectedNote};f.state.selectedNote={shape:p,color:v},f.emit("noteChanged",{newNote:f.state.selectedNote,oldNote:w})},setPitchRange(p){f.state.pitchRange={...f.state.pitchRange,...p},f.emit("pitchRangeChanged",f.state.pitchRange)},setDegreeDisplayMode(p){f.state.degreeDisplayMode=p,f.emit("degreeDisplayModeChanged",p)},setLongNoteStyle(p){f.state.longNoteStyle=p,f.emit("longNoteStyleChanged",p)},toggleAccidentalMode(p){f.state.accidentalMode[p]=!f.state.accidentalMode[p],f.emit("accidentalModeChanged",f.state.accidentalMode)},toggleFrequencyLabels(){f.state.showFrequencyLabels=!f.state.showFrequencyLabels,f.emit("frequencyLabelsChanged",f.state.showFrequencyLabels)},toggleOctaveLabels(){f.state.showOctaveLabels=!f.state.showOctaveLabels,f.emit("octaveLabelsChanged",f.state.showOctaveLabels)},toggleFocusColours(){f.state.focusColours=!f.state.focusColours,f.emit("focusColoursChanged",f.state.focusColours)},toggleWaveformExtendedView(){f.state.waveformExtendedView=!f.state.waveformExtendedView,f.emit("waveformExtendedViewChanged",f.state.waveformExtendedView)},setLayoutConfig(p){p.cellWidth!==void 0&&(f.state.cellWidth=p.cellWidth),p.cellHeight!==void 0&&(f.state.cellHeight=p.cellHeight),p.columnWidths!==void 0&&(f.state.columnWidths=p.columnWidths),f.emit("layoutConfigChanged",p)},setDeviceProfile(p){f.state.deviceProfile={...f.state.deviceProfile,...p},f.emit("deviceProfileChanged",f.state.deviceProfile)},setPrintPreviewActive(p){f.state.isPrintPreviewActive=p,f.emit("printPreviewStateChanged",p)},setPrintOptions(p){f.state.printOptions={...f.state.printOptions,...p},f.emit("printOptionsChanged",f.state.printOptions)},setAdsrTimeAxisScale(p){f.state.adsrTimeAxisScale=p,f.emit("adsrTimeAxisScaleChanged",p)},setAdsrComponentWidth(){},shiftGridUp(){},shiftGridDown(){},setGridPosition(){},setKeySignature(p){f.state.keySignature=p,f.emit("keySignatureChanged",p)},setActiveChordIntervals(p){f.state.activeChordIntervals=p,f.emit("activeChordIntervalsChanged",p)},setIntervalsInversion(p){f.state.isIntervalsInverted=p,f.emit("intervalsInversionChanged",p)},setChordPosition(p){f.state.chordPositionState=p,f.emit("chordPositionChanged",p)},setADSR(p,v){f.state.timbres[p]&&(f.state.timbres[p].adsr={...f.state.timbres[p].adsr,...v},f.emit("timbreChanged",p))},setHarmonicCoefficients(p,v){f.state.timbres[p]&&(f.state.timbres[p].coeffs=v,f.emit("timbreChanged",p))},setHarmonicPhases(p,v){f.state.timbres[p]&&(f.state.timbres[p].phases=v,f.emit("timbreChanged",p))},setFilterSettings(p,v){f.state.timbres[p]&&(f.state.timbres[p].filter={...f.state.timbres[p].filter,...v},f.emit("timbreChanged",p))},applyPreset(p,v){f.state.timbres[p]&&(Object.assign(f.state.timbres[p],v),f.emit("timbreChanged",p))},...gd(s),...bd(a),...yd(r),...Hl(c)};return e&&(f.on("tempoChanged",()=>f.saveState()),f.on("degreeDisplayModeChanged",()=>f.saveState()),f.on("longNoteStyleChanged",()=>f.saveState()),f.on("playheadModeChanged",()=>f.saveState())),h&&e&&f.saveState(),f}class Pd extends Ll{presetGain;vibratoLFO;vibratoDepth;vibratoGain;tremoloLFO;tremoloDepth;tremoloGain;hpFilter;lpFilterForBP;lpFilterSolo;hpOutput;bpOutput;lpOutput;hp_bp_fade;main_fade;wetDryFade;constructor(t){super(t),this.presetGain=new je(t.gain||1),this.vibratoLFO=new Hs(0,0),this.vibratoDepth=new qs(-1,1),this.vibratoGain=new je(0),this.vibratoLFO.connect(this.vibratoDepth),this.vibratoDepth.connect(this.vibratoGain),this.vibratoGain.connect(this.oscillator.frequency),this.tremoloLFO=new Hs(0,0),this.tremoloDepth=new qs(0,1),this.tremoloGain=new je(1),this.tremoloLFO.connect(this.tremoloDepth),this.tremoloDepth.connect(this.tremoloGain.gain),this.hpFilter=new pi({type:"highpass"}),this.lpFilterForBP=new pi({type:"lowpass"}),this.lpFilterSolo=new pi({type:"lowpass"}),this.hpOutput=new je,this.bpOutput=new je,this.lpOutput=new je,this.hp_bp_fade=new gi(0),this.main_fade=new gi(0),this.wetDryFade=new gi(0),this.oscillator.connect(this.presetGain),this.presetGain.connect(this.wetDryFade.a),this.presetGain.connect(this.hpFilter),this.hpFilter.connect(this.hpOutput),this.hpFilter.connect(this.lpFilterForBP),this.lpFilterForBP.connect(this.bpOutput),this.presetGain.connect(this.lpFilterSolo),this.lpFilterSolo.connect(this.lpOutput),this.hpOutput.connect(this.hp_bp_fade.a),this.bpOutput.connect(this.hp_bp_fade.b),this.lpOutput.connect(this.main_fade.b),this.hp_bp_fade.connect(this.main_fade.a),this.main_fade.connect(this.wetDryFade.b),this.wetDryFade.connect(this.tremoloGain),this.tremoloGain.connect(this.envelope),t.filter&&this._setFilter(t.filter),t.vibrato?this._setVibrato(t.vibrato):this._setVibrato({speed:0,span:0}),t.tremelo?this._setTremolo(t.tremelo):this._setTremolo({speed:0,span:0})}_setPresetGain(t){this.presetGain&&(this.presetGain.gain.value=t)}_setVibrato(t,e=Rt()){if(!this.vibratoLFO||!this.vibratoGain)return;const o=t.speed/100*16,s=(Gs()?.rawContext?.state??Pe.state)==="running";if(t.speed===0||t.span===0){s&&this.vibratoLFO.state==="started"&&this.vibratoLFO.stop(e),this.vibratoLFO.frequency.value=0,this.vibratoGain.gain.value=0;return}s&&this.vibratoLFO.state!=="started"&&this.vibratoLFO.start(e),this.vibratoLFO.frequency.value=o;const c=t.span/100*50/1200,h=440*(Math.pow(2,c)-1);this.vibratoGain.gain.value=h}_setTremolo(t,e=Rt()){if(!this.tremoloLFO||!this.tremoloGain)return;const o=t.speed/100*16,s=(Gs()?.rawContext?.state??Pe.state)==="running";if(t.speed===0||t.span===0){s&&this.tremoloLFO.state==="started"&&this.tremoloLFO.stop(e),this.tremoloLFO.frequency.value=0,this.tremoloGain.gain.cancelScheduledValues(e),this.tremoloGain.gain.value=1;return}s&&this.tremoloLFO.state!=="started"&&this.tremoloLFO.start(e),this.tremoloLFO.frequency.value=o;const a=t.span/100,r=Math.max(0,1-a),c=1;this.tremoloDepth.min=r,this.tremoloDepth.max=c}_setFilter(t){this.wetDryFade.fade.value=t.enabled?1:0;const e=kl(t.cutoff+35).toFrequency(),o=t.resonance/100*12+.1;this.hpFilter.set({frequency:e,Q:o}),this.lpFilterForBP.set({frequency:e,Q:o}),this.lpFilterSolo.set({frequency:e,Q:o});const i=t.blend;i<=1?(this.main_fade.fade.value=0,this.hp_bp_fade.fade.value=i):(this.main_fade.fade.value=i-1,this.hp_bp_fade.fade.value=1)}}const dr={polyphonyReference:32,smoothingTauMs:200,masterGainRampMs:50,gainUpdateIntervalMs:16};function ur(n=dr.polyphonyReference){return 1/Math.sqrt(n)}class Td{masterGain;options;perVoiceBaselineGain;activeVoiceCount=0;smoothedVoiceCount;gainUpdateLoopId=null;constructor(t,e={}){this.masterGain=t,this.options={...dr,...e},this.perVoiceBaselineGain=ur(this.options.polyphonyReference),this.smoothedVoiceCount=this.options.polyphonyReference}start(){this.stop(),this.gainUpdateLoopId=setInterval(()=>this.updateMasterGain(),this.options.gainUpdateIntervalMs)}stop(){this.gainUpdateLoopId!==null&&(clearInterval(this.gainUpdateLoopId),this.gainUpdateLoopId=null)}noteOn(t=1){t<=0||(this.activeVoiceCount+=t)}noteOff(t=1){t<=0||(this.activeVoiceCount=Math.max(0,this.activeVoiceCount-t))}clampActiveVoiceCountToAtMost(t){Number.isFinite(t)&&(this.activeVoiceCount=Math.max(0,Math.min(this.activeVoiceCount,Math.floor(t))))}resetActiveVoiceCount(){this.activeVoiceCount=0}getActiveVoiceCount(){return this.activeVoiceCount}updateMasterGain(){const{polyphonyReference:t,smoothingTauMs:e,masterGainRampMs:o,gainUpdateIntervalMs:i}=this.options,s=Rt();if(this.activeVoiceCount===0){this.smoothedVoiceCount=.01*t+(1-.01)*this.smoothedVoiceCount;return}const a=i/1e3,r=1-Math.exp(-a/(e/1e3)),c=Math.max(1,this.activeVoiceCount);this.smoothedVoiceCount=r*c+(1-r)*this.smoothedVoiceCount;const d=Math.sqrt(t/this.smoothedVoiceCount),u=this.perVoiceBaselineGain*d;this.masterGain.gain.rampTo(u,o/1e3,s)}}const Id={clippingWarningThresholdDb:-3,clippingMonitorIntervalMs:500,clippingWarningCooldownMs:2e3};class Ld{meter;options;clippingMonitorId=null;lastClippingWarningAt=0;constructor(t,e={}){this.meter=t,this.options={...Id,...e}}start(){this.stop(),this.lastClippingWarningAt=0,this.clippingMonitorId=setInterval(()=>{const t=this.meter.getValue(),e=Array.isArray(t)?t[0]:t;if(e===void 0||e<=this.options.clippingWarningThresholdDb)return;const o=Date.now();o-this.lastClippingWarningAt<this.options.clippingWarningCooldownMs||(this.lastClippingWarningAt=o,this.options.onWarning?.(e))},this.options.clippingMonitorIntervalMs)}stop(){this.clippingMonitorId!==null&&(clearInterval(this.clippingMonitorId),this.clippingMonitorId=null)}}function kd(n){const{timbres:t,masterVolume:e=0,effectsManager:o,harmonicFilter:i,logger:s,audioInit:a,getDrumVolume:r}=n,c={};let d=null,u=null,h=null,m=null,g=null,f={},p=null,v=null;const w={...t},y=s??{debug:()=>{},info:()=>{},warn:()=>{}};function C(M){if(i)return i.getFilteredCoefficients(M);const A=w[M];return A?.coeffs?A.coeffs:new Float32Array([0,1])}function P(M){const A=M.reduce((x,k)=>x+Math.abs(k),0);return A>1?Array.from(M).map(x=>x/A):Array.from(M)}const T={init(){this.stopBackgroundMonitors(),d=new je(ur()),p=new Td(d),p.start(),u=new Cs(e),h=new Rl({threshold:-12,ratio:3,attack:.01,release:.1,knee:6}),m=new Bl(-3),g=new Dl,d.connect(u),u.connect(h),h.connect(m),m.toDestination(),m.connect(g),g&&(v=new Ld(g,{onWarning:M=>{y.warn("SynthEngine","Limiter input approaching clipping threshold",{level:M},"audio")}}),v.start());for(const M in w){const A=w[M];if(!A)continue;A.vibrato||(A.vibrato={speed:0,span:0}),A.tremelo||(A.tremelo={speed:0,span:0});const x=C(M),k=P(x),S=A.gain||1,E=new Fl({voice:Pd,options:{oscillator:{type:"custom",partials:k},envelope:A.adsr,filter:A.filter,vibrato:A.vibrato,tremelo:A.tremelo,gain:S}}).connect(d);o&&d&&o.applySynthEffects(E,M,d);const I=E.triggerAttack.bind(E);E.triggerAttack=function(...D){const W=I(...D),G=(D[1]??Rt())+.005;return _n.schedule(()=>{const Y=this._activeVoices;o?Y&&Y.size>0?Y.forEach(O=>{O.effectsApplied||(o.applyEffectsToVoice(O,M),O.effectsApplied=!0)}):this._voices&&Array.isArray(this._voices)&&this._voices.forEach(O=>{O&&!O.effectsApplied&&(o.applyEffectsToVoice(O,M),O.effectsApplied=!0)}):Y&&Y.size>0?Y.forEach(O=>{O._setVibrato&&O.vibratoApplied!==!0&&(O._setVibrato(this._currentVibrato),O.vibratoApplied=!0),O._setTremolo&&O.tremoloApplied!==!0&&(O._setTremolo(this._currentTremolo),O.tremoloApplied=!0)}):this._voices&&Array.isArray(this._voices)&&this._voices.forEach(O=>{O?._setVibrato&&O.vibratoApplied!==!0&&(O._setVibrato(this._currentVibrato),O.vibratoApplied=!0),O?._setTremolo&&O.tremoloApplied!==!0&&(O._setTremolo(this._currentTremolo),O.tremoloApplied=!0)})},G),W},E._currentVibrato=A.vibrato,E._currentTremolo=A.tremelo,E._currentFilter=A.filter,c[M]=E,y.debug("SynthEngine",`Created filtered synth for color: ${M}`,null,"audio")}y.info("SynthEngine","Initialized with multi-timbral support",null,"audio")},updateSynthForColor(M){const A=w[M],x=c[M];if(!x||!A)return;A.vibrato||(A.vibrato={speed:0,span:0}),A.tremelo||(A.tremelo={speed:0,span:0}),y.debug("SynthEngine",`Updating timbre for color ${M}`,null,"audio");const k=C(M),S=P(k);x.set({oscillator:{partials:S},envelope:A.adsr}),o&&d&&o.applySynthEffects(x,M,d),x._currentVibrato=A.vibrato,x._currentTremolo=A.tremelo,x._currentFilter=A.filter;const E=x._activeVoices;E&&E.size>0?E.forEach(I=>{if(I._setFilter&&I._setFilter(A.filter),I._setVibrato&&(I._setVibrato(A.vibrato),I.vibratoApplied=!0),I._setTremolo&&(I._setTremolo(A.tremelo),I.tremoloApplied=!0),I._setPresetGain){const D=A.gain||1;I._setPresetGain(D)}}):x._voices&&Array.isArray(x._voices)&&x._voices.forEach(I=>{if(I?._setVibrato&&(I._setVibrato(A.vibrato),I.vibratoApplied=!0),I?._setTremolo&&(I._setTremolo(A.tremelo),I.tremoloApplied=!0),I?._setFilter&&I._setFilter(A.filter),I?._setPresetGain){const D=A.gain||1;I._setPresetGain(D)}})},setBpm(M){try{rt?.bpm&&(rt.bpm.value=M,y.debug("SynthEngine",`Tone.Transport BPM updated to ${M}`,null,"audio"))}catch(A){y.warn("SynthEngine","Unable to update BPM on Tone.Transport",{tempo:M,error:A},"audio")}},setVolume(M){u&&(u.volume.value=M)},async playNote(M,A,x=Rt()){await(a||(()=>Xo()))();const S=Object.keys(c);if(S.length===0)return;const[E]=S;if(!E)return;const I=c[E];I&&I.triggerAttackRelease(M,A,x)},triggerAttack(M,A,x=Rt(),k=!1){const S=c[A];if(S)if(p?.noteOn(1),k&&r){const E=r(),I=S.volume.value,D=I+20*Math.log10(E);S.volume.value=D,S.triggerAttack(M,x),_n.schedule(()=>{S?.volume&&(S.volume.value=I)},x+.1)}else S.triggerAttack(M,x)},triggerAttackInteractive(M,A){T.triggerAttack(M,A,Rt()+.02)},quickReleasePitches(M,A){const x=c[A];if(!x||!M||M.length===0)return;let k;try{const E=(typeof x.get=="function"?x.get():null)?.envelope?.release;k=typeof E=="number"?E:void 0,x.set({envelope:{release:.01}}),M.forEach(D=>{x.triggerRelease(D,Rt())});const I=x._activeVoices?.size??x._voices?.length??p?.getActiveVoiceCount()??0;p?.clampActiveVoiceCountToAtMost(I)}catch(S){y.warn("SynthEngine","quickReleasePitches failed",{err:S,color:A,pitches:M},"audio")}finally{if(k!==void 0)try{x.set({envelope:{release:k}})}catch{}}},triggerRelease(M,A,x=Rt()){const k=c[A];if(!k)return;k.triggerRelease(M,x),p?.noteOff(1);const S=k._activeVoices?.size??k._voices?.length??p?.getActiveVoiceCount()??0;p?.clampActiveVoiceCountToAtMost(S)},releaseAll(){for(const M in c)c[M]?.releaseAll();p?.resetActiveVoiceCount()},createWaveformAnalyzer(M){const A=c[M];return A?(f[M]||(f[M]=new Nl("waveform",1024),A.connect(f[M]),y.debug("SynthEngine",`Created waveform analyzer for color: ${M}`,null,"waveform")),f[M]):(y.warn("SynthEngine",`No synth found for color: ${M}`,null,"audio"),null)},getWaveformAnalyzer(M){return f[M]||null},getAllWaveformAnalyzers(){const M=new Map;for(const A in f)f[A]&&M.set(A,f[A]);return M},removeWaveformAnalyzer(M){f[M]&&(f[M].dispose(),delete f[M],y.debug("SynthEngine",`Removed waveform analyzer for color: ${M}`,null,"waveform"))},disposeAllWaveformAnalyzers(){for(const M in f)f[M]&&f[M].dispose();f={},y.debug("SynthEngine","Disposed all waveform analyzers",null,"waveform")},getSynth(M){return c[M]||null},getAllSynths(){return{...c}},getMainVolumeNode(){return u||null},getMasterGainNode(){return d||null},stopBackgroundMonitors(){v?.stop(),p?.stop()},dispose(){this.stopBackgroundMonitors(),this.disposeAllWaveformAnalyzers();for(const M in c)c[M]?.dispose();d?.dispose(),u?.dispose(),h?.dispose(),m?.dispose(),g?.dispose(),y.debug("SynthEngine","Disposed SynthEngine",null,"audio")}};return T}const js=1e-4;function Nd(n){const{getMacrobeatInfo:t,getPlacedTonicSigns:e,getTonicSpanColumnIndices:o,updatePlayheadModel:i,logger:s}=n;let a=[],r=0,c=0,d=0;const u=s??{debug:()=>{}};function h(f){return 60/(f*2)}function m(f,p,v){let w=0;u.debug("TimeMapCalculator","[TIMEMAP] Building timeMap",{columnCount:p.length,tonicSignCount:v.length,microbeatDuration:f});const y=p.length,C=o(v);for(let P=0;P<y;P++){a[P]=w;const T=C.has(P);if(T?u.debug("TimeMapCalculator",`[TIMEMAP] Column ${P} is tonic, not advancing time`):w+=(p[P]||0)*f,P<5){const M=a[P];M!==void 0&&u.debug("TimeMapCalculator",`[TIMEMAP] timeMap[${P}] = ${M.toFixed(3)}s (isTonic: ${T})`)}}y>0&&(a[y]=w),u.debug("TimeMapCalculator",`[TIMEMAP] Complete. Total columns: ${y}, Final time: ${w.toFixed(3)}s`)}function g(f){const p=a.length>0?a[a.length-1]??0:0;if(!Number.isFinite(p)||p===0){r=0;return}const v=f.tempoModulationMarkers?.filter(C=>C.active)||[];if(v.length===0){r=p;return}const w=[...v].sort((C,P)=>C.measureIndex-P.measureIndex);let y=p;for(const C of w){const P=t(C.measureIndex);if(P){const T=P.endColumn-1,M=a[T]??p,A=p-M,x=A*C.ratio;y=y-A+x}}r=y}return{getMicrobeatDuration:h,calculate(f){u.debug("TimeMapCalculator","calculate",{tempo:`${f.tempo} BPM`}),a=[];const p=h(f.tempo),{columnWidths:v}=f,w=e();m(p,v,w),u.timing?.("TimeMapCalculator","calculate",{totalDuration:`${a[a.length-1]?.toFixed(2)}s`}),g(f),i?.({timeMap:a,musicalEndTime:r,columnWidths:f.columnWidths,cellWidth:f.cellWidth})},getTimeMap(){return a},getMusicalEndTime(){return r},findNonAnacrusisStart(f){if(!f.hasAnacrusis)return u.debug("TimeMapCalculator","[ANACRUSIS] No anacrusis, starting from time 0"),0;for(let p=0;p<f.macrobeatBoundaryStyles.length;p++)if(f.macrobeatBoundaryStyles[p]==="solid"){const v=t(p+1);if(v){const w=a[v.startColumn]||0;return u.debug("TimeMapCalculator",`[ANACRUSIS] Found solid boundary at macrobeat ${p}, non-anacrusis starts at column ${v.startColumn}, time ${w.toFixed(3)}s`),w}}return u.debug("TimeMapCalculator","[ANACRUSIS] No solid boundary found, starting from time 0"),0},applyModulationToTime(f,p,v){const w=v.tempoModulationMarkers?.filter(P=>P.active)||[];if(w.length===0)return f;const y=[...w].sort((P,T)=>P.measureIndex-T.measureIndex);let C=f;p<5&&u.debug("TimeMapCalculator",`[MODULATION] Column ${p}: baseTime ${f.toFixed(3)}s, ${y.length} active markers`);for(const P of y){const T=t(P.measureIndex);if(T){const M=T.endColumn;if(p>M){const A=a[M]!==void 0?a[M]:0,x=f-A,k=x*P.ratio;C=C-x+k,p<5&&u.debug("TimeMapCalculator",`[MODULATION] Column ${p}: Applied marker at measure ${P.measureIndex} (col ${M}), ratio ${P.ratio}, adjustedTime ${C.toFixed(3)}s`)}}}return C},setLoopBounds(f,p,v){const w=h(v),y=Math.max(w,.001),C=Number.isFinite(f)?f:0;let P=Number.isFinite(p)?p:C+y;P<=C&&(P=C+y),c=C,d=P,rt&&(rt.loopStart=C,rt.loopEnd=P)},getConfiguredLoopBounds(){return{loopStart:c,loopEnd:d}},setConfiguredLoopBounds(f,p){c=f,d=p},clearConfiguredLoopBounds(){c=0,d=0},reapplyConfiguredLoopBounds(f){if(d>c){const p=Nt(rt.loopStart).toSeconds(),v=Nt(rt.loopEnd).toSeconds(),w=Math.abs(p-c),y=Math.abs(v-d);(w>js||y>js)&&(rt.loopStart=c,rt.loopEnd=d),rt.loop!==f&&(rt.loop=f)}},updateLoopBoundsFromTimeline(f){const p=this.findNonAnacrusisStart(f),v=r;this.setLoopBounds(p,v,f.tempo)}}}const Rd={H:"https://tonejs.github.io/audio/drum-samples/CR78/hihat.mp3",M:"https://tonejs.github.io/audio/drum-samples/CR78/snare.mp3",L:"https://tonejs.github.io/audio/drum-samples/CR78/kick.mp3"},Bd=1e-4;function Dd(n={}){const{samples:t=Rd,synthEngine:e,initialVolume:o=0}=n;let i=null,s=null;const a=new Map;function r(c,d){let u=Number.isFinite(d)?d:Rt();const h=a.get(c)??-1/0;return u>h||(u=h+Bd),a.set(c,u),u}if(s=new Cs(o),i=new As(t).connect(s),e){const c=e.getMainVolumeNode?.();c?s.connect(c):s.toDestination()}else s.toDestination();return{getPlayers(){return i},getVolumeNode(){return s},trigger(c,d){if(!i)return;const u=r(c,d);i.player(c)?.start(u)},reset(){a.clear()},dispose(){i?.dispose(),s?.dispose(),i=null,s=null,a.clear()},isLoaded(){return i?.loaded??!1},async waitForLoad(){i&&await i.loaded}}}const Zs="",Ks="";function Fd(n,t){if(n.length<2||t<n[0]||t>=n[n.length-1])return-1;let e=0,o=n.length-2;for(;e<=o;){const i=e+o>>>1,s=n[i],a=n[i+1];if(t>=s&&t<a)return i;t<s?o=i-1:e=i+1}return-1}function Wd(n){const{synthEngine:t,stateCallbacks:e,eventCallbacks:o,visualCallbacks:i,logger:s,audioInit:a,playbackMode:r="standard"}=n,c=s??{debug:()=>{},info:()=>{},warn:()=>{}};let d=null,u=!1,h=null,m=null,g=1;const f=[];function p(S,E){const I=E.fullRowData[S];return I?I.toneNote.replace(Zs,"b").replace(Ks,"#"):"C4"}function v(S,E){const I=S.globalRow??S.row,D=E.fullRowData[I];return D?D.toneNote.replace(Zs,"b").replace(Ks,"#"):"C4"}function w(){if(!h)return;const S=e.getState();c.debug("TransportService","scheduleNotes","Clearing previous transport events and rescheduling all notes"),rt.cancel(),m?.reset(),h.calculate(S),i?.clearAdsrVisuals?.();const E=h.getTimeMap(),{loopEnd:I}=h.getConfiguredLoopBounds(),D=h.findNonAnacrusisStart(S);c.debug("TransportService",`[ANACRUSIS] hasAnacrusis: ${S.hasAnacrusis}, anacrusisOffset: ${D.toFixed(3)}s`),S.placedNotes.forEach((G,Y)=>{const O=G.startColumnIndex,j=G.endColumnIndex,at=E[O];if(at===void 0){c.warn("TransportService",`[NOTE SCHEDULE] Note ${Y}: timeMap[${O}] undefined, skipping`);return}const ft=h.applyModulationToTime(at,O,S),gt=E[j+1];if(gt===void 0){c.warn("TransportService",`Skipping note with invalid endColumnIndex: ${G.endColumnIndex+1}`);return}const L=h.applyModulationToTime(gt,j+1,S)-ft;G.isDrum?y(G,ft):C(G,ft,L,I,S)});const W=e.getStampPlaybackData?.()??[];W.forEach(G=>{P(G,E,S)});const Q=e.getTripletPlaybackData?.()??[];Q.forEach(G=>{T(G,E,S)}),c.debug("TransportService","scheduleNotes",`Finished scheduling ${S.placedNotes.length} notes, ${W.length} stamps, and ${Q.length} triplets`)}function y(S,E){const I=e.getState();rt.schedule(D=>{if(I.isPaused)return;const W=S.drumTrack;if(W==null)return;const Q=String(W);m?.trigger(Q,D),_n.schedule(()=>{i?.triggerDrumNotePop?.(S.startColumnIndex,W)},D)},E)}function C(S,E,I,D,W){const Q=v(S,W),G=S.color,Y=S.globalRow??S.row,O=W.fullRowData[Y]?.hex||"#888888",j=S.uuid,at=W.timbres[G];if(!at){c.warn("TransportService",`Timbre not found for color ${G}. Skipping note ${j}`);return}let ft=E+I;const nt=D-.001;ft>=D&&(ft=Math.max(E+.001,nt)),rt.schedule(L=>{e.getState().isPaused||(t.triggerAttack(Q,G,L),_n.schedule(()=>{i?.triggerAdsrVisual?.(j,"attack",O,at.adsr),o.emit("noteAttack",{noteId:j,color:G})},L))},E),rt.schedule(L=>{t.triggerRelease(Q,G,L),_n.schedule(()=>{i?.triggerAdsrVisual?.(j,"release",O,at.adsr),o.emit("noteRelease",{noteId:j,color:G})},L)},ft)}function P(S,E,I){const D=S.column,W=E[D];if(W===void 0)return;(e.getStampScheduleEvents?.(S.sixteenthStampId,S.placement)??[]).forEach(G=>{M(G,W,S.row,S.color,I)})}function T(S,E,I){const D=e.timeToCanvas?.(S.startTimeIndex,I)??S.startTimeIndex,W=E[D];if(W===void 0)return;(e.getTripletScheduleEvents?.(S.tripletStampId,S.placement)??[]).forEach(G=>{M(G,W,S.row,S.color,I)})}function M(S,E,I,D,W){const Q=Nt(S.offset).toSeconds(),G=Nt(S.duration).toSeconds(),Y=E+Q,O=Y+G,j=I+S.rowOffset,at=p(j,W);rt.schedule(ft=>{e.getState().isPaused||t.triggerAttack(at,D,ft)},Y),rt.schedule(ft=>{e.getState().isPaused||t.triggerRelease(at,D,ft)},O)}function A(){const E=e.getState().tempo,I=1e-4,D=.5,W=Y=>Y?.xPosition??477.5,Q=typeof rt?.bpm?.value=="number"?rt.bpm.value:E;g=E!==0?Q/E:1,u=!0;function G(){if(!u||!h)return;if(rt.state==="stopped"){d=requestAnimationFrame(G);return}const Y=e.getState(),O=Nt(rt.loopEnd).toSeconds(),j=Y.isLooping,at=h.getMusicalEndTime(),ft=j&&O>0?O:at,gt=rt.seconds,nt=gt*1e3,L=gt>=ft-.001;if(!j&&L){c.info("TransportService","Playback reached end. Stopping playhead."),k.stop();return}if(Y.isPaused){d=requestAnimationFrame(G);return}const z=h.getTimeMap();i?.clearPlayheadCanvas?.(),i?.clearDrumPlayheadCanvas?.();let U=gt;if(j){const dt=Nt(rt.loopStart).toSeconds(),ut=Nt(rt.loopEnd).toSeconds()-dt;ut>0&&(U=(gt-dt)%ut+dt)}const B=e.getCanvasWidth?.()??1e3,F=e.getPlacedTonicSigns?.()??[],Z=e.getTonicSpanColumnIndices?.(F)??new Set;let N=0,H=0,R=0,$=-1;const q=Fd(z,U);if(q>=0){const dt=z[q],bt=z[q+1];let ut=q;for(;Z.has(ut)&&ut<z.length-1;)ut++;const K=e.getColumnStartX?.(ut)??0,st=e.getColumnWidth?.(ut)??10;if(H=K,R=st,$=ut,Z.has(q))N=K;else{const ct=bt-dt,At=U-dt,xt=ct>0?At/ct:0;N=K+xt*st}}const X=Math.min(N,B);x(Y,X,E,W,I,D);const tt=i?.getPlayheadCanvasHeight?.()??500,_=i?.getDrumCanvasHeight?.()??100,it=Y.playheadMode==="macrobeat"&&$>=0?e.getMacrobeatHighlightRect?.($):null,et=it?.x??H,ot=it?.width??R;X>=0&&(Y.playheadMode==="macrobeat"||Y.playheadMode==="microbeat"?(i?.drawPlayheadHighlight?.(et,ot,tt,nt),i?.drawDrumPlayheadHighlight?.(et,ot,_,nt)):(i?.drawPlayheadLine?.(X,tt),i?.drawDrumPlayheadLine?.(X,_)));const ht=Y.playheadMode==="macrobeat"||Y.playheadMode==="microbeat";i?.updateBeatLineHighlight?.(et,ot,ht),d=requestAnimationFrame(G)}G()}function x(S,E,I,D,W,Q){if(!h)return;const Y=(Array.isArray(S.tempoModulationMarkers)?S.tempoModulationMarkers:[]).filter(O=>O?.active&&typeof O.ratio=="number"&&O.ratio!==0).sort((O,j)=>D(O)-D(j));if(Y.length>0){let O=1;for(const j of Y){const at=D(j);if(E+Q>=at)O*=1/j.ratio;else break}if((!Number.isFinite(O)||O<=0)&&(O=1),Math.abs(O-g)>W){const j=I*O;rt.bpm.value=j,h.reapplyConfiguredLoopBounds(S.isLooping),g=O,c.debug("TransportService",`Tempo multiplier updated to ${O.toFixed(3)} (${j.toFixed(2)} BPM)`)}}else Math.abs(g-1)>W&&(rt.bpm.value=I,h.reapplyConfiguredLoopBounds(S.isLooping),g=1,c.debug("TransportService",`Tempo reset to base ${I} BPM`))}const k={init(){const S=e.getState();h=Nd({getMacrobeatInfo:e.getMacrobeatInfo??(()=>null),getPlacedTonicSigns:e.getPlacedTonicSigns??(()=>[]),getTonicSpanColumnIndices:e.getTonicSpanColumnIndices??(()=>new Set),logger:c}),m=Dd({samples:{H:"https://tonejs.github.io/audio/drum-samples/CR78/hihat.mp3",M:"https://tonejs.github.io/audio/drum-samples/CR78/snare.mp3",L:"https://tonejs.github.io/audio/drum-samples/CR78/kick.mp3"},synthEngine:{getMainVolumeNode:()=>t.getMainVolumeNode()}}),rt.bpm.value=S.tempo;const E=()=>this.handleStateChange(),I=()=>this.handleStateChange(),D=()=>this.handleStateChange(),W=()=>{if(h&&h.getTimeMap().length>0){const O=e.getState();h.calculate(O)}this.handleStateChange()},Q=O=>{const j=O?.oldConfig?.columnWidths||[],at=O?.newConfig?.columnWidths||[];j.length!==at.length&&h&&h.calculate(e.getState())},G=O=>{if(c.info("TransportService",`tempoChanged triggered with new value: ${O} BPM`),rt.state==="started"){const j=rt.position;rt.pause(),d&&(cancelAnimationFrame(d),d=null),rt.bpm.value=O,h?.reapplyConfiguredLoopBounds(e.getState().isLooping),w(),rt.start(void 0,j),r==="standard"&&A()}else rt.bpm.value=O,h?.reapplyConfiguredLoopBounds(e.getState().isLooping),h?.calculate(e.getState())},Y=O=>{rt.loop=O;const j=Nt(rt.loopStart).toSeconds(),at=Nt(rt.loopEnd).toSeconds();O&&at<=j&&h&&(rt.loopEnd=j+Math.max(h.getMicrobeatDuration(e.getState().tempo),.001)),O&&h?h.setConfiguredLoopBounds(Nt(rt.loopStart).toSeconds(),Nt(rt.loopEnd).toSeconds()):h?.clearConfiguredLoopBounds()};o.on("rhythmStructureChanged",E),o.on("notesChanged",I),o.on("sixteenthStampPlacementsChanged",D),o.on("tempoModulationMarkersChanged",W),o.on("layoutConfigChanged",Q),o.on("tempoChanged",G),o.on("loopingChanged",Y),f.push(()=>{}),rt.on("stop",()=>{c.info("TransportService","Tone.Transport 'stop' fired. Resetting playback state"),o.setPlaybackState?.(!1,!1),i?.clearAdsrVisuals?.(),d&&(cancelAnimationFrame(d),d=null)}),c.info("TransportService","Initialized")},handleStateChange(){if(rt.state==="started"){c.debug("TransportService","handleStateChange: Notes or rhythm changed during playback. Rescheduling");const E=rt.position;rt.pause(),w(),rt.start(void 0,E)}else h?.calculate(e.getState())},start(){c.info("TransportService","Starting playback"),(a||(()=>Xo()))().then(async()=>{Pe.state!=="running"&&await Pe.resume(),m&&await m.waitForLoad();const E=e.getState();h?.calculate(E);const I=h?.getMusicalEndTime()??0,D=h?.findNonAnacrusisStart(E)??0;h?.setLoopBounds(D,I,E.tempo),rt.bpm.value=E.tempo,w();const W=Rt()+.1;rt.start(W,0),r==="standard"&&A(),o.emit("playbackStarted")})},resume(){c.info("TransportService","Resuming playback"),(a||(()=>Xo()))().then(async()=>{Pe.state!=="running"&&await Pe.resume(),rt.start(),r==="standard"&&A(),o.emit("playbackResumed")})},pause(){c.info("TransportService","Pausing playback"),rt.pause(),d&&(cancelAnimationFrame(d),d=null),o.emit("playbackPaused")},stop(){c.info("TransportService","Stopping playback and clearing visuals"),u=!1,d&&(cancelAnimationFrame(d),d=null),rt.stop(),rt.cancel(),m?.reset();const S=e.getState();rt.bpm.value=S.tempo,h?.reapplyConfiguredLoopBounds(S.isLooping),t.releaseAll(),i?.clearPlayheadCanvas?.(),i?.clearDrumPlayheadCanvas?.(),i?.updateBeatLineHighlight?.(0,0,!1),o.emit("playbackStopped")},dispose(){this.stop(),m?.dispose(),f.forEach(S=>S()),c.debug("TransportService","Disposed")}};return k}const Od={latencyHint:"playback",lookAhead:.1};function _d(n={}){const{latencyHint:t,lookAhead:e}={...Od,...n};let o=!1;if(Pe.state==="suspended")try{Wl(new Ol({latencyHint:t})),o=!0}catch(i){console.warn("Failed to create new AudioContext, using default:",i)}return e!==void 0&&(Pe.lookAhead=e),o}class zd{logLevel;enabledLevels;categories;constructor(){this.logLevel="ERROR",this.enabledLevels={DEBUG:!1,INFO:!1,WARN:!1,ERROR:!0},this.categories={general:!1,state:!1,canvas:!1,audio:!1,ui:!1,layout:!1,harmony:!1,performance:!1,initialization:!1,transport:!1,grid:!1,toolbar:!1,zoom:!1,scroll:!1,keyboard:!1,mouse:!1,adsr:!1,filter:!1,waveform:!1,debug:!1}}enable(...t){t.forEach(e=>{Object.prototype.hasOwnProperty.call(this.categories,e)&&(this.categories[e]=!0)})}disable(...t){t.forEach(e=>{Object.prototype.hasOwnProperty.call(this.categories,e)&&(this.categories[e]=!1)})}enableAll(){Object.keys(this.categories).forEach(t=>{this.categories[t]=!0}),this.setLevel("DEBUG")}disableAll(){Object.keys(this.categories).forEach(t=>{this.categories[t]=!1}),this.setLevel("ERROR")}isCategoryEnabled(t){return this.categories[t]===!0}setLevel(t){const o=["DEBUG","INFO","WARN","ERROR"].indexOf(t);o!==-1&&(this.logLevel=t,this.enabledLevels={DEBUG:o<=0,INFO:o<=1,WARN:o<=2,ERROR:o<=3})}logWithConsole(t,e,o,i=null){if(typeof console<"u"&&console[t]){const s=i!==null?[e,o,i]:[e,o];console[t](...s)}}event(t,e,o="",i="ui"){!this.enabledLevels.INFO||this.isCategoryEnabled(i)}state(t,e,o=null,i="state"){!this.enabledLevels.INFO||this.isCategoryEnabled(i)}debug(t,e,o=null,i="debug"){!this.enabledLevels.DEBUG||!this.isCategoryEnabled(i)||this.logWithConsole("debug",t,e,o)}timing(t,e,o,i="performance"){!this.enabledLevels.DEBUG||!this.isCategoryEnabled(i)||this.logWithConsole("debug",t,e,o)}warn(t,e,o=null,i="general"){!this.enabledLevels.WARN||!this.isCategoryEnabled(i)||this.logWithConsole("warn",t,e,o)}error(t,e,o=null,i="general"){this.enabledLevels.ERROR&&this.logWithConsole("error",t,e,o)}info(t,e,o=null,i="general"){!this.enabledLevels.INFO||!this.isCategoryEnabled(i)||this.logWithConsole("info",t,e,o)}getConfig(){return{logLevel:this.logLevel,enabledLevels:{...this.enabledLevels},enabledCategories:Object.entries(this.categories).filter(([,t])=>t).map(([t])=>t)}}getAvailableCategories(){return Object.keys(this.categories)}section(t){this.enabledLevels.INFO&&this.info("Logger",`===== ${t} =====`,null,"general")}initStart(t){this.enabledLevels.INFO&&this.info(t,"init start",null,"initialization")}initSuccess(t){this.enabledLevels.INFO&&this.info(t,"init success",null,"initialization")}initFailed(t,e){if(this.enabledLevels.ERROR){const o=e?`init failed: ${e}`:"init failed";this.error(t,o,null,"initialization")}}moduleLoaded(t,e="initialization"){this.isCategoryEnabled(e)&&this.enabledLevels.INFO&&this.info(t,"loaded",null,e)}log(t,e,o=null){this.info(t,e,o,"general")}}const b=new zd;typeof window<"u"&&(window.logger=b);b.moduleLoaded("EngineStore","general");function Js(){return{entries:[],visualToCanvas:new Map,visualToTime:new Map,canvasToVisual:new Map,canvasToTime:new Map,timeToCanvas:new Map,timeToVisual:new Map,macrobeatBoundaries:[],totalVisualColumns:0,totalCanvasColumns:0,totalTimeColumns:0,totalWidthUnmodulated:0}}const $d="studentNotationState",Hd={getItem:n=>localStorage.getItem(n),setItem:(n,t)=>localStorage.setItem(n,t),removeItem:n=>localStorage.removeItem(n)},po=(n,t,e,o,i)=>{const s=i||"general";switch(n){case"debug":b.debug(t,e,o,s);break;case"info":b.info(t,e,o,s);break;case"warn":b.warn(t,e,o,s);break;case"error":b.error(t,e,o,s);break}};let le={};function qd(n){le=n,b.info("EngineStore","Column map callbacks registered")}const l=Ed({storageKey:$d,storage:Hd,onClearState:()=>{localStorage.removeItem("effectDialValues"),window.location.reload()},noteActionCallbacks:{getMacrobeatInfo:(n,t)=>{const e=n.macrobeatGroupings||[];let o=0;for(let s=0;s<t&&s<e.length;s++)o+=e[s]||2;const i=o+(e[t]||2)-1;return{startColumn:o,endColumn:i}},log:(n,t,e)=>po(n,"noteActions",t,e)},rhythmActionCallbacks:{getColumnMap:n=>le.getColumnMap?le.getColumnMap(n):Js(),visualToTimeIndex:(n,t,e)=>le.visualToTimeIndex?le.visualToTimeIndex(n,t,e):t,timeIndexToVisualColumn:(n,t,e)=>le.timeIndexToVisualColumn?le.timeIndexToVisualColumn(n,t,e):t,getTimeBoundaryAfterMacrobeat:(n,t,e)=>{if(le.getTimeBoundaryAfterMacrobeat)return le.getTimeBoundaryAfterMacrobeat(n,t,e);let o=0;for(let i=0;i<=t&&i<e.length;i++)o+=e[i]||2;return o},log:po},sixteenthStampActionCallbacks:{log:(n,t,e)=>po(n,"sixteenthStampActions",t,e)},tripletStampActionCallbacks:{canvasToTime:(n,t)=>t.canvasToTime.get(n)??null,timeToCanvas:(n,t)=>t.timeToCanvas.get(n)??n,getColumnMap:n=>le.getColumnMap?le.getColumnMap(n):Js(),log:(n,t,e)=>po(n,"tripletStampActions",t,e)}}),Me=[{pitch:"C8",flatName:"C8",sharpName:"C8",toneNote:"C8",frequency:4186.01,column:"A",hex:"#fcfcfc",isAccidental:!1},{pitch:"B7",flatName:"B7",sharpName:"B7",toneNote:"B7",frequency:3951.07,column:"B",hex:"#fcf7fc",isAccidental:!1},{pitch:"B/A7",flatName:"B7",sharpName:"A7",toneNote:"Bb7",frequency:3729.31,column:"A",hex:"#f7f5fd",isAccidental:!0},{pitch:"A7",flatName:"A7",sharpName:"A7",toneNote:"A7",frequency:3520,column:"B",hex:"#f0f4ff",isAccidental:!1},{pitch:"A/G7",flatName:"A7",sharpName:"G7",toneNote:"Ab7",frequency:3322.44,column:"A",hex:"#e6f3fd",isAccidental:!0},{pitch:"G7",flatName:"G7",sharpName:"G7",toneNote:"G7",frequency:3135.96,column:"B",hex:"#def3f7",isAccidental:!1},{pitch:"G/F7",flatName:"G7",sharpName:"F7",toneNote:"Gb7",frequency:2959.96,column:"A",hex:"#daf2ec",isAccidental:!0},{pitch:"F7",flatName:"F7",sharpName:"F7",toneNote:"F7",frequency:2793.83,column:"B",hex:"#dcefdf",isAccidental:!1},{pitch:"E7",flatName:"E7",sharpName:"E7",toneNote:"E7",frequency:2637.02,column:"A",hex:"#e3ebd1",isAccidental:!1},{pitch:"E/D7",flatName:"E7",sharpName:"D7",toneNote:"Eb7",frequency:2489.02,column:"B",hex:"#eee4c8",isAccidental:!0},{pitch:"D7",flatName:"D7",sharpName:"D7",toneNote:"D7",frequency:2349.32,column:"A",hex:"#f8dcc6",isAccidental:!1},{pitch:"D/C7",flatName:"D7",sharpName:"C7",toneNote:"Db7",frequency:2217.46,column:"B",hex:"#fcd4cd",isAccidental:!0},{pitch:"C7",flatName:"C7",sharpName:"C7",toneNote:"C7",frequency:2093,column:"A",hex:"#facfdb",isAccidental:!1},{pitch:"B6",flatName:"B6",sharpName:"B6",toneNote:"B6",frequency:1975.53,column:"B",hex:"#efcdeb",isAccidental:!1},{pitch:"B/A6",flatName:"B6",sharpName:"A6",toneNote:"Bb6",frequency:1864.66,column:"A",hex:"#ddcff9",isAccidental:!0},{pitch:"A6",flatName:"A6",sharpName:"A6",toneNote:"A6",frequency:1760,column:"B",hex:"#c4d3ff",isAccidental:!1},{pitch:"A/G6",flatName:"A6",sharpName:"G6",toneNote:"Ab6",frequency:1661.22,column:"A",hex:"#abd9fa",isAccidental:!0},{pitch:"G6",flatName:"G6",sharpName:"G6",toneNote:"G6",frequency:1567.94,column:"B",hex:"#98dde9",isAccidental:!1},{pitch:"G/F6",flatName:"G6",sharpName:"F6",toneNote:"Gb6",frequency:1479.98,column:"A",hex:"#96ddcf",isAccidental:!0},{pitch:"F6",flatName:"F6",sharpName:"F6",toneNote:"F6",frequency:1396.91,column:"B",hex:"#a6d9b0",isAccidental:!1},{pitch:"E6",flatName:"E6",sharpName:"E6",toneNote:"E6",frequency:1318.51,column:"A",hex:"#c0d093",isAccidental:!1},{pitch:"E/D6",flatName:"E6",sharpName:"D6",toneNote:"Eb6",frequency:1244.51,column:"B",hex:"#dbc383",isAccidental:!0},{pitch:"D6",flatName:"D6",sharpName:"D6",toneNote:"D6",frequency:1174.66,column:"A",hex:"#efb586",isAccidental:!1},{pitch:"D/C6",flatName:"D6",sharpName:"C6",toneNote:"Db6",frequency:1108.73,column:"B",hex:"#f8a99c",isAccidental:!0},{pitch:"C6",flatName:"C6",sharpName:"C6",toneNote:"C6",frequency:1046.5,column:"A",hex:"#f3a2bb",isAccidental:!1},{pitch:"B5",flatName:"B5",sharpName:"B5",toneNote:"B5",frequency:987.77,column:"B",hex:"#e1a3db",isAccidental:!1},{pitch:"B/A5",flatName:"B5",sharpName:"A5",toneNote:"Bb5",frequency:932.33,column:"A",hex:"#c3a9f4",isAccidental:!0},{pitch:"A5",flatName:"A5",sharpName:"A5",toneNote:"A5",frequency:880,column:"B",hex:"#9ab2ff",isAccidental:!1},{pitch:"A/G5",flatName:"A5",sharpName:"G5",toneNote:"Ab5",frequency:830.61,column:"A",hex:"#67bdf7",isAccidental:!0},{pitch:"G5",flatName:"G5",sharpName:"G5",toneNote:"G5",frequency:783.99,column:"B",hex:"#30c6dc",isAccidental:!1},{pitch:"G/F5",flatName:"G5",sharpName:"F5",toneNote:"Gb5",frequency:739.99,column:"A",hex:"#32c8b2",isAccidental:!0},{pitch:"F5",flatName:"F5",sharpName:"F5",toneNote:"F5",frequency:698.46,column:"B",hex:"#6dc281",isAccidental:!1},{pitch:"E5",flatName:"E5",sharpName:"E5",toneNote:"E5",frequency:659.25,column:"A",hex:"#a0b556",isAccidental:!1},{pitch:"E/D5",flatName:"E5",sharpName:"D5",toneNote:"Eb5",frequency:622.25,column:"B",hex:"#c5a33f",isAccidental:!0},{pitch:"D5",flatName:"D5",sharpName:"D5",toneNote:"D5",frequency:587.33,column:"A",hex:"#dc9150",isAccidental:!1},{pitch:"D/C5",flatName:"D5",sharpName:"C5",toneNote:"Db5",frequency:554.37,column:"B",hex:"#e38475",isAccidental:!0},{pitch:"C5",flatName:"C5",sharpName:"C5",toneNote:"C5",frequency:523.25,column:"A",hex:"#dc7f9d",isAccidental:!1},{pitch:"B4",flatName:"B4",sharpName:"B4",toneNote:"B4",frequency:493.88,column:"B",hex:"#c781c0",isAccidental:!1},{pitch:"B/A4",flatName:"B4",sharpName:"A4",toneNote:"Bb4",frequency:466.16,column:"A",hex:"#a68ad8",isAccidental:!0},{pitch:"A4",flatName:"A4",sharpName:"A4",toneNote:"A4",frequency:440,column:"B",hex:"#7d94e0",isAccidental:!1},{pitch:"A/G4",flatName:"A4",sharpName:"G4",toneNote:"Ab4",frequency:415.3,column:"A",hex:"#4c9fd5",isAccidental:!0},{pitch:"G4",flatName:"G4",sharpName:"G4",toneNote:"G4",frequency:392,column:"B",hex:"#0fa6ba",isAccidental:!1},{pitch:"G/F4",flatName:"G4",sharpName:"F4",toneNote:"Gb4",frequency:369.99,column:"A",hex:"#24a794",isAccidental:!0},{pitch:"F4",flatName:"F4",sharpName:"F4",toneNote:"F4",frequency:349.23,column:"B",hex:"#5aa26a",isAccidental:!1},{pitch:"E4",flatName:"E4",sharpName:"E4",toneNote:"E4",frequency:329.63,column:"A",hex:"#849646",isAccidental:!1},{pitch:"E/D4",flatName:"E4",sharpName:"D4",toneNote:"Eb4",frequency:311.13,column:"B",hex:"#a38733",isAccidental:!0},{pitch:"D4",flatName:"D4",sharpName:"D4",toneNote:"D4",frequency:293.66,column:"A",hex:"#b67740",isAccidental:!1},{pitch:"D/C4",flatName:"D4",sharpName:"C4",toneNote:"Db4",frequency:277.18,column:"B",hex:"#bc6c5f",isAccidental:!0},{pitch:"C4",flatName:"C4",sharpName:"C4",toneNote:"C4",frequency:261.63,column:"A",hex:"#b56880",isAccidental:!1},{pitch:"B3",flatName:"B3",sharpName:"B3",toneNote:"B3",frequency:246.94,column:"B",hex:"#a3699e",isAccidental:!1},{pitch:"B/A3",flatName:"B3",sharpName:"A3",toneNote:"Bb3",frequency:233.08,column:"A",hex:"#8870b1",isAccidental:!0},{pitch:"A3",flatName:"A3",sharpName:"A3",toneNote:"A3",frequency:220,column:"B",hex:"#6578b7",isAccidental:!1},{pitch:"A/G3",flatName:"A3",sharpName:"G3",toneNote:"Ab3",frequency:207.65,column:"A",hex:"#3c81ad",isAccidental:!0},{pitch:"G3",flatName:"G3",sharpName:"G3",toneNote:"G3",frequency:196,column:"B",hex:"#0e8696",isAccidental:!1},{pitch:"G/F3",flatName:"G3",sharpName:"F3",toneNote:"Gb3",frequency:185,column:"A",hex:"#1b8777",isAccidental:!0},{pitch:"F3",flatName:"F3",sharpName:"F3",toneNote:"F3",frequency:174.61,column:"B",hex:"#478255",isAccidental:!1},{pitch:"E3",flatName:"E3",sharpName:"E3",toneNote:"E3",frequency:164.81,column:"A",hex:"#697836",isAccidental:!1},{pitch:"E/D3",flatName:"E3",sharpName:"D3",toneNote:"Eb3",frequency:155.56,column:"B",hex:"#836b27",isAccidental:!0},{pitch:"D3",flatName:"D3",sharpName:"D3",toneNote:"D3",frequency:146.83,column:"A",hex:"#925e32",isAccidental:!1},{pitch:"D/C3",flatName:"D3",sharpName:"C3",toneNote:"Db3",frequency:138.59,column:"B",hex:"#96554b",isAccidental:!0},{pitch:"C3",flatName:"C3",sharpName:"C3",toneNote:"C3",frequency:130.81,column:"A",hex:"#905165",isAccidental:!1},{pitch:"B2",flatName:"B2",sharpName:"B2",toneNote:"B2",frequency:123.47,column:"B",hex:"#80527c",isAccidental:!1},{pitch:"B/A2",flatName:"B2",sharpName:"A2",toneNote:"Bb2",frequency:116.54,column:"A",hex:"#6a578c",isAccidental:!0},{pitch:"A2",flatName:"A2",sharpName:"A2",toneNote:"A2",frequency:110,column:"B",hex:"#4e5e90",isAccidental:!1},{pitch:"A/G2",flatName:"A2",sharpName:"G2",toneNote:"Ab2",frequency:103.83,column:"A",hex:"#2d6488",isAccidental:!0},{pitch:"G2",flatName:"G2",sharpName:"G2",toneNote:"G2",frequency:98,column:"B",hex:"#096875",isAccidental:!1},{pitch:"G/F2",flatName:"G2",sharpName:"F2",toneNote:"Gb2",frequency:92.5,column:"A",hex:"#13685b",isAccidental:!0},{pitch:"F2",flatName:"F2",sharpName:"F2",toneNote:"F2",frequency:87.31,column:"B",hex:"#356440",isAccidental:!1},{pitch:"E2",flatName:"E2",sharpName:"E2",toneNote:"E2",frequency:82.41,column:"A",hex:"#505c28",isAccidental:!1},{pitch:"E/D2",flatName:"E2",sharpName:"D2",toneNote:"Eb2",frequency:77.78,column:"B",hex:"#63511c",isAccidental:!0},{pitch:"D2",flatName:"D2",sharpName:"D2",toneNote:"D2",frequency:73.42,column:"A",hex:"#6e4724",isAccidental:!1},{pitch:"D/C2",flatName:"D2",sharpName:"C2",toneNote:"Db2",frequency:69.3,column:"B",hex:"#713f37",isAccidental:!0},{pitch:"C2",flatName:"C2",sharpName:"C2",toneNote:"C2",frequency:65.41,column:"A",hex:"#6c3c4b",isAccidental:!1},{pitch:"B1",flatName:"B1",sharpName:"B1",toneNote:"B1",frequency:61.74,column:"B",hex:"#603c5d",isAccidental:!1},{pitch:"B/A1",flatName:"B1",sharpName:"A1",toneNote:"Bb1",frequency:58.27,column:"A",hex:"#4e4068",isAccidental:!0},{pitch:"A1",flatName:"A1",sharpName:"A1",toneNote:"A1",frequency:55,column:"B",hex:"#38446b",isAccidental:!1},{pitch:"A/G1",flatName:"A1",sharpName:"G1",toneNote:"Ab1",frequency:51.91,column:"A",hex:"#1f4964",isAccidental:!0},{pitch:"G1",flatName:"G1",sharpName:"G1",toneNote:"G1",frequency:49,column:"B",hex:"#044b55",isAccidental:!1},{pitch:"G/F1",flatName:"G1",sharpName:"F1",toneNote:"Gb1",frequency:46.25,column:"A",hex:"#0c4b41",isAccidental:!0},{pitch:"F1",flatName:"F1",sharpName:"F1",toneNote:"F1",frequency:43.65,column:"B",hex:"#24472c",isAccidental:!1},{pitch:"E1",flatName:"E1",sharpName:"E1",toneNote:"E1",frequency:41.2,column:"A",hex:"#38401a",isAccidental:!1},{pitch:"E/D1",flatName:"E1",sharpName:"D1",toneNote:"Eb1",frequency:38.89,column:"B",hex:"#463811",isAccidental:!0},{pitch:"D1",flatName:"D1",sharpName:"D1",toneNote:"D1",frequency:36.71,column:"A",hex:"#4d3017",isAccidental:!1},{pitch:"D/C1",flatName:"D1",sharpName:"C1",toneNote:"Db1",frequency:34.65,column:"B",hex:"#4f2a24",isAccidental:!0},{pitch:"C1",flatName:"C1",sharpName:"C1",toneNote:"C1",frequency:32.7,column:"A",hex:"#4a2733",isAccidental:!1},{pitch:"B0",flatName:"B0",sharpName:"B0",toneNote:"B0",frequency:30.87,column:"B",hex:"#41273f",isAccidental:!1},{pitch:"B/A0",flatName:"B0",sharpName:"A0",toneNote:"Bb0",frequency:29.14,column:"A",hex:"#342a46",isAccidental:!0},{pitch:"A0",flatName:"A0",sharpName:"A0",toneNote:"A0",frequency:27.5,column:"B",hex:"#242c48",isAccidental:!1}],Gd=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"],Gt=n=>n.tonicSignGroups?Object.values(n.tonicSignGroups).flat():[],Zt=(n,t)=>{const e=Ft.getColumnMap(n),{macrobeatGroupings:o}=n,i=o[t]??0;let s=null,a=null;for(const r of e.entries)r.macrobeatIndex===t&&r.type==="beat"&&((s===null||r.canvasIndex!==null&&r.canvasIndex<s)&&(s=r.canvasIndex),(a===null||r.canvasIndex!==null&&r.canvasIndex>a)&&(a=r.canvasIndex));if(s===null||a===null){let r=0;const c=Gt(n);c.some(d=>d.preMacrobeatIndex===-1)&&(r+=2);for(let d=0;d<t;d++)r+=o[d]??0,c.some(u=>u.preMacrobeatIndex===d)&&(r+=2);s=r,a=s+i-1}return{startColumn:s,endColumn:a,grouping:i}},Vd=n=>n.placedNotes.filter(t=>!t.isDrum),Ud=n=>n.placedNotes.filter(t=>t.isDrum),Xd=(n,t)=>{const o=Gt(n).filter(d=>d.columnIndex<=t);if(o.length===0)return{keyTonic:"C",keyMode:"major"};const i=o.reduce((d,u)=>u.columnIndex>d.columnIndex?u:d),s=typeof i.globalRow=="number"?i.globalRow:i.row,a=Me[s]??n.fullRowData[i.row];if(!a)return{keyTonic:"C",keyMode:"major"};const r=Hi(a.toneNote),c=Gd[i.tonicNumber-1]||"major";return{keyTonic:r,keyMode:c}},wn=12,Yd=50,Qd=.5,de=3,go=1,Hn=30,Kn=30,Jn=.5,ta=3,jd=.7,Zd=.9,Kd=4,Jd=1.5,tu=.15,eu=.2,nu=1,to=1.5,ou="#CCCCCC",hr=1,ea=3,na=5,iu=7,Do=16,su=0,au=255;class ru{cachedMap=null;cacheKey=null;getColumnMap(t){const e=this.buildCacheKey(t);return this.cachedMap&&this.isCacheValid(e)?this.cachedMap:(this.cachedMap=this.buildColumnMap(t),this.cacheKey=e,this.cachedMap)}invalidate(){this.cachedMap=null,this.cacheKey=null}buildCacheKey(t){const o=Gt(t).map(i=>`${i.columnIndex}:${i.preMacrobeatIndex}:${i.uuid||""}`).sort().join("|");return{macrobeatGroupings:[...t.macrobeatGroupings],tonicSignsHash:o,macrobeatBoundaryStyles:[...t.macrobeatBoundaryStyles]}}isCacheValid(t){return this.cacheKey?this.cacheKey.tonicSignsHash===t.tonicSignsHash&&JSON.stringify(this.cacheKey.macrobeatGroupings)===JSON.stringify(t.macrobeatGroupings)&&JSON.stringify(this.cacheKey.macrobeatBoundaryStyles)===JSON.stringify(t.macrobeatBoundaryStyles):!1}buildColumnMap(t){const{macrobeatGroupings:e,macrobeatBoundaryStyles:o}=t,s=[...Gt(t)].sort((T,M)=>T.preMacrobeatIndex-M.preMacrobeatIndex),a=[],r=[];let c=0,d=0,u=0,h=0,m=0;const g=T=>{for(;m<s.length;){const M=s[m];if(!M||M.preMacrobeatIndex!==T)break;const A=M.uuid||"";for(let k=0;k<2;k++)a.push({visualIndex:c,canvasIndex:d,timeIndex:null,type:"tonic",widthMultiplier:go,xOffsetUnmodulated:h,macrobeatIndex:null,beatInMacrobeat:null,isMacrobeatStart:!1,isMacrobeatEnd:!1,isPlayable:!1,tonicSignUuid:k===0?A:null}),c++,d++,h+=go;const x=A;do m++;while(m<s.length&&(s[m]?.uuid||"")===x)}};for(let T=0;T<2;T++)a.push({visualIndex:c,canvasIndex:null,timeIndex:null,type:"legend-left",widthMultiplier:de,xOffsetUnmodulated:h,macrobeatIndex:null,beatInMacrobeat:null,isMacrobeatStart:!1,isMacrobeatEnd:!1,isPlayable:!1,tonicSignUuid:null}),c++,h+=de;g(-1),e.forEach((T,M)=>{for(let x=0;x<T;x++)a.push({visualIndex:c,canvasIndex:d,timeIndex:u,type:"beat",widthMultiplier:go,xOffsetUnmodulated:h,macrobeatIndex:M,beatInMacrobeat:x,isMacrobeatStart:x===0,isMacrobeatEnd:x===T-1,isPlayable:!0,tonicSignUuid:null}),c++,d++,u++,h+=go;const A=o[M]||"dashed";r.push({macrobeatIndex:M,visualColumn:c-1,canvasColumn:d-1,timeColumn:u-1,boundaryType:A,isMeasureStart:A==="solid"}),g(M)});for(let T=0;T<2;T++)a.push({visualIndex:c,canvasIndex:null,timeIndex:null,type:"legend-right",widthMultiplier:de,xOffsetUnmodulated:h,macrobeatIndex:null,beatInMacrobeat:null,isMacrobeatStart:!1,isMacrobeatEnd:!1,isPlayable:!1,tonicSignUuid:null}),c++,h+=de;const f=new Map,p=new Map,v=new Map,w=new Map,y=new Map,C=new Map;return a.forEach(T=>{f.set(T.visualIndex,T.canvasIndex),p.set(T.visualIndex,T.timeIndex),T.canvasIndex!==null&&(v.set(T.canvasIndex,T.visualIndex),w.set(T.canvasIndex,T.timeIndex)),T.timeIndex!==null&&(T.canvasIndex!==null&&y.set(T.timeIndex,T.canvasIndex),C.set(T.timeIndex,T.visualIndex))}),{entries:a,visualToCanvas:f,visualToTime:p,canvasToVisual:v,canvasToTime:w,timeToCanvas:y,timeToVisual:C,macrobeatBoundaries:r,totalVisualColumns:c,totalCanvasColumns:d,totalTimeColumns:u,totalWidthUnmodulated:h}}}const Ft=new ru;function lu(n){n.on("rhythmStructureChanged",()=>{Ft.invalidate()})}function cu(n,t){return Ft.getColumnMap(t).visualToTime.get(n)??null}function qe(n,t){return Ft.getColumnMap(t).canvasToTime.get(n)??null}function Kt(n,t){const o=Ft.getColumnMap(t).timeToCanvas.get(n);return o!==void 0?o:n}function du(n,t){const o=Ft.getColumnMap(t).timeToVisual.get(n);return o!==void 0?o:n+2}function uu(n,t){const e=Ft.getColumnMap(t),o=e.canvasToVisual.get(n);return o!==void 0&&e.entries[o]||null}function hu(n,t){return uu(n,t)?.isPlayable??!1}function fu(n){const t=Ft.getColumnMap(n),e=[];for(const o of t.entries)o.canvasIndex!==null&&(e[o.canvasIndex]=o.widthMultiplier);return e}function qi(n,...t){}const ne={COMPRESSION_2_3:2/3,EXPANSION_3_2:3/2};function mu(n,t){if(!t||!t.macrobeatGroupings)return n*4;if(n===0)return 0;const e=n-1,o=Zt(t,e);if(o){const s=o.endColumn+1;return qi("log","[MODULATION] Found measure info, canvas-space endColumn:",o.endColumn,"first column after:",s),s}return n*4}function fr(n){return Math.abs(n-ne.COMPRESSION_2_3)<.001?"2:3":Math.abs(n-ne.EXPANSION_3_2)<.001?"3:2":`${n}`}function mr(n){const t="#ffc107";return Math.abs(n-ne.COMPRESSION_2_3)<.001||Math.abs(n-ne.EXPANSION_3_2)<.001,t}function oa(){const n=[{startColumn:0,endColumn:1/0,scale:1}];return{segments:n,getScaleForColumn(t){return 1},microbeatToCanvasX(){return 0},canvasXToMicrobeat(){return 0},getSegmentAtX(){return n[0]||null},getGhostGridPositions(){return[]}}}function pu(n,t,e=null){if(!n||n.length===0)return oa();const o=[...n.filter(d=>d.active)].sort((d,u)=>d.measureIndex-u.measureIndex);if(o.length===0)return oa();const i=o.map(d=>{const u=mu(d.measureIndex,e);return qi("log",`[MODULATION] Marker at measure ${d.measureIndex} calculated column=${u}`),qi("log","[MODULATION] Final marker position:",{id:d.id,measureIndex:d.measureIndex,columnIndex:u}),{...d,columnIndex:u}}),s=[];let a=1;const r=i[0];if(i.length===0||r&&r.columnIndex>0){const d=r?r.columnIndex:1/0;s.push({startColumn:0,endColumn:d,scale:1})}for(let d=0;d<i.length;d++){const u=i[d],h=i[d+1],m=h?h.columnIndex:1/0;a*=u.ratio,s.push({startColumn:u.columnIndex,endColumn:m,scale:a,marker:u})}return{segments:s,getScaleForColumn(d){for(const u of s)if(d>=u.startColumn&&d<u.endColumn)return u.scale;return 1},microbeatToCanvasX(d){return 0},canvasXToMicrobeat(d){return 0},getSegmentAtX(d){return s[0]||null},getGhostGridPositions(d,u){return[]}}}class gu{cachedPixelMap=null;lastPixelMapHash=null;getColumnPixelPosition(t,e,o){const i=this.getOrBuildPixelMap(e,o),s=i.columnPositions.get(Math.floor(t));if(s)return s;const a=i.columnPositions.size;return t===a&&i.columnPositions.get(a-1)?{canvasIndex:t,xStart:i.totalPixelWidth,xEnd:i.totalPixelWidth,width:0,modulationScale:1}:this.calculateFallbackPosition(t,e)}columnToPixelX(t,e,o){const i=Math.floor(t),s=t-i,a=this.getColumnPixelPosition(i,e,o);return a.xStart+s*a.width}pixelXToColumn(t,e,o){const i=this.getOrBuildPixelMap(e,o),s=Array.from(i.columnPositions.values()).sort((c,d)=>c.canvasIndex-d.canvasIndex);for(const c of s)if(t>=c.xStart&&t<c.xEnd){const d=(t-c.xStart)/c.width;return c.canvasIndex+d}if(s.length===0)return 0;const a=s[0];return!a||t<a.xStart?0:s[s.length-1]?.canvasIndex??0}invalidate(){this.cachedPixelMap=null,this.lastPixelMapHash=null}getOrBuildPixelMap(t,e){const o=this.buildPixelMapHash(t,e);return this.cachedPixelMap&&this.lastPixelMapHash===o?this.cachedPixelMap:(this.cachedPixelMap=this.buildPixelMap(t,e),this.lastPixelMapHash=o,this.cachedPixelMap)}buildPixelMapHash(t,e){const o=t.tempoModulationMarkers?JSON.stringify(t.tempoModulationMarkers.map(i=>({id:i.id,col:i.columnIndex,ratio:i.ratio}))):"none";return JSON.stringify({cellWidth:t.cellWidth,modulation:o,columnCount:e?Ft.getColumnMap(e).totalCanvasColumns:0})}buildPixelMap(t,e){const{cellWidth:o,tempoModulationMarkers:i}=t,s=Ft.getColumnMap(e),a=new Map,r=t.baseMicrobeatPx??o,c=i&&i.length>0?pu(i,r,e):null;let d=0;for(const u of s.entries){if(u.canvasIndex===null)continue;const h=u.widthMultiplier*o,m=c?c.getScaleForColumn(u.canvasIndex):1,g=h*m;a.set(u.canvasIndex,{canvasIndex:u.canvasIndex,xStart:d,xEnd:d+g,width:g,modulationScale:m}),d+=g}return{columnPositions:a,totalPixelWidth:d}}calculateFallbackPosition(t,e){const{cellWidth:o}=e,i=o;return{canvasIndex:t,xStart:t*i,xEnd:(t+1)*i,width:i,modulationScale:1}}}const Xe=new gu;function vu(n){n.on("rhythmStructureChanged",()=>{Xe.invalidate()})}function bu(n,t){const e=t.state||t;return Xe.columnToPixelX(n,t,e)}function pr(n){const t=n.state||n;return Xe.getOrBuildPixelMap(n,t).totalPixelWidth}function wu(n){return fu(n)}function yu(n,t){return n.reduce((e,o)=>e+o,0)*t}let fn=1,yn=0,Ze,Sn,Gi,qn,Gn,xe,Vi,Ui,gr,vr,br,wr,ce,Vn,Xi,yi=null,Fo=!1,Un=!1,Si=!1,Ci=!1,Yi=!1,ia=0,vo=null,Cn=null,Qi=0,yr=null,Ai=!1,bo=0;const Su=new Promise(n=>{yr=()=>n()});let xi=0,Mi=0;function Sr(){const n=document.getElementById("pitch-grid-container"),t=yn||window.innerHeight||0;return n?.clientHeight||(t?t*.7:0)}function sa(n,t){return Ul(n,t,{baseUnit:Hn,paddingRows:1})}function An(){const n=l.state.fullRowData.length,t=Math.max(0,n-1),e=l.state.pitchRange||{topIndex:0,bottomIndex:t};return Te(e,n,_t)}function Wo(){Cn!==null&&(cancelAnimationFrame(Cn),Cn=null),Qi+=1,Un=!1}function wo(n,t){const e=l.state.fullRowData.length,o=An(),i=Te(n,e,_t);if(i.topIndex===o.topIndex&&i.bottomIndex===o.bottomIndex)return;const s=o.topIndex,a=_e(o);l.setPitchRange(i),l.emit("scrollChanged");const r=i.topIndex-s;if(r!==0&&l.emit("scrollByUnits",r),_e(i)!==a){ve(),l.emit("zoomChanged");return}document.dispatchEvent(new CustomEvent("canvasResized",{detail:{source:t}}))}function yo(n,t,e){Wo(),Un=!0;const o=l.state.fullRowData.length,i=An(),s=Te(n,o,_t);if(s.topIndex===i.topIndex&&s.bottomIndex===i.bottomIndex){Un=!1;return}const a=Qi,r=performance.now(),c=Math.max(0,Math.round(t));let d=i.topIndex;const u=m=>m<.5?4*m*m*m:1-Math.pow(-2*m+2,3)/2,h=()=>{if(a!==Qi)return;const m=performance.now(),g=c>0?(m-r)/c:1,f=Math.max(0,Math.min(1,g)),p=u(f),v=Math.round(i.topIndex+(s.topIndex-i.topIndex)*p),w=Math.round(i.bottomIndex+(s.bottomIndex-i.bottomIndex)*p),y=Te({topIndex:v,bottomIndex:w},o,_t);l.setPitchRange(y),l.emit("scrollChanged");const C=y.topIndex-d;if(C!==0&&(l.emit("scrollByUnits",C),d=y.topIndex),ve(),l.emit("zoomChanged"),f<1){Cn=requestAnimationFrame(h);return}Cn=null,Un=!1};Cn=requestAnimationFrame(h)}function Cu(){try{if(globalThis.__SN_DEBUG_VIEWPORT)return!0}catch{}try{if(new URLSearchParams(window.location.search).get("debugViewport")==="1")return!0}catch{}try{return localStorage.getItem("sn:debugViewport")==="1"}catch{return!1}}let Au=!1;function Cr(n,t){if(Cu())try{const e=performance?.now?.()??Date.now();if(e-ia<500)return;ia=e,Au=!0}catch{}}function xu(){const n=window?.devicePixelRatio??1;return!Number.isFinite(n)||n<=0?1:n}function Ye(n,t,e,o,i){if(!n)return!1;const s=Number.isFinite(o)&&o>0?o:1;n.dataset.pixelRatio=`${s}`;let a=!1;if(typeof t=="number"){const r=Math.max(1,Math.round(t*s));Math.abs(n.width-r)>.5&&(n.width=r,a=!0),n.style.width=`${t}px`,n.dataset.logicalWidth=`${t}`}if(typeof e=="number"){const r=Math.max(1,Math.round(e*s));Math.abs(n.height-r)>.5&&(n.height=r,a=!0),n.style.height=`${e}px`,n.dataset.logicalHeight=`${e}`}if(a){const r=i||n.getContext("2d");r&&r.setTransform(s,0,0,s,0,0)}return a}function Mu(){Ze=document.getElementById("pitch-grid-wrapper"),Sn=document.getElementById("notation-grid"),qn=document.getElementById("legend-left-canvas"),Gn=document.getElementById("legend-right-canvas"),xe=document.getElementById("drum-grid-wrapper"),Vi=document.getElementById("drum-grid"),gr=document.getElementById("drum-playhead-canvas"),vr=document.getElementById("playhead-canvas"),br=document.getElementById("hover-canvas"),wr=document.getElementById("drum-hover-canvas"),ce=document.getElementById("button-grid"),Vn=document.getElementById("grid-scrollbar-proxy"),Xi=Vn?.querySelector(".grid-scrollbar-inner")||null;const n=document.getElementById("canvas-container");if(!Ze||!Sn||!n)return{};Gi=Sn.getContext("2d"),Ui=Vi?.getContext("2d")||null;const t=qn?.getContext("2d")||null,e=Gn?.getContext("2d")||null;return{ctx:Gi,drumCtx:Ui,legendLeftCtx:t,legendRightCtx:e,canvasContainer:n}}function Eu(){if(Yi)return;const n=(l.state.columnWidths?.length||0)>0,t=!!(l.state.cellWidth&&l.state.cellWidth>0);!n||!t||(Yi=!0,yr?.())}function ve(){if(!Ze||Ze.clientHeight===0){Si||(b.warn("LayoutService","Pitch grid wrapper not ready for layout (height=0). Retrying on next frame.",null,"layout"),Si=!0),requestAnimationFrame(ve);return}if(Si=!1,Fo)return;Fo=!0;const n=document.getElementById("pitch-grid-container");Ze.clientWidth;const t=window.innerHeight;(Math.abs(t-yn)>3||yn===0)&&(yn=t);const o=Hn,i=o*Qd,s=An(),a=Sr(),r=Math.max(1,_e(s));fn=sa(a,r);const c=Math.round(o*fn),d=Math.round(i*fn);l.setLayoutConfig({cellHeight:c,cellWidth:d});const u=wu(l.state);l.setLayoutConfig({columnWidths:u}),Eu(),(!l.state.cellWidth||!u.length)&&b.warn("LayoutService","Unexpected layout configuration",{cellWidth:l.state.cellWidth,columnCount:u.length},"layout");const m=u.reduce((L,z)=>L+z,0)*l.state.cellWidth,g=jt.getModulatedCanvasWidth(),f=l.state.tempoModulationMarkers&&l.state.tempoModulationMarkers.length>0,p=f?g:m,v=de*2*l.state.cellWidth,w=de*2*l.state.cellWidth,y=Math.round(p+v+w),C=xu();document.getElementById("drum-grid-wrapper");const P=document.getElementById("grids-wrapper"),T=y+"px";if(n&&(n.style.width=T),Ze&&(Ze.style.width=T),xe&&(xe.style.width=T),Xi&&Vn){Xi.style.width=T;const L=P?.getBoundingClientRect().width||0;y>L?Vn.style.display="":Vn.style.display="none"}const M=Math.max(Kn,Jn*l.state.cellHeight),A=ta*M,x=`${A}px`,k=l.state.columnWidths?.length??0;let S=0;if(f){const L={cellWidth:l.state.cellWidth,columnWidths:l.state.columnWidths,tempoModulationMarkers:l.state.tempoModulationMarkers,baseMicrobeatPx:l.state.cellWidth,cellHeight:l.state.cellHeight,state:l.state};S=pr(L)}else for(let L=0;L<k;L++)S+=(l.state.columnWidths[L]||0)*l.state.cellWidth;if(k===0&&b.warn("LayoutService","Column widths array is empty.",{columnWidthsCount:k,columnWidths:l.state.columnWidths},"layout"),S<50&&k>0&&b.warn("LayoutService","Computed button-grid middle cell width is unexpectedly small.",{middleCellWidth:S,columnWidthsSample:l.state.columnWidths?.slice(0,10),cellWidth:l.state.cellWidth,macrobeatGroupings:l.state.macrobeatGroupings},"layout"),ce){const L=ce.querySelector(".button-grid-left-cell"),z=ce.querySelector(".button-grid-middle-cell"),U=ce.querySelector(".button-grid-right-cell"),B=de*2*l.state.cellWidth,F=de*2*l.state.cellWidth;(Math.abs(Mi-A)>5||Mi===0)&&(ce.style.height=x,Mi=A);const H=(q,X)=>{if(!q)return;const tt=`${Math.max(0,X)}px`;q.style.width=tt,q.style.flex=`0 0 ${tt}`,q.style.maxWidth=tt,q.style.minWidth=tt,q.style.height=x};if(L){H(L,B);const q=L.getBoundingClientRect();B>0&&q.width===0&&b.warn("LayoutService","Left button-grid cell measured width is 0 after assignment.",{assignedWidth:B,measuredWidth:q.width,computedDisplay:window.getComputedStyle(L).display},"layout")}if(z){S===0&&b.warn("LayoutService","Calculated middle button-grid width is 0. Check column width data.",{columnWidths:l.state.columnWidths,cellWidth:l.state.cellWidth},"layout"),H(z,S);const q=z.getBoundingClientRect();if(S>0&&q.width===0&&b.warn("LayoutService","Middle button-grid cell assigned width but still measures 0.",{assignedWidth:S,measuredWidth:q.width,computedStyles:window.getComputedStyle(z)},"layout"),Math.abs(q.width-S)>5&&(b.warn("LayoutService","Middle cell measured width does not match assigned width.",{assignedWidth:S,measuredWidth:q.width,styleWidth:z.style.width,cellWidth:l.state.cellWidth},"layout"),requestAnimationFrame(()=>{const X=z.getBoundingClientRect();Math.abs(X.width-S)>5&&b.warn("LayoutService","Middle cell still mismatched after RAF.",{assignedWidth:S,measuredWidth:X.width,delta:X.width-S,computedStyles:window.getComputedStyle(z)},"layout")})),!Ci){const X=z.querySelector("#beat-line-button-layer");if(X){const tt=X.getBoundingClientRect();if(tt.width===0){const _=window.getComputedStyle(X);b.warn("LayoutService","#beat-line-button-layer width is 0 despite middle cell sizing.",{beatLineRect:tt,beatLineStyles:{display:_.display,position:_.position,flex:{direction:_.flexDirection,grow:_.flexGrow,shrink:_.flexShrink,basis:_.flexBasis},width:_.width,minWidth:_.minWidth,maxWidth:_.maxWidth},middleRect:q,middleCellComputedWidth:_.width},"layout"),Ci=!0}}else b.warn("LayoutService","Could not find #beat-line-button-layer inside middle cell to measure.",null,"layout"),Ci=!0}}if(U){H(U,F);const q=U.getBoundingClientRect();F>0&&q.width===0&&b.warn("LayoutService","Right button-grid cell measured width is 0 after assignment.",{assignedWidth:F,measuredWidth:q.width,computedDisplay:window.getComputedStyle(U).display},"layout")}const R=B+S+F;Number.isFinite(R)&&R>0&&(ce.style.width=T,ce.style.maxWidth=T,ce.style.minWidth=T),ce.getBoundingClientRect().width===0&&b.warn("LayoutService","Entire button grid wrapper width is 0 after layout pass.",{leftCellWidth:B,middleCellWidth:S,rightCellWidth:F,wrapperStyles:window.getComputedStyle(ce)},"layout")}const E=Math.max(Kn,Jn*l.state.cellHeight),I=ta*E,D=`${I}px`,W=n?.clientHeight||0;if(W>0){const L=l.state.cellHeight,z=l.state.cellWidth,U=Math.max(1,_e(s)),B=sa(W,U),F=Math.round(o*B),Z=Math.round(i*B);l.setLayoutConfig({cellHeight:F,cellWidth:Z}),fn=B,(F!==L||Z!==z)&&(Ai=!0)}const Q=Math.round(de*2*l.state.cellWidth),G=Math.round(de*2*l.state.cellWidth),Y=Math.round(p),O=[{element:Sn,context:Gi},{element:vr},{element:br}];if(O.forEach(({element:L,context:z})=>{Ye(L,Y,W,C,z),L&&(L.style.left=`${Q}px`)}),Ye(qn,Q,W,C,null),Ye(Gn,G,W,C,null),[{element:Vi,context:Ui},{element:gr},{element:wr}].forEach(({element:L,context:z})=>{Ye(L,Y,I,C,z)}),xe){const L=xe.querySelector(".drum-grid-left-cell"),z=xe.querySelector(".drum-grid-middle-cell"),U=xe.querySelector(".drum-grid-right-cell"),B=(Z,N)=>{if(!Z)return;const H=`${Math.max(0,Math.round(N))}px`;Z.style.width=H,Z.style.flex=`0 0 ${H}`,Z.style.maxWidth=H,Z.style.minWidth=H,Z.style.height=D};B(L,Q),B(z,Y),B(U,G);const F=z?.querySelector("#drum-canvas-wrapper");F&&(F.style.width="100%",F.style.height=D)}const ft=Math.abs(xi-I)>5||xi===0;xe&&ft&&(xe.style.height=D,xi=I);const gt=C,nt=Y;vo&&clearTimeout(vo),vo=setTimeout(()=>{vo=null;const z=document.getElementById("pitch-grid-container")?.clientHeight||0;O.forEach(({element:U,context:B})=>{Ye(U,nt,z,gt,B),U&&(U.style.left=`${Q}px`)}),Ye(qn,Q,z,gt,null),Ye(Gn,G,z,gt,null),Cr("deferredResize",{finalContainerHeight:z,pitchCanvasLogicalHeight:Sn?.dataset?.logicalHeight,legendLeftLogicalHeight:qn?.dataset?.logicalHeight,legendRightLogicalHeight:Gn?.dataset?.logicalHeight}),document.dispatchEvent(new CustomEvent("canvasResized",{detail:{source:"layoutService-deferred"}}))});try{const L=l.state.fullRowData.length,z=Math.max(0,L-1),U=l.state.pitchRange||{topIndex:0,bottomIndex:z},B=Te(U,L,_t);(U.topIndex!==B.topIndex||U.bottomIndex!==B.bottomIndex)&&l.setPitchRange(B)}catch{}l.emit("layoutConfigChanged"),Fo=!1,Ai?(Ai=!1,bo<1?(bo+=1,requestAnimationFrame(ve)):b.warn("LayoutService","Skipped additional layout pass after repeated final zoom adjustments.",{finalRecalcAttempts:bo},"layout")):bo=0}const jt={init(){const{ctx:n,drumCtx:t,legendLeftCtx:e,legendRightCtx:o}=Mu();requestAnimationFrame(ve),this.initScrollHandler();const i=()=>{Fo||(yi!==null&&clearTimeout(yi),yi=setTimeout(()=>{ve()},Yd))};return window.addEventListener("resize",i),l.on("zoomIn",s=>{this.zoomIn(s)}),l.on("zoomOut",s=>{this.zoomOut(s)}),{ctx:n,drumCtx:t,legendLeftCtx:e,legendRightCtx:o}},waitForInitialLayout(){return Yi?Promise.resolve():Su},getCurrentZoomLevel(){return fn},setZoomLevel(n){const t=Number.isFinite(n)&&n>0?n:1,e=Sr(),o=l.state.fullRowData.length,i=Math.max(0,o-1);if(!o||o<=0)return;const s=2*e/(t*Hn),a=Math.max(_t,Math.min(o,Math.round(s)-1)),r=An(),c=(r.topIndex+r.bottomIndex)/2,d=(a-1)/2;let u=Math.round(c-d),h=u+a-1;if(u<0&&(h+=-u,u=0),h>i){const m=h-i;u-=m,h=i}wo({topIndex:u,bottomIndex:h},"setZoomLevel")},setPitchViewportRange(n,t={}){const e=t.source??"setPitchViewportRange",o=Math.max(0,Math.round(t.animateMs??0));if(o>0){yo(n,o);return}wo(n,e)},_canScrollRange(n){const t=l.state.pitchRange;if(!t||!Me||Me.length===0)return!1;const e=Me.length-1,o=typeof n=="string"?n==="up"?-1:1:n,i=o<0&&t.topIndex>0,s=o>0&&t.bottomIndex<e;return i||s},initScrollHandler(){const n=document.getElementById("pitch-grid-wrapper");n&&n.addEventListener("wheel",t=>{if(t.preventDefault(),t.ctrlKey||t.metaKey)t.deltaY<0?this.zoomIn({source:"wheel"}):this.zoomOut({source:"wheel"});else{const e=t.deltaY>0?1:-1;this._canScrollRange(e)&&this.scrollByUnits(e)}},{passive:!1})},zoomIn(n){const t=l.state.fullRowData.length;if(!t)return;const e=An(),o=_e(e),i=Vs(o,t),s=Us(e,"in",{totalRanks:t,minSpan:_t,zoomStep:i}),a=_e(s),r=n?.source??"unknown",c=r==="wheel"?0:280;b.debug("LayoutService",`[Zoom] Range zoom in (span ${o} -> ${a})`,{source:r},"layout"),c>0?yo(s,c):(wo(s,`zoomIn:${r}`),l.emit("zoomChanged"))},zoomOut(n){const t=l.state.fullRowData.length;if(!t)return;const e=An(),o=_e(e),i=Vs(o,t),s=Us(e,"out",{totalRanks:t,minSpan:_t,zoomStep:i}),a=_e(s),r=n?.source??"unknown",c=r==="wheel"?0:280;b.debug("LayoutService",`[Zoom] Range zoom out (span ${o} -> ${a})`,{source:r},"layout"),c>0?yo(s,c):(wo(s,`zoomOut:${r}`),l.emit("zoomChanged"))},resetZoom(n){const t=l.state.fullRowData.length;if(!t)return;const e=Math.max(0,t-1);n?.source,yo({topIndex:0,bottomIndex:e},320)},scroll(n){const e=this.getViewportInfo().startRank;l.emit("scrollChanged");const s=this.getViewportInfo().startRank-e;s!==0&&l.emit("scrollByUnits",s),l.emit("layoutConfigChanged")},scrollByUnits(n){Wo();const t=l.state.pitchRange;if(!t||!Me||Me.length===0)return;const e=Math.sign(n||0);if(e===0)return;const o=Me.length,i=Te(t,o,_t),s=Vl(i,e,o);s.topIndex===i.topIndex&&s.bottomIndex===i.bottomIndex||(l.setPitchRange(s),l.emit("scrollChanged"),l.emit("scrollByUnits",e),document.dispatchEvent(new CustomEvent("canvasResized",{detail:{source:"viewportScroll"}})))},setViewportTopIndex(n){Wo();const t=l.state.pitchRange||{topIndex:0,bottomIndex:Math.max(0,l.state.fullRowData.length-1)},e=l.state.fullRowData.length,o=Te(t,e,_t),i=Gl(o,n,e,_t),s=i.topIndex-(o.topIndex??0);i.topIndex===o.topIndex&&i.bottomIndex===o.bottomIndex||(l.setPitchRange(i),l.emit("scrollChanged"),s!==0&&l.emit("scrollByUnits",s),ve(),l.emit("zoomChanged"))},setViewportBottomIndex(n){Wo();const t=l.state.pitchRange||{topIndex:0,bottomIndex:Math.max(0,l.state.fullRowData.length-1)},e=l.state.fullRowData.length,o=Te(t,e,_t),i=ql(o,n,e,_t),s=i.topIndex-(o.topIndex??0);b.debug("LayoutService","setViewportBottomIndex",{requestedBottom:n,currentRange:t,normalized:o,nextRange:i,willUpdate:!(i.topIndex===o.topIndex&&i.bottomIndex===o.bottomIndex)},"layout"),!(i.topIndex===o.topIndex&&i.bottomIndex===o.bottomIndex)&&(l.setPitchRange(i),l.emit("scrollChanged"),s!==0&&l.emit("scrollByUnits",s),ve(),l.emit("zoomChanged"))},scrollByPixels(n,t=0){const o=this.getViewportInfo().startRank;l.state.fullRowData.length,l.state.cellHeight,l.emit("scrollChanged");const a=this.getViewportInfo().startRank-o;a!==0&&l.emit("scrollByUnits",a),l.emit("layoutConfigChanged")},getViewportInfo(){const n=l.state.fullRowData.length,t=Math.max(0,n-1),e=document.getElementById("pitch-grid-container"),o=e?.clientHeight||yn*.7,i=l.state.cellHeight||Hn,s=i/2,a=Te(l.state.pitchRange||{topIndex:0,bottomIndex:t},n,_t),r=Math.max(0,Math.min(t,a.topIndex??0)),c=Math.max(r,Math.min(t,a.bottomIndex??t)),d=Math.min(n,c+1),u=r*s,h=document.getElementById("legend-left-canvas"),m=document.getElementById("legend-right-canvas"),g=s?o/s:0,f=Math.max(1,c-r+1),p=f*s,v=l.state.fullRowData[r],w=l.state.fullRowData[c],y=r<=0,C=c>=t;return Cr("getViewportInfo",{containerHeight:o,containerRectHeight:e?.getBoundingClientRect?.().height,cellHeight:i,halfUnit:s,ratio:g,rowCount:f,coveragePx:p,coverageGapPx:o-p,totalRanks:n,pitchRange:a,startRank:r,endRank:d,atTopGamutEdge:y,atBottomGamutEdge:C,scrollOffset:u,startRowSummary:v?{pitch:v.pitch,column:v.column,isBoundary:!!v.isBoundary}:null,endRowSummary:w?{pitch:w.pitch,column:w.column,isBoundary:!!w.isBoundary}:null,pitchCanvasLogicalHeight:Sn?.dataset?.logicalHeight,legendLeftLogicalHeight:h?.dataset?.logicalHeight,legendRightLogicalHeight:m?.dataset?.logicalHeight,legendLeftCssHeight:h?.getBoundingClientRect?.().height,legendRightCssHeight:m?.getBoundingClientRect?.().height}),{zoomLevel:fn,viewportHeight:yn,containerHeight:o,cellHeight:i,halfUnit:s,startRank:r,endRank:d,scrollOffset:u}},getMacrobeatWidthPx(n,t){return t*n.cellWidth},getColumnX(n){const t=l.state.cellWidth||40,e=l.state.columnWidths||[];return bu(n,{cellWidth:t,columnWidths:e,tempoModulationMarkers:l.state.tempoModulationMarkers,baseMicrobeatPx:t,state:l.state})},getCanvasWidth(){return yu(l.state.columnWidths,l.state.cellWidth)},getModulatedCanvasWidth(){const n=this.getCanvasWidth();if(!l.state.tempoModulationMarkers||l.state.tempoModulationMarkers.length===0)return n;try{const t=l.state.cellWidth||40,e=l.state.columnWidths||[],o={cellWidth:t,columnWidths:e,tempoModulationMarkers:l.state.tempoModulationMarkers,baseMicrobeatPx:t,cellHeight:l.state.cellHeight||40,state:l.state};return pr(o)}catch{return n}},recalculateLayout(){ve()},reflow(){ve()},get isZooming(){return Un}};let Ei=null,Pi=null,Ti=null,Ii=null;const eo={setContexts({ctx:n,drumCtx:t,legendLeftCtx:e,legendRightCtx:o}){Ei=n??null,Pi=t??null,Ti=e??null,Ii=o??null},getPitchContext(){return Ei||b.error("CanvasContextService","Pitch context requested before it was set.",null,"canvas"),Ei},getDrumContext(){return Pi||b.error("CanvasContextService","Drum context requested before it was set.",null,"canvas"),Pi},getLegendLeftContext(){return Ti||b.error("CanvasContextService","Legend left context requested before it was set.",null,"canvas"),Ti},getLegendRightContext(){return Ii||b.error("CanvasContextService","Legend right context requested before it was set.",null,"canvas"),Ii}},Ht={getViewportInfo:()=>jt.getViewportInfo(),setViewportTopIndex(n){jt.setViewportTopIndex?.(n)},setViewportBottomIndex(n){jt.setViewportBottomIndex?.(n)},setPitchViewportRange(n,t={}){jt.setPitchViewportRange?.(n,t)}};let xn=null,Mn=null;l.on("tempoModulationMarkersChanged",()=>{});l.on("scrollChanged",()=>{xn=null,Mn=null});l.on("zoomChanged",()=>{xn=null,Mn=null});l.on("pitchRangeChanged",()=>{xn=null,Mn=null});function xs(){const n=performance.now();return(!xn||!Mn||n-Mn>1)&&(xn=Ht.getViewportInfo(),Mn=n),xn}function J(n,t){const e=l.state,o={cellWidth:t.cellWidth,tempoModulationMarkers:t.tempoModulationMarkers,baseMicrobeatPx:t.baseMicrobeatPx,columnWidths:t.columnWidths,state:e};return Xe.columnToPixelX(n,o,e)}function pt(n,t){const e=xs(),o=n-e.startRank,i=t.cellHeight/2;return(o+1)*i}function Pu(n){let t=(n||"").replace(/\d/g,"").trim();return t=t.replace(/b/g,"b-").replace(/#/g,"b_"),t}function Tu(n){switch(n){case"C":return{lineWidth:3.33,dash:[],color:"#adb5bd"};case"E":return{lineWidth:1,dash:[5,5],color:"#adb5bd"};case"G":return{lineWidth:1,dash:[],color:"#dee2e6"};case"B":case"A":case"F":case"Eb/Db":case"Db/C#":return{lineWidth:1,dash:[],color:"#ced4da"};default:return{lineWidth:1,dash:[],color:"#ced4da"}}}function Iu(){const n=xs(),{startRank:t,endRank:e}=n,o=Math.max(t,e-1);return{startRow:t,endRow:o}}function ji(n,t){const e=l.state,o={cellWidth:t.cellWidth,tempoModulationMarkers:t.tempoModulationMarkers,baseMicrobeatPx:t.baseMicrobeatPx,columnWidths:t.columnWidths,state:e};return Xe.pixelXToColumn(n,o,e)}function Lu(n,t){const e=xs(),o=t.cellHeight/2;return n/o-1+e.startRank}function Ar(n,t){return t.some(e=>e.columnIndex===n)}function Zi(n,t){return t.some(e=>n===e.columnIndex||n===e.columnIndex+1)}function no(n,t){const e=Gt(t);return!Zi(n,e)}function xr(n,t){for(const e of t)if(n===e.columnIndex+1)return!1;return t.some(e=>n===e.columnIndex+2),!0}function ku(n){const t=new Set;return n.forEach(e=>{t.add(e.columnIndex),t.add(e.columnIndex+1)}),t}function qt(n){if(!n)return 0;const t=n.dataset?.logicalWidth,e=t!==void 0?Number(t):NaN;return Number.isFinite(e)?e:n.width||0}function Pt(n){if(!n)return 0;const t=n.dataset?.logicalHeight,e=t!==void 0?Number(t):NaN;return Number.isFinite(e)?e:n.height||0}function Nu(n){if(!n)return 1;const t=n.dataset?.pixelRatio,e=t!==void 0?Number(t):NaN;return Number.isFinite(e)&&e>0?e:1}const Li={stroke:"#c7cfd8",background:"rgba(207, 214, 222, 0.32)"};let So=null;function Mr(){if(So)return So;if(typeof window>"u")return Li;const n=window.getComputedStyle(document.documentElement);return So={stroke:n.getPropertyValue("--c-anacrusis-border").trim()||Li.stroke,background:n.getPropertyValue("--c-anacrusis-bg").trim()||Li.background},So}function Ru(n){if(n.length===0)return[];const t=[...n].sort((o,i)=>o.start-i.start),e=[];for(const o of t){if(e.length===0){e.push({...o});continue}const i=e[e.length-1];o.start<=i.end?i.end=Math.max(i.end,o.end):e.push({...o})}return e}function Bu(n){const t=[],e=Fu();return e!==null&&e>0&&t.push({start:J(0,n),end:J(e,n)}),Gt(l.state).forEach(i=>{const s=J(i.columnIndex,n),a=J(i.columnIndex+2,n);t.push({start:s,end:a})}),Ru(t)}function Du(n,t,e){const o=new Set([n,t]);e.forEach(a=>{const r=Math.max(n,Math.min(t,a.start)),c=Math.max(n,Math.min(t,a.end));c>r&&(o.add(r),o.add(c))});const i=Array.from(o).sort((a,r)=>a-r),s=[];for(let a=0;a<i.length-1;a++){const r=i[a],c=i[a+1],d=(r+c)/2,u=e.some(h=>d>=h.start&&d<h.end);c>r&&s.push({from:r,to:c,light:u})}return s}function Fu(){const n=l.state;if(!n?.hasAnacrusis||!Array.isArray(n.macrobeatBoundaryStyles))return null;const t=n.macrobeatBoundaryStyles.findIndex(o=>o==="solid");if(t<0)return null;const e=Zt(n,t);return e?e.endColumn+1:null}function Wu(n,t,e,o){const i=Bu(t),{stroke:s}=Mr();for(let a=e;a<=o;a++){const r=t.fullRowData[a];if(!r||r.isBoundary)continue;const c=pt(a,t);if(c<-10||c>t.viewportHeight+10)continue;const d=Pu(r.pitch);if(["B","A","F","E/D","D/C"].includes(d))continue;const h=Tu(d),m=t.musicalColumnWidths&&t.musicalColumnWidths.length>0?t.musicalColumnWidths:t.columnWidths||[],g=J(0,t),f=J(m.length,t),p=Du(g,f,i);d==="G"?p.forEach(v=>{const w=v.to-v.from;w<=0||(n.save(),n.fillStyle=v.light?s:h.color,n.globalAlpha=v.light?.5:1,n.fillRect(v.from,c-t.cellHeight/2,w,t.cellHeight),n.restore())}):p.forEach(v=>{v.to-v.from<=0||(n.beginPath(),n.moveTo(v.from,c),n.lineTo(v.to,c),n.lineWidth=h.lineWidth,n.strokeStyle=v.light?s:h.color,n.setLineDash(h.dash),n.globalAlpha=v.light?.6:1,n.stroke(),n.setLineDash([]),n.globalAlpha=1)})}}function Ou(n,t,e,o){Wu(n,t,e,o)}function _u(n,t){zu(n,t)}function zu(n,t){const{columnWidths:e,macrobeatGroupings:o,macrobeatBoundaryStyles:i,placedTonicSigns:s}=t,r=(t.musicalColumnWidths&&t.musicalColumnWidths.length>0?t.musicalColumnWidths:e).length,c=o.map((d,u)=>{const{endColumn:h}=Zt(l.state,u);return h+1});for(let d=0;d<=r;d++){const u=d===0||d===r,h=Ar(d,s),m=s.some(w=>d===w.columnIndex+2),g=c.includes(d);if(!xr(d,s))continue;let p=null;if(u||h||m)p={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(g){const w=c.indexOf(d),y=i[w]??"dashed";if(y==="anacrusis"){const{stroke:C}=Mr();p={lineWidth:1,strokeStyle:C,dash:[4,4]}}else p={lineWidth:1,strokeStyle:"#adb5bd",dash:y==="solid"?[]:[5,5]}}if(!p)continue;const v=J(d,t);n.beginPath(),n.moveTo(v,0),n.lineTo(v,Pt(n.canvas)),n.lineWidth=p.lineWidth,n.strokeStyle=p.strokeStyle,n.setLineDash(p.dash),n.stroke()}n.setLineDash([])}let aa=0;function Er(){try{if(globalThis.__SN_DEBUG_VIEWPORT)return!0}catch{}try{if(new URLSearchParams(window.location.search).get("debugViewport")==="1")return!0}catch{}try{return localStorage.getItem("sn:debugViewport")==="1"}catch{return!1}}let $u=!1;function Hu(n,t){if(Er())try{const e=performance?.now?.()??Date.now();if(e-aa<500)return;aa=e,$u=!0}catch{}}const ra=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"];function qu(n){const t=n.replace(/\d+$/,"");return t.length>0?t:n}function Pr(n,t){return!Number.isFinite(t)||t<=0?n:Math.round(n*t)/t}function Gu(n,t,e,o){const i=Math.max(10,Math.min(n*1.2,t*1.2)),s=e<=3?1:.7,a=o<=1?1.08:1;return Pr(i*s*a,o)}function Vu(n,t){const e=t[n];if(!e)return null;const i=e.pitch.replace(/\d+$/,"");return(i.includes("/")?i.split("/")[0]??i:i).replace(//g,"b").replace(//g,"#")}function Uu(n,t){if(!n||!t)return[];const e=t-1;if(e<0||e>=ra.length)return b.warn("LegendRenderer",`Invalid tonic number: ${t}`,null,"grid"),[];const o=ra[e];try{const i=`${n} ${o}`;return Kl(i).notes||[]}catch(i){return b.warn("LegendRenderer",`Could not generate ${o} scale`,{tonic:n,error:i},"grid"),[]}}function Qo(n){return n?n.replace(/\d+$/,"").replace(/T-/g,"b").replace(/T_/g,"#").replace(/-/g,"b").replace(/_/g,"#").replace(//g,"b").replace(//g,"#"):""}function Xu(n){const t=new Set;return n.forEach(e=>{const o=Qo(e);if(o){t.add(o);try{const i=Qo(zn(o));i&&t.add(i)}catch{}}}),t}function la(n,t){if(!t.size)return!0;const e=Qo(n.toneNote||n.pitch);if(!e)return!1;if(t.has(e))return!0;try{const o=Qo(zn(e));if(o&&t.has(o))return!0}catch{}return e.includes("/")?e.split("/").some(o=>t.has(o)):!1}function Yu(n,t,e,o,i){const{fullRowData:s,columnWidths:a,cellWidth:r,cellHeight:c,colorMode:d}=e,u=d??"color",{sharp:h,flat:m}=l.state.accidentalMode,{focusColours:g,showFrequencyLabels:f}=l.state,p=e.showOctaveLabels??!0,v=x=>p?x:qu(x),w=(x,k)=>{if(!Er())return;const S=c/2,E=Pt(x.canvas),I=pt(i,e),D=I+S,W=document.getElementById("pitch-grid-container")?.clientHeight??null,Q=s.length,G=o<=0,Y=i>=Q-1,O=nt=>{if(nt===null)return null;const L=s[nt];return L?{rowIndex:nt,pitch:L.pitch,column:L.column,isBoundary:!!L.isBoundary}:{rowIndex:nt,exists:!1}},j=nt=>{let L=null,z=null;for(let U=o;U<=i;U++){const B=s[U];!B||B.isDummy||B.column===nt&&(L===null&&(L=U),z=U)}return{first:L,last:z}},at=j("A"),ft=j("B"),gt=nt=>{if(nt===null)return null;const L=pt(nt,e);return{rowIndex:nt,y:L,topEdge:L-S,bottomEdge:L+S,gapCanvasMinusBottomEdge:E-(L+S)}};Hu("legendCoverage",{side:k,startRow:o,endRow:i,atTopGamutEdge:G,atBottomGamutEdge:Y,cellHeight:c,halfUnit:S,yEnd:I,bottomEdge:D,canvasHeight:E,gapCanvasMinusBottomEdge:E-D,containerHeight:W,gapCanvasMinusContainer:typeof W=="number"?E-W:null,startRowSummary:O(o),endRowSummary:O(i),firstLastA:{...at,firstSummary:O(at.first),lastSummary:O(at.last)},firstLastB:{...ft,firstSummary:O(ft.first),lastSummary:O(ft.last)},aLastCoverage:gt(at.last),bLastCoverage:gt(ft.last)})};let y=[],C=new Set;if(g){const x=Gt(l.state),k=new Set;x.length||b.info("LegendRenderer","Focus Colours ON but no tonic placements found",null,"grid"),x.forEach(S=>{const E=Vu(S.row,s),I=Uu(E,S.tonicNumber);b.debug("LegendRenderer","Focus Colours tonic scale",{tonicNote:E,tonicNumber:S.tonicNumber,scaleNotes:I},"grid"),I.forEach(D=>k.add(D))}),y=Array.from(k),b.debug("LegendRenderer","Focus Colours combined scale",{focusScale:y},"grid"),C=Xu(y)}const P=(x,k=[],S=null)=>{if(f){const Q=g&&C.size>0,G=S?la(S,C):!1;return Q&&S&&!G?null:S&&S.frequency?String(S.frequency):x}if(!S){if(!x.includes("/"))return v(x);const Q=x.slice(-1),G=x.substring(0,x.length-1),[Y,O]=G.split("/");return v(h&&m?`${Y}/${O}${Q}`:h?`${O}${Q}`:m?`${Y}${Q}`:`${O}${Q}`)}const{flatName:E,sharpName:I,isAccidental:D}=S;if(!D)return v(E);let W;return h&&m?W=S.pitch:h&&!m?W=I:m&&!h?W=E:W=I,v(W)},T=()=>!h&&!m,M=x=>{x.clearRect(0,0,qt(x.canvas),Pt(x.canvas))};function A(x,k,S,E){const I=de*2*r,D=[I/2,I/2],W=Nu(x.canvas),Q=j=>Pr(j,W);let G=0,Y=0,O=0;S.forEach((j,at)=>{const ft=D[at]??0;for(let gt=o;gt<=i;gt++){const nt=s[gt];if(!(!nt||nt.isDummy)&&nt.column===j){const L=pt(gt,e),z=nt.isAccidental??nt.pitch.includes("/"),U=!f&&z&&T(),B=la(nt,C),F=P(nt.pitch,E,nt);if(F===null)continue;const Z=!!nt.isBoundary;let N=u==="bw"?"#ffffff":nt.hex||"#ffffff";g&&!B&&!f&&(N="#ffffff");const H=U||Z?"00":g&&!B?"55":"FF";g&&C.size>0&&(O+=1,B||(Y+=1)),x.fillStyle=U?"rgba(255,255,255,0)":N,x.fillRect(G,L-c/2,ft,c);const R=Gu(r,c,F.length,W);x.font=`bold ${R}px 'Atkinson Hyperlegible', sans-serif`,x.textAlign="center",x.textBaseline="middle";const $=Q(G+ft/2),q=Q(L);x.strokeStyle=`#212529${H}`,x.lineWidth=Math.max(1.2,2.5/W),x.lineJoin="round",x.strokeText(F,$,q),x.fillStyle=`#ffffff${H}`,x.fillText(F,$,q)}}G+=ft}),g&&C.size>0&&b.debug("LegendRenderer","Focus filter summary (separate)",{side:k===0?"left":"right",startCol:k,relevantScale:E,totalLabels:O,filteredLabels:Y},"grid")}n&&(M(n),w(n,"left"),A(n,0,["B","A"],y)),t&&(M(t),w(t,"right"),A(t,a.length,["A","B"],y))}const Tr={0:{degree:1,alt:0},1:{degree:2,alt:-1},2:{degree:2,alt:0},3:{degree:3,alt:-1},4:{degree:3,alt:0},5:{degree:4,alt:0},6:{degree:5,alt:-1},7:{degree:5,alt:0},8:{degree:6,alt:-1},9:{degree:6,alt:0},10:{degree:7,alt:-1},11:{degree:7,alt:0}};function Qu(n){if(Math.abs(n.num)!==8||n.alt>=0)return null;const e=(n.semitones%12+12)%12;return Tr[e]||null}function ca(n){if(!n)return null;const t=ic(n);if(t?.num===void 0)return null;const e=Qu(t);if(e){const c=e.degree,d=e.alt;let u="";return d<0?u="".repeat(Math.abs(d)):d>0&&(u="".repeat(d)),`${u}${c}`}const o=(t.semitones%12+12)%12,i=Tr[o];if(!i){const c=Math.abs(t.num),d=t.alt;let u="";return d<0?u="".repeat(Math.abs(d)):d>0&&(u="".repeat(d)),`${u}${c}`}const s=i.degree,a=i.alt;let r="";return a<0?r="".repeat(Math.abs(a)):a>0&&(r="".repeat(a)),`${r}${s}`}function da(n){return n&&{"1":"2","2":"1","2":"3","3":"2","4":"5","5":"4","5":"6","6":"5","6":"7","7":"6"}[n]||null}function ua(n){return!!(n&&(n.includes("")||n.includes("")))}const ki={getEnharmonicDegree:da,hasAccidental:ua,getDegreeForNote(n,t){if(!n||!t)return null;const{keyTonic:e,keyMode:o}=Xd(t,n.startColumnIndex);if(!e)return null;const i=n.globalRow??n.row,s=t.fullRowData[i]?.toneNote;if(!s)return null;const a=Hi(s)||s;let r=e;if(t.degreeDisplayMode!=="modal"&&o!=="major"){const m=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"].indexOf(o);if(m>0){const f=["1P","2M","3M","4P","5P","6M","7M"][m];if(f){const p=oc(f);r=bn(e,p)||r}}}const d=Xs(r,a),u=ca(d);if(n.enharmonicPreference&&u&&ua(u)){const h=da(u);if(h)return h}return u},getDegreesForNotes(n,t){return!n||n.length===0?[]:n.map(e=>{const o=Hi(e)||e,i=Xs(t,o);return ca(i)}).filter(e=>e!==null)},getRomanNumeralForNotes(n,t){if(!n||n.length<2)return null;const[e]=Jl(n);if(!e)return null;const o=tc(e),i=o?.symbol;if(!i)return null;const[s]=ec(t,[i]);if(!s)return null;const a=nc(s),r=a?.roman;if(!r)return null;let c=a.name.replace(r,"");const d=o?.tonic||t;return c==="6"&&(c="add6"),{roman:r,ext:c,root:d}}},Ki="",Ji="",jo="/",uo=()=>window.animationEffectsManager,ts=()=>l.state.placedNotes,Zo=n=>{const t=n?.split("-")[1];return Number.parseInt(t??"0",10)};function Ir(n){if(!n||typeof n.startColumnIndex!="number"||typeof n.endColumnIndex!="number")return!1;const t=n.shape==="circle"?n.startColumnIndex+1:n.startColumnIndex;return n.endColumnIndex>t}function Lr(n,t,e){const{cellWidth:o}=e,i=o*.25,s=n.uuid;if(!s)return 0;const a=t.filter(d=>!d.isDrum&&d.row===n.row&&d.startColumnIndex===n.startColumnIndex&&d.uuid&&d.uuid!==s);if(a.length===0)return 0;const r=[n,...a];return r.sort((d,u)=>Zo(d.uuid)-Zo(u.uuid)),r.findIndex(d=>d.uuid===s)*i}function kr(n,t){const{cellHeight:e}=t,o=uo();return o?.shouldAnimateNote?.(n)?(o.getVibratoYOffset?.(n.color)??0)*e:0}function Nr(n,t,e){const o=uo(),i=o?.hasReverbEffect;if(!(typeof i=="function"?i(t.color):!!i))return{shouldApply:!1,blur:0,spread:0};const{cellWidth:a}=e,r=o?.getReverbEffect,c=typeof r=="function"?r(t.color):void 0;if(!c)return{shouldApply:!1,blur:0,spread:0};const d=c.blur*(a/2),u=c.spread*(a/3);return{shouldApply:d>0||u>0,blur:d,spread:u}}function Rr(n,t,e,o,i,s,a){const r=uo();if(!r?.hasDelayEffect?.(t.color))return;const{cellWidth:c}=e,d=r.getDelayEffects?.(t.color);!d||d.length===0||d.forEach((u,h)=>{const m=u.delay/500*c*2,g=o+m,f=s*u.scale,p=a*u.scale;n.save(),n.globalAlpha=u.opacity*.6,n.beginPath(),n.ellipse(g,i,f,p,0,0,2*Math.PI),n.strokeStyle=t.color,n.lineWidth=Math.max(.5,f*.1),n.setLineDash([2,2]),n.stroke(),n.restore()})}function Br(n,t,e,o,i,s){const a=uo();if(!a?.shouldFillNote?.(t))return;const r=a.getFillLevel?.(t)??0;if(r<=0)return;n.save();const c=1-r,d=n.createRadialGradient(e,o,0,e,o,Math.max(i,s));d.addColorStop(0,"transparent"),d.addColorStop(Math.max(0,c-.05),"transparent"),d.addColorStop(c,`${t.color}1F`),d.addColorStop(1,`${t.color}BF`),n.beginPath(),n.ellipse(e,o,i,s,0,0,2*Math.PI),n.clip(),n.fillStyle=d,n.fillRect(e-i-10,o-s-10,(i+10)*2,(s+10)*2),n.restore()}function ju(n,t,e,o,i,s){const a=uo();if(!a?.shouldFillNote?.(t))return;const r=a.getFillLevel?.(t)??0;if(r<=0)return;n.save(),n.beginPath(),n.arc(e,i,s,Math.PI/2,-Math.PI/2,!1),n.lineTo(o,i-s),n.arc(o,i,s,-Math.PI/2,Math.PI/2,!1),n.lineTo(e,i+s),n.closePath(),n.clip();const c=(e+o)/2,d=o-e,u=Math.max(d/2+s,s),h=1-r,m=n.createRadialGradient(c,i,0,c,i,u);m.addColorStop(0,"transparent"),m.addColorStop(Math.max(0,h-.05),"transparent"),m.addColorStop(h,`${t.color}1F`),m.addColorStop(1,`${t.color}BF`),n.fillStyle=m,n.fillRect(e-s-10,i-s-10,d+(s+10)*2,(s+10)*2),n.restore()}function Zu(n,t,e,o,i,s,a,r){if(ju(n,t,o,i,s,a),n.save(),n.beginPath(),n.arc(o,s,a,Math.PI/2,-Math.PI/2,!1),n.lineTo(i,s-a),n.arc(i,s,a,-Math.PI/2,Math.PI/2,!1),n.lineTo(o,s+a),n.closePath(),n.strokeStyle=t.color,n.lineWidth=r,n.shadowColor=t.color,n.shadowBlur=to,n.stroke(),n.shadowBlur=0,n.shadowColor="transparent",n.restore(),e.degreeDisplayMode!=="off"){const c=(o+i)/2;Ms(n,t,e,c,s,a)}}function Ku(n,t,e){const{cellHeight:o}=e,i=o/2*.12,s=n.uuid;if(!s)return 0;const a=t.filter(d=>!d.isDrum&&d.row===n.row&&d.startColumnIndex===n.startColumnIndex&&d.uuid&&d.uuid!==s&&Ir(d));if(a.length===0)return 0;const r=[n,...a];return r.sort((d,u)=>Zo(d.uuid)-Zo(u.uuid)),r.findIndex(d=>d.uuid===s)*i}function Ju(n,t){const e=ki.getDegreeForNote(n,t);if(!e)return{label:null,isAccidental:!1};if(!ki.hasAccidental(e))return{label:e,isAccidental:!1};const i=l.state.accidentalMode||{},s=i.sharp??!0,a=i.flat??!0;if(!s&&!a)return{label:null,isAccidental:!0};let r=e.includes(Ki)?e:null,c=e.includes(Ji)?e:null;const d=ki.getEnharmonicDegree(e);d&&(d.includes(Ki)&&!r&&(r=d),d.includes(Ji)&&!c&&(c=d));let u=null;if(s&&a){const h=[];r&&h.push(r),c&&(!r||c!==r)&&h.push(c),u=h.join(jo),u||(u=e)}else s?u=r||e:a&&(u=c||e);return{label:u,isAccidental:!0}}function th(n){if(!n)return{multiplier:1,category:"natural"};const t=n.includes(Ji),e=n.includes(Ki),o=n.includes(jo);return!t&&!e?{multiplier:1,category:"natural"}:o?{multiplier:.75,category:"both-accidentals"}:{multiplier:.88,category:"single-accidental"}}function Ms(n,t,e,o,i,s,a){const{label:r}=Ju(t,e);if(!r)return;const{multiplier:c,category:d}=th(r);let u;if(t.shape==="circle"){const m=s*2*Zd;switch(d){case"natural":u=m;break;case"single-accidental":u=m*.8;break;case"both-accidentals":u=m*.4;break;default:u=m*c}}else{const m=s*2*jd;switch(d){case"natural":u=m*1.5;break;case"single-accidental":u=m*1.2;break;case"both-accidentals":u=m;break;default:u=m*c}}const h=u;if(!(h<Kd))if(n.fillStyle="#212529",n.font=`bold ${h}px 'Atkinson Hyperlegible', sans-serif`,n.textAlign="center",n.textBaseline="middle",t.shape==="oval"&&d==="both-accidentals"&&r.includes(jo)){const m=r.split(jo),g=h*1.1,f=g*(m.length-1),p=i-f/2;m.forEach((v,w)=>{const y=p+w*g,C=h*.08;n.fillText(v.trim(),o,y+C)})}else{const m=h*.08;n.fillText(r,o,i+m)}}function Xn(n,t){return Number.isFinite(n)&&n>0&&Number.isFinite(t)&&t>0}function Es(n,t,e,o){const{cellWidth:i,cellHeight:s,tempoModulationMarkers:a}=t,r=pt(o,t),c=kr(e,t),d=r+c,u=J(e.startColumnIndex,t);let h;if(a&&a.length>0?h=J(e.startColumnIndex+1,t)-u:h=i,!Xn(h,s))return;const m=Lr(e,ts(),t),g=u+h+m,f=Math.max(Jd,h*tu),p=s/2-f/2,v=Ir(e),w=l.state.longNoteStyle||"style1";if(v&&w==="style2"){const P=g,T=J(e.endColumnIndex,t);if(!Xn(T-P,p))return;Zu(n,e,t,P,T,d,p,f);return}if(v){const P=J(e.endColumnIndex+1,t),T=Ku(e,ts(),t),M=d+T;n.beginPath(),n.moveTo(g,M),n.lineTo(P,M),n.strokeStyle=e.color,n.lineWidth=Math.max(nu,h*eu),n.stroke()}const y=h-f/2;if(!Xn(y,p))return;Rr(n,e,t,g,d,y,p),n.save(),Br(n,e,g,d,y,p);const C=Nr(n,e,t);C.shouldApply&&(n.shadowColor=e.color,n.shadowBlur=to+C.blur,n.shadowOffsetX=C.spread),n.beginPath(),n.ellipse(g,d,y,p,0,0,2*Math.PI),n.strokeStyle=e.color,n.lineWidth=f,C.shouldApply||(n.shadowColor=e.color,n.shadowBlur=to),n.stroke(),n.shadowBlur=0,n.shadowColor="transparent",n.shadowOffsetX=0,n.restore(),t.degreeDisplayMode!=="off"&&Ms(n,e,t,g,d,y)}function Ps(n,t,e,o){const{columnWidths:i,cellWidth:s,cellHeight:a,tempoModulationMarkers:r}=t,c=pt(o,t),d=kr(e,t),u=c+d,h=J(e.startColumnIndex,t);let m;if(r&&r.length>0?m=J(e.startColumnIndex+1,t)-h:m=((t.musicalColumnWidths&&t.musicalColumnWidths.length>0?t.musicalColumnWidths:i)[e.startColumnIndex]??0)*s,!Xn(m,a))return;const g=Lr(e,ts(),t),f=Math.max(.5,m*.15),p=h+m/2+g,v=m/2-f/2,w=a/2-f/2;if(!Xn(v,w))return;Rr(n,e,t,p,u,v,w),n.save(),Br(n,e,p,u,v,w);const y=Nr(n,e,t);y.shouldApply&&(n.shadowColor=e.color,n.shadowBlur=to+y.blur,n.shadowOffsetX=y.spread),n.beginPath(),n.ellipse(p,u,v,w,0,0,2*Math.PI),n.strokeStyle=e.color,n.lineWidth=f,y.shouldApply||(n.shadowColor=e.color,n.shadowBlur=to),n.stroke(),n.shadowBlur=0,n.shadowColor="transparent",n.shadowOffsetX=0,n.restore(),t.degreeDisplayMode!=="off"&&Ms(n,e,t,p,u,v)}function Dr(n,t,e){const{cellWidth:o,cellHeight:i,tempoModulationMarkers:s}=t,a=pt(e.globalRow??e.row,t);let r=e.columnIndex;if(e.uuid){const v=Ft.getColumnMap(l.state).entries.find(w=>w.type==="tonic"&&w.tonicSignUuid===e.uuid&&typeof w.canvasIndex=="number");v&&typeof v.canvasIndex=="number"&&(r=v.canvasIndex)}const c=J(r,t);let d;s&&s.length>0?d=J(r+1,t)-c:d=o;const u=d*2,h=c+u/2,m=Math.min(u,i)/2*.9;if(m<2||(n.beginPath(),n.arc(h,a,m,0,2*Math.PI),n.strokeStyle="#212529",n.lineWidth=Math.max(.5,d*.05),n.stroke(),e.tonicNumber==null))return;const g=e.tonicNumber.toString(),f=m*1.5;f<6||(n.fillStyle="#212529",n.font=`bold ${f}px 'Atkinson Hyperlegible', sans-serif`,n.textAlign="center",n.textBaseline="middle",n.fillText(g,h,a))}const es=[{id:1,diamonds:[0],ovals:[],label:"left 8th"},{id:2,diamonds:[1],ovals:[],label:"e"},{id:3,diamonds:[2],ovals:[],label:"right 8th"},{id:4,diamonds:[3],ovals:[],label:"a"},{id:5,diamonds:[0,1],ovals:[],label:"1 e"},{id:6,diamonds:[1,2],ovals:[],label:"e &"},{id:7,diamonds:[2,3],ovals:[],label:"& a"},{id:8,diamonds:[0,2],ovals:[],label:"two 8ths"},{id:9,diamonds:[1,3],ovals:[],label:"e a"},{id:10,diamonds:[0,1,2],ovals:[],label:"1 e + right 8th"},{id:11,diamonds:[1,2,3],ovals:[],label:"e & a"},{id:12,diamonds:[0,1,3],ovals:[],label:"1 e a"},{id:13,diamonds:[0,2,3],ovals:[],label:"left 8th + & a"},{id:14,diamonds:[0,3],ovals:[],label:"left 8th + a"},{id:15,diamonds:[0,1,2,3],ovals:[],label:"1 e & a"}];function ci(n){return es.find(t=>t.id===n)}function ha(n,t,e,o){const i=Math.sqrt(3)/2*e,s=Math.max(1,o-2*i),a=t-(s/2+i),r=a+i,c=r+s,d=c+i,u=n-e/2,h=n+e/2;return`M ${[`${n},${a}`,`${u},${r}`,`${u},${c}`,`${n},${d}`,`${h},${c}`,`${h},${r}`].join(" ")} Z`.replace(/,/g," ")}class eh{options;constructor(t={}){this.options={diamondW:30,diamondH:120,ovalRx:30,ovalRy:60,strokeWidth:2,...t}}renderToCanvas(t,e,o,i,s,a,r="#000",c=null,d=null){const u=s/100*.8,h=a/100*.8,m=this.options.diamondW*u,g=this.options.diamondH*h,f=this.options.ovalRx*u,p=this.options.ovalRy*h,v=[.125,.375,.625,.875].map(y=>o+y*s),w=i+a/2;t.save(),t.strokeStyle=r,t.fillStyle=r,t.lineWidth=this.options.strokeWidth,t.lineCap="round",t.lineJoin="round",e.ovals.forEach(y=>{const C=y===0?o+.25*s:o+.75*s;let P=w;if(c&&d){const T=`oval_${y}`,M=c.shapeOffsets?.[T]||0,A=c.row+M;P=d(A)}t.beginPath(),t.ellipse(C,P,f,p,0,0,Math.PI*2),t.stroke()}),e.diamonds.forEach(y=>{const C=v[y];if(C===void 0)return;let P=w;if(c&&d){const A=`diamond_${y}`,x=c.shapeOffsets?.[A]||0,k=c.row+x;P=d(k)}const T=ha(C,P,m,g),M=new Path2D(T);t.stroke(M)}),t.restore()}renderToSVG(t,e=100,o=100){const i=document.createElementNS("http://www.w3.org/2000/svg","svg");i.setAttribute("viewBox",`0 0 ${e} ${o}`),i.style.color="#000000";const s=Math.min(e/100,o/100)*.8,a=this.options.diamondW*s,r=this.options.diamondH*s,c=this.options.ovalRx*s,d=this.options.ovalRy*s,u=[12.5,37.5,62.5,87.5],h=o/2;return t.ovals.forEach(m=>{const g=m===0?25:75,f=document.createElementNS("http://www.w3.org/2000/svg","ellipse");f.setAttribute("cx",String(g)),f.setAttribute("cy",String(h)),f.setAttribute("rx",String(c)),f.setAttribute("ry",String(d)),f.setAttribute("fill","none"),f.setAttribute("stroke","currentColor"),f.setAttribute("stroke-width",String(this.options.strokeWidth*2)),f.setAttribute("stroke-linecap","round"),i.appendChild(f)}),t.diamonds.forEach(m=>{const g=u[m];if(g===void 0)return;const f=ha(g,h,a,r),p=document.createElementNS("http://www.w3.org/2000/svg","path");p.setAttribute("d",f),p.setAttribute("fill","none"),p.setAttribute("stroke","currentColor"),p.setAttribute("stroke-width",String(this.options.strokeWidth*2)),p.setAttribute("stroke-linejoin","round"),p.setAttribute("stroke-linecap","round"),i.appendChild(p)}),i}}const Ts=new eh;b.moduleLoaded("SixteenthStampRenderer","stamps");function nh(n,t){const e=l.getAllSixteenthStampPlacements?.()??l.state?.sixteenthStampPlacements??[];e.length!==0&&(b.debug("SixteenthStampRenderer",`Rendering ${e.length} stamps`,{count:e.length},"stamps"),e.forEach(o=>{oh(n,o,t)}))}function oh(n,t,e){const o=ci(t.sixteenthStampId);if(!o)return;const{startColumn:i,row:s,color:a}=t,r=l.state,c=J(i,e),u=pt(s,e)-e.cellHeight/2,h=qe(i,r);let m;if(h!==null){const y=h+2;m=Kt(y,r)}else m=i+2;const f=J(m,e)-c,p=e.cellHeight,v=qt(n.canvas);if(c+f<0||c>v)return;const w=y=>pt(y,e);Ts.renderToCanvas(n,o,c,u,f,p,a,t,w),n.save(),n.globalAlpha=.1,n.fillStyle=a,n.fillRect(c+1,u+1,f-2,p-2),n.restore(),b.debug("SixteenthStampRenderer",`Rendered stamp ${t.sixteenthStampId} at ${i}-${m},${s}`,{sixteenthStampId:t.sixteenthStampId,startColumn:i,effectiveEndColumn:m,row:s,stampX:c,stampY:u,hasOffsets:!!t.shapeOffsets},"stamps")}function ih(n,t,e,o,i){if(!o)return;const s=l.state,a=J(t,i),c=pt(e,i)-i.cellHeight/2,d=qe(t,s);let u;if(d!==null){const f=d+2;u=Kt(f,s)}else u=t+2;const m=J(u,i)-a,g=i.cellHeight;n.save(),n.globalAlpha=.6,Ts.renderToCanvas(n,o,a,c,m,g,i.previewColor||"#4a90e2"),n.restore()}function fa(n,t,e){return[{id:t+0,span:n,hits:[0],label:`${e} [1]`},{id:t+1,span:n,hits:[1],label:`${e} [2]`},{id:t+2,span:n,hits:[2],label:`${e} [3]`},{id:t+3,span:n,hits:[0,1],label:`${e} [1 2]`},{id:t+4,span:n,hits:[1,2],label:`${e} [2 3]`},{id:t+5,span:n,hits:[0,2],label:`${e} [1 3]`},{id:t+6,span:n,hits:[0,1,2],label:`${e} [1 2 3]`}]}const Oo=[...fa("eighth",1,"8th triplet"),...fa("quarter",8,"Quarter triplet")],Fr={eighth:1,quarter:2},Wr=[16.6667,50,83.3333];function di(n){return Oo.find(t=>t.id===n)}b.moduleLoaded("TripletStampRenderer","triplets");function sh(n,t){const e=l.getAllTripletStampPlacements?.()??l.state?.tripletStampPlacements??[];e.length!==0&&(b.debug("TripletStampRenderer",`Rendering ${e.length} triplet groups`,{count:e.length},"triplets"),e.forEach(o=>{ah(n,o,t)}))}function ah(n,t,e){const o=di(t.tripletStampId);if(!o)return;const{startTimeIndex:i,span:s,row:a,color:r}=t,c=s*2,d=Kt(i,l.state),u=d+c,h=J(d,e),m=pt(a,e),g=m-e.cellHeight/2,p=J(u,e)-h,v=e.cellHeight,w=qt(n.canvas);if(h+p<0||h>w)return;Or(n,o,h,m,p,v,r,t,C=>pt(C,e)),n.save(),n.globalAlpha=.1,n.fillStyle=r,n.fillRect(h+1,g+1,p-2,v-2),n.restore()}function Or(n,t,e,o,i,s,a,r=null,c=null){const d=i/100*.8,u=s/100*.8,h=Math.max(1,3*u);t.hits.forEach(m=>{const g=Wr[m]??50,f=e+i*g/100;let p=o;if(r&&c){const v=`triplet_${m}`,w=r.shapeOffsets?.[v]||0,y=r.row+w;p=c(y),w!==0&&b.debug("TripletStampRenderer","Drawing notehead with offset",{slot:m,shapeKey:v,rowOffset:w,baseRow:r.row,shapeRow:y,y:p},"triplets")}rh(n,f,p,a,h,d,u)})}function rh(n,t,e,o="currentColor",i=4,s=1,a=1){const r=20*s,c=60*a;n.strokeStyle=o,n.lineWidth=i,n.fillStyle="none",n.beginPath(),n.ellipse(t,e,r,c,0,0,2*Math.PI),n.stroke()}function lh(n,t,e,o,i){if(!o)return;const a=(o.span==="eighth"?1:2)*2,r=Kt(t,l.state),c=J(r,i),d=pt(e,i),u=r+a,m=J(u,i)-c,g=i.cellHeight;n.save(),n.globalAlpha=.6;const f=i.previewColor||"#4a90e2";Or(n,o,c,d,m,g,f),n.restore()}function ch(n,t){if(n===0)return J(0,t);const e=n-1,o=Zt(l.state,e);return o?J(o.endColumn+1,t):(b.warn("ModulationRenderer","Could not find measure info for index",{measureIndex:n},"grid"),n*200)}function _r(n,t){const{tempoModulationMarkers:e}=t;if(!e||e.length===0)return;const o=e.filter(s=>s.active).map(s=>{let a;if(s.columnIndex!==null&&s.columnIndex!==void 0)a=J(s.columnIndex+1,t);else if(s.macrobeatIndex!==null&&s.macrobeatIndex!==void 0&&s.macrobeatIndex>=0){const r=Zt(l.state,s.macrobeatIndex);r?a=J(r.endColumn+1,t):(b.warn("ModulationRenderer","Could not find macrobeat info for index",{macrobeatIndex:s.macrobeatIndex},"grid"),a=s.xPosition??0)}else s.measureIndex!==null&&s.measureIndex!==void 0?a=ch(s.measureIndex,t):a=s.xPosition??0;return{...s,xCanvas:a}});n.save();const i=t.showModulationLabel!==!1;o.forEach(s=>{dh(n,s,i)}),n.restore()}function dh(n,t,e){const o=t.xCanvas,i=t.ratio,s=mr(i),a=fr(i);uh(n,o,s),e&&hh(n,o,a,s)}function uh(n,t,e){const i=Pt(n.canvas);n.beginPath(),n.moveTo(t,0),n.lineTo(t,i),n.lineWidth=3,n.strokeStyle=e,n.setLineDash([]),n.stroke()}function hh(n,t,e,o){const s="Arial, sans-serif";n.font=`14px ${s}`,n.textAlign="center",n.textBaseline="middle";const u=n.measureText(e).width,h=14,m=u+12,g=h+12,f=t-m/2,p=20;fh(n,f,p,m,g,8,o),n.fillStyle="#212529",n.fillText(e,t,p+g/2)}function fh(n,t,e,o,i,s,a){n.beginPath(),n.moveTo(t+s,e),n.lineTo(t+o-s,e),n.quadraticCurveTo(t+o,e,t+o,e+s),n.lineTo(t+o,e+i-s),n.quadraticCurveTo(t+o,e+i,t+o-s,e+i),n.lineTo(t+s,e+i),n.quadraticCurveTo(t,e+i,t,e+i-s),n.lineTo(t,e+s),n.quadraticCurveTo(t,e,t+s,e),n.closePath(),n.fillStyle=a,n.fill(),n.strokeStyle="rgba(0, 0, 0, 0.2)",n.lineWidth=1,n.stroke()}function ma(n,t,e){const{xCanvas:o}=e,i=6,s=40;return Math.abs(n-o)<=i/2?t<=s?{marker:e,type:"label",canDrag:!1}:{marker:e,type:"barline",canDrag:!0}:null}function pa(n){if(!n)return"default";switch(n.type){case"label":return"pointer";case"barline":return n.canDrag?"ew-resize":"pointer";default:return"default"}}function he(n){return n.x??n.col??0}function fe(n){return n.y??n.row??0}function oo(n,t){if(!t||t.length<3)return!1;const e=he(n),o=fe(n);let i=!1;for(let s=0,a=t.length-1;s<t.length;a=s++){const r=he(t[s]),c=fe(t[s]),d=he(t[a]),u=fe(t[a]);c>o!=u>o&&e<(d-r)*(o-c)/(u-c)+r&&(i=!i)}return i}function mh(n){if(!n||n.length<3)return n;const t=n.map(s=>({x:he(s),y:fe(s)}));if(t.length===0)return[];let e=t[0];for(let s=1;s<t.length;s++){const a=t[s];(a.y<e.y||a.y===e.y&&a.x<e.x)&&(e=a)}const o=t.filter(s=>s!==e);if(o.sort((s,a)=>{const r=Math.atan2(s.y-e.y,s.x-e.x),c=Math.atan2(a.y-e.y,a.x-e.x);if(r!==c)return r-c;const d=Math.hypot(s.x-e.x,s.y-e.y),u=Math.hypot(a.x-e.x,a.y-e.y);return d-u}),o.length===0)return[e];const i=[e,o[0]];for(let s=1;s<o.length;s++){const a=o[s];for(;i.length>1&&!ph(i[i.length-2],i[i.length-1],a);)i.pop();i.push(a)}return i}function ph(n,t,e){const o=he(n),i=fe(n),s=he(t),a=fe(t),r=he(e),c=fe(e);return(s-o)*(c-i)-(a-i)*(r-o)>0}function gh(n,t,e,o=10){const i=he(n),s=fe(n),a=he(t),r=fe(t),c=he(e),d=fe(e),u=c-a,h=d-r,m=u*u+h*h;if(m===0)return Math.hypot(i-a,s-r)<=o;let g=((i-a)*u+(s-r)*h)/m;g=Math.max(0,Math.min(1,g));const f=a+g*u,p=r+g*h;return Math.hypot(i-f,s-p)<=o}function ga(n,t,e=10){if(!t||t.length<2)return!1;for(let o=0;o<t.length;o++){const i=t[o],s=t[(o+1)%t.length];if(gh(n,i,s,e))return!0}return!1}function vh(n,t){const{centerX:e,centerY:o,rx:i,ry:s}=t,a=16;for(let r=0;r<a;r++){const c=r/a*2*Math.PI,d=e+i*Math.cos(c),u=o+s*Math.sin(c);if(oo({x:d,y:u},n))return!0}return!!oo({x:e,y:o},n)}function va(n,t){const{x:e,y:o,width:i,height:s}=t,a=[{x:e,y:o},{x:e+i,y:o},{x:e+i,y:o+s},{x:e,y:o+s}];for(const r of a)if(oo(r,n))return!0;for(const r of n){const c=he(r),d=fe(r);if(c>=e&&c<=e+i&&d>=o&&d<=o+s)return!0}return!1}function zr(n,t,e,o,i,s){const a=i-e,r=s-o,c=a*a+r*r;if(c===0){const f=n-e,p=t-o;return Math.sqrt(f*f+p*p)}let d=((n-e)*a+(t-o)*r)/c;d=Math.max(0,Math.min(1,d));const u=e+d*a,h=o+d*r,m=n-u,g=t-h;return Math.sqrt(m*m+g*g)}function bh(n){const{x:t,y:e,annotations:o,getRenderOptions:i}=n,s=10;let a=!1;const r=i();return{nextAnnotations:o.filter(d=>{let u=!0;if(d.type==="arrow"){const h=J(d.startCol,r),m=pt(d.startRow,r),g=J(d.endCol,r),f=pt(d.endRow,r);zr(t,e,h,m,g,f)<s&&(u=!1,a=!0)}else if(d.type==="text"){const h=J(d.col,r),m=pt(d.row,r),g=J(d.col+d.widthCols,r),f=pt(d.row+d.heightRows,r);t>=h&&t<=g&&e>=m&&e<=f&&(u=!1,a=!0)}else if(d.type==="marker"||d.type==="highlighter")for(let h=0;h<d.path.length;h++){const m=J(d.path[h].col,r),g=pt(d.path[h].row,r),f=t-m,p=e-g;if(Math.sqrt(f*f+p*p)<s){u=!1,a=!0;break}}return u}),changed:a}}function wh(n){const{lassoPath:t,state:e,renderOptions:o,isAdditive:i,existingSelectedItems:s}=n,a=[];i&&Array.isArray(s)&&a.push(...s),e.placedNotes.forEach((c,d)=>{if(c.isDrum)return;const u=c.startColumnIndex,h=J(u,o),m=pt(c.row,o),{cellWidth:g,cellHeight:f}=o;let p=g;o.tempoModulationMarkers&&o.tempoModulationMarkers.length>0&&(p=J(u+1,o)-h);const v=c.shape==="oval"?h+p:h+p/2,w=m,y=c.shape==="oval"?p:p/2,C=f/2;if(vh(t,{centerX:v,centerY:w,rx:y,ry:C})){const P=`note-${c.row}-${u}-${c.color}-${c.shape}`;a.find(T=>T.id===P)||a.push({type:"note",id:P,data:c,index:d})}}),e.sixteenthStampPlacements.forEach((c,d)=>{const{cellWidth:u,cellHeight:h}=o,m=J(c.startColumn,o),g=pt(c.row,o)-h/2,f=u*2;if(va(t,{x:m,y:g,width:f,height:h})){const v=`sixteenth-stamp-${c.row}-${c.startColumn}-${c.sixteenthStampId}`;a.find(w=>w.id===v)||a.push({type:"sixteenthStamp",id:v,data:c,index:d})}}),e.tripletStampPlacements.forEach((c,d)=>{const{cellHeight:u}=o,h=Kt(c.startTimeIndex,e),m=h+c.span*2,g=J(h,o),f=J(m,o)-g,p=pt(c.row,o)-u/2;if(va(t,{x:g,y:p,width:f,height:u})){const w=`triplet-stamp-${c.row}-${h}-${c.tripletStampId}`;a.find(y=>y.id===w)||a.push({type:"tripletStamp",id:w,data:c,index:d})}});const r=io({selectedItems:a,renderOptions:o,state:e});return{selectedItems:a,convexHull:r,isActive:a.length>0}}function io(n){const{selectedItems:t,renderOptions:e,state:o}=n;if(!t.length)return null;const i=o??l.state,s=t.map(a=>{const r=a.type==="note"?a.data.startColumnIndex:a.type==="sixteenthStamp"?a.data.startColumn:Kt(a.data.startTimeIndex,i),c=J(r,e),d=pt(a.data.row,e);return{x:c,y:d}});return mh(s)}function yh(n){const{canvasX:t,canvasY:e,state:o,renderOptions:i,selection:s}=n;if(!s?.isActive)return null;const a=n.thresholdPx??15;let r=null;if(o.placedNotes.forEach(u=>{const h=u.startColumnIndex,m=J(h,i),g=pt(u.row,i);Math.hypot(t-m,e-g)<=a&&(r=`note-${u.row}-${h}-${u.color}-${u.shape}`)}),r||o.sixteenthStampPlacements.forEach(u=>{const h=u.startColumn+1,m=J(h,i),g=pt(u.row,i);Math.hypot(t-m,e-g)<=a&&(r=`sixteenth-stamp-${u.row}-${u.startColumn}-${u.sixteenthStampId}`)}),r||o.tripletStampPlacements.forEach(u=>{const h=Kt(u.startTimeIndex,o),m=h+u.span,g=J(m,i),f=pt(u.row,i);Math.hypot(t-g,e-f)<=a&&(r=`triplet-stamp-${u.row}-${h}-${u.tripletStampId}`)}),!r)return null;const c=s.selectedItems.filter(u=>u.id!==r),d=io({selectedItems:c,renderOptions:i});return{nextSelection:{selectedItems:c,convexHull:d,isActive:c.length>0},changed:!0}}function Sh(n){const{selection:t,selectionDragStart:e,selectionDragTotal:o,currentPointerGrid:i,initialDragStartRank:s,currentStartRank:a,renderOptions:r}=n,c=s!==null?a-s:0,d=i.row-c,u=Math.round(i.col-e.col),h=Math.round(d-e.row),m={col:u-o.col,row:h-o.row};if(m.col===0&&m.row===0)return{moved:!1,nextSelectionDragTotal:o,nextConvexHull:t.convexHull};const g=(w,y)=>typeof y=="number"?y:w,f=(w,y)=>{const C=l.state.columnWidths?.length??0;let P=w;for(;P>=0&&P<C;){const T=qe(P,l.state);if(T!==null)return T;P+=y}return null};t.selectedItems.forEach(w=>{if(w.type==="note"){const C=g(w.data.row,w.data.globalRow)+m.row;w.data.globalRow=C,w.data.row=C,w.data.startColumnIndex=w.data.startColumnIndex+m.col,w.data.endColumnIndex=w.data.endColumnIndex+m.col}else if(w.type==="sixteenthStamp"){const C=g(w.data.row,w.data.globalRow)+m.row;w.data.globalRow=C,w.data.row=C,w.data.startColumn=w.data.startColumn+m.col,w.data.endColumn=w.data.endColumn+m.col}else if(w.type==="tripletStamp"){const C=g(w.data.row,w.data.globalRow)+m.row;if(w.data.globalRow=C,w.data.row=C,m.col!==0){const T=Kt(w.data.startTimeIndex,l.state)+m.col,M=Math.sign(m.col)||1,A=f(T,M);A!==null&&(w.data.startTimeIndex=A)}}});const p={col:u,row:h},v=io({selectedItems:t.selectedItems,renderOptions:r,state:l.state});return t.convexHull=v,{moved:!0,nextSelectionDragTotal:p,nextConvexHull:v}}function Ch(n){const{ctx:t,annotation:e,isTemp:o=!1,isSelected:i=!1,isHovered:s=!1,getStrokeWidth:a,getLineDash:r}=n,{startX:c,startY:d,endX:u,endY:h,settings:m}=e;t.save(),i&&(t.strokeStyle="#4a90e2",t.lineWidth=a(m.strokeWeight)+4,t.globalAlpha=.3,t.setLineDash([]),t.beginPath(),t.moveTo(c,d),t.lineTo(u,h),t.stroke(),t.globalAlpha=1),s&&!i&&(t.strokeStyle="#4a90e2",t.lineWidth=a(m.strokeWeight)+4,t.globalAlpha=.15,t.setLineDash([]),t.beginPath(),t.moveTo(c,d),t.lineTo(u,h),t.stroke(),t.globalAlpha=1),t.strokeStyle=o?"rgba(0, 0, 0, 0.5)":"#000000",t.lineWidth=a(m.strokeWeight),t.setLineDash(r(m.lineStyle));const g=Math.atan2(h-d,u-c),f=m.arrowheadSize||12;let p=c,v=d,w=u,y=h;m.startArrowhead!=="none"&&(p=c+Math.cos(g)*f,v=d+Math.sin(g)*f),m.endArrowhead!=="none"&&(w=u-Math.cos(g)*f,y=h-Math.sin(g)*f),t.beginPath(),t.moveTo(p,v),t.lineTo(w,y),t.stroke(),m.startArrowhead!=="none"&&ba({ctx:t,x:c,y:d,angle:g+Math.PI,type:m.startArrowhead,size:f}),m.endArrowhead!=="none"&&ba({ctx:t,x:u,y:h,angle:g,type:m.endArrowhead,size:f}),t.restore()}function ba(n){const{ctx:t,x:e,y:o,angle:i,type:s,size:a}=n;switch(t.save(),t.translate(e,o),t.rotate(i),t.setLineDash([]),s){case"filled":case"filled-arrow":t.beginPath(),t.moveTo(0,0),t.lineTo(-a,-a/2),t.lineTo(-a,a/2),t.closePath(),t.fillStyle=t.strokeStyle,t.fill();break;case"unfilled":case"unfilled-arrow":t.beginPath(),t.moveTo(0,0),t.lineTo(-a,-a/2),t.lineTo(-a,a/2),t.closePath(),t.stroke();break;case"circle":t.beginPath(),t.arc(0,0,a/3,0,Math.PI*2),t.fillStyle=t.strokeStyle,t.fill();break}t.restore()}b.moduleLoaded("AnnotationService","annotation");class Ah{canvas;ctx;currentTool;toolSettings;tempEraserMode;isDrawing;currentPath;startPoint;tempAnnotation;selectedAnnotation;hoverAnnotation;eraserCursor;isDragging;dragOffset;isResizing;resizeHandle;resizeStartBounds;isDraggingSelection;selectionDragStart;selectionDragTotal;lastPointerPosition;initialDragStartRank;constructor(){this.toolSettings=null,this.tempEraserMode=!1,this.currentTool=null,this.isDrawing=!1,this.currentPath=[],this.startPoint=null,this.tempAnnotation=null,this.selectedAnnotation=null,this.hoverAnnotation=null,this.eraserCursor=null,this.isDragging=!1,this.dragOffset=null,this.isResizing=!1,this.resizeHandle=null,this.resizeStartBounds=null,this.isDraggingSelection=!1,this.selectionDragStart=null,this.selectionDragTotal=null,this.lastPointerPosition=null,this.initialDragStartRank=null}initialize(){const t=document.getElementById("notation-grid");if(!(t instanceof HTMLCanvasElement)){b.error("AnnotationService","Pitch grid canvas not found",null,"annotation");return}const e=t.getContext("2d");if(!e){b.error("AnnotationService","Pitch grid context not available",null,"annotation");return}this.canvas=t,this.ctx=e,this.setupEventListeners(),l.on("annotationsChanged",()=>{this.selectedAnnotation=null,this.render()}),l.on("scrollByUnits",o=>{typeof o=="number"&&this.handleSelectionScroll(o)}),b.initSuccess("AnnotationService")}setupEventListeners(){this.canvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this.handleMouseMove.bind(this)),this.canvas.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvas.addEventListener("mouseleave",this.handleMouseLeave.bind(this)),this.canvas.addEventListener("dblclick",this.handleDoubleClick.bind(this)),this.canvas.addEventListener("wheel",this.handleWheel.bind(this),{passive:!0}),this.canvas.addEventListener("contextmenu",t=>t.preventDefault()),this.registerScrollSyncTarget(document.getElementById("pitch-grid-wrapper")),this.registerScrollSyncTarget(document.getElementById("canvas-container")),window.addEventListener("scroll",this.handleScroll.bind(this),{passive:!0}),window.addEventListener("wheel",this.handleWheel.bind(this),{passive:!0}),document.addEventListener("keydown",this.handleKeyDown.bind(this))}handleKeyDown(t){if(!this.selectedAnnotation)return;const e=document.activeElement;if(e instanceof HTMLElement){const o=e.isContentEditable,i=e.tagName.toLowerCase();if(["input","textarea"].includes(i)||o)return}(t.key==="Delete"||t.key==="Backspace")&&(t.preventDefault(),this.deleteSelectedAnnotation())}deleteSelectedAnnotation(){if(!this.selectedAnnotation)return;const t=l.state.annotations.indexOf(this.selectedAnnotation);t>-1&&(l.state.annotations.splice(t,1),this.selectedAnnotation=null,l.recordState(),this.render(),b.log("AnnotationService","Deleted annotation","annotation"))}resize(){const t=document.getElementById("notation-grid");t instanceof HTMLCanvasElement&&(this.canvas.width=t.width,this.canvas.height=t.height,this.render())}getRenderOptions(){return{columnWidths:l.state.columnWidths,cellWidth:l.state.cellWidth,cellHeight:l.state.cellHeight,tempoModulationMarkers:l.state.tempoModulationMarkers,baseMicrobeatPx:l.state.cellWidth}}canvasToGrid(t,e){const o=this.getRenderOptions();return{col:ji(t,o),row:Lu(e,o)}}canvasToGridFresh(t,e){const o=this.getRenderOptions(),i=Ht.getViewportInfo(),s=o.cellHeight/2;return{col:ji(t,o),row:e/s+i.startRank-1}}gridToCanvas(t,e){const o=this.getRenderOptions();return{x:J(t,o),y:pt(e,o)}}setTool(t,e){if(this.currentTool=t,this.toolSettings=e,this.canvas)switch(t){case"arrow":case"text":this.canvas.style.cursor="crosshair";break;case"marker":case"highlighter":this.canvas.style.cursor=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16'><circle cx='8' cy='8' r='4' fill='rgba(0,0,0,0.5)'/></svg>") 8 8, crosshair`;break;case"lasso":this.canvas.style.cursor="crosshair";break;default:this.canvas.style.cursor="default"}}handleMouseDown(t){if(!this.currentTool||!this.toolSettings)return;const e=this.canvas.getBoundingClientRect(),o=t.clientX-e.left,i=t.clientY-e.top;this.lastPointerPosition={clientX:t.clientX,clientY:t.clientY};const s=this.canvasToGridFresh(o,i);if(t.button===2){if(this.currentTool==="lasso"&&l.state.lassoSelection?.isActive){this.removeFromLassoSelection(o,i);return}this.tempEraserMode=!0,this.isDrawing=!0,this.eraseAtPoint(o,i),this.showEraserCursor(o,i);return}if(this.selectedAnnotation?.type==="text"){const r=this.getResizeHandleAt(o,i,this.selectedAnnotation);if(r){this.isResizing=!0,this.resizeHandle=r,this.resizeStartBounds={col:this.selectedAnnotation.col,row:this.selectedAnnotation.row,widthCols:this.selectedAnnotation.widthCols,heightRows:this.selectedAnnotation.heightRows,mouseCol:s.col,mouseRow:s.row};return}}if(l.state.lassoSelection?.isActive&&l.state.lassoSelection.convexHull){const r=ga({x:o,y:i},l.state.lassoSelection.convexHull,10),c=oo({x:o,y:i},l.state.lassoSelection.convexHull);if(r||c){this.isDraggingSelection=!0,this.selectionDragStart={col:s.col,row:s.row},this.selectionDragTotal={col:0,row:0},this.lastPointerPosition={clientX:t.clientX,clientY:t.clientY},this.initialDragStartRank=Ht.getViewportInfo().startRank;return}}const a=this.getAnnotationAt(o,i);if(a&&(a.type==="arrow"||a.type==="text")){if(this.selectedAnnotation===a){this.isDragging=!0,a.type==="arrow"?this.dragOffset={startCol:s.col-a.startCol,startRow:s.row-a.startRow,endCol:s.col-a.endCol,endRow:s.row-a.endRow}:a.type==="text"&&(this.dragOffset={col:s.col-a.col,row:s.row-a.row});return}if(this.currentTool==="text"&&a.type==="text"){this.editTextAnnotation(a);return}this.selectedAnnotation=a,this.loadAnnotationSettings(a),this.render();return}else this.selectedAnnotation=null;switch(this.isDrawing=!0,this.startPoint=s,this.currentPath=[s],this.currentTool){case"arrow":this.tempAnnotation={type:"arrow",startCol:s.col,startRow:s.row,endCol:s.col,endRow:s.row,settings:{...this.toolSettings.arrow}};break;case"text":this.tempAnnotation={type:"text",startCol:s.col,startRow:s.row,endCol:s.col,endRow:s.row};break;case"marker":case"highlighter":this.tempAnnotation={type:this.currentTool,path:[s],settings:{...this.toolSettings[this.currentTool]}};break;case"lasso":this.tempAnnotation={type:"lasso",path:[{x:o,y:i}]};break}}handleMouseMove(t){const e=this.canvas.getBoundingClientRect(),o=t.clientX-e.left,i=t.clientY-e.top;this.lastPointerPosition={clientX:t.clientX,clientY:t.clientY};const s=this.canvasToGridFresh(o,i);if(this.tempEraserMode){this.eraseAtPoint(o,i),this.showEraserCursor(o,i);return}if(this.isResizing&&this.selectedAnnotation?.type==="text"){if(!this.resizeHandle||!this.resizeStartBounds)return;const a=s.col-this.resizeStartBounds.mouseCol,r=s.row-this.resizeStartBounds.mouseRow;let c=this.resizeStartBounds.col,d=this.resizeStartBounds.row,u=this.resizeStartBounds.widthCols,h=this.resizeStartBounds.heightRows;this.resizeHandle.includes("n")&&(d=this.resizeStartBounds.row+r,h=this.resizeStartBounds.heightRows-r),this.resizeHandle.includes("s")&&(h=this.resizeStartBounds.heightRows+r),this.resizeHandle.includes("w")&&(c=this.resizeStartBounds.col+a,u=this.resizeStartBounds.widthCols-a),this.resizeHandle.includes("e")&&(u=this.resizeStartBounds.widthCols+a);const m=2,g=1;u<m&&(this.resizeHandle.includes("w")&&(c=this.resizeStartBounds.col+this.resizeStartBounds.widthCols-m),u=m),h<g&&(this.resizeHandle.includes("n")&&(d=this.resizeStartBounds.row+this.resizeStartBounds.heightRows-g),h=g),this.selectedAnnotation.col=c,this.selectedAnnotation.row=d,this.selectedAnnotation.widthCols=u,this.selectedAnnotation.heightRows=h,this.render();return}if(this.isDraggingSelection&&this.selectionDragStart&&this.selectionDragTotal){this.applySelectionDrag(o,i);return}if(this.isDragging&&this.selectedAnnotation){this.selectedAnnotation.type==="arrow"?(this.selectedAnnotation.startCol=s.col-this.dragOffset.startCol,this.selectedAnnotation.startRow=s.row-this.dragOffset.startRow,this.selectedAnnotation.endCol=s.col-this.dragOffset.endCol,this.selectedAnnotation.endRow=s.row-this.dragOffset.endRow):this.selectedAnnotation.type==="text"&&(this.selectedAnnotation.col=s.col-this.dragOffset.col,this.selectedAnnotation.row=s.row-this.dragOffset.row),this.render();return}if(!this.isDrawing){this.updateHover(o,i);return}if(this.tempAnnotation)switch(this.currentTool){case"arrow":this.tempAnnotation.endCol=s.col,this.tempAnnotation.endRow=s.row,this.render();break;case"text":this.tempAnnotation.endCol=s.col,this.tempAnnotation.endRow=s.row,this.render();break;case"marker":case"highlighter":if(this.tempAnnotation.path.length>0){const a=this.tempAnnotation.path[this.tempAnnotation.path.length-1],r=this.interpolatePoints(a,s);this.tempAnnotation.path.push(...r)}else this.tempAnnotation.path.push(s);this.render();break;case"lasso":this.tempAnnotation.path.push({x:o,y:i}),this.render();break}}handleMouseUp(t){if(this.isResizing){this.isResizing=!1,this.resizeHandle=null,this.resizeStartBounds=null,l.recordState();return}if(this.isDraggingSelection){this.isDraggingSelection=!1,this.selectionDragStart=null,this.selectionDragTotal=null,this.lastPointerPosition=null,this.initialDragStartRank=null,l.recordState();return}if(this.isDragging){this.isDragging=!1,this.dragOffset=null,l.recordState();return}if(this.isDrawing){if(this.isDrawing=!1,this.tempEraserMode){this.tempEraserMode=!1,this.render();return}if(this.tempAnnotation){if(this.currentTool==="text"){const{startCol:e,startRow:o,endCol:i,endRow:s}=this.tempAnnotation,a=Math.abs(i-e),r=Math.abs(s-o),c=Math.min(e,i),d=Math.min(o,s);a>.5&&r>.2?this.createTextAnnotation(c,d,a,r):this.createTextAnnotation(e,o,8,2),this.tempAnnotation=null,this.render();return}this.currentTool==="lasso"?this.handleLassoSelection(t.shiftKey):(l.state.annotations.push(this.tempAnnotation),this.currentTool==="arrow"&&(this.selectedAnnotation=this.tempAnnotation),l.recordState()),this.tempAnnotation=null,this.render()}}}handleWheel(t){!this.isDraggingSelection||!this.selectionDragStart||!this.selectionDragTotal||((t.clientX!==0||t.clientY!==0)&&(this.lastPointerPosition={clientX:t.clientX,clientY:t.clientY}),requestAnimationFrame(()=>this.applySelectionDragFromLastPointer()))}handleScroll(){!this.isDraggingSelection||!this.selectionDragStart||!this.selectionDragTotal||requestAnimationFrame(()=>this.applySelectionDragFromLastPointer())}applySelectionDragFromLastPointer(){if(!this.canvas||!this.lastPointerPosition)return;const t=this.canvas.getBoundingClientRect(),e=this.lastPointerPosition.clientX-t.left,o=this.lastPointerPosition.clientY-t.top;this.applySelectionDrag(e,o)}registerScrollSyncTarget(t){t&&(t.addEventListener("wheel",this.handleWheel.bind(this),{passive:!0}),t.addEventListener("scroll",this.handleScroll.bind(this),{passive:!0}))}applySelectionDrag(t,e){if(!this.isDraggingSelection||!this.selectionDragStart||!this.selectionDragTotal)return;const o=this.getRenderOptions(),s=Ht.getViewportInfo().startRank,a=this.canvasToGridFresh(t,e),{moved:r,nextSelectionDragTotal:c}=Sh({selection:l.state.lassoSelection,selectionDragStart:this.selectionDragStart,selectionDragTotal:this.selectionDragTotal,currentPointerGrid:a,initialDragStartRank:this.initialDragStartRank,currentStartRank:s,renderOptions:o});r&&(this.selectionDragTotal.col=c.col,this.selectionDragTotal.row=c.row,this.render())}handleSelectionScroll(t){if(!l.state.lassoSelection?.isActive||this.isDraggingSelection)return;const e=this.getRenderOptions();l.state.lassoSelection.convexHull=io({selectedItems:l.state.lassoSelection.selectedItems,renderOptions:e}),this.render()}handleMouseLeave(t){this.isDrawing&&this.handleMouseUp(t)}handleDoubleClick(t){const e=this.canvas.getBoundingClientRect(),o=t.clientX-e.left,i=t.clientY-e.top,s=this.getAnnotationAt(o,i);s?.type==="text"&&this.editTextAnnotation(s)}editTextAnnotation(t){const{col:e,row:o,widthCols:i,heightRows:s,text:a,settings:r}=t,c=l.state.annotations.indexOf(t);c>-1&&(l.state.annotations.splice(c,1),this.selectedAnnotation=null,this.render()),this.createTextAnnotation(e,o,i,s,a,r)}createTextAnnotation(t,e,o,i,s=null,a=null){this.isDrawing=!1;const r=this.gridToCanvas(t,e),c=this.gridToCanvas(t+o,e+i),d=r.x,u=r.y,h=c.x-d,m=c.y-u,f=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',p=a||this.toolSettings.text,v=document.createElement("div");v.contentEditable="true",v.className="annotation-text-input",v.textContent=s||"Type here...";const w=p.size,y=w*1.2;v.style.width=`${h}px`,v.style.height=`${m}px`,v.style.padding=p.background?"4px 8px":"4px",v.style.border="2px dashed rgba(74, 144, 226, 0.5)",v.style.backgroundColor=p.background?"#ffffff":"transparent",v.style.color=p.color,v.style.fontSize=`${w}px`,v.style.lineHeight=`${y}px`,v.style.fontWeight=p.bold?"bold":"normal",v.style.fontStyle=p.italic?"italic":"normal",v.style.textDecoration=p.underline?"underline":"none",p.superscript?(v.style.fontSize=`${w*.6}px`,v.style.verticalAlign="super"):p.subscript&&(v.style.fontSize=`${w*.6}px`,v.style.verticalAlign="sub"),v.style.outline="none",v.style.zIndex="10000",v.style.position="fixed",v.style.cursor="text",v.style.pointerEvents="auto",v.style.fontFamily=f,v.style.whiteSpace="pre-wrap",v.style.wordWrap="break-word",v.style.overflow="hidden",v.style.boxSizing="border-box";const C=this.canvas.getBoundingClientRect();v.style.left=`${C.left+d}px`,v.style.top=`${C.top+u}px`,document.body.appendChild(v),v.focus();const P=document.createRange();P.selectNodeContents(v);const T=window.getSelection();T&&(T.removeAllRanges(),T.addRange(P));let M=!1;const A=()=>{if(M)return;M=!0;const k=v.textContent.trim();if(k&&k!=="Type here..."){const S={type:"text",col:t,row:e,widthCols:o,heightRows:i,text:k,settings:{...p}};l.state.annotations.push(S),this.selectedAnnotation=l.state.annotations[l.state.annotations.length-1],l.recordState(),this.render()}document.body.contains(v)&&document.body.removeChild(v)};let x=!1;v.addEventListener("input",()=>{!x&&v.textContent==="Type here..."&&(v.textContent="",x=!0)}),setTimeout(()=>{v.addEventListener("blur",A)},100),v.addEventListener("keydown",k=>{k.key==="Enter"&&!k.shiftKey&&(k.preventDefault(),A()),k.key==="Escape"&&(M=!0,document.body.contains(v)&&document.body.removeChild(v))})}handleLassoSelection(t=!1){if(!this.tempAnnotation?.path)return;const e=this.getRenderOptions();l.state.lassoSelection=wh({lassoPath:this.tempAnnotation.path,state:l.state,renderOptions:e,isAdditive:t,existingSelectedItems:l.state.lassoSelection?.selectedItems}),l.recordState(),b.log("AnnotationService",`Lasso selection completed: ${l.state.lassoSelection.selectedItems.length} items selected`,"annotation"),this.render()}updateLassoConvexHull(){if(!l.state.lassoSelection?.isActive||!l.state.lassoSelection.selectedItems?.length)return;const t=this.getRenderOptions();l.state.lassoSelection.convexHull=io({selectedItems:l.state.lassoSelection.selectedItems,renderOptions:t})}removeFromLassoSelection(t,e){if(!l.state.lassoSelection?.isActive)return;const o=this.getRenderOptions(),i=yh({canvasX:t,canvasY:e,state:l.state,renderOptions:o,selection:l.state.lassoSelection});i?.changed&&(l.state.lassoSelection=i.nextSelection,l.recordState(),this.render(),b.log("AnnotationService",`Removed item from lasso selection. ${i.nextSelection.selectedItems.length} items remain.`,"annotation"))}drawTempAnnotation(){if(this.tempAnnotation)switch(this.tempAnnotation.type){case"arrow":this.drawArrow(this.tempAnnotation,!0);break;case"text":this.drawTextBoxPreview(this.tempAnnotation);break;case"marker":this.drawPath(this.tempAnnotation,!1);break;case"highlighter":this.drawPath(this.tempAnnotation,!0);break;case"lasso":this.drawLassoPath(this.tempAnnotation);break}}drawTextBoxPreview(t){const{startX:e,startY:o,endX:i,endY:s}=t,a=this.ctx,r=Math.min(e,i),c=Math.min(o,s),d=Math.abs(i-e),u=Math.abs(s-o);a.save(),a.strokeStyle="rgba(74, 144, 226, 0.6)",a.lineWidth=2,a.setLineDash([5,5]),a.strokeRect(r,c,d,u),this.toolSettings.text.background&&(a.fillStyle="rgba(255, 255, 255, 0.8)",a.fillRect(r,c,d,u)),a.restore()}render(){En.render()}drawArrow(t,e=!1,o=!1,i=!1){Ch({ctx:this.ctx,annotation:t,isTemp:e,isSelected:o,isHovered:i,getStrokeWidth:this.getStrokeWidth.bind(this),getLineDash:this.getLineDash.bind(this)})}wrapText(t,e,o){const i=e.split(`
`),s=[];return i.forEach(a=>{if(!a.trim()){s.push("");return}const r=a.split(" ");let c="";r.forEach((d,u)=>{const h=c?c+" "+d:d;t.measureText(h).width>o&&c?(s.push(c),c=d):c=h}),c&&s.push(c)}),s}drawText(t,e=!1,o=!1){const{x:i,y:s,text:a,settings:r}=t,c=this.ctx;c.save();const u=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',h=this.getSizeValue(r.size);c.font=`${r.italic?"italic ":""}${r.bold?"bold ":""}${h} ${u}`,c.textBaseline="top";const m=parseInt(h)*1.2,g=t.width||0,f=t.height||0,p=r.background?16:8,v=g-p,w=this.wrapText(c,a,v);if(r.background){c.fillStyle="#ffffff";const C=8;c.fillRect(i-C/2,s-C/2,g+C,f+C/2)}if(o&&!e){c.fillStyle="rgba(74, 144, 226, 0.1)";const C=r.background?8:2;c.fillRect(i-C/2,s-C/2,g+C,f+C/2)}if(e){c.fillStyle="rgba(74, 144, 226, 0.2)";const C=r.background?8:2;c.fillRect(i-C/2,s-C/2,g+C,f+C/2)}c.fillStyle=r.color;const y=parseInt(h);w.forEach((C,P)=>{const T=s+P*m;this.drawTextWithSuperscripts(c,C,i,T,y,r,u)}),e&&this.drawResizeHandles(i,s,g,f),c.restore()}drawTextWithSuperscripts(t,e,o,i,s,a,r){if(a.superscript||a.subscript){t.save();const h=s*.6,m=a.superscript?-s*.4:s*.3;if(t.font=`${a.italic?"italic ":""}${a.bold?"bold ":""}${h}px ${r}`,t.fillText(e,o,i+m),a.underline){const g=t.measureText(e);t.beginPath(),t.strokeStyle=a.color,t.lineWidth=1,t.moveTo(o,i+m+h*1.2-2),t.lineTo(o+g.width,i+m+h*1.2-2),t.stroke()}t.restore();return}let c=o;const d=this.parseFormattedText(e),u=(h,m)=>{const g=h;if(g){if(t.save(),m==="superscript"){const f=s*.6,p=-s*.4;t.font=`${a.italic?"italic ":""}${a.bold?"bold ":""}${f}px ${r}`,t.fillText(g,c,i+p),c+=t.measureText(g).width}else if(m==="subscript"){const f=s*.6,p=s*.3;t.font=`${a.italic?"italic ":""}${a.bold?"bold ":""}${f}px ${r}`,t.fillText(g,c,i+p),c+=t.measureText(g).width}else{if(t.font=`${a.italic?"italic ":""}${a.bold?"bold ":""}${s}px ${r}`,t.fillText(g,c,i),a.underline){const f=t.measureText(g);t.beginPath(),t.strokeStyle=a.color,t.lineWidth=1,t.moveTo(c,i+s*1.2-2),t.lineTo(c+f.width,i+s*1.2-2),t.stroke()}c+=t.measureText(g).width}t.restore()}};d.forEach(h=>{u(h.text,h.format)})}parseFormattedText(t){const e=[];let o=0,i="",s=!1;for(;o<t.length;){if(t.substr(o,5)==="<sup>"){i&&(e.push({text:i,format:"normal"}),i="");const a=t.indexOf("</sup>",o);if(a!==-1){const r=t.substring(o+5,a);e.push({text:r,format:"superscript"}),o=a+6;continue}}if(t.substr(o,5)==="<sub>"){i&&(e.push({text:i,format:"normal"}),i="");const a=t.indexOf("</sub>",o);if(a!==-1){const r=t.substring(o+5,a);e.push({text:r,format:"subscript"}),o=a+6;continue}}if(t[o]==="^"&&!s){i&&(e.push({text:i,format:"normal"}),i=""),s=!0,o++;continue}if(s&&t[o]===" "){i&&(e.push({text:i,format:"superscript"}),i=""),s=!1,e.push({text:" ",format:"normal"}),o++;continue}i+=t[o],o++}return i&&e.push({text:i,format:s?"superscript":"normal"}),e}drawResizeHandles(t,e,o,i){const s=this.ctx,a=8,r=[{pos:"nw",x:t,y:e},{pos:"n",x:t+o/2,y:e},{pos:"ne",x:t+o,y:e},{pos:"e",x:t+o,y:e+i/2},{pos:"se",x:t+o,y:e+i},{pos:"s",x:t+o/2,y:e+i},{pos:"sw",x:t,y:e+i},{pos:"w",x:t,y:e+i/2}];s.save(),r.forEach(c=>{s.fillStyle="#4a90e2",s.strokeStyle="#ffffff",s.lineWidth=2,s.fillRect(c.x-a/2,c.y-a/2,a,a),s.strokeRect(c.x-a/2,c.y-a/2,a,a)}),s.restore()}drawPath(t,e){const{path:o,settings:i}=t,s=this.ctx;if(!(o.length<2)){s.save(),e&&(s.globalAlpha=.3),s.strokeStyle=i.color,s.lineWidth=this.getStrokeWidth(i.size),s.lineCap="round",s.lineJoin="round",s.beginPath(),s.moveTo(o[0].x,o[0].y);for(let a=1;a<o.length;a++)s.lineTo(o[a].x,o[a].y);s.stroke(),s.restore()}}drawLassoPath(t){const{path:e}=t,o=this.ctx;if(!(e.length<2)){o.save(),o.strokeStyle="rgba(0, 100, 255, 0.8)",o.lineWidth=2,o.setLineDash([5,5]),o.beginPath(),o.moveTo(e[0].x,e[0].y);for(let i=1;i<e.length;i++)o.lineTo(e[i].x,e[i].y);o.lineTo(e[0].x,e[0].y),o.stroke(),o.restore()}}getStrokeWidth(t){if(typeof t=="number")return t;switch(t){case"small":return 2;case"medium":return 4;case"large":return 6;default:return 2}}getLineDash(t){switch(t){case"solid":return[];case"dashed-big":return[10,5];case"dashed-small":return[5,3];case"dotted":return[2,3];default:return[]}}getSizeValue(t){if(typeof t=="number")return`${t}px`;switch(t){case"small":return"14px";case"medium":return"18px";case"large":return"24px";default:return"16px"}}updateHover(t,e){const o=this.hoverAnnotation,i=typeof document<"u"&&document.body?.dataset?.cursorOverride==="stamp";if(this.selectedAnnotation?.type==="text"){const a=this.getResizeHandleAt(t,e,this.selectedAnnotation);if(a){const r={nw:"nwse-resize",n:"ns-resize",ne:"nesw-resize",e:"ew-resize",se:"nwse-resize",s:"ns-resize",sw:"nesw-resize",w:"ew-resize"};this.canvas.style.cursor=r[a]??"default";return}}if(l.state.lassoSelection?.isActive&&l.state.lassoSelection.convexHull){const a=ga({x:t,y:e},l.state.lassoSelection.convexHull,10),r=oo({x:t,y:e},l.state.lassoSelection.convexHull);if(a||r){this.canvas.style.cursor="move";return}}const s=this.getAnnotationAt(t,e);s&&(s.type==="arrow"||s.type==="text")?(i||(this.currentTool==="text"&&s.type==="text"?this.selectedAnnotation===s?this.canvas.style.cursor="move":this.canvas.style.cursor="pointer":this.canvas.style.cursor="move"),this.hoverAnnotation=s):(i||(this.currentTool?this.setTool(this.currentTool,this.toolSettings):o&&(this.canvas.style.cursor="default")),this.hoverAnnotation=null),o!==this.hoverAnnotation&&this.render()}getResizeHandleAt(t,e,o){if(o?.type!=="text")return null;const s=8/2+2,a=this.getRenderOptions(),r=J(o.col,a),c=pt(o.row,a),d=J(o.col+o.widthCols,a),u=pt(o.row+o.heightRows,a),h=d-r,m=u-c,g=[{pos:"nw",x:r,y:c},{pos:"n",x:r+h/2,y:c},{pos:"ne",x:r+h,y:c},{pos:"e",x:r+h,y:c+m/2},{pos:"se",x:r+h,y:c+m},{pos:"s",x:r+h/2,y:c+m},{pos:"sw",x:r,y:c+m},{pos:"w",x:r,y:c+m/2}];for(const f of g)if(Math.sqrt(Math.pow(t-f.x,2)+Math.pow(e-f.y,2))<=s)return f.pos;return null}getAnnotationAt(t,e){for(let i=l.state.annotations.length-1;i>=0;i--){const s=l.state.annotations[i];if(s.type==="arrow"){if(zr(t,e,s.startX,s.startY,s.endX,s.endY)<10)return s}else if(s.type==="text"){const a=this.getRenderOptions(),r=J(s.col,a),c=pt(s.row,a),d=J(s.col+s.widthCols,a),u=pt(s.row+s.heightRows,a),h=d-r,m=u-c;if(t>=r&&t<=r+h&&e>=c&&e<=c+m)return s}}return null}showEraserCursor(t,e){this.render();const i=(l.state.cellWidth||40)*2;this.ctx.save(),this.ctx.fillStyle="rgba(220, 53, 69, 0.3)",this.ctx.fillRect(t-i/2,e-i/2,i,i),this.ctx.restore()}loadAnnotationSettings(t){if(t.type==="arrow"&&window.drawToolsController){const e=t.settings;window.drawToolsController.settings.arrow={...e},window.drawToolsController.renderArrowOptions()}else if(t.type==="text"&&window.drawToolsController){const e=t.settings;window.drawToolsController.settings.text={...e},window.drawToolsController.renderTextOptions()}}applyCurrentSettingsToSelected(){this.selectedAnnotation&&(this.selectedAnnotation.type==="arrow"&&this.toolSettings.arrow?(this.selectedAnnotation.settings={...this.toolSettings.arrow},this.render()):this.selectedAnnotation.type==="text"&&this.toolSettings.text&&(this.selectedAnnotation.settings={...this.toolSettings.text},this.render()))}clearAnnotations(){l.state.annotations=[],this.render()}eraseAtPoint(t,e){const{nextAnnotations:o,changed:i}=bh({x:t,y:e,annotations:l.state.annotations,getRenderOptions:()=>this.getRenderOptions()});return l.state.annotations=o,i&&this.render(),i}interpolatePoints(t,e){const o=[],i=e.col-t.col,s=e.row-t.row,a=Math.sqrt(i*i+s*s),r=Math.max(1,Math.floor(a/.1));for(let c=1;c<=r;c++){const d=c/r;o.push({col:t.col+d*i,row:t.row+d*s})}return o}deleteAnnotationAt(t,e){this.eraseAtPoint(t,e)}getAnnotations(){return l.state.annotations}loadAnnotations(t){l.state.annotations=t||[],this.render()}applyInlineFormatting(t){const e=document.querySelector(".annotation-text-input");if(!e)return;const o=window.getSelection();if(!o||!o.rangeCount)return;const i=o.getRangeAt(0),s=i.toString();if(!s)return;let a;if(t==="superscript")a=`<sup>${s}</sup>`;else if(t==="subscript")a=`<sub>${s}</sub>`;else return;i.deleteContents();const r=document.createTextNode(a);i.insertNode(r),i.setStartAfter(r),i.setEndAfter(r),o.removeAllRanges(),o.addRange(i),e instanceof HTMLElement&&e.focus()}}const Mt=new Ah;function wa(n){if(n?.type!=="arrow")return!1;const t=n,e=t.settings;return typeof t.startCol=="number"&&typeof t.startRow=="number"&&typeof t.endCol=="number"&&typeof t.endRow=="number"&&!!e&&typeof e.strokeWeight=="number"&&typeof e.lineStyle=="string"}function ya(n){if(n?.type!=="text")return!1;const t=n,e=t.settings;return typeof t.col=="number"&&typeof t.row=="number"&&typeof t.widthCols=="number"&&typeof t.heightRows=="number"&&typeof t.text=="string"&&!!e&&typeof e.size=="number"&&typeof e.color=="string"}function xh(n){if(n?.type!=="text")return!1;const t=n,e=typeof n.col=="number";return typeof t.startCol=="number"&&typeof t.startRow=="number"&&typeof t.endCol=="number"&&typeof t.endRow=="number"&&!e}function Sa(n){if(!n||n.type!=="marker"&&n.type!=="highlighter")return!1;const t=n,e=t.settings;return Array.isArray(t.path)&&!!e&&typeof e.color=="string"&&(typeof e.size=="number"||e.size==="small"||e.size==="medium"||e.size==="large")}function Mh(n){return n?.type==="lasso"&&Array.isArray(n.path)}function Eh(n,t){const e=l.state.annotations,o=Mt.tempAnnotation,i=Mt.selectedAnnotation,s=Mt.hoverAnnotation;if(e&&e.length>0&&e.forEach(r=>{const c=r===i,d=r===s;switch(r.type){case"arrow":wa(r)&&Ca(n,r,c,d,t);break;case"text":ya(r)&&xa(n,r,c,d,t);break;case"marker":case"highlighter":Sa(r)&&Ma(n,r,t);break}}),o)switch(o.type){case"arrow":wa(o)&&Ca(n,o,!1,!1,t);break;case"text":xh(o)?kh(n,o,t):ya(o)&&xa(n,o,!1,!1,t);break;case"marker":case"highlighter":Sa(o)&&Ma(n,o,t);break;case"lasso":Mh(o)&&Rh(n,o);break}const a=l.state.lassoSelection;a?.isActive&&Array.isArray(a.convexHull)&&(Mt.updateLassoConvexHull(),Bh(n,a.convexHull))}function Ca(n,t,e=!1,o=!1,i){const{startCol:s,startRow:a,endCol:r,endRow:c,settings:d}=t,u=J(s,i),h=pt(a,i),m=J(r,i),g=pt(c,i);n.save(),n.strokeStyle=t.color||"#000000",n.lineWidth=ns(d.strokeWeight),n.setLineDash(Nh(d.lineStyle));const f=Math.atan2(g-h,m-u),p=d.arrowheadSize||12;let v=u,w=h,y=m,C=g;d.startArrowhead&&d.startArrowhead!=="none"&&(v=u+Math.cos(f)*p,w=h+Math.sin(f)*p),d.endArrowhead&&d.endArrowhead!=="none"&&(y=m-Math.cos(f)*p,C=g-Math.sin(f)*p),n.beginPath(),n.moveTo(v,w),n.lineTo(y,C),n.stroke(),n.setLineDash([]),d.startArrowhead&&d.startArrowhead!=="none"&&Aa(n,u,h,f+Math.PI,d.startArrowhead,p),d.endArrowhead&&d.endArrowhead!=="none"&&Aa(n,m,g,f,d.endArrowhead,p),(e||o)&&(n.strokeStyle=e?"rgba(74, 144, 226, 0.6)":"rgba(74, 144, 226, 0.3)",n.lineWidth=ns(d.strokeWeight)+4,n.setLineDash([]),n.beginPath(),n.moveTo(u,h),n.lineTo(m,g),n.stroke()),n.restore()}function Aa(n,t,e,o,i,s){switch(n.save(),n.translate(t,e),n.rotate(o),i){case"filled":case"filled-arrow":n.beginPath(),n.moveTo(0,0),n.lineTo(-s,-s/2),n.lineTo(-s,s/2),n.closePath(),n.fillStyle=n.strokeStyle,n.fill();break;case"unfilled":case"unfilled-arrow":n.beginPath(),n.moveTo(0,0),n.lineTo(-s,-s/2),n.lineTo(-s,s/2),n.closePath(),n.stroke();break;case"circle":n.beginPath(),n.arc(0,0,s/3,0,Math.PI*2),n.fillStyle=n.strokeStyle,n.fill();break}n.restore()}function xa(n,t,e=!1,o=!1,i){const{col:s,row:a,text:r,widthCols:c,heightRows:d,settings:u}=t,h=J(s,i),m=pt(a,i),g=J(s+(typeof c=="number"?c:2),i)-h,f=pt(a+(typeof d=="number"?d:1),i)-m;n.save(),n.textBaseline="top";const v=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',w=u.size,y=w*1.2,C=u.background?8:4,P=4,T=g-C*2,M=Ph(n,r,T,w,u,v);u.background&&(n.fillStyle="#ffffff",n.fillRect(h,m,g,f)),o&&!e&&(n.fillStyle="rgba(74, 144, 226, 0.1)",n.fillRect(h,m,g,f)),e&&(n.fillStyle="rgba(74, 144, 226, 0.2)",n.fillRect(h,m,g,f)),n.fillStyle=u.color,M.forEach((A,x)=>{const k=m+P+x*y;Th(n,A,h+C,k,w,u,v)}),e&&Lh(n,h,m,g,f),n.restore()}function Ph(n,t,e,o,i,s){n.font=`${i.italic?"italic ":""}${i.bold?"bold ":""}${o}px ${s}`;const a=t.split(`
`),r=[];return a.forEach(c=>{if(!c.trim()){r.push("");return}const d=c.split(" ");let u="";d.forEach(h=>{const m=u?u+" "+h:h;n.measureText(m).width>e&&u?(r.push(u),u=h):u=m}),u&&r.push(u)}),r}function Th(n,t,e,o,i,s,a){if(s.superscript||s.subscript){n.save();const d=i*.6,u=s.superscript?-i*.4:i*.3;if(n.font=`${s.italic?"italic ":""}${s.bold?"bold ":""}${d}px ${a}`,n.fillText(t,e,o+u),s.underline){const h=n.measureText(t);n.beginPath(),n.strokeStyle=s.color,n.lineWidth=1,n.moveTo(e,o+u+d*1.2-2),n.lineTo(e+h.width,o+u+d*1.2-2),n.stroke()}n.restore();return}const r=Ih(t);let c=e;r.forEach(d=>{if(n.save(),d.format==="superscript"){const u=i*.6,h=-i*.4;n.font=`${s.italic?"italic ":""}${s.bold?"bold ":""}${u}px ${a}`,n.fillText(d.text,c,o+h),c+=n.measureText(d.text).width}else if(d.format==="subscript"){const u=i*.6,h=i*.3;n.font=`${s.italic?"italic ":""}${s.bold?"bold ":""}${u}px ${a}`,n.fillText(d.text,c,o+h),c+=n.measureText(d.text).width}else{if(n.font=`${s.italic?"italic ":""}${s.bold?"bold ":""}${i}px ${a}`,n.fillText(d.text,c,o),s.underline){const u=n.measureText(d.text);n.beginPath(),n.strokeStyle=s.color,n.lineWidth=1,n.moveTo(c,o+i*1.2-2),n.lineTo(c+u.width,o+i*1.2-2),n.stroke()}c+=n.measureText(d.text).width}n.restore()})}function Ih(n){const t=[];let e=0,o="",i=!1;for(;e<n.length;){if(n.substr(e,5)==="<sup>"){o&&(t.push({text:o,format:"normal"}),o="");const s=n.indexOf("</sup>",e);if(s!==-1){const a=n.substring(e+5,s);t.push({text:a,format:"superscript"}),e=s+6;continue}}if(n.substr(e,5)==="<sub>"){o&&(t.push({text:o,format:"normal"}),o="");const s=n.indexOf("</sub>",e);if(s!==-1){const a=n.substring(e+5,s);t.push({text:a,format:"subscript"}),e=s+6;continue}}if(n[e]==="^"&&!i){o&&(t.push({text:o,format:"normal"}),o=""),i=!0,e++;continue}if(i&&n[e]===" "){o&&(t.push({text:o,format:"superscript"}),o=""),i=!1,t.push({text:" ",format:"normal"}),e++;continue}o+=n[e],e++}return o&&t.push({text:o,format:i?"superscript":"normal"}),t}function Lh(n,t,e,o,i){const a=[{x:t,y:e},{x:t+o/2,y:e},{x:t+o,y:e},{x:t+o,y:e+i/2},{x:t+o,y:e+i},{x:t+o/2,y:e+i},{x:t,y:e+i},{x:t,y:e+i/2}];n.save(),a.forEach(r=>{n.fillStyle="#4a90e2",n.strokeStyle="#ffffff",n.lineWidth=2,n.fillRect(r.x-8/2,r.y-8/2,8,8),n.strokeRect(r.x-8/2,r.y-8/2,8,8)}),n.restore()}function kh(n,t,e){const{startCol:o,startRow:i,endCol:s,endRow:a}=t,r=J(o,e),c=pt(i,e),d=J(s,e),u=pt(a,e),h=Math.min(r,d),m=Math.min(c,u),g=Math.abs(d-r),f=Math.abs(u-c);n.save(),n.strokeStyle="rgba(74, 144, 226, 0.6)",n.lineWidth=2,n.setLineDash([5,5]),n.strokeRect(h,m,g,f),n.restore()}function Ma(n,t,e){const{path:o,settings:i,type:s}=t;if(!o||o.length<2)return;const a=o.map(c=>({x:J(c.col,e),y:pt(c.row,e)}));n.save(),s==="highlighter"&&(n.globalAlpha=.3),n.strokeStyle=i.color,n.lineWidth=typeof i.size=="number"?i.size:ns(i.size),n.lineCap="round",n.lineJoin="round",n.beginPath();const r=a[0];if(!r){n.restore();return}n.moveTo(r.x,r.y);for(let c=1;c<a.length;c++){const d=a[c];d&&n.lineTo(d.x,d.y)}n.stroke(),n.restore()}function ns(n){if(typeof n=="number")return n;switch(n){case"small":return 2;case"medium":return 4;case"large":return 6;default:return 4}}function Nh(n){switch(n){case"solid":return[];case"dashed-big":return[10,5];case"dashed-small":return[5,3];case"dotted":return[2,3];default:return[]}}function Rh(n,t){const e=t.path;if(!e||e.length<2)return;const o=e[0];if(o){n.save(),n.strokeStyle="#4a90e2",n.lineWidth=2,n.setLineDash([5,5]),n.globalAlpha=.7,n.beginPath(),n.moveTo(o.x,o.y);for(let i=1;i<e.length;i++){const s=e[i];s&&n.lineTo(s.x,s.y)}e.length>2&&n.lineTo(o.x,o.y),n.stroke(),n.restore()}}function Bh(n,t){if(!t||t.length<3)return;const e=t[0];if(e){n.save(),n.strokeStyle="#4a90e2",n.lineWidth=2,n.setLineDash([8,4]),n.globalAlpha=.8,n.beginPath(),n.moveTo(e.x,e.y);for(let o=1;o<t.length;o++){const i=t[o];i&&n.lineTo(i.x,i.y)}n.closePath(),n.stroke(),n.fillStyle="rgba(74, 144, 226, 0.1)",n.fill(),n.restore()}}let Ea=0;function $r(){try{if(globalThis.__SN_DEBUG_VIEWPORT)return!0}catch{}try{if(new URLSearchParams(window.location.search).get("debugViewport")==="1")return!0}catch{}try{return localStorage.getItem("sn:debugViewport")==="1"}catch{return!1}}let Dh=!1;function Fh(n,t){if($r())try{const e=performance?.now?.()??Date.now();if(e-Ea<500)return;Ea=e,Dh=!0}catch{}}function Wh(n,t){const e={...l.state,...t};if(!e.columnWidths?.length||!e.fullRowData?.length)return;n.clearRect(0,0,qt(n.canvas),Pt(n.canvas));const{startRow:o,endRow:i}=Iu(),s=Math.max(0,o-1),a=Math.max(0,(e.fullRowData?.length??1)-1),r=Math.min(a,i+1);if($r()){const p=Pt(n.canvas),v=e.cellHeight/2,w=pt(i,e),y=w+v,C=e.fullRowData?.length??0,P=o<=0,T=C>0?i>=C-1:!1,M=e.fullRowData?.[o],A=e.fullRowData?.[i];Fh("pitchCanvasCoverage",{startRow:o,endRow:i,paddedStartRow:s,paddedEndRow:r,atTopGamutEdge:P,atBottomGamutEdge:T,canvasHeight:p,containerHeight:e.viewportHeight,halfUnit:v,yEnd:w,bottomEdge:y,gapCanvasMinusBottomEdge:p-y,gapCanvasMinusContainer:p-e.viewportHeight,startRowSummary:M?{pitch:M.pitch,column:M.column,isBoundary:!!M.isBoundary}:null,endRowSummary:A?{pitch:A.pitch,column:A.column,isBoundary:!!A.isBoundary}:null})}const c=e.cellHeight,d=p=>{const v=pt(p,e);return v>=-c&&v<=e.viewportHeight+c},u=e.placedTonicSigns.filter(p=>p.globalRow===void 0?!1:d(p.globalRow)),h=eo.getLegendLeftContext(),m=eo.getLegendRightContext();Yu(h,m,e,s,r),Ou(n,e,s,r),_u(n,e);const g=t.placedNotes.filter(p=>p.isDrum||p.globalRow===void 0?!1:d(p.globalRow)),f=u;g.forEach(p=>{p.shape==="oval"?Ps(n,e,p,p.globalRow):p.shape==="circle"&&Es(n,e,p,p.globalRow)}),f.forEach(p=>{Dr(n,e,p)}),nh(n,e),sh(n,e),_r(n,e),Eh(n,e)}const Hr={getTimeSignatureSegments(){const n=l.state,t=n.macrobeatGroupings??[],e=n.macrobeatBoundaryStyles??[],o=[];let i=!!n.hasAnacrusis,s=Zt(n,0).startColumn,a=0,r=!1;return t.forEach((c,d)=>{a+=c,c===3&&(r=!0);const u=d===t.length-1,m=e[d]==="solid";if(m||u){const f=Zt(n,d).endColumn+1,p=Array.isArray(n.tempoModulationMarkers)&&n.tempoModulationMarkers.length>0,v={...n,tempoModulationMarkers:p?n.tempoModulationMarkers:[],cellWidth:n.cellWidth,columnWidths:n.columnWidths,musicalColumnWidths:n.musicalColumnWidths,baseMicrobeatPx:n.cellWidth},w=J(s,v),y=J(f,v),C=r?`${a}/8`:`${a/2}/4`;o.push({label:C,centerX:(w+y)/2,startX:w,endX:y,isAnacrusis:i}),u||(s=f,a=0,r=!1,m&&(i=!1))}}),o},getRhythmUIButtons(){const n=l.state,t=n.macrobeatGroupings??[],e=n.macrobeatBoundaryStyles??[],o=[],i=Gt(n),s=new Set(i.map(a=>a.columnIndex+2));return t.forEach((a,r)=>{const c=Zt(n,r),{startColumn:d,endColumn:u}=c,h={...n,tempoModulationMarkers:n.tempoModulationMarkers||[],cellWidth:n.cellWidth,columnWidths:n.columnWidths,musicalColumnWidths:n.columnWidths,baseMicrobeatPx:n.cellWidth},m=J(d,h),g=J(u+1,h),f=(m+g)/2,p=e[r]??null,v=r>0?e[r-1]??null:null,w=v!==null&&s.has(d);o.push({type:"grouping",content:a,x:f,startX:m,endX:g,index:r,nextBoundaryStyle:p,prevBoundaryStyle:v,hasLeftDivider:w}),r<t.length-1&&o.push({type:"boundary",boundaryStyle:p,x:g,index:r})}),o}},Oh="data-rhythm-ui-element",os=n=>`${Math.round(n*100)/100}px`,_h=n=>{n.querySelectorAll(`[${Oh}]`).forEach(t=>t.remove())},zh=n=>{const t=document.getElementById("notation-grid");if(!t)return null;const e=t.getBoundingClientRect(),o=n.getBoundingClientRect();return e.width===0?null:e.left-o.left},$h=(n,t)=>{const e=document.createElement("button");return e.type="button",e.className="grouping-segment",e.dataset.rhythmUiElement="grouping",e.dataset.index=`${n.index}`,e.textContent=`${n.content}`,e.style.left=os(t+n.startX),e.style.width=os(Math.max(0,n.endX-n.startX)),e.dataset.nextBoundaryStyle=`${n.nextBoundaryStyle??""}`,e.dataset.prevBoundaryStyle=`${n.prevBoundaryStyle??""}`,e.dataset.hasLeftDivider=n.hasLeftDivider?"true":"false",e.setAttribute("aria-label",`Toggle macrobeat grouping (${n.content}) at position ${n.index+1}`),e.addEventListener("click",o=>{o.stopPropagation(),l.toggleMacrobeatGrouping(n.index)}),e},Hh=(n,t)=>{const e=document.createElement("button");e.type="button",e.className="buttonGrid-ui-button buttonGrid-ui-button--boundary",e.dataset.rhythmUiElement="boundary",e.dataset.index=`${n.index}`,e.style.left=os(t+n.x),e.setAttribute("aria-label","Cycle boundary style");const o=document.createElement("span");return o.className="boundary-diamond",o.dataset.style=n.boundaryStyle||"dashed",e.appendChild(o),e.addEventListener("click",i=>{i.stopPropagation(),l.cycleMacrobeatBoundaryStyle(n.index)}),e};function qr(){const n=document.getElementById("beat-line-button-layer");if(!n){b.warn("rhythmUI","Cannot render rhythm UI without beat-line container",null,"ui");return}const t=zh(n);if(t===null)return;const e=n.querySelector("#grouping-buttons-row"),o=n.querySelector("#boundary-buttons-row");_h(n);const i=Hr.getRhythmUIButtons();if(!Array.isArray(i)||i.length===0)return;const s=document.createDocumentFragment(),a=document.createDocumentFragment();i.forEach(r=>{r.type==="grouping"?s.appendChild($h(r,t)):r.type==="boundary"&&a.appendChild(Hh(r,t))}),e?e.appendChild(s):n.appendChild(s),o?o.appendChild(a):n.appendChild(a)}const qh={init:Gh};function Gh(){qr()}const Vh={getTimeSignatureOptions(){return{"Single Macrobeat":[{label:"1/4",groupings:[2],description:"one 2-beat"},{label:"2/8",groupings:[2],description:"one 2-beat"},{label:"3/8",groupings:[3],description:"one 3-beat"}],"Two Macrobeats":[{label:"2/4",groupings:[2,2],description:"two 2-beats"},{label:"4/8",groupings:[2,2],description:"two 2-beats"},{label:"5/8",groupings:[2,3],description:"2+3"},{label:"5/8",groupings:[3,2],description:"3+2"},{label:"6/8",groupings:[3,3],description:"two 3-beats"}],"Three Macrobeats":[{label:"3/4",groupings:[2,2,2],description:"three 2-beats"},{label:"7/8",groupings:[2,2,3],description:"2+2+3"},{label:"7/8",groupings:[3,2,2],description:"3+2+2"},{label:"7/8",groupings:[2,3,2],description:"2+3+2"},{label:"8/8",groupings:[3,3,2],description:"3+3+2"},{label:"8/8",groupings:[3,2,3],description:"3+2+3"},{label:"8/8",groupings:[2,3,3],description:"2+3+3"},{label:"9/8",groupings:[3,3,3],description:"three 3-beats"}],"Four Macrobeats":[{label:"4/4",groupings:[2,2,2,2],description:"four 2-beats"},{label:"10/8",groupings:[2,2,3,3],description:"2+2+3+3"},{label:"10/8",groupings:[2,3,2,3],description:"2+3+2+3"},{label:"10/8",groupings:[2,3,3,2],description:"2+3+3+2"},{label:"10/8",groupings:[3,2,3,2],description:"3+2+3+2"},{label:"10/8",groupings:[3,3,2,2],description:"3+3+2+2"},{label:"10/8",groupings:[3,2,2,3],description:"3+2+2+3"},{label:"11/8",groupings:[3,3,3,2],description:"3+3+3+2"},{label:"11/8",groupings:[3,3,2,3],description:"3+3+2+3"},{label:"11/8",groupings:[3,2,3,3],description:"3+2+3+3"},{label:"11/8",groupings:[2,3,3,3],description:"2+3+3+3"},{label:"12/8",groupings:[3,3,3,3],description:"four 3-beats"}],"Five Macrobeats":[{label:"5/4",groupings:[2,2,2,2,2],description:"five 2-beats"},{label:"11/8",groupings:[2,2,2,2,3],description:"2+2+2+2+3"},{label:"11/8",groupings:[2,2,2,3,2],description:"2+2+2+3+2"},{label:"11/8",groupings:[2,2,3,2,2],description:"2+2+3+2+2"},{label:"11/8",groupings:[2,3,2,2,2],description:"2+3+2+2+2"},{label:"11/8",groupings:[3,2,2,2,2],description:"3+2+2+2+2"},{label:"12/8",groupings:[2,2,2,3,3],description:"2+2+2+3+3"},{label:"12/8",groupings:[2,2,3,2,3],description:"2+2+3+2+3"},{label:"12/8",groupings:[2,2,3,3,2],description:"2+2+3+3+2"},{label:"12/8",groupings:[2,3,2,2,3],description:"2+3+2+2+3"},{label:"12/8",groupings:[2,3,2,3,2],description:"2+3+2+3+2"},{label:"12/8",groupings:[2,3,3,2,2],description:"2+3+3+2+2"},{label:"12/8",groupings:[3,2,2,2,3],description:"3+2+2+2+3"},{label:"12/8",groupings:[3,2,2,3,2],description:"3+2+2+3+2"},{label:"12/8",groupings:[3,2,3,2,2],description:"3+2+3+2+2"},{label:"12/8",groupings:[3,3,2,2,2],description:"3+3+2+2+2"},{label:"13/8",groupings:[3,2,2,3,3],description:"3+2+2+3+3"},{label:"13/8",groupings:[3,3,2,3,2],description:"3+3+2+3+2"},{label:"13/8",groupings:[3,3,3,2,2],description:"3+3+3+2+2"},{label:"15/8",groupings:[3,3,3,3,3],description:"five 3-beats"}]}},generateDropdownHTML(){const n=this.getTimeSignatureOptions();let t='<div id="time-signature-dropdown" class="time-signature-dropdown hidden">';return Object.entries(n).forEach(([e,o])=>{t+='<div class="dropdown-category">',t+=`<div class="dropdown-category-header">${e}</div>`,o.forEach((i,s)=>{const a=`${e}-${s}`;t+=`<div class="dropdown-option" data-groupings="${JSON.stringify(i.groupings)}" data-key="${a}">`,t+=`<span class="dropdown-label">${i.label}</span>`,t+=`<span class="dropdown-description">${i.description}</span>`,t+="</div>"}),t+="</div>"}),t+="</div>",t},getTimeSignatureLabel(n){const t=n.reduce((o,i)=>o+i,0);return n.includes(3)?`${t}/8`:`${t/2}/4`}};let Ko=null;function Uh(){const n=document.getElementById("beat-line-button-layer");if(!n)return;const t=n.querySelector("#time-signature-row")||n;n.querySelectorAll(".time-signature-label").forEach(c=>c.remove());const o=document.getElementById("notation-grid");if(!o)return;const i=o.getBoundingClientRect(),s=n.getBoundingClientRect(),a=i.left-s.left;Hr.getTimeSignatureSegments().forEach((c,d)=>{const u=document.createElement("div");u.className="time-signature-label",c.isAnacrusis&&u.classList.add("anacrusis-label"),u.textContent=c.label,u.style.position="absolute",u.style.left=`${a+c.startX}px`,u.style.width=`${Math.max(0,c.endX-c.startX)}px`,u.style.transform="none",u.style.pointerEvents="auto",u.addEventListener("click",h=>{h.stopPropagation(),Yh(u,d)}),t.appendChild(u)}),Xh()}function Xh(){if(!document.getElementById("time-signature-dropdown")){const n=Vh.generateDropdownHTML();document.body.insertAdjacentHTML("beforeend",n),document.getElementById("time-signature-dropdown")?.addEventListener("click",jh)}}function Yh(n,t){const e=document.getElementById("time-signature-dropdown");if(!e)return;e.dataset.measureIndex=String(t);const o=n.getBoundingClientRect();e.style.left=`${o.left}px`,e.style.top=`${o.bottom+5}px`;const i=e.getBoundingClientRect(),s=window.innerWidth,a=window.innerHeight;o.left+i.width>s&&(e.style.left=`${s-i.width-10}px`),o.bottom+i.height>a&&(e.style.top=`${o.top-i.height-5}px`),e.classList.remove("hidden"),Ko={dropdown:e,measureIndex:t},setTimeout(()=>{document.addEventListener("click",Qh,{once:!0})},0)}function Qh(n){const t=document.getElementById("time-signature-dropdown"),e=n.target;t&&e&&!t.contains(e)&&(t.classList.add("hidden"),Ko=null)}function jh(n){const e=n.target?.closest(".dropdown-option");if(!e)return;const o=e.dataset.groupings,i=Ko?.measureIndex??NaN;if(!(!o||Number.isNaN(i)))try{const s=JSON.parse(o);l.updateTimeSignature(i,s),document.getElementById("time-signature-dropdown")?.classList.add("hidden"),Ko=null}catch{}}b.moduleLoaded("PitchGridController","grid");function Zh(){const n=eo.getPitchContext();if(!n?.canvas){b.error("PitchGridController","Pitch grid context not available for rendering",null,"grid");return}const t=Ht.getViewportInfo(),e={placedNotes:Vd(l.state),placedTonicSigns:Gt(l.state),fullRowData:l.state.fullRowData,columnWidths:l.state.columnWidths,cellWidth:l.state.cellWidth,cellHeight:l.state.cellHeight,rowHeight:l.state.cellHeight*.5,macrobeatGroupings:l.state.macrobeatGroupings,macrobeatBoundaryStyles:l.state.macrobeatBoundaryStyles,accidentalMode:l.state.accidentalMode,showFrequencyLabels:l.state.showFrequencyLabels,showOctaveLabels:l.state.showOctaveLabels,colorMode:"color",degreeDisplayMode:l.state.degreeDisplayMode,zoomLevel:t.zoomLevel,viewportHeight:t.containerHeight,tempoModulationMarkers:l.state.tempoModulationMarkers,showModulationLabel:!1};b.debug("PitchGridController","renderPitchGrid options",{columns:e.columnWidths?.length,rows:e.fullRowData?.length,placedNotes:e.placedNotes.length,tonicSigns:e.placedTonicSigns.length,zoomLevel:e.zoomLevel,viewportHeight:e.viewportHeight},"grid"),Wh(n,e)}const En={render(){Zh()},renderMacrobeatTools(){qr(),Uh()}},Yn={},De={},Kh=600,Ni=.25,Pa={letter:{width:8.5,height:11},"11x14":{width:11,height:14},"11x17":{width:11,height:17}};async function Jh(n,t){const e=document.getElementById("button-grid");if(!e)return b.warn("PrintService","Button grid element not found",null,"print"),null;const o=e.querySelector(".button-grid-left-cell"),i=e.querySelector(".button-grid-right-cell");try{const s=e.getBoundingClientRect(),a=o?.getBoundingClientRect().width??0,r=i?.getBoundingClientRect().width??0,c=Math.min(window.devicePixelRatio||1,2),d=await ac(e,{scale:c,backgroundColor:"#ffffff",logging:!1,useCORS:!0}),u=s.width>0?d.width/s.width:1,h=n?0:Math.round(a*u),m=t?0:Math.round(r*u),g=Math.max(0,Math.min(d.width-1,h)),f=Math.max(g+1,Math.min(d.width,d.width-m)),p=Math.max(1,f-g),v=document.createElement("canvas");v.width=p,v.height=d.height,(v.getContext("2d",{willReadFrequently:!0})||v.getContext("2d")).drawImage(d,g,0,p,d.height,0,0,p,d.height);const y=sf(v,n,t);return b.debug("PrintService",`Captured button grid: ${y.width}x${y.height}`,null,"print"),y}catch(s){return b.error("PrintService","Failed to capture button grid",s,"print"),null}}function tf(n,t){const e=document.getElementById("notation-grid"),o=document.getElementById("legend-left-canvas"),i=document.getElementById("legend-right-canvas");if(!e)return b.warn("PrintService","Notation grid canvas not found",null,"print"),null;const s=n&&o?o.width:0,a=t&&i?i.width:0,r=s+e.width+a,c=s,d=document.createElement("canvas");d.width=r,d.height=e.height;const u=d.getContext("2d");return n&&o&&s>0&&u.drawImage(o,0,0),u.drawImage(e,c,0),t&&i&&a>0&&u.drawImage(i,c+e.width,0),b.debug("PrintService",`Captured pitch grid: ${d.width}x${d.height}`,null,"print"),d}function ef(n,t){const e=document.getElementById("drum-grid"),o=document.querySelector(".drum-grid-left-cell"),i=document.querySelector(".drum-grid-right-cell");if(!e||e.width===0)return b.debug("PrintService","Drum grid not found or empty",null,"print"),null;const s=e.offsetWidth?e.width/e.offsetWidth:1,a=n?Math.max(0,Math.round((o?.offsetWidth||0)*s)):0,r=t?Math.max(0,Math.round((i?.offsetWidth||0)*s)):0,c=a+e.width+r,d=getComputedStyle(document.documentElement).getPropertyValue("--c-surface")||"#ffffff",u=document.createElement("canvas");u.width=c,u.height=e.height;const h=u.getContext("2d");return h.fillStyle=d.trim()||"#ffffff",h.fillRect(0,0,c,e.height),h.drawImage(e,a,0),b.debug("PrintService",`Captured drum grid: ${u.width}x${u.height}`,null,"print"),u}function nf(n){const t=document.createElement("canvas");t.width=n.width,t.height=n.height;const e=t.getContext("2d");e.drawImage(n,0,0);const o=e.getImageData(0,0,t.width,t.height),i=o.data;for(let s=0;s<i.length;s+=4){const a=i[s]*.299+i[s+1]*.587+i[s+2]*.114;i[s]=a,i[s+1]=a,i[s+2]=a}return e.putImageData(o,0,0),t}async function of(n,t){b.debug("PrintService","Generating score canvas...",{printOptions:n,targetDimensions:t},"print");const e=[];if(n.includeButtonGrid){const P=await Gr(n.includeLeftLegend,n.includeRightLegend);P&&e.push({canvas:P,name:"buttons"})}const o=tf(n.includeLeftLegend,n.includeRightLegend);if(o&&e.push({canvas:o,name:"pitch"}),n.includeDrums){const P=ef(n.includeLeftLegend,n.includeRightLegend);P&&e.push({canvas:P,name:"drums"})}if(e.length===0)return b.warn("PrintService","No content captured for printing",null,"print"),null;n.colorMode==="bw"&&(e.forEach(P=>{P.canvas=nf(P.canvas)}),b.debug("PrintService","Applied black & white filter",null,"print"));const i=Math.max(...e.map(P=>P.canvas.width)),s=e.reduce((P,T)=>P+T.canvas.height,0),a=n.cropTop||0,r=n.cropBottom||1,c=n.cropLeft||0,d=n.cropRight||1,u=s*(r-a),h=i*(d-c),m=s*a,g=i*c;b.debug("PrintService",`Applying crop: top=${a.toFixed(2)}, bottom=${r.toFixed(2)}, left=${c.toFixed(2)}, right=${d.toFixed(2)}`,null,"print");const f=Math.min(t.width/h,t.height/u),p=document.createElement("canvas");p.width=h*f,p.height=u*f;const v=p.getContext("2d");v.fillStyle="#FFFFFF",v.fillRect(0,0,p.width,p.height);const w=document.createElement("canvas");w.width=i,w.height=s;const y=w.getContext("2d");let C=0;return e.forEach(({canvas:P,name:T})=>{y.drawImage(P,0,C),b.debug("PrintService",`Drew ${T} at y=${C}, height=${P.height}`,null,"print"),C+=P.height}),v.drawImage(w,g,m,h,u,0,0,p.width,p.height),b.debug("PrintService",`Generated composite canvas: ${p.width}x${p.height}`,null,"print"),p}const _o={generateScoreCanvas:of,async generateAndPrint(){const n=l.state.printOptions,t=300,e=n.pageSize,o=e&&e in Pa?e:"letter",i=Pa[o],s=n.orientation==="landscape"?i.height:i.width,a=n.orientation==="landscape"?i.width:i.height,r=Math.max(1,s-2*Ni),c=Math.max(1,a-2*Ni),d=r*t,u=c*t;b.info("PrintService","Generating print canvas at high resolution",{width:d,height:u,options:n},"print");const h=await this.generateScoreCanvas(n,{width:d,height:u});if(!h){b.error("PrintService","Failed to generate print canvas",null,"print");return}const m=document.getElementById("print-staging-area");m.innerHTML="";const g=document.getElementById("print-style-rules");g.textContent=`@page { size: ${s}in ${a}in; margin: ${Ni}in; }`;const f=document.createElement("img");f.src=h.toDataURL("image/png"),f.style.width="100%",f.style.height="auto",m.appendChild(f),b.info("PrintService","Opening print dialog",null,"print"),setTimeout(()=>window.print(),100)},async prefetchButtonGridSnapshot(n=!0,t=!0){try{await Gr(n,t)}catch(e){b.warn("PrintService","Button grid prefetch failed",e,"print")}},invalidateButtonGridSnapshot(){Vr()}};function sf(n,t,e){if(!n)return n;const o=document.getElementById("notation-grid"),i=document.getElementById("legend-left-canvas"),s=document.getElementById("legend-right-canvas"),a=t&&i?i.width:0,r=e&&s?s.width:0,c=(o?.width??0)+a+r||n.width;if(!c||c===n.width)return n;const d=c/n.width,u=Math.max(1,Math.round(n.height*d)),h=document.createElement("canvas");return h.width=c,h.height=u,(h.getContext("2d",{willReadFrequently:!0})||h.getContext("2d")).drawImage(n,0,0,h.width,h.height),h}async function Gr(n,t){const e=`${n}-${t}`;return Yn[e]!==void 0?Yn[e]??null:(De[e]||(De[e]=(async()=>{await af();const o=await Jh(n,t);return Yn[e]=o,De[e]=null,o})().catch(o=>{throw De[e]=null,o})),De[e])}function af(){return new Promise(n=>{typeof window.requestIdleCallback=="function"?requestIdleCallback(()=>n(),{timeout:Kh}):requestAnimationFrame(()=>n())})}function Vr(){Object.keys(Yn).forEach(n=>{delete Yn[n]}),Object.keys(De).forEach(n=>{delete De[n]})}typeof window<"u"&&window.addEventListener("resize",()=>Vr());function be(n,t){if(!n)return`rgba(204, 204, 204, ${t})`;const e=parseInt(n.slice(hr,ea),Do),o=parseInt(n.slice(ea,na),Do),i=parseInt(n.slice(na,iu),Do);return`rgba(${e}, ${o}, ${i}, ${t})`}function ui(n,t){if(!n||typeof n!="string")return ou;const e=parseInt(n.slice(hr),Do),o=t<0?su:au,i=t<0?t*-1:t,s=e>>16,a=e>>8&255,r=e&255;return"#"+(16777216+(Math.round((o-s)*i)+s)*65536+(Math.round((o-a)*i)+a)*256+(Math.round((o-r)*i)+r)).toString(16).slice(1)}const rf=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor"/>\r
</svg>`,lf=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(90, 12, 12)"/>\r
</svg>`,cf=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(180, 12, 12)"/>\r
</svg>`,df=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(270, 12, 12)"/>\r
</svg>`,Ur=wn;function Fn(n,t){const{blend:e,cutoff:o,resonance:i}=t,s=(o-1)/30,a=20,r=n-s,c=s-n;let d=1/(1+Math.pow(Math.max(0,r*a),2)),u=1/(1+Math.pow(Math.max(0,c*a),2));const h=.01;d<h&&(d=0),u<h&&(u=0);const m=d*u;let g;e<=1?g=u*(1-e)+m*e:g=m*(2-e)+d*(e-1);const f=1-(i||0)/105,p=Math.max(.01,.2*f*f),v=Math.exp(-Math.pow((n-s)/p,2)),w=(i||0)/100*.6,y=g+v*w,C=Math.max(0,Math.min(1,y));return C<h?0:C}function uf(n,t){const e=t/100;return 1-e+e*n}function so(n,t){const e=t.mix||0;if(e===0)return new Float32Array(n);const o=new Float32Array(n.length),i=e/100;for(let s=0;s<n.length;s++){const a=n[s]??0,r=(s+.5)/Ur,c=Fn(r,t);if(c<a){const h=(a-c)*i;o[s]=a-h}else o[s]=a;const d=o[s]??0;o[s]=Math.max(0,d)}return o}function is(n){const t=l.state.timbres[n];if(!t)return new Float32Array(Ur);const e=t.filter;return e&&e.enabled!==!1&&(e.mix||0)>0?so(t.coeffs,e):new Float32Array(t.coeffs)}b.moduleLoaded("OvertoneBins with Columnar Structure");function ss(n,...t){}const zo={0:rf,90:lf,180:cf,270:df},ye=wn;let Bt=null,Lt=null,zt=new Float32Array(ye).fill(0),Ct=null,ee=new Float32Array(ye).fill(0);const Is=[],as=[];let mn=!1,se=null;const Co=new Array(ye).fill(null);let Ao=!1;const xo=new Float32Array(ye).fill(1);new Float32Array(ye).fill(0);function rs(){if(!Ct||((!Bt||!Lt||!se)&&(Bt=document.getElementById("filter-overlay-canvas"),se=document.querySelector(".overtone-bins-grid"),Bt&&(Lt=Bt.getContext("2d"))),!Bt||!Lt||!se))return;const{width:n,height:t}=Bt;Lt.clearRect(0,0,n,t);const o=t*.95,i=t,s=l.state.timbres[Ct]?.filter,a=s&&s.enabled!==!1;if(s&&a){const r=s.mix||0;if(r===0){xo.fill(1);return}const c=[];for(let g=0;g<ye;g++){const f=(g+.5)/ye,p=Fn(f,s);xo[g]=uf(p,r),c.push({bin:g+1,rawFilterAmp:p.toFixed(3),afterMix:(xo[g]??0).toFixed(3)})}Lt.beginPath();const d=2;for(let g=0;g<=n;g+=d){const f=g/n,p=Fn(f,s),v=i-p*o;g===0?Lt.moveTo(g,v):Lt.lineTo(g,v)}const h=.4+r/100*.6;Lt.strokeStyle=be(ui(Ct,-.3),h),Lt.lineWidth=2.5,Lt.stroke();const m=r/100;if(m>0){Lt.beginPath(),Lt.moveTo(0,0),Lt.lineTo(n,0);const g=Fn(1,s),f=i-g*o;Lt.lineTo(n,f);for(let p=n;p>=0;p-=2){const v=p/n,w=Fn(v,s),y=i-w*o;Lt.lineTo(p,y)}Lt.closePath(),Lt.fillStyle=`rgba(255, 255, 255, ${m})`,Lt.fill()}}else xo.fill(1)}function Qn(){if(!Ct)return;const n=Ct;Is.forEach((t,e)=>{const o=t.sliderTrack.querySelector(".slider-fill"),i=t.sliderTrack.querySelector(".harmonic-label-internal");if(!o||!i)return;const s=zt[e]??0;if(o.style.height=`${s*100}%`,s>0){const r=ui(n,-.1);o.style.backgroundColor=be(r,1)}else o.style.backgroundColor="transparent";const a=o.querySelector("canvas");a&&a.remove(),s>.1?(i.style.color="rgba(255, 255, 255, 0.35)",i.style.textShadow="0 0 2px rgba(0,0,0,0.3)"):(i.style.color="rgba(51, 51, 51, 0.5)",i.style.textShadow="0 0 1px rgba(255,255,255,0.3)")}),rs()}function Ta(n,t=null){if(!Ct||!se)return;const e=n.target instanceof Element?n.target:null;if(ss("log","[BINS DRAG] handleBinPointerEvent called",{clientX:n.clientX,clientY:n.clientY}),b.debug("OvertoneBins","handleBinPointerEvent called",{target:e?.className},"filter"),e?.classList.contains("phase-button")||e?.closest(".phase-button")||e?.tagName==="path"||e?.tagName==="svg"){b.debug("OvertoneBins","Blocking phase button interaction in handleBinPointerEvent",null,"filter");return}if(t===null){const h=se.getBoundingClientRect(),m=n.clientX-h.left,g=h.width/ye,f=Math.floor(m/g);t=Math.max(0,Math.min(ye-1,f))}if(b.debug("OvertoneBins","handleBinPointerEvent - binIndex",{binIndex:t},"filter"),t===null)return;const o=l.state.timbres[Ct];if(!o)return;const i=Is[t];if(!i)return;const a=i.sliderTrack.getBoundingClientRect(),r=n.clientY-a.top,c=a.height,d=(c-r)/c,u=Math.max(0,Math.min(1,d));if(ss("log","[BINS DRAG] Setting bin",t+1,"value:",u.toFixed(3)),u===0){b.debug("OvertoneBins","Setting coefficient to zero immediately for bin",{binIndex:t},"filter");const h=new Float32Array(o.coeffs);h[t]=0,zt[t]=0,l.setHarmonicCoefficients(Ct,h);const m=Co[t];typeof m=="number"&&(clearTimeout(m),Co[t]=null),mn||(St.triggerAttack("C4",Ct),l.emit("spacebarPlayback",{color:Ct,isPlaying:!0}),mn=!0);const g=l.state.timbres[Ct]?.filter;g&&g.enabled!==!1&&(g.mix||0)>0&&so(h,g),window.waveformVisualizer?.generateWaveform&&window.waveformVisualizer.generateWaveform(),b.debug("OvertoneBins",`Set coefficient H${t+1} to 0 for color ${Ct}`,null,"filter")}else{const h=Co[t];typeof h=="number"&&(clearTimeout(h),Co[t]=null),mn||(St.triggerAttack("C4",Ct),l.emit("spacebarPlayback",{color:Ct,isPlaying:!0}),mn=!0),b.debug("OvertoneBins","BEFORE creating newCoeffs - store coeffs",{coeffs:o.coeffs},"filter");const m=new Float32Array(o.coeffs);b.debug("OvertoneBins","AFTER copying to newCoeffs",{newCoeffs:m},"filter"),m[t]=u,zt[t]=u,b.debug("OvertoneBins",`AFTER setting newCoeffs[${t}] = ${u}`,{newCoeffs:m},"filter"),l.setHarmonicCoefficients(Ct,m);const g=l.state.timbres[Ct]?.filter;g&&g.enabled!==!1&&(g.mix||0)>0&&so(m,g),window.waveformVisualizer?.generateWaveform&&window.waveformVisualizer.generateWaveform(),b.debug("OvertoneBins",`Updated coefficient H${t+1} to ${u} for color ${Ct}`,null,"filter"),b.debug("OvertoneBins","All coefficients",{newCoeffs:m},"filter")}Qn()}function ls(n,t,e,o){const i=e.coeffs,s=e.phases||new Float32Array(i.length).fill(0);let a=!0,r=!0;if(n.length!==i.length)a=!1;else for(let d=0;d<n.length;d++){const u=n[d]??0,h=i[d]??0;if(Math.abs(u-h)>.001){a=!1;break}}if(t.length!==s.length)r=!1;else for(let d=0;d<t.length;d++){const u=t[d]??0,h=s[d]??0;if(Math.abs(u-h)>.001){r=!1;break}}return a&&r}function Ia(n){if(!n)return;Ct=n;const t=l.state.timbres[n];t&&(t.filter?t.filter.enabled===void 0&&(t.filter.enabled=!0):t.filter={enabled:!0,blend:1,cutoff:16,resonance:0,type:"lowpass",mix:0},b.debug("OvertoneBins","updateForNewColor - timbre.coeffs",{coeffs:t.coeffs},"filter"),b.debug("OvertoneBins","updateForNewColor - timbre.phases",{phases:t.phases},"filter"),zt=new Float32Array(t.coeffs),t.phases?ee=new Float32Array(t.phases):ee=new Float32Array(zt.length).fill(0),ls(zt,ee,t),b.debug("OvertoneBins","updateForNewColor - final coeffs",{coeffs:zt},"filter"),b.debug("OvertoneBins","updateForNewColor - final phases",{phases:ee},"filter"),as.forEach(({phaseBtn:e},o)=>{if(!e)return;let s=(ee[o]||0)%(2*Math.PI);s<0&&(s+=2*Math.PI);const a=.1;let r=0;Math.abs(s-Math.PI/2)<a?r=90:Math.abs(s-Math.PI)<a?r=180:Math.abs(s-3*Math.PI/2)<a&&(r=270),e.innerHTML=zo[r]}),Qn())}function hf(){const n=document.querySelector(".filter-container"),t=n?.querySelector(".filter-bins-wrapper"),e=n?.querySelector(".filter-vertical-blend-wrapper");if(!n||!t||!e){b.error("OvertoneBins","Missing required elements - aborting init",null,"audio");return}se=document.createElement("div"),se.className="overtone-bins-grid";for(let r=0;r<ye;r++){const c=document.createElement("div");c.className="slider-column";const d=document.createElement("div");d.className="slider-track";const u=document.createElement("div");u.className="slider-fill",d.appendChild(u);const h=document.createElement("div");h.className="harmonic-label-internal",h.textContent=`${r+1}`,d.appendChild(h),c.appendChild(d);const m=document.createElement("button");m.className="phase-button",m.innerHTML=zo[0],m.dataset.binIndex=String(r),m.addEventListener("pointerenter",()=>{if(Ao){const f=Rt(),p=St.synths,v=Ct;if(v&&p?.[v]?.activeNotes?.C4){const w=p[v].activeNotes.C4;w.oscillators?.[r]&&w.oscillators[r].volume.linearRampTo(-1/0,.015,f)}setTimeout(()=>{const w=Ct,y=w?l.state.timbres[w]:void 0;if(!w||!y)return;const C=new Float32Array(y.coeffs);C[r]=0,zt[r]=0,l.setHarmonicCoefficients(w,C);const P=l.state.timbres[w]?.filter;P&&P.enabled!==!1&&(P.mix||0)>0&&so(C,P),Qn()},.015*1e3)}}),m.addEventListener("click",g=>{if(Ao){g.preventDefault();return}const f=Ct;if(!f)return;b.debug("OvertoneBins","Phase button click handler started",null,"filter"),b.debug("OvertoneBins","Current coeffs before phase change",{coeffs:zt},"filter"),g.preventDefault();const p=new Float32Array(ee),v=new Float32Array(ee);let y=(v[r]||0)%(2*Math.PI);y<0&&(y+=2*Math.PI);const C=.1;let P=0;Math.abs(y)<C?P=Math.PI/2:Math.abs(y-Math.PI/2)<C?P=Math.PI:Math.abs(y-Math.PI)<C?P=3*Math.PI/2:P=0,v[r]=P,ee=v,window.waveformVisualizer?.startPhaseTransition&&window.waveformVisualizer.startPhaseTransition(p,v,r),l.setHarmonicPhases(f,v);const T=P===0?0:Math.abs(P-Math.PI/2)<C?90:Math.abs(P-Math.PI)<C?180:270;m.innerHTML=zo[T],b.debug("OvertoneBins",`Phase button clicked for H${r+1}, new phase: ${T}`,null,"filter")}),c.appendChild(m),se.appendChild(c),Is.push({column:c,label:h,sliderTrack:d,sliderFill:u,phaseBtn:m}),as.push({phaseBtn:m})}se.addEventListener("pointerdown",r=>{const c=r.target instanceof Element?r.target:null;if(ss("log","[BINS DRAG] Pointerdown event fired",{target:c,className:c?.className}),c?.classList.contains("phase-button")||c?.closest(".phase-button")){b.debug("OvertoneBins","Pointerdown blocked - phase button clicked",null,"filter");return}if(b.debug("OvertoneBins","Pointerdown - handling bin interaction",null,"filter"),r.preventDefault(),Ao=!0,!Ct)return;const d=Ct;St.triggerAttack("C4",d),l.emit("spacebarPlayback",{color:d,isPlaying:!0}),mn=!0,Ta(r);const u=m=>Ta(m),h=()=>{window.removeEventListener("pointermove",u),window.removeEventListener("pointerup",h),Ao=!1;const m=!!window.waveformVisualizer?.generateWaveform;l.recordState(),St.triggerRelease("C4",d),l.emit("spacebarPlayback",{color:d,isPlaying:!1}),mn=!1,m?setTimeout(()=>{window.waveformVisualizer?.generateWaveform?.()},0):b.warn("OvertoneBins","Static waveform visualizer not ready when drag ended",null,"audio")};window.addEventListener("pointermove",u),window.addEventListener("pointerup",h)}),Bt=document.createElement("canvas"),Bt.id="filter-overlay-canvas",Bt.className="filter-overlay-canvas",Bt.style.pointerEvents="none",Lt=Bt.getContext("2d"),se.appendChild(Bt);const o=document.createElement("div");o.className="vertical-blend-wrapper";const i=document.createElement("div");i.id="vertical-blend-track";const s=document.createElement("div");s.id="vertical-blend-thumb",s.textContent="M",i.appendChild(s),o.appendChild(i),t.appendChild(se),e.appendChild(o);const a=()=>{if(!Bt)return;const r=Bt.getBoundingClientRect();(Bt.width!==r.width||Bt.height!==r.height)&&(Bt.width=r.width,Bt.height=r.height,rs())};Ct=l.state.selectedNote?.color||"#4a90e2",Ia(Ct),l.on("timbreChanged",r=>{if(r&&r===Ct){b.debug("OvertoneBins","timbreChanged event - checking what changed",null,"filter");const c=l.state.timbres[r];if(!c)return;const d=c.coeffs,u=c.phases;let h=!1;if(b.debug("OvertoneBins","Comparing coefficients...",null,"filter"),b.debug("OvertoneBins","Local coeffs",{coeffs:zt},"filter"),b.debug("OvertoneBins","Store coeffs",{newCoeffs:d},"filter"),zt.length!==d.length)b.debug("OvertoneBins","Array length mismatch - coeffsChanged = true",null,"filter"),h=!0;else for(let m=0;m<d.length;m++){const g=zt[m]??0,f=d[m]??0,p=Math.abs(g-f);if(p>.001){b.debug("OvertoneBins",`Coefficient ${m} changed: ${g} -> ${f} (diff: ${p})`,null,"filter"),h=!0;break}}b.debug("OvertoneBins","Force syncing local coeffs with store",null,"filter"),ls(zt,ee,c),zt=new Float32Array(d),u?ee=new Float32Array(u):ee=new Float32Array(zt.length).fill(0),ls(zt,ee,c),h?(b.debug("OvertoneBins","Coefficients changed - updating visuals",null,"filter"),Qn()):(b.debug("OvertoneBins","No coefficient changes detected - but local coeffs synced",null,"filter"),rs()),as.forEach(({phaseBtn:m},g)=>{if(!m)return;let p=(ee[g]||0)%(2*Math.PI);p<0&&(p+=2*Math.PI);const v=.1;let w=0;Math.abs(p-Math.PI/2)<v?w=90:Math.abs(p-Math.PI)<v?w=180:Math.abs(p-3*Math.PI/2)<v&&(w=270),m.innerHTML=zo[w]})}}),l.on("noteChanged",({newNote:r}={})=>{r?.color&&r.color!==Ct&&Ia(r.color)}),l.on("filterChanged",r=>{const c=Ct;if(c&&r===c){Qn();const d=l.state.timbres[c],u=d?.filter;if(!d)return;u&&u.enabled!==!1&&(u.mix||0)>0?so(d.coeffs,u):new Float32Array(d.coeffs)}}),new ResizeObserver(a).observe(se),a(),b.info("OvertoneBins","Initialized with columnar div structure and perfect alignment",null,"filter")}b.moduleLoaded("EngineAudio","general");let mt=null;const St={init(){b.info("EngineAudio","Initializing with engine createSynthEngine()",null,"audio"),mt=kd({timbres:l.state.timbres,masterVolume:0,harmonicFilter:{getFilteredCoefficients:n=>is(n)},effectsManager:{applySynthEffects:(n,t,e)=>{window.audioEffectsManager?.applySynthEffects(n,t,e)},applyEffectsToVoice:(n,t)=>{window.audioEffectsManager?.applyEffectsToVoice(n,t)}},logger:{debug:(n,t,e)=>{b.debug(n,t,e,"audio")},info:(n,t,e)=>{b.info(n,t,e,"audio")},warn:(n,t,e)=>{b.warn(n,t,e,"audio")}}}),mt.init(),l.on("timbreChanged",n=>{n&&this.updateSynthForColor(n)}),l.on("filterChanged",n=>{n&&this.updateSynthForColor(n)}),l.on("audioEffectChanged",n=>{if(!n||!n.color||!n.effectType)return;const{effectType:t,color:e}=n;(t==="vibrato"||t==="tremolo")&&this.updateSynthForColor(e)}),l.on("volumeChanged",n=>{typeof n=="number"&&this.setVolume(n)}),window.synthEngine=this,b.info("EngineAudio","Initialization complete",null,"audio")},updateSynthForColor(n){if(!mt)return;const t=l.state.timbres[n];t&&(t.vibrato||(t.vibrato={speed:0,span:0}),t.tremelo||(t.tremelo={speed:0,span:0}),mt.updateSynthForColor(n))},playNote(n,t,e){mt&&mt.playNote(n,t,e)},triggerAttack(n,t,e,o){mt&&mt.triggerAttack(n,t,e,o)},triggerAttackInteractive(n,t){mt&&mt.triggerAttackInteractive(n,t)},triggerRelease(n,t,e){mt&&mt.triggerRelease(n,t,e)},releaseAll(){mt&&mt.releaseAll()},quickReleasePitches(n,t){mt&&mt.quickReleasePitches(n,t)},setSynth(n,t){mt&&mt.setSynth?.(n,t)},getSynth(n){return mt?mt.getSynth(n):null},getAllSynths(){return mt?mt.getAllSynths():{}},setBpm(n){mt&&mt.setBpm(n)},setVolume(n){mt&&mt.setVolume(n)},getMasterGainNode(){return mt?mt.getMasterGainNode():null},getMainVolumeNode(){return mt?mt.getMainVolumeNode():null},createWaveformAnalyzer(n){return mt?mt.createWaveformAnalyzer(n):null},getWaveformAnalyzer(n){return mt?mt.getWaveformAnalyzer(n):null},getAllWaveformAnalyzers(){return mt?mt.getAllWaveformAnalyzers():new Map},removeWaveformAnalyzer(n){mt&&mt.removeWaveformAnalyzer(n)},disposeAllWaveformAnalyzers(){mt&&mt.disposeAllWaveformAnalyzers()},stopBackgroundMonitors(){mt&&mt.stopBackgroundMonitors()},teardown(){this.dispose()},dispose(){mt&&(mt.dispose(),mt=null)}};class ff{elements=new Map;initialized=!1;init(){this.initialized||(this.cacheElement("notationGrid","notation-grid"),this.cacheElement("playheadCanvas","playhead-canvas"),this.cacheElement("hoverCanvas","hover-canvas"),this.cacheElement("drumGrid","drum-grid"),this.cacheElement("drumPlayheadCanvas","drum-playhead-canvas"),this.cacheElement("drumHoverCanvas","drum-hover-canvas"),this.cacheElement("appContainer","app-container"),this.cacheElement("pitchGridWrapper","pitch-grid-wrapper"),this.cacheElement("drumGridWrapper","drum-grid-wrapper"),this.cacheElement("eraserButton","eraser-tool-button"),this.cacheElement("playButton","play-button"),this.cacheElement("stopButton","stop-button"),this.cacheElement("clearButton","clear-button"),this.cacheElement("loopButton","loop-button"),this.cacheElement("undoButton","undo-button"),this.cacheElement("redoButton","redo-button"),this.cacheElement("noteBankContainer","note-bank-container"),this.cacheElement("tonicModeGrid","tonic-mode-grid"),this.cacheElement("degreeVisibilityToggle","degree-visibility-toggle"),this.cacheElement("degreeModeToggle","degree-mode-toggle"),this.cacheElement("flatBtn","flat-toggle-btn"),this.cacheElement("sharpBtn","sharp-toggle-btn"),this.cacheElement("frequencyBtn","hz-toggle-btn"),this.cacheElement("octaveLabelBtn","spn-octave-toggle-btn"),this.cacheElement("focusColoursToggle","focus-colours-toggle"),this.cacheElement("harmonyContainerMain","chordShape-container"),this.cacheElement("tempoSlider","tempo-slider"),this.cacheElement("volumeSlider","vertical-volume-slider"),this.initialized=!0)}cacheElement(t,e){const o=document.getElementById(e);o&&this.elements.set(t,o)}get(t){return this.initialized?this.elements.get(t)??null:null}getMultiple(...t){const e={};return t.forEach(o=>{e[o]=this.get(o)}),e}has(t){return this.elements.has(t)}refresh(){this.elements.clear(),this.initialized=!1,this.init()}getStats(){const t=this.elements.size,e=Array.from(this.elements.values()).filter(o=>o!==null).length;return{totalCached:t,foundElements:e,missingElements:t-e}}}const Ne=new ff;let mf=[],pf=0,La=null,$o=[];function gf(){const n=l.state,t=Ft.getColumnMap(n);if(La!==t){La=t,$o=[];for(const e of t.entries){if(e.type!=="beat"||e.canvasIndex===null||e.macrobeatIndex===null)continue;const o=e.macrobeatIndex,i=$o[o];if(!i){$o[o]={start:e.canvasIndex,end:e.canvasIndex};continue}i.start=Math.min(i.start,e.canvasIndex),i.end=Math.max(i.end,e.canvasIndex)}}}function Ls(){return{cellWidth:l.state.cellWidth,tempoModulationMarkers:l.state.tempoModulationMarkers,baseMicrobeatPx:l.state.baseMicrobeatPx}}function ka(){return mf}function vf(){return pf}function Jo(n){const t=Ls(),e=Math.max(0,Math.floor(n));return Xe.getColumnPixelPosition(e,t,l.state)?.xStart??0}function Xr(n){const t=Ls(),e=Math.max(0,Math.floor(n));return Xe.getColumnPixelPosition(e,t,l.state)?.width??0}function bf(){return Array.isArray(l.state.columnWidths)?l.state.columnWidths.length:0}function wf(){const n=Ls(),t=bf();return Xe.getColumnPixelPosition(t,n,l.state)?.xStart??0}function cs(n){const t=l.state;gf();const e=Ft.getColumnMap(t),o=e.canvasToVisual.get(Math.floor(n));if(o===void 0)return null;const s=e.entries[o]?.macrobeatIndex;if(s==null)return null;const a=$o[s];if(!a)return null;const r=Jo(a.start),c=Jo(a.end+1);return{x:r,width:Math.max(0,c-r)}}const yf={hz:0,minAlpha:.2,maxAlpha:.2,maxExpandPx:0,colorRgb:"rgb(255, 235, 0)"};function Wn(n,t,e,o,i,s,a=yf){if(!Number.isFinite(t)||!Number.isFinite(e)||!Number.isFinite(o)||!Number.isFinite(i)||o<=0||i<=0)return;const r=s/1e3,c=a.hz>0?.5+.5*Math.sin(r*(2*Math.PI)*a.hz):1,d=a.minAlpha+(a.maxAlpha-a.minAlpha)*c,u=Math.min(a.maxExpandPx,Math.max(0,o*.1))*c;n.save(),n.globalAlpha=d,n.fillStyle=a.colorRgb,n.fillRect(t-u/2,e,o+u,i),n.restore()}class Sf{canvas=null;ctx=null;animationFrameId=null;_lastColumnIndex=null;_lastColumnProgress=0;_lastColumnStartX=0;_lastColumnWidth=0;_lastDebugLogTime=0;activeAnimations=new Map;popDuration={scaleUp:100,scaleDown:300};popScale=1.5;ensureContext(){return this.canvas||(this.canvas=document.getElementById("drum-playhead-canvas")),this.canvas?(this.ctx||(this.ctx=this.canvas.getContext("2d")),this.ctx):null}initialize(){this.canvas=document.getElementById("drum-playhead-canvas"),this.canvas&&(this.ctx=this.canvas.getContext("2d"),l.on("playbackStateChanged",()=>this.handlePlaybackStateChange()),l.on("tempoChanged",()=>this.invalidateTimeMap()))}drawPlayheadLine(t){const e=this.ensureContext();if(!e||!this.canvas)return;const o=Pt(this.canvas);e.strokeStyle="rgba(255, 0, 0, 0.8)",e.lineWidth=2,e.beginPath(),e.moveTo(t,0),e.lineTo(t,o),e.stroke()}drawColumnHighlight(t,e,o){const i=this.ensureContext();if(!i||!this.canvas)return;const s=Pt(this.canvas);Wn(i,t,0,e,s,o)}handlePlaybackStateChange(){l.state.isPlaying&&!l.state.isPaused?this.startRendering():this.stopRendering({clear:!l.state.isPaused})}invalidateTimeMap(){}startRendering(){this.animationFrameId||this.render()}stopRendering({clear:t}={clear:!0}){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),t&&this.ctx&&this.canvas&&this.ctx.clearRect(0,0,qt(this.canvas),Pt(this.canvas))}render(){if(!l.state.isPlaying||l.state.isPaused||!this.ctx||!this.canvas){this.animationFrameId=null;return}this.ctx.clearRect(0,0,qt(this.canvas),Pt(this.canvas));const t=Number(rt.seconds||0),e=this.calculateXFromTime(t);if(e===null){this.animationFrameId=requestAnimationFrame(()=>this.render());return}const o=Pt(this.canvas);if(l.state.playheadMode==="macrobeat"){const i=this._lastColumnIndex,s=(i!==null?cs(i):null)??(i!==null?cs(i+1):null);s?Wn(this.ctx,s.x,0,s.width,o,performance.now()):Wn(this.ctx,this._lastColumnStartX,0,this._lastColumnWidth,o,performance.now())}else l.state.playheadMode==="microbeat"?Wn(this.ctx,this._lastColumnStartX,0,this._lastColumnWidth,o,performance.now()):(this.ctx.strokeStyle="#FF6B35",this.ctx.lineWidth=3,this.ctx.shadowColor="#FF6B35",this.ctx.shadowBlur=6,this.ctx.beginPath(),this.ctx.moveTo(e,0),this.ctx.lineTo(e,o),this.ctx.stroke(),this.ctx.shadowBlur=0);this.debugPlayhead(rt.seconds,e),this.animationFrameId=requestAnimationFrame(()=>this.render())}calculateXFromTime(t){this._lastColumnIndex=null,this._lastColumnProgress=0,this._lastColumnStartX=0,this._lastColumnWidth=0;const e=ka();if(!Array.isArray(e)||e.length<2)return null;for(let o=0;o<e.length-1;o++){const i=e[o],s=e[o+1];if(!(typeof i!="number"||typeof s!="number")&&t>=i&&t<s){const a=s-i,r=t-i,c=Jo(o)??0,d=Xr(o)??0;return this._lastColumnIndex=o,this._lastColumnProgress=a>0?r/a:0,this._lastColumnStartX=c,this._lastColumnWidth=d,c+(a>0?r/a*d:0)}}return null}debugPlayhead(t,e){if(!window.__DEBUG_PLAYHEAD_SYNC__)return;const o=performance.now();if(o-this._lastDebugLogTime<250)return;this._lastDebugLogTime=o;const i=ka(),s=this._lastColumnIndex,a=Array.isArray(i)&&s!==null&&s>=0?i[s]:void 0,r=Array.isArray(i)&&s!==null&&s+1<i.length?i[s+1]:void 0,c=Array.isArray(i)?i[i.length-1]??0:0,d=vf(),u={transportSeconds:Number(t.toFixed(3)),drumX:Number((e??0).toFixed(2)),columnIndex:s,columnProgress:Number(this._lastColumnProgress.toFixed(3)),drumStartTime:Number(a?.toFixed(3)??NaN),transportStartTime:Number(a?.toFixed(3)??NaN),startDelta:0,drumEndTime:Number(r?.toFixed(3)??NaN),transportEndTime:Number(r?.toFixed(3)??NaN),endDelta:0,drumTimelineEnd:Number(c.toFixed(3)),transportTimelineEnd:Number(d.toFixed(3)),timelineDelta:Number((c-d).toFixed(3)),toneLoopStart:Number(Number(rt.loopStart??0).toFixed(3)),toneLoopEnd:Number(Number(rt.loopEnd??0).toFixed(3)),storeLooping:l.state.isLooping};b.debug("DrumPlayheadRenderer","Playhead diagnostics",u,"canvas")}triggerNotePop(t,e){const o=`${t}-${e}`;this.activeAnimations.set(o,{startTime:performance.now(),phase:"scaleUp"}),window.drumGridRenderer&&window.drumGridRenderer.render()}getAnimationScale(t,e){const o=`${t}-${e}`,i=this.activeAnimations.get(o);if(!i)return 1;const s=performance.now(),a=s-i.startTime;if(i.phase==="scaleUp"){if(a>=this.popDuration.scaleUp)return i.phase="scaleDown",i.startTime=s,this.popScale;{const r=a/this.popDuration.scaleUp;return 1+(this.popScale-1)*r}}else if(i.phase==="scaleDown"){if(a>=this.popDuration.scaleDown)return this.activeAnimations.delete(o),1;{const r=a/this.popDuration.scaleDown;return this.popScale-(this.popScale-1)*r}}return 1}hasActiveAnimations(){return this.activeAnimations.size>0}cleanupAnimations(){const t=performance.now();for(const[e,o]of this.activeAnimations.entries()){const i=t-o.startTime,s=o.phase==="scaleUp"?this.popDuration.scaleUp:this.popDuration.scaleUp+this.popDuration.scaleDown;i>s&&this.activeAnimations.delete(e)}}}const ke=new Sf;b.moduleLoaded("SixteenthStampPlacements","stamps");function Cf(n,t,e,o="#4a90e2"){return ci(n)?l.addSixteenthStampPlacement(n,t,e,o):(b.warn("SixteenthStampPlacements",`Invalid sixteenth stamp ID: ${n}`,{sixteenthStampId:n},"stamps"),null)}function Af(n,t,e,o){return l.eraseSixteenthStampsInArea(n,t,e,o)}function Yr(){l.clearAllSixteenthStamps()}function xf(){return l.getSixteenthStampPlaybackData()}b.moduleLoaded("SixteenthStampScheduler","stamps");const Na=["0","16n","8n",{"8n":1,"16n":1}];function Qr(n,t=null){const e=ci(n);if(!e)return b.warn("SixteenthStampScheduler",`Unknown sixteenth stamp ID: ${n}`,{sixteenthStampId:n},"stamps"),[];const o=[];return e.ovals.forEach(i=>{const s=`oval_${i}`,a=t?.shapeOffsets?.[s]||0;o.push({offset:Na[i],duration:"8n",type:"oval",slot:i,shapeKey:s,rowOffset:a})}),e.diamonds.forEach(i=>{const s=`diamond_${i}`,a=t?.shapeOffsets?.[s]||0;o.push({offset:Na[i],duration:"16n",type:"diamond",slot:i,shapeKey:s,rowOffset:a})}),o}b.moduleLoaded("TripletStampPlacements","triplets");function Mf(n,t,e,o="#4a90e2"){const i=di(n);if(!i)return b.warn("TripletStampPlacements",`Invalid triplet stamp ID: ${n}`,{tripletStampId:n},"triplets"),null;const s=Fr[i.span]??1;if(!Ef(t,s,e))return b.debug("TripletStampPlacements",`Cannot place triplet at time ${t}, row ${e} - collision detected`,{tripletStampId:n,startTimeIndex:t,row:e,span:s},"triplets"),null;const a=e,r={id:`triplet_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,tripletStampId:n,startTimeIndex:t,span:s,row:e,globalRow:a,color:o,timestamp:Date.now()};return l.addTripletStampPlacement(r)}function Ef(n,t,e){const o=l.state,i=Gt(o),s=t*2,a=Kt(n,o);for(const r of i){const c=r.columnIndex,d=r.columnIndex+1;if(c>=a&&c<a+s||a>=c&&a<=d)return!1}if(o.sixteenthStampPlacements){for(const r of o.sixteenthStampPlacements)if(r.row===e){const c=qe(r.startColumn,o);if(c===null)return!1;const d=c+2,u=n+s;if(!(d<=n||c>=u))return!1}}if(o.tripletStampPlacements){for(const r of o.tripletStampPlacements)if(r.row===e){const c=r.startTimeIndex+r.span*2;if(!(n+s<=r.startTimeIndex||n>=c))return!1}}return!0}function Pf(n,t,e,o){const i=l.state;if(!i.tripletStampPlacements)return!1;const s=[];for(const a of i.tripletStampPlacements)if(a.row>=e&&a.row<=o){const r=a.span*2,c=Kt(a.startTimeIndex,i);c+r-1<n||c>t||s.push(a.id)}return s.length>0?(s.forEach(a=>l.removeTripletStampPlacement(a)),b.debug("TripletStampPlacements",`Erased ${s.length} triplet groups`,{removedIds:s,eraseArea:{eraseStartCol:n,eraseEndCol:t,eraseStartRow:e,eraseEndRow:o}},"triplets"),!0):!1}function Tf(){return l.getTripletStampPlaybackData()}function jr(){l.clearAllTripletStamps(),b.info("TripletStampPlacements","Cleared all triplet stamp placements",null,"triplets")}b.moduleLoaded("TripletScheduler","triplets");function Zr(n,t=null){const e=di(n);if(!e)return b.warn("TripletScheduler",`Unknown triplet stamp ID: ${n}`,{tripletStampId:n},"triplets"),[];const o=[],i=e.span==="eighth"?"8t":"4t",s=i;return e.hits.forEach(a=>{const r=`triplet_${a}`,c=t?.shapeOffsets?.[r]||0;let d;if(a===0)d="0";else if(a===1)d=i;else if(a===2){const u=Nt(i).toSeconds();d=Nt(u*2).toNotation()}else{const u=Nt(i).toSeconds();d=Nt(u*a).toNotation()}o.push({offset:d,duration:s,type:e.span==="eighth"?"triplet-eighth":"triplet-quarter",slot:a,shapeKey:r,rowOffset:c}),b.debug("TripletScheduler",`Triplet stamp ${n} ${e.span} at slot ${a} with offset "${d}", rowOffset: ${c}`,"triplets")}),b.debug("TripletScheduler",`Total events for triplet stamp ${n}:`,o.length,"triplets"),o}b.moduleLoaded("EngineTransport","general");let Vt=null;const kn=()=>Ne.get("playheadCanvas")??document.getElementById("playhead-canvas"),Mo=()=>Ne.get("drumPlayheadCanvas")??document.getElementById("drum-playhead-canvas"),If=()=>Ne.get("beatLineHighlight")??document.getElementById("beat-line-highlight"),Ie={init(){b.info("EngineTransport","Initializing with engine createTransportService()",null,"transport"),Vt=Wd({synthEngine:St,stateCallbacks:{getState:()=>({tempo:l.state.tempo,columnWidths:l.state.columnWidths,hasAnacrusis:l.state.hasAnacrusis,macrobeatBoundaryStyles:l.state.macrobeatBoundaryStyles,tempoModulationMarkers:l.state.tempoModulationMarkers,isLooping:l.state.isLooping,isPaused:l.state.isPaused,cellWidth:l.state.cellWidth,placedNotes:l.state.placedNotes,timbres:l.state.timbres,fullRowData:l.state.fullRowData,playheadMode:l.state.playheadMode}),getStampPlaybackData:()=>xf().map(n=>({sixteenthStampId:String(n.sixteenthStampId),column:n.column,row:n.row,color:n.color,placement:n.placement})),getStampScheduleEvents:(n,t)=>{const e=typeof n=="string"?Number(n):n;return Number.isFinite(e)?Qr(e,t??null):[]},getTripletPlaybackData:()=>Tf().map(n=>({tripletStampId:String(n.tripletStampId),startTimeIndex:n.startTimeIndex,row:n.row,color:n.color,placement:n.placement})),getTripletScheduleEvents:(n,t)=>{const e=typeof n=="string"?Number(n):n;return Number.isFinite(e)?Zr(e,t??null):[]},timeToCanvas:(n,t)=>Kt(n,t),getPlacedTonicSigns:()=>Gt(l.state),getTonicSpanColumnIndices:n=>ku(n),getMacrobeatInfo:n=>Zt(l.state,n),getColumnStartX:n=>Jo(n),getColumnWidth:n=>Xr(n),getCanvasWidth:()=>wf(),getMacrobeatHighlightRect:n=>cs(n)},eventCallbacks:{on:(n,t)=>l.on(n,t),emit:(n,t)=>l.emit(n,t),setPlaybackState:(n,t)=>l.setPlaybackState(n,t)},visualCallbacks:{clearPlayheadCanvas:()=>{const n=kn();if(!n)return;const t=n.getContext("2d");if(!t)return;const e=qt(n),o=Pt(n);t.clearRect(0,0,e,o)},clearDrumPlayheadCanvas:()=>{const n=Mo();if(!n)return;const t=n.getContext("2d");if(!t)return;const e=qt(n),o=Pt(n);t.clearRect(0,0,e,o)},drawPlayheadLine:(n,t)=>{const e=kn();if(!e)return;const o=e.getContext("2d");o&&(o.strokeStyle="rgba(255, 0, 0, 0.8)",o.lineWidth=2,o.beginPath(),o.moveTo(n,0),o.lineTo(n,t),o.stroke())},drawPlayheadHighlight:(n,t,e,o)=>{const i=kn();if(!i)return;const s=i.getContext("2d");s&&Wn(s,n,0,t,e,o)},drawDrumPlayheadLine:(n,t)=>{Mo()&&ke.drawPlayheadLine(n)},drawDrumPlayheadHighlight:(n,t,e,o)=>{Mo()&&ke.drawColumnHighlight(n,t,o)},updateBeatLineHighlight:(n,t,e)=>{const o=If();o&&(e?(o.style.left=`${n}px`,o.style.width=`${t}px`,o.style.display="block"):o.style.display="none")},triggerDrumNotePop:(n,t)=>{ke.triggerNotePop(n,t)},triggerAdsrVisual:(n,t,e,o)=>{window.adsrComponent&&window.adsrComponent.triggerPlayheadVisual(n,t,e,o)},clearAdsrVisuals:()=>{window.adsrComponent&&window.adsrComponent.clearAllPlayheadVisuals()},getPlayheadCanvasWidth:()=>{const n=kn();return n?qt(n):0},getPlayheadCanvasHeight:()=>{const n=kn();return n?Pt(n):0},getDrumCanvasHeight:()=>{const n=Mo();return n?Pt(n):0}},logger:{debug:(n,t,e)=>{b.debug(n,t,e,"transport")},info:(n,t,e)=>{b.info(n,t,e,"transport")},warn:(n,t,e)=>{b.warn(n,t,e,"transport")}}}),Vt.init(),b.info("EngineTransport","Initialization complete",null,"transport")},handleStateChange(){Vt&&Vt.handleStateChange()},start(){Vt&&Vt.start()},resume(){Vt&&Vt.resume()},pause(){Vt&&Vt.pause()},stop(){Vt&&Vt.stop()},dispose(){Vt&&(Vt.dispose(),Vt=null)}},Lf=/(Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini)/i,Kr=900;let Ra=!1,Ho=Kr,Ri=!1;const kf=Object.freeze({isMobile:!1,isTouch:!1,isCoarsePointer:!1,orientation:"landscape",width:0,height:0});function ks(){return typeof window<"u"?window:null}function Nf(){const n=ks();if(!n)return{...kf};const{innerWidth:t=0,innerHeight:e=0}=n,o=n.matchMedia?n.matchMedia("(orientation: portrait)"):null,i=o?o.matches?"portrait":"landscape":e>=t?"portrait":"landscape",s=!!(n.matchMedia&&n.matchMedia("(pointer: coarse)").matches),a=!!(n.matchMedia&&n.matchMedia("(hover: none)").matches),r=typeof navigator<"u"?navigator:null,c=r?.maxTouchPoints??r?.msMaxTouchPoints??0,d="ontouchstart"in n||c>0,u=r?.userAgent?Lf.test(r.userAgent):!1,h=t>0?t<=Ho:!1;return{isMobile:!!(u||d&&(s||a||h)),isTouch:d,isCoarsePointer:s,orientation:i,width:t,height:e}}function Rf(n){if(typeof document>"u")return;[document.documentElement,document.body].filter(Boolean).forEach(e=>{e.classList.toggle("is-mobile",!!n.isMobile),e.classList.toggle("is-touch",!!n.isTouch),e.classList.toggle("orientation-portrait",n.orientation==="portrait"),e.classList.toggle("orientation-landscape",n.orientation==="landscape")})}function Eo(){if(Ri)return;const n=ks();n&&(Ri=!0,n.requestAnimationFrame(()=>{Ri=!1;const t=Nf();l.setDeviceProfile(t),Rf(t)}))}function Bf(n,t){return n?typeof n.addEventListener=="function"?(n.addEventListener("change",t),()=>n.removeEventListener("change",t)):typeof n.addListener=="function"?(n.addListener(t),()=>n.removeListener(t)):()=>{}:()=>{}}function Df(n={}){const t=ks();if(!t||Ra)return;Ho=n.maxMobileWidth??Kr,Ra=!0;const e=()=>Eo(),o=()=>Eo();t.addEventListener("resize",e),t.addEventListener("orientationchange",o),[t.matchMedia&&t.matchMedia("(pointer: coarse)"),t.matchMedia&&t.matchMedia("(hover: none)"),t.matchMedia&&t.matchMedia(`(max-width: ${Ho}px)`),t.matchMedia&&t.matchMedia("(orientation: portrait)")].filter(Boolean).forEach(s=>{Bf(s,Eo)}),Eo(),b.debug("DeviceProfileService",`Initialized (breakpoint <= ${Ho}px)`,null,"ui")}const Ff=()=>{const n="/music-learning-tools/";return n.endsWith("/")?n:`${n}/`},Wf=`${Ff()}assets/`;function Of(n=""){const t=n.replace(/^\/+/,"");return`${Wf}${t}`}function Be(n){return Of(`icons/${n}`)}class _f{tasks=[];completedTasks=0;totalTasks=0;startTime=null;loadingScreen=null;progressBar=null;progressText=null;statusText=null;initialized=!1;cache={fonts:new Map,icons:new Map,modules:new Map};diagnostics=[];createLoadingScreen(){if(this.loadingScreen)return;const t=document.getElementById("app-loading-screen");t?this.loadingScreen=t:(this.loadingScreen=document.createElement("div"),this.loadingScreen.id="app-loading-screen",this.loadingScreen.innerHTML=`
            <div class="loading-container">
                <div class="loading-logo">
                    <svg viewBox="0 0 100 100" class="logo-svg">
                        <circle cx="50" cy="50" r="45" class="logo-circle" />
                        <path d="M 30 50 Q 50 30, 70 50 T 70 70" class="logo-path" />
                    </svg>
                </div>
                <h1 class="loading-title">Student Notation</h1>
                <div class="loading-progress-container">
                    <div class="loading-progress-bar">
                        <div class="loading-progress-fill" id="loading-progress-fill"></div>
                    </div>
                    <div class="loading-progress-text" id="loading-progress-text">0%</div>
                </div>
                <div class="loading-status" id="loading-status">Initializing...</div>
            </div>
        `,document.body.appendChild(this.loadingScreen)),this.progressBar=this.loadingScreen.querySelector("#loading-progress-fill"),this.progressText=this.loadingScreen.querySelector("#loading-progress-text"),this.statusText=this.loadingScreen.querySelector("#loading-status")}registerTask(t,e=1){this.tasks.push({name:t,weight:e,completed:!1}),this.totalTasks+=e}completeTask(t){const e=this.tasks.find(o=>o.name===t&&!o.completed);e&&(e.completed=!0,this.completedTasks+=e.weight,this.updateProgress())}updateProgress(){if(!this.progressBar||!this.progressText)return;const t=this.totalTasks>0?this.completedTasks/this.totalTasks*100:0;this.progressBar.style.width=`${t}%`,this.progressText.textContent=`${Math.floor(t)}%`,t>=100&&this.completeLoading()}async nextFrame(t=200){await new Promise(e=>{let o=!1;const i=()=>{o||(o=!0,e())};typeof requestAnimationFrame=="function"?(requestAnimationFrame(()=>i()),setTimeout(()=>i(),t)):setTimeout(()=>i(),0)})}setStatus(t){this.statusText&&(this.statusText.textContent=t)}start(){this.initialized||(this.initialized=!0,this.startTime=performance.now())}completeLoading(){this.loadingScreen&&(this.loadingScreen.classList.add("fade-out"),setTimeout(()=>{this.loadingScreen?.remove(),this.loadingScreen=null},400))}showError(t){if(this.statusText){const e=t instanceof Error?t.message:String(t);this.statusText.textContent=`Error: ${e}`,this.statusText.style.color="#ff4444"}}init(){this.createLoadingScreen(),this.start()}updateStatus(t){this.setStatus(t)}async complete(){this.completeLoading()}async preloadIcon(t){if(this.cache.icons.has(t))return this.cache.icons.get(t);const e=Be(t);return this.cache.icons.set(t,e),e}getDiagnostics(){return[...this.diagnostics]}}const lt=new _f;let Ns=!1,Rs=[],qo=null;function Jr(){Ns=!0}function zf(){Ns=!1}function tl(n){try{return JSON.parse(JSON.stringify(n,(t,e)=>e instanceof Float32Array?{__type:"Float32Array",data:Array.from(e)}:e))}catch{return null}}function ds(n,t,e="root"){const o=[];if(!n||!t)return o;if(typeof n!=typeof t)return o.push({path:e,type:"type_change",oldValue:typeof n,newValue:typeof t,timestamp:Date.now()}),o;if(typeof n!="object")return n!==t&&o.push({path:e,type:"value_change",oldValue:n,newValue:t,timestamp:Date.now()}),o;if(Array.isArray(n)){if(!Array.isArray(t))return o.push({path:e,type:"array_to_non_array",oldLength:n.length,newType:typeof t,timestamp:Date.now()}),o;n.length!==t.length&&o.push({path:e,type:"array_length_change",oldLength:n.length,newLength:t.length,timestamp:Date.now()});const s=Math.max(n.length,t.length);for(let a=0;a<s;a++){const r=ds(n[a],t[a],`${e}[${a}]`);o.push(...r)}return o}const i=new Set([...Object.keys(n),...Object.keys(t)]);for(const s of i)if(!(s in n))o.push({path:`${e}.${String(s)}`,type:"property_added",newValue:t[s],timestamp:Date.now()});else if(!(s in t))o.push({path:`${e}.${String(s)}`,type:"property_removed",oldValue:n[s],timestamp:Date.now()});else{const a=ds(n[s],t[s],`${e}.${String(s)}`);o.push(...a)}return o}function $f(n){qo=tl(n)}function Hf(n,t="unknown"){if(!Ns||!qo)return;const e=tl(n),o=ds(qo,e);if(o.length>0){const i=o.filter(s=>!s.path.includes("tempo")&&!s.path.includes("isPlaying")&&!s.path.includes("fullRowData")&&!s.path.includes("columnWidths"));i.length>0&&Rs.push({action:t,mutations:i,timestamp:Date.now()})}qo=e}function qf(){return[...Rs]}function Gf(){Rs=[]}typeof window<"u"&&(window.stateGuard={enable:Jr,disable:zf,getLog:qf,clearLog:Gf});b.moduleLoaded("RhythmPlaybackService");class Vf{scheduledEvents=[];isInitialized=!1;constructor(){this.scheduledEvents=[],this.isInitialized=!1}init(){return this.initialize()}refresh(){this.stopCurrentPattern()}async initialize(){this.isInitialized||(this.isInitialized=!0,b.info("RhythmPlaybackService","Initialized"),window.rhythmPlaybackService=this)}playRhythmPattern(t,e,o,i="oval",s=null){if(!this.isInitialized){b.warn("RhythmPlaybackService","Not initialized, call initialize() first");return}this.stopCurrentPattern();const a=Qr(t,s);if(!a||a.length===0){b.warn("RhythmPlaybackService",`No events found for sixteenth stamp ${t}`);return}b.debug("RhythmPlaybackService",`Playing pattern for sixteenth stamp ${t}: ${a.length} notes`,{sixteenthStampId:t,basePitch:e,color:o,events:a,hasShapeOffsets:!!s?.shapeOffsets});const r=Rt(),c=s?.globalRow??s?.row;a.forEach((d,u)=>{try{const h=Nt(String(d.offset)).toSeconds(),m=r+h,g=Nt(String(d.duration)).toSeconds(),f=i==="circle"?g*2:g,p=m+f;let v=e;if(c!==void 0&&d.rowOffset!==0){const w=c+d.rowOffset,y=l.state.fullRowData[w];y&&(v=y.toneNote.replace("","b").replace("","#"))}St.triggerAttack(v,o,m),St.triggerRelease(v,o,p),this.scheduledEvents.push({pitch:v,color:o,attackTime:m,releaseTime:p})}catch(h){b.warn("RhythmPlaybackService",`Error scheduling note ${u+1}`,h)}}),b.info("RhythmPlaybackService",`Scheduled ${a.length} notes for rhythm pattern ${t}`)}stopCurrentPattern(){this.scheduledEvents.length!==0&&(b.debug("RhythmPlaybackService",`Clearing ${this.scheduledEvents.length} scheduled events`),St.releaseAll(),this.scheduledEvents=[])}getSixteenthStampAtPosition(t,e){return l.state.sixteenthStampPlacements&&l.state.sixteenthStampPlacements.find(i=>{const s=i.row===e,a=t>=i.startColumn&&t<i.endColumn;return s&&a})||null}playTripletPattern(t,e,o,i=null){if(!this.isInitialized){b.warn("RhythmPlaybackService","Not initialized, call initialize() first");return}this.stopCurrentPattern();const s=Zr(t,i);if(!s||s.length===0){b.warn("RhythmPlaybackService",`No events found for triplet ${t}`);return}b.debug("RhythmPlaybackService",`Playing triplet pattern ${t}: ${s.length} notes`,{tripletStampId:t,basePitch:e,color:o,events:s,hasShapeOffsets:!!i?.shapeOffsets});const a=Rt(),r=i?.globalRow??i?.row;s.forEach((c,d)=>{try{const u=Nt(c.offset).toSeconds(),h=a+u,m=Nt(c.duration).toSeconds(),g=h+m;let f=e;if(r!==void 0&&c.rowOffset!==0){const p=r+c.rowOffset,v=l.state.fullRowData[p];v&&(f=v.toneNote.replace("?T-","b").replace("?T_","#"))}St.triggerAttack(f,o,h),St.triggerRelease(f,o,g),this.scheduledEvents.push({pitch:f,color:o,attackTime:h,releaseTime:g})}catch(u){b.warn("RhythmPlaybackService",`Error scheduling triplet note ${d+1}`,u)}}),b.info("RhythmPlaybackService",`Scheduled ${s.length} notes for triplet pattern ${t}`)}getTripletStampAtPosition(t,e){return l.state.tripletStampPlacements&&l.state.tripletStampPlacements.find(o=>o.row===e&&t>=o.startTimeIndex&&t<o.startTimeIndex+o.span*2)||null}dispose(){this.stopCurrentPattern(),this.isInitialized=!1,b.info("RhythmPlaybackService","Disposed")}}const It=new Vf,el={H:"https://tonejs.github.io/audio/drum-samples/CR78/hihat.mp3",M:"https://tonejs.github.io/audio/drum-samples/CR78/snare.mp3",L:"https://tonejs.github.io/audio/drum-samples/CR78/kick.mp3"};let tn=null,en=null;const Ba=new Map,Uf=1e-4;let us=!1;function Xf(n,t){let e=Number.isFinite(t)?t:Rt();const o=Ba.get(n)??-1/0;return e>o||(e=o+Uf),Ba.set(n,e),e}function Da(){return tn}async function Yf(){if(!us){en=new As(el);try{await en.loaded,us=!0}catch(n){console.warn("Drum sample preloading failed, will load on-demand:",n),en?.dispose(),en=null}}}function Qf(){const n=new Cs(0);if(en&&us?(tn=en,tn.connect(n),en=null):tn=new As(el).connect(n),window.synthEngine){const t=window.synthEngine.getMainVolumeNode?.();t?n.connect(t):n.toDestination()}else n.toDestination();return window.drumVolumeNode=n,tn}function jf(n,t){if(!tn)return;const e=Xf(n,t);tn.player(n)?.start(e)}const nl=[];function Et(...n){nl.push(n)}const ol={enableModulationTool(){l.setSelectedTool("modulation"),Et("[MODULATION TEST] Modulation tool enabled. Click on the grid to place markers."),Et("[MODULATION TEST] Click marker labels to toggle 2:3  3:2"),Et("[MODULATION TEST] Drag marker barlines to move them")},addTestMarker(){const t=this.findNearestGridLine(200),e=this.findMeasureIndexForX(t.x),o=l.addModulationMarker(e,ne.COMPRESSION_2_3,t.x,t.columnIndex);return Et("[MODULATION TEST] Added test marker at measure",e,"columnIndex=",t.columnIndex,"x=",t.x,"(snapped from",200,")"),o},addTestMarker2(){const t=this.findNearestGridLine(400),e=this.findMeasureIndexForX(t.x),o=l.addModulationMarker(e,ne.EXPANSION_3_2,t.x,t.columnIndex);return Et("[MODULATION TEST] Added test marker 2 at measure",e,"columnIndex=",t.columnIndex,"x=",t.x,"(snapped from",400,")"),o},findNearestGridLine(n){const t=l.state;let e=0,o=0,i=1/0,s=0;for(let a=0;a<t.columnWidths.length;a++){const r=Math.abs(s-n);r<i&&(i=r,o=s,e=a);const c=t.columnWidths[a]||0;s+=c*t.cellWidth}return Et("[MODULATION TEST] findNearestGridLine:",{targetX:n,closestColumnIndex:e,closestX:o,minDistance:i}),{columnIndex:e,x:o}},findMeasureIndexForX(n){const t=l.state.cellWidth||40,e=5,o=Math.round(n/t);return Math.max(1,Math.round(o/e))},clearAllMarkers(){[...l.state.tempoModulationMarkers||[]].forEach(t=>{l.removeModulationMarker(t.id)}),Et("[MODULATION TEST] Cleared all markers")},testMapping(){const n=l.state.baseMicrobeatPx||l.state.cellWidth||40;Et("[MODULATION TEST] Base microbeat pixels:",n),Et("[MODULATION TEST] Modulation markers:",l.state.tempoModulationMarkers);const t=typeof window<"u"?window.getModulationMapping?.():void 0;t&&(Et("[MODULATION TEST] Coordinate mapping:",t),[0,100,200,300,400,500].forEach(o=>{const i=t.canvasXToMicrobeat(o),s=t.microbeatToCanvasX(i);Et(`[MODULATION TEST] x=${o}  microbeat=${i.toFixed(3)}  x=${s.toFixed(1)}`)}))},testVisualExpansion(){Et("[MODULATION TEST] Testing visual grid expansion..."),this.clearAllMarkers();const n=this.addTestMarker2();Et("[MODULATION TEST] Added 3:2 expansion marker:",n),typeof window<"u"&&window.LayoutService?.recalculateLayout&&(Et("[MODULATION TEST] Manually triggering layout recalculation..."),window.LayoutService.recalculateLayout()),setTimeout(()=>{Et("[MODULATION TEST] Grid should now show expansion after x=400"),Et("[MODULATION TEST] Container should be wider to accommodate expansion"),Et("[MODULATION TEST] Check console for [LAYOUT], [GETCOLX], [GRIDLINES], and [NOTES] logs")},100)},testVisualCompression(){Et("[MODULATION TEST] Testing visual grid compression..."),this.clearAllMarkers();const n=this.addTestMarker();Et("[MODULATION TEST] Added 2:3 compression marker:",n),typeof window<"u"&&window.LayoutService?.recalculateLayout&&(Et("[MODULATION TEST] Manually triggering layout recalculation..."),window.LayoutService.recalculateLayout()),setTimeout(()=>{Et("[MODULATION TEST] Grid should now show compression after x=200"),Et("[MODULATION TEST] Container should adjust to accommodate compression"),Et("[MODULATION TEST] Check console for [LAYOUT], [GETCOLX], [GRIDLINES], and [NOTES] logs")},100)},logState(){Et("[MODULATION TEST] Current state:",{selectedTool:l.state.selectedTool,tempoModulationMarkers:l.state.tempoModulationMarkers,baseMicrobeatPx:l.state.baseMicrobeatPx,cellWidth:l.state.cellWidth})}};typeof window<"u"&&(window.ModulationTest=ol,window.ModulationTestLogs=nl);b.moduleLoaded("ToolbarComponent","toolbar");const Zf={init(){b.info("ToolbarComponent","Toolbar init called (all controls managed by Svelte)",null,"toolbar")}};var Kf=Ue('<img alt="Pause" class="svelte-1sr4oe7"/>'),Jf=Ue('<img alt="Play" class="svelte-1sr4oe7"/>'),tm=Ue('<div class="playback-controls svelte-1sr4oe7"><button class="toolbar-button svelte-1sr4oe7"><!></button> <button class="toolbar-button svelte-1sr4oe7" title="Stop"><img alt="Stop" class="svelte-1sr4oe7"/></button> <button><img alt="Loop" class="svelte-1sr4oe7"/></button> <div class="separator svelte-1sr4oe7"></div> <button class="toolbar-button svelte-1sr4oe7" title="Clear All Notes"><img alt="Clear" class="svelte-1sr4oe7"/></button> <div class="separator svelte-1sr4oe7"></div> <button class="toolbar-button svelte-1sr4oe7" title="Undo"><img alt="Undo" class="svelte-1sr4oe7"/></button> <button class="toolbar-button svelte-1sr4oe7" title="Redo"><img alt="Redo" class="svelte-1sr4oe7"/></button></div>');function em(n,t){Wt(t,!0);let e=Tt(sn(l.state.isPlaying)),o=Tt(sn(l.state.isPaused)),i=Tt(sn(l.state.isLooping)),s=Tt(l.state.historyIndex>0),a=Tt(l.state.historyIndex<l.state.history.length-1);ae(()=>{const G=j=>{j&&(vt(e,j.isPlaying,!0),vt(o,j.isPaused,!0))},Y=j=>{j!==void 0&&vt(i,j,!0)},O=()=>{vt(s,l.state.historyIndex>0),vt(a,l.state.historyIndex<l.state.history.length-1)};return l.on("playbackStateChanged",G),l.on("loopingChanged",Y),l.on("historyChanged",O),O(),()=>{}});const r=Je(()=>Be("play.svg")),c=Je(()=>Be("pause.svg")),d=Je(()=>V(e)&&!V(o));function u(){V(e)&&V(o)?(l.setPlaybackState(!0,!1),Ie.resume()):V(e)&&!V(o)?(l.setPlaybackState(!0,!0),Ie.pause()):(l.setPlaybackState(!0,!1),Ie.start())}function h(){l.setPlaybackState(!1,!1),Ie.stop()}function m(){l.clearAllNotes(),Yr(),jr()}function g(){l.setLooping(!V(i))}function f(){l.undo()}function p(){l.redo()}var v=tm(),w=Dt(v);w.__click=u;var y=Dt(w);{var C=G=>{var Y=Kf();an(()=>wt(Y,"src",V(c))),oe(G,Y)},P=G=>{var Y=Jf();an(()=>wt(Y,"src",V(r))),oe(G,Y)};co(y,G=>{V(d)?G(C):G(P,!1)})}var T=$t(w,2);T.__click=h;var M=Dt(T),A=$t(T,2);let x;A.__click=g;var k=Dt(A),S=$t(A,4);S.__click=m;var E=Dt(S),I=$t(S,4);I.__click=f;var D=Dt(I),W=$t(I,2);W.__click=p;var Q=Dt(W);an((G,Y,O,j,at)=>{wt(w,"title",V(d)?"Pause":"Play"),wt(M,"src",G),x=ar(A,1,"toolbar-button svelte-1sr4oe7",null,x,{active:V(i)}),wt(A,"title",V(i)?"Disable Loop":"Enable Loop"),wt(k,"src",Y),wt(E,"src",O),I.disabled=!V(s),wt(D,"src",j),W.disabled=!V(a),wt(Q,"src",at)},[()=>Be("stop.svg"),()=>Be("loop.svg"),()=>Be("clear.svg"),()=>Be("undo.svg"),()=>Be("redo.svg")]),oe(n,v),Ot()}li(["click"]);function nm(n,t){Wt(t,!1);let e=l.state.isPlaying,o=l.state.isPaused,i=l.state.isLooping,s=l.state.historyIndex>0,a=l.state.historyIndex<l.state.history.length-1,r=null,c=null,d=null,u=null,h=null,m=null;function g(){e&&o?(l.setPlaybackState(!0,!1),Ie.resume()):e&&!o?(l.setPlaybackState(!0,!0),Ie.pause()):(l.setPlaybackState(!0,!1),Ie.start())}function f(){l.setPlaybackState(!1,!1),Ie.stop(),c?.blur()}function p(){u?.classList.add("flash"),setTimeout(()=>u?.classList.remove("flash"),300),l.clearAllNotes(),Yr(),jr(),u?.blur()}function v(){l.setLooping(!i)}function w(){l.undo(),h?.blur()}function y(){l.redo(),m?.blur()}function C(){if(!r)return;const M=`<img src="${cr}" alt="Play">`,A=`<img src="${lr}" alt="Pause">`;r.innerHTML=e&&!o?A:M}function P(){d&&d.classList.toggle("active",i)}function T(){h&&(h.disabled=!s),m&&(m.disabled=!a)}Re(()=>{r=document.getElementById("play-button"),c=document.getElementById("stop-button"),d=document.getElementById("loop-button"),u=document.getElementById("clear-button"),h=document.getElementById("undo-button"),m=document.getElementById("redo-button"),r?.addEventListener("click",g),c?.addEventListener("click",f),d?.addEventListener("click",v),u?.addEventListener("click",p),h?.addEventListener("click",w),m?.addEventListener("click",y);const M=k=>{k&&(e=k.isPlaying,o=k.isPaused,C())},A=k=>{k!==void 0&&(i=k,P())},x=()=>{s=l.state.historyIndex>0,a=l.state.historyIndex<l.state.history.length-1,T()};l.on("playbackStateChanged",M),l.on("loopingChanged",A),l.on("historyChanged",x),C(),P(),T(),console.log("[Svelte] PlaybackControlsBridge mounted")}),Ge(()=>{r?.removeEventListener("click",g),c?.removeEventListener("click",f),d?.removeEventListener("click",v),u?.removeEventListener("click",p),h?.removeEventListener("click",w),m?.removeEventListener("click",y),console.log("[Svelte] PlaybackControlsBridge unmounted")}),Ve(),Ot()}function om(n,t){Wt(t,!1);let e=null,o=null,i=null,s=null;function a(){const f=new Date,p=f.toLocaleDateString("en-US",{month:"long"}),v=f.getDate();return`SN-score-${p}${v}.csv`}async function r(f){try{const p={suggestedName:a(),types:[{description:"Student Notation CSV File",accept:{"text/csv":[".csv"]}}]},w=await(await window.showSaveFilePicker(p)).createWritable();await w.write(f),await w.close()}catch(p){p.name!=="AbortError"&&b.error("FileActionsBridge","Error saving file with picker",p,"toolbar")}}function c(f){const p=document.createElement("a"),v=URL.createObjectURL(f);p.setAttribute("href",v),p.setAttribute("download",a()),document.body.appendChild(p),p.click(),document.body.removeChild(p),URL.revokeObjectURL(v)}function d(){return l.state.placedNotes.map(f=>[f.row,f.startColumnIndex,f.endColumnIndex,f.color,f.shape,f.tonicNumber||"",f.isDrum,f.drumTrack||""].join(",")).join(`
`)}async function u(){const f=d(),p=new Blob([f],{type:"text/csv;charset=utf-8;"});window.showSaveFilePicker?await r(p):c(p)}function h(){const f=document.createElement("input");f.type="file",f.accept=".csv,.txt",f.onchange=p=>{const w=p.target.files?.[0];if(!w)return;const y=new FileReader;y.onload=C=>{const P=C.target?.result;if(!P){b.warn("FileActionsBridge","Imported file was empty",null,"toolbar");return}const T=new Set(["circle","oval","diamond"]),M=[];if(P.split(`
`).map(A=>A.trim()).filter(A=>A.length>0).forEach(A=>{const x=A.split(",");if(x.length<7){b.warn("FileActionsBridge","Skipping invalid note row",{line:A},"toolbar");return}const k=Number.parseInt(x[0]??"",10),S=Number.parseInt(x[1]??"",10),E=Number.parseInt(x[2]??"",10),I=(x[3]??"").trim(),D=(x[4]??"").trim().toLowerCase(),W=x[5]?Number.parseInt(x[5],10):null,Q=(x[6]??"").trim().toLowerCase()==="true",G=x[7]?Number.parseInt(x[7],10):null,Y=typeof G=="number"&&Number.isFinite(G)?G:void 0;if(!I){b.warn("FileActionsBridge","Skipping note with missing color",{line:A},"toolbar");return}if(!Number.isFinite(k)||!Number.isFinite(S)||!Number.isFinite(E)){b.warn("FileActionsBridge","Skipping note with invalid coordinates",{line:A},"toolbar");return}const O=T.has(D)?D:"circle";T.has(D)||b.warn("FileActionsBridge",`Unknown shape "${D}", defaulting to circle`,null,"toolbar"),M.push({row:k,startColumnIndex:S,endColumnIndex:E,color:I,shape:O,tonicNumber:W,isDrum:Q,drumTrack:Y})}),M.length===0){b.warn("FileActionsBridge","No valid notes found in imported file",null,"toolbar");return}l.loadNotes(M)},y.readAsText(w)},f.click()}function m(){document.body.classList.remove("sidebar-open"),l.emit("printPreviewStateChanged",!0)}function g(){window.confirm("Are you sure you want to reset the canvas? This will clear all your work and cannot be undone.")&&l.clearSavedState()}Re(()=>{e=document.getElementById("save-as-button"),o=document.getElementById("import-button"),i=document.getElementById("print-button"),s=document.getElementById("reset-canvas-button"),e?.addEventListener("click",()=>{u()}),o?.addEventListener("click",h),i?.addEventListener("click",m),s?.addEventListener("click",g),console.log("[Svelte] FileActionsBridge mounted")}),Ge(()=>{e?.removeEventListener("click",()=>{u()}),o?.removeEventListener("click",h),i?.removeEventListener("click",m),s?.removeEventListener("click",g),console.log("[Svelte] FileActionsBridge unmounted")}),Ve(),Ot()}function im(n,t){Wt(t,!1);let e=null,o=null,i=null,s=null;function a(){const h=document.querySelector('.tab-button[data-tab="pitch"]'),m=document.querySelector('.pitch-tab-button[data-pitch-tab="range"]');h?.click(),m?.click()}function r(){a(),l.emit("zoomIn",{source:"button"}),e?.blur()}function c(){a(),l.emit("zoomOut",{source:"button"}),o?.blur()}function d(){l.increaseMacrobeatCount()}function u(){l.decreaseMacrobeatCount()}Re(()=>{e=document.getElementById("grid-zoom-in"),o=document.getElementById("grid-zoom-out"),i=document.getElementById("macrobeat-increase"),s=document.getElementById("macrobeat-decrease"),e?.addEventListener("click",r),o?.addEventListener("click",c),i?.addEventListener("click",d),s?.addEventListener("click",u),console.log("[Svelte] GridControlsBridge mounted")}),Ge(()=>{e?.removeEventListener("click",r),o?.removeEventListener("click",c),i?.removeEventListener("click",d),s?.removeEventListener("click",u),console.log("[Svelte] GridControlsBridge unmounted")}),Ve(),Ot()}var Jt=bc(()=>l);function sm(n,t){Wt(t,!1);let e=null,o=null,i=null,s=null;function a(){s===ne.COMPRESSION_2_3?(s=null,e?.classList.remove("active"),Jt().setSelectedTool("note"),b.info("ModulationBridge","2:3 modulation tool deactivated",null,"ui")):(s=ne.COMPRESSION_2_3,e?.classList.add("active"),o?.classList.remove("active"),Jt().setSelectedTool("modulation"),Jt(Jt().state.selectedModulationRatio=s),b.info("ModulationBridge","2:3 modulation tool activated",null,"ui"))}function r(){s===ne.EXPANSION_3_2?(s=null,o?.classList.remove("active"),Jt().setSelectedTool("note"),b.info("ModulationBridge","3:2 modulation tool deactivated",null,"ui")):(s=ne.EXPANSION_3_2,o?.classList.add("active"),e?.classList.remove("active"),Jt().setSelectedTool("modulation"),Jt(Jt().state.selectedModulationRatio=s),b.info("ModulationBridge","3:2 modulation tool activated",null,"ui"))}function c(){const m=(Jt().state.tempoModulationMarkers||[]).length;if(m===0){b.info("ModulationBridge","No modulation markers to clear",null,"ui");return}Jt().clearModulationMarkers(),b.info("ModulationBridge",`Cleared ${m} modulation markers`,null,"ui")}function d(){if(!i)return;const m=(Jt().state.tempoModulationMarkers||[]).length;m===0?(i.disabled=!0,i.style.opacity="0.5"):(i.disabled=!1,i.style.opacity="1"),i.textContent=m>0?`Clear (${m})`:"Clear"}function u(m){const g=m;(typeof g=="string"?g:g.newTool||g)!=="modulation"&&(s=null,e?.classList.remove("active"),o?.classList.remove("active"))}function h(){d()}Re(()=>{if(e=document.getElementById("modulation-2-3-btn"),o=document.getElementById("modulation-3-2-btn"),i=document.getElementById("modulation-clear-btn"),!e||!o||!i){b.warn("ModulationBridge","Modulation control buttons not found in DOM",null,"ui");return}e.addEventListener("click",a),o.addEventListener("click",r),i.addEventListener("click",c),Jt().on("toolChanged",u),Jt().on("tempoModulationMarkersChanged",h),d(),b.info("ModulationBridge","Modulation controls initialized",null,"ui"),console.log("[Svelte] ModulationBridge mounted")}),Ge(()=>{e?.removeEventListener("click",a),o?.removeEventListener("click",r),i?.removeEventListener("click",c),console.log("[Svelte] ModulationBridge unmounted")}),Ve(),Ot()}function am(n,t){const e=n.endMicrobeatCol<t.startMicrobeatCol,o=t.endMicrobeatCol<n.startMicrobeatCol;return!e&&!o}function rm(n,t){const e=Math.max(n.startMicrobeatCol,t.startMicrobeatCol),o=Math.min(n.endMicrobeatCol,t.endMicrobeatCol);if(e>o)return[];const i=[];for(let s=e;s<=o;s++)i.push(s);return i}function lm(n){const t=[],e=n.notes;for(let o=0;o<e.length;o++)for(let i=o+1;i<e.length;i++){const s=e[o],a=e[i];if(am(s,a)){const r=rm(s,a);t.push({voiceId:n.voiceId,color:n.color,conflictColumns:r,note1:{startMicrobeatCol:s.startMicrobeatCol,endMicrobeatCol:s.endMicrobeatCol,midiPitch:s.midiPitch},note2:{startMicrobeatCol:a.startMicrobeatCol,endMicrobeatCol:a.endMicrobeatCol,midiPitch:a.midiPitch}})}}return t}function cm(n){const t=`Note 1: cols ${n.note1.startMicrobeatCol}-${n.note1.endMicrobeatCol}, MIDI ${n.note1.midiPitch}`,e=`Note 2: cols ${n.note2.startMicrobeatCol}-${n.note2.endMicrobeatCol}, MIDI ${n.note2.midiPitch}`,o=n.conflictColumns.length===1?`column ${n.conflictColumns[0]}`:`columns ${n.conflictColumns[0]}-${n.conflictColumns[n.conflictColumns.length-1]}`;return`Voice "${n.voiceId}" (${n.color}): Overlap at ${o}
  ${t}
  ${e}`}function dm(n){const t=[],e=[];if(n.schemaVersion!==1&&e.push(`Unsupported schema version: ${n.schemaVersion}. Expected: 1`),n.timeGrid||e.push("Missing required field: timeGrid"),(!n.voices||!Array.isArray(n.voices))&&e.push("Missing or invalid field: voices"),n.clefPitchRange){const{minMidi:o,maxMidi:i}=n.clefPitchRange;!Number.isFinite(o)||!Number.isFinite(i)?e.push("Invalid clefPitchRange: MIDI values must be finite numbers"):o>i&&e.push("Invalid clefPitchRange: minMidi exceeds maxMidi")}if(n.voices)for(const o of n.voices){const i=lm(o);t.push(...i)}for(const o of t)e.push(cm(o));return{isValid:t.length===0&&e.length===0,conflicts:t,errorMessages:e}}function um(n){const t=dm(n);if(t.isValid)return{isValid:!0,summary:"Validation passed. Ready to export to Singing Trainer.",details:t};const e=new Set(t.conflicts.map(i=>i.voiceId));return{isValid:!1,summary:`Cannot export: ${t.conflicts.length} overlap(s) found in ${e.size} voice(s).`,details:t}}function hm(n){return n.reduce((t,e)=>t+e,0)}function fm(n){if(n.length===0)return 2;const t=n.filter(o=>o===2).length;return n.filter(o=>o===3).length>t?3:2}function mm(n,t,e){const o=e.topIndex+n;return o<0||o>=t.length?-1:t[o]?.midi??-1}function pm(n,t,e){const o=e.topIndex+n;return o<0||o>=t.length?"Unknown":t[o]?.toneNote??"Unknown"}function gm(n,t){const e=n[t.topIndex],o=n[t.bottomIndex],i=e?.midi,s=o?.midi;return typeof i!="number"||typeof s!="number"?null:{minMidi:Math.min(i,s),maxMidi:Math.max(i,s)}}function vm(n,t,e={}){const o=n.placedNotes.filter(m=>!m.isDrum),i=new Map;for(const m of o){const g=m.color;i.has(g)||i.set(g,[]),i.get(g).push(m)}const s=[];let a=1/0,r=-1/0;for(const[m,g]of i){const f=[];for(const p of g){const v=mm(p.row,n.fullRowData,n.pitchRange),w=pm(p.row,n.fullRowData,n.pitchRange);v>0&&(a=Math.min(a,v),r=Math.max(r,v)),f.push({startMicrobeatCol:p.startColumnIndex,endMicrobeatCol:p.endColumnIndex,midiPitch:v,pitchName:w,shape:p.shape})}f.sort((p,v)=>p.startMicrobeatCol-v.startMicrobeatCol),s.push({voiceId:m,color:m,notes:f})}const c={microbeatCount:hm(n.macrobeatGroupings),microbeatsPerMacrobeat:fm(n.macrobeatGroupings),macrobeatGroupings:[...n.macrobeatGroupings],macrobeatBoundaryStyles:[...n.macrobeatBoundaryStyles]},d=[];if(n.annotations&&Array.isArray(n.annotations))for(const m of n.annotations)d.push({type:"freehand",id:m.id??`overlay-${Date.now()}`,data:m,coordinateSystem:"pixel"});const u=e.includeClefPitchRange===!1?null:gm(n.fullRowData,n.pitchRange),h={schemaVersion:Xl,createdAt:Date.now(),sourceFileId:t,sourceApp:"student-notation",timeGrid:c,voices:s,tempo:n.tempo,minMidiPitch:a===1/0?void 0:a,maxMidiPitch:r===-1/0?void 0:r};return u&&(h.clefPitchRange=u),e.preferredPitchRangeSource&&(h.preferredPitchRangeSource=e.preferredPitchRangeSource),d.length>0&&(h.visualOverlays=d),e.tonalCenter&&(h.tonalCenter=e.tonalCenter),h}function bm(n,t){Wt(t,!1);let e=null,o=null,i=null,s=null,a=null,r=null,c=null,d=null,u=null,h=null,m=null,g=null,f=null,p=null,v=null,w=null,y=null,C=null,P=null,T=null,M=null,A=null,x=!0,k=!0,S=!0,E=!0;const I="app.volumeSliderValue";function D(_){return Math.min(100,Math.max(0,_))}function W(){try{const _=window.localStorage.getItem(I);if(_!==null){const it=Number(_);if(!Number.isNaN(it))return D(it)}}catch{}return 70}function Q(_){try{window.localStorage.setItem(I,String(D(_)))}catch{}}function G(){document.body.classList.toggle("sidebar-open")}function Y(_){if(_.stopPropagation(),!a||!s)return;const it=a.classList.toggle("visible");s.classList.toggle("active",it)}function O(){const _=parseInt(this.value,10),it=_===0?-1/0:_/100*37.5-50;l.emit("volumeChanged",it),Q(_)}function j(_){!a||!s||!a.contains(_.target)&&_.target!==s&&(a.classList.remove("visible"),s.classList.remove("active"))}function at(){l.setAnacrusis(!0)}function ft(){l.setAnacrusis(!1)}function gt(_){const it=_;c?.classList.toggle("active",it),d?.classList.toggle("active",!it)}function nt(){l.setLongNoteStyle("style1")}function L(){l.setLongNoteStyle("style2")}function z(_){const it=_;u?.classList.toggle("active",it==="style1"),h?.classList.toggle("active",it==="style2")}function U(){l.setPlayheadMode("cursor")}function B(){l.setPlayheadMode("microbeat")}function F(){l.setPlayheadMode("macrobeat")}function Z(_){const it=_==="macrobeat"?"macrobeat":_==="microbeat"?"microbeat":"cursor";m?.classList.toggle("active",it==="cursor"),g?.classList.toggle("active",it==="microbeat"),f?.classList.toggle("active",it==="macrobeat")}function N(){x=!x,v&&(v.style.display=x?"flex":"none");const _=p?.querySelector(".sidebar-button-text");_&&(_.textContent=x?"Hide Drum Grid":"Show Drum Grid"),setTimeout(()=>jt.recalculateLayout(),10)}function H(){k=!k,y&&(y.style.display=k?"flex":"none");const _=w?.querySelector(".sidebar-button-text");_&&(_.textContent=k?"Hide Button Grid":"Show Button Grid"),setTimeout(()=>jt.recalculateLayout(),10)}function R(){S=!S,P&&(P.style.display=S?"block":"none"),C&&(C.textContent=S?"Hide Left Legend":"Show Left Legend"),setTimeout(()=>jt.recalculateLayout(),10)}function $(){E=!E,M&&(M.style.display=E?"block":"none"),T&&(T.textContent=E?"Hide Right Legend":"Show Right Legend"),setTimeout(()=>jt.recalculateLayout(),10)}function q(_,it,et=[]){const ot=document.getElementById("notification-overlay"),ht=ot?.querySelector(".notification-message"),dt=ot?.querySelector(".notification-title");if(!ot||!ht){alert(`${_}

${it}${et.length>0?`

`+et.join(`
`):""}`);return}dt&&(dt.textContent=_);const bt=et.length>0?`<ul style="text-align: left; margin-top: 8px; padding-left: 20px;">${et.map(ct=>`<li style="margin-bottom: 4px;">${ct.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</li>`).join("")}</ul>`:"";ht.innerHTML=`<p>${it.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</p>${bt}`,ot.classList.add("visible");const ut=ot.querySelector(".notification-close"),K=ot.querySelector(".notification-button"),st=()=>{ot.classList.remove("visible"),ut?.removeEventListener("click",st),K?.removeEventListener("click",st)};ut?.addEventListener("click",st),K?.addEventListener("click",st)}function X(){return l.state.placedNotes.some(_=>!_.isDrum)}async function tt(){if(console.log("[Svelte] Take to Singing Trainer clicked"),!X()){q("Cannot Export","No notes to export. Add some pitch notes to the grid before exporting to Singing Trainer.");return}const _={placedNotes:l.state.placedNotes,macrobeatGroupings:l.state.macrobeatGroupings,macrobeatBoundaryStyles:l.state.macrobeatBoundaryStyles,fullRowData:l.state.fullRowData,pitchRange:l.state.pitchRange,tempo:l.state.tempo,annotations:l.state.annotations},it=vm(_),et=um(it);if(!et.isValid){console.warn("[Svelte] Handoff validation failed",et.details);const ot=[];for(const ht of et.details.conflicts){const dt=ht.conflictColumns.length===1?`column ${ht.conflictColumns[0]}`:`columns ${ht.conflictColumns[0]}-${ht.conflictColumns[ht.conflictColumns.length-1]}`;ot.push(`Voice "${ht.color}": Overlap at ${dt}`)}q("Cannot Export to Singing Trainer",et.summary,ot);return}try{const ot=await Yl(it);console.log("[Svelte] Handoff slot written",ot),Ql(ot)}catch(ot){console.error("[Svelte] Failed to write handoff slot",ot),q("Export Failed","An error occurred while preparing the handoff. Please try again.")}}Re(()=>{if(e=document.getElementById("settings-button"),o=document.getElementById("sidebar"),i=document.getElementById("sidebar-overlay"),s=document.getElementById("volume-icon-button"),a=document.getElementById("volume-popup"),r=document.getElementById("vertical-volume-slider"),c=document.getElementById("anacrusis-on-btn"),d=document.getElementById("anacrusis-off-btn"),u=document.getElementById("long-note-style1-btn"),h=document.getElementById("long-note-style2-btn"),m=document.getElementById("playhead-mode-cursor-btn"),g=document.getElementById("playhead-mode-microbeat-btn"),f=document.getElementById("playhead-mode-macrobeat-btn"),p=document.getElementById("hide-drumgrid-toggle"),v=document.getElementById("drum-grid-wrapper"),w=document.getElementById("hide-buttongrid-toggle"),y=document.getElementById("button-grid"),C=document.getElementById("hide-leftlegend-toggle"),P=document.getElementById("legend-left-canvas"),T=document.getElementById("hide-rightlegend-toggle"),M=document.getElementById("legend-right-canvas"),A=document.getElementById("take-to-singing-trainer-button"),e&&o&&i&&(e.addEventListener("click",G),i.addEventListener("click",G)),s&&a&&r){const _=W();r.value=String(_),s.addEventListener("click",Y),r.addEventListener("input",O),document.addEventListener("click",j),r.dispatchEvent(new Event("input"))}if(c&&d&&(c.addEventListener("click",at),d.addEventListener("click",ft),l.on("anacrusisChanged",gt),c.classList.toggle("active",l.state.hasAnacrusis),d.classList.toggle("active",!l.state.hasAnacrusis)),u&&h){u.addEventListener("click",nt),h.addEventListener("click",L),l.on("longNoteStyleChanged",z);const _=l.state.longNoteStyle||"style1";u.classList.toggle("active",_==="style1"),h.classList.toggle("active",_==="style2")}if(m&&g&&f){m.addEventListener("click",U),g.addEventListener("click",B),f.addEventListener("click",F),l.on("playheadModeChanged",Z);const _=l.state.playheadMode||"cursor";m.classList.toggle("active",_==="cursor"),g.classList.toggle("active",_==="microbeat"),f.classList.toggle("active",_==="macrobeat")}p&&v&&p.addEventListener("click",N),w&&y&&w.addEventListener("click",H),C&&P&&C.addEventListener("click",R),T&&M&&T.addEventListener("click",$),A&&A.addEventListener("click",()=>{tt()}),console.log("[Svelte] SidebarBridge mounted")}),Ge(()=>{e?.removeEventListener("click",G),i?.removeEventListener("click",G),s?.removeEventListener("click",Y),r?.removeEventListener("input",O),document.removeEventListener("click",j),c?.removeEventListener("click",at),d?.removeEventListener("click",ft),u?.removeEventListener("click",nt),h?.removeEventListener("click",L),m?.removeEventListener("click",U),g?.removeEventListener("click",B),f?.removeEventListener("click",F),p?.removeEventListener("click",N),w?.removeEventListener("click",H),C?.removeEventListener("click",R),T?.removeEventListener("click",$),console.log("[Svelte] SidebarBridge unmounted")}),Ve(),Ot()}const hi={selectedSixteenthStampId:1,updateSixteenthStampColors:n=>{},init(){this.render(),this.bindEvents(),b.info("SixteenthStampsToolbar","Sixteenth stamps toolbar initialized",null,"stamps")},render(){const n=document.getElementById("sixteenth-stamps-toolbar-container");if(!n){b.warn("SixteenthStampsToolbar","Container not found",null,"stamps");return}n.innerHTML="";const t=document.createElement("div");t.className="sixteenth-stamps-grid",[[1,2,3,4],[5,8,14,6,9,7],[10,13,12,11,15]].forEach((o,i)=>{const s=document.createElement("div");s.className=`sixteenth-stamps-row sixteenth-stamps-row-${i+1}`,o.forEach(a=>{const r=es.find(c=>c.id===a);if(r){const c=this.createSixteenthStampButton(r);s.appendChild(c)}}),t.appendChild(s)}),n.appendChild(t),this.setInitialSelection(this.selectedSixteenthStampId)},createSixteenthStampButton(n){const t=document.createElement("button");t.className="sixteenth-stamp-button",t.dataset.sixteenthStampId=`${n.id}`,t.setAttribute("title",`${n.id}: ${n.label}`);const e=this.createSixteenthStampPreview(n);return t.appendChild(e),t},createSixteenthStampPreview(n){const t=Ts.renderToSVG(n,100,100);return t.setAttribute("width","40"),t.setAttribute("height","40"),t},bindEvents(){const n=document.getElementById("sixteenth-stamps-toolbar-container");if(!n)return;n.addEventListener("click",e=>{const o=e.target?.closest(".sixteenth-stamp-button");if(o){const i=parseInt(o.dataset.sixteenthStampId||"",10);Number.isNaN(i)||this.selectSixteenthStamp(i)}}),this.updateSixteenthStampColors=e=>{if(!e||!n)return;const o=(d,u=50)=>{const h=parseInt(d.slice(1,3),16),m=parseInt(d.slice(3,5),16),g=parseInt(d.slice(5,7),16),f=Math.min(255,Math.floor(h+(255-h)*(u/100))),p=Math.min(255,Math.floor(m+(255-m)*(u/100))),v=Math.min(255,Math.floor(g+(255-g)*(u/100)));return`#${f.toString(16).padStart(2,"0")}${p.toString(16).padStart(2,"0")}${v.toString(16).padStart(2,"0")}`},i=(d,u=20)=>{const h=parseInt(d.slice(1,3),16),m=parseInt(d.slice(3,5),16),g=parseInt(d.slice(5,7),16),f=Math.max(0,Math.floor(h*(1-u/100))),p=Math.max(0,Math.floor(m*(1-u/100))),v=Math.max(0,Math.floor(g*(1-u/100)));return`#${f.toString(16).padStart(2,"0")}${p.toString(16).padStart(2,"0")}${v.toString(16).padStart(2,"0")}`},s=l.state.colorPalette[e]||{primary:e,light:e},a=o(s.light,60),r=s.primary,c=i(r,20);n.style.setProperty("--c-accent",r),n.style.setProperty("--c-accent-light",a),n.style.setProperty("--c-accent-hover",c)},l.on("noteChanged",({newNote:e}={})=>{e?.color&&this.updateSixteenthStampColors(e.color)});const t=l.state.selectedNote;t?.color&&this.updateSixteenthStampColors(t.color),l.on("toolChanged",({newTool:e}={})=>{e&&e!=="sixteenthStamp"&&this.clearSelection()}),l.on("tripletStampToolSelected",()=>{this.clearSelection()})},setInitialSelection(n){this.selectedSixteenthStampId=n;const t=document.getElementById("sixteenth-stamps-toolbar-container");t&&t.querySelectorAll(".sixteenth-stamp-button").forEach(e=>{const o=e;o.classList.toggle("active",parseInt(o.dataset.sixteenthStampId||"",10)===n)})},selectSixteenthStamp(n){this.selectedSixteenthStampId=n;const t=document.getElementById("sixteenth-stamps-toolbar-container");t&&t.querySelectorAll(".sixteenth-stamp-button").forEach(e=>{const o=e;o.classList.toggle("active",parseInt(o.dataset.sixteenthStampId||"",10)===n)}),l.setSelectedTool("sixteenthStamp"),l.emit("sixteenthStampSelected",n),l.emit("sixteenthStampToolSelected")},clearSelection(){const n=document.getElementById("sixteenth-stamps-toolbar-container");n&&n.querySelectorAll(".sixteenth-stamp-button").forEach(t=>{t.classList.remove("active")})},getSelectedSixteenthStamp(){return es.find(t=>t.id===this.selectedSixteenthStampId)}};class wm{overlay;modal;title;message;actionsContainer;closeButton;constructor(){this.overlay=document.getElementById("notification-overlay"),this.modal=this.overlay?.querySelector(".notification-modal"),this.title=this.overlay?.querySelector(".notification-title"),this.message=this.overlay?.querySelector(".notification-message"),this.actionsContainer=this.overlay?.querySelector(".notification-actions"),this.closeButton=this.overlay?.querySelector(".notification-close"),this.setupEventListeners()}setupEventListeners(){this.overlay&&(this.closeButton?.addEventListener("click",()=>this.hide()),this.overlay.addEventListener("click",t=>{t.target===this.overlay&&this.hide()}),document.addEventListener("keydown",t=>{t.key==="Escape"&&this.overlay?.classList.contains("visible")&&this.hide()}))}show(t={}){const e=this.overlay;if(!e)return;const{title:o="Notice",message:i="",buttons:s=[{text:"OK",primary:!0,action:()=>this.hide()}]}=t;this.title&&(this.title.textContent=o),this.message&&(this.message.textContent=i);const a=this.actionsContainer;a&&(a.innerHTML="",s.forEach(r=>{const c=document.createElement("button");c.className=`notification-button ${r.primary?"":"secondary"}`,c.textContent=r.text,c.addEventListener("click",()=>{r.action?r.action():this.hide()}),a.appendChild(c)})),e.classList.add("visible"),setTimeout(()=>{this.actionsContainer?.querySelector(".notification-button")?.focus()},100)}hide(){this.overlay&&this.overlay.classList.remove("visible")}alert(t,e="Notice"){this.show({title:e,message:t,buttons:[{text:"OK",primary:!0,action:()=>this.hide()}]})}confirm(t,e="Confirm"){return new Promise(o=>{this.show({title:e,message:t,buttons:[{text:"Cancel",primary:!1,action:()=>{this.hide(),o(!1)}},{text:"OK",primary:!0,action:()=>{this.hide(),o(!0)}}]})})}}const Fa=new wm,hs=40,ym=hs;class Wa{element;viewportEl;optionsEl;onChange;onBeforeChange;options;optionNodes=[];selectedIndex=0;pointerActive=!1;pointerId=null;lastPointerY=0;deltaBuffer=0;optionHeight=hs;resizeObserver=null;constructor(t,e,o,i,s){this.element=t,this.viewportEl=t?.querySelector(".clef-wheel-viewport"),this.optionsEl=t?.querySelector(".clef-wheel-options"),this.onChange=i,this.onBeforeChange=s||null,this.options=e,!(!t||!this.viewportEl||!this.optionsEl)&&(this.renderOptions(),this.setIndex(o,{silent:!0}),this.attachEvents(),this.observeSize())}renderOptions(){const t=this.optionsEl;t&&(t.innerHTML="",this.optionNodes=this.options.map((e,o)=>{const i=document.createElement("div");return i.className="clef-wheel-option",i.dataset.index=o.toString(),i.textContent=e.label,t.appendChild(i),i}))}attachEvents(){if(!this.element)return;this.element.addEventListener("wheel",e=>{e.preventDefault(),e.stopPropagation();const o=Math.sign(e.deltaY);o!==0&&this.increment(o)},{passive:!1}),this.element.addEventListener("keydown",e=>{e.key==="ArrowUp"?(e.preventDefault(),this.increment(-1)):e.key==="ArrowDown"?(e.preventDefault(),this.increment(1)):e.key==="Home"?(e.preventDefault(),this.setIndex(0)):e.key==="End"&&(e.preventDefault(),this.setIndex(this.options.length-1))}),this.element.addEventListener("pointerdown",e=>{if(this.pointerActive=!0,this.pointerId=e.pointerId,this.lastPointerY=e.clientY,this.deltaBuffer=0,typeof this.element?.setPointerCapture=="function")try{this.element.setPointerCapture(this.pointerId)}catch{}}),this.element.addEventListener("pointermove",e=>{if(!this.pointerActive||e.pointerId!==this.pointerId)return;const o=e.clientY-this.lastPointerY;if(this.lastPointerY=e.clientY,o===0)return;this.deltaBuffer+=o;const i=this.optionHeight||ym;for(;Math.abs(this.deltaBuffer)>=i;){const s=-Math.sign(this.deltaBuffer);this.increment(s),this.deltaBuffer-=Math.sign(this.deltaBuffer)*i}});const t=e=>{this.pointerActive&&e.pointerId===this.pointerId&&(this.pointerActive=!1,this.pointerId=null,this.deltaBuffer=0,this.element?.hasPointerCapture?.(e.pointerId)&&this.element.releasePointerCapture(e.pointerId))};this.element.addEventListener("pointerup",t),this.element.addEventListener("pointercancel",t),this.element.addEventListener("pointerleave",t)}observeSize(){this.element&&(typeof ResizeObserver=="function"?(this.resizeObserver=new ResizeObserver(t=>{for(const e of t)e.target===this.element&&e.contentRect.height>0&&this.updateVisuals()}),this.resizeObserver.observe(this.element)):window.addEventListener("resize",()=>this.updateVisuals()))}getIndex(){return this.selectedIndex}increment(t){t===0||!this.options||this.options.length===0||this.setIndex(this.selectedIndex+t)}setIndex(t,{silent:e=!1}={}){if(!this.optionsEl)return;let o=t;!e&&typeof this.onBeforeChange=="function"&&(o=this.onBeforeChange(t));const i=Math.max(0,Math.min(this.options.length-1,o));if(i===this.selectedIndex){this.updateVisuals();return}if(this.selectedIndex=i,this.updateVisuals(),!e&&typeof this.onChange=="function"){const s=this.options[i];s&&this.onChange(i,s)}}updateVisuals(){if(!this.optionsEl||!this.viewportEl)return;const t=this.viewportEl.clientHeight||0,e=this.optionNodes?.[this.selectedIndex],o=this.optionNodes?.[0],i=e?.offsetHeight||o?.offsetHeight||hs;if(this.optionHeight=i,this.optionNodes?.forEach((c,d)=>{const u=Math.abs(d-this.selectedIndex);c.dataset.distance=String(Math.min(u,3))}),t===0||i===0)return;const s=Math.max(0,(t-i)/2);this.optionsEl.style.paddingTop=`${s}px`,this.optionsEl.style.paddingBottom=`${s}px`;const a=e?e.offsetTop+i/2:s+i/2,r=t/2-a;this.optionsEl.style.transform=`translateY(${r}px)`}}class Sm{initialized=!1;topPicker=null;bottomPicker=null;topWheel=null;bottomWheel=null;rangeLabel=null;rangeCount=null;fullRangeButton=null;trebleButton=null;altoButton=null;bassButton=null;voice1Button=null;voice2Button=null;voice3Button=null;presetContainer=null;presetButtons=[];activePresetId=null;masterOptions=[];presetRanges={};init(){if(this.initialized)return;if(this.topWheel=document.getElementById("clef-top-wheel"),this.bottomWheel=document.getElementById("clef-bottom-wheel"),this.rangeLabel=document.getElementById("clef-range-label"),this.rangeCount=document.getElementById("clef-range-count"),this.fullRangeButton=document.getElementById("clef-full-range-button"),this.trebleButton=document.getElementById("clef-treble-button"),this.altoButton=document.getElementById("clef-alto-button"),this.bassButton=document.getElementById("clef-bass-button"),this.voice1Button=document.getElementById("clef-voice1-button"),this.voice2Button=document.getElementById("clef-voice2-button"),this.voice3Button=document.getElementById("clef-voice3-button"),this.presetContainer=document.querySelector(".clef-preset-buttons"),this.presetButtons=Array.from(document.querySelectorAll(".clef-preset-button")),!this.topWheel||!this.bottomWheel){b.warn("ClefViewportController","Clef tab elements not found; skipping initialization",null,"ui");return}this.masterOptions=Me.map((e,o)=>({index:o,label:e.pitch,toneNote:e.toneNote,frequency:e.frequency}));const t=this.getViewportRange();this.topPicker=new Wa(this.topWheel,this.masterOptions,t.topIndex,e=>this.handleTopSelection(e),e=>this.constrainTopIndex(e)),this.bottomPicker=new Wa(this.bottomWheel,this.masterOptions,t.bottomIndex,e=>this.handleBottomSelection(e),e=>this.constrainBottomIndex(e)),this.computePresetRanges(),this.fullRangeButton&&this.fullRangeButton.addEventListener("click",()=>this.applyPresetView("full")),this.trebleButton&&this.trebleButton.addEventListener("click",()=>this.applyPresetView("treble")),this.altoButton&&this.altoButton.addEventListener("click",()=>this.applyPresetView("alto")),this.bassButton&&this.bassButton.addEventListener("click",()=>this.applyPresetView("bass")),this.voice1Button&&this.voice1Button.addEventListener("click",()=>this.applyPresetView("voice1")),this.voice2Button&&this.voice2Button.addEventListener("click",()=>this.applyPresetView("voice2")),this.voice3Button&&this.voice3Button.addEventListener("click",()=>this.applyPresetView("voice3")),l.on("pitchRangeChanged",()=>{this.syncFromViewport()}),l.on("zoomChanged",()=>{this.syncFromViewport()}),this.calculateAndSetWheelHeight(),window.addEventListener("resize",()=>this.calculateAndSetWheelHeight()),this.syncFromViewport(),this.initialized=!0,b.moduleLoaded("ClefViewportController","ui")}refreshWheelVisuals(){this.topPicker?.updateVisuals(),this.bottomPicker?.updateVisuals()}getViewportRange(){const t=Math.max(0,this.masterOptions.length-1),e=Ht.getViewportInfo(),o=e?.startRank??l.state.pitchRange?.topIndex??0,i=e?.endRank??o+1,s=Math.max(0,Math.min(t,o)),a=Math.max(s,Math.min(t,i-1));return{topIndex:s,bottomIndex:a}}syncFromViewport(){if(!this.topPicker||!this.bottomPicker)return;const{topIndex:t,bottomIndex:e}=this.getViewportRange();this.topPicker.setIndex(t,{silent:!0}),this.bottomPicker.setIndex(e,{silent:!0}),this.updateSummary(t,e),this.updatePresetHighlight(t,e)}constrainTopIndex=t=>{if(!this.bottomPicker)return t;const e=this.bottomPicker.getIndex(),o=this.masterOptions.length;return jl(e,t,o,_t)};constrainBottomIndex=t=>{if(!this.topPicker)return t;const e=this.topPicker.getIndex(),o=this.masterOptions.length;return Zl(e,t,o,_t)};handleTopSelection(t){b.debug("ClefViewportController","handleTopSelection called",{newTopIndex:t},"ui"),Ht.setViewportTopIndex(t)}handleBottomSelection(t){b.debug("ClefViewportController","handleBottomSelection called",{newBottomIndex:t},"ui"),Ht.setViewportBottomIndex(t)}updateSummary(t,e){const o=this.masterOptions[t],i=this.masterOptions[e],s=e-t+1;this.rangeLabel&&o&&i&&(this.rangeLabel.textContent=`${o.label}  ${i.label}`),this.rangeCount&&(this.rangeCount.textContent=`${s} ${s===1?"pitch":"pitches"}`)}computePresetRanges(){const t=(e,o)=>{const i=this.findToneNoteIndex(e),s=this.findToneNoteIndex(o);return i===-1||s===-1?null:{topIndex:Math.min(i,s),bottomIndex:Math.max(i,s)}};this.presetRanges={full:{topIndex:0,bottomIndex:Math.max(0,this.masterOptions.length-1)},treble:t("G5","C4"),alto:t("A4","D3"),bass:t("C4","F2"),voice1:t("A5","A3"),voice2:t("C5","C3"),voice3:t("E4","E2")}}updatePresetHighlight(t,e){let o=null;Object.entries(this.presetRanges).forEach(([i,s])=>{s&&s.topIndex===t&&s.bottomIndex===e&&(o=i)}),this.activePresetId=o,this.presetButtons?.length&&(this.presetButtons.forEach(i=>{const s=i.dataset?.preset?i.dataset.preset??"":(i.id||"").replace(/^clef-/,"").replace(/-button$/,"").replace(/-range$/,"").replace(/-/g,""),a=this.activePresetId&&s===this.activePresetId;i.classList.toggle("active",!!a)}),this.presetContainer&&this.presetContainer.classList.toggle("locked",!1))}applyPresetView(t){const e=this.presetRanges[t];if(!e){b.warn("ClefViewportController","Preset range could not be resolved",{preset:t},"ui");return}const o=t==="full"?420:280;Ht.setPitchViewportRange(e,{animateMs:o,source:`preset:${t}`})}findNoteIndex(t){return this.masterOptions.findIndex(e=>e.label===t)}findToneNoteIndex(t){return this.masterOptions.findIndex(e=>e.toneNote===t)}calculateAndSetWheelHeight(){const t=document.querySelector(".range-panel-section.wheels-section"),e=t?.querySelector(".panel-section-title");if(!t||!this.topWheel||!this.bottomWheel)return;const o=t.clientHeight,i=e?.offsetHeight||0,a=o-i-15,r=Math.max(120,Math.min(a,300));this.topWheel.style.setProperty("--clef-wheel-height",`${r}px`),this.bottomWheel.style.setProperty("--clef-wheel-height",`${r}px`),setTimeout(()=>{this.topPicker?.updateVisuals(),this.bottomPicker?.updateVisuals()},0)}}const Oa=new Sm,Cm={X:["1P","3M","5P"],x:["1P","3m","5P"],"x":["1P","3m","5d"],"X+":["1P","3M","5A"],"X":["1P","3M","5P","7m"],"x":["1P","3m","5P","7m"],"Xmaj":["1P","3M","5P","7M"],"":["1P","3m","5d","7m"],"x":["1P","3m","5d","6M"],"X":["1P","3M","5P","6M"],Xsus2:["1P","2M","5P"],Xsus4:["1P","4P","5P"]},Am={"xmaj":["1P","3m","5P","7M"],Xadd9:["1P","3M","5P","9M"],xadd9:["1P","3m","5P","9M"],"X6/9":["1P","3M","5P","6M","9M"],X9:["1P","3M","5P","7m","9M"],X11:["1P","3M","5P","7m","9M","11P"],X13:["1P","3M","5P","7m","9M","13M"],Xmaj9:["1P","3M","5P","7M","9M"],"x":["1P","3m","5P","7m","9M"],"x":["1P","3m","5P","6M"],"x":["1P","3m","5P","7m","9M","11P"],"Xmaj711":["1P","3M","5P","7M","11A"]},_a={...Cm,...Am},za={M6:["6M"],A6:["6A"],m7:["7m"],M7:["7M"],d5:["5d"],P5:["5P"],A5:["5A"],m6:["6m"],m3:["3m"],M3:["3M"],P4:["4P"],A4:["4A"],U:["1P"],m2:["2m"],M2:["2M"],A2:["2A"]},xm={"9m":"2m","9M":"2M","9A":"2A","11P":"4P","11A":"4A","13m":"6m","13M":"6M","13A":"6A"};function Bi(n){return xm[n]??n}function Mm(n,t){Wt(t,!1);const e=15;let o="diatonic",i="position",s=null,a=null,r=null,c=null,d=null,u=null,h=null,m=null,g=null,f=null,p=null,v=null,w=null,y=null,C=[];function P(){return Object.keys(l.state.tonicSignGroups).length>0}function T(N=l.state.degreeDisplayMode){const H=r?.querySelector('[data-mode="diatonic"]'),R=r?.querySelector('[data-mode="modal"]');if(!H||!R)return;N!=="off"&&(o=N);const $=N==="off"?o:N,q=N==="off";[H,R].forEach(X=>{X.disabled=q,X.classList.toggle("disabled",q)}),r&&r.classList.toggle("disabled",q),H.classList.toggle("active",$==="diatonic"),H.setAttribute("aria-pressed",$==="diatonic"?"true":"false"),R.classList.toggle("active",$==="modal"),R.setAttribute("aria-pressed",$==="modal"?"true":"false")}function M(N,H){if(!H)return;const R=N!=="off";H.classList.toggle("active",R),H.setAttribute("aria-pressed",R?"true":"false")}function A(){if(w&&(w.querySelectorAll(".harmony-preset-button").forEach(N=>{N.classList.remove("selected","partial-match")}),l.state.activeChordIntervals)){const N=l.state.activeChordIntervals,H=N.toString(),R=N.map(Bi),$=w.querySelectorAll(".harmony-preset-button");for(const q of $){const X=q.textContent?.trim()??"",tt=_a[X];if(!tt)continue;const _=tt.toString(),it=tt.map(Bi);if(_===H){q.classList.add("selected");continue}R.every(ot=>it.includes(ot))&&q.classList.add("partial-match")}}}function x(){if(y&&(y.querySelectorAll(".harmony-preset-button").forEach(N=>N.classList.remove("selected")),l.state.activeChordIntervals)){const H=l.state.activeChordIntervals.map(Bi);y.querySelectorAll(".harmony-preset-button").forEach(R=>{const $=R.textContent?.trim()??"",X=za[$]?.[0];X&&H.includes(X)&&R.classList.add("selected")})}}const k=(N,H=50)=>{const R=parseInt(N.slice(1,3),16),$=parseInt(N.slice(3,5),16),q=parseInt(N.slice(5,7),16),X=Math.min(255,Math.floor(R+(255-R)*(H/100))),tt=Math.min(255,Math.floor($+(255-$)*(H/100))),_=Math.min(255,Math.floor(q+(255-q)*(H/100)));return`#${X.toString(16).padStart(2,"0")}${tt.toString(16).padStart(2,"0")}${_.toString(16).padStart(2,"0")}`},S=(N,H=1)=>{const R=N.startsWith("#")?N.slice(1):N;if(R.length!==6)return N;const $=parseInt(R.slice(0,2),16),q=parseInt(R.slice(2,4),16),X=parseInt(R.slice(4,6),16);return`rgba(${$}, ${q}, ${X}, ${H})`},E=(N,H)=>{if(!N)return;const R=k(H,50),$=k(R,60);N.style.setProperty("--c-accent",H),N.style.setProperty("--c-accent-light",$),N.style.setProperty("--harmony-partial-bg",S($,.25)),N.style.setProperty("--harmony-partial-border",S(H,.4)),N.style.setProperty("--harmony-partial-bg-hover",S($,.4)),N.style.setProperty("--harmony-partial-border-hover",S(H,.6))};function I(){return(l.state.activeChordIntervals?.length??0)===2?"inversion":"position"}function D(){const N=l.state.activeChordIntervals?.length??1;return N===2?2:Math.max(1,N)}function W(){return I()==="inversion"?l.state.isIntervalsInverted?1:0:l.state.chordPositionState}function Q(N){I()==="inversion"?l.setIntervalsInversion(N===1):l.setChordPosition(N)}function G(){if(!v)return;const N=I(),H=W(),R=l.state.activeChordIntervals?.length??1;v.classList.toggle("inversion-mode",N==="inversion"),v.classList.toggle("position-mode",N==="position"),v.classList.remove("state-1","state-2","state-3","state-4","state-5"),H>=1&&H<=5&&v.classList.add(`state-${H}`);for(let $=1;$<=5;$++)v.classList.remove(`disabled-state-${$}`);N==="position"&&(R<=1?v.classList.add("disabled-state-1"):R===2?v.classList.add("disabled-state-2"):R===3?v.classList.add("disabled-state-3"):R===4?v.classList.add("disabled-state-4"):R===5&&v.classList.add("disabled-state-5"))}function Y(){const N=I(),H=l.state.activeChordIntervals?.length??1;if(i!==N){if(N==="inversion"){const R=l.state.chordPositionState===0;l.setIntervalsInversion(!R)}else l.setChordPosition(0);i=N}else if(N==="position"){const R=Math.max(0,H-1);l.state.chordPositionState>R&&l.setChordPosition(0)}G()}function O(){Y()}function j(N=l.state.selectedToolTonicNumber){if(!C.length)return;const H=C[0]?parseInt(C[0].dataset.tonic??"1",10):1,R=typeof N=="number"?N:parseInt(String(N??""),10),$=Number.isNaN(R)?H:R;C.forEach(q=>{const X=q.dataset.tonic,_=(X?parseInt(X,10):NaN)===$;q.classList.toggle("selected",_),q.setAttribute("aria-pressed",_?"true":"false")})}function at(){return d?.classList.contains("active")?"modal":c?.classList.contains("active")?"diatonic":o}function ft(){const N=document.querySelector('[data-tab="rhythm"]');N&&!N.classList.contains("active")&&N.click();const H=document.querySelector('[data-rhythm-stamp-tab="sixteenth"]');H&&!H.classList.contains("active")&&H.click()}const gt=N=>{[u,h,g].forEach(H=>{H&&(H.classList.toggle("accidental-btn--disabled",N),H.setAttribute("aria-disabled",N?"true":"false"))})},nt=N=>{N!==void 0&&(m&&(m.classList.toggle("active",N),m.setAttribute("aria-pressed",N?"true":"false")),gt(N))},L=N=>{N!==void 0&&g&&(g.classList.toggle("active",N),g.setAttribute("aria-pressed",N?"true":"false"))};function z({newTool:N}={}){if(s?.classList.remove("selected"),p&&p.classList.remove("active-tool"),N==="eraser")s?.classList.add("selected");else if(N==="chord")p?.classList.add("active-tool");else if(N==="note"){const H=l.state.selectedNote;if(H){const R=document.querySelector(`.note-pair[data-color='${H.color}']`);R?.classList.add("selected"),R?.querySelector(`.note[data-type='${H.shape}']`)?.classList.add("selected")}}j()}function U(){A(),x(),O()}function B({newNote:N}={}){if(!N?.color||!N.shape)return;const{color:H,shape:R}=N;document.querySelectorAll(".note, .note-pair").forEach(X=>X.classList.remove("selected"));const $=document.querySelector(`.note[data-color='${H}'][data-type='${R}']`);if($)$.classList.add("selected");else{const X=document.querySelector(`.note-pair[data-color='${H}']`);X?.classList.add("selected"),X?.querySelector(`.note[data-type='${R}']`)?.classList.add("selected")}E(p,H);const q=document.querySelector(".tab-sidebar");q&&q.style.setProperty("--c-accent",H)}function F(N){N&&(M(N,a),T(N))}function Z(N){N&&(h?.classList.toggle("active",N.sharp),u?.classList.toggle("active",N.flat))}Re(()=>{const N=Ne.getMultiple("noteBankContainer","eraserButton","degreeVisibilityToggle","degreeModeToggle","flatBtn","sharpBtn","frequencyBtn","octaveLabelBtn","focusColoursToggle");s=N.eraserButton,a=N.degreeVisibilityToggle??null,r=N.degreeModeToggle,c=r?.querySelector('[data-mode="diatonic"]')??null,d=r?.querySelector('[data-mode="modal"]')??null,u=N.flatBtn,h=N.sharpBtn,m=N.frequencyBtn,g=N.octaveLabelBtn,f=N.focusColoursToggle,p=document.querySelector(".pitch-tabs-container"),v=document.getElementById("unified-position-toggle"),w=document.querySelector("#chords-panel .chords-grid"),y=document.querySelector("#chords-panel .intervals-4x4-grid"),C=Array.from(document.querySelectorAll(".tonic-mode-button")),Oa.init(),document.querySelectorAll(".note").forEach(K=>{K.addEventListener("click",()=>{const st=K.dataset.type,ct=K.dataset.color||K.closest(".note-pair")?.dataset.color;if(!(!st||!ct)){if(st==="diamond"){l.setSelectedNote("diamond",ct);const At=document.querySelector(".sixteenth-stamp-button.active"),xt=At?parseInt(At.dataset.sixteenthStampId??"",10):NaN;if(l.state.selectedTool==="sixteenthStamp"&&At&&!Number.isNaN(xt)&&xt!==e)return;ft(),hi.selectSixteenthStamp(e);return}l.setSelectedNote(st,ct),l.setSelectedTool("note")}})}),s&&s.addEventListener("click",()=>{if(l.state.selectedTool==="eraser"){l.setSelectedTool(l.state.previousTool||"note");return}l.setSelectedTool("eraser")});const R=document.getElementById("lasso-shortcut-button");R&&R.addEventListener("click",()=>{document.querySelector('[data-tab="pitch"]')?.click(),document.querySelector('[data-pitch-tab="draw"]')?.click(),document.querySelector('button.draw-tool-button[data-draw-tool="lasso"]')?.click()});const $=document.getElementById("marker-shortcut-button");$&&$.addEventListener("click",()=>{document.querySelector('[data-tab="pitch"]')?.click(),document.querySelector('[data-pitch-tab="draw"]')?.click(),document.querySelector('button.draw-tool-button[data-draw-tool="marker"]')?.click()}),C.length&&(C.forEach(K=>{K.addEventListener("click",()=>{const st=K.getAttribute("data-tonic");if(!st)return;const ct=parseInt(st,10);l.setSelectedTool("tonicization",ct),j(ct)})}),j()),w&&w.querySelectorAll(".harmony-preset-button").forEach(K=>{K.addEventListener("click",()=>{const st=K.textContent?.trim()??"",ct=_a[st];ct&&ct.length>0&&(l.setActiveChordIntervals(ct),l.setSelectedTool("chord")),K.blur()}),K.addEventListener("dblclick",()=>{K.classList.contains("selected")&&l.setSelectedTool("note"),K.blur()})}),y&&y.querySelectorAll(".harmony-preset-button").forEach(K=>{K.addEventListener("click",()=>{const st=K.textContent?.trim()??"",ct=za[st];if(ct&&ct.length>0){const At=ct[0];if(!At)return;let xt=l.state.selectedTool==="chord"&&l.state.activeChordIntervals?[...l.state.activeChordIntervals]:["1P"];xt.includes(At)?At!=="1P"&&(xt=xt.filter(re=>re!==At)):xt.push(At),xt.includes("1P")||xt.unshift("1P");const Ut=["1P","2m","2M","2A","3m","3M","4P","4A","5d","5P","5A","6m","6M","6A","7m","7M","9M","11P","11A","13M"];xt.sort((re,mi)=>Ut.indexOf(re)-Ut.indexOf(mi)),l.setActiveChordIntervals(xt),l.setSelectedTool("chord")}K.blur()}),K.addEventListener("dblclick",()=>{l.setActiveChordIntervals(["1P"]),l.setSelectedTool("chord"),K.blur()})});const q=document.querySelectorAll(".pitch-tab-button"),X=document.querySelectorAll(".pitch-tab-panel");q.forEach(K=>{K.addEventListener("click",()=>{const st=K.dataset.pitchTab;st&&(q.forEach(ct=>ct.classList.remove("active")),K.classList.add("active"),X.forEach(ct=>ct.classList.remove("active")),document.getElementById(`${st}-panel`)?.classList.add("active"),localStorage.setItem("selectedPitchTab",st),st==="chords"&&O(),st==="range"&&setTimeout(()=>Oa.refreshWheelVisuals(),0))})});const tt=localStorage.getItem("selectedPitchTab")||"chords",_=document.querySelector(`[data-pitch-tab="${tt}"]`);_&&(q.forEach(K=>K.classList.remove("active")),X.forEach(K=>K.classList.remove("active")),_.classList.add("active"),document.getElementById(`${tt}-panel`)?.classList.add("active"));const it=document.querySelectorAll(".rhythm-stamp-tab-button"),et=document.querySelectorAll(".rhythm-stamp-tab-panel");it.forEach(K=>{K.addEventListener("click",()=>{const st=K.dataset.rhythmStampTab;st&&(it.forEach(ct=>ct.classList.remove("active")),K.classList.add("active"),et.forEach(ct=>ct.classList.remove("active")),document.getElementById(`${st}-stamps-panel`)?.classList.add("active"),localStorage.setItem("selectedRhythmStampTab",st))})});const ot=localStorage.getItem("selectedRhythmStampTab")||localStorage.getItem("selectedRhythmTab"),ht=ot==="stamps"?"sixteenth":ot==="triplets"?"triplet":ot||"sixteenth",dt=document.querySelector(`[data-rhythm-stamp-tab="${ht}"]`);dt&&(it.forEach(K=>K.classList.remove("active")),et.forEach(K=>K.classList.remove("active")),dt.classList.add("active"),document.getElementById(`${ht}-stamps-panel`)?.classList.add("active")),v&&(v.querySelector(".toggle-track")?.addEventListener("click",()=>{const st=W(),ct=D();Q((st+1)%ct),v?.blur()}),v.querySelectorAll(".left-labels .state-label").forEach(st=>{st.addEventListener("click",()=>{I()==="inversion"&&Q(parseInt(st.dataset.step??"0",10))})}),v.querySelectorAll(".right-labels .state-label").forEach(st=>{st.addEventListener("click",()=>{if(I()!=="position")return;const ct=parseInt(st.dataset.step??"0",10);ct<D()&&Q(ct)})}),l.on("chordPositionChanged",G),l.on("intervalsInversionChanged",G),G()),a&&a.addEventListener("click",()=>{if(l.state.degreeDisplayMode==="off"){if(!P()){Fa.alert("Please place a tonal center on the canvas before showing degrees.","Tonal Center Required");return}l.setDegreeDisplayMode(at())}else l.setDegreeDisplayMode("off");a?.blur()}),c&&c.addEventListener("click",()=>{l.state.degreeDisplayMode!=="off"&&l.state.degreeDisplayMode!=="diatonic"&&l.setDegreeDisplayMode("diatonic"),c?.blur()}),d&&d.addEventListener("click",()=>{l.state.degreeDisplayMode!=="off"&&l.state.degreeDisplayMode!=="modal"&&l.setDegreeDisplayMode("modal"),d?.blur()}),u&&u.addEventListener("click",()=>{l.state.showFrequencyLabels&&l.toggleFrequencyLabels(),l.toggleAccidentalMode("flat"),u?.blur()}),h&&h.addEventListener("click",()=>{l.state.showFrequencyLabels&&l.toggleFrequencyLabels(),l.toggleAccidentalMode("sharp"),h?.blur()}),m&&m.addEventListener("click",()=>{l.toggleFrequencyLabels(),m?.blur()}),g&&g.addEventListener("click",()=>{l.state.showFrequencyLabels&&l.toggleFrequencyLabels(),l.toggleOctaveLabels(),g?.blur()}),f&&f.addEventListener("change",()=>{if(!l.state.focusColours&&!P()){Fa.alert("Please place a tonal center on the canvas before enabling focus colours.","Tonal Center Required"),f&&(f.checked=!1);return}l.toggleFocusColours()}),l.on("toolChanged",z),l.on("activeChordIntervalsChanged",U),l.on("noteChanged",B),l.on("degreeDisplayModeChanged",F),l.on("accidentalModeChanged",Z),l.on("frequencyLabelsChanged",nt),l.on("octaveLabelsChanged",L),nt(l.state.showFrequencyLabels),L(l.state.showOctaveLabels),p&&l.state.selectedNote&&E(p,l.state.selectedNote.color);const bt=document.querySelector(".tab-sidebar");bt&&l.state.selectedNote&&bt.style.setProperty("--c-accent",l.state.selectedNote.color),setTimeout(()=>O(),50);const ut=l.state.degreeDisplayMode;M(ut,a),T(ut),A(),x(),O(),console.log("[Svelte] ToolSelectorBridge mounted")}),Ge(()=>{console.log("[Svelte] ToolSelectorBridge unmounted")}),Ve(),Ot()}class Di{parent;settings;_em;_value;decimalPlaces;colors;element;_minDimension;actual=0;hasMoved=!1;clicked=!1;_start={y:0};_changeFactor=1;constructor(t,e={}){const o=typeof t=="string"?document.querySelector(t):t;if(this.parent=o,!this.parent)throw new Error("DraggableNumber: parent element not found");const i={size:[60,30],value:0,min:0,max:2e4,step:1,decimalPlaces:2,colors:{fill:"#e7e7e7",dark:"#333",light:"#fff",accent:"#b35"},useAppStyling:!1},s={fill:e.colors?.fill??i.colors.fill,dark:e.colors?.dark??i.colors.dark,light:e.colors?.light??i.colors.light,accent:e.colors?.accent??i.colors.accent};this.settings={...i,...e,colors:s},this._em=new Pm,this._value=new Em(this.settings.min,this.settings.max,this.settings.step,this.settings.value),this.decimalPlaces=this.settings.decimalPlaces,this.colors=this.settings.colors,this.element=document.createElement("input"),this.element.type="text",this.parent.appendChild(this.element);const[a,r]=this.settings.size;this._minDimension=Math.min(a,r),this.settings.useAppStyling?(this.element.className="draggable-number-input",this.element.style.cssText=[`width:${a}px`,`height:${r}px`,"background-color: var(--c-surface)","color: var(--c-text)","border: 1px solid var(--c-border)","border-radius: var(--border-radius-sm)","font-family: var(--main-font)","font-weight: 400","font-size: 14px","text-align: center","outline: none","padding: 0","box-sizing: border-box","user-select: text"].join(";")):this.element.style.cssText=[`width:${a}px`,`height:${r}px`,`background-color:${this.colors.fill}`,`color:${this.colors.dark}`,"font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif","font-weight:500",`font-size:${this._minDimension/2}px`,"border: none","outline: none",`padding:${this._minDimension/4}px ${this._minDimension/4}px`,"box-sizing:border-box","user-select:text"].join(";"),Im(this.element,c=>/^-?\d*\.?\d*$/.test(c)),this.actual=0,this.hasMoved=!1,this.clicked=!1,this.element.value=$a(this._value.value,this.decimalPlaces),this._bind()}on(t,e){return this._em.on(t,e),()=>this._em.off(t,e)}emit(t,e){this._em.emit(t,e)}get value(){return this._value.value}set value(t){this._value.update(t),this.emit("change",this._value.value),this._render()}get min(){return this._value.min}set min(t){this._value.min=t,this._render()}get max(){return this._value.max}set max(t){this._value.max=t,this._render()}get step(){return this._value.step}set step(t){this._value.step=t,this._render()}passiveUpdate(t){this._value.update(t),this._render()}link(t){this.min=t.min,this.max=t.max,this.step=t.step,typeof t.on=="function"&&t.on("change",e=>this.passiveUpdate(e)),this.on("change",e=>{"value"in t&&(t.value=e)}),this.value=t.value}_bind(){this.element.addEventListener("blur",()=>{this.settings.useAppStyling?(this.element.style.backgroundColor="var(--c-surface)",this.element.style.color="var(--c-text)"):(this.element.style.backgroundColor=this.colors.fill,this.element.style.color=this.colors.dark);const t=parseFloat(this.element.value);!Number.isNaN(t)&&t!==this.value?this.value=t:this._render()}),this.element.addEventListener("keydown",t=>{if(t.key==="Enter"){this.element.blur();const e=parseFloat(this.element.value);Number.isNaN(e)||(this.value=e)}},!0),this.element.addEventListener("mousedown",t=>this._onMouseDown(t)),this.element.addEventListener("dragstart",t=>t.preventDefault())}_onMouseDown(t){this.hasMoved=!1,this.clicked=!0,this.element.readOnly=!0,this.actual=this.value,this._start={y:t.clientY};const e=this.element.getBoundingClientRect(),o=(t.clientX-e.left)/e.width;this._changeFactor=Tm(o);const i=a=>this._onMouseMove(a),s=()=>this._onMouseUp(i,s);window.addEventListener("mousemove",i),window.addEventListener("mouseup",s)}_onMouseMove(t){if(!this.clicked)return;this.hasMoved=!0;const e=t.clientY-this._start.y,i=Bs(this.max-this.min,0,1e3)/200*Math.pow(this._changeFactor,2),s=this.actual-e*i;this._value.update(s),this._render(),this._value.changed&&this.emit("change",this._value.value)}_onMouseUp(t,e){this.clicked=!1,window.removeEventListener("mousemove",t),window.removeEventListener("mouseup",e),this.hasMoved?document.body.focus():(this.element.readOnly=!1,this.element.focus(),this.element.setSelectionRange(0,this.element.value.length),this.settings.useAppStyling?(this.element.style.backgroundColor="var(--c-accent)",this.element.style.color="var(--c-surface)"):(this.element.style.backgroundColor=this.colors.accent,this.element.style.color=this.colors.light))}_render(){this.element.value=$a(this._value.value,this.decimalPlaces)}}class Em{min;max;step;_value;changed;constructor(t,e,o,i){this.min=Number(t),this.max=Number(e),this.step=Number(o)||1,this._value=0,this.changed=!1,this.update(i)}get value(){return this._value}update(t){const e=Bs(Number(t),this.min,this.max),o=this._stepTo(e),i=this._value;this._value=o,this.changed=o!==i}_stepTo(t){if(!isFinite(this.step)||this.step<=0)return t;const e=Math.round((t-this.min)/this.step);return this.min+e*this.step}}class Pm{_m;constructor(){this._m=new Map}on(t,e){const o=this._m.get(t)||[];o.push(e),this._m.set(t,o)}off(t,e){const o=this._m.get(t);if(!o)return;const i=o.indexOf(e);i>=0&&o.splice(i,1)}emit(t,e){const o=this._m.get(t);if(o)for(const i of o.slice())i(e)}}function Bs(n,t,e){return Math.max(t,Math.min(e,n))}function Tm(n){return 1-Bs(n,0,1)}function $a(n,t=2){return isFinite(n)?Number(n).toFixed(Math.max(0,t)).replace(/\.0+$/,"").replace(/(\.\d*?)0+$/,"$1"):""}function Im(n,t){let e=n.value;n.addEventListener("input",()=>{t(n.value)?e=n.value:n.value=e})}class Lm{isActive=!1;pulseIntervals=new Map;tempoElements=new Map;popDuration={scaleUp:40,scaleDown:80};popScale=1.4;activeAnimations=new Map;constructor(){this.initElements()}initElements(){[{type:"eighth",containerId:"eighth-note-tempo",bpmMultiplier:2},{type:"quarter",containerId:"quarter-note-tempo",bpmMultiplier:1},{type:"dottedQuarter",containerId:"dotted-quarter-tempo",bpmMultiplier:.666}].forEach(({type:e,containerId:o,bpmMultiplier:i})=>{const s=document.getElementById(o),a=s?.parentElement,r=a?.querySelector(".tempo-label-icon");s&&r?this.tempoElements.set(e,{container:s,icon:r,bpmMultiplier:i,originalTransform:s.style.transform||"",originalIconTransform:r.style.transform||""}):b.warn("TempoVisualizer",`Could not find elements for ${e} tempo`,{container:!!s,icon:!!r,tempoGroup:!!a},"toolbar")})}start(){this.isActive||(this.isActive=!0,this.tempoElements.size===0&&this.initElements(),this.tempoElements.forEach((t,e)=>{this.startPulseForType(e)}))}stop(){this.isActive&&(this.isActive=!1,this.pulseIntervals.forEach(t=>{clearInterval(t)}),this.pulseIntervals.clear(),this.activeAnimations.clear(),this.tempoElements.forEach(t=>{t.container.style.transform=t.originalTransform,t.icon.style.transform=t.originalIconTransform}))}startPulseForType(t){const e=this.tempoElements.get(t);if(!e)return;const s=60/(l.state.tempo*e.bpmMultiplier)*1e3;this.triggerPulse(t);const a=setInterval(()=>{this.isActive&&this.triggerPulse(t)},s);this.pulseIntervals.set(t,a)}triggerPulse(t){const o={startTime:performance.now(),phase:"scaleUp"};this.activeAnimations.set(t,o);const i=this.isActive;this.isActive=!0,this.activeAnimations.size===1&&this.animationLoop(),i||setTimeout(()=>{this.activeAnimations.size===0&&(this.isActive=!1)},this.popDuration.scaleUp+this.popDuration.scaleDown+50)}animationLoop(){if(this.activeAnimations.size===0||!this.isActive)return;const t=performance.now();this.activeAnimations.forEach((e,o)=>{const i=this.calculateScale(e,t);this.applyScale(o,i),i===1&&e.phase==="complete"&&this.activeAnimations.delete(o)}),this.activeAnimations.size>0&&requestAnimationFrame(()=>this.animationLoop())}calculateScale(t,e){const o=e-t.startTime;if(t.phase==="scaleUp"){if(o>=this.popDuration.scaleUp)return t.phase="scaleDown",t.startTime=e,this.popScale;{const i=Math.min(o/this.popDuration.scaleUp,1);return 1+(this.popScale-1)*i}}else if(t.phase==="scaleDown"){if(o>=this.popDuration.scaleDown)return t.phase="complete",1;{const i=Math.min(o/this.popDuration.scaleDown,1);return this.popScale-(this.popScale-1)*i}}return 1}applyScale(t,e){const o=this.tempoElements.get(t);if(!o)return;const i=`scale(${e})`;o.container.style.transform=o.originalTransform+" "+i,o.icon.style.transform=o.originalIconTransform+" "+i;const s=e<this.popScale?"transform 0.08s ease-out":"none";o.container.style.transition=s,o.icon.style.transition=s}updateTempo(){this.isActive&&(this.stop(),this.start())}}const ln=new Lm,rn=wn,me={blend:2,cutoff:31,resonance:0,type:"lowpass"};function ho(){return{coeffs:new Float32Array(rn).fill(0),phases:new Float32Array(rn).fill(0)}}function km(){const n=ho();return n.coeffs[0]=1,n}function Nm(){const n=ho();for(let t=1;t<=rn;t+=2){const e=t-1;n.coeffs[e]=1/t,n.phases[e]=0}return n}function Rm(){const n=ho();for(let t=1;t<=rn;t+=2){const e=t-1;n.coeffs[e]=1/(t*t),n.phases[e]=Math.PI/2}return n}function Bm(){const n=ho();for(let t=1;t<=rn;t++){const e=t-1;n.coeffs[e]=1/t,n.phases[e]=t&1?0:Math.PI}return n}const Dm={strings:{amps:[.995,.94,.425,.48,0,.365,.04,.085,0,.09,0,0],phases:[0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,0]},piano:{amps:[1,.7,.6,.5,.4,.32,.25,.2,.17,.14,.12,.1],phases:Array(12).fill(0)},marimba:{amps:[1,.2,.15,.7,.05,.18,.03,.05,.02,.01,0,0],phases:Array(12).fill(0)},woodwind:{amps:[1,.05,.5,.05,.3,.05,.2,.05,.12,.05,.08,.05],phases:Array(12).fill(0)}};function Po(n){const t=ho(),e=Dm[n];if(!e)return t;const o=Math.min(rn,e.amps.length);for(let i=0;i<o;i++)t.coeffs[i]=e.amps[i]||0,t.phases[i]=e.phases[i]||0;return t}const Nn={attack:.1,decay:.2,sustain:.8,release:.3},Fm={sine:{name:"sine",gain:1,adsr:Nn,...km(),filter:{...me}},triangle:{name:"triangle",gain:.81,adsr:Nn,...Rm(),filter:{...me}},square:{name:"square",gain:4/Math.PI,adsr:Nn,...Nm(),filter:{...me}},sawtooth:{name:"sawtooth",gain:2/Math.PI,adsr:Nn,...Bm(),filter:{...me}},trapezium:{name:"trapezium",gain:4/Math.PI,adsr:Nn,coeffs:new Float32Array([.993,0,.314,0,.168,0,.101,0,.06,0,.033,0]),phases:new Float32Array(rn).fill(0),filter:{...me}},impulse:{name:"impulse",gain:.18,adsr:{attack:.01,decay:.3,sustain:0,release:.2},coeffs:new Float32Array([1,.9,.8,.7,.6,.5,.4,.3,.2,.1,0,0]),phases:new Float32Array([0,Math.PI*1.5,Math.PI,Math.PI/2,0,Math.PI*1.5,Math.PI,Math.PI/2,0,Math.PI*1.5,Math.PI,0]),filter:{...me}},strings:{name:"strings",gain:.49,adsr:{attack:.08,decay:.4,sustain:.7,release:.5},...Po("strings"),filter:{...me,cutoff:28}},piano:{name:"piano",gain:.8,adsr:{attack:.01,decay:1.5,sustain:0,release:.4},...Po("piano"),filter:{...me,cutoff:28}},marimba:{name:"marimba",gain:.9,adsr:{attack:.01,decay:.8,sustain:0,release:.4},...Po("marimba"),filter:{...me,cutoff:25}},woodwind:{name:"woodwind",gain:.6,adsr:{attack:.1,decay:.2,sustain:.8,release:.3},...Po("woodwind"),filter:{...me}}};function Wm(n,t){Wt(t,!1);let e=null,o=null,i=null,s=null,a=null,r=!1;const c=(A,x=20)=>{const k=parseInt(A.slice(1,3),16),S=parseInt(A.slice(3,5),16),E=parseInt(A.slice(5,7),16),I=Math.max(0,Math.floor(k*(1-x/100))),D=Math.max(0,Math.floor(S*(1-x/100))),W=Math.max(0,Math.floor(E*(1-x/100)));return`#${I.toString(16).padStart(2,"0")}${D.toString(16).padStart(2,"0")}${W.toString(16).padStart(2,"0")}`},d=(A,x=50)=>{const k=parseInt(A.slice(1,3),16),S=parseInt(A.slice(3,5),16),E=parseInt(A.slice(5,7),16),I=Math.min(255,Math.floor(k+(255-k)*(x/100))),D=Math.min(255,Math.floor(S+(255-S)*(x/100))),W=Math.min(255,Math.floor(E+(255-E)*(x/100)));return`#${I.toString(16).padStart(2,"0")}${D.toString(16).padStart(2,"0")}${W.toString(16).padStart(2,"0")}`};function u(A){const x=Math.round(A),k=e||document.getElementById("tempo-slider");k&&parseInt(k.value,10)!==x&&(k.value=`${x}`);const S=x*2,E=Math.round(x/1.5);o&&o.value!==S&&o.passiveUpdate(S),i&&i.value!==x&&i.passiveUpdate(x),s&&s.value!==E&&s.passiveUpdate(E),l.state.tempo!==x&&(l.setTempo(x),ln.updateTempo())}function h(A){if(!A)return;const x=A.closest(".tempo-slider-container");if(!x||x.querySelector(".tempo-slider-marks"))return;const k=[60,90,120,160,200],S=document.createElement("div");S.className="tempo-slider-marks",x.appendChild(S);const E=Number(A.min)||0,I=Number(A.max)||1,D=Math.max(I-E,1),W=[],Q=()=>{const O=A.getBoundingClientRect().height||A.clientHeight,j=getComputedStyle(A),at=parseFloat(j.getPropertyValue("--slider-thumb-size"))||0,ft=parseFloat(j.getPropertyValue("--slider-thumb-border"))||0,gt=at+ft*2,nt=Math.max(O-gt,1),L=gt/2;W.forEach(({el:z,bpm:U})=>{if(U<E||U>I){z.style.display="none";return}z.style.display="";const B=(U-E)/D,F=L+nt*B;z.style.bottom=`${F}px`})};k.forEach(Y=>{const O=document.createElement("span");O.className="tempo-slider-mark",O.setAttribute("aria-hidden","true"),S.appendChild(O),W.push({el:O,bpm:Y})}),Q(),new ResizeObserver(Q).observe(A)}function m(A){if(!A||!a)return;const x=l.state.timbres[A],k=l.state.colorPalette[A]||{primary:A,light:A},S=k.light,E=k.primary;document.querySelectorAll(".preset-button").forEach(D=>{const W=D,Q=W.id.replace("preset-",""),G=x?.activePresetName===Q;W.classList.toggle("selected",G)});const I=d(S,60);a.style.setProperty("--c-accent",E),a.style.setProperty("--c-accent-light",I),a.style.setProperty("--c-accent-hover",c(E,20))}function g(){r=!0,ln.start()}function f(){r=!0,ln.start()}function p(A){const x=A.target,k=x?parseInt(x.value,10):NaN;u(k)}function v(){e?.blur()}function w(){r&&(r=!1,ln.stop())}function y(){r&&(r=!1,ln.stop())}function C(){r&&(r=!1,ln.stop())}function P(A){A?.newNote?.color?m(A.newNote.color):(document.querySelectorAll(".preset-button").forEach(x=>x.classList.remove("selected")),a&&(a.style.setProperty("--c-accent","#4A90E2"),a.style.setProperty("--c-accent-hover","#357ABD")))}function T(A){A&&A===l.state.selectedNote?.color&&m(A)}function M(A){A!==void 0&&u(A)}Re(()=>{e=document.getElementById("tempo-slider"),a=document.querySelector(".preset-effects-container");const A={size:[45,24],step:1,decimalPlaces:0,useAppStyling:!0};o=new Di("#eighth-note-tempo",{...A,value:180,min:60,max:480}),i=new Di("#quarter-note-tempo",{...A,value:90,min:30,max:240}),s=new Di("#dotted-quarter-tempo",{...A,value:60,min:20,max:160}),o.on("change",k=>{!isNaN(k)&&k>0&&u(k/2)}),i.on("change",k=>{!isNaN(k)&&k>0&&u(k)}),s.on("change",k=>{!isNaN(k)&&k>0&&u(k*1.5)}),u(l.state.tempo),e?(h(e),e.addEventListener("mousedown",g),e.addEventListener("touchstart",f),e.addEventListener("input",p),e.addEventListener("mouseup",v),u(l.state.tempo)):b.warn("AudioControlsBridge","Tempo slider not found - will initialize when rhythm tab is opened",null,"toolbar"),document.addEventListener("mouseup",w),document.addEventListener("touchend",y),document.addEventListener("touchcancel",C),document.querySelectorAll(".preset-button").forEach(k=>{const S=k,E=S.id.replace("preset-",""),I=Fm[E];I&&S.addEventListener("click",()=>{const D=l.state.selectedNote?.color;D&&(l.applyPreset(D,I),setTimeout(()=>m(D),10)),S.blur()})}),l.on("noteChanged",P),l.on("timbreChanged",T),l.on("tempoChanged",M);const x=l.state.selectedNote?.color;x&&m(x),console.log("[Svelte] AudioControlsBridge mounted")}),Ge(()=>{e?.removeEventListener("mousedown",g),e?.removeEventListener("touchstart",f),e?.removeEventListener("input",p),e?.removeEventListener("mouseup",v),document.removeEventListener("mouseup",w),document.removeEventListener("touchend",y),document.removeEventListener("touchcancel",C),console.log("[Svelte] AudioControlsBridge unmounted")}),Ve(),Ot()}function Om(n,t){Wt(t,!0);const e="selectedTab",o="selectedPresetTab",i="timbre",s="presets";function a(L){try{localStorage.setItem(e,L),b.debug("TabManagement",`Saved tab to localStorage: ${L}`,void 0,"ui")}catch(z){b.warn("TabManagement","Failed to save tab to localStorage",z,"ui")}}function r(){try{return localStorage.getItem(e)||i}catch(L){return b.warn("TabManagement","Failed to read tab from localStorage",L,"ui"),i}}function c(L){try{localStorage.setItem(o,L),b.debug("TabManagement",`Saved preset tab to localStorage: ${L}`,void 0,"ui")}catch(z){b.warn("TabManagement","Failed to save preset tab to localStorage",z,"ui")}}function d(){try{return localStorage.getItem(o)||s}catch(L){return b.warn("TabManagement","Failed to read preset tab from localStorage",L,"ui"),s}}let u=null,h=null,m=null;const g=new Map,f=new Map,p=new Map,v=[{label:"effectsPanelActive",selector:"#effects-panel.preset-tab-panel.active"},{label:"effectsPanel",selector:"#effects-panel"},{label:"effectsContentBox",selector:"#effects-panel .effects-content-box"},{label:"presetsPanelActive",selector:"#presets-panel.preset-tab-panel.active"},{label:"presetsPanel",selector:"#presets-panel"},{label:"presetContentBox",selector:"#presets-panel .preset-content-box"},{label:"presetEffectsContent",selector:".preset-effects-content"},{label:"presetEffectsControls",selector:".preset-effects-controls"},{label:"presetEffectsContainer",selector:".preset-effects-container"},{label:"presetEffectsTabs",selector:".preset-effects-tabs"}];let w=null,y=null;const C=new Map;let P=null,T="",M=!1,A=null;function x(L,z){if(!L)return{selector:z,missing:!0};const U=L,B=U.getBoundingClientRect(),F=window.getComputedStyle(U),Z=U.parentElement,N=Z?.getBoundingClientRect(),H=Z?window.getComputedStyle(Z):null;return{selector:z,tag:U.tagName.toLowerCase(),id:U.id||null,className:U.className||null,rectWidth:Number(B.width.toFixed(1)),rectHeight:Number(B.height.toFixed(1)),offsetWidth:U.offsetWidth,clientWidth:U.clientWidth,scrollWidth:U.scrollWidth,computed:{display:F.display,position:F.position,width:F.width,minWidth:F.minWidth,maxWidth:F.maxWidth,flex:F.flex,flexGrow:F.flexGrow,flexShrink:F.flexShrink,flexBasis:F.flexBasis,alignSelf:F.alignSelf,alignItems:F.alignItems,justifyContent:F.justifyContent,justifySelf:F.justifySelf,gap:F.gap,boxSizing:F.boxSizing,paddingLeft:F.paddingLeft,paddingRight:F.paddingRight,borderLeftWidth:F.borderLeftWidth,borderRightWidth:F.borderRightWidth,overflowX:F.overflowX,overflowY:F.overflowY},parent:Z?{tag:Z.tagName.toLowerCase(),id:Z.id||null,className:Z.className||null,rectWidth:Number((N?.width||0).toFixed(1)),computedWidth:H?.width,display:H?.display,flex:H?.flex}:null}}function k(L){const z=Array.from(document.querySelectorAll(L));return{selector:L,count:z.length,entries:z.map((U,B)=>({index:B,...x(U,L)}))}}function S(L,z,U=4){if(!L)return{selector:z,missing:!0,chain:[]};const B=[];let F=L,Z=0;for(;F&&Z<U;){const N=F.getBoundingClientRect(),H=window.getComputedStyle(F);B.push({tag:F.tagName.toLowerCase(),id:F.id||null,className:F.className||null,rectWidth:Number(N.width.toFixed(1)),offsetWidth:F.offsetWidth,clientWidth:F.clientWidth,computed:{display:H.display,width:H.width,minWidth:H.minWidth,maxWidth:H.maxWidth,flex:H.flex,flexGrow:H.flexGrow,flexShrink:H.flexShrink,flexBasis:H.flexBasis,alignItems:H.alignItems,justifyContent:H.justifyContent,alignSelf:H.alignSelf,boxSizing:H.boxSizing,paddingLeft:H.paddingLeft,paddingRight:H.paddingRight,gap:H.gap}}),F=F.parentElement,Z+=1}return{selector:z,missing:!1,chain:B}}function E(L){const z=Object.keys(L.elements).sort(),U={activePresetTab:L.activePresetTab,activePresetPanelId:L.activePresetPanelId};return z.forEach(B=>{const F=L.elements[B];if(!F||F.missing){U[B]="missing";return}U[B]={rectWidth:F.rectWidth,rectHeight:F.rectHeight,offsetWidth:F.offsetWidth,clientWidth:F.clientWidth,scrollWidth:F.scrollWidth}}),JSON.stringify(U)}function I(L,z,U,B){if(z.missing||B.missing)return{pair:`${L} vs ${U}`,missing:!0};const F=["rectWidth","offsetWidth","clientWidth","scrollWidth"],Z=["display","position","width","minWidth","maxWidth","flex","alignSelf","boxSizing","paddingLeft","paddingRight","borderLeftWidth","borderRightWidth","overflowX","overflowY"],N=["computedWidth","display","flex"],H=[];return F.forEach(R=>{const $=z[R],q=B[R];$!==q&&H.push({property:R,[L]:$,[U]:q})}),Z.forEach(R=>{const $=z.computed?.[R],q=B.computed?.[R];$!==q&&H.push({property:`computed.${R}`,[L]:$,[U]:q})}),N.forEach(R=>{const $=z.parent?.[R],q=B.parent?.[R];$!==q&&H.push({property:`parent.${R}`,[L]:$,[U]:q})}),{pair:`${L} vs ${U}`,missing:!1,differences:H}}function D(L){M&&(T=T?`${T}; ${L}`:L,P===null&&(P=requestAnimationFrame(()=>{const z=T||"auto";P=null,T="",Y(z)})))}function W(){w&&v.forEach(L=>{document.querySelectorAll(L.selector).forEach(z=>{C.has(z)||(C.set(z,L.label),w.observe(z))})})}function Q(){w||(M=!0,A=null,w=new ResizeObserver(L=>{const z=L.map(U=>C.get(U.target)||U.target.id||U.target.tagName.toLowerCase()).filter(Boolean);z.length&&D(`Resize: ${z.join(", ")}`)}),y=new MutationObserver(()=>W()),document.body?y.observe(document.body,{childList:!0,subtree:!0}):document.addEventListener("DOMContentLoaded",()=>{y?.observe(document.body,{childList:!0,subtree:!0}),W(),D("init")},{once:!0}),window.addEventListener("resize",()=>D("window resize")),W(),D("init"))}function G(){M=!1,A=null,w&&(w.disconnect(),w=null),y&&(y.disconnect(),y=null),C.clear(),P!==null&&(cancelAnimationFrame(P),P=null),T=""}function Y(L){requestAnimationFrame(()=>{const z=document.querySelector(".preset-tab-button.active"),U=document.querySelector(".preset-tab-panel.active"),B=x(document.querySelector("#effects-panel.preset-tab-panel.active"),"#effects-panel.preset-tab-panel.active"),F=x(document.getElementById("effects-panel"),"#effects-panel"),Z=x(document.querySelector("#effects-panel .effects-content-box"),"#effects-panel .effects-content-box"),N=x(document.querySelector("#presets-panel.preset-tab-panel.active"),"#presets-panel.preset-tab-panel.active"),H=x(document.getElementById("presets-panel"),"#presets-panel"),R=x(document.querySelector("#presets-panel .preset-content-box"),"#presets-panel .preset-content-box"),$=x(document.querySelector(".preset-effects-content"),".preset-effects-content"),q=x(document.querySelector(".preset-effects-controls"),".preset-effects-controls"),X=x(document.querySelector(".preset-effects-container"),".preset-effects-container"),tt=x(document.querySelector(".preset-effects-tabs"),".preset-effects-tabs"),_={reason:L,activePresetTab:z?.dataset?.presetTab||null,activePresetPanelId:U?.id||null,elements:{effectsPanelActive:B,effectsPanel:F,effectsContentBox:Z,presetsPanelActive:N,presetsPanel:H,presetContentBox:R,presetEffectsContent:$,presetEffectsControls:q,presetEffectsContainer:X,presetEffectsTabs:tt},comparisons:{activePanelVsEffectsContent:I("effectsPanelActive",B.missing?F:B,"effectsContentBox",Z),panelVsEffectsContent:I("effectsPanel",F,"effectsContentBox",Z),contentBoxes:I("effectsContentBox",Z,"presetContentBox",R),panels:I("effectsPanel",F,"presetsPanel",H),tabsVsEffectsContent:I("presetEffectsTabs",tt,"effectsContentBox",Z)},chains:{effectsPanelActive:S(document.querySelector("#effects-panel.preset-tab-panel.active"),"#effects-panel.preset-tab-panel.active"),effectsContentBox:S(document.querySelector("#effects-panel .effects-content-box"),"#effects-panel .effects-content-box"),presetEffectsContent:S(document.querySelector(".preset-effects-content"),".preset-effects-content")},lists:{presetTabButtons:k(".preset-effects-tabs .preset-tab-button")}},it=E(_);(L.startsWith("Resize")||L==="auto"||L==="init"||L==="window resize")&&it===A||(A=it,console.groupCollapsed(`[Sizing] Preset/Effects widths (${L})`),console.log(_),console.groupEnd())})}function O(L){window.enablePresetEffectsSizingDiagnostics&&Y(L)}function j(){const L=r();document.querySelectorAll(".tab-button").forEach(B=>B.classList.remove("active")),document.querySelectorAll(".tab-panel").forEach(B=>B.classList.remove("active"));const z=document.querySelector(`[data-tab="${L}"]`),U=document.getElementById(`${L}-panel`);z&&U?(z.classList.add("active"),U.classList.add("active"),L==="rhythm"&&setTimeout(()=>{const B=window.initTempoSliderIfNeeded;typeof B=="function"&&B()},200)):b.warn("TabManagement",`Could not restore tab: ${L}. Tab button or panel not found.`)}function at(){const L=d();document.querySelectorAll(".preset-tab-button:not([disabled])").forEach(B=>B.classList.remove("active")),document.querySelectorAll(".preset-tab-panel").forEach(B=>B.classList.remove("active"));const z=document.querySelector(`[data-preset-tab="${L}"]`),U=document.getElementById(`${L}-panel`);if(z&&U&&!z.hasAttribute("disabled")){z.classList.add("active"),U.classList.add("active");const B=document.querySelector(".harmonic-bins-container");B&&(L==="effects"?B.style.display="none":B.style.display="flex")}else b.warn("TabManagement",`Could not restore preset tab: ${L}. Tab button or panel not found.`);O("restore preset tab")}function ft(){j(),u=document.querySelectorAll(".tab-button"),u.forEach(L=>{const z=()=>{const U=L.dataset.tab;if(!U)return;document.querySelectorAll(".tab-button").forEach(F=>F.classList.remove("active")),L.classList.add("active"),document.querySelectorAll(".tab-panel").forEach(F=>F.classList.remove("active"));const B=document.getElementById(`${U}-panel`);B&&B.classList.add("active"),a(U),U==="rhythm"&&setTimeout(()=>{const F=window.initTempoSliderIfNeeded;typeof F=="function"&&F()},50)};L.addEventListener("click",z),g.set(L,z)}),b.info("TabManagementBridge","Main tabs initialized",null,"ui")}function gt(){at(),h=document.querySelectorAll(".preset-tab-button"),h.forEach(L=>{const z=()=>{const U=L.dataset.presetTab;if(!U)return;document.querySelectorAll(".preset-tab-button:not([disabled])").forEach(Z=>Z.classList.remove("active")),L.classList.add("active"),document.querySelectorAll(".preset-tab-panel").forEach(Z=>Z.classList.remove("active"));const B=document.getElementById(`${U}-panel`);B&&B.classList.add("active"),c(U);const F=document.querySelector(".harmonic-bins-container");F&&(U==="effects"?F.style.display="none":F.style.display="flex"),O(`preset tab click: ${U}`)};L.addEventListener("click",z),f.set(L,z)}),b.info("TabManagementBridge","Preset tabs initialized",null,"ui")}function nt(){m=document.querySelectorAll(".pitch-tab-button"),m.forEach(L=>{const z=()=>{const U=L.dataset.pitchTab;if(!U)return;document.querySelectorAll(".pitch-tab-button").forEach(F=>F.classList.remove("active")),L.classList.add("active"),document.querySelectorAll(".pitch-tab-panel").forEach(F=>F.classList.remove("active"));const B=document.getElementById(`${U}-panel`);B&&B.classList.add("active")};L.addEventListener("click",z),p.set(L,z)}),b.info("TabManagementBridge","Pitch tabs initialized",null,"ui")}ae(()=>(ft(),gt(),nt(),window.logPresetEffectsSizing=(L="manual")=>{Y(L)},window.enablePresetEffectsSizingAutoLog=()=>{window.enablePresetEffectsSizingDiagnostics=!0,Q()},window.disablePresetEffectsSizingAutoLog=()=>{window.enablePresetEffectsSizingDiagnostics=!1,G()},window.enablePresetEffectsSizingDiagnostics&&Q(),console.log("[Svelte 5] TabManagementBridge mounted"),()=>{g.forEach((L,z)=>{z.removeEventListener("click",L)}),g.clear(),f.forEach((L,z)=>{z.removeEventListener("click",L)}),f.clear(),p.forEach((L,z)=>{z.removeEventListener("click",L)}),p.clear(),G(),console.log("[Svelte 5] TabManagementBridge unmounted")})),Ot()}function _m(n,t){Wt(t,!1);const e=16,o={letter:{width:8.5,height:11},"11x14":{width:11,height:14},"11x17":{width:11,height:17}};let i=null,s=null,a=null,r=null,c=null,d=null,u=null,h=null,m=null,g=null,f=null,p=null,v=null,w=!1,y=null;const C=20,P=5;let T=null,M=null;function A(){l.state.isPrintPreviewActive||l.setPrintPreviewActive(!0),i?.classList.remove("hidden");const R=et=>et?getComputedStyle(et).display!=="none":!1,$=l.state.printOptions.pageSize,q=$&&$ in o?$:"letter",X=R(document.getElementById("button-grid")),tt=R(document.getElementById("drum-grid-wrapper")),_=R(document.getElementById("legend-left-canvas")),it=R(document.getElementById("legend-right-canvas"));l.setPrintOptions({pageSize:q,cropTop:0,cropBottom:1,cropLeft:0,cropRight:1,includeButtonGrid:X,includeDrums:tt,includeLeftLegend:_,includeRightLegend:it}),X&&_o.prefetchButtonGridSnapshot(_,it),E()}function x(){l.state.isPrintPreviewActive&&l.setPrintPreviewActive(!1),i?.classList.add("hidden")}function k(R,$){const X=l.state.printOptions[R]===$[0]?$[1]:$[0];l.setPrintOptions({[R]:X})}function S(){if([h,m,g,f,p,v].some(ht=>ht===null))return;const $=l.state.printOptions.pageSize,q=$&&$ in o?$:"letter",{orientation:X,colorMode:tt,includeButtonGrid:_,includeDrums:it,includeLeftLegend:et,includeRightLegend:ot}=l.state.printOptions;u&&(u.value=q),h&&(h.textContent=X.charAt(0).toUpperCase()+X.slice(1)),m&&(m.textContent=tt==="color"?"Color":"B&W",m.classList.toggle("active",tt==="color")),g&&(g.textContent=_?"Include":"Exclude",g.classList.toggle("active",_)),f&&(f.textContent=it?"Include":"Exclude",f.classList.toggle("active",it)),p&&(p.textContent=et?"Include":"Exclude",p.classList.toggle("active",et)),v&&(v.textContent=ot?"Include":"Exclude",v.classList.toggle("active",ot))}async function E(){if(!l.state.isPrintPreviewActive||!s||!a)return;S();const R=d?.clientWidth??0,$=d?.clientHeight??0;if(R===0||$===0)return;const{orientation:q}=l.state.printOptions,X=l.state.printOptions.pageSize,tt=X&&X in o?X:"letter",_=o[tt],it=q==="landscape"?_.height:_.width,et=q==="landscape"?_.width:_.height,ot=.25,ht=it/et,dt=e*2;let bt=Math.max(R-dt,100),ut=Math.max($-dt,100);bt/ut>ht?bt=ut*ht:ut=bt/ht;const K=ot/it*bt,st=bt-2*K,ct=ut-2*K,At={...l.state.printOptions,cropTop:0,cropBottom:1,cropLeft:0,cropRight:1},xt=await _o.generateScoreCanvas(At,{width:st,height:ct});if(!xt)return;s.width=bt,s.height=ut,a.fillStyle="#FFFFFF",a.fillRect(0,0,bt,ut),a.strokeStyle="#E0E0E0",a.lineWidth=1,a.strokeRect(K,K,st,ct);const Ut=K+Math.max(0,(st-xt.width)/2),re=K+Math.max(0,(ct-xt.height)/2);a.drawImage(xt,Ut,re),I(K,st,ct),D(bt,ut,{contentTop:re,contentLeft:Ut,contentWidth:xt.width,contentHeight:xt.height})}function I(R,$,q){if(!a)return;a.strokeStyle="#CCCCCC",a.lineWidth=1;const X=10,tt=R+$,_=R+q;a.beginPath(),a.moveTo(R,R-X),a.lineTo(R,R+X),a.moveTo(R-X,R),a.lineTo(R+X,R),a.moveTo(tt,R-X),a.lineTo(tt,R+X),a.moveTo(tt-X,R),a.lineTo(tt+X,R),a.moveTo(R,_-X),a.lineTo(R,_+X),a.moveTo(R-X,_),a.lineTo(R+X,_),a.moveTo(tt,_-X),a.lineTo(tt,_+X),a.moveTo(tt-X,_),a.lineTo(tt+X,_),a.stroke()}function D(R,$,q){const X=s?.getBoundingClientRect(),tt=d?.getBoundingClientRect();if(!X||!tt||!r||!c)return;r.width=R,r.height=$,r.style.left=`${X.left-tt.left}px`,r.style.top=`${X.top-tt.top}px`,r.style.width=`${R}px`,r.style.height=`${$}px`;const{cropTop:_,cropBottom:it,cropLeft:et,cropRight:ot}=l.state.printOptions,{contentTop:ht,contentLeft:dt,contentHeight:bt,contentWidth:ut}=q,K=ht+_*bt,st=ht+it*bt,ct=dt+et*ut,At=dt+ot*ut,xt=ht+bt,Ut=dt+ut;c.clearRect(0,0,R,$),c.fillStyle="rgba(0, 0, 0, 0.5)",_>0&&c.fillRect(dt,ht,ut,K-ht),it<1&&c.fillRect(dt,st,ut,xt-st),et>0&&c.fillRect(dt,K,ct-dt,st-K),ot<1&&c.fillRect(At,K,Ut-At,st-K),W(K,dt,Ut,"top"),W(st,dt,Ut,"bottom"),Q(ct,ht,xt,"left"),Q(At,ht,xt,"right"),T={pageWidth:R,pageHeight:$,contentTop:ht,contentLeft:dt,contentHeight:bt,contentWidth:ut,cropTopY:K,cropBottomY:st,cropLeftX:ct,cropRightX:At}}function W(R,$,q,X){if(!c)return;const tt=60,_=q-$,it=$+(_-tt)/2,et=X==="top"?R-C-4:R+4;c.fillStyle="#4a90e2",c.fillRect($,R-1,_,2),c.fillRect(it,et,tt,C),c.strokeStyle="#FFFFFF",c.lineWidth=2,c.strokeRect(it,et,tt,C),c.strokeStyle="#FFFFFF",c.lineWidth=1;const ot=3,ht=6,dt=30,bt=$+(_-dt)/2;for(let ut=0;ut<ot;ut++){const K=et+C/2+(ut-1)*ht;c.beginPath(),c.moveTo(bt,K),c.lineTo(bt+dt,K),c.stroke()}}function Q(R,$,q,X){if(!c)return;const tt=60,_=q-$,it=$+(_-tt)/2,et=X==="left"?R-C-4:R+4;c.fillStyle="#4a90e2",c.fillRect(R-1,$,2,_),c.fillRect(et,it,C,tt),c.strokeStyle="#FFFFFF",c.lineWidth=2,c.strokeRect(et,it,C,tt),c.strokeStyle="#FFFFFF",c.lineWidth=1;const ot=3,ht=6,dt=30,bt=$+(_-dt)/2;for(let ut=0;ut<ot;ut++){const K=et+C/2+(ut-1)*ht;c.beginPath(),c.moveTo(K,bt),c.lineTo(K,bt+dt),c.stroke()}}function G(R){if(!T||!r)return;const $=r.getBoundingClientRect(),q=R.clientX-$.left,X=R.clientY-$.top,tt=q>=T.contentLeft&&q<=T.contentLeft+T.contentWidth,_=X>=T.contentTop&&X<=T.contentTop+T.contentHeight,it=tt&&Math.abs(X-T.cropTopY)<C+P,et=tt&&Math.abs(X-T.cropBottomY)<C+P,ot=_&&Math.abs(q-T.cropLeftX)<C+P,ht=_&&Math.abs(q-T.cropRightX)<C+P;it?(w=!0,y="top",r.style.cursor="ns-resize"):et?(w=!0,y="bottom",r.style.cursor="ns-resize"):ot?(w=!0,y="left",r.style.cursor="ew-resize"):ht&&(w=!0,y="right",r.style.cursor="ew-resize")}function Y(R){if(!T||!r)return;const $=r.getBoundingClientRect(),q=R.clientX-$.left,X=R.clientY-$.top;if(w&&y){O(q,X);return}const tt=q>=T.contentLeft&&q<=T.contentLeft+T.contentWidth,_=X>=T.contentTop&&X<=T.contentTop+T.contentHeight,it=tt&&Math.abs(X-T.cropTopY)<C+P,et=tt&&Math.abs(X-T.cropBottomY)<C+P,ot=_&&Math.abs(q-T.cropLeftX)<C+P,ht=_&&Math.abs(q-T.cropRightX)<C+P;it||et?r.style.cursor="ns-resize":ot||ht?r.style.cursor="ew-resize":r.style.cursor="default"}function O(R,$){if(!T)return;const{contentTop:q,contentLeft:X,contentHeight:tt,contentWidth:_}=T,it=.05;if(y==="top"){const et=Math.max(0,Math.min(1,($-q)/tt)),ot=l.state.printOptions.cropBottom;et<ot-it&&l.setPrintOptions({cropTop:et})}else if(y==="bottom"){const et=Math.max(0,Math.min(1,($-q)/tt)),ot=l.state.printOptions.cropTop;et>ot+it&&l.setPrintOptions({cropBottom:et})}else if(y==="left"){const et=Math.max(0,Math.min(1,(R-X)/_)),ot=l.state.printOptions.cropRight;et<ot-it&&l.setPrintOptions({cropLeft:et})}else if(y==="right"){const et=Math.max(0,Math.min(1,(R-X)/_)),ot=l.state.printOptions.cropLeft;et>ot+it&&l.setPrintOptions({cropRight:et})}}function j(){w=!1,y=null,r&&(r.style.cursor="default")}function at(){x()}function ft(){_o.generateAndPrint(),x()}function gt(){k("orientation",["landscape","portrait"])}function nt(){k("colorMode",["color","bw"])}function L(){k("includeButtonGrid",[!0,!1])}function z(){k("includeDrums",[!0,!1])}function U(){k("includeLeftLegend",[!0,!1])}function B(){k("includeRightLegend",[!0,!1])}function F(){if(!u)return;const R=u.value;R in o&&l.setPrintOptions({pageSize:R})}function Z(R){R!==void 0&&(R?A():x())}function N(){E()}function H(){l.state.isPrintPreviewActive&&E()}Re(()=>{i=document.getElementById("print-preview-overlay"),s=document.getElementById("print-preview-canvas"),a=s?.getContext("2d")??null,r=document.getElementById("print-crop-overlay"),c=r?.getContext("2d")??null,d=s?.parentElement??null,u=document.getElementById("print-page-size"),h=document.getElementById("print-orientation-toggle"),m=document.getElementById("print-color-mode-toggle"),g=document.getElementById("print-button-grid-toggle"),f=document.getElementById("print-drum-grid-toggle"),p=document.getElementById("print-left-legend-toggle"),v=document.getElementById("print-right-legend-toggle"),document.getElementById("print-close-button")?.addEventListener("click",at),document.getElementById("print-confirm-button")?.addEventListener("click",ft),h?.addEventListener("click",gt),m?.addEventListener("click",nt),g?.addEventListener("click",L),f?.addEventListener("click",z),p?.addEventListener("click",U),v?.addEventListener("click",B),u?.addEventListener("change",F),r?.addEventListener("mousedown",G),r?.addEventListener("mousemove",Y),r?.addEventListener("mouseup",j),r?.addEventListener("mouseleave",j),l.on("printPreviewStateChanged",Z),l.on("printOptionsChanged",N),l.on("notesChanged",H),d&&(M=new ResizeObserver(()=>{l.state.isPrintPreviewActive&&E()}),M.observe(d)),console.log("[Svelte] PrintPreviewBridge mounted")}),Ge(()=>{document.getElementById("print-close-button")?.removeEventListener("click",at),document.getElementById("print-confirm-button")?.removeEventListener("click",ft),h?.removeEventListener("click",gt),m?.removeEventListener("click",nt),g?.removeEventListener("click",L),f?.removeEventListener("click",z),p?.removeEventListener("click",U),v?.removeEventListener("click",B),u?.removeEventListener("change",F),r?.removeEventListener("mousedown",G),r?.removeEventListener("mousemove",Y),r?.removeEventListener("mouseup",j),r?.removeEventListener("mouseleave",j),M?.disconnect(),console.log("[Svelte] PrintPreviewBridge unmounted")}),Ve(),Ot()}const Fi={stroke:"#c7cfd8",background:"rgba(207, 214, 222, 0.32)"};let To=null;function il(){if(To)return To;if(typeof window>"u")return Fi;const n=window.getComputedStyle(document.documentElement);return To={stroke:n.getPropertyValue("--c-anacrusis-border").trim()||Fi.stroke,background:n.getPropertyValue("--c-anacrusis-bg").trim()||Fi.background},To}function zm(n){if(n.length===0)return[];const t=[...n].sort((o,i)=>o.start-i.start),e=[];for(const o of t){if(e.length===0){e.push({...o});continue}const i=e[e.length-1];o.start<=i.end?i.end=Math.max(i.end,o.end):e.push({...o})}return e}function $m(n){const t=[],e=qm(l.state);return e!==null&&e>0&&t.push({start:nn(0,n),end:nn(e,n)}),n.placedTonicSigns.forEach(o=>{const i=nn(o.columnIndex,n),s=nn(o.columnIndex+2,n);t.push({start:i,end:s})}),zm(t)}function Hm(n,t,e){const o=new Set([n,t]);e.forEach(a=>{const r=Math.max(n,Math.min(t,a.start)),c=Math.max(n,Math.min(t,a.end));c>r&&(o.add(r),o.add(c))});const i=Array.from(o).sort((a,r)=>a-r),s=[];for(let a=0;a<i.length-1;a++){const r=i[a],c=i[a+1],d=(r+c)/2,u=e.some(h=>d>=h.start&&d<h.end);c>r&&s.push({from:r,to:c,light:u})}return s}function qm(n){if(!n.hasAnacrusis||!Array.isArray(n.macrobeatBoundaryStyles))return null;const t=n.macrobeatBoundaryStyles.findIndex(o=>o==="solid");if(t<0)return null;const e=Zt(n,t);return e?e.endColumn+1:null}function nn(n,t){return J(n,t)}function sl(n,t,e,o,i,s,a=1){const r=e+i/2,c=o+s/2,d=Math.min(i,s)*.4*a;if(n.beginPath(),t===0)n.moveTo(r,c-d),n.lineTo(r-d,c+d),n.lineTo(r+d,c+d),n.closePath();else if(t===1)n.moveTo(r,c-d),n.lineTo(r+d,c),n.lineTo(r,c+d),n.lineTo(r-d,c),n.closePath();else{for(let h=0;h<5;h++){const m=2*Math.PI/5*h-Math.PI/2,g=r+d*Math.cos(m),f=c+d*Math.sin(m);h===0?n.moveTo(g,f):n.lineTo(g,f)}n.closePath()}n.fill()}function Gm(n,t){const{columnWidths:e,musicalColumnWidths:o,macrobeatGroupings:i,macrobeatBoundaryStyles:s,placedTonicSigns:a}=t,c=(o&&o.length>0?o:e).length,d=i.map((u,h)=>{const{endColumn:m}=Zt(l.state,h);return m+1});for(let u=0;u<=c;u++){const h=u===0||u===c,m=Ar(u,a),g=a.some(y=>u===y.columnIndex+2),f=d.includes(u);if(!xr(u,a))continue;let v=null;if(h||m||g)v={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(f){const y=d.indexOf(u),C=s[y];if(C==="anacrusis"){const{stroke:P}=il();v={lineWidth:1,strokeStyle:P,dash:[4,4]}}else v={lineWidth:1,strokeStyle:"#adb5bd",dash:C==="solid"?[]:[5,5]}}if(!v)continue;const w=nn(u,t);n.beginPath(),n.moveTo(w,0),n.lineTo(w,Pt(n.canvas)),n.lineWidth=v.lineWidth,n.strokeStyle=v.strokeStyle,n.setLineDash(v.dash),n.stroke()}n.setLineDash([])}function Vm(n,t){const{placedNotes:e,columnWidths:o,cellWidth:i,cellHeight:s,placedTonicSigns:a}=t;n.clearRect(0,0,qt(n.canvas),Pt(n.canvas));const r=Math.max(Kn,Jn*s),c=o.length,d=["H","M","L"],u=$m(t),h=Hm(0,qt(n.canvas),u),{stroke:m}=il();for(let g=0;g<4;g++){const f=g*r;h.forEach(p=>{p.to<=p.from||(n.beginPath(),n.moveTo(p.from,f),n.lineTo(p.to,f),n.strokeStyle=p.light?m:"#ced4da",n.lineWidth=1,n.globalAlpha=p.light?.6:1,n.stroke(),n.globalAlpha=1)})}Gm(n,t);for(let g=0;g<c;g++){if(a.some(v=>g===v.columnIndex||g===v.columnIndex+1))continue;const f=nn(g,t);let p;t.tempoModulationMarkers&&t.tempoModulationMarkers.length>0?p=nn(g+1,t)-f:p=(o[g]??0)*i;for(let v=0;v<3;v++){const w=v*r,y=d[v],C=e.find(P=>P.isDrum&&(typeof P.drumTrack=="number"?String(P.drumTrack):P.drumTrack)===y&&P.startColumnIndex===g);if(C){n.fillStyle=C.color;const P=ke.getAnimationScale(g,y);sl(n,v,f,w,p,r,P)}else n.fillStyle="#ced4da",n.beginPath(),n.arc(f+p/2,w+r/2,2,0,Math.PI*2),n.fill()}}t.tempoModulationMarkers&&t.tempoModulationMarkers.length>0&&_r(n,t)}const Se={getColumnIndex(n){const{cellWidth:t,tempoModulationMarkers:e,cellHeight:o,musicalColumnWidths:i}=l.state,s=l.state.columnWidths||[];if(t===0)return 0;const a={...l.state,tempoModulationMarkers:e,cellWidth:t,columnWidths:s,baseMicrobeatPx:l.state.baseMicrobeatPx||t},r=ji(n,a),c=Math.floor(r);return c},getPitchRowIndex(n){const t=Ht.getViewportInfo();if(!t?.halfUnit||t.halfUnit===0)return-1;const e=t.halfUnit,o=Math.round(n/e-1),i=t.startRank+o,s=t.startRank,a=Math.max(s,(t.endRank??s+1)-1);return Math.max(s,Math.min(a,i))},getDrumRowIndex(n){const t=Math.max(Kn,Jn*l.state.cellHeight);return t===0?-1:Math.floor(n/t)}},Ds=["H","M","L"],Um="canvas-container",Xm="drum-grid-wrapper",al="eraser-tool-button",Ym="drum-grid",Qm="drum-hover-canvas";let Yt=null,ti=!1,ao=!1,Go=1,Ce=null,Ha=0;const jm=500,Zm=()=>Da()?!0:(Qf(),!!Da()),rl=(n,t=0)=>{const e=()=>{Zm()&&jf(n,Rt()+t)},o=window.initAudio?.();if(o&&typeof o.then=="function"){o.then(e).catch(()=>{});return}e()},ei=n=>{l.state.musicalColumnWidths&&l.state.musicalColumnWidths.length>0?l.state.musicalColumnWidths:l.state.columnWidths;const t={tempoModulationMarkers:l.state.tempoModulationMarkers||[],columnWidths:l.state.columnWidths,cellWidth:l.state.cellWidth,cellHeight:l.state.cellHeight,baseMicrobeatPx:l.state.baseMicrobeatPx||l.state.cellWidth||40};return J(n,t)},ll=n=>{if(l.state.tempoModulationMarkers&&l.state.tempoModulationMarkers.length>0){const i=ei(n);return ei(n+1)-i}return((l.state.musicalColumnWidths&&l.state.musicalColumnWidths.length>0?l.state.musicalColumnWidths:l.state.columnWidths)[n]??1)*l.state.cellWidth},ni=()=>Math.max(Kn,Jn*l.state.cellHeight),Fs=()=>{Yt&&Yt.clearRect(0,0,qt(Yt.canvas),Pt(Yt.canvas))};function fs(n,t,e){if(!Yt)return;const o=ei(n),i=t*ni(),s=ll(n);Yt.fillStyle=e,Yt.fillRect(o,i,s,ni())}function Km(n,t){if(!Yt)return;const e=ei(n),o=t*ni(),i=ll(n),s=Ds[t];if(!s)return;const a=ke.getAnimationScale(n,s),r=l.state.selectedTool?.color??"#212529";Yt.globalAlpha=.4,Yt.fillStyle=r,sl(Yt,t,e,o,i,ni(),a),Yt.globalAlpha=1}const cl=()=>document.getElementById(Um)?.scrollLeft??0;function Jm(n){const t=n.currentTarget;if(!t)return;const e=t.getBoundingClientRect(),o=n.clientX-e.left,i=n.clientY-e.top,s=Se.getColumnIndex(o+cl()),a=Se.getDrumRowIndex(i),r=l.state.musicalColumnWidths&&l.state.musicalColumnWidths.length>0?l.state.musicalColumnWidths.length:l.state.columnWidths.length;if(!Yt||s<0||s>=r||a<0||a>2){Ws();return}Fs();const c=Ds[a];c&&(ti?(l.eraseDrumNoteAt?.(s,c,!1)&&(ao=!0),fs(s,a,"rgba(220, 53, 69, 0.3)")):(fs(s,a,"rgba(74, 144, 226, 0.2)"),Km(s,a)))}function Ws(){Fs()}function t0(n){n.preventDefault();const t=n.currentTarget;if(!t)return;const e=t.getBoundingClientRect(),o=n.clientX-e.left,i=n.clientY-e.top,s=Se.getColumnIndex(o+cl()),a=l.state.musicalColumnWidths&&l.state.musicalColumnWidths.length>0?l.state.musicalColumnWidths.length:l.state.columnWidths.length;if(s<0||s>=a||!hu(s,l.state))return;const r=Se.getDrumRowIndex(i);if(r<0||r>2)return;const c=Ds[r];if(c){if(n.button===2){ti=!0,ao=!1,document.getElementById(al)?.classList.add("erasing-active"),l.eraseDrumNoteAt?.(s,c,!1)&&(ao=!0),Fs(),fs(s,r,"rgba(220, 53, 69, 0.3)");return}if(n.button===0){const d=l.state.selectedTool?.color??"#000000",u={isDrum:!0,drumTrack:c,startColumnIndex:s,endColumnIndex:s,color:d,shape:c==="H"?"triangle":c==="M"?"square":"pentagon"};l.toggleDrumNote?.(u),ke.triggerNotePop(s,c),rl(c)}}}function e0(){ti&&(ao&&l.recordState?.(),ti=!1,ao=!1,document.getElementById(al)?.classList.remove("erasing-active")),Ws()}function n0(){const n=document.getElementById(Xm),t=n?.querySelector(".drum-grid-left-cell");if(!n||!t)return;let e=t.querySelector(".drum-left-content");if(!e){e=document.createElement("div"),e.className="drum-left-content";const a=e,r=document.createElement("button");r.className="drum-volume-button",r.type="button",r.setAttribute("aria-label","Drum volume"),r.innerHTML=`
      <span class="drum-volume-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" focusable="false" role="img">
          <path d="M3 10v4h4l5 5V5L7 10H3z" fill="currentColor"></path>
          <path d="M16 8.82v6.36c1.18-.85 2-2.22 2-3.64s-.82-2.79-2-3.64z" fill="currentColor"></path>
          <path d="M16 4v2c2.9 1.06 5 3.86 5 7s-2.1 5.94-5 7v2c4.01-1.15 7-4.97 7-9s-2.99-7.85-7-9z" fill="currentColor"></path>
        </svg>
      </span>
    `,r.style.gridRow="1 / span 3",r.style.gridColumn="1",["H","M","L"].forEach((c,d)=>{const u=document.createElement("span");u.className="drum-track-label",u.textContent=c,u.style.gridColumn="2",u.style.gridRow=`${d+1}`,a.appendChild(u)}),a.appendChild(r),t.appendChild(a)}const o=document.createElement("div");o.className="drum-volume-control",Ce=document.createElement("input"),Ce.type="range",Ce.min="0",Ce.max="100",Ce.value="100",Ce.className="drum-volume-slider",Ce.style.cssText="width: 80px; margin: 0;",Ce.addEventListener("input",a=>{const r=a.currentTarget;Go=Number(r.value)/100;const c=window.drumVolumeNode;if(c?.volume){const d=Go===0?-60:20*Math.log10(Go);c.volume.value=d;const u=Date.now();u-Ha>=jm&&(rl("M",.1),Ha=u)}}),o.appendChild(Ce),t.appendChild(o);const i=()=>{if(!o)return;o.classList.contains("visible")?o.classList.remove("visible"):o.classList.add("visible")},s=t.querySelector(".drum-volume-button");s&&s.addEventListener("click",a=>{a.stopPropagation(),i()}),document.addEventListener("click",a=>{const r=a.target,c=r?.closest(".drum-volume-control"),d=r?.closest(".drum-volume-button");!c&&!d&&o.classList.remove("visible")})}function o0(){return Go}window.getDrumVolume=o0;function i0(){const n=document.getElementById(Ym),t=document.getElementById(Qm);!n||!t||(Yt=t.getContext("2d"),n.addEventListener("mousedown",t0),n.addEventListener("mousemove",Jm),n.addEventListener("mouseleave",Ws),n.addEventListener("contextmenu",e=>e.preventDefault()),window.addEventListener("mouseup",e0),n0())}function qa(){const n=eo.getDrumContext();if(!n?.canvas)return;const t={placedNotes:Ud(l.state),placedTonicSigns:Gt(l.state),columnWidths:l.state.columnWidths,musicalColumnWidths:l.state.musicalColumnWidths,cellWidth:l.state.cellWidth,cellHeight:l.state.cellHeight,macrobeatGroupings:l.state.macrobeatGroupings,macrobeatBoundaryStyles:l.state.macrobeatBoundaryStyles,tempoModulationMarkers:l.state.tempoModulationMarkers,baseMicrobeatPx:l.state.cellWidth};Vm(n,t)}const te={animationFrameId:null,render(){qa(),ke.hasActiveAnimations()?te.animationFrameId||te.startAnimationLoop():te.stopAnimationLoop()},startAnimationLoop(){if(te.animationFrameId)return;const n=()=>{ke.cleanupAnimations(),qa(),ke.hasActiveAnimations()?te.animationFrameId=requestAnimationFrame(n):te.animationFrameId=null};te.animationFrameId=requestAnimationFrame(n)},stopAnimationLoop(){te.animationFrameId&&(cancelAnimationFrame(te.animationFrameId),te.animationFrameId=null)}};window.drumGridRenderer=te;const s0=Symbol("store-context");function a0(n,t){Wt(t,!0),dc(s0,{store:l});function e(){try{En.render(),te.render?.(),b.debug("StoreContext","renderAll invoked",null,"grid")}catch(a){b.error("StoreContext","renderAll failed",a,"grid")}}ae(()=>{const a=()=>{St.setBpm(l.state.tempo)},r=()=>{jt.reflow()},c=()=>{It.refresh&&It.refresh()},d=()=>{En.renderMacrobeatTools()},u=()=>{jt.reflow()},h=()=>{jt.reflow(),e()};return l.on("tempoChanged",a),l.on("layoutChanged",r),l.on("rhythmPatternChanged",c),l.on("notesChanged",e),l.on("sixteenthStampPlacementsChanged",e),l.on("tripletStampPlacementsChanged",e),l.on("accidentalModeChanged",e),l.on("frequencyLabelsChanged",e),l.on("focusColoursChanged",e),l.on("octaveLabelsChanged",e),l.on("degreeDisplayModeChanged",e),l.on("longNoteStyleChanged",e),l.on("layoutConfigChanged",d),l.on("rhythmStructureChanged",u),l.on("tempoModulationMarkersChanged",h),b.initSuccess("StoreContext"),()=>{l.off("tempoChanged",a),l.off("layoutChanged",r),l.off("rhythmPatternChanged",c),l.off("notesChanged",e),l.off("sixteenthStampPlacementsChanged",e),l.off("tripletStampPlacementsChanged",e),l.off("accidentalModeChanged",e),l.off("frequencyLabelsChanged",e),l.off("focusColoursChanged",e),l.off("octaveLabelsChanged",e),l.off("degreeDisplayModeChanged",e),l.off("longNoteStyleChanged",e),l.off("layoutConfigChanged",d),l.off("rhythmStructureChanged",u),l.off("tempoModulationMarkersChanged",h)}});var o=Yo(),i=Zn(o);{var s=a=>{var r=Yo(),c=Zn(r);vc(c,()=>t.children),oe(a,r)};co(i,a=>{t.children&&a(s)})}oe(n,o),Ot()}function r0(n,t){Wt(t,!0);const e=1,o=31,i=0,s=2;let a=!1,r=!1,c=!1,d=l.state.selectedNote?.color||"#4a90e2",u=null,h=null,m=null,g=null,f=null,p=null,v=null;function w(){if(!d)return null;const M=l.state.timbres[d];return M?(M.filter?M.filter.enabled===void 0&&(M.filter.enabled=!0):M.filter={enabled:!0,blend:1,cutoff:16,resonance:0,type:"lowpass",mix:0},M.filter):null}function y(){const M=w();if(!M)return;const{cutoff:A=16,blend:x=0,mix:k=0}=M;if(u&&h){const S=(s-x)/(s-i);u.style.left=`${S*100}%`,h.style.setProperty("--progress",`${S*100}%`)}if(p&&v){const S=(k||0)/100;p.style.bottom=`${S*100}%`,v.style.setProperty("--blend-progress",`${S*100}%`)}if(m&&g){const S=(A-e)/(o-e);m.style.left=`${S*100}%`,m.style.top="50%",m.style.transform="translate(-50%, -50%)",g.style.setProperty("--progress",`${S*100}%`)}f&&d&&f.style.setProperty("--c-accent",d)}function C(M){if(!a||!d||!g)return;const A=g.getBoundingClientRect(),x=M.clientX-A.left,k=A.width;let S=x/k;S=Math.max(0,Math.min(1,S));const E=S*(o-e)+e;l.setFilterSettings(d,{cutoff:E})}function P(M){if(!r||!d||!h)return;const A=h.getBoundingClientRect(),x=M.clientX-A.left,k=A.width;let S=x/k;S=Math.max(0,Math.min(1,S));const E=s-S*(s-i);l.setFilterSettings(d,{blend:E})}function T(M){if(!c||!d||!v)return;const A=v.getBoundingClientRect(),x=M.clientY-A.top,k=A.height;let S=1-x/k;S=Math.max(0,Math.min(1,S));const E=S*100;l.setFilterSettings(d,{mix:E})}ae(()=>{if(f=document.querySelector(".filter-container"),u=document.getElementById("thumb-b"),h=document.getElementById("blend-slider-container"),m=document.getElementById("thumb-c"),g=document.getElementById("cutoff-slider-container"),v=document.getElementById("vertical-blend-track"),p=document.getElementById("vertical-blend-thumb"),!f||!u||!m||!p||!v){b.error("FilterControlsBridge","Missing required elements",{container:f,blendThumb:u,cutoffThumb:m,verticalBlendSlider:p,verticalBlendTrack:v},"filter");return}const M=E=>{E.preventDefault(),r=!0,document.body.style.cursor="ew-resize";const I=W=>P(W),D=()=>{r=!1,document.body.style.cursor="default",window.removeEventListener("pointermove",I),window.removeEventListener("pointerup",D),l.recordState()};window.addEventListener("pointermove",I),window.addEventListener("pointerup",D)},A=E=>{E.preventDefault(),a=!0,document.body.style.cursor="ew-resize";const I=W=>C(W),D=()=>{a=!1,document.body.style.cursor="default",window.removeEventListener("pointermove",I),window.removeEventListener("pointerup",D),l.recordState()};window.addEventListener("pointermove",I),window.addEventListener("pointerup",D)},x=E=>{E.preventDefault(),c=!0,document.body.style.cursor="ns-resize";const I=W=>T(W),D=()=>{c=!1,document.body.style.cursor="default",window.removeEventListener("pointermove",I),window.removeEventListener("pointerup",D),l.recordState()};window.addEventListener("pointermove",I),window.addEventListener("pointerup",D)};u.addEventListener("pointerdown",M),m.addEventListener("pointerdown",A),p.addEventListener("pointerdown",x);const k=({newNote:E}={})=>{E?.color&&E.color!==d&&(d=E.color,y())},S=E=>{E&&E===d&&y()};return l.on("noteChanged",k),l.on("timbreChanged",S),y(),b.info("FilterControlsBridge","Filter controls initialized",null,"filter"),()=>{u?.removeEventListener("pointerdown",M),m?.removeEventListener("pointerdown",A),p?.removeEventListener("pointerdown",x),l.off("noteChanged",k),l.off("timbreChanged",S)}}),Ot()}function Io(n,t){if(!(typeof window>"u"||!window.__adsrFlowDebug)){if(t===void 0){console.log("[ADSR Flow]",n);return}console.log("[ADSR Flow]",n,t)}}function l0(n,{width:t,height:e},o){for(;n.firstChild;)n.removeChild(n.firstChild);if(o>0){for(let r=1;r<=5;r++)if(r<=o){const c=r/o*t,d=document.createElementNS("http://www.w3.org/2000/svg","text");d.setAttribute("x",String(c)),d.setAttribute("y",String(e-5)),d.setAttribute("fill","#d0d0d0"),d.setAttribute("font-size","24"),d.setAttribute("font-weight","bold"),d.setAttribute("text-anchor","middle"),d.setAttribute("dominant-baseline","auto"),d.setAttribute("opacity","0.3"),d.textContent=`${r}s`,n.appendChild(d)}}const i=l.state.tempo;if(i<=0||o<=0)return;const s=30/i;let a=0;for(let r=s;r<o;r+=s){const c=r/o*t,d=document.createElementNS("http://www.w3.org/2000/svg","line");d.setAttribute("x1",String(c)),d.setAttribute("y1","0"),d.setAttribute("x2",String(c)),d.setAttribute("y2",String(e));const u=(a+1)%2===0;d.setAttribute("stroke",u?"#adb5bd":"#ced4da"),d.setAttribute("stroke-width",u?"1":"0.5"),d.setAttribute("stroke-dasharray","3,3"),n.appendChild(d),a++}}function c0(n,t,e,{height:o,width:i},s,a,r){for(;n.firstChild;)n.removeChild(n.firstChild);for(;t.firstChild;)t.removeChild(t.firstChild);if(e.length<4)return;const c=e[0],d=e[1],u=e[2],h=e[3];if(!c||!d||!u||!h)return;const m=l.state.colorPalette[s]||{primary:s,light:s},g=m.primary,f=m.light;let p={time:0,feedback:0};if(window.effectsCoordinator&&(p=window.effectsCoordinator.getEffectParameters(s,"delay")),r&&r.clearRect(0,0,i,o),(p.time||0)>0&&(p.feedback||0)>0&&a){const x=Math.max(.01,(p.time||0)/100*.5),k=Math.min(.95,(p.feedback||0)/100),S=.05;let E=k,I=0;for(;E>S&&I<10;){I++;const D=x*I/a*i,W=e.map(Y=>({x:Y.x+D,y:Y.y})),Q=W[0],G=W[3];if(!(!Q||!G)){if(Q.x<i){const Y=document.createElementNS("http://www.w3.org/2000/svg","polygon"),O=`${Q.x},${o} `+W.map(at=>`${at.x},${at.y}`).join(" ")+` ${Math.min(G.x,i)},${o}`;Y.setAttribute("points",O),Y.setAttribute("fill",be(f,.7*E)),Y.setAttribute("class","delay-echo"),n.appendChild(Y);const j=document.createElementNS("http://www.w3.org/2000/svg","polyline");j.setAttribute("points",W.map(at=>`${at.x},${at.y}`).join(" ")),j.setAttribute("stroke-width","2"),j.setAttribute("fill","none"),j.setAttribute("stroke",be(g,E)),j.setAttribute("class","delay-echo"),n.appendChild(j)}E*=k}}}const v=document.createElementNS("http://www.w3.org/2000/svg","polygon"),w=`0,${o} `+e.map(x=>`${x.x},${x.y}`).join(" ")+` ${i},${o}`;v.setAttribute("points",w),v.setAttribute("fill",be(f,.7)),n.appendChild(v);const y=document.createElementNS("http://www.w3.org/2000/svg","line");y.setAttribute("x1",String(c.x)),y.setAttribute("y1",String(c.y)),y.setAttribute("x2",String(d.x)),y.setAttribute("y2",String(d.y)),y.setAttribute("stroke",g),y.setAttribute("stroke-width","2"),n.appendChild(y);const C=document.createElementNS("http://www.w3.org/2000/svg","line");C.setAttribute("x1",String(d.x)),C.setAttribute("y1",String(d.y)),C.setAttribute("x2",String(u.x)),C.setAttribute("y2",String(u.y)),C.setAttribute("stroke",g),C.setAttribute("stroke-width","2"),n.appendChild(C);const P=1,T=document.createElementNS("http://www.w3.org/2000/svg","line");T.setAttribute("x1",String(u.x)),T.setAttribute("y1",String(u.y)),T.setAttribute("x2",String(h.x)),T.setAttribute("y2",String(h.y)),T.setAttribute("stroke",be(g,P)),T.setAttribute("stroke-width","2"),n.appendChild(T);const M=["attack-node","decay-sustain-node","release-node"];[d,u,h].forEach((x,k)=>{const S=document.createElementNS("http://www.w3.org/2000/svg","circle");S.setAttribute("id",M[k]),S.setAttribute("class","adsr-node"),S.setAttribute("cx",String(x.x)),S.setAttribute("cy",String(x.y)),S.setAttribute("r","8"),S.setAttribute("fill",g),S.setAttribute("stroke",ui(g,-.3)),S.setAttribute("stroke-width","2"),S.style.cursor="grab";const E=document.createElementNS("http://www.w3.org/2000/svg","title");S.appendChild(E),t.appendChild(S)})}function d0(n,t){if(!n)return;const e=ui(t,-.2);n.style.setProperty("--c-accent",t),n.style.setProperty("--c-accent-hover",e)}var u0=Ue('<canvas class="adsr-reverb-canvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas> <svg width="100%" height="100%"><g></g><g></g><g></g></svg>',1);function h0(n,t){Wt(t,!0);const e=2.5,o=.01,i=1e-4;let s=0,a=0,r=0,c=0,d=l.state.selectedNote?.color||"#4a90e2",u=l.state.adsrTimeAxisScale,h=0,m=0,g=!1,f=null,p=null,v=null,w=null,y=null,C=null,P=null,T=null,M=null,A=null,x=null,k=null,S=null,E=null;function I(){if(g)return;g=!0;const B=()=>{g=!1,j(),O()};typeof requestAnimationFrame=="function"?requestAnimationFrame(B):setTimeout(B,0)}function D(B){let F=1;const Z=window.animationEffectsManager;return Z?.shouldTremoloBeRunning?.()&&(F=Z.getADSRTremoloAmplitudeMultiplier(B)),(window.waveformVisualizer?.calculatedAmplitude??1)*F}function W(B){const F=D(d);if(!Number.isFinite(F))return B;if(B.sustain-F>i){const Z={...B,sustain:F};return l.setADSR(d,Z),Io("adsrEnvelope:clampSustain",{color:d,adsr:Z,normalizedAmplitude:F}),Z}return B}function Q(){const B=l.state.timbres[d];if(!B)return;const F=W(B.adsr);s=F.attack,a=F.decay,r=F.sustain,c=F.release,I()}function G(){return e*u}function Y(B){const F=l.state.timbres[d];if(!F)return;const{sustain:Z}=F.adsr,N={...B};N.d=Math.max(N.a+o,N.d),N.r=Math.max(N.d+o,N.r);const H=N.a,R=N.d-N.a,$=N.r-N.d;if(Number.isNaN(H)||Number.isNaN(R)||Number.isNaN($)){b.error("ADSREnvelope","NaN value detected before setting ADSR. Aborting update.",{nextAttack:H,nextDecay:R,nextRelease:$},"audio");return}const q={attack:H,decay:R,release:$,sustain:Z};l.setADSR(d,q),Io("adsrEnvelope:updateADSRFromAbsoluteTimes",{color:d,adsr:q})}function O(){if(!w||!v||!C||!P||!T||!y||!l.state.timbres[d])return;const Z=D(d)*100,N=r*100;w.style.bottom=`${N}%`,v.style.setProperty("--sustain-progress",`${N}%`);const H=100-Z;v.style.setProperty("--ineligible-height",`${H}%`);const R=G(),$=R>0?s/R*100:0,q=R>0?(s+a)/R*100:0,X=R>0?(s+a+c)/R*100:0;C.style.left=`${$}%`,P.style.left=`${q}%`,T.style.left=`${X}%`,y.style.setProperty("--adr-progress",`${X}%`);const tt=ht=>`${ht.toFixed(3)}s`,_=ht=>`${(ht*100).toFixed(0)}%`;C.title=`Attack: ${tt(s)}`,P.title=`Decay: ${tt(a)}`,T.title=`Release: ${tt(c)}`,w.title=`Sustain: ${_(r)}`;const it=E?.querySelector("#attack-node > title");it&&(it.textContent=`Attack: ${tt(s)}`);const et=E?.querySelector("#decay-sustain-node > title");et&&(et.textContent=`Decay: ${tt(a)}
Sustain: ${_(r)}`);const ot=E?.querySelector("#release-node > title");ot&&(ot.textContent=`Release: ${tt(c)}`)}function j(){if(!k||!S||!E||!h||!m)return;const B=G();if(!Number.isFinite(B)||B<=0)return;const F=D(d);if(!Number.isFinite(F))return;const Z=H=>H/B*h,N=[{x:0,y:m},{x:Z(s),y:m*(1-F)},{x:Z(s+a),y:m*(1-Math.min(r*F,F))},{x:Z(s+a+c),y:m}];l0(k,{width:h,height:m},B),c0(S,E,N,{width:h,height:m},d,B,A),d0(p,d)}function at(){if(!f)return;const B=f.clientWidth,F=f.clientHeight;if(!(B<=0||F<=0)){if(h=B,m=F,M){const Z=window.devicePixelRatio||1;M.width=B*Z,M.height=F*Z,A||(A=M.getContext("2d")),A&&(A.setTransform(1,0,0,1,0,0),A.scale(Z,Z))}x&&x.setAttribute("viewBox",`0 0 ${B} ${F}`),I()}}ae(()=>{if(f=document.getElementById("adsr-envelope"),!f){b.error("ADSREnvelope","ADSR container element not found",null,"adsr");return}p=f.closest(".adsr-container"),v=document.getElementById("sustain-slider-track"),w=document.getElementById("sustain-slider-thumb"),y=document.getElementById("multi-thumb-slider-container"),C=document.getElementById("thumb-a"),P=document.getElementById("thumb-d"),T=document.getElementById("thumb-r"),A=M?.getContext("2d")??null;const B=new ResizeObserver(()=>at());return B.observe(f),at(),()=>{B.disconnect()}}),ae(()=>{const B=($={})=>{const q=$.newNote?.color;q&&q!==d&&(d=q,Q())},F=$=>{$===d&&Q()},Z=()=>I(),N=()=>{u=l.state.adsrTimeAxisScale,I()},H=$=>{$?.activeColors?.includes(d)&&I()},R=$=>{$&&$.color===d&&($.effectType==="delay"||$.effectType==="reverb")&&I()};return l.on("noteChanged",B),l.on("timbreChanged",F),l.on("tempoChanged",Z),l.on("adsrTimeAxisScaleChanged",N),l.on("tremoloAmplitudeUpdate",H),l.on("audioEffectChanged",R),Q(),()=>{l.off("noteChanged",B),l.off("timbreChanged",F),l.off("tempoChanged",Z),l.off("adsrTimeAxisScaleChanged",N),l.off("tremoloAmplitudeUpdate",H),l.off("audioEffectChanged",R)}}),ae(()=>{if(!v||!y||!x||!E)return;let B=!1,F=null,Z=null;const N=et=>{if(!B||!v)return;const ot=v.getBoundingClientRect();let dt=100-(et.clientY-ot.top)/ot.height*100;dt=Math.max(0,Math.min(100,dt));const ut=(window.waveformVisualizer?.getNormalizedAmplitude?.()||1)*100;dt=Math.min(dt,ut);const K=l.state.timbres[d];if(!K)return;const st={...K.adsr,sustain:dt/100};l.setADSR(d,st),Io("adsrEnvelope:sustainSlider",{color:d,adsr:st})},H=et=>{B=!0,N(et)},R=()=>{B=!1},$=et=>{if(!F||!y)return;const ot=y.getBoundingClientRect();let dt=(et.clientX-ot.left)/ot.width*100;dt=Math.max(0,Math.min(100,dt));const bt=dt/100*G(),ut=l.state.timbres[d];if(!ut)return;const{attack:K,decay:st,release:ct}=ut.adsr,At={a:K,d:K+st,r:K+st+ct};F.id==="thumb-a"&&(At.a=bt),F.id==="thumb-d"&&(At.d=bt),F.id==="thumb-r"&&(At.r=bt),Y(At)},q=et=>{const ot=et.target;ot?.classList.contains("time-slider-thumb")&&(F=ot,$(et))},X=()=>{F=null},tt=et=>{if(!Z||!x||!h||!m)return;const ot=x.createSVGPoint();ot.x=et.clientX,ot.y=et.clientY;const ht=x.getScreenCTM();if(!ht)return;const dt=ot.matrixTransform(ht.inverse());let bt=dt.x/h*100,ut=1-dt.y/m;bt=Math.max(0,Math.min(100,bt)),ut=Math.max(0,Math.min(1,ut));const K=bt/100*G(),st=l.state.timbres[d];if(!st)return;const{attack:ct,decay:At,release:xt}=st.adsr;let Ut=st.adsr.sustain;const re={a:ct,d:ct+At,r:ct+At+xt};switch(Z.id){case"attack-node":re.a=K;break;case"decay-sustain-node":{re.d=K;const fo=window.waveformVisualizer?.getNormalizedAmplitude?.()||1;Ut=Math.min(ut,fo);break}case"release-node":re.r=K;break}const mi=st.adsr.sustain;if(Ut!==mi){const fo={attack:ct,decay:At,release:xt,sustain:Ut};l.setADSR(d,fo),Io("adsrEnvelope:nodeDragSustain",{color:d,adsr:fo})}Y(re)},_=et=>{const ot=et.target;ot?.classList.contains("adsr-node")&&(Z=ot,Z.style.cursor="grabbing",tt(et))},it=()=>{Z&&(Z.style.cursor="grab",Z=null)};return v.addEventListener("pointerdown",H),document.addEventListener("pointermove",N),document.addEventListener("pointerup",R),y.addEventListener("pointerdown",q),document.addEventListener("pointermove",$),document.addEventListener("pointerup",X),E.addEventListener("pointerdown",_),document.addEventListener("pointermove",tt),document.addEventListener("pointerup",it),()=>{v?.removeEventListener("pointerdown",H),document.removeEventListener("pointermove",N),document.removeEventListener("pointerup",R),y?.removeEventListener("pointerdown",q),document.removeEventListener("pointermove",$),document.removeEventListener("pointerup",X),E?.removeEventListener("pointerdown",_),document.removeEventListener("pointermove",tt),document.removeEventListener("pointerup",it)}});var ft=u0(),gt=Zn(ft);dn(gt,B=>M=B,()=>M);var nt=$t(gt,2),L=Dt(nt);dn(L,B=>k=B,()=>k);var z=$t(L);dn(z,B=>S=B,()=>S);var U=$t(z);dn(U,B=>E=B,()=>E),dn(nt,B=>x=B,()=>x),oe(n,ft),Ot()}b.moduleLoaded("EffectsCoordinator");class f0{constructor(){this.effectParameters=new Map,this.defaultEffects={vibrato:{speed:0,span:0,wet:100},tremolo:{speed:0,span:0,wet:100},delay:{time:0,feedback:0,wet:20}},b.info("EffectsCoordinator","Initialized as main coordinator",null,"effects")}init(){return Object.keys(l.state.timbres).forEach(t=>{this.initializeColorEffects(t)}),l.on("timbreCreated",({color:t})=>{this.initializeColorEffects(t)}),this.loadSavedValues(),b.info("EffectsCoordinator","Event subscriptions established",null,"effects"),!0}initializeColorEffects(t){if(!this.effectParameters.has(t)){const e={};Object.entries(this.defaultEffects).forEach(([i,s])=>{e[i]={...s}}),this.effectParameters.set(t,e);const o=l.state.timbres[t];o&&(o.vibrato&&(e.vibrato={...o.vibrato}),o.tremelo&&(e.tremolo={...o.tremelo})),b.debug("EffectsCoordinator",`Initialized effects for color ${t}`,e,"effects")}}updateParameter(t,e,o,i){if(!i){b.warn("EffectsCoordinator","Cannot update parameter: no color provided",{effectType:t,parameter:e,value:o},"effects");return}this.initializeColorEffects(i);const s=this.effectParameters.get(i);s[t]||(s[t]={...this.defaultEffects[t]}),s[t][e]=o,this.notifyAudioSystem(t,e,o,i,s[t]),this.notifyAnimationSystem(t,e,o,i,s[t]),this.updateTimbreState(t,s[t],i),this.saveValues()}notifyAudioSystem(t,e,o,i,s){l.emit("audioEffectChanged",{effectType:t,parameter:e,value:o,color:i,effectParams:{...s}}),b.debug("EffectsCoordinator",`Notified audio system: ${t}.${e} = ${o} for ${i}`,null,"effects")}notifyAnimationSystem(t,e,o,i,s){(t==="vibrato"||t==="tremolo")&&(l.emit("visualEffectChanged",{effectType:t,parameter:e,value:o,color:i,effectParams:{...s}}),b.debug("EffectsCoordinator",`Notified animation system: ${t}.${e} = ${o} for ${i}`,null,"effects"))}updateTimbreState(t,e,o){const i=l.state.timbres[o];if(!i)return;const a={vibrato:"vibrato",tremolo:"tremelo"}[t];a&&(i[a]||(i[a]={}),Object.assign(i[a],e),l.recordState())}getEffectParameters(t,e){const o=this.effectParameters.get(t);return o?.[e]?{...o[e]}:{...this.defaultEffects[e]}}getAllEffectParameters(t){const e=this.effectParameters.get(t);return e?{...e}:{...this.defaultEffects}}resetColorEffects(t){const e={};Object.entries(this.defaultEffects).forEach(([o,i])=>{e[o]={...i}}),this.effectParameters.set(t,e),Object.keys(e).forEach(o=>{Object.keys(e[o]).forEach(i=>{this.notifyAudioSystem(o,i,e[o][i],t,e[o]),this.notifyAnimationSystem(o,i,e[o][i],t,e[o])})}),b.info("EffectsCoordinator",`Reset all effects for color ${t}`,e,"effects")}saveValues(){const t={};Object.keys(l.state.timbres).forEach(e=>{const o=this.effectParameters.get(e);o&&(t[e]={vibrato:o.vibrato||{speed:0,span:0,wet:100},tremelo:o.tremolo||{speed:0,span:0,wet:100},delay:o.delay||{time:0,feedback:0,wet:20}})});try{localStorage.setItem("effectDialValues",JSON.stringify(t)),b.debug("EffectsCoordinator","Saved effect values to localStorage",null,"effects")}catch(e){b.warn("EffectsCoordinator","Failed to save effect values to localStorage",e,"effects")}}loadSavedValues(){try{const t=localStorage.getItem("effectDialValues");if(!t){b.debug("EffectsCoordinator","No saved effect values found",null,"effects");return}const e=JSON.parse(t);b.debug("EffectsCoordinator","Loading saved effect values",null,"effects"),Object.keys(e).forEach(o=>{const i=l.state.timbres[o],s=e[o];i&&s&&(s.vibrato&&Object.entries(s.vibrato).forEach(([a,r])=>{typeof r=="number"&&this.updateParameter("vibrato",a,r,o)}),s.tremelo&&Object.entries(s.tremelo).forEach(([a,r])=>{typeof r=="number"&&this.updateParameter("tremolo",a,r,o)}),s.delay&&Object.entries(s.delay).forEach(([a,r])=>{typeof r=="number"&&this.updateParameter("delay",a,r,o)}))}),b.info("EffectsCoordinator","Applied saved effect values",null,"effects"),window.synthEngine&&Object.keys(e).forEach(o=>{const i=e[o];i.delay&&(i.delay.time>0||i.delay.feedback>0)&&(window.synthEngine.updateSynthForColor(o),b.debug("EffectsCoordinator",`Re-applied effects to synth for ${o}`,null,"effects"))})}catch(t){b.warn("EffectsCoordinator","Failed to load saved effect values",t,"effects")}}dispose(){this.effectParameters.clear(),b.info("EffectsCoordinator","Disposed",null,"effects")}}const Fe=new f0;class m0{currentEffect=null;effectControlsContainer=null;effectButtons=[];dials=[];currentColor=null;isDialInteractionActive=!1;lastPreviewAt={};previewThrottleMs=180;previewDurationMs=220;previewPitch="C4";holdPreviews={};effectConfigs={delay:{name:"Delay",controls:{time:{label:"Time",min:0,max:100,default:0,unit:"%"},feedback:{label:"Echoes",min:0,max:95,default:0,unit:"%"},wet:{label:"Mix",min:0,max:100,default:15,unit:"%"}}},vibrato:{name:"Vibrato",controls:{speed:{label:"Speed",min:0,max:100,default:0,unit:"%"},span:{label:"Span",min:0,max:100,default:0,unit:"%"}}},tremolo:{name:"Tremolo",controls:{speed:{label:"Speed",min:0,max:100,default:0,unit:"%"},span:{label:"Span",min:0,max:100,default:0,unit:"%"}}}};init(){return b.initStart("Effects Controller"),this.effectControlsContainer=document.getElementById("effect-controls"),this.effectButtons=document.querySelectorAll(".effect-button[data-effect]"),this.effectButtons.length>0&&this.setupEventListeners(),this.initializeSelectedColorTracking(),this.setupGlobalMouseUpHandler(),b.initSuccess("Effects Controller"),!0}setupGlobalMouseUpHandler(){document.addEventListener("mouseup",()=>{this.isDialInteractionActive&&this.onDialInteractionEnd(this.currentEffect)})}setupEventListeners(){this.effectButtons.forEach(t=>{t.addEventListener("click",e=>{const i=e.currentTarget.dataset.effect;i&&this.selectEffect(i)})})}selectEffect(t){if(b.debug("Effects",`Selecting effect: ${t}`,null,"ui"),!this.effectConfigs[t]){b.info("Effects",`Effect ${t} not configured`,null,"ui");return}if(this.effectButtons.forEach(e=>{e.classList.remove("active"),e.dataset.effect===t&&e.classList.add("active")}),this.currentEffect===t){this.currentEffect=null,this.hideEffectControls();return}this.currentEffect=t,this.showEffectControls(t)}showEffectControls(t){const e=this.effectConfigs[t];if(!e||!this.effectControlsContainer){b.warn("Effects",`No configuration found for effect: ${t}`,null,"ui");return}this.clearControls(),this.effectControlsContainer.innerHTML='<div class="effect-controls"></div>';const o=this.effectControlsContainer.querySelector(".effect-controls");o&&Object.entries(e.controls).forEach(([i,s])=>{const r=(this.currentColor?Fe.getEffectParameters?.(this.currentColor,t):null)?.[i]??s.default??0,c=document.createElement("div");c.className="effect-slider-group",c.style.cssText="margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;",o.appendChild(c);const d=document.createElement("label");d.className="effect-slider-label",d.textContent=s.label,d.style.cssText="display: block; margin-bottom: 5px; font-weight: bold; color: #333;",c.appendChild(d);const u=document.createElement("input");u.type="range",u.min=`${s.min}`,u.max=`${s.max}`,u.value=`${r}`,u.className="effect-slider",u.style.cssText="width: 100%; margin: 5px 0;",c.appendChild(u);const h=document.createElement("div");h.className="effect-slider-value";const m=s.unit?`${Math.round(r)}${s.unit}`:Math.round(r);h.textContent=`${m}`,h.style.cssText="text-align: center; font-size: 12px; color: #666;",c.appendChild(h),this.dials.push({dial:{element:u,value:r,destroy:()=>{}},control:i,effectType:t,valueDisplay:h,controlConfig:s});const g=f=>{const p=f.target;if(!p)return;const v=parseFloat(p.value),w=s.unit?`${Math.round(v)}${s.unit}`:Math.round(v);h.textContent=`${w}`,b.debug("Effects",`${t} ${i}: ${v}`,null,"audio"),this.onEffectParameterChange(t,i,v)};u.addEventListener("input",g),u.addEventListener("change",g),u.addEventListener("mousedown",()=>this.onDialInteractionStart(t)),u.addEventListener("mouseup",()=>this.onDialInteractionEnd(t)),u.addEventListener("mouseleave",f=>{(f.buttons&1)===1&&this.onDialInteractionEnd(t)})})}hideEffectControls(){this.clearControls(),this.currentEffect=null}clearControls(){this.dials.forEach(t=>t.dial.destroy()),this.dials=[],this.effectControlsContainer&&(this.effectControlsContainer.innerHTML="")}onEffectParameterChange(t,e,o){const i=this.currentColor||l.state.selectedNote?.color;i&&Fe.updateParameter(t,e,o,i)}updateEffect(t,e){const o=this.currentColor||l.state.selectedNote?.color;o&&Object.entries(e).forEach(([i,s])=>{typeof s=="number"&&Fe.updateParameter(t,i,s,o)})}getEffectState(t){const e=this.currentColor||l.state.selectedNote?.color;return e?Fe.getEffectParameters(e,t)||{}:{}}getActiveColor(){return this.currentColor||l.state.selectedNote?.color||null}getPreviewNotes(){const t=this.getActiveColor();if(!t)return null;const e=l.state.placedNotes.slice().reverse().find(a=>!a.isDrum),o=e?l.state.fullRowData[e.row]?.toneNote||this.previewPitch:this.previewPitch,i=l.state.selectedTool;let s=[o];return i==="chord"&&Array.isArray(l.state.activeChordIntervals)&&(s=l.state.activeChordIntervals.map(r=>$n(bn(o,r)))),{pitches:s,root:o,color:t}}previewEffect(t){const e=this.getActiveColor();if(!e)return;const o=Date.now(),i=this.lastPreviewAt[t]??0;if(o-i<this.previewThrottleMs)return;this.lastPreviewAt[t]=o;const{isPlaying:s,isPaused:a}=l.state;if(s&&!a)return;const r=`effect-preview-${t}`;l.emit?.("noteAttack",{noteId:r,color:e});try{St.triggerAttack(this.previewPitch,e),setTimeout(()=>St.triggerRelease(this.previewPitch,e),this.previewDurationMs)}catch(c){b.warn("Effects","Preview trigger failed",{err:c},"audio")}finally{setTimeout(()=>l.emit?.("noteRelease",{noteId:r,color:e}),this.previewDurationMs)}}startHoldPreview(t){if(this.holdPreviews[t])return;const e=this.getPreviewNotes();if(!e)return;const{pitches:o,root:i,color:s}=e,a=`effect-hold-${t}-${Date.now()}`;this.holdPreviews[t]={pitches:o,root:i,color:s,noteId:a};const{isPlaying:r,isPaused:c}=l.state;if(r&&!c)return;if(t==="delay"){const u=Fe.getEffectParameters(s,"delay");u&&u.wet>0&&Fe.updateParameter("delay","wet",u.wet,s)}o.forEach(u=>St.triggerAttack(u,s));const d=l.state.fullRowData.find(u=>u.toneNote===i);d&&d.hex,l.state.timbres[s],l.emit("spacebarPlayback",{note:i,color:s,isPlaying:!0}),l.emit("noteAttack",{noteId:a,color:s})}stopHoldPreview(t){const e=this.holdPreviews[t];if(!e)return;delete this.holdPreviews[t];const{pitches:o,root:i,color:s,noteId:a}=e;o.forEach(c=>St.triggerRelease(c,s));const r=l.state.fullRowData.find(c=>c.toneNote===i);r&&r.hex,l.state.timbres[s],l.emit("spacebarPlayback",{note:i,color:s,isPlaying:!1}),l.emit("noteRelease",{noteId:a,color:s})}initializeSelectedColorTracking(){l.on("noteChanged",({newNote:t}={})=>{this.currentColor=t?.color||null,this.currentColor&&this.currentEffect&&this.showEffectControls(this.currentEffect)}),this.currentColor=l.state.selectedNote?.color||null}onDialInteractionStart(t){if(this.isDialInteractionActive=!0,t){b.debug("Effects",`Dial interaction start for ${t}`,null,"ui");const e=this.getActiveColor();e&&l.emit("effectDialInteractionStart",{effectType:t,color:e}),this.startHoldPreview(t)}}onDialInteractionEnd(t){if(this.isDialInteractionActive=!1,t){b.debug("Effects",`Dial interaction end for ${t}`,null,"ui");const e=this.getActiveColor();e&&l.emit("effectDialInteractionEnd",{effectType:t,color:e}),this.stopHoldPreview(t)}}}const We=new m0;var p0=uc('<svg class="svelte-w1yw4"><defs><pattern width="20" height="20" patternUnits="userSpaceOnUse"><rect width="20" height="20" fill="none" stroke-width="1"></rect></pattern></defs><rect x="0" y="0"></rect><rect x="0" y="0" opacity="0.2"></rect><line y1="0" stroke-width="1" opacity="0.6"></line><line x1="0" stroke-width="1" opacity="0.6"></line><circle r="10" stroke="#fff" stroke-width="2"></circle></svg>');function g0(n,t){Wt(t,!0);let e=ie(t,"x",15,.5),o=ie(t,"y",15,.5),i=ie(t,"minX",3,0),s=ie(t,"maxX",3,1),a=ie(t,"stepX",3,0),r=ie(t,"minY",3,0),c=ie(t,"maxY",3,1),d=ie(t,"stepY",3,0),u=ie(t,"size",19,()=>[200,200]),h=ie(t,"mode",3,"absolute"),m=ie(t,"reverseX",3,!1),g=ie(t,"colors",19,()=>({}));const f={accent:"#4a90e2",fill:"#1f1f1f",stroke:"#555",grid:"#333",text:"#fff"};let p=Tt(sn({...f}));ae(()=>{try{const nt=getComputedStyle(document.documentElement),L=nt.getPropertyValue("--c-surface").trim(),z=nt.getPropertyValue("--c-border").trim(),U=nt.getPropertyValue("--c-border-strong").trim(),B=nt.getPropertyValue("--c-text").trim();vt(p,{...f,fill:L||f.fill,stroke:z||f.stroke,grid:U||f.grid,text:B||f.text,...g()},!0)}catch{vt(p,{...f,...g()},!0)}});let v=Tt(!1),w=Tt(0),y=Tt(0);const C=Je(()=>u()[0]),P=Je(()=>u()[1]),T=`pos-grid-${Math.random().toString(36).slice(2,8)}`;function M(nt,L,z){return Math.max(L,Math.min(z,nt))}function A(nt,L,z,U){if(U<=0)return nt;const B=nt-L,F=Math.round(B/U),Z=L+F*U;return M(Z,L,z)}function x(){if(!(e()===i()&&o()===r())){if(e()===i()){const nt=a()>0?a():Math.max((s()-i())/100,.01);e(i()+nt)}if(o()===r()){const nt=d()>0?d():Math.max((c()-r())/100,.01);o(r()+nt)}}vt(w,M((e()-i())/(s()-i()||1),0,1),!0),vt(y,M((o()-r())/(c()-r()||1),0,1),!0)}const k=Je(()=>m()?(1-V(w))*V(C):V(w)*V(C)),S=Je(()=>h()==="absolute"?V(y)*V(P):(1-V(y))*V(P));function E(nt){vt(v,!0),I(nt),nt.target.setPointerCapture?.(nt.pointerId)}function I(nt){if(!V(v))return;const z=nt.currentTarget.getBoundingClientRect(),U=(nt.clientX-z.left)/z.width,B=m()?1-U:U,F=(nt.clientY-z.top)/z.height;vt(w,M(B,0,1),!0);const Z=h()==="relative"?1-F:F;if(vt(y,M(Z,0,1),!0),e(i()+V(w)*(s()-i())),o(r()+V(y)*(c()-r())),a()>0&&e(A(e(),i(),s(),a())),d()>0&&o(A(o(),r(),c(),d())),!(e()===i()&&o()===r())){if(e()===i()){const N=a()>0?a():Math.max((s()-i())/100,.01);e(i()+N)}if(o()===r()){const N=d()>0?d():Math.max((c()-r())/100,.01);o(r()+N)}}vt(w,M((e()-i())/(s()-i()||1),0,1),!0),vt(y,M((o()-r())/(c()-r()||1),0,1),!0),t.onchange?.({x:e(),y:o()})}function D(nt){vt(v,!1),nt.target.releasePointerCapture?.(nt.pointerId)}ae(()=>{x()}),ae(()=>{V(v)||x()});var W=p0();W.__pointerdown=E,W.__pointermove=I,W.__pointerup=D,hc(W,"",{},{"touch-action":"none"});var Q=Dt(W),G=Dt(Q),Y=Dt(G),O=$t(Q),j=$t(O),at=$t(j),ft=$t(at),gt=$t(ft);an(()=>{wt(W,"width",V(C)),wt(W,"height",V(P)),wt(W,"viewBox",`0 0 ${V(C)??""} ${V(P)??""}`),wt(G,"id",T),wt(Y,"stroke",V(p).grid),wt(O,"width",V(C)),wt(O,"height",V(P)),wt(O,"fill",V(p).fill),wt(O,"stroke",V(p).stroke),wt(j,"width",V(C)),wt(j,"height",V(P)),wt(j,"fill",`url(#${T})`),wt(at,"x1",V(k)),wt(at,"x2",V(k)),wt(at,"y2",V(P)),wt(at,"stroke",V(p).grid),wt(ft,"x2",V(C)),wt(ft,"y1",V(S)),wt(ft,"y2",V(S)),wt(ft,"stroke",V(p).grid),wt(gt,"cx",V(k)),wt(gt,"cy",V(S)),wt(gt,"fill",V(p).accent)}),hn("pointercancel",W,D),oe(n,W),Ot()}li(["pointerdown","pointermove","pointerup"]);var v0=Ue('<div class="effects-cartesian-slider svelte-96fy48"><!></div>');function b0(n,t){Wt(t,!0);const e={delay:{xParam:"time",yParam:"feedback",xRange:{min:0,max:100,step:1},yRange:{min:0,max:95,step:1},backgroundOpacity:.5},vibrato:{xParam:"speed",yParam:"span",xRange:{min:0,max:100,step:1},yRange:{min:0,max:100,step:1},backgroundOpacity:.5},tremolo:{xParam:"speed",yParam:"span",xRange:{min:0,max:100,step:1},yRange:{min:0,max:100,step:1},backgroundOpacity:.5}},o=120;let i=Tt(null),s=null,a=Tt(null),r=Tt(null),c=Tt(sn([o,o])),d=Tt(0),u=Tt(0),h=Tt(sn({})),m=l.state.selectedNote?.color??null,g=!1;const f=E=>Math.max(0,Math.min(255,E)),p=(E,I)=>{const D=E.replace("#",""),W=f(parseInt(D.slice(0,2),16)+I),Q=f(parseInt(D.slice(2,4),16)+I),G=f(parseInt(D.slice(4,6),16)+I);return`#${W.toString(16).padStart(2,"0")}${Q.toString(16).padStart(2,"0")}${G.toString(16).padStart(2,"0")}`},v=(E,I)=>{const D=E.replace("#",""),W=parseInt(D.slice(0,2),16),Q=parseInt(D.slice(2,4),16),G=parseInt(D.slice(4,6),16);return`rgba(${W}, ${Q}, ${G}, ${I})`};function w(E){const I=E.getBoundingClientRect();let D=I?.width||E.clientWidth||E.offsetWidth||o,W=I?.height||E.clientHeight||E.offsetHeight||D;return(!D||D<10)&&(D=o),(!W||W<10)&&(W=D),[Math.round(D),Math.round(W)]}function y(){s&&vt(c,w(s),!0)}function C(E){const I=l.state.colorPalette[E]||{primary:E,light:E},D=I.light||p(I.primary,80),W=V(r)?.backgroundOpacity??.5;vt(h,{accent:I.primary,fill:v(D,W),stroke:"#c3c9d0",grid:"#d7dce4",text:"#3c4048"},!0)}function P(){if(!V(r)||!V(a))return;const E=We.getEffectState(V(a))||{},I=typeof E[V(r).xParam]=="number"?E[V(r).xParam]:V(r).xRange.min,D=typeof E[V(r).yParam]=="number"?E[V(r).yParam]:V(r).yRange.min;vt(d,I,!0),vt(u,D,!0)}function T({x:E,y:I}){!V(r)||!V(a)||We.updateEffect(V(a),{[V(r).xParam]:E,[V(r).yParam]:I})}function M(){if(!V(a)||g)return;g=!0;const E=We.getActiveColor();l.emit("effectDialInteractionStart",{effectType:V(a),color:E}),We.startHoldPreview(V(a))}function A(){if(!V(a)||!g)return;g=!1;const E=We.getActiveColor();l.emit("effectDialInteractionEnd",{effectType:V(a),color:E}),We.stopHoldPreview(V(a))}Re(()=>{if(!V(i)||(s=V(i).parentElement,!s))return;const E=s.dataset.effect;if(E==="delay"||E==="vibrato"||E==="tremolo")vt(a,E,!0),vt(r,e[E],!0),vt(d,V(r).xRange.min,!0),vt(u,V(r).yRange.min,!0);else{E&&console.warn("[EffectsCartesianSlider] Unknown effect type:",E);return}if(y(),typeof ResizeObserver>"u")return;const I=new ResizeObserver(()=>y());return I.observe(s),()=>I.disconnect()}),ae(()=>{if(!V(r)||!V(a))return;const E=(Q={})=>{const G=Q.newNote?.color??null;m=G,G?C(G):vt(h,{},!0),g||P()},I=Q=>{!Q||Q!==m||g||P()},D=Q=>{if(!(!Q||Q.effectType!==V(a))&&Q.color===m&&!g){if(Q.effectParams){const G=Q.effectParams[V(r).xParam],Y=Q.effectParams[V(r).yParam];typeof G=="number"&&vt(d,G,!0),typeof Y=="number"&&vt(u,Y,!0);return}P()}};l.on("noteChanged",E),l.on("timbreChanged",I),l.on("audioEffectChanged",D),m?C(m):vt(h,{},!0),P();const W=()=>A();return window.addEventListener("pointerup",W),()=>{l.off("noteChanged",E),l.off("timbreChanged",I),l.off("audioEffectChanged",D),window.removeEventListener("pointerup",W)}});var x=v0(),k=Dt(x);{var S=E=>{g0(E,{get minX(){return V(r).xRange.min},get maxX(){return V(r).xRange.max},get stepX(){return V(r).xRange.step},get minY(){return V(r).yRange.min},get maxY(){return V(r).yRange.max},get stepY(){return V(r).yRange.step},get size(){return V(c)},mode:"relative",get colors(){return V(h)},onchange:T,get x(){return V(d)},set x(I){vt(d,I,!0)},get y(){return V(u)},set y(I){vt(u,I,!0)}})};co(k,E=>{V(r)&&E(S)})}dn(x,E=>vt(i,E),()=>V(i)),hn("pointerdown",x,M),hn("pointerup",x,A),hn("pointerleave",x,A),hn("pointercancel",x,A),oe(n,x),Ot()}var w0=Ue("<button> </button>"),y0=Ue('<div class="notification-overlay visible svelte-12566qp" role="button" tabindex="0" aria-label="Dismiss notification"><div class="notification-modal svelte-12566qp"><button class="notification-close svelte-12566qp" aria-label="Close"></button> <h2 class="notification-title svelte-12566qp"> </h2> <p class="notification-message svelte-12566qp"> </p> <div class="notification-actions svelte-12566qp"></div></div></div>');function S0(n,t){Wt(t,!0);let e=Tt(!1),o=Tt("Notice"),i=Tt(""),s=Tt(sn([{text:"OK",primary:!0}]));function a(g){g.target===g.currentTarget&&vt(e,!1)}function r(g){(g.key==="Enter"||g.key===" ")&&(g.preventDefault(),vt(e,!1))}function c(g){g.key==="Escape"&&V(e)&&vt(e,!1)}function d(g){g.action?g.action():vt(e,!1)}var u=Yo();hn("keydown",fc,c);var h=Zn(u);{var m=g=>{var f=y0();f.__click=a,f.__keydown=r;var p=Dt(f),v=Dt(p);v.__click=()=>vt(e,!1);var w=$t(v,2),y=Dt(w),C=$t(w,2),P=Dt(C),T=$t(C,2);mc(T,21,()=>V(s),pc,(M,A)=>{var x=w0();x.__click=()=>d(V(A));var k=Dt(x);an(()=>{ar(x,1,`notification-button ${V(A).primary?"":"secondary"}`,"svelte-12566qp"),Bo(k,V(A).text)}),oe(M,x)}),an(()=>{Bo(y,V(o)),Bo(P,V(i))}),oe(g,f)};co(h,g=>{V(e)&&g(m)})}oe(n,u),Ot()}li(["click","keydown"]);var C0=Ue('<div class="zoom-indicator svelte-lpl7xl"> </div>');function A0(n,t){Wt(t,!0);let e=Tt(!1),o=Tt("Zoom: 100%"),i=null;function s(){let u=100,h="";const m=Ht.getViewportInfo();if(m)if(u=Math.round((m.zoomLevel??1)*100),m.canSeeFullRange)h=" (Full Range)";else{const g=m.startRank??m.startRow??0,f=m.endRank??m.endRow??g;h=` (~${Math.max(0,Math.floor(f-g))} semitones)`}vt(o,`Zoom: ${u}%${h}`)}function a(){s(),vt(e,!0),i!==null&&clearTimeout(i),i=setTimeout(()=>{vt(e,!1),i=null},2e3)}ae(()=>{const u=()=>a();return l.on("zoomIn",u),l.on("zoomOut",u),()=>{l.off("zoomIn",u),l.off("zoomOut",u),i!==null&&clearTimeout(i)}});var r=Yo(),c=Zn(r);{var d=u=>{var h=C0(),m=Dt(h);an(()=>Bo(m,V(o))),oe(u,h)};co(c,u=>{V(e)&&u(d)})}oe(n,r),Ot()}const ro=()=>{if(typeof window>"u")return!1;const n=window.__initDebug;return n===!0},Ee=(n,t)=>{if(ro()){if(t===void 0){console.log(`[SvelteMount] ${n}`);return}console.log(`[SvelteMount] ${n}`,t)}};let Ga=!1;const dl=()=>{if(!Ga&&(Ga=!0,!(typeof window>"u")))try{const n=window,t=new URLSearchParams(window.location.search),e=t.get("allowSvelte")??t.get("onlySvelte"),o=t.get("skipSvelte"),i=t.get("skipSvelteAll")==="1";if(!Array.isArray(n.__svelteAllowComponents)||n.__svelteAllowComponents.length===0){if(e==="*"||e==="all")n.__svelteAllowComponents=["*"];else if(e){const s=e.split(",").map(a=>a.trim()).filter(Boolean);s.length>0&&(n.__svelteAllowComponents=s)}}if(!Array.isArray(n.__svelteSkipComponents)||n.__svelteSkipComponents.length===0){if(i||o==="*"||o==="all")n.__svelteSkipComponents=["*"];else if(o){const s=o.split(",").map(a=>a.trim()).filter(Boolean);s.length>0&&(n.__svelteSkipComponents=s)}}ro()&&(n.__svelteAllowComponents&&console.warn("[SvelteMount] allow list",n.__svelteAllowComponents),n.__svelteSkipComponents&&console.warn("[SvelteMount] skip list",n.__svelteSkipComponents))}catch(n){console.error("[SvelteMount] filter list parse failed",n)}},ul=n=>{if(typeof window>"u")return!1;dl();const t=window.__svelteAllowComponents;if(Array.isArray(t)&&t.length>0)return!(t.includes("*")||t.includes(n));const e=window.__svelteSkipComponents;return!Array.isArray(e)||e.length===0?!1:e.includes("*")||e.includes(n)},hl={"playback-controls":em,"playback-controls-bridge":nm,"file-actions-bridge":om,"grid-controls-bridge":im,"modulation-bridge":sm,"sidebar-bridge":bm,"tool-selector-bridge":Mm,"audio-controls-bridge":Wm,"tab-management-bridge":Om,"print-preview-bridge":_m,"store-context":a0,"adsr-envelope":h0,"effects-cartesian-slider":b0,"filter-controls-bridge":r0,"notification-modal":S0,"zoom-indicator":A0},oi=[];function x0(){dl();const n=document.querySelectorAll("[data-svelte-component]");Ee("placeholders found",n.length),n.forEach(t=>{const e=t.getAttribute("data-svelte-component");if(!e)return;const o=hl[e];if(!o){console.warn(`[Svelte] Unknown component: ${e}`);return}try{if(ul(e)){Ee("mount:skip",e),ro()&&console.warn(`[Svelte] Skipped: ${e}`);return}Ee("mount:start",e),t.innerHTML="";const i=rr(o,{target:t});oi.push({target:t,component:i}),ro()&&console.log(`[Svelte] Mounted: ${e}`),Ee("mount:done",e)}catch(i){console.error(`[Svelte] Failed to mount ${e}:`,i),Ee("mount:failed",e)}}),Ee("mountSvelteComponents:complete")}function M0(){oi.forEach(({component:n})=>{try{gc(n)}catch(t){console.error("[Svelte] Failed to unmount component:",t)}}),oi.length=0}function Va(n,t){const e=hl[n];if(!e)return console.error(`[Svelte] Unknown component: ${n}`),null;if(ul(n))return Ee("mount:skip",n),ro()&&console.warn(`[Svelte] Skipped: ${n}`),null;const o=typeof t=="string"?document.querySelector(t):t;if(!o)return console.error(`[Svelte] Target not found: ${t}`),null;Ee("mount:start",n);const i=rr(e,{target:o});return oi.push({target:o,component:i}),Ee("mount:done",n),i}li(["input","mousedown","keydown"]);const E0=()=>{if(typeof window>"u")return!1;const n=window.__initDebug;return n===!0},Lo=(n,t)=>{if(E0()){console.log(`[InitUiComponents] ${n}`);return}};function P0(){Lo("start"),Zf.init(),Lo("mountSvelteComponents:start"),x0(),Lo("mountSvelteComponents:done"),b.initSuccess("UiComponents"),Lo("done")}const Wi=()=>window.synthEngine??null,Ua=()=>window.animationEffectsManager??null;b.moduleLoaded("DynamicWaveformVisualizer");class T0{canvas=null;ctx=null;currentColor=null;isPlaybackActive=!1;liveAnalysers=new Map;liveWaveforms=new Map;playbackAnimationId=null;animationSpeed=100;frameSkipCounter=0;onWaveformUpdate;initialize(t,e){return this.canvas=t,this.ctx=e,this.currentColor=l.state.selectedNote?.color||"#4a90e2",this.setupEventListeners(),b.info("DynamicWaveformVisualizer","Initialized with canvas context",null,"waveform"),!0}setupEventListeners(){l.on("noteChanged",({newNote:t}={})=>{t?.color&&t.color!==this.currentColor&&(this.currentColor=t.color)}),l.on("playbackStateChanged",({isPlaying:t=!1,isPaused:e=!1}={})=>{t&&!e?this.startLiveVisualization():this.stopLiveVisualization()}),l.on("spacebarPlayback",({color:t,isPlaying:e=!1}={})=>{e&&t?this.startSingleNoteVisualization(t):this.stopLiveVisualization()}),l.on("tremoloAmplitudeUpdate",({activeColors:t}={})=>{this.isPlaybackActive&&t?.some(e=>this.liveWaveforms.has(e))&&b.debug("DynamicWaveformVisualizer","Tremolo update received for active colors",t,"waveform")}),b.info("DynamicWaveformVisualizer","Event subscriptions established",null,"waveform")}setAnimationSpeed(t){this.animationSpeed=t,this.frameSkipCounter=0}startLiveVisualization(){this.isPlaybackActive||(this.isPlaybackActive=!0,this.setupLiveAnalysers(),this.updateContainerState(!0),this.animateLiveWaveforms(),b.debug("DynamicWaveformVisualizer","Started live visualization",null,"waveform"))}startSingleNoteVisualization(t){this.isPlaybackActive||(this.isPlaybackActive=!0,this.setupSingleAnalyser(t),this.updateContainerState(!0),this.animateLiveWaveforms(),b.debug("DynamicWaveformVisualizer",`Started single note visualization for ${t}`,null,"waveform"))}stopLiveVisualization(){this.isPlaybackActive=!1;const t=Wi();this.liveAnalysers.forEach((e,o)=>{t?.removeWaveformAnalyzer?.(o)}),this.liveAnalysers.clear(),this.liveWaveforms.clear(),this.playbackAnimationId&&(cancelAnimationFrame(this.playbackAnimationId),this.playbackAnimationId=null),this.updateContainerState(!1),b.debug("DynamicWaveformVisualizer","Stopped live visualization",null,"waveform")}updateContainerState(t){const e=this.canvas?.parentElement;e&&(t?(e.classList.add("live-mode"),l.state.isPlaying&&!l.state.isPaused&&e.classList.add("pulsing")):e.classList.remove("live-mode","pulsing"))}setupLiveAnalysers(){const t=Wi();if(!t){b.warn("DynamicWaveformVisualizer","SynthEngine not available for live analysis",null,"waveform");return}this.getActivePlayingColors().forEach(o=>{const i=t.createWaveformAnalyzer?.(o);i&&(this.liveAnalysers.set(o,i),this.liveWaveforms.set(o,new Float32Array(1024)),b.debug("DynamicWaveformVisualizer",`Created analyser for ${o}`,null,"waveform"))})}setupSingleAnalyser(t){const e=Wi();if(!e)return;const o=e.createWaveformAnalyzer?.(t);o&&(this.liveAnalysers.set(t,o),this.liveWaveforms.set(t,new Float32Array(1024)),b.debug("DynamicWaveformVisualizer",`Created single analyser for ${t}`,null,"waveform"))}getActivePlayingColors(){const t=new Set,e=l.state.placedNotes;l.state.isPlaying&&e.forEach(i=>{!i.isDrum&&i.color&&t.add(i.color)}),t.size===0&&this.currentColor&&t.add(this.currentColor);const o=Array.from(t);return b.debug("DynamicWaveformVisualizer","Active playing colors detected",o,"waveform"),o}animateLiveWaveforms(){if(!this.isPlaybackActive)return;this.frameSkipCounter++;const t=Math.max(1,Math.floor(100/Math.max(this.animationSpeed,1)));if(this.frameSkipCounter%t!==0){this.playbackAnimationId=requestAnimationFrame(()=>this.animateLiveWaveforms());return}this.liveAnalysers.forEach((e,o)=>{const i=e.getValue();this.liveWaveforms.set(o,i)}),this.onWaveformUpdate?.(),this.playbackAnimationId=requestAnimationFrame(()=>this.animateLiveWaveforms())}drawLiveWaveforms(t,e,o){if(!this.ctx)return;const s=Array.from(this.liveWaveforms.keys());if(s.length===1){const a=s[0];if(!a)return;const r=this.liveWaveforms.get(a);this.drawSingleLiveWaveform(r,a,t,e,o)}else s.length>1&&s.forEach(a=>{if(!a)return;const r=this.liveWaveforms.get(a);this.drawLayeredLiveWaveform(r,a,t,e,o,s.length)})}drawSingleLiveWaveform(t,e,o,i,s){const a=this.ctx;if(!a||!t||t.length===0)return;const r=Ua();let c=s;if(r){const v=r.getTremoloAmplitudeMultiplier(e);c*=v}let d=0;const u=r?.vibratoCanvasEffect,h=u?.animations.get(e);u&&h&&u.shouldBeRunning()&&(d=Math.sin(h.phase)*h.amplitude*.4);let m=0;for(let v=0;v<t.length;v++){const w=t[v]??0;m=Math.max(m,Math.abs(w))}const g=m>1?1/m:1;a.strokeStyle=e,a.lineWidth=2,a.beginPath();const p=t.length/o*(1+d);for(let v=0;v<o;v++){const w=d*o*.3,y=v+w,C=Math.floor(y*p),P=Math.max(0,Math.min(t.length-1,C)),T=(t[P]??0)*g,M=i-T*c;v===0?a.moveTo(v,M):a.lineTo(v,M)}a.stroke(),b.debug("DynamicWaveformVisualizer",`Drew single live waveform for ${e} with tremolo and vibrato stretch`,{amplitudeRatio:c/s,vibratoStretch:d},"waveform")}drawLayeredLiveWaveform(t,e,o,i,s,a){const r=this.ctx;if(!r||!t||t.length===0)return;const c=Ua();let d=s;c&&(d*=c.getTremoloAmplitudeMultiplier(e));let u=0;const h=c?.vibratoCanvasEffect,m=h?.animations.get(e);h&&m&&h.shouldBeRunning()&&(u=Math.sin(m.phase)*m.amplitude*.4);let g=0;for(let y=0;y<t.length;y++){const C=t[y]??0;g=Math.max(g,Math.abs(C))}const f=g>1?1/g:1,p=Math.max(.4,1/a);r.strokeStyle=be(e,p*2),r.lineWidth=1.5,r.beginPath();const w=t.length/o*(1+u);for(let y=0;y<o;y++){const C=u*o*.3,P=y+C,T=Math.floor(P*w),M=Math.max(0,Math.min(t.length-1,T)),A=(t[M]??0)*f,x=i-A*d*.7;y===0?r.moveTo(y,x):r.lineTo(y,x)}r.stroke()}isLiveMode(){return this.isPlaybackActive}getLiveColors(){return Array.from(this.liveWaveforms.keys())}dispose(){this.stopLiveVisualization(),b.info("DynamicWaveformVisualizer","Disposed",null,"waveform")}}const I0=512,Qe=360,Rn=480,L0=()=>window.animationEffectsManager;b.moduleLoaded("StaticWaveformVisualizer");class k0{canvas=null;ctx=null;currentColor=null;animationFrameId=null;waveformData=new Float32Array(I0);isInitialized=!1;isTransitioning=!1;transitionStartTime=0;transitionDuration=300;fromWaveform=null;toWaveform=null;transitionAnimationId=null;dynamicVisualizer=new T0;animationSpeed=100;frameSkipCounter=0;resizeObserver=null;calculatedAmplitude=0;constructor(){b.info("StaticWaveformVisualizer","Initialized with dynamic visualizer integration",null,"waveform")}initialize(){if(this.canvas=document.getElementById("static-waveform-canvas"),!this.canvas)return!1;const t=this.canvas.getContext("2d");if(!t)return!1;this.ctx=t,this.currentColor=l.state.selectedNote?.color||"#4a90e2";const e=this.canvas.parentElement;return e&&typeof ResizeObserver<"u"&&(this.resizeObserver?.disconnect(),this.resizeObserver=new ResizeObserver(()=>this.resize()),this.resizeObserver.observe(e)),this.resize(),this.setupEventListeners(),this.dynamicVisualizer.initialize(this.canvas,this.ctx),this.dynamicVisualizer.onWaveformUpdate=()=>this.draw(),this.generateWaveform(),this.isInitialized=!0,!0}resize(){if(!this.canvas||!this.ctx)return;const t=this.canvas.parentElement;if(!t)return;const{clientWidth:e,clientHeight:o}=t,i=this.canvas.width,s=this.canvas.height;if((e===0||o===0)&&this.canvas.width>0&&this.canvas.height>0)return;const r=Math.abs(e-i),c=Math.abs(o-s);(r>2||c>2)&&(this.canvas.width=e,this.canvas.height=o,this.draw())}setupEventListeners(){l.on("noteChanged",(e={})=>{const o=e.newNote?.color;o&&o!==this.currentColor&&(this.currentColor=o,this.generateWaveform())}),l.on("timbreChanged",e=>{e&&e===this.currentColor&&this.generateWaveform()}),l.on("waveformExtendedViewChanged",()=>{this.generateWaveform(),this.updateToggleButton()}),document.querySelectorAll(".tab-button").forEach(e=>{e.addEventListener("click",()=>{e.dataset.tab==="timbre"&&setTimeout(()=>this.resize(),100)})}),this.setupSpeedControls(),this.setupExtendToggle()}setupSpeedControls(){const t=Array.from(document.querySelectorAll(".waveform-speed-btn"));t.length!==0&&t.forEach(e=>{e.addEventListener("click",()=>{const o=e.dataset.speed,i=o?parseInt(o,10):NaN;Number.isFinite(i)&&(e.classList.contains("active")?(e.classList.remove("active"),this.setAnimationSpeed(100)):(t.forEach(s=>s.classList.remove("active")),e.classList.add("active"),this.setAnimationSpeed(i)))})})}setAnimationSpeed(t){Number.isFinite(t)&&(this.animationSpeed=t,this.frameSkipCounter=0,this.dynamicVisualizer.setAnimationSpeed(t))}setupExtendToggle(){const t=document.getElementById("waveform-extend-toggle");t instanceof HTMLElement&&(t.addEventListener("click",()=>{l.toggleWaveformExtendedView()}),this.updateToggleButton())}updateToggleButton(){const t=document.getElementById("waveform-extend-toggle");if(!(t instanceof HTMLElement))return;const e=l.state.waveformExtendedView;t.classList.toggle("extended",e),t.textContent=e?"480 View":"360 View",t.title=e?"Switch to 360 waveform view":"Switch to 480 waveform view (shows extra 120)"}generateWaveform(){if(this.isTransitioning||!this.currentColor)return;const t=l.state.timbres[this.currentColor];if(!t?.coeffs)return;const e=is(this.currentColor),o=t.phases??new Float32Array(wn),i=this.waveformData.length;this.waveformData.fill(0);let s=0;for(let a=0;a<i;a++){const c=(l.state.waveformExtendedView?Rn:Qe)/Qe,d=a/i*c*2*Math.PI;let u=0;for(let h=0;h<wn;h++){const m=e[h]??0;if(m<=.001)continue;const g=o[h]??0,f=h+1;u+=m*Math.sin(f*d+g)}this.waveformData[a]=u,s=Math.max(s,Math.abs(u))}if(this.calculatedAmplitude=Math.min(1,s),s>1){const a=1/s;for(let r=0;r<this.waveformData.length;r++){const c=this.waveformData[r]??0;this.waveformData[r]=c*a}}this.draw()}startPhaseTransition(t,e,o){!this.isInitialized||!this.currentColor||(this.isTransitioning&&this.transitionAnimationId&&cancelAnimationFrame(this.transitionAnimationId),this.fromWaveform=new Float32Array(this.waveformData),this.generateTargetWaveform(e),this.toWaveform=new Float32Array(this.waveformData),this.waveformData=this.fromWaveform,this.isTransitioning=!0,this.transitionStartTime=performance.now(),this.animateTransition())}generateTargetWaveform(t){if(!this.currentColor||!t||!l.state.timbres[this.currentColor]?.coeffs)return;const o=is(this.currentColor),i=t instanceof Float32Array?t:new Float32Array(t),s=this.waveformData.length;this.waveformData.fill(0);let a=0;for(let r=0;r<s;r++){const d=(l.state.waveformExtendedView?Rn:Qe)/Qe,u=r/s*d*2*Math.PI;let h=0;for(let m=0;m<wn;m++){const g=o[m]??0;if(g<=.001)continue;const f=i[m]??0,p=m+1;h+=g*Math.sin(p*u+f)}this.waveformData[r]=h,a=Math.max(a,Math.abs(h))}if(this.calculatedAmplitude=Math.min(1,a),a>1){const r=1/a;for(let c=0;c<this.waveformData.length;c++){const d=this.waveformData[c]??0;this.waveformData[c]=d*r}}}animateTransition(){const t=this.fromWaveform,e=this.toWaveform;if(!this.isTransitioning||!t||!e)return;const o=performance.now()-this.transitionStartTime,i=Math.min(o/this.transitionDuration,1),s=1-Math.pow(1-i,3);for(let a=0;a<this.waveformData.length;a++){const r=t[a]??0,c=e[a]??0;this.waveformData[a]=r+(c-r)*s}this.draw(),i>=1?(this.isTransitioning=!1,this.fromWaveform=null,this.toWaveform=null,this.transitionAnimationId=null):this.transitionAnimationId=requestAnimationFrame(()=>this.animateTransition())}normalizeWaveform(){let t=0;for(let e=0;e<this.waveformData.length;e++){const o=this.waveformData[e]??0;t=Math.max(t,Math.abs(o))}if(t>0){const e=.9/t;for(let o=0;o<this.waveformData.length;o++){const i=this.waveformData[o]??0;this.waveformData[o]=i*e}}}draw(){const t=this.ctx,e=this.canvas;if(!t||!e)return;const{width:o,height:i}=e,s=i/2,a=i/2;t.fillStyle="#ffffff",t.fillRect(0,0,o,i),this.drawGrid(o,i,s,a),this.dynamicVisualizer.isLiveMode()?this.dynamicVisualizer.drawLiveWaveforms(o,s,a):this.drawWaveform(o,s,a),o>200&&i>100&&this.drawLabels(o,i)}drawGrid(t,e,o,i){const s=this.ctx;if(!s)return;s.strokeStyle="#ced4da",s.lineWidth=1,s.setLineDash([2,2]),s.beginPath(),s.moveTo(0,o),s.lineTo(t,o),s.stroke();const a=l.state.waveformExtendedView?Rn:Qe;if((l.state.waveformExtendedView?[90,180,270,360,450]:[90,180,270]).forEach(h=>{const m=t/a*h;s.beginPath(),s.moveTo(m,0),s.lineTo(m,e),s.stroke()}),l.state.waveformExtendedView){const h=t/Rn*Qe;s.fillStyle="rgba(128, 128, 128, 0.15)",s.fillRect(h,0,t-h,e)}[.5].forEach(h=>{const m=o-i*h,g=o+i*h;s.beginPath(),s.moveTo(0,m),s.lineTo(t,m),s.moveTo(0,g),s.lineTo(t,g),s.stroke()}),s.setLineDash([]),s.strokeStyle="#999999",s.lineWidth=1;const d=o-i,u=o+i;s.beginPath(),s.moveTo(0,d),s.lineTo(t,d),s.stroke(),s.beginPath(),s.moveTo(0,u),s.lineTo(t,u),s.stroke()}drawWaveform(t,e,o){const i=this.ctx;if(!i||this.waveformData.length===0)return;const s=this.currentColor||"#4a90e2";i.strokeStyle=s,i.lineWidth=2,i.beginPath();const a=this.waveformData.length/t;for(let c=0;c<t;c++){const d=Math.floor(c*a),u=this.waveformData[d]||0,h=e-u*o;c===0?i.moveTo(c,h):i.lineTo(c,h)}i.stroke(),i.lineTo(t,e),i.lineTo(0,e),i.closePath();const r=i.createLinearGradient(0,e-o,0,e+o);r.addColorStop(0,be(s,.3)),r.addColorStop(.5,be(s,.1)),r.addColorStop(1,be(s,.3)),i.fillStyle=r,i.fill()}drawLabels(t,e){const o=this.ctx;if(!o)return;const i=l.state.waveformExtendedView,s=i?Rn:Qe,a=i?["0","90","180","270","360","450"]:["0","90","180","270","360"],r=i?[0,90,180,270,360,450]:[0,90,180,270,360];o.fillStyle="#666666",o.font='12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',o.textAlign="center",a.forEach((c,d)=>{const u=r[d]??0,h=t/s*u+10;o.fillText(c,h,e/2+4)}),o.textAlign="left",o.fillText("+1.0",5,15),o.fillText("-1.0",5,e-8)}getNormalizedAmplitude(){return this.calculatedAmplitude||0}getADSRTremoloAmplitude(){const t=this.calculatedAmplitude||0,e=L0();if(this.currentColor&&e?.getADSRTremoloAmplitudeMultiplier){const o=e.getADSRTremoloAmplitudeMultiplier(this.currentColor);return t*o}return t}startSingleNoteVisualization(t){this.dynamicVisualizer.startSingleNoteVisualization(t)}stopLiveVisualization(){this.dynamicVisualizer.stopLiveVisualization()}startLiveVisualization(){this.dynamicVisualizer.startLiveVisualization()}dispose(){this.dynamicVisualizer.dispose(),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.transitionAnimationId&&(cancelAnimationFrame(this.transitionAnimationId),this.transitionAnimationId=null),this.resizeObserver?.disconnect(),this.resizeObserver=null,this.isTransitioning=!1,this.fromWaveform=null,this.toWaveform=null,this.isInitialized=!1}}const fl=new k0;window.waveformVisualizer=fl;function N0(){return fl.initialize()}class Os{effectName;animations;activeNoteAnimations;ghostNoteAnimation;activeSoundingNotes;isPlaybackActive;hasActiveInteraction;hasDialInteraction;constructor(t){this.effectName=t,this.animations=new Map,this.activeNoteAnimations=new Map,this.ghostNoteAnimation=null,this.activeSoundingNotes=new Map,this.isPlaybackActive=!1,this.hasActiveInteraction=!1,this.hasDialInteraction=!1,b.info(`${t}AnimationEffect`,"Base initialized",null,"animation")}initBase(){l.on("visualEffectChanged",t=>{if(!t)return;const{effectType:e,color:o,effectParams:i}=t;e===this.effectName.toLowerCase()&&this.updateAnimationParameters(o,i)}),l.on("playbackStarted",()=>{this.isPlaybackActive=!0,this.requestAnimationStateUpdate()}),l.on("playbackStopped",()=>{this.isPlaybackActive=!1,this.activeNoteAnimations.clear(),this.activeSoundingNotes.clear(),this.requestAnimationStateUpdate()}),l.on("noteInteractionStart",t=>{t&&this.onNoteInteractionStart(t.noteId,t.color)}),l.on("noteInteractionEnd",t=>{const e=t?.noteId;e&&this.onNoteInteractionEnd(e)}),l.on("ghostNoteUpdated",t=>{t&&this.onGhostNoteUpdated(t.color)}),l.on("ghostNoteCleared",()=>this.onGhostNoteCleared()),l.on("spacebarPlayback",t=>{t&&(this.isPlaybackActive=t.isPlaying,this.requestAnimationStateUpdate())}),l.on("noteAttack",t=>{t&&this.onNoteAttack(t.noteId,t.color)}),l.on("noteRelease",t=>{t&&this.onNoteRelease(t.noteId,t.color)}),l.on("effectDialInteractionStart",t=>{t&&t.effectType===this.effectName.toLowerCase()&&this.onDialInteractionStart(t.color)}),l.on("effectDialInteractionEnd",t=>{t&&t.effectType===this.effectName.toLowerCase()&&this.onDialInteractionEnd(t.color)}),b.info(`${this.effectName}AnimationEffect`,"Base event subscriptions established",null,"animation")}shouldAnimateColor(t){return this.animations.has(t)}shouldAnimateNote(t){if(!t?.color||!this.shouldAnimateColor(t.color))return!1;if(this.hasDialInteraction&&this.activeNoteAnimations.has("dial-preview")){const e=this.activeNoteAnimations.get("dial-preview");if(e&&t.color===e)return!0}return!!(this.isPlaybackActive&&t.uuid&&this.activeSoundingNotes.has(t.uuid)||this.hasActiveInteraction&&t.uuid&&this.activeNoteAnimations.has(t.uuid)||!t.uuid&&this.ghostNoteAnimation&&this.ghostNoteAnimation.color===t.color&&this.isPlaybackActive)}shouldBeRunning(){const t=this.animations.size>0;return t?!!(this.isPlaybackActive||this.hasActiveInteraction||this.hasDialInteraction||this.ghostNoteAnimation!==null||t):!1}onNoteInteractionStart(t,e){this.shouldAnimateColor(e)&&(this.activeNoteAnimations.set(t,e),this.hasActiveInteraction=!0,b.debug(`${this.effectName}AnimationEffect`,`Started interaction animation for note ${t} (${e})`,null,"animation"),this.requestAnimationStateUpdate())}onNoteInteractionEnd(t){this.activeNoteAnimations.delete(t),this.hasActiveInteraction=this.activeNoteAnimations.size>0,b.debug(`${this.effectName}AnimationEffect`,`Ended interaction animation for note ${t}`,null,"animation"),this.requestAnimationStateUpdate()}onGhostNoteUpdated(t){this.shouldAnimateColor(t)?(this.ghostNoteAnimation={color:t,active:!0},b.debug(`${this.effectName}AnimationEffect`,`Ghost note animation updated for color ${t}`,null,"animation")):this.ghostNoteAnimation=null}onGhostNoteCleared(){this.ghostNoteAnimation=null,b.debug(`${this.effectName}AnimationEffect`,"Ghost note animation cleared",null,"animation")}onNoteAttack(t,e){this.shouldAnimateColor(e)&&(this.activeSoundingNotes.set(t,e),b.debug(`${this.effectName}AnimationEffect`,`Note attack: ${t} (${e}) added to active sounding notes`,null,"animation"),this.requestAnimationStateUpdate())}onNoteRelease(t,e){this.activeSoundingNotes.delete(t),b.debug(`${this.effectName}AnimationEffect`,`Note release: ${t} (${e}) removed from active sounding notes`,null,"animation"),this.requestAnimationStateUpdate()}onDialInteractionStart(t){this.shouldAnimateColor(t)&&(this.hasDialInteraction=!0,this.activeNoteAnimations.set("dial-preview",t),b.debug(`${this.effectName}AnimationEffect`,`Dial interaction started for ${t}`,null,"animation"),this.requestAnimationStateUpdate())}onDialInteractionEnd(t){this.hasDialInteraction=!1,this.activeNoteAnimations.delete("dial-preview"),b.debug(`${this.effectName}AnimationEffect`,`Dial interaction ended for ${t}`,null,"animation"),this.requestAnimationStateUpdate()}getActiveColors(){const t=new Set;for(const[,e]of this.activeSoundingNotes.entries())this.shouldAnimateColor(e)&&t.add(e);for(const[,e]of this.activeNoteAnimations.entries())this.shouldAnimateColor(e)&&t.add(e);return this.ghostNoteAnimation&&this.shouldAnimateColor(this.ghostNoteAnimation.color)&&t.add(this.ghostNoteAnimation.color),Array.from(t)}disposeBase(){this.animations.clear(),this.activeNoteAnimations.clear(),this.activeSoundingNotes.clear(),this.ghostNoteAnimation=null,b.info(`${this.effectName}AnimationEffect`,"Base disposed",null,"animation")}requestAnimationStateUpdate(){window.animationEffectsManager?.updateAnimationState()}}b.moduleLoaded("VibratoCanvasEffect");class R0 extends Os{constructor(){super("Vibrato"),b.info("VibratoCanvasEffect","Initialized for canvas note positions",null,"animation")}init(){return this.initBase(),b.info("VibratoCanvasEffect","Ready for canvas animation",null,"animation"),!0}updateAnimationParameters(t,e){const{speed:o,span:i}=e;if(o===0||i===0)this.animations.delete(t),b.debug("VibratoCanvasEffect",`Disabled vibrato animation for ${t}`,null,"animation");else{const s=this.animations.get(t),a=o/100*16,r=i/100*.5,c={frequency:a,amplitude:r,phase:s?.phase||0,lastUpdate:performance.now()};this.animations.set(t,c),b.debug("VibratoCanvasEffect",`Updated vibrato animation for ${t}`,{frequency:a,amplitude:r,preservedPhase:!!s},"animation")}}updateAnimationPhases(t){this.animations.forEach(e=>{const o=(t-e.lastUpdate)/1e3;e.phase+=e.frequency*o*2*Math.PI,e.lastUpdate=t,e.phase>4*Math.PI&&(e.phase-=4*Math.PI)})}getVibratoYOffset(t){if(!t)return 0;const e=this.animations.get(t);if(!e||window.animationEffectsManager&&!window.animationEffectsManager.shouldVibratoBeRunning())return 0;const o=Math.sin(e.phase),i=-o*e.amplitude;return b.debug("VibratoCanvasEffect","Visual vibrato",{sine:o.toFixed(3),offset:i.toFixed(3),phase:e.phase.toFixed(3)},"effects"),i}shouldBeRunning(){return this.animations.size>0?this.isPlaybackActive||this.hasActiveInteraction||this.hasDialInteraction||this.ghostNoteAnimation!==null&&this.isPlaybackActive:!1}shouldAnimateColor(t){const e=this.animations.get(t);return e?e.frequency>0&&e.amplitude>0:!1}dispose(){this.disposeBase(),b.info("VibratoCanvasEffect","Disposed",null,"animation")}}b.moduleLoaded("TremoloWaveformEffect");class B0 extends Os{constructor(){super("Tremolo"),b.info("TremoloWaveformEffect","Initialized for waveform/ADSR amplitude",null,"animation")}init(){return this.initBase(),b.info("TremoloWaveformEffect","Ready for waveform/ADSR animation",null,"animation"),!0}updateAnimationParameters(t,e){const{speed:o,span:i}=e;if(o===0||i===0)this.animations.delete(t),b.debug("TremoloWaveformEffect",`Disabled tremolo animation for ${t}`,null,"animation");else{const s=this.animations.get(t),a=o/100*16,r=i/100,c=window.Tone?.now?.(),d=typeof c=="number"?c*1e3:performance.now(),u={frequency:a,span:r,phase:s?.phase||0,lastUpdate:d};this.animations.set(t,u),b.debug("TremoloWaveformEffect",`Updated tremolo animation for ${t}`,{frequency:a,span:r,preservedPhase:!!s},"animation")}}updateAnimationPhases(t){let e=0;const o=window.Tone?.now?.(),i=typeof o=="number"?o*1e3:t;if(this.animations.forEach((s,a)=>{const r=(i-s.lastUpdate)/1e3,c=s.phase;s.phase+=s.frequency*r*2*Math.PI,s.lastUpdate=i,e++,Math.abs(s.phase-c)<.001&&b.warn("TremoloWaveformEffect",`Phase not advancing for ${a}`,{deltaSeconds:Number(r.toFixed(4)),frequency:s.frequency},"animation"),s.phase>4*Math.PI&&(s.phase-=4*Math.PI)}),e>0&&Math.random()<.05){const s=window.Tone?.now?"Tone.js":"performance";b.debug("TremoloWaveformEffect","Timing sample",{hasTone:!!window.Tone,hasToneNow:!!window.Tone?.now,toneTime:i,currentTime:t,timingSource:s},"animation")}}getTremoloAmplitudeMultiplier(t){const e=this.animations.get(t);if(!e||window.animationEffectsManager&&!window.animationEffectsManager.shouldTremoloBeRunning())return 1;const o=window.waveformVisualizer?.calculatedAmplitude??1,i=Math.sin(e.phase),s=e.span,a=o,r=o*(1-s),c=(a+r)/2,d=(a-r)/2,h=(c+i*d)/o,m=window.Tone?.now?.(),f=(typeof m=="number"?m*1e3:performance.now())-e.lastUpdate;if(f>100&&e.span>0){const p=e.frequency*(f/1e3)*2*Math.PI;p>.1&&b.warn("TremoloWaveformEffect",`Phase stagnation detected for ${t}`,{phase:Number(e.phase.toFixed(3)),millisecondsSinceUpdate:Number(f.toFixed(1)),expectedAdvancement:Number(p.toFixed(3))},"animation")}return Math.max(0,Math.min(1,h))}getADSRTremoloAmplitudeMultiplier(t){return this.getTremoloAmplitudeMultiplier(t)}shouldAnimateColor(t){const e=this.animations.get(t);return e?e.frequency>0&&e.span>0:!1}dispose(){this.disposeBase(),b.info("TremoloWaveformEffect","Disposed",null,"animation")}}b.moduleLoaded("EnvelopeFillEffect");class D0{activeFills;instanceId;constructor(){this.activeFills=new Map,this.instanceId=Math.random().toString(36).substring(7),b.info("EnvelopeFillEffect","Initialized",null,"animation")}init(){l.on("noteAttack",t=>{const e=t?.noteId,o=t?.color;if(!e||!o)return;const i=l.state.timbres?.[o];if(!i){b.warn("EnvelopeFillEffect","No timbre found for color",{color:o},"effects");return}this.activeFills.set(e,{fillLevel:0,color:o,startTime:Rt(),adsr:i.adsr,phase:"attack"}),b.debug("EnvelopeFillEffect",`Started fill animation for note ${e}`,null,"animation"),window.animationEffectsManager?.updateAnimationState()}),l.on("noteRelease",t=>{const e=t?.noteId;if(!e)return;const o=this.activeFills.get(e);o?(o.phase="release",o.releaseStartTime=Rt(),o.releaseStartLevel=o.fillLevel,b.debug("EnvelopeFillEffect",`Started release phase for note ${e}`,null,"animation")):b.warn("EnvelopeFillEffect","No fill data found for release",{noteId:e},"effects")}),l.on("playbackStopped",()=>{this.activeFills.clear(),window.animationEffectsManager?.updateAnimationState(),l.emit("animationUpdate",{type:"envelopeFill",activeColors:[],hasEnvelopeFills:!1})}),b.info("EnvelopeFillEffect","Event subscriptions established",null,"animation")}updateAnimationPhases(t){const e=Rt();for(const[o,i]of this.activeFills.entries()){const{adsr:s,startTime:a,phase:r,releaseStartTime:c,releaseStartLevel:d}=i,u=e-a;if(r==="attack"){const h=s.attack||.01;u<h?i.fillLevel=u/h:(i.phase="decay",i.decayStartTime=e)}else if(r==="decay"){const h=s.decay||.1,m=e-(i.decayStartTime??e),g=s.sustain??.5;if(m<h){const f=m/h;i.fillLevel=1-f*(1-g)}else i.phase="sustain",i.fillLevel=g}else if(r==="sustain"){const h=s.sustain??.5;i.fillLevel=h}else if(r==="release"){const h=s.release||.5,m=c?e-c:0,g=d??i.fillLevel;if(m<h){const f=m/h;i.fillLevel=g*(1-f)}else this.activeFills.delete(o),b.debug("EnvelopeFillEffect",`Completed fill animation for note ${o}`,null,"animation"),this.activeFills.size===0&&window.animationEffectsManager?.updateAnimationState()}}}getFillLevel(t){if(!t.uuid)return 0;const e=this.activeFills.get(t.uuid);return e?e.fillLevel:0}shouldFillNote(t){return t.uuid?this.activeFills.has(t.uuid):!1}shouldBeRunning(){return this.activeFills.size>0}dispose(){this.activeFills.clear(),b.info("EnvelopeFillEffect","Disposed",null,"animation")}}b.moduleLoaded("DelayADSREffect");class F0 extends Os{constructor(){super("Delay"),b.info("DelayADSREffect","Initialized for delay visualization (PLACEHOLDER)",null,"animation")}init(){return this.initBase(),b.info("DelayADSREffect","Ready for delay animation (PLACEHOLDER)",null,"animation"),!0}updateAnimationParameters(t,e){const{time:o,feedback:i}=e;if(o===0&&i===0)this.animations.delete(t),b.debug("DelayADSREffect",`Disabled delay animation for ${t}`,null,"animation");else{const s=o/100*500,a=i/100,r={delayTime:s,feedback:a,echoCount:Math.floor(a*5),lastTrigger:0,echoPhases:[],lastUpdate:performance.now()};this.animations.set(t,r),b.debug("DelayADSREffect",`Updated delay animation for ${t} (PLACEHOLDER)`,{delayTime:s,feedback:a},"animation")}}updateAnimationPhases(t){this.animations.forEach(e=>{e.lastUpdate=t})}getDelayEffects(t){const e=this.animations.get(t);if(!e)return[];const o=[];for(let i=0;i<e.echoCount;i++)o.push({delay:e.delayTime*(i+1),opacity:1-i*.3,scale:1-i*.1,active:!1});return o}triggerDelay(t,e){const o=this.animations.get(t);o&&(o.lastTrigger=e,b.debug("DelayADSREffect",`Triggered delay for ${t} (PLACEHOLDER)`,null,"animation"))}shouldBeRunning(){return this.animations.size>0?this.isPlaybackActive||this.hasActiveInteraction||this.ghostNoteAnimation!==null:!1}shouldAnimateColor(t){const e=this.animations.get(t);return e?e.delayTime>0||e.feedback>0:!1}dispose(){this.disposeBase(),b.info("DelayADSREffect","Disposed",null,"animation")}}b.moduleLoaded("AnimationEffectsManager");class W0{vibratoEffect;tremoloEffect;envelopeFillEffect;delayEffect;isRunning;animationFrameId;lastTime;lastRenderTrigger;constructor(){this.vibratoEffect=new R0,this.tremoloEffect=new B0,this.envelopeFillEffect=new D0,this.delayEffect=new F0,this.isRunning=!1,this.animationFrameId=null,this.lastTime=0,this.lastRenderTrigger=0,b.info("AnimationEffectsManager","Initialized with single animation loop",null,"animation")}init(){return this.vibratoEffect.init(),this.tremoloEffect.init(),this.envelopeFillEffect.init(),this.delayEffect.init(),l.on("visualEffectChanged",t=>{const e=t?.effectType;(e==="vibrato"||e==="tremolo")&&(setTimeout(()=>this.updateAnimationState(),0),e==="tremolo"&&setTimeout(()=>this.triggerTremoloAmplitudeUpdate(),0))}),l.on("audioEffectChanged",t=>{if(!t)return;const{effectType:e,color:o,effectParams:i}=t;!o||!i||e==="delay"&&this.delayEffect.updateAnimationParameters(o,i)}),b.info("AnimationEffectsManager","Event subscriptions established",null,"animation"),!0}animate(t){this.isRunning&&(this.lastTime=t,this.vibratoEffect.updateAnimationPhases(t),this.tremoloEffect.updateAnimationPhases(t),this.envelopeFillEffect.updateAnimationPhases(t),this.triggerVisualUpdates(t),this.animationFrameId=requestAnimationFrame(e=>this.animate(e)))}start(){this.isRunning||(this.isRunning=!0,this.lastTime=performance.now(),this.animationFrameId=requestAnimationFrame(t=>this.animate(t)),b.debug("AnimationEffectsManager","Single animation loop started",null,"animation"))}stop(){this.isRunning&&(this.isRunning=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.triggerFinalUpdates(),b.debug("AnimationEffectsManager","Animation loop stopped",null,"animation"))}shouldTremoloBeRunning(){if(!(this.tremoloEffect.animations.size>0))return!1;const e=this.tremoloEffect.activeSoundingNotes.size>0,o=this.tremoloEffect.hasDialInteraction;return e||o}shouldVibratoBeRunning(){return this.vibratoEffect.animations.size>0?this.vibratoEffect.isPlaybackActive||this.vibratoEffect.hasActiveInteraction||this.vibratoEffect.hasDialInteraction||this.vibratoEffect.ghostNoteAnimation!==null:!1}shouldEnvelopeFillBeRunning(){return this.envelopeFillEffect.shouldBeRunning()}updateAnimationState(){const t=this.shouldVibratoBeRunning(),e=this.shouldTremoloBeRunning(),o=this.shouldEnvelopeFillBeRunning(),i=t||e||o;i&&!this.isRunning?this.start():!i&&this.isRunning&&this.stop()}triggerVisualUpdates(t){if(!this.lastRenderTrigger||t-this.lastRenderTrigger>=16.67){this.lastRenderTrigger=t;const e=this.vibratoEffect.getActiveColors(),o=this.tremoloEffect.getActiveColors(),i=this.envelopeFillEffect.activeFills.size>0;(e.length>0||i)&&l.emit("animationUpdate",{type:e.length>0?"vibrato":"envelopeFill",activeColors:e,hasEnvelopeFills:i}),o.length>0&&l.emit("tremoloAmplitudeUpdate",{activeColors:o})}}triggerFinalUpdates(){const t=Array.from(this.vibratoEffect.animations.keys());t.length>0&&l.emit("animationUpdate",{type:"vibrato",activeColors:t});const e=Array.from(this.tremoloEffect.animations.keys());e.length>0&&l.emit("tremoloAmplitudeUpdate",{activeColors:e})}shouldAnimateNote(t){return this.vibratoEffect.shouldAnimateNote(t)}getVibratoYOffset(t){return this.vibratoEffect.getVibratoYOffset(t)}getTremoloAmplitudeMultiplier(t){return this.tremoloEffect.getTremoloAmplitudeMultiplier(t)}getADSRTremoloAmplitudeMultiplier(t){return this.tremoloEffect.getADSRTremoloAmplitudeMultiplier(t)}getFillLevel(t){return this.envelopeFillEffect.getFillLevel(t)}shouldFillNote(t){return this.envelopeFillEffect.shouldFillNote(t)}getDelayEffects(t){return this.delayEffect.getDelayEffects(t)}hasDelayEffect(t){return this.delayEffect.shouldAnimateColor(t)}triggerTremoloAmplitudeUpdate(){const t=this.tremoloEffect.getActiveColors();t.length>0&&l.emit("tremoloAmplitudeUpdate",{activeColors:t})}getAllActiveColors(){const t=this.vibratoEffect.getActiveColors(),e=this.tremoloEffect.getActiveColors();return[...new Set([...t,...e])]}dispose(){this.stop(),this.vibratoEffect.dispose(),this.tremoloEffect.dispose(),this.envelopeFillEffect.dispose(),this.delayEffect.dispose(),b.info("AnimationEffectsManager","Disposed",null,"animation")}}const Xa=new W0;b.moduleLoaded("VibratoAudioEffect");class O0{currentSettings=new Map;constructor(){b.info("VibratoAudioEffect","Initialized",null,"audio")}init(){return b.info("VibratoAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(t,e){const{speed:o,span:i}=t;this.currentSettings.set(e,{speed:o,span:i}),b.debug("VibratoAudioEffect",`Updated parameters for ${e}`,{speed:o,span:i},"audio")}applyToVoice(t,e){if(!t||typeof t._setVibrato!="function")return;const o=this.currentSettings.get(e);if(!o){b.debug("VibratoAudioEffect",`No vibrato settings found for color ${e}`,null,"audio");return}try{t._setVibrato(o),t.vibratoApplied=!0,b.debug("VibratoAudioEffect",`Applied vibrato to voice for ${e}`,o,"audio")}catch(i){b.warn("VibratoAudioEffect",`Failed to apply vibrato to voice for ${e}`,i,"audio")}}getCurrentSettings(t){return this.currentSettings.get(t)??{speed:0,span:0}}getEffectInstance(){return null}createVibratoSettings(t,e){if(t===0||e===0)return null;const o=t/100*16,i=e/100*50;return{frequency:o,depth:i}}disableForColor(t){this.updateParameters({speed:0,span:0},t)}dispose(){this.currentSettings.clear(),b.info("VibratoAudioEffect","Disposed",null,"audio")}}b.moduleLoaded("TremoloAudioEffect");class _0{currentSettings=new Map;constructor(){b.info("TremoloAudioEffect","Initialized",null,"audio")}init(){return b.info("TremoloAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(t,e){const{speed:o,span:i}=t;this.currentSettings.set(e,{speed:o,span:i}),b.debug("TremoloAudioEffect",`Updated parameters for ${e}`,{speed:o,span:i},"audio")}applyToVoice(t,e){if(!t||typeof t._setTremolo!="function")return;const o=this.currentSettings.get(e);if(!o){b.debug("TremoloAudioEffect",`No tremolo settings found for color ${e}`,null,"audio");return}try{t._setTremolo(o),t.tremoloApplied=!0,b.debug("TremoloAudioEffect",`Applied tremolo to voice for ${e}`,o,"audio")}catch(i){b.warn("TremoloAudioEffect",`Failed to apply tremolo to voice for ${e}`,i,"audio")}}getCurrentSettings(t){return this.currentSettings.get(t)??{speed:0,span:0}}getEffectInstance(){return null}createTremoloSettings(t,e){if(t===0||e===0)return null;const o=t/100*16,i=e/100;return{frequency:o,depth:i}}disableForColor(t){this.updateParameters({speed:0,span:0},t)}dispose(){this.currentSettings.clear(),b.info("TremoloAudioEffect","Disposed",null,"audio")}}b.moduleLoaded("DelayAudioEffect");const z0=()=>window.synthEngine;class $0{currentSettings=new Map;delayInstances=new Map;init(){return b.info("DelayAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(t,e){const{time:o,feedback:i,wet:s}=t;this.currentSettings.set(e,{time:o,feedback:i,wet:s}),b.debug("DelayAudioEffect",`Updated parameters for ${e}`,{time:o,feedback:i,wet:s},"audio");let a=this.delayInstances.get(e);a?this.updateDelayInstance(a,o,i,s):s>0&&(a=this.createDelayInstance(o,i,s),a&&(this.delayInstances.set(e,a),b.debug("DelayAudioEffect",`Created new delay instance for ${e}`,{time:o,feedback:i,wet:s},"audio"),z0()?.updateSynthForColor?.(e)))}applyToVoice(t,e){if(!t)return;const o=this.currentSettings.get(e);if(!(!o||o.time===0&&o.feedback===0))try{let i=this.delayInstances.get(e);if(!i){if(i=this.createDelayInstance(o.time,o.feedback,o.wet),!i)return;this.delayInstances.set(e,i)}if(typeof t.isDisposed=="function"&&t.isDisposed())return;try{t.connect?.(i)}catch{t.output?.connect?.(i)}b.debug("DelayAudioEffect",`Applied delay to voice for ${e}`,o,"audio")}catch(i){b.warn("DelayAudioEffect",`Failed to apply delay to voice for ${e}`,i,"audio")}}getCurrentSettings(t){return this.currentSettings.get(t)??{time:0,feedback:0,wet:0}}getEffectInstance(t){return this.delayInstances.get(t)??null}createDelayInstance(t,e,o=30){if(o===0)return null;const i=Math.max(.01,t/100*.5),s=Math.min(.95,e/100),a=o/100,r=new _l({delayTime:i,feedback:s,wet:a});return r._wetAmount=a,b.debug("DelayAudioEffect","Created delay instance",{delayTime:i,feedbackAmount:s,wetAmount:a},"audio"),r}updateDelayInstance(t,e,o,i=15){const s=Math.max(.01,e/100*.5),a=Math.min(.95,o/100),r=i/100;try{t.delayTime.value=s,t.feedback.value=a,t._crossFade&&(t._crossFade.fade.value=r),t._wetAmount=r,b.debug("DelayAudioEffect","Updated delay instance",{delayTime:s,feedbackAmount:a,wetAmount:r},"audio")}catch(c){b.warn("DelayAudioEffect","Failed to update delay instance",c,"audio")}}createDelaySettings(t,e,o=30){if(t===0&&e===0)return null;const i=Math.max(.01,t/100*.5),s=Math.min(.95,e/100),a=o/100;return{time:i,feedback:s,wet:a}}disableForColor(t){this.updateParameters({time:0,feedback:0,wet:0},t);const e=this.delayInstances.get(t);if(e)try{e._crossFade?.dispose(),e.dispose()}finally{this.delayInstances.delete(t)}}dispose(){this.delayInstances.forEach((t,e)=>{try{t._crossFade?.dispose(),t.dispose()}catch(o){b.warn("DelayAudioEffect",`Failed to dispose delay for ${e}`,o,"audio")}}),this.currentSettings.clear(),this.delayInstances.clear(),b.info("DelayAudioEffect","Disposed",null,"audio")}}b.moduleLoaded("AudioEffectsManager");const H0=()=>window.synthEngine;class q0{vibratoEffect=new O0;tremoloEffect=new _0;delayEffect=new $0;init(){return this.vibratoEffect.init(),this.tremoloEffect.init(),this.delayEffect.init(),l.on("audioEffectChanged",t=>{if(!t)return;const{effectType:e,parameter:o,value:i,color:s,effectParams:a}=t;this.handleAudioEffectChange(e,o,i,s,a)}),b.info("AudioEffectsManager","Event subscriptions established",null,"audio"),!0}handleAudioEffectChange(t,e,o,i,s){switch(b.debug("AudioEffectsManager",`Processing audio effect: ${t}.${e} = ${o} for ${i}`,null,"audio"),t){case"vibrato":this.vibratoEffect.updateParameters(s,i);break;case"tremolo":this.tremoloEffect.updateParameters(s,i);break;case"delay":this.delayEffect.updateParameters(s,i);break;default:b.debug("AudioEffectsManager",`Effect type ${t} not handled by audio system`,null,"audio")}}getEffectHandler(t){switch(t){case"vibrato":return this.vibratoEffect;case"tremolo":return this.tremoloEffect;case"delay":return this.delayEffect;default:return null}}applySynthEffects(t,e,o){const i=this.delayEffect.getEffectInstance(e);try{t.disconnect()}catch{}let s=t;if(i)try{s.connect(i),s=i}catch(a){b.error("AudioEffectsManager","Delay connection error",a,"audio")}try{s.connect(o);const a=H0()?.getWaveformAnalyzer?.(e);a&&t.connect(a)}catch(a){b.error("AudioEffectsManager","masterGain connection error",a,"audio")}}applyEffectsToVoice(t,e){this.vibratoEffect.applyToVoice(t,e),this.tremoloEffect.applyToVoice(t,e)}dispose(){this.vibratoEffect.dispose(),this.tremoloEffect.dispose(),this.delayEffect.dispose(),b.info("AudioEffectsManager","Disposed",null,"audio")}}const Ya=new q0;function G0(){Va("adsr-envelope","#adsr-envelope"),hf(),Va("filter-controls-bridge",document.body),b.initStart("Waveform Visualizer"),N0()?b.initSuccess("Waveform Visualizer"):b.initFailed("Waveform Visualizer"),b.initStart("Effects Managers"),Xa.init(),Ya.init(),Fe.init(),We.init();const n=window;n.effectsCoordinator=Fe,n.animationEffectsManager=Xa,n.audioEffectsManager=Ya,n.effectsController=We,b.initSuccess("Effects Managers")}function V0({cx:n,cy:t,rx:e,ry:o,stroke:i="currentColor",strokeWidth:s=3}){const a=document.createElementNS("http://www.w3.org/2000/svg","ellipse");return a.setAttribute("cx",`${n}`),a.setAttribute("cy",`${t}`),a.setAttribute("rx",`${e}`),a.setAttribute("ry",`${o}`),a.setAttribute("fill","none"),a.setAttribute("stroke",i),a.setAttribute("stroke-width",`${s}`),a.setAttribute("stroke-linecap","round"),a}function U0(n,t=48,e=48){const o=document.createElementNS("http://www.w3.org/2000/svg","svg"),i=n.span==="quarter",s=i?200:100;o.setAttribute("viewBox",`0 0 ${s} 100`),o.setAttribute("width",`${t}`),o.setAttribute("height",`${e}`),o.setAttribute("aria-label",n.label),o.style.color="#000000";const r=50,c=i?32:16,d=40,u=i?[33.33,100,166.67]:[16.67,50,83.33];return n.hits.forEach(h=>{const m=V0({cx:u[h]??0,cy:r,rx:c,ry:d,stroke:"currentColor",strokeWidth:3});o.appendChild(m)}),o}const lo={selectedTripletStampId:1,init(){this.render(),this.bindEvents(),b.info("TripletStampsToolbar","Triplet stamps toolbar initialized",null,"triplets")},render(){const n=document.getElementById("triplet-stamps-toolbar-container");if(!n){b.warn("TripletStampsToolbar","Container not found",null,"triplets");return}n.innerHTML="";const t=Oo.filter(i=>i.span==="eighth"),e=Oo.filter(i=>i.span==="quarter"),o=document.createElement("div");if(o.className="triplet-stamps-grid",t.length>0){const i=document.createElement("div");i.className="triplet-stamps-row triplet-stamps-eighth-row",t.forEach(s=>{const a=this.createTripletStampButton(s);i.appendChild(a)}),o.appendChild(i)}if(e.length>0){const i=document.createElement("div");if(i.className="triplet-stamps-row triplet-stamps-quarter-row",e.slice(0,3).forEach(s=>{const a=this.createTripletStampButton(s);a.classList.add("triplet-stamp-button-wide"),i.appendChild(a)}),o.appendChild(i),e.length>3){const s=document.createElement("div");s.className="triplet-stamps-row triplet-stamps-quarter-row",e.slice(3).forEach(a=>{const r=this.createTripletStampButton(a);r.classList.add("triplet-stamp-button-wide"),s.appendChild(r)}),o.appendChild(s)}}n.appendChild(o),this.setInitialSelection(this.selectedTripletStampId)},createTripletStampButton(n){const t=document.createElement("button");t.className="triplet-stamp-button",t.dataset.tripletStampId=`${n.id}`,t.setAttribute("title",n.label||`Triplet ${n.id}`);const o=n.span==="quarter"?80:40,s=U0(n,o,40);return s.style.width="100%",s.style.height="100%",s.style.maxWidth="100%",s.style.maxHeight="100%",t.appendChild(s),t},bindEvents(){const n=document.getElementById("triplet-stamps-toolbar-container");n&&(n.addEventListener("click",t=>{const e=t.target?.closest(".triplet-stamp-button");if(!e)return;const o=parseInt(e.dataset.tripletStampId||"",10);Number.isNaN(o)||this.selectTripletStamp(o)}),l.on("toolChanged",({newTool:t}={})=>{t&&t!=="tripletStamp"&&this.clearSelection()}),l.on("sixteenthStampToolSelected",()=>{this.clearSelection()}))},setInitialSelection(n){this.selectedTripletStampId=n;const t=document.getElementById("triplet-stamps-toolbar-container");t&&t.querySelectorAll(".triplet-stamp-button").forEach(e=>{const o=e;o.classList.toggle("active",parseInt(o.dataset.tripletStampId||"",10)===n)})},selectTripletStamp(n){this.selectedTripletStampId=n;const t=document.getElementById("triplet-stamps-toolbar-container");t&&t.querySelectorAll(".triplet-stamp-button").forEach(e=>{const o=e;o.classList.toggle("active",parseInt(o.dataset.tripletStampId||"",10)===n)}),l.setSelectedTool("tripletStamp"),l.emit("tripletStampSelected",n),l.emit("tripletStampToolSelected")},clearSelection(){const n=document.getElementById("triplet-stamps-toolbar-container");n&&n.querySelectorAll(".triplet-stamp-button").forEach(t=>{t.classList.remove("active")})},getSelectedTripletStamp(){return Oo.find(t=>t.id===this.selectedTripletStampId)}};function X0(){qh.init(),It.initialize?.()??It.init?.(),hi.init(),lo.init(),b.initSuccess("RhythmUi")}class Y0{gridsWrapper=null;pitchGridWrapper=null;drumGridWrapper=null;gridScrollbarProxy=null;isInitialized=!1;lastScrollTime=0;isSyncingFromProxy=!1;isSyncingFromWrapper=!1;handleWrapperScroll;handleProxyScroll;init(){if(this.gridsWrapper=document.getElementById("grids-wrapper"),this.pitchGridWrapper=document.getElementById("pitch-grid-wrapper"),this.drumGridWrapper=document.getElementById("drum-grid-wrapper"),this.gridScrollbarProxy=document.getElementById("grid-scrollbar-proxy"),!this.gridsWrapper||!this.pitchGridWrapper||!this.drumGridWrapper){b.error("ScrollSyncService","Required elements not found for scroll sync",null,"scroll");return}this.setupScrollSynchronization(),this.isInitialized=!0,b.info("ScrollSyncService","Initialized with unified grids-wrapper structure",null,"scroll")}setupScrollSynchronization(){this.handleWrapperScroll=this.handleWrapperScrollInternal.bind(this),this.handleProxyScroll=this.handleProxyScrollInternal.bind(this),this.gridsWrapper.addEventListener("scroll",this.handleWrapperScroll,{passive:!0}),this.gridScrollbarProxy?this.gridScrollbarProxy.addEventListener("scroll",this.handleProxyScroll,{passive:!0}):b.warn("ScrollSyncService","Grid scrollbar proxy not found; falling back to native scrollbars.",null,"scroll")}handleWrapperScrollInternal(t){if(this.isSyncingFromProxy||!this.gridsWrapper)return;const e=Date.now();if(this.lastScrollTime=e,this.gridScrollbarProxy){const i=this.gridsWrapper.scrollLeft;Math.abs(this.gridScrollbarProxy.scrollLeft-i)>.5&&(this.isSyncingFromWrapper=!0,this.gridScrollbarProxy.scrollLeft=i,this.isSyncingFromWrapper=!1)}const o=t.target;b.debug("ScrollSyncService",`Unified scroll: ${o?.scrollLeft??0}px`,null,"scroll")}handleProxyScrollInternal(){if(this.isSyncingFromWrapper||!this.gridScrollbarProxy)return;const t=this.gridScrollbarProxy.scrollLeft;this.gridsWrapper&&Math.abs(this.gridsWrapper.scrollLeft-t)>.5&&(this.isSyncingFromProxy=!0,this.gridsWrapper.scrollLeft=t,this.isSyncingFromProxy=!1)}syncScrollTo(t){!this.isInitialized||!this.gridsWrapper||(this.isSyncingFromProxy=!0,this.isSyncingFromWrapper=!0,this.gridsWrapper.scrollLeft=t,this.gridScrollbarProxy&&(this.gridScrollbarProxy.scrollLeft=t),this.isSyncingFromProxy=!1,this.isSyncingFromWrapper=!1)}}const Q0=new Y0;function Qa(n){if(n)return n.uuid}function ml(n,t=null){const e=Array.isArray(t)?t:n.macrobeatGroupings||[],i=[...Gt(n)].sort((u,h)=>u.preMacrobeatIndex-h.preMacrobeatIndex);let s=0;const a=[];let r=0;const c=u=>{a.push({visualIndex:a.length,type:`legend-${u}`,timeIndex:null})},d=u=>{for(;s<i.length;){const h=i[s];if(h?.preMacrobeatIndex!==u)break;a.push({visualIndex:a.length,type:"tonic",timeIndex:null}),a.push({visualIndex:a.length,type:"tonic",timeIndex:null});const m=Qa(h);if(m)do s++;while(s<i.length&&Qa(i[s])===m);else s++}};return c("left"),c("left"),d(-1),e.forEach((u,h)=>{for(let m=0;m<u;m++)a.push({visualIndex:a.length,type:"time",timeIndex:r++});d(h)}),c("right"),c("right"),{entries:a,totalTimeColumns:r}}function j0(n,t,e=null){if(e!==null){const{entries:o}=ml(n,e),i=o[t];return i?i.timeIndex:null}return cu(t,n)}function Z0(n,t,e=null){if(t==null)return null;if(e!==null){const{entries:o,totalTimeColumns:i}=ml(n,e);if(t<0||t>=i)return null;const s=o.find(a=>a.timeIndex===t);return s?s.visualIndex:null}return du(t,n)}let ko=!1,Oe="C4",ii=null;function Vo(){return{pitches:[],rootNote:Oe,color:l.state.selectedNote?.color||"#000000"}}let pe=Vo();function K0(){const n=document.activeElement;if(!(n instanceof HTMLElement))return!0;const t=n.tagName.toLowerCase();return!(["input","textarea","select"].includes(t)||n.isContentEditable)}function J0(n){const t=n.globalRow??n.row,e=l.state.fullRowData[t];return e?e.toneNote:"C4"}function ja(){const n=l.state.placedNotes.slice().reverse().find(t=>!t.isDrum);Oe=n?J0(n):"C4"}function Za(n){const{activeChordIntervals:t}=l.state;return!n||!t?.length?[]:t.map(e=>{const o=bn(n,e);return $n(o)})}function tp(){ja(),l.on("notesChanged",ja),document.addEventListener("keydown",n=>{if(n.code!=="Enter"||ko||n.repeat||!K0())return;n.preventDefault(),ko=!0;const t=l.state.selectedNote?.color;let e,o=[];if(ii&&t){const i=l.state.fullRowData[ii.row];e=i?i.toneNote:Oe,l.state.selectedTool==="chord"?o=Za(e):o=[e]}else t&&Oe&&(e=Oe,l.state.selectedTool==="chord"?o=Za(Oe):o=[Oe]);if(o.length>0&&t&&e){pe={pitches:[...o],rootNote:e,color:t},o.forEach(r=>{St.triggerAttack(r,t)});const i=l.state.fullRowData.find(r=>r.toneNote===e);i&&i.hex;const s=l.state.timbres[t];if(!s)return;s.adsr,l.emit("spacebarPlayback",{note:e,color:t,isPlaying:!0});const a=`spacebar-${Date.now()}`;l.emit("noteAttack",{noteId:a,color:t}),pe.noteId=a}}),document.addEventListener("keyup",n=>{if(n.code!=="Enter"||!ko)return;n.preventDefault(),ko=!1;const t=pe.pitches;if(!Array.isArray(t)||t.length===0){pe=Vo();return}const e=pe.color;if(e){t.forEach(a=>{St.triggerRelease(a,e)});const o=pe.rootNote??Oe,i=l.state.fullRowData.find(a=>a.toneNote===o);i&&i.hex;const s=l.state.timbres[e];if(!s){pe=Vo();return}s.adsr,l.emit("spacebarPlayback",{note:o,color:e,isPlaying:!1}),pe.noteId&&l.emit("noteRelease",{noteId:pe.noteId,color:e})}pe=Vo()})}function pl(n,t){ii={col:n,row:t};const e=l.state.selectedNote?.color;e&&l.emit("ghostNoteUpdated",{color:e})}function gl(){ii=null,l.emit("ghostNoteCleared")}const ep={single:40,chord:20,transient:30};function vl(n){return String(n)}function np(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}const Ka={single:0,chord:0,transient:0},ze=new Map;function Ja(n,t){const e=vl(t),o=ze.get(n)??new Set;o.add(e),ze.set(n,o)}function tr(n,t){const e=ze.get(n);e&&(e.delete(vl(t)),e.size===0&&ze.delete(n))}const Xt={shouldPlayPreview(n){const t=np(),e=ep[n],o=Ka[n];return t-o<e?!1:(Ka[n]=t,!0)},triggerAttack(n,t,e={}){const o=e.kind??"single";return!e.bypassThrottle&&!this.shouldPlayPreview(o)?!1:(St.triggerAttack(n,t),Ja(t,n),!0)},triggerAttacks(n,t,e={}){const o=e.kind??"chord";return!e.bypassThrottle&&!this.shouldPlayPreview(o)?!1:(n.forEach(i=>{St.triggerAttack(i,t),Ja(t,i)}),!0)},triggerRelease(n,t){St.triggerRelease(n,t),tr(t,n)},releasePitches(n,t){n.forEach(e=>{this.triggerRelease(e,t)})},quickReleasePitches(n,t){!n||n.length===0||(St.quickReleasePitches(n,t),n.forEach(e=>tr(t,e)))},playTransient(n,t,e=100){this.triggerAttack(n,t,{kind:"transient"})&&setTimeout(()=>this.triggerRelease(n,t),e)},releaseAll(n){if(typeof n=="string"){const t=ze.get(n);if(!t)return;Array.from(t.values()).forEach(e=>{St.triggerRelease(e,n)}),ze.delete(n);return}for(const[t,e]of ze.entries())Array.from(e.values()).forEach(o=>{St.triggerRelease(o,t)});ze.clear()}};class op{isDragging=!1;draggedModulationMarker=null;lastModulationHoverResult=null;handleMouseDown(t,e){for(const o of l.state.tempoModulationMarkers||[]){const i=o.xCanvas??o.xPosition??0,s=ma(t,e,{...o,xCanvas:i});if(s){if(s.type==="label"){const a=o.ratio===ne.COMPRESSION_2_3?ne.EXPANSION_3_2:ne.COMPRESSION_2_3;return l.setModulationRatio(o.id,a),!0}if(s.type==="barline"&&s.canDrag)return this.isDragging=!0,this.draggedModulationMarker=o,document.body.style.cursor=pa(s),!0}}return!1}handlePlacementClick(t,e){if(l.state.selectedTool!=="modulation")return!1;const o=l.state.selectedModulationRatio;if(typeof o!="number")return b.warn("PitchGridModulationToolInteractor","No modulation ratio selected before placement",null,"grid"),!0;const i=e(t);if(!i)return b.warn("PitchGridModulationToolInteractor","Modulation placement must be near a measure boundary",{clickX:t},"grid"),!0;b.debug("PitchGridModulationToolInteractor","Placing modulation marker at boundary",{measureIndex:i.measureIndex,ratio:o,clickX:t,boundaryX:i.xPosition},"grid");const s=l.addModulationMarker(i.measureIndex,o,i.xPosition,null,i.macrobeatIndex);return b.debug("PitchGridModulationToolInteractor","Modulation marker placed",{markerId:s,measureIndex:i.measureIndex,ratio:o},"grid"),!0}handleMouseMove(t){if(!this.isDragging||!this.draggedModulationMarker)return!1;const e=l.state.baseMicrobeatPx||l.state.cellWidth||40,o=Math.round(t/e)*e;return l.moveModulationMarker(this.draggedModulationMarker.id,o),!0}getHoveredMarker(t,e){for(const o of l.state.tempoModulationMarkers||[]){const i=o.xCanvas??o.xPosition??0,s=ma(t,e,{...o,xCanvas:i});if(s)return s}return null}updateCursor(t,e){if(e){t.style.cursor=pa(e),this.lastModulationHoverResult=e;return}this.lastModulationHoverResult&&(t.style.cursor="default",this.lastModulationHoverResult=null)}handleMouseUp(){return this.isDragging?(this.isDragging=!1,this.draggedModulationMarker=null,!0):!1}}class ip{handleExistingNoteMouseDown(t,e,o,i){if(l.state.selectedTool!=="note")return{handled:!1,state:o};const s=l.state.placedNotes.find(d=>!d.isDrum&&d.row===e&&t>=d.startColumnIndex&&t<=d.endColumnIndex);if(!s)return{handled:!1,state:o};const a=i.getPitchForRow(e);if(!a)return{handled:!0,state:o};const r=window.waveformVisualizer;r&&(r.currentColor=s.color,r.generateWaveform(),r.startSingleNoteVisualization(s.color));const c=It.getSixteenthStampAtPosition(t,e);return c?(It.playRhythmPattern(c.sixteenthStampId,a,s.color,s.shape,c),{handled:!0,state:{...o,activePreviewPitches:[a],activeNote:s}}):(Xt.triggerAttack(a,s.color,{kind:"single",bypassThrottle:!0}),l.state.fullRowData[e]?.hex,l.state.timbres[s.color]?.adsr,{handled:!0,state:{...o,activePreviewPitches:[a],activeNote:s}})}attemptPlaceNoteAt(t,e,o,i,s){if(l.state.selectedTool!=="note")return{placed:!1,state:o,shouldStartDragging:!1};if(!no(t,l.state))return{placed:!1,state:o,shouldStartDragging:!1};const a=l.state.selectedNote;if(!a)return{placed:!1,state:o,shouldStartDragging:!1};const{shape:r,color:c}=a;if(r==="circle"&&!no(t+1,l.state))return{placed:!1,state:o,shouldStartDragging:!1};const d=r==="circle"?t+1:t,u={row:e,startColumnIndex:t,endColumnIndex:d,color:c,shape:r,isDrum:!1},h=l.addNote(u);if(!h)return{placed:!1,state:o,shouldStartDragging:!1};const m={...o,activeNote:h,lastDragRow:e};h.uuid&&l.emit("noteInteractionStart",{noteId:h.uuid,color:h.color});const g=s.getPitchForRow(e);if(g){h.uuid&&(i.add(h.uuid),l.emit("noteAttack",{noteId:h.uuid,color:h.color})),m.activePreviewPitches=[g],Xt.triggerAttack(g,h.color,{kind:"single",bypassThrottle:!0}),l.state.fullRowData[e]?.hex,l.state.timbres[h.color]?.adsr;const f=window.waveformVisualizer;f&&(f.currentColor=h.color,f.generateWaveform(),f.startSingleNoteVisualization(h.color))}return{placed:!0,state:m,shouldStartDragging:!0}}handleActiveNoteDrag(t,e,o,i){const s=o.activeNote;if(!s)return o;const a=t,r=e,c=s.uuid;if(s.shape==="circle"){if(a!==s.endColumnIndex&&l.updateNoteTail(s,a),r!==o.lastDragRow){const d=i.getPitchForRow(r);if(!d)return o;o.activePreviewPitches.length>0&&Xt.quickReleasePitches(o.activePreviewPitches,s.color);const u=l.state.placedNotes.find(p=>p.uuid===c);u&&l.updateNoteRow(u,r);const m=l.state.placedNotes.find(p=>p.uuid===c)||u||s;let g=o.activePreviewPitches;return Xt.triggerAttack(d,m.color,{kind:"single"})&&(g=[d]),l.state.fullRowData[r]?.hex,l.state.timbres[m.color]?.adsr&&m.uuid,{...o,activeNote:m,lastDragRow:r,activePreviewPitches:g}}return o}if(s.shape==="oval"){const d=t;if(d!==s.startColumnIndex&&l.updateNotePosition(s,d),r!==o.lastDragRow){const u=i.getPitchForRow(r);if(!u)return o;o.activePreviewPitches.length>0&&Xt.quickReleasePitches(o.activePreviewPitches,s.color);const h=l.state.placedNotes.find(v=>v.uuid===c);h&&l.updateNoteRow(h,r);const g=l.state.placedNotes.find(v=>v.uuid===c)||h||s;let f=o.activePreviewPitches;return Xt.triggerAttack(u,g.color,{kind:"single"})&&(f=[u]),l.state.fullRowData[r]?.hex,l.state.timbres[g.color]?.adsr&&g.uuid,{...o,activeNote:g,lastDragRow:r,activePreviewPitches:f}}}return o}}class sp{handleMouseDown(t,e){if(l.state.selectedTool!=="eraser")return{handled:!1,shouldStartDrag:!1};l.eraseInPitchArea(t,e,2,!1);const o=t+2-1,i=e-1,s=e+1;return Af(t,o,i,s),Pf(t,o,i,s),{handled:!0,shouldStartDrag:!0}}handleMouseMove(t,e,o){if(!o)return!1;l.eraseInPitchArea(t,e,2,!1);const i=t+2-1,s=e-1,a=e+1;return l.eraseSixteenthStampsInArea(t,i,s,a),l.eraseTripletStampsInArea(t,i,s,a),!0}}class ap{handleMouseDown(t,e,o,i,s){if(l.state.selectedTool!=="chord")return{handled:!1,state:o,shouldStartDragging:!1};if(!no(t,l.state))return{handled:!0,state:o,shouldStartDragging:!1};const a=s.getPitchForRow(e);if(!a)return{handled:!0,state:o,shouldStartDragging:!1};const r=s.getChordPitchesForRootPitch(a),c=l.state.selectedNote;if(!c)return{handled:!0,state:o,shouldStartDragging:!1};const{shape:d,color:u}=c;Xt.triggerAttacks(r,u,{kind:"chord",bypassThrottle:!0}),l.state.fullRowData[e]?.hex,l.state.timbres[u]?.adsr;const h=[];return r.forEach(m=>{const g=l.state.fullRowData.findIndex(w=>w.toneNote===m);if(g===-1)return;const f=d==="circle"?t+1:t,p={row:g,startColumnIndex:t,endColumnIndex:f,color:u,shape:d,isDrum:!1},v=l.addNote(p);v&&(h.push(v),v.uuid&&(i.add(v.uuid),l.emit("noteAttack",{noteId:v.uuid,color:v.color}),l.emit("noteInteractionStart",{noteId:v.uuid,color:v.color})))}),{handled:!0,shouldStartDragging:!0,state:{...o,activeChordNotes:h,activePreviewPitches:[...r],lastDragRow:e}}}handleActiveChordDrag(t,e,o,i){if(!o.activeChordNotes||o.activeChordNotes.length===0)return o;const s=o.activeChordNotes[0];if(!s)return o;const a=s.color,r=e;if(s.shape==="circle"){const c=t,d=o.activeChordNotes.filter(u=>c!==u.endColumnIndex);if(d.length>0&&l.updateMultipleNoteTails(d,c),r!==o.lastDragRow){const u=o.lastDragRow??s.row,h=r-u;if(h===0)return o;Xt.quickReleasePitches(o.activePreviewPitches,a);const m=o.activeChordNotes.map(p=>p.row+h);if(!m.every(p=>i.getPitchForRow(p)!==null))return o;l.updateMultipleNoteRows(o.activeChordNotes,m);const f=m.map(p=>i.getPitchForRow(p)).filter(p=>typeof p=="string");return Xt.triggerAttacks(f,a,{kind:"chord"}),{...o,activePreviewPitches:f,lastDragRow:r}}return o}if(s.shape==="oval"){const c=t,d=o.activeChordNotes.filter(p=>c!==p.startColumnIndex);d.length>0&&l.updateMultipleNotePositions(d,c);const u=o.lastDragRow!==null?o.lastDragRow:s.row,h=r-u;if(h===0)return o;Xt.quickReleasePitches(o.activePreviewPitches,a);const m=o.activeChordNotes.map(p=>p.row+h);if(!m.every(p=>i.getPitchForRow(p)!==null))return o;l.updateMultipleNoteRows(o.activeChordNotes,m);const f=m.map(p=>i.getPitchForRow(p)).filter(p=>typeof p=="string");return Xt.triggerAttacks(f,a,{kind:"chord"}),{...o,activePreviewPitches:f,lastDragRow:r}}return o}}function rp(n,t,e,o){const i=ci(e.sixteenthStampId);if(!i)return null;const s=J(e.startColumn,o),a=o.cellWidth*2,r=o.cellHeight,c=[.125,.375,.625,.875].map(d=>s+d*a);for(const d of i.diamonds){const u=`diamond_${d}`,h=e.shapeOffsets?.[u]||0,m=e.row+h,g=pt(m,o),f=c[d];if(f===void 0)continue;const p=Math.sqrt(Math.pow(n-f,2)+Math.pow(t-g,2)),v=Math.min(a*.2,r*1);if(p<v)return{type:"diamond",slot:d??0,shapeKey:u,cx:f,cy:g,placement:e}}for(const d of i.ovals){const u=`oval_${d}`,h=e.shapeOffsets?.[u]||0,m=e.row+h,g=pt(m,o),f=d===0?s+.25*a:s+.75*a,p=Math.sqrt(Math.pow(n-f,2)+Math.pow(t-g,2)),v=Math.min(a*.25,r*1);if(p<v)return{type:"oval",slot:d,shapeKey:u,cx:f,cy:g,placement:e}}return null}function er(n,t,e,o){for(const i of e){const s=rp(n,t,i,o);if(s)return s}return null}class lp{draggedStampShape=null;isDraggingShape(){return this.draggedStampShape!==null}tryStartShapeDrag(t){const e=l.getAllSixteenthStampPlacements(),o={...l.state},i=er(t.actualX,t.canvasY,e,o);return i?(this.draggedStampShape={...i,startRow:l.getSixteenthStampShapeRow(i.placement,i.shapeKey),startMouseY:t.canvasY},!0):!1}handleMouseDown(t){if(this.tryStartShapeDrag({actualX:t.actualX,canvasY:t.canvasY}))return{handled:!0};if(l.state.selectedTool!=="sixteenthStamp")return{handled:!1};const e=It.getSixteenthStampAtPosition(t.colIndex,t.rowIndex);if(e){const d=t.getPitchForRow(t.rowIndex);if(!d)return{handled:!0};const u=l.state.placedNotes.find(m=>!m.isDrum&&m.row===t.rowIndex&&t.colIndex>=m.startColumnIndex&&t.colIndex<=m.endColumnIndex),h=u?u.shape:"oval";return It.playRhythmPattern(e.sixteenthStampId,d,e.color,h,e),{handled:!0,activePreviewPitches:[d]}}const o=hi.getSelectedSixteenthStamp();if(!o)return{handled:!0};const i=t.getTimeAlignedCanvasColumn(t.colIndex);if(i===null)return{handled:!0};const s=l.state.selectedNote;if(!s)return{handled:!0};const{color:a,shape:r}=s;Cf(o.id,i,t.rowIndex,a);const c=t.getPitchForRow(t.rowIndex);return c?(It.playRhythmPattern(o.id,c,a,r),l.recordState(),{handled:!0,activePreviewPitches:[c]}):(l.recordState(),{handled:!0})}handleMouseMove(t){if(!this.draggedStampShape)return!1;const e=t.rowIndex-this.draggedStampShape.placement.row;if(l.updateSixteenthStampShapeOffset(this.draggedStampShape.placement.id,this.draggedStampShape.shapeKey,e),t.rowIndex!==this.draggedStampShape.startRow){const o=t.getPitchForRow(t.rowIndex);if(o){const i=this.draggedStampShape.placement.color||l.state.selectedNote?.color;i&&Xt.playTransient(o,i,100)}this.draggedStampShape.startRow=t.rowIndex}return t.canvasEl&&(t.canvasEl.style.cursor="ns-resize"),!0}updateHoverCursor(t){if(l.state.selectedTool!=="sixteenthStamp"||this.draggedStampShape)return;const e=t.canvasEl;if(!e)return;const o=l.getAllSixteenthStampPlacements(),i={...l.state};er(t.actualX,t.canvasY,o,i)||cp(t.actualX,t.canvasY,o,i)?e.style.cursor="grab":e.style.cursor="default"}handleMouseUp(){if(!this.draggedStampShape)return!1;this.draggedStampShape=null,l.recordState();const t=document.getElementById("notation-grid");return t&&(t.style.cursor="default"),!0}}function cp(n,t,e,o){const i=o.columnWidths||[];for(const s of e){const a=s.startColumn,r=Math.min(s.endColumn,i.length),c=J(a,o),d=J(r,o),h=pt(s.row,o)-o.cellHeight/2;if(n>=c&&n<=d&&t>=h&&t<=h+o.cellHeight)return!0}return!1}function dp(n,t,e,o){const i=di(e.tripletStampId);if(!i)return null;const s=e.span*2,a=Kt(e.startTimeIndex,l.state),r=a+s,c=J(a,o),u=J(r,o)-c,h=o.cellHeight;for(const m of i.hits){const g=`triplet_${m}`,f=e.shapeOffsets?.[g]||0,p=e.row+f,v=pt(p,o),w=Wr[m];if(w===void 0)continue;const y=c+u*w/100,C=Math.sqrt(Math.pow(n-y,2)+Math.pow(t-v,2)),P=Math.min(u*.15,h*1);if(C<P)return{type:"tripletStamp",slot:m,shapeKey:g,cx:y,cy:v,placement:e}}return null}function nr(n,t,e,o){for(const i of e){const s=dp(n,t,i,o);if(s)return s}return null}class up{draggedTripletShape=null;isDraggingShape(){return this.draggedTripletShape!==null}tryStartShapeDrag(t){const e=l.getAllTripletStampPlacements(),o={...l.state},i=nr(t.actualX,t.canvasY,e,o);return i?(this.draggedTripletShape={...i,startRow:l.getTripletStampShapeRow(i.placement,i.shapeKey),startMouseY:t.canvasY},!0):!1}handleMouseDown(t){if(this.tryStartShapeDrag({actualX:t.actualX,canvasY:t.canvasY}))return{handled:!0};if(l.state.selectedTool!=="tripletStamp")return{handled:!1};const e=qe(t.colIndex,l.state);if(e===null)return{handled:!0};const o=e,i=It.getTripletStampAtPosition(o,t.rowIndex);if(i){const c=t.getPitchForRow(t.rowIndex);return c?(It.playTripletPattern(i.tripletStampId,c,i.color,i),{handled:!0,activePreviewPitches:[c]}):{handled:!0}}const s=lo.getSelectedTripletStamp();if(!s||!l.state.selectedNote)return{handled:!0};const a=Mf(s.id,o,t.rowIndex,l.state.selectedNote.color),r=t.getPitchForRow(t.rowIndex);return r&&a?(It.playTripletPattern(s.id,r,l.state.selectedNote.color,a),l.recordState(),{handled:!0,activePreviewPitches:[r]}):(l.recordState(),{handled:!0})}handleMouseMove(t){if(!this.draggedTripletShape)return!1;const e=t.rowIndex-this.draggedTripletShape.placement.row;if(l.updateTripletStampShapeOffset(this.draggedTripletShape.placement.id,this.draggedTripletShape.shapeKey,e),t.rowIndex!==this.draggedTripletShape.startRow){const o=t.getPitchForRow(t.rowIndex);if(o){const i=this.draggedTripletShape.placement.color||l.state.selectedNote?.color;i&&Xt.playTransient(o,i,100)}this.draggedTripletShape.startRow=t.rowIndex}return t.canvasEl&&(t.canvasEl.style.cursor="ns-resize"),!0}updateHoverCursor(t){if(l.state.selectedTool!=="tripletStamp"||this.draggedTripletShape)return;const e=t.canvasEl;if(!e)return;const o=l.getAllTripletStampPlacements(),i={...l.state};nr(t.actualX,t.canvasY,o,i)||hp(t.actualX,t.canvasY,o,i)?e.style.cursor="grab":e.style.cursor="default"}handleMouseUp(){if(!this.draggedTripletShape)return!1;this.draggedTripletShape=null,l.recordState();const t=document.getElementById("notation-grid");return t&&(t.style.cursor="default"),!0}}function hp(n,t,e,o){for(const i of e){const s=i.span*2,a=Kt(i.startTimeIndex,l.state),r=a+s,c=J(a,o),d=J(r,o),h=pt(i.row,o)-o.cellHeight/2;if(n>=c&&n<=d&&t>=h&&t<=h+o.cellHeight)return!0}return!1}function fp(n){const{macrobeatGroupings:t,macrobeatBoundaryStyles:e,columnWidths:o}=l.state,i=o.length;if(n<0||n>=i)return null;let s=-1;for(let h=0;h<t.length;h++){const{startColumn:m,endColumn:g}=Zt(l.state,h);if(n>=m&&n<=g){s=h;break}}if(s===-1)return null;let a=0;for(let h=s-1;h>=0;h--)if(e[h]==="solid"){a=h+1;break}const r=a-1;return(h=>h<=0?!0:e[h-1]==="solid")(a)?{drawColumn:Zt(l.state,a).startColumn,preMacrobeatIndex:r}:null}function or(n){return n.replace(/\d+$/,"")}class mp{lastHoveredTonicPoint=null;lastHoveredOctaveRows=[];resetHoverState(){this.lastHoveredTonicPoint=null,this.lastHoveredOctaveRows=[]}handleMouseMove(t){if(l.state.selectedTool!=="tonicization")return(this.lastHoveredTonicPoint||this.lastHoveredOctaveRows.length>0)&&this.resetHoverState(),!1;const e=fp(t.colIndex);if(!e)return this.resetHoverState(),!0;if(Gt(l.state).some(u=>u.preMacrobeatIndex===e.preMacrobeatIndex))return this.resetHoverState(),!0;const s=t.getPitchForRow(t.rowIndex);if(!s)return this.resetHoverState(),!0;const a=or(s),r=Me.map((u,h)=>({rowData:u,masterIndex:h})).filter(({rowData:u})=>u.toneNote&&or(u.toneNote)===a).map(({masterIndex:u})=>u);this.lastHoveredTonicPoint=e,this.lastHoveredOctaveRows=r;const c=r.filter(u=>u>=0&&u<l.state.fullRowData.length);t.hoverCtx.globalAlpha=.5;const d={...l.state,zoomLevel:Ht.getViewportInfo().zoomLevel};return c.forEach(u=>{const h={row:u,globalRow:u,columnIndex:e.drawColumn,tonicNumber:l.state.selectedToolTonicNumber,preMacrobeatIndex:e.preMacrobeatIndex};Dr(t.hoverCtx,d,h)}),t.hoverCtx.globalAlpha=1,!0}handleMouseDown(){if(l.state.selectedTool!=="tonicization")return!1;if(!this.lastHoveredTonicPoint||this.lastHoveredOctaveRows.length===0)return!0;const t=this.lastHoveredTonicPoint;if(Gt(l.state).some(s=>s.preMacrobeatIndex===t.preMacrobeatIndex))return this.resetHoverState(),!0;const i=this.lastHoveredOctaveRows.map(s=>({row:s,tonicNumber:l.state.selectedToolTonicNumber,preMacrobeatIndex:t.preMacrobeatIndex,columnIndex:t.drawColumn}));return l.addTonicSignGroup(i),this.resetHoverState(),!0}}class pp{constructor(t){this.deps=t}handleToolMouseDown(t){const{toolType:e,colIndex:o,rowIndex:i,actualX:s,canvasY:a}=t,r=t.state;if(e==="chord"){const c=this.deps.chordToolInteractor.handleMouseDown(o,i,{activeChordNotes:r.activeChordNotes,lastDragRow:r.lastDragRow,activePreviewPitches:r.activePreviewPitches},this.deps.placementFillNoteIds,{getPitchForRow:this.deps.getPitchForRow,getChordPitchesForRootPitch:this.deps.getChordPitchesForRootPitch});return{handled:c.handled,state:{...r,isDragging:c.shouldStartDragging?!0:r.isDragging,activeChordNotes:c.state.activeChordNotes,lastDragRow:c.state.lastDragRow,activePreviewPitches:c.state.activePreviewPitches}}}if(e==="tonicization")return this.deps.tonicizationToolInteractor.handleMouseDown(),{handled:!0,state:r};if(e==="eraser"){const c=this.deps.eraserToolInteractor.handleMouseDown(o,i);return{handled:c.handled,state:{...r,isEraserDragActive:c.handled?c.shouldStartDrag:r.isEraserDragActive}}}if(e==="sixteenthStamp"){const c=this.deps.stampToolInteractor.handleMouseDown({colIndex:o,rowIndex:i,actualX:s,canvasY:a,getPitchForRow:this.deps.getPitchForRow,getTimeAlignedCanvasColumn:this.deps.getTimeAlignedCanvasColumn});return{handled:c.handled,state:{...r,activePreviewPitches:c.activePreviewPitches??r.activePreviewPitches}}}if(e==="tripletStamp"){const c=this.deps.tripletToolInteractor.handleMouseDown({colIndex:o,rowIndex:i,actualX:s,canvasY:a,getPitchForRow:this.deps.getPitchForRow});return{handled:c.handled,state:{...r,activePreviewPitches:c.activePreviewPitches??r.activePreviewPitches}}}if(e==="modulation")return this.deps.modulationToolInteractor.handlePlacementClick(s,this.deps.findNearestMeasureBoundary),{handled:!0,state:r};if(e==="note"){const c=this.deps.noteToolInteractor.attemptPlaceNoteAt(o,i,{activeNote:r.activeNote,lastDragRow:r.lastDragRow,activePreviewPitches:r.activePreviewPitches},this.deps.placementFillNoteIds,{getPitchForRow:this.deps.getPitchForRow});return{handled:!0,state:{...r,isDragging:c.placed&&c.shouldStartDragging?!0:r.isDragging,activeNote:c.state.activeNote,lastDragRow:c.state.lastDragRow,activePreviewPitches:c.state.activePreviewPitches}}}return{handled:!1,state:r}}handleToolMouseMoveBeforeBoundsCheck(t){const{actualX:e,rowIndex:o,canvasEl:i,state:s}=t;return this.deps.modulationToolInteractor.handleMouseMove(e)?{handled:!0,state:s}:this.deps.stampToolInteractor.handleMouseMove({rowIndex:o,canvasEl:i,getPitchForRow:this.deps.getPitchForRow})?{handled:!0,state:s}:this.deps.tripletToolInteractor.handleMouseMove({rowIndex:o,canvasEl:i,getPitchForRow:this.deps.getPitchForRow})?{handled:!0,state:s}:{handled:!1,state:s}}handleNoteOrChordDragMouseMove(t){const{colIndex:e,rowIndex:o}=t,i=t.state;if(!i.isDragging||!i.activeNote&&i.activeChordNotes.length===0)return{handled:!1,state:i};if(i.activeNote){const a=this.deps.noteToolInteractor.handleActiveNoteDrag(e,o,{activeNote:i.activeNote,lastDragRow:i.lastDragRow,activePreviewPitches:i.activePreviewPitches},{getPitchForRow:this.deps.getPitchForRow});return{handled:!0,state:{...i,activeNote:a.activeNote,lastDragRow:a.lastDragRow,activePreviewPitches:a.activePreviewPitches}}}const s=this.deps.chordToolInteractor.handleActiveChordDrag(e,o,{activeChordNotes:i.activeChordNotes,lastDragRow:i.lastDragRow,activePreviewPitches:i.activePreviewPitches},{getPitchForRow:this.deps.getPitchForRow});return{handled:!0,state:{...i,activeChordNotes:s.activeChordNotes,lastDragRow:s.lastDragRow,activePreviewPitches:s.activePreviewPitches}}}handleToolHoverVisuals(t){const{toolType:e,actualX:o,canvasY:i,pitchHoverCtx:s,canvasEl:a}=t;e==="sixteenthStamp"?this.deps.stampToolInteractor.updateHoverCursor({actualX:o,canvasY:i,canvasEl:a}):e==="tripletStamp"&&this.deps.tripletToolInteractor.updateHoverCursor({actualX:o,canvasY:i,canvasEl:a});const r=this.deps.modulationToolInteractor.getHoveredMarker(o,i);if(e==="modulation"&&!r&&s){const c=t.findNearestMeasureBoundary(o),d=t.selectedModulationRatio;c&&typeof d=="number"&&t.drawModulationPreview(s,c.xPosition,d)}a&&this.deps.modulationToolInteractor.updateCursor(a,r)}handleToolMouseUp(){return!!(this.deps.stampToolInteractor.handleMouseUp()||this.deps.tripletToolInteractor.handleMouseUp()||this.deps.modulationToolInteractor.handleMouseUp())}handleChordToolHover(t){if(l.state.selectedTool!=="chord")return!1;const e=this.deps.getPitchForRow(t.rowIndex);if(!e)return!0;const o=this.deps.getChordPitchesForRootPitch(e),i=l.state.selectedNote;if(!i)return!0;const{shape:s,color:a}=i;return t.pitchHoverCtx.globalAlpha=.4,o.forEach(r=>{const c=l.state.fullRowData.findIndex(m=>m.toneNote===r);if(c<=-1)return;const d=s==="circle"?t.colIndex+1:t.colIndex,u={row:c,startColumnIndex:t.colIndex,endColumnIndex:d,color:a,shape:s,isDrum:!1},h={...l.state,zoomLevel:t.zoomLevel};s==="oval"?t.drawSingleColumnOvalNote(t.pitchHoverCtx,h,u,c):t.drawTwoColumnOvalNote(t.pitchHoverCtx,h,u,c)}),t.pitchHoverCtx.globalAlpha=1,!0}}class gp{isActive=!1;actionTaken=!1;previousTool=null;getIsActive(){return this.isActive}handleMouseDown(t){const{event:e,colIndex:o,rowIndex:i,annotationService:s}=t;if(e.button!==2)return!1;e.preventDefault(),this.isActive=!0,this.actionTaken=!1,l.state.selectedTool!=="eraser"&&(this.previousTool=l.state.selectedTool,l.setSelectedTool("eraser")),Ne.get("eraserButton")?.classList.add("erasing-active"),this.actionTaken||=!!l.eraseInPitchArea(o,i,2,!1),this.actionTaken||=!!l.eraseTonicSignAt(o,!1);const a=o+2-1,r=i-1,c=i+1;this.actionTaken||=!!l.eraseSixteenthStampsInArea(o,a,r,c),this.actionTaken||=!!l.eraseTripletStampsInArea(o,a,r,c);const d=e.target instanceof Element?e.target:null;if(d){const u=d.getBoundingClientRect(),h=e.clientX-u.left,m=e.clientY-u.top;this.actionTaken||=!!s.eraseAtPoint(h,m)}return!0}handleMouseMove(t){if(!this.isActive)return!1;const{event:e,colIndex:o,rowIndex:i,annotationService:s}=t;this.actionTaken||=!!l.eraseInPitchArea(o,i,2,!1),this.actionTaken||=!!l.eraseTonicSignAt(o,!1);const a=o+2-1,r=i-1,c=i+1;this.actionTaken||=!!l.eraseSixteenthStampsInArea(o,a,r,c),this.actionTaken||=!!l.eraseTripletStampsInArea(o,a,r,c);const d=e.target instanceof Element?e.target:null;if(d){const u=d.getBoundingClientRect(),h=e.clientX-u.left,m=e.clientY-u.top;this.actionTaken||=!!s.eraseAtPoint(h,m)}return!0}handleGlobalMouseUp(){return this.isActive?(this.actionTaken&&l.recordState(),this.isActive=!1,this.actionTaken=!1,this.previousTool&&(l.setSelectedTool(this.previousTool),this.previousTool=null),Ne.get("eraserButton")?.classList.remove("erasing-active"),!0):!1}}class vp{constructor(t,e){this.deps=t,this.options=e}pitchCanvasElement=null;mobileLongPressTimer=null;mobileTouchState=null;mobileGhostActive=!1;setPitchCanvasElement(t){this.pitchCanvasElement=t}handleTouchStart(t){if(!this.deps.shouldUseMobileLongPress()||this.mobileTouchState)return;const e=t.changedTouches?.[0];if(!e)return;const o=this.getTouchGridPosition(e);!o||!this.deps.isPositionWithinPitchGrid(o.colIndex,o.rowIndex)||(t.preventDefault(),this.mobileTouchState={identifier:e.identifier,colIndex:o.colIndex,rowIndex:o.rowIndex},this.mobileLongPressTimer=window.setTimeout(()=>{this.activateMobileGhostPreview()},this.options.longPressDelayMs))}handleTouchMove(t){if(!this.mobileTouchState)return;const e=this.findTouchById(t.changedTouches,this.mobileTouchState.identifier)||this.findTouchById(t.touches,this.mobileTouchState.identifier);if(!e)return;const o=this.getTouchGridPosition(e);if(!o){this.resetMobileTouchState({clearOverlay:this.mobileGhostActive});return}if(!this.deps.isPositionWithinPitchGrid(o.colIndex,o.rowIndex)){this.resetMobileTouchState({clearOverlay:this.mobileGhostActive});return}t.preventDefault(),this.mobileTouchState.colIndex=o.colIndex,this.mobileTouchState.rowIndex=o.rowIndex,this.mobileGhostActive&&this.renderMobileGhostPreview()}handleTouchEnd(t){if(!this.mobileTouchState||!this.findTouchById(t.changedTouches,this.mobileTouchState.identifier))return;t.preventDefault();const o=this.mobileGhostActive,i=this.mobileTouchState.colIndex,s=this.mobileTouchState.rowIndex;if(this.resetMobileTouchState(),!o||this.deps.getSelectedTool()!=="note")return;this.deps.attemptPlaceNoteAt(i,s)?this.deps.onNotePlaced():this.deps.onNoteNotPlaced()}handleTouchCancel(){this.resetMobileTouchState({clearOverlay:this.mobileGhostActive})}getTouchGridPosition(t){if(!this.pitchCanvasElement)return null;const e=this.pitchCanvasElement.getBoundingClientRect(),o=t.clientX-e.left,i=t.clientY-e.top,s=document.getElementById("canvas-container")?.scrollLeft??0,a=Se.getColumnIndex(o+s),r=Se.getPitchRowIndex(i);return{colIndex:a,rowIndex:r}}findTouchById(t,e){if(!t)return null;for(let o=0;o<t.length;o++){const i=t.item(o);if(i&&i.identifier===e)return i}return null}renderMobileGhostPreview(){const t=this.deps.getPitchHoverCtx();!t||!this.mobileTouchState||(t.clearRect(0,0,qt(t.canvas),Pt(t.canvas)),this.deps.drawHoverHighlight(this.mobileTouchState.colIndex,this.mobileTouchState.rowIndex,this.deps.getNoteHoverColor(this.options.ghostAlpha)),this.deps.drawGhostNote(this.mobileTouchState.colIndex,this.mobileTouchState.rowIndex),this.deps.setGhostNotePosition(this.mobileTouchState.colIndex,this.mobileTouchState.rowIndex))}activateMobileGhostPreview(){if(this.mobileTouchState){if(!this.deps.isPositionWithinPitchGrid(this.mobileTouchState.colIndex,this.mobileTouchState.rowIndex)){this.resetMobileTouchState({clearOverlay:!1});return}this.mobileGhostActive=!0,this.renderMobileGhostPreview()}}resetMobileTouchState({clearOverlay:t=!1}={}){this.mobileLongPressTimer&&(clearTimeout(this.mobileLongPressTimer),this.mobileLongPressTimer=null),t&&this.mobileGhostActive&&this.deps.clearOverlay(),this.mobileTouchState=null,this.mobileGhostActive=!1}}function bp(n,t){const{activeChordIntervals:e,isIntervalsInverted:o,chordPositionState:i}=t;if(!n||!e||e.length===0)return[];if(o&&e.length===2&&e[0]==="1P"){const r="-"+e[1],c=bn(n,r),d=$n(c),u=d.includes("#")&&zn(d).includes("b")?zn(d):d;return[n,u]}const s=e.map(a=>{const r=bn(n,a),c=$n(r);if(c.includes("#")){const d=zn(c);if(d.includes("b"))return d}return c});if(e.length>=3&&i>0){const a=[...s];for(let g=0;g<i;g++){const f=a.shift();if(!f)break;const p=bn(f,"8P");a.push($n(p)??f)}const r=a[0],c=n;if(!r)return s;const d=vi(r),u=vi(c);if(d===null||u===null)return s;let h=0,m=d;for(;m>u;)m-=12,h-=12;for(;m+12<=u;)m+=12,h+=12;return a.map(g=>{const f=vi(g);if(f===null)return g;const p=f+h;return sc(p)??g})}return s}let si=!1,ms=null,ps=null,gs=null,On=null;const on="grab";function wp(n){if(si){n&&(n.style.cursor=on);return}ms=document.body.style.cursor||null,ps=document.documentElement.style.cursor||null,gs=n?.style.cursor??null,On=n??null,n&&(n.style.cursor=on),document.body.style.cursor=on,document.documentElement.style.cursor=on,document.body.dataset.cursorOverride="stamp",si=!0}function bl(){si&&(On&&On.style.cursor===on&&(On.style.cursor=gs??""),document.body.style.cursor===on&&(document.body.style.cursor=ms??""),document.documentElement.style.cursor===on&&(document.documentElement.style.cursor=ps??""),document.body.dataset.cursorOverride==="stamp"&&delete document.body.dataset.cursorOverride,si=!1,ms=null,ps=null,gs=null,On=null)}let yt=null,He=!1,kt=null,Le=[],Qt=[];const pn=new Set;let $e=!1,we=null;const wl=new op,_s=new ip,yl=new sp,yp=new ap,zs=new lp,$s=new up,ai=new mp,fi=new gp,gn=new pp({noteToolInteractor:_s,chordToolInteractor:yp,eraserToolInteractor:yl,stampToolInteractor:zs,tripletToolInteractor:$s,modulationToolInteractor:wl,tonicizationToolInteractor:ai,placementFillNoteIds:pn,getPitchForRow:Pn,getTimeAlignedCanvasColumn:vs,getChordPitchesForRootPitch:n=>bp(n,l.state),findNearestMeasureBoundary:Pl}),Sp=275,Cp=.25,Bn=new vp({shouldUseMobileLongPress:Mp,isPositionWithinPitchGrid:xl,getSelectedTool:()=>l.state.selectedTool,getPitchHoverCtx:()=>yt,clearOverlay:Tn,drawHoverHighlight:jn,getNoteHoverColor:Cl,drawGhostNote:Ml,setGhostNotePosition:pl,attemptPlaceNoteAt:xp,onNotePlaced:El,onNoteNotPlaced:Tn},{longPressDelayMs:Sp,ghostAlpha:Cp}),Sl="#4a90e2";function Ap(n,t=1){const e=n.startsWith("#")?n.slice(1):n;if(e.length!==6)return n;const o=parseInt(e.slice(0,2),16),i=parseInt(e.slice(2,4),16),s=parseInt(e.slice(4,6),16);return`rgba(${o}, ${i}, ${s}, ${t})`}function Cl(n=.2){const t=l.state.selectedNote?.color||Sl;return Ap(t,n)}function ir(){return l.state.selectedNote?.color||Sl}function Al(){return!!Mt.currentTool}function Pn(n){const t=l.state.fullRowData[n];return!t||t.isBoundary?null:t.toneNote}function vs(n){const t=n+2,e=j0(l.state,t);if(e===null)return null;const o=Z0(l.state,e);return o===null?null:Math.max(0,o-2)}function xl(n,t){const e=(l.state.selectedTool==="note"||l.state.selectedTool==="chord")&&l.state.selectedNote?.shape==="circle",i=(l.state.musicalColumnWidths&&l.state.musicalColumnWidths.length>0?l.state.musicalColumnWidths:l.state.columnWidths||[]).length,s=e?i-1:i;return n<0||n>=s?!1:Pn(t)!==null}function jn(n,t,e){if(!yt)return;const o={...l.state,zoomLevel:Ht.getViewportInfo().zoomLevel},i=J(n,o),a=pt(t,l.state)-l.state.cellHeight/2,r=l.state.selectedTool;let c;if(l.state.tempoModulationMarkers&&l.state.tempoModulationMarkers.length>0?c=J(n+1,o)-i:c=(l.state.columnWidths[n]??1)*l.state.cellWidth,r==="eraser"||fi.getIsActive())l.state.tempoModulationMarkers&&l.state.tempoModulationMarkers.length>0?c=J(n+2,o)-i:c=l.state.cellWidth*2;else if(r==="note"&&l.state.selectedNote?.shape==="circle")l.state.tempoModulationMarkers&&l.state.tempoModulationMarkers.length>0?c=J(n+2,o)-i:c=l.state.cellWidth*2;else if(r==="sixteenthStamp")l.state.tempoModulationMarkers&&l.state.tempoModulationMarkers.length>0?c=J(n+2,o)-i:c=l.state.cellWidth*2;else if(r==="tripletStamp"){const d=lo.getSelectedTripletStamp();if(d){const h=2*(d.span==="eighth"?1:2);l.state.tempoModulationMarkers&&l.state.tempoModulationMarkers.length>0?c=J(n+h,o)-i:c=l.state.cellWidth*h}else c=l.state.cellWidth*2}else r==="tonicization"&&(l.state.tempoModulationMarkers&&l.state.tempoModulationMarkers.length>0?c=J(n+2,o)-i:c=l.state.cellWidth*2);yt.fillStyle=e,yt.fillRect(i,a,c,l.state.cellHeight)}function Ml(n,t,e=!1){if(!yt||!l.state.selectedNote)return;const o=l.state.selectedTool,{shape:i,color:s}=l.state.selectedNote;if(yt.globalAlpha=e?.2:.4,o==="note"){const a=i==="circle"?n+1:n,r={uuid:"ghost-note",globalRow:t,row:t,startColumnIndex:n,endColumnIndex:a,color:s,shape:i,isDrum:!1},c={...l.state,zoomLevel:Ht.getViewportInfo().zoomLevel};i==="oval"?Ps(yt,c,r,t):Es(yt,c,r,t)}yt.globalAlpha=1}function xp(n,t){const e=_s.attemptPlaceNoteAt(n,t,{activeNote:kt,lastDragRow:we,activePreviewPitches:Qt},pn,{getPitchForRow:Pn});return kt=e.state.activeNote,we=e.state.lastDragRow,Qt=e.state.activePreviewPitches,e.placed&&e.shouldStartDragging&&(He=!0),e.placed}function Mp(){if(l.state.selectedTool!=="note")return!1;const n=l.state.deviceProfile;if(n&&typeof n.isMobile=="boolean")return n.isMobile;if(typeof window<"u"&&typeof window.matchMedia=="function")try{return window.matchMedia("(pointer: coarse)").matches}catch{return!1}return!1}function Ep(n){if(Al()){Tn();return}if(!yt)return;const t=n.target instanceof Element?n.target:null;if(!t)return;const e=t.getBoundingClientRect(),o=n.clientX-e.left,i=n.clientY-e.top,s=document.getElementById("canvas-container")?.scrollLeft??0,a=Se.getColumnIndex(o+s),r=Se.getPitchRowIndex(i);if(!xl(a,r)){l.state.selectedTool;return}if(n.button===2&&fi.handleMouseDown({event:n,colIndex:a,rowIndex:r,annotationService:Mt})){yt.clearRect(0,0,qt(yt.canvas),Pt(yt.canvas)),jn(a,r,"rgba(220, 53, 69, 0.3)");return}if(n.button===0){const c=o+s;if(wl.handleMouseDown(c,i))return;const d=_s.handleExistingNoteMouseDown(a,r,{activeNote:kt,lastDragRow:we,activePreviewPitches:Qt},{getPitchForRow:Pn});if(d.handled){kt=d.state.activeNote,we=d.state.lastDragRow,Qt=d.state.activePreviewPitches;return}const u=l.state.selectedTool;if(u==="note"||u==="chord"){const m=zs.tryStartShapeDrag({actualX:o+s,canvasY:i}),g=!m&&$s.tryStartShapeDrag({actualX:o+s,canvasY:i});if(m||g)return;const f=It.getSixteenthStampAtPosition(a,r),p=qe(a,l.state),v=p===null?null:It.getTripletStampAtPosition(p,r);if(f||v)return}const h=gn.handleToolMouseDown({toolType:u,colIndex:a,rowIndex:r,actualX:o+s,canvasY:i,state:{isDragging:He,isEraserDragActive:$e,activeNote:kt,activeChordNotes:Le,activePreviewPitches:Qt,lastDragRow:we}});if(h.handled){He=h.state.isDragging,$e=h.state.isEraserDragActive,kt=h.state.activeNote,Le=h.state.activeChordNotes,Qt=h.state.activePreviewPitches,we=h.state.lastDragRow;return}}}function Pp(n){if(Al()){Tn();return}if(!yt)return;const t=n.target instanceof Element?n.target:null;if(!t)return;const e=t.getBoundingClientRect(),o=n.clientX-e.left,i=n.clientY-e.top,s=document.getElementById("canvas-container")?.scrollLeft??0,a=Se.getColumnIndex(o+s),r=Se.getPitchRowIndex(i);if(!yt)return;yt.clearRect(0,0,qt(yt.canvas),Pt(yt.canvas));const c=n.target instanceof HTMLElement?n.target:null,d=l.state.selectedTool,u=o+s,h=qe(a,l.state);if(gn.handleToolMouseMoveBeforeBoundsCheck({actualX:u,rowIndex:r,canvasEl:c,state:{isDragging:He,isEraserDragActive:$e,activeNote:kt,activeChordNotes:Le,activePreviewPitches:Qt,lastDragRow:we}}).handled)return;gn.handleToolHoverVisuals({toolType:d,actualX:u,canvasY:i,pitchHoverCtx:yt,canvasEl:c,selectedModulationRatio:l.state.selectedModulationRatio,findNearestMeasureBoundary:Pl,drawModulationPreview:Tp});const g=(l.state.selectedTool==="note"||l.state.selectedTool==="chord")&&l.state.selectedNote?.shape==="circle",f=l.state.columnWidths.length,p=g?f-1:f;if(a<0||a>=p||Pn(r)===null){ai.resetHoverState(),gl();return}pl(a,r);const v=It.getSixteenthStampAtPosition(a,r),w=h===null?null:It.getTripletStampAtPosition(h,r),y=!!(v||w),C=y&&(d==="note"||d==="chord");if(y&&d!=="eraser"&&!zs.isDraggingShape()&&!$s.isDraggingShape()?wp(c):bl(),(d==="sixteenthStamp"||d==="tripletStamp")&&y)return;const M=gn.handleNoteOrChordDragMouseMove({colIndex:a,rowIndex:r,state:{isDragging:He,isEraserDragActive:$e,activeNote:kt,activeChordNotes:Le,activePreviewPitches:Qt,lastDragRow:we}});if(M.handled){He=M.state.isDragging,$e=M.state.isEraserDragActive,kt=M.state.activeNote,Le=M.state.activeChordNotes,Qt=M.state.activePreviewPitches,we=M.state.lastDragRow;return}if(!C&&gn.handleChordToolHover({colIndex:a,rowIndex:r,pitchHoverCtx:yt,zoomLevel:Ht.getViewportInfo().zoomLevel,drawSingleColumnOvalNote:Ps,drawTwoColumnOvalNote:Es}))return;if(fi.handleMouseMove({event:n,colIndex:a,rowIndex:r,annotationService:Mt})){jn(a,r,"rgba(220, 53, 69, 0.3)");return}if(yl.handleMouseMove(a,r,$e)){jn(a,r,"rgba(220, 53, 69, 0.3)");return}if(yt&&ai.handleMouseMove({colIndex:a,rowIndex:r,hoverCtx:yt,getPitchForRow:Pn})||C)return;const A=Gt(l.state),x=l.state.selectedNote?.shape==="circle";let k=null,S=!0;if(l.state.selectedTool==="note"||l.state.selectedTool==="chord")S=no(a,l.state)&&(!x||no(a+1,l.state));else if(l.state.selectedTool==="sixteenthStamp"){const D=vs(a);S=D!==null&&!Zi(D,A)&&!Zi(D+1,A)}else if(l.state.selectedTool==="tripletStamp"){const D=lo.getSelectedTripletStamp();if(D){const W=qe(a,l.state);if(W===null)S=!1;else{k=W;const G=(Fr[D.span]??1)*2,Y=Kt(k,l.state);S=!0;for(const O of A){const j=O.columnIndex,at=O.columnIndex+1;if(j>=Y&&j<Y+G){S=!1;break}if(Y>=j&&Y<=at){S=!1;break}}}}}const E=l.state.selectedTool==="eraser"?"rgba(220, 53, 69, 0.3)":S?Cl(.2):"rgba(220, 53, 69, 0.15)";if(jn(a,r,E),l.state.selectedTool==="sixteenthStamp"){const D=hi.getSelectedSixteenthStamp();if(D&&S){const W=vs(a);if(W===null)return;const Q={cellWidth:l.state.cellWidth,cellHeight:l.state.cellHeight,columnWidths:l.state.columnWidths,musicalColumnWidths:l.state.columnWidths,tempoModulationMarkers:l.state.tempoModulationMarkers,baseMicrobeatPx:l.state.cellWidth,macrobeatGroupings:l.state.macrobeatGroupings,previewColor:ir()};ih(yt,W,r,D,Q)}}else if(l.state.selectedTool==="tripletStamp"){const D=lo.getSelectedTripletStamp();if(D&&S&&k!==null){const W={cellWidth:l.state.cellWidth,cellHeight:l.state.cellHeight,columnWidths:l.state.columnWidths,musicalColumnWidths:l.state.columnWidths,tempoModulationMarkers:l.state.tempoModulationMarkers,baseMicrobeatPx:l.state.cellWidth,macrobeatGroupings:l.state.macrobeatGroupings,previewColor:ir()};lh(yt,k,r,D,W)}}else S&&Ml(a,r)}function Tn(){yt&&yt.clearRect(0,0,qt(yt.canvas),Pt(yt.canvas)),bl(),ai.resetHoverState(),gl()}function El(){if(!gn.handleToolMouseUp()){if(Qt.length>0){It.stopCurrentPattern();const n=kt?.color??Le[0]?.color??l.state.selectedNote?.color;n&&Xt.releasePitches(Qt,n);const t=kt;if(t&&n)l.state.timbres[n]?.adsr&&l.state.fullRowData[t.row]?.hex;else if(n){const o=Qt[0];if(!o){Qt=[];return}const i=l.state.fullRowData.find(s=>s.toneNote===o);i&&l.state.timbres[n]?.adsr&&i.hex}Qt=[];const e=window.waveformVisualizer;e&&e.stopLiveVisualization()}kt?.uuid&&pn.has(kt.uuid)&&(l.emit("noteRelease",{noteId:kt.uuid,color:kt.color}),pn.delete(kt.uuid)),Le.forEach(n=>{n?.uuid&&pn.has(n.uuid)&&(l.emit("noteRelease",{noteId:n.uuid,color:n.color}),pn.delete(n.uuid))}),He&&l.recordState(),He=!1,we=null,kt?.uuid&&l.emit("noteInteractionEnd",{noteId:kt.uuid}),Le.forEach(n=>{n.uuid&&l.emit("noteInteractionEnd",{noteId:n.uuid})}),kt=null,Le=[],$e&&(l.recordState(),$e=!1),fi.handleGlobalMouseUp(),Tn()}}function Pl(n){const{macrobeatBoundaryStyles:t}=l.state,e=100,o=[],i=l.state.tempoModulationMarkers&&l.state.tempoModulationMarkers.length>0;b.debug("PitchGridInteractor","Boundary calculation modulation state",{hasModulation:i},"grid");for(let c=0;c<t.length;c++)if(t[c]==="solid"){const d=Zt(l.state,c);if(d){const u=d.endColumn+1,h=J(u,{...l.state,tempoModulationMarkers:l.state.tempoModulationMarkers||[],cellWidth:l.state.cellWidth,columnWidths:l.state.columnWidths,musicalColumnWidths:l.state.columnWidths,baseMicrobeatPx:l.state.cellWidth});b.debug("PitchGridInteractor","Computed measure boundary",{boundaryIndex:c,endColumn:d.endColumn,calculatedX:h,method:"canvas-space"},"grid"),o.push({measureIndex:c+1,xPosition:h,macrobeatIndex:c})}}const s=J(0,{...l.state,tempoModulationMarkers:l.state.tempoModulationMarkers||[],cellWidth:l.state.cellWidth,columnWidths:l.state.columnWidths,musicalColumnWidths:l.state.columnWidths,baseMicrobeatPx:l.state.cellWidth});b.debug("PitchGridInteractor","Start boundary position",{startBoundaryX:s,method:"canvas-space"},"grid"),o.unshift({measureIndex:0,xPosition:s,macrobeatIndex:-1}),b.debug("PitchGridInteractor","Available measure boundaries",{boundaries:o},"grid"),b.debug("PitchGridInteractor","Modulation click context",{clickX:n,tolerance:e},"grid");let a=null,r=1/0;return o.forEach(c=>{const d=Math.abs(n-c.xPosition);b.debug("PitchGridInteractor","Boundary distance check",{boundaryX:c.xPosition,distance:d},"grid"),d<=e&&d<r&&(r=d,a=c)}),a?b.debug("PitchGridInteractor","Found closest boundary",{boundary:a,distance:r},"grid"):b.debug("PitchGridInteractor","No boundary found within tolerance",{tolerance:e},"grid"),a}function Tp(n,t,e){if(!e)return;const o=mr(e),i=fr(e);n.save();const s=3,a=2,r=Pt(n.canvas);n.strokeStyle=o,n.lineWidth=a,n.globalAlpha=.7,n.setLineDash([]);for(let c=-1;c<=1;c++){const d=t+c*s;n.beginPath(),n.moveTo(d,0),n.lineTo(d,r),n.stroke()}n.globalAlpha=.8,n.font="12px Arial, sans-serif",n.textAlign="center",n.textBaseline="top",n.fillStyle=o,n.fillText(`Preview: ${i}`,t,10),n.restore()}function Ip(){const n=document.getElementById("notation-grid"),t=document.getElementById("hover-canvas");if(!n||!t){b.error("PitchGridInteractor","Could not find required canvas elements.",{hasPitchCanvas:!!n,hasHoverCanvas:!!t},"grid");return}if(yt=t.getContext("2d"),!yt){b.error("PitchGridInteractor","Could not get hover canvas context.",null,"grid");return}Bn.setPitchCanvasElement(n),n.addEventListener("mousedown",Ep),n.addEventListener("mousemove",Pp),n.addEventListener("mouseleave",Tn),n.addEventListener("contextmenu",e=>e.preventDefault()),n.addEventListener("touchstart",e=>Bn.handleTouchStart(e),{passive:!1}),n.addEventListener("touchmove",e=>Bn.handleTouchMove(e),{passive:!1}),n.addEventListener("touchend",e=>Bn.handleTouchEnd(e),{passive:!1}),n.addEventListener("touchcancel",()=>Bn.handleTouchCancel(),{passive:!1}),window.addEventListener("mouseup",El)}const Lp={init(){Ip(),i0(),document.addEventListener("canvasResized",()=>{this.renderPitchGrid(),this.renderDrumGrid()}),l.on("animationUpdate",n=>{n.type==="vibrato"&&n.activeColors&&n.activeColors.length>0?this.renderPitchGrid():n.type==="envelopeFill"||n.hasEnvelopeFills?this.renderPitchGrid():n.type==="combined"&&n.vibratoColors&&n.vibratoColors.length>0&&this.renderPitchGrid()}),b.debug("GridManager","Initialized pitch and drum grid interactions",null,"grid")},renderPitchGrid:En.render,renderDrumGrid:te.render};function kp(){const n=jt.init();return eo.setContexts(n),Q0.init(),Lp.init(),n}class Np{currentTool=null;toolButtons=[];toolPanels=[];lastSelectedNote=null;optionsContainers={arrow:null,text:null,marker:null,highlighter:null,lasso:null};settings={arrow:{lineStyle:"solid",strokeWeight:4,startArrowhead:"none",endArrowhead:"filled-arrow",arrowheadSize:12},text:{color:"#000000",size:16,bold:!1,italic:!1,underline:!1,background:!1,superscript:!1,subscript:!1},marker:{color:"#4a90e2",size:6},highlighter:{color:"#4a90e2",size:10},lasso:{}};initialize(){if(this.toolButtons=document.querySelectorAll(".draw-tool-button"),this.toolPanels=document.querySelectorAll(".draw-tool-panel"),this.optionsContainers={arrow:document.getElementById("arrow-tool-options"),text:document.getElementById("text-tool-options"),marker:document.getElementById("marker-tool-options"),highlighter:document.getElementById("highlighter-tool-options"),lasso:document.getElementById("lasso-tool-options")},!this.toolButtons.length||!this.optionsContainers.arrow){b.warn("DrawToolsController","Could not find draw tool elements",null,"draw");return}this.attachEventListeners(),this.setupChordTabListeners(),this.setupMainTabListeners(),this.populateAllPanels(),this.initializePanelWidthSync(),this.logPanelMetrics(),window.addEventListener("resize",()=>this.logPanelMetrics(),{passive:!0}),l.on("noteChanged",({newNote:t}={})=>{this.lastSelectedNote=t??null,this.currentTool&&this.deselectAllTools()})}attachEventListeners(){this.toolButtons.forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.drawTool;this.selectTool(e)})})}setupMainTabListeners(){document.querySelectorAll(".tab-button").forEach(e=>{e.addEventListener("click",()=>{e.dataset.tab!=="pitch"&&this.currentTool&&(this.deselectAllTools(),this.restoreLastSelectedNote())})})}setupChordTabListeners(){document.querySelectorAll(".pitch-tab-button").forEach(e=>{e.addEventListener("click",()=>{e.dataset.pitchTab!=="draw"&&this.currentTool&&(this.deselectAllTools(),this.restoreLastSelectedNote())})})}restoreLastSelectedNote(){this.lastSelectedNote?(l.setSelectedNote(this.lastSelectedNote.shape,this.lastSelectedNote.color),l.setSelectedTool("note")):l.state.selectedNote&&(l.setSelectedNote(l.state.selectedNote.shape,l.state.selectedNote.color),l.setSelectedTool("note"))}deselectAllTools(){this.toolButtons.forEach(t=>t.classList.remove("active")),this.toolPanels.forEach(t=>t.classList.remove("active")),this.currentTool=null,Mt.setTool(null,null),l.state.selectedTool==="draw"&&l.setSelectedTool("note")}selectTool(t){this.toolButtons.forEach(o=>o.classList.remove("active")),this.toolPanels.forEach(o=>o.classList.remove("active"));const e=Array.from(this.toolButtons).find(o=>o.dataset.drawTool===t);e&&(e.classList.add("active"),e.closest(".draw-tool-panel")?.classList.add("active")),this.currentTool=t,Mt.setTool(t,this.settings),l.setSelectedTool("draw"),l.state.selectedNote={shape:"circle",color:l.state.selectedNote?.color||"#4a90e2"}}populateAllPanels(){this.populateArrowOptions(),this.populateTextOptions(),this.populateMarkerOptions(),this.populateHighlighterOptions()}initializePanelWidthSync(){const t=Array.from(this.toolPanels);t.length&&t.forEach(e=>{e.style.minWidth="",e.style.width="fit-content",e.style.maxWidth="100%",e.style.flex="0 0 auto"})}logPanelMetrics(){try{const t=document.querySelector(".draw-layout-grid");Array.from(this.toolPanels??[]).forEach(o=>{o.getBoundingClientRect()}),t?.getBoundingClientRect()}catch{}}populateArrowOptions(){const t=this.optionsContainers.arrow;if(!t)return;const e=t.querySelector("#arrow-start-head-trigger"),o=t.querySelector("#arrow-end-head-trigger"),i=(m,g)=>g!=="filled-arrow"?`
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="4" y1="12" x2="20" y2="12"/>
          </svg>
        `:m==="start"?`
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9,5 3,12 9,19"/>
            <line x1="3" y1="12" x2="21" y2="12"/>
          </svg>
        `:`
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15,5 21,12 15,19"/>
          <line x1="3" y1="12" x2="21" y2="12"/>
        </svg>
      `,s=(m,g,f)=>{m&&(m.innerHTML=i(g,f))},a=t.querySelector("#arrow-stroke-weight");a&&(a.value=`${this.settings.arrow.strokeWeight}`,a.addEventListener("input",()=>{this.settings.arrow.strokeWeight=parseInt(a.value,10),Mt.setTool("arrow",this.settings)}));const r=t.querySelector("#arrow-head-size");r&&(r.value=`${this.settings.arrow.arrowheadSize}`,r.addEventListener("input",()=>{this.settings.arrow.arrowheadSize=parseInt(r.value,10),Mt.setTool("arrow",this.settings)}));const c=Array.from(t.querySelectorAll("[data-line-style]"));if(c.length){const m=g=>{c.forEach(f=>f.classList.toggle("active",f.dataset.lineStyle===g))};m(this.settings.arrow.lineStyle),c.forEach(g=>{g.addEventListener("click",()=>{const f=g.dataset.lineStyle;f&&(this.settings.arrow.lineStyle=f,m(f),Mt.setTool("arrow",this.settings))})})}const d=Array.from(t.querySelectorAll("[data-arrow-start]"));if(d.length){const m=g=>{d.forEach(f=>f.classList.toggle("active",f.dataset.arrowStart===g)),s(e,"start",g)};m(this.settings.arrow.startArrowhead),d.forEach(g=>{g.addEventListener("click",()=>{const f=g.dataset.arrowStart;f&&(this.settings.arrow.startArrowhead=f,m(f),Mt.setTool("arrow",this.settings))})})}const u=Array.from(t.querySelectorAll("[data-arrow-end]"));if(u.length){const m=g=>{u.forEach(f=>f.classList.toggle("active",f.dataset.arrowEnd===g)),s(o,"end",g)};m(this.settings.arrow.endArrowhead),u.forEach(g=>{g.addEventListener("click",()=>{const f=g.dataset.arrowEnd;f&&(this.settings.arrow.endArrowhead=f,m(f),Mt.setTool("arrow",this.settings))})})}const h=t.querySelector("#arrow-swap-heads");h&&h.addEventListener("click",()=>{const m=this.settings.arrow.startArrowhead;if(this.settings.arrow.startArrowhead=this.settings.arrow.endArrowhead,this.settings.arrow.endArrowhead=m,d.length){const g=this.settings.arrow.startArrowhead;d.forEach(f=>f.classList.toggle("active",f.dataset.arrowStart===g)),s(e,"start",g)}if(u.length){const g=this.settings.arrow.endArrowhead;u.forEach(f=>f.classList.toggle("active",f.dataset.arrowEnd===g)),s(o,"end",g)}Mt.setTool("arrow",this.settings)})}populateTextOptions(){const t=this.optionsContainers.text;if(!t)return;const e=t.querySelector("#text-size-input");e&&(e.value=`${this.settings.text.size}`,e.addEventListener("input",()=>{this.settings.text.size=parseInt(e.value,10),Mt.setTool("text",this.settings)}));const o=Array.from(t.querySelectorAll(".draw-color-button"));if(o.length){const s=a=>{o.forEach(r=>{const c=r.dataset.color||"";r.classList.toggle("active",c.toLowerCase()===a.toLowerCase())})};s(this.settings.text.color),o.forEach(a=>{a.addEventListener("click",()=>{const r=a.dataset.color;r&&(this.settings.text.color=r,s(r),Mt.setTool("text",this.settings))})})}const i=Array.from(t.querySelectorAll("[data-text-style]"));if(i.length){const s=["bold","italic","underline","background","superscript","subscript"],a=r=>{this.settings.text[r]=!this.settings.text[r],Mt.setTool("text",this.settings)};i.forEach(r=>{const c=r.dataset.textStyle;c&&s.includes(c)&&r.classList.toggle("active",!!this.settings.text[c])}),i.forEach(r=>{r.addEventListener("click",()=>{const c=r.dataset.textStyle;!c||!s.includes(c)||(a(c),r.classList.toggle("active",!!this.settings.text[c]))})})}}populateMarkerOptions(){const t=this.optionsContainers.marker;if(!t)return;const e=t.querySelector("#marker-size-input");e&&(e.value=`${this.settings.marker.size}`,e.addEventListener("input",()=>{this.settings.marker.size=parseInt(e.value,10),Mt.setTool("marker",this.settings)}));const o=Array.from(t.querySelectorAll(".draw-color-button"));if(o.length){const i=s=>{o.forEach(a=>{const r=a.dataset.color||"";a.classList.toggle("active",r.toLowerCase()===s.toLowerCase())})};i(this.settings.marker.color),o.forEach(s=>{s.addEventListener("click",()=>{const a=s.dataset.color;a&&(this.settings.marker.color=a,i(a),Mt.setTool("marker",this.settings))})})}}populateHighlighterOptions(){const t=this.optionsContainers.highlighter;if(!t)return;const e=t.querySelector("#highlighter-size-input");e&&(e.value=`${this.settings.highlighter.size}`,e.addEventListener("input",()=>{this.settings.highlighter.size=parseInt(e.value,10),Mt.setTool("highlighter",this.settings)}));const o=Array.from(t.querySelectorAll(".draw-color-button"));if(o.length){const i=s=>{o.forEach(a=>{const r=a.dataset.color||"";a.classList.toggle("active",r.toLowerCase()===s.toLowerCase())})};i(this.settings.highlighter.color),o.forEach(s=>{s.addEventListener("click",()=>{const a=s.dataset.color;a&&(this.settings.highlighter.color=a,i(a),Mt.setTool("highlighter",this.settings))})})}}}const Rp=new Np;function Bp(){return Mt.initialize(),Rp.initialize?.(),b.initSuccess("DrawSystem"),typeof window<"u"&&(window.annotationService=Mt),{annotationService:Mt}}b.moduleLoaded("KeyboardHandler","keyboard");function Dp(){document.addEventListener("keydown",n=>{const t=document.activeElement;if(!t)return;const e=t.tagName.toLowerCase(),o=t.contentEditable==="true";if(["input","textarea"].includes(e)||o)return;if(n.ctrlKey&&n.key.toLowerCase()==="p"){n.preventDefault(),b.info("KeyboardHandler","Ctrl+P pressed. Opening print preview",null,"keyboard"),l.emit("printPreviewStateChanged",!0);return}if(n.ctrlKey&&n.key.toLowerCase()==="z"){n.preventDefault(),l.undo();return}if(n.ctrlKey&&n.key.toLowerCase()==="y"){n.preventDefault(),l.redo();return}let i=!1;switch(n.key){case"Backspace":case"Delete":if(l.state.lassoSelection?.isActive){const s=l.state.lassoSelection.selectedItems;s.forEach(a=>{if(a.type==="note"){const r=a.data,c=l.state.placedNotes.findIndex(d=>d.uuid===r.uuid);c!==-1&&l.state.placedNotes.splice(c,1)}else if(a.type==="sixteenthStamp"){const r=a.data,c=l.state.sixteenthStampPlacements.findIndex(d=>d.id===r.id);c!==-1&&l.state.sixteenthStampPlacements.splice(c,1)}else if(a.type==="tripletStamp"){const r=a.data,c=l.state.tripletStampPlacements.findIndex(d=>d.id===r.id);c!==-1&&l.state.tripletStampPlacements.splice(c,1)}}),l.state.lassoSelection={selectedItems:[],convexHull:null,isActive:!1},l.recordState(),l.emit("render"),i=!0,b.info("KeyboardHandler",`Deleted ${s.length} items from lasso selection`,null,"keyboard")}break}i&&n.preventDefault()}),b.info("KeyboardHandler","Initialized",null,"keyboard")}b.moduleLoaded("TransportKeyboardShortcuts","keyboard");function Fp(){const n=document.activeElement;if(!(n instanceof HTMLElement))return!0;const t=n.tagName.toLowerCase();return!(["input","textarea","select"].includes(t)||n.isContentEditable)}function Wp(){let n=!1;document.addEventListener("keydown",t=>{if(t.code!=="Space"||n||t.repeat||!Fp())return;const e=document.getElementById("play-button");e&&(t.preventDefault(),n=!0,e.click())}),document.addEventListener("keyup",t=>{t.code==="Space"&&(n=!1)}),b.info("TransportKeyboardShortcuts","Initialized",null,"keyboard")}const Op=[{label:"Toolbar",selector:"#toolbar"},{label:"Toolbar Primary",selector:"#toolbar-primary"},{label:"Primary Actions Grid",selector:"#toolbar-primary .primary-toolbar-actions"},{label:"Primary Playback Row",selector:"#toolbar-primary .primary-toolbar-playback"},{label:"Toolbar Secondary",selector:"#toolbar-secondary"},{label:"Toolbar Preset Controls",selector:"#toolbar-secondary .preset-effects-controls"},{label:"Toolbar Tab Sidebar",selector:"#toolbar-secondary .tab-sidebar"},{label:"Sidebar",selector:"#sidebar"},{label:"Timbre Tab Panel",selector:"#timbre-panel"},{label:"Pitch Tab Panel",selector:"#pitch-panel"},{label:"Rhythm Tab Panel",selector:"#rhythm-panel"},{label:"Macrobeat Tools",selector:"#canvas-macrobeat-tools, #macrobeat-tools"},{label:"Waveform Card",selector:"#timbre-panel .waveform-content-box"},{label:"Preset Card",selector:"#timbre-panel .preset-content-box"},{label:"Effects Card",selector:"#timbre-panel #effects-panel .effects-content-box"},{label:"Envelope Card",selector:"#adsr-envelope"},{label:"Harmonics Card",selector:".harmonic-bins-container"},{label:"Canvas Container",selector:"#canvas-container"},{label:"Pitch Grid Wrapper",selector:"#pitch-grid-wrapper"},{label:"Pitch Grid Container",selector:"#pitch-grid-container"},{label:"Drum Grid Wrapper",selector:"#drum-grid-wrapper"},{label:"Drum Grid",selector:"#drum-grid"}],bs=new Map;let ws,Oi,_i=null,Dn="",vn=!1;function No(n){return Number.isFinite(n)?Number(n.toFixed(1)):n}function _p(n){const t=n.getBoundingClientRect(),e=window.getComputedStyle(n);return{tag:n.tagName.toLowerCase(),id:n.id||null,class:n.className||null,top:No(t.top),left:No(t.left),width:No(t.width),height:No(t.height),offsetWidth:n.offsetWidth,offsetHeight:n.offsetHeight,scrollWidth:n.scrollWidth,scrollHeight:n.scrollHeight,clientWidth:n.clientWidth,clientHeight:n.clientHeight,display:e.display,position:e.position,overflowX:e.overflowX,overflowY:e.overflowY,transform:e.transform!=="none"?e.transform:void 0}}function Tl(n="manual"){const t=window.__uiDiagnosticsTrackedElements;if(!t)return[];if(!vn&&n!=="manual")return[];Uo();const e=[];return t.forEach(o=>{const i=Array.from(document.querySelectorAll(o.selector));if(!i.length){e.push({label:o.label,selector:o.selector,missing:!0});return}i.forEach((s,a)=>{const r=i.length>1?`${o.label} [${a}]`:o.label,c=_p(s);e.push({label:r,selector:o.selector,info:c})})}),window.__uiDiagnosticsLastSnapshot=e,e}function un(n){vn&&(Dn=Dn?`${Dn}; ${n}`:n,_i===null&&(_i=requestAnimationFrame(()=>{const t=Dn||"auto";_i=null,Dn="",Tl(t)})))}function Uo(){const n=window.__uiDiagnosticsTrackedElements;!n||!ws||n.forEach(t=>{document.querySelectorAll(t.selector).forEach(o=>{bs.has(o)||(bs.set(o,t.label),ws.observe(o),o.addEventListener("scroll",()=>un(`${t.label} scroll`),{passive:!0}))})})}function zp(n={}){if(window.__uiDiagnosticsInitialized)return;window.__uiDiagnosticsInitialized=!0;const{elements:t,autoLog:e=!1}=n;vn=!!e,window.__uiDiagnosticsAutoLog=vn;const o=t||Op;window.__uiDiagnosticsTrackedElements=o,ws=new ResizeObserver(i=>{const s=i.map(a=>bs.get(a.target)||a.target.id||a.target.tagName.toLowerCase()).filter(Boolean);s.length&&un(`Resize: ${s.join(", ")}`)}),Oi=new MutationObserver(()=>Uo()),document.body?Oi.observe(document.body,{childList:!0,subtree:!0}):document.addEventListener("DOMContentLoaded",()=>{Oi.observe(document.body,{childList:!0,subtree:!0}),Uo(),un("init")},{once:!0}),window.addEventListener("resize",()=>un("window resize")),Uo(),un("init"),window.logUIState=(i="manual")=>Tl(i),window.enableUIDiagnosticsAutoLog=()=>{vn=!0,window.__uiDiagnosticsAutoLog=!0,un("auto-log enabled")},window.disableUIDiagnosticsAutoLog=()=>{vn=!1,window.__uiDiagnosticsAutoLog=!1}}function $p(){b.section("SETTING UP INPUT HANDLERS"),Dp(),Wp(),tp(),window.enableUIDiagnostics&&zp()}const Hp=()=>{if(typeof window>"u")return!1;const n=window.__initDebug;return n===!0},ge=(n,t)=>{if(Hp()){if(t===void 0){console.log(`[Init] ${n}`);return}console.log(`[Init] ${n}`,t)}};let ys=!1,Ke=[],zi=!1,cn=null,$i=!1;function qp(){zi=!1,cn=null,$i=!1,window.initAudio=async()=>{if(!zi)return cn||(cn=(async()=>{try{Pe.state!=="running"&&(await Xo(),b.info("Main.js","AudioContext started successfully")),zi=!0}catch(e){throw b.error("Main.js","Could not start AudioContext",e),cn=null,e}})(),cn)};const n=()=>{$i||($i=!0,window.initAudio?.().catch(e=>b.warn("Main.js","Failed to initialize audio after user interaction",e,"initialization")),document.removeEventListener("click",n,!0),document.removeEventListener("keydown",n,!0),document.removeEventListener("touchstart",n,!0))},t=()=>{typeof St.teardown=="function"&&St.teardown()};document.addEventListener("click",n,!0),document.addEventListener("keydown",n,!0),document.addEventListener("touchstart",n,!0),window.addEventListener("beforeunload",t),Ke.push(()=>document.removeEventListener("click",n,!0)),Ke.push(()=>document.removeEventListener("keydown",n,!0)),Ke.push(()=>document.removeEventListener("touchstart",n,!0)),Ke.push(()=>window.removeEventListener("beforeunload",t)),Ke.push(()=>{delete window.initAudio})}const In={domCache:!1,layoutService:!1,canvasContextService:!1,synthEngine:!1,transportService:!1,scrollSync:!1,uiComponents:!1,audioComponents:!1,rhythmPlaybackService:!1,initialized:!1},Gp={top:"G5",bottom:"C4"};function Vp(n){if(!n?.top||!n?.bottom)return null;const t=ue.findIndex(o=>o.toneNote===n.top),e=ue.findIndex(o=>o.toneNote===n.bottom);return t===-1||e===-1?(b.warn("Main.js","Failed to resolve preset range from tone notes",n),null):{topIndex:Math.min(t,e),bottomIndex:Math.max(t,e)}}function Up(){return Vp(Gp)}function Ae(n){In[n]=!0}function sr(n,t=5e3){return new Promise((e,o)=>{if(In[n]){e();return}const i=Date.now(),s=()=>{In[n]?e():Date.now()-i>t?o(new Error(`Component ${n} not ready within ${t}ms`)):setTimeout(s,50)};s()})}function Il(){Object.keys(In).forEach(n=>{In[n]=!1})}async function Xp(){window.initStartTime=Date.now(),b.info("Main.js","Initialization triggered"),b.section("STARTING INITIALIZATION");const n=["dom-cache","drum-samples","state-setup","canvas-services","layout-ready","synth-engine","rhythm-playback","transport-service","input-handlers","store-hooks","ui-components","audio-components","state-subscriptions","initial-render","finalize"];try{lt.init(),n.forEach(c=>lt.registerTask(c)),ge("startup rhythm defaults",{macrobeatGroupings:l.state.macrobeatGroupings,macrobeatBoundaryStyles:l.state.macrobeatBoundaryStyles});const t=l.state.selectedNote?.color??"#4a90e2",e=l.state.timbres?.[t];ge("startup adsr defaults",{color:t,adsr:e?.adsr??null,preset:e?.activePresetName??null}),await lt.nextFrame(),Df(),_d({latencyHint:"playback",lookAhead:.1}),b.info("Main.js","AudioContext configured with latencyHint: playback"),(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&Jr(),lt.updateStatus("Initializing interface..."),Ne.init(),Ae("domCache"),lt.completeTask("dom-cache"),await lt.nextFrame(),lt.updateStatus("Loading audio samples..."),await Yf(),lt.completeTask("drum-samples"),b.info("Main.js","Drum samples preloaded"),await lt.nextFrame(),(()=>{const c=Ne.get("appContainer")||document.getElementById("app-container");if(c){const d=["click","keydown","touchstart"],u=()=>{window.initAudio?.()};d.forEach(h=>{c.addEventListener(h,u,{once:!0})})}})(),lt.updateStatus("Preparing core systems..."),$f(l.state);const i=l.state.pitchRange||{topIndex:0,bottomIndex:ue.length-1},s=Math.max(0,Math.min(ue.length-1,i.topIndex??0)),a=Math.max(s,Math.min(ue.length-1,i.bottomIndex??ue.length-1));l.state.pitchRange={topIndex:s,bottomIndex:a},l.state.fullRowData=[...ue],lt.completeTask("state-setup"),await lt.nextFrame(),lt.updateStatus("Sizing canvas..."),kp(),Ae("layoutService"),Ae("canvasContextService"),lt.completeTask("canvas-services"),await lt.nextFrame(),lt.updateStatus("Calculating layout..."),await jt.waitForInitialLayout(),lt.completeTask("layout-ready"),await lt.nextFrame(),lt.updateStatus("Initializing synth engine..."),St.init(),Ae("synthEngine"),lt.completeTask("synth-engine"),await lt.nextFrame(),lt.updateStatus("Preparing rhythm playback..."),It.initialize().catch(c=>{b.warn("Main.js","RhythmPlaybackService initialization deferred (needs user interaction)",c,"initialization")}),Ae("rhythmPlaybackService"),lt.completeTask("rhythm-playback"),await lt.nextFrame(),lt.updateStatus("Configuring transport..."),Ie.init(),Ae("transportService"),lt.completeTask("transport-service"),await lt.nextFrame(),lt.updateStatus("Registering input handlers..."),$p(),lt.completeTask("input-handlers"),await lt.nextFrame(),lt.updateStatus("Syncing state services..."),lu(l),vu(l),qd({getColumnMap:c=>Ft.getColumnMap(c),visualToTimeIndex:(c,d)=>Ft.getColumnMap(c).visualToTime.get(d)??null,timeIndexToVisualColumn:(c,d)=>Ft.getColumnMap(c).timeToVisual.get(d)??null,getTimeBoundaryAfterMacrobeat:(c,d)=>{const h=Ft.getColumnMap(c).macrobeatBoundaries.find(m=>m.macrobeatIndex===d);return h?h.timeColumn+1:0}}),lt.completeTask("store-hooks"),await lt.nextFrame(),lt.updateStatus("Loading interface components..."),ge("Loading interface components..."),ge("initUiComponents:start"),P0(),ge("initUiComponents:done"),Ae("uiComponents"),ge("uiComponents marked ready"),lt.completeTask("ui-components"),ge("ui-components task complete"),await lt.nextFrame(),ge("ui-components nextFrame resolved"),ge("waitForComponent:uiComponents"),await sr("uiComponents"),ge("waitForComponent:uiComponents resolved"),lt.updateStatus("Preparing audio components..."),G0(),Ae("audioComponents"),lt.completeTask("audio-components"),await lt.nextFrame(),Hf(l.state,"audio-components-initialization"),X0(),Bp(),await sr("audioComponents"),b.section("SETTING UP STATE SUBSCRIPTIONS"),lt.updateStatus("Binding state subscriptions...");const r=()=>{try{En.render();const c=window.DrumGridController;c?.render&&c.render(),b.debug("Main","renderAll invoked",null,"grid")}catch(c){b.error("Main","renderAll failed",c,"grid")}};if(lt.completeTask("state-subscriptions"),await lt.nextFrame(),b.section("PERFORMING INITIAL RENDER"),l.setSelectedTool("note"),l.setSelectedNote("circle","#4a90e2"),lt.updateStatus("Rendering workspace..."),r(),En.renderMacrobeatTools(),lt.completeTask("initial-render"),_o.prefetchButtonGridSnapshot(),await lt.nextFrame(),Ae("initialized"),b.section("INITIALIZATION COMPLETE"),lt.updateStatus("Finalizing..."),lt.completeTask("finalize"),await lt.nextFrame(),l.isColdStart){const c=Up();c?Ht.setPitchViewportRange(c,{animateMs:0,source:"coldStart:treble"}):b.warn("Main.js","Treble Clef preset range could not be resolved during cold start")}await lt.complete(),window.ModulationTest=ol}catch(t){b.error("Main.js","Initialization failed",t,"initialization"),b.error("Main.js","Component readiness snapshot at failure",{...In},"initialization");const e=t instanceof Error?t:new Error(String(t));lt.showError(e);const o=document.createElement("div");o.style.cssText=`
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #ff4444; color: white; padding: 20px; border-radius: 8px;
            z-index: 10000; font-family: monospace; max-width: 80vw;
        `,o.innerHTML=`
            <h3>Initialization Error</h3>
            <p>The application failed to initialize properly.</p>
            <details>
                <summary>Technical Details</summary>
                <pre>${e.message}</pre>
                <pre>Stack: ${e.stack}</pre>
            </details>
            <button onclick="location.reload()">Reload Page</button>
        `,document.body.appendChild(o)}}function Yp(){ys||(ys=!0,Il(),qp(),Ne.refresh(),Xp())}function Qp(){Ke.forEach(t=>t()),Ke=[];try{M0()}catch(t){b.warn("Main.js","Failed to unmount Svelte components",t,"cleanup")}typeof St.teardown=="function"&&St.teardown(),typeof It.dispose=="function"&&It.dispose();const n=["is-mobile","is-touch","orientation-portrait","orientation-landscape"];[document.documentElement,document.body].forEach(t=>{n.forEach(e=>t?.classList.remove(e))}),Il(),ys=!1}const jp=Object.assign({"../public/apple-touch-icon.png":wc,"../public/assets/icons/clear.svg":yc,"../public/assets/icons/diamond-note.svg":Sc,"../public/assets/icons/eraser.svg":Cc,"../public/assets/icons/lasso-tool.svg":Ac,"../public/assets/icons/loop.svg":xc,"../public/assets/icons/marker-tool.svg":Mc,"../public/assets/icons/pause.svg":lr,"../public/assets/icons/play.svg":cr,"../public/assets/icons/redo.svg":Ec,"../public/assets/icons/settings.svg":Pc,"../public/assets/icons/stop.svg":Tc,"../public/assets/icons/undo.svg":Ic,"../public/assets/icons/volume.svg":Lc,"../public/assets/icons/zoomIn.svg":kc,"../public/assets/icons/zoomOut.svg":Nc,"../public/assets/sidebar/hideAnalysis.svg":Rc,"../public/assets/sidebar/hideDrums.svg":Bc,"../public/assets/sidebar/newPage.svg":Dc,"../public/assets/sidebar/open.svg":Fc,"../public/assets/sidebar/print.svg":Wc,"../public/assets/sidebar/saveAs.svg":Oc,"../public/assets/tabicons/dottedQuarterNote.svg":_c,"../public/assets/tabicons/eigthNote.svg":zc,"../public/assets/tabicons/phaseButton_0.svg":$c,"../public/assets/tabicons/phaseButton_180.svg":Hc,"../public/assets/tabicons/phaseButton_270.svg":qc,"../public/assets/tabicons/phaseButton_90.svg":Gc,"../public/assets/tabicons/quarterNote.svg":Vc,"../public/assets/tabicons/tonicShape_1.svg":Uc,"../public/assets/tabicons/tonicShape_2.svg":Xc,"../public/assets/tabicons/tonicShape_3.svg":Yc,"../public/assets/tabicons/tonicShape_4.svg":Qc,"../public/assets/tabicons/tonicShape_5.svg":jc,"../public/assets/tabicons/tonicShape_6.svg":Zc,"../public/assets/tabicons/tonicShape_7.svg":Kc,"../public/favicon-96x96.png":Jc,"../public/favicon.ico":td,"../public/favicon.svg":ed,"../public/fonts/atkinsonHyperlegibleNextBold.otf":nd,"../public/fonts/atkinsonHyperlegibleNextRegular.otf":od,"../public/fonts/atkinsonHyperlegibleNextRegularItalic.otf":id,"../public/site.webmanifest":sd,"../public/web-app-manifest-192x192.png":ad,"../public/web-app-manifest-512x512.png":rd}),Zp="../public/",Kp=()=>{if(typeof window>"u")return!1;const n=window.__initDebug;return n===!0},Ro=(n,t)=>{if(Kp()){if(t===void 0){console.log(n);return}console.log(n,t)}};function Jp(n){const t=n.replace(/^\/+/,""),e=`${Zp}${t}`;return jp[e]??n}function tg(n){n.querySelectorAll("[src], [href]").forEach(e=>{const o=e.hasAttribute("src")?"src":"href",i=e.getAttribute(o);!i||i.startsWith("http")||i.startsWith("data:")||i.startsWith("#")||!i.startsWith("assets/")&&!i.startsWith("fonts/")&&!i.startsWith("favicon")||e.setAttribute(o,Jp(i))})}function eg(n){return Ro("[StudentNotation] mount:start",{hasTemplate:!!bi,templateLength:bi.length,containerId:n.id||null}),n.innerHTML=bi,Ro("[StudentNotation] template injected"),tg(n),Ro("[StudentNotation] assets rewritten"),Yp(),Ro("[StudentNotation] initStudentNotation:called"),{destroy:()=>{Qp(),n.innerHTML=""}}}const Ln="[Hub:StudentNotation]",ng=()=>{if(typeof window>"u")return!1;const n=window.__initDebug;return n===!0},ri=(n,t)=>{ng()&&(t===void 0?console.log(`${Ln} ${n}`):console.log(`${Ln} ${n}`,t))};ri("entry");window.addEventListener("error",n=>{console.error(`${Ln} window error`,n.error??n.message)});window.addEventListener("unhandledrejection",n=>{console.error(`${Ln} unhandled rejection`,n.reason)});const Ss=document.getElementById("app");ri("app container",{found:!!Ss});if(Ss)try{ri("mountStudentNotation:start"),eg(Ss),ri("mountStudentNotation:done")}catch(n){console.error(`${Ln} mountStudentNotation failed`,n)}else console.error(`${Ln} #app not found`);
