function Ft(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var at,ft;function At(){if(ft)return at;ft=1;function i(n){if(this.size=n|0,this.size<=1||(this.size&this.size-1)!==0)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=n<<1;for(var t=new Array(this.size*2),r=0;r<t.length;r+=2){const u=Math.PI*r/this.size;t[r]=Math.cos(u),t[r+1]=-Math.sin(u)}this.table=t;for(var e=0,s=1;this.size>s;s<<=1)e++;this._width=e%2===0?e-1:e,this._bitrev=new Array(1<<this._width);for(var a=0;a<this._bitrev.length;a++){this._bitrev[a]=0;for(var o=0;o<this._width;o+=2){var h=this._width-o-2;this._bitrev[a]|=(a>>>o&3)<<h}}this._out=null,this._data=null,this._inv=0}return at=i,i.prototype.fromComplexArray=function(t,r){for(var e=r||new Array(t.length>>>1),s=0;s<t.length;s+=2)e[s>>>1]=t[s];return e},i.prototype.createComplexArray=function(){const t=new Array(this._csize);for(var r=0;r<t.length;r++)t[r]=0;return t},i.prototype.toComplexArray=function(t,r){for(var e=r||this.createComplexArray(),s=0;s<e.length;s+=2)e[s]=t[s>>>1],e[s+1]=0;return e},i.prototype.completeSpectrum=function(t){for(var r=this._csize,e=r>>>1,s=2;s<e;s+=2)t[r-s]=t[s],t[r-s+1]=-t[s+1]},i.prototype.transform=function(t,r){if(t===r)throw new Error("Input and output buffers must be different");this._out=t,this._data=r,this._inv=0,this._transform4(),this._out=null,this._data=null},i.prototype.realTransform=function(t,r){if(t===r)throw new Error("Input and output buffers must be different");this._out=t,this._data=r,this._inv=0,this._realTransform4(),this._out=null,this._data=null},i.prototype.inverseTransform=function(t,r){if(t===r)throw new Error("Input and output buffers must be different");this._out=t,this._data=r,this._inv=1,this._transform4();for(var e=0;e<t.length;e++)t[e]/=this.size;this._out=null,this._data=null},i.prototype._transform4=function(){var t=this._out,r=this._csize,e=this._width,s=1<<e,a=r/s<<1,o,h,u=this._bitrev;if(a===4)for(o=0,h=0;o<r;o+=a,h++){const l=u[h];this._singleTransform2(o,l,s)}else for(o=0,h=0;o<r;o+=a,h++){const l=u[h];this._singleTransform4(o,l,s)}var c=this._inv?-1:1,f=this.table;for(s>>=2;s>=2;s>>=2){a=r/s<<1;var v=a>>>2;for(o=0;o<r;o+=a)for(var p=o+v,g=o,_=0;g<p;g+=2,_+=s){const l=g,m=l+v,d=m+v,b=d+v,w=t[l],A=t[l+1],F=t[m],y=t[m+1],T=t[d],B=t[d+1],I=t[b],x=t[b+1],z=w,R=A,M=f[_],C=c*f[_+1],E=F*M-y*C,V=F*C+y*M,$=f[2*_],K=c*f[2*_+1],G=T*$-B*K,H=T*K+B*$,J=f[3*_],Q=c*f[3*_+1],U=I*J-x*Q,W=I*Q+x*J,X=z+G,D=R+H,S=z-G,Y=R-H,Z=E+U,N=V+W,P=c*(E-U),j=c*(V-W),L=X+Z,O=D+N,tt=X-Z,rt=D-N,st=S+j,nt=Y-P,et=S-j,ot=Y+P;t[l]=L,t[l+1]=O,t[m]=st,t[m+1]=nt,t[d]=tt,t[d+1]=rt,t[b]=et,t[b+1]=ot}}},i.prototype._singleTransform2=function(t,r,e){const s=this._out,a=this._data,o=a[r],h=a[r+1],u=a[r+e],c=a[r+e+1],f=o+u,v=h+c,p=o-u,g=h-c;s[t]=f,s[t+1]=v,s[t+2]=p,s[t+3]=g},i.prototype._singleTransform4=function(t,r,e){const s=this._out,a=this._data,o=this._inv?-1:1,h=e*2,u=e*3,c=a[r],f=a[r+1],v=a[r+e],p=a[r+e+1],g=a[r+h],_=a[r+h+1],l=a[r+u],m=a[r+u+1],d=c+g,b=f+_,w=c-g,A=f-_,F=v+l,y=p+m,T=o*(v-l),B=o*(p-m),I=d+F,x=b+y,z=w+B,R=A-T,M=d-F,C=b-y,E=w-B,V=A+T;s[t]=I,s[t+1]=x,s[t+2]=z,s[t+3]=R,s[t+4]=M,s[t+5]=C,s[t+6]=E,s[t+7]=V},i.prototype._realTransform4=function(){var t=this._out,r=this._csize,e=this._width,s=1<<e,a=r/s<<1,o,h,u=this._bitrev;if(a===4)for(o=0,h=0;o<r;o+=a,h++){const it=u[h];this._singleRealTransform2(o,it>>>1,s>>>1)}else for(o=0,h=0;o<r;o+=a,h++){const it=u[h];this._singleRealTransform4(o,it>>>1,s>>>1)}var c=this._inv?-1:1,f=this.table;for(s>>=2;s>=2;s>>=2){a=r/s<<1;var v=a>>>1,p=v>>>1,g=p>>>1;for(o=0;o<r;o+=a)for(var _=0,l=0;_<=g;_+=2,l+=s){var m=o+_,d=m+p,b=d+p,w=b+p,A=t[m],F=t[m+1],y=t[d],T=t[d+1],B=t[b],I=t[b+1],x=t[w],z=t[w+1],R=A,M=F,C=f[l],E=c*f[l+1],V=y*C-T*E,$=y*E+T*C,K=f[2*l],G=c*f[2*l+1],H=B*K-I*G,J=B*G+I*K,Q=f[3*l],U=c*f[3*l+1],W=x*Q-z*U,X=x*U+z*Q,D=R+H,S=M+J,Y=R-H,Z=M-J,N=V+W,P=$+X,j=c*(V-W),L=c*($-X),O=D+N,tt=S+P,rt=Y+L,st=Z-j;if(t[m]=O,t[m+1]=tt,t[d]=rt,t[d+1]=st,_===0){var nt=D-N,et=S-P;t[b]=nt,t[b+1]=et;continue}if(_!==g){var ot=Y,lt=-Z,ut=D,_t=-S,vt=-c*L,mt=-c*j,dt=-c*P,pt=-c*N,bt=ot+vt,gt=lt+mt,yt=ut+pt,wt=_t-dt,ht=o+p-_,ct=o+v-_;t[ht]=bt,t[ht+1]=gt,t[ct]=yt,t[ct+1]=wt}}}},i.prototype._singleRealTransform2=function(t,r,e){const s=this._out,a=this._data,o=a[r],h=a[r+e],u=o+h,c=o-h;s[t]=u,s[t+1]=0,s[t+2]=c,s[t+3]=0},i.prototype._singleRealTransform4=function(t,r,e){const s=this._out,a=this._data,o=this._inv?-1:1,h=e*2,u=e*3,c=a[r],f=a[r+e],v=a[r+h],p=a[r+u],g=c+v,_=c-v,l=f+p,m=o*(f-p),d=g+l,b=_,w=-m,A=g-l,F=_,y=m;s[t]=d,s[t+1]=0,s[t+2]=b,s[t+3]=w,s[t+4]=A,s[t+5]=0,s[t+6]=F,s[t+7]=y},at}var Tt=At();const Bt=Ft(Tt);class q{_inputLength;_fft;_bufferSupplier;_paddedInputBuffer;_transformBuffer;_inverseBuffer;static forFloat32Array(n){return new q(n,t=>new Float32Array(t))}static forFloat64Array(n){return new q(n,t=>new Float64Array(t))}static forNumberArray(n){return new q(n,t=>Array(t))}constructor(n,t){if(n<1)throw new Error("Input length must be at least one");this._inputLength=n,this._fft=new Bt(zt(2*n)),this._bufferSupplier=t,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}get inputLength(){return this._inputLength}autocorrelate(n,t=this._bufferSupplier(n.length)){if(n.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${n.length}`);for(let e=0;e<n.length;e++)this._paddedInputBuffer[e]=n[e];for(let e=n.length;e<this._paddedInputBuffer.length;e++)this._paddedInputBuffer[e]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const r=this._transformBuffer;for(let e=0;e<r.length;e+=2)r[e]=r[e]*r[e]+r[e+1]*r[e+1],r[e+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let e=0;e<n.length;e++)t[e]=this._inverseBuffer[2*e];return t}}function It(i){const n=[];let t=!1,r=-1/0,e=-1;for(let s=1;s<i.length-1;s++)i[s-1]<=0&&i[s]>0?(t=!0,e=s,r=i[s]):i[s-1]>0&&i[s]<=0?(t=!1,e!==-1&&n.push(e)):t&&i[s]>r&&(r=i[s],e=s);return n}function xt(i,n){const[t,r,e]=[i-1,i,i+1],[s,a,o]=[n[t],n[r],n[e]],h=s/2-a+o/2,u=-(s/2)*(r+e)+a*(t+e)-o/2*(t+r),c=s*r*e/2-a*t*e+o*t*r/2,f=-u/(2*h),v=h*f*f+u*f+c;return[f,v]}class k{_autocorrelator;_nsdfBuffer;_clarityThreshold=.9;_minVolumeAbsolute=0;_maxInputAmplitude=1;static forFloat32Array(n){return new k(n,t=>new Float32Array(t))}static forFloat64Array(n){return new k(n,t=>new Float64Array(t))}static forNumberArray(n){return new k(n,t=>Array(t))}constructor(n,t){this._autocorrelator=new q(n,t),this._nsdfBuffer=t(n)}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(n){if(!Number.isFinite(n)||n<=0||n>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=n}set minVolumeAbsolute(n){if(!Number.isFinite(n)||n<0||n>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=n}set minVolumeDecibels(n){if(!Number.isFinite(n)||n>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(n/10)}set maxInputAmplitude(n){if(!Number.isFinite(n)||n<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=n}findPitch(n,t){if(this._belowMinimumVolume(n))return[0,0];this._nsdf(n);const r=It(this._nsdfBuffer);if(r.length===0)return[0,0];const e=Math.max(...r.map(h=>this._nsdfBuffer[h])),s=r.find(h=>this._nsdfBuffer[h]>=this._clarityThreshold*e),[a,o]=xt(s,this._nsdfBuffer);return[t/a,Math.min(o,1)]}_belowMinimumVolume(n){if(this._minVolumeAbsolute===0)return!1;let t=0;for(let r=0;r<n.length;r++)t+=n[r]**2;return Math.sqrt(t/n.length)<this._minVolumeAbsolute}_nsdf(n){this._autocorrelator.autocorrelate(n,this._nsdfBuffer);let t=2*this._nsdfBuffer[0],r;for(r=0;r<this._nsdfBuffer.length&&t>0;r++)this._nsdfBuffer[r]=2*this._nsdfBuffer[r]/t,t-=n[r]**2+n[n.length-r-1]**2;for(;r<this._nsdfBuffer.length;r++)this._nsdfBuffer[r]=0}}function zt(i){return i--,i|=i>>1,i|=i>>2,i|=i>>4,i|=i>>8,i|=i>>16,i++,i}export{k as P};
