import"./modulepreload-polyfill-B5Qt9EMX.js";import{o as en,q as Tn,r as Pn,v as Cn,w as Sn,x as Ue,y as In,z as Pt,A as Ct,B as An,C as xn,D as Rn,S as tn,E as Nn,F as kn,P as Ln,g as t,G as Dn,H as Hn,i as ke,k as E,I as En,J as On,K as Fn,L as Wn,M as Bn,N as zn,O as qn,Q as Gn,R as Yn,p as pe,u as Re,h as X,l as A,f as D,c as p,s as w,a as k,j as ye,e as Te,t as Z,b as q,T as Un,d as Oe,U as Ke,V as Je,$ as nn,W as Vn,X as jn,m as Xn,n as Kn}from"./legacy-BJBcSenI.js";import{o as sn,j as ze,i as $,q as Zn,t as Jn,k as St,h as qe,f as dt,u as Qn,w as $n,v as ei,x as ti,y as ni,A as tt,S as Nt}from"./navigation-BnREHJnM.js";import{s as It,V as ii,S as an,l as kt,U as si,A as ai,g as oi,P as ri}from"./vendor-tone-Cer4uW5H.js";import{P as li}from"./vendor-pitchy-DoA2xU7W.js";import{e as Ge,i as et,s as at}from"./style-CtguFRYq.js";function At(e,n,i=!1){if(e.multiple){if(n==null)return;if(!Tn(n))return Pn();for(var s of e.options)s.selected=n.includes(Lt(s));return}for(s of e.options){var r=Lt(s);if(Cn(r,n)){s.selected=!0;return}}(!i||n!==void 0)&&(e.selectedIndex=-1)}function on(e){var n=new MutationObserver(()=>{At(e,e.__value)});n.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),en(()=>{n.disconnect()})}function Lt(e){return"__value"in e?e.__value:e.value}function ut(e,n,i=n){var s=new WeakSet;Sn(e,"input",async r=>{var o=r?e.defaultValue:e.value;if(o=ft(e)?ht(o):o,i(o),Ue!==null&&s.add(Ue),await In(),o!==(o=n())){var a=e.selectionStart,c=e.selectionEnd,l=e.value.length;if(e.value=o??"",c!==null){var d=e.value.length;a===c&&c===l&&d>l?(e.selectionStart=d,e.selectionEnd=d):(e.selectionStart=a,e.selectionEnd=Math.min(c,d))}}}),Pt(n)==null&&e.value&&(i(ft(e)?ht(e.value):e.value),Ue!==null&&s.add(Ue)),Ct(()=>{var r=n();if(e===document.activeElement){var o=An??Ue;if(s.has(o))return}ft(e)&&r===ht(e.value)||e.type==="date"&&!r&&!e.value||r!==e.value&&(e.value=r??"")})}function ft(e){var n=e.type;return n==="number"||n==="range"}function ht(e){return e===""?null:+e}function Dt(e,n){return e===n||e?.[tn]===n}function Ne(e={},n,i,s){return xn(()=>{var r,o;return Ct(()=>{r=o,o=[],Pt(()=>{e!==i(...o)&&(n(e,...o),r&&Dt(i(...r),e)&&n(null,...r))})}),()=>{Rn(()=>{o&&Dt(i(...o),e)&&n(null,...o)})}}),e}function rn(e,n,i,s,r){var o=()=>{s(i[e])};i.addEventListener(n,o),r?Ct(()=>{i[e]=r()}):o(),(i===document.body||i===window||i===document)&&en(()=>{i.removeEventListener(n,o)})}let nt=!1;function ci(e){var n=nt;try{return nt=!1,[e(),nt]}finally{nt=n}}function fe(e,n,i,s){var r=!Bn||(i&zn)!==0,o=(i&Wn)!==0,a=(i&Gn)!==0,c=s,l=!0,d=()=>(l&&(l=!1,c=a?Pt(s):s),c),g;if(o){var v=tn in e||Yn in e;g=Nn(e,n)?.set??(v&&n in e?M=>e[n]=M:void 0)}var f,y=!1;o?[f,y]=ci(()=>e[n]):f=e[n],f===void 0&&s!==void 0&&(f=d(),g&&(r&&kn(),g(f)));var h;if(r?h=()=>{var M=e[n];return M===void 0?d():(l=!0,M)}:h=()=>{var M=e[n];return M!==void 0&&(c=void 0),M===void 0?c:M},r&&(i&Ln)===0)return h;if(g){var u=e.$$legacy;return(function(M,x){return arguments.length>0?((!r||!x||u||y)&&g(x?h():M),M):h()})}var m=!1,b=((i&qn)!==0?Dn:Hn)(()=>(m=!1,h()));o&&t(b);var T=On;return(function(M,x){if(arguments.length>0){const C=x?t(b):r&&o?ke(M):M;return E(b,C),m=!0,c!==void 0&&(c=C),M}return En&&m||(T.f&Fn)!==0?b.v:t(b)})}const bt=["#ef8aab","#f48e7d","#e89955","#cdaa42","#a4ba57","#6ec482","#2dc8b1","#16c3da","#58b8f6","#8fa9ff","#ba9bf2","#db8fd4"],Ht=bt[0];function Et(e){const n=parseInt(e.slice(1),16);return[n>>16&255,n>>8&255,n&255]}function di(e,n,i){const s=Math.max(0,Math.min(1,i));return e.map((r,o)=>{const a=n[o]??r;return Math.round(r+s*(a-r))})}function ln(e,n=0){const i=Math.floor(e),s=e-i,r=(i%12-n+12)%12,o=(r+1)%12,a=Et(bt[r]??Ht),c=Et(bt[o]??Ht);return di(a,c,s)}const ui={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11};function fi(e){const n=e.replace(/\d+$/,"");return ui[n]??0}const gt={onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70,accuracyTiers:{perfect:{onsetMs:30,pitchCents:10,coverage:95},good:{onsetMs:75,pitchCents:25,coverage:85},okay:{onsetMs:150,pitchCents:50,coverage:70}}};function hi(e={}){const n={...gt,...e,accuracyTiers:e.accuracyTiers?{...gt.accuracyTiers,...e.accuracyTiers}:gt.accuracyTiers},i=new Map,s=new Map;function r(v,f){return(v-f)*100}function o(v,f){return Math.abs(r(v.midi,f))<=n.pitchToleranceCents}function a(v,f){return v.length===0?0:v.reduce((h,u)=>h+Math.abs(r(u.midi,f)),0)/v.length}function c(v,f,y,h){if(v.length===0)return 0;const u=v.filter(b=>o(b,f));if(u.length===0)return 0;let m=0;for(let b=0;b<u.length;b++){const T=u[b];if(!T)continue;const M=u[b+1];if(M)m+=M.timeMs-T.timeMs;else{const x=y+h,C=Math.min(50,x-T.timeMs);m+=C}}return m/h*100}function l(v,f,y){const h=n.accuracyTiers;if(!h)return"okay";const u=Math.abs(v);return u<=h.perfect.onsetMs&&f<=h.perfect.pitchCents&&y>=h.perfect.coverage?"perfect":u<=h.good.onsetMs&&f<=h.good.pitchCents&&y>=h.good.coverage?"good":u<=h.okay.onsetMs&&f<=h.okay.pitchCents&&y>=h.okay.coverage?"okay":"miss"}function d(v){const{note:f,samples:y,onsetSample:h,releaseSample:u}=v;let m=0;h?m=h.timeMs-f.startTimeMs:m=n.onsetToleranceMs*2;let b=0;const T=f.startTimeMs+f.durationMs;u?b=u.timeMs-T:b=n.releaseToleranceMs*2;const M=a(y,f.midi),x=c(y,f.midi,f.startTimeMs,f.durationMs),C=Math.abs(m)<=n.onsetToleranceMs,P=Math.abs(b)<=n.releaseToleranceMs,I=x>=n.hitThreshold,L=C&&P&&I?"hit":"miss",N=l(m,M,x);return{hitStatus:L,onsetAccuracyMs:m,releaseAccuracyMs:b,pitchAccuracyCents:M,pitchCoverage:x,pitchSamples:[...y],accuracyTier:N}}return{startNote(v,f){i.set(v,{note:f,samples:[],onsetSample:null,releaseSample:null,startedAt:performance.now()})},recordPitchSample(v){for(const[f,y]of i){const{note:h}=y,u=h.startTimeMs+h.durationMs,m=n.onsetToleranceMs,b=n.releaseToleranceMs;v.timeMs>=h.startTimeMs-m&&v.timeMs<=u+b&&(y.samples.push(v),!y.onsetSample&&v.timeMs>=h.startTimeMs-m&&v.timeMs<=h.startTimeMs+m&&o(v,h.midi)&&(y.onsetSample=v),v.timeMs>=u-b&&v.timeMs<=u+b&&(y.releaseSample=v))}},endNote(v){const f=i.get(v);if(!f)return null;const y=d(f);return s.set(v,y),i.delete(v),y},getCurrentPerformance(v){const f=i.get(v);if(!f)return null;const{note:y,samples:h,onsetSample:u}=f;let m=0;u&&(m=u.timeMs-y.startTimeMs);const b=a(h,y.midi),T=c(h,y.midi,y.startTimeMs,y.durationMs);return{onsetAccuracyMs:m,pitchAccuracyCents:b,pitchCoverage:T,pitchSamples:[...h]}},getAllPerformances(){return new Map(s)},reset(){i.clear(),s.clear()},dispose(){i.clear(),s.clear()}}}const Ot={judgmentLinePosition:.12,pixelsPerSecond:200,lookAheadMs:3e3,scrollMode:"constant-speed",leadInBeats:4,playMetronomeDuringOnramp:!0,playTargetNotes:!0,playMetronome:!1,inputSources:["microphone"],feedbackConfig:{onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70}};function gi(e){const n={...Ot,...e,feedbackConfig:{...Ot.feedbackConfig,...e.feedbackConfig}},{stateCallbacks:i,eventCallbacks:s,visualCallbacks:r,logger:o}=n,a={isPlaying:!1,isPaused:!1,currentTimeMs:0,scrollOffset:0,onrampComplete:!1,targetNotes:[],activeNotes:new Set,startTime:null},c=hi(n.feedbackConfig);let l=null;const d=new Set;function g(){const P=60/i.getTempo()*1e3;return n.leadInBeats*P}function v(){return i.getViewportWidth()*n.judgmentLinePosition}function f(C){const P=n.pixelsPerSecond/1e3,I=v(),L=g();return(C+L)*P-I}function y(C){const P=v(),I=i.getCellWidth(),L=C.startColumn*I-a.scrollOffset,N=C.endColumn*I-a.scrollOffset,H=n.feedbackConfig.onsetToleranceMs/1e3*n.pixelsPerSecond;return L<=P+H&&N>=P-H}function h(){const C=new Set;for(const P of a.targetNotes){const I=P.startTimeMs+P.durationMs,L=n.feedbackConfig.onsetToleranceMs;if(a.currentTimeMs>=P.startTimeMs-L&&a.currentTimeMs<=I+L)C.add(P.id),a.activeNotes.has(P.id)||(c.startNote(P.id,P),o?.debug("NoteHighway",`Note ${P.id} became active`,{note:P}));else if(a.activeNotes.has(P.id)){const N=c.endNote(P.id);if(N){P.performance=N;const O={noteId:P.id,note:P,performance:N};N.hitStatus==="hit"?(s.emit("noteHit",O),r?.onNoteHit?.(P.id,N.accuracyTier||"okay"),o?.info("NoteHighway",`Note hit: ${P.id}`,N)):(s.emit("noteMissed",O),r?.onNoteMiss?.(P.id),o?.info("NoteHighway",`Note missed: ${P.id}`,N))}}}a.activeNotes=C}function u(){for(const C of a.targetNotes){const P=y(C),I=d.has(C.id);P&&!I?(d.add(C.id),s.emit("noteEntered",{noteId:C.id,note:C})):!P&&I&&(d.delete(C.id),s.emit("noteExited",{noteId:C.id,note:C}))}}function m(){if(!a.onrampComplete)if(a.currentTimeMs>=0)a.onrampComplete=!0,s.emit("onrampComplete"),r?.clearOnrampCountdown?.(),o?.info("NoteHighway","Onramp complete",null);else{const P=60/i.getTempo()*1e3,I=Math.abs(a.currentTimeMs),L=Math.ceil(I/P);r?.updateOnrampCountdown?.(L)}}function b(){if(!a.isPlaying||a.isPaused||!a.startTime){l=null;return}const C=performance.now(),P=g();a.currentTimeMs=C-a.startTime-P,a.scrollOffset=f(a.currentTimeMs),m(),h(),u(),l=requestAnimationFrame(b)}function T(){l||(l=requestAnimationFrame(b))}function M(){l&&(cancelAnimationFrame(l),l=null)}return{init(C){a.targetNotes=C,o?.info("NoteHighway",`Initialized with ${C.length} notes`,null)},start(){a.isPlaying||(a.isPlaying=!0,a.isPaused=!1,a.currentTimeMs=-g(),a.scrollOffset=f(a.currentTimeMs),a.onrampComplete=!1,a.activeNotes.clear(),a.startTime=performance.now(),d.clear(),c.reset(),T(),s.emit("playbackStarted"),o?.info("NoteHighway","Playback started",{onrampDurationMs:g()}))},pause(){!a.isPlaying||a.isPaused||(a.isPaused=!0,M(),s.emit("playbackPaused"),o?.info("NoteHighway","Playback paused",{currentTimeMs:a.currentTimeMs}))},resume(){if(!a.isPlaying||!a.isPaused||!a.startTime)return;const C=performance.now()-(a.startTime+a.currentTimeMs+g());a.startTime+=C,a.isPaused=!1,T(),s.emit("playbackResumed"),o?.info("NoteHighway","Playback resumed",null)},stop(){if(!a.isPlaying)return;a.isPlaying=!1,a.isPaused=!1,a.currentTimeMs=0,a.scrollOffset=0,a.onrampComplete=!1,a.activeNotes.clear(),a.startTime=null,d.clear(),M(),r?.clearCanvas?.(),r?.clearOnrampCountdown?.(),s.emit("playbackStopped"),a.targetNotes.every(P=>P.performance!==void 0)&&s.emit("performanceComplete"),o?.info("NoteHighway","Playback stopped",null)},setScrollOffset(C){if(a.currentTimeMs=C,a.scrollOffset=f(C),a.isPlaying){const P=g();a.startTime=performance.now()-(C+P)}o?.debug("NoteHighway","Scroll offset set",{timeMs:C,scrollOffset:a.scrollOffset})},recordPitchInput(C,P,I){if(!a.isPlaying||a.isPaused||!n.inputSources.includes(I))return;const L={timeMs:a.currentTimeMs,midi:C,clarity:P,source:I};c.recordPitchSample(L)},getState(){return a},getVisibleNotes(){v();const C=i.getViewportWidth(),P=i.getCellWidth();return a.targetNotes.filter(I=>{const L=I.startColumn*P-a.scrollOffset;return I.endColumn*P-a.scrollOffset>=0&&L<=C})},getPerformanceResults(){return c.getAllPerformances()},getFeedbackCollector(){return c},dispose(){M(),c.dispose(),a.targetNotes=[],a.activeNotes.clear(),d.clear(),o?.info("NoteHighway","Service disposed",null)}}}function vi(e){const{cellHeight:n,columnWidths:i,viewport:s}=e,r=n/2,o=mi(i,e.cellWidth);return{getRowY(a){return(a-s.startRow+1)*r},getRowFromY(a){const c=a/r-1;return Math.round(c)+s.startRow},getColumnX(a){return a<0?0:a>=o.length?o[o.length-1]??0:o[a]??0},getColumnFromX(a){let c=0,l=o.length-1;for(;c<l;){const d=Math.floor((c+l)/2);(o[d]??0)<=a?c=d+1:l=d}return Math.max(0,c-1)}}}function cn(e){const{cellHeight:n,viewport:i,pixelsPerSecond:s,nowLineX:r=100,currentTimeMs:o=0}=e,a=n/2;return{getRowY(c){return(c-i.startRow+1)*a},getRowFromY(c){const l=c/a-1;return Math.round(l)+i.startRow},getColumnX(c){return 0},getColumnFromX(c){return 0},getTimeX(c){const l=c-o;return r+l/1e3*s},getTimeFromX(c){const l=(c-r)/s*1e3;return o+l}}}function mi(e,n){const i=[0];let s=0;for(let r=0;r<e.length;r++){const o=(e[r]??1)*n;s+=o,i.push(s)}return i}function pi(e,n){const{startRow:i,endRow:s}=e,r=Math.max(0,n.length-1);return{startRow:i,endRow:s,paddedStartRow:Math.max(0,i-1),paddedEndRow:Math.min(r,s+1)}}function vt(e,n,i,s){const r=s.getRowY(e),o=i;return r>=-o&&r<=n.containerHeight+o}function yi(e){let n=(e||"").replace(/\d/g,"").trim();return n=n.replace(/b/g,"b-").replace(/#/g,"b_"),n}function bi(e){switch(e){case"C":return{lineWidth:3.33,dash:[],color:"#adb5bd"};case"E":return{lineWidth:1,dash:[5,5],color:"#adb5bd"};case"G":return{lineWidth:1,dash:[],color:"#dee2e6"};case"B":case"A":case"F":case"Eb/Db":case"Db/C#":return{lineWidth:1,dash:[],color:"#ced4da"};default:return{lineWidth:1,dash:[],color:"#ced4da"}}}const it={stroke:"#c7cfd8",background:"rgba(207, 214, 222, 0.32)"};let Ve=null;function wi(){if(Ve)return Ve;if(typeof window>"u")return it;try{const e=window.getComputedStyle(document.documentElement);Ve={stroke:e.getPropertyValue("--c-anacrusis-border").trim()||it.stroke,background:e.getPropertyValue("--c-anacrusis-bg").trim()||it.background}}catch{Ve=it}return Ve}function Mi(e,n,i,s,r,o=0,a){const{fullRowData:c,viewportHeight:l,viewportWidth:d,cellHeight:g}=n,v=d,f=["B","A","F","Eâ™­/Dâ™¯","Dâ™­/Câ™¯"];for(let y=s;y<=r;y++){const h=c[y];if(!h||h.isBoundary)continue;const u=i.getRowY(y);if(u<-10||u>l+10)continue;const m=yi(h.pitch);if(f.includes(m))continue;const b=bi(m);m==="G"?(e.save(),e.fillStyle=b.color,e.fillRect(o,u-g/2,v-o,g),e.restore()):(e.beginPath(),e.moveTo(o,u),e.lineTo(v,u),e.lineWidth=b.lineWidth,e.strokeStyle=b.color,e.setLineDash(b.dash),e.stroke(),e.setLineDash([]))}}function _i(e,n,i,s){const{columnWidths:r,viewportHeight:o,macrobeatBoundaryStyles:a,placedTonicSigns:c}=n,l=r.length;for(let d=0;d<=l;d++){const g=d===0||d===l,v=Pi(d,c),f=c.some(b=>d===b.columnIndex+2),y=s.includes(d);if(!Ci(d,c))continue;let u=null;if(g||v||f)u={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(y){const b=s.indexOf(d),T=a[b]??"dashed";if(T==="anacrusis"){const{stroke:M}=wi();u={lineWidth:1,strokeStyle:M,dash:[4,4]}}else u={lineWidth:1,strokeStyle:"#adb5bd",dash:T==="solid"?[]:[5,5]}}if(!u)continue;const m=i.getColumnX(d);e.beginPath(),e.moveTo(m,0),e.lineTo(m,o),e.lineWidth=u.lineWidth,e.strokeStyle=u.strokeStyle,e.setLineDash(u.dash),e.stroke()}e.setLineDash([])}function Ti(e,n,i){const{viewportHeight:s,beatIntervalMs:r,measureIntervalMs:o,visibleTimeRange:a,nowLineX:c,beatTimeOffsetMs:l=0}=n,d=a.startMs-l,g=a.endMs-l,v=Math.floor(d/r),f=Math.ceil(g/r);for(let y=v;y<=f;y++){const h=l+y*r,u=i.getTimeX?.(h);if(u===void 0)continue;const m=o?(h-l)%o===0:!1;e.beginPath(),e.moveTo(u,0),e.lineTo(u,s),e.lineWidth=m?2:1,e.strokeStyle=m?"#adb5bd":"#dee2e6",e.setLineDash(m?[]:[5,5]),e.stroke()}e.setLineDash([]),c!==void 0&&(e.beginPath(),e.moveTo(c,0),e.lineTo(c,s),e.lineWidth=3,e.strokeStyle="#00ff00",e.setLineDash([]),e.stroke())}function Pi(e,n){return n.some(i=>i.columnIndex===e)}function Ci(e,n){return!n.some(i=>i.columnIndex+1===e)}const Si=.7,Ii=.9,Ai=4,xi=1,Ri=.15,Ni=.2,ki=1,xt=1.5;function Ze(e,n){return Number.isFinite(e)&&e>0&&Number.isFinite(n)&&n>0}function dn(e){if(!e||typeof e.startColumnIndex!="number"||typeof e.endColumnIndex!="number")return!1;const n=e.shape==="circle"?e.startColumnIndex+1:e.startColumnIndex;return e.endColumnIndex>n}function ot(e){const n=e?.split("-")[1];return Number.parseInt(n??"0",10)}function un(e,n,i){const s=i*.25,r=e.uuid;if(!r)return 0;const o=n.filter(l=>!l.isDrum&&l.row===e.row&&l.startColumnIndex===e.startColumnIndex&&l.uuid&&l.uuid!==r);if(o.length===0)return 0;const a=[e,...o];return a.sort((l,d)=>ot(l.uuid)-ot(d.uuid)),a.findIndex(l=>l.uuid===r)*s}function Li(e,n,i){const s=i/2*.12,r=e.uuid;if(!r)return 0;const o=n.filter(l=>!l.isDrum&&l.row===e.row&&l.startColumnIndex===e.startColumnIndex&&l.uuid&&l.uuid!==r&&dn(l));if(o.length===0)return 0;const a=[e,...o];return a.sort((l,d)=>ot(l.uuid)-ot(d.uuid)),a.findIndex(l=>l.uuid===r)*s}function Di(e){if(!e)return{multiplier:1,category:"natural"};const n=e.includes("â™­"),i=e.includes("â™¯"),s=e.includes("/");return!n&&!i?{multiplier:1,category:"natural"}:s?{multiplier:.75,category:"both-accidentals"}:{multiplier:.88,category:"single-accidental"}}function wt(e,n,i,s,r,o){const{multiplier:a,category:c}=Di(n);let l;if(i==="circle"){const d=o*2*Ii;switch(c){case"natural":l=d;break;case"single-accidental":l=d*.8;break;case"both-accidentals":l=d*.4;break;default:l=d*a}}else{const d=o*2*Si;switch(c){case"natural":l=d*1.5;break;case"single-accidental":l=d*1.2;break;case"both-accidentals":l=d;break;default:l=d*a}}if(!(l<Ai))if(e.fillStyle="#212529",e.font=`bold ${l}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle",i==="oval"&&c==="both-accidentals"&&n.includes("/")){const d=n.split("/"),g=l*1.1,v=g*(d.length-1),f=r-v/2;d.forEach((y,h)=>{const u=f+h*g,m=l*.08;e.fillText(y.trim(),s,u+m)})}else{const d=l*.08;e.fillText(n,s,r+d)}}function Hi(e,n,i,s,r,o,a){e.save(),e.beginPath(),e.arc(i,r,o,Math.PI/2,-Math.PI/2,!1),e.lineTo(s,r-o),e.arc(s,r,o,-Math.PI/2,Math.PI/2,!1),e.lineTo(i,r+o),e.closePath(),e.strokeStyle=n.color,e.lineWidth=a,e.shadowColor=n.color,e.shadowBlur=xt,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore()}function Ft(e,n,i,s){const{config:r,coords:o,allNotes:a,getScaleDegreeLabel:c}=n,{cellWidth:l,cellHeight:d,columnWidths:g,degreeDisplayMode:v}=r,f=o.getRowY(s),y=o.getColumnX(i.startColumnIndex),u=(g[i.startColumnIndex]??1)*l;if(!Ze(u,d))return;const m=un(i,a,l),b=Math.max(.5,u*.15),T=y+u/2+m,M=u/2-b/2,x=d/2-b/2;if(Ze(M,x)&&(e.save(),e.beginPath(),e.ellipse(T,f,M,x,0,0,2*Math.PI),e.strokeStyle=i.color,e.lineWidth=b,e.shadowColor=i.color,e.shadowBlur=xt,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore(),v!=="off"&&c)){const{label:C}=c(i);C&&wt(e,C,"oval",T,f,M)}}function Wt(e,n,i,s){const{config:r,coords:o,allNotes:a,getScaleDegreeLabel:c}=n,{cellWidth:l,cellHeight:d,degreeDisplayMode:g,longNoteStyle:v}=r,f=o.getRowY(s),y=o.getColumnX(i.startColumnIndex),u=o.getColumnX(i.startColumnIndex+1)-y;if(!Ze(u,d))return;const m=un(i,a,l),b=y+u+m,T=Math.max(xi,u*Ri),M=d/2-T/2,x=dn(i);if(x&&v==="style2"){const P=b,I=o.getColumnX(i.endColumnIndex);if(Ze(I-P,M)&&(Hi(e,i,P,I,f,M,T),g!=="off"&&c)){const{label:L}=c(i);if(L){const N=(P+I)/2;wt(e,L,"circle",N,f,M)}}return}if(x){const P=o.getColumnX(i.endColumnIndex+1),I=Li(i,a,d),L=f+I;e.beginPath(),e.moveTo(b,L),e.lineTo(P,L),e.strokeStyle=i.color,e.lineWidth=Math.max(ki,u*Ni),e.stroke()}const C=u-T/2;if(Ze(C,M)&&(e.save(),e.beginPath(),e.ellipse(b,f,C,M,0,0,2*Math.PI),e.strokeStyle=i.color,e.lineWidth=T,e.shadowColor=i.color,e.shadowBlur=xt,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore(),g!=="off"&&c)){const{label:P}=c(i);P&&wt(e,P,"circle",b,f,C)}}function Ei(e,n,i){const{config:s,coords:r}=n,{cellWidth:o,cellHeight:a}=s,c=r.getRowY(i.globalRow??i.row),l=r.getColumnX(i.columnIndex),g=r.getColumnX(i.columnIndex+1)-l,v=g*2,f=l+v/2,y=Math.min(v,a)/2*.9;if(y<2||(e.beginPath(),e.arc(f,c,y,0,2*Math.PI),e.strokeStyle="#212529",e.lineWidth=Math.max(.5,g*.05),e.stroke(),i.tonicNumber==null))return;const h=i.tonicNumber.toString(),u=y*1.5;u<6||(e.fillStyle="#212529",e.font=`bold ${u}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(h,f,c))}const Oi={timeWindowMs:4e3,pixelsPerSecond:200,circleRadius:9.5,proximityThreshold:35,maxConnections:3,connectorLineWidth:2.5,connectorColor:"rgba(0,0,0,0.4)",useTonicRelativeColors:!0,tonicPitchClass:0,clarityThreshold:.5,maxOpacity:.9};function fn(e){return{...Oi,...e}}function Bt(e,n,i,s,r,o,a){const c=fn(o.trailConfig);if(s<c.clarityThreshold||i<=0)return;const{cellHeight:l,colorMode:d}=o,g=hn(n,i,l,a),v=l/2*.8,f=d==="bw"?[128,128,128]:ln(i,c.tonicPitchClass);e.save(),e.beginPath(),e.arc(r,g,v+4,0,2*Math.PI),e.fillStyle=`rgba(${f[0]}, ${f[1]}, ${f[2]}, ${s*.3})`,e.fill(),e.beginPath(),e.arc(r,g,v,0,2*Math.PI),e.fillStyle=`rgba(${f[0]}, ${f[1]}, ${f[2]}, ${s})`,e.fill(),e.restore()}function hn(e,n,i,s){if(s.length===0||!s[0])return 0;const r=Math.floor(n),o=n-r,l=(s[0].midi??108)-r;if(l<0||l>=s.length)return l<0?0:e.getRowY(s.length-1);const d=e.getRowY(l),g=i/2;return d-o*g}function gn(e,n,i,s,r,o){const{viewportWidth:a,cellHeight:c,colorMode:l}=r,d=fn(r.trailConfig),g=d.timeWindowMs,v=d.pixelsPerSecond,f=r.nowLineX??a,y=i.filter(h=>h.midi>0&&h.clarity>=d.clarityThreshold).map(h=>{const u=s-h.time;if(u>=g||u<0)return null;const m=f-u/1e3*v,b=hn(n,h.midi,c,o),T=l==="bw"?[128,128,128]:ln(h.midi,d.tonicPitchClass);return{x:m,y:b,clarity:h.clarity,color:T}}).filter(h=>h!==null&&h.x>=0);if(y.length!==0){e.save(),e.strokeStyle=d.connectorColor,e.lineWidth=d.connectorLineWidth,e.beginPath();for(let h=0;h<y.length;h++){let u=0;for(let m=h+1;m<y.length&&u<d.maxConnections;m++){const b=y[h].x-y[m].x,T=y[h].y-y[m].y;Math.sqrt(b*b+T*T)<=d.proximityThreshold&&(e.moveTo(y[h].x,y[h].y),e.lineTo(y[m].x,y[m].y),u++)}}e.stroke();for(const h of y){const u=Math.min(h.clarity*d.maxOpacity,1);e.fillStyle=`rgba(${h.color[0]}, ${h.color[1]}, ${h.color[2]}, ${u})`,e.beginPath(),e.arc(h.x,h.y,d.circleRadius,0,2*Math.PI),e.fill()}e.restore()}}function zt(e,n,i,s,r,o,a,c){const{cellHeight:l,nowLineX:d=100,pixelsPerSecond:g}=r,v=.5;for(const f of i){const y=(d??100)+(f.startTimeMs-s)/1e3*g,h=y+f.durationMs/1e3*g;if(h<0||y>r.viewportWidth)continue;let u;if(o){if(u=o.findIndex(P=>P.midi===f.midi),u===-1)continue}else u=Math.round(108-f.midi);const m=n.getRowY(u),b=l/2-2,T=f.color??"#4CAF50",M=y<=d&&h>=d,x=a!=null&&(c??0)>.5&&Math.abs(a-f.midi)<=v,C=M&&x;if(e.save(),e.beginPath(),e.arc(y,m,b,Math.PI/2,-Math.PI/2,!1),e.lineTo(h,m-b),e.arc(h,m,b,-Math.PI/2,Math.PI/2,!1),e.lineTo(y,m+b),e.closePath(),C?(e.strokeStyle="#FFD700",e.lineWidth=5,e.shadowColor="#FFD700",e.shadowBlur=20,e.stroke(),e.fillStyle="rgba(255, 215, 0, 0.3)",e.fill(),Fi(e,d,m,b)):(e.strokeStyle=T,e.lineWidth=3,e.shadowColor=T,e.shadowBlur=8,e.stroke()),e.shadowBlur=0,e.restore(),f.label){const P=y+b+4;e.fillStyle=C?"#FFD700":"#212529",e.font=`bold ${Math.max(16,b*1.2)}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="left",e.textBaseline="middle",e.fillText(f.label,P,m)}}}function Fi(e,n,i,s){const a=s*1.5;e.save(),e.fillStyle="#FFD700",e.shadowColor="#FFD700",e.shadowBlur=6;for(let c=0;c<8;c++){const l=c/8*Math.PI*2,d=n+Math.cos(l)*a,g=i+Math.sin(l)*a;e.beginPath(),e.arc(d,g,3,0,Math.PI*2),e.fill()}e.restore()}function Wi(e){const n=e.replace(/\d+$/,"");return n.length>0?n:e}function vn(e,n){return!Number.isFinite(n)||n<=0?e:Math.round(e*n)/n}function Bi(e,n,i,s){const r=Math.max(10,Math.min(e*1.2,n*1.2)),o=i<=3?1:.7,a=s<=1?1.08:1;return vn(r*o*a,s)}function zi(e){const n=e.getContext("2d");return n&&(n.getTransform().a||window.devicePixelRatio)||1}function qi(e){if(typeof e.midi=="number")return e.midi%12;if(typeof e.pitchClass=="number")return e.pitchClass;const n={C:0,D:2,E:4,F:5,G:7,A:9,B:11},i=e.pitch.charAt(0).toUpperCase();let s=n[i]??0;return(e.pitch.includes("#")||e.pitch.includes("â™¯"))&&s++,(e.pitch.includes("b")||e.pitch.includes("â™­"))&&s--,(s%12+12)%12}function Gi(e,n){const{showFrequencyLabels:i,showOctaveLabels:s,accidentalMode:r}=n,o=v=>s?v:Wi(v);if(i)return String(Math.round(e.frequency));const{flatName:a,sharpName:c,isAccidental:l}=e,{sharp:d,flat:g}=r;return l?d&&g?o(e.pitch):d&&!g?o(c):g&&!d?o(a):null:o(a)}function qt(e,n,i,s){const{fullRowData:r,cellWidth:o,cellHeight:a,legendColumnWidth:c,colorMode:l,accidentalMode:d}=n,{startRow:g,endRow:v,coords:f}=i,y=zi(e.canvas),h=b=>vn(b,y),u=c;let m=0;for(const b of s){for(let T=g;T<=v;T++){const M=r[T];if(!M||M.isBoundary||M.column!==b)continue;const x=f.getRowY(T),C=!d.sharp&&!d.flat,P=M.isAccidental&&C,I=Gi(M,n);if(I===null)continue;let L=l==="bw"?"#ffffff":M.hex||"#ffffff",N="FF";P&&(N="00"),e.fillStyle=P?"rgba(255,255,255,0)":L,e.fillRect(m,x-a/2,u,a),n.highlight&&typeof n.highlight.pitchClass=="number"&&n.highlight.opacity>.01&&qi(M)===n.highlight.pitchClass&&(e.save(),e.globalAlpha=Math.min(Math.max(n.highlight.opacity,0),1),e.fillStyle=n.highlight.color??"#ffff00",e.fillRect(m,x-a/2,u,a),e.restore());const O=Bi(o,a,I.length,y);e.font=`bold ${O}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle";const H=h(m+u/2),Y=h(x);e.strokeStyle=`#212529${N}`,e.lineWidth=Math.max(1.2,2.5/y),e.lineJoin="round",e.strokeText(I,H,Y),e.fillStyle=`#ffffff${N}`,e.fillText(I,H,Y)}m+=u}}function Yi(e,n,i,s){e&&(e.clearRect(0,0,e.canvas.width,e.canvas.height),qt(e,i,s,["B","A"])),n&&(n.clearRect(0,0,n.canvas.width,n.canvas.height),qt(n,i,s,["A","B"]))}var Ui=D('<canvas class="pitch-grid-legend pitch-grid-legend--left svelte-ui3s88"></canvas>'),Vi=D('<canvas class="pitch-grid-legend pitch-grid-legend--right svelte-ui3s88"></canvas>'),ji=D('<div class="pitch-grid-container svelte-ui3s88"><!> <canvas class="pitch-grid-canvas svelte-ui3s88"></canvas> <!></div>');function Xi(e,n){pe(n,!0);let i=fe(n,"colorMode",3,"color"),s=fe(n,"degreeDisplayMode",3,"off"),r=fe(n,"accidentalMode",19,()=>({sharp:!0,flat:!0})),o=fe(n,"showFrequencyLabels",3,!1),a=fe(n,"showOctaveLabels",3,!0),c=fe(n,"showRightLegend",3,!0),l=fe(n,"placedNotes",19,()=>[]),d=fe(n,"placedTonicSigns",19,()=>[]),g=fe(n,"columnWidths",19,()=>[]),v=fe(n,"macrobeatGroupings",19,()=>[]),f=fe(n,"macrobeatBoundaryStyles",19,()=>[]),y=fe(n,"longNoteStyle",3,"style1"),h=fe(n,"beatIntervalMs",3,500),u=fe(n,"beatTimeOffsetMs",3,0),m=X(void 0),b=X(void 0),T=X(void 0),M=X(null),x=X(null),C=X(null),P=X(null);const I=3,L=A(()=>n.cellWidth*I),N=A(()=>t(L)*2),O=A(()=>a()||o()),H=A(()=>t(O)?t(N)*(c()?2:1):0),Y=A(()=>Math.max(0,n.viewport.containerWidth-t(H))),ie=A(()=>n.mode==="notation"||n.mode==="playback"),te=A(()=>n.mode==="singing"),S=A(()=>n.mode==="highway");function G(){if(t(ie))return vi({cellWidth:n.cellWidth,cellHeight:n.cellHeight,columnWidths:g(),viewport:n.viewport,modulationMarkers:n.modulationMarkers});{const _=t(S)?n.highwayConfig:n.singingConfig;return cn({cellWidth:n.cellWidth,cellHeight:n.cellHeight,viewport:n.viewport,pixelsPerSecond:_?.pixelsPerSecond??200,nowLineX:_?.nowLineX??100,currentTimeMs:_?.currentTimeMs??0})}}function J(){if(!t(M)||!t(m))return;const _=G(),{paddedStartRow:F,paddedEndRow:B}=pi(n.viewport,n.fullRowData);t(M).clearRect(0,0,t(Y),n.viewport.containerHeight);const oe={fullRowData:n.fullRowData,cellHeight:n.cellHeight,viewportHeight:n.viewport.containerHeight,viewportWidth:t(Y),colorMode:i()};Mi(t(M),oe,_,F,B),t(ie)?le(t(M),_):t(te)?_e(t(M),_):t(S)&&Pe(t(M),_),t(O)&&(t(x)||t(C))&&Q(_,F,B)}function le(_,F){const B=W(v()),oe={columnWidths:g(),cellWidth:n.cellWidth,viewportHeight:n.viewport.containerHeight,macrobeatGroupings:v(),macrobeatBoundaryStyles:f(),placedTonicSigns:d()};_i(_,oe,F,B);const ge=l().filter(ne=>ne.isDrum||ne.globalRow===void 0?!1:vt(ne.globalRow,n.viewport,n.cellHeight,F)),Me=d().filter(ne=>ne.globalRow===void 0?!1:vt(ne.globalRow,n.viewport,n.cellHeight,F)),Ae={config:{cellWidth:n.cellWidth,cellHeight:n.cellHeight,columnWidths:g(),degreeDisplayMode:s(),accidentalMode:r(),longNoteStyle:y(),colorMode:i()},coords:F,allNotes:l()};for(const ne of ge)ne.shape==="oval"?Ft(_,Ae,ne,ne.globalRow):ne.shape==="circle"&&Wt(_,Ae,ne,ne.globalRow);for(const ne of Me)Ei(_,Ae,ne)}function _e(_,F){if(!n.singingConfig)return;const B={cellHeight:n.cellHeight,viewportWidth:t(Y),pixelsPerSecond:n.singingConfig.pixelsPerSecond??200,timeWindowMs:n.singingConfig.timeWindowMs??4e3,colorMode:i(),trailConfig:n.singingConfig.trailConfig};n.singingConfig.pitchHistory&&n.singingConfig.pitchHistory.length>0&&gn(_,F,n.singingConfig.pitchHistory,performance.now(),B,n.fullRowData),n.singingConfig.targetNotes&&n.singingConfig.targetNotes.length>0&&zt(_,F,n.singingConfig.targetNotes,performance.now(),B,n.fullRowData),n.singingConfig.userPitch&&n.singingConfig.userPitch.clarity>.5&&Bt(_,F,n.singingConfig.userPitch.midi,n.singingConfig.userPitch.clarity,t(Y)-20,B,n.fullRowData)}function Pe(_,F){if(!n.highwayConfig)return;const B={cellHeight:n.cellHeight,viewportWidth:n.viewport.containerWidth,nowLineX:n.highwayConfig.nowLineX,pixelsPerSecond:n.highwayConfig.pixelsPerSecond??200,timeWindowMs:n.highwayConfig.timeWindowMs??4e3,colorMode:i(),trailConfig:n.highwayConfig.trailConfig};if(n.highwayConfig.scrollingGridData&&n.highwayConfig.scrollOffset!==void 0)Ce(_,F);else{const ge={startMs:n.highwayConfig.currentTimeMs-1e3,endMs:n.highwayConfig.currentTimeMs+t(Y)/(n.highwayConfig.pixelsPerSecond??200)*1e3},Me={viewportWidth:t(Y),viewportHeight:n.viewport.containerHeight,beatIntervalMs:h(),visibleTimeRange:ge,nowLineX:n.highwayConfig.nowLineX,beatTimeOffsetMs:u()};Ti(_,Me,F),n.highwayConfig.targetNotes&&n.highwayConfig.targetNotes.length>0&&zt(_,F,n.highwayConfig.targetNotes,n.highwayConfig.currentTimeMs,B,n.fullRowData,n.highwayConfig.userPitch?.midi??null,n.highwayConfig.userPitch?.clarity??0)}ee(_,n.highwayConfig.nowLineX,n.viewport.containerHeight),n.highwayConfig.showOnrampCountdown&&n.highwayConfig.onrampBeatsRemaining!==void 0&&U(_,n.highwayConfig.onrampBeatsRemaining),n.highwayConfig.userPitch&&n.highwayConfig.userPitch.clarity>.5&&Bt(_,F,n.highwayConfig.userPitch.midi,n.highwayConfig.userPitch.clarity,n.highwayConfig.nowLineX,B,n.fullRowData)}function Ce(_,F){if(!n.highwayConfig?.scrollingGridData||n.highwayConfig.scrollOffset===void 0)return;const B=n.highwayConfig.scrollingGridData,oe=n.highwayConfig.scrollOffset,ge=W(B.macrobeatGroupings);for(let re=0;re<ge.length;re++){const ne=ge[re]*n.cellWidth-oe;if(ne>=-n.cellWidth&&ne<=t(Y)+n.cellWidth){const Le=B.macrobeatBoundaryStyles[re]||"solid",He=Le==="solid"?2:1,Ye=Le==="dashed"?[5,5]:[];_.strokeStyle="#495057",_.lineWidth=He,_.setLineDash(Ye),_.beginPath(),_.moveTo(ne,0),_.lineTo(ne,n.viewport.containerHeight),_.stroke(),_.setLineDash([])}}const Me={cellWidth:n.cellWidth,cellHeight:n.cellHeight,columnWidths:B.columnWidths,degreeDisplayMode:s(),accidentalMode:r(),longNoteStyle:y(),colorMode:i()};for(const re of B.placedNotes){if(re.isDrum||re.globalRow===void 0||!vt(re.globalRow,n.viewport,n.cellHeight,F))continue;const Ae=re.startColumnIndex*n.cellWidth-oe;if(re.endColumnIndex*n.cellWidth-oe>=-n.cellWidth&&Ae<=t(Y)+n.cellWidth){const Le={...F,getColumnX:Ye=>Ye*n.cellWidth-oe},He={config:Me,coords:Le,allNotes:B.placedNotes};re.shape==="oval"?Ft(_,He,re,re.globalRow):re.shape==="circle"&&Wt(_,He,re,re.globalRow)}}}function ee(_,F,B){_.strokeStyle="rgba(255, 0, 0, 0.9)",_.lineWidth=3,_.beginPath(),_.moveTo(F,0),_.lineTo(F,B),_.stroke()}function U(_,F){_.fillStyle="rgba(0, 0, 0, 0.7)",_.fillRect(t(Y)/2-40,10,80,50),_.fillStyle="#ffffff",_.font="bold 36px sans-serif",_.textAlign="center",_.textBaseline="middle",_.fillText(F.toString(),t(Y)/2,35)}function Q(_,F,B){const oe={fullRowData:n.fullRowData,cellWidth:n.cellWidth,cellHeight:n.cellHeight,legendColumnWidth:t(L),colorMode:i(),showFrequencyLabels:o(),showOctaveLabels:a(),accidentalMode:r(),highlight:n.legendHighlight},ge={startRow:F,endRow:B,coords:_};Yi(t(x),t(C),oe,ge)}function W(_){const F=[];let B=0;for(const oe of _)B+=oe,F.push(B);return F}function R(){if(t(P))return;function _(){J(),E(P,requestAnimationFrame(_),!0)}E(P,requestAnimationFrame(_),!0)}function K(){t(P)&&(cancelAnimationFrame(t(P)),E(P,null))}function ae(){if(!t(m)||(E(M,t(m).getContext("2d"),!0),!t(M)))return;const _=window.devicePixelRatio||1;t(m).width=t(Y)*_,t(m).height=n.viewport.containerHeight*_,t(m).style.width=`${t(Y)}px`,t(m).style.height=`${n.viewport.containerHeight}px`,t(M).scale(_,_),t(b)&&(E(x,t(b).getContext("2d"),!0),t(x)&&(t(b).width=t(N)*_,t(b).height=n.viewport.containerHeight*_,t(b).style.width=`${t(N)}px`,t(b).style.height=`${n.viewport.containerHeight}px`,t(x).scale(_,_))),t(T)&&(E(C,t(T).getContext("2d"),!0),t(C)&&(t(T).width=t(N)*_,t(T).height=n.viewport.containerHeight*_,t(T).style.width=`${t(N)}px`,t(T).style.height=`${n.viewport.containerHeight}px`,t(C).scale(_,_))),J(),(t(te)||t(S))&&R()}sn(()=>{ae()}),ze(()=>{K()}),Re(()=>{n.mode,n.viewport,n.cellWidth,n.cellHeight,i(),s(),l(),d(),g(),t(M)&&t(ie)&&J()}),Re(()=>{n.mode,t(te)||t(S)?R():(K(),t(M)&&J())}),Re(()=>{n.viewport.containerWidth,n.viewport.containerHeight,t(M)&&t(m)&&ae()});var ue=ji(),be=p(ue);{var we=_=>{var F=Ui();Ne(F,B=>E(b,B),()=>t(b)),k(_,F)};$(be,_=>{t(O)&&_(we)})}var me=w(be,2);Ne(me,_=>E(m,_),()=>t(m));var V=w(me,2);{var se=_=>{var F=Vi();Ne(F,B=>E(T,B),()=>t(T)),k(_,F)};$(V,_=>{t(O)&&c()&&_(se)})}k(e,ue),ye()}const Gt={isDetecting:!1,visualizationMode:"highway",tonic:"C",useDegrees:!1,showAccidentals:!0,pitchHighlightEnabled:!0,yAxisRange:{minMidi:40,maxMidi:72},drone:{isPlaying:!1,octave:3,volume:-12}};function Ki(){let e=X(ke({...Gt}));return{get state(){return t(e)},toggleDetecting(){t(e).isDetecting=!t(e).isDetecting},setDetecting(n){t(e).isDetecting=n},setVisualizationMode(n){t(e).visualizationMode=n},setTonic(n){t(e).tonic=n},setUseDegrees(n){t(e).useDegrees=n},setShowAccidentals(n){t(e).showAccidentals=n},togglePitchHighlight(){t(e).pitchHighlightEnabled=!t(e).pitchHighlightEnabled},setPitchHighlightEnabled(n){t(e).pitchHighlightEnabled=n},setYAxisRange(n){t(e).yAxisRange=n},expandYAxisUpper(){t(e).yAxisRange.maxMidi<108&&(t(e).yAxisRange={...t(e).yAxisRange,maxMidi:t(e).yAxisRange.maxMidi+1})},contractYAxisUpper(){t(e).yAxisRange.maxMidi>t(e).yAxisRange.minMidi+6&&(t(e).yAxisRange={...t(e).yAxisRange,maxMidi:t(e).yAxisRange.maxMidi-1})},expandYAxisLower(){t(e).yAxisRange.minMidi>21&&(t(e).yAxisRange={...t(e).yAxisRange,minMidi:t(e).yAxisRange.minMidi-1})},contractYAxisLower(){t(e).yAxisRange.minMidi<t(e).yAxisRange.maxMidi-6&&(t(e).yAxisRange={...t(e).yAxisRange,minMidi:t(e).yAxisRange.minMidi+1})},toggleDrone(){t(e).drone={...t(e).drone,isPlaying:!t(e).drone.isPlaying}},setDroneOctave(n){t(e).drone={...t(e).drone,octave:n}},setDroneVolume(n){t(e).drone={...t(e).drone,volume:n}},reset(){E(e,{...Gt},!0)}}}const j=Ki(),Zi=200,Yt={currentPitch:null,history:[],stablePitch:{pitchClass:null,opacity:0,size:1}};function Ji(){let e=X(ke({...Yt}));return{get state(){return t(e)},setCurrentPitch(n){t(e).currentPitch=n},addHistoryPoint(n){t(e).history.push(n),t(e).history.length>Zi&&t(e).history.shift()},setStablePitch(n){t(e).stablePitch=n},clearHistory(){t(e).history=[]},reset(){E(e,{...Yt},!0)}}}const ce=Ji(),Ut={isPlaying:!1,startTime:null,currentTimeMs:0,targetNotes:[],nowLineX:100,pixelsPerSecond:200,timeWindowMs:4e3};function Qi(){let e=X(ke({...Ut})),n=null,i=null,s=null;function r(l){return l.map((d,g)=>({id:`target-${g}`,midi:d.midi,startTimeMs:d.startTimeMs,durationMs:d.durationMs,startColumn:0,endColumn:0,color:"#3b82f6",shape:"oval",globalRow:0}))}function o(){if(!n)return;const l=n.getState();t(e).isPlaying=l.isPlaying&&!l.isPaused,t(e).currentTimeMs=l.currentTimeMs;const d=n.getPerformanceResults();t(e).targetNotes=t(e).targetNotes.map((g,v)=>{const f=`target-${v}`,y=d.get(f);return{...g,hit:y?.hitStatus==="hit"}})}function a(){t(e).isPlaying&&n?(o(),i=requestAnimationFrame(a)):i=null}function c(){n&&n.dispose(),n=gi({judgmentLinePosition:t(e).nowLineX/800,pixelsPerSecond:t(e).pixelsPerSecond,lookAheadMs:t(e).timeWindowMs,scrollMode:"constant-speed",leadInBeats:0,playMetronomeDuringOnramp:!1,playTargetNotes:!1,playMetronome:!1,inputSources:["microphone"],feedbackConfig:{onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70},stateCallbacks:{getTempo:()=>120,getCellWidth:()=>20,getViewportWidth:()=>800},eventCallbacks:{emit:(d,g)=>{if(console.debug("[Highway]",d,g),d==="noteHit"){const v=g;console.log(`[Highway] Note HIT: ${v.noteId}, accuracy: ${v.performance.accuracyTier||"unknown"}`)}else d==="noteMissed"?console.log(`[Highway] Note MISSED: ${g.noteId}`):d==="onrampComplete"?console.log("[Highway] Onramp complete, playback starting!"):d==="performanceComplete"&&(console.log("[Highway] Performance complete!"),s&&n&&s(n.getPerformanceResults()))}}});const l=r(t(e).targetNotes);n.init(l)}return{get state(){return t(e)},get engineService(){return n},start(){!n&&t(e).targetNotes.length>0&&c(),n&&(n.start(),t(e).isPlaying=!0,t(e).startTime=performance.now(),t(e).currentTimeMs=0,a())},stop(){n&&n.stop(),t(e).isPlaying=!1,i!==null&&(cancelAnimationFrame(i),i=null)},pause(){n&&n.pause(),t(e).isPlaying=!1,i!==null&&(cancelAnimationFrame(i),i=null)},resume(){n&&(n.resume(),t(e).isPlaying=!0,a())},setTargetNotes(l){if(t(e).targetNotes=l,n){const d=r(l);n.init(d)}},markNoteHit(l){l>=0&&l<t(e).targetNotes.length&&(t(e).targetNotes=t(e).targetNotes.map((d,g)=>g===l?{...d,hit:!0}:d))},setNowLineX(l){t(e).nowLineX=l},setPixelsPerSecond(l){t(e).pixelsPerSecond=l},setTimeWindowMs(l){t(e).timeWindowMs=l},recordPitchInput(l,d){n&&t(e).isPlaying&&n.recordPitchInput(l,d,"microphone")},getPerformanceResults(){return n?.getPerformanceResults()??new Map},setCurrentTime(l){t(e).currentTimeMs=l,n&&n.setScrollOffset(l)},onPerformanceComplete(l){return s=l,()=>{s=null}},reset(){i!==null&&(cancelAnimationFrame(i),i=null),n&&(n.dispose(),n=null),E(e,{...Ut},!0)}}}const de=Qi(),$i={numLoops:5,minMidi:48,maxMidi:72,tempo:108,referenceVolume:-12},Vt={isActive:!1,isPlaying:!1,config:{...$i},currentLoop:0,currentPhase:"reference",currentPitch:null,generatedNotes:[],results:[]};function es(e,n){return Math.floor(Math.random()*(n-e+1))+e}function jt(e){return 60/e*1e3/2}function ts(){let e=X(ke({...Vt}));function n(s){const r=[],o=jt(s.tempo),a=2e3;for(let c=0;c<s.numLoops;c++){const l=es(s.minMidi,s.maxMidi),d=a+c*32*o;r.push({midi:l,startTimeMs:d,durationMs:8*o,lyric:"ðŸ‘‚"}),r.push({midi:l,startTimeMs:d+16*o,durationMs:8*o,lyric:"ðŸŽ¤"})}return r}function i(s,r){const o=jt(r),a=32*o,l=s-2e3;if(l<0)return{loop:0,phase:"rest2"};const d=Math.floor(l/a),g=l%a,v=Math.floor(g/o);let f;return v<8?f="reference":v<16?f="rest1":v<24?f="input":f="rest2",{loop:d,phase:f}}return{get state(){return t(e)},configure(s){t(e).config={...t(e).config,...s}},setPitchRange(s,r){t(e).config.minMidi=s,t(e).config.maxMidi=r},start(){const s=n(t(e).config);t(e).generatedNotes=s,t(e).isActive=!0,t(e).isPlaying=!1,t(e).currentLoop=0,t(e).currentPhase="reference",t(e).currentPitch=s.length>0?s[0].midi:null,t(e).results=[]},stop(){t(e).isActive=!1,t(e).isPlaying=!1,t(e).currentLoop=0,t(e).currentPhase="reference",t(e).currentPitch=null},setPlaying(s){t(e).isPlaying=s},updatePhase(s){const{loop:r,phase:o}=i(s,t(e).config.tempo);t(e).currentLoop=r,t(e).currentPhase=o;const a=r*2;a<t(e).generatedNotes.length&&(t(e).currentPitch=t(e).generatedNotes[a].midi)},addResult(s){t(e).results.push(s)},hasResultForLoop(s){return t(e).results.some(r=>r.loopIndex===s)},getResults(){return t(e).results},getCurrentProgress(){return{current:t(e).currentLoop+1,total:t(e).config.numLoops}},getGeneratedNotes(){return t(e).generatedNotes},getAverageAccuracy(){return t(e).results.length===0?0:t(e).results.reduce((r,o)=>r+o.accuracy,0)/t(e).results.length},getHitCount(){return t(e).results.filter(s=>s.performance?.hitStatus==="hit").length},reset(){E(e,{...Vt,config:{...t(e).config}},!0)}}}const he=ts();var ns=D('<div class="singing-canvas-container svelte-1lr8v2d"><!> <canvas class="pitch-trail-canvas svelte-1lr8v2d"></canvas></div>');function is(e,n){pe(n,!0);let i=X(void 0),s=X(800),r=X(400),o=X(void 0),a=X(null),c=X(null),l=0,d=0,g=0;const v=20,f=!0,y=!1,h=A(()=>t(s)>=720),u=3,m=A(()=>v*u),b=A(()=>t(m)*2),T=A(()=>f),M=A(()=>t(T)?t(b)*(t(h)?2:1):0),x=A(()=>Math.max(0,t(s)-t(M))),C=A(()=>t(T)?t(b):0),P=()=>{try{return!!globalThis.__ST_DEBUG_TRAIL}catch{return!1}},I=A(()=>Zn(j.state.yAxisRange.minMidi,j.state.yAxisRange.maxMidi)),L=A(()=>Jn({containerHeight:t(r),fullRowData:t(I),preferredCellHeight:40,minCellHeight:20})),N=A(()=>j.state.visualizationMode==="highway"?"highway":"singing"),O=A(()=>60/he.state.config.tempo*1e3),H=2e3,Y=A(()=>(()=>{if(!j.state.pitchHighlightEnabled)return;const W=ce.state.stablePitch;if(!(W.pitchClass===null||W.opacity<=.01))return{pitchClass:W.pitchClass,opacity:W.opacity,color:"#ffff00"}})());function ie(){return de.state.targetNotes.map((W,R)=>({id:`target-${R}`,midi:W.midi,startTimeMs:W.startTimeMs,durationMs:W.durationMs,label:W.lyric}))}const te=A(()=>({timeWindowMs:4e3,pixelsPerSecond:200,circleRadius:9.5,proximityThreshold:35,maxConnections:3,connectorLineWidth:2.5,connectorColor:"rgba(0,0,0,0.4)",useTonicRelativeColors:!0,tonicPitchClass:fi(j.state.tonic),clarityThreshold:.5,maxOpacity:.9})),S=A(()=>t(N)==="singing"?{userPitch:ce.state.currentPitch?{frequency:ce.state.currentPitch.frequency,midi:ce.state.currentPitch.midi,clarity:ce.state.currentPitch.clarity,pitchClass:ce.state.currentPitch.pitchClass}:null,pitchHistory:[],targetNotes:[],pixelsPerSecond:200,timeWindowMs:4e3,trailConfig:t(te)}:void 0),G=A(()=>t(N)==="highway"?{userPitch:ce.state.currentPitch?{frequency:ce.state.currentPitch.frequency,midi:ce.state.currentPitch.midi,clarity:ce.state.currentPitch.clarity,pitchClass:ce.state.currentPitch.pitchClass}:null,pitchHistory:[],targetNotes:ie(),nowLineX:de.state.nowLineX,pixelsPerSecond:de.state.pixelsPerSecond,currentTimeMs:de.state.currentTimeMs,timeWindowMs:de.state.timeWindowMs,trailConfig:t(te)}:void 0),J=A(()=>({startRow:t(L).startRow,endRow:t(L).endRow,zoomLevel:1,containerWidth:t(s),containerHeight:t(r)}));function le(){if(!t(o))return;const W=window.devicePixelRatio||1;t(o).width=t(x)*W,t(o).height=t(r)*W,t(o).style.width=`${t(x)}px`,t(o).style.height=`${t(r)}px`,t(o).style.left=`${t(C)}px`;const R=t(o).getContext("2d");if(!R){E(a,null);return}R.setTransform(W,0,0,W,0,0),E(a,R,!0)}function _e(){if(!t(a)||t(x)<=0)return;t(a).clearRect(0,0,t(x),t(r));const W=ce.state.history;if(W.length===0)return;const R=t(N)==="singing"?t(S):t(G);if(!R)return;const K=P(),ae=K?performance.now():0,ue=t(N)==="highway"&&t(G)?t(G).nowLineX:100,be=cn({cellHeight:t(L).cellHeight,viewport:t(J),pixelsPerSecond:R.pixelsPerSecond??200,nowLineX:ue,currentTimeMs:t(N)==="highway"&&t(G)?t(G).currentTimeMs:0}),we={cellHeight:t(L).cellHeight,viewportWidth:t(x),nowLineX:ue,pixelsPerSecond:R.pixelsPerSecond??200,timeWindowMs:R.timeWindowMs??4e3,colorMode:"color",trailConfig:t(te)},me=performance.now();if(gn(t(a),be,W,me,we,t(I)),K){const V=performance.now();if(d+=1,g+=V-ae,V-l>=1e3){const se=d>0?g/d:0;console.log(`[SingingTrail] points=${W.length} avgMs=${se.toFixed(2)} gridWidth=${t(x)}`),l=V,d=0,g=0}}}function Pe(){if(t(c))return;const W=()=>{_e(),E(c,requestAnimationFrame(W),!0)};E(c,requestAnimationFrame(W),!0)}function Ce(){t(c)&&(cancelAnimationFrame(t(c)),E(c,null)),t(a)&&t(x)>0&&t(a).clearRect(0,0,t(x),t(r))}Re(()=>{if(!t(i))return;const W=new ResizeObserver(R=>{for(const K of R)E(s,K.contentRect.width,!0),E(r,K.contentRect.height,!0)});return W.observe(t(i)),()=>{W.disconnect()}}),Re(()=>{t(x),t(r),t(C),t(o),le()}),Re(()=>{t(N),t(a),t(N)==="singing"||t(N)==="highway"?Pe():Ce()}),ze(()=>{Ce()});var ee=ns(),U=p(ee);Xi(U,{get mode(){return t(N)},get fullRowData(){return t(I)},get viewport(){return t(J)},cellWidth:v,get cellHeight(){return t(L).cellHeight},colorMode:"color",showOctaveLabels:f,showFrequencyLabels:y,get showRightLegend(){return t(h)},get singingConfig(){return t(S)},get highwayConfig(){return t(G)},get legendHighlight(){return t(Y)},get beatIntervalMs(){return t(O)},beatTimeOffsetMs:H});var Q=w(U,2);Ne(Q,W=>E(o,W),()=>t(o)),Ne(ee,W=>E(i,W),()=>t(i)),k(e,ee),ye()}const ss=100,mt=12;function as(e){const n=Math.round(e);return(e-n)*ss}function os(e){return Math.round(e)}function rs(e){return(Math.round(e)%mt+mt)%mt}class ls{synth=null;scheduledTimeouts=[];volume=null;startTime=0;_isPlaying=!1;get isPlaying(){return this._isPlaying}async init(){await It(),this.volume=new ii(-12).toDestination(),this.synth=new an({oscillator:{type:"triangle"},envelope:{attack:.05,decay:.1,sustain:.9,release:.1}}).connect(this.volume)}setVolume(n){this.volume&&(this.volume.volume.value=n)}scheduleReferenceTones(n){if(!this.synth){console.warn("[ReferenceAudio] Synth not initialized");return}this.clearScheduled(),this.startTime=performance.now(),n.forEach(i=>{const s=i.durationMs/1e3,r=kt(i.midi,"midi").toFrequency(),o=window.setTimeout(()=>{this.synth&&(console.log(`[ReferenceAudio] Playing ${i.midi} at ${performance.now()-this.startTime}ms`),this._isPlaying=!0,this.synth.triggerAttackRelease(r,s))},i.startTimeMs),a=window.setTimeout(()=>{this._isPlaying=!1},i.startTimeMs+i.durationMs);this.scheduledTimeouts.push(o,a)}),console.log(`[ReferenceAudio] Scheduled ${n.length} reference tones`)}playTone(n,i){if(!this.synth){console.warn("[ReferenceAudio] Synth not initialized");return}const s=kt(n,"midi").toFrequency(),r=i/1e3;this.synth.triggerAttackRelease(s,r)}clearScheduled(){this.scheduledTimeouts.forEach(n=>{window.clearTimeout(n)}),this.scheduledTimeouts=[]}stop(){this.clearScheduled(),this.synth&&this.synth.triggerRelease()}dispose(){this.stop(),this.synth&&(this.synth.dispose(),this.synth=null),this.volume&&(this.volume.dispose(),this.volume=null)}}const je=new ls,Fe={FFT_SIZE:2048,CLARITY_THRESHOLD:.8,MIN_PITCH_HZ:60,MAX_PITCH_HZ:1600,HIGHLIGHT_CENTS_RANGE:50};let We=null,Be=null,rt=null,De=null,lt=!1;const Mt=1;function cs(e){return 12*Math.log2(e/440)+69}function _t(){if(!lt||!Be||!rt){De=null;return}if(je.isPlaying){ce.addHistoryPoint({frequency:0,midi:0,time:performance.now(),clarity:0}),De=requestAnimationFrame(_t);return}const e=Be.getValue(),[n,i]=rt.findPitch(e,oi().sampleRate),s=n!==null&&i>Fe.CLARITY_THRESHOLD&&n>Fe.MIN_PITCH_HZ&&n<Fe.MAX_PITCH_HZ;if(s){const r=cs(n),o={frequency:n,midi:r,clarity:i,pitchClass:Math.round(r)%12};ce.setCurrentPitch(o),ce.addHistoryPoint({frequency:n,midi:r,time:performance.now(),clarity:i}),de.recordPitchInput(r,i)}else ce.addHistoryPoint({frequency:0,midi:0,time:performance.now(),clarity:0});if(s&&ce.state.currentPitch){const r=ce.state.currentPitch.midi,o=os(r),a=as(r),c=Math.min(Math.abs(a),Fe.HIGHLIGHT_CENTS_RANGE),l=Math.max(0,1-c/Fe.HIGHLIGHT_CENTS_RANGE);ce.setStablePitch({pitchClass:rs(o),opacity:l,size:Mt})}else ce.setStablePitch({pitchClass:null,opacity:0,size:Mt});De=requestAnimationFrame(_t)}async function ds(){if(!lt){De!==null&&cancelAnimationFrame(De),We=new si,Be=new ai("waveform",Fe.FFT_SIZE),rt=li.forFloat32Array(Be.size);try{await It(),await We.open(),We.connect(Be),lt=!0,_t()}catch(e){throw console.error("Microphone access denied or failed:",e),mn(),e}}}function us(){lt=!1,mn()}function mn(){De!==null&&(cancelAnimationFrame(De),De=null),We&&(We.close(),We=null),Be=null,rt=null,ce.setStablePitch({pitchClass:null,opacity:0,size:Mt}),ce.setCurrentPitch(null)}Te(["click"]);let xe=null,Qe=!1,$e=null;function fs(){if(!xe){xe=new ri(an,{oscillator:{type:"sawtooth"},envelope:{attack:.3,decay:.1,sustain:.8,release:.5}}).toDestination();const e=xe.get().oscillator?.type??"unknown";console.log("[DroneAudio] Initialized drone synth",{oscillatorType:e})}return xe}function pn(e,n){return`${e.replace("b","#").replace("Db","C#").replace("Eb","D#").replace("Gb","F#").replace("Ab","G#").replace("Bb","A#")}${n}`}async function hs(){await It();const e=fs(),n=pn(j.state.tonic,j.state.drone.octave);e.volume.value=j.state.drone.volume,console.log("[DroneAudio] Starting drone",{note:n,volume:e.volume.value}),$e&&e.releaseAll(),$e=n,e.triggerAttack(n),Qe=!0}function gs(){xe&&Qe&&(xe.releaseAll(),$e=null,Qe=!1)}function Tt(){if(!Qe||!xe)return;const e=pn(j.state.tonic,j.state.drone.octave);xe.volume.value=j.state.drone.volume,console.log("[DroneAudio] Updating drone",{note:e,volume:xe.volume.value}),e!==$e&&(xe.releaseAll(),xe.triggerAttack(e),$e=e)}async function vs(){Qe?gs():await hs()}var ms=D("<option> </option>"),ps=D('<div class="tonic-selector svelte-1kv0v4r"><label for="tonic-select" class="svelte-1kv0v4r">Key:</label> <select id="tonic-select" class="svelte-1kv0v4r"></select></div>');function ys(e,n){pe(n,!1);const i=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function s(c){const l=c.target;j.setTonic(l.value),Tt()}St();var r=ps(),o=w(p(r),2);o.__change=s,Ge(o,5,()=>i,et,(c,l)=>{var d=ms(),g=p(d),v={};Z(()=>{q(g,t(l)),v!==(v=t(l))&&(d.value=(d.__value=t(l))??"")}),k(c,d)});var a;on(o),Z(()=>{a!==(a=j.state.tonic)&&(o.value=(o.__value=j.state.tonic)??"",At(o,j.state.tonic))}),k(e,r),ye()}Te(["change"]);var bs=D("<option> </option>"),ws=D('<div class="drone-controls svelte-z8euf7"><button> </button> <div class="drone-settings svelte-z8euf7"><label class="svelte-z8euf7">Oct: <select class="svelte-z8euf7"></select></label> <label class="svelte-z8euf7">Vol: <input type="range" min="-40" max="0" class="svelte-z8euf7"/></label></div></div>');function Ms(e,n){pe(n,!1);const i=[2,3,4,5];async function s(){await vs(),j.toggleDrone()}function r(m){const b=m.target;j.setDroneOctave(parseInt(b.value,10)),Tt()}function o(m){const b=m.target;j.setDroneVolume(parseInt(b.value,10)),Tt()}St();var a=ws(),c=p(a);let l;c.__click=s;var d=p(c),g=w(c,2),v=p(g),f=w(p(v));f.__change=r,Ge(f,5,()=>i,et,(m,b)=>{var T=bs(),M=p(T),x={};Z(()=>{q(M,t(b)),x!==(x=t(b))&&(T.value=(T.__value=t(b))??"")}),k(m,T)});var y;on(f);var h=w(v,2),u=w(p(h));u.__input=o,Z(()=>{l=qe(c,1,"drone-toggle svelte-z8euf7",null,l,{active:j.state.drone.isPlaying}),q(d,j.state.drone.isPlaying?"Drone On":"Drone Off"),y!==(y=j.state.drone.octave)&&(f.value=(f.__value=j.state.drone.octave)??"",At(f,j.state.drone.octave)),Un(u,j.state.drone.volume)}),k(e,a),ye()}Te(["click","change","input"]);Te(["click"]);var _s=D('<div class="pitch-wheel-option svelte-53gwvz"> </div>'),Ts=D('<div class="pitch-wheel svelte-53gwvz" role="slider" tabindex="0" aria-valuemin="0"><div class="pitch-wheel-viewport svelte-53gwvz"><div class="pitch-wheel-options svelte-53gwvz"></div></div> <div class="pitch-wheel-overlay svelte-53gwvz"></div></div>');function Xt(e,n){pe(n,!0);let i=fe(n,"selectedIndex",15),s=fe(n,"ariaLabel",3,"Pitch selector");const r=40,o=r;let a=X(void 0),c=X(void 0),l=X(void 0),d=X(!1),g=X(null),v=X(0),f=X(0),y=X(r);const h=A(()=>n.options.map((S,G)=>Math.min(Math.abs(G-i()),3))),u=A(()=>t(c)?.clientHeight??0),m=A(()=>Math.max(0,(t(u)-t(y))/2)),b=A(()=>t(m)+i()*t(y)+t(y)/2),T=A(()=>t(u)>0?t(u)/2-t(b):0);function M(S){if(!n.options||n.options.length===0)return;let G=S;typeof n.onbeforechange=="function"&&(G=n.onbeforechange(S));const J=Math.max(0,Math.min(n.options.length-1,G));if(J!==i()&&(i(J),typeof n.onchange=="function")){const le=n.options[J];le&&n.onchange(J,le)}}function x(S){S!==0&&M(i()+S)}function C(S){S.preventDefault(),S.stopPropagation();const G=Math.sign(S.deltaY);G!==0&&x(G)}function P(S){S.key==="ArrowUp"?(S.preventDefault(),x(-1)):S.key==="ArrowDown"?(S.preventDefault(),x(1)):S.key==="Home"?(S.preventDefault(),M(0)):S.key==="End"&&(S.preventDefault(),M(n.options.length-1))}function I(S){if(S.preventDefault(),E(d,!0),E(g,S.pointerId,!0),E(v,S.clientY,!0),E(f,0),t(a)&&typeof t(a).setPointerCapture=="function")try{t(a).setPointerCapture(S.pointerId)}catch{}}function L(S){if(!t(d)||S.pointerId!==t(g))return;const G=S.clientY-t(v);if(E(v,S.clientY,!0),G===0)return;E(f,t(f)+G);const J=t(y)||o;for(;Math.abs(t(f))>=J;){const le=-Math.sign(t(f));x(le),E(f,t(f)-Math.sign(t(f))*J)}}function N(S){t(d)&&S.pointerId===t(g)&&(E(d,!1),E(g,null),E(f,0),t(a)?.hasPointerCapture?.(S.pointerId)&&t(a).releasePointerCapture(S.pointerId))}Re(()=>{if(!t(l)||!t(c))return;const S=()=>{const J=t(l)?.querySelector(".pitch-wheel-option");J&&E(y,J.offsetHeight||r,!0)};S();const G=new ResizeObserver(()=>{S()});return G.observe(t(c)),()=>{G.disconnect()}});var O=Ts();O.__keydown=P,O.__pointerdown=I,O.__pointermove=L,O.__pointerup=N;let H;var Y=p(O),ie=p(Y);let te;Ge(ie,23,()=>n.options,S=>S.index,(S,G,J)=>{var le=_s(),_e=p(le);Z(()=>{Oe(le,"data-distance",t(h)[t(J)]),q(_e,t(G).label)}),k(S,le)}),Ne(ie,S=>E(l,S),()=>t(l)),Ne(Y,S=>E(c,S),()=>t(c)),Ne(O,S=>E(a,S),()=>t(a)),Z(()=>{Oe(O,"aria-label",s()),Oe(O,"aria-valuemax",n.options.length-1),Oe(O,"aria-valuenow",i()),Oe(O,"aria-valuetext",n.options[i()]?.label??""),H=at(O,"",H,{height:n.wheelHeight?`${n.wheelHeight}px`:"100%"}),te=at(ie,"",te,{"padding-top":`${t(m)??""}px`,"padding-bottom":`${t(m)??""}px`,transform:`translateY(${t(T)??""}px)`})}),Ke("wheel",O,C),Ke("pointercancel",O,N),Ke("pointerleave",O,N),k(e,O),ye()}Te(["keydown","pointerdown","pointermove","pointerup"]);var Ps=D('<button type="button"> </button>'),Cs=D('<div class="preset-buttons svelte-uznh62"></div>');function Ss(e,n){pe(n,!0);function i(r){n.onPresetClick(r)}var s=Cs();Ge(s,21,()=>n.presets,et,(r,o)=>{var a=Ps();let c;a.__click=()=>i(t(o));var l=p(a);Z(()=>{c=qe(a,1,"preset-button svelte-uznh62",null,c,{active:n.activePreset===t(o).label}),q(l,t(o).label)}),k(r,a)}),k(e,s),ye()}Te(["click"]);const yn=7;function ct(e,n,i){return Number.isFinite(e)?Math.max(n,Math.min(i,Math.round(e))):n}function Is(e,n,i,s=yn){const r=Math.max(0,i-1),o=ct(e,0,r),a=Math.max(1,Math.round(s)),c=Math.max(0,o-(a-1));return ct(n,0,c)}function As(e,n,i,s=yn){const r=Math.max(0,i-1),o=ct(e,0,r),a=Math.max(1,Math.round(s)),c=Math.min(r,o+(a-1));return ct(n,c,r)}function xs(e){return e.map((n,i)=>({index:i,label:n.pitch,midi:n.midi,toneNote:n.toneNote,frequency:n.frequency}))}function Ee(e,n){const i=e.findIndex(s=>s.midi===n);return i>=0?i:0}function Rs(e){return[{label:"Voice I",topIndex:Ee(e,81),bottomIndex:Ee(e,57)},{label:"Voice II",topIndex:Ee(e,72),bottomIndex:Ee(e,48)},{label:"Voice III",topIndex:Ee(e,64),bottomIndex:Ee(e,40)}]}var Ns=D('<div class="summary-card svelte-yqjxxp"><div class="summary-label svelte-yqjxxp"> </div> <div class="summary-metadata svelte-yqjxxp"> </div></div>'),ks=D('<div class="dual-pitch-wheel svelte-yqjxxp"><div class="wheels-container svelte-yqjxxp"><div class="wheel-column svelte-yqjxxp"><div class="wheel-label svelte-yqjxxp">High</div> <!></div> <div class="wheel-column svelte-yqjxxp"><div class="wheel-label svelte-yqjxxp">Low</div> <!></div></div> <!> <!></div>');function Ls(e,n){pe(n,!0);let i=fe(n,"topIndex",15),s=fe(n,"bottomIndex",15),r=fe(n,"minSpan",3,7),o=fe(n,"showSummary",3,!0),a=fe(n,"showPresets",3,!1);const c=A(()=>xs(n.fullRowData)),l=A(()=>({topIndex:i(),bottomIndex:s(),topPitch:n.fullRowData[i()],bottomPitch:n.fullRowData[s()],span:s()-i()+1})),d=A(()=>t(l).topPitch&&t(l).bottomPitch?`${t(l).topPitch.pitch} â€“ ${t(l).bottomPitch.pitch}`:""),g=A(()=>`${t(l).span} ${t(l).span===1?"pitch":"pitches"}`),v=A(()=>!n.presets||n.presets.length===0?void 0:n.presets.find(Y=>Y.topIndex===i()&&Y.bottomIndex===s())?.label);function f(H){return Is(s(),H,t(c).length,r())}function y(H){return As(i(),H,t(c).length,r())}function h(H,Y){i(H),typeof n.onrangechange=="function"&&n.onrangechange(t(l))}function u(H,Y){s(H),typeof n.onrangechange=="function"&&n.onrangechange(t(l))}function m(H){i(H.topIndex),s(H.bottomIndex),typeof n.onrangechange=="function"&&n.onrangechange(t(l))}var b=ks(),T=p(b),M=p(T),x=w(p(M),2);Xt(x,{get options(){return t(c)},get selectedIndex(){return i()},onchange:h,onbeforechange:f,get wheelHeight(){return n.wheelHeight},ariaLabel:"High pitch selector"});var C=w(M,2),P=w(p(C),2);Xt(P,{get options(){return t(c)},get selectedIndex(){return s()},onchange:u,onbeforechange:y,get wheelHeight(){return n.wheelHeight},ariaLabel:"Low pitch selector"});var I=w(T,2);{var L=H=>{var Y=Ns(),ie=p(Y),te=p(ie),S=w(ie,2),G=p(S);Z(()=>{q(te,t(d)),q(G,t(g))}),k(H,Y)};$(I,H=>{o()&&H(L)})}var N=w(I,2);{var O=H=>{Ss(H,{get presets(){return n.presets},get activePreset(){return t(v)},onPresetClick:m})};$(N,H=>{a()&&n.presets&&n.presets.length>0&&H(O)})}k(e,b),ye()}Te(["change"]);var Ds=D('<div class="range-control svelte-y9vn59"><h3 class="control-title svelte-y9vn59">Pitch Range</h3> <!></div>');function Hs(e,n){pe(n,!0);function i(d){const g=dt.findIndex(v=>v.midi===d);return g>=0?g:0}const s=A(()=>i(j.state.yAxisRange.maxMidi)),r=A(()=>i(j.state.yAxisRange.minMidi)),o=Rs(dt);function a(d){const g=d.bottomPitch.midi??21,v=d.topPitch.midi??108;j.setYAxisRange({minMidi:g,maxMidi:v})}var c=Ds(),l=w(p(c),2);Ls(l,{get fullRowData(){return dt},get topIndex(){return t(s)},get bottomIndex(){return t(r)},minSpan:7,onrangechange:a,showSummary:!0,wheelHeight:200,get presets(){return o},showPresets:!0}),k(e,c),ye()}var Es=D('<div class="pitch-highlight-toggle svelte-167yaa1"><span class="toggle-label svelte-167yaa1">Pitch Highlight</span> <button> </button></div>');function Os(e,n){pe(n,!1);function i(){j.togglePitchHighlight()}St();var s=Es(),r=w(p(s),2);let o;r.__click=i;var a=p(r);Z(()=>{o=qe(r,1,"toggle-button svelte-167yaa1",null,o,{active:j.state.pitchHighlightEnabled}),q(a,j.state.pitchHighlightEnabled?"On":"Off")}),k(e,s),ye()}Te(["click"]);var Fs=D('<button class="start-exercise-btn svelte-16pthc8">Start Demo Exercise</button>'),Ws=D('<button class="stop-exercise-btn svelte-16pthc8">Stop Exercise</button> <div class="progress-indicator svelte-16pthc8"> </div> <div class="phase-indicator svelte-16pthc8"> </div>',1),Bs=D('<div><span class="result-loop svelte-16pthc8"></span> <span class="result-pitch svelte-16pthc8"> </span> <span class="result-accuracy svelte-16pthc8"> </span> <span class="result-status svelte-16pthc8"> </span></div>'),zs=D('<div class="exercise-results svelte-16pthc8"><h4 class="results-title svelte-16pthc8">Results</h4> <div class="results-summary svelte-16pthc8"><div class="stat svelte-16pthc8"><span class="stat-label svelte-16pthc8">Average Accuracy:</span> <span class="stat-value svelte-16pthc8"> </span></div> <div class="stat svelte-16pthc8"><span class="stat-label svelte-16pthc8">Hits:</span> <span class="stat-value svelte-16pthc8"> </span></div></div> <details class="results-details svelte-16pthc8"><summary class="results-summary-label svelte-16pthc8">Detailed Results</summary> <div class="results-list svelte-16pthc8"></div></details></div>'),qs=D('<div class="demo-exercise-panel svelte-16pthc8"><h3 class="panel-title svelte-16pthc8">Demo Exercise</h3> <details class="settings-details svelte-16pthc8"><summary class="settings-summary svelte-16pthc8">Settings</summary> <div class="exercise-settings svelte-16pthc8"><label class="setting-label svelte-16pthc8"><span class="label-text svelte-16pthc8">Number of loops:</span> <input class="setting-input svelte-16pthc8" type="number" min="1" max="20"/></label> <label class="setting-label svelte-16pthc8"><span class="label-text svelte-16pthc8">Tempo (BPM):</span> <input class="setting-input svelte-16pthc8" type="number" min="60" max="180"/></label> <label class="setting-label svelte-16pthc8"><span class="label-text svelte-16pthc8">Reference Volume:</span> <input class="setting-slider svelte-16pthc8" type="range" min="-40" max="0"/> <span class="volume-value svelte-16pthc8"> </span></label> <div class="pitch-range-buttons svelte-16pthc8"><button class="range-btn svelte-16pthc8">Use Current Range</button> <button class="range-btn svelte-16pthc8">Use Full Range</button></div></div></details> <div class="exercise-controls svelte-16pthc8"><!></div> <!></div>');function Gs(e,n){pe(n,!0);let i=X(!1),s=X(5),r=X(108),o=X(-12);const a=A(()=>he.state.isActive),c=A(()=>he.state.isPlaying),l=A(()=>he.state.currentPhase),d=A(()=>he.getCurrentProgress()),g=A(()=>he.getResults()),v=A(()=>t(g).length>0),f=A(()=>he.getAverageAccuracy()),y=A(()=>he.getHitCount()),h=A(()=>t(g).length);Re(()=>{if(!t(a)||!t(c))return;const R=de.state.currentTimeMs;he.updatePhase(R)}),Re(()=>{if(!t(a))return;const R=de.getPerformanceResults();he.getGeneratedNotes().forEach((ae,ue)=>{if(ae.lyric!=="ðŸŽ¤")return;const be=`target-${ue}`,we=R.get(be);if(we&&!he.hasResultForLoop(Math.floor(ue/2))){const me=u(we);he.addResult({loopIndex:Math.floor(ue/2),targetPitch:ae.midi,accuracy:me,performance:we})}})});function u(R){return R.hitStatus==="hit"?R.pitchAccuracyCents!==void 0?Math.max(0,100-Math.abs(R.pitchAccuracyCents)/50*100):100:0}ze(()=>{t(a)&&M()});function m(){const R=j.state.yAxisRange;he.setPitchRange(R.minMidi,R.maxMidi)}function b(){he.setPitchRange(21,108)}async function T(){j.setVisualizationMode("highway"),he.configure({numLoops:t(s),tempo:t(r),referenceVolume:t(o)}),m(),await je.init(),je.setVolume(t(o)),he.start();const R=he.getGeneratedNotes();de.setTargetNotes(R),de.start(),he.setPlaying(!0);const K=R.filter(ae=>ae.lyric==="ðŸ‘‚");je.scheduleReferenceTones(K)}function M(){je.stop(),de.stop(),he.stop()}function x(R){switch(R){case"reference":return"ðŸ‘‚ Listen";case"input":return"ðŸŽ¤ Sing";default:return"Rest"}}function C(R){return Qn(R)?.pitch||`MIDI ${R}`}var P=qs(),I=w(p(P),2),L=w(p(I),2),N=p(L),O=w(p(N),2),H=w(N,2),Y=w(p(H),2),ie=w(H,2),te=w(p(ie),2),S=w(te,2),G=p(S),J=w(ie,2),le=p(J);le.__click=m;var _e=w(le,2);_e.__click=b;var Pe=w(I,2),Ce=p(Pe);{var ee=R=>{var K=Fs();K.__click=T,k(R,K)},U=R=>{var K=Ws(),ae=Je(K);ae.__click=M;var ue=w(ae,2),be=p(ue),we=w(ue,2),me=p(we);Z(V=>{q(be,`Loop ${t(d).current??""} / ${t(d).total??""}`),q(me,V)},[()=>x(t(l))]),k(R,K)};$(Ce,R=>{t(a)?R(U,!1):R(ee)})}var Q=w(Pe,2);{var W=R=>{var K=zs(),ae=w(p(K),2),ue=p(ae),be=w(p(ue),2),we=p(be),me=w(ue,2),V=w(p(me),2),se=p(V),_=w(ae,2),F=w(p(_),2);Ge(F,21,()=>t(g),et,(B,oe,ge)=>{var Me=Bs();let re;var Ae=p(Me);Ae.textContent=`Loop ${ge+1}:`;var ne=w(Ae,2),Le=p(ne),He=w(ne,2),Ye=p(He),bn=w(He,2),wn=p(bn);Z((Mn,_n)=>{re=qe(Me,1,"result-item svelte-16pthc8",null,re,{hit:t(oe).performance?.hitStatus==="hit"}),q(Le,Mn),q(Ye,`${_n??""}%`),q(wn,t(oe).performance?.hitStatus==="hit"?"âœ“":"âœ—")},[()=>C(t(oe).targetPitch),()=>t(oe).accuracy.toFixed(0)]),k(B,Me)}),Z(B=>{q(we,`${B??""}%`),q(se,`${t(y)??""}/${t(h)??""}`)},[()=>t(f).toFixed(1)]),k(R,K)};$(Q,R=>{t(v)&&!t(a)&&R(W)})}Z(()=>{O.disabled=t(a),Y.disabled=t(a),te.disabled=t(a),q(G,`${t(o)??""} dB`),le.disabled=t(a),_e.disabled=t(a)}),ut(O,()=>t(s),R=>E(s,R)),ut(Y,()=>t(r),R=>E(r,R)),ut(te,()=>t(o),R=>E(o,R)),rn("open","toggle",I,R=>E(i,R),()=>t(i)),k(e,P),ye()}Te(["click"]);const Ys=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,/^([a-zA-Z0-9_-]{11})$/],Us={gapMs:0,videoGapSec:0,manualOffsetSec:0},Rt=60;function Vs(e){try{const n=e.split(/\r?\n/).map(a=>a.trim()),i=js(n);if(!i.bpm)return{success:!1,error:"Missing required #BPM tag"};const{notes:s,lineBreaks:r,totalBeats:o}=Xs(n);return s.length===0?{success:!1,error:"No valid notes found in file"}:{success:!0,song:{metadata:i,notes:s,lineBreaks:r,totalBeats:o}}}catch(n){return{success:!1,error:n instanceof Error?n.message:"Unknown parsing error"}}}function js(e){const n={};for(const i of e){if(!i.startsWith("#"))continue;const s=i.indexOf(":");if(s===-1)continue;const r=i.slice(1,s).toUpperCase().trim(),o=i.slice(s+1).trim();switch(r){case"TITLE":n.title=o;break;case"ARTIST":n.artist=o;break;case"VIDEO":n.video=o;break;case"VIDEOGAP":n.videoGap=parseFloat(o.replace(",","."))||0;break;case"GAP":n.gap=parseFloat(o.replace(",","."))||0;break;case"BPM":n.bpm=parseFloat(o.replace(",","."))||0;break;case"MP3":case"AUDIO":n.mp3=o;break;case"LANGUAGE":n.language=o;break;case"GENRE":n.genre=o;break;case"YEAR":n.year=parseInt(o)||void 0;break;case"CREATOR":n.creator=o;break;case"COVER":n.cover=o;break;case"BACKGROUND":n.background=o;break;case"PREVIEWSTART":n.previewStart=parseFloat(o.replace(",","."))||0;break}}return{title:n.title||"Unknown Title",artist:n.artist||"Unknown Artist",bpm:n.bpm||0,...n}}function Xs(e){const n=[],i=[];let s=0;for(const r of e){if(r.length===0||r.startsWith("#"))continue;const o=r[0];if(o==="E")break;if(o==="-"){const a=r.slice(1).trim().split(/\s+/),c=parseInt(a[0])||0;i.push(c);continue}if([":","*","F","R"].includes(o)){const a=Ks(r);if(a){n.push(a);const c=a.startBeat+a.duration;c>s&&(s=c)}}}return{notes:n,lineBreaks:i,totalBeats:s}}function Ks(e){const n=e[0],s=e.slice(1).trim().split(/\s+/);if(s.length<3)return null;const r=parseInt(s[0]),o=parseInt(s[1]),a=parseInt(s[2]),c=s.slice(3).join(" ")||"";return isNaN(r)||isNaN(o)||isNaN(a)?null:{type:n,startBeat:r,duration:o,pitch:a,lyric:c}}function Zs(e){if(!e)return null;const n=e.trim();for(const i of Ys){const s=n.match(i);if(s&&s[1])return s[1]}return null}function Kt(e,n=Rt){const{metadata:i,notes:s,lineBreaks:r}=e,{bpm:o}=i,a=60/o*1e3*4;let c=0;const l=[...r].sort((g,v)=>g-v),d=s.length>0?Math.min(...s.map(g=>g.startBeat)):0;return s.filter(g=>g.type!=="F").map(g=>{const v=(g.startBeat-d)*a,f=g.duration*a,y=n+g.pitch;for(;c<l.length&&g.startBeat>=l[c];)c++;const h={midi:y,startTimeMs:v,durationMs:f,lyric:g.lyric.trim()||void 0};return g.type==="*"&&(h.isGolden=!0),h})}function Js(e){return{gapMs:e.gap||0,videoGapSec:e.videoGap||0,manualOffsetSec:0}}function Qs(e){const{metadata:n,notes:i,totalBeats:s}=e,{bpm:r}=n,o=60/r*1e3*4,a=i.length>0?Math.min(...i.map(l=>l.startBeat)):0;return(s-a)*o+2e3}function Zt(e,n=Rt){const i=e.notes.filter(o=>o.type!=="F"&&o.type!=="-").map(o=>n+o.pitch);if(i.length===0)return{minMidi:48,maxMidi:72};const s=Math.min(...i),r=Math.max(...i);return{minMidi:Math.max(24,s-3),maxMidi:Math.min(108,r+3)}}const Jt={isActive:!1,isLoading:!1,isPlaying:!1,song:null,targetNotes:[],youtubeId:null,syncConfig:{...Us},baseMidi:Rt,totalDurationMs:0,detectedRange:{minMidi:48,maxMidi:72},error:null};function $s(){let e=X(ke({...Jt})),n=null;return{get state(){return t(e)},async loadFile(i){t(e).isLoading=!0,t(e).error=null;try{const s=await i.text(),r=Vs(s);if(!r.success)return t(e).error=r.error,t(e).isLoading=!1,!1;const o=r.song,a=o.metadata.video?Zs(o.metadata.video):null,c=Js(o.metadata),l=Kt(o,t(e).baseMidi),d=Qs(o),g=Zt(o,t(e).baseMidi);return t(e).song=o,t(e).youtubeId=a,t(e).syncConfig=c,t(e).targetNotes=l,t(e).totalDurationMs=d,t(e).detectedRange=g,t(e).isActive=!0,t(e).isLoading=!1,!0}catch(s){return t(e).error=s instanceof Error?s.message:"Failed to load file",t(e).isLoading=!1,!1}},get youtubeOffset(){const{gapMs:i,videoGapSec:s,manualOffsetSec:r}=t(e).syncConfig;return i/1e3+s+r},adjustOffset(i){t(e).syncConfig={...t(e).syncConfig,manualOffsetSec:t(e).syncConfig.manualOffsetSec+i}},setManualOffset(i){t(e).syncConfig={...t(e).syncConfig,manualOffsetSec:i}},resetOffset(){t(e).syncConfig={...t(e).syncConfig,manualOffsetSec:0}},setBaseMidi(i){t(e).baseMidi=i,t(e).song&&(t(e).targetNotes=Kt(t(e).song,i),t(e).detectedRange=Zt(t(e).song,i))},setPlaying(i){t(e).isPlaying=i},onComplete(i){n=i},triggerComplete(){t(e).isPlaying=!1,n&&n()},checkCompletion(i){return!t(e).isPlaying||!t(e).isActive?!1:i>=t(e).totalDurationMs-500?(this.triggerComplete(),!0):!1},get title(){return t(e).song?.metadata.title||""},get artist(){return t(e).song?.metadata.artist||""},get hasVideo(){return t(e).youtubeId!==null},reset(){E(e,{...Jt},!0),n=null},unload(){t(e).isActive=!1,t(e).isPlaying=!1,t(e).song=null,t(e).targetNotes=[],t(e).youtubeId=null,t(e).totalDurationMs=0,t(e).error=null}}}const z=$s();let st=null,Xe=!1;function ea(){return st||(Xe&&window.YT&&window.YT.Player?Promise.resolve():(st=new Promise((e,n)=>{if(window.YT&&window.YT.Player){Xe=!0,e();return}window.onYouTubeIframeAPIReady=()=>{Xe=!0,e()};const i=document.createElement("script");i.src="https://www.youtube.com/iframe_api",i.async=!0,i.onerror=()=>{n(new Error("Failed to load YouTube IFrame API"))},document.head.appendChild(i),setTimeout(()=>{Xe||n(new Error("YouTube IFrame API load timeout"))},1e4)}),st))}function ta(e,n,i={}){if(!Xe||!window.YT?.Player)throw new Error("YouTube API not loaded. Call loadYouTubeAPI() first.");const{width:s=320,height:r=180,onReady:o,onStateChange:a,onError:c}=i;return new window.YT.Player(e,{width:s,height:r,videoId:n,playerVars:{autoplay:0,controls:1,disablekb:1,enablejsapi:1,fs:0,modestbranding:1,origin:window.location.origin,playsinline:1,rel:0},events:{onReady:l=>{o?.(l.target)},onStateChange:l=>{a?.(l.data)},onError:l=>{c?.(l.data)}}})}function na(e){switch(e){case YT.PlayerError.InvalidParam:return"Invalid video ID";case YT.PlayerError.Html5Error:return"HTML5 player error";case YT.PlayerError.VideoNotFound:return"Video not found";case YT.PlayerError.NotAllowedEmbedded:case YT.PlayerError.NotAllowedEmbedded2:return"Video cannot be embedded";default:return"Unknown player error"}}const pt={isApiLoaded:!1,isApiLoading:!1,isPlayerReady:!1,isPlaying:!1,currentTime:0,duration:0,videoId:null,error:null,isEmbeddable:!0,volume:100,isMuted:!1};function ia(){let e=X(ke({...pt})),n=null,i=null,s=null;return{get state(){return t(e)},async initAPI(){if(t(e).isApiLoaded)return!0;if(t(e).isApiLoading)return!1;t(e).isApiLoading=!0,t(e).error=null;try{return await ea(),t(e).isApiLoaded=!0,t(e).isApiLoading=!1,!0}catch(r){return t(e).error=r instanceof Error?r.message:"Failed to load YouTube API",t(e).isApiLoading=!1,!1}},async loadVideo(r,o){if(!t(e).isApiLoaded&&!await this.initAPI())return!1;if(n){try{n.destroy()}catch{}n=null}return t(e).isPlayerReady=!1,t(e).error=null,t(e).isEmbeddable=!0,t(e).videoId=r,new Promise(a=>{try{n=ta(o,r,{onReady:c=>{t(e).isPlayerReady=!0,t(e).duration=c.getDuration(),t(e).volume=c.getVolume(),t(e).isMuted=c.isMuted(),a(!0)},onStateChange:c=>{t(e).isPlaying=c===YT.PlayerState.PLAYING,c===YT.PlayerState.ENDED&&(t(e).isPlaying=!1,this.stopSyncLoop())},onError:c=>{t(e).error=na(c),t(e).isEmbeddable=c!==YT.PlayerError.NotAllowedEmbedded&&c!==YT.PlayerError.NotAllowedEmbedded2,t(e).isPlayerReady=!1,a(!1)}})}catch(c){t(e).error=c instanceof Error?c.message:"Failed to create player",a(!1)}})},play(){n&&t(e).isPlayerReady&&n.playVideo()},pause(){n&&t(e).isPlayerReady&&n.pauseVideo()},stop(){n&&t(e).isPlayerReady&&(n.stopVideo(),t(e).isPlaying=!1),this.stopSyncLoop()},seekTo(r){n&&t(e).isPlayerReady&&(n.seekTo(Math.max(0,r),!0),t(e).currentTime=Math.max(0,r))},getCurrentTime(){return n&&t(e).isPlayerReady?n.getCurrentTime():t(e).currentTime},setVolume(r){const o=Math.max(0,Math.min(100,r));n&&t(e).isPlayerReady&&n.setVolume(o),t(e).volume=o},mute(){n&&t(e).isPlayerReady&&n.mute(),t(e).isMuted=!0},unmute(){n&&t(e).isPlayerReady&&n.unMute(),t(e).isMuted=!1},toggleMute(){t(e).isMuted?this.unmute():this.mute()},startSyncLoop(r,o=250){s=r,i!==null&&clearInterval(i),i=window.setInterval(()=>{if(n&&t(e).isPlayerReady&&t(e).isPlaying){const a=n.getCurrentTime();t(e).currentTime=a,s?.(a)}},o)},stopSyncLoop(){i!==null&&(clearInterval(i),i=null),s=null},correctDrift(r,o=150){if(!n||!t(e).isPlayerReady||!t(e).isPlaying)return!1;const a=n.getCurrentTime();return Math.abs(a-r)*1e3>o?(n.seekTo(r,!0),!0):!1},getVideoUrl(){return t(e).videoId?`https://www.youtube.com/watch?v=${t(e).videoId}`:null},dispose(){if(this.stopSyncLoop(),n){try{n.destroy()}catch{}n=null}E(e,{...pt,isApiLoaded:t(e).isApiLoaded},!0)},reset(){this.dispose(),E(e,{...pt},!0)}}}const ve=ia();function sa(e){let n={...e.syncConfig};const i=e.driftCheckIntervalMs??250,s=e.maxDriftMs??150;function r(){return n.gapMs/1e3+n.videoGapSec+n.manualOffsetSec}function o(u){return u/1e3+r()}function a(u){return(u-r())*1e3}function c(u,m){const b=o(u),T=m-b,M=Math.abs(T*1e3);if(M>s){const x=a(m);return{driftMs:M,needsCorrection:!0,correctedTransportTimeMs:x}}return{driftMs:M,needsCorrection:!1}}function l(u){n={...n,...u}}function d(u){n.manualOffsetSec+=u}function g(){n.manualOffsetSec=0}function v(){return n.manualOffsetSec}function f(){return r()}function y(){const u=n.manualOffsetSec;return`${u>=0?"+":""}${u.toFixed(2)}s`}function h(){return{intervalMs:i,maxDriftMs:s}}return{getYouTubeOffset:r,getTotalOffset:f,getManualOffset:v,getSyncLoopConfig:h,transportToYouTube:o,youTubeToTransport:a,checkDrift:c,updateConfig:l,adjustManualOffset:d,resetManualOffset:g,formatOffset:y,getConfig:()=>({...n})}}var aa=D('<div class="youtube-loading svelte-4iyhd6"><div class="spinner svelte-4iyhd6"></div> <span>Loading video...</span></div>'),oa=D('<button class="fallback-btn svelte-4iyhd6">Open on YouTube â†—</button>'),ra=D('<div class="youtube-error svelte-4iyhd6"><span class="error-icon svelte-4iyhd6">âš ï¸</span> <span class="error-message svelte-4iyhd6"> </span> <!></div>'),la=D('<div class="youtube-placeholder svelte-4iyhd6"><span class="placeholder-icon svelte-4iyhd6">ðŸŽ¬</span> <span class="placeholder-text svelte-4iyhd6">No video loaded</span></div>'),ca=D('<div class="youtube-container svelte-4iyhd6"><div class="youtube-player svelte-4iyhd6"></div> <!> <!> <!></div>');function da(e,n){pe(n,!0);const i=`youtube-player-${Math.random().toString(36).slice(2,9)}`,s=A(()=>ve.state.isApiLoading||ve.state.videoId&&!ve.state.isPlayerReady),r=A(()=>!!ve.state.error),o=A(()=>ve.state.isEmbeddable),a=A(()=>z.state.youtubeId);Re(()=>{t(a)&&ve.loadVideo(t(a),i)}),ze(()=>{ve.dispose()});function c(){const m=ve.getVideoUrl();m&&window.open(m,"_blank","noopener,noreferrer")}var l=ca(),d=p(l),g=w(d,2);{var v=m=>{var b=aa();k(m,b)};$(g,m=>{t(s)&&t(a)&&m(v)})}var f=w(g,2);{var y=m=>{var b=ra(),T=w(p(b),2),M=p(T),x=w(T,2);{var C=P=>{var I=oa();I.__click=c,k(P,I)};$(x,P=>{t(o)||P(C)})}Z(()=>q(M,ve.state.error)),k(m,b)};$(f,m=>{t(r)&&m(y)})}var h=w(f,2);{var u=m=>{var b=la();k(m,b)};$(h,m=>{!t(a)&&!t(s)&&!t(r)&&m(u)})}Z(()=>Oe(d,"id",i)),k(e,l),ye()}Te(["click"]);var ua=D('<div class="sync-controls svelte-wiblfi"><div class="sync-header svelte-wiblfi"><span class="sync-label svelte-wiblfi">Sync Offset</span> <span class="sync-value svelte-wiblfi"> </span></div> <div class="sync-buttons svelte-wiblfi"><button class="sync-btn coarse svelte-wiblfi" title="Earlier by 0.1s">-0.1s</button> <button class="sync-btn fine svelte-wiblfi" title="Earlier by 0.01s">-0.01s</button> <button class="sync-btn reset svelte-wiblfi" title="Reset offset">0</button> <button class="sync-btn fine svelte-wiblfi" title="Later by 0.01s">+0.01s</button> <button class="sync-btn coarse svelte-wiblfi" title="Later by 0.1s">+0.1s</button></div> <div class="sync-hint svelte-wiblfi">Use arrow keys to adjust (Shift for coarse)</div></div>');function fa(e,n){pe(n,!0);const i=A(()=>z.state.syncConfig.manualOffsetSec),s=A(()=>z.state.isActive);function r(T){return`${T>=0?"+":""}${T.toFixed(2)}s`}function o(T){z.adjustOffset(T)}function a(){z.resetOffset()}function c(T){if(t(s)&&!(T.target instanceof HTMLInputElement))switch(T.key){case"ArrowLeft":T.preventDefault(),o(T.shiftKey?-.1:-.01);break;case"ArrowRight":T.preventDefault(),o(T.shiftKey?.1:.01);break}}var l=ua();Ke("keydown",nn,c);var d=p(l),g=w(p(d),2),v=p(g),f=w(d,2),y=p(f);y.__click=()=>o(-.1);var h=w(y,2);h.__click=()=>o(-.01);var u=w(h,2);u.__click=a;var m=w(u,2);m.__click=()=>o(.01);var b=w(m,2);b.__click=()=>o(.1),Z(T=>{q(v,T),y.disabled=!t(s),h.disabled=!t(s),u.disabled=!t(s)||t(i)===0,m.disabled=!t(s),b.disabled=!t(s)},[()=>r(t(i))]),k(e,l),ye()}Te(["click"]);var ha=D('<span class="spinner svelte-1162o9n"></span> Loading...',1),ga=D('<div class="error-message svelte-1162o9n"> </div>'),va=D('<button class="upload-btn svelte-1162o9n"><!></button> <!>',1),ma=D('<div class="video-section svelte-1162o9n"><!> <!></div>'),pa=D('<button class="play-btn svelte-1162o9n">â–¶ Play</button>'),ya=D('<button class="stop-btn svelte-1162o9n">â¹ Stop</button>'),ba=D('<div class="progress-info svelte-1162o9n"><span class="time-display svelte-1162o9n"> </span></div>'),wa=D('<div class="song-info svelte-1162o9n"><div class="song-title svelte-1162o9n"> </div> <div class="song-artist svelte-1162o9n"> </div></div> <!> <div class="playback-controls svelte-1162o9n"><!> <button class="unload-btn svelte-1162o9n">Unload</button></div> <!>',1),Ma=D('<div class="ultrastar-panel svelte-1162o9n"><h3 class="panel-title svelte-1162o9n">Ultrastar Song</h3> <input type="file" accept=".txt" style="display: none;"/> <!></div>');function _a(e,n){pe(n,!0);let i=null,s;const r=A(()=>z.state.isActive),o=A(()=>z.state.isLoading),a=A(()=>z.state.isPlaying),c=A(()=>z.hasVideo),l=A(()=>z.title),d=A(()=>z.artist),g=A(()=>z.state.error);async function v(I){const L=I.target,N=L.files?.[0];if(!N)return;if(await z.loadFile(N)){i=sa({syncConfig:z.state.syncConfig});const H=z.state.detectedRange;j.setYAxisRange({minMidi:H.minMidi,maxMidi:H.maxMidi}),de.setTargetNotes(z.state.targetNotes),console.log("[Ultrastar] File loaded:",{title:z.title,artist:z.artist,youtubeId:z.state.youtubeId,bpm:z.state.song?.metadata.bpm,gap:z.state.song?.metadata.gap,videoGap:z.state.song?.metadata.videoGap,noteCount:z.state.targetNotes.length,firstNotes:z.state.targetNotes.slice(0,3),lastNotes:z.state.targetNotes.slice(-3),totalDurationMs:z.state.totalDurationMs,pitchRange:H,syncConfig:z.state.syncConfig})}L.value=""}async function f(){if(t(r))if(j.setVisualizationMode("highway"),i&&i.updateConfig(z.state.syncConfig),de.setTargetNotes(z.state.targetNotes),z.setPlaying(!0),t(c)&&ve.state.isPlayerReady){const I=i?.getYouTubeOffset()??0;console.log("[Ultrastar] Starting playback:",{youtubeOffset:I,noteCount:z.state.targetNotes.length,firstNote:z.state.targetNotes[0],syncConfig:z.state.syncConfig}),de.setCurrentTime(0),ve.seekTo(I),ve.play(),u()}else de.start()}function y(){de.stop(),z.setPlaying(!1),ve.pause(),m()}function h(){y(),z.unload(),ve.dispose(),de.reset(),i=null}function u(){ve.startSyncLoop(I=>{if(!i)return;const L=i.youTubeToTransport(I),N=de.state.currentTimeMs;Math.abs(L-N)>50&&de.setCurrentTime(Math.max(0,L))},100)}function m(){ve.stopSyncLoop()}function b(){s?.click()}ze(()=>{m(),ve.dispose()});var T=Ma(),M=w(p(T),2);M.__change=v,Ne(M,I=>s=I,()=>s);var x=w(M,2);{var C=I=>{var L=va(),N=Je(L);N.__click=b;var O=p(N);{var H=S=>{var G=ha();k(S,G)},Y=S=>{var G=Vn("Upload Ultrastar .txt");k(S,G)};$(O,S=>{t(o)?S(H):S(Y,!1)})}var ie=w(N,2);{var te=S=>{var G=ga(),J=p(G);Z(()=>q(J,t(g))),k(S,G)};$(ie,S=>{t(g)&&S(te)})}Z(()=>N.disabled=t(o)),k(I,L)},P=I=>{var L=wa(),N=Je(L),O=p(N),H=p(O),Y=w(O,2),ie=p(Y),te=w(N,2);{var S=U=>{var Q=ma(),W=p(Q);da(W,{});var R=w(W,2);fa(R,{}),k(U,Q)};$(te,U=>{t(c)&&U(S)})}var G=w(te,2),J=p(G);{var le=U=>{var Q=pa();Q.__click=f,k(U,Q)},_e=U=>{var Q=ya();Q.__click=y,k(U,Q)};$(J,U=>{t(a)?U(_e,!1):U(le)})}var Pe=w(J,2);Pe.__click=h;var Ce=w(G,2);{var ee=U=>{var Q=ba(),W=p(Q),R=p(W);Z((K,ae)=>q(R,`${K??""}s
          / ${ae??""}s`),[()=>Math.floor(de.state.currentTimeMs/1e3),()=>Math.floor(z.state.totalDurationMs/1e3)]),k(U,Q)};$(Ce,U=>{t(a)&&U(ee)})}Z(()=>{q(H,t(l)),q(ie,t(d)),Pe.disabled=t(a)}),k(I,L)};$(x,I=>{t(r)?I(P,!1):I(C)})}k(e,T),ye()}Te(["change","click"]);var Ta=D('<div class="note-display svelte-44x6iu"><span class="note-name svelte-44x6iu"> </span> <span class="octave svelte-44x6iu"> </span></div> <div class="details svelte-44x6iu"><span class="frequency"> </span> <span> </span> <span class="clarity"> </span></div>',1),Pa=D('<div class="no-pitch svelte-44x6iu"><span class="placeholder svelte-44x6iu">---</span> <span class="hint svelte-44x6iu">Sing or hum into the microphone</span></div>'),Ca=D('<div class="pitch-readout svelte-44x6iu"><!></div>');function Sa(e,n){pe(n,!0);const i=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],s=A(()=>()=>{const l=ce.state.currentPitch;if(!l)return null;const d=i[l.pitchClass],g=Math.floor(l.midi/12)-1,v=Math.round((l.midi-Math.round(l.midi))*100);return{name:d,octave:g,frequency:l.frequency.toFixed(1),cents:v,clarity:Math.round(l.clarity*100)}});var r=Ca(),o=p(r);{var a=l=>{const d=A(()=>t(s)());var g=Ta(),v=Je(g),f=p(v),y=p(f),h=w(f,2),u=p(h),m=w(v,2),b=p(m),T=p(b),M=w(b,2);let x;var C=p(M),P=w(M,2),I=p(P);Z(()=>{q(y,t(d).name),q(u,t(d).octave),q(T,`${t(d).frequency??""} Hz`),x=qe(M,1,"cents svelte-44x6iu",null,x,{sharp:t(d).cents>0,flat:t(d).cents<0}),q(C,`${t(d).cents>0?"+":""}${t(d).cents??""}Â¢`),q(I,`${t(d).clarity??""}%`)}),k(l,g)},c=l=>{var d=Pa();k(l,d)};$(o,l=>{t(s)()?l(a):l(c,!1)})}k(e,r),ye()}const Qt={isVisible:!1,summary:null,songTitle:"",artistName:"",source:null},Ia={totalNotes:0,notesHit:0,notesMissed:0,accuracyPercent:0,goldenNotesHit:0,goldenNotesTotal:0,phraseResults:[],averagePitchDeviationCents:0};function Aa(){let e=X(ke({...Qt}));return{get state(){return t(e)},show(n,i={}){t(e).summary=n,t(e).songTitle=i.title||"",t(e).artistName=i.artist||"",t(e).source=i.source||null,t(e).isVisible=!0},hide(){t(e).isVisible=!1},clear(){E(e,{...Qt},!0)},calculateSummary(n,i){if(i.length===0)return{...Ia};let s=0,r=0,o=0,a=0,c=0;const l=new Map;i.forEach((h,u)=>{const m=`target-${u}`,b=n.get(m),T=h.isGolden===!0,M=h.phraseIndex??0;T&&o++,l.has(M)||l.set(M,{hit:0,total:0,lyrics:[]});const x=l.get(M);x.total++,h.lyric&&x.lyrics.push(h.lyric),b?.hitStatus==="hit"&&(s++,x.hit++,T&&r++,typeof b.pitchAccuracyCents=="number"&&(a+=Math.abs(b.pitchAccuracyCents),c++))});const d=i.length,g=d-s,v=d>0?s/d*100:0,f=c>0?a/c:0,y=[];return l.forEach((h,u)=>{y.push({phraseIndex:u,notesHit:h.hit,totalNotes:h.total,accuracyPercent:h.total>0?h.hit/h.total*100:0,lyricPreview:h.lyrics.join("").trim().slice(0,30)||`Phrase ${u+1}`})}),y.sort((h,u)=>h.phraseIndex-u.phraseIndex),{totalNotes:d,notesHit:s,notesMissed:g,accuracyPercent:v,goldenNotesHit:r,goldenNotesTotal:o,phraseResults:y,averagePitchDeviationCents:f}},getLetterGrade(n){return n>=95?"S":n>=90?"A":n>=80?"B":n>=70?"C":n>=60?"D":"F"},getAccuracyColor(n){return n>=90?"var(--color-success, #28a745)":n>=70?"var(--color-warning, #ffc107)":"var(--color-error, #dc3545)"}}}const Ie=Aa();var xa=D('<span class="song-artist svelte-1typ84j"> </span>'),Ra=D('<div class="song-info svelte-1typ84j"><span class="song-title svelte-1typ84j"> </span> <!></div>'),Na=D('<div class="stat-item missed svelte-1typ84j"><span class="stat-value svelte-1typ84j"> </span> <span class="stat-label svelte-1typ84j">Missed</span></div>'),ka=D('<div class="golden-stats svelte-1typ84j"><span class="golden-icon svelte-1typ84j">â­</span> <span class="golden-text svelte-1typ84j"> </span></div>'),La=D('<div class="pitch-stats svelte-1typ84j"><span class="pitch-label">Avg. Pitch Deviation:</span> <span class="pitch-value svelte-1typ84j"> </span></div>'),Da=D('<div><span class="phrase-lyric svelte-1typ84j"> </span> <span class="phrase-accuracy svelte-1typ84j"> </span></div>'),Ha=D('<details class="phrase-details svelte-1typ84j"><summary class="phrase-summary svelte-1typ84j">Phrase Breakdown</summary> <div class="phrase-list svelte-1typ84j"></div></details>'),Ea=D('<button class="action-btn retry-btn svelte-1typ84j">Try Again</button>'),Oa=D('<div class="modal-backdrop svelte-1typ84j" role="dialog" aria-modal="true" aria-labelledby="results-title" tabindex="-1"><div class="modal-content svelte-1typ84j"><div class="modal-header svelte-1typ84j"><h2 id="results-title" class="modal-title svelte-1typ84j">Results</h2> <!></div> <div class="stats-section svelte-1typ84j"><div class="grade-display svelte-1typ84j"><span class="grade-letter svelte-1typ84j"> </span></div> <div class="accuracy-display svelte-1typ84j"><span class="accuracy-value svelte-1typ84j"> </span> <span class="accuracy-label svelte-1typ84j">Accuracy</span></div> <div class="stats-row svelte-1typ84j"><div class="stat-item svelte-1typ84j"><span class="stat-value hit svelte-1typ84j"> </span> <span class="stat-label svelte-1typ84j">Hit</span></div> <div class="stat-divider svelte-1typ84j">/</div> <div class="stat-item svelte-1typ84j"><span class="stat-value total svelte-1typ84j"> </span> <span class="stat-label svelte-1typ84j">Total</span></div> <!></div> <!> <!></div> <!> <div class="modal-actions svelte-1typ84j"><!> <button class="action-btn close-btn svelte-1typ84j">Close</button></div></div></div>');function Fa(e,n){pe(n,!0);const i=A(()=>Ie.state.isVisible),s=A(()=>Ie.state.summary),r=A(()=>Ie.state.songTitle),o=A(()=>Ie.state.artistName),a=A(()=>t(s)?Ie.getLetterGrade(t(s).accuracyPercent):"F"),c=A(()=>t(s)?Ie.getAccuracyColor(t(s).accuracyPercent):"");function l(){Ie.hide(),n.onClose?.()}function d(){Ie.hide(),n.onRetry?.()}function g(u){u.target===u.currentTarget&&l()}function v(u){u.key==="Escape"&&t(i)&&l()}var f=jn();Ke("keydown",nn,v);var y=Je(f);{var h=u=>{var m=Oa();m.__click=g,m.__keydown=v;var b=p(m),T=p(b),M=w(p(T),2);{var x=V=>{var se=Ra(),_=p(se),F=p(_),B=w(_,2);{var oe=ge=>{var Me=xa(),re=p(Me);Z(()=>q(re,`by ${t(o)??""}`)),k(ge,Me)};$(B,ge=>{t(o)&&ge(oe)})}Z(()=>q(F,t(r))),k(V,se)};$(M,V=>{t(r)&&V(x)})}var C=w(T,2),P=p(C);let I;var L=p(P),N=p(L),O=w(P,2);let H;var Y=p(O),ie=p(Y),te=w(O,2),S=p(te),G=p(S),J=p(G),le=w(S,4),_e=p(le),Pe=p(_e),Ce=w(le,2);{var ee=V=>{var se=Na(),_=p(se),F=p(_);Z(()=>q(F,t(s).notesMissed)),k(V,se)};$(Ce,V=>{t(s).notesMissed>0&&V(ee)})}var U=w(te,2);{var Q=V=>{var se=ka(),_=w(p(se),2),F=p(_);Z(()=>q(F,`Golden Notes: ${t(s).goldenNotesHit??""}/${t(s).goldenNotesTotal??""}`)),k(V,se)};$(U,V=>{t(s).goldenNotesTotal>0&&V(Q)})}var W=w(U,2);{var R=V=>{var se=La(),_=w(p(se),2),F=p(_);Z(B=>q(F,`${B??""} cents`),[()=>t(s).averagePitchDeviationCents.toFixed(1)]),k(V,se)};$(W,V=>{t(s).averagePitchDeviationCents>0&&V(R)})}var K=w(C,2);{var ae=V=>{var se=Ha(),_=w(p(se),2);Ge(_,21,()=>t(s).phraseResults,et,(F,B)=>{var oe=Da();let ge;var Me=p(oe),re=p(Me),Ae=w(Me,2),ne=p(Ae);Z(Le=>{ge=qe(oe,1,"phrase-item svelte-1typ84j",null,ge,{perfect:t(B).accuracyPercent===100,good:t(B).accuracyPercent>=70&&t(B).accuracyPercent<100,poor:t(B).accuracyPercent<70}),q(re,t(B).lyricPreview),q(ne,`${t(B).notesHit??""}/${t(B).totalNotes??""}
                  (${Le??""}%)`)},[()=>t(B).accuracyPercent.toFixed(0)]),k(F,oe)}),k(V,se)};$(K,V=>{t(s).phraseResults.length>1&&V(ae)})}var ue=w(K,2),be=p(ue);{var we=V=>{var se=Ea();se.__click=d,k(V,se)};$(be,V=>{n.onRetry&&V(we)})}var me=w(be,2);me.__click=l,Z(V=>{I=at(P,"",I,{"--grade-color":t(c)}),q(N,t(a)),H=at(O,"",H,{color:t(c)}),q(ie,`${V??""}%`),q(J,t(s).notesHit),q(Pe,t(s).totalNotes)},[()=>t(s).accuracyPercent.toFixed(1)]),k(u,m)};$(y,u=>{t(i)&&t(s)&&u(h)})}k(e,f),ye()}Te(["click","keydown"]);const yt={hasImportedSnapshot:!1,snapshot:null,isLoading:!1,error:null,transpositionSemitones:0};function Wa(){let e=X(ke({...yt}));return{get state(){return t(e)},async checkAndConsumeHandoff(){if(!ti())return!1;t(e).isLoading=!0,t(e).error=null;try{const i=await ni();return i?i.schemaVersion!==Nt?(t(e).error=`Incompatible snapshot version: ${i.schemaVersion}. Expected: ${Nt}`,t(e).isLoading=!1,tt(),!1):(t(e).snapshot=i,t(e).hasImportedSnapshot=!0,t(e).isLoading=!1,tt(),console.log("[HandoffState] Successfully imported snapshot",{voices:i.voices.length,microbeatCount:i.timeGrid.microbeatCount,tempo:i.tempo}),!0):(t(e).error="Handoff data expired or not found. Please try exporting again.",t(e).isLoading=!1,tt(),!1)}catch(i){return console.error("[HandoffState] Failed to process handoff",i),t(e).error="Failed to import data from Student Notation.",t(e).isLoading=!1,tt(),!1}},get voices(){return t(e).snapshot?.voices??[]},get timeGrid(){return t(e).snapshot?.timeGrid??null},get tempo(){return t(e).snapshot?.tempo??90},get suggestedPitchRange(){if(!t(e).snapshot)return null;const n=3,i=t(e).snapshot.minMidiPitch,s=t(e).snapshot.maxMidiPitch;return i===void 0||s===void 0?null:{minMidi:Math.max(21,i-n+t(e).transpositionSemitones),maxMidi:Math.min(108,s+n+t(e).transpositionSemitones)}},setTransposition(n){t(e).transpositionSemitones=n},transposeUp(){t(e).transpositionSemitones+=1},transposeDown(){t(e).transpositionSemitones-=1},getTransposedMidi(n){return n+t(e).transpositionSemitones},async bringBackToStudentNotation(){if(!t(e).snapshot){console.warn("[HandoffState] No snapshot to bring back");return}const n={...t(e).snapshot,sourceApp:"singing-trainer",createdAt:Date.now(),voices:t(e).snapshot.voices.map(i=>({...i,notes:i.notes.map(s=>({...s,midiPitch:s.midiPitch+t(e).transpositionSemitones}))}))};try{const i=await $n(n);console.log("[HandoffState] Handoff slot written for return",i),ei(i)}catch(i){console.error("[HandoffState] Failed to write return handoff",i)}},clearSnapshot(){E(e,{...yt},!0)},reset(){E(e,{...yt},!0)}}}const Se=Wa();var Ba=D('<div class="handoff-controls svelte-1izxdqy"><div class="transposition-control svelte-1izxdqy"><button class="transpose-btn svelte-1izxdqy" title="Transpose down">-</button> <span class="transposition-label svelte-1izxdqy"> </span> <button class="transpose-btn svelte-1izxdqy" title="Transpose up">+</button></div> <button class="bring-back-btn svelte-1izxdqy">Bring Back to Student Notation</button></div>'),za=D('<div class="error-banner svelte-1izxdqy"> </div>'),qa=D('<div class="import-info svelte-1izxdqy"><span class="import-label svelte-1izxdqy">Microbeats:</span> <span class="import-value svelte-1izxdqy"> </span></div>'),Ga=D('<div class="control-group svelte-1izxdqy"><h3 class="control-group-title svelte-1izxdqy">Imported Material</h3> <div class="import-info svelte-1izxdqy"><span class="import-label svelte-1izxdqy">Voices:</span> <span class="import-value svelte-1izxdqy"> </span></div> <div class="import-info svelte-1izxdqy"><span class="import-label svelte-1izxdqy">Tempo:</span> <span class="import-value svelte-1izxdqy"> </span></div> <!></div>'),Ya=D('<div class="app svelte-1izxdqy"><header class="header svelte-1izxdqy"><h1 class="title svelte-1izxdqy">Singing Trainer</h1> <div class="header-controls svelte-1izxdqy"><!></div></header> <!> <main class="main svelte-1izxdqy"><aside class="sidebar sidebar--left svelte-1izxdqy"><div class="control-group svelte-1izxdqy"><!></div> <div class="control-group svelte-1izxdqy"><!></div> <div class="control-group svelte-1izxdqy"><!></div> <div class="control-group svelte-1izxdqy"><details class="settings-details svelte-1izxdqy"><summary class="settings-summary svelte-1izxdqy">Settings</summary> <div class="settings-content svelte-1izxdqy"><!> <!> <!></div></details></div> <div class="control-group svelte-1izxdqy"><!></div> <!></aside> <section class="canvas-area svelte-1izxdqy"><!></section></main> <!></div>');function Ua(e,n){pe(n,!0);let i=X(!1);Re(()=>de.onPerformanceComplete(U=>{if(z.state.isActive&&z.state.isPlaying){const Q=Ie.calculateSummary(U,z.state.targetNotes);Ie.show(Q,{title:z.title,artist:z.artist,source:"ultrastar"}),z.setPlaying(!1)}}));function s(){Ie.state.source==="ultrastar"?(de.reset(),de.setTargetNotes(z.state.targetNotes),j.setVisualizationMode("highway")):Ie.state.source}sn(async()=>{if(await Se.checkAndConsumeHandoff()){console.log("[App] Handoff detected and processed");const U=Se.suggestedPitchRange;U&&j.setYAxisRange(U)}try{await ds(),j.setDetecting(!0),console.log("[App] Pitch detection auto-started")}catch(U){console.error("[App] Failed to auto-start pitch detection:",U)}}),ze(()=>{us()});const r=A(()=>Se.state.hasImportedSnapshot),o=A(()=>Se.state.transpositionSemitones),a=A(()=>Se.state.error);function c(){Se.bringBackToStudentNotation()}function l(){Se.transposeUp()}function d(){Se.transposeDown()}var g=Ya(),v=p(g),f=w(p(v),2),y=p(f);{var h=ee=>{var U=Ba(),Q=p(U),W=p(Q);W.__click=d;var R=w(W,2),K=p(R),ae=w(R,2);ae.__click=l;var ue=w(Q,2);ue.__click=c,Z(()=>q(K,`${t(o)>=0?"+":""}${t(o)??""}`)),k(ee,U)};$(y,ee=>{t(r)&&ee(h)})}var u=w(v,2);{var m=ee=>{var U=za(),Q=p(U);Z(()=>q(Q,t(a))),k(ee,U)};$(u,ee=>{t(a)&&ee(m)})}var b=w(u,2),T=p(b),M=p(T),x=p(M);Sa(x,{});var C=w(M,2),P=p(C);Gs(P,{});var I=w(C,2),L=p(I);_a(L,{});var N=w(I,2),O=p(N),H=w(p(O),2),Y=p(H);ys(Y,{});var ie=w(Y,2);Ms(ie,{});var te=w(ie,2);Os(te,{});var S=w(N,2),G=p(S);Hs(G,{});var J=w(S,2);{var le=ee=>{var U=Ga(),Q=w(p(U),2),W=w(p(Q),2),R=p(W),K=w(Q,2),ae=w(p(K),2),ue=p(ae),be=w(K,2);{var we=me=>{var V=qa(),se=w(p(V),2),_=p(se);Z(()=>q(_,Se.timeGrid.microbeatCount)),k(me,V)};$(be,me=>{Se.timeGrid&&me(we)})}Z(()=>{q(R,Se.voices.length),q(ue,`${Se.tempo??""} BPM`)}),k(ee,U)};$(J,ee=>{t(r)&&ee(le)})}var _e=w(T,2),Pe=p(_e);is(Pe,{});var Ce=w(b,2);Fa(Ce,{onRetry:s}),rn("open","toggle",O,ee=>E(i,ee),()=>t(i)),k(e,g),ye()}Te(["click"]);function Va(e){const n=Xn(Ua,{target:e});return{destroy:()=>{Kn(n)}}}const $t=document.getElementById("app");$t&&Va($t);
