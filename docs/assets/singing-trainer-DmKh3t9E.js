import"./modulepreload-polyfill-B5Qt9EMX.js";import{o as lt,h as _t,i as ee,w as It,l as Tt,m as Ht,p as Rt,S as ze,q as _e,j as xe,r as je,t as At,u as Dt}from"./navigation-dv7s3B3s.js";import{q as xt,r as Lt,v as Wt,w as kt,x as Nt,y as Ot,z as ct,A as Ft,S as dt,B as qt,C as Et,P as Bt,g as n,D as Yt,E as Xt,k as Se,n as H,F as zt,G as jt,H as Gt,I as Ut,J as Vt,K as Zt,L as Kt,M as Jt,N as Qt,p as Q,l as pe,j as O,o as k,f as x,c as C,s as S,a as A,i as $,h as le,t as U,d as ve,O as Oe,b as X,m as $t,u as en,Q as tn,R as nn,T as ut}from"./disclose-version-CQsWsxfw.js";import{e as Le,s as Ge,i as Be}from"./style-CDe0fSxQ.js";import{U as on,A as an,b as ht,i as sn,P as rn,S as ln}from"./index-Daas8fXP.js";import{P as cn}from"./index-DoA2xU7W.js";function Ye(e,t,i=!1){if(e.multiple){if(t==null)return;if(!Lt(t))return Wt();for(var a of e.options)a.selected=t.includes(Ue(a));return}for(a of e.options){var o=Ue(a);if(kt(o,t)){a.selected=!0;return}}(!i||t!==void 0)&&(e.selectedIndex=-1)}function ft(e){var t=new MutationObserver(()=>{Ye(e,e.__value)});t.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),xt(()=>{t.disconnect()})}function Ue(e){return"__value"in e?e.__value:e.value}function Ve(e,t){return e===t||e?.[dt]===t}function se(e={},t,i,a){return Nt(()=>{var o,r;return Ot(()=>{o=r,r=[],ct(()=>{e!==i(...r)&&(t(e,...r),o&&Ve(i(...o),e)&&t(null,...o))})}),()=>{Ft(()=>{r&&Ve(i(...r),e)&&t(null,...r)})}}),e}let Ie=!1;function dn(e){var t=Ie;try{return Ie=!1,[e(),Ie]}finally{Ie=t}}function Y(e,t,i,a){var o=!Vt||(i&Zt)!==0,r=(i&Ut)!==0,d=(i&Jt)!==0,c=a,s=!0,l=()=>(s&&(s=!1,c=d?ct(a):a),c),h;if(r){var b=dt in e||Qt in e;h=qt(e,t)?.set??(b&&t in e?M=>e[t]=M:void 0)}var u,f=!1;r?[u,f]=dn(()=>e[t]):u=e[t],u===void 0&&a!==void 0&&(u=l(),h&&(o&&Et(),h(u)));var v;if(o?v=()=>{var M=e[t];return M===void 0?l():(s=!0,M)}:v=()=>{var M=e[t];return M!==void 0&&(c=void 0),M===void 0?c:M},o&&(i&Bt)===0)return v;if(h){var g=e.$$legacy;return(function(M,_){return arguments.length>0?((!o||!_||g||f)&&h(_?v():M),M):v()})}var w=!1,m=((i&Kt)!==0?Yt:Xt)(()=>(w=!1,v()));r&&n(m);var P=jt;return(function(M,_){if(arguments.length>0){const F=_?n(m):o&&r?Se(M):M;return H(m,F),w=!0,c!==void 0&&(c=F),M}return zt&&w||(P.f&Gt)!==0?m.v:n(m)})}const Ze=["#ef8aab","#f48e7d","#e89955","#cdaa42","#a4ba57","#6ec482","#2dc8b1","#16c3da","#58b8f6","#8fa9ff","#ba9bf2","#db8fd4"];function Ke(e){const t=parseInt(e.slice(1),16);return[t>>16&255,t>>8&255,t&255]}function un(e,t,i){const a=Math.max(0,Math.min(1,i));return e.map((o,r)=>Math.round(o+a*(t[r]-o)))}function gt(e,t=0){const i=Math.floor(e),a=e-i,o=(i%12-t+12)%12,r=(o+1)%12,d=Ke(Ze[o]),c=Ke(Ze[r]);return un(d,c,a)}const hn={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11};function fn(e){const t=e.replace(/\d+$/,"");return hn[t]??0}function gn(e){const{cellHeight:t,columnWidths:i,viewport:a}=e,o=mn(i,e.cellWidth);return{getRowY(r){return(r-a.startRow)*t+t/2},getRowFromY(r){const d=(r-t/2)/t;return Math.round(d)+a.startRow},getColumnX(r){return r<0?0:r>=o.length?o[o.length-1]??0:o[r]??0},getColumnFromX(r){let d=0,c=o.length-1;for(;d<c;){const s=Math.floor((d+c)/2);(o[s]??0)<=r?d=s+1:c=s}return Math.max(0,d-1)}}}function vn(e){const{cellHeight:t,viewport:i,pixelsPerSecond:a,nowLineX:o=100,currentTimeMs:r=0}=e;return{getRowY(d){return(d-i.startRow)*t+t/2},getRowFromY(d){const c=(d-t/2)/t;return Math.round(c)+i.startRow},getColumnX(d){return 0},getColumnFromX(d){return 0},getTimeX(d){const c=d-r;return o+c/1e3*a},getTimeFromX(d){const c=(d-o)/a*1e3;return r+c}}}function mn(e,t){const i=[0];let a=0;for(let o=0;o<e.length;o++){const r=(e[o]??1)*t;a+=r,i.push(a)}return i}function wn(e,t){const{startRow:i,endRow:a}=e,o=Math.max(0,t.length-1);return{startRow:i,endRow:a,paddedStartRow:Math.max(0,i-1),paddedEndRow:Math.min(o,a+1)}}function Je(e,t,i,a){const o=a.getRowY(e),r=i;return o>=-r&&o<=t.containerHeight+r}function yn(e){let t=(e||"").replace(/\d/g,"").trim();return t=t.replace(/b/g,"b-").replace(/#/g,"b_"),t}function bn(e){switch(e){case"C":return{lineWidth:3.33,dash:[],color:"#adb5bd"};case"E":return{lineWidth:1,dash:[5,5],color:"#adb5bd"};case"G":return{lineWidth:1,dash:[],color:"#dee2e6"};case"B":case"A":case"F":case"Eb/Db":case"Db/C#":return{lineWidth:1,dash:[],color:"#ced4da"};default:return{lineWidth:1,dash:[],color:"#ced4da"}}}const Te={stroke:"#c7cfd8",background:"rgba(207, 214, 222, 0.32)"};let me=null;function pn(){if(me)return me;if(typeof window>"u")return Te;try{const e=window.getComputedStyle(document.documentElement);me={stroke:e.getPropertyValue("--c-anacrusis-border").trim()||Te.stroke,background:e.getPropertyValue("--c-anacrusis-bg").trim()||Te.background}}catch{me=Te}return me}function Mn(e,t,i,a,o,r=0,d){const{fullRowData:c,viewportHeight:s,viewportWidth:l,cellHeight:h}=t,b=l,u=["B","A","F","E♭/D♯","D♭/C♯"];for(let f=a;f<=o;f++){const v=c[f];if(!v||v.isBoundary)continue;const g=i.getRowY(f);if(g<-10||g>s+10)continue;const w=yn(v.pitch);if(u.includes(w))continue;const m=bn(w);w==="G"?(e.save(),e.fillStyle=m.color,e.fillRect(r,g-h/2,b-r,h),e.restore()):(e.beginPath(),e.moveTo(r,g),e.lineTo(b,g),e.lineWidth=m.lineWidth,e.strokeStyle=m.color,e.setLineDash(m.dash),e.stroke(),e.setLineDash([]))}}function Cn(e,t,i,a){const{columnWidths:o,viewportHeight:r,macrobeatBoundaryStyles:d,placedTonicSigns:c}=t,s=o.length;for(let l=0;l<=s;l++){const h=l===0||l===s,b=Sn(l,c),u=c.some(m=>l===m.columnIndex+2),f=a.includes(l);if(!_n(l,c))continue;let g=null;if(h||b||u)g={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(f){const m=a.indexOf(l),P=d[m]??"dashed";if(P==="anacrusis"){const{stroke:M}=pn();g={lineWidth:1,strokeStyle:M,dash:[4,4]}}else g={lineWidth:1,strokeStyle:"#adb5bd",dash:P==="solid"?[]:[5,5]}}if(!g)continue;const w=i.getColumnX(l);e.beginPath(),e.moveTo(w,0),e.lineTo(w,r),e.lineWidth=g.lineWidth,e.strokeStyle=g.strokeStyle,e.setLineDash(g.dash),e.stroke()}e.setLineDash([])}function Pn(e,t,i){const{viewportHeight:a,beatIntervalMs:o,measureIntervalMs:r,visibleTimeRange:d,nowLineX:c}=t,s=Math.floor(d.startMs/o)*o,l=Math.ceil(d.endMs/o)*o;for(let h=s;h<=l;h+=o){const b=i.getTimeX?.(h);if(b===void 0)continue;const u=r?h%r===0:!1;e.beginPath(),e.moveTo(b,0),e.lineTo(b,a),e.lineWidth=u?2:1,e.strokeStyle=u?"#adb5bd":"#dee2e6",e.setLineDash(u?[]:[5,5]),e.stroke()}e.setLineDash([]),c!==void 0&&(e.beginPath(),e.moveTo(c,0),e.lineTo(c,a),e.lineWidth=3,e.strokeStyle="#00ff00",e.setLineDash([]),e.stroke())}function Sn(e,t){return t.some(i=>i.columnIndex===e)}function _n(e,t){return!t.some(i=>i.columnIndex+1===e)}const In=.7,Tn=.9,Hn=4,Rn=1,An=.15,Dn=.2,xn=1,Xe=1.5;function Me(e,t){return Number.isFinite(e)&&e>0&&Number.isFinite(t)&&t>0}function vt(e){if(!e||typeof e.startColumnIndex!="number"||typeof e.endColumnIndex!="number")return!1;const t=e.shape==="circle"?e.startColumnIndex+1:e.startColumnIndex;return e.endColumnIndex>t}function He(e){const t=e?.split("-")[1];return Number.parseInt(t??"0",10)}function mt(e,t,i){const a=i*.25,o=e.uuid;if(!o)return 0;const r=t.filter(s=>!s.isDrum&&s.row===e.row&&s.startColumnIndex===e.startColumnIndex&&s.uuid&&s.uuid!==o);if(r.length===0)return 0;const d=[e,...r];return d.sort((s,l)=>He(s.uuid)-He(l.uuid)),d.findIndex(s=>s.uuid===o)*a}function Ln(e,t,i){const a=i/2*.12,o=e.uuid;if(!o)return 0;const r=t.filter(s=>!s.isDrum&&s.row===e.row&&s.startColumnIndex===e.startColumnIndex&&s.uuid&&s.uuid!==o&&vt(s));if(r.length===0)return 0;const d=[e,...r];return d.sort((s,l)=>He(s.uuid)-He(l.uuid)),d.findIndex(s=>s.uuid===o)*a}function Wn(e){if(!e)return{multiplier:1,category:"natural"};const t=e.includes("♭"),i=e.includes("♯"),a=e.includes("/");return!t&&!i?{multiplier:1,category:"natural"}:a?{multiplier:.75,category:"both-accidentals"}:{multiplier:.88,category:"single-accidental"}}function qe(e,t,i,a,o,r){const{multiplier:d,category:c}=Wn(t);let s;if(i==="circle"){const l=r*2*Tn;switch(c){case"natural":s=l;break;case"single-accidental":s=l*.8;break;case"both-accidentals":s=l*.4;break;default:s=l*d}}else{const l=r*2*In;switch(c){case"natural":s=l*1.5;break;case"single-accidental":s=l*1.2;break;case"both-accidentals":s=l;break;default:s=l*d}}if(!(s<Hn))if(e.fillStyle="#212529",e.font=`bold ${s}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle",i==="oval"&&c==="both-accidentals"&&t.includes("/")){const l=t.split("/"),h=s*1.1,b=h*(l.length-1),u=o-b/2;l.forEach((f,v)=>{const g=u+v*h,w=s*.08;e.fillText(f.trim(),a,g+w)})}else{const l=s*.08;e.fillText(t,a,o+l)}}function kn(e,t,i,a,o,r,d){e.save(),e.beginPath(),e.arc(i,o,r,Math.PI/2,-Math.PI/2,!1),e.lineTo(a,o-r),e.arc(a,o,r,-Math.PI/2,Math.PI/2,!1),e.lineTo(i,o+r),e.closePath(),e.strokeStyle=t.color,e.lineWidth=d,e.shadowColor=t.color,e.shadowBlur=Xe,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore()}function Nn(e,t,i,a){const{config:o,coords:r,allNotes:d,getScaleDegreeLabel:c}=t,{cellWidth:s,cellHeight:l,columnWidths:h,degreeDisplayMode:b}=o,u=r.getRowY(a),f=r.getColumnX(i.startColumnIndex),g=(h[i.startColumnIndex]??1)*s;if(!Me(g,l))return;const w=mt(i,d,s),m=Math.max(.5,g*.15),P=f+g/2+w,M=g/2-m/2,_=l/2-m/2;if(Me(M,_)&&(e.save(),e.beginPath(),e.ellipse(P,u,M,_,0,0,2*Math.PI),e.strokeStyle=i.color,e.lineWidth=m,e.shadowColor=i.color,e.shadowBlur=Xe,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore(),b!=="off"&&c)){const{label:F}=c(i);F&&qe(e,F,"oval",P,u,M)}}function On(e,t,i,a){const{config:o,coords:r,allNotes:d,getScaleDegreeLabel:c}=t,{cellWidth:s,cellHeight:l,degreeDisplayMode:h,longNoteStyle:b}=o,u=r.getRowY(a),f=r.getColumnX(i.startColumnIndex),g=r.getColumnX(i.startColumnIndex+1)-f;if(!Me(g,l))return;const w=mt(i,d,s),m=f+g+w,P=Math.max(Rn,g*An),M=l/2-P/2,_=vt(i);if(_&&b==="style2"){const I=m,L=r.getColumnX(i.endColumnIndex);if(Me(L-I,M)&&(kn(e,i,I,L,u,M,P),h!=="off"&&c)){const{label:B}=c(i);if(B){const z=(I+L)/2;qe(e,B,"circle",z,u,M)}}return}if(_){const I=r.getColumnX(i.endColumnIndex+1),L=Ln(i,d,l),B=u+L;e.beginPath(),e.moveTo(m,B),e.lineTo(I,B),e.strokeStyle=i.color,e.lineWidth=Math.max(xn,g*Dn),e.stroke()}const F=g-P/2;if(Me(F,M)&&(e.save(),e.beginPath(),e.ellipse(m,u,F,M,0,0,2*Math.PI),e.strokeStyle=i.color,e.lineWidth=P,e.shadowColor=i.color,e.shadowBlur=Xe,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore(),h!=="off"&&c)){const{label:I}=c(i);I&&qe(e,I,"circle",m,u,F)}}function Fn(e,t,i){const{config:a,coords:o}=t,{cellWidth:r,cellHeight:d}=a,c=o.getRowY(i.globalRow??i.row),s=o.getColumnX(i.columnIndex),h=o.getColumnX(i.columnIndex+1)-s,b=h*2,u=s+b/2,f=Math.min(b,d)/2*.9;if(f<2||(e.beginPath(),e.arc(u,c,f,0,2*Math.PI),e.strokeStyle="#212529",e.lineWidth=Math.max(.5,h*.05),e.stroke(),i.tonicNumber==null))return;const v=i.tonicNumber.toString(),g=f*1.5;g<6||(e.fillStyle="#212529",e.font=`bold ${g}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(v,u,c))}const qn={timeWindowMs:4e3,pixelsPerSecond:200,circleRadius:9.5,proximityThreshold:35,maxConnections:3,connectorLineWidth:2.5,connectorColor:"rgba(0,0,0,0.4)",useTonicRelativeColors:!0,tonicPitchClass:0,clarityThreshold:.5,maxOpacity:.9};function wt(e){return{...qn,...e}}function Qe(e,t,i,a,o,r,d){const c=wt(r.trailConfig);if(a<c.clarityThreshold||i<=0)return;const{cellHeight:s,colorMode:l}=r,h=yt(t,i,s,d),b=s/2*.8,u=l==="bw"?[128,128,128]:gt(i,c.tonicPitchClass);e.save(),e.beginPath(),e.arc(o,h,b+4,0,2*Math.PI),e.fillStyle=`rgba(${u[0]}, ${u[1]}, ${u[2]}, ${a*.3})`,e.fill(),e.beginPath(),e.arc(o,h,b,0,2*Math.PI),e.fillStyle=`rgba(${u[0]}, ${u[1]}, ${u[2]}, ${a})`,e.fill(),e.restore()}function yt(e,t,i,a){if(a.length===0||!a[0])return 0;const o=Math.floor(t),r=t-o,s=(a[0].midi??108)-o;return s<0||s>=a.length?s<0?0:e.getRowY(a.length-1):e.getRowY(s)-r*i}function En(e,t,i,a,o,r){const{viewportWidth:d,cellHeight:c,colorMode:s}=o,l=wt(o.trailConfig),h=l.timeWindowMs,b=l.pixelsPerSecond,u=i.filter(f=>f.midi>0&&f.clarity>=l.clarityThreshold).map(f=>{const v=a-f.time;if(v>=h||v<0)return null;const g=d-v/1e3*b,w=yt(t,f.midi,c,r),m=s==="bw"?[128,128,128]:gt(f.midi,l.tonicPitchClass);return{x:g,y:w,clarity:f.clarity,color:m}}).filter(f=>f!==null&&f.x>=0);if(u.length!==0){e.save(),e.strokeStyle=l.connectorColor,e.lineWidth=l.connectorLineWidth,e.beginPath();for(let f=0;f<u.length;f++){let v=0;for(let g=f+1;g<u.length&&v<l.maxConnections;g++){const w=u[f].x-u[g].x,m=u[f].y-u[g].y;Math.sqrt(w*w+m*m)<=l.proximityThreshold&&(e.moveTo(u[f].x,u[f].y),e.lineTo(u[g].x,u[g].y),v++)}}e.stroke();for(const f of u){const v=Math.min(f.clarity*l.maxOpacity,1);e.fillStyle=`rgba(${f.color[0]}, ${f.color[1]}, ${f.color[2]}, ${v})`,e.beginPath(),e.arc(f.x,f.y,l.circleRadius,0,2*Math.PI),e.fill()}e.restore()}}function $e(e,t,i,a,o){const{cellHeight:r,nowLineX:d=100,pixelsPerSecond:c}=o;for(const s of i){const l=(d??100)+(s.startTimeMs-a)/1e3*c,h=l+s.durationMs/1e3*c;if(h<0||l>o.viewportWidth)continue;const b=Math.round(108-s.midi),u=t.getRowY(b),f=r/2-2,v=s.color??"#4CAF50";if(e.save(),e.beginPath(),e.arc(l,u,f,Math.PI/2,-Math.PI/2,!1),e.lineTo(h,u-f),e.arc(h,u,f,-Math.PI/2,Math.PI/2,!1),e.lineTo(l,u+f),e.closePath(),e.strokeStyle=v,e.lineWidth=3,e.shadowColor=v,e.shadowBlur=8,e.stroke(),e.shadowBlur=0,e.restore(),s.label){const g=(l+h)/2;e.fillStyle=v,e.font=`bold ${f}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(s.label,g,u)}}}function Bn(e){const t=e.replace(/\d+$/,"");return t.length>0?t:e}function bt(e,t){return!Number.isFinite(t)||t<=0?e:Math.round(e*t)/t}function Yn(e,t,i,a){const o=Math.max(10,Math.min(e*1.2,t*1.2)),r=i<=3?1:.7,d=a<=1?1.08:1;return bt(o*r*d,a)}function Xn(e){const t=e.getContext("2d");return t&&(t.getTransform().a||window.devicePixelRatio)||1}function zn(e,t){const{showFrequencyLabels:i,showOctaveLabels:a,accidentalMode:o}=t,r=b=>a?b:Bn(b);if(i)return String(Math.round(e.frequency));const{flatName:d,sharpName:c,isAccidental:s}=e,{sharp:l,flat:h}=o;return s?l&&h?r(e.pitch):l&&!h?r(c):h&&!l?r(d):null:r(d)}function et(e,t,i,a){const{fullRowData:o,cellWidth:r,cellHeight:d,legendColumnWidth:c,colorMode:s,accidentalMode:l}=t,{startRow:h,endRow:b,coords:u}=i,f=Xn(e.canvas),v=m=>bt(m,f),g=c;let w=0;for(const m of a){for(let P=h;P<=b;P++){const M=o[P];if(!M||M.isBoundary||M.column!==m)continue;const _=u.getRowY(P),F=!l.sharp&&!l.flat,I=M.isAccidental&&F,L=zn(M,t);if(L===null)continue;let B=s==="bw"?"#ffffff":M.hex||"#ffffff",z="FF";I&&(z="00"),e.fillStyle=I?"rgba(255,255,255,0)":B,e.fillRect(w,_-d/2,g,d);const W=Yn(r,d,L.length,f);e.font=`bold ${W}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle";const Z=v(w+g/2),te=v(_);e.strokeStyle=`#212529${z}`,e.lineWidth=Math.max(1.2,2.5/f),e.lineJoin="round",e.strokeText(L,Z,te),e.fillStyle=`#ffffff${z}`,e.fillText(L,Z,te)}w+=g}}function jn(e,t,i,a){e&&(e.clearRect(0,0,e.canvas.width,e.canvas.height),et(e,i,a,["B","A"])),t&&(t.clearRect(0,0,t.canvas.width,t.canvas.height),et(t,i,a,["A","B"]))}var Gn=x('<canvas class="pitch-grid-legend pitch-grid-legend--left svelte-ui3s88"></canvas>'),Un=x('<canvas class="pitch-grid-legend pitch-grid-legend--right svelte-ui3s88"></canvas>'),Vn=x('<div class="pitch-grid-container svelte-ui3s88"><!> <canvas class="pitch-grid-canvas svelte-ui3s88"></canvas> <!></div>');function Zn(e,t){Q(t,!0);let i=Y(t,"colorMode",3,"color"),a=Y(t,"degreeDisplayMode",3,"off"),o=Y(t,"accidentalMode",19,()=>({sharp:!0,flat:!0})),r=Y(t,"showFrequencyLabels",3,!1),d=Y(t,"showOctaveLabels",3,!0),c=Y(t,"placedNotes",19,()=>[]),s=Y(t,"placedTonicSigns",19,()=>[]),l=Y(t,"columnWidths",19,()=>[]),h=Y(t,"macrobeatGroupings",19,()=>[]),b=Y(t,"macrobeatBoundaryStyles",19,()=>[]),u=Y(t,"longNoteStyle",3,"style1"),f=Y(t,"beatIntervalMs",3,500),v=O(void 0),g=O(void 0),w=O(void 0),m=O(null),P=O(null),M=O(null),_=O(null);const F=30,I=k(()=>t.mode==="notation"||t.mode==="playback"),L=k(()=>t.mode==="singing"),B=k(()=>t.mode==="highway");function z(){if(n(I))return gn({cellWidth:t.cellWidth,cellHeight:t.cellHeight,columnWidths:l(),viewport:t.viewport,modulationMarkers:t.modulationMarkers});{const p=n(B)?t.highwayConfig:t.singingConfig;return vn({cellWidth:t.cellWidth,cellHeight:t.cellHeight,viewport:t.viewport,pixelsPerSecond:p?.pixelsPerSecond??200,nowLineX:p?.nowLineX??100,currentTimeMs:p?.currentTimeMs??0})}}function W(){if(!n(m)||!n(v))return;const p=z(),{paddedStartRow:T,paddedEndRow:q}=wn(t.viewport,t.fullRowData);n(m).clearRect(0,0,t.viewport.containerWidth,t.viewport.containerHeight);const K={fullRowData:t.fullRowData,cellHeight:t.cellHeight,viewportHeight:t.viewport.containerHeight,viewportWidth:t.viewport.containerWidth,colorMode:i()};Mn(n(m),K,p,T,q),n(I)?Z(n(m),p):n(L)?te(n(m),p):n(B)&&oe(n(m),p),(d()||r())&&(n(P)||n(M))&&ce(p,T,q)}function Z(p,T){const q=y(h()),K={columnWidths:l(),cellWidth:t.cellWidth,viewportHeight:t.viewport.containerHeight,macrobeatGroupings:h(),macrobeatBoundaryStyles:b(),placedTonicSigns:s()};Cn(p,K,T,q);const ge=c().filter(G=>G.isDrum||G.globalRow===void 0?!1:Je(G.globalRow,t.viewport,t.cellHeight,T)),St=s().filter(G=>G.globalRow===void 0?!1:Je(G.globalRow,t.viewport,t.cellHeight,T)),Ne={config:{cellWidth:t.cellWidth,cellHeight:t.cellHeight,columnWidths:l(),degreeDisplayMode:a(),accidentalMode:o(),longNoteStyle:u(),colorMode:i()},coords:T,allNotes:c()};for(const G of ge)G.shape==="oval"?Nn(p,Ne,G,G.globalRow):G.shape==="circle"&&On(p,Ne,G,G.globalRow);for(const G of St)Fn(p,Ne,G)}function te(p,T){if(!t.singingConfig)return;const q={cellHeight:t.cellHeight,viewportWidth:t.viewport.containerWidth,pixelsPerSecond:t.singingConfig.pixelsPerSecond??200,timeWindowMs:t.singingConfig.timeWindowMs??4e3,colorMode:i(),trailConfig:t.singingConfig.trailConfig};t.singingConfig.pitchHistory&&t.singingConfig.pitchHistory.length>0&&En(p,T,t.singingConfig.pitchHistory,performance.now(),q,t.fullRowData),t.singingConfig.targetNotes&&t.singingConfig.targetNotes.length>0&&$e(p,T,t.singingConfig.targetNotes,performance.now(),q),t.singingConfig.userPitch&&t.singingConfig.userPitch.clarity>.5&&Qe(p,T,t.singingConfig.userPitch.midi,t.singingConfig.userPitch.clarity,t.viewport.containerWidth-20,q,t.fullRowData)}function oe(p,T){if(!t.highwayConfig)return;const q={cellHeight:t.cellHeight,viewportWidth:t.viewport.containerWidth,nowLineX:t.highwayConfig.nowLineX,pixelsPerSecond:t.highwayConfig.pixelsPerSecond??200,timeWindowMs:t.highwayConfig.timeWindowMs??4e3,colorMode:i(),trailConfig:t.highwayConfig.trailConfig},K={startMs:t.highwayConfig.currentTimeMs-1e3,endMs:t.highwayConfig.currentTimeMs+t.viewport.containerWidth/(t.highwayConfig.pixelsPerSecond??200)*1e3},ge={viewportWidth:t.viewport.containerWidth,viewportHeight:t.viewport.containerHeight,beatIntervalMs:f(),visibleTimeRange:K,nowLineX:t.highwayConfig.nowLineX};Pn(p,ge,T),t.highwayConfig.targetNotes&&t.highwayConfig.targetNotes.length>0&&$e(p,T,t.highwayConfig.targetNotes,t.highwayConfig.currentTimeMs,q),t.highwayConfig.userPitch&&t.highwayConfig.userPitch.clarity>.5&&Qe(p,T,t.highwayConfig.userPitch.midi,t.highwayConfig.userPitch.clarity,t.highwayConfig.nowLineX,q,t.fullRowData)}function ce(p,T,q){const K={fullRowData:t.fullRowData,cellWidth:t.cellWidth,cellHeight:t.cellHeight,legendColumnWidth:F,colorMode:i(),showFrequencyLabels:r(),showOctaveLabels:d(),accidentalMode:o()},ge={startRow:T,endRow:q,coords:p};jn(n(P),n(M),K,ge)}function y(p){const T=[];let q=0;for(const K of p)q+=K,T.push(q);return T}function D(){if(n(_))return;function p(){W(),H(_,requestAnimationFrame(p),!0)}H(_,requestAnimationFrame(p),!0)}function N(){n(_)&&(cancelAnimationFrame(n(_)),H(_,null))}function j(){if(!n(v)||(H(m,n(v).getContext("2d"),!0),!n(m)))return;const p=window.devicePixelRatio||1;n(v).width=t.viewport.containerWidth*p,n(v).height=t.viewport.containerHeight*p,n(v).style.width=`${t.viewport.containerWidth}px`,n(v).style.height=`${t.viewport.containerHeight}px`,n(m).scale(p,p);const T=F*2;n(g)&&(H(P,n(g).getContext("2d"),!0),n(P)&&(n(g).width=T*p,n(g).height=t.viewport.containerHeight*p,n(g).style.width=`${T}px`,n(g).style.height=`${t.viewport.containerHeight}px`,n(P).scale(p,p))),n(w)&&(H(M,n(w).getContext("2d"),!0),n(M)&&(n(w).width=T*p,n(w).height=t.viewport.containerHeight*p,n(w).style.width=`${T}px`,n(w).style.height=`${t.viewport.containerHeight}px`,n(M).scale(p,p))),W(),(n(L)||n(B))&&D()}lt(()=>{j()}),_t(()=>{N()}),pe(()=>{t.mode,t.viewport,t.cellWidth,t.cellHeight,i(),a(),c(),s(),l(),n(m)&&n(I)&&W()}),pe(()=>{t.mode,n(L)||n(B)?D():(N(),n(m)&&W())}),pe(()=>{t.viewport.containerWidth,t.viewport.containerHeight,n(m)&&n(v)&&j()});var ne=Vn(),ae=C(ne);{var fe=p=>{var T=Gn();se(T,q=>H(g,q),()=>n(g)),A(p,T)};ee(ae,p=>{(d()||r())&&p(fe)})}var de=S(ae,2);se(de,p=>H(v,p),()=>n(v));var We=S(de,2);{var ke=p=>{var T=Un();se(T,q=>H(w,q),()=>n(w)),A(p,T)};ee(We,p=>{(d()||r())&&p(ke)})}A(e,ne),$()}var Kn=x('<div class="pitch-wheel-option svelte-53gwvz"> </div>'),Jn=x('<div class="pitch-wheel svelte-53gwvz" role="slider" tabindex="0" aria-valuemin="0"><div class="pitch-wheel-viewport svelte-53gwvz"><div class="pitch-wheel-options svelte-53gwvz"></div></div> <div class="pitch-wheel-overlay svelte-53gwvz"></div></div>');function tt(e,t){Q(t,!0);let i=Y(t,"selectedIndex",15),a=Y(t,"ariaLabel",3,"Pitch selector");const o=40,r=o;let d=O(void 0),c=O(void 0),s=O(void 0),l=O(!1),h=O(null),b=O(0),u=O(0),f=O(o);const v=k(()=>t.options.map((y,D)=>Math.min(Math.abs(D-i()),3))),g=k(()=>n(c)?.clientHeight??0),w=k(()=>Math.max(0,(n(g)-n(f))/2)),m=k(()=>i()*n(f)+n(f)/2),P=k(()=>n(g)>0?n(g)/2-n(m):0);function M(y){if(!t.options||t.options.length===0)return;let D=y;typeof t.onbeforechange=="function"&&(D=t.onbeforechange(y));const N=Math.max(0,Math.min(t.options.length-1,D));if(N!==i()&&(i(N),typeof t.onchange=="function")){const j=t.options[N];j&&t.onchange(N,j)}}function _(y){y!==0&&M(i()+y)}function F(y){y.preventDefault(),y.stopPropagation();const D=Math.sign(y.deltaY);D!==0&&_(D)}function I(y){y.key==="ArrowUp"?(y.preventDefault(),_(-1)):y.key==="ArrowDown"?(y.preventDefault(),_(1)):y.key==="Home"?(y.preventDefault(),M(0)):y.key==="End"&&(y.preventDefault(),M(t.options.length-1))}function L(y){if(H(l,!0),H(h,y.pointerId,!0),H(b,y.clientY,!0),H(u,0),n(d)&&typeof n(d).setPointerCapture=="function")try{n(d).setPointerCapture(y.pointerId)}catch{}}function B(y){if(!n(l)||y.pointerId!==n(h))return;const D=y.clientY-n(b);if(H(b,y.clientY,!0),D===0)return;H(u,n(u)+D);const N=n(f)||r;for(;Math.abs(n(u))>=N;){const j=-Math.sign(n(u));_(j),H(u,n(u)-Math.sign(n(u))*N)}}function z(y){n(l)&&y.pointerId===n(h)&&(H(l,!1),H(h,null),H(u,0),n(d)?.hasPointerCapture?.(y.pointerId)&&n(d).releasePointerCapture(y.pointerId))}pe(()=>{if(!n(s)||!n(c))return;const y=()=>{const N=n(s)?.querySelector(".pitch-wheel-option");N&&H(f,N.offsetHeight||o,!0)};y();const D=new ResizeObserver(()=>{y()});return D.observe(n(c)),()=>{D.disconnect()}});var W=Jn();W.__keydown=I,W.__pointerdown=L,W.__pointermove=B,W.__pointerup=z;let Z;var te=C(W),oe=C(te);let ce;Le(oe,23,()=>t.options,y=>y.index,(y,D,N)=>{var j=Kn(),ne=C(j);U(()=>{ve(j,"data-distance",n(v)[n(N)]),X(ne,n(D).label)}),A(y,j)}),se(oe,y=>H(s,y),()=>n(s)),se(te,y=>H(c,y),()=>n(c)),se(W,y=>H(d,y),()=>n(d)),U(()=>{ve(W,"aria-label",a()),ve(W,"aria-valuemax",t.options.length-1),ve(W,"aria-valuenow",i()),ve(W,"aria-valuetext",t.options[i()]?.label??""),Z=Ge(W,"",Z,{height:t.wheelHeight?`${t.wheelHeight}px`:"100%"}),ce=Ge(oe,"",ce,{"padding-top":`${n(w)??""}px`,"padding-bottom":`${n(w)??""}px`,transform:`translateY(${n(P)??""}px)`})}),Oe("wheel",W,F),Oe("pointercancel",W,z),Oe("pointerleave",W,z),A(e,W),$()}le(["keydown","pointerdown","pointermove","pointerup"]);const pt=7;function Re(e,t,i){return Number.isFinite(e)?Math.max(t,Math.min(i,Math.round(e))):t}function Qn(e,t,i,a=pt){const o=Math.max(0,i-1),r=Re(e,0,o),d=Math.max(1,Math.round(a)),c=Math.max(0,r-(d-1));return Re(t,0,c)}function $n(e,t,i,a=pt){const o=Math.max(0,i-1),r=Re(e,0,o),d=Math.max(1,Math.round(a)),c=Math.min(o,r+(d-1));return Re(t,c,o)}function ei(e){return e.map((t,i)=>({index:i,label:t.pitch,midi:t.midi,toneNote:t.toneNote,frequency:t.frequency}))}var ti=x('<div class="summary-card svelte-yqjxxp"><div class="summary-label svelte-yqjxxp"> </div> <div class="summary-metadata svelte-yqjxxp"> </div></div>'),ni=x('<div class="dual-pitch-wheel svelte-yqjxxp"><div class="wheels-container svelte-yqjxxp"><div class="wheel-column svelte-yqjxxp"><div class="wheel-label svelte-yqjxxp">High</div> <!></div> <div class="wheel-column svelte-yqjxxp"><div class="wheel-label svelte-yqjxxp">Low</div> <!></div></div> <!></div>');function ii(e,t){Q(t,!0);let i=Y(t,"topIndex",15),a=Y(t,"bottomIndex",15),o=Y(t,"minSpan",3,7),r=Y(t,"showSummary",3,!0);const d=k(()=>ei(t.fullRowData)),c=k(()=>({topIndex:i(),bottomIndex:a(),topPitch:t.fullRowData[i()],bottomPitch:t.fullRowData[a()],span:a()-i()+1})),s=k(()=>n(c).topPitch&&n(c).bottomPitch?`${n(c).topPitch.pitch} – ${n(c).bottomPitch.pitch}`:""),l=k(()=>`${n(c).span} ${n(c).span===1?"pitch":"pitches"}`);function h(I){return Qn(a(),I,n(d).length,o())}function b(I){return $n(i(),I,n(d).length,o())}function u(I,L){i(I),typeof t.onrangechange=="function"&&t.onrangechange(n(c))}function f(I,L){a(I),typeof t.onrangechange=="function"&&t.onrangechange(n(c))}var v=ni(),g=C(v),w=C(g),m=S(C(w),2);tt(m,{get options(){return n(d)},get selectedIndex(){return i()},onchange:u,onbeforechange:h,get wheelHeight(){return t.wheelHeight},ariaLabel:"High pitch selector"});var P=S(w,2),M=S(C(P),2);tt(M,{get options(){return n(d)},get selectedIndex(){return a()},onchange:f,onbeforechange:b,get wheelHeight(){return t.wheelHeight},ariaLabel:"Low pitch selector"});var _=S(g,2);{var F=I=>{var L=ti(),B=C(L),z=C(B),W=S(B,2),Z=C(W);U(()=>{X(z,n(s)),X(Z,n(l))}),A(I,L)};ee(_,I=>{r()&&I(F)})}A(e,v),$()}le(["change"]);const nt={isDetecting:!1,visualizationMode:"stationary",tonic:"C",useDegrees:!1,showAccidentals:!0,yAxisRange:{minMidi:48,maxMidi:72},drone:{isPlaying:!1,octave:3,volume:-12}};function oi(){let e=O(Se({...nt}));return{get state(){return n(e)},toggleDetecting(){n(e).isDetecting=!n(e).isDetecting},setDetecting(t){n(e).isDetecting=t},setVisualizationMode(t){n(e).visualizationMode=t},setTonic(t){n(e).tonic=t},setUseDegrees(t){n(e).useDegrees=t},setShowAccidentals(t){n(e).showAccidentals=t},setYAxisRange(t){n(e).yAxisRange=t},expandYAxisUpper(){n(e).yAxisRange.maxMidi<108&&(n(e).yAxisRange={...n(e).yAxisRange,maxMidi:n(e).yAxisRange.maxMidi+1})},contractYAxisUpper(){n(e).yAxisRange.maxMidi>n(e).yAxisRange.minMidi+6&&(n(e).yAxisRange={...n(e).yAxisRange,maxMidi:n(e).yAxisRange.maxMidi-1})},expandYAxisLower(){n(e).yAxisRange.minMidi>21&&(n(e).yAxisRange={...n(e).yAxisRange,minMidi:n(e).yAxisRange.minMidi-1})},contractYAxisLower(){n(e).yAxisRange.minMidi<n(e).yAxisRange.maxMidi-6&&(n(e).yAxisRange={...n(e).yAxisRange,minMidi:n(e).yAxisRange.minMidi+1})},toggleDrone(){n(e).drone={...n(e).drone,isPlaying:!n(e).drone.isPlaying}},setDroneOctave(t){n(e).drone={...n(e).drone,octave:t}},setDroneVolume(t){n(e).drone={...n(e).drone,volume:t}},reset(){H(e,{...nt},!0)}}}const R=oi(),ai=500,it={currentPitch:null,history:[],stablePitch:{pitchClass:null,opacity:0,size:1}};function si(){let e=O(Se({...it}));return{get state(){return n(e)},setCurrentPitch(t){n(e).currentPitch=t},addHistoryPoint(t){const i=[...n(e).history,t];i.length>ai&&i.shift(),n(e).history=i},setStablePitch(t){n(e).stablePitch=t},clearHistory(){n(e).history=[]},reset(){H(e,{...it},!0)}}}const E=si(),ot={isPlaying:!1,startTime:null,currentTimeMs:0,targetNotes:[],nowLineX:100,pixelsPerSecond:200,timeWindowMs:4e3};function ri(){let e=O(Se({...ot})),t=null;function i(){n(e).isPlaying&&n(e).startTime!==null&&(n(e).currentTimeMs=performance.now()-n(e).startTime,t=requestAnimationFrame(i))}return{get state(){return n(e)},start(){n(e).isPlaying=!0,n(e).startTime=performance.now(),n(e).currentTimeMs=0,t=requestAnimationFrame(i)},stop(){n(e).isPlaying=!1,t!==null&&(cancelAnimationFrame(t),t=null)},pause(){n(e).isPlaying=!1,t!==null&&(cancelAnimationFrame(t),t=null)},resume(){if(n(e).startTime!==null){const a=performance.now()-(n(e).startTime+n(e).currentTimeMs);n(e).startTime+=a,n(e).isPlaying=!0,t=requestAnimationFrame(i)}},setTargetNotes(a){n(e).targetNotes=a},markNoteHit(a){a>=0&&a<n(e).targetNotes.length&&(n(e).targetNotes=n(e).targetNotes.map((o,r)=>r===a?{...o,hit:!0}:o))},setNowLineX(a){n(e).nowLineX=a},setPixelsPerSecond(a){n(e).pixelsPerSecond=a},setTimeWindowMs(a){n(e).timeWindowMs=a},reset(){t!==null&&(cancelAnimationFrame(t),t=null),H(e,{...ot},!0)}}}const we=ri();var li=x('<div class="singing-canvas-container svelte-15ar5r5"><!></div>');function ci(e,t){Q(t,!0);let i=O(void 0),a=O(800),o=O(400);const r=k(()=>Dt(R.state.yAxisRange.minMidi,R.state.yAxisRange.maxMidi)),d=k(()=>At({containerHeight:n(o),fullRowData:n(r),preferredCellHeight:40,minCellHeight:20})),c=k(()=>R.state.visualizationMode==="highway"?"highway":"singing");function s(){return E.state.history.map(w=>({frequency:w.frequency,midi:w.midi,time:w.time,clarity:w.clarity}))}function l(){return we.state.targetNotes.map((w,m)=>({id:`target-${m}`,midi:w.midi,startTimeMs:w.startTimeMs,durationMs:w.durationMs}))}const h=k(()=>({timeWindowMs:4e3,pixelsPerSecond:200,circleRadius:9.5,proximityThreshold:35,maxConnections:3,connectorLineWidth:2.5,connectorColor:"rgba(0,0,0,0.4)",useTonicRelativeColors:!0,tonicPitchClass:fn(R.state.tonic),clarityThreshold:.5,maxOpacity:.9})),b=k(()=>n(c)==="singing"?{userPitch:E.state.currentPitch?{frequency:E.state.currentPitch.frequency,midi:E.state.currentPitch.midi,clarity:E.state.currentPitch.clarity,pitchClass:E.state.currentPitch.pitchClass}:null,pitchHistory:s(),targetNotes:[],pixelsPerSecond:200,timeWindowMs:4e3,trailConfig:n(h)}:void 0),u=k(()=>n(c)==="highway"?{userPitch:E.state.currentPitch?{frequency:E.state.currentPitch.frequency,midi:E.state.currentPitch.midi,clarity:E.state.currentPitch.clarity,pitchClass:E.state.currentPitch.pitchClass}:null,pitchHistory:s(),targetNotes:l(),nowLineX:we.state.nowLineX,pixelsPerSecond:we.state.pixelsPerSecond,currentTimeMs:we.state.currentTimeMs,timeWindowMs:we.state.timeWindowMs,trailConfig:n(h)}:void 0),f=k(()=>({startRow:n(d).startRow,endRow:n(d).endRow,zoomLevel:1,containerWidth:n(a),containerHeight:n(o)}));pe(()=>{if(!n(i))return;const w=new ResizeObserver(m=>{for(const P of m)H(a,P.contentRect.width,!0),H(o,P.contentRect.height,!0)});return w.observe(n(i)),()=>{w.disconnect()}});var v=li(),g=C(v);Zn(g,{get mode(){return n(c)},get fullRowData(){return n(r)},get viewport(){return n(f)},cellWidth:20,get cellHeight(){return n(d).cellHeight},colorMode:"color",showOctaveLabels:!0,showFrequencyLabels:!1,get singingConfig(){return n(b)},get highwayConfig(){return n(u)}}),se(v,w=>H(i,w),()=>n(i)),A(e,v),$()}const ie={FFT_SIZE:2048,CLARITY_THRESHOLD:.8,MIN_PITCH_HZ:60,MAX_PITCH_HZ:1600,STABILITY_THRESHOLD:15,HIGHLIGHT_FADE_SPEED:.2};let ue=null,he=null,Ae=null,re=null,De=!1,ye=-1,be=0,at=0,st=1;function di(e){return 12*Math.log2(e/440)+69}function Mt(){if(!De||!he||!Ae){re=null;return}const e=he.getValue(),[t,i]=Ae.findPitch(e,sn().sampleRate),a=t!==null&&i>ie.CLARITY_THRESHOLD&&t>ie.MIN_PITCH_HZ&&t<ie.MAX_PITCH_HZ;if(a){const s=di(t),l={frequency:t,midi:s,clarity:i,pitchClass:Math.round(s)%12};E.setCurrentPitch(l),E.addHistoryPoint({frequency:t,midi:s,time:performance.now(),clarity:i})}else E.addHistoryPoint({frequency:0,midi:0,time:performance.now(),clarity:0});const o=a&&E.state.currentPitch?Math.round(E.state.currentPitch.midi)%12:-1;o===ye&&o!==-1?be++:(be=0,ye=o),at=be>=ie.STABILITY_THRESHOLD?1:0,st=be>=ie.STABILITY_THRESHOLD?1.05:1;const r=E.state.stablePitch,d=r.opacity+(at-r.opacity)*ie.HIGHLIGHT_FADE_SPEED,c=r.size+(st-r.size)*ie.HIGHLIGHT_FADE_SPEED;E.setStablePitch({pitchClass:ye>=0?ye:null,opacity:d,size:c}),re=requestAnimationFrame(Mt)}async function ui(){if(!De){re!==null&&cancelAnimationFrame(re),ue=new on,he=new an("waveform",ie.FFT_SIZE),Ae=cn.forFloat32Array(he.size);try{await ht(),await ue.open(),ue.connect(he),De=!0,Mt()}catch(e){throw console.error("Microphone access denied or failed:",e),Ct(),e}}}function hi(){De=!1,Ct()}function Ct(){re!==null&&(cancelAnimationFrame(re),re=null),ue&&(ue.close(),ue=null),he=null,Ae=null,be=0,ye=-1,E.setStablePitch({pitchClass:null,opacity:0,size:1}),E.setCurrentPitch(null)}var fi=x('<span class="spinner svelte-cytsjj"></span> Starting...',1),gi=x('<span class="icon svelte-cytsjj">&#9632;</span> Stop',1),vi=x('<span class="icon svelte-cytsjj">&#9654;</span> Start',1),mi=x("<button><!></button>");function wi(e,t){Q(t,!0);let i=O(!1);async function a(){if(!n(i))if(R.state.isDetecting)hi(),R.setDetecting(!1),E.reset();else{H(i,!0);try{await ui(),R.setDetecting(!0)}catch(l){console.error("Failed to start detection:",l),alert("Could not access microphone. Please grant permission and try again.")}finally{H(i,!1)}}}var o=mi();let r;o.__click=a;var d=C(o);{var c=l=>{var h=fi();A(l,h)},s=l=>{var h=nn(),b=ut(h);{var u=v=>{var g=gi();A(v,g)},f=v=>{var g=vi();A(v,g)};ee(b,v=>{R.state.isDetecting?v(u):v(f,!1)},!0)}A(l,h)};ee(d,l=>{n(i)?l(c):l(s,!1)})}U(()=>{r=xe(o,1,"start-button svelte-cytsjj",null,r,{active:R.state.isDetecting,loading:n(i)}),o.disabled=n(i)}),A(e,o),$()}le(["click"]);let J=null,Ce=!1,Pe=null;function yi(){var e;if(!J){J=new rn(ln,{oscillator:{type:"sawtooth"},envelope:{attack:.3,decay:.1,sustain:.8,release:.5}}).toDestination();const t=((e=J.get().oscillator)==null?void 0:e.type)??"unknown";console.log("[DroneAudio] Initialized drone synth",{oscillatorType:t})}return J}function Pt(e,t){return`${e.replace("b","#").replace("Db","C#").replace("Eb","D#").replace("Gb","F#").replace("Ab","G#").replace("Bb","A#")}${t}`}async function bi(){await ht();const e=yi(),t=Pt(R.state.tonic,R.state.drone.octave);e.volume.value=R.state.drone.volume,console.log("[DroneAudio] Starting drone",{note:t,volume:e.volume.value}),Pe&&e.releaseAll(),Pe=t,e.triggerAttack(t),Ce=!0}function pi(){J&&Ce&&(J.releaseAll(),Pe=null,Ce=!1)}function Ee(){if(!Ce||!J)return;const e=Pt(R.state.tonic,R.state.drone.octave);J.volume.value=R.state.drone.volume,console.log("[DroneAudio] Updating drone",{note:e,volume:J.volume.value}),e!==Pe&&(J.releaseAll(),J.triggerAttack(e),Pe=e)}async function Mi(){Ce?pi():await bi()}var Ci=x("<option> </option>"),Pi=x('<div class="tonic-selector svelte-16h7our"><label for="tonic-select" class="svelte-16h7our">Key:</label> <select id="tonic-select" class="svelte-16h7our"></select></div>');function Si(e,t){Q(t,!0);const i=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function a(c){const s=c.target;R.setTonic(s.value),Ee()}var o=Pi(),r=S(C(o),2);r.__change=a,Le(r,21,()=>i,Be,(c,s)=>{var l=Ci(),h=C(l),b={};U(()=>{X(h,n(s)),b!==(b=n(s))&&(l.value=(l.__value=n(s))??"")}),A(c,l)});var d;ft(r),U(()=>{d!==(d=R.state.tonic)&&(r.value=(r.__value=R.state.tonic)??"",Ye(r,R.state.tonic))}),A(e,o),$()}le(["change"]);var _i=x("<option> </option>"),Ii=x('<div class="drone-controls svelte-1rkr6nv"><button> </button> <div class="drone-settings svelte-1rkr6nv"><label class="svelte-1rkr6nv">Oct: <select class="svelte-1rkr6nv"></select></label> <label class="svelte-1rkr6nv">Vol: <input type="range" min="-40" max="0" class="svelte-1rkr6nv"/></label></div></div>');function Ti(e,t){Q(t,!0);const i=[2,3,4,5];async function a(){await Mi(),R.toggleDrone()}function o(w){const m=w.target;R.setDroneOctave(parseInt(m.value,10)),Ee()}function r(w){const m=w.target;R.setDroneVolume(parseInt(m.value,10)),Ee()}var d=Ii(),c=C(d);let s;c.__click=a;var l=C(c),h=S(c,2),b=C(h),u=S(C(b));u.__change=o,Le(u,21,()=>i,Be,(w,m)=>{var P=_i(),M=C(P),_={};U(()=>{X(M,n(m)),_!==(_=n(m))&&(P.value=(P.__value=n(m))??"")}),A(w,P)});var f;ft(u);var v=S(b,2),g=S(C(v));g.__input=r,U(()=>{s=xe(c,1,"drone-toggle svelte-1rkr6nv",null,s,{active:R.state.drone.isPlaying}),X(l,R.state.drone.isPlaying?"Drone On":"Drone Off"),f!==(f=R.state.drone.octave)&&(u.value=(u.__value=R.state.drone.octave)??"",Ye(u,R.state.drone.octave)),tn(g,R.state.drone.volume)}),A(e,d),$()}le(["click","change","input"]);var Hi=x("<button> </button>"),Ri=x('<div class="mode-toggle svelte-i9tkj4"></div>');function Ai(e,t){Q(t,!0);const i=[{value:"stationary",label:"Stationary"},{value:"highway",label:"Highway"}];function a(r){R.setVisualizationMode(r)}var o=Ri();Le(o,21,()=>i,Be,(r,d)=>{let c=()=>n(d).value,s=()=>n(d).label;var l=Hi();let h;l.__click=()=>a(c());var b=C(l);U(()=>{h=xe(l,1,"mode-button svelte-i9tkj4",null,h,{active:R.state.visualizationMode===c()}),X(b,s())}),A(r,l)}),A(e,o),$()}le(["click"]);var Di=x('<div class="range-control svelte-1es7ond"><h3 class="control-title svelte-1es7ond">Pitch Range</h3> <!></div>');function xi(e,t){Q(t,!0);function i(s){const l=je.findIndex(h=>h.midi===s);return l>=0?l:0}const a=k(()=>i(R.state.yAxisRange.maxMidi)),o=k(()=>i(R.state.yAxisRange.minMidi));function r(s){const l=s.bottomPitch.midi??21,h=s.topPitch.midi??108;R.setYAxisRange({minMidi:l,maxMidi:h})}var d=Di(),c=S(C(d),2);ii(c,{get fullRowData(){return je},get topIndex(){return n(a)},get bottomIndex(){return n(o)},minSpan:7,onrangechange:r,showSummary:!0,wheelHeight:200}),A(e,d),$()}var Li=x('<div class="note-display svelte-1hjl33a"><span class="note-name svelte-1hjl33a"> </span> <span class="octave svelte-1hjl33a"> </span></div> <div class="details svelte-1hjl33a"><span class="frequency"> </span> <span> </span> <span class="clarity"> </span></div>',1),Wi=x('<div class="no-pitch svelte-1hjl33a"><span class="placeholder svelte-1hjl33a">---</span> <span class="hint svelte-1hjl33a">Sing or hum into the microphone</span></div>'),ki=x('<div class="pitch-readout svelte-1hjl33a"><!></div>');function Ni(e,t){Q(t,!0);const i=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],a=k(()=>()=>{const s=E.state.currentPitch;if(!s)return null;const l=i[s.pitchClass],h=Math.floor(s.midi/12)-1,b=Math.round((s.midi-Math.round(s.midi))*100);return{name:l,octave:h,frequency:s.frequency.toFixed(1),cents:b,clarity:Math.round(s.clarity*100)}});var o=ki(),r=C(o);{var d=s=>{const l=k(()=>n(a)());var h=Li(),b=ut(h),u=C(b),f=C(u),v=S(u,2),g=C(v),w=S(b,2),m=C(w),P=C(m),M=S(m,2);let _;var F=C(M),I=S(M,2),L=C(I);U(()=>{X(f,n(l).name),X(g,n(l).octave),X(P,`${n(l).frequency??""} Hz`),_=xe(M,1,"cents svelte-1hjl33a",null,_,{sharp:n(l).cents>0,flat:n(l).cents<0}),X(F,`${n(l).cents>0?"+":""}${n(l).cents??""}¢`),X(L,`${n(l).clarity??""}%`)}),A(s,h)},c=s=>{var l=Wi();A(s,l)};ee(r,s=>{n(a)()?s(d):s(c,!1)})}A(e,o),$()}const Fe={hasImportedSnapshot:!1,snapshot:null,isLoading:!1,error:null,transpositionSemitones:0};function Oi(){let e=O(Se({...Fe}));return{get state(){return n(e)},async checkAndConsumeHandoff(){if(!Ht())return!1;n(e).isLoading=!0,n(e).error=null;try{const t=await Rt();return t?t.schemaVersion!==ze?(n(e).error=`Incompatible snapshot version: ${t.schemaVersion}. Expected: ${ze}`,n(e).isLoading=!1,_e(),!1):(n(e).snapshot=t,n(e).hasImportedSnapshot=!0,n(e).isLoading=!1,_e(),console.log("[HandoffState] Successfully imported snapshot",{voices:t.voices.length,microbeatCount:t.timeGrid.microbeatCount,tempo:t.tempo}),!0):(n(e).error="Handoff data expired or not found. Please try exporting again.",n(e).isLoading=!1,_e(),!1)}catch(t){return console.error("[HandoffState] Failed to process handoff",t),n(e).error="Failed to import data from Student Notation.",n(e).isLoading=!1,_e(),!1}},get voices(){var t;return((t=n(e).snapshot)==null?void 0:t.voices)??[]},get timeGrid(){var t;return((t=n(e).snapshot)==null?void 0:t.timeGrid)??null},get tempo(){var t;return((t=n(e).snapshot)==null?void 0:t.tempo)??90},get suggestedPitchRange(){if(!n(e).snapshot)return null;const t=3,i=n(e).snapshot.minMidiPitch,a=n(e).snapshot.maxMidiPitch;return i===void 0||a===void 0?null:{minMidi:Math.max(21,i-t+n(e).transpositionSemitones),maxMidi:Math.min(108,a+t+n(e).transpositionSemitones)}},setTransposition(t){n(e).transpositionSemitones=t},transposeUp(){n(e).transpositionSemitones+=1},transposeDown(){n(e).transpositionSemitones-=1},getTransposedMidi(t){return t+n(e).transpositionSemitones},async bringBackToStudentNotation(){if(!n(e).snapshot){console.warn("[HandoffState] No snapshot to bring back");return}const t={...n(e).snapshot,sourceApp:"singing-trainer",createdAt:Date.now(),voices:n(e).snapshot.voices.map(i=>({...i,notes:i.notes.map(a=>({...a,midiPitch:a.midiPitch+n(e).transpositionSemitones}))}))};try{const i=await It(t);console.log("[HandoffState] Handoff slot written for return",i),Tt(i)}catch(i){console.error("[HandoffState] Failed to write return handoff",i)}},clearSnapshot(){H(e,{...Fe},!0)},reset(){H(e,{...Fe},!0)}}}const V=Oi();var Fi=x('<div class="handoff-controls svelte-1n46o8q"><div class="transposition-control svelte-1n46o8q"><button class="transpose-btn svelte-1n46o8q" title="Transpose down">-</button> <span class="transposition-label svelte-1n46o8q"> </span> <button class="transpose-btn svelte-1n46o8q" title="Transpose up">+</button></div> <button class="bring-back-btn svelte-1n46o8q">Bring Back to Student Notation</button></div>'),qi=x('<div class="error-banner svelte-1n46o8q"> </div>'),Ei=x('<div class="import-info svelte-1n46o8q"><span class="import-label svelte-1n46o8q">Microbeats:</span> <span class="import-value svelte-1n46o8q"> </span></div>'),Bi=x('<div class="control-group svelte-1n46o8q"><h3 class="control-group-title svelte-1n46o8q">Imported Material</h3> <div class="import-info svelte-1n46o8q"><span class="import-label svelte-1n46o8q">Voices:</span> <span class="import-value svelte-1n46o8q"> </span></div> <div class="import-info svelte-1n46o8q"><span class="import-label svelte-1n46o8q">Tempo:</span> <span class="import-value svelte-1n46o8q"> </span></div> <!></div>'),Yi=x('<div class="app svelte-1n46o8q"><header class="header svelte-1n46o8q"><h1 class="title svelte-1n46o8q">Singing Trainer</h1> <div class="header-controls svelte-1n46o8q"><!> <!></div></header> <!> <main class="main svelte-1n46o8q"><aside class="sidebar sidebar--left svelte-1n46o8q"><div class="control-group svelte-1n46o8q"><!></div> <div class="control-group svelte-1n46o8q"><!></div> <div class="control-group svelte-1n46o8q"><h3 class="control-group-title svelte-1n46o8q">Settings</h3> <!> <!></div> <div class="control-group svelte-1n46o8q"><!></div> <!></aside> <section class="canvas-area svelte-1n46o8q"><!></section></main></div>');function Xi(e,t){Q(t,!0),lt(async()=>{if(await V.checkAndConsumeHandoff()){console.log("[App] Handoff detected and processed");const y=V.suggestedPitchRange;y&&R.setYAxisRange(y)}});const i=k(()=>V.state.hasImportedSnapshot),a=k(()=>V.state.transpositionSemitones),o=k(()=>V.state.error);function r(){V.bringBackToStudentNotation()}function d(){V.transposeUp()}function c(){V.transposeDown()}var s=Yi(),l=C(s),h=S(C(l),2),b=C(h);{var u=y=>{var D=Fi(),N=C(D),j=C(N);j.__click=c;var ne=S(j,2),ae=C(ne),fe=S(ne,2);fe.__click=d;var de=S(N,2);de.__click=r,U(()=>X(ae,`${n(a)>=0?"+":""}${n(a)??""}`)),A(y,D)};ee(b,y=>{n(i)&&y(u)})}var f=S(b,2);Ai(f,{});var v=S(l,2);{var g=y=>{var D=qi(),N=C(D);U(()=>X(N,n(o))),A(y,D)};ee(v,y=>{n(o)&&y(g)})}var w=S(v,2),m=C(w),P=C(m),M=C(P);wi(M,{});var _=S(P,2),F=C(_);Ni(F,{});var I=S(_,2),L=S(C(I),2);Si(L,{});var B=S(L,2);Ti(B,{});var z=S(I,2),W=C(z);xi(W,{});var Z=S(z,2);{var te=y=>{var D=Bi(),N=S(C(D),2),j=S(C(N),2),ne=C(j),ae=S(N,2),fe=S(C(ae),2),de=C(fe),We=S(ae,2);{var ke=p=>{var T=Ei(),q=S(C(T),2),K=C(q);U(()=>X(K,V.timeGrid.microbeatCount)),A(p,T)};ee(We,p=>{V.timeGrid&&p(ke)})}U(()=>{X(ne,V.voices.length),X(de,`${V.tempo??""} BPM`)}),A(y,D)};ee(Z,y=>{n(i)&&y(te)})}var oe=S(m,2),ce=C(oe);ci(ce,{}),A(e,s),$()}le(["click"]);function zi(e){const t=$t(Xi,{target:e});return{destroy:()=>en(t)}}const ji=zi,rt=document.getElementById("app");rt&&ji(rt);
