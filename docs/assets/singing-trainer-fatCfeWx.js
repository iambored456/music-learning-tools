import"./modulepreload-polyfill-B5Qt9EMX.js";import{C as bn,D as ti,F as ni,G as ii,H as wn,I as qe,J as ai,K as _n,L as si,M as oi,N as Mn,p as _e,u as De,g as t,o as X,v as I,f as N,c as u,s as y,k as A,a as R,r as Me,q as Fe,n as Se,e as Ye,i as Qe,t as K,b as B,O as ri,h as Ge,d as Je,A as it,y as Ie,$ as Pn,P as li,x as We,m as ci,B as di}from"./legacy-BhVoqlM1.js";import{t as ye,o as Cn,j as $e,i as G,q as Be,u as ui,v as fi,k as Ot,h as Ve,f as Pt,x as hi,w as vi,y as gi,A as mi,C as pi,E as ct,S as Vt}from"./navigation-Bl6AO8PX.js";import{s as bt,V as yi,S as Sn,l as zt,U as Tn,A as xn,g as kn,P as bi}from"./vendor-tone-Cer4uW5H.js";import{P as Rn}from"./vendor-pitchy-DoA2xU7W.js";function wt(e,n,i=!1){if(e.multiple){if(n==null)return;if(!ti(n))return ni();for(var a of e.options)a.selected=n.includes(at(a));return}for(a of e.options){var o=at(a);if(ii(o,n)){a.selected=!0;return}}(!i||n!==void 0)&&(e.selectedIndex=-1)}function Ft(e){var n=new MutationObserver(()=>{wt(e,e.__value)});n.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),bn(()=>{n.disconnect()})}function wi(e,n,i=n){var a=new WeakSet,o=!0;wn(e,"change",s=>{var r=s?"[selected]":":checked",c;if(e.multiple)c=[].map.call(e.querySelectorAll(r),at);else{var l=e.querySelector(r)??e.querySelector("option:not([disabled])");c=l&&at(l)}i(c),qe!==null&&a.add(qe)}),ai(()=>{var s=n();if(e===document.activeElement){var r=_n??qe;if(a.has(r))return}if(wt(e,s,o),o&&s===void 0){var c=e.querySelector(":checked");c!==null&&(s=at(c),i(s))}e.__value=s,o=!1}),Ft(e)}function at(e){return"__value"in e?e.__value:e.value}function Ct(e,n,i=n){var a=new WeakSet;wn(e,"input",async o=>{var s=o?e.defaultValue:e.value;if(s=St(e)?Tt(s):s,i(s),qe!==null&&a.add(qe),await si(),s!==(s=n())){var r=e.selectionStart,c=e.selectionEnd,l=e.value.length;if(e.value=s??"",c!==null){var d=e.value.length;r===c&&c===l&&d>l?(e.selectionStart=d,e.selectionEnd=d):(e.selectionStart=r,e.selectionEnd=Math.min(c,d))}}}),oi(n)==null&&e.value&&(i(St(e)?Tt(e.value):e.value),qe!==null&&a.add(qe)),Mn(()=>{var o=n();if(e===document.activeElement){var s=_n??qe;if(a.has(s))return}St(e)&&o===Tt(e.value)||e.type==="date"&&!o&&!e.value||o!==e.value&&(e.value=o??"")})}function St(e){var n=e.type;return n==="number"||n==="range"}function Tt(e){return e===""?null:+e}function In(e,n,i,a,o){var s=()=>{a(i[e])};i.addEventListener(n,s),o?Mn(()=>{i[e]=o()}):s(),(i===document.body||i===window||i===document)&&bn(()=>{i.removeEventListener(n,s)})}const Nt=["#ef8aab","#f48e7d","#e89955","#cdaa42","#a4ba57","#6ec482","#2dc8b1","#16c3da","#58b8f6","#8fa9ff","#ba9bf2","#db8fd4"],Xt=Nt[0];function Kt(e){const n=parseInt(e.slice(1),16);return[n>>16&255,n>>8&255,n&255]}function _i(e,n,i){const a=Math.max(0,Math.min(1,i));return e.map((o,s)=>{const r=n[s]??o;return Math.round(o+a*(r-o))})}function An(e,n=0){const i=Math.floor(e),a=e-i,o=(i%12-n+12)%12,s=(o+1)%12,r=Kt(Nt[o]??Xt),c=Kt(Nt[s]??Xt);return _i(r,c,a)}const Mi={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11};function Pi(e){const n=e.replace(/\d+$/,"");return Mi[n]??0}const xt={onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70,accuracyTiers:{perfect:{onsetMs:30,pitchCents:10,coverage:95},good:{onsetMs:75,pitchCents:25,coverage:85},okay:{onsetMs:150,pitchCents:50,coverage:70}}};function Ci(e={}){const n={...xt,...e,accuracyTiers:e.accuracyTiers?{...xt.accuracyTiers,...e.accuracyTiers}:xt.accuracyTiers},i=new Map,a=new Map;function o(f,h){return(f-h)*100}function s(f,h){return Math.abs(o(f.midi,h))<=n.pitchToleranceCents}function r(f,h){return f.length===0?0:f.reduce((m,g)=>m+Math.abs(o(g.midi,h)),0)/f.length}function c(f,h,b,m){if(f.length===0)return 0;const g=f.filter(p=>s(p,h));if(g.length===0)return 0;let w=0;for(let p=0;p<g.length;p++){const _=g[p];if(!_)continue;const C=g[p+1];if(C)w+=C.timeMs-_.timeMs;else{const x=b+m,T=Math.min(50,x-_.timeMs);w+=T}}return w/m*100}function l(f,h,b){const m=n.accuracyTiers;if(!m)return"okay";const g=Math.abs(f);return g<=m.perfect.onsetMs&&h<=m.perfect.pitchCents&&b>=m.perfect.coverage?"perfect":g<=m.good.onsetMs&&h<=m.good.pitchCents&&b>=m.good.coverage?"good":g<=m.okay.onsetMs&&h<=m.okay.pitchCents&&b>=m.okay.coverage?"okay":"miss"}function d(f){const{note:h,samples:b,onsetSample:m,releaseSample:g}=f;let w=0;m?w=m.timeMs-h.startTimeMs:w=n.onsetToleranceMs*2;let p=0;const _=h.startTimeMs+h.durationMs;g?p=g.timeMs-_:p=n.releaseToleranceMs*2;const C=r(b,h.midi),x=c(b,h.midi,h.startTimeMs,h.durationMs),T=Math.abs(w)<=n.onsetToleranceMs,M=Math.abs(p)<=n.releaseToleranceMs,k=x>=n.hitThreshold,D=T&&M&&k?"hit":"miss",H=l(w,C,x);return{hitStatus:D,onsetAccuracyMs:w,releaseAccuracyMs:p,pitchAccuracyCents:C,pitchCoverage:x,pitchSamples:[...b],accuracyTier:H}}return{startNote(f,h){i.set(f,{note:h,samples:[],onsetSample:null,releaseSample:null,startedAt:performance.now()})},recordPitchSample(f){for(const[h,b]of i){const{note:m}=b,g=m.startTimeMs+m.durationMs,w=n.onsetToleranceMs,p=n.releaseToleranceMs;f.timeMs>=m.startTimeMs-w&&f.timeMs<=g+p&&(b.samples.push(f),!b.onsetSample&&f.timeMs>=m.startTimeMs-w&&f.timeMs<=m.startTimeMs+w&&s(f,m.midi)&&(b.onsetSample=f),f.timeMs>=g-p&&f.timeMs<=g+p&&(b.releaseSample=f))}},endNote(f){const h=i.get(f);if(!h)return null;const b=d(h);return a.set(f,b),i.delete(f),b},getCurrentPerformance(f){const h=i.get(f);if(!h)return null;const{note:b,samples:m,onsetSample:g}=h;let w=0;g&&(w=g.timeMs-b.startTimeMs);const p=r(m,b.midi),_=c(m,b.midi,b.startTimeMs,b.durationMs);return{onsetAccuracyMs:w,pitchAccuracyCents:p,pitchCoverage:_,pitchSamples:[...m]}},getAllPerformances(){return new Map(a)},reset(){i.clear(),a.clear()},dispose(){i.clear(),a.clear()}}}const Zt={judgmentLinePosition:.12,pixelsPerSecond:200,lookAheadMs:3e3,scrollMode:"constant-speed",leadInBeats:4,playMetronomeDuringOnramp:!0,playTargetNotes:!0,playMetronome:!1,inputSources:["microphone"],feedbackConfig:{onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70}};function Si(e){const n={...Zt,...e,feedbackConfig:{...Zt.feedbackConfig,...e.feedbackConfig}},{stateCallbacks:i,eventCallbacks:a,visualCallbacks:o,logger:s}=n,r={isPlaying:!1,isPaused:!1,currentTimeMs:0,scrollOffset:0,onrampComplete:!1,targetNotes:[],activeNotes:new Set,startTime:null},c=Ci(n.feedbackConfig);let l=null;const d=new Set;function v(){const M=60/i.getTempo()*1e3;return n.leadInBeats*M}function f(){return i.getViewportWidth()*n.judgmentLinePosition}function h(T){const M=n.pixelsPerSecond/1e3,k=f(),D=v();return(T+D)*M-k}function b(T){const M=f(),k=i.getCellWidth(),D=T.startColumn*k-r.scrollOffset,H=T.endColumn*k-r.scrollOffset,W=n.feedbackConfig.onsetToleranceMs/1e3*n.pixelsPerSecond;return D<=M+W&&H>=M-W}function m(){const T=new Set;for(const M of r.targetNotes){const k=M.startTimeMs+M.durationMs,D=n.feedbackConfig.onsetToleranceMs;if(r.currentTimeMs>=M.startTimeMs-D&&r.currentTimeMs<=k+D)T.add(M.id),r.activeNotes.has(M.id)||(c.startNote(M.id,M),s?.debug("NoteHighway",`Note ${M.id} became active`,{note:M}));else if(r.activeNotes.has(M.id)){const H=c.endNote(M.id);if(H){M.performance=H;const F={noteId:M.id,note:M,performance:H};H.hitStatus==="hit"?(a.emit("noteHit",F),o?.onNoteHit?.(M.id,H.accuracyTier||"okay"),s?.info("NoteHighway",`Note hit: ${M.id}`,H)):(a.emit("noteMissed",F),o?.onNoteMiss?.(M.id),s?.info("NoteHighway",`Note missed: ${M.id}`,H))}}}r.activeNotes=T}function g(){for(const T of r.targetNotes){const M=b(T),k=d.has(T.id);M&&!k?(d.add(T.id),a.emit("noteEntered",{noteId:T.id,note:T})):!M&&k&&(d.delete(T.id),a.emit("noteExited",{noteId:T.id,note:T}))}}function w(){if(!r.onrampComplete)if(r.currentTimeMs>=0)r.onrampComplete=!0,a.emit("onrampComplete"),o?.clearOnrampCountdown?.(),s?.info("NoteHighway","Onramp complete",null);else{const M=60/i.getTempo()*1e3,k=Math.abs(r.currentTimeMs),D=Math.ceil(k/M);o?.updateOnrampCountdown?.(D)}}function p(){if(!r.isPlaying||r.isPaused||!r.startTime){l=null;return}const T=performance.now(),M=v();r.currentTimeMs=T-r.startTime-M,r.scrollOffset=h(r.currentTimeMs),w(),m(),g(),l=requestAnimationFrame(p)}function _(){l||(l=requestAnimationFrame(p))}function C(){l&&(cancelAnimationFrame(l),l=null)}return{init(T){r.targetNotes=T,s?.info("NoteHighway",`Initialized with ${T.length} notes`,null)},start(){r.isPlaying||(r.isPlaying=!0,r.isPaused=!1,r.currentTimeMs=-v(),r.scrollOffset=h(r.currentTimeMs),r.onrampComplete=!1,r.activeNotes.clear(),r.startTime=performance.now(),d.clear(),c.reset(),_(),a.emit("playbackStarted"),s?.info("NoteHighway","Playback started",{onrampDurationMs:v()}))},pause(){!r.isPlaying||r.isPaused||(r.isPaused=!0,C(),a.emit("playbackPaused"),s?.info("NoteHighway","Playback paused",{currentTimeMs:r.currentTimeMs}))},resume(){if(!r.isPlaying||!r.isPaused||!r.startTime)return;const T=performance.now()-(r.startTime+r.currentTimeMs+v());r.startTime+=T,r.isPaused=!1,_(),a.emit("playbackResumed"),s?.info("NoteHighway","Playback resumed",null)},stop(){if(!r.isPlaying)return;r.isPlaying=!1,r.isPaused=!1,r.currentTimeMs=0,r.scrollOffset=0,r.onrampComplete=!1,r.activeNotes.clear(),r.startTime=null,d.clear(),C(),o?.clearCanvas?.(),o?.clearOnrampCountdown?.(),a.emit("playbackStopped"),r.targetNotes.every(M=>M.performance!==void 0)&&a.emit("performanceComplete"),s?.info("NoteHighway","Playback stopped",null)},setScrollOffset(T){if(r.currentTimeMs=T,r.scrollOffset=h(T),r.isPlaying){const M=v();r.startTime=performance.now()-(T+M)}s?.debug("NoteHighway","Scroll offset set",{timeMs:T,scrollOffset:r.scrollOffset})},recordPitchInput(T,M,k){if(!r.isPlaying||r.isPaused||!n.inputSources.includes(k))return;const D={timeMs:r.currentTimeMs,midi:T,clarity:M,source:k};c.recordPitchSample(D)},getState(){return r},getVisibleNotes(){f();const T=i.getViewportWidth(),M=i.getCellWidth();return r.targetNotes.filter(k=>{const D=k.startColumn*M-r.scrollOffset;return k.endColumn*M-r.scrollOffset>=0&&D<=T})},getPerformanceResults(){return c.getAllPerformances()},getFeedbackCollector(){return c},dispose(){C(),c.dispose(),r.targetNotes=[],r.activeNotes.clear(),d.clear(),s?.info("NoteHighway","Service disposed",null)}}}function Ti(e){const{cellHeight:n,columnWidths:i,viewport:a}=e,o=n/2,s=xi(i,e.cellWidth);return{getRowY(r){return(r-a.startRow+1)*o},getRowFromY(r){const c=r/o-1;return Math.round(c)+a.startRow},getColumnX(r){return r<0?0:r>=s.length?s[s.length-1]??0:s[r]??0},getColumnFromX(r){let c=0,l=s.length-1;for(;c<l;){const d=Math.floor((c+l)/2);(s[d]??0)<=r?c=d+1:l=d}return Math.max(0,c-1)}}}function Nn(e){const{cellHeight:n,viewport:i,pixelsPerSecond:a,nowLineX:o=100,currentTimeMs:s=0}=e,r=n/2;return{getRowY(c){return(c-i.startRow+1)*r},getRowFromY(c){const l=c/r-1;return Math.round(l)+i.startRow},getColumnX(c){return 0},getColumnFromX(c){return 0},getTimeX(c){const l=c-s;return o+l/1e3*a},getTimeFromX(c){const l=(c-o)/a*1e3;return s+l}}}function xi(e,n){const i=[0];let a=0;for(let o=0;o<e.length;o++){const s=(e[o]??1)*n;a+=s,i.push(a)}return i}function ki(e,n){const{startRow:i,endRow:a}=e,o=Math.max(0,n.length-1);return{startRow:i,endRow:a,paddedStartRow:Math.max(0,i-1),paddedEndRow:Math.min(o,a+1)}}function kt(e,n,i,a){const o=a.getRowY(e),s=i;return o>=-s&&o<=n.containerHeight+s}function Ri(e){let n=(e||"").replace(/\d/g,"").trim();return n=n.replace(/b/g,"b-").replace(/#/g,"b_"),n}function Ii(e){switch(e){case"C":return{lineWidth:3.33,dash:[],color:"#adb5bd"};case"E":return{lineWidth:1,dash:[5,5],color:"#adb5bd"};case"G":return{lineWidth:1,dash:[],color:"#dee2e6"};case"B":case"A":case"F":case"Eb/Db":case"Db/C#":return{lineWidth:1,dash:[],color:"#ced4da"};default:return{lineWidth:1,dash:[],color:"#ced4da"}}}const dt={stroke:"#c7cfd8",background:"rgba(207, 214, 222, 0.32)"};let et=null;function Ai(){if(et)return et;if(typeof window>"u")return dt;try{const e=window.getComputedStyle(document.documentElement);et={stroke:e.getPropertyValue("--c-anacrusis-border").trim()||dt.stroke,background:e.getPropertyValue("--c-anacrusis-bg").trim()||dt.background}}catch{et=dt}return et}function Ni(e,n,i,a,o,s=0,r){const{fullRowData:c,viewportHeight:l,viewportWidth:d,cellHeight:v}=n,f=d,h=["B","A","F","Eâ™­/Dâ™¯","Dâ™­/Câ™¯"];for(let b=a;b<=o;b++){const m=c[b];if(!m||m.isBoundary)continue;const g=i.getRowY(b);if(g<-10||g>l+10)continue;const w=Ri(m.pitch);if(h.includes(w))continue;const p=Ii(w);w==="G"?(e.save(),e.fillStyle=p.color,e.fillRect(s,g-v/2,f-s,v),e.restore()):(e.beginPath(),e.moveTo(s,g),e.lineTo(f,g),e.lineWidth=p.lineWidth,e.strokeStyle=p.color,e.setLineDash(p.dash),e.stroke(),e.setLineDash([]))}}function Di(e,n,i,a){const{columnWidths:o,viewportHeight:s,macrobeatBoundaryStyles:r,placedTonicSigns:c}=n,l=o.length;for(let d=0;d<=l;d++){const v=d===0||d===l,f=Li(d,c),h=c.some(p=>d===p.columnIndex+2),b=a.includes(d);if(!Ei(d,c))continue;let g=null;if(v||f||h)g={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(b){const p=a.indexOf(d),_=r[p]??"dashed";if(_==="anacrusis"){const{stroke:C}=Ai();g={lineWidth:1,strokeStyle:C,dash:[4,4]}}else g={lineWidth:1,strokeStyle:"#adb5bd",dash:_==="solid"?[]:[5,5]}}if(!g)continue;const w=i.getColumnX(d);e.beginPath(),e.moveTo(w,0),e.lineTo(w,s),e.lineWidth=g.lineWidth,e.strokeStyle=g.strokeStyle,e.setLineDash(g.dash),e.stroke()}e.setLineDash([])}function Hi(e,n,i){const{viewportHeight:a,beatIntervalMs:o,measureIntervalMs:s,visibleTimeRange:r,nowLineX:c,beatTimeOffsetMs:l=0}=n,d=r.startMs-l,v=r.endMs-l,f=Math.floor(d/o),h=Math.ceil(v/o);for(let b=f;b<=h;b++){const m=l+b*o,g=i.getTimeX?.(m);if(g===void 0)continue;const w=s?(m-l)%s===0:!1;e.beginPath(),e.moveTo(g,0),e.lineTo(g,a),e.lineWidth=w?2:1,e.strokeStyle=w?"#adb5bd":"#dee2e6",e.setLineDash(w?[]:[5,5]),e.stroke()}e.setLineDash([]),c!==void 0&&(e.beginPath(),e.moveTo(c,0),e.lineTo(c,a),e.lineWidth=3,e.strokeStyle="#00ff00",e.setLineDash([]),e.stroke())}function Li(e,n){return n.some(i=>i.columnIndex===e)}function Ei(e,n){return!n.some(i=>i.columnIndex+1===e)}const Oi=.7,Fi=.9,Wi=4,Bi=1,ji=.15,qi=.2,Ui=1,Wt=1.5;function st(e,n){return Number.isFinite(e)&&e>0&&Number.isFinite(n)&&n>0}function Dn(e){if(!e||typeof e.startColumnIndex!="number"||typeof e.endColumnIndex!="number")return!1;const n=e.shape==="circle"?e.startColumnIndex+1:e.startColumnIndex;return e.endColumnIndex>n}function vt(e){const n=e?.split("-")[1];return Number.parseInt(n??"0",10)}function Hn(e,n,i){const a=i*.25,o=e.uuid;if(!o)return 0;const s=n.filter(l=>!l.isDrum&&l.row===e.row&&l.startColumnIndex===e.startColumnIndex&&l.uuid&&l.uuid!==o);if(s.length===0)return 0;const r=[e,...s];return r.sort((l,d)=>vt(l.uuid)-vt(d.uuid)),r.findIndex(l=>l.uuid===o)*a}function Gi(e,n,i){const a=i/2*.12,o=e.uuid;if(!o)return 0;const s=n.filter(l=>!l.isDrum&&l.row===e.row&&l.startColumnIndex===e.startColumnIndex&&l.uuid&&l.uuid!==o&&Dn(l));if(s.length===0)return 0;const r=[e,...s];return r.sort((l,d)=>vt(l.uuid)-vt(d.uuid)),r.findIndex(l=>l.uuid===o)*a}function Yi(e){if(!e)return{multiplier:1,category:"natural"};const n=e.includes("â™­"),i=e.includes("â™¯"),a=e.includes("/");return!n&&!i?{multiplier:1,category:"natural"}:a?{multiplier:.75,category:"both-accidentals"}:{multiplier:.88,category:"single-accidental"}}function Dt(e,n,i,a,o,s){const{multiplier:r,category:c}=Yi(n);let l;if(i==="circle"){const d=s*2*Fi;switch(c){case"natural":l=d;break;case"single-accidental":l=d*.8;break;case"both-accidentals":l=d*.4;break;default:l=d*r}}else{const d=s*2*Oi;switch(c){case"natural":l=d*1.5;break;case"single-accidental":l=d*1.2;break;case"both-accidentals":l=d;break;default:l=d*r}}if(!(l<Wi))if(e.fillStyle="#212529",e.font=`bold ${l}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle",i==="oval"&&c==="both-accidentals"&&n.includes("/")){const d=n.split("/"),v=l*1.1,f=v*(d.length-1),h=o-f/2;d.forEach((b,m)=>{const g=h+m*v,w=l*.08;e.fillText(b.trim(),a,g+w)})}else{const d=l*.08;e.fillText(n,a,o+d)}}function Vi(e,n,i,a,o,s,r){e.save(),e.beginPath(),e.arc(i,o,s,Math.PI/2,-Math.PI/2,!1),e.lineTo(a,o-s),e.arc(a,o,s,-Math.PI/2,Math.PI/2,!1),e.lineTo(i,o+s),e.closePath(),e.strokeStyle=n.color,e.lineWidth=r,e.shadowColor=n.color,e.shadowBlur=Wt,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore()}function Jt(e,n,i,a){const{config:o,coords:s,allNotes:r,getScaleDegreeLabel:c}=n,{cellWidth:l,cellHeight:d,columnWidths:v,degreeDisplayMode:f}=o,h=s.getRowY(a),b=s.getColumnX(i.startColumnIndex),g=(v[i.startColumnIndex]??1)*l;if(!st(g,d))return;const w=Hn(i,r,l),p=Math.max(.5,g*.15),_=b+g/2+w,C=g/2-p/2,x=d/2-p/2;if(st(C,x)&&(e.save(),e.beginPath(),e.ellipse(_,h,C,x,0,0,2*Math.PI),e.strokeStyle=i.color,e.lineWidth=p,e.shadowColor=i.color,e.shadowBlur=Wt,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore(),f!=="off"&&c)){const{label:T}=c(i);T&&Dt(e,T,"oval",_,h,C)}}function Qt(e,n,i,a){const{config:o,coords:s,allNotes:r,getScaleDegreeLabel:c}=n,{cellWidth:l,cellHeight:d,degreeDisplayMode:v,longNoteStyle:f}=o,h=s.getRowY(a),b=s.getColumnX(i.startColumnIndex),g=s.getColumnX(i.startColumnIndex+1)-b;if(!st(g,d))return;const w=Hn(i,r,l),p=b+g+w,_=Math.max(Bi,g*ji),C=d/2-_/2,x=Dn(i);if(x&&f==="style2"){const M=p,k=s.getColumnX(i.endColumnIndex);if(st(k-M,C)&&(Vi(e,i,M,k,h,C,_),v!=="off"&&c)){const{label:D}=c(i);if(D){const H=(M+k)/2;Dt(e,D,"circle",H,h,C)}}return}if(x){const M=s.getColumnX(i.endColumnIndex+1),k=Gi(i,r,d),D=h+k;e.beginPath(),e.moveTo(p,D),e.lineTo(M,D),e.strokeStyle=i.color,e.lineWidth=Math.max(Ui,g*qi),e.stroke()}const T=g-_/2;if(st(T,C)&&(e.save(),e.beginPath(),e.ellipse(p,h,T,C,0,0,2*Math.PI),e.strokeStyle=i.color,e.lineWidth=_,e.shadowColor=i.color,e.shadowBlur=Wt,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore(),v!=="off"&&c)){const{label:M}=c(i);M&&Dt(e,M,"circle",p,h,T)}}function zi(e,n,i){const{config:a,coords:o}=n,{cellWidth:s,cellHeight:r}=a,c=o.getRowY(i.globalRow??i.row),l=o.getColumnX(i.columnIndex),v=o.getColumnX(i.columnIndex+1)-l,f=v*2,h=l+f/2,b=Math.min(f,r)/2*.9;if(b<2||(e.beginPath(),e.arc(h,c,b,0,2*Math.PI),e.strokeStyle="#212529",e.lineWidth=Math.max(.5,v*.05),e.stroke(),i.tonicNumber==null))return;const m=i.tonicNumber.toString(),g=b*1.5;g<6||(e.fillStyle="#212529",e.font=`bold ${g}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(m,h,c))}const Xi={timeWindowMs:4e3,pixelsPerSecond:200,circleRadius:9.5,proximityThreshold:35,maxConnections:3,connectorLineWidth:2.5,connectorColor:"rgba(0,0,0,0.4)",useTonicRelativeColors:!0,tonicPitchClass:0,clarityThreshold:.5,maxOpacity:.9};function Ln(e){return{...Xi,...e}}function $t(e,n,i,a,o,s,r){const c=Ln(s.trailConfig);if(a<c.clarityThreshold||i<=0)return;const{cellHeight:l,colorMode:d}=s,v=En(n,i,l,r),f=l/2*.8,h=d==="bw"?[128,128,128]:An(i,c.tonicPitchClass);e.save(),e.beginPath(),e.arc(o,v,f+4,0,2*Math.PI),e.fillStyle=`rgba(${h[0]}, ${h[1]}, ${h[2]}, ${a*.3})`,e.fill(),e.beginPath(),e.arc(o,v,f,0,2*Math.PI),e.fillStyle=`rgba(${h[0]}, ${h[1]}, ${h[2]}, ${a})`,e.fill(),e.restore()}function En(e,n,i,a){if(a.length===0||!a[0])return 0;const o=Math.floor(n),s=n-o,l=(a[0].midi??108)-o;if(l<0||l>=a.length)return l<0?0:e.getRowY(a.length-1);const d=e.getRowY(l),v=i/2;return d-s*v}function On(e,n,i,a,o,s){const{viewportWidth:r,cellHeight:c,colorMode:l}=o,d=Ln(o.trailConfig),v=d.timeWindowMs,f=d.pixelsPerSecond,h=o.nowLineX??r,b=i.filter(m=>m.midi>0&&m.clarity>=d.clarityThreshold).map(m=>{const g=a-m.time;if(g>=v||g<0)return null;const w=h-g/1e3*f,p=En(n,m.midi,c,s),_=l==="bw"?[128,128,128]:An(m.midi,d.tonicPitchClass);return{x:w,y:p,clarity:m.clarity,color:_}}).filter(m=>m!==null&&m.x>=0);if(b.length!==0){e.save(),e.strokeStyle=d.connectorColor,e.lineWidth=d.connectorLineWidth,e.beginPath();for(let m=0;m<b.length;m++){let g=0;for(let w=m+1;w<b.length&&g<d.maxConnections;w++){const p=b[m].x-b[w].x,_=b[m].y-b[w].y;Math.sqrt(p*p+_*_)<=d.proximityThreshold&&(e.moveTo(b[m].x,b[m].y),e.lineTo(b[w].x,b[w].y),g++)}}e.stroke();for(const m of b){const g=Math.min(m.clarity*d.maxOpacity,1);e.fillStyle=`rgba(${m.color[0]}, ${m.color[1]}, ${m.color[2]}, ${g})`,e.beginPath(),e.arc(m.x,m.y,d.circleRadius,0,2*Math.PI),e.fill()}e.restore()}}function en(e,n,i,a,o,s,r,c){const{cellHeight:l,nowLineX:d=100,pixelsPerSecond:v}=o,f=.5;for(const h of i){const b=(d??100)+(h.startTimeMs-a)/1e3*v,m=b+h.durationMs/1e3*v;if(m<0||b>o.viewportWidth)continue;let g;if(s){if(g=s.findIndex(k=>k.midi===h.midi),g===-1)continue}else g=Math.round(108-h.midi);const w=n.getRowY(g),p=l/2-2,_=h.color??"#4CAF50",C=b<=d&&m>=d,x=r!=null&&(c??0)>.5&&Math.abs(r-h.midi)<=f,T=C&&x;e.save(),e.beginPath();const M=m-b;if(M>=2*p){const k=b+p,D=m-p;e.arc(k,w,p,Math.PI/2,-Math.PI/2,!1),e.lineTo(D,w-p),e.arc(D,w,p,-Math.PI/2,Math.PI/2,!1),e.lineTo(k,w+p)}else{const k=(b+m)/2,D=M/2;e.ellipse(k,w,D,p,0,0,2*Math.PI)}if(e.closePath(),T?(e.strokeStyle="#FFD700",e.lineWidth=5,e.shadowColor="#FFD700",e.shadowBlur=20,e.stroke(),e.fillStyle="rgba(255, 215, 0, 0.3)",e.fill(),Ki(e,d,w,p)):(e.strokeStyle=_,e.lineWidth=3,e.shadowColor=_,e.shadowBlur=8,e.stroke()),e.shadowBlur=0,e.restore(),h.label){const k=b+4;e.fillStyle=T?"#FFD700":"#212529",e.font=`bold ${Math.max(16,p*1.2)}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="left",e.textBaseline="middle",e.fillText(h.label,k,w)}}}function Ki(e,n,i,a){const r=a*1.5;e.save(),e.fillStyle="#FFD700",e.shadowColor="#FFD700",e.shadowBlur=6;for(let c=0;c<8;c++){const l=c/8*Math.PI*2,d=n+Math.cos(l)*r,v=i+Math.sin(l)*r;e.beginPath(),e.arc(d,v,3,0,Math.PI*2),e.fill()}e.restore()}function Zi(e){const n=e.replace(/\d+$/,"");return n.length>0?n:e}function Fn(e,n){return!Number.isFinite(n)||n<=0?e:Math.round(e*n)/n}function Ji(e,n,i,a){const o=Math.max(10,Math.min(e*1.2,n*1.2)),s=i<=3?1:.7,r=a<=1?1.08:1;return Fn(o*s*r,a)}function Qi(e){const n=e.getContext("2d");return n&&(n.getTransform().a||window.devicePixelRatio)||1}function $i(e){if(typeof e.midi=="number")return e.midi%12;if(typeof e.pitchClass=="number")return e.pitchClass;const n={C:0,D:2,E:4,F:5,G:7,A:9,B:11},i=e.pitch.charAt(0).toUpperCase();let a=n[i]??0;return(e.pitch.includes("#")||e.pitch.includes("â™¯"))&&a++,(e.pitch.includes("b")||e.pitch.includes("â™­"))&&a--,(a%12+12)%12}function ea(e){return e?Array.isArray(e)?e:[e]:[]}function ta(e,n){const{showFrequencyLabels:i,showOctaveLabels:a,accidentalMode:o}=n,s=f=>a?f:Zi(f);if(i)return String(Math.round(e.frequency));const{flatName:r,sharpName:c,isAccidental:l}=e,{sharp:d,flat:v}=o;return l?d&&v?s(e.pitch):d&&!v?s(c):v&&!d?s(r):null:s(r)}function tn(e,n,i,a){const{fullRowData:o,cellWidth:s,cellHeight:r,legendColumnWidth:c,colorMode:l,accidentalMode:d}=n,{startRow:v,endRow:f,coords:h}=i,b=Qi(e.canvas),m=_=>Fn(_,b),g=ea(n.highlight),w=c;let p=0;for(const _ of a){for(let C=v;C<=f;C++){const x=o[C];if(!x||x.isBoundary||x.column!==_)continue;const T=h.getRowY(C),M=!d.sharp&&!d.flat,k=x.isAccidental&&M,D=ta(x,n);if(D===null)continue;let H=l==="bw"?"#ffffff":x.hex||"#ffffff",F="FF";if(k&&(F="00"),e.fillStyle=k?"rgba(255,255,255,0)":H,e.fillRect(p,T-r/2,w,r),g.length>0)for(const L of g){if(L.opacity<=0)continue;let P=!1;typeof L.midi=="number"?P=typeof x.midi=="number"&&x.midi===Math.round(L.midi):typeof L.pitchClass=="number"&&(P=$i(x)===L.pitchClass),P&&(e.save(),e.globalAlpha=Math.min(Math.max(L.opacity,0),1),e.fillStyle=L.color??"#ffff00",e.fillRect(p,T-r/2,w,r),e.restore())}const W=Ji(s,r,D.length,b);e.font=`bold ${W}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle";const U=m(p+w/2),ne=m(T);e.strokeStyle=`#212529${F}`,e.lineWidth=Math.max(1.2,2.5/b),e.lineJoin="round",e.strokeText(D,U,ne),e.fillStyle=`#ffffff${F}`,e.fillText(D,U,ne)}p+=w}}function na(e,n,i,a){e&&(e.clearRect(0,0,e.canvas.width,e.canvas.height),tn(e,i,a,["B","A"])),n&&(n.clearRect(0,0,n.canvas.width,n.canvas.height),tn(n,i,a,["A","B"]))}var ia=N('<canvas class="pitch-grid-legend pitch-grid-legend--left svelte-1b4jihh"></canvas>'),aa=N('<canvas class="pitch-grid-legend pitch-grid-legend--right svelte-1b4jihh"></canvas>'),sa=N('<div class="pitch-grid-container svelte-1b4jihh"><!> <canvas class="pitch-grid-canvas svelte-1b4jihh"></canvas> <!></div>');function oa(e,n){_e(n,!0);let i=ye(n,"colorMode",3,"color"),a=ye(n,"degreeDisplayMode",3,"off"),o=ye(n,"accidentalMode",19,()=>({sharp:!0,flat:!0})),s=ye(n,"showFrequencyLabels",3,!1),r=ye(n,"showOctaveLabels",3,!0),c=ye(n,"showRightLegend",3,!0),l=ye(n,"placedNotes",19,()=>[]),d=ye(n,"placedTonicSigns",19,()=>[]),v=ye(n,"columnWidths",19,()=>[]),f=ye(n,"macrobeatGroupings",19,()=>[]),h=ye(n,"macrobeatBoundaryStyles",19,()=>[]),b=ye(n,"longNoteStyle",3,"style1"),m=ye(n,"beatIntervalMs",3,500),g=ye(n,"beatTimeOffsetMs",3,0),w=X(void 0),p=X(void 0),_=X(void 0),C=X(null),x=X(null),T=X(null),M=X(null);const k=3,D=I(()=>n.cellWidth*k),H=I(()=>t(D)*2),F=I(()=>r()||s()),W=I(()=>t(F)?t(H)*(c()?2:1):0),U=I(()=>Math.max(0,n.viewport.containerWidth-t(W))),ne=I(()=>n.mode==="notation"||n.mode==="playback"),L=I(()=>n.mode==="singing"),P=I(()=>n.mode==="highway");function E(){if(t(ne))return Ti({cellWidth:n.cellWidth,cellHeight:n.cellHeight,columnWidths:v(),viewport:n.viewport,tempoModulationMarkers:n.tempoModulationMarkers});{const S=t(P)?n.highwayConfig:n.singingConfig;return Nn({cellWidth:n.cellWidth,cellHeight:n.cellHeight,viewport:n.viewport,pixelsPerSecond:S?.pixelsPerSecond??200,nowLineX:S?.nowLineX??100,currentTimeMs:S?.currentTimeMs??0})}}function Y(){if(!t(C)||!t(w))return;const S=E(),{paddedStartRow:q,paddedEndRow:V}=ki(n.viewport,n.fullRowData);t(C).clearRect(0,0,t(U),n.viewport.containerHeight);const ve={fullRowData:n.fullRowData,cellHeight:n.cellHeight,viewportHeight:n.viewport.containerHeight,viewportWidth:t(U),colorMode:i()};Ni(t(C),ve,S,q,V),t(ne)?$(t(C),S):t(L)?se(t(C),S):t(P)&&oe(t(C),S),t(F)&&(t(x)||t(T))&&he(S,q,V)}function $(S,q){const V=J(f()),ve={columnWidths:v(),cellWidth:n.cellWidth,viewportHeight:n.viewport.containerHeight,macrobeatGroupings:f(),macrobeatBoundaryStyles:h(),placedTonicSigns:d()};Di(S,ve,q,V);const Pe=l().filter(Z=>Z.isDrum||Z.globalRow===void 0?!1:kt(Z.globalRow,n.viewport,n.cellHeight,q)),O=d().filter(Z=>Z.globalRow===void 0?!1:kt(Z.globalRow,n.viewport,n.cellHeight,q)),ie={config:{cellWidth:n.cellWidth,cellHeight:n.cellHeight,columnWidths:v(),degreeDisplayMode:a(),accidentalMode:o(),longNoteStyle:b(),colorMode:i()},coords:q,allNotes:l()};for(const Z of Pe)Z.shape==="oval"?Jt(S,ie,Z,Z.globalRow):Z.shape==="circle"&&Qt(S,ie,Z,Z.globalRow);for(const Z of O)zi(S,ie,Z)}function se(S,q){if(!n.singingConfig)return;const V={cellHeight:n.cellHeight,viewportWidth:t(U),pixelsPerSecond:n.singingConfig.pixelsPerSecond??200,timeWindowMs:n.singingConfig.timeWindowMs??4e3,colorMode:i(),trailConfig:n.singingConfig.trailConfig};n.singingConfig.pitchHistory&&n.singingConfig.pitchHistory.length>0&&On(S,q,n.singingConfig.pitchHistory,performance.now(),V,n.fullRowData),n.singingConfig.targetNotes&&n.singingConfig.targetNotes.length>0&&en(S,q,n.singingConfig.targetNotes,performance.now(),V,n.fullRowData),n.singingConfig.userPitch&&n.singingConfig.userPitch.clarity>.5&&$t(S,q,n.singingConfig.userPitch.midi,n.singingConfig.userPitch.clarity,t(U)-20,V,n.fullRowData)}function oe(S,q){if(!n.highwayConfig)return;const V={cellHeight:n.cellHeight,viewportWidth:n.viewport.containerWidth,nowLineX:n.highwayConfig.nowLineX,pixelsPerSecond:n.highwayConfig.pixelsPerSecond??200,timeWindowMs:n.highwayConfig.timeWindowMs??4e3,colorMode:i(),trailConfig:n.highwayConfig.trailConfig};if(n.highwayConfig.scrollingGridData&&n.highwayConfig.scrollOffset!==void 0)le(S,q);else{const Pe={startMs:n.highwayConfig.currentTimeMs-1e3,endMs:n.highwayConfig.currentTimeMs+t(U)/(n.highwayConfig.pixelsPerSecond??200)*1e3},O={viewportWidth:t(U),viewportHeight:n.viewport.containerHeight,beatIntervalMs:m(),visibleTimeRange:Pe,nowLineX:n.highwayConfig.nowLineX,beatTimeOffsetMs:g()};Hi(S,O,q),n.highwayConfig.targetNotes&&n.highwayConfig.targetNotes.length>0&&en(S,q,n.highwayConfig.targetNotes,n.highwayConfig.currentTimeMs,V,n.fullRowData,n.highwayConfig.userPitch?.midi??null,n.highwayConfig.userPitch?.clarity??0)}ge(S,n.highwayConfig.nowLineX,n.viewport.containerHeight),n.highwayConfig.showOnrampCountdown&&n.highwayConfig.onrampBeatsRemaining!==void 0&&ce(S,n.highwayConfig.onrampBeatsRemaining),n.highwayConfig.userPitch&&n.highwayConfig.userPitch.clarity>.5&&$t(S,q,n.highwayConfig.userPitch.midi,n.highwayConfig.userPitch.clarity,n.highwayConfig.nowLineX,V,n.fullRowData)}function le(S,q){if(!n.highwayConfig?.scrollingGridData||n.highwayConfig.scrollOffset===void 0)return;const V=n.highwayConfig.scrollingGridData,ve=n.highwayConfig.scrollOffset,Pe=J(V.macrobeatGroupings);for(let j=0;j<Pe.length;j++){const Z=Pe[j]*n.cellWidth-ve;if(Z>=-n.cellWidth&&Z<=t(U)+n.cellWidth){const we=V.macrobeatBoundaryStyles[j]||"solid",Ce=we==="solid"?2:1,pe=we==="dashed"?[5,5]:[];S.strokeStyle="#495057",S.lineWidth=Ce,S.setLineDash(pe),S.beginPath(),S.moveTo(Z,0),S.lineTo(Z,n.viewport.containerHeight),S.stroke(),S.setLineDash([])}}const O={cellWidth:n.cellWidth,cellHeight:n.cellHeight,columnWidths:V.columnWidths,degreeDisplayMode:a(),accidentalMode:o(),longNoteStyle:b(),colorMode:i()};for(const j of V.placedNotes){if(j.isDrum||j.globalRow===void 0||!kt(j.globalRow,n.viewport,n.cellHeight,q))continue;const ie=j.startColumnIndex*n.cellWidth-ve;if(j.endColumnIndex*n.cellWidth-ve>=-n.cellWidth&&ie<=t(U)+n.cellWidth){const we={...q,getColumnX:pe=>pe*n.cellWidth-ve},Ce={config:O,coords:we,allNotes:V.placedNotes};j.shape==="oval"?Jt(S,Ce,j,j.globalRow):j.shape==="circle"&&Qt(S,Ce,j,j.globalRow)}}}function ge(S,q,V){S.strokeStyle="rgba(255, 0, 0, 0.9)",S.lineWidth=3,S.beginPath(),S.moveTo(q,0),S.lineTo(q,V),S.stroke()}function ce(S,q){S.fillStyle="rgba(0, 0, 0, 0.7)",S.fillRect(t(U)/2-40,10,80,50),S.fillStyle="#ffffff",S.font="bold 36px sans-serif",S.textAlign="center",S.textBaseline="middle",S.fillText(q.toString(),t(U)/2,35)}function he(S,q,V){const ve={fullRowData:n.fullRowData,cellWidth:n.cellWidth,cellHeight:n.cellHeight,legendColumnWidth:t(D),colorMode:i(),showFrequencyLabels:s(),showOctaveLabels:r(),accidentalMode:o(),highlight:n.legendHighlight},Pe={startRow:q,endRow:V,coords:S};na(t(x),t(T),ve,Pe)}function J(S){const q=[];let V=0;for(const ve of S)V+=ve,q.push(V);return q}function te(){if(t(M))return;function S(){Y(),A(M,requestAnimationFrame(S),!0)}A(M,requestAnimationFrame(S),!0)}function be(){t(M)&&(cancelAnimationFrame(t(M)),A(M,null))}function Te(){if(!t(w)||(A(C,t(w).getContext("2d"),!0),!t(C)))return;const S=window.devicePixelRatio||1;t(w).width=t(U)*S,t(w).height=n.viewport.containerHeight*S,t(w).style.width=`${t(U)}px`,t(w).style.height=`${n.viewport.containerHeight}px`,t(C).scale(S,S),t(p)&&(A(x,t(p).getContext("2d"),!0),t(x)&&(t(p).width=t(H)*S,t(p).height=n.viewport.containerHeight*S,t(p).style.width=`${t(H)}px`,t(p).style.height=`${n.viewport.containerHeight}px`,t(x).scale(S,S))),t(_)&&(A(T,t(_).getContext("2d"),!0),t(T)&&(t(_).width=t(H)*S,t(_).height=n.viewport.containerHeight*S,t(_).style.width=`${t(H)}px`,t(_).style.height=`${n.viewport.containerHeight}px`,t(T).scale(S,S))),Y(),(t(L)||t(P))&&te()}Cn(()=>{Te()}),$e(()=>{be()}),De(()=>{n.mode,n.viewport,n.cellWidth,n.cellHeight,i(),a(),l(),d(),v(),t(C)&&t(ne)&&Y()}),De(()=>{n.mode,t(L)||t(P)?te():(be(),t(C)&&Y())}),De(()=>{n.viewport.containerWidth,n.viewport.containerHeight,t(C)&&t(w)&&Te()});var Ae=sa(),Re=u(Ae);{var re=S=>{var q=ia();Be(q,V=>A(p,V),()=>t(p)),R(S,q)};G(Re,S=>{t(F)&&S(re)})}var ue=y(Re,2);Be(ue,S=>A(w,S),()=>t(w));var z=y(ue,2);{var ae=S=>{var q=aa();Be(q,V=>A(_,V),()=>t(_)),R(S,q)};G(z,S=>{t(F)&&c()&&S(ae)})}R(e,Ae),Me()}const nn={isDetecting:!1,visualizationMode:"highway",tonic:"C",useDegrees:!1,showAccidentals:!0,pitchHighlightEnabled:!0,yAxisRange:{minMidi:40,maxMidi:72},drone:{isPlaying:!1,octave:3,volume:-12}};function ra(){let e=X(Fe({...nn}));return{get state(){return t(e)},toggleDetecting(){t(e).isDetecting=!t(e).isDetecting},setDetecting(n){t(e).isDetecting=n},setVisualizationMode(n){t(e).visualizationMode=n},setTonic(n){t(e).tonic=n},setUseDegrees(n){t(e).useDegrees=n},setShowAccidentals(n){t(e).showAccidentals=n},togglePitchHighlight(){t(e).pitchHighlightEnabled=!t(e).pitchHighlightEnabled},setPitchHighlightEnabled(n){t(e).pitchHighlightEnabled=n},setYAxisRange(n){t(e).yAxisRange=n},expandYAxisUpper(){t(e).yAxisRange.maxMidi<108&&(t(e).yAxisRange={...t(e).yAxisRange,maxMidi:t(e).yAxisRange.maxMidi+1})},contractYAxisUpper(){t(e).yAxisRange.maxMidi>t(e).yAxisRange.minMidi+6&&(t(e).yAxisRange={...t(e).yAxisRange,maxMidi:t(e).yAxisRange.maxMidi-1})},expandYAxisLower(){t(e).yAxisRange.minMidi>21&&(t(e).yAxisRange={...t(e).yAxisRange,minMidi:t(e).yAxisRange.minMidi-1})},contractYAxisLower(){t(e).yAxisRange.minMidi<t(e).yAxisRange.maxMidi-6&&(t(e).yAxisRange={...t(e).yAxisRange,minMidi:t(e).yAxisRange.minMidi+1})},toggleDrone(){t(e).drone={...t(e).drone,isPlaying:!t(e).drone.isPlaying}},setDroneOctave(n){t(e).drone={...t(e).drone,octave:n}},setDroneVolume(n){t(e).drone={...t(e).drone,volume:n}},reset(){A(e,{...nn},!0)}}}const ee=ra(),la=200,an={currentPitch:null,history:[],stablePitch:{highlights:[],size:1}};function ca(){let e=X(Fe({...an}));return{get state(){return t(e)},setCurrentPitch(n){t(e).currentPitch=n},addHistoryPoint(n){t(e).history.push(n),t(e).history.length>la&&t(e).history.shift()},setStablePitch(n){t(e).stablePitch=n},clearHistory(){t(e).history=[]},reset(){A(e,{...an},!0)}}}const me=ca(),sn={isPlaying:!1,startTime:null,currentTimeMs:0,targetNotes:[],nowLineX:100,pixelsPerSecond:200,timeWindowMs:4e3};function da(){let e=X(Fe({...sn})),n=null,i=null,a=null;function o(l){return l.map((d,v)=>({id:`target-${v}`,midi:d.midi,startTimeMs:d.startTimeMs,durationMs:d.durationMs,startColumn:0,endColumn:0,color:"#3b82f6",shape:"oval",globalRow:0}))}function s(){if(!n)return;const l=n.getState();t(e).isPlaying=l.isPlaying&&!l.isPaused,t(e).currentTimeMs=l.currentTimeMs;const d=n.getPerformanceResults();t(e).targetNotes=t(e).targetNotes.map((v,f)=>{const h=`target-${f}`,b=d.get(h);return{...v,hit:b?.hitStatus==="hit"}})}function r(){t(e).isPlaying&&n?(s(),i=requestAnimationFrame(r)):i=null}function c(){n&&n.dispose(),n=Si({judgmentLinePosition:t(e).nowLineX/800,pixelsPerSecond:t(e).pixelsPerSecond,lookAheadMs:t(e).timeWindowMs,scrollMode:"constant-speed",leadInBeats:0,playMetronomeDuringOnramp:!1,playTargetNotes:!1,playMetronome:!1,inputSources:["microphone"],feedbackConfig:{onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70},stateCallbacks:{getTempo:()=>120,getCellWidth:()=>20,getViewportWidth:()=>800},eventCallbacks:{emit:(d,v)=>{if(console.debug("[Highway]",d,v),d==="noteHit"){const f=v;console.log(`[Highway] Note HIT: ${f.noteId}, accuracy: ${f.performance.accuracyTier||"unknown"}`)}else d==="noteMissed"?console.log(`[Highway] Note MISSED: ${v.noteId}`):d==="onrampComplete"?console.log("[Highway] Onramp complete, playback starting!"):d==="performanceComplete"&&(console.log("[Highway] Performance complete!"),a&&n&&a(n.getPerformanceResults()))}}});const l=o(t(e).targetNotes);n.init(l)}return{get state(){return t(e)},get engineService(){return n},start(){!n&&t(e).targetNotes.length>0&&c(),n&&(n.start(),t(e).isPlaying=!0,t(e).startTime=performance.now(),t(e).currentTimeMs=0,r())},stop(){n&&n.stop(),t(e).isPlaying=!1,i!==null&&(cancelAnimationFrame(i),i=null)},pause(){n&&n.pause(),t(e).isPlaying=!1,i!==null&&(cancelAnimationFrame(i),i=null)},resume(){n&&(n.resume(),t(e).isPlaying=!0,r())},setTargetNotes(l){if(t(e).targetNotes=l,n){const d=o(l);n.init(d)}},markNoteHit(l){l>=0&&l<t(e).targetNotes.length&&(t(e).targetNotes=t(e).targetNotes.map((d,v)=>v===l?{...d,hit:!0}:d))},setNowLineX(l){t(e).nowLineX=l},setPixelsPerSecond(l){t(e).pixelsPerSecond=l},setTimeWindowMs(l){t(e).timeWindowMs=l},recordPitchInput(l,d){n&&t(e).isPlaying&&n.recordPitchInput(l,d,"microphone")},getPerformanceResults(){return n?.getPerformanceResults()??new Map},setCurrentTime(l){t(e).currentTimeMs=l,n&&n.setScrollOffset(l)},onPerformanceComplete(l){return a=l,()=>{a=null}},reset(){i!==null&&(cancelAnimationFrame(i),i=null),n&&(n.dispose(),n=null),A(e,{...sn},!0)}}}const fe=da(),Xe=["How now brown cow","The arsonist has oddly shaped feet","The human torch was denied a bank loan"],Bt={clarityThreshold:.8,binSizeSemitones:.5,minVoicedSamples:50,lowerRegionPercent:.4,minPeakDensity:.05,clusterExpansionThreshold:.02,minSpeakingMidi:36,maxSpeakingMidi:72,recordingDurationMs:5e3};function ua(e){return 440*Math.pow(2,(e-69)/12)}function fa(e,n=Bt){const i=e.filter(p=>p.clarity>=n.clarityThreshold);if(i.length<n.minVoicedSamples)return{success:!1,error:{code:"TOO_FEW_VOICED_SAMPLES",message:`Only ${i.length} voiced samples detected. Need at least ${n.minVoicedSamples}.`,details:{voicedCount:i.length,required:n.minVoicedSamples}}};const a=ha(i,n.binSizeSemitones),o=i.map(p=>p.midi).sort((p,_)=>p-_),s=o[Math.floor(o.length*.1)],c=o[Math.floor(o.length*.9)]-s,l=s+c*n.lowerRegionPercent,d=va(a,n.minPeakDensity),v=d.filter(p=>p.midiCenter<=l);if(v.length===0)if(d.length>0){const p=d.reduce((_,C)=>C.midiCenter<_.midiCenter?C:_);v.push(p)}else return{success:!1,error:{code:"NO_STABLE_CLUSTER",message:"Could not find a stable pitch cluster in the recordings.",details:{totalPeaks:d.length,lowerRegionCutoff:l}}};const f=v.reduce((p,_)=>_.midiCenter<p.midiCenter?_:p),h=ga(a,f,n.clusterExpansionThreshold),b=ma(h),m=Math.round(b),g=ua(b);if(m<n.minSpeakingMidi||m>n.maxSpeakingMidi)return{success:!1,error:{code:"PITCH_OUT_OF_BOUNDS",message:"Detected pitch is outside typical speaking range.",details:{estimatedMidi:m,minBound:n.minSpeakingMidi,maxBound:n.maxSpeakingMidi}}};const w=pa(h,i.length,c);return{success:!0,estimatedMidi:m,estimatedHz:g,confidenceScore:w,histogram:a,clusterBins:h}}function ha(e,n){const i=new Map;for(const o of e){const s=Math.round(o.midi/n)*n;i.set(s,(i.get(s)||0)+1)}const a=e.length;return Array.from(i.entries()).map(([o,s])=>({midiCenter:o,count:s,density:s/a})).sort((o,s)=>o.midiCenter-s.midiCenter)}function va(e,n){return e.filter((i,a,o)=>{if(i.density<n)return!1;const s=a>0?o[a-1].density:0,r=a<o.length-1?o[a+1].density:0;return i.density>=s&&i.density>=r})}function ga(e,n,i){const a=[n],o=e.findIndex(s=>s.midiCenter===n.midiCenter);if(o===-1)return a;for(let s=o-1;s>=0&&e[s].density>=i;s--)a.unshift(e[s]);for(let s=o+1;s<e.length&&e[s].density>=i;s++)a.push(e[s]);return a}function ma(e){const n=e.reduce((a,o)=>a+o.count,0);return n===0?e[0]?.midiCenter??0:e.reduce((a,o)=>a+o.midiCenter*o.count,0)/n}function pa(e,n,i){const a=e.reduce((l,d)=>l+d.count,0),o=Math.min(1,a/n),s=Math.max(0,1-i/12),r=e.length>1?e[e.length-1].midiCenter-e[0].midiCenter:0,c=Math.max(0,1-r/3);return o*.4+s*.3+c*.3}function Wn(e){const n=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],i=Math.floor(e/12)-1,a=Math.round(e)%12;return`${n[a]}${i}`}function ya(e,n){return e+n}const Bn="singingTrainerPreferences",gt={speakingPitch:null};function on(){try{const e=localStorage.getItem(Bn);if(e){const n=JSON.parse(e);return ba(n)}}catch(e){console.warn("[preferencesStore] Failed to load preferences:",e)}return{...gt}}function ut(e){try{return localStorage.setItem(Bn,JSON.stringify(e)),!0}catch(n){return console.error("[preferencesStore] Failed to save preferences:",n),!1}}function ba(e){if(!e||typeof e!="object")return{...gt};const n=e,i={...gt};if(n.speakingPitch&&typeof n.speakingPitch=="object"){const a=n.speakingPitch;typeof a.speakingPitchMidi=="number"&&a.speakingPitchMidi>=0&&a.speakingPitchMidi<=127&&typeof a.speakingPitchLastCalibratedAt=="string"&&(i.speakingPitch={speakingPitchMidi:a.speakingPitchMidi,speakingPitchLastCalibratedAt:a.speakingPitchLastCalibratedAt})}return i}function wa(e){return 440*Math.pow(2,(e-69)/12)}function _a(e){try{return new Date(e).toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}catch{return"Unknown date"}}function Ma(){let e=X(Fe(on()));return{get state(){return t(e)},get speakingPitchMidi(){return t(e).speakingPitch?.speakingPitchMidi??null},get speakingPitchHz(){const n=t(e).speakingPitch?.speakingPitchMidi;return n!==void 0?wa(n):null},get speakingPitchNoteName(){const n=t(e).speakingPitch?.speakingPitchMidi;return n!==void 0?Wn(n):null},get isCalibrated(){return t(e).speakingPitch!==null},get lastCalibratedDate(){return t(e).speakingPitch?.speakingPitchLastCalibratedAt?_a(t(e).speakingPitch.speakingPitchLastCalibratedAt):null},get lastCalibratedIso(){return t(e).speakingPitch?.speakingPitchLastCalibratedAt??null},setSpeakingPitch(n){return A(e,{...t(e),speakingPitch:{...n}},!0),ut(t(e))},clearSpeakingPitch(){return A(e,{...t(e),speakingPitch:null},!0),ut(t(e))},adjustSpeakingPitch(n){if(!t(e).speakingPitch)return!1;const i=t(e).speakingPitch.speakingPitchMidi+n;return i<0||i>127?!1:(A(e,{...t(e),speakingPitch:{...t(e).speakingPitch,speakingPitchMidi:i}},!0),ut(t(e)))},reload(){A(e,on(),!0)},reset(){return A(e,{...gt},!0),ut(t(e))}}}const Le=Ma(),Pa={numLoops:5,minMidi:48,maxMidi:72,tempo:108,referenceVolume:-12,speakingPitchUsage:"none",templateId:void 0},rn={isActive:!1,isPlaying:!1,config:{...Pa},currentLoop:0,currentPhase:"reference",currentPitch:null,generatedNotes:[],results:[],restartRequested:!1};function Ca(e,n){return Math.floor(Math.random()*(n-e+1))+e}function ln(e){return 60/e*1e3/2}function cn(e){const n=Le.speakingPitchMidi;if(n===null||e.speakingPitchUsage==="none")return{minMidi:e.minMidi,maxMidi:e.maxMidi};const i=e.maxMidi-e.minMidi;switch(e.speakingPitchUsage){case"asTonic":{const a=Math.floor(i/2);return{minMidi:n-Math.floor(a*.4),maxMidi:n+Math.ceil(a*1.6)}}case"asFloorNote":return{minMidi:n,maxMidi:n+i};case"custom":return{minMidi:n,maxMidi:n+i};default:return{minMidi:e.minMidi,maxMidi:e.maxMidi}}}function Sa(){let e=X(Fe({...rn}));function n(a){const o=[],s=ln(a.tempo),{minMidi:r,maxMidi:c}=cn(a),l=2e3;for(let d=0;d<a.numLoops;d++){const v=Ca(r,c),f=l+d*32*s;o.push({midi:v,startTimeMs:f,durationMs:8*s,lyric:"ðŸ‘‚"}),o.push({midi:v,startTimeMs:f+16*s,durationMs:8*s,lyric:"ðŸŽ¤"})}return o}function i(a,o){const s=ln(o),r=32*s,l=a-2e3;if(l<0)return{loop:0,phase:"rest2"};const d=Math.floor(l/r),v=l%r,f=Math.floor(v/s);let h;return f<8?h="reference":f<16?h="rest1":f<24?h="input":h="rest2",{loop:d,phase:h}}return{get state(){return t(e)},configure(a){t(e).config={...t(e).config,...a}},setPitchRange(a,o){t(e).config.minMidi=a,t(e).config.maxMidi=o},start(){const a=n(t(e).config);t(e).generatedNotes=a,t(e).isActive=!0,t(e).isPlaying=!1,t(e).currentLoop=0,t(e).currentPhase="reference",t(e).currentPitch=a.length>0?a[0].midi:null,t(e).results=[]},stop(){t(e).isActive=!1,t(e).isPlaying=!1,t(e).currentLoop=0,t(e).currentPhase="reference",t(e).currentPitch=null},setPlaying(a){t(e).isPlaying=a},updatePhase(a){const{loop:o,phase:s}=i(a,t(e).config.tempo);t(e).currentLoop=o,t(e).currentPhase=s;const r=o*2;r<t(e).generatedNotes.length&&(t(e).currentPitch=t(e).generatedNotes[r].midi)},addResult(a){t(e).results.push(a)},hasResultForLoop(a){return t(e).results.some(o=>o.loopIndex===a)},getResults(){return t(e).results},getCurrentProgress(){return{current:t(e).currentLoop+1,total:t(e).config.numLoops}},getGeneratedNotes(){return t(e).generatedNotes},getAverageAccuracy(){return t(e).results.length===0?0:t(e).results.reduce((o,s)=>o+s.accuracy,0)/t(e).results.length},getHitCount(){return t(e).results.filter(a=>a.performance?.hitStatus==="hit").length},reset(){A(e,{...rn,config:{...t(e).config}},!0)},requestRestart(){t(e).restartRequested=!0},consumeRestartRequest(){t(e).restartRequested=!1},setSpeakingPitchUsage(a){t(e).config.speakingPitchUsage=a},getSpeakingPitchUsage(){return t(e).config.speakingPitchUsage},isSpeakingPitchAvailable(){return Le.isCalibrated},getEffectivePitchRange(){return cn(t(e).config)}}}const de=Sa();var Ta=N('<div class="singing-canvas-container svelte-wysbg"><!> <canvas class="pitch-trail-canvas svelte-wysbg"></canvas></div>');function xa(e,n){_e(n,!0);let i=X(void 0),a=X(800),o=X(400),s=X(void 0),r=X(null),c=X(null),l=0,d=0,v=0;const f=20,h=!0,b=!1,m=I(()=>t(a)>=720),g=3,w=I(()=>f*g),p=I(()=>t(w)*2),_=I(()=>h),C=I(()=>t(_)?t(p)*(t(m)?2:1):0),x=I(()=>Math.max(0,t(a)-t(C))),T=I(()=>t(_)?t(p):0),M=()=>{try{return!!globalThis.__ST_DEBUG_TRAIL}catch{return!1}},k=I(()=>ui(ee.state.yAxisRange.minMidi,ee.state.yAxisRange.maxMidi)),D=I(()=>fi({containerHeight:t(o),fullRowData:t(k),preferredCellHeight:40,minCellHeight:20})),H=I(()=>ee.state.visualizationMode==="highway"?"highway":"singing"),F=I(()=>60/de.state.config.tempo*1e3),W=2e3,U=I(()=>(()=>{if(!ee.state.pitchHighlightEnabled)return;const J=me.state.stablePitch;if(J.highlights.length!==0)return J.highlights.map(te=>({pitchClass:te.pitchClass,midi:te.midi,opacity:te.opacity,color:"#ffff00"}))})());function ne(){return fe.state.targetNotes.map((J,te)=>({id:`target-${te}`,midi:J.midi,startTimeMs:J.startTimeMs,durationMs:J.durationMs,label:J.lyric}))}const L=I(()=>({timeWindowMs:4e3,pixelsPerSecond:200,circleRadius:9.5,proximityThreshold:35,maxConnections:3,connectorLineWidth:2.5,connectorColor:"rgba(0,0,0,0.4)",useTonicRelativeColors:!0,tonicPitchClass:Pi(ee.state.tonic),clarityThreshold:.5,maxOpacity:.9})),P=I(()=>t(H)==="singing"?{userPitch:me.state.currentPitch?{frequency:me.state.currentPitch.frequency,midi:me.state.currentPitch.midi,clarity:me.state.currentPitch.clarity,pitchClass:me.state.currentPitch.pitchClass}:null,pitchHistory:[],targetNotes:[],pixelsPerSecond:200,timeWindowMs:4e3,trailConfig:t(L)}:void 0),E=I(()=>t(H)==="highway"?{userPitch:me.state.currentPitch?{frequency:me.state.currentPitch.frequency,midi:me.state.currentPitch.midi,clarity:me.state.currentPitch.clarity,pitchClass:me.state.currentPitch.pitchClass}:null,pitchHistory:[],targetNotes:ne(),nowLineX:fe.state.nowLineX,pixelsPerSecond:fe.state.pixelsPerSecond,currentTimeMs:fe.state.currentTimeMs,timeWindowMs:fe.state.timeWindowMs,trailConfig:t(L)}:void 0),Y=I(()=>({startRow:t(D).startRow,endRow:t(D).endRow,zoomLevel:1,containerWidth:t(a),containerHeight:t(o)}));function $(){if(!t(s))return;const J=window.devicePixelRatio||1;t(s).width=t(x)*J,t(s).height=t(o)*J,t(s).style.width=`${t(x)}px`,t(s).style.height=`${t(o)}px`,t(s).style.left=`${t(T)}px`;const te=t(s).getContext("2d");if(!te){A(r,null);return}te.setTransform(J,0,0,J,0,0),A(r,te,!0)}function se(){if(!t(r)||t(x)<=0)return;t(r).clearRect(0,0,t(x),t(o));const J=me.state.history;if(J.length===0)return;const te=t(H)==="singing"?t(P):t(E);if(!te)return;const be=M(),Te=be?performance.now():0,Ae=t(H)==="highway"&&t(E)?t(E).nowLineX:100,Re=Nn({cellHeight:t(D).cellHeight,viewport:t(Y),pixelsPerSecond:te.pixelsPerSecond??200,nowLineX:Ae,currentTimeMs:t(H)==="highway"&&t(E)?t(E).currentTimeMs:0}),re={cellHeight:t(D).cellHeight,viewportWidth:t(x),nowLineX:Ae,pixelsPerSecond:te.pixelsPerSecond??200,timeWindowMs:te.timeWindowMs??4e3,colorMode:"color",trailConfig:t(L)},ue=performance.now();if(On(t(r),Re,J,ue,re,t(k)),be){const z=performance.now();if(d+=1,v+=z-Te,z-l>=1e3){const ae=d>0?v/d:0;console.log(`[SingingTrail] points=${J.length} avgMs=${ae.toFixed(2)} gridWidth=${t(x)}`),l=z,d=0,v=0}}}function oe(){if(t(c))return;const J=()=>{se(),A(c,requestAnimationFrame(J),!0)};A(c,requestAnimationFrame(J),!0)}function le(){t(c)&&(cancelAnimationFrame(t(c)),A(c,null)),t(r)&&t(x)>0&&t(r).clearRect(0,0,t(x),t(o))}De(()=>{if(!t(i))return;const J=new ResizeObserver(te=>{for(const be of te)A(a,be.contentRect.width,!0),A(o,be.contentRect.height,!0)});return J.observe(t(i)),()=>{J.disconnect()}}),De(()=>{t(x),t(o),t(T),t(s),$()}),De(()=>{t(H),t(r),t(H)==="singing"||t(H)==="highway"?oe():le()}),$e(()=>{le()});var ge=Ta(),ce=u(ge);oa(ce,{get mode(){return t(H)},get fullRowData(){return t(k)},get viewport(){return t(Y)},cellWidth:f,get cellHeight(){return t(D).cellHeight},colorMode:"color",showOctaveLabels:h,showFrequencyLabels:b,get showRightLegend(){return t(m)},get singingConfig(){return t(P)},get highwayConfig(){return t(E)},get legendHighlight(){return t(U)},get beatIntervalMs(){return t(F)},beatTimeOffsetMs:W});var he=y(ce,2);Be(he,J=>A(s,J),()=>t(s)),Be(ge,J=>A(i,J),()=>t(i)),R(e,ge),Me()}const ka=440,Ra=69,dn=100,ht=12;function Ia(e){return ka*Math.pow(2,(e-Ra)/ht)}function un(e){return(Math.round(e)%ht+ht)%ht}class Aa{synth=null;scheduledTimeouts=[];volume=null;startTime=0;_isPlaying=!1;get isPlaying(){return this._isPlaying}async init(){await bt(),this.volume=new yi(-12).toDestination(),this.synth=new Sn({oscillator:{type:"triangle"},envelope:{attack:.05,decay:.1,sustain:.9,release:.1}}).connect(this.volume)}setVolume(n){this.volume&&(this.volume.volume.value=n)}scheduleReferenceTones(n){if(!this.synth){console.warn("[ReferenceAudio] Synth not initialized");return}this.clearScheduled(),this.startTime=performance.now(),n.forEach(i=>{const a=i.durationMs/1e3,o=zt(i.midi,"midi").toFrequency(),s=window.setTimeout(()=>{this.synth&&(console.log(`[ReferenceAudio] Playing ${i.midi} at ${performance.now()-this.startTime}ms`),this._isPlaying=!0,this.synth.triggerAttackRelease(o,a))},i.startTimeMs),r=window.setTimeout(()=>{this._isPlaying=!1},i.startTimeMs+i.durationMs);this.scheduledTimeouts.push(s,r)}),console.log(`[ReferenceAudio] Scheduled ${n.length} reference tones`)}playTone(n,i){if(!this.synth){console.warn("[ReferenceAudio] Synth not initialized");return}const a=zt(n,"midi").toFrequency(),o=i/1e3;this.synth.triggerAttackRelease(a,o)}clearScheduled(){this.scheduledTimeouts.forEach(n=>{window.clearTimeout(n)}),this.scheduledTimeouts=[]}stop(){this.clearScheduled(),this.synth&&this.synth.triggerRelease()}dispose(){this.stop(),this.synth&&(this.synth.dispose(),this.synth=null),this.volume&&(this.volume.dispose(),this.volume=null)}}const tt=new Aa,Ee={FFT_SIZE:2048,CLARITY_THRESHOLD:.8,MIN_PITCH_HZ:60,MAX_PITCH_HZ:1600,HIGHLIGHT_CORE_CENTS:25,HIGHLIGHT_CROSSFADE_CENTS:50};let Ke=null,Ze=null,mt=null,Ue=null,pt=!1;const Ht=1;function jn(e){return 12*Math.log2(e/440)+69}function Lt(){if(!pt||!Ze||!mt){Ue=null;return}if(tt.isPlaying){me.addHistoryPoint({frequency:0,midi:0,time:performance.now(),clarity:0}),Ue=requestAnimationFrame(Lt);return}const e=Ze.getValue(),[n,i]=mt.findPitch(e,kn().sampleRate),a=n!==null&&i>Ee.CLARITY_THRESHOLD&&n>Ee.MIN_PITCH_HZ&&n<Ee.MAX_PITCH_HZ;if(a){const o=jn(n),s={frequency:n,midi:o,clarity:i,pitchClass:Math.round(o)%12};me.setCurrentPitch(s),me.addHistoryPoint({frequency:n,midi:o,time:performance.now(),clarity:i}),fe.recordPitchInput(o,i)}else me.addHistoryPoint({frequency:0,midi:0,time:performance.now(),clarity:0});if(a&&me.state.currentPitch){const o=me.state.currentPitch.midi,s=Math.floor(o),r=s+1,c=(o-s)*dn,l=Ee.HIGHLIGHT_CORE_CENTS,d=dn-Ee.HIGHLIGHT_CORE_CENTS;let v=0,f=0;if(c<=l)v=1;else if(c>=d)f=1;else{const b=(c-l)/Ee.HIGHLIGHT_CROSSFADE_CENTS;v=1-b,f=b}const h=[];v>0&&h.push({pitchClass:un(s),midi:s,opacity:v}),f>0&&h.push({pitchClass:un(r),midi:r,opacity:f}),me.setStablePitch({highlights:h,size:Ht})}else me.setStablePitch({highlights:[],size:Ht});Ue=requestAnimationFrame(Lt)}async function Na(){if(!pt){Ue!==null&&cancelAnimationFrame(Ue),Ke=new Tn,Ze=new xn("waveform",Ee.FFT_SIZE),mt=Rn.forFloat32Array(Ze.size);try{await bt(),await Ke.open(),Ke.connect(Ze),pt=!0,Lt()}catch(e){throw console.error("Microphone access denied or failed:",e),qn(),e}}}function Da(){pt=!1,qn()}function qn(){Ue!==null&&(cancelAnimationFrame(Ue),Ue=null),Ke&&(Ke.close(),Ke=null),Ze=null,mt=null,me.setStablePitch({highlights:[],size:Ht}),me.setCurrentPitch(null)}async function Ha(e,n){const i=[],a=new Tn,o=new xn("waveform",Ee.FFT_SIZE),s=Rn.forFloat32Array(o.size);try{await bt(),await a.open(),a.connect(o)}catch(c){throw console.error("[collectPitchSamples] Microphone access failed:",c),c}const r=performance.now();return new Promise(c=>{let l=null;function d(){const v=performance.now()-r;if(v>=e){l!==null&&cancelAnimationFrame(l),a.close(),c(i);return}const f=o.getValue(),[h,b]=s.findPitch(f,kn().sampleRate),m=h!==null&&b>Ee.CLARITY_THRESHOLD&&h>Ee.MIN_PITCH_HZ&&h<Ee.MAX_PITCH_HZ;let g=null;m&&(g={midi:jn(h),frequency:h,clarity:b,timestamp:performance.now()},i.push(g)),n?.(v,g),l=requestAnimationFrame(d)}l=requestAnimationFrame(d)})}Se(["click"]);let Oe=null,ot=!1,rt=null;function La(){if(!Oe){Oe=new bi(Sn,{oscillator:{type:"sawtooth"},envelope:{attack:.3,decay:.1,sustain:.8,release:.5}}).toDestination();const e=Oe.get().oscillator?.type??"unknown";console.log("[DroneAudio] Initialized drone synth",{oscillatorType:e})}return Oe}function Un(e,n){return`${e.replace("b","#").replace("Db","C#").replace("Eb","D#").replace("Gb","F#").replace("Ab","G#").replace("Bb","A#")}${n}`}async function Ea(){await bt();const e=La(),n=Un(ee.state.tonic,ee.state.drone.octave);e.volume.value=ee.state.drone.volume,console.log("[DroneAudio] Starting drone",{note:n,volume:e.volume.value}),rt&&e.releaseAll(),rt=n,e.triggerAttack(n),ot=!0}function Oa(){Oe&&ot&&(Oe.releaseAll(),rt=null,ot=!1)}function Et(){if(!ot||!Oe)return;const e=Un(ee.state.tonic,ee.state.drone.octave);Oe.volume.value=ee.state.drone.volume,console.log("[DroneAudio] Updating drone",{note:e,volume:Oe.volume.value}),e!==rt&&(Oe.releaseAll(),Oe.triggerAttack(e),rt=e)}async function Fa(){ot?Oa():await Ea()}var Wa=N("<option> </option>"),Ba=N('<div class="tonic-selector svelte-3w4ray"><label for="tonic-select" class="svelte-3w4ray">Key:</label> <select id="tonic-select" class="svelte-3w4ray"></select></div>');function ja(e,n){_e(n,!1);const i=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function a(c){const l=c.target;ee.setTonic(l.value),Et()}Ot();var o=Ba(),s=y(u(o),2);s.__change=a,Ye(s,5,()=>i,Qe,(c,l)=>{var d=Wa(),v=u(d),f={};K(()=>{B(v,t(l)),f!==(f=t(l))&&(d.value=(d.__value=t(l))??"")}),R(c,d)});var r;Ft(s),K(()=>{r!==(r=ee.state.tonic)&&(s.value=(s.__value=ee.state.tonic)??"",wt(s,ee.state.tonic))}),R(e,o),Me()}Se(["change"]);var qa=N("<option> </option>"),Ua=N('<div class="drone-controls svelte-z4onaa"><button> </button> <div class="drone-settings svelte-z4onaa"><label class="svelte-z4onaa">Oct: <select class="svelte-z4onaa"></select></label> <label class="svelte-z4onaa">Vol: <input type="range" min="-40" max="0" class="svelte-z4onaa"/></label></div></div>');function Ga(e,n){_e(n,!1);const i=[2,3,4,5];async function a(){await Fa(),ee.toggleDrone()}function o(w){const p=w.target;ee.setDroneOctave(parseInt(p.value,10)),Et()}function s(w){const p=w.target;ee.setDroneVolume(parseInt(p.value,10)),Et()}Ot();var r=Ua(),c=u(r);let l;c.__click=a;var d=u(c),v=y(c,2),f=u(v),h=y(u(f));h.__change=o,Ye(h,5,()=>i,Qe,(w,p)=>{var _=qa(),C=u(_),x={};K(()=>{B(C,t(p)),x!==(x=t(p))&&(_.value=(_.__value=t(p))??"")}),R(w,_)});var b;Ft(h);var m=y(f,2),g=y(u(m));g.__input=s,K(()=>{l=Ve(c,1,"drone-toggle svelte-z4onaa",null,l,{active:ee.state.drone.isPlaying}),B(d,ee.state.drone.isPlaying?"Drone On":"Drone Off"),b!==(b=ee.state.drone.octave)&&(h.value=(h.__value=ee.state.drone.octave)??"",wt(h,ee.state.drone.octave)),ri(g,ee.state.drone.volume)}),R(e,r),Me()}Se(["click","change","input"]);Se(["click"]);var Ya=N('<div class="pitch-wheel-option svelte-i0c5ty"> </div>'),Va=N('<div class="pitch-wheel svelte-i0c5ty" role="slider" tabindex="0" aria-valuemin="0"><div class="pitch-wheel-viewport svelte-i0c5ty"><div class="pitch-wheel-options svelte-i0c5ty"></div></div> <div class="pitch-wheel-overlay svelte-i0c5ty"></div></div>');function fn(e,n){_e(n,!0);let i=ye(n,"selectedIndex",15),a=ye(n,"ariaLabel",3,"Pitch selector");const o=40,s=o;let r=X(void 0),c=X(void 0),l=X(void 0),d=X(!1),v=X(null),f=X(0),h=X(0),b=X(o);const m=I(()=>n.options.map((P,E)=>Math.min(Math.abs(E-i()),3))),g=I(()=>t(c)?.clientHeight??0),w=I(()=>Math.max(0,(t(g)-t(b))/2)),p=I(()=>t(w)+i()*t(b)+t(b)/2),_=I(()=>t(g)>0?t(g)/2-t(p):0);function C(P){if(!n.options||n.options.length===0)return;let E=P;typeof n.onbeforechange=="function"&&(E=n.onbeforechange(P));const Y=Math.max(0,Math.min(n.options.length-1,E));if(Y!==i()&&(i(Y),typeof n.onchange=="function")){const $=n.options[Y];$&&n.onchange(Y,$)}}function x(P){P!==0&&C(i()+P)}function T(P){P.preventDefault(),P.stopPropagation();const E=Math.sign(P.deltaY);E!==0&&x(E)}function M(P){P.key==="ArrowUp"?(P.preventDefault(),x(-1)):P.key==="ArrowDown"?(P.preventDefault(),x(1)):P.key==="Home"?(P.preventDefault(),C(0)):P.key==="End"&&(P.preventDefault(),C(n.options.length-1))}function k(P){if(P.preventDefault(),A(d,!0),A(v,P.pointerId,!0),A(f,P.clientY,!0),A(h,0),t(r)&&typeof t(r).setPointerCapture=="function")try{t(r).setPointerCapture(P.pointerId)}catch{}}function D(P){if(!t(d)||P.pointerId!==t(v))return;const E=P.clientY-t(f);if(A(f,P.clientY,!0),E===0)return;A(h,t(h)+E);const Y=t(b)||s;for(;Math.abs(t(h))>=Y;){const $=-Math.sign(t(h));x($),A(h,t(h)-Math.sign(t(h))*Y)}}function H(P){t(d)&&P.pointerId===t(v)&&(A(d,!1),A(v,null),A(h,0),t(r)?.hasPointerCapture?.(P.pointerId)&&t(r).releasePointerCapture(P.pointerId))}De(()=>{if(!t(l)||!t(c))return;const P=()=>{const Y=t(l)?.querySelector(".pitch-wheel-option");Y&&A(b,Y.offsetHeight||o,!0)};P();const E=new ResizeObserver(()=>{P()});return E.observe(t(c)),()=>{E.disconnect()}});var F=Va();F.__keydown=M,F.__pointerdown=k,F.__pointermove=D,F.__pointerup=H;let W;var U=u(F),ne=u(U);let L;Ye(ne,23,()=>n.options,P=>P.index,(P,E,Y)=>{var $=Ya(),se=u($);K(()=>{Ge($,"data-distance",t(m)[t(Y)]),B(se,t(E).label)}),R(P,$)}),Be(ne,P=>A(l,P),()=>t(l)),Be(U,P=>A(c,P),()=>t(c)),Be(F,P=>A(r,P),()=>t(r)),K(()=>{Ge(F,"aria-label",a()),Ge(F,"aria-valuemax",n.options.length-1),Ge(F,"aria-valuenow",i()),Ge(F,"aria-valuetext",n.options[i()]?.label??""),W=Je(F,"",W,{height:n.wheelHeight?`${n.wheelHeight}px`:"100%"}),L=Je(ne,"",L,{"padding-top":`${t(w)??""}px`,"padding-bottom":`${t(w)??""}px`,transform:`translateY(${t(_)??""}px)`})}),it("wheel",F,T),it("pointercancel",F,H),it("pointerleave",F,H),R(e,F),Me()}Se(["keydown","pointerdown","pointermove","pointerup"]);var za=N('<button type="button"> </button>'),Xa=N('<div class="preset-buttons svelte-s7fyen"></div>');function Ka(e,n){_e(n,!0);function i(o){n.onPresetClick(o)}var a=Xa();Ye(a,21,()=>n.presets,Qe,(o,s)=>{var r=za();let c;r.__click=()=>i(t(s));var l=u(r);K(()=>{c=Ve(r,1,"preset-button svelte-s7fyen",null,c,{active:n.activePreset===t(s).label}),B(l,t(s).label)}),R(o,r)}),R(e,a),Me()}Se(["click"]);const Gn=7;function yt(e,n,i){return Number.isFinite(e)?Math.max(n,Math.min(i,Math.round(e))):n}function Za(e,n,i,a=Gn){const o=Math.max(0,i-1),s=yt(e,0,o),r=Math.max(1,Math.round(a)),c=Math.max(0,s-(r-1));return yt(n,0,c)}function Ja(e,n,i,a=Gn){const o=Math.max(0,i-1),s=yt(e,0,o),r=Math.max(1,Math.round(a)),c=Math.min(o,s+(r-1));return yt(n,c,o)}function Qa(e){return e.map((n,i)=>({index:i,label:n.pitch,midi:n.midi,toneNote:n.toneNote,frequency:n.frequency}))}function ze(e,n){const i=e.findIndex(a=>a.midi===n);return i>=0?i:0}function $a(e){return[{label:"Voice I",topIndex:ze(e,81),bottomIndex:ze(e,57)},{label:"Voice II",topIndex:ze(e,72),bottomIndex:ze(e,48)},{label:"Voice III",topIndex:ze(e,64),bottomIndex:ze(e,40)}]}var es=N('<div class="summary-card svelte-s4iox0"><div class="summary-label svelte-s4iox0"> </div> <div class="summary-metadata svelte-s4iox0"> </div></div>'),ts=N('<div class="dual-pitch-wheel svelte-s4iox0"><div class="wheels-container svelte-s4iox0"><div class="wheel-column svelte-s4iox0"><div class="wheel-label svelte-s4iox0">High</div> <!></div> <div class="wheel-column svelte-s4iox0"><div class="wheel-label svelte-s4iox0">Low</div> <!></div></div> <!> <!></div>');function ns(e,n){_e(n,!0);let i=ye(n,"topIndex",15),a=ye(n,"bottomIndex",15),o=ye(n,"minSpan",3,7),s=ye(n,"showSummary",3,!0),r=ye(n,"showPresets",3,!1);const c=I(()=>Qa(n.fullRowData)),l=I(()=>({topIndex:i(),bottomIndex:a(),topPitch:n.fullRowData[i()],bottomPitch:n.fullRowData[a()],span:a()-i()+1})),d=I(()=>t(l).topPitch&&t(l).bottomPitch?`${t(l).topPitch.pitch} â€“ ${t(l).bottomPitch.pitch}`:""),v=I(()=>`${t(l).span} ${t(l).span===1?"pitch":"pitches"}`),f=I(()=>!n.presets||n.presets.length===0?void 0:n.presets.find(U=>U.topIndex===i()&&U.bottomIndex===a())?.label);function h(W){return Za(a(),W,t(c).length,o())}function b(W){return Ja(i(),W,t(c).length,o())}function m(W,U){i(W),typeof n.onrangechange=="function"&&n.onrangechange(t(l))}function g(W,U){a(W),typeof n.onrangechange=="function"&&n.onrangechange(t(l))}function w(W){i(W.topIndex),a(W.bottomIndex),typeof n.onrangechange=="function"&&n.onrangechange(t(l))}var p=ts(),_=u(p),C=u(_),x=y(u(C),2);fn(x,{get options(){return t(c)},get selectedIndex(){return i()},onchange:m,onbeforechange:h,get wheelHeight(){return n.wheelHeight},ariaLabel:"High pitch selector"});var T=y(C,2),M=y(u(T),2);fn(M,{get options(){return t(c)},get selectedIndex(){return a()},onchange:g,onbeforechange:b,get wheelHeight(){return n.wheelHeight},ariaLabel:"Low pitch selector"});var k=y(_,2);{var D=W=>{var U=es(),ne=u(U),L=u(ne),P=y(ne,2),E=u(P);K(()=>{B(L,t(d)),B(E,t(v))}),R(W,U)};G(k,W=>{s()&&W(D)})}var H=y(k,2);{var F=W=>{Ka(W,{get presets(){return n.presets},get activePreset(){return t(f)},onPresetClick:w})};G(H,W=>{r()&&n.presets&&n.presets.length>0&&W(F)})}R(e,p),Me()}Se(["change"]);var is=N('<div class="range-control svelte-150ksck"><h3 class="control-title svelte-150ksck">Pitch Range</h3> <!></div>');function as(e,n){_e(n,!0);function i(d){const v=Pt.findIndex(f=>f.midi===d);return v>=0?v:0}const a=I(()=>i(ee.state.yAxisRange.maxMidi)),o=I(()=>i(ee.state.yAxisRange.minMidi)),s=$a(Pt);function r(d){const v=d.bottomPitch.midi??21,f=d.topPitch.midi??108;ee.setYAxisRange({minMidi:v,maxMidi:f})}var c=is(),l=y(u(c),2);ns(l,{get fullRowData(){return Pt},get topIndex(){return t(a)},get bottomIndex(){return t(o)},minSpan:7,onrangechange:r,showSummary:!0,wheelHeight:200,get presets(){return s},showPresets:!0}),R(e,c),Me()}var ss=N('<div class="pitch-highlight-toggle svelte-1v98ldk"><span class="toggle-label svelte-1v98ldk">Pitch Highlight</span> <button> </button></div>');function os(e,n){_e(n,!1);function i(){ee.togglePitchHighlight()}Ot();var a=ss(),o=y(u(a),2);let s;o.__click=i;var r=u(o);K(()=>{s=Ve(o,1,"toggle-button svelte-1v98ldk",null,s,{active:ee.state.pitchHighlightEnabled}),B(r,ee.state.pitchHighlightEnabled?"On":"Off")}),R(e,a),Me()}Se(["click"]);const hn={isVisible:!1,summary:null,songTitle:"",artistName:"",source:null},rs={totalNotes:0,notesHit:0,notesMissed:0,accuracyPercent:0,goldenNotesHit:0,goldenNotesTotal:0,phraseResults:[],averagePitchDeviationCents:0};function ls(){let e=X(Fe({...hn}));return{get state(){return t(e)},show(n,i={}){t(e).summary=n,t(e).songTitle=i.title||"",t(e).artistName=i.artist||"",t(e).source=i.source||null,t(e).isVisible=!0},hide(){t(e).isVisible=!1},clear(){A(e,{...hn},!0)},calculateSummary(n,i){if(i.length===0)return{...rs};let a=0,o=0,s=0,r=0,c=0;const l=new Map;i.forEach((m,g)=>{const w=`target-${g}`,p=n.get(w),_=m.isGolden===!0,C=m.phraseIndex??0;_&&s++,l.has(C)||l.set(C,{hit:0,total:0,lyrics:[]});const x=l.get(C);x.total++,m.lyric&&x.lyrics.push(m.lyric),p?.hitStatus==="hit"&&(a++,x.hit++,_&&o++,typeof p.pitchAccuracyCents=="number"&&(r+=Math.abs(p.pitchAccuracyCents),c++))});const d=i.length,v=d-a,f=d>0?a/d*100:0,h=c>0?r/c:0,b=[];return l.forEach((m,g)=>{b.push({phraseIndex:g,notesHit:m.hit,totalNotes:m.total,accuracyPercent:m.total>0?m.hit/m.total*100:0,lyricPreview:m.lyrics.join("").trim().slice(0,30)||`Phrase ${g+1}`})}),b.sort((m,g)=>m.phraseIndex-g.phraseIndex),{totalNotes:d,notesHit:a,notesMissed:v,accuracyPercent:f,goldenNotesHit:o,goldenNotesTotal:s,phraseResults:b,averagePitchDeviationCents:h}},getLetterGrade(n){return n>=95?"S":n>=90?"A":n>=80?"B":n>=70?"C":n>=60?"D":"F"},getAccuracyColor(n){return n>=90?"var(--color-success, #28a745)":n>=70?"var(--color-warning, #ffc107)":"var(--color-error, #dc3545)"}}}const Ne=ls();var cs=N(`<select class="setting-input svelte-16rxcxh"><option>Don't use</option><option> </option><option> </option></select>`),ds=N('<span class="not-calibrated svelte-16rxcxh">Not calibrated</span>'),us=N('<button class="start-exercise-btn svelte-16rxcxh">Start Demo Exercise</button>'),fs=N('<button class="stop-exercise-btn svelte-16rxcxh">Stop Exercise</button> <div class="progress-indicator svelte-16rxcxh"> </div> <div class="phase-indicator svelte-16rxcxh"> </div>',1),hs=N('<div><span class="result-loop svelte-16rxcxh"></span> <span class="result-pitch svelte-16rxcxh"> </span> <span class="result-accuracy svelte-16rxcxh"> </span> <span class="result-status svelte-16rxcxh"> </span></div>'),vs=N('<div class="exercise-results svelte-16rxcxh"><h4 class="results-title svelte-16rxcxh">Results</h4> <div class="results-summary svelte-16rxcxh"><div class="stat svelte-16rxcxh"><span class="stat-label svelte-16rxcxh">Average Accuracy:</span> <span class="stat-value svelte-16rxcxh"> </span></div> <div class="stat svelte-16rxcxh"><span class="stat-label svelte-16rxcxh">Hits:</span> <span class="stat-value svelte-16rxcxh"> </span></div></div> <details class="results-details svelte-16rxcxh"><summary class="results-summary-label svelte-16rxcxh">Detailed Results</summary> <div class="results-list svelte-16rxcxh"></div></details></div>'),gs=N('<div class="demo-exercise-panel svelte-16rxcxh"><h3 class="panel-title svelte-16rxcxh">Demo Exercise</h3> <details class="settings-details svelte-16rxcxh"><summary class="settings-summary svelte-16rxcxh">Settings</summary> <div class="exercise-settings svelte-16rxcxh"><label class="setting-label svelte-16rxcxh"><span class="label-text svelte-16rxcxh">Number of loops:</span> <input class="setting-input svelte-16rxcxh" type="number" min="1" max="20"/></label> <label class="setting-label svelte-16rxcxh"><span class="label-text svelte-16rxcxh">Tempo (BPM):</span> <input class="setting-input svelte-16rxcxh" type="number" min="60" max="180"/></label> <label class="setting-label svelte-16rxcxh"><span class="label-text svelte-16rxcxh">Reference Volume:</span> <input class="setting-slider svelte-16rxcxh" type="range" min="-40" max="0"/> <span class="volume-value svelte-16rxcxh"> </span></label> <div class="pitch-range-buttons svelte-16rxcxh"><button class="range-btn svelte-16rxcxh">Use Current Range</button> <button class="range-btn svelte-16rxcxh">Use Full Range</button></div> <label class="setting-label svelte-16rxcxh"><span class="label-text svelte-16rxcxh">Speaking Pitch:</span> <!></label></div></details> <div class="exercise-controls svelte-16rxcxh"><!></div> <!></div>');function ms(e,n){_e(n,!0);let i=X(!1),a=X(5),o=X(108),s=X(-12),r=X("none");const c=I(()=>Le.isCalibrated),l=I(()=>Le.speakingPitchNoteName);let d=X(!1),v=null;const f=I(()=>de.state.isActive),h=I(()=>de.state.isPlaying),b=I(()=>de.state.currentPhase),m=I(()=>de.getCurrentProgress()),g=I(()=>de.getResults()),w=I(()=>t(g).length>0),p=I(()=>de.getAverageAccuracy()),_=I(()=>de.getHitCount()),C=I(()=>t(g).length);De(()=>{if(!t(f)||!t(h))return;const O=fe.state.currentTimeMs;de.updatePhase(O)}),De(()=>{de.state.restartRequested&&!t(f)&&(de.consumeRestartRequest(),U())});function x(){console.log("[DemoExercise] Starting results polling"),v=setInterval(()=>{M(),k()},200)}function T(){v&&(clearInterval(v),v=null)}function M(){const O=fe.getPerformanceResults(),j=de.getGeneratedNotes();console.log("[DemoExercise] collectResults:",{performanceCount:O.size,notesCount:j.length,currentResults:de.state.results.length}),j.forEach((ie,Z)=>{if(ie.lyric!=="ðŸŽ¤")return;const we=`target-${Z}`,Ce=O.get(we);if(Ce&&!de.hasResultForLoop(Math.floor(Z/2))){const pe=H(Ce);console.log("[DemoExercise] Adding result for loop",Math.floor(Z/2),{noteId:we,accuracy:pe}),de.addResult({loopIndex:Math.floor(Z/2),targetPitch:ie.midi,accuracy:pe,performance:Ce})}})}function k(){const O=de.state.results.length,j=de.state.config.numLoops;console.log("[DemoExercise] checkCompletion:",{completedLoops:O,totalLoops:j,completionTriggered:t(d)}),O>=j&&j>0&&!t(d)&&(console.log("[DemoExercise] Exercise complete! Showing results modal"),A(d,!0),D())}function D(){ne(),fe.reset();const O=de.getResults(),j=O.filter(pe=>pe.performance?.hitStatus==="hit").length,ie=O.length;let Z=0,we=0;O.forEach(pe=>{pe.performance?.hitStatus==="hit"&&typeof pe.performance.pitchAccuracyCents=="number"&&(Z+=Math.abs(pe.performance.pitchAccuracyCents),we++)});const Ce={totalNotes:ie,notesHit:j,notesMissed:ie-j,accuracyPercent:ie>0?j/ie*100:0,goldenNotesHit:0,goldenNotesTotal:0,phraseResults:O.map((pe,je)=>({phraseIndex:je,notesHit:pe.performance?.hitStatus==="hit"?1:0,totalNotes:1,accuracyPercent:pe.accuracy,lyricPreview:`Loop ${je+1}: ${P(pe.targetPitch)}`})),averagePitchDeviationCents:we>0?Z/we:0};Ne.show(Ce,{title:"Pitch Matching Exercise",source:"demo"})}function H(O){return O.hitStatus==="hit"?O.pitchAccuracyCents!==void 0?Math.max(0,100-Math.abs(O.pitchAccuracyCents)/50*100):100:0}$e(()=>{T(),t(f)&&ne()});function F(){const O=ee.state.yAxisRange;de.setPitchRange(O.minMidi,O.maxMidi)}function W(){de.setPitchRange(21,108)}async function U(){ee.setVisualizationMode("highway"),de.configure({numLoops:t(a),tempo:t(o),referenceVolume:t(s),speakingPitchUsage:t(r)}),F(),await tt.init(),tt.setVolume(t(s)),de.start();const O=de.getGeneratedNotes();fe.setTargetNotes(O),fe.start(),de.setPlaying(!0),x();const j=O.filter(ie=>ie.lyric==="ðŸ‘‚");tt.scheduleReferenceTones(j)}function ne(){T(),A(d,!1),tt.stop(),fe.stop(),de.stop()}function L(O){switch(O){case"reference":return"ðŸ‘‚ Listen";case"input":return"ðŸŽ¤ Sing";default:return"Rest"}}function P(O){return hi(O)?.pitch||`MIDI ${O}`}var E=gs(),Y=y(u(E),2),$=y(u(Y),2),se=u($),oe=y(u(se),2),le=y(se,2),ge=y(u(le),2),ce=y(le,2),he=y(u(ce),2),J=y(he,2),te=u(J),be=y(ce,2),Te=u(be);Te.__click=F;var Ae=y(Te,2);Ae.__click=W;var Re=y(be,2),re=y(u(Re),2);{var ue=O=>{var j=cs(),ie=u(j);ie.value=ie.__value="none";var Z=y(ie),we=u(Z);Z.value=Z.__value="asFloorNote";var Ce=y(Z),pe=u(Ce);Ce.value=Ce.__value="asTonic",K(()=>{j.disabled=t(f),B(we,`As lowest note (${t(l)??""})`),B(pe,`As center (${t(l)??""})`)}),wi(j,()=>t(r),je=>A(r,je)),R(O,j)},z=O=>{var j=ds();R(O,j)};G(re,O=>{t(c)?O(ue):O(z,!1)})}var ae=y(Y,2),S=u(ae);{var q=O=>{var j=us();j.__click=U,R(O,j)},V=O=>{var j=fs(),ie=Ie(j);ie.__click=ne;var Z=y(ie,2),we=u(Z),Ce=y(Z,2),pe=u(Ce);K(je=>{B(we,`Loop ${t(m).current??""} / ${t(m).total??""}`),B(pe,je)},[()=>L(t(b))]),R(O,j)};G(S,O=>{t(f)?O(V,!1):O(q)})}var ve=y(ae,2);{var Pe=O=>{var j=vs(),ie=y(u(j),2),Z=u(ie),we=y(u(Z),2),Ce=u(we),pe=y(Z,2),je=y(u(pe),2),Yn=u(je),Vn=y(ie,2),zn=y(u(Vn),2);Ye(zn,21,()=>t(g),Qe,(_t,lt,Xn)=>{var Mt=hs();let qt;var Ut=u(Mt);Ut.textContent=`Loop ${Xn+1}:`;var Gt=y(Ut,2),Kn=u(Gt),Yt=y(Gt,2),Zn=u(Yt),Jn=y(Yt,2),Qn=u(Jn);K(($n,ei)=>{qt=Ve(Mt,1,"result-item svelte-16rxcxh",null,qt,{hit:t(lt).performance?.hitStatus==="hit"}),B(Kn,$n),B(Zn,`${ei??""}%`),B(Qn,t(lt).performance?.hitStatus==="hit"?"âœ“":"âœ—")},[()=>P(t(lt).targetPitch),()=>t(lt).accuracy.toFixed(0)]),R(_t,Mt)}),K(_t=>{B(Ce,`${_t??""}%`),B(Yn,`${t(_)??""}/${t(C)??""}`)},[()=>t(p).toFixed(1)]),R(O,j)};G(ve,O=>{t(w)&&!t(f)&&O(Pe)})}K(()=>{oe.disabled=t(f),ge.disabled=t(f),he.disabled=t(f),B(te,`${t(s)??""} dB`),Te.disabled=t(f),Ae.disabled=t(f)}),Ct(oe,()=>t(a),O=>A(a,O)),Ct(ge,()=>t(o),O=>A(o,O)),Ct(he,()=>t(s),O=>A(s,O)),In("open","toggle",Y,O=>A(i,O),()=>t(i)),R(e,E),Me()}Se(["click"]);const ps=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,/^([a-zA-Z0-9_-]{11})$/],ys={gapMs:0,videoGapSec:0,manualOffsetSec:0},jt=60;function bs(e){try{const n=e.split(/\r?\n/).map(r=>r.trim()),i=ws(n);if(!i.bpm)return{success:!1,error:"Missing required #BPM tag"};const{notes:a,lineBreaks:o,totalBeats:s}=_s(n);return a.length===0?{success:!1,error:"No valid notes found in file"}:{success:!0,song:{metadata:i,notes:a,lineBreaks:o,totalBeats:s}}}catch(n){return{success:!1,error:n instanceof Error?n.message:"Unknown parsing error"}}}function ws(e){const n={};for(const i of e){if(!i.startsWith("#"))continue;const a=i.indexOf(":");if(a===-1)continue;const o=i.slice(1,a).toUpperCase().trim(),s=i.slice(a+1).trim();switch(o){case"TITLE":n.title=s;break;case"ARTIST":n.artist=s;break;case"VIDEO":n.video=s;break;case"VIDEOGAP":n.videoGap=parseFloat(s.replace(",","."))||0;break;case"GAP":n.gap=parseFloat(s.replace(",","."))||0;break;case"BPM":n.bpm=parseFloat(s.replace(",","."))||0;break;case"MP3":case"AUDIO":n.mp3=s;break;case"LANGUAGE":n.language=s;break;case"GENRE":n.genre=s;break;case"YEAR":n.year=parseInt(s)||void 0;break;case"CREATOR":n.creator=s;break;case"COVER":n.cover=s;break;case"BACKGROUND":n.background=s;break;case"PREVIEWSTART":n.previewStart=parseFloat(s.replace(",","."))||0;break}}return{title:n.title||"Unknown Title",artist:n.artist||"Unknown Artist",bpm:n.bpm||0,...n}}function _s(e){const n=[],i=[];let a=0;for(const o of e){if(o.length===0||o.startsWith("#"))continue;const s=o[0];if(s==="E")break;if(s==="-"){const r=o.slice(1).trim().split(/\s+/),c=parseInt(r[0])||0;i.push(c);continue}if([":","*","F","R"].includes(s)){const r=Ms(o);if(r){n.push(r);const c=r.startBeat+r.duration;c>a&&(a=c)}}}return{notes:n,lineBreaks:i,totalBeats:a}}function Ms(e){const n=e[0],a=e.slice(1).trim().split(/\s+/);if(a.length<3)return null;const o=parseInt(a[0]),s=parseInt(a[1]),r=parseInt(a[2]),c=a.slice(3).join(" ")||"";return isNaN(o)||isNaN(s)||isNaN(r)?null:{type:n,startBeat:o,duration:s,pitch:r,lyric:c}}function Ps(e){if(!e)return null;const n=e.trim();for(const i of ps){const a=n.match(i);if(a&&a[1])return a[1]}return null}function vn(e,n=jt){const{metadata:i,notes:a,lineBreaks:o}=e,{bpm:s}=i,r=60/s*1e3*4;let c=0;const l=[...o].sort((v,f)=>v-f),d=a.length>0?Math.min(...a.map(v=>v.startBeat)):0;return a.filter(v=>v.type!=="F").map(v=>{const f=(v.startBeat-d)*r,h=v.duration*r,b=n+v.pitch;for(;c<l.length&&v.startBeat>=l[c];)c++;const m={midi:b,startTimeMs:f,durationMs:h,lyric:v.lyric.trim()||void 0};return v.type==="*"&&(m.isGolden=!0),m})}function Cs(e){return{gapMs:e.gap||0,videoGapSec:e.videoGap||0,manualOffsetSec:0}}function Ss(e){const{metadata:n,notes:i,totalBeats:a}=e,{bpm:o}=n,s=60/o*1e3*4,r=i.length>0?Math.min(...i.map(l=>l.startBeat)):0;return(a-r)*s+2e3}function gn(e,n=jt){const i=e.notes.filter(s=>s.type!=="F"&&s.type!=="-").map(s=>n+s.pitch);if(i.length===0)return{minMidi:48,maxMidi:72};const a=Math.min(...i),o=Math.max(...i);return{minMidi:Math.max(24,a-3),maxMidi:Math.min(108,o+3)}}const mn={isActive:!1,isLoading:!1,isPlaying:!1,song:null,targetNotes:[],youtubeId:null,syncConfig:{...ys},baseMidi:jt,totalDurationMs:0,detectedRange:{minMidi:48,maxMidi:72},error:null};function Ts(){let e=X(Fe({...mn})),n=null;return{get state(){return t(e)},async loadFile(i){t(e).isLoading=!0,t(e).error=null;try{const a=await i.text(),o=bs(a);if(!o.success)return t(e).error=o.error,t(e).isLoading=!1,!1;const s=o.song,r=s.metadata.video?Ps(s.metadata.video):null,c=Cs(s.metadata),l=vn(s,t(e).baseMidi),d=Ss(s),v=gn(s,t(e).baseMidi);return t(e).song=s,t(e).youtubeId=r,t(e).syncConfig=c,t(e).targetNotes=l,t(e).totalDurationMs=d,t(e).detectedRange=v,t(e).isActive=!0,t(e).isLoading=!1,!0}catch(a){return t(e).error=a instanceof Error?a.message:"Failed to load file",t(e).isLoading=!1,!1}},get youtubeOffset(){const{gapMs:i,videoGapSec:a,manualOffsetSec:o}=t(e).syncConfig;return i/1e3+a+o},adjustOffset(i){t(e).syncConfig={...t(e).syncConfig,manualOffsetSec:t(e).syncConfig.manualOffsetSec+i}},setManualOffset(i){t(e).syncConfig={...t(e).syncConfig,manualOffsetSec:i}},resetOffset(){t(e).syncConfig={...t(e).syncConfig,manualOffsetSec:0}},setBaseMidi(i){t(e).baseMidi=i,t(e).song&&(t(e).targetNotes=vn(t(e).song,i),t(e).detectedRange=gn(t(e).song,i))},setPlaying(i){t(e).isPlaying=i},onComplete(i){n=i},triggerComplete(){t(e).isPlaying=!1,n&&n()},checkCompletion(i){return!t(e).isPlaying||!t(e).isActive?!1:i>=t(e).totalDurationMs-500?(this.triggerComplete(),!0):!1},get title(){return t(e).song?.metadata.title||""},get artist(){return t(e).song?.metadata.artist||""},get hasVideo(){return t(e).youtubeId!==null},reset(){A(e,{...mn},!0),n=null},unload(){t(e).isActive=!1,t(e).isPlaying=!1,t(e).song=null,t(e).targetNotes=[],t(e).youtubeId=null,t(e).totalDurationMs=0,t(e).error=null}}}const Q=Ts();let ft=null,nt=!1;function xs(){return ft||(nt&&window.YT&&window.YT.Player?Promise.resolve():(ft=new Promise((e,n)=>{if(window.YT&&window.YT.Player){nt=!0,e();return}window.onYouTubeIframeAPIReady=()=>{nt=!0,e()};const i=document.createElement("script");i.src="https://www.youtube.com/iframe_api",i.async=!0,i.onerror=()=>{n(new Error("Failed to load YouTube IFrame API"))},document.head.appendChild(i),setTimeout(()=>{nt||n(new Error("YouTube IFrame API load timeout"))},1e4)}),ft))}function ks(e,n,i={}){if(!nt||!window.YT?.Player)throw new Error("YouTube API not loaded. Call loadYouTubeAPI() first.");const{width:a=320,height:o=180,onReady:s,onStateChange:r,onError:c}=i;return new window.YT.Player(e,{width:a,height:o,videoId:n,playerVars:{autoplay:0,controls:1,disablekb:1,enablejsapi:1,fs:0,modestbranding:1,origin:window.location.origin,playsinline:1,rel:0},events:{onReady:l=>{s?.(l.target)},onStateChange:l=>{r?.(l.data)},onError:l=>{c?.(l.data)}}})}function Rs(e){switch(e){case YT.PlayerError.InvalidParam:return"Invalid video ID";case YT.PlayerError.Html5Error:return"HTML5 player error";case YT.PlayerError.VideoNotFound:return"Video not found";case YT.PlayerError.NotAllowedEmbedded:case YT.PlayerError.NotAllowedEmbedded2:return"Video cannot be embedded";default:return"Unknown player error"}}const Rt={isApiLoaded:!1,isApiLoading:!1,isPlayerReady:!1,isPlaying:!1,currentTime:0,duration:0,videoId:null,error:null,isEmbeddable:!0,volume:100,isMuted:!1};function Is(){let e=X(Fe({...Rt})),n=null,i=null,a=null;return{get state(){return t(e)},async initAPI(){if(t(e).isApiLoaded)return!0;if(t(e).isApiLoading)return!1;t(e).isApiLoading=!0,t(e).error=null;try{return await xs(),t(e).isApiLoaded=!0,t(e).isApiLoading=!1,!0}catch(o){return t(e).error=o instanceof Error?o.message:"Failed to load YouTube API",t(e).isApiLoading=!1,!1}},async loadVideo(o,s){if(!t(e).isApiLoaded&&!await this.initAPI())return!1;if(n){try{n.destroy()}catch{}n=null}return t(e).isPlayerReady=!1,t(e).error=null,t(e).isEmbeddable=!0,t(e).videoId=o,new Promise(r=>{try{n=ks(s,o,{onReady:c=>{t(e).isPlayerReady=!0,t(e).duration=c.getDuration(),t(e).volume=c.getVolume(),t(e).isMuted=c.isMuted(),r(!0)},onStateChange:c=>{t(e).isPlaying=c===YT.PlayerState.PLAYING,c===YT.PlayerState.ENDED&&(t(e).isPlaying=!1,this.stopSyncLoop())},onError:c=>{t(e).error=Rs(c),t(e).isEmbeddable=c!==YT.PlayerError.NotAllowedEmbedded&&c!==YT.PlayerError.NotAllowedEmbedded2,t(e).isPlayerReady=!1,r(!1)}})}catch(c){t(e).error=c instanceof Error?c.message:"Failed to create player",r(!1)}})},play(){n&&t(e).isPlayerReady&&n.playVideo()},pause(){n&&t(e).isPlayerReady&&n.pauseVideo()},stop(){n&&t(e).isPlayerReady&&(n.stopVideo(),t(e).isPlaying=!1),this.stopSyncLoop()},seekTo(o){n&&t(e).isPlayerReady&&(n.seekTo(Math.max(0,o),!0),t(e).currentTime=Math.max(0,o))},getCurrentTime(){return n&&t(e).isPlayerReady?n.getCurrentTime():t(e).currentTime},setVolume(o){const s=Math.max(0,Math.min(100,o));n&&t(e).isPlayerReady&&n.setVolume(s),t(e).volume=s},mute(){n&&t(e).isPlayerReady&&n.mute(),t(e).isMuted=!0},unmute(){n&&t(e).isPlayerReady&&n.unMute(),t(e).isMuted=!1},toggleMute(){t(e).isMuted?this.unmute():this.mute()},startSyncLoop(o,s=250){a=o,i!==null&&clearInterval(i),i=window.setInterval(()=>{if(n&&t(e).isPlayerReady&&t(e).isPlaying){const r=n.getCurrentTime();t(e).currentTime=r,a?.(r)}},s)},stopSyncLoop(){i!==null&&(clearInterval(i),i=null),a=null},correctDrift(o,s=150){if(!n||!t(e).isPlayerReady||!t(e).isPlaying)return!1;const r=n.getCurrentTime();return Math.abs(r-o)*1e3>s?(n.seekTo(o,!0),!0):!1},getVideoUrl(){return t(e).videoId?`https://www.youtube.com/watch?v=${t(e).videoId}`:null},dispose(){if(this.stopSyncLoop(),n){try{n.destroy()}catch{}n=null}A(e,{...Rt,isApiLoaded:t(e).isApiLoaded},!0)},reset(){this.dispose(),A(e,{...Rt},!0)}}}const xe=Is();function As(e){let n={...e.syncConfig};const i=e.driftCheckIntervalMs??250,a=e.maxDriftMs??150;function o(){return n.gapMs/1e3+n.videoGapSec+n.manualOffsetSec}function s(g){return g/1e3+o()}function r(g){return(g-o())*1e3}function c(g,w){const p=s(g),_=w-p,C=Math.abs(_*1e3);if(C>a){const x=r(w);return{driftMs:C,needsCorrection:!0,correctedTransportTimeMs:x}}return{driftMs:C,needsCorrection:!1}}function l(g){n={...n,...g}}function d(g){n.manualOffsetSec+=g}function v(){n.manualOffsetSec=0}function f(){return n.manualOffsetSec}function h(){return o()}function b(){const g=n.manualOffsetSec;return`${g>=0?"+":""}${g.toFixed(2)}s`}function m(){return{intervalMs:i,maxDriftMs:a}}return{getYouTubeOffset:o,getTotalOffset:h,getManualOffset:f,getSyncLoopConfig:m,transportToYouTube:s,youTubeToTransport:r,checkDrift:c,updateConfig:l,adjustManualOffset:d,resetManualOffset:v,formatOffset:b,getConfig:()=>({...n})}}var Ns=N('<div class="youtube-loading svelte-1pmfeb3"><div class="spinner svelte-1pmfeb3"></div> <span>Loading video...</span></div>'),Ds=N('<button class="fallback-btn svelte-1pmfeb3">Open on YouTube â†—</button>'),Hs=N('<div class="youtube-error svelte-1pmfeb3"><span class="error-icon svelte-1pmfeb3">âš ï¸</span> <span class="error-message svelte-1pmfeb3"> </span> <!></div>'),Ls=N('<div class="youtube-placeholder svelte-1pmfeb3"><span class="placeholder-icon svelte-1pmfeb3">ðŸŽ¬</span> <span class="placeholder-text svelte-1pmfeb3">No video loaded</span></div>'),Es=N('<div class="youtube-container svelte-1pmfeb3"><div class="youtube-player svelte-1pmfeb3"></div> <!> <!> <!></div>');function Os(e,n){_e(n,!0);const i=`youtube-player-${Math.random().toString(36).slice(2,9)}`,a=I(()=>xe.state.isApiLoading||xe.state.videoId&&!xe.state.isPlayerReady),o=I(()=>!!xe.state.error),s=I(()=>xe.state.isEmbeddable),r=I(()=>Q.state.youtubeId);De(()=>{t(r)&&xe.loadVideo(t(r),i)}),$e(()=>{xe.dispose()});function c(){const w=xe.getVideoUrl();w&&window.open(w,"_blank","noopener,noreferrer")}var l=Es(),d=u(l),v=y(d,2);{var f=w=>{var p=Ns();R(w,p)};G(v,w=>{t(a)&&t(r)&&w(f)})}var h=y(v,2);{var b=w=>{var p=Hs(),_=y(u(p),2),C=u(_),x=y(_,2);{var T=M=>{var k=Ds();k.__click=c,R(M,k)};G(x,M=>{t(s)||M(T)})}K(()=>B(C,xe.state.error)),R(w,p)};G(h,w=>{t(o)&&w(b)})}var m=y(h,2);{var g=w=>{var p=Ls();R(w,p)};G(m,w=>{!t(r)&&!t(a)&&!t(o)&&w(g)})}K(()=>Ge(d,"id",i)),R(e,l),Me()}Se(["click"]);var Fs=N('<div class="sync-controls svelte-1xjjmjf"><div class="sync-header svelte-1xjjmjf"><span class="sync-label svelte-1xjjmjf">Sync Offset</span> <span class="sync-value svelte-1xjjmjf"> </span></div> <div class="sync-buttons svelte-1xjjmjf"><button class="sync-btn coarse svelte-1xjjmjf" title="Earlier by 0.1s">-0.1s</button> <button class="sync-btn fine svelte-1xjjmjf" title="Earlier by 0.01s">-0.01s</button> <button class="sync-btn reset svelte-1xjjmjf" title="Reset offset">0</button> <button class="sync-btn fine svelte-1xjjmjf" title="Later by 0.01s">+0.01s</button> <button class="sync-btn coarse svelte-1xjjmjf" title="Later by 0.1s">+0.1s</button></div> <div class="sync-hint svelte-1xjjmjf">Use arrow keys to adjust (Shift for coarse)</div></div>');function Ws(e,n){_e(n,!0);const i=I(()=>Q.state.syncConfig.manualOffsetSec),a=I(()=>Q.state.isActive);function o(_){return`${_>=0?"+":""}${_.toFixed(2)}s`}function s(_){Q.adjustOffset(_)}function r(){Q.resetOffset()}function c(_){if(t(a)&&!(_.target instanceof HTMLInputElement))switch(_.key){case"ArrowLeft":_.preventDefault(),s(_.shiftKey?-.1:-.01);break;case"ArrowRight":_.preventDefault(),s(_.shiftKey?.1:.01);break}}var l=Fs();it("keydown",Pn,c);var d=u(l),v=y(u(d),2),f=u(v),h=y(d,2),b=u(h);b.__click=()=>s(-.1);var m=y(b,2);m.__click=()=>s(-.01);var g=y(m,2);g.__click=r;var w=y(g,2);w.__click=()=>s(.01);var p=y(w,2);p.__click=()=>s(.1),K(_=>{B(f,_),b.disabled=!t(a),m.disabled=!t(a),g.disabled=!t(a)||t(i)===0,w.disabled=!t(a),p.disabled=!t(a)},[()=>o(t(i))]),R(e,l),Me()}Se(["click"]);var Bs=N('<span class="spinner svelte-oab1bu"></span> Loading...',1),js=N('<div class="error-message svelte-oab1bu"> </div>'),qs=N('<button class="upload-btn svelte-oab1bu"><!></button> <!>',1),Us=N('<div class="video-section svelte-oab1bu"><!> <!></div>'),Gs=N('<button class="play-btn svelte-oab1bu">â–¶ Play</button>'),Ys=N('<button class="stop-btn svelte-oab1bu">â¹ Stop</button>'),Vs=N('<div class="progress-info svelte-oab1bu"><span class="time-display svelte-oab1bu"> </span></div>'),zs=N('<div class="song-info svelte-oab1bu"><div class="song-title svelte-oab1bu"> </div> <div class="song-artist svelte-oab1bu"> </div></div> <!> <div class="playback-controls svelte-oab1bu"><!> <button class="unload-btn svelte-oab1bu">Unload</button></div> <!>',1),Xs=N('<div class="ultrastar-panel svelte-oab1bu"><h3 class="panel-title svelte-oab1bu">Ultrastar Song</h3> <input type="file" accept=".txt" style="display: none;"/> <!></div>');function Ks(e,n){_e(n,!0);let i=null,a;const o=I(()=>Q.state.isActive),s=I(()=>Q.state.isLoading),r=I(()=>Q.state.isPlaying),c=I(()=>Q.hasVideo),l=I(()=>Q.title),d=I(()=>Q.artist),v=I(()=>Q.state.error);async function f(k){const D=k.target,H=D.files?.[0];if(!H)return;if(await Q.loadFile(H)){i=As({syncConfig:Q.state.syncConfig});const W=Q.state.detectedRange;ee.setYAxisRange({minMidi:W.minMidi,maxMidi:W.maxMidi}),fe.setTargetNotes(Q.state.targetNotes),console.log("[Ultrastar] File loaded:",{title:Q.title,artist:Q.artist,youtubeId:Q.state.youtubeId,bpm:Q.state.song?.metadata.bpm,gap:Q.state.song?.metadata.gap,videoGap:Q.state.song?.metadata.videoGap,noteCount:Q.state.targetNotes.length,firstNotes:Q.state.targetNotes.slice(0,3),lastNotes:Q.state.targetNotes.slice(-3),totalDurationMs:Q.state.totalDurationMs,pitchRange:W,syncConfig:Q.state.syncConfig})}D.value=""}async function h(){if(t(o))if(ee.setVisualizationMode("highway"),i&&i.updateConfig(Q.state.syncConfig),fe.setTargetNotes(Q.state.targetNotes),Q.setPlaying(!0),t(c)&&xe.state.isPlayerReady){const k=i?.getYouTubeOffset()??0;console.log("[Ultrastar] Starting playback:",{youtubeOffset:k,noteCount:Q.state.targetNotes.length,firstNote:Q.state.targetNotes[0],syncConfig:Q.state.syncConfig}),fe.setCurrentTime(0),xe.seekTo(k),xe.play(),g()}else fe.start()}function b(){fe.stop(),Q.setPlaying(!1),xe.pause(),w()}function m(){b(),Q.unload(),xe.dispose(),fe.reset(),i=null}function g(){xe.startSyncLoop(k=>{if(!i)return;const D=i.youTubeToTransport(k),H=fe.state.currentTimeMs;Math.abs(D-H)>50&&fe.setCurrentTime(Math.max(0,D))},100)}function w(){xe.stopSyncLoop()}function p(){a?.click()}$e(()=>{w(),xe.dispose()});var _=Xs(),C=y(u(_),2);C.__change=f,Be(C,k=>a=k,()=>a);var x=y(C,2);{var T=k=>{var D=qs(),H=Ie(D);H.__click=p;var F=u(H);{var W=P=>{var E=Bs();R(P,E)},U=P=>{var E=li("Upload Ultrastar .txt");R(P,E)};G(F,P=>{t(s)?P(W):P(U,!1)})}var ne=y(H,2);{var L=P=>{var E=js(),Y=u(E);K(()=>B(Y,t(v))),R(P,E)};G(ne,P=>{t(v)&&P(L)})}K(()=>H.disabled=t(s)),R(k,D)},M=k=>{var D=zs(),H=Ie(D),F=u(H),W=u(F),U=y(F,2),ne=u(U),L=y(H,2);{var P=ce=>{var he=Us(),J=u(he);Os(J,{});var te=y(J,2);Ws(te,{}),R(ce,he)};G(L,ce=>{t(c)&&ce(P)})}var E=y(L,2),Y=u(E);{var $=ce=>{var he=Gs();he.__click=h,R(ce,he)},se=ce=>{var he=Ys();he.__click=b,R(ce,he)};G(Y,ce=>{t(r)?ce(se,!1):ce($)})}var oe=y(Y,2);oe.__click=m;var le=y(E,2);{var ge=ce=>{var he=Vs(),J=u(he),te=u(J);K((be,Te)=>B(te,`${be??""}s
          / ${Te??""}s`),[()=>Math.floor(fe.state.currentTimeMs/1e3),()=>Math.floor(Q.state.totalDurationMs/1e3)]),R(ce,he)};G(le,ce=>{t(r)&&ce(ge)})}K(()=>{B(W,t(l)),B(ne,t(d)),oe.disabled=t(r)}),R(k,D)};G(x,k=>{t(o)?k(M,!1):k(T)})}R(e,_),Me()}Se(["change","click"]);var Zs=N('<button class="settings-toggle svelte-1osw0t8" aria-label="Toggle settings"><svg class="gear-icon svelte-1osw0t8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg></button>'),Js=N('<div class="settings-dropdown svelte-1osw0t8"><button class="settings-option svelte-1osw0t8"><svg class="option-icon svelte-1osw0t8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> Recalibrate</button> <button class="settings-option settings-option--danger svelte-1osw0t8"><svg class="option-icon svelte-1osw0t8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg> Clear Calibration</button></div>'),Qs=N('<div class="pitch-display svelte-1osw0t8"><div class="pitch-value-row svelte-1osw0t8"><button class="adjust-btn svelte-1osw0t8" aria-label="Lower pitch">âˆ’</button> <div class="pitch-value svelte-1osw0t8"><span class="note-name svelte-1osw0t8"> </span> <span class="frequency svelte-1osw0t8"> </span></div> <button class="adjust-btn svelte-1osw0t8" aria-label="Raise pitch">+</button></div> <p class="calibration-date svelte-1osw0t8"> </p></div> <!>',1),$s=N('<div class="not-calibrated svelte-1osw0t8"><p class="hint-text svelte-1osw0t8">Calibrate your speaking pitch to adapt exercises to your voice range.</p> <button class="calibrate-btn svelte-1osw0t8"><svg class="btn-icon svelte-1osw0t8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg> Calibrate Now</button></div>'),eo=N('<div class="speaking-pitch-panel svelte-1osw0t8"><div class="panel-header svelte-1osw0t8"><h3 class="panel-title svelte-1osw0t8">Speaking Pitch</h3> <!></div> <!></div>');function to(e,n){_e(n,!0);let i=X(!1);const a=I(()=>Le.isCalibrated),o=I(()=>Le.speakingPitchMidi),s=I(()=>Le.speakingPitchNoteName),r=I(()=>Le.lastCalibratedDate),c=I(()=>t(o)!==null?Math.round(Ia(t(o))):null);function l(){Le.adjustSpeakingPitch(1)}function d(){Le.adjustSpeakingPitch(-1)}function v(){confirm("Clear your speaking pitch calibration?")&&(Le.clearSpeakingPitch(),A(i,!1))}function f(){A(i,!t(i))}var h=eo(),b=u(h),m=y(u(b),2);{var g=C=>{var x=Zs();x.__click=f,K(()=>Ge(x,"aria-expanded",t(i))),R(C,x)};G(m,C=>{t(a)&&C(g)})}var w=y(b,2);{var p=C=>{var x=Qs(),T=Ie(x),M=u(T),k=u(M);k.__click=d;var D=y(k,2),H=u(D),F=u(H),W=y(H,2),U=u(W),ne=y(D,2);ne.__click=l;var L=y(M,2),P=u(L),E=y(T,2);{var Y=$=>{var se=Js(),oe=u(se);oe.__click=function(...ge){n.onCalibrate?.apply(this,ge)};var le=y(oe,2);le.__click=v,R($,se)};G(E,$=>{t(i)&&$(Y)})}K(()=>{B(F,t(s)),B(U,`${t(c)??""} Hz`),B(P,`Calibrated ${t(r)??""}`)}),R(C,x)},_=C=>{var x=$s(),T=y(u(x),2);T.__click=function(...M){n.onCalibrate?.apply(this,M)},R(C,x)};G(w,C=>{t(a)?C(p):C(_,!1)})}R(e,h),Me()}Se(["click"]);var no=N('<div class="note-display svelte-fwpoo3"><span class="note-name svelte-fwpoo3"> </span> <span class="octave svelte-fwpoo3"> </span></div> <div class="details svelte-fwpoo3"><span class="frequency"> </span> <span> </span> <span class="clarity"> </span></div>',1),io=N('<div class="no-pitch svelte-fwpoo3"><span class="placeholder svelte-fwpoo3">---</span> <span class="hint svelte-fwpoo3">Sing or hum into the microphone</span></div>'),ao=N('<div class="pitch-readout svelte-fwpoo3"><!></div>');function so(e,n){_e(n,!0);const i=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],a=I(()=>()=>{const l=me.state.currentPitch;if(!l)return null;const d=i[l.pitchClass],v=Math.floor(l.midi/12)-1,f=Math.round((l.midi-Math.round(l.midi))*100);return{name:d,octave:v,frequency:l.frequency.toFixed(1),cents:f,clarity:Math.round(l.clarity*100)}});var o=ao(),s=u(o);{var r=l=>{const d=I(()=>t(a)());var v=no(),f=Ie(v),h=u(f),b=u(h),m=y(h,2),g=u(m),w=y(f,2),p=u(w),_=u(p),C=y(p,2);let x;var T=u(C),M=y(C,2),k=u(M);K(()=>{B(b,t(d).name),B(g,t(d).octave),B(_,`${t(d).frequency??""} Hz`),x=Ve(C,1,"cents svelte-fwpoo3",null,x,{sharp:t(d).cents>0,flat:t(d).cents<0}),B(T,`${t(d).cents>0?"+":""}${t(d).cents??""}Â¢`),B(k,`${t(d).clarity??""}%`)}),R(l,v)},c=l=>{var d=io();R(l,d)};G(s,l=>{t(a)()?l(r):l(c,!1)})}R(e,o),Me()}var oo=N('<span class="song-artist svelte-1rv7phe"> </span>'),ro=N('<div class="song-info svelte-1rv7phe"><span class="song-title svelte-1rv7phe"> </span> <!></div>'),lo=N('<div class="stat-item missed svelte-1rv7phe"><span class="stat-value svelte-1rv7phe"> </span> <span class="stat-label svelte-1rv7phe">Missed</span></div>'),co=N('<div class="golden-stats svelte-1rv7phe"><span class="golden-icon svelte-1rv7phe">â­</span> <span class="golden-text svelte-1rv7phe"> </span></div>'),uo=N('<div class="pitch-stats svelte-1rv7phe"><span class="pitch-label">Avg. Pitch Deviation:</span> <span class="pitch-value svelte-1rv7phe"> </span></div>'),fo=N('<div><span class="phrase-lyric svelte-1rv7phe"> </span> <span class="phrase-accuracy svelte-1rv7phe"> </span></div>'),ho=N('<details class="phrase-details svelte-1rv7phe"><summary class="phrase-summary svelte-1rv7phe">Phrase Breakdown</summary> <div class="phrase-list svelte-1rv7phe"></div></details>'),vo=N('<button class="action-btn retry-btn svelte-1rv7phe">Try Again</button>'),go=N('<div class="modal-backdrop svelte-1rv7phe" role="dialog" aria-modal="true" aria-labelledby="results-title" tabindex="-1"><div class="modal-content svelte-1rv7phe"><div class="modal-header svelte-1rv7phe"><h2 id="results-title" class="modal-title svelte-1rv7phe">Results</h2> <!></div> <div class="stats-section svelte-1rv7phe"><div class="grade-display svelte-1rv7phe"><span class="grade-letter svelte-1rv7phe"> </span></div> <div class="accuracy-display svelte-1rv7phe"><span class="accuracy-value svelte-1rv7phe"> </span> <span class="accuracy-label svelte-1rv7phe">Accuracy</span></div> <div class="stats-row svelte-1rv7phe"><div class="stat-item svelte-1rv7phe"><span class="stat-value hit svelte-1rv7phe"> </span> <span class="stat-label svelte-1rv7phe">Hit</span></div> <div class="stat-divider svelte-1rv7phe">/</div> <div class="stat-item svelte-1rv7phe"><span class="stat-value total svelte-1rv7phe"> </span> <span class="stat-label svelte-1rv7phe">Total</span></div> <!></div> <!> <!></div> <!> <div class="modal-actions svelte-1rv7phe"><!> <button class="action-btn close-btn svelte-1rv7phe">Close</button></div></div></div>');function mo(e,n){_e(n,!0);const i=I(()=>Ne.state.isVisible),a=I(()=>Ne.state.summary),o=I(()=>Ne.state.songTitle),s=I(()=>Ne.state.artistName),r=I(()=>t(a)?Ne.getLetterGrade(t(a).accuracyPercent):"F"),c=I(()=>t(a)?Ne.getAccuracyColor(t(a).accuracyPercent):"");function l(){Ne.hide(),n.onClose?.()}function d(){Ne.hide(),n.onRetry?.()}function v(g){g.target===g.currentTarget&&l()}function f(g){g.key==="Escape"&&t(i)&&l()}var h=We();it("keydown",Pn,f);var b=Ie(h);{var m=g=>{var w=go();w.__click=v,w.__keydown=f;var p=u(w),_=u(p),C=y(u(_),2);{var x=z=>{var ae=ro(),S=u(ae),q=u(S),V=y(S,2);{var ve=Pe=>{var O=oo(),j=u(O);K(()=>B(j,`by ${t(s)??""}`)),R(Pe,O)};G(V,Pe=>{t(s)&&Pe(ve)})}K(()=>B(q,t(o))),R(z,ae)};G(C,z=>{t(o)&&z(x)})}var T=y(_,2),M=u(T);let k;var D=u(M),H=u(D),F=y(M,2);let W;var U=u(F),ne=u(U),L=y(F,2),P=u(L),E=u(P),Y=u(E),$=y(P,4),se=u($),oe=u(se),le=y($,2);{var ge=z=>{var ae=lo(),S=u(ae),q=u(S);K(()=>B(q,t(a).notesMissed)),R(z,ae)};G(le,z=>{t(a).notesMissed>0&&z(ge)})}var ce=y(L,2);{var he=z=>{var ae=co(),S=y(u(ae),2),q=u(S);K(()=>B(q,`Golden Notes: ${t(a).goldenNotesHit??""}/${t(a).goldenNotesTotal??""}`)),R(z,ae)};G(ce,z=>{t(a).goldenNotesTotal>0&&z(he)})}var J=y(ce,2);{var te=z=>{var ae=uo(),S=y(u(ae),2),q=u(S);K(V=>B(q,`${V??""} cents`),[()=>t(a).averagePitchDeviationCents.toFixed(1)]),R(z,ae)};G(J,z=>{t(a).averagePitchDeviationCents>0&&z(te)})}var be=y(T,2);{var Te=z=>{var ae=ho(),S=y(u(ae),2);Ye(S,21,()=>t(a).phraseResults,Qe,(q,V)=>{var ve=fo();let Pe;var O=u(ve),j=u(O),ie=y(O,2),Z=u(ie);K(we=>{Pe=Ve(ve,1,"phrase-item svelte-1rv7phe",null,Pe,{perfect:t(V).accuracyPercent===100,good:t(V).accuracyPercent>=70&&t(V).accuracyPercent<100,poor:t(V).accuracyPercent<70}),B(j,t(V).lyricPreview),B(Z,`${t(V).notesHit??""}/${t(V).totalNotes??""}
                  (${we??""}%)`)},[()=>t(V).accuracyPercent.toFixed(0)]),R(q,ve)}),R(z,ae)};G(be,z=>{t(a).phraseResults.length>1&&z(Te)})}var Ae=y(be,2),Re=u(Ae);{var re=z=>{var ae=vo();ae.__click=d,R(z,ae)};G(Re,z=>{n.onRetry&&z(re)})}var ue=y(Re,2);ue.__click=l,K(z=>{k=Je(M,"",k,{"--grade-color":t(c)}),B(H,t(r)),W=Je(F,"",W,{color:t(c)}),B(ne,`${z??""}%`),B(Y,t(a).notesHit),B(oe,t(a).totalNotes)},[()=>t(a).accuracyPercent.toFixed(1)]),R(g,w)};G(b,g=>{t(i)&&t(a)&&g(m)})}R(e,h),Me()}Se(["click","keydown"]);function pn(){return Xe.map((e,n)=>({phraseIndex:n,phrase:e,status:"pending",pitchSamples:[]}))}function po(){let e=X(Fe({currentStep:"intro",phraseRecordings:pn(),analysisResult:null,manualAdjustmentSemitones:0,isComplete:!1}));return{get state(){return t(e)},get currentStep(){return t(e).currentStep},get currentPhraseIndex(){const n=t(e).currentStep.match(/^recording-(\d+)$/);return n?parseInt(n[1],10)-1:null},get currentPhrase(){const n=this.currentPhraseIndex;return n!==null?Xe[n]:null},get currentPhraseRecording(){const n=this.currentPhraseIndex;return n!==null?t(e).phraseRecordings[n]:null},get analysisResult(){return t(e).analysisResult},get adjustedMidi(){return t(e).analysisResult?.estimatedMidi?ya(t(e).analysisResult.estimatedMidi,t(e).manualAdjustmentSemitones):null},get adjustedNoteName(){const n=this.adjustedMidi;return n!==null?Wn(n):null},get manualAdjustment(){return t(e).manualAdjustmentSemitones},get allRecordingsComplete(){return t(e).phraseRecordings.every(n=>n.status==="complete")},start(){A(e,{currentStep:"intro",phraseRecordings:pn(),analysisResult:null,manualAdjustmentSemitones:0,isComplete:!1},!0)},reset(){this.start()},nextStep(){switch(t(e).currentStep){case"intro":t(e).currentStep="recording-1";break;case"recording-1":t(e).currentStep="recording-2";break;case"recording-2":t(e).currentStep="recording-3";break;case"recording-3":t(e).currentStep="analyzing",this.analyze();break}},previousStep(){switch(t(e).currentStep){case"recording-1":t(e).currentStep="intro";break;case"recording-2":t(e).currentStep="recording-1";break;case"recording-3":t(e).currentStep="recording-2";break}},startRecording(){const n=this.currentPhraseIndex;n!==null&&(t(e).phraseRecordings[n]={...t(e).phraseRecordings[n],status:"recording",pitchSamples:[]})},addSample(n){const i=this.currentPhraseIndex;i===null||t(e).phraseRecordings[i].status!=="recording"||t(e).phraseRecordings[i].pitchSamples.push(n)},completeRecording(n){const i=this.currentPhraseIndex;i!==null&&(t(e).phraseRecordings[i]={...t(e).phraseRecordings[i],status:"complete",pitchSamples:n})},reRecord(){const n=this.currentPhraseIndex;n!==null&&(t(e).phraseRecordings[n]={...t(e).phraseRecordings[n],status:"pending",pitchSamples:[]})},analyze(){const n=t(e).phraseRecordings.flatMap(a=>a.pitchSamples),i=fa(n,Bt);t(e).analysisResult=i,i.success?t(e).currentStep="result":t(e).currentStep="error"},adjustSemitones(n){const i=t(e).manualAdjustmentSemitones+n;i>=-12&&i<=12&&(t(e).manualAdjustmentSemitones=i)},setAdjustment(n){n>=-12&&n<=12&&(t(e).manualAdjustmentSemitones=n)},save(){const n=this.adjustedMidi;if(n===null)return!1;const i=Le.setSpeakingPitch({speakingPitchMidi:n,speakingPitchLastCalibratedAt:new Date().toISOString()});return i&&(t(e).isComplete=!0),i}}}const ke=po();var yo=N('<div><p class="phrase-text svelte-1lrl03w"> </p></div>');function bo(e,n){let i=ye(n,"isActive",3,!1);var a=yo();let o;var s=u(a),r=u(s);K(()=>{o=Ve(a,1,"phrase-prompt svelte-1lrl03w",null,o,{active:i()}),B(r,`"${n.phrase??""}"`)}),R(e,a)}var wo=N('<div class="error-message svelte-15omjpi"> </div>'),_o=N('<div class="current-pitch svelte-15omjpi"> </div>'),Mo=N('<div class="recording-status svelte-15omjpi"><div class="recording-indicator svelte-15omjpi"><span class="recording-dot svelte-15omjpi"></span> <span class="svelte-15omjpi">Recording...</span></div> <!> <div class="progress-bar svelte-15omjpi"><div class="progress-fill svelte-15omjpi"></div></div></div>'),Po=N('<div class="recording-complete svelte-15omjpi"><span class="check-icon svelte-15omjpi">&#x2713;</span> <span class="svelte-15omjpi"> </span></div>'),Co=N('<button class="btn btn-secondary svelte-15omjpi">Back</button>'),So=N('<button class="btn btn-primary svelte-15omjpi">Start Recording</button>'),To=N('<button class="btn btn-secondary svelte-15omjpi">Re-record</button> <button class="btn btn-primary svelte-15omjpi">Next</button>',1),xo=N('<div class="record-step svelte-15omjpi"><div class="step-header svelte-15omjpi"><span class="step-indicator svelte-15omjpi"> </span></div> <div class="phrase-section svelte-15omjpi"><!></div> <!> <div class="recording-section svelte-15omjpi"><!></div> <div class="button-row svelte-15omjpi"><!> <!></div></div>');function It(e,n){_e(n,!0);let i=X(!1),a=X(0),o=X(!1),s=X(0),r=X(null),c=X(null);const l=Bt.recordingDurationMs;De(()=>{const L=ke.state.phraseRecordings[n.phraseIndex];A(o,L?.status==="complete"&&L.pitchSamples.length>0,!0),A(s,L?.pitchSamples.length??0,!0)});async function d(){A(r,null),A(i,!0),A(a,0),A(c,null),ke.startRecording();try{const L=await Ha(l,(P,E)=>{if(A(a,P/l*100),E){const Y=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],$=Math.round(E.midi),se=Math.floor($/12)-1,oe=Y[$%12];A(c,`${oe}${se}`)}else A(c,null)});ke.completeRecording(L),A(o,!0),A(s,L.length,!0)}catch(L){console.error("[CalibrationRecordStep] Recording failed:",L),A(r,"Could not access microphone. Please check permissions.")}finally{A(i,!1),A(a,100),A(c,null)}}function v(){ke.reRecord(),A(o,!1),A(s,0),A(a,0)}function f(){t(o)&&n.onComplete()}var h=xo(),b=u(h),m=u(b),g=u(m),w=y(b,2),p=u(w);bo(p,{get phrase(){return n.phrase},get isActive(){return t(i)}});var _=y(w,2);{var C=L=>{var P=wo(),E=u(P);K(()=>B(E,t(r))),R(L,P)};G(_,L=>{t(r)&&L(C)})}var x=y(_,2),T=u(x);{var M=L=>{var P=Mo(),E=y(u(P),2);{var Y=oe=>{var le=_o(),ge=u(le);K(()=>B(ge,t(c))),R(oe,le)};G(E,oe=>{t(c)&&oe(Y)})}var $=y(E,2),se=u($);K(()=>Je(se,`width: ${t(a)??""}%`)),R(L,P)},k=L=>{var P=We(),E=Ie(P);{var Y=$=>{var se=Po(),oe=y(u(se),2),le=u(oe);K(()=>B(le,`Recording complete (${t(s)??""} samples)`)),R($,se)};G(E,$=>{t(o)&&$(Y)},!0)}R(L,P)};G(T,L=>{t(i)?L(M):L(k,!1)})}var D=y(x,2),H=u(D);{var F=L=>{var P=Co();P.__click=function(...E){n.onBack?.apply(this,E)},K(()=>P.disabled=t(i)),R(L,P)};G(H,L=>{n.onBack&&L(F)})}var W=y(H,2);{var U=L=>{var P=So();P.__click=d,R(L,P)},ne=L=>{var P=We(),E=Ie(P);{var Y=$=>{var se=To(),oe=Ie(se);oe.__click=v;var le=y(oe,2);le.__click=f,R($,se)};G(E,$=>{!t(i)&&t(o)&&$(Y)},!0)}R(L,P)};G(W,L=>{!t(i)&&!t(o)?L(U):L(ne,!1)})}K(()=>B(g,`Phrase ${n.phraseIndex+1} of 3`)),R(e,h),Me()}Se(["click"]);var ko=N('<span class="adjustment-indicator svelte-gp26ti"> </span>'),Ro=N('<div class="result-step svelte-gp26ti"><div class="result-header svelte-gp26ti"><h3 class="result-title svelte-gp26ti">Your Speaking Pitch</h3> <p class="result-description svelte-gp26ti">This is your estimated comfortable speaking anchor. You can adjust it if needed.</p></div> <div class="pitch-display svelte-gp26ti"><button class="adjust-btn svelte-gp26ti" aria-label="Lower pitch" title="Lower by 1 semitone">-</button> <div class="pitch-value svelte-gp26ti"><span class="note-name svelte-gp26ti"> </span> <!></div> <button class="adjust-btn svelte-gp26ti" aria-label="Raise pitch" title="Raise by 1 semitone">+</button></div> <div class="confidence-section svelte-gp26ti"><div class="confidence-bar svelte-gp26ti"><div class="confidence-fill svelte-gp26ti"></div></div> <span class="confidence-label svelte-gp26ti"> </span></div> <div class="button-row svelte-gp26ti"><button class="btn btn-secondary svelte-gp26ti">Try Again</button> <button class="btn btn-primary svelte-gp26ti">Save</button></div></div>');function Io(e,n){_e(n,!0);const i=I(()=>ke.adjustedNoteName),a=I(()=>ke.manualAdjustment),o=I(()=>ke.analysisResult?.confidenceScore??0);function s(){ke.adjustSemitones(-1)}function r(){ke.adjustSemitones(1)}function c(){ke.save()&&n.onSave()}const l=I(()=>Math.round(t(o)*100));var d=Ro(),v=y(u(d),2),f=u(v);f.__click=s;var h=y(f,2),b=u(h),m=u(b),g=y(b,2);{var w=F=>{var W=ko(),U=u(W);K(()=>B(U,`(${t(a)>0?"+":""}${t(a)??""})`)),R(F,W)};G(g,F=>{t(a)!==0&&F(w)})}var p=y(h,2);p.__click=r;var _=y(v,2),C=u(_),x=u(C),T=y(C,2),M=u(T),k=y(_,2),D=u(k);D.__click=function(...F){n.onRetry?.apply(this,F)};var H=y(D,2);H.__click=c,K(()=>{B(m,t(i)),Je(x,`width: ${t(l)??""}%`),B(M,`Confidence: ${t(l)??""}%`)}),R(e,d),Me()}Se(["click"]);var Ao=N('<li class="svelte-cxu70i"> </li>'),No=N(`<div class="intro-step svelte-cxu70i"><h2 class="wizard-title svelte-cxu70i">Calibrate Speaking Pitch</h2> <div class="intro-description svelte-cxu70i"><p class="svelte-cxu70i"><strong>Speaking Pitch</strong> is your relaxed anchor note. We'll estimate it
              from your speaking voice. You can adjust it afterward.</p> <p class="instruction svelte-cxu70i">Read each phrase slowly and naturally.</p></div> <div class="phrases-preview svelte-cxu70i"><h4 class="svelte-cxu70i">You'll read these phrases:</h4> <ol class="phrase-list svelte-cxu70i"></ol></div> <div class="button-row svelte-cxu70i"><button class="btn btn-secondary svelte-cxu70i">Cancel</button> <button class="btn btn-primary svelte-cxu70i">Start Calibration</button></div></div>`),Do=N('<div class="analyzing-step svelte-cxu70i"><div class="spinner svelte-cxu70i"></div> <p>Analyzing your recordings...</p></div>'),Ho=N(`<div class="error-step svelte-cxu70i"><div class="error-icon svelte-cxu70i">!</div> <h3 class="svelte-cxu70i">Couldn't Detect Your Pitch</h3> <p class="error-message svelte-cxu70i">We couldn't get a clear reading. Please try again, speaking clearly
            and at your normal volume.</p> <div class="button-row svelte-cxu70i"><button class="btn btn-secondary svelte-cxu70i">Cancel</button> <button class="btn btn-primary svelte-cxu70i">Retry</button></div></div>`),Lo=N('<div class="wizard-overlay svelte-cxu70i" role="presentation"><div class="wizard-modal svelte-cxu70i" role="dialog" aria-modal="true" aria-labelledby="wizard-title" tabindex="-1"><button class="close-btn svelte-cxu70i" aria-label="Close">&times;</button> <div class="wizard-content svelte-cxu70i"><!></div></div></div>');function Eo(e,n){_e(n,!0);const i=I(()=>ke.currentStep);De(()=>{ke.start()});function a(){ke.nextStep()}function o(){ke.nextStep()}function s(){ke.previousStep()}function r(){n.onComplete()}function c(){ke.reset()}function l(){n.onCancel()}function d(p){p.key==="Escape"&&l()}var v=Lo();v.__click=l,v.__keydown=d;var f=u(v);f.__click=p=>p.stopPropagation();var h=u(f);h.__click=l;var b=y(h,2),m=u(b);{var g=p=>{var _=No(),C=y(u(_),4),x=y(u(C),2);Ye(x,21,()=>Xe,Qe,(D,H)=>{var F=Ao(),W=u(F);K(()=>B(W,`"${t(H)??""}"`)),R(D,F)});var T=y(C,2),M=u(T);M.__click=l;var k=y(M,2);k.__click=a,R(p,_)},w=p=>{var _=We(),C=Ie(_);{var x=M=>{It(M,{phraseIndex:0,get phrase(){return Xe[0]},onComplete:o,onBack:s})},T=M=>{var k=We(),D=Ie(k);{var H=W=>{It(W,{phraseIndex:1,get phrase(){return Xe[1]},onComplete:o,onBack:s})},F=W=>{var U=We(),ne=Ie(U);{var L=E=>{It(E,{phraseIndex:2,get phrase(){return Xe[2]},onComplete:o,onBack:s})},P=E=>{var Y=We(),$=Ie(Y);{var se=le=>{var ge=Do();R(le,ge)},oe=le=>{var ge=We(),ce=Ie(ge);{var he=te=>{Io(te,{onSave:r,onRetry:c})},J=te=>{var be=We(),Te=Ie(be);{var Ae=Re=>{var re=Ho(),ue=y(u(re),6),z=u(ue);z.__click=l;var ae=y(z,2);ae.__click=c,R(Re,re)};G(Te,Re=>{t(i)==="error"&&Re(Ae)},!0)}R(te,be)};G(ce,te=>{t(i)==="result"?te(he):te(J,!1)},!0)}R(le,ge)};G($,le=>{t(i)==="analyzing"?le(se):le(oe,!1)},!0)}R(E,Y)};G(ne,E=>{t(i)==="recording-3"?E(L):E(P,!1)},!0)}R(W,U)};G(D,W=>{t(i)==="recording-2"?W(H):W(F,!1)},!0)}R(M,k)};G(C,M=>{t(i)==="recording-1"?M(x):M(T,!1)},!0)}R(p,_)};G(m,p=>{t(i)==="intro"?p(g):p(w,!1)})}R(e,v),Me()}Se(["click","keydown"]);const At={hasImportedSnapshot:!1,snapshot:null,isLoading:!1,error:null,transpositionSemitones:0};function Oo(){let e=X(Fe({...At}));return{get state(){return t(e)},async checkAndConsumeHandoff(){if(!mi())return!1;t(e).isLoading=!0,t(e).error=null;try{const i=await pi();return i?i.schemaVersion!==Vt?(t(e).error=`Incompatible snapshot version: ${i.schemaVersion}. Expected: ${Vt}`,t(e).isLoading=!1,ct(),!1):(t(e).snapshot=i,t(e).hasImportedSnapshot=!0,t(e).isLoading=!1,ct(),console.log("[HandoffState] Successfully imported snapshot",{voices:i.voices.length,microbeatCount:i.timeGrid.microbeatCount,tempo:i.tempo}),!0):(t(e).error="Handoff data expired or not found. Please try exporting again.",t(e).isLoading=!1,ct(),!1)}catch(i){return console.error("[HandoffState] Failed to process handoff",i),t(e).error="Failed to import data from Student Notation.",t(e).isLoading=!1,ct(),!1}},get voices(){return t(e).snapshot?.voices??[]},get timeGrid(){return t(e).snapshot?.timeGrid??null},get tempo(){return t(e).snapshot?.tempo??90},get suggestedPitchRange(){if(!t(e).snapshot)return null;const n=3,i=t(e).snapshot.minMidiPitch,a=t(e).snapshot.maxMidiPitch;return i===void 0||a===void 0?null:{minMidi:Math.max(21,i-n+t(e).transpositionSemitones),maxMidi:Math.min(108,a+n+t(e).transpositionSemitones)}},setTransposition(n){t(e).transpositionSemitones=n},transposeUp(){t(e).transpositionSemitones+=1},transposeDown(){t(e).transpositionSemitones-=1},getTransposedMidi(n){return n+t(e).transpositionSemitones},async bringBackToStudentNotation(){if(!t(e).snapshot){console.warn("[HandoffState] No snapshot to bring back");return}const n={...t(e).snapshot,sourceApp:"singing-trainer",createdAt:Date.now(),voices:t(e).snapshot.voices.map(i=>({...i,notes:i.notes.map(a=>({...a,midiPitch:a.midiPitch+t(e).transpositionSemitones}))}))};try{const i=await vi(n);console.log("[HandoffState] Handoff slot written for return",i),gi(i)}catch(i){console.error("[HandoffState] Failed to write return handoff",i)}},clearSnapshot(){A(e,{...At},!0)},reset(){A(e,{...At},!0)}}}const He=Oo();var Fo=N('<div class="handoff-controls svelte-1qpo30f"><div class="transposition-control svelte-1qpo30f"><button class="transpose-btn svelte-1qpo30f" title="Transpose down">-</button> <span class="transposition-label svelte-1qpo30f"> </span> <button class="transpose-btn svelte-1qpo30f" title="Transpose up">+</button></div> <button class="bring-back-btn svelte-1qpo30f">Bring Back to Student Notation</button></div>'),Wo=N('<div class="error-banner svelte-1qpo30f"> </div>'),Bo=N('<div class="import-info svelte-1qpo30f"><span class="import-label svelte-1qpo30f">Microbeats:</span> <span class="import-value svelte-1qpo30f"> </span></div>'),jo=N('<div class="control-group svelte-1qpo30f"><h3 class="control-group-title svelte-1qpo30f">Imported Material</h3> <div class="import-info svelte-1qpo30f"><span class="import-label svelte-1qpo30f">Voices:</span> <span class="import-value svelte-1qpo30f"> </span></div> <div class="import-info svelte-1qpo30f"><span class="import-label svelte-1qpo30f">Tempo:</span> <span class="import-value svelte-1qpo30f"> </span></div> <!></div>'),qo=N('<div class="app svelte-1qpo30f"><header class="header svelte-1qpo30f"><h1 class="title svelte-1qpo30f">Singing Trainer</h1> <div class="header-controls svelte-1qpo30f"><!></div></header> <!> <main class="main svelte-1qpo30f"><aside class="sidebar sidebar--left svelte-1qpo30f"><div class="control-group svelte-1qpo30f"><!></div> <div class="control-group svelte-1qpo30f"><!></div> <div class="control-group svelte-1qpo30f"><!></div> <div class="control-group svelte-1qpo30f"><!></div> <div class="control-group svelte-1qpo30f"><details class="settings-details svelte-1qpo30f"><summary class="settings-summary svelte-1qpo30f">Settings</summary> <div class="settings-content svelte-1qpo30f"><!> <!> <!></div></details></div> <div class="control-group svelte-1qpo30f"><!></div> <!></aside> <section class="canvas-area svelte-1qpo30f"><!></section></main> <!> <!></div>');function Uo(e,n){_e(n,!0);let i=X(!1),a=X(!1);function o(){A(a,!0)}function s(){A(a,!1)}function r(){A(a,!1)}De(()=>fe.onPerformanceComplete(ue=>{if(Q.state.isActive&&Q.state.isPlaying){const z=Ne.calculateSummary(ue,Q.state.targetNotes);Ne.show(z,{title:Q.title,artist:Q.artist,source:"ultrastar"}),Q.setPlaying(!1)}}));function c(){Ne.state.source==="ultrastar"?(fe.reset(),fe.setTargetNotes(Q.state.targetNotes),ee.setVisualizationMode("highway")):Ne.state.source==="demo"&&(fe.reset(),de.reset(),de.requestRestart())}function l(){fe.reset(),Ne.state.source==="demo"&&de.reset()}Cn(async()=>{if(await He.checkAndConsumeHandoff()){console.log("[App] Handoff detected and processed");const ue=He.suggestedPitchRange;ue&&ee.setYAxisRange(ue)}try{await Na(),ee.setDetecting(!0),console.log("[App] Pitch detection auto-started")}catch(ue){console.error("[App] Failed to auto-start pitch detection:",ue)}}),$e(()=>{Da()});const d=I(()=>He.state.hasImportedSnapshot),v=I(()=>He.state.transpositionSemitones),f=I(()=>He.state.error);function h(){He.bringBackToStudentNotation()}function b(){He.transposeUp()}function m(){He.transposeDown()}var g=qo(),w=u(g),p=y(u(w),2),_=u(p);{var C=re=>{var ue=Fo(),z=u(ue),ae=u(z);ae.__click=m;var S=y(ae,2),q=u(S),V=y(S,2);V.__click=b;var ve=y(z,2);ve.__click=h,K(()=>B(q,`${t(v)>=0?"+":""}${t(v)??""}`)),R(re,ue)};G(_,re=>{t(d)&&re(C)})}var x=y(w,2);{var T=re=>{var ue=Wo(),z=u(ue);K(()=>B(z,t(f))),R(re,ue)};G(x,re=>{t(f)&&re(T)})}var M=y(x,2),k=u(M),D=u(k),H=u(D);so(H,{});var F=y(D,2),W=u(F);ms(W,{});var U=y(F,2),ne=u(U);Ks(ne,{});var L=y(U,2),P=u(L);to(P,{onCalibrate:o});var E=y(L,2),Y=u(E),$=y(u(Y),2),se=u($);ja(se,{});var oe=y(se,2);Ga(oe,{});var le=y(oe,2);os(le,{});var ge=y(E,2),ce=u(ge);as(ce,{});var he=y(ge,2);{var J=re=>{var ue=jo(),z=y(u(ue),2),ae=y(u(z),2),S=u(ae),q=y(z,2),V=y(u(q),2),ve=u(V),Pe=y(q,2);{var O=j=>{var ie=Bo(),Z=y(u(ie),2),we=u(Z);K(()=>B(we,He.timeGrid.microbeatCount)),R(j,ie)};G(Pe,j=>{He.timeGrid&&j(O)})}K(()=>{B(S,He.voices.length),B(ve,`${He.tempo??""} BPM`)}),R(re,ue)};G(he,re=>{t(d)&&re(J)})}var te=y(k,2),be=u(te);xa(be,{});var Te=y(M,2);mo(Te,{onRetry:c,onClose:l});var Ae=y(Te,2);{var Re=re=>{Eo(re,{onComplete:s,onCancel:r})};G(Ae,re=>{t(a)&&re(Re)})}In("open","toggle",Y,re=>A(i,re),()=>t(i)),R(e,g),Me()}Se(["click"]);function Go(e){const n=ci(Uo,{target:e});return{destroy:()=>{di(n)}}}const yn=document.getElementById("app");yn&&Go(yn);
