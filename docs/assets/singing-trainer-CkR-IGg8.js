import"./modulepreload-polyfill-B5Qt9EMX.js";import{C as Zt,D as bn,F as wn,G as Mn,H as Tn,I as Ve,J as _n,K as Pn,L as Jt,M as Cn,p as pe,u as Re,g as t,o as z,v as I,f as D,c as v,s as w,k as W,a as k,r as ye,q as Le,n as _e,e as Ge,i as et,t as Z,b as Y,N as Sn,h as Oe,d as st,A as Ke,y as Je,$ as Qt,O as xn,x as In,m as An,B as Rn}from"./legacy-CpVVXpx-.js";import{t as fe,o as $t,j as Ye,i as ee,q as Ne,u as Nn,v as kn,k as _t,h as qe,f as ct,x as Hn,w as Ln,y as Dn,A as En,C as On,E as tt,S as It}from"./navigation-CidcP4BR.js";import{s as Pt,V as Fn,S as en,l as At,U as Wn,A as Bn,g as Gn,P as Yn}from"./vendor-tone-Cer4uW5H.js";import{P as qn}from"./vendor-pitchy-DoA2xU7W.js";function Ct(e,n,i=!1){if(e.multiple){if(n==null)return;if(!bn(n))return wn();for(var s of e.options)s.selected=n.includes(Rt(s));return}for(s of e.options){var r=Rt(s);if(Mn(r,n)){s.selected=!0;return}}(!i||n!==void 0)&&(e.selectedIndex=-1)}function tn(e){var n=new MutationObserver(()=>{Ct(e,e.__value)});n.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),Zt(()=>{n.disconnect()})}function Rt(e){return"__value"in e?e.__value:e.value}function dt(e,n,i=n){var s=new WeakSet;Tn(e,"input",async r=>{var o=r?e.defaultValue:e.value;if(o=ut(e)?ft(o):o,i(o),Ve!==null&&s.add(Ve),await _n(),o!==(o=n())){var a=e.selectionStart,c=e.selectionEnd,l=e.value.length;if(e.value=o??"",c!==null){var d=e.value.length;a===c&&c===l&&d>l?(e.selectionStart=d,e.selectionEnd=d):(e.selectionStart=a,e.selectionEnd=Math.min(c,d))}}}),Pn(n)==null&&e.value&&(i(ut(e)?ft(e.value):e.value),Ve!==null&&s.add(Ve)),Jt(()=>{var r=n();if(e===document.activeElement){var o=Cn??Ve;if(s.has(o))return}ut(e)&&r===ft(e.value)||e.type==="date"&&!r&&!e.value||r!==e.value&&(e.value=r??"")})}function ut(e){var n=e.type;return n==="number"||n==="range"}function ft(e){return e===""?null:+e}function nn(e,n,i,s,r){var o=()=>{s(i[e])};i.addEventListener(n,o),r?Jt(()=>{i[e]=r()}):o(),(i===document.body||i===window||i===document)&&Zt(()=>{i.removeEventListener(n,o)})}const yt=["#ef8aab","#f48e7d","#e89955","#cdaa42","#a4ba57","#6ec482","#2dc8b1","#16c3da","#58b8f6","#8fa9ff","#ba9bf2","#db8fd4"],Nt=yt[0];function kt(e){const n=parseInt(e.slice(1),16);return[n>>16&255,n>>8&255,n&255]}function Un(e,n,i){const s=Math.max(0,Math.min(1,i));return e.map((r,o)=>{const a=n[o]??r;return Math.round(r+s*(a-r))})}function sn(e,n=0){const i=Math.floor(e),s=e-i,r=(i%12-n+12)%12,o=(r+1)%12,a=kt(yt[r]??Nt),c=kt(yt[o]??Nt);return Un(a,c,s)}const Vn={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11};function Xn(e){const n=e.replace(/\d+$/,"");return Vn[n]??0}const ht={onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70,accuracyTiers:{perfect:{onsetMs:30,pitchCents:10,coverage:95},good:{onsetMs:75,pitchCents:25,coverage:85},okay:{onsetMs:150,pitchCents:50,coverage:70}}};function jn(e={}){const n={...ht,...e,accuracyTiers:e.accuracyTiers?{...ht.accuracyTiers,...e.accuracyTiers}:ht.accuracyTiers},i=new Map,s=new Map;function r(g,f){return(g-f)*100}function o(g,f){return Math.abs(r(g.midi,f))<=n.pitchToleranceCents}function a(g,f){return g.length===0?0:g.reduce((h,u)=>h+Math.abs(r(u.midi,f)),0)/g.length}function c(g,f,y,h){if(g.length===0)return 0;const u=g.filter(b=>o(b,f));if(u.length===0)return 0;let p=0;for(let b=0;b<u.length;b++){const T=u[b];if(!T)continue;const P=u[b+1];if(P)p+=P.timeMs-T.timeMs;else{const R=y+h,C=Math.min(50,R-T.timeMs);p+=C}}return p/h*100}function l(g,f,y){const h=n.accuracyTiers;if(!h)return"okay";const u=Math.abs(g);return u<=h.perfect.onsetMs&&f<=h.perfect.pitchCents&&y>=h.perfect.coverage?"perfect":u<=h.good.onsetMs&&f<=h.good.pitchCents&&y>=h.good.coverage?"good":u<=h.okay.onsetMs&&f<=h.okay.pitchCents&&y>=h.okay.coverage?"okay":"miss"}function d(g){const{note:f,samples:y,onsetSample:h,releaseSample:u}=g;let p=0;h?p=h.timeMs-f.startTimeMs:p=n.onsetToleranceMs*2;let b=0;const T=f.startTimeMs+f.durationMs;u?b=u.timeMs-T:b=n.releaseToleranceMs*2;const P=a(y,f.midi),R=c(y,f.midi,f.startTimeMs,f.durationMs),C=Math.abs(p)<=n.onsetToleranceMs,_=Math.abs(b)<=n.releaseToleranceMs,x=R>=n.hitThreshold,L=C&&_&&x?"hit":"miss",N=l(p,P,R);return{hitStatus:L,onsetAccuracyMs:p,releaseAccuracyMs:b,pitchAccuracyCents:P,pitchCoverage:R,pitchSamples:[...y],accuracyTier:N}}return{startNote(g,f){i.set(g,{note:f,samples:[],onsetSample:null,releaseSample:null,startedAt:performance.now()})},recordPitchSample(g){for(const[f,y]of i){const{note:h}=y,u=h.startTimeMs+h.durationMs,p=n.onsetToleranceMs,b=n.releaseToleranceMs;g.timeMs>=h.startTimeMs-p&&g.timeMs<=u+b&&(y.samples.push(g),!y.onsetSample&&g.timeMs>=h.startTimeMs-p&&g.timeMs<=h.startTimeMs+p&&o(g,h.midi)&&(y.onsetSample=g),g.timeMs>=u-b&&g.timeMs<=u+b&&(y.releaseSample=g))}},endNote(g){const f=i.get(g);if(!f)return null;const y=d(f);return s.set(g,y),i.delete(g),y},getCurrentPerformance(g){const f=i.get(g);if(!f)return null;const{note:y,samples:h,onsetSample:u}=f;let p=0;u&&(p=u.timeMs-y.startTimeMs);const b=a(h,y.midi),T=c(h,y.midi,y.startTimeMs,y.durationMs);return{onsetAccuracyMs:p,pitchAccuracyCents:b,pitchCoverage:T,pitchSamples:[...h]}},getAllPerformances(){return new Map(s)},reset(){i.clear(),s.clear()},dispose(){i.clear(),s.clear()}}}const Ht={judgmentLinePosition:.12,pixelsPerSecond:200,lookAheadMs:3e3,scrollMode:"constant-speed",leadInBeats:4,playMetronomeDuringOnramp:!0,playTargetNotes:!0,playMetronome:!1,inputSources:["microphone"],feedbackConfig:{onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70}};function zn(e){const n={...Ht,...e,feedbackConfig:{...Ht.feedbackConfig,...e.feedbackConfig}},{stateCallbacks:i,eventCallbacks:s,visualCallbacks:r,logger:o}=n,a={isPlaying:!1,isPaused:!1,currentTimeMs:0,scrollOffset:0,onrampComplete:!1,targetNotes:[],activeNotes:new Set,startTime:null},c=jn(n.feedbackConfig);let l=null;const d=new Set;function m(){const _=60/i.getTempo()*1e3;return n.leadInBeats*_}function g(){return i.getViewportWidth()*n.judgmentLinePosition}function f(C){const _=n.pixelsPerSecond/1e3,x=g(),L=m();return(C+L)*_-x}function y(C){const _=g(),x=i.getCellWidth(),L=C.startColumn*x-a.scrollOffset,N=C.endColumn*x-a.scrollOffset,E=n.feedbackConfig.onsetToleranceMs/1e3*n.pixelsPerSecond;return L<=_+E&&N>=_-E}function h(){const C=new Set;for(const _ of a.targetNotes){const x=_.startTimeMs+_.durationMs,L=n.feedbackConfig.onsetToleranceMs;if(a.currentTimeMs>=_.startTimeMs-L&&a.currentTimeMs<=x+L)C.add(_.id),a.activeNotes.has(_.id)||(c.startNote(_.id,_),o?.debug("NoteHighway",`Note ${_.id} became active`,{note:_}));else if(a.activeNotes.has(_.id)){const N=c.endNote(_.id);if(N){_.performance=N;const H={noteId:_.id,note:_,performance:N};N.hitStatus==="hit"?(s.emit("noteHit",H),r?.onNoteHit?.(_.id,N.accuracyTier||"okay"),o?.info("NoteHighway",`Note hit: ${_.id}`,N)):(s.emit("noteMissed",H),r?.onNoteMiss?.(_.id),o?.info("NoteHighway",`Note missed: ${_.id}`,N))}}}a.activeNotes=C}function u(){for(const C of a.targetNotes){const _=y(C),x=d.has(C.id);_&&!x?(d.add(C.id),s.emit("noteEntered",{noteId:C.id,note:C})):!_&&x&&(d.delete(C.id),s.emit("noteExited",{noteId:C.id,note:C}))}}function p(){if(!a.onrampComplete)if(a.currentTimeMs>=0)a.onrampComplete=!0,s.emit("onrampComplete"),r?.clearOnrampCountdown?.(),o?.info("NoteHighway","Onramp complete",null);else{const _=60/i.getTempo()*1e3,x=Math.abs(a.currentTimeMs),L=Math.ceil(x/_);r?.updateOnrampCountdown?.(L)}}function b(){if(!a.isPlaying||a.isPaused||!a.startTime){l=null;return}const C=performance.now(),_=m();a.currentTimeMs=C-a.startTime-_,a.scrollOffset=f(a.currentTimeMs),p(),h(),u(),l=requestAnimationFrame(b)}function T(){l||(l=requestAnimationFrame(b))}function P(){l&&(cancelAnimationFrame(l),l=null)}return{init(C){a.targetNotes=C,o?.info("NoteHighway",`Initialized with ${C.length} notes`,null)},start(){a.isPlaying||(a.isPlaying=!0,a.isPaused=!1,a.currentTimeMs=-m(),a.scrollOffset=f(a.currentTimeMs),a.onrampComplete=!1,a.activeNotes.clear(),a.startTime=performance.now(),d.clear(),c.reset(),T(),s.emit("playbackStarted"),o?.info("NoteHighway","Playback started",{onrampDurationMs:m()}))},pause(){!a.isPlaying||a.isPaused||(a.isPaused=!0,P(),s.emit("playbackPaused"),o?.info("NoteHighway","Playback paused",{currentTimeMs:a.currentTimeMs}))},resume(){if(!a.isPlaying||!a.isPaused||!a.startTime)return;const C=performance.now()-(a.startTime+a.currentTimeMs+m());a.startTime+=C,a.isPaused=!1,T(),s.emit("playbackResumed"),o?.info("NoteHighway","Playback resumed",null)},stop(){if(!a.isPlaying)return;a.isPlaying=!1,a.isPaused=!1,a.currentTimeMs=0,a.scrollOffset=0,a.onrampComplete=!1,a.activeNotes.clear(),a.startTime=null,d.clear(),P(),r?.clearCanvas?.(),r?.clearOnrampCountdown?.(),s.emit("playbackStopped"),a.targetNotes.every(_=>_.performance!==void 0)&&s.emit("performanceComplete"),o?.info("NoteHighway","Playback stopped",null)},setScrollOffset(C){if(a.currentTimeMs=C,a.scrollOffset=f(C),a.isPlaying){const _=m();a.startTime=performance.now()-(C+_)}o?.debug("NoteHighway","Scroll offset set",{timeMs:C,scrollOffset:a.scrollOffset})},recordPitchInput(C,_,x){if(!a.isPlaying||a.isPaused||!n.inputSources.includes(x))return;const L={timeMs:a.currentTimeMs,midi:C,clarity:_,source:x};c.recordPitchSample(L)},getState(){return a},getVisibleNotes(){g();const C=i.getViewportWidth(),_=i.getCellWidth();return a.targetNotes.filter(x=>{const L=x.startColumn*_-a.scrollOffset;return x.endColumn*_-a.scrollOffset>=0&&L<=C})},getPerformanceResults(){return c.getAllPerformances()},getFeedbackCollector(){return c},dispose(){P(),c.dispose(),a.targetNotes=[],a.activeNotes.clear(),d.clear(),o?.info("NoteHighway","Service disposed",null)}}}function Kn(e){const{cellHeight:n,columnWidths:i,viewport:s}=e,r=n/2,o=Zn(i,e.cellWidth);return{getRowY(a){return(a-s.startRow+1)*r},getRowFromY(a){const c=a/r-1;return Math.round(c)+s.startRow},getColumnX(a){return a<0?0:a>=o.length?o[o.length-1]??0:o[a]??0},getColumnFromX(a){let c=0,l=o.length-1;for(;c<l;){const d=Math.floor((c+l)/2);(o[d]??0)<=a?c=d+1:l=d}return Math.max(0,c-1)}}}function an(e){const{cellHeight:n,viewport:i,pixelsPerSecond:s,nowLineX:r=100,currentTimeMs:o=0}=e,a=n/2;return{getRowY(c){return(c-i.startRow+1)*a},getRowFromY(c){const l=c/a-1;return Math.round(l)+i.startRow},getColumnX(c){return 0},getColumnFromX(c){return 0},getTimeX(c){const l=c-o;return r+l/1e3*s},getTimeFromX(c){const l=(c-r)/s*1e3;return o+l}}}function Zn(e,n){const i=[0];let s=0;for(let r=0;r<e.length;r++){const o=(e[r]??1)*n;s+=o,i.push(s)}return i}function Jn(e,n){const{startRow:i,endRow:s}=e,r=Math.max(0,n.length-1);return{startRow:i,endRow:s,paddedStartRow:Math.max(0,i-1),paddedEndRow:Math.min(r,s+1)}}function gt(e,n,i,s){const r=s.getRowY(e),o=i;return r>=-o&&r<=n.containerHeight+o}function Qn(e){let n=(e||"").replace(/\d/g,"").trim();return n=n.replace(/b/g,"b-").replace(/#/g,"b_"),n}function $n(e){switch(e){case"C":return{lineWidth:3.33,dash:[],color:"#adb5bd"};case"E":return{lineWidth:1,dash:[5,5],color:"#adb5bd"};case"G":return{lineWidth:1,dash:[],color:"#dee2e6"};case"B":case"A":case"F":case"Eb/Db":case"Db/C#":return{lineWidth:1,dash:[],color:"#ced4da"};default:return{lineWidth:1,dash:[],color:"#ced4da"}}}const nt={stroke:"#c7cfd8",background:"rgba(207, 214, 222, 0.32)"};let Xe=null;function ei(){if(Xe)return Xe;if(typeof window>"u")return nt;try{const e=window.getComputedStyle(document.documentElement);Xe={stroke:e.getPropertyValue("--c-anacrusis-border").trim()||nt.stroke,background:e.getPropertyValue("--c-anacrusis-bg").trim()||nt.background}}catch{Xe=nt}return Xe}function ti(e,n,i,s,r,o=0,a){const{fullRowData:c,viewportHeight:l,viewportWidth:d,cellHeight:m}=n,g=d,f=["B","A","F","Eâ™­/Dâ™¯","Dâ™­/Câ™¯"];for(let y=s;y<=r;y++){const h=c[y];if(!h||h.isBoundary)continue;const u=i.getRowY(y);if(u<-10||u>l+10)continue;const p=Qn(h.pitch);if(f.includes(p))continue;const b=$n(p);p==="G"?(e.save(),e.fillStyle=b.color,e.fillRect(o,u-m/2,g-o,m),e.restore()):(e.beginPath(),e.moveTo(o,u),e.lineTo(g,u),e.lineWidth=b.lineWidth,e.strokeStyle=b.color,e.setLineDash(b.dash),e.stroke(),e.setLineDash([]))}}function ni(e,n,i,s){const{columnWidths:r,viewportHeight:o,macrobeatBoundaryStyles:a,placedTonicSigns:c}=n,l=r.length;for(let d=0;d<=l;d++){const m=d===0||d===l,g=si(d,c),f=c.some(b=>d===b.columnIndex+2),y=s.includes(d);if(!ai(d,c))continue;let u=null;if(m||g||f)u={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(y){const b=s.indexOf(d),T=a[b]??"dashed";if(T==="anacrusis"){const{stroke:P}=ei();u={lineWidth:1,strokeStyle:P,dash:[4,4]}}else u={lineWidth:1,strokeStyle:"#adb5bd",dash:T==="solid"?[]:[5,5]}}if(!u)continue;const p=i.getColumnX(d);e.beginPath(),e.moveTo(p,0),e.lineTo(p,o),e.lineWidth=u.lineWidth,e.strokeStyle=u.strokeStyle,e.setLineDash(u.dash),e.stroke()}e.setLineDash([])}function ii(e,n,i){const{viewportHeight:s,beatIntervalMs:r,measureIntervalMs:o,visibleTimeRange:a,nowLineX:c,beatTimeOffsetMs:l=0}=n,d=a.startMs-l,m=a.endMs-l,g=Math.floor(d/r),f=Math.ceil(m/r);for(let y=g;y<=f;y++){const h=l+y*r,u=i.getTimeX?.(h);if(u===void 0)continue;const p=o?(h-l)%o===0:!1;e.beginPath(),e.moveTo(u,0),e.lineTo(u,s),e.lineWidth=p?2:1,e.strokeStyle=p?"#adb5bd":"#dee2e6",e.setLineDash(p?[]:[5,5]),e.stroke()}e.setLineDash([]),c!==void 0&&(e.beginPath(),e.moveTo(c,0),e.lineTo(c,s),e.lineWidth=3,e.strokeStyle="#00ff00",e.setLineDash([]),e.stroke())}function si(e,n){return n.some(i=>i.columnIndex===e)}function ai(e,n){return!n.some(i=>i.columnIndex+1===e)}const oi=.7,ri=.9,li=4,ci=1,di=.15,ui=.2,fi=1,St=1.5;function Ze(e,n){return Number.isFinite(e)&&e>0&&Number.isFinite(n)&&n>0}function on(e){if(!e||typeof e.startColumnIndex!="number"||typeof e.endColumnIndex!="number")return!1;const n=e.shape==="circle"?e.startColumnIndex+1:e.startColumnIndex;return e.endColumnIndex>n}function at(e){const n=e?.split("-")[1];return Number.parseInt(n??"0",10)}function rn(e,n,i){const s=i*.25,r=e.uuid;if(!r)return 0;const o=n.filter(l=>!l.isDrum&&l.row===e.row&&l.startColumnIndex===e.startColumnIndex&&l.uuid&&l.uuid!==r);if(o.length===0)return 0;const a=[e,...o];return a.sort((l,d)=>at(l.uuid)-at(d.uuid)),a.findIndex(l=>l.uuid===r)*s}function hi(e,n,i){const s=i/2*.12,r=e.uuid;if(!r)return 0;const o=n.filter(l=>!l.isDrum&&l.row===e.row&&l.startColumnIndex===e.startColumnIndex&&l.uuid&&l.uuid!==r&&on(l));if(o.length===0)return 0;const a=[e,...o];return a.sort((l,d)=>at(l.uuid)-at(d.uuid)),a.findIndex(l=>l.uuid===r)*s}function gi(e){if(!e)return{multiplier:1,category:"natural"};const n=e.includes("â™­"),i=e.includes("â™¯"),s=e.includes("/");return!n&&!i?{multiplier:1,category:"natural"}:s?{multiplier:.75,category:"both-accidentals"}:{multiplier:.88,category:"single-accidental"}}function bt(e,n,i,s,r,o){const{multiplier:a,category:c}=gi(n);let l;if(i==="circle"){const d=o*2*ri;switch(c){case"natural":l=d;break;case"single-accidental":l=d*.8;break;case"both-accidentals":l=d*.4;break;default:l=d*a}}else{const d=o*2*oi;switch(c){case"natural":l=d*1.5;break;case"single-accidental":l=d*1.2;break;case"both-accidentals":l=d;break;default:l=d*a}}if(!(l<li))if(e.fillStyle="#212529",e.font=`bold ${l}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle",i==="oval"&&c==="both-accidentals"&&n.includes("/")){const d=n.split("/"),m=l*1.1,g=m*(d.length-1),f=r-g/2;d.forEach((y,h)=>{const u=f+h*m,p=l*.08;e.fillText(y.trim(),s,u+p)})}else{const d=l*.08;e.fillText(n,s,r+d)}}function vi(e,n,i,s,r,o,a){e.save(),e.beginPath(),e.arc(i,r,o,Math.PI/2,-Math.PI/2,!1),e.lineTo(s,r-o),e.arc(s,r,o,-Math.PI/2,Math.PI/2,!1),e.lineTo(i,r+o),e.closePath(),e.strokeStyle=n.color,e.lineWidth=a,e.shadowColor=n.color,e.shadowBlur=St,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore()}function Lt(e,n,i,s){const{config:r,coords:o,allNotes:a,getScaleDegreeLabel:c}=n,{cellWidth:l,cellHeight:d,columnWidths:m,degreeDisplayMode:g}=r,f=o.getRowY(s),y=o.getColumnX(i.startColumnIndex),u=(m[i.startColumnIndex]??1)*l;if(!Ze(u,d))return;const p=rn(i,a,l),b=Math.max(.5,u*.15),T=y+u/2+p,P=u/2-b/2,R=d/2-b/2;if(Ze(P,R)&&(e.save(),e.beginPath(),e.ellipse(T,f,P,R,0,0,2*Math.PI),e.strokeStyle=i.color,e.lineWidth=b,e.shadowColor=i.color,e.shadowBlur=St,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore(),g!=="off"&&c)){const{label:C}=c(i);C&&bt(e,C,"oval",T,f,P)}}function Dt(e,n,i,s){const{config:r,coords:o,allNotes:a,getScaleDegreeLabel:c}=n,{cellWidth:l,cellHeight:d,degreeDisplayMode:m,longNoteStyle:g}=r,f=o.getRowY(s),y=o.getColumnX(i.startColumnIndex),u=o.getColumnX(i.startColumnIndex+1)-y;if(!Ze(u,d))return;const p=rn(i,a,l),b=y+u+p,T=Math.max(ci,u*di),P=d/2-T/2,R=on(i);if(R&&g==="style2"){const _=b,x=o.getColumnX(i.endColumnIndex);if(Ze(x-_,P)&&(vi(e,i,_,x,f,P,T),m!=="off"&&c)){const{label:L}=c(i);if(L){const N=(_+x)/2;bt(e,L,"circle",N,f,P)}}return}if(R){const _=o.getColumnX(i.endColumnIndex+1),x=hi(i,a,d),L=f+x;e.beginPath(),e.moveTo(b,L),e.lineTo(_,L),e.strokeStyle=i.color,e.lineWidth=Math.max(fi,u*ui),e.stroke()}const C=u-T/2;if(Ze(C,P)&&(e.save(),e.beginPath(),e.ellipse(b,f,C,P,0,0,2*Math.PI),e.strokeStyle=i.color,e.lineWidth=T,e.shadowColor=i.color,e.shadowBlur=St,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore(),m!=="off"&&c)){const{label:_}=c(i);_&&bt(e,_,"circle",b,f,C)}}function mi(e,n,i){const{config:s,coords:r}=n,{cellWidth:o,cellHeight:a}=s,c=r.getRowY(i.globalRow??i.row),l=r.getColumnX(i.columnIndex),m=r.getColumnX(i.columnIndex+1)-l,g=m*2,f=l+g/2,y=Math.min(g,a)/2*.9;if(y<2||(e.beginPath(),e.arc(f,c,y,0,2*Math.PI),e.strokeStyle="#212529",e.lineWidth=Math.max(.5,m*.05),e.stroke(),i.tonicNumber==null))return;const h=i.tonicNumber.toString(),u=y*1.5;u<6||(e.fillStyle="#212529",e.font=`bold ${u}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(h,f,c))}const pi={timeWindowMs:4e3,pixelsPerSecond:200,circleRadius:9.5,proximityThreshold:35,maxConnections:3,connectorLineWidth:2.5,connectorColor:"rgba(0,0,0,0.4)",useTonicRelativeColors:!0,tonicPitchClass:0,clarityThreshold:.5,maxOpacity:.9};function ln(e){return{...pi,...e}}function Et(e,n,i,s,r,o,a){const c=ln(o.trailConfig);if(s<c.clarityThreshold||i<=0)return;const{cellHeight:l,colorMode:d}=o,m=cn(n,i,l,a),g=l/2*.8,f=d==="bw"?[128,128,128]:sn(i,c.tonicPitchClass);e.save(),e.beginPath(),e.arc(r,m,g+4,0,2*Math.PI),e.fillStyle=`rgba(${f[0]}, ${f[1]}, ${f[2]}, ${s*.3})`,e.fill(),e.beginPath(),e.arc(r,m,g,0,2*Math.PI),e.fillStyle=`rgba(${f[0]}, ${f[1]}, ${f[2]}, ${s})`,e.fill(),e.restore()}function cn(e,n,i,s){if(s.length===0||!s[0])return 0;const r=Math.floor(n),o=n-r,l=(s[0].midi??108)-r;if(l<0||l>=s.length)return l<0?0:e.getRowY(s.length-1);const d=e.getRowY(l),m=i/2;return d-o*m}function dn(e,n,i,s,r,o){const{viewportWidth:a,cellHeight:c,colorMode:l}=r,d=ln(r.trailConfig),m=d.timeWindowMs,g=d.pixelsPerSecond,f=r.nowLineX??a,y=i.filter(h=>h.midi>0&&h.clarity>=d.clarityThreshold).map(h=>{const u=s-h.time;if(u>=m||u<0)return null;const p=f-u/1e3*g,b=cn(n,h.midi,c,o),T=l==="bw"?[128,128,128]:sn(h.midi,d.tonicPitchClass);return{x:p,y:b,clarity:h.clarity,color:T}}).filter(h=>h!==null&&h.x>=0);if(y.length!==0){e.save(),e.strokeStyle=d.connectorColor,e.lineWidth=d.connectorLineWidth,e.beginPath();for(let h=0;h<y.length;h++){let u=0;for(let p=h+1;p<y.length&&u<d.maxConnections;p++){const b=y[h].x-y[p].x,T=y[h].y-y[p].y;Math.sqrt(b*b+T*T)<=d.proximityThreshold&&(e.moveTo(y[h].x,y[h].y),e.lineTo(y[p].x,y[p].y),u++)}}e.stroke();for(const h of y){const u=Math.min(h.clarity*d.maxOpacity,1);e.fillStyle=`rgba(${h.color[0]}, ${h.color[1]}, ${h.color[2]}, ${u})`,e.beginPath(),e.arc(h.x,h.y,d.circleRadius,0,2*Math.PI),e.fill()}e.restore()}}function Ot(e,n,i,s,r,o,a,c){const{cellHeight:l,nowLineX:d=100,pixelsPerSecond:m}=r,g=.5;for(const f of i){const y=(d??100)+(f.startTimeMs-s)/1e3*m,h=y+f.durationMs/1e3*m;if(h<0||y>r.viewportWidth)continue;let u;if(o){if(u=o.findIndex(_=>_.midi===f.midi),u===-1)continue}else u=Math.round(108-f.midi);const p=n.getRowY(u),b=l/2-2,T=f.color??"#4CAF50",P=y<=d&&h>=d,R=a!=null&&(c??0)>.5&&Math.abs(a-f.midi)<=g,C=P&&R;if(e.save(),e.beginPath(),e.arc(y,p,b,Math.PI/2,-Math.PI/2,!1),e.lineTo(h,p-b),e.arc(h,p,b,-Math.PI/2,Math.PI/2,!1),e.lineTo(y,p+b),e.closePath(),C?(e.strokeStyle="#FFD700",e.lineWidth=5,e.shadowColor="#FFD700",e.shadowBlur=20,e.stroke(),e.fillStyle="rgba(255, 215, 0, 0.3)",e.fill(),yi(e,d,p,b)):(e.strokeStyle=T,e.lineWidth=3,e.shadowColor=T,e.shadowBlur=8,e.stroke()),e.shadowBlur=0,e.restore(),f.label){const _=y+b+4;e.fillStyle=C?"#FFD700":"#212529",e.font=`bold ${Math.max(16,b*1.2)}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="left",e.textBaseline="middle",e.fillText(f.label,_,p)}}}function yi(e,n,i,s){const a=s*1.5;e.save(),e.fillStyle="#FFD700",e.shadowColor="#FFD700",e.shadowBlur=6;for(let c=0;c<8;c++){const l=c/8*Math.PI*2,d=n+Math.cos(l)*a,m=i+Math.sin(l)*a;e.beginPath(),e.arc(d,m,3,0,Math.PI*2),e.fill()}e.restore()}function bi(e){const n=e.replace(/\d+$/,"");return n.length>0?n:e}function un(e,n){return!Number.isFinite(n)||n<=0?e:Math.round(e*n)/n}function wi(e,n,i,s){const r=Math.max(10,Math.min(e*1.2,n*1.2)),o=i<=3?1:.7,a=s<=1?1.08:1;return un(r*o*a,s)}function Mi(e){const n=e.getContext("2d");return n&&(n.getTransform().a||window.devicePixelRatio)||1}function Ti(e){if(typeof e.midi=="number")return e.midi%12;if(typeof e.pitchClass=="number")return e.pitchClass;const n={C:0,D:2,E:4,F:5,G:7,A:9,B:11},i=e.pitch.charAt(0).toUpperCase();let s=n[i]??0;return(e.pitch.includes("#")||e.pitch.includes("â™¯"))&&s++,(e.pitch.includes("b")||e.pitch.includes("â™­"))&&s--,(s%12+12)%12}function _i(e,n){const{showFrequencyLabels:i,showOctaveLabels:s,accidentalMode:r}=n,o=g=>s?g:bi(g);if(i)return String(Math.round(e.frequency));const{flatName:a,sharpName:c,isAccidental:l}=e,{sharp:d,flat:m}=r;return l?d&&m?o(e.pitch):d&&!m?o(c):m&&!d?o(a):null:o(a)}function Ft(e,n,i,s){const{fullRowData:r,cellWidth:o,cellHeight:a,legendColumnWidth:c,colorMode:l,accidentalMode:d}=n,{startRow:m,endRow:g,coords:f}=i,y=Mi(e.canvas),h=b=>un(b,y),u=c;let p=0;for(const b of s){for(let T=m;T<=g;T++){const P=r[T];if(!P||P.isBoundary||P.column!==b)continue;const R=f.getRowY(T),C=!d.sharp&&!d.flat,_=P.isAccidental&&C,x=_i(P,n);if(x===null)continue;let L=l==="bw"?"#ffffff":P.hex||"#ffffff",N="FF";_&&(N="00"),e.fillStyle=_?"rgba(255,255,255,0)":L,e.fillRect(p,R-a/2,u,a);const H=n.highlight;if(H&&H.opacity>.01){let Q=!1;typeof H.midi=="number"?Q=typeof P.midi=="number"&&P.midi===Math.round(H.midi):typeof H.pitchClass=="number"&&(Q=Ti(P)===H.pitchClass),Q&&(e.save(),e.globalAlpha=Math.min(Math.max(H.opacity,0),1),e.fillStyle=H.color??"#ffff00",e.fillRect(p,R-a/2,u,a),e.restore())}const E=wi(o,a,x.length,y);e.font=`bold ${E}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle";const U=h(p+u/2),te=h(R);e.strokeStyle=`#212529${N}`,e.lineWidth=Math.max(1.2,2.5/y),e.lineJoin="round",e.strokeText(x,U,te),e.fillStyle=`#ffffff${N}`,e.fillText(x,U,te)}p+=u}}function Pi(e,n,i,s){e&&(e.clearRect(0,0,e.canvas.width,e.canvas.height),Ft(e,i,s,["B","A"])),n&&(n.clearRect(0,0,n.canvas.width,n.canvas.height),Ft(n,i,s,["A","B"]))}var Ci=D('<canvas class="pitch-grid-legend pitch-grid-legend--left svelte-1b4jihh"></canvas>'),Si=D('<canvas class="pitch-grid-legend pitch-grid-legend--right svelte-1b4jihh"></canvas>'),xi=D('<div class="pitch-grid-container svelte-1b4jihh"><!> <canvas class="pitch-grid-canvas svelte-1b4jihh"></canvas> <!></div>');function Ii(e,n){pe(n,!0);let i=fe(n,"colorMode",3,"color"),s=fe(n,"degreeDisplayMode",3,"off"),r=fe(n,"accidentalMode",19,()=>({sharp:!0,flat:!0})),o=fe(n,"showFrequencyLabels",3,!1),a=fe(n,"showOctaveLabels",3,!0),c=fe(n,"showRightLegend",3,!0),l=fe(n,"placedNotes",19,()=>[]),d=fe(n,"placedTonicSigns",19,()=>[]),m=fe(n,"columnWidths",19,()=>[]),g=fe(n,"macrobeatGroupings",19,()=>[]),f=fe(n,"macrobeatBoundaryStyles",19,()=>[]),y=fe(n,"longNoteStyle",3,"style1"),h=fe(n,"beatIntervalMs",3,500),u=fe(n,"beatTimeOffsetMs",3,0),p=z(void 0),b=z(void 0),T=z(void 0),P=z(null),R=z(null),C=z(null),_=z(null);const x=3,L=I(()=>n.cellWidth*x),N=I(()=>t(L)*2),H=I(()=>a()||o()),E=I(()=>t(H)?t(N)*(c()?2:1):0),U=I(()=>Math.max(0,n.viewport.containerWidth-t(E))),te=I(()=>n.mode==="notation"||n.mode==="playback"),Q=I(()=>n.mode==="singing"),S=I(()=>n.mode==="highway");function q(){if(t(te))return Kn({cellWidth:n.cellWidth,cellHeight:n.cellHeight,columnWidths:m(),viewport:n.viewport,tempoModulationMarkers:n.tempoModulationMarkers});{const M=t(S)?n.highwayConfig:n.singingConfig;return an({cellWidth:n.cellWidth,cellHeight:n.cellHeight,viewport:n.viewport,pixelsPerSecond:M?.pixelsPerSecond??200,nowLineX:M?.nowLineX??100,currentTimeMs:M?.currentTimeMs??0})}}function J(){if(!t(P)||!t(p))return;const M=q(),{paddedStartRow:F,paddedEndRow:B}=Jn(n.viewport,n.fullRowData);t(P).clearRect(0,0,t(U),n.viewport.containerHeight);const oe={fullRowData:n.fullRowData,cellHeight:n.cellHeight,viewportHeight:n.viewport.containerHeight,viewportWidth:t(U),colorMode:i()};ti(t(P),oe,M,F,B),t(te)?le(t(P),M):t(Q)?Te(t(P),M):t(S)&&Pe(t(P),M),t(H)&&(t(R)||t(C))&&$(M,F,B)}function le(M,F){const B=O(g()),oe={columnWidths:m(),cellWidth:n.cellWidth,viewportHeight:n.viewport.containerHeight,macrobeatGroupings:g(),macrobeatBoundaryStyles:f(),placedTonicSigns:d()};ni(M,oe,F,B);const ge=l().filter(ie=>ie.isDrum||ie.globalRow===void 0?!1:gt(ie.globalRow,n.viewport,n.cellHeight,F)),Me=d().filter(ie=>ie.globalRow===void 0?!1:gt(ie.globalRow,n.viewport,n.cellHeight,F)),Ie={config:{cellWidth:n.cellWidth,cellHeight:n.cellHeight,columnWidths:m(),degreeDisplayMode:s(),accidentalMode:r(),longNoteStyle:y(),colorMode:i()},coords:F,allNotes:l()};for(const ie of ge)ie.shape==="oval"?Lt(M,Ie,ie,ie.globalRow):ie.shape==="circle"&&Dt(M,Ie,ie,ie.globalRow);for(const ie of Me)mi(M,Ie,ie)}function Te(M,F){if(!n.singingConfig)return;const B={cellHeight:n.cellHeight,viewportWidth:t(U),pixelsPerSecond:n.singingConfig.pixelsPerSecond??200,timeWindowMs:n.singingConfig.timeWindowMs??4e3,colorMode:i(),trailConfig:n.singingConfig.trailConfig};n.singingConfig.pitchHistory&&n.singingConfig.pitchHistory.length>0&&dn(M,F,n.singingConfig.pitchHistory,performance.now(),B,n.fullRowData),n.singingConfig.targetNotes&&n.singingConfig.targetNotes.length>0&&Ot(M,F,n.singingConfig.targetNotes,performance.now(),B,n.fullRowData),n.singingConfig.userPitch&&n.singingConfig.userPitch.clarity>.5&&Et(M,F,n.singingConfig.userPitch.midi,n.singingConfig.userPitch.clarity,t(U)-20,B,n.fullRowData)}function Pe(M,F){if(!n.highwayConfig)return;const B={cellHeight:n.cellHeight,viewportWidth:n.viewport.containerWidth,nowLineX:n.highwayConfig.nowLineX,pixelsPerSecond:n.highwayConfig.pixelsPerSecond??200,timeWindowMs:n.highwayConfig.timeWindowMs??4e3,colorMode:i(),trailConfig:n.highwayConfig.trailConfig};if(n.highwayConfig.scrollingGridData&&n.highwayConfig.scrollOffset!==void 0)Ce(M,F);else{const ge={startMs:n.highwayConfig.currentTimeMs-1e3,endMs:n.highwayConfig.currentTimeMs+t(U)/(n.highwayConfig.pixelsPerSecond??200)*1e3},Me={viewportWidth:t(U),viewportHeight:n.viewport.containerHeight,beatIntervalMs:h(),visibleTimeRange:ge,nowLineX:n.highwayConfig.nowLineX,beatTimeOffsetMs:u()};ii(M,Me,F),n.highwayConfig.targetNotes&&n.highwayConfig.targetNotes.length>0&&Ot(M,F,n.highwayConfig.targetNotes,n.highwayConfig.currentTimeMs,B,n.fullRowData,n.highwayConfig.userPitch?.midi??null,n.highwayConfig.userPitch?.clarity??0)}ne(M,n.highwayConfig.nowLineX,n.viewport.containerHeight),n.highwayConfig.showOnrampCountdown&&n.highwayConfig.onrampBeatsRemaining!==void 0&&V(M,n.highwayConfig.onrampBeatsRemaining),n.highwayConfig.userPitch&&n.highwayConfig.userPitch.clarity>.5&&Et(M,F,n.highwayConfig.userPitch.midi,n.highwayConfig.userPitch.clarity,n.highwayConfig.nowLineX,B,n.fullRowData)}function Ce(M,F){if(!n.highwayConfig?.scrollingGridData||n.highwayConfig.scrollOffset===void 0)return;const B=n.highwayConfig.scrollingGridData,oe=n.highwayConfig.scrollOffset,ge=O(B.macrobeatGroupings);for(let re=0;re<ge.length;re++){const ie=ge[re]*n.cellWidth-oe;if(ie>=-n.cellWidth&&ie<=t(U)+n.cellWidth){const ke=B.macrobeatBoundaryStyles[re]||"solid",De=ke==="solid"?2:1,Ue=ke==="dashed"?[5,5]:[];M.strokeStyle="#495057",M.lineWidth=De,M.setLineDash(Ue),M.beginPath(),M.moveTo(ie,0),M.lineTo(ie,n.viewport.containerHeight),M.stroke(),M.setLineDash([])}}const Me={cellWidth:n.cellWidth,cellHeight:n.cellHeight,columnWidths:B.columnWidths,degreeDisplayMode:s(),accidentalMode:r(),longNoteStyle:y(),colorMode:i()};for(const re of B.placedNotes){if(re.isDrum||re.globalRow===void 0||!gt(re.globalRow,n.viewport,n.cellHeight,F))continue;const Ie=re.startColumnIndex*n.cellWidth-oe;if(re.endColumnIndex*n.cellWidth-oe>=-n.cellWidth&&Ie<=t(U)+n.cellWidth){const ke={...F,getColumnX:Ue=>Ue*n.cellWidth-oe},De={config:Me,coords:ke,allNotes:B.placedNotes};re.shape==="oval"?Lt(M,De,re,re.globalRow):re.shape==="circle"&&Dt(M,De,re,re.globalRow)}}}function ne(M,F,B){M.strokeStyle="rgba(255, 0, 0, 0.9)",M.lineWidth=3,M.beginPath(),M.moveTo(F,0),M.lineTo(F,B),M.stroke()}function V(M,F){M.fillStyle="rgba(0, 0, 0, 0.7)",M.fillRect(t(U)/2-40,10,80,50),M.fillStyle="#ffffff",M.font="bold 36px sans-serif",M.textAlign="center",M.textBaseline="middle",M.fillText(F.toString(),t(U)/2,35)}function $(M,F,B){const oe={fullRowData:n.fullRowData,cellWidth:n.cellWidth,cellHeight:n.cellHeight,legendColumnWidth:t(L),colorMode:i(),showFrequencyLabels:o(),showOctaveLabels:a(),accidentalMode:r(),highlight:n.legendHighlight},ge={startRow:F,endRow:B,coords:M};Pi(t(R),t(C),oe,ge)}function O(M){const F=[];let B=0;for(const oe of M)B+=oe,F.push(B);return F}function A(){if(t(_))return;function M(){J(),W(_,requestAnimationFrame(M),!0)}W(_,requestAnimationFrame(M),!0)}function K(){t(_)&&(cancelAnimationFrame(t(_)),W(_,null))}function ae(){if(!t(p)||(W(P,t(p).getContext("2d"),!0),!t(P)))return;const M=window.devicePixelRatio||1;t(p).width=t(U)*M,t(p).height=n.viewport.containerHeight*M,t(p).style.width=`${t(U)}px`,t(p).style.height=`${n.viewport.containerHeight}px`,t(P).scale(M,M),t(b)&&(W(R,t(b).getContext("2d"),!0),t(R)&&(t(b).width=t(N)*M,t(b).height=n.viewport.containerHeight*M,t(b).style.width=`${t(N)}px`,t(b).style.height=`${n.viewport.containerHeight}px`,t(R).scale(M,M))),t(T)&&(W(C,t(T).getContext("2d"),!0),t(C)&&(t(T).width=t(N)*M,t(T).height=n.viewport.containerHeight*M,t(T).style.width=`${t(N)}px`,t(T).style.height=`${n.viewport.containerHeight}px`,t(C).scale(M,M))),J(),(t(Q)||t(S))&&A()}$t(()=>{ae()}),Ye(()=>{K()}),Re(()=>{n.mode,n.viewport,n.cellWidth,n.cellHeight,i(),s(),l(),d(),m(),t(P)&&t(te)&&J()}),Re(()=>{n.mode,t(Q)||t(S)?A():(K(),t(P)&&J())}),Re(()=>{n.viewport.containerWidth,n.viewport.containerHeight,t(P)&&t(p)&&ae()});var ue=xi(),be=v(ue);{var we=M=>{var F=Ci();Ne(F,B=>W(b,B),()=>t(b)),k(M,F)};ee(be,M=>{t(H)&&M(we)})}var me=w(be,2);Ne(me,M=>W(p,M),()=>t(p));var X=w(me,2);{var se=M=>{var F=Si();Ne(F,B=>W(T,B),()=>t(T)),k(M,F)};ee(X,M=>{t(H)&&c()&&M(se)})}k(e,ue),ye()}const Wt={isDetecting:!1,visualizationMode:"highway",tonic:"C",useDegrees:!1,showAccidentals:!0,pitchHighlightEnabled:!0,yAxisRange:{minMidi:40,maxMidi:72},drone:{isPlaying:!1,octave:3,volume:-12}};function Ai(){let e=z(Le({...Wt}));return{get state(){return t(e)},toggleDetecting(){t(e).isDetecting=!t(e).isDetecting},setDetecting(n){t(e).isDetecting=n},setVisualizationMode(n){t(e).visualizationMode=n},setTonic(n){t(e).tonic=n},setUseDegrees(n){t(e).useDegrees=n},setShowAccidentals(n){t(e).showAccidentals=n},togglePitchHighlight(){t(e).pitchHighlightEnabled=!t(e).pitchHighlightEnabled},setPitchHighlightEnabled(n){t(e).pitchHighlightEnabled=n},setYAxisRange(n){t(e).yAxisRange=n},expandYAxisUpper(){t(e).yAxisRange.maxMidi<108&&(t(e).yAxisRange={...t(e).yAxisRange,maxMidi:t(e).yAxisRange.maxMidi+1})},contractYAxisUpper(){t(e).yAxisRange.maxMidi>t(e).yAxisRange.minMidi+6&&(t(e).yAxisRange={...t(e).yAxisRange,maxMidi:t(e).yAxisRange.maxMidi-1})},expandYAxisLower(){t(e).yAxisRange.minMidi>21&&(t(e).yAxisRange={...t(e).yAxisRange,minMidi:t(e).yAxisRange.minMidi-1})},contractYAxisLower(){t(e).yAxisRange.minMidi<t(e).yAxisRange.maxMidi-6&&(t(e).yAxisRange={...t(e).yAxisRange,minMidi:t(e).yAxisRange.minMidi+1})},toggleDrone(){t(e).drone={...t(e).drone,isPlaying:!t(e).drone.isPlaying}},setDroneOctave(n){t(e).drone={...t(e).drone,octave:n}},setDroneVolume(n){t(e).drone={...t(e).drone,volume:n}},reset(){W(e,{...Wt},!0)}}}const j=Ai(),Ri=200,Bt={currentPitch:null,history:[],stablePitch:{pitchClass:null,midi:null,opacity:0,size:1}};function Ni(){let e=z(Le({...Bt}));return{get state(){return t(e)},setCurrentPitch(n){t(e).currentPitch=n},addHistoryPoint(n){t(e).history.push(n),t(e).history.length>Ri&&t(e).history.shift()},setStablePitch(n){t(e).stablePitch=n},clearHistory(){t(e).history=[]},reset(){W(e,{...Bt},!0)}}}const ce=Ni(),Gt={isPlaying:!1,startTime:null,currentTimeMs:0,targetNotes:[],nowLineX:100,pixelsPerSecond:200,timeWindowMs:4e3};function ki(){let e=z(Le({...Gt})),n=null,i=null,s=null;function r(l){return l.map((d,m)=>({id:`target-${m}`,midi:d.midi,startTimeMs:d.startTimeMs,durationMs:d.durationMs,startColumn:0,endColumn:0,color:"#3b82f6",shape:"oval",globalRow:0}))}function o(){if(!n)return;const l=n.getState();t(e).isPlaying=l.isPlaying&&!l.isPaused,t(e).currentTimeMs=l.currentTimeMs;const d=n.getPerformanceResults();t(e).targetNotes=t(e).targetNotes.map((m,g)=>{const f=`target-${g}`,y=d.get(f);return{...m,hit:y?.hitStatus==="hit"}})}function a(){t(e).isPlaying&&n?(o(),i=requestAnimationFrame(a)):i=null}function c(){n&&n.dispose(),n=zn({judgmentLinePosition:t(e).nowLineX/800,pixelsPerSecond:t(e).pixelsPerSecond,lookAheadMs:t(e).timeWindowMs,scrollMode:"constant-speed",leadInBeats:0,playMetronomeDuringOnramp:!1,playTargetNotes:!1,playMetronome:!1,inputSources:["microphone"],feedbackConfig:{onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70},stateCallbacks:{getTempo:()=>120,getCellWidth:()=>20,getViewportWidth:()=>800},eventCallbacks:{emit:(d,m)=>{if(console.debug("[Highway]",d,m),d==="noteHit"){const g=m;console.log(`[Highway] Note HIT: ${g.noteId}, accuracy: ${g.performance.accuracyTier||"unknown"}`)}else d==="noteMissed"?console.log(`[Highway] Note MISSED: ${m.noteId}`):d==="onrampComplete"?console.log("[Highway] Onramp complete, playback starting!"):d==="performanceComplete"&&(console.log("[Highway] Performance complete!"),s&&n&&s(n.getPerformanceResults()))}}});const l=r(t(e).targetNotes);n.init(l)}return{get state(){return t(e)},get engineService(){return n},start(){!n&&t(e).targetNotes.length>0&&c(),n&&(n.start(),t(e).isPlaying=!0,t(e).startTime=performance.now(),t(e).currentTimeMs=0,a())},stop(){n&&n.stop(),t(e).isPlaying=!1,i!==null&&(cancelAnimationFrame(i),i=null)},pause(){n&&n.pause(),t(e).isPlaying=!1,i!==null&&(cancelAnimationFrame(i),i=null)},resume(){n&&(n.resume(),t(e).isPlaying=!0,a())},setTargetNotes(l){if(t(e).targetNotes=l,n){const d=r(l);n.init(d)}},markNoteHit(l){l>=0&&l<t(e).targetNotes.length&&(t(e).targetNotes=t(e).targetNotes.map((d,m)=>m===l?{...d,hit:!0}:d))},setNowLineX(l){t(e).nowLineX=l},setPixelsPerSecond(l){t(e).pixelsPerSecond=l},setTimeWindowMs(l){t(e).timeWindowMs=l},recordPitchInput(l,d){n&&t(e).isPlaying&&n.recordPitchInput(l,d,"microphone")},getPerformanceResults(){return n?.getPerformanceResults()??new Map},setCurrentTime(l){t(e).currentTimeMs=l,n&&n.setScrollOffset(l)},onPerformanceComplete(l){return s=l,()=>{s=null}},reset(){i!==null&&(cancelAnimationFrame(i),i=null),n&&(n.dispose(),n=null),W(e,{...Gt},!0)}}}const de=ki(),Hi={numLoops:5,minMidi:48,maxMidi:72,tempo:108,referenceVolume:-12},Yt={isActive:!1,isPlaying:!1,config:{...Hi},currentLoop:0,currentPhase:"reference",currentPitch:null,generatedNotes:[],results:[]};function Li(e,n){return Math.floor(Math.random()*(n-e+1))+e}function qt(e){return 60/e*1e3/2}function Di(){let e=z(Le({...Yt}));function n(s){const r=[],o=qt(s.tempo),a=2e3;for(let c=0;c<s.numLoops;c++){const l=Li(s.minMidi,s.maxMidi),d=a+c*32*o;r.push({midi:l,startTimeMs:d,durationMs:8*o,lyric:"ðŸ‘‚"}),r.push({midi:l,startTimeMs:d+16*o,durationMs:8*o,lyric:"ðŸŽ¤"})}return r}function i(s,r){const o=qt(r),a=32*o,l=s-2e3;if(l<0)return{loop:0,phase:"rest2"};const d=Math.floor(l/a),m=l%a,g=Math.floor(m/o);let f;return g<8?f="reference":g<16?f="rest1":g<24?f="input":f="rest2",{loop:d,phase:f}}return{get state(){return t(e)},configure(s){t(e).config={...t(e).config,...s}},setPitchRange(s,r){t(e).config.minMidi=s,t(e).config.maxMidi=r},start(){const s=n(t(e).config);t(e).generatedNotes=s,t(e).isActive=!0,t(e).isPlaying=!1,t(e).currentLoop=0,t(e).currentPhase="reference",t(e).currentPitch=s.length>0?s[0].midi:null,t(e).results=[]},stop(){t(e).isActive=!1,t(e).isPlaying=!1,t(e).currentLoop=0,t(e).currentPhase="reference",t(e).currentPitch=null},setPlaying(s){t(e).isPlaying=s},updatePhase(s){const{loop:r,phase:o}=i(s,t(e).config.tempo);t(e).currentLoop=r,t(e).currentPhase=o;const a=r*2;a<t(e).generatedNotes.length&&(t(e).currentPitch=t(e).generatedNotes[a].midi)},addResult(s){t(e).results.push(s)},hasResultForLoop(s){return t(e).results.some(r=>r.loopIndex===s)},getResults(){return t(e).results},getCurrentProgress(){return{current:t(e).currentLoop+1,total:t(e).config.numLoops}},getGeneratedNotes(){return t(e).generatedNotes},getAverageAccuracy(){return t(e).results.length===0?0:t(e).results.reduce((r,o)=>r+o.accuracy,0)/t(e).results.length},getHitCount(){return t(e).results.filter(s=>s.performance?.hitStatus==="hit").length},reset(){W(e,{...Yt,config:{...t(e).config}},!0)}}}const he=Di();var Ei=D('<div class="singing-canvas-container svelte-wysbg"><!> <canvas class="pitch-trail-canvas svelte-wysbg"></canvas></div>');function Oi(e,n){pe(n,!0);let i=z(void 0),s=z(800),r=z(400),o=z(void 0),a=z(null),c=z(null),l=0,d=0,m=0;const g=20,f=!0,y=!1,h=I(()=>t(s)>=720),u=3,p=I(()=>g*u),b=I(()=>t(p)*2),T=I(()=>f),P=I(()=>t(T)?t(b)*(t(h)?2:1):0),R=I(()=>Math.max(0,t(s)-t(P))),C=I(()=>t(T)?t(b):0),_=()=>{try{return!!globalThis.__ST_DEBUG_TRAIL}catch{return!1}},x=I(()=>Nn(j.state.yAxisRange.minMidi,j.state.yAxisRange.maxMidi)),L=I(()=>kn({containerHeight:t(r),fullRowData:t(x),preferredCellHeight:40,minCellHeight:20})),N=I(()=>j.state.visualizationMode==="highway"?"highway":"singing"),H=I(()=>60/he.state.config.tempo*1e3),E=2e3,U=I(()=>(()=>{if(!j.state.pitchHighlightEnabled)return;const O=ce.state.stablePitch;if(!(O.pitchClass===null||O.opacity<=.01))return{pitchClass:O.pitchClass,midi:O.midi,opacity:O.opacity,color:"#ffff00"}})());function te(){return de.state.targetNotes.map((O,A)=>({id:`target-${A}`,midi:O.midi,startTimeMs:O.startTimeMs,durationMs:O.durationMs,label:O.lyric}))}const Q=I(()=>({timeWindowMs:4e3,pixelsPerSecond:200,circleRadius:9.5,proximityThreshold:35,maxConnections:3,connectorLineWidth:2.5,connectorColor:"rgba(0,0,0,0.4)",useTonicRelativeColors:!0,tonicPitchClass:Xn(j.state.tonic),clarityThreshold:.5,maxOpacity:.9})),S=I(()=>t(N)==="singing"?{userPitch:ce.state.currentPitch?{frequency:ce.state.currentPitch.frequency,midi:ce.state.currentPitch.midi,clarity:ce.state.currentPitch.clarity,pitchClass:ce.state.currentPitch.pitchClass}:null,pitchHistory:[],targetNotes:[],pixelsPerSecond:200,timeWindowMs:4e3,trailConfig:t(Q)}:void 0),q=I(()=>t(N)==="highway"?{userPitch:ce.state.currentPitch?{frequency:ce.state.currentPitch.frequency,midi:ce.state.currentPitch.midi,clarity:ce.state.currentPitch.clarity,pitchClass:ce.state.currentPitch.pitchClass}:null,pitchHistory:[],targetNotes:te(),nowLineX:de.state.nowLineX,pixelsPerSecond:de.state.pixelsPerSecond,currentTimeMs:de.state.currentTimeMs,timeWindowMs:de.state.timeWindowMs,trailConfig:t(Q)}:void 0),J=I(()=>({startRow:t(L).startRow,endRow:t(L).endRow,zoomLevel:1,containerWidth:t(s),containerHeight:t(r)}));function le(){if(!t(o))return;const O=window.devicePixelRatio||1;t(o).width=t(R)*O,t(o).height=t(r)*O,t(o).style.width=`${t(R)}px`,t(o).style.height=`${t(r)}px`,t(o).style.left=`${t(C)}px`;const A=t(o).getContext("2d");if(!A){W(a,null);return}A.setTransform(O,0,0,O,0,0),W(a,A,!0)}function Te(){if(!t(a)||t(R)<=0)return;t(a).clearRect(0,0,t(R),t(r));const O=ce.state.history;if(O.length===0)return;const A=t(N)==="singing"?t(S):t(q);if(!A)return;const K=_(),ae=K?performance.now():0,ue=t(N)==="highway"&&t(q)?t(q).nowLineX:100,be=an({cellHeight:t(L).cellHeight,viewport:t(J),pixelsPerSecond:A.pixelsPerSecond??200,nowLineX:ue,currentTimeMs:t(N)==="highway"&&t(q)?t(q).currentTimeMs:0}),we={cellHeight:t(L).cellHeight,viewportWidth:t(R),nowLineX:ue,pixelsPerSecond:A.pixelsPerSecond??200,timeWindowMs:A.timeWindowMs??4e3,colorMode:"color",trailConfig:t(Q)},me=performance.now();if(dn(t(a),be,O,me,we,t(x)),K){const X=performance.now();if(d+=1,m+=X-ae,X-l>=1e3){const se=d>0?m/d:0;console.log(`[SingingTrail] points=${O.length} avgMs=${se.toFixed(2)} gridWidth=${t(R)}`),l=X,d=0,m=0}}}function Pe(){if(t(c))return;const O=()=>{Te(),W(c,requestAnimationFrame(O),!0)};W(c,requestAnimationFrame(O),!0)}function Ce(){t(c)&&(cancelAnimationFrame(t(c)),W(c,null)),t(a)&&t(R)>0&&t(a).clearRect(0,0,t(R),t(r))}Re(()=>{if(!t(i))return;const O=new ResizeObserver(A=>{for(const K of A)W(s,K.contentRect.width,!0),W(r,K.contentRect.height,!0)});return O.observe(t(i)),()=>{O.disconnect()}}),Re(()=>{t(R),t(r),t(C),t(o),le()}),Re(()=>{t(N),t(a),t(N)==="singing"||t(N)==="highway"?Pe():Ce()}),Ye(()=>{Ce()});var ne=Ei(),V=v(ne);Ii(V,{get mode(){return t(N)},get fullRowData(){return t(x)},get viewport(){return t(J)},cellWidth:g,get cellHeight(){return t(L).cellHeight},colorMode:"color",showOctaveLabels:f,showFrequencyLabels:y,get showRightLegend(){return t(h)},get singingConfig(){return t(S)},get highwayConfig(){return t(q)},get legendHighlight(){return t(U)},get beatIntervalMs(){return t(H)},beatTimeOffsetMs:E});var $=w(V,2);Ne($,O=>W(o,O),()=>t(o)),Ne(ne,O=>W(i,O),()=>t(i)),k(e,ne),ye()}const Fi=100,vt=12;function Wi(e){const n=Math.round(e);return(e-n)*Fi}function Bi(e){return Math.round(e)}function Gi(e){return(Math.round(e)%vt+vt)%vt}class Yi{synth=null;scheduledTimeouts=[];volume=null;startTime=0;_isPlaying=!1;get isPlaying(){return this._isPlaying}async init(){await Pt(),this.volume=new Fn(-12).toDestination(),this.synth=new en({oscillator:{type:"triangle"},envelope:{attack:.05,decay:.1,sustain:.9,release:.1}}).connect(this.volume)}setVolume(n){this.volume&&(this.volume.volume.value=n)}scheduleReferenceTones(n){if(!this.synth){console.warn("[ReferenceAudio] Synth not initialized");return}this.clearScheduled(),this.startTime=performance.now(),n.forEach(i=>{const s=i.durationMs/1e3,r=At(i.midi,"midi").toFrequency(),o=window.setTimeout(()=>{this.synth&&(console.log(`[ReferenceAudio] Playing ${i.midi} at ${performance.now()-this.startTime}ms`),this._isPlaying=!0,this.synth.triggerAttackRelease(r,s))},i.startTimeMs),a=window.setTimeout(()=>{this._isPlaying=!1},i.startTimeMs+i.durationMs);this.scheduledTimeouts.push(o,a)}),console.log(`[ReferenceAudio] Scheduled ${n.length} reference tones`)}playTone(n,i){if(!this.synth){console.warn("[ReferenceAudio] Synth not initialized");return}const s=At(n,"midi").toFrequency(),r=i/1e3;this.synth.triggerAttackRelease(s,r)}clearScheduled(){this.scheduledTimeouts.forEach(n=>{window.clearTimeout(n)}),this.scheduledTimeouts=[]}stop(){this.clearScheduled(),this.synth&&this.synth.triggerRelease()}dispose(){this.stop(),this.synth&&(this.synth.dispose(),this.synth=null),this.volume&&(this.volume.dispose(),this.volume=null)}}const je=new Yi,Fe={FFT_SIZE:2048,CLARITY_THRESHOLD:.8,MIN_PITCH_HZ:60,MAX_PITCH_HZ:1600,HIGHLIGHT_CENTS_RANGE:50};let We=null,Be=null,ot=null,He=null,rt=!1;const wt=1;function qi(e){return 12*Math.log2(e/440)+69}function Mt(){if(!rt||!Be||!ot){He=null;return}if(je.isPlaying){ce.addHistoryPoint({frequency:0,midi:0,time:performance.now(),clarity:0}),He=requestAnimationFrame(Mt);return}const e=Be.getValue(),[n,i]=ot.findPitch(e,Gn().sampleRate),s=n!==null&&i>Fe.CLARITY_THRESHOLD&&n>Fe.MIN_PITCH_HZ&&n<Fe.MAX_PITCH_HZ;if(s){const r=qi(n),o={frequency:n,midi:r,clarity:i,pitchClass:Math.round(r)%12};ce.setCurrentPitch(o),ce.addHistoryPoint({frequency:n,midi:r,time:performance.now(),clarity:i}),de.recordPitchInput(r,i)}else ce.addHistoryPoint({frequency:0,midi:0,time:performance.now(),clarity:0});if(s&&ce.state.currentPitch){const r=ce.state.currentPitch.midi,o=Bi(r),a=Wi(r),c=Math.min(Math.abs(a),Fe.HIGHLIGHT_CENTS_RANGE),l=Math.max(0,1-c/Fe.HIGHLIGHT_CENTS_RANGE);ce.setStablePitch({pitchClass:Gi(o),midi:o,opacity:l,size:wt})}else ce.setStablePitch({pitchClass:null,midi:null,opacity:0,size:wt});He=requestAnimationFrame(Mt)}async function Ui(){if(!rt){He!==null&&cancelAnimationFrame(He),We=new Wn,Be=new Bn("waveform",Fe.FFT_SIZE),ot=qn.forFloat32Array(Be.size);try{await Pt(),await We.open(),We.connect(Be),rt=!0,Mt()}catch(e){throw console.error("Microphone access denied or failed:",e),fn(),e}}}function Vi(){rt=!1,fn()}function fn(){He!==null&&(cancelAnimationFrame(He),He=null),We&&(We.close(),We=null),Be=null,ot=null,ce.setStablePitch({pitchClass:null,midi:null,opacity:0,size:wt}),ce.setCurrentPitch(null)}_e(["click"]);let Ae=null,Qe=!1,$e=null;function Xi(){if(!Ae){Ae=new Yn(en,{oscillator:{type:"sawtooth"},envelope:{attack:.3,decay:.1,sustain:.8,release:.5}}).toDestination();const e=Ae.get().oscillator?.type??"unknown";console.log("[DroneAudio] Initialized drone synth",{oscillatorType:e})}return Ae}function hn(e,n){return`${e.replace("b","#").replace("Db","C#").replace("Eb","D#").replace("Gb","F#").replace("Ab","G#").replace("Bb","A#")}${n}`}async function ji(){await Pt();const e=Xi(),n=hn(j.state.tonic,j.state.drone.octave);e.volume.value=j.state.drone.volume,console.log("[DroneAudio] Starting drone",{note:n,volume:e.volume.value}),$e&&e.releaseAll(),$e=n,e.triggerAttack(n),Qe=!0}function zi(){Ae&&Qe&&(Ae.releaseAll(),$e=null,Qe=!1)}function Tt(){if(!Qe||!Ae)return;const e=hn(j.state.tonic,j.state.drone.octave);Ae.volume.value=j.state.drone.volume,console.log("[DroneAudio] Updating drone",{note:e,volume:Ae.volume.value}),e!==$e&&(Ae.releaseAll(),Ae.triggerAttack(e),$e=e)}async function Ki(){Qe?zi():await ji()}var Zi=D("<option> </option>"),Ji=D('<div class="tonic-selector svelte-3w4ray"><label for="tonic-select" class="svelte-3w4ray">Key:</label> <select id="tonic-select" class="svelte-3w4ray"></select></div>');function Qi(e,n){pe(n,!1);const i=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function s(c){const l=c.target;j.setTonic(l.value),Tt()}_t();var r=Ji(),o=w(v(r),2);o.__change=s,Ge(o,5,()=>i,et,(c,l)=>{var d=Zi(),m=v(d),g={};Z(()=>{Y(m,t(l)),g!==(g=t(l))&&(d.value=(d.__value=t(l))??"")}),k(c,d)});var a;tn(o),Z(()=>{a!==(a=j.state.tonic)&&(o.value=(o.__value=j.state.tonic)??"",Ct(o,j.state.tonic))}),k(e,r),ye()}_e(["change"]);var $i=D("<option> </option>"),es=D('<div class="drone-controls svelte-z4onaa"><button> </button> <div class="drone-settings svelte-z4onaa"><label class="svelte-z4onaa">Oct: <select class="svelte-z4onaa"></select></label> <label class="svelte-z4onaa">Vol: <input type="range" min="-40" max="0" class="svelte-z4onaa"/></label></div></div>');function ts(e,n){pe(n,!1);const i=[2,3,4,5];async function s(){await Ki(),j.toggleDrone()}function r(p){const b=p.target;j.setDroneOctave(parseInt(b.value,10)),Tt()}function o(p){const b=p.target;j.setDroneVolume(parseInt(b.value,10)),Tt()}_t();var a=es(),c=v(a);let l;c.__click=s;var d=v(c),m=w(c,2),g=v(m),f=w(v(g));f.__change=r,Ge(f,5,()=>i,et,(p,b)=>{var T=$i(),P=v(T),R={};Z(()=>{Y(P,t(b)),R!==(R=t(b))&&(T.value=(T.__value=t(b))??"")}),k(p,T)});var y;tn(f);var h=w(g,2),u=w(v(h));u.__input=o,Z(()=>{l=qe(c,1,"drone-toggle svelte-z4onaa",null,l,{active:j.state.drone.isPlaying}),Y(d,j.state.drone.isPlaying?"Drone On":"Drone Off"),y!==(y=j.state.drone.octave)&&(f.value=(f.__value=j.state.drone.octave)??"",Ct(f,j.state.drone.octave)),Sn(u,j.state.drone.volume)}),k(e,a),ye()}_e(["click","change","input"]);_e(["click"]);var ns=D('<div class="pitch-wheel-option svelte-i0c5ty"> </div>'),is=D('<div class="pitch-wheel svelte-i0c5ty" role="slider" tabindex="0" aria-valuemin="0"><div class="pitch-wheel-viewport svelte-i0c5ty"><div class="pitch-wheel-options svelte-i0c5ty"></div></div> <div class="pitch-wheel-overlay svelte-i0c5ty"></div></div>');function Ut(e,n){pe(n,!0);let i=fe(n,"selectedIndex",15),s=fe(n,"ariaLabel",3,"Pitch selector");const r=40,o=r;let a=z(void 0),c=z(void 0),l=z(void 0),d=z(!1),m=z(null),g=z(0),f=z(0),y=z(r);const h=I(()=>n.options.map((S,q)=>Math.min(Math.abs(q-i()),3))),u=I(()=>t(c)?.clientHeight??0),p=I(()=>Math.max(0,(t(u)-t(y))/2)),b=I(()=>t(p)+i()*t(y)+t(y)/2),T=I(()=>t(u)>0?t(u)/2-t(b):0);function P(S){if(!n.options||n.options.length===0)return;let q=S;typeof n.onbeforechange=="function"&&(q=n.onbeforechange(S));const J=Math.max(0,Math.min(n.options.length-1,q));if(J!==i()&&(i(J),typeof n.onchange=="function")){const le=n.options[J];le&&n.onchange(J,le)}}function R(S){S!==0&&P(i()+S)}function C(S){S.preventDefault(),S.stopPropagation();const q=Math.sign(S.deltaY);q!==0&&R(q)}function _(S){S.key==="ArrowUp"?(S.preventDefault(),R(-1)):S.key==="ArrowDown"?(S.preventDefault(),R(1)):S.key==="Home"?(S.preventDefault(),P(0)):S.key==="End"&&(S.preventDefault(),P(n.options.length-1))}function x(S){if(S.preventDefault(),W(d,!0),W(m,S.pointerId,!0),W(g,S.clientY,!0),W(f,0),t(a)&&typeof t(a).setPointerCapture=="function")try{t(a).setPointerCapture(S.pointerId)}catch{}}function L(S){if(!t(d)||S.pointerId!==t(m))return;const q=S.clientY-t(g);if(W(g,S.clientY,!0),q===0)return;W(f,t(f)+q);const J=t(y)||o;for(;Math.abs(t(f))>=J;){const le=-Math.sign(t(f));R(le),W(f,t(f)-Math.sign(t(f))*J)}}function N(S){t(d)&&S.pointerId===t(m)&&(W(d,!1),W(m,null),W(f,0),t(a)?.hasPointerCapture?.(S.pointerId)&&t(a).releasePointerCapture(S.pointerId))}Re(()=>{if(!t(l)||!t(c))return;const S=()=>{const J=t(l)?.querySelector(".pitch-wheel-option");J&&W(y,J.offsetHeight||r,!0)};S();const q=new ResizeObserver(()=>{S()});return q.observe(t(c)),()=>{q.disconnect()}});var H=is();H.__keydown=_,H.__pointerdown=x,H.__pointermove=L,H.__pointerup=N;let E;var U=v(H),te=v(U);let Q;Ge(te,23,()=>n.options,S=>S.index,(S,q,J)=>{var le=ns(),Te=v(le);Z(()=>{Oe(le,"data-distance",t(h)[t(J)]),Y(Te,t(q).label)}),k(S,le)}),Ne(te,S=>W(l,S),()=>t(l)),Ne(U,S=>W(c,S),()=>t(c)),Ne(H,S=>W(a,S),()=>t(a)),Z(()=>{Oe(H,"aria-label",s()),Oe(H,"aria-valuemax",n.options.length-1),Oe(H,"aria-valuenow",i()),Oe(H,"aria-valuetext",n.options[i()]?.label??""),E=st(H,"",E,{height:n.wheelHeight?`${n.wheelHeight}px`:"100%"}),Q=st(te,"",Q,{"padding-top":`${t(p)??""}px`,"padding-bottom":`${t(p)??""}px`,transform:`translateY(${t(T)??""}px)`})}),Ke("wheel",H,C),Ke("pointercancel",H,N),Ke("pointerleave",H,N),k(e,H),ye()}_e(["keydown","pointerdown","pointermove","pointerup"]);var ss=D('<button type="button"> </button>'),as=D('<div class="preset-buttons svelte-s7fyen"></div>');function os(e,n){pe(n,!0);function i(r){n.onPresetClick(r)}var s=as();Ge(s,21,()=>n.presets,et,(r,o)=>{var a=ss();let c;a.__click=()=>i(t(o));var l=v(a);Z(()=>{c=qe(a,1,"preset-button svelte-s7fyen",null,c,{active:n.activePreset===t(o).label}),Y(l,t(o).label)}),k(r,a)}),k(e,s),ye()}_e(["click"]);const gn=7;function lt(e,n,i){return Number.isFinite(e)?Math.max(n,Math.min(i,Math.round(e))):n}function rs(e,n,i,s=gn){const r=Math.max(0,i-1),o=lt(e,0,r),a=Math.max(1,Math.round(s)),c=Math.max(0,o-(a-1));return lt(n,0,c)}function ls(e,n,i,s=gn){const r=Math.max(0,i-1),o=lt(e,0,r),a=Math.max(1,Math.round(s)),c=Math.min(r,o+(a-1));return lt(n,c,r)}function cs(e){return e.map((n,i)=>({index:i,label:n.pitch,midi:n.midi,toneNote:n.toneNote,frequency:n.frequency}))}function Ee(e,n){const i=e.findIndex(s=>s.midi===n);return i>=0?i:0}function ds(e){return[{label:"Voice I",topIndex:Ee(e,81),bottomIndex:Ee(e,57)},{label:"Voice II",topIndex:Ee(e,72),bottomIndex:Ee(e,48)},{label:"Voice III",topIndex:Ee(e,64),bottomIndex:Ee(e,40)}]}var us=D('<div class="summary-card svelte-s4iox0"><div class="summary-label svelte-s4iox0"> </div> <div class="summary-metadata svelte-s4iox0"> </div></div>'),fs=D('<div class="dual-pitch-wheel svelte-s4iox0"><div class="wheels-container svelte-s4iox0"><div class="wheel-column svelte-s4iox0"><div class="wheel-label svelte-s4iox0">High</div> <!></div> <div class="wheel-column svelte-s4iox0"><div class="wheel-label svelte-s4iox0">Low</div> <!></div></div> <!> <!></div>');function hs(e,n){pe(n,!0);let i=fe(n,"topIndex",15),s=fe(n,"bottomIndex",15),r=fe(n,"minSpan",3,7),o=fe(n,"showSummary",3,!0),a=fe(n,"showPresets",3,!1);const c=I(()=>cs(n.fullRowData)),l=I(()=>({topIndex:i(),bottomIndex:s(),topPitch:n.fullRowData[i()],bottomPitch:n.fullRowData[s()],span:s()-i()+1})),d=I(()=>t(l).topPitch&&t(l).bottomPitch?`${t(l).topPitch.pitch} â€“ ${t(l).bottomPitch.pitch}`:""),m=I(()=>`${t(l).span} ${t(l).span===1?"pitch":"pitches"}`),g=I(()=>!n.presets||n.presets.length===0?void 0:n.presets.find(U=>U.topIndex===i()&&U.bottomIndex===s())?.label);function f(E){return rs(s(),E,t(c).length,r())}function y(E){return ls(i(),E,t(c).length,r())}function h(E,U){i(E),typeof n.onrangechange=="function"&&n.onrangechange(t(l))}function u(E,U){s(E),typeof n.onrangechange=="function"&&n.onrangechange(t(l))}function p(E){i(E.topIndex),s(E.bottomIndex),typeof n.onrangechange=="function"&&n.onrangechange(t(l))}var b=fs(),T=v(b),P=v(T),R=w(v(P),2);Ut(R,{get options(){return t(c)},get selectedIndex(){return i()},onchange:h,onbeforechange:f,get wheelHeight(){return n.wheelHeight},ariaLabel:"High pitch selector"});var C=w(P,2),_=w(v(C),2);Ut(_,{get options(){return t(c)},get selectedIndex(){return s()},onchange:u,onbeforechange:y,get wheelHeight(){return n.wheelHeight},ariaLabel:"Low pitch selector"});var x=w(T,2);{var L=E=>{var U=us(),te=v(U),Q=v(te),S=w(te,2),q=v(S);Z(()=>{Y(Q,t(d)),Y(q,t(m))}),k(E,U)};ee(x,E=>{o()&&E(L)})}var N=w(x,2);{var H=E=>{os(E,{get presets(){return n.presets},get activePreset(){return t(g)},onPresetClick:p})};ee(N,E=>{a()&&n.presets&&n.presets.length>0&&E(H)})}k(e,b),ye()}_e(["change"]);var gs=D('<div class="range-control svelte-150ksck"><h3 class="control-title svelte-150ksck">Pitch Range</h3> <!></div>');function vs(e,n){pe(n,!0);function i(d){const m=ct.findIndex(g=>g.midi===d);return m>=0?m:0}const s=I(()=>i(j.state.yAxisRange.maxMidi)),r=I(()=>i(j.state.yAxisRange.minMidi)),o=ds(ct);function a(d){const m=d.bottomPitch.midi??21,g=d.topPitch.midi??108;j.setYAxisRange({minMidi:m,maxMidi:g})}var c=gs(),l=w(v(c),2);hs(l,{get fullRowData(){return ct},get topIndex(){return t(s)},get bottomIndex(){return t(r)},minSpan:7,onrangechange:a,showSummary:!0,wheelHeight:200,get presets(){return o},showPresets:!0}),k(e,c),ye()}var ms=D('<div class="pitch-highlight-toggle svelte-1v98ldk"><span class="toggle-label svelte-1v98ldk">Pitch Highlight</span> <button> </button></div>');function ps(e,n){pe(n,!1);function i(){j.togglePitchHighlight()}_t();var s=ms(),r=w(v(s),2);let o;r.__click=i;var a=v(r);Z(()=>{o=qe(r,1,"toggle-button svelte-1v98ldk",null,o,{active:j.state.pitchHighlightEnabled}),Y(a,j.state.pitchHighlightEnabled?"On":"Off")}),k(e,s),ye()}_e(["click"]);var ys=D('<button class="start-exercise-btn svelte-16rxcxh">Start Demo Exercise</button>'),bs=D('<button class="stop-exercise-btn svelte-16rxcxh">Stop Exercise</button> <div class="progress-indicator svelte-16rxcxh"> </div> <div class="phase-indicator svelte-16rxcxh"> </div>',1),ws=D('<div><span class="result-loop svelte-16rxcxh"></span> <span class="result-pitch svelte-16rxcxh"> </span> <span class="result-accuracy svelte-16rxcxh"> </span> <span class="result-status svelte-16rxcxh"> </span></div>'),Ms=D('<div class="exercise-results svelte-16rxcxh"><h4 class="results-title svelte-16rxcxh">Results</h4> <div class="results-summary svelte-16rxcxh"><div class="stat svelte-16rxcxh"><span class="stat-label svelte-16rxcxh">Average Accuracy:</span> <span class="stat-value svelte-16rxcxh"> </span></div> <div class="stat svelte-16rxcxh"><span class="stat-label svelte-16rxcxh">Hits:</span> <span class="stat-value svelte-16rxcxh"> </span></div></div> <details class="results-details svelte-16rxcxh"><summary class="results-summary-label svelte-16rxcxh">Detailed Results</summary> <div class="results-list svelte-16rxcxh"></div></details></div>'),Ts=D('<div class="demo-exercise-panel svelte-16rxcxh"><h3 class="panel-title svelte-16rxcxh">Demo Exercise</h3> <details class="settings-details svelte-16rxcxh"><summary class="settings-summary svelte-16rxcxh">Settings</summary> <div class="exercise-settings svelte-16rxcxh"><label class="setting-label svelte-16rxcxh"><span class="label-text svelte-16rxcxh">Number of loops:</span> <input class="setting-input svelte-16rxcxh" type="number" min="1" max="20"/></label> <label class="setting-label svelte-16rxcxh"><span class="label-text svelte-16rxcxh">Tempo (BPM):</span> <input class="setting-input svelte-16rxcxh" type="number" min="60" max="180"/></label> <label class="setting-label svelte-16rxcxh"><span class="label-text svelte-16rxcxh">Reference Volume:</span> <input class="setting-slider svelte-16rxcxh" type="range" min="-40" max="0"/> <span class="volume-value svelte-16rxcxh"> </span></label> <div class="pitch-range-buttons svelte-16rxcxh"><button class="range-btn svelte-16rxcxh">Use Current Range</button> <button class="range-btn svelte-16rxcxh">Use Full Range</button></div></div></details> <div class="exercise-controls svelte-16rxcxh"><!></div> <!></div>');function _s(e,n){pe(n,!0);let i=z(!1),s=z(5),r=z(108),o=z(-12);const a=I(()=>he.state.isActive),c=I(()=>he.state.isPlaying),l=I(()=>he.state.currentPhase),d=I(()=>he.getCurrentProgress()),m=I(()=>he.getResults()),g=I(()=>t(m).length>0),f=I(()=>he.getAverageAccuracy()),y=I(()=>he.getHitCount()),h=I(()=>t(m).length);Re(()=>{if(!t(a)||!t(c))return;const A=de.state.currentTimeMs;he.updatePhase(A)}),Re(()=>{if(!t(a))return;const A=de.getPerformanceResults();he.getGeneratedNotes().forEach((ae,ue)=>{if(ae.lyric!=="ðŸŽ¤")return;const be=`target-${ue}`,we=A.get(be);if(we&&!he.hasResultForLoop(Math.floor(ue/2))){const me=u(we);he.addResult({loopIndex:Math.floor(ue/2),targetPitch:ae.midi,accuracy:me,performance:we})}})});function u(A){return A.hitStatus==="hit"?A.pitchAccuracyCents!==void 0?Math.max(0,100-Math.abs(A.pitchAccuracyCents)/50*100):100:0}Ye(()=>{t(a)&&P()});function p(){const A=j.state.yAxisRange;he.setPitchRange(A.minMidi,A.maxMidi)}function b(){he.setPitchRange(21,108)}async function T(){j.setVisualizationMode("highway"),he.configure({numLoops:t(s),tempo:t(r),referenceVolume:t(o)}),p(),await je.init(),je.setVolume(t(o)),he.start();const A=he.getGeneratedNotes();de.setTargetNotes(A),de.start(),he.setPlaying(!0);const K=A.filter(ae=>ae.lyric==="ðŸ‘‚");je.scheduleReferenceTones(K)}function P(){je.stop(),de.stop(),he.stop()}function R(A){switch(A){case"reference":return"ðŸ‘‚ Listen";case"input":return"ðŸŽ¤ Sing";default:return"Rest"}}function C(A){return Hn(A)?.pitch||`MIDI ${A}`}var _=Ts(),x=w(v(_),2),L=w(v(x),2),N=v(L),H=w(v(N),2),E=w(N,2),U=w(v(E),2),te=w(E,2),Q=w(v(te),2),S=w(Q,2),q=v(S),J=w(te,2),le=v(J);le.__click=p;var Te=w(le,2);Te.__click=b;var Pe=w(x,2),Ce=v(Pe);{var ne=A=>{var K=ys();K.__click=T,k(A,K)},V=A=>{var K=bs(),ae=Je(K);ae.__click=P;var ue=w(ae,2),be=v(ue),we=w(ue,2),me=v(we);Z(X=>{Y(be,`Loop ${t(d).current??""} / ${t(d).total??""}`),Y(me,X)},[()=>R(t(l))]),k(A,K)};ee(Ce,A=>{t(a)?A(V,!1):A(ne)})}var $=w(Pe,2);{var O=A=>{var K=Ms(),ae=w(v(K),2),ue=v(ae),be=w(v(ue),2),we=v(be),me=w(ue,2),X=w(v(me),2),se=v(X),M=w(ae,2),F=w(v(M),2);Ge(F,21,()=>t(m),et,(B,oe,ge)=>{var Me=ws();let re;var Ie=v(Me);Ie.textContent=`Loop ${ge+1}:`;var ie=w(Ie,2),ke=v(ie),De=w(ie,2),Ue=v(De),vn=w(De,2),mn=v(vn);Z((pn,yn)=>{re=qe(Me,1,"result-item svelte-16rxcxh",null,re,{hit:t(oe).performance?.hitStatus==="hit"}),Y(ke,pn),Y(Ue,`${yn??""}%`),Y(mn,t(oe).performance?.hitStatus==="hit"?"âœ“":"âœ—")},[()=>C(t(oe).targetPitch),()=>t(oe).accuracy.toFixed(0)]),k(B,Me)}),Z(B=>{Y(we,`${B??""}%`),Y(se,`${t(y)??""}/${t(h)??""}`)},[()=>t(f).toFixed(1)]),k(A,K)};ee($,A=>{t(g)&&!t(a)&&A(O)})}Z(()=>{H.disabled=t(a),U.disabled=t(a),Q.disabled=t(a),Y(q,`${t(o)??""} dB`),le.disabled=t(a),Te.disabled=t(a)}),dt(H,()=>t(s),A=>W(s,A)),dt(U,()=>t(r),A=>W(r,A)),dt(Q,()=>t(o),A=>W(o,A)),nn("open","toggle",x,A=>W(i,A),()=>t(i)),k(e,_),ye()}_e(["click"]);const Ps=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,/^([a-zA-Z0-9_-]{11})$/],Cs={gapMs:0,videoGapSec:0,manualOffsetSec:0},xt=60;function Ss(e){try{const n=e.split(/\r?\n/).map(a=>a.trim()),i=xs(n);if(!i.bpm)return{success:!1,error:"Missing required #BPM tag"};const{notes:s,lineBreaks:r,totalBeats:o}=Is(n);return s.length===0?{success:!1,error:"No valid notes found in file"}:{success:!0,song:{metadata:i,notes:s,lineBreaks:r,totalBeats:o}}}catch(n){return{success:!1,error:n instanceof Error?n.message:"Unknown parsing error"}}}function xs(e){const n={};for(const i of e){if(!i.startsWith("#"))continue;const s=i.indexOf(":");if(s===-1)continue;const r=i.slice(1,s).toUpperCase().trim(),o=i.slice(s+1).trim();switch(r){case"TITLE":n.title=o;break;case"ARTIST":n.artist=o;break;case"VIDEO":n.video=o;break;case"VIDEOGAP":n.videoGap=parseFloat(o.replace(",","."))||0;break;case"GAP":n.gap=parseFloat(o.replace(",","."))||0;break;case"BPM":n.bpm=parseFloat(o.replace(",","."))||0;break;case"MP3":case"AUDIO":n.mp3=o;break;case"LANGUAGE":n.language=o;break;case"GENRE":n.genre=o;break;case"YEAR":n.year=parseInt(o)||void 0;break;case"CREATOR":n.creator=o;break;case"COVER":n.cover=o;break;case"BACKGROUND":n.background=o;break;case"PREVIEWSTART":n.previewStart=parseFloat(o.replace(",","."))||0;break}}return{title:n.title||"Unknown Title",artist:n.artist||"Unknown Artist",bpm:n.bpm||0,...n}}function Is(e){const n=[],i=[];let s=0;for(const r of e){if(r.length===0||r.startsWith("#"))continue;const o=r[0];if(o==="E")break;if(o==="-"){const a=r.slice(1).trim().split(/\s+/),c=parseInt(a[0])||0;i.push(c);continue}if([":","*","F","R"].includes(o)){const a=As(r);if(a){n.push(a);const c=a.startBeat+a.duration;c>s&&(s=c)}}}return{notes:n,lineBreaks:i,totalBeats:s}}function As(e){const n=e[0],s=e.slice(1).trim().split(/\s+/);if(s.length<3)return null;const r=parseInt(s[0]),o=parseInt(s[1]),a=parseInt(s[2]),c=s.slice(3).join(" ")||"";return isNaN(r)||isNaN(o)||isNaN(a)?null:{type:n,startBeat:r,duration:o,pitch:a,lyric:c}}function Rs(e){if(!e)return null;const n=e.trim();for(const i of Ps){const s=n.match(i);if(s&&s[1])return s[1]}return null}function Vt(e,n=xt){const{metadata:i,notes:s,lineBreaks:r}=e,{bpm:o}=i,a=60/o*1e3*4;let c=0;const l=[...r].sort((m,g)=>m-g),d=s.length>0?Math.min(...s.map(m=>m.startBeat)):0;return s.filter(m=>m.type!=="F").map(m=>{const g=(m.startBeat-d)*a,f=m.duration*a,y=n+m.pitch;for(;c<l.length&&m.startBeat>=l[c];)c++;const h={midi:y,startTimeMs:g,durationMs:f,lyric:m.lyric.trim()||void 0};return m.type==="*"&&(h.isGolden=!0),h})}function Ns(e){return{gapMs:e.gap||0,videoGapSec:e.videoGap||0,manualOffsetSec:0}}function ks(e){const{metadata:n,notes:i,totalBeats:s}=e,{bpm:r}=n,o=60/r*1e3*4,a=i.length>0?Math.min(...i.map(l=>l.startBeat)):0;return(s-a)*o+2e3}function Xt(e,n=xt){const i=e.notes.filter(o=>o.type!=="F"&&o.type!=="-").map(o=>n+o.pitch);if(i.length===0)return{minMidi:48,maxMidi:72};const s=Math.min(...i),r=Math.max(...i);return{minMidi:Math.max(24,s-3),maxMidi:Math.min(108,r+3)}}const jt={isActive:!1,isLoading:!1,isPlaying:!1,song:null,targetNotes:[],youtubeId:null,syncConfig:{...Cs},baseMidi:xt,totalDurationMs:0,detectedRange:{minMidi:48,maxMidi:72},error:null};function Hs(){let e=z(Le({...jt})),n=null;return{get state(){return t(e)},async loadFile(i){t(e).isLoading=!0,t(e).error=null;try{const s=await i.text(),r=Ss(s);if(!r.success)return t(e).error=r.error,t(e).isLoading=!1,!1;const o=r.song,a=o.metadata.video?Rs(o.metadata.video):null,c=Ns(o.metadata),l=Vt(o,t(e).baseMidi),d=ks(o),m=Xt(o,t(e).baseMidi);return t(e).song=o,t(e).youtubeId=a,t(e).syncConfig=c,t(e).targetNotes=l,t(e).totalDurationMs=d,t(e).detectedRange=m,t(e).isActive=!0,t(e).isLoading=!1,!0}catch(s){return t(e).error=s instanceof Error?s.message:"Failed to load file",t(e).isLoading=!1,!1}},get youtubeOffset(){const{gapMs:i,videoGapSec:s,manualOffsetSec:r}=t(e).syncConfig;return i/1e3+s+r},adjustOffset(i){t(e).syncConfig={...t(e).syncConfig,manualOffsetSec:t(e).syncConfig.manualOffsetSec+i}},setManualOffset(i){t(e).syncConfig={...t(e).syncConfig,manualOffsetSec:i}},resetOffset(){t(e).syncConfig={...t(e).syncConfig,manualOffsetSec:0}},setBaseMidi(i){t(e).baseMidi=i,t(e).song&&(t(e).targetNotes=Vt(t(e).song,i),t(e).detectedRange=Xt(t(e).song,i))},setPlaying(i){t(e).isPlaying=i},onComplete(i){n=i},triggerComplete(){t(e).isPlaying=!1,n&&n()},checkCompletion(i){return!t(e).isPlaying||!t(e).isActive?!1:i>=t(e).totalDurationMs-500?(this.triggerComplete(),!0):!1},get title(){return t(e).song?.metadata.title||""},get artist(){return t(e).song?.metadata.artist||""},get hasVideo(){return t(e).youtubeId!==null},reset(){W(e,{...jt},!0),n=null},unload(){t(e).isActive=!1,t(e).isPlaying=!1,t(e).song=null,t(e).targetNotes=[],t(e).youtubeId=null,t(e).totalDurationMs=0,t(e).error=null}}}const G=Hs();let it=null,ze=!1;function Ls(){return it||(ze&&window.YT&&window.YT.Player?Promise.resolve():(it=new Promise((e,n)=>{if(window.YT&&window.YT.Player){ze=!0,e();return}window.onYouTubeIframeAPIReady=()=>{ze=!0,e()};const i=document.createElement("script");i.src="https://www.youtube.com/iframe_api",i.async=!0,i.onerror=()=>{n(new Error("Failed to load YouTube IFrame API"))},document.head.appendChild(i),setTimeout(()=>{ze||n(new Error("YouTube IFrame API load timeout"))},1e4)}),it))}function Ds(e,n,i={}){if(!ze||!window.YT?.Player)throw new Error("YouTube API not loaded. Call loadYouTubeAPI() first.");const{width:s=320,height:r=180,onReady:o,onStateChange:a,onError:c}=i;return new window.YT.Player(e,{width:s,height:r,videoId:n,playerVars:{autoplay:0,controls:1,disablekb:1,enablejsapi:1,fs:0,modestbranding:1,origin:window.location.origin,playsinline:1,rel:0},events:{onReady:l=>{o?.(l.target)},onStateChange:l=>{a?.(l.data)},onError:l=>{c?.(l.data)}}})}function Es(e){switch(e){case YT.PlayerError.InvalidParam:return"Invalid video ID";case YT.PlayerError.Html5Error:return"HTML5 player error";case YT.PlayerError.VideoNotFound:return"Video not found";case YT.PlayerError.NotAllowedEmbedded:case YT.PlayerError.NotAllowedEmbedded2:return"Video cannot be embedded";default:return"Unknown player error"}}const mt={isApiLoaded:!1,isApiLoading:!1,isPlayerReady:!1,isPlaying:!1,currentTime:0,duration:0,videoId:null,error:null,isEmbeddable:!0,volume:100,isMuted:!1};function Os(){let e=z(Le({...mt})),n=null,i=null,s=null;return{get state(){return t(e)},async initAPI(){if(t(e).isApiLoaded)return!0;if(t(e).isApiLoading)return!1;t(e).isApiLoading=!0,t(e).error=null;try{return await Ls(),t(e).isApiLoaded=!0,t(e).isApiLoading=!1,!0}catch(r){return t(e).error=r instanceof Error?r.message:"Failed to load YouTube API",t(e).isApiLoading=!1,!1}},async loadVideo(r,o){if(!t(e).isApiLoaded&&!await this.initAPI())return!1;if(n){try{n.destroy()}catch{}n=null}return t(e).isPlayerReady=!1,t(e).error=null,t(e).isEmbeddable=!0,t(e).videoId=r,new Promise(a=>{try{n=Ds(o,r,{onReady:c=>{t(e).isPlayerReady=!0,t(e).duration=c.getDuration(),t(e).volume=c.getVolume(),t(e).isMuted=c.isMuted(),a(!0)},onStateChange:c=>{t(e).isPlaying=c===YT.PlayerState.PLAYING,c===YT.PlayerState.ENDED&&(t(e).isPlaying=!1,this.stopSyncLoop())},onError:c=>{t(e).error=Es(c),t(e).isEmbeddable=c!==YT.PlayerError.NotAllowedEmbedded&&c!==YT.PlayerError.NotAllowedEmbedded2,t(e).isPlayerReady=!1,a(!1)}})}catch(c){t(e).error=c instanceof Error?c.message:"Failed to create player",a(!1)}})},play(){n&&t(e).isPlayerReady&&n.playVideo()},pause(){n&&t(e).isPlayerReady&&n.pauseVideo()},stop(){n&&t(e).isPlayerReady&&(n.stopVideo(),t(e).isPlaying=!1),this.stopSyncLoop()},seekTo(r){n&&t(e).isPlayerReady&&(n.seekTo(Math.max(0,r),!0),t(e).currentTime=Math.max(0,r))},getCurrentTime(){return n&&t(e).isPlayerReady?n.getCurrentTime():t(e).currentTime},setVolume(r){const o=Math.max(0,Math.min(100,r));n&&t(e).isPlayerReady&&n.setVolume(o),t(e).volume=o},mute(){n&&t(e).isPlayerReady&&n.mute(),t(e).isMuted=!0},unmute(){n&&t(e).isPlayerReady&&n.unMute(),t(e).isMuted=!1},toggleMute(){t(e).isMuted?this.unmute():this.mute()},startSyncLoop(r,o=250){s=r,i!==null&&clearInterval(i),i=window.setInterval(()=>{if(n&&t(e).isPlayerReady&&t(e).isPlaying){const a=n.getCurrentTime();t(e).currentTime=a,s?.(a)}},o)},stopSyncLoop(){i!==null&&(clearInterval(i),i=null),s=null},correctDrift(r,o=150){if(!n||!t(e).isPlayerReady||!t(e).isPlaying)return!1;const a=n.getCurrentTime();return Math.abs(a-r)*1e3>o?(n.seekTo(r,!0),!0):!1},getVideoUrl(){return t(e).videoId?`https://www.youtube.com/watch?v=${t(e).videoId}`:null},dispose(){if(this.stopSyncLoop(),n){try{n.destroy()}catch{}n=null}W(e,{...mt,isApiLoaded:t(e).isApiLoaded},!0)},reset(){this.dispose(),W(e,{...mt},!0)}}}const ve=Os();function Fs(e){let n={...e.syncConfig};const i=e.driftCheckIntervalMs??250,s=e.maxDriftMs??150;function r(){return n.gapMs/1e3+n.videoGapSec+n.manualOffsetSec}function o(u){return u/1e3+r()}function a(u){return(u-r())*1e3}function c(u,p){const b=o(u),T=p-b,P=Math.abs(T*1e3);if(P>s){const R=a(p);return{driftMs:P,needsCorrection:!0,correctedTransportTimeMs:R}}return{driftMs:P,needsCorrection:!1}}function l(u){n={...n,...u}}function d(u){n.manualOffsetSec+=u}function m(){n.manualOffsetSec=0}function g(){return n.manualOffsetSec}function f(){return r()}function y(){const u=n.manualOffsetSec;return`${u>=0?"+":""}${u.toFixed(2)}s`}function h(){return{intervalMs:i,maxDriftMs:s}}return{getYouTubeOffset:r,getTotalOffset:f,getManualOffset:g,getSyncLoopConfig:h,transportToYouTube:o,youTubeToTransport:a,checkDrift:c,updateConfig:l,adjustManualOffset:d,resetManualOffset:m,formatOffset:y,getConfig:()=>({...n})}}var Ws=D('<div class="youtube-loading svelte-1pmfeb3"><div class="spinner svelte-1pmfeb3"></div> <span>Loading video...</span></div>'),Bs=D('<button class="fallback-btn svelte-1pmfeb3">Open on YouTube â†—</button>'),Gs=D('<div class="youtube-error svelte-1pmfeb3"><span class="error-icon svelte-1pmfeb3">âš ï¸</span> <span class="error-message svelte-1pmfeb3"> </span> <!></div>'),Ys=D('<div class="youtube-placeholder svelte-1pmfeb3"><span class="placeholder-icon svelte-1pmfeb3">ðŸŽ¬</span> <span class="placeholder-text svelte-1pmfeb3">No video loaded</span></div>'),qs=D('<div class="youtube-container svelte-1pmfeb3"><div class="youtube-player svelte-1pmfeb3"></div> <!> <!> <!></div>');function Us(e,n){pe(n,!0);const i=`youtube-player-${Math.random().toString(36).slice(2,9)}`,s=I(()=>ve.state.isApiLoading||ve.state.videoId&&!ve.state.isPlayerReady),r=I(()=>!!ve.state.error),o=I(()=>ve.state.isEmbeddable),a=I(()=>G.state.youtubeId);Re(()=>{t(a)&&ve.loadVideo(t(a),i)}),Ye(()=>{ve.dispose()});function c(){const p=ve.getVideoUrl();p&&window.open(p,"_blank","noopener,noreferrer")}var l=qs(),d=v(l),m=w(d,2);{var g=p=>{var b=Ws();k(p,b)};ee(m,p=>{t(s)&&t(a)&&p(g)})}var f=w(m,2);{var y=p=>{var b=Gs(),T=w(v(b),2),P=v(T),R=w(T,2);{var C=_=>{var x=Bs();x.__click=c,k(_,x)};ee(R,_=>{t(o)||_(C)})}Z(()=>Y(P,ve.state.error)),k(p,b)};ee(f,p=>{t(r)&&p(y)})}var h=w(f,2);{var u=p=>{var b=Ys();k(p,b)};ee(h,p=>{!t(a)&&!t(s)&&!t(r)&&p(u)})}Z(()=>Oe(d,"id",i)),k(e,l),ye()}_e(["click"]);var Vs=D('<div class="sync-controls svelte-1xjjmjf"><div class="sync-header svelte-1xjjmjf"><span class="sync-label svelte-1xjjmjf">Sync Offset</span> <span class="sync-value svelte-1xjjmjf"> </span></div> <div class="sync-buttons svelte-1xjjmjf"><button class="sync-btn coarse svelte-1xjjmjf" title="Earlier by 0.1s">-0.1s</button> <button class="sync-btn fine svelte-1xjjmjf" title="Earlier by 0.01s">-0.01s</button> <button class="sync-btn reset svelte-1xjjmjf" title="Reset offset">0</button> <button class="sync-btn fine svelte-1xjjmjf" title="Later by 0.01s">+0.01s</button> <button class="sync-btn coarse svelte-1xjjmjf" title="Later by 0.1s">+0.1s</button></div> <div class="sync-hint svelte-1xjjmjf">Use arrow keys to adjust (Shift for coarse)</div></div>');function Xs(e,n){pe(n,!0);const i=I(()=>G.state.syncConfig.manualOffsetSec),s=I(()=>G.state.isActive);function r(T){return`${T>=0?"+":""}${T.toFixed(2)}s`}function o(T){G.adjustOffset(T)}function a(){G.resetOffset()}function c(T){if(t(s)&&!(T.target instanceof HTMLInputElement))switch(T.key){case"ArrowLeft":T.preventDefault(),o(T.shiftKey?-.1:-.01);break;case"ArrowRight":T.preventDefault(),o(T.shiftKey?.1:.01);break}}var l=Vs();Ke("keydown",Qt,c);var d=v(l),m=w(v(d),2),g=v(m),f=w(d,2),y=v(f);y.__click=()=>o(-.1);var h=w(y,2);h.__click=()=>o(-.01);var u=w(h,2);u.__click=a;var p=w(u,2);p.__click=()=>o(.01);var b=w(p,2);b.__click=()=>o(.1),Z(T=>{Y(g,T),y.disabled=!t(s),h.disabled=!t(s),u.disabled=!t(s)||t(i)===0,p.disabled=!t(s),b.disabled=!t(s)},[()=>r(t(i))]),k(e,l),ye()}_e(["click"]);var js=D('<span class="spinner svelte-oab1bu"></span> Loading...',1),zs=D('<div class="error-message svelte-oab1bu"> </div>'),Ks=D('<button class="upload-btn svelte-oab1bu"><!></button> <!>',1),Zs=D('<div class="video-section svelte-oab1bu"><!> <!></div>'),Js=D('<button class="play-btn svelte-oab1bu">â–¶ Play</button>'),Qs=D('<button class="stop-btn svelte-oab1bu">â¹ Stop</button>'),$s=D('<div class="progress-info svelte-oab1bu"><span class="time-display svelte-oab1bu"> </span></div>'),ea=D('<div class="song-info svelte-oab1bu"><div class="song-title svelte-oab1bu"> </div> <div class="song-artist svelte-oab1bu"> </div></div> <!> <div class="playback-controls svelte-oab1bu"><!> <button class="unload-btn svelte-oab1bu">Unload</button></div> <!>',1),ta=D('<div class="ultrastar-panel svelte-oab1bu"><h3 class="panel-title svelte-oab1bu">Ultrastar Song</h3> <input type="file" accept=".txt" style="display: none;"/> <!></div>');function na(e,n){pe(n,!0);let i=null,s;const r=I(()=>G.state.isActive),o=I(()=>G.state.isLoading),a=I(()=>G.state.isPlaying),c=I(()=>G.hasVideo),l=I(()=>G.title),d=I(()=>G.artist),m=I(()=>G.state.error);async function g(x){const L=x.target,N=L.files?.[0];if(!N)return;if(await G.loadFile(N)){i=Fs({syncConfig:G.state.syncConfig});const E=G.state.detectedRange;j.setYAxisRange({minMidi:E.minMidi,maxMidi:E.maxMidi}),de.setTargetNotes(G.state.targetNotes),console.log("[Ultrastar] File loaded:",{title:G.title,artist:G.artist,youtubeId:G.state.youtubeId,bpm:G.state.song?.metadata.bpm,gap:G.state.song?.metadata.gap,videoGap:G.state.song?.metadata.videoGap,noteCount:G.state.targetNotes.length,firstNotes:G.state.targetNotes.slice(0,3),lastNotes:G.state.targetNotes.slice(-3),totalDurationMs:G.state.totalDurationMs,pitchRange:E,syncConfig:G.state.syncConfig})}L.value=""}async function f(){if(t(r))if(j.setVisualizationMode("highway"),i&&i.updateConfig(G.state.syncConfig),de.setTargetNotes(G.state.targetNotes),G.setPlaying(!0),t(c)&&ve.state.isPlayerReady){const x=i?.getYouTubeOffset()??0;console.log("[Ultrastar] Starting playback:",{youtubeOffset:x,noteCount:G.state.targetNotes.length,firstNote:G.state.targetNotes[0],syncConfig:G.state.syncConfig}),de.setCurrentTime(0),ve.seekTo(x),ve.play(),u()}else de.start()}function y(){de.stop(),G.setPlaying(!1),ve.pause(),p()}function h(){y(),G.unload(),ve.dispose(),de.reset(),i=null}function u(){ve.startSyncLoop(x=>{if(!i)return;const L=i.youTubeToTransport(x),N=de.state.currentTimeMs;Math.abs(L-N)>50&&de.setCurrentTime(Math.max(0,L))},100)}function p(){ve.stopSyncLoop()}function b(){s?.click()}Ye(()=>{p(),ve.dispose()});var T=ta(),P=w(v(T),2);P.__change=g,Ne(P,x=>s=x,()=>s);var R=w(P,2);{var C=x=>{var L=Ks(),N=Je(L);N.__click=b;var H=v(N);{var E=S=>{var q=js();k(S,q)},U=S=>{var q=xn("Upload Ultrastar .txt");k(S,q)};ee(H,S=>{t(o)?S(E):S(U,!1)})}var te=w(N,2);{var Q=S=>{var q=zs(),J=v(q);Z(()=>Y(J,t(m))),k(S,q)};ee(te,S=>{t(m)&&S(Q)})}Z(()=>N.disabled=t(o)),k(x,L)},_=x=>{var L=ea(),N=Je(L),H=v(N),E=v(H),U=w(H,2),te=v(U),Q=w(N,2);{var S=V=>{var $=Zs(),O=v($);Us(O,{});var A=w(O,2);Xs(A,{}),k(V,$)};ee(Q,V=>{t(c)&&V(S)})}var q=w(Q,2),J=v(q);{var le=V=>{var $=Js();$.__click=f,k(V,$)},Te=V=>{var $=Qs();$.__click=y,k(V,$)};ee(J,V=>{t(a)?V(Te,!1):V(le)})}var Pe=w(J,2);Pe.__click=h;var Ce=w(q,2);{var ne=V=>{var $=$s(),O=v($),A=v(O);Z((K,ae)=>Y(A,`${K??""}s
          / ${ae??""}s`),[()=>Math.floor(de.state.currentTimeMs/1e3),()=>Math.floor(G.state.totalDurationMs/1e3)]),k(V,$)};ee(Ce,V=>{t(a)&&V(ne)})}Z(()=>{Y(E,t(l)),Y(te,t(d)),Pe.disabled=t(a)}),k(x,L)};ee(R,x=>{t(r)?x(_,!1):x(C)})}k(e,T),ye()}_e(["change","click"]);var ia=D('<div class="note-display svelte-fwpoo3"><span class="note-name svelte-fwpoo3"> </span> <span class="octave svelte-fwpoo3"> </span></div> <div class="details svelte-fwpoo3"><span class="frequency"> </span> <span> </span> <span class="clarity"> </span></div>',1),sa=D('<div class="no-pitch svelte-fwpoo3"><span class="placeholder svelte-fwpoo3">---</span> <span class="hint svelte-fwpoo3">Sing or hum into the microphone</span></div>'),aa=D('<div class="pitch-readout svelte-fwpoo3"><!></div>');function oa(e,n){pe(n,!0);const i=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],s=I(()=>()=>{const l=ce.state.currentPitch;if(!l)return null;const d=i[l.pitchClass],m=Math.floor(l.midi/12)-1,g=Math.round((l.midi-Math.round(l.midi))*100);return{name:d,octave:m,frequency:l.frequency.toFixed(1),cents:g,clarity:Math.round(l.clarity*100)}});var r=aa(),o=v(r);{var a=l=>{const d=I(()=>t(s)());var m=ia(),g=Je(m),f=v(g),y=v(f),h=w(f,2),u=v(h),p=w(g,2),b=v(p),T=v(b),P=w(b,2);let R;var C=v(P),_=w(P,2),x=v(_);Z(()=>{Y(y,t(d).name),Y(u,t(d).octave),Y(T,`${t(d).frequency??""} Hz`),R=qe(P,1,"cents svelte-fwpoo3",null,R,{sharp:t(d).cents>0,flat:t(d).cents<0}),Y(C,`${t(d).cents>0?"+":""}${t(d).cents??""}Â¢`),Y(x,`${t(d).clarity??""}%`)}),k(l,m)},c=l=>{var d=sa();k(l,d)};ee(o,l=>{t(s)()?l(a):l(c,!1)})}k(e,r),ye()}const zt={isVisible:!1,summary:null,songTitle:"",artistName:"",source:null},ra={totalNotes:0,notesHit:0,notesMissed:0,accuracyPercent:0,goldenNotesHit:0,goldenNotesTotal:0,phraseResults:[],averagePitchDeviationCents:0};function la(){let e=z(Le({...zt}));return{get state(){return t(e)},show(n,i={}){t(e).summary=n,t(e).songTitle=i.title||"",t(e).artistName=i.artist||"",t(e).source=i.source||null,t(e).isVisible=!0},hide(){t(e).isVisible=!1},clear(){W(e,{...zt},!0)},calculateSummary(n,i){if(i.length===0)return{...ra};let s=0,r=0,o=0,a=0,c=0;const l=new Map;i.forEach((h,u)=>{const p=`target-${u}`,b=n.get(p),T=h.isGolden===!0,P=h.phraseIndex??0;T&&o++,l.has(P)||l.set(P,{hit:0,total:0,lyrics:[]});const R=l.get(P);R.total++,h.lyric&&R.lyrics.push(h.lyric),b?.hitStatus==="hit"&&(s++,R.hit++,T&&r++,typeof b.pitchAccuracyCents=="number"&&(a+=Math.abs(b.pitchAccuracyCents),c++))});const d=i.length,m=d-s,g=d>0?s/d*100:0,f=c>0?a/c:0,y=[];return l.forEach((h,u)=>{y.push({phraseIndex:u,notesHit:h.hit,totalNotes:h.total,accuracyPercent:h.total>0?h.hit/h.total*100:0,lyricPreview:h.lyrics.join("").trim().slice(0,30)||`Phrase ${u+1}`})}),y.sort((h,u)=>h.phraseIndex-u.phraseIndex),{totalNotes:d,notesHit:s,notesMissed:m,accuracyPercent:g,goldenNotesHit:r,goldenNotesTotal:o,phraseResults:y,averagePitchDeviationCents:f}},getLetterGrade(n){return n>=95?"S":n>=90?"A":n>=80?"B":n>=70?"C":n>=60?"D":"F"},getAccuracyColor(n){return n>=90?"var(--color-success, #28a745)":n>=70?"var(--color-warning, #ffc107)":"var(--color-error, #dc3545)"}}}const xe=la();var ca=D('<span class="song-artist svelte-1rv7phe"> </span>'),da=D('<div class="song-info svelte-1rv7phe"><span class="song-title svelte-1rv7phe"> </span> <!></div>'),ua=D('<div class="stat-item missed svelte-1rv7phe"><span class="stat-value svelte-1rv7phe"> </span> <span class="stat-label svelte-1rv7phe">Missed</span></div>'),fa=D('<div class="golden-stats svelte-1rv7phe"><span class="golden-icon svelte-1rv7phe">â­</span> <span class="golden-text svelte-1rv7phe"> </span></div>'),ha=D('<div class="pitch-stats svelte-1rv7phe"><span class="pitch-label">Avg. Pitch Deviation:</span> <span class="pitch-value svelte-1rv7phe"> </span></div>'),ga=D('<div><span class="phrase-lyric svelte-1rv7phe"> </span> <span class="phrase-accuracy svelte-1rv7phe"> </span></div>'),va=D('<details class="phrase-details svelte-1rv7phe"><summary class="phrase-summary svelte-1rv7phe">Phrase Breakdown</summary> <div class="phrase-list svelte-1rv7phe"></div></details>'),ma=D('<button class="action-btn retry-btn svelte-1rv7phe">Try Again</button>'),pa=D('<div class="modal-backdrop svelte-1rv7phe" role="dialog" aria-modal="true" aria-labelledby="results-title" tabindex="-1"><div class="modal-content svelte-1rv7phe"><div class="modal-header svelte-1rv7phe"><h2 id="results-title" class="modal-title svelte-1rv7phe">Results</h2> <!></div> <div class="stats-section svelte-1rv7phe"><div class="grade-display svelte-1rv7phe"><span class="grade-letter svelte-1rv7phe"> </span></div> <div class="accuracy-display svelte-1rv7phe"><span class="accuracy-value svelte-1rv7phe"> </span> <span class="accuracy-label svelte-1rv7phe">Accuracy</span></div> <div class="stats-row svelte-1rv7phe"><div class="stat-item svelte-1rv7phe"><span class="stat-value hit svelte-1rv7phe"> </span> <span class="stat-label svelte-1rv7phe">Hit</span></div> <div class="stat-divider svelte-1rv7phe">/</div> <div class="stat-item svelte-1rv7phe"><span class="stat-value total svelte-1rv7phe"> </span> <span class="stat-label svelte-1rv7phe">Total</span></div> <!></div> <!> <!></div> <!> <div class="modal-actions svelte-1rv7phe"><!> <button class="action-btn close-btn svelte-1rv7phe">Close</button></div></div></div>');function ya(e,n){pe(n,!0);const i=I(()=>xe.state.isVisible),s=I(()=>xe.state.summary),r=I(()=>xe.state.songTitle),o=I(()=>xe.state.artistName),a=I(()=>t(s)?xe.getLetterGrade(t(s).accuracyPercent):"F"),c=I(()=>t(s)?xe.getAccuracyColor(t(s).accuracyPercent):"");function l(){xe.hide(),n.onClose?.()}function d(){xe.hide(),n.onRetry?.()}function m(u){u.target===u.currentTarget&&l()}function g(u){u.key==="Escape"&&t(i)&&l()}var f=In();Ke("keydown",Qt,g);var y=Je(f);{var h=u=>{var p=pa();p.__click=m,p.__keydown=g;var b=v(p),T=v(b),P=w(v(T),2);{var R=X=>{var se=da(),M=v(se),F=v(M),B=w(M,2);{var oe=ge=>{var Me=ca(),re=v(Me);Z(()=>Y(re,`by ${t(o)??""}`)),k(ge,Me)};ee(B,ge=>{t(o)&&ge(oe)})}Z(()=>Y(F,t(r))),k(X,se)};ee(P,X=>{t(r)&&X(R)})}var C=w(T,2),_=v(C);let x;var L=v(_),N=v(L),H=w(_,2);let E;var U=v(H),te=v(U),Q=w(H,2),S=v(Q),q=v(S),J=v(q),le=w(S,4),Te=v(le),Pe=v(Te),Ce=w(le,2);{var ne=X=>{var se=ua(),M=v(se),F=v(M);Z(()=>Y(F,t(s).notesMissed)),k(X,se)};ee(Ce,X=>{t(s).notesMissed>0&&X(ne)})}var V=w(Q,2);{var $=X=>{var se=fa(),M=w(v(se),2),F=v(M);Z(()=>Y(F,`Golden Notes: ${t(s).goldenNotesHit??""}/${t(s).goldenNotesTotal??""}`)),k(X,se)};ee(V,X=>{t(s).goldenNotesTotal>0&&X($)})}var O=w(V,2);{var A=X=>{var se=ha(),M=w(v(se),2),F=v(M);Z(B=>Y(F,`${B??""} cents`),[()=>t(s).averagePitchDeviationCents.toFixed(1)]),k(X,se)};ee(O,X=>{t(s).averagePitchDeviationCents>0&&X(A)})}var K=w(C,2);{var ae=X=>{var se=va(),M=w(v(se),2);Ge(M,21,()=>t(s).phraseResults,et,(F,B)=>{var oe=ga();let ge;var Me=v(oe),re=v(Me),Ie=w(Me,2),ie=v(Ie);Z(ke=>{ge=qe(oe,1,"phrase-item svelte-1rv7phe",null,ge,{perfect:t(B).accuracyPercent===100,good:t(B).accuracyPercent>=70&&t(B).accuracyPercent<100,poor:t(B).accuracyPercent<70}),Y(re,t(B).lyricPreview),Y(ie,`${t(B).notesHit??""}/${t(B).totalNotes??""}
                  (${ke??""}%)`)},[()=>t(B).accuracyPercent.toFixed(0)]),k(F,oe)}),k(X,se)};ee(K,X=>{t(s).phraseResults.length>1&&X(ae)})}var ue=w(K,2),be=v(ue);{var we=X=>{var se=ma();se.__click=d,k(X,se)};ee(be,X=>{n.onRetry&&X(we)})}var me=w(be,2);me.__click=l,Z(X=>{x=st(_,"",x,{"--grade-color":t(c)}),Y(N,t(a)),E=st(H,"",E,{color:t(c)}),Y(te,`${X??""}%`),Y(J,t(s).notesHit),Y(Pe,t(s).totalNotes)},[()=>t(s).accuracyPercent.toFixed(1)]),k(u,p)};ee(y,u=>{t(i)&&t(s)&&u(h)})}k(e,f),ye()}_e(["click","keydown"]);const pt={hasImportedSnapshot:!1,snapshot:null,isLoading:!1,error:null,transpositionSemitones:0};function ba(){let e=z(Le({...pt}));return{get state(){return t(e)},async checkAndConsumeHandoff(){if(!En())return!1;t(e).isLoading=!0,t(e).error=null;try{const i=await On();return i?i.schemaVersion!==It?(t(e).error=`Incompatible snapshot version: ${i.schemaVersion}. Expected: ${It}`,t(e).isLoading=!1,tt(),!1):(t(e).snapshot=i,t(e).hasImportedSnapshot=!0,t(e).isLoading=!1,tt(),console.log("[HandoffState] Successfully imported snapshot",{voices:i.voices.length,microbeatCount:i.timeGrid.microbeatCount,tempo:i.tempo}),!0):(t(e).error="Handoff data expired or not found. Please try exporting again.",t(e).isLoading=!1,tt(),!1)}catch(i){return console.error("[HandoffState] Failed to process handoff",i),t(e).error="Failed to import data from Student Notation.",t(e).isLoading=!1,tt(),!1}},get voices(){return t(e).snapshot?.voices??[]},get timeGrid(){return t(e).snapshot?.timeGrid??null},get tempo(){return t(e).snapshot?.tempo??90},get suggestedPitchRange(){if(!t(e).snapshot)return null;const n=3,i=t(e).snapshot.minMidiPitch,s=t(e).snapshot.maxMidiPitch;return i===void 0||s===void 0?null:{minMidi:Math.max(21,i-n+t(e).transpositionSemitones),maxMidi:Math.min(108,s+n+t(e).transpositionSemitones)}},setTransposition(n){t(e).transpositionSemitones=n},transposeUp(){t(e).transpositionSemitones+=1},transposeDown(){t(e).transpositionSemitones-=1},getTransposedMidi(n){return n+t(e).transpositionSemitones},async bringBackToStudentNotation(){if(!t(e).snapshot){console.warn("[HandoffState] No snapshot to bring back");return}const n={...t(e).snapshot,sourceApp:"singing-trainer",createdAt:Date.now(),voices:t(e).snapshot.voices.map(i=>({...i,notes:i.notes.map(s=>({...s,midiPitch:s.midiPitch+t(e).transpositionSemitones}))}))};try{const i=await Ln(n);console.log("[HandoffState] Handoff slot written for return",i),Dn(i)}catch(i){console.error("[HandoffState] Failed to write return handoff",i)}},clearSnapshot(){W(e,{...pt},!0)},reset(){W(e,{...pt},!0)}}}const Se=ba();var wa=D('<div class="handoff-controls svelte-1qpo30f"><div class="transposition-control svelte-1qpo30f"><button class="transpose-btn svelte-1qpo30f" title="Transpose down">-</button> <span class="transposition-label svelte-1qpo30f"> </span> <button class="transpose-btn svelte-1qpo30f" title="Transpose up">+</button></div> <button class="bring-back-btn svelte-1qpo30f">Bring Back to Student Notation</button></div>'),Ma=D('<div class="error-banner svelte-1qpo30f"> </div>'),Ta=D('<div class="import-info svelte-1qpo30f"><span class="import-label svelte-1qpo30f">Microbeats:</span> <span class="import-value svelte-1qpo30f"> </span></div>'),_a=D('<div class="control-group svelte-1qpo30f"><h3 class="control-group-title svelte-1qpo30f">Imported Material</h3> <div class="import-info svelte-1qpo30f"><span class="import-label svelte-1qpo30f">Voices:</span> <span class="import-value svelte-1qpo30f"> </span></div> <div class="import-info svelte-1qpo30f"><span class="import-label svelte-1qpo30f">Tempo:</span> <span class="import-value svelte-1qpo30f"> </span></div> <!></div>'),Pa=D('<div class="app svelte-1qpo30f"><header class="header svelte-1qpo30f"><h1 class="title svelte-1qpo30f">Singing Trainer</h1> <div class="header-controls svelte-1qpo30f"><!></div></header> <!> <main class="main svelte-1qpo30f"><aside class="sidebar sidebar--left svelte-1qpo30f"><div class="control-group svelte-1qpo30f"><!></div> <div class="control-group svelte-1qpo30f"><!></div> <div class="control-group svelte-1qpo30f"><!></div> <div class="control-group svelte-1qpo30f"><details class="settings-details svelte-1qpo30f"><summary class="settings-summary svelte-1qpo30f">Settings</summary> <div class="settings-content svelte-1qpo30f"><!> <!> <!></div></details></div> <div class="control-group svelte-1qpo30f"><!></div> <!></aside> <section class="canvas-area svelte-1qpo30f"><!></section></main> <!></div>');function Ca(e,n){pe(n,!0);let i=z(!1);Re(()=>de.onPerformanceComplete(V=>{if(G.state.isActive&&G.state.isPlaying){const $=xe.calculateSummary(V,G.state.targetNotes);xe.show($,{title:G.title,artist:G.artist,source:"ultrastar"}),G.setPlaying(!1)}}));function s(){xe.state.source==="ultrastar"?(de.reset(),de.setTargetNotes(G.state.targetNotes),j.setVisualizationMode("highway")):xe.state.source}$t(async()=>{if(await Se.checkAndConsumeHandoff()){console.log("[App] Handoff detected and processed");const V=Se.suggestedPitchRange;V&&j.setYAxisRange(V)}try{await Ui(),j.setDetecting(!0),console.log("[App] Pitch detection auto-started")}catch(V){console.error("[App] Failed to auto-start pitch detection:",V)}}),Ye(()=>{Vi()});const r=I(()=>Se.state.hasImportedSnapshot),o=I(()=>Se.state.transpositionSemitones),a=I(()=>Se.state.error);function c(){Se.bringBackToStudentNotation()}function l(){Se.transposeUp()}function d(){Se.transposeDown()}var m=Pa(),g=v(m),f=w(v(g),2),y=v(f);{var h=ne=>{var V=wa(),$=v(V),O=v($);O.__click=d;var A=w(O,2),K=v(A),ae=w(A,2);ae.__click=l;var ue=w($,2);ue.__click=c,Z(()=>Y(K,`${t(o)>=0?"+":""}${t(o)??""}`)),k(ne,V)};ee(y,ne=>{t(r)&&ne(h)})}var u=w(g,2);{var p=ne=>{var V=Ma(),$=v(V);Z(()=>Y($,t(a))),k(ne,V)};ee(u,ne=>{t(a)&&ne(p)})}var b=w(u,2),T=v(b),P=v(T),R=v(P);oa(R,{});var C=w(P,2),_=v(C);_s(_,{});var x=w(C,2),L=v(x);na(L,{});var N=w(x,2),H=v(N),E=w(v(H),2),U=v(E);Qi(U,{});var te=w(U,2);ts(te,{});var Q=w(te,2);ps(Q,{});var S=w(N,2),q=v(S);vs(q,{});var J=w(S,2);{var le=ne=>{var V=_a(),$=w(v(V),2),O=w(v($),2),A=v(O),K=w($,2),ae=w(v(K),2),ue=v(ae),be=w(K,2);{var we=me=>{var X=Ta(),se=w(v(X),2),M=v(se);Z(()=>Y(M,Se.timeGrid.microbeatCount)),k(me,X)};ee(be,me=>{Se.timeGrid&&me(we)})}Z(()=>{Y(A,Se.voices.length),Y(ue,`${Se.tempo??""} BPM`)}),k(ne,V)};ee(J,ne=>{t(r)&&ne(le)})}var Te=w(T,2),Pe=v(Te);Oi(Pe,{});var Ce=w(b,2);ya(Ce,{onRetry:s}),nn("open","toggle",H,ne=>W(i,ne),()=>t(i)),k(e,m),ye()}_e(["click"]);function Sa(e){const n=An(Ca,{target:e});return{destroy:()=>{Rn(n)}}}const Kt=document.getElementById("app");Kt&&Sa(Kt);
