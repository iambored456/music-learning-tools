import{x as $,a9 as ct,ae as D,aa as rt,Y as L,a1 as H,ai as lt,a2 as ht,Z as dt,aj as mt,ak as ut,al as I,am as ft,u as q,an as U,z as _,ao as pt,g as K,ap as Nt,G as At,M as xt}from"./legacy-BJBcSenI.js";function Q(a){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}class yt{anchor;#e=new Map;#a=new Map;#t=new Map;#n=new Set;#s=!0;constructor(e,s=!0){this.anchor=e,this.#s=s}#i=()=>{var e=$;if(this.#e.has(e)){var s=this.#e.get(e),i=this.#a.get(s);if(i)ct(i),this.#n.delete(s);else{var c=this.#t.get(s);c&&(this.#a.set(s,c.effect),this.#t.delete(s),c.fragment.lastChild.remove(),this.anchor.before(c.fragment),i=c.effect)}for(const[o,t]of this.#e){if(this.#e.delete(o),o===e)break;const n=this.#t.get(t);n&&(D(n.effect),this.#t.delete(t))}for(const[o,t]of this.#a){if(o===s||this.#n.has(o))continue;const n=()=>{if(Array.from(this.#e.values()).includes(o)){var h=document.createDocumentFragment();lt(t,h),h.append(L()),this.#t.set(o,{effect:t,fragment:h})}else D(t);this.#n.delete(o),this.#a.delete(o)};this.#s||!i?(this.#n.add(o),rt(t,n,!1)):n()}}};#o=e=>{this.#e.delete(e);const s=Array.from(this.#e.values());for(const[i,c]of this.#t)s.includes(i)||(D(c.effect),this.#t.delete(i))};ensure(e,s){var i=$,c=ht();if(s&&!this.#a.has(e)&&!this.#t.has(e))if(c){var o=document.createDocumentFragment(),t=L();o.append(t),this.#t.set(e,{effect:H(()=>s(t)),fragment:o})}else this.#a.set(e,H(()=>s(this.anchor)));if(this.#e.set(i,e),c){for(const[n,r]of this.#a)n===e?i.skipped_effects.delete(r):i.skipped_effects.add(r);for(const[n,r]of this.#t)n===e?i.skipped_effects.delete(r.effect):i.skipped_effects.add(r.effect);i.oncommit(this.#i),i.ondiscard(this.#o)}else this.#i()}}function Ut(a,e,s=!1){var i=new yt(a),c=s?mt:0;function o(t,n){i.ensure(t,n)}dt(()=>{var t=!1;e((n,r=!0)=>{t=!0,o(r,n)}),t||o(!1,null)},c)}function zt(a,e,s,i,c,o){var t=a.__className;if(t!==s||t===void 0){var n=ut(s,i,o);n==null?a.removeAttribute("class"):a.className=n,a.__className=s}else if(o&&c!==o)for(var r in o){var h=!!o[r];(c==null||h!==!!c[r])&&a.classList.toggle(r,h)}return o}function Vt(a=!1){const e=I,s=e.l.u;if(!s)return;let i=()=>Nt(e.s);if(a){let c=0,o={};const t=At(()=>{let n=!1;const r=e.s;for(const h in r)r[h]!==o[h]&&(o[h]=r[h],n=!0);return n&&c++,c});i=()=>K(t)}s.b.length&&ft(()=>{z(e,i),U(s.b)}),q(()=>{const c=_(()=>s.m.map(pt));return()=>{for(const o of c)typeof o=="function"&&o()}}),s.a.length&&q(()=>{z(e,i),U(s.a)})}function z(a,e){if(a.l.s)for(const s of a.l.s)K(s);e()}function Ct(a){I===null&&Q(),xt&&I.l!==null?gt(I).m.push(a):q(()=>{const e=_(a);if(typeof e=="function")return e})}function jt(a){I===null&&Q(),Ct(()=>()=>_(a))}function gt(a){var e=a.l;return e.u??={a:[],b:[],m:[]}}const tt=[{pitch:"C8",flatName:"C8",sharpName:"C8",toneNote:"C8",frequency:4186.01,column:"A",hex:"#fcfcfc",isAccidental:!1,midi:108,pitchClass:0,octave:8},{pitch:"B7",flatName:"B7",sharpName:"B7",toneNote:"B7",frequency:3951.07,column:"B",hex:"#fcf7fc",isAccidental:!1,midi:107,pitchClass:11,octave:7},{pitch:"B♭/A♯7",flatName:"B♭7",sharpName:"A♯7",toneNote:"Bb7",frequency:3729.31,column:"A",hex:"#f7f5fd",isAccidental:!0,midi:106,pitchClass:10,octave:7},{pitch:"A7",flatName:"A7",sharpName:"A7",toneNote:"A7",frequency:3520,column:"B",hex:"#f0f4ff",isAccidental:!1,midi:105,pitchClass:9,octave:7},{pitch:"A♭/G♯7",flatName:"A♭7",sharpName:"G♯7",toneNote:"Ab7",frequency:3322.44,column:"A",hex:"#e6f3fd",isAccidental:!0,midi:104,pitchClass:8,octave:7},{pitch:"G7",flatName:"G7",sharpName:"G7",toneNote:"G7",frequency:3135.96,column:"B",hex:"#def3f7",isAccidental:!1,midi:103,pitchClass:7,octave:7},{pitch:"G♭/F♯7",flatName:"G♭7",sharpName:"F♯7",toneNote:"Gb7",frequency:2959.96,column:"A",hex:"#daf2ec",isAccidental:!0,midi:102,pitchClass:6,octave:7},{pitch:"F7",flatName:"F7",sharpName:"F7",toneNote:"F7",frequency:2793.83,column:"B",hex:"#dcefdf",isAccidental:!1,midi:101,pitchClass:5,octave:7},{pitch:"E7",flatName:"E7",sharpName:"E7",toneNote:"E7",frequency:2637.02,column:"A",hex:"#e3ebd1",isAccidental:!1,midi:100,pitchClass:4,octave:7},{pitch:"E♭/D♯7",flatName:"E♭7",sharpName:"D♯7",toneNote:"Eb7",frequency:2489.02,column:"B",hex:"#eee4c8",isAccidental:!0,midi:99,pitchClass:3,octave:7},{pitch:"D7",flatName:"D7",sharpName:"D7",toneNote:"D7",frequency:2349.32,column:"A",hex:"#f8dcc6",isAccidental:!1,midi:98,pitchClass:2,octave:7},{pitch:"D♭/C♯7",flatName:"D♭7",sharpName:"C♯7",toneNote:"Db7",frequency:2217.46,column:"B",hex:"#fcd4cd",isAccidental:!0,midi:97,pitchClass:1,octave:7},{pitch:"C7",flatName:"C7",sharpName:"C7",toneNote:"C7",frequency:2093,column:"A",hex:"#facfdb",isAccidental:!1,midi:96,pitchClass:0,octave:7},{pitch:"B6",flatName:"B6",sharpName:"B6",toneNote:"B6",frequency:1975.53,column:"B",hex:"#efcdeb",isAccidental:!1,midi:95,pitchClass:11,octave:6},{pitch:"B♭/A♯6",flatName:"B♭6",sharpName:"A♯6",toneNote:"Bb6",frequency:1864.66,column:"A",hex:"#ddcff9",isAccidental:!0,midi:94,pitchClass:10,octave:6},{pitch:"A6",flatName:"A6",sharpName:"A6",toneNote:"A6",frequency:1760,column:"B",hex:"#c4d3ff",isAccidental:!1,midi:93,pitchClass:9,octave:6},{pitch:"A♭/G♯6",flatName:"A♭6",sharpName:"G♯6",toneNote:"Ab6",frequency:1661.22,column:"A",hex:"#abd9fa",isAccidental:!0,midi:92,pitchClass:8,octave:6},{pitch:"G6",flatName:"G6",sharpName:"G6",toneNote:"G6",frequency:1567.94,column:"B",hex:"#98dde9",isAccidental:!1,midi:91,pitchClass:7,octave:6},{pitch:"G♭/F♯6",flatName:"G♭6",sharpName:"F♯6",toneNote:"Gb6",frequency:1479.98,column:"A",hex:"#96ddcf",isAccidental:!0,midi:90,pitchClass:6,octave:6},{pitch:"F6",flatName:"F6",sharpName:"F6",toneNote:"F6",frequency:1396.91,column:"B",hex:"#a6d9b0",isAccidental:!1,midi:89,pitchClass:5,octave:6},{pitch:"E6",flatName:"E6",sharpName:"E6",toneNote:"E6",frequency:1318.51,column:"A",hex:"#c0d093",isAccidental:!1,midi:88,pitchClass:4,octave:6},{pitch:"E♭/D♯6",flatName:"E♭6",sharpName:"D♯6",toneNote:"Eb6",frequency:1244.51,column:"B",hex:"#dbc383",isAccidental:!0,midi:87,pitchClass:3,octave:6},{pitch:"D6",flatName:"D6",sharpName:"D6",toneNote:"D6",frequency:1174.66,column:"A",hex:"#efb586",isAccidental:!1,midi:86,pitchClass:2,octave:6},{pitch:"D♭/C♯6",flatName:"D♭6",sharpName:"C♯6",toneNote:"Db6",frequency:1108.73,column:"B",hex:"#f8a99c",isAccidental:!0,midi:85,pitchClass:1,octave:6},{pitch:"C6",flatName:"C6",sharpName:"C6",toneNote:"C6",frequency:1046.5,column:"A",hex:"#f3a2bb",isAccidental:!1,midi:84,pitchClass:0,octave:6},{pitch:"B5",flatName:"B5",sharpName:"B5",toneNote:"B5",frequency:987.77,column:"B",hex:"#e1a3db",isAccidental:!1,midi:83,pitchClass:11,octave:5},{pitch:"B♭/A♯5",flatName:"B♭5",sharpName:"A♯5",toneNote:"Bb5",frequency:932.33,column:"A",hex:"#c3a9f4",isAccidental:!0,midi:82,pitchClass:10,octave:5},{pitch:"A5",flatName:"A5",sharpName:"A5",toneNote:"A5",frequency:880,column:"B",hex:"#9ab2ff",isAccidental:!1,midi:81,pitchClass:9,octave:5},{pitch:"A♭/G♯5",flatName:"A♭5",sharpName:"G♯5",toneNote:"Ab5",frequency:830.61,column:"A",hex:"#67bdf7",isAccidental:!0,midi:80,pitchClass:8,octave:5},{pitch:"G5",flatName:"G5",sharpName:"G5",toneNote:"G5",frequency:783.99,column:"B",hex:"#30c6dc",isAccidental:!1,midi:79,pitchClass:7,octave:5},{pitch:"G♭/F♯5",flatName:"G♭5",sharpName:"F♯5",toneNote:"Gb5",frequency:739.99,column:"A",hex:"#32c8b2",isAccidental:!0,midi:78,pitchClass:6,octave:5},{pitch:"F5",flatName:"F5",sharpName:"F5",toneNote:"F5",frequency:698.46,column:"B",hex:"#6dc281",isAccidental:!1,midi:77,pitchClass:5,octave:5},{pitch:"E5",flatName:"E5",sharpName:"E5",toneNote:"E5",frequency:659.25,column:"A",hex:"#a0b556",isAccidental:!1,midi:76,pitchClass:4,octave:5},{pitch:"E♭/D♯5",flatName:"E♭5",sharpName:"D♯5",toneNote:"Eb5",frequency:622.25,column:"B",hex:"#c5a33f",isAccidental:!0,midi:75,pitchClass:3,octave:5},{pitch:"D5",flatName:"D5",sharpName:"D5",toneNote:"D5",frequency:587.33,column:"A",hex:"#dc9150",isAccidental:!1,midi:74,pitchClass:2,octave:5},{pitch:"D♭/C♯5",flatName:"D♭5",sharpName:"C♯5",toneNote:"Db5",frequency:554.37,column:"B",hex:"#e38475",isAccidental:!0,midi:73,pitchClass:1,octave:5},{pitch:"C5",flatName:"C5",sharpName:"C5",toneNote:"C5",frequency:523.25,column:"A",hex:"#dc7f9d",isAccidental:!1,midi:72,pitchClass:0,octave:5},{pitch:"B4",flatName:"B4",sharpName:"B4",toneNote:"B4",frequency:493.88,column:"B",hex:"#c781c0",isAccidental:!1,midi:71,pitchClass:11,octave:4},{pitch:"B♭/A♯4",flatName:"B♭4",sharpName:"A♯4",toneNote:"Bb4",frequency:466.16,column:"A",hex:"#a68ad8",isAccidental:!0,midi:70,pitchClass:10,octave:4},{pitch:"A4",flatName:"A4",sharpName:"A4",toneNote:"A4",frequency:440,column:"B",hex:"#7d94e0",isAccidental:!1,midi:69,pitchClass:9,octave:4},{pitch:"A♭/G♯4",flatName:"A♭4",sharpName:"G♯4",toneNote:"Ab4",frequency:415.3,column:"A",hex:"#4c9fd5",isAccidental:!0,midi:68,pitchClass:8,octave:4},{pitch:"G4",flatName:"G4",sharpName:"G4",toneNote:"G4",frequency:392,column:"B",hex:"#0fa6ba",isAccidental:!1,midi:67,pitchClass:7,octave:4},{pitch:"G♭/F♯4",flatName:"G♭4",sharpName:"F♯4",toneNote:"Gb4",frequency:369.99,column:"A",hex:"#24a794",isAccidental:!0,midi:66,pitchClass:6,octave:4},{pitch:"F4",flatName:"F4",sharpName:"F4",toneNote:"F4",frequency:349.23,column:"B",hex:"#5aa26a",isAccidental:!1,midi:65,pitchClass:5,octave:4},{pitch:"E4",flatName:"E4",sharpName:"E4",toneNote:"E4",frequency:329.63,column:"A",hex:"#849646",isAccidental:!1,midi:64,pitchClass:4,octave:4},{pitch:"E♭/D♯4",flatName:"E♭4",sharpName:"D♯4",toneNote:"Eb4",frequency:311.13,column:"B",hex:"#a38733",isAccidental:!0,midi:63,pitchClass:3,octave:4},{pitch:"D4",flatName:"D4",sharpName:"D4",toneNote:"D4",frequency:293.66,column:"A",hex:"#b67740",isAccidental:!1,midi:62,pitchClass:2,octave:4},{pitch:"D♭/C♯4",flatName:"D♭4",sharpName:"C♯4",toneNote:"Db4",frequency:277.18,column:"B",hex:"#bc6c5f",isAccidental:!0,midi:61,pitchClass:1,octave:4},{pitch:"C4",flatName:"C4",sharpName:"C4",toneNote:"C4",frequency:261.63,column:"A",hex:"#b56880",isAccidental:!1,midi:60,pitchClass:0,octave:4},{pitch:"B3",flatName:"B3",sharpName:"B3",toneNote:"B3",frequency:246.94,column:"B",hex:"#a3699e",isAccidental:!1,midi:59,pitchClass:11,octave:3},{pitch:"B♭/A♯3",flatName:"B♭3",sharpName:"A♯3",toneNote:"Bb3",frequency:233.08,column:"A",hex:"#8870b1",isAccidental:!0,midi:58,pitchClass:10,octave:3},{pitch:"A3",flatName:"A3",sharpName:"A3",toneNote:"A3",frequency:220,column:"B",hex:"#6578b7",isAccidental:!1,midi:57,pitchClass:9,octave:3},{pitch:"A♭/G♯3",flatName:"A♭3",sharpName:"G♯3",toneNote:"Ab3",frequency:207.65,column:"A",hex:"#3c81ad",isAccidental:!0,midi:56,pitchClass:8,octave:3},{pitch:"G3",flatName:"G3",sharpName:"G3",toneNote:"G3",frequency:196,column:"B",hex:"#0e8696",isAccidental:!1,midi:55,pitchClass:7,octave:3},{pitch:"G♭/F♯3",flatName:"G♭3",sharpName:"F♯3",toneNote:"Gb3",frequency:185,column:"A",hex:"#1b8777",isAccidental:!0,midi:54,pitchClass:6,octave:3},{pitch:"F3",flatName:"F3",sharpName:"F3",toneNote:"F3",frequency:174.61,column:"B",hex:"#478255",isAccidental:!1,midi:53,pitchClass:5,octave:3},{pitch:"E3",flatName:"E3",sharpName:"E3",toneNote:"E3",frequency:164.81,column:"A",hex:"#697836",isAccidental:!1,midi:52,pitchClass:4,octave:3},{pitch:"E♭/D♯3",flatName:"E♭3",sharpName:"D♯3",toneNote:"Eb3",frequency:155.56,column:"B",hex:"#836b27",isAccidental:!0,midi:51,pitchClass:3,octave:3},{pitch:"D3",flatName:"D3",sharpName:"D3",toneNote:"D3",frequency:146.83,column:"A",hex:"#925e32",isAccidental:!1,midi:50,pitchClass:2,octave:3},{pitch:"D♭/C♯3",flatName:"D♭3",sharpName:"C♯3",toneNote:"Db3",frequency:138.59,column:"B",hex:"#96554b",isAccidental:!0,midi:49,pitchClass:1,octave:3},{pitch:"C3",flatName:"C3",sharpName:"C3",toneNote:"C3",frequency:130.81,column:"A",hex:"#905165",isAccidental:!1,midi:48,pitchClass:0,octave:3},{pitch:"B2",flatName:"B2",sharpName:"B2",toneNote:"B2",frequency:123.47,column:"B",hex:"#80527c",isAccidental:!1,midi:47,pitchClass:11,octave:2},{pitch:"B♭/A♯2",flatName:"B♭2",sharpName:"A♯2",toneNote:"Bb2",frequency:116.54,column:"A",hex:"#6a578c",isAccidental:!0,midi:46,pitchClass:10,octave:2},{pitch:"A2",flatName:"A2",sharpName:"A2",toneNote:"A2",frequency:110,column:"B",hex:"#4e5e90",isAccidental:!1,midi:45,pitchClass:9,octave:2},{pitch:"A♭/G♯2",flatName:"A♭2",sharpName:"G♯2",toneNote:"Ab2",frequency:103.83,column:"A",hex:"#2d6488",isAccidental:!0,midi:44,pitchClass:8,octave:2},{pitch:"G2",flatName:"G2",sharpName:"G2",toneNote:"G2",frequency:98,column:"B",hex:"#096875",isAccidental:!1,midi:43,pitchClass:7,octave:2},{pitch:"G♭/F♯2",flatName:"G♭2",sharpName:"F♯2",toneNote:"Gb2",frequency:92.5,column:"A",hex:"#13685b",isAccidental:!0,midi:42,pitchClass:6,octave:2},{pitch:"F2",flatName:"F2",sharpName:"F2",toneNote:"F2",frequency:87.31,column:"B",hex:"#356440",isAccidental:!1,midi:41,pitchClass:5,octave:2},{pitch:"E2",flatName:"E2",sharpName:"E2",toneNote:"E2",frequency:82.41,column:"A",hex:"#505c28",isAccidental:!1,midi:40,pitchClass:4,octave:2},{pitch:"E♭/D♯2",flatName:"E♭2",sharpName:"D♯2",toneNote:"Eb2",frequency:77.78,column:"B",hex:"#63511c",isAccidental:!0,midi:39,pitchClass:3,octave:2},{pitch:"D2",flatName:"D2",sharpName:"D2",toneNote:"D2",frequency:73.42,column:"A",hex:"#6e4724",isAccidental:!1,midi:38,pitchClass:2,octave:2},{pitch:"D♭/C♯2",flatName:"D♭2",sharpName:"C♯2",toneNote:"Db2",frequency:69.3,column:"B",hex:"#713f37",isAccidental:!0,midi:37,pitchClass:1,octave:2},{pitch:"C2",flatName:"C2",sharpName:"C2",toneNote:"C2",frequency:65.41,column:"A",hex:"#6c3c4b",isAccidental:!1,midi:36,pitchClass:0,octave:2},{pitch:"B1",flatName:"B1",sharpName:"B1",toneNote:"B1",frequency:61.74,column:"B",hex:"#603c5d",isAccidental:!1,midi:35,pitchClass:11,octave:1},{pitch:"B♭/A♯1",flatName:"B♭1",sharpName:"A♯1",toneNote:"Bb1",frequency:58.27,column:"A",hex:"#4e4068",isAccidental:!0,midi:34,pitchClass:10,octave:1},{pitch:"A1",flatName:"A1",sharpName:"A1",toneNote:"A1",frequency:55,column:"B",hex:"#38446b",isAccidental:!1,midi:33,pitchClass:9,octave:1},{pitch:"A♭/G♯1",flatName:"A♭1",sharpName:"G♯1",toneNote:"Ab1",frequency:51.91,column:"A",hex:"#1f4964",isAccidental:!0,midi:32,pitchClass:8,octave:1},{pitch:"G1",flatName:"G1",sharpName:"G1",toneNote:"G1",frequency:49,column:"B",hex:"#044b55",isAccidental:!1,midi:31,pitchClass:7,octave:1},{pitch:"G♭/F♯1",flatName:"G♭1",sharpName:"F♯1",toneNote:"Gb1",frequency:46.25,column:"A",hex:"#0c4b41",isAccidental:!0,midi:30,pitchClass:6,octave:1},{pitch:"F1",flatName:"F1",sharpName:"F1",toneNote:"F1",frequency:43.65,column:"B",hex:"#24472c",isAccidental:!1,midi:29,pitchClass:5,octave:1},{pitch:"E1",flatName:"E1",sharpName:"E1",toneNote:"E1",frequency:41.2,column:"A",hex:"#38401a",isAccidental:!1,midi:28,pitchClass:4,octave:1},{pitch:"E♭/D♯1",flatName:"E♭1",sharpName:"D♯1",toneNote:"Eb1",frequency:38.89,column:"B",hex:"#463811",isAccidental:!0,midi:27,pitchClass:3,octave:1},{pitch:"D1",flatName:"D1",sharpName:"D1",toneNote:"D1",frequency:36.71,column:"A",hex:"#4d3017",isAccidental:!1,midi:26,pitchClass:2,octave:1},{pitch:"D♭/C♯1",flatName:"D♭1",sharpName:"C♯1",toneNote:"Db1",frequency:34.65,column:"B",hex:"#4f2a24",isAccidental:!0,midi:25,pitchClass:1,octave:1},{pitch:"C1",flatName:"C1",sharpName:"C1",toneNote:"C1",frequency:32.7,column:"A",hex:"#4a2733",isAccidental:!1,midi:24,pitchClass:0,octave:1},{pitch:"B0",flatName:"B0",sharpName:"B0",toneNote:"B0",frequency:30.87,column:"B",hex:"#41273f",isAccidental:!1,midi:23,pitchClass:11,octave:0},{pitch:"B♭/A♯0",flatName:"B♭0",sharpName:"A♯0",toneNote:"Bb0",frequency:29.14,column:"A",hex:"#342a46",isAccidental:!0,midi:22,pitchClass:10,octave:0},{pitch:"A0",flatName:"A0",sharpName:"A0",toneNote:"A0",frequency:27.5,column:"B",hex:"#242c48",isAccidental:!1,midi:21,pitchClass:9,octave:0}],et=new Map,at=new Map;tt.forEach((a,e)=>{et.set(a.toneNote,e),a.midi!==void 0&&at.set(a.midi,e)});function V(a){return et.get(a)??-1}function bt(a){const e=at.get(a);return e!==void 0?tt[e]:void 0}function Wt(a,e){const s=V(a),i=V(e);return s===-1||i===-1?null:{topIndex:Math.min(s,i),bottomIndex:Math.max(s,i)}}function Yt(a,e){const s=[];for(let i=e;i>=a;i--){const c=bt(i);c&&s.push(c)}return s}const j={COMPRESSION_2_3:2/3,EXPANSION_3_2:3/2};function St(a,e,s=null,i=null,c=null){return{id:`mod_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,measureIndex:a,ratio:e,active:!0,xPosition:s,columnIndex:i,macrobeatIndex:c}}const W=new Array(19).fill(2),vt=["anacrusis","anacrusis","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid"],Y=new Array(16).fill(2),Bt=["dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed"];function Z(a,e){const s=e(a),i=new Map;s.entries.forEach(c=>{c.type==="tonic"&&c.tonicSignUuid&&typeof c.canvasIndex=="number"&&i.set(c.tonicSignUuid,c.canvasIndex)}),Object.entries(a.tonicSignGroups||{}).forEach(([c,o])=>{const t=i.get(c);t!==void 0&&o.forEach(n=>{n.columnIndex=t})})}const Mt={entries:[],visualToCanvas:new Map,visualToTime:new Map,canvasToVisual:new Map,canvasToTime:new Map,timeToCanvas:new Map,timeToVisual:new Map,macrobeatBoundaries:[],totalVisualColumns:0,totalCanvasColumns:0,totalTimeColumns:0,totalWidthUnmodulated:0};function Zt(a={}){const{getColumnMap:e=()=>Mt,visualToTimeIndex:s=()=>null,timeIndexToVisualColumn:i=()=>null,getTimeBoundaryAfterMacrobeat:c=()=>0,log:o=()=>{}}=a;return{setAnacrusis(t){if(this.state.hasAnacrusis===t)return;const n=[...this.state.macrobeatGroupings],r=[...this.state.macrobeatBoundaryStyles],h=n.reduce((N,f)=>N+f,0);let m,u;if(t){const N=this._anacrusisCache,f=W.length-Y.length,C=W.slice(0,f),S=vt.slice(0,f),x=N?.groupings?.length?[...N.groupings]:[...C],l=N?.boundaryStyles?.length?[...N.boundaryStyles]:[...S];if(m=[...x,...n],u=[...l,...r],!N?.boundaryStyles?.length)for(let d=0;d<l.length;d++)u[d]=d<l.length-1?"anacrusis":"solid";this._anacrusisCache=null,o("debug","rhythmActions","Enabled anacrusis",{insertedCount:x.length,insertedColumns:x.reduce((d,y)=>d+y,0)},"state")}else{const N=r.findIndex(x=>x==="solid");let f=0;if(N!==-1)f=N+1;else for(;f<r.length&&r[f]==="anacrusis";)f++;f=Math.min(f,n.length);const C=n.slice(0,f),S=r.slice(0,f);f>0?this._anacrusisCache={groupings:C,boundaryStyles:S}:this._anacrusisCache=null,m=n.slice(f),u=r.slice(f).map(x=>x==="anacrusis"?"dashed":x),m.length===0&&(m=[...Y],u=[...Bt]),o("debug","rhythmActions","Disabled anacrusis",{removalCount:f,removedColumns:C.reduce((x,l)=>x+l,0)},"state")}const A=m.reduce((N,f)=>N+f,0)-h;if(this.state.hasAnacrusis=t,this.state.macrobeatGroupings=[...m],this.state.macrobeatBoundaryStyles=[...u],Z(this.state,e),A!==0){const N=[];this.state.placedNotes.forEach(l=>{const d=s(this.state,l.startColumnIndex,n),y=s(this.state,l.endColumnIndex,n);if(d===null||y===null)return;const g=d+A,w=y+A;if(g<0){N.push(l);return}const B=i(this.state,g,m),M=i(this.state,w,m);if(B===null||M===null){N.push(l);return}l.startColumnIndex=B,l.endColumnIndex=M}),N.forEach(l=>{const d=this.state.placedNotes.indexOf(l);d>-1&&this.state.placedNotes.splice(d,1)});const f=[];this.state.sixteenthStampPlacements.forEach(l=>{const d=s(this.state,l.startColumn,n),y=s(this.state,l.endColumn,n);if(d===null||y===null)return;const g=d+A,w=y+A;if(g<0){f.push(l);return}const B=i(this.state,g,m),M=i(this.state,w,m);if(B===null||M===null){f.push(l);return}l.startColumn=B,l.endColumn=M}),f.forEach(l=>{const d=this.state.sixteenthStampPlacements.indexOf(l);d>-1&&this.state.sixteenthStampPlacements.splice(d,1)});const C=[];this.state.tripletStampPlacements&&(this.state.tripletStampPlacements.forEach(l=>{const d=l.startTimeIndex+A;d<0?C.push(l):l.startTimeIndex=d}),C.forEach(l=>{const d=this.state.tripletStampPlacements.indexOf(l);d>-1&&this.state.tripletStampPlacements.splice(d,1)}));const S=[],x=t?m.length-n.length:-(n.length-m.length);this.state.modulationMarkers.forEach(l=>{const d=l.measureIndex+x;if(d<0){S.push(l);return}l.measureIndex=d,l.columnIndex=null,l.xPosition=null,l.macrobeatIndex=null}),S.forEach(l=>{const d=this.state.modulationMarkers.indexOf(l);d>-1&&this.state.modulationMarkers.splice(d,1)})}this.emit("anacrusisChanged",t),this.emit("notesChanged"),this.emit("sixteenthStampPlacementsChanged"),this.emit("tripletStampPlacementsChanged"),this.emit("modulationMarkersChanged"),this.emit("rhythmStructureChanged"),this.recordState()},toggleMacrobeatGrouping(t){if(t===void 0||t<0||t>=this.state.macrobeatGroupings.length){o("error","rhythmActions",`Invalid index for toggleMacrobeatGrouping: ${t}`,null,"state");return}const n=[...this.state.macrobeatGroupings],r=n[t],h=r===2?3:2,m=h-r,u=[...n];u[t]=h;const p=c(this.state,t,n),A=[];this.state.placedNotes.forEach(N=>{const f=s(this.state,N.startColumnIndex,n),C=s(this.state,N.endColumnIndex,n);if(!(f===null||C===null)&&f>=p){const S=f+m,x=C+m,l=i(this.state,S,u),d=i(this.state,x,u);l!==null&&d!==null?(N.startColumnIndex=l,N.endColumnIndex=d):A.push(N)}}),A.length&&A.forEach(N=>{const f=this.state.placedNotes.indexOf(N);f>-1&&this.state.placedNotes.splice(f,1)}),this.state.macrobeatGroupings=u,Z(this.state,e),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},cycleMacrobeatBoundaryStyle(t){if(t===void 0||t<0||t>=this.state.macrobeatBoundaryStyles.length){o("error","rhythmActions",`Invalid index for cycleMacrobeatBoundaryStyle: ${t}`,null,"state");return}const n=this._isBoundaryInAnacrusis(t);let r;n?r=["dashed","solid","anacrusis"]:r=["dashed","solid"];const h=this.state.macrobeatBoundaryStyles[t]??"dashed",m=r.indexOf(h),u=m===-1?0:(m+1)%r.length,p=r[u]??"dashed";this.state.macrobeatBoundaryStyles[t]=p,this.emit("rhythmStructureChanged"),this.recordState()},_isBoundaryInAnacrusis(t){if(!this.state.hasAnacrusis)return!1;for(let n=0;n<=t;n++)if(this.state.macrobeatBoundaryStyles[n]==="solid")return n===t;return!0},increaseMacrobeatCount(){this.state.macrobeatGroupings.push(2),this.state.macrobeatBoundaryStyles.push("dashed"),this.emit("rhythmStructureChanged"),this.recordState()},decreaseMacrobeatCount(){if(this.state.macrobeatGroupings.length>1){const t=this.state.macrobeatGroupings.length-1,n=c(this.state,t-1,this.state.macrobeatGroupings),r=[];this.state.placedNotes.forEach(u=>{const p=s(this.state,u.startColumnIndex,this.state.macrobeatGroupings);p!==null&&p>=n&&r.push(u)}),r.forEach(u=>{const p=this.state.placedNotes.indexOf(u);p>-1&&this.state.placedNotes.splice(p,1)});const h=[];this.state.sixteenthStampPlacements.forEach(u=>{const p=s(this.state,u.startColumn,this.state.macrobeatGroupings);p!==null&&p>=n&&h.push(u)}),h.forEach(u=>{const p=this.state.sixteenthStampPlacements.indexOf(u);p>-1&&this.state.sixteenthStampPlacements.splice(p,1)});const m=[];this.state.tripletStampPlacements&&(this.state.tripletStampPlacements.forEach(u=>{u.startTimeIndex>=n&&m.push(u)}),m.forEach(u=>{const p=this.state.tripletStampPlacements.indexOf(u);p>-1&&this.state.tripletStampPlacements.splice(p,1)})),this.state.macrobeatGroupings.pop(),this.state.macrobeatBoundaryStyles.pop(),r.length>0&&this.emit("notesChanged"),h.length>0&&this.emit("sixteenthStampPlacementsChanged"),m.length>0&&this.emit("tripletStampPlacementsChanged"),this.emit("rhythmStructureChanged"),this.recordState()}},updateTimeSignature(t,n){if(!Array.isArray(n)||n.length===0){o("error","rhythmActions","Invalid groupings provided to updateTimeSignature",null,"state");return}let r=0,h=0,m=0;for(let l=0;l<this.state.macrobeatGroupings.length;l++){if(m===t){r=l;break}const d=l===this.state.macrobeatGroupings.length-1;(this.state.macrobeatBoundaryStyles[l]==="solid"||d)&&m++}m=0;for(let l=0;l<this.state.macrobeatGroupings.length;l++)if(m===t){const d=l===this.state.macrobeatGroupings.length-1;if(this.state.macrobeatBoundaryStyles[l]==="solid"||d){h=l;break}}else if(m<t){const d=l===this.state.macrobeatGroupings.length-1;(this.state.macrobeatBoundaryStyles[l]==="solid"||d)&&m++}const u=h-r+1,p=n.length,A=this.state.macrobeatGroupings.slice(r,h+1).reduce((l,d)=>l+d,0),f=n.reduce((l,d)=>l+d,0)-A,C=c(this.state,h,this.state.macrobeatGroupings);if(f!==0){const l=(()=>{const y=[...this.state.macrobeatGroupings];return y.splice(r,u,...n),y})(),d=[];this.state.placedNotes.forEach(y=>{const g=s(this.state,y.startColumnIndex,this.state.macrobeatGroupings),w=s(this.state,y.endColumnIndex,this.state.macrobeatGroupings);if(!(g===null||w===null)&&g>=C){const B=g+f,M=w+f,k=i(this.state,B,l),O=i(this.state,M,l);k!==null&&O!==null?(y.startColumnIndex=k,y.endColumnIndex=O):d.push(y)}}),d.length&&d.forEach(y=>{const g=this.state.placedNotes.indexOf(y);g>-1&&this.state.placedNotes.splice(g,1)})}const S=[...n],x=new Array(Math.max(p-1,0)).fill("dashed");if(h<this.state.macrobeatBoundaryStyles.length){const l=this.state.macrobeatBoundaryStyles[h]??"dashed";x.push(l)}this.state.macrobeatGroupings.splice(r,u,...S),this.state.macrobeatBoundaryStyles.splice(r,u-1,...x),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},addModulationMarker(t,n,r=null,h=null,m=null){if(!Object.values(j).includes(n))return o("error","rhythmActions",`Invalid modulation ratio: ${n}`,null,"state"),null;const u=this.state.modulationMarkers.findIndex(A=>A.measureIndex===t||m!==null&&A.macrobeatIndex===m||h!==null&&A.columnIndex===h);if(u!==-1){const A=this.state.modulationMarkers[u];return o("info","rhythmActions",`Replacing existing modulation marker ${A.id} at measure ${t} (old ratio: ${A.ratio}, new ratio: ${n})`,null,"state"),A.ratio=n,A.xPosition=r,h!==null&&(A.columnIndex=h),m!==null&&(A.macrobeatIndex=m),this.emit("modulationMarkersChanged"),this.recordState(),A.id}const p=St(t,n,r,h,m);return this.state.modulationMarkers.push(p),this.state.modulationMarkers.sort((A,N)=>A.measureIndex-N.measureIndex),this.emit("modulationMarkersChanged"),this.recordState(),o("info","rhythmActions",`Added modulation marker ${p.id} at measure ${t} with ratio=${n}, columnIndex=${h}`,null,"state"),p.id},removeModulationMarker(t){const n=this.state.modulationMarkers.findIndex(r=>r.id===t);if(n===-1){o("warn","rhythmActions",`Modulation marker not found: ${t}`,null,"state");return}this.state.modulationMarkers.splice(n,1),this.emit("modulationMarkersChanged"),this.recordState(),o("info","rhythmActions",`Removed modulation marker ${t}`,null,"state")},setModulationRatio(t,n){if(!Object.values(j).includes(n)){o("error","rhythmActions",`Invalid modulation ratio: ${n}`,null,"state");return}const r=this.state.modulationMarkers.find(h=>h.id===t);if(!r){o("warn","rhythmActions",`Modulation marker not found: ${t}`,null,"state");return}r.ratio=n,this.emit("modulationMarkersChanged"),this.recordState(),o("info","rhythmActions",`Updated modulation marker ${t} ratio to ${n}`,null,"state")},moveModulationMarker(t,n){const r=this.state.modulationMarkers.find(h=>h.id===t);if(!r){o("warn","rhythmActions",`Modulation marker not found: ${t}`,null,"state");return}r.measureIndex=n,this.state.modulationMarkers.sort((h,m)=>h.measureIndex-m.measureIndex),this.emit("modulationMarkersChanged"),this.recordState(),o("info","rhythmActions",`Moved modulation marker ${t} to measure ${n}`,null,"state")},toggleModulationMarker(t){const n=this.state.modulationMarkers.find(r=>r.id===t);if(!n){o("warn","rhythmActions",`Modulation marker not found: ${t}`,null,"state");return}n.active=!n.active,this.emit("modulationMarkersChanged"),this.recordState(),o("info","rhythmActions",`Toggled modulation marker ${t} active state to ${n.active}`,null,"state")},clearModulationMarkers(){const t=this.state.modulationMarkers.length;this.state.modulationMarkers=[],this.emit("modulationMarkersChanged"),this.recordState(),o("info","rhythmActions",`Cleared ${t} modulation markers`,null,"state")}}}const E=9,wt=2,Et=5;function b(a,e,s){return Number.isFinite(a)?Math.max(e,Math.min(s,Math.round(a))):e}function It(a){return Number.isFinite(a)?Math.max(1,a):1}function Xt(a,e,{maxStep:s=Et}={}){const i=Math.max(1,Math.round(e)),o=Math.max(1,Math.round(a))/i;let t=1;o>=.85?t=5:o>=.65?t=4:o>=.45?t=3:o>=.25?t=2:t=1;const n=Math.max(1,Math.round(s));return Math.max(1,Math.min(n,t))}function nt(a,e,s){const i=Math.max(0,s-1),c=Math.max(1,Math.round(e)),o=(c-1)/2;let t=Math.round(a-o),n=t+c-1;if(t<0&&(n+=-t,t=0),n>i){const r=n-i;t-=r,n=i}return t=b(t,0,i),n=b(n,t,i),{topIndex:t,bottomIndex:n}}function F(a){return a.bottomIndex-a.topIndex+1}function st(a,e){const s=Math.max(0,e-1),i=b(a.topIndex??0,0,s),c=b(a.bottomIndex??s,0,s);return c<i?{topIndex:c,bottomIndex:i}:{topIndex:i,bottomIndex:c}}function T(a,e,s=E){const i=st(a,e),c=Math.max(1,Math.round(s));if(F(i)>=c)return i;const t=(i.topIndex+i.bottomIndex)/2;return nt(t,c,e)}function Jt(a,e,s,i=E){const c=Math.max(0,s-1),o=b(a.bottomIndex,0,c),t=Math.max(1,Math.round(i)),n=Math.max(0,o-(t-1));return{topIndex:b(e,0,n),bottomIndex:o}}function Kt(a,e,s,i=E){const c=Math.max(0,s-1),o=b(a.topIndex,0,c),t=Math.max(1,Math.round(i)),n=Math.min(c,o+(t-1)),r=b(e,n,c);return{topIndex:o,bottomIndex:r}}function Qt(a,e,s,i=E){const c=Math.max(0,s-1),o=b(a,0,c),t=Math.max(1,Math.round(i)),n=Math.max(0,o-(t-1));return b(e,0,n)}function te(a,e,s,i=E){const c=Math.max(0,s-1),o=b(a,0,c),t=Math.max(1,Math.round(i)),n=Math.min(c,o+(t-1));return b(e,n,c)}function ee(a,e,s){const i=Math.max(0,s-1),c=Math.max(1,F(a)),o=Math.max(0,i+1-c),t=b(a.topIndex+e,0,o),n=Math.min(i,t+c-1);return{topIndex:t,bottomIndex:n}}function ae(a,e,{totalRanks:s,minSpan:i=E,zoomStep:c=wt}){const o=Math.max(0,s-1),t=Math.max(1,Math.round(i)),n=Math.max(0,Math.round(c)),r=st(a,s);if(n===0)return T(r,s,t);const h=F(r);if(e==="in"){if(h<=t)return T(r,s,t);const N=Math.max(t,h-2*n),f=(r.topIndex+r.bottomIndex)/2;return nt(f,N,s)}const m=r.topIndex-n,u=r.bottomIndex+n,p=b(m,0,o),A=b(u,0,o);return T({topIndex:p,bottomIndex:A},s,t)}function ne(a,e,{baseUnit:s,paddingRows:i=1}){if(!a||a<=0||!e||e<=0)return 1;const c=Math.max(1,Math.round(e)+Math.max(0,Math.round(i))),o=It(s);return 2*a/(c*o)}const Gt=40,Dt=20;function se(a){const{containerHeight:e,fullRowData:s,preferredCellHeight:i=Gt,minCellHeight:c=Dt,centerOnMidi:o}=a,t=s.length;if(t===0)return{startRow:0,endRow:0,cellHeight:i,visibleRows:0};const n=Math.max(1,c),r=Math.max(n,i),h=C=>{if(e<=0||C<=0)return 0;const S=C/2;return Math.max(0,Math.floor(e/S)-1)},m=h(r),u=h(n);if(t<=m&&m>0){const C=2*e/(t+1);return{startRow:0,endRow:t-1,cellHeight:C,visibleRows:t}}if(t<=u&&u>0){const C=2*e/(t+1);return{startRow:0,endRow:t-1,cellHeight:C,visibleRows:t}}const p=Math.max(1,u);let A=0,N=p-1;if(o!==void 0&&s[0]){const x=(s[0].midi??108)-Math.round(o);if(x>=0&&x<t){const l=Math.floor(p/2);A=Math.max(0,x-l),N=Math.min(t-1,A+p-1),N===t-1&&(A=Math.max(0,N-p+1))}}const f=2*e/(p+1);return{startRow:A,endRow:N,cellHeight:f,visibleRows:p}}const ie=1,Tt="mlt-handoff",qt=1,v="handoff-slots",R="mlt-handoff-slot",_t=300*1e3;function G(){return new Promise((a,e)=>{const s=indexedDB.open(Tt,qt);s.onerror=()=>{e(new Error("Failed to open IndexedDB"))},s.onsuccess=()=>{a(s.result)},s.onupgradeneeded=i=>{const c=i.target.result;c.objectStoreNames.contains(v)||c.createObjectStore(v,{keyPath:"handoffId"})}})}async function P(){if(typeof indexedDB>"u")return!1;try{return(await G()).close(),!0}catch{return!1}}function Ft(){const a=Date.now().toString(36),e=Math.random().toString(36).substring(2,10);return`handoff-${a}-${e}`}async function Rt(a){const e=await G();return new Promise((s,i)=>{const c=e.transaction(v,"readwrite"),o=c.objectStore(v),t=o.clear();t.onsuccess=()=>{const n=o.add(a);n.onsuccess=()=>{s()},n.onerror=()=>{i(new Error("Failed to write to IndexedDB"))}},t.onerror=()=>{i(new Error("Failed to clear IndexedDB"))},c.oncomplete=()=>{e.close()}})}function X(a){try{const e=JSON.stringify(a);localStorage.setItem(R,e)}catch(e){throw new Error(`Failed to write to localStorage: ${e}`)}}async function oe(a){const e=Ft(),s={snapshot:a,writtenAt:Date.now(),handoffId:e};if(await P())try{return await Rt(s),e}catch{return X(s),e}else return X(s),e}async function Pt(){const a=await G();return new Promise((e,s)=>{const i=a.transaction(v,"readonly"),o=i.objectStore(v).getAll();o.onsuccess=()=>{const t=o.result;t.length>0?e(t[t.length-1]):e(null)},o.onerror=()=>{s(new Error("Failed to read from IndexedDB"))},i.oncomplete=()=>{a.close()}})}function J(){try{const a=localStorage.getItem(R);return a?JSON.parse(a):null}catch{return null}}async function kt(){const a=await P();let e=null;if(a)try{e=await Pt()}catch{e=J()}else e=J();return e?Date.now()-e.writtenAt>_t?(await it(),null):e.snapshot:null}async function Ot(){const a=await G();return new Promise((e,s)=>{const i=a.transaction(v,"readwrite"),o=i.objectStore(v).clear();o.onsuccess=()=>{e()},o.onerror=()=>{s(new Error("Failed to clear IndexedDB"))},i.oncomplete=()=>{a.close()}})}function $t(){try{localStorage.removeItem(R)}catch{}}async function it(){const a=await P();if($t(),a)try{await Ot()}catch{}}async function ce(){const a=await kt();return a&&await it(),a}function Lt(a){switch(a){case"student-notation":return"/student-notation/";case"singing-trainer":return"/singing-trainer/";default:throw new Error(`Unknown app: ${a}`)}}function ot(a,e){let s=Lt(a);if(e&&Object.keys(e).length>0){const i=new URLSearchParams(e);s+=`?${i.toString()}`}window.location.href=s}function re(a){const e={};a&&(e.handoff=a),e.from="student-notation",ot("singing-trainer",e)}function le(a){const e={};a&&(e.handoff=a),e.from="singing-trainer",ot("student-notation",e)}function he(){const a=new URLSearchParams(window.location.search),e=a.get("from"),s=a.get("handoff")??void 0;return e==="student-notation"?{direction:"student-notation-to-singing-trainer",handoffId:s}:e==="singing-trainer"?{direction:"singing-trainer-to-student-notation",handoffId:s}:null}function de(){const a=new URL(window.location.href);a.searchParams.delete("handoff"),a.searchParams.delete("from"),window.history.replaceState({},"",a.toString())}export{de as A,E as D,ie as S,Jt as a,ee as b,Zt as c,Xt as d,ne as e,tt as f,F as g,zt as h,Ut as i,jt as j,Vt as k,re as l,Qt as m,T as n,Ct as o,te as p,Yt as q,Wt as r,Kt as s,se as t,bt as u,le as v,oe as w,he as x,ce as y,ae as z};
