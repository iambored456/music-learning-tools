{"version":3,"file":"index.js","sources":["../src/lib/stores/appState.svelte.ts","../src/lib/stores/pitchState.svelte.ts","../src/lib/stores/highwayState.svelte.ts","../src/lib/stores/demoExerciseState.svelte.ts","../src/lib/components/SingingCanvas.svelte","../src/lib/services/referenceAudio.ts","../src/lib/services/pitchDetection.ts","../src/lib/services/droneAudio.ts","../src/lib/components/controls/TonicSelector.svelte","../src/lib/components/controls/DroneControls.svelte","../src/lib/components/controls/RangeControl.svelte","../src/lib/components/controls/PitchHighlightToggle.svelte","../src/lib/components/controls/DemoExerciseControls.svelte","../src/lib/types/ultrastar.ts","../src/lib/services/ultrastarParser.ts","../src/lib/stores/ultrastarState.svelte.ts","../src/lib/services/youtubePlayer.ts","../src/lib/stores/youtubeState.svelte.ts","../src/lib/services/transportSync.ts","../src/lib/components/youtube/YouTubePlayer.svelte","../src/lib/components/controls/SyncControls.svelte","../src/lib/components/controls/UltrastarControls.svelte","../src/lib/components/feedback/PitchReadout.svelte","../src/lib/stores/resultsState.svelte.ts","../src/lib/components/feedback/ResultsModal.svelte","../src/lib/stores/handoffState.svelte.ts","../src/App.svelte","../src/index.ts"],"sourcesContent":["/**\n * App State Store - Svelte 5 Runes\n *\n * Main application state for the Singing Trainer.\n */\n\nexport type VisualizationMode = 'stationary' | 'highway';\nexport type TonicNote =\n  | 'C'\n  | 'C#'\n  | 'Db'\n  | 'D'\n  | 'D#'\n  | 'Eb'\n  | 'E'\n  | 'F'\n  | 'F#'\n  | 'Gb'\n  | 'G'\n  | 'G#'\n  | 'Ab'\n  | 'A'\n  | 'A#'\n  | 'Bb'\n  | 'B';\n\nexport interface DroneState {\n  isPlaying: boolean;\n  octave: number;\n  volume: number;\n}\n\nexport interface YAxisRange {\n  minMidi: number;\n  maxMidi: number;\n}\n\nexport interface AppState {\n  isDetecting: boolean;\n  visualizationMode: VisualizationMode;\n  tonic: TonicNote;\n  useDegrees: boolean;\n  showAccidentals: boolean;\n  pitchHighlightEnabled: boolean;\n  yAxisRange: YAxisRange;\n  drone: DroneState;\n}\n\nconst DEFAULT_STATE: AppState = {\n  isDetecting: false,\n  visualizationMode: 'highway',\n  tonic: 'C',\n  useDegrees: false,\n  showAccidentals: true,\n  pitchHighlightEnabled: true,\n  yAxisRange: { minMidi: 48, maxMidi: 72 }, // C3 to C5\n  drone: { isPlaying: false, octave: 3, volume: -12 },\n};\n\nfunction createAppState() {\n  let state = $state<AppState>({ ...DEFAULT_STATE });\n\n  return {\n    get state() {\n      return state;\n    },\n\n    toggleDetecting() {\n      state.isDetecting = !state.isDetecting;\n    },\n\n    setDetecting(isDetecting: boolean) {\n      state.isDetecting = isDetecting;\n    },\n\n    setVisualizationMode(mode: VisualizationMode) {\n      state.visualizationMode = mode;\n    },\n\n    setTonic(tonic: TonicNote) {\n      state.tonic = tonic;\n    },\n\n    setUseDegrees(useDegrees: boolean) {\n      state.useDegrees = useDegrees;\n    },\n\n    setShowAccidentals(show: boolean) {\n      state.showAccidentals = show;\n    },\n\n    togglePitchHighlight() {\n      state.pitchHighlightEnabled = !state.pitchHighlightEnabled;\n    },\n\n    setPitchHighlightEnabled(enabled: boolean) {\n      state.pitchHighlightEnabled = enabled;\n    },\n\n    setYAxisRange(range: YAxisRange) {\n      state.yAxisRange = range;\n    },\n\n    expandYAxisUpper() {\n      if (state.yAxisRange.maxMidi < 108) {\n        state.yAxisRange = { ...state.yAxisRange, maxMidi: state.yAxisRange.maxMidi + 1 };\n      }\n    },\n\n    contractYAxisUpper() {\n      if (state.yAxisRange.maxMidi > state.yAxisRange.minMidi + 6) {\n        state.yAxisRange = { ...state.yAxisRange, maxMidi: state.yAxisRange.maxMidi - 1 };\n      }\n    },\n\n    expandYAxisLower() {\n      if (state.yAxisRange.minMidi > 21) {\n        state.yAxisRange = { ...state.yAxisRange, minMidi: state.yAxisRange.minMidi - 1 };\n      }\n    },\n\n    contractYAxisLower() {\n      if (state.yAxisRange.minMidi < state.yAxisRange.maxMidi - 6) {\n        state.yAxisRange = { ...state.yAxisRange, minMidi: state.yAxisRange.minMidi + 1 };\n      }\n    },\n\n    toggleDrone() {\n      state.drone = { ...state.drone, isPlaying: !state.drone.isPlaying };\n    },\n\n    setDroneOctave(octave: number) {\n      state.drone = { ...state.drone, octave };\n    },\n\n    setDroneVolume(volume: number) {\n      state.drone = { ...state.drone, volume };\n    },\n\n    reset() {\n      state = { ...DEFAULT_STATE };\n    },\n  };\n}\n\nexport const appState = createAppState();\n","/**\n * Pitch State Store - Svelte 5 Runes\n *\n * Real-time pitch detection state including current pitch and history.\n */\n\nexport interface DetectedPitch {\n  frequency: number;\n  midi: number;\n  clarity: number;\n  pitchClass: number;\n}\n\nexport interface PitchHistoryPoint {\n  frequency: number;\n  midi: number;\n  time: number;\n  clarity: number;\n}\n\nexport interface StablePitch {\n  pitchClass: number | null;\n  opacity: number;\n  size: number;\n}\n\nexport interface PitchState {\n  currentPitch: DetectedPitch | null;\n  history: PitchHistoryPoint[];\n  stablePitch: StablePitch;\n}\n\nconst MAX_HISTORY_LENGTH = 200; // Cap history to bound trail render cost\n\nconst DEFAULT_STATE: PitchState = {\n  currentPitch: null,\n  history: [],\n  stablePitch: { pitchClass: null, opacity: 0, size: 1.0 },\n};\n\nfunction createPitchState() {\n  let state = $state<PitchState>({ ...DEFAULT_STATE });\n\n  return {\n    get state() {\n      return state;\n    },\n\n    setCurrentPitch(pitch: DetectedPitch | null) {\n      state.currentPitch = pitch;\n    },\n\n    addHistoryPoint(point: PitchHistoryPoint) {\n      state.history.push(point);\n      if (state.history.length > MAX_HISTORY_LENGTH) {\n        state.history.shift();\n      }\n    },\n\n    setStablePitch(stable: StablePitch) {\n      state.stablePitch = stable;\n    },\n\n    clearHistory() {\n      state.history = [];\n    },\n\n    reset() {\n      state = { ...DEFAULT_STATE };\n    },\n  };\n}\n\nexport const pitchState = createPitchState();\n","/**\n * Highway State Store - Svelte 5 Runes\n *\n * State for the \"Guitar Hero\" note highway visualization mode.\n * Now uses the @mlt/student-notation-engine highway service.\n */\n\nimport {\n  createNoteHighwayService,\n  type NoteHighwayServiceInstance,\n  type HighwayTargetNote,\n  type NotePerformance,\n} from '@mlt/student-notation-engine';\n\nexport interface TargetNote {\n  midi: number;\n  startTimeMs: number;\n  durationMs: number;\n  hit?: boolean;\n  lyric?: string; // For emoji/text display on notes\n}\n\nexport interface HighwayState {\n  isPlaying: boolean;\n  startTime: number | null;\n  currentTimeMs: number;\n  targetNotes: TargetNote[];\n  nowLineX: number;\n  pixelsPerSecond: number;\n  timeWindowMs: number;\n}\n\nconst DEFAULT_STATE: HighwayState = {\n  isPlaying: false,\n  startTime: null,\n  currentTimeMs: 0,\n  targetNotes: [],\n  nowLineX: 100, // Position of the \"now\" line from left edge\n  pixelsPerSecond: 200,\n  timeWindowMs: 4000,\n};\n\nfunction createHighwayState() {\n  let state = $state<HighwayState>({ ...DEFAULT_STATE });\n  let engineService: NoteHighwayServiceInstance | null = null;\n  let animationFrameId: number | null = null;\n  let performanceCompleteCallback: ((results: Map<string, NotePerformance>) => void) | null = null;\n\n  // Convert local TargetNote to engine HighwayTargetNote\n  function convertToEngineFormat(notes: TargetNote[]): HighwayTargetNote[] {\n    return notes.map((note, index) => ({\n      id: `target-${index}`,\n      midi: note.midi,\n      startTimeMs: note.startTimeMs,\n      durationMs: note.durationMs,\n      startColumn: 0, // Not used in target notes mode\n      endColumn: 0,   // Not used in target notes mode\n      color: '#3b82f6',\n      shape: 'oval' as const,\n      globalRow: 0,\n    }));\n  }\n\n  // Sync engine state to local state\n  function syncEngineState() {\n    if (!engineService) return;\n\n    const engineState = engineService.getState();\n    state.isPlaying = engineState.isPlaying && !engineState.isPaused;\n    state.currentTimeMs = engineState.currentTimeMs;\n\n    // Update hit status from engine performance\n    const performances = engineService.getPerformanceResults();\n    state.targetNotes = state.targetNotes.map((note, index) => {\n      const noteId = `target-${index}`;\n      const perf = performances.get(noteId);\n      return {\n        ...note,\n        hit: perf?.hitStatus === 'hit',\n      };\n    });\n  }\n\n  // Animation loop to sync state\n  function animate() {\n    if (state.isPlaying && engineService) {\n      syncEngineState();\n      animationFrameId = requestAnimationFrame(animate);\n    } else {\n      animationFrameId = null;\n    }\n  }\n\n  function initializeEngine() {\n    if (engineService) {\n      engineService.dispose();\n    }\n\n    // Create engine service with minimal config\n    engineService = createNoteHighwayService({\n      judgmentLinePosition: state.nowLineX / 800, // Assume 800px viewport\n      pixelsPerSecond: state.pixelsPerSecond,\n      lookAheadMs: state.timeWindowMs,\n      scrollMode: 'constant-speed',\n      leadInBeats: 0, // No onramp for singing trainer\n      playMetronomeDuringOnramp: false,\n      playTargetNotes: false,\n      playMetronome: false,\n      inputSources: ['microphone'],\n      feedbackConfig: {\n        onsetToleranceMs: 100,\n        releaseToleranceMs: 150,\n        pitchToleranceCents: 50,\n        hitThreshold: 70,\n      },\n      stateCallbacks: {\n        getTempo: () => 120,\n        getCellWidth: () => 20,\n        getViewportWidth: () => 800,\n      },\n      eventCallbacks: {\n        emit: (event, data) => {\n          // Log highway events for debugging\n          console.debug('[Highway]', event, data);\n\n          // Handle specific events with visual feedback (placeholder for Phase 6)\n          if (event === 'noteHit') {\n            const hitData = data as { noteId: string; note: any; performance: any };\n            console.log(\n              `[Highway] Note HIT: ${hitData.noteId}, accuracy: ${hitData.performance.accuracyTier || 'unknown'}`\n            );\n            // TODO Phase 6: Trigger visual effects (glow, particles, emboldening)\n          } else if (event === 'noteMissed') {\n            const missData = data as { noteId: string; note: any; performance: any };\n            console.log(`[Highway] Note MISSED: ${missData.noteId}`);\n            // TODO Phase 6: Trigger visual effects (fade, shake, miss indicator)\n          } else if (event === 'onrampComplete') {\n            console.log('[Highway] Onramp complete, playback starting!');\n          } else if (event === 'performanceComplete') {\n            console.log('[Highway] Performance complete!');\n            // Trigger callback with results\n            if (performanceCompleteCallback && engineService) {\n              performanceCompleteCallback(engineService.getPerformanceResults());\n            }\n          }\n        },\n      },\n    });\n\n    // Initialize with target notes\n    const engineNotes = convertToEngineFormat(state.targetNotes);\n    engineService.init(engineNotes);\n  }\n\n  return {\n    get state() {\n      return state;\n    },\n\n    get engineService() {\n      return engineService;\n    },\n\n    start() {\n      if (!engineService && state.targetNotes.length > 0) {\n        initializeEngine();\n      }\n\n      if (engineService) {\n        engineService.start();\n        state.isPlaying = true;\n        state.startTime = performance.now();\n        state.currentTimeMs = 0;\n        animate();\n      }\n    },\n\n    stop() {\n      if (engineService) {\n        engineService.stop();\n      }\n      state.isPlaying = false;\n      if (animationFrameId !== null) {\n        cancelAnimationFrame(animationFrameId);\n        animationFrameId = null;\n      }\n    },\n\n    pause() {\n      if (engineService) {\n        engineService.pause();\n      }\n      state.isPlaying = false;\n      if (animationFrameId !== null) {\n        cancelAnimationFrame(animationFrameId);\n        animationFrameId = null;\n      }\n    },\n\n    resume() {\n      if (engineService) {\n        engineService.resume();\n        state.isPlaying = true;\n        animate();\n      }\n    },\n\n    setTargetNotes(notes: TargetNote[]) {\n      state.targetNotes = notes;\n\n      // Reinitialize engine if it exists\n      if (engineService) {\n        const engineNotes = convertToEngineFormat(notes);\n        engineService.init(engineNotes);\n      }\n    },\n\n    markNoteHit(noteIndex: number) {\n      if (noteIndex >= 0 && noteIndex < state.targetNotes.length) {\n        state.targetNotes = state.targetNotes.map((note, i) =>\n          i === noteIndex ? { ...note, hit: true } : note\n        );\n      }\n    },\n\n    setNowLineX(x: number) {\n      state.nowLineX = x;\n    },\n\n    setPixelsPerSecond(pps: number) {\n      state.pixelsPerSecond = pps;\n    },\n\n    setTimeWindowMs(ms: number) {\n      state.timeWindowMs = ms;\n    },\n\n    recordPitchInput(midi: number, clarity: number) {\n      if (engineService && state.isPlaying) {\n        engineService.recordPitchInput(midi, clarity, 'microphone');\n      }\n    },\n\n    getPerformanceResults(): Map<string, NotePerformance> {\n      return engineService?.getPerformanceResults() ?? new Map();\n    },\n\n    /**\n     * Set current time externally (for YouTube sync)\n     */\n    setCurrentTime(timeMs: number) {\n      state.currentTimeMs = timeMs;\n      if (engineService) {\n        engineService.setScrollOffset(timeMs);\n      }\n    },\n\n    /**\n     * Register callback for performance complete event\n     */\n    onPerformanceComplete(callback: (results: Map<string, NotePerformance>) => void): () => void {\n      performanceCompleteCallback = callback;\n      return () => {\n        performanceCompleteCallback = null;\n      };\n    },\n\n    reset() {\n      if (animationFrameId !== null) {\n        cancelAnimationFrame(animationFrameId);\n        animationFrameId = null;\n      }\n      if (engineService) {\n        engineService.dispose();\n        engineService = null;\n      }\n      state = { ...DEFAULT_STATE };\n    },\n  };\n}\n\nexport const highwayState = createHighwayState();\n","/**\r\n * Demo Exercise State Store - Svelte 5 Runes\r\n *\r\n * Manages the pitch-matching demo exercise with reference tones and graded user input.\r\n */\r\n\r\nimport type { NotePerformance } from '@mlt/student-notation-engine';\r\nimport type { TargetNote } from './highwayState.svelte.js';\r\n\r\nexport interface ExerciseConfig {\r\n  numLoops: number;\r\n  minMidi: number;\r\n  maxMidi: number;\r\n  tempo: number;\r\n  referenceVolume: number; // dB, -60 to 0\r\n}\r\n\r\nexport type ExercisePhase = 'reference' | 'rest1' | 'input' | 'rest2';\r\n\r\nexport interface ExerciseState {\r\n  isActive: boolean;\r\n  isPlaying: boolean;\r\n  config: ExerciseConfig;\r\n  currentLoop: number;\r\n  currentPhase: ExercisePhase;\r\n  currentPitch: number | null;\r\n  generatedNotes: TargetNote[];\r\n  results: ExerciseResult[];\r\n}\r\n\r\nexport interface ExerciseResult {\r\n  loopIndex: number;\r\n  targetPitch: number;\r\n  performance: NotePerformance | null;\r\n  accuracy: number; // 0-100%\r\n}\r\n\r\nconst DEFAULT_CONFIG: ExerciseConfig = {\r\n  numLoops: 5,\r\n  minMidi: 48, // Will be overridden with Y-axis range\r\n  maxMidi: 72,\r\n  tempo: 108,\r\n  referenceVolume: -12, // -12 dB default\r\n};\r\n\r\nconst DEFAULT_STATE: ExerciseState = {\r\n  isActive: false,\r\n  isPlaying: false,\r\n  config: { ...DEFAULT_CONFIG },\r\n  currentLoop: 0,\r\n  currentPhase: 'reference',\r\n  currentPitch: null,\r\n  generatedNotes: [],\r\n  results: [],\r\n};\r\n\r\n/**\r\n * Generate a random MIDI pitch within range\r\n */\r\nfunction randomPitch(minMidi: number, maxMidi: number): number {\r\n  return Math.floor(Math.random() * (maxMidi - minMidi + 1)) + minMidi;\r\n}\r\n\r\n/**\r\n * Calculate microbeat duration in milliseconds\r\n */\r\nfunction getMicrobeatDurationMs(tempo: number): number {\r\n  // Microbeat = eighth note = (60 / tempo) / 2 seconds\r\n  return (60 / tempo) * 1000 / 2;\r\n}\r\n\r\nfunction createDemoExerciseState() {\r\n  let state = $state<ExerciseState>({ ...DEFAULT_STATE });\r\n\r\n  /**\r\n   * Generate exercise notes with emojis\r\n   */\r\n  function generateExerciseNotes(config: ExerciseConfig): TargetNote[] {\r\n    const notes: TargetNote[] = [];\r\n    const microbeatDurationMs = getMicrobeatDurationMs(config.tempo);\r\n\r\n    // Add 2-second lead-in so notes don't start immediately\r\n    const leadInMs = 2000;\r\n\r\n    for (let loop = 0; loop < config.numLoops; loop++) {\r\n      const pitch = randomPitch(config.minMidi, config.maxMidi);\r\n      const loopStartTime = leadInMs + (loop * 32 * microbeatDurationMs);\r\n\r\n      // Reference note (0-8 microbeats) with ðŸ‘‚ emoji\r\n      notes.push({\r\n        midi: pitch,\r\n        startTimeMs: loopStartTime,\r\n        durationMs: 8 * microbeatDurationMs,\r\n        lyric: 'ðŸ‘‚',\r\n      });\r\n\r\n      // Rest 1 (8-16 microbeats) - no note\r\n\r\n      // User input note (16-24 microbeats) with ðŸŽ¤ emoji\r\n      notes.push({\r\n        midi: pitch,\r\n        startTimeMs: loopStartTime + (16 * microbeatDurationMs),\r\n        durationMs: 8 * microbeatDurationMs,\r\n        lyric: 'ðŸŽ¤',\r\n      });\r\n\r\n      // Rest 2 (24-32 microbeats) - no note\r\n    }\r\n\r\n    return notes;\r\n  }\r\n\r\n  /**\r\n   * Determine which phase we're in based on current time\r\n   */\r\n  function getPhaseFromTime(currentTimeMs: number, tempo: number): { loop: number; phase: ExercisePhase } {\r\n    const microbeatDurationMs = getMicrobeatDurationMs(tempo);\r\n    const loopDurationMs = 32 * microbeatDurationMs;\r\n    const leadInMs = 2000;\r\n\r\n    // Subtract lead-in time\r\n    const adjustedTimeMs = currentTimeMs - leadInMs;\r\n\r\n    // During lead-in, show as rest\r\n    if (adjustedTimeMs < 0) {\r\n      return { loop: 0, phase: 'rest2' };\r\n    }\r\n\r\n    const currentLoop = Math.floor(adjustedTimeMs / loopDurationMs);\r\n    const timeInLoop = adjustedTimeMs % loopDurationMs;\r\n    const microbeatInLoop = Math.floor(timeInLoop / microbeatDurationMs);\r\n\r\n    let phase: ExercisePhase;\r\n    if (microbeatInLoop < 8) {\r\n      phase = 'reference';\r\n    } else if (microbeatInLoop < 16) {\r\n      phase = 'rest1';\r\n    } else if (microbeatInLoop < 24) {\r\n      phase = 'input';\r\n    } else {\r\n      phase = 'rest2';\r\n    }\r\n\r\n    return { loop: currentLoop, phase };\r\n  }\r\n\r\n  return {\r\n    get state() {\r\n      return state;\r\n    },\r\n\r\n    /**\r\n     * Update exercise configuration\r\n     */\r\n    configure(newConfig: Partial<ExerciseConfig>) {\r\n      state.config = { ...state.config, ...newConfig };\r\n    },\r\n\r\n    /**\r\n     * Set pitch range from current Y-axis range\r\n     */\r\n    setPitchRange(minMidi: number, maxMidi: number) {\r\n      state.config.minMidi = minMidi;\r\n      state.config.maxMidi = maxMidi;\r\n    },\r\n\r\n    /**\r\n     * Start the demo exercise\r\n     */\r\n    start() {\r\n      // Generate notes\r\n      const notes = generateExerciseNotes(state.config);\r\n\r\n      state.generatedNotes = notes;\r\n      state.isActive = true;\r\n      state.isPlaying = false; // Will be set to true when playback starts\r\n      state.currentLoop = 0;\r\n      state.currentPhase = 'reference';\r\n      state.currentPitch = notes.length > 0 ? notes[0].midi : null;\r\n      state.results = [];\r\n    },\r\n\r\n    /**\r\n     * Stop the exercise\r\n     */\r\n    stop() {\r\n      state.isActive = false;\r\n      state.isPlaying = false;\r\n      state.currentLoop = 0;\r\n      state.currentPhase = 'reference';\r\n      state.currentPitch = null;\r\n    },\r\n\r\n    /**\r\n     * Mark exercise as playing (called when highway starts)\r\n     */\r\n    setPlaying(playing: boolean) {\r\n      state.isPlaying = playing;\r\n    },\r\n\r\n    /**\r\n     * Update current phase based on time\r\n     */\r\n    updatePhase(currentTimeMs: number) {\r\n      const { loop, phase } = getPhaseFromTime(currentTimeMs, state.config.tempo);\r\n      state.currentLoop = loop;\r\n      state.currentPhase = phase;\r\n\r\n      // Update current pitch\r\n      const noteIndex = loop * 2; // 2 notes per loop (reference + input)\r\n      if (noteIndex < state.generatedNotes.length) {\r\n        state.currentPitch = state.generatedNotes[noteIndex].midi;\r\n      }\r\n    },\r\n\r\n    /**\r\n     * Add a performance result for a completed loop\r\n     */\r\n    addResult(result: ExerciseResult) {\r\n      state.results.push(result);\r\n    },\r\n\r\n    /**\r\n     * Check if we already have a result for a specific loop\r\n     */\r\n    hasResultForLoop(loopIndex: number): boolean {\r\n      return state.results.some(r => r.loopIndex === loopIndex);\r\n    },\r\n\r\n    /**\r\n     * Get all results\r\n     */\r\n    getResults(): ExerciseResult[] {\r\n      return state.results;\r\n    },\r\n\r\n    /**\r\n     * Get current progress\r\n     */\r\n    getCurrentProgress(): { current: number; total: number } {\r\n      return {\r\n        current: state.currentLoop + 1,\r\n        total: state.config.numLoops,\r\n      };\r\n    },\r\n\r\n    /**\r\n     * Get generated notes for highway\r\n     */\r\n    getGeneratedNotes(): TargetNote[] {\r\n      return state.generatedNotes;\r\n    },\r\n\r\n    /**\r\n     * Calculate average accuracy from results\r\n     */\r\n    getAverageAccuracy(): number {\r\n      if (state.results.length === 0) return 0;\r\n      const total = state.results.reduce((sum, r) => sum + r.accuracy, 0);\r\n      return total / state.results.length;\r\n    },\r\n\r\n    /**\r\n     * Count hits\r\n     */\r\n    getHitCount(): number {\r\n      return state.results.filter(r => r.performance?.hitStatus === 'hit').length;\r\n    },\r\n\r\n    /**\r\n     * Reset to default state\r\n     */\r\n    reset() {\r\n      state = { ...DEFAULT_STATE, config: { ...state.config } };\r\n    },\r\n  };\r\n}\r\n\r\nexport const demoExerciseState = createDemoExerciseState();\r\n","<script lang=\"ts\">\n  /**\n   * SingingCanvas Component\n   *\n   * Wraps the shared PitchGrid component for singing/highway visualization modes.\n   */\n\n  import { onDestroy } from 'svelte';\n  import {\n    PitchGrid,\n    calculateViewportWindow,\n    createTimeCoordinates,\n    drawUserPitchTrace,\n  } from '@mlt/ui-components/canvas';\n  import type {\n    LegendHighlightConfig,\n    PitchGridMode,\n    PitchGridViewport,\n    SingingModeConfig,\n    HighwayModeConfig,\n    TargetNote as SharedTargetNote,\n    PitchTrailConfig,\n    UserPitchRenderConfig,\n    ViewportWindow,\n  } from '@mlt/ui-components/canvas';\n  import { generateRowDataForMidiRange, getTonicPitchClass, type PitchRowData } from '@mlt/pitch-data';\n  import { appState } from '../stores/appState.svelte.js';\n  import { pitchState } from '../stores/pitchState.svelte.js';\n  import { highwayState } from '../stores/highwayState.svelte.js';\n  import { demoExerciseState } from '../stores/demoExerciseState.svelte.js';\n\n  // Container element for measuring size\n  let container: HTMLDivElement | undefined = $state(undefined);\n  let containerWidth = $state(800);\n  let containerHeight = $state(400);\n\n  // Trail canvas overlay\n  let trailCanvas: HTMLCanvasElement | undefined = $state(undefined);\n  let trailCtx: CanvasRenderingContext2D | null = $state(null);\n  let trailAnimationId: number | null = $state(null);\n\n  let lastTrailLogAt = 0;\n  let trailFrameSamples = 0;\n  let trailFrameTimeTotal = 0;\n\n  const cellWidth = 20;\n  const showOctaveLabels = true;\n  const showFrequencyLabels = false;\n  const showRightLegend = $derived(containerWidth >= 720);\n\n  // Keep legend sizing in sync with PitchGrid\n  const LEGEND_COLUMN_WIDTH_UNITS = 3;\n  const legendColumnWidth = $derived(cellWidth * LEGEND_COLUMN_WIDTH_UNITS);\n  const legendCanvasWidth = $derived(legendColumnWidth * 2);\n  const showLegends = $derived(showOctaveLabels || showFrequencyLabels);\n  const legendTotalWidth = $derived(showLegends ? legendCanvasWidth * (showRightLegend ? 2 : 1) : 0);\n  const gridWidth = $derived(Math.max(0, containerWidth - legendTotalWidth));\n  const gridOffsetX = $derived(showLegends ? legendCanvasWidth : 0);\n  const getDebugTrailFlag = (): boolean => {\n    try {\n      const win = globalThis as typeof globalThis & { __ST_DEBUG_TRAIL?: boolean };\n      return Boolean(win.__ST_DEBUG_TRAIL);\n    } catch {\n      return false;\n    }\n  };\n\n  // Generate row data for the pitch grid based on y-axis range\n  // Uses the shared pitch data package which includes proper colors, frequencies, and enharmonic spellings\n  const fullRowData = $derived<PitchRowData[]>(\n    generateRowDataForMidiRange(appState.state.yAxisRange.minMidi, appState.state.yAxisRange.maxMidi)\n  );\n\n  // Calculate optimal viewport window that fills container height\n  const viewportWindow = $derived<ViewportWindow>(\n    calculateViewportWindow({\n      containerHeight,\n      fullRowData,\n      preferredCellHeight: 40,\n      minCellHeight: 20,\n    })\n  );\n\n  // Derive the PitchGrid mode from app state\n  const mode = $derived<PitchGridMode>(\n    appState.state.visualizationMode === 'highway' ? 'highway' : 'singing'\n  );\n\n  // Calculate beat interval based on exercise tempo\n  // 1 beat = 2 microbeats, beatIntervalMs = 60000 / tempo\n  const beatIntervalMs = $derived<number>(\n    (60 / demoExerciseState.state.config.tempo) * 1000 // ms per beat (quarter note)\n  );\n\n  // Lead-in time offset for beat line alignment (matches demoExerciseState)\n  const beatTimeOffsetMs = 2000;\n\n  const legendHighlight = $derived<LegendHighlightConfig | undefined>((() => {\n    if (!appState.state.pitchHighlightEnabled) {\n      return undefined;\n    }\n\n    const stable = pitchState.state.stablePitch;\n    if (stable.pitchClass === null || stable.opacity <= 0.01) {\n      return undefined;\n    }\n\n    return {\n      pitchClass: stable.pitchClass,\n      opacity: stable.opacity,\n      color: '#ffff00',\n    };\n  })());\n\n  // Convert local target notes to shared format\n  function convertTargetNotes(): SharedTargetNote[] {\n    return highwayState.state.targetNotes.map((n, i) => ({\n      id: `target-${i}`,\n      midi: n.midi,\n      startTimeMs: n.startTimeMs,\n      durationMs: n.durationMs,\n      label: n.lyric, // Pass emoji as label\n    }));\n  }\n\n  // Get pitch trail configuration with tonic-relative colors\n  const trailConfig = $derived<PitchTrailConfig>({\n    timeWindowMs: 4000,\n    pixelsPerSecond: 200,\n    circleRadius: 9.5,\n    proximityThreshold: 35,\n    maxConnections: 3,\n    connectorLineWidth: 2.5,\n    connectorColor: 'rgba(0,0,0,0.4)',\n    useTonicRelativeColors: true,\n    tonicPitchClass: getTonicPitchClass(appState.state.tonic),\n    clarityThreshold: 0.5,\n    maxOpacity: 0.9,\n  });\n\n  // Build singing mode config\n  const singingConfig = $derived<SingingModeConfig | undefined>(\n    mode === 'singing'\n      ? {\n          userPitch: pitchState.state.currentPitch\n            ? {\n                frequency: pitchState.state.currentPitch.frequency,\n                midi: pitchState.state.currentPitch.midi,\n                clarity: pitchState.state.currentPitch.clarity,\n                pitchClass: pitchState.state.currentPitch.pitchClass,\n              }\n            : null,\n          pitchHistory: [],\n          targetNotes: [],\n          pixelsPerSecond: 200,\n          timeWindowMs: 4000,\n          trailConfig,\n        }\n      : undefined\n  );\n\n  // Build highway mode config\n  const highwayConfig = $derived<HighwayModeConfig | undefined>(\n    mode === 'highway'\n      ? {\n          userPitch: pitchState.state.currentPitch\n            ? {\n                frequency: pitchState.state.currentPitch.frequency,\n                midi: pitchState.state.currentPitch.midi,\n                clarity: pitchState.state.currentPitch.clarity,\n                pitchClass: pitchState.state.currentPitch.pitchClass,\n              }\n            : null,\n          pitchHistory: [],\n          targetNotes: convertTargetNotes(),\n          nowLineX: highwayState.state.nowLineX,\n          pixelsPerSecond: highwayState.state.pixelsPerSecond,\n          currentTimeMs: highwayState.state.currentTimeMs,\n          timeWindowMs: highwayState.state.timeWindowMs,\n          trailConfig,\n        }\n      : undefined\n  );\n\n  // Viewport configuration using calculated window\n  const viewport = $derived<PitchGridViewport>({\n    startRow: viewportWindow.startRow,\n    endRow: viewportWindow.endRow,\n    zoomLevel: 1.0,\n    containerWidth,\n    containerHeight,\n  });\n\n  function setupTrailCanvas(): void {\n    if (!trailCanvas) return;\n\n    const dpr = window.devicePixelRatio || 1;\n    trailCanvas.width = gridWidth * dpr;\n    trailCanvas.height = containerHeight * dpr;\n    trailCanvas.style.width = `${gridWidth}px`;\n    trailCanvas.style.height = `${containerHeight}px`;\n    trailCanvas.style.left = `${gridOffsetX}px`;\n\n    const ctx = trailCanvas.getContext('2d');\n    if (!ctx) {\n      trailCtx = null;\n      return;\n    }\n\n    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);\n    trailCtx = ctx;\n  }\n\n  function renderTrail(): void {\n    if (!trailCtx || gridWidth <= 0) return;\n\n    trailCtx.clearRect(0, 0, gridWidth, containerHeight);\n\n    const trailHistory = pitchState.state.history;\n    if (trailHistory.length === 0) return;\n\n    // Support both stationary and highway modes\n    const activeConfig = mode === 'singing' ? singingConfig : highwayConfig;\n    if (!activeConfig) return;\n\n    const debugTrail = getDebugTrailFlag();\n    const frameStart = debugTrail ? performance.now() : 0;\n\n    // Use appropriate nowLineX based on mode\n    const nowLineX = mode === 'highway' && highwayConfig\n      ? highwayConfig.nowLineX\n      : 100;\n\n    const coords = createTimeCoordinates({\n      cellWidth,\n      cellHeight: viewportWindow.cellHeight,\n      viewport,\n      pixelsPerSecond: activeConfig.pixelsPerSecond ?? 200,\n      nowLineX,\n      currentTimeMs: mode === 'highway' && highwayConfig ? highwayConfig.currentTimeMs : 0,\n    });\n\n    const userPitchConfig: UserPitchRenderConfig = {\n      cellHeight: viewportWindow.cellHeight,\n      viewportWidth: gridWidth,\n      nowLineX,\n      pixelsPerSecond: activeConfig.pixelsPerSecond ?? 200,\n      timeWindowMs: activeConfig.timeWindowMs ?? 4000,\n      colorMode: 'color',\n      trailConfig,\n    };\n\n    const currentTime = performance.now();\n\n    drawUserPitchTrace(\n      trailCtx,\n      coords,\n      trailHistory,\n      currentTime,\n      userPitchConfig,\n      fullRowData\n    );\n\n    if (debugTrail) {\n      const now = performance.now();\n      trailFrameSamples += 1;\n      trailFrameTimeTotal += (now - frameStart);\n      if (now - lastTrailLogAt >= 1000) {\n        const avgMs = trailFrameSamples > 0 ? (trailFrameTimeTotal / trailFrameSamples) : 0;\n        console.log(\n          `[SingingTrail] points=${trailHistory.length} avgMs=${avgMs.toFixed(2)} gridWidth=${gridWidth}`\n        );\n        lastTrailLogAt = now;\n        trailFrameSamples = 0;\n        trailFrameTimeTotal = 0;\n      }\n    }\n  }\n\n  function startTrailLoop(): void {\n    if (trailAnimationId) return;\n\n    const loop = () => {\n      renderTrail();\n      trailAnimationId = requestAnimationFrame(loop);\n    };\n\n    trailAnimationId = requestAnimationFrame(loop);\n  }\n\n  function stopTrailLoop(): void {\n    if (trailAnimationId) {\n      cancelAnimationFrame(trailAnimationId);\n      trailAnimationId = null;\n    }\n    if (trailCtx && gridWidth > 0) {\n      trailCtx.clearRect(0, 0, gridWidth, containerHeight);\n    }\n  }\n\n  // Handle container resize\n  $effect(() => {\n    if (!container) return;\n\n    const resizeObserver = new ResizeObserver((entries) => {\n      for (const entry of entries) {\n        containerWidth = entry.contentRect.width;\n        containerHeight = entry.contentRect.height;\n      }\n    });\n\n    resizeObserver.observe(container);\n\n    return () => {\n      resizeObserver.disconnect();\n    };\n  });\n\n  $effect(() => {\n    void gridWidth;\n    void containerHeight;\n    void gridOffsetX;\n    void trailCanvas;\n    setupTrailCanvas();\n  });\n\n  $effect(() => {\n    void mode;\n    void trailCtx;\n    // Run trail loop for both stationary and highway modes\n    if (mode === 'singing' || mode === 'highway') {\n      startTrailLoop();\n    } else {\n      stopTrailLoop();\n    }\n  });\n\n  onDestroy(() => {\n    stopTrailLoop();\n  });\n</script>\n\n<div class=\"singing-canvas-container\" bind:this={container}>\n  <PitchGrid\n    {mode}\n    {fullRowData}\n    {viewport}\n    cellWidth={cellWidth}\n    cellHeight={viewportWindow.cellHeight}\n    colorMode=\"color\"\n    {showOctaveLabels}\n    {showFrequencyLabels}\n    {showRightLegend}\n    {singingConfig}\n    {highwayConfig}\n    legendHighlight={legendHighlight}\n    {beatIntervalMs}\n    {beatTimeOffsetMs}\n  />\n  <canvas\n    bind:this={trailCanvas}\n    class=\"pitch-trail-canvas\"\n  ></canvas>\n</div>\n\n<style>\n  .singing-canvas-container {\n    flex: 1;\n    width: 100%;\n    min-height: 300px;\n    position: relative;\n    background-color: var(--color-bg-light);\n    /* Subtle white overlay to make grid bounds more visible */\n    background-image: linear-gradient(rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.02));\n    border-radius: var(--radius-md);\n    overflow: hidden;\n  }\n\n  .pitch-trail-canvas {\n    position: absolute;\n    top: 0;\n    pointer-events: none;\n    z-index: 2;\n  }\n</style>\n","/**\r\n * Reference Audio Service\r\n *\r\n * Plays sine wave reference tones for the demo exercise.\r\n */\r\n\r\nimport * as Tone from 'tone';\r\n\r\nclass ReferenceAudioService {\r\n  private synth: Tone.Synth | null = null;\r\n  private scheduledTimeouts: number[] = []; // Store timeout IDs for cleanup\r\n  private volume: Tone.Volume | null = null;\r\n  private startTime: number = 0; // Performance.now() when playback started\r\n  private _isPlaying: boolean = false; // Track if a reference tone is currently playing\r\n\r\n  /**\r\n   * Check if a reference tone is currently playing\r\n   */\r\n  get isPlaying(): boolean {\r\n    return this._isPlaying;\r\n  }\r\n\r\n  /**\r\n   * Initialize the audio service\r\n   */\r\n  async init(): Promise<void> {\r\n    await Tone.start();\r\n\r\n    // Create volume node\r\n    this.volume = new Tone.Volume(-12).toDestination();\r\n\r\n    // Create synth with triangle wave (less likely to be picked up by mic as same frequency)\r\n    this.synth = new Tone.Synth({\r\n      oscillator: { type: 'triangle' },\r\n      envelope: {\r\n        attack: 0.05,\r\n        decay: 0.1,\r\n        sustain: 0.9,\r\n        release: 0.1,\r\n      },\r\n    }).connect(this.volume);\r\n  }\r\n\r\n  /**\r\n   * Set reference tone volume\r\n   */\r\n  setVolume(dB: number): void {\r\n    if (this.volume) {\r\n      this.volume.volume.value = dB;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Schedule all reference tones for the exercise\r\n   * Uses setTimeout for precise timing aligned with the highway animation\r\n   */\r\n  scheduleReferenceTones(\r\n    notes: Array<{ midi: number; startTimeMs: number; durationMs: number }>\r\n  ): void {\r\n    if (!this.synth) {\r\n      console.warn('[ReferenceAudio] Synth not initialized');\r\n      return;\r\n    }\r\n\r\n    // Clear any existing scheduled notes\r\n    this.clearScheduled();\r\n\r\n    // Record start time for synchronization\r\n    this.startTime = performance.now();\r\n\r\n    notes.forEach((note) => {\r\n      const duration = note.durationMs / 1000;\r\n      const frequency = Tone.Frequency(note.midi, 'midi').toFrequency();\r\n\r\n      // Schedule the note start\r\n      const startTimeoutId = window.setTimeout(() => {\r\n        if (this.synth) {\r\n          console.log(`[ReferenceAudio] Playing ${note.midi} at ${performance.now() - this.startTime}ms`);\r\n          this._isPlaying = true;\r\n          this.synth.triggerAttackRelease(frequency, duration);\r\n        }\r\n      }, note.startTimeMs);\r\n\r\n      // Schedule the note end (to clear isPlaying flag)\r\n      const endTimeoutId = window.setTimeout(() => {\r\n        this._isPlaying = false;\r\n      }, note.startTimeMs + note.durationMs);\r\n\r\n      this.scheduledTimeouts.push(startTimeoutId, endTimeoutId);\r\n    });\r\n\r\n    console.log(`[ReferenceAudio] Scheduled ${notes.length} reference tones`);\r\n  }\r\n\r\n  /**\r\n   * Play a single reference tone immediately\r\n   */\r\n  playTone(midi: number, durationMs: number): void {\r\n    if (!this.synth) {\r\n      console.warn('[ReferenceAudio] Synth not initialized');\r\n      return;\r\n    }\r\n\r\n    const frequency = Tone.Frequency(midi, 'midi').toFrequency();\r\n    const duration = durationMs / 1000;\r\n    this.synth.triggerAttackRelease(frequency, duration);\r\n  }\r\n\r\n  /**\r\n   * Clear all scheduled notes\r\n   */\r\n  clearScheduled(): void {\r\n    this.scheduledTimeouts.forEach((timeoutId) => {\r\n      window.clearTimeout(timeoutId);\r\n    });\r\n    this.scheduledTimeouts = [];\r\n  }\r\n\r\n  /**\r\n   * Stop all audio\r\n   */\r\n  stop(): void {\r\n    this.clearScheduled();\r\n    if (this.synth) {\r\n      this.synth.triggerRelease();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Dispose of audio resources\r\n   */\r\n  dispose(): void {\r\n    this.stop();\r\n    if (this.synth) {\r\n      this.synth.dispose();\r\n      this.synth = null;\r\n    }\r\n    if (this.volume) {\r\n      this.volume.dispose();\r\n      this.volume = null;\r\n    }\r\n  }\r\n}\r\n\r\n// Singleton instance\r\nexport const referenceAudio = new ReferenceAudioService();\r\n","/**\n * Pitch Detection Service\n *\n * Uses Pitchy.js for real-time pitch detection from microphone input.\n * Ported from the original JavaScript implementation.\n */\n\nimport * as Tone from 'tone';\nimport { PitchDetector } from 'pitchy';\nimport { getCentsOffset, getNearestMidi, midiToPitchClass } from '@mlt/pitch-utils';\nimport { pitchState, type DetectedPitch } from '../stores/pitchState.svelte.js';\nimport { highwayState } from '../stores/highwayState.svelte.js';\nimport { referenceAudio } from './referenceAudio.js';\n\n// Configuration\nconst CONFIG = {\n  FFT_SIZE: 2048,\n  CLARITY_THRESHOLD: 0.8,\n  MIN_PITCH_HZ: 60,\n  MAX_PITCH_HZ: 1600,\n  HIGHLIGHT_CENTS_RANGE: 50,\n  MIN_VOLUME_DB: -60,\n} as const;\n\n// Module state\nlet mic: Tone.UserMedia | null = null;\nlet analyser: Tone.Analyser | null = null;\nlet detector: ReturnType<typeof PitchDetector.forFloat32Array> | null = null;\nlet animationFrameId: number | null = null;\nlet isRunning = false;\n\nconst HIGHLIGHT_DEFAULT_SIZE = 1.0;\n\n/**\n * Convert frequency in Hz to MIDI note number\n */\nfunction frequencyToMidi(frequency: number): number {\n  return 12 * Math.log2(frequency / 440) + 69;\n}\n\n/**\n * The main detection and animation loop\n */\nfunction animationLoop(): void {\n  if (!isRunning || !analyser || !detector) {\n    animationFrameId = null;\n    return;\n  }\n\n  // Skip pitch detection while reference tone is playing (avoid mic picking up speakers)\n  if (referenceAudio.isPlaying) {\n    // Still add a silent history point to keep the trail continuous\n    pitchState.addHistoryPoint({\n      frequency: 0,\n      midi: 0,\n      time: performance.now(),\n      clarity: 0,\n    });\n    animationFrameId = requestAnimationFrame(animationLoop);\n    return;\n  }\n\n  // Get pitch from audio\n  const waveform = analyser.getValue() as Float32Array;\n  const [pitch, clarity] = detector.findPitch(waveform, Tone.getContext().sampleRate);\n\n  const isValidPitch =\n    pitch !== null &&\n    clarity > CONFIG.CLARITY_THRESHOLD &&\n    pitch > CONFIG.MIN_PITCH_HZ &&\n    pitch < CONFIG.MAX_PITCH_HZ;\n\n  // Update pitch state\n  if (isValidPitch) {\n    const midi = frequencyToMidi(pitch);\n    const detectedPitch: DetectedPitch = {\n      frequency: pitch,\n      midi,\n      clarity,\n      pitchClass: Math.round(midi) % 12,\n    };\n    pitchState.setCurrentPitch(detectedPitch);\n    pitchState.addHistoryPoint({\n      frequency: pitch,\n      midi,\n      time: performance.now(),\n      clarity,\n    });\n\n    // Record pitch input for highway performance tracking\n    highwayState.recordPitchInput(midi, clarity);\n  } else {\n    pitchState.addHistoryPoint({\n      frequency: 0,\n      midi: 0,\n      time: performance.now(),\n      clarity: 0,\n    });\n  }\n\n  // Highlight opacity based on cents deviation from nearest pitch\n  if (isValidPitch && pitchState.state.currentPitch) {\n    const midi = pitchState.state.currentPitch.midi;\n    const nearestMidi = getNearestMidi(midi);\n    const centsOffset = getCentsOffset(midi);\n    const centsDistance = Math.min(Math.abs(centsOffset), CONFIG.HIGHLIGHT_CENTS_RANGE);\n    const opacity = Math.max(0, 1 - (centsDistance / CONFIG.HIGHLIGHT_CENTS_RANGE));\n\n    pitchState.setStablePitch({\n      pitchClass: midiToPitchClass(nearestMidi),\n      opacity,\n      size: HIGHLIGHT_DEFAULT_SIZE,\n    });\n  } else {\n    pitchState.setStablePitch({ pitchClass: null, opacity: 0, size: HIGHLIGHT_DEFAULT_SIZE });\n  }\n\n  // Request next frame\n  animationFrameId = requestAnimationFrame(animationLoop);\n}\n\n/**\n * Start pitch detection from microphone\n */\nexport async function startDetection(): Promise<void> {\n  if (isRunning) return;\n\n  // Cancel any existing animation frame\n  if (animationFrameId !== null) {\n    cancelAnimationFrame(animationFrameId);\n  }\n\n  // Create audio nodes\n  mic = new Tone.UserMedia();\n  analyser = new Tone.Analyser('waveform', CONFIG.FFT_SIZE);\n  detector = PitchDetector.forFloat32Array(analyser.size);\n\n  try {\n    await Tone.start(); // Initialize audio context\n    await mic.open();\n    mic.connect(analyser);\n    isRunning = true;\n    animationLoop();\n  } catch (err) {\n    console.error('Microphone access denied or failed:', err);\n    cleanup();\n    throw err;\n  }\n}\n\n/**\n * Stop pitch detection\n */\nexport function stopDetection(): void {\n  isRunning = false;\n  cleanup();\n}\n\n/**\n * Clean up audio resources\n */\nfunction cleanup(): void {\n  if (animationFrameId !== null) {\n    cancelAnimationFrame(animationFrameId);\n    animationFrameId = null;\n  }\n\n  if (mic) {\n    mic.close();\n    mic = null;\n  }\n\n  analyser = null;\n  detector = null;\n\n  pitchState.setStablePitch({ pitchClass: null, opacity: 0, size: HIGHLIGHT_DEFAULT_SIZE });\n  pitchState.setCurrentPitch(null);\n}\n\n/**\n * Check if detection is currently running\n */\nexport function isDetecting(): boolean {\n  return isRunning;\n}\n","/**\n * Drone Audio Service\n *\n * Provides a sustained drone tone using Tone.js for pitch reference.\n */\n\nimport * as Tone from 'tone';\nimport { appState } from '../stores/appState.svelte.js';\n\n// Module state\nlet synth: Tone.PolySynth | null = null;\nlet isPlaying = false;\nlet currentNote: string | null = null;\n\n// Note name mapping\nconst NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];\n\n/**\n * Initialize the drone synth\n */\nfunction ensureSynth(): Tone.PolySynth {\n  if (!synth) {\n    synth = new Tone.PolySynth(Tone.Synth, {\n      oscillator: { type: 'sawtooth' },\n      envelope: {\n        attack: 0.3,\n        decay: 0.1,\n        sustain: 0.8,\n        release: 0.5,\n      },\n    }).toDestination();\n    const oscillatorType = synth.get().oscillator?.type ?? 'unknown';\n    console.log('[DroneAudio] Initialized drone synth', { oscillatorType });\n  }\n  return synth;\n}\n\n/**\n * Get the note name with octave from tonic and octave\n */\nfunction getNoteName(tonic: string, octave: number): string {\n  // Normalize tonic (handle flats)\n  const normalizedTonic = tonic.replace('b', '#').replace('Db', 'C#').replace('Eb', 'D#')\n    .replace('Gb', 'F#').replace('Ab', 'G#').replace('Bb', 'A#');\n  return `${normalizedTonic}${octave}`;\n}\n\n/**\n * Start playing the drone\n */\nexport async function startDrone(): Promise<void> {\n  // Ensure audio context is started (required for browsers)\n  await Tone.start();\n\n  const s = ensureSynth();\n  const note = getNoteName(appState.state.tonic, appState.state.drone.octave);\n\n  // Set volume (convert from dB scale used in app to Tone.js scale)\n  s.volume.value = appState.state.drone.volume;\n  console.log('[DroneAudio] Starting drone', {\n    note,\n    volume: s.volume.value,\n  });\n\n  // Release any current note before starting new one\n  if (currentNote) {\n    s.releaseAll();\n  }\n\n  currentNote = note;\n  s.triggerAttack(note);\n  isPlaying = true;\n}\n\n/**\n * Stop the drone\n */\nexport function stopDrone(): void {\n  if (synth && isPlaying) {\n    synth.releaseAll();\n    currentNote = null;\n    isPlaying = false;\n  }\n}\n\n/**\n * Update drone parameters (tonic, octave, volume)\n */\nexport function updateDrone(): void {\n  if (!isPlaying || !synth) return;\n\n  const newNote = getNoteName(appState.state.tonic, appState.state.drone.octave);\n  synth.volume.value = appState.state.drone.volume;\n  console.log('[DroneAudio] Updating drone', {\n    note: newNote,\n    volume: synth.volume.value,\n  });\n\n  if (newNote !== currentNote) {\n    synth.releaseAll();\n    synth.triggerAttack(newNote);\n    currentNote = newNote;\n  }\n}\n\n/**\n * Toggle drone on/off\n */\nexport async function toggleDrone(): Promise<void> {\n  if (isPlaying) {\n    stopDrone();\n  } else {\n    await startDrone();\n  }\n}\n\n/**\n * Check if drone is playing\n */\nexport function isDronePlaying(): boolean {\n  return isPlaying;\n}\n\n/**\n * Clean up resources\n */\nexport function dispose(): void {\n  stopDrone();\n  if (synth) {\n    synth.dispose();\n    synth = null;\n  }\n}\n","<script lang=\"ts\">\n  /**\n   * TonicSelector Component\n   *\n   * Dropdown for selecting the tonic/key center.\n   */\n\n  import { appState, type TonicNote } from '../../stores/appState.svelte.js';\n  import { updateDrone } from '../../services/droneAudio.js';\n\n  const TONIC_OPTIONS: TonicNote[] = [\n    'C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'\n  ];\n\n  function handleChange(event: Event) {\n    const target = event.target as HTMLSelectElement;\n    appState.setTonic(target.value as TonicNote);\n    updateDrone();\n  }\n</script>\n\n<div class=\"tonic-selector\">\n  <label for=\"tonic-select\">Key:</label>\n  <select\n    id=\"tonic-select\"\n    value={appState.state.tonic}\n    onchange={handleChange}\n  >\n    {#each TONIC_OPTIONS as tonic}\n      <option value={tonic}>{tonic}</option>\n    {/each}\n  </select>\n</div>\n\n<style>\n  .tonic-selector {\n    display: flex;\n    align-items: center;\n    gap: var(--spacing-sm);\n  }\n\n  label {\n    font-weight: 500;\n    color: var(--color-text-muted);\n  }\n\n  select {\n    padding: var(--spacing-sm) var(--spacing-md);\n    font-size: var(--font-size-base);\n    color: var(--color-text);\n    background-color: var(--color-surface);\n    border: 1px solid rgba(255, 255, 255, 0.1);\n    border-radius: var(--radius-sm);\n    cursor: pointer;\n    min-width: 70px;\n  }\n\n  select:hover {\n    border-color: var(--color-secondary);\n  }\n\n  select:focus {\n    outline: none;\n    border-color: var(--color-secondary);\n    box-shadow: 0 0 0 2px rgba(0, 217, 255, 0.2);\n  }\n</style>\n","<script lang=\"ts\">\n  /**\n   * DroneControls Component\n   *\n   * Controls for the drone reference tone.\n   */\n\n  import { appState } from '../../stores/appState.svelte.js';\n  import { toggleDrone, updateDrone } from '../../services/droneAudio.js';\n\n  const OCTAVE_OPTIONS = [2, 3, 4, 5];\n\n  async function handleToggle() {\n    await toggleDrone();\n    appState.toggleDrone();\n  }\n\n  function handleOctaveChange(event: Event) {\n    const target = event.target as HTMLSelectElement;\n    appState.setDroneOctave(parseInt(target.value, 10));\n    updateDrone();\n  }\n\n  function handleVolumeChange(event: Event) {\n    const target = event.target as HTMLInputElement;\n    appState.setDroneVolume(parseInt(target.value, 10));\n    updateDrone();\n  }\n</script>\n\n<div class=\"drone-controls\">\n  <button\n    class=\"drone-toggle\"\n    class:active={appState.state.drone.isPlaying}\n    onclick={handleToggle}\n  >\n    {appState.state.drone.isPlaying ? 'Drone On' : 'Drone Off'}\n  </button>\n\n  <div class=\"drone-settings\">\n    <label>\n      Oct:\n      <select value={appState.state.drone.octave} onchange={handleOctaveChange}>\n        {#each OCTAVE_OPTIONS as oct}\n          <option value={oct}>{oct}</option>\n        {/each}\n      </select>\n    </label>\n\n    <label>\n      Vol:\n      <input\n        type=\"range\"\n        min=\"-40\"\n        max=\"0\"\n        value={appState.state.drone.volume}\n        oninput={handleVolumeChange}\n      />\n    </label>\n  </div>\n</div>\n\n<style>\n  .drone-controls {\n    display: flex;\n    align-items: center;\n    gap: var(--spacing-md);\n  }\n\n  .drone-toggle {\n    padding: var(--spacing-sm) var(--spacing-md);\n    font-size: var(--font-size-sm);\n    font-weight: 500;\n    color: var(--color-text);\n    background-color: var(--color-surface);\n    border: 1px solid rgba(255, 255, 255, 0.1);\n    border-radius: var(--radius-sm);\n    transition: all 0.2s ease;\n  }\n\n  .drone-toggle:hover {\n    border-color: var(--color-secondary);\n  }\n\n  .drone-toggle.active {\n    background-color: var(--color-secondary);\n    color: var(--color-bg);\n    border-color: var(--color-secondary);\n  }\n\n  .drone-settings {\n    display: flex;\n    align-items: center;\n    gap: var(--spacing-md);\n  }\n\n  label {\n    display: flex;\n    align-items: center;\n    gap: var(--spacing-xs);\n    font-size: var(--font-size-sm);\n    color: var(--color-text-muted);\n  }\n\n  select {\n    padding: var(--spacing-xs) var(--spacing-sm);\n    font-size: var(--font-size-sm);\n    color: var(--color-text);\n    background-color: var(--color-surface);\n    border: 1px solid rgba(255, 255, 255, 0.1);\n    border-radius: var(--radius-sm);\n    cursor: pointer;\n  }\n\n  input[type='range'] {\n    width: 80px;\n    height: 4px;\n    cursor: pointer;\n  }\n</style>\n","<script lang=\"ts\">\n\t/**\n\t * RangeControl Component\n\t *\n\t * Wrapper for DualPitchWheel that integrates with singing-trainer app state.\n\t * Converts between MIDI values (used in app state) and indices (used by wheels).\n\t */\n\timport { DualPitchWheel } from '@mlt/ui-components/pitch-wheels';\n\timport type { PitchWheelRange } from '@mlt/ui-components/pitch-wheels';\n\timport { fullRowData } from '@mlt/pitch-data';\n\timport { appState } from '../../stores/appState.svelte';\n\n\t// Convert MIDI to index in fullRowData\n\tfunction midiToIndex(midi: number): number {\n\t\tconst index = fullRowData.findIndex((p) => p.midi === midi);\n\t\treturn index >= 0 ? index : 0;\n\t}\n\n\t// Current indices derived from app state\n\tconst topIndex = $derived(midiToIndex(appState.state.yAxisRange.maxMidi));\n\tconst bottomIndex = $derived(midiToIndex(appState.state.yAxisRange.minMidi));\n\n\t// Handle range change from wheels\n\tfunction handleRangeChange(range: PitchWheelRange) {\n\t\tconst minMidi = range.bottomPitch.midi ?? 21;\n\t\tconst maxMidi = range.topPitch.midi ?? 108;\n\t\tappState.setYAxisRange({ minMidi, maxMidi });\n\t}\n</script>\n\n<div class=\"range-control\">\n\t<h3 class=\"control-title\">Pitch Range</h3>\n\t<DualPitchWheel\n\t\t{fullRowData}\n\t\t{topIndex}\n\t\t{bottomIndex}\n\t\tminSpan={7}\n\t\tonrangechange={handleRangeChange}\n\t\tshowSummary={true}\n\t\twheelHeight={200}\n\t/>\n</div>\n\n<style>\n\t.range-control {\n\t\tdisplay: flex;\n\t\tflex-direction: column;\n\t\tgap: 12px;\n\t\tpadding: 16px;\n\t\tbackground: rgba(255, 255, 255, 0.05);\n\t\tborder-radius: 12px;\n\t}\n\n\t.control-title {\n\t\tmargin: 0;\n\t\tfont-size: 0.85rem;\n\t\tfont-weight: 600;\n\t\tcolor: rgba(255, 255, 255, 0.9);\n\t\ttext-align: center;\n\t\tletter-spacing: 0.5px;\n\t}\n</style>\n","<script lang=\"ts\">\n  /**\n   * PitchHighlightToggle Component\n   *\n   * Toggles the yellow pitch highlight overlay.\n   */\n\n  import { appState } from '../../stores/appState.svelte.js';\n\n  function handleToggle() {\n    appState.togglePitchHighlight();\n  }\n</script>\n\n<div class=\"pitch-highlight-toggle\">\n  <span class=\"toggle-label\">Pitch Highlight</span>\n  <button\n    class=\"toggle-button\"\n    class:active={appState.state.pitchHighlightEnabled}\n    onclick={handleToggle}\n  >\n    {appState.state.pitchHighlightEnabled ? 'On' : 'Off'}\n  </button>\n</div>\n\n<style>\n  .pitch-highlight-toggle {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    gap: var(--spacing-sm);\n  }\n\n  .toggle-label {\n    font-size: var(--font-size-sm);\n    color: var(--color-text-muted);\n  }\n\n  .toggle-button {\n    padding: var(--spacing-xs) var(--spacing-md);\n    font-size: var(--font-size-sm);\n    font-weight: 500;\n    color: var(--color-text);\n    background-color: var(--color-surface);\n    border: 1px solid rgba(255, 255, 255, 0.1);\n    border-radius: var(--radius-sm);\n    transition: all 0.2s ease;\n    min-width: 64px;\n  }\n\n  .toggle-button:hover {\n    border-color: var(--color-secondary);\n  }\n\n  .toggle-button.active {\n    background-color: var(--color-secondary);\n    color: var(--color-bg);\n    border-color: var(--color-secondary);\n  }\n</style>\n","<script lang=\"ts\">\r\n  /**\r\n   * Demo Exercise Controls Component\r\n   *\r\n   * UI for starting/stopping the pitch-matching demo exercise.\r\n   */\r\n\r\n  import { demoExerciseState } from '../../stores/demoExerciseState.svelte.js';\r\n  import { highwayState } from '../../stores/highwayState.svelte.js';\r\n  import { appState } from '../../stores/appState.svelte.js';\r\n  import { referenceAudio } from '../../services/referenceAudio.js';\r\n  import { getPitchByMidi } from '@mlt/pitch-data';\r\n  import { onDestroy } from 'svelte';\r\n\r\n  // Local state for settings panel\r\n  let showSettings = $state(false);\r\n  let numLoops = $state(5);\r\n  let tempo = $state(108);\r\n  let referenceVolume = $state(-12);\r\n\r\n  // Reactive state from stores\r\n  const isActive = $derived(demoExerciseState.state.isActive);\r\n  const isPlaying = $derived(demoExerciseState.state.isPlaying);\r\n  const currentPhase = $derived(demoExerciseState.state.currentPhase);\r\n  const progress = $derived(demoExerciseState.getCurrentProgress());\r\n  const results = $derived(demoExerciseState.getResults());\r\n  const hasResults = $derived(results.length > 0);\r\n\r\n  // Calculate stats from results\r\n  const averageAccuracy = $derived(demoExerciseState.getAverageAccuracy());\r\n  const hitCount = $derived(demoExerciseState.getHitCount());\r\n  const totalCount = $derived(results.length);\r\n\r\n  /**\r\n   * Track phase based on highway currentTimeMs\r\n   */\r\n  $effect(() => {\r\n    if (!isActive || !isPlaying) return;\r\n\r\n    const currentTimeMs = highwayState.state.currentTimeMs;\r\n    demoExerciseState.updatePhase(currentTimeMs);\r\n  });\r\n\r\n  /**\r\n   * Collect results from highway performance data\r\n   */\r\n  $effect(() => {\r\n    if (!isActive) return;\r\n\r\n    const performances = highwayState.getPerformanceResults();\r\n    const notes = demoExerciseState.getGeneratedNotes();\r\n\r\n    // Check each input note for completion\r\n    notes.forEach((note, index) => {\r\n      if (note.lyric !== 'ðŸŽ¤') return; // Only process input notes\r\n\r\n      const noteId = `target-${index}`;\r\n      const perf = performances.get(noteId);\r\n\r\n      if (perf && !demoExerciseState.hasResultForLoop(Math.floor(index / 2))) {\r\n        // Calculate accuracy percentage from performance data\r\n        const accuracy = calculateAccuracy(perf);\r\n\r\n        demoExerciseState.addResult({\r\n          loopIndex: Math.floor(index / 2),\r\n          targetPitch: note.midi,\r\n          accuracy,\r\n          performance: perf,\r\n        });\r\n      }\r\n    });\r\n  });\r\n\r\n  /**\r\n   * Calculate accuracy percentage from performance data\r\n   */\r\n  function calculateAccuracy(perf: any): number {\r\n    // Simple accuracy: 100% if hit, based on pitch accuracy if available\r\n    if (perf.hitStatus === 'hit') {\r\n      // If we have pitch accuracy data, use it\r\n      if (perf.pitchAccuracyCents !== undefined) {\r\n        const maxCents = 50; // Tolerance from config\r\n        const accuracy = Math.max(0, 100 - (Math.abs(perf.pitchAccuracyCents) / maxCents) * 100);\r\n        return accuracy;\r\n      }\r\n      return 100;\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  /**\r\n   * Cleanup on component destroy\r\n   */\r\n  onDestroy(() => {\r\n    if (isActive) {\r\n      handleStop();\r\n    }\r\n  });\r\n\r\n  /**\r\n   * Use current Y-axis range for pitch range\r\n   */\r\n  function useCurrentRange() {\r\n    const range = appState.state.yAxisRange;\r\n    demoExerciseState.setPitchRange(range.minMidi, range.maxMidi);\r\n  }\r\n\r\n  /**\r\n   * Use full piano range\r\n   */\r\n  function useFullRange() {\r\n    demoExerciseState.setPitchRange(21, 108); // A0 to C8\r\n  }\r\n\r\n  /**\r\n   * Start the demo exercise\r\n   */\r\n  async function handleStart() {\r\n    // Auto-switch to highway mode\r\n    appState.setVisualizationMode('highway');\r\n\r\n    // Update configuration\r\n    demoExerciseState.configure({\r\n      numLoops,\r\n      tempo,\r\n      referenceVolume,\r\n    });\r\n\r\n    // Set pitch range to current Y-axis range\r\n    useCurrentRange();\r\n\r\n    // Initialize reference audio\r\n    await referenceAudio.init();\r\n    referenceAudio.setVolume(referenceVolume);\r\n\r\n    // Start exercise (generates notes)\r\n    demoExerciseState.start();\r\n\r\n    const notes = demoExerciseState.getGeneratedNotes();\r\n\r\n    // Set highway state with generated notes\r\n    highwayState.setTargetNotes(notes);\r\n\r\n    // Start highway playback\r\n    highwayState.start();\r\n    demoExerciseState.setPlaying(true);\r\n\r\n    // Schedule reference tones (only the reference notes, not input notes)\r\n    const referenceTones = notes.filter(n => n.lyric === 'ðŸ‘‚');\r\n    referenceAudio.scheduleReferenceTones(referenceTones);\r\n  }\r\n\r\n  /**\r\n   * Stop the demo exercise\r\n   */\r\n  function handleStop() {\r\n    // Stop audio\r\n    referenceAudio.stop();\r\n\r\n    // Stop highway\r\n    highwayState.stop();\r\n\r\n    // Mark exercise as stopped\r\n    demoExerciseState.stop();\r\n  }\r\n\r\n  /**\r\n   * Get phase label for display\r\n   */\r\n  function getPhaseLabel(phase: string): string {\r\n    switch (phase) {\r\n      case 'reference':\r\n        return 'ðŸ‘‚ Listen';\r\n      case 'input':\r\n        return 'ðŸŽ¤ Sing';\r\n      default:\r\n        return 'Rest';\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get pitch name from MIDI number\r\n   */\r\n  function getPitchName(midi: number): string {\r\n    const pitch = getPitchByMidi(midi);\r\n    return pitch?.pitch || `MIDI ${midi}`;\r\n  }\r\n</script>\r\n\r\n<div class=\"demo-exercise-panel\">\r\n  <h3 class=\"panel-title\">Demo Exercise</h3>\r\n\r\n  <!-- Settings (collapsed by default) -->\r\n  <details class=\"settings-details\" bind:open={showSettings}>\r\n    <summary class=\"settings-summary\">Settings</summary>\r\n    <div class=\"exercise-settings\">\r\n      <label class=\"setting-label\">\r\n        <span class=\"label-text\">Number of loops:</span>\r\n        <input\r\n          class=\"setting-input\"\r\n          type=\"number\"\r\n          min=\"1\"\r\n          max=\"20\"\r\n          bind:value={numLoops}\r\n          disabled={isActive}\r\n        />\r\n      </label>\r\n\r\n      <label class=\"setting-label\">\r\n        <span class=\"label-text\">Tempo (BPM):</span>\r\n        <input\r\n          class=\"setting-input\"\r\n          type=\"number\"\r\n          min=\"60\"\r\n          max=\"180\"\r\n          bind:value={tempo}\r\n          disabled={isActive}\r\n        />\r\n      </label>\r\n\r\n      <label class=\"setting-label\">\r\n        <span class=\"label-text\">Reference Volume:</span>\r\n        <input\r\n          class=\"setting-slider\"\r\n          type=\"range\"\r\n          min=\"-40\"\r\n          max=\"0\"\r\n          bind:value={referenceVolume}\r\n          disabled={isActive}\r\n        />\r\n        <span class=\"volume-value\">{referenceVolume} dB</span>\r\n      </label>\r\n\r\n      <div class=\"pitch-range-buttons\">\r\n        <button class=\"range-btn\" onclick={useCurrentRange} disabled={isActive}>\r\n          Use Current Range\r\n        </button>\r\n        <button class=\"range-btn\" onclick={useFullRange} disabled={isActive}>\r\n          Use Full Range\r\n        </button>\r\n      </div>\r\n    </div>\r\n  </details>\r\n\r\n  <!-- Main Controls -->\r\n  <div class=\"exercise-controls\">\r\n    {#if !isActive}\r\n      <button class=\"start-exercise-btn\" onclick={handleStart}>\r\n        Start Demo Exercise\r\n      </button>\r\n    {:else}\r\n      <button class=\"stop-exercise-btn\" onclick={handleStop}>\r\n        Stop Exercise\r\n      </button>\r\n\r\n      <div class=\"progress-indicator\">\r\n        Loop {progress.current} / {progress.total}\r\n      </div>\r\n\r\n      <div class=\"phase-indicator\">\r\n        {getPhaseLabel(currentPhase)}\r\n      </div>\r\n    {/if}\r\n  </div>\r\n\r\n  <!-- Results Display (after completion) -->\r\n  {#if hasResults && !isActive}\r\n    <div class=\"exercise-results\">\r\n      <h4 class=\"results-title\">Results</h4>\r\n      <div class=\"results-summary\">\r\n        <div class=\"stat\">\r\n          <span class=\"stat-label\">Average Accuracy:</span>\r\n          <span class=\"stat-value\">{averageAccuracy.toFixed(1)}%</span>\r\n        </div>\r\n        <div class=\"stat\">\r\n          <span class=\"stat-label\">Hits:</span>\r\n          <span class=\"stat-value\">{hitCount}/{totalCount}</span>\r\n        </div>\r\n      </div>\r\n\r\n      <details class=\"results-details\">\r\n        <summary class=\"results-summary-label\">Detailed Results</summary>\r\n        <div class=\"results-list\">\r\n          {#each results as result, i}\r\n            <div class=\"result-item\" class:hit={result.performance?.hitStatus === 'hit'}>\r\n              <span class=\"result-loop\">Loop {i + 1}:</span>\r\n              <span class=\"result-pitch\">{getPitchName(result.targetPitch)}</span>\r\n              <span class=\"result-accuracy\">{result.accuracy.toFixed(0)}%</span>\r\n              <span class=\"result-status\">\r\n                {result.performance?.hitStatus === 'hit' ? 'âœ“' : 'âœ—'}\r\n              </span>\r\n            </div>\r\n          {/each}\r\n        </div>\r\n      </details>\r\n    </div>\r\n  {/if}\r\n</div>\r\n\r\n<style>\r\n  .demo-exercise-panel {\r\n    display: flex;\r\n    flex-direction: column;\r\n    gap: var(--spacing-md);\r\n  }\r\n\r\n  .panel-title {\r\n    font-size: var(--font-size-sm);\r\n    font-weight: 600;\r\n    color: var(--color-text-muted);\r\n    text-transform: uppercase;\r\n    letter-spacing: 0.05em;\r\n    margin: 0;\r\n  }\r\n\r\n  /* Settings */\r\n  .settings-details {\r\n    background-color: var(--color-surface);\r\n    border-radius: var(--radius-sm);\r\n    padding: var(--spacing-xs);\r\n  }\r\n\r\n  .settings-summary {\r\n    cursor: pointer;\r\n    font-size: var(--font-size-sm);\r\n    font-weight: 500;\r\n    padding: var(--spacing-xs);\r\n    user-select: none;\r\n  }\r\n\r\n  .settings-summary:hover {\r\n    color: var(--color-primary);\r\n  }\r\n\r\n  .exercise-settings {\r\n    display: flex;\r\n    flex-direction: column;\r\n    gap: var(--spacing-sm);\r\n    padding: var(--spacing-sm);\r\n    padding-top: 0;\r\n  }\r\n\r\n  .setting-label {\r\n    display: flex;\r\n    flex-direction: column;\r\n    gap: var(--spacing-xs);\r\n    font-size: var(--font-size-sm);\r\n  }\r\n\r\n  .label-text {\r\n    color: var(--color-text-muted);\r\n    font-weight: 500;\r\n  }\r\n\r\n  .setting-input {\r\n    padding: var(--spacing-xs) var(--spacing-sm);\r\n    border: 1px solid rgba(255, 255, 255, 0.1);\r\n    border-radius: var(--radius-sm);\r\n    background-color: var(--color-bg);\r\n    color: var(--color-text);\r\n    font-size: var(--font-size-sm);\r\n    width: 100%;\r\n  }\r\n\r\n  .setting-input:disabled {\r\n    opacity: 0.5;\r\n    cursor: not-allowed;\r\n  }\r\n\r\n  .setting-slider {\r\n    width: 100%;\r\n    accent-color: var(--color-primary);\r\n  }\r\n\r\n  .volume-value {\r\n    font-size: var(--font-size-xs);\r\n    color: var(--color-text-muted);\r\n  }\r\n\r\n  .pitch-range-buttons {\r\n    display: flex;\r\n    gap: var(--spacing-xs);\r\n  }\r\n\r\n  .range-btn {\r\n    flex: 1;\r\n    padding: var(--spacing-xs) var(--spacing-sm);\r\n    font-size: var(--font-size-xs);\r\n    font-weight: 500;\r\n    background-color: var(--color-bg);\r\n    color: var(--color-text);\r\n    border: 1px solid rgba(255, 255, 255, 0.1);\r\n    border-radius: var(--radius-sm);\r\n    cursor: pointer;\r\n    transition: all 0.2s ease;\r\n  }\r\n\r\n  .range-btn:hover:not(:disabled) {\r\n    background-color: var(--color-primary);\r\n    color: white;\r\n  }\r\n\r\n  .range-btn:disabled {\r\n    opacity: 0.5;\r\n    cursor: not-allowed;\r\n  }\r\n\r\n  /* Main Controls */\r\n  .exercise-controls {\r\n    display: flex;\r\n    flex-direction: column;\r\n    gap: var(--spacing-sm);\r\n  }\r\n\r\n  .start-exercise-btn {\r\n    padding: var(--spacing-md);\r\n    font-size: var(--font-size-md);\r\n    font-weight: 600;\r\n    background-color: var(--color-primary);\r\n    color: white;\r\n    border: none;\r\n    border-radius: var(--radius-md);\r\n    cursor: pointer;\r\n    transition: background-color 0.2s ease;\r\n  }\r\n\r\n  .start-exercise-btn:hover {\r\n    background-color: var(--color-primary-dark, #4a7bc8);\r\n  }\r\n\r\n  .stop-exercise-btn {\r\n    padding: var(--spacing-md);\r\n    font-size: var(--font-size-md);\r\n    font-weight: 600;\r\n    background-color: var(--color-error, #dc3545);\r\n    color: white;\r\n    border: none;\r\n    border-radius: var(--radius-md);\r\n    cursor: pointer;\r\n    transition: background-color 0.2s ease;\r\n  }\r\n\r\n  .stop-exercise-btn:hover {\r\n    background-color: #c82333;\r\n  }\r\n\r\n  .progress-indicator {\r\n    text-align: center;\r\n    font-size: var(--font-size-md);\r\n    font-weight: 600;\r\n    color: var(--color-text);\r\n  }\r\n\r\n  .phase-indicator {\r\n    text-align: center;\r\n    font-size: var(--font-size-lg);\r\n    font-weight: 500;\r\n    padding: var(--spacing-sm);\r\n    background-color: var(--color-surface);\r\n    border-radius: var(--radius-sm);\r\n    color: var(--color-text);\r\n  }\r\n\r\n  /* Results */\r\n  .exercise-results {\r\n    display: flex;\r\n    flex-direction: column;\r\n    gap: var(--spacing-sm);\r\n    background-color: var(--color-surface);\r\n    border-radius: var(--radius-sm);\r\n    padding: var(--spacing-md);\r\n  }\r\n\r\n  .results-title {\r\n    font-size: var(--font-size-sm);\r\n    font-weight: 600;\r\n    margin: 0;\r\n    color: var(--color-text);\r\n  }\r\n\r\n  .results-summary {\r\n    display: flex;\r\n    flex-direction: column;\r\n    gap: var(--spacing-xs);\r\n  }\r\n\r\n  .stat {\r\n    display: flex;\r\n    justify-content: space-between;\r\n    font-size: var(--font-size-sm);\r\n  }\r\n\r\n  .stat-label {\r\n    color: var(--color-text-muted);\r\n  }\r\n\r\n  .stat-value {\r\n    color: var(--color-text);\r\n    font-weight: 600;\r\n  }\r\n\r\n  .results-details {\r\n    margin-top: var(--spacing-xs);\r\n  }\r\n\r\n  .results-summary-label {\r\n    cursor: pointer;\r\n    font-size: var(--font-size-sm);\r\n    font-weight: 500;\r\n    padding: var(--spacing-xs);\r\n    user-select: none;\r\n  }\r\n\r\n  .results-summary-label:hover {\r\n    color: var(--color-primary);\r\n  }\r\n\r\n  .results-list {\r\n    display: flex;\r\n    flex-direction: column;\r\n    gap: var(--spacing-xs);\r\n    padding-top: var(--spacing-sm);\r\n  }\r\n\r\n  .result-item {\r\n    display: grid;\r\n    grid-template-columns: auto 1fr auto auto;\r\n    gap: var(--spacing-xs);\r\n    align-items: center;\r\n    padding: var(--spacing-xs);\r\n    background-color: var(--color-bg);\r\n    border-radius: var(--radius-sm);\r\n    font-size: var(--font-size-sm);\r\n  }\r\n\r\n  .result-item.hit {\r\n    border-left: 3px solid var(--color-success, #28a745);\r\n  }\r\n\r\n  .result-item:not(.hit) {\r\n    border-left: 3px solid var(--color-error, #dc3545);\r\n  }\r\n\r\n  .result-loop {\r\n    color: var(--color-text-muted);\r\n    font-weight: 500;\r\n  }\r\n\r\n  .result-pitch {\r\n    color: var(--color-text);\r\n    font-weight: 600;\r\n  }\r\n\r\n  .result-accuracy {\r\n    color: var(--color-text);\r\n  }\r\n\r\n  .result-status {\r\n    font-size: var(--font-size-md);\r\n    font-weight: bold;\r\n  }\r\n\r\n  .result-item.hit .result-status {\r\n    color: var(--color-success, #28a745);\r\n  }\r\n\r\n  .result-item:not(.hit) .result-status {\r\n    color: var(--color-error, #dc3545);\r\n  }\r\n</style>\r\n","/**\n * Ultrastar File Format Types\n *\n * Type definitions for parsing and working with UltraStar karaoke .txt files.\n * Supports YouTube video embedding and sync with the note highway.\n */\n\n/** Ultrastar metadata parsed from header lines (#KEY:VALUE) */\nexport interface UltrastarMetadata {\n  title: string;\n  artist: string;\n  video?: string; // YouTube URL or video ID\n  videoGap?: number; // Offset in seconds for video sync\n  gap?: number; // Offset in milliseconds for note timing\n  bpm: number; // Beats per minute (Ultrastar uses quarter-beat resolution)\n  mp3?: string; // Audio filename (not used for YouTube mode)\n  language?: string;\n  genre?: string;\n  year?: number;\n  creator?: string;\n  cover?: string;\n  background?: string;\n  previewStart?: number; // Preview start time in seconds\n}\n\n/** Note types from Ultrastar format */\nexport type UltrastarNoteType =\n  | ':' // Regular note\n  | '*' // Golden/bonus note (worth double points)\n  | 'F' // Freestyle note (no pitch judgment)\n  | 'R' // Rap note (rhythm only, no pitch)\n  | '-'; // Line/phrase break\n\n/** Parsed note from Ultrastar file */\nexport interface UltrastarNote {\n  type: UltrastarNoteType;\n  startBeat: number; // Beat number from song start\n  duration: number; // Duration in beats\n  pitch: number; // Relative pitch (0 = C4 in standard Ultrastar)\n  lyric: string; // Syllable text\n}\n\n/** Complete parsed Ultrastar song */\nexport interface UltrastarSong {\n  metadata: UltrastarMetadata;\n  notes: UltrastarNote[];\n  lineBreaks: number[]; // Beat positions of phrase breaks\n  totalBeats: number; // Total length in beats\n}\n\n/** YouTube player state */\nexport interface YouTubePlayerState {\n  isApiLoaded: boolean;\n  isReady: boolean;\n  isPlaying: boolean;\n  currentTime: number; // seconds\n  duration: number; // seconds\n  error?: string;\n}\n\n/** Sync configuration for YouTube-highway alignment */\nexport interface YouTubeSyncConfig {\n  gapMs: number; // GAP from Ultrastar (ms)\n  videoGapSec: number; // VIDEOGAP from Ultrastar (sec)\n  manualOffsetSec: number; // User-adjustable offset\n}\n\n/** Parser result with success/error info */\nexport type ParseResult =\n  | { success: true; song: UltrastarSong }\n  | { success: false; error: string };\n\n/** YouTube ID extraction patterns */\nexport const YOUTUBE_URL_PATTERNS = [\n  /(?:youtube\\.com\\/watch\\?v=|youtu\\.be\\/|youtube\\.com\\/embed\\/)([a-zA-Z0-9_-]{11})/,\n  /^([a-zA-Z0-9_-]{11})$/, // Direct video ID\n] as const;\n\n/** Default sync configuration */\nexport const DEFAULT_SYNC_CONFIG: YouTubeSyncConfig = {\n  gapMs: 0,\n  videoGapSec: 0,\n  manualOffsetSec: 0,\n};\n\n/** Standard Ultrastar base MIDI (0 = C4 = MIDI 60) */\nexport const ULTRASTAR_BASE_MIDI = 60;\n","/**\n * Ultrastar Parser Service\n *\n * Parses UltraStar karaoke .txt files into structured data for the singing trainer.\n * Handles metadata extraction, note parsing, and conversion to highway target notes.\n */\n\nimport type {\n  UltrastarMetadata,\n  UltrastarNote,\n  UltrastarNoteType,\n  UltrastarSong,\n  ParseResult,\n  YouTubeSyncConfig,\n} from '../types/ultrastar.js';\nimport { YOUTUBE_URL_PATTERNS, ULTRASTAR_BASE_MIDI } from '../types/ultrastar.js';\nimport type { TargetNote } from '../stores/highwayState.svelte.js';\n\n/**\n * Parse an Ultrastar .txt file content into structured song data\n */\nexport function parseUltrastarFile(content: string): ParseResult {\n  try {\n    const lines = content.split(/\\r?\\n/).map((line) => line.trim());\n\n    // Extract metadata from header lines\n    const metadata = extractMetadata(lines);\n\n    if (!metadata.bpm) {\n      return { success: false, error: 'Missing required #BPM tag' };\n    }\n\n    // Parse note lines\n    const { notes, lineBreaks, totalBeats } = parseNoteLines(lines);\n\n    if (notes.length === 0) {\n      return { success: false, error: 'No valid notes found in file' };\n    }\n\n    return {\n      success: true,\n      song: {\n        metadata,\n        notes,\n        lineBreaks,\n        totalBeats,\n      },\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Unknown parsing error',\n    };\n  }\n}\n\n/**\n * Extract metadata from header lines (#KEY:VALUE format)\n */\nexport function extractMetadata(lines: string[]): UltrastarMetadata {\n  const metadata: Partial<UltrastarMetadata> = {};\n\n  for (const line of lines) {\n    if (!line.startsWith('#')) continue;\n\n    const colonIndex = line.indexOf(':');\n    if (colonIndex === -1) continue;\n\n    const key = line.slice(1, colonIndex).toUpperCase().trim();\n    const value = line.slice(colonIndex + 1).trim();\n\n    switch (key) {\n      case 'TITLE':\n        metadata.title = value;\n        break;\n      case 'ARTIST':\n        metadata.artist = value;\n        break;\n      case 'VIDEO':\n        metadata.video = value;\n        break;\n      case 'VIDEOGAP':\n        // VIDEOGAP is in seconds (can be negative)\n        metadata.videoGap = parseFloat(value.replace(',', '.')) || 0;\n        break;\n      case 'GAP':\n        // GAP is in milliseconds (can use comma as decimal separator)\n        metadata.gap = parseFloat(value.replace(',', '.')) || 0;\n        break;\n      case 'BPM':\n        // BPM uses comma as decimal separator in some files\n        metadata.bpm = parseFloat(value.replace(',', '.')) || 0;\n        break;\n      case 'MP3':\n      case 'AUDIO':\n        metadata.mp3 = value;\n        break;\n      case 'LANGUAGE':\n        metadata.language = value;\n        break;\n      case 'GENRE':\n        metadata.genre = value;\n        break;\n      case 'YEAR':\n        metadata.year = parseInt(value) || undefined;\n        break;\n      case 'CREATOR':\n        metadata.creator = value;\n        break;\n      case 'COVER':\n        metadata.cover = value;\n        break;\n      case 'BACKGROUND':\n        metadata.background = value;\n        break;\n      case 'PREVIEWSTART':\n        metadata.previewStart = parseFloat(value.replace(',', '.')) || 0;\n        break;\n    }\n  }\n\n  return {\n    title: metadata.title || 'Unknown Title',\n    artist: metadata.artist || 'Unknown Artist',\n    bpm: metadata.bpm || 0,\n    ...metadata,\n  };\n}\n\n/**\n * Parse note lines from Ultrastar format\n */\nexport function parseNoteLines(lines: string[]): {\n  notes: UltrastarNote[];\n  lineBreaks: number[];\n  totalBeats: number;\n} {\n  const notes: UltrastarNote[] = [];\n  const lineBreaks: number[] = [];\n  let totalBeats = 0;\n\n  for (const line of lines) {\n    if (line.length === 0 || line.startsWith('#')) continue;\n\n    const firstChar = line[0];\n\n    // End of song marker\n    if (firstChar === 'E') break;\n\n    // Line break marker\n    if (firstChar === '-') {\n      const parts = line.slice(1).trim().split(/\\s+/);\n      const beat = parseInt(parts[0]) || 0;\n      lineBreaks.push(beat);\n      continue;\n    }\n\n    // Note types: :, *, F, R\n    if ([':','*', 'F', 'R'].includes(firstChar)) {\n      const note = parseNoteLine(line);\n      if (note) {\n        notes.push(note);\n        const noteEnd = note.startBeat + note.duration;\n        if (noteEnd > totalBeats) {\n          totalBeats = noteEnd;\n        }\n      }\n    }\n  }\n\n  return { notes, lineBreaks, totalBeats };\n}\n\n/**\n * Parse a single note line\n * Format: TYPE STARTBEAT DURATION PITCH LYRIC\n * Example: : 0 5 60 Hel\n */\nfunction parseNoteLine(line: string): UltrastarNote | null {\n  const type = line[0] as UltrastarNoteType;\n  const rest = line.slice(1).trim();\n\n  // Split by whitespace, but keep lyric text together\n  const parts = rest.split(/\\s+/);\n  if (parts.length < 3) return null;\n\n  const startBeat = parseInt(parts[0]);\n  const duration = parseInt(parts[1]);\n  const pitch = parseInt(parts[2]);\n  const lyric = parts.slice(3).join(' ') || '';\n\n  if (isNaN(startBeat) || isNaN(duration) || isNaN(pitch)) {\n    return null;\n  }\n\n  return {\n    type,\n    startBeat,\n    duration,\n    pitch,\n    lyric,\n  };\n}\n\n/**\n * Extract YouTube video ID from URL or direct ID\n */\nexport function extractYouTubeId(urlOrId: string): string | null {\n  if (!urlOrId) return null;\n\n  const trimmed = urlOrId.trim();\n\n  for (const pattern of YOUTUBE_URL_PATTERNS) {\n    const match = trimmed.match(pattern);\n    if (match && match[1]) {\n      return match[1];\n    }\n  }\n\n  return null;\n}\n\n/**\n * Convert Ultrastar song to highway target notes\n *\n * Note: GAP is NOT added to note timing here. GAP represents the offset\n * from audio start to first note, and is handled separately via YouTube sync.\n * Note timing is relative to transport time 0 = first beat of song.\n */\nexport function convertToTargetNotes(\n  song: UltrastarSong,\n  baseMidi: number = ULTRASTAR_BASE_MIDI\n): TargetNote[] {\n  const { metadata, notes, lineBreaks } = song;\n  const { bpm } = metadata;\n\n  // Calculate milliseconds per beat\n  // Ultrastar BPM is actually quarter-beat resolution (beats are 1/4 notes)\n  // So we multiply by 4 to get real ms per beat unit\n  const msPerBeat = (60 / bpm) * 1000 * 4;\n\n  // Group notes by phrase (between line breaks)\n  let phraseIndex = 0;\n  const sortedBreaks = [...lineBreaks].sort((a, b) => a - b);\n\n  // Find the first note's beat to use as reference (transport 0 = first note)\n  const firstNoteBeat = notes.length > 0 ? Math.min(...notes.map(n => n.startBeat)) : 0;\n\n  return notes\n    .filter((note) => note.type !== 'F') // Skip freestyle notes (no pitch judgment)\n    .map((note) => {\n      // Calculate timing relative to first note (so first note starts at ~0)\n      const startTimeMs = (note.startBeat - firstNoteBeat) * msPerBeat;\n      const durationMs = note.duration * msPerBeat;\n\n      // Convert relative pitch to MIDI\n      const midi = baseMidi + note.pitch;\n\n      // Determine phrase index\n      while (\n        phraseIndex < sortedBreaks.length &&\n        note.startBeat >= sortedBreaks[phraseIndex]\n      ) {\n        phraseIndex++;\n      }\n\n      // Build target note\n      const targetNote: TargetNote & {\n        phraseIndex?: number;\n        isGolden?: boolean;\n      } = {\n        midi,\n        startTimeMs,\n        durationMs,\n        lyric: note.lyric.trim() || undefined,\n      };\n\n      // Add optional metadata\n      if (note.type === '*') {\n        targetNote.isGolden = true;\n      }\n\n      return targetNote;\n    });\n}\n\n/**\n * Get sync configuration from Ultrastar metadata\n */\nexport function getSyncConfig(metadata: UltrastarMetadata): YouTubeSyncConfig {\n  return {\n    gapMs: metadata.gap || 0,\n    videoGapSec: metadata.videoGap || 0,\n    manualOffsetSec: 0,\n  };\n}\n\n/**\n * Calculate total duration of song in milliseconds\n * Duration is relative to transport time 0 = first note\n */\nexport function calculateSongDuration(song: UltrastarSong): number {\n  const { metadata, notes, totalBeats } = song;\n  const { bpm } = metadata;\n\n  // Ultrastar BPM is quarter-beat resolution\n  const msPerBeat = (60 / bpm) * 1000 * 4;\n\n  // Find first note beat to calculate relative duration\n  const firstNoteBeat = notes.length > 0 ? Math.min(...notes.map(n => n.startBeat)) : 0;\n  const relativeTotalBeats = totalBeats - firstNoteBeat;\n\n  // Add some buffer after the last note\n  return relativeTotalBeats * msPerBeat + 2000;\n}\n\n/**\n * Detect pitch range of song (for auto-adjusting viewport)\n */\nexport function detectPitchRange(\n  song: UltrastarSong,\n  baseMidi: number = ULTRASTAR_BASE_MIDI\n): { minMidi: number; maxMidi: number } {\n  const midiNotes = song.notes\n    .filter((note) => note.type !== 'F' && note.type !== '-')\n    .map((note) => baseMidi + note.pitch);\n\n  if (midiNotes.length === 0) {\n    return { minMidi: 48, maxMidi: 72 };\n  }\n\n  const minMidi = Math.min(...midiNotes);\n  const maxMidi = Math.max(...midiNotes);\n\n  // Add some padding\n  return {\n    minMidi: Math.max(24, minMidi - 3),\n    maxMidi: Math.min(108, maxMidi + 3),\n  };\n}\n\n/**\n * Group notes by phrase for results breakdown\n */\nexport function groupNotesByPhrase(\n  notes: UltrastarNote[],\n  lineBreaks: number[]\n): UltrastarNote[][] {\n  const phrases: UltrastarNote[][] = [];\n  const sortedBreaks = [0, ...lineBreaks].sort((a, b) => a - b);\n\n  for (let i = 0; i < sortedBreaks.length; i++) {\n    const start = sortedBreaks[i];\n    const end = sortedBreaks[i + 1] ?? Infinity;\n\n    const phraseNotes = notes.filter(\n      (note) => note.startBeat >= start && note.startBeat < end\n    );\n\n    if (phraseNotes.length > 0) {\n      phrases.push(phraseNotes);\n    }\n  }\n\n  return phrases;\n}\n\n/**\n * Get lyric preview for a phrase (first few syllables)\n */\nexport function getPhraseLyricPreview(notes: UltrastarNote[], maxLength = 30): string {\n  const lyrics = notes\n    .map((n) => n.lyric)\n    .join('')\n    .trim();\n\n  if (lyrics.length <= maxLength) {\n    return lyrics;\n  }\n\n  return lyrics.slice(0, maxLength - 3) + '...';\n}\n","/**\n * Ultrastar State Store - Svelte 5 Runes\n *\n * Manages the state for loaded Ultrastar karaoke files,\n * including parsed song data, sync configuration, and playback state.\n */\n\nimport type {\n  UltrastarSong,\n  YouTubeSyncConfig,\n} from '../types/ultrastar.js';\nimport { DEFAULT_SYNC_CONFIG, ULTRASTAR_BASE_MIDI } from '../types/ultrastar.js';\nimport {\n  parseUltrastarFile,\n  extractYouTubeId,\n  convertToTargetNotes,\n  getSyncConfig,\n  calculateSongDuration,\n  detectPitchRange,\n} from '../services/ultrastarParser.js';\nimport type { TargetNote } from './highwayState.svelte.js';\n\nexport interface UltrastarState {\n  isActive: boolean;\n  isLoading: boolean;\n  isPlaying: boolean;\n  song: UltrastarSong | null;\n  targetNotes: TargetNote[];\n  youtubeId: string | null;\n  syncConfig: YouTubeSyncConfig;\n  baseMidi: number;\n  totalDurationMs: number;\n  detectedRange: { minMidi: number; maxMidi: number };\n  error: string | null;\n}\n\nconst DEFAULT_STATE: UltrastarState = {\n  isActive: false,\n  isLoading: false,\n  isPlaying: false,\n  song: null,\n  targetNotes: [],\n  youtubeId: null,\n  syncConfig: { ...DEFAULT_SYNC_CONFIG },\n  baseMidi: ULTRASTAR_BASE_MIDI,\n  totalDurationMs: 0,\n  detectedRange: { minMidi: 48, maxMidi: 72 },\n  error: null,\n};\n\nfunction createUltrastarState() {\n  let state = $state<UltrastarState>({ ...DEFAULT_STATE });\n\n  // Completion callback\n  let onCompleteCallback: (() => void) | null = null;\n\n  return {\n    get state() {\n      return state;\n    },\n\n    /** Load and parse an Ultrastar .txt file */\n    async loadFile(file: File): Promise<boolean> {\n      state.isLoading = true;\n      state.error = null;\n\n      try {\n        const content = await file.text();\n        const result = parseUltrastarFile(content);\n\n        if (!result.success) {\n          state.error = result.error;\n          state.isLoading = false;\n          return false;\n        }\n\n        const song = result.song;\n\n        // Extract YouTube ID if video is specified\n        const youtubeId = song.metadata.video\n          ? extractYouTubeId(song.metadata.video)\n          : null;\n\n        // Get sync configuration from metadata\n        const syncConfig = getSyncConfig(song.metadata);\n\n        // Convert notes to target format\n        const targetNotes = convertToTargetNotes(song, state.baseMidi);\n\n        // Calculate duration and detect pitch range\n        const totalDurationMs = calculateSongDuration(song);\n        const detectedRange = detectPitchRange(song, state.baseMidi);\n\n        // Update state\n        state.song = song;\n        state.youtubeId = youtubeId;\n        state.syncConfig = syncConfig;\n        state.targetNotes = targetNotes;\n        state.totalDurationMs = totalDurationMs;\n        state.detectedRange = detectedRange;\n        state.isActive = true;\n        state.isLoading = false;\n\n        return true;\n      } catch (error) {\n        state.error = error instanceof Error ? error.message : 'Failed to load file';\n        state.isLoading = false;\n        return false;\n      }\n    },\n\n    /** Get the computed YouTube offset in seconds */\n    get youtubeOffset(): number {\n      const { gapMs, videoGapSec, manualOffsetSec } = state.syncConfig;\n      return gapMs / 1000 + videoGapSec + manualOffsetSec;\n    },\n\n    /** Adjust the manual sync offset */\n    adjustOffset(deltaSec: number) {\n      state.syncConfig = {\n        ...state.syncConfig,\n        manualOffsetSec: state.syncConfig.manualOffsetSec + deltaSec,\n      };\n    },\n\n    /** Set the manual sync offset directly */\n    setManualOffset(offsetSec: number) {\n      state.syncConfig = {\n        ...state.syncConfig,\n        manualOffsetSec: offsetSec,\n      };\n    },\n\n    /** Reset manual offset to zero */\n    resetOffset() {\n      state.syncConfig = {\n        ...state.syncConfig,\n        manualOffsetSec: 0,\n      };\n    },\n\n    /** Set the base MIDI note for pitch conversion */\n    setBaseMidi(midi: number) {\n      state.baseMidi = midi;\n\n      // Reconvert notes if song is loaded\n      if (state.song) {\n        state.targetNotes = convertToTargetNotes(state.song, midi);\n        state.detectedRange = detectPitchRange(state.song, midi);\n      }\n    },\n\n    /** Set playing state */\n    setPlaying(playing: boolean) {\n      state.isPlaying = playing;\n    },\n\n    /** Register completion callback */\n    onComplete(callback: () => void) {\n      onCompleteCallback = callback;\n    },\n\n    /** Trigger completion (called when song ends) */\n    triggerComplete() {\n      state.isPlaying = false;\n      if (onCompleteCallback) {\n        onCompleteCallback();\n      }\n    },\n\n    /** Check if current time has exceeded song duration */\n    checkCompletion(currentTimeMs: number): boolean {\n      if (!state.isPlaying || !state.isActive) return false;\n\n      // Add a small buffer before triggering completion\n      if (currentTimeMs >= state.totalDurationMs - 500) {\n        this.triggerComplete();\n        return true;\n      }\n\n      return false;\n    },\n\n    /** Get song title */\n    get title(): string {\n      return state.song?.metadata.title || '';\n    },\n\n    /** Get song artist */\n    get artist(): string {\n      return state.song?.metadata.artist || '';\n    },\n\n    /** Check if YouTube video is available */\n    get hasVideo(): boolean {\n      return state.youtubeId !== null;\n    },\n\n    /** Reset state and clear loaded song */\n    reset() {\n      state = { ...DEFAULT_STATE };\n      onCompleteCallback = null;\n    },\n\n    /** Unload song but preserve settings */\n    unload() {\n      state.isActive = false;\n      state.isPlaying = false;\n      state.song = null;\n      state.targetNotes = [];\n      state.youtubeId = null;\n      state.totalDurationMs = 0;\n      state.error = null;\n    },\n  };\n}\n\nexport const ultrastarState = createUltrastarState();\n","/**\n * YouTube Player Service\n *\n * Manages the YouTube IFrame Player API for embedding and controlling\n * YouTube videos synchronized with the note highway.\n */\n\n// YouTube IFrame API types\ndeclare global {\n  interface Window {\n    YT: typeof YT;\n    onYouTubeIframeAPIReady: () => void;\n  }\n\n  namespace YT {\n    interface Player {\n      playVideo(): void;\n      pauseVideo(): void;\n      stopVideo(): void;\n      seekTo(seconds: number, allowSeekAhead?: boolean): void;\n      getCurrentTime(): number;\n      getDuration(): number;\n      getPlayerState(): PlayerState;\n      getVideoUrl(): string;\n      destroy(): void;\n      setVolume(volume: number): void;\n      getVolume(): number;\n      mute(): void;\n      unMute(): void;\n      isMuted(): boolean;\n    }\n\n    interface PlayerOptions {\n      height?: string | number;\n      width?: string | number;\n      videoId?: string;\n      playerVars?: PlayerVars;\n      events?: PlayerEvents;\n    }\n\n    interface PlayerVars {\n      autoplay?: 0 | 1;\n      controls?: 0 | 1;\n      disablekb?: 0 | 1;\n      enablejsapi?: 0 | 1;\n      fs?: 0 | 1;\n      modestbranding?: 0 | 1;\n      origin?: string;\n      playsinline?: 0 | 1;\n      rel?: 0 | 1;\n      start?: number;\n    }\n\n    interface PlayerEvents {\n      onReady?: (event: PlayerEvent) => void;\n      onStateChange?: (event: OnStateChangeEvent) => void;\n      onError?: (event: OnErrorEvent) => void;\n    }\n\n    interface PlayerEvent {\n      target: Player;\n    }\n\n    interface OnStateChangeEvent {\n      target: Player;\n      data: PlayerState;\n    }\n\n    interface OnErrorEvent {\n      target: Player;\n      data: PlayerError;\n    }\n\n    enum PlayerState {\n      UNSTARTED = -1,\n      ENDED = 0,\n      PLAYING = 1,\n      PAUSED = 2,\n      BUFFERING = 3,\n      CUED = 5,\n    }\n\n    enum PlayerError {\n      InvalidParam = 2,\n      Html5Error = 5,\n      VideoNotFound = 100,\n      NotAllowedEmbedded = 101,\n      NotAllowedEmbedded2 = 150,\n    }\n\n    const Player: {\n      new (elementId: string | HTMLElement, options: PlayerOptions): Player;\n    };\n  }\n}\n\nlet apiLoadPromise: Promise<void> | null = null;\nlet isApiLoaded = false;\n\n/**\n * Load the YouTube IFrame Player API script\n */\nexport function loadYouTubeAPI(): Promise<void> {\n  // Return existing promise if already loading\n  if (apiLoadPromise) return apiLoadPromise;\n\n  // Already loaded\n  if (isApiLoaded && window.YT && window.YT.Player) {\n    return Promise.resolve();\n  }\n\n  apiLoadPromise = new Promise((resolve, reject) => {\n    // Check if already loaded\n    if (window.YT && window.YT.Player) {\n      isApiLoaded = true;\n      resolve();\n      return;\n    }\n\n    // Set up callback for when API is ready\n    window.onYouTubeIframeAPIReady = () => {\n      isApiLoaded = true;\n      resolve();\n    };\n\n    // Create and inject the script\n    const script = document.createElement('script');\n    script.src = 'https://www.youtube.com/iframe_api';\n    script.async = true;\n    script.onerror = () => {\n      reject(new Error('Failed to load YouTube IFrame API'));\n    };\n\n    document.head.appendChild(script);\n\n    // Timeout after 10 seconds\n    setTimeout(() => {\n      if (!isApiLoaded) {\n        reject(new Error('YouTube IFrame API load timeout'));\n      }\n    }, 10000);\n  });\n\n  return apiLoadPromise;\n}\n\n/**\n * Check if YouTube API is loaded\n */\nexport function isYouTubeAPILoaded(): boolean {\n  return isApiLoaded && !!window.YT?.Player;\n}\n\n/**\n * Create a YouTube player instance\n */\nexport function createYouTubePlayer(\n  elementId: string,\n  videoId: string,\n  options: {\n    width?: number;\n    height?: number;\n    onReady?: (player: YT.Player) => void;\n    onStateChange?: (state: YT.PlayerState) => void;\n    onError?: (error: YT.PlayerError) => void;\n  } = {}\n): YT.Player {\n  if (!isApiLoaded || !window.YT?.Player) {\n    throw new Error('YouTube API not loaded. Call loadYouTubeAPI() first.');\n  }\n\n  const { width = 320, height = 180, onReady, onStateChange, onError } = options;\n\n  return new window.YT.Player(elementId, {\n    width,\n    height,\n    videoId,\n    playerVars: {\n      autoplay: 0,\n      controls: 1,\n      disablekb: 1, // Disable keyboard controls (we handle our own)\n      enablejsapi: 1,\n      fs: 0, // Disable fullscreen button\n      modestbranding: 1,\n      origin: window.location.origin,\n      playsinline: 1,\n      rel: 0, // Don't show related videos\n    },\n    events: {\n      onReady: (event) => {\n        onReady?.(event.target);\n      },\n      onStateChange: (event) => {\n        onStateChange?.(event.data);\n      },\n      onError: (event) => {\n        onError?.(event.data);\n      },\n    },\n  });\n}\n\n/**\n * Get human-readable error message for YouTube player errors\n */\nexport function getYouTubeErrorMessage(error: YT.PlayerError): string {\n  switch (error) {\n    case YT.PlayerError.InvalidParam:\n      return 'Invalid video ID';\n    case YT.PlayerError.Html5Error:\n      return 'HTML5 player error';\n    case YT.PlayerError.VideoNotFound:\n      return 'Video not found';\n    case YT.PlayerError.NotAllowedEmbedded:\n    case YT.PlayerError.NotAllowedEmbedded2:\n      return 'Video cannot be embedded';\n    default:\n      return 'Unknown player error';\n  }\n}\n\n/**\n * Get player state name for debugging\n */\nexport function getPlayerStateName(state: YT.PlayerState): string {\n  switch (state) {\n    case YT.PlayerState.UNSTARTED:\n      return 'unstarted';\n    case YT.PlayerState.ENDED:\n      return 'ended';\n    case YT.PlayerState.PLAYING:\n      return 'playing';\n    case YT.PlayerState.PAUSED:\n      return 'paused';\n    case YT.PlayerState.BUFFERING:\n      return 'buffering';\n    case YT.PlayerState.CUED:\n      return 'cued';\n    default:\n      return 'unknown';\n  }\n}\n","/**\n * YouTube State Store - Svelte 5 Runes\n *\n * Manages the YouTube player instance and playback state,\n * including sync with the note highway transport.\n */\n\nimport {\n  loadYouTubeAPI,\n  createYouTubePlayer,\n  isYouTubeAPILoaded,\n  getYouTubeErrorMessage,\n} from '../services/youtubePlayer.js';\n\nexport interface YouTubeState {\n  isApiLoaded: boolean;\n  isApiLoading: boolean;\n  isPlayerReady: boolean;\n  isPlaying: boolean;\n  currentTime: number; // seconds\n  duration: number; // seconds\n  videoId: string | null;\n  error: string | null;\n  isEmbeddable: boolean;\n  volume: number; // 0-100\n  isMuted: boolean;\n}\n\nconst DEFAULT_STATE: YouTubeState = {\n  isApiLoaded: false,\n  isApiLoading: false,\n  isPlayerReady: false,\n  isPlaying: false,\n  currentTime: 0,\n  duration: 0,\n  videoId: null,\n  error: null,\n  isEmbeddable: true,\n  volume: 100,\n  isMuted: false,\n};\n\nfunction createYouTubeState() {\n  let state = $state<YouTubeState>({ ...DEFAULT_STATE });\n  let player: YT.Player | null = null;\n  let syncIntervalId: number | null = null;\n  let timeUpdateCallback: ((time: number) => void) | null = null;\n\n  return {\n    get state() {\n      return state;\n    },\n\n    /** Initialize the YouTube IFrame API */\n    async initAPI(): Promise<boolean> {\n      if (state.isApiLoaded) return true;\n      if (state.isApiLoading) return false;\n\n      state.isApiLoading = true;\n      state.error = null;\n\n      try {\n        await loadYouTubeAPI();\n        state.isApiLoaded = true;\n        state.isApiLoading = false;\n        return true;\n      } catch (error) {\n        state.error = error instanceof Error ? error.message : 'Failed to load YouTube API';\n        state.isApiLoading = false;\n        return false;\n      }\n    },\n\n    /** Load a video into the player */\n    async loadVideo(videoId: string, containerId: string): Promise<boolean> {\n      // Ensure API is loaded\n      if (!state.isApiLoaded) {\n        const loaded = await this.initAPI();\n        if (!loaded) return false;\n      }\n\n      // Dispose existing player\n      if (player) {\n        try {\n          player.destroy();\n        } catch {\n          // Player may already be destroyed\n        }\n        player = null;\n      }\n\n      state.isPlayerReady = false;\n      state.error = null;\n      state.isEmbeddable = true;\n      state.videoId = videoId;\n\n      return new Promise((resolve) => {\n        try {\n          player = createYouTubePlayer(containerId, videoId, {\n            onReady: (p) => {\n              state.isPlayerReady = true;\n              state.duration = p.getDuration();\n              state.volume = p.getVolume();\n              state.isMuted = p.isMuted();\n              resolve(true);\n            },\n            onStateChange: (playerState) => {\n              // Update playing state\n              state.isPlaying = playerState === YT.PlayerState.PLAYING;\n\n              // Check for video ended\n              if (playerState === YT.PlayerState.ENDED) {\n                state.isPlaying = false;\n                this.stopSyncLoop();\n              }\n            },\n            onError: (error) => {\n              state.error = getYouTubeErrorMessage(error);\n              state.isEmbeddable =\n                error !== YT.PlayerError.NotAllowedEmbedded &&\n                error !== YT.PlayerError.NotAllowedEmbedded2;\n              state.isPlayerReady = false;\n              resolve(false);\n            },\n          });\n        } catch (error) {\n          state.error = error instanceof Error ? error.message : 'Failed to create player';\n          resolve(false);\n        }\n      });\n    },\n\n    /** Play the video */\n    play() {\n      if (player && state.isPlayerReady) {\n        player.playVideo();\n      }\n    },\n\n    /** Pause the video */\n    pause() {\n      if (player && state.isPlayerReady) {\n        player.pauseVideo();\n      }\n    },\n\n    /** Stop the video */\n    stop() {\n      if (player && state.isPlayerReady) {\n        player.stopVideo();\n        state.isPlaying = false;\n      }\n      this.stopSyncLoop();\n    },\n\n    /** Seek to a specific time in seconds */\n    seekTo(timeSeconds: number) {\n      if (player && state.isPlayerReady) {\n        player.seekTo(Math.max(0, timeSeconds), true);\n        state.currentTime = Math.max(0, timeSeconds);\n      }\n    },\n\n    /** Get current playback time */\n    getCurrentTime(): number {\n      if (player && state.isPlayerReady) {\n        return player.getCurrentTime();\n      }\n      return state.currentTime;\n    },\n\n    /** Set volume (0-100) */\n    setVolume(volume: number) {\n      const v = Math.max(0, Math.min(100, volume));\n      if (player && state.isPlayerReady) {\n        player.setVolume(v);\n      }\n      state.volume = v;\n    },\n\n    /** Mute the video */\n    mute() {\n      if (player && state.isPlayerReady) {\n        player.mute();\n      }\n      state.isMuted = true;\n    },\n\n    /** Unmute the video */\n    unmute() {\n      if (player && state.isPlayerReady) {\n        player.unMute();\n      }\n      state.isMuted = false;\n    },\n\n    /** Toggle mute state */\n    toggleMute() {\n      if (state.isMuted) {\n        this.unmute();\n      } else {\n        this.mute();\n      }\n    },\n\n    /** Start the sync loop for drift correction */\n    startSyncLoop(onTimeUpdate: (time: number) => void, intervalMs = 250) {\n      timeUpdateCallback = onTimeUpdate;\n\n      if (syncIntervalId !== null) {\n        clearInterval(syncIntervalId);\n      }\n\n      syncIntervalId = window.setInterval(() => {\n        if (player && state.isPlayerReady && state.isPlaying) {\n          const currentTime = player.getCurrentTime();\n          state.currentTime = currentTime;\n          timeUpdateCallback?.(currentTime);\n        }\n      }, intervalMs);\n    },\n\n    /** Stop the sync loop */\n    stopSyncLoop() {\n      if (syncIntervalId !== null) {\n        clearInterval(syncIntervalId);\n        syncIntervalId = null;\n      }\n      timeUpdateCallback = null;\n    },\n\n    /** Check and correct drift if needed */\n    correctDrift(expectedTimeSec: number, maxDriftMs = 150): boolean {\n      if (!player || !state.isPlayerReady || !state.isPlaying) return false;\n\n      const actualTime = player.getCurrentTime();\n      const driftMs = Math.abs(actualTime - expectedTimeSec) * 1000;\n\n      if (driftMs > maxDriftMs) {\n        player.seekTo(expectedTimeSec, true);\n        return true;\n      }\n\n      return false;\n    },\n\n    /** Get the YouTube video URL for fallback */\n    getVideoUrl(): string | null {\n      if (!state.videoId) return null;\n      return `https://www.youtube.com/watch?v=${state.videoId}`;\n    },\n\n    /** Dispose of the player and clean up */\n    dispose() {\n      this.stopSyncLoop();\n\n      if (player) {\n        try {\n          player.destroy();\n        } catch {\n          // Player may already be destroyed\n        }\n        player = null;\n      }\n\n      state = { ...DEFAULT_STATE, isApiLoaded: state.isApiLoaded };\n    },\n\n    /** Reset to initial state */\n    reset() {\n      this.dispose();\n      state = { ...DEFAULT_STATE };\n    },\n  };\n}\n\nexport const youtubeState = createYouTubeState();\n","/**\n * Transport Sync Service\n *\n * Coordinates time synchronization between the note highway transport\n * and YouTube player. Handles offset calculations and drift correction.\n */\n\nimport type { YouTubeSyncConfig } from '../types/ultrastar.js';\n\nexport interface TransportSyncOptions {\n  /** Sync configuration from Ultrastar metadata */\n  syncConfig: YouTubeSyncConfig;\n  /** Interval for checking drift (ms) */\n  driftCheckIntervalMs?: number;\n  /** Maximum allowed drift before correction (ms) */\n  maxDriftMs?: number;\n}\n\nexport interface DriftCheckResult {\n  /** Drift amount in milliseconds */\n  driftMs: number;\n  /** Whether drift exceeds threshold and needs correction */\n  needsCorrection: boolean;\n  /** Suggested corrected transport time (ms) */\n  correctedTransportTimeMs?: number;\n}\n\n/**\n * Create a transport sync coordinator\n */\nexport function createTransportSync(options: TransportSyncOptions) {\n  let config = { ...options.syncConfig };\n  const driftCheckIntervalMs = options.driftCheckIntervalMs ?? 250;\n  const maxDriftMs = options.maxDriftMs ?? 150;\n\n  /**\n   * Calculate the total YouTube offset in seconds\n   * youtubeOffset = (GAP_ms/1000) + VIDEOGAP_sec + manualOffset\n   */\n  function getYouTubeOffset(): number {\n    return config.gapMs / 1000 + config.videoGapSec + config.manualOffsetSec;\n  }\n\n  /**\n   * Convert transport time (ms) to YouTube time (seconds)\n   * When transport is at 0, YouTube should be at youtubeOffset\n   */\n  function transportToYouTube(transportTimeMs: number): number {\n    return transportTimeMs / 1000 + getYouTubeOffset();\n  }\n\n  /**\n   * Convert YouTube time (seconds) to transport time (ms)\n   */\n  function youTubeToTransport(youtubeTimeSec: number): number {\n    return (youtubeTimeSec - getYouTubeOffset()) * 1000;\n  }\n\n  /**\n   * Check drift between expected and actual YouTube time\n   */\n  function checkDrift(\n    transportTimeMs: number,\n    youtubeTimeSec: number\n  ): DriftCheckResult {\n    const expectedYouTubeTime = transportToYouTube(transportTimeMs);\n    const driftSec = youtubeTimeSec - expectedYouTubeTime;\n    const driftMs = Math.abs(driftSec * 1000);\n\n    if (driftMs > maxDriftMs) {\n      // Calculate corrected transport time based on actual YouTube position\n      const correctedTransportTimeMs = youTubeToTransport(youtubeTimeSec);\n      return {\n        driftMs,\n        needsCorrection: true,\n        correctedTransportTimeMs,\n      };\n    }\n\n    return {\n      driftMs,\n      needsCorrection: false,\n    };\n  }\n\n  /**\n   * Update sync configuration\n   */\n  function updateConfig(partial: Partial<YouTubeSyncConfig>) {\n    config = { ...config, ...partial };\n  }\n\n  /**\n   * Adjust manual offset by a delta\n   */\n  function adjustManualOffset(deltaSec: number) {\n    config.manualOffsetSec += deltaSec;\n  }\n\n  /**\n   * Reset manual offset to zero\n   */\n  function resetManualOffset() {\n    config.manualOffsetSec = 0;\n  }\n\n  /**\n   * Get the current manual offset\n   */\n  function getManualOffset(): number {\n    return config.manualOffsetSec;\n  }\n\n  /**\n   * Get total offset in seconds\n   */\n  function getTotalOffset(): number {\n    return getYouTubeOffset();\n  }\n\n  /**\n   * Format offset for display (e.g., \"+0.15s\" or \"-0.30s\")\n   */\n  function formatOffset(): string {\n    const offset = config.manualOffsetSec;\n    const sign = offset >= 0 ? '+' : '';\n    return `${sign}${offset.toFixed(2)}s`;\n  }\n\n  /**\n   * Get configuration for creating sync loop\n   */\n  function getSyncLoopConfig() {\n    return {\n      intervalMs: driftCheckIntervalMs,\n      maxDriftMs,\n    };\n  }\n\n  return {\n    // Getters\n    getYouTubeOffset,\n    getTotalOffset,\n    getManualOffset,\n    getSyncLoopConfig,\n\n    // Conversion\n    transportToYouTube,\n    youTubeToTransport,\n\n    // Drift handling\n    checkDrift,\n\n    // Configuration\n    updateConfig,\n    adjustManualOffset,\n    resetManualOffset,\n\n    // Formatting\n    formatOffset,\n\n    // Get current config (for persistence)\n    getConfig: () => ({ ...config }),\n  };\n}\n\n/** Type for the transport sync instance */\nexport type TransportSyncInstance = ReturnType<typeof createTransportSync>;\n","<script lang=\"ts\">\n  /**\n   * YouTube Player Component\n   *\n   * Embeds a YouTube video player synchronized with the note highway.\n   * Shows loading state, error handling, and fallback for non-embeddable videos.\n   */\n\n  import { onMount, onDestroy } from 'svelte';\n  import { youtubeState } from '../../stores/youtubeState.svelte.js';\n  import { ultrastarState } from '../../stores/ultrastarState.svelte.js';\n\n  // Unique ID for the player container\n  const playerId = `youtube-player-${Math.random().toString(36).slice(2, 9)}`;\n\n  // Reactive state\n  const isLoading = $derived(\n    youtubeState.state.isApiLoading ||\n    (youtubeState.state.videoId && !youtubeState.state.isPlayerReady)\n  );\n  const hasError = $derived(!!youtubeState.state.error);\n  const isEmbeddable = $derived(youtubeState.state.isEmbeddable);\n  const videoId = $derived(ultrastarState.state.youtubeId);\n\n  // Load video when videoId changes\n  $effect(() => {\n    if (videoId) {\n      youtubeState.loadVideo(videoId, playerId);\n    }\n  });\n\n  onDestroy(() => {\n    youtubeState.dispose();\n  });\n\n  /**\n   * Open video in new tab (fallback for non-embeddable)\n   */\n  function openOnYouTube() {\n    const url = youtubeState.getVideoUrl();\n    if (url) {\n      window.open(url, '_blank', 'noopener,noreferrer');\n    }\n  }\n</script>\n\n<div class=\"youtube-container\">\n  <!-- Player container - NEVER hide this div, YouTube API needs it visible -->\n  <div\n    id={playerId}\n    class=\"youtube-player\"\n  ></div>\n\n  <!-- Loading overlay (shown on top of player while loading) -->\n  {#if isLoading && videoId}\n    <div class=\"youtube-loading\">\n      <div class=\"spinner\"></div>\n      <span>Loading video...</span>\n    </div>\n  {/if}\n\n  <!-- Error state -->\n  {#if hasError}\n    <div class=\"youtube-error\">\n      <span class=\"error-icon\">âš ï¸</span>\n      <span class=\"error-message\">{youtubeState.state.error}</span>\n\n      {#if !isEmbeddable}\n        <button class=\"fallback-btn\" onclick={openOnYouTube}>\n          Open on YouTube â†—\n        </button>\n      {/if}\n    </div>\n  {/if}\n\n  <!-- No video placeholder -->\n  {#if !videoId && !isLoading && !hasError}\n    <div class=\"youtube-placeholder\">\n      <span class=\"placeholder-icon\">ðŸŽ¬</span>\n      <span class=\"placeholder-text\">No video loaded</span>\n    </div>\n  {/if}\n</div>\n\n<style>\n  .youtube-container {\n    position: relative;\n    width: 100%;\n    aspect-ratio: 16 / 9;\n    background-color: var(--color-bg);\n    border-radius: var(--radius-sm);\n    overflow: hidden;\n  }\n\n  .youtube-player {\n    width: 100%;\n    height: 100%;\n  }\n\n  .youtube-player :global(iframe) {\n    width: 100%;\n    height: 100%;\n    border: none;\n  }\n\n  .youtube-loading,\n  .youtube-error,\n  .youtube-placeholder {\n    position: absolute;\n    inset: 0;\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    justify-content: center;\n    gap: var(--spacing-sm);\n    color: var(--color-text-muted);\n    font-size: var(--font-size-sm);\n  }\n\n  .spinner {\n    width: 24px;\n    height: 24px;\n    border: 2px solid rgba(255, 255, 255, 0.1);\n    border-top-color: var(--color-primary);\n    border-radius: 50%;\n    animation: spin 0.8s linear infinite;\n  }\n\n  @keyframes spin {\n    to {\n      transform: rotate(360deg);\n    }\n  }\n\n  .youtube-error {\n    background-color: rgba(220, 53, 69, 0.1);\n  }\n\n  .error-icon {\n    font-size: var(--font-size-xl);\n  }\n\n  .error-message {\n    color: var(--color-error, #dc3545);\n    text-align: center;\n  }\n\n  .fallback-btn {\n    margin-top: var(--spacing-sm);\n    padding: var(--spacing-sm) var(--spacing-md);\n    font-size: var(--font-size-sm);\n    font-weight: 500;\n    background-color: var(--color-primary);\n    color: white;\n    border: none;\n    border-radius: var(--radius-sm);\n    cursor: pointer;\n    transition: background-color 0.2s ease;\n  }\n\n  .fallback-btn:hover {\n    background-color: var(--color-primary-dark, #4a7bc8);\n  }\n\n  .placeholder-icon {\n    font-size: var(--font-size-xl);\n    opacity: 0.5;\n  }\n\n  .placeholder-text {\n    opacity: 0.7;\n  }\n</style>\n","<script lang=\"ts\">\n  /**\n   * Sync Controls Component\n   *\n   * Provides manual offset adjustment for YouTube-highway synchronization.\n   * Allows fine-tuning with +/- 0.01s and coarse with +/- 0.1s buttons.\n   */\n\n  import { ultrastarState } from '../../stores/ultrastarState.svelte.js';\n\n  // Reactive state\n  const manualOffset = $derived(ultrastarState.state.syncConfig.manualOffsetSec);\n  const isActive = $derived(ultrastarState.state.isActive);\n\n  /**\n   * Format offset for display\n   */\n  function formatOffset(offset: number): string {\n    const sign = offset >= 0 ? '+' : '';\n    return `${sign}${offset.toFixed(2)}s`;\n  }\n\n  /**\n   * Adjust offset by delta\n   */\n  function adjust(delta: number) {\n    ultrastarState.adjustOffset(delta);\n  }\n\n  /**\n   * Reset offset to zero\n   */\n  function reset() {\n    ultrastarState.resetOffset();\n  }\n\n  /**\n   * Handle keyboard shortcuts\n   */\n  function handleKeydown(event: KeyboardEvent) {\n    if (!isActive) return;\n\n    // Only handle if not focused on an input\n    if (event.target instanceof HTMLInputElement) return;\n\n    switch (event.key) {\n      case 'ArrowLeft':\n        event.preventDefault();\n        adjust(event.shiftKey ? -0.1 : -0.01);\n        break;\n      case 'ArrowRight':\n        event.preventDefault();\n        adjust(event.shiftKey ? 0.1 : 0.01);\n        break;\n    }\n  }\n</script>\n\n<svelte:window onkeydown={handleKeydown} />\n\n<div class=\"sync-controls\">\n  <div class=\"sync-header\">\n    <span class=\"sync-label\">Sync Offset</span>\n    <span class=\"sync-value\">{formatOffset(manualOffset)}</span>\n  </div>\n\n  <div class=\"sync-buttons\">\n    <button\n      class=\"sync-btn coarse\"\n      onclick={() => adjust(-0.1)}\n      disabled={!isActive}\n      title=\"Earlier by 0.1s\"\n    >\n      -0.1s\n    </button>\n    <button\n      class=\"sync-btn fine\"\n      onclick={() => adjust(-0.01)}\n      disabled={!isActive}\n      title=\"Earlier by 0.01s\"\n    >\n      -0.01s\n    </button>\n    <button\n      class=\"sync-btn reset\"\n      onclick={reset}\n      disabled={!isActive || manualOffset === 0}\n      title=\"Reset offset\"\n    >\n      0\n    </button>\n    <button\n      class=\"sync-btn fine\"\n      onclick={() => adjust(0.01)}\n      disabled={!isActive}\n      title=\"Later by 0.01s\"\n    >\n      +0.01s\n    </button>\n    <button\n      class=\"sync-btn coarse\"\n      onclick={() => adjust(0.1)}\n      disabled={!isActive}\n      title=\"Later by 0.1s\"\n    >\n      +0.1s\n    </button>\n  </div>\n\n  <div class=\"sync-hint\">\n    Use arrow keys to adjust (Shift for coarse)\n  </div>\n</div>\n\n<style>\n  .sync-controls {\n    display: flex;\n    flex-direction: column;\n    gap: var(--spacing-xs);\n    padding: var(--spacing-sm);\n    background-color: var(--color-surface);\n    border-radius: var(--radius-sm);\n  }\n\n  .sync-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n  }\n\n  .sync-label {\n    font-size: var(--font-size-sm);\n    font-weight: 500;\n    color: var(--color-text-muted);\n  }\n\n  .sync-value {\n    font-size: var(--font-size-md);\n    font-weight: 600;\n    font-family: monospace;\n    color: var(--color-text);\n  }\n\n  .sync-buttons {\n    display: flex;\n    gap: 2px;\n    justify-content: center;\n  }\n\n  .sync-btn {\n    flex: 1;\n    padding: var(--spacing-xs);\n    font-size: var(--font-size-xs);\n    font-weight: 500;\n    background-color: var(--color-bg);\n    color: var(--color-text);\n    border: 1px solid rgba(255, 255, 255, 0.1);\n    border-radius: var(--radius-sm);\n    cursor: pointer;\n    transition: all 0.15s ease;\n  }\n\n  .sync-btn:hover:not(:disabled) {\n    background-color: var(--color-primary);\n    color: white;\n    border-color: var(--color-primary);\n  }\n\n  .sync-btn:disabled {\n    opacity: 0.4;\n    cursor: not-allowed;\n  }\n\n  .sync-btn.reset {\n    flex: 0.5;\n    font-weight: 600;\n  }\n\n  .sync-btn.reset:hover:not(:disabled) {\n    background-color: var(--color-secondary, #00d9ff);\n  }\n\n  .sync-hint {\n    font-size: var(--font-size-xs);\n    color: var(--color-text-muted);\n    text-align: center;\n    opacity: 0.7;\n  }\n</style>\n","<script lang=\"ts\">\n  /**\n   * Ultrastar Controls Component\n   *\n   * UI for uploading Ultrastar .txt files, displaying song info,\n   * and controlling playback with YouTube video sync.\n   */\n\n  import { ultrastarState } from '../../stores/ultrastarState.svelte.js';\n  import { youtubeState } from '../../stores/youtubeState.svelte.js';\n  import { highwayState } from '../../stores/highwayState.svelte.js';\n  import { appState } from '../../stores/appState.svelte.js';\n  import { createTransportSync, type TransportSyncInstance } from '../../services/transportSync.js';\n  import { onDestroy } from 'svelte';\n  import YouTubePlayer from '../youtube/YouTubePlayer.svelte';\n  import SyncControls from './SyncControls.svelte';\n\n  // Transport sync instance\n  let transportSync: TransportSyncInstance | null = null;\n  let syncLoopId: number | null = null;\n\n  // File input ref\n  let fileInput: HTMLInputElement;\n\n  // Reactive state\n  const isActive = $derived(ultrastarState.state.isActive);\n  const isLoading = $derived(ultrastarState.state.isLoading);\n  const isPlaying = $derived(ultrastarState.state.isPlaying);\n  const hasVideo = $derived(ultrastarState.hasVideo);\n  const songTitle = $derived(ultrastarState.title);\n  const songArtist = $derived(ultrastarState.artist);\n  const error = $derived(ultrastarState.state.error);\n\n  /**\n   * Handle file upload\n   */\n  async function handleFileSelect(event: Event) {\n    const input = event.target as HTMLInputElement;\n    const file = input.files?.[0];\n\n    if (!file) return;\n\n    const success = await ultrastarState.loadFile(file);\n\n    if (success) {\n      // Initialize transport sync with song's sync config\n      transportSync = createTransportSync({\n        syncConfig: ultrastarState.state.syncConfig,\n      });\n\n      // Apply detected pitch range to app\n      const range = ultrastarState.state.detectedRange;\n      appState.setYAxisRange({ minMidi: range.minMidi, maxMidi: range.maxMidi });\n\n      // Set target notes on highway\n      highwayState.setTargetNotes(ultrastarState.state.targetNotes);\n\n      // Debug logging\n      console.log('[Ultrastar] File loaded:', {\n        title: ultrastarState.title,\n        artist: ultrastarState.artist,\n        youtubeId: ultrastarState.state.youtubeId,\n        bpm: ultrastarState.state.song?.metadata.bpm,\n        gap: ultrastarState.state.song?.metadata.gap,\n        videoGap: ultrastarState.state.song?.metadata.videoGap,\n        noteCount: ultrastarState.state.targetNotes.length,\n        firstNotes: ultrastarState.state.targetNotes.slice(0, 3),\n        lastNotes: ultrastarState.state.targetNotes.slice(-3),\n        totalDurationMs: ultrastarState.state.totalDurationMs,\n        pitchRange: range,\n        syncConfig: ultrastarState.state.syncConfig,\n      });\n    }\n\n    // Reset input so same file can be selected again\n    input.value = '';\n  }\n\n  /**\n   * Start playback\n   */\n  async function handleStart() {\n    if (!isActive) return;\n\n    // Switch to highway mode\n    appState.setVisualizationMode('highway');\n\n    // Update transport sync config if offset changed\n    if (transportSync) {\n      transportSync.updateConfig(ultrastarState.state.syncConfig);\n    }\n\n    // Set target notes (in case they changed)\n    highwayState.setTargetNotes(ultrastarState.state.targetNotes);\n    ultrastarState.setPlaying(true);\n\n    // If we have video, YouTube is the master clock\n    if (hasVideo && youtubeState.state.isPlayerReady) {\n      const startOffset = transportSync?.getYouTubeOffset() ?? 0;\n\n      // Log for debugging\n      console.log('[Ultrastar] Starting playback:', {\n        youtubeOffset: startOffset,\n        noteCount: ultrastarState.state.targetNotes.length,\n        firstNote: ultrastarState.state.targetNotes[0],\n        syncConfig: ultrastarState.state.syncConfig,\n      });\n\n      // Reset highway time to 0\n      highwayState.setCurrentTime(0);\n\n      // Seek YouTube to the offset where first note plays\n      youtubeState.seekTo(startOffset);\n      youtubeState.play();\n\n      // Start sync loop - YouTube drives highway time\n      startSyncLoop();\n    } else {\n      // No video - use highway's internal clock\n      highwayState.start();\n    }\n  }\n\n  /**\n   * Stop playback\n   */\n  function handleStop() {\n    // Stop highway\n    highwayState.stop();\n    ultrastarState.setPlaying(false);\n\n    // Stop YouTube\n    youtubeState.pause();\n\n    // Stop sync loop\n    stopSyncLoop();\n  }\n\n  /**\n   * Unload current song\n   */\n  function handleUnload() {\n    handleStop();\n    ultrastarState.unload();\n    youtubeState.dispose();\n    highwayState.reset();\n    transportSync = null;\n  }\n\n  /**\n   * Start the sync loop - YouTube is the master clock for Ultrastar songs\n   * We sync the highway to YouTube, not the other way around\n   */\n  function startSyncLoop() {\n    if (syncLoopId !== null) {\n      clearInterval(syncLoopId);\n    }\n\n    // Use YouTube as the master clock - update highway time from YouTube position\n    youtubeState.startSyncLoop((ytTime) => {\n      if (!transportSync) return;\n\n      // Convert YouTube time to transport time and update highway\n      const transportTimeMs = transportSync.youTubeToTransport(ytTime);\n\n      // Only update if significantly different to avoid jitter\n      const currentTransport = highwayState.state.currentTimeMs;\n      const diffMs = Math.abs(transportTimeMs - currentTransport);\n\n      // Update highway time to match YouTube (with small threshold to reduce jitter)\n      if (diffMs > 50) {\n        highwayState.setCurrentTime(Math.max(0, transportTimeMs));\n      }\n    }, 100); // Check every 100ms for smoother sync\n  }\n\n  /**\n   * Stop the sync loop\n   */\n  function stopSyncLoop() {\n    youtubeState.stopSyncLoop();\n    if (syncLoopId !== null) {\n      clearInterval(syncLoopId);\n      syncLoopId = null;\n    }\n  }\n\n  /**\n   * Trigger file input click\n   */\n  function openFilePicker() {\n    fileInput?.click();\n  }\n\n  onDestroy(() => {\n    stopSyncLoop();\n    youtubeState.dispose();\n  });\n</script>\n\n<div class=\"ultrastar-panel\">\n  <h3 class=\"panel-title\">Ultrastar Song</h3>\n\n  <!-- Hidden file input -->\n  <input\n    type=\"file\"\n    accept=\".txt\"\n    bind:this={fileInput}\n    onchange={handleFileSelect}\n    style=\"display: none;\"\n  />\n\n  {#if !isActive}\n    <!-- Upload button -->\n    <button class=\"upload-btn\" onclick={openFilePicker} disabled={isLoading}>\n      {#if isLoading}\n        <span class=\"spinner\"></span>\n        Loading...\n      {:else}\n        Upload Ultrastar .txt\n      {/if}\n    </button>\n\n    {#if error}\n      <div class=\"error-message\">{error}</div>\n    {/if}\n  {:else}\n    <!-- Song Info -->\n    <div class=\"song-info\">\n      <div class=\"song-title\">{songTitle}</div>\n      <div class=\"song-artist\">{songArtist}</div>\n    </div>\n\n    <!-- YouTube Player (if video available) -->\n    {#if hasVideo}\n      <div class=\"video-section\">\n        <YouTubePlayer />\n        <SyncControls />\n      </div>\n    {/if}\n\n    <!-- Playback Controls -->\n    <div class=\"playback-controls\">\n      {#if !isPlaying}\n        <button class=\"play-btn\" onclick={handleStart}>\n          â–¶ Play\n        </button>\n      {:else}\n        <button class=\"stop-btn\" onclick={handleStop}>\n          â¹ Stop\n        </button>\n      {/if}\n\n      <button class=\"unload-btn\" onclick={handleUnload} disabled={isPlaying}>\n        Unload\n      </button>\n    </div>\n\n    <!-- Progress info -->\n    {#if isPlaying}\n      <div class=\"progress-info\">\n        <span class=\"time-display\">\n          {Math.floor(highwayState.state.currentTimeMs / 1000)}s\n          / {Math.floor(ultrastarState.state.totalDurationMs / 1000)}s\n        </span>\n      </div>\n    {/if}\n  {/if}\n</div>\n\n<style>\n  .ultrastar-panel {\n    display: flex;\n    flex-direction: column;\n    gap: var(--spacing-md);\n  }\n\n  .panel-title {\n    font-size: var(--font-size-sm);\n    font-weight: 600;\n    color: var(--color-text-muted);\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n    margin: 0;\n  }\n\n  .upload-btn {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: var(--spacing-sm);\n    padding: var(--spacing-md);\n    font-size: var(--font-size-md);\n    font-weight: 600;\n    background-color: var(--color-primary);\n    color: white;\n    border: none;\n    border-radius: var(--radius-md);\n    cursor: pointer;\n    transition: background-color 0.2s ease;\n  }\n\n  .upload-btn:hover:not(:disabled) {\n    background-color: var(--color-primary-dark, #4a7bc8);\n  }\n\n  .upload-btn:disabled {\n    opacity: 0.7;\n    cursor: wait;\n  }\n\n  .spinner {\n    width: 16px;\n    height: 16px;\n    border: 2px solid rgba(255, 255, 255, 0.3);\n    border-top-color: white;\n    border-radius: 50%;\n    animation: spin 0.8s linear infinite;\n  }\n\n  @keyframes spin {\n    to {\n      transform: rotate(360deg);\n    }\n  }\n\n  .error-message {\n    padding: var(--spacing-sm);\n    font-size: var(--font-size-sm);\n    color: var(--color-error, #dc3545);\n    background-color: rgba(220, 53, 69, 0.1);\n    border-radius: var(--radius-sm);\n  }\n\n  .song-info {\n    padding: var(--spacing-sm);\n    background-color: var(--color-surface);\n    border-radius: var(--radius-sm);\n  }\n\n  .song-title {\n    font-size: var(--font-size-md);\n    font-weight: 600;\n    color: var(--color-text);\n  }\n\n  .song-artist {\n    font-size: var(--font-size-sm);\n    color: var(--color-text-muted);\n  }\n\n  .video-section {\n    display: flex;\n    flex-direction: column;\n    gap: var(--spacing-sm);\n  }\n\n  .playback-controls {\n    display: flex;\n    gap: var(--spacing-sm);\n  }\n\n  .play-btn {\n    flex: 1;\n    padding: var(--spacing-md);\n    font-size: var(--font-size-md);\n    font-weight: 600;\n    background-color: var(--color-success, #28a745);\n    color: white;\n    border: none;\n    border-radius: var(--radius-md);\n    cursor: pointer;\n    transition: background-color 0.2s ease;\n  }\n\n  .play-btn:hover {\n    background-color: #218838;\n  }\n\n  .stop-btn {\n    flex: 1;\n    padding: var(--spacing-md);\n    font-size: var(--font-size-md);\n    font-weight: 600;\n    background-color: var(--color-error, #dc3545);\n    color: white;\n    border: none;\n    border-radius: var(--radius-md);\n    cursor: pointer;\n    transition: background-color 0.2s ease;\n  }\n\n  .stop-btn:hover {\n    background-color: #c82333;\n  }\n\n  .unload-btn {\n    padding: var(--spacing-md);\n    font-size: var(--font-size-sm);\n    font-weight: 500;\n    background-color: var(--color-bg);\n    color: var(--color-text-muted);\n    border: 1px solid rgba(255, 255, 255, 0.1);\n    border-radius: var(--radius-md);\n    cursor: pointer;\n    transition: all 0.2s ease;\n  }\n\n  .unload-btn:hover:not(:disabled) {\n    background-color: var(--color-surface);\n    color: var(--color-text);\n  }\n\n  .unload-btn:disabled {\n    opacity: 0.4;\n    cursor: not-allowed;\n  }\n\n  .progress-info {\n    text-align: center;\n    padding: var(--spacing-sm);\n    background-color: var(--color-surface);\n    border-radius: var(--radius-sm);\n  }\n\n  .time-display {\n    font-size: var(--font-size-md);\n    font-weight: 500;\n    font-family: monospace;\n    color: var(--color-text);\n  }\n</style>\n","<script lang=\"ts\">\n  /**\n   * PitchReadout Component\n   *\n   * Displays the current detected pitch information.\n   */\n\n  import { pitchState } from '../../stores/pitchState.svelte.js';\n\n  const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];\n\n  const currentNote = $derived(() => {\n    const pitch = pitchState.state.currentPitch;\n    if (!pitch) return null;\n\n    const noteName = NOTE_NAMES[pitch.pitchClass];\n    const octave = Math.floor(pitch.midi / 12) - 1;\n    const cents = Math.round((pitch.midi - Math.round(pitch.midi)) * 100);\n\n    return {\n      name: noteName,\n      octave,\n      frequency: pitch.frequency.toFixed(1),\n      cents,\n      clarity: Math.round(pitch.clarity * 100),\n    };\n  });\n</script>\n\n<div class=\"pitch-readout\">\n  {#if currentNote()}\n    {@const note = currentNote()!}\n    <div class=\"note-display\">\n      <span class=\"note-name\">{note.name}</span>\n      <span class=\"octave\">{note.octave}</span>\n    </div>\n    <div class=\"details\">\n      <span class=\"frequency\">{note.frequency} Hz</span>\n      <span class=\"cents\" class:sharp={note.cents > 0} class:flat={note.cents < 0}>\n        {note.cents > 0 ? '+' : ''}{note.cents}Â¢\n      </span>\n      <span class=\"clarity\">{note.clarity}%</span>\n    </div>\n  {:else}\n    <div class=\"no-pitch\">\n      <span class=\"placeholder\">---</span>\n      <span class=\"hint\">Sing or hum into the microphone</span>\n    </div>\n  {/if}\n</div>\n\n<style>\n  .pitch-readout {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    justify-content: center;\n    padding: var(--spacing-lg);\n    background-color: var(--color-surface);\n    border-radius: var(--radius-md);\n    min-width: 200px;\n    min-height: 100px;\n  }\n\n  .note-display {\n    display: flex;\n    align-items: baseline;\n    gap: var(--spacing-xs);\n  }\n\n  .note-name {\n    font-size: var(--font-size-2xl);\n    font-weight: 700;\n    color: var(--color-secondary);\n  }\n\n  .octave {\n    font-size: var(--font-size-lg);\n    color: var(--color-text-muted);\n  }\n\n  .details {\n    display: flex;\n    gap: var(--spacing-md);\n    margin-top: var(--spacing-sm);\n    font-size: var(--font-size-sm);\n    color: var(--color-text-muted);\n  }\n\n  .cents {\n    font-weight: 500;\n  }\n\n  .cents.sharp {\n    color: var(--color-warning);\n  }\n\n  .cents.flat {\n    color: var(--color-primary);\n  }\n\n  .no-pitch {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    gap: var(--spacing-sm);\n  }\n\n  .placeholder {\n    font-size: var(--font-size-2xl);\n    color: var(--color-text-muted);\n  }\n\n  .hint {\n    font-size: var(--font-size-sm);\n    color: var(--color-text-muted);\n    opacity: 0.7;\n  }\n</style>\n","/**\n * Results State Store - Svelte 5 Runes\n *\n * Manages the display of performance results after song/exercise completion.\n * Calculates statistics and controls the results modal visibility.\n */\n\nimport type { NotePerformance } from '@mlt/student-notation-engine';\nimport type { TargetNote } from './highwayState.svelte.js';\n\n/** Result for a single phrase/section */\nexport interface PhraseResult {\n  phraseIndex: number;\n  notesHit: number;\n  totalNotes: number;\n  accuracyPercent: number;\n  lyricPreview: string;\n}\n\n/** Summary of overall performance */\nexport interface ResultsSummary {\n  totalNotes: number;\n  notesHit: number;\n  notesMissed: number;\n  accuracyPercent: number;\n  goldenNotesHit: number;\n  goldenNotesTotal: number;\n  phraseResults: PhraseResult[];\n  averagePitchDeviationCents: number;\n}\n\n/** State for the results modal */\nexport interface ResultsState {\n  isVisible: boolean;\n  summary: ResultsSummary | null;\n  songTitle: string;\n  artistName: string;\n  source: 'demo' | 'ultrastar' | null;\n}\n\nconst DEFAULT_STATE: ResultsState = {\n  isVisible: false,\n  summary: null,\n  songTitle: '',\n  artistName: '',\n  source: null,\n};\n\nconst EMPTY_SUMMARY: ResultsSummary = {\n  totalNotes: 0,\n  notesHit: 0,\n  notesMissed: 0,\n  accuracyPercent: 0,\n  goldenNotesHit: 0,\n  goldenNotesTotal: 0,\n  phraseResults: [],\n  averagePitchDeviationCents: 0,\n};\n\nfunction createResultsState() {\n  let state = $state<ResultsState>({ ...DEFAULT_STATE });\n\n  return {\n    get state() {\n      return state;\n    },\n\n    /**\n     * Show results modal with calculated summary\n     */\n    show(\n      summary: ResultsSummary,\n      options: {\n        title?: string;\n        artist?: string;\n        source?: 'demo' | 'ultrastar';\n      } = {}\n    ) {\n      state.summary = summary;\n      state.songTitle = options.title || '';\n      state.artistName = options.artist || '';\n      state.source = options.source || null;\n      state.isVisible = true;\n    },\n\n    /**\n     * Hide results modal\n     */\n    hide() {\n      state.isVisible = false;\n    },\n\n    /**\n     * Clear results and hide modal\n     */\n    clear() {\n      state = { ...DEFAULT_STATE };\n    },\n\n    /**\n     * Calculate summary from performance data and target notes\n     */\n    calculateSummary(\n      performances: Map<string, NotePerformance>,\n      targetNotes: TargetNote[]\n    ): ResultsSummary {\n      if (targetNotes.length === 0) {\n        return { ...EMPTY_SUMMARY };\n      }\n\n      let notesHit = 0;\n      let goldenNotesHit = 0;\n      let goldenNotesTotal = 0;\n      let totalPitchDeviation = 0;\n      let pitchDeviationCount = 0;\n\n      // Group notes by phrase for phrase-level results\n      const phraseMap = new Map<number, { hit: number; total: number; lyrics: string[] }>();\n\n      targetNotes.forEach((note, index) => {\n        const noteId = `target-${index}`;\n        const perf = performances.get(noteId);\n        const isGolden = (note as any).isGolden === true;\n        const phraseIndex = (note as any).phraseIndex ?? 0;\n\n        // Track golden notes\n        if (isGolden) {\n          goldenNotesTotal++;\n        }\n\n        // Initialize phrase tracking\n        if (!phraseMap.has(phraseIndex)) {\n          phraseMap.set(phraseIndex, { hit: 0, total: 0, lyrics: [] });\n        }\n        const phrase = phraseMap.get(phraseIndex)!;\n        phrase.total++;\n\n        // Track lyrics for preview\n        if (note.lyric) {\n          phrase.lyrics.push(note.lyric);\n        }\n\n        // Check if hit\n        if (perf?.hitStatus === 'hit') {\n          notesHit++;\n          phrase.hit++;\n\n          if (isGolden) {\n            goldenNotesHit++;\n          }\n\n          // Track pitch deviation if available\n          if (typeof perf.pitchAccuracyCents === 'number') {\n            totalPitchDeviation += Math.abs(perf.pitchAccuracyCents);\n            pitchDeviationCount++;\n          }\n        }\n      });\n\n      const totalNotes = targetNotes.length;\n      const notesMissed = totalNotes - notesHit;\n      const accuracyPercent = totalNotes > 0 ? (notesHit / totalNotes) * 100 : 0;\n      const averagePitchDeviationCents =\n        pitchDeviationCount > 0 ? totalPitchDeviation / pitchDeviationCount : 0;\n\n      // Build phrase results\n      const phraseResults: PhraseResult[] = [];\n      phraseMap.forEach((data, phraseIndex) => {\n        phraseResults.push({\n          phraseIndex,\n          notesHit: data.hit,\n          totalNotes: data.total,\n          accuracyPercent: data.total > 0 ? (data.hit / data.total) * 100 : 0,\n          lyricPreview: data.lyrics.join('').trim().slice(0, 30) || `Phrase ${phraseIndex + 1}`,\n        });\n      });\n\n      // Sort by phrase index\n      phraseResults.sort((a, b) => a.phraseIndex - b.phraseIndex);\n\n      return {\n        totalNotes,\n        notesHit,\n        notesMissed,\n        accuracyPercent,\n        goldenNotesHit,\n        goldenNotesTotal,\n        phraseResults,\n        averagePitchDeviationCents,\n      };\n    },\n\n    /**\n     * Get letter grade based on accuracy\n     */\n    getLetterGrade(accuracy: number): string {\n      if (accuracy >= 95) return 'S';\n      if (accuracy >= 90) return 'A';\n      if (accuracy >= 80) return 'B';\n      if (accuracy >= 70) return 'C';\n      if (accuracy >= 60) return 'D';\n      return 'F';\n    },\n\n    /**\n     * Get color for accuracy display\n     */\n    getAccuracyColor(accuracy: number): string {\n      if (accuracy >= 90) return 'var(--color-success, #28a745)';\n      if (accuracy >= 70) return 'var(--color-warning, #ffc107)';\n      return 'var(--color-error, #dc3545)';\n    },\n  };\n}\n\nexport const resultsState = createResultsState();\n","<script lang=\"ts\">\n  /**\n   * Results Modal Component\n   *\n   * Displays performance results after song/exercise completion.\n   * Shows accuracy, notes hit, letter grade, and optional phrase breakdown.\n   */\n\n  import { resultsState, type ResultsSummary } from '../../stores/resultsState.svelte.js';\n\n  interface Props {\n    onRetry?: () => void;\n    onClose?: () => void;\n  }\n\n  let { onRetry, onClose }: Props = $props();\n\n  // Reactive state\n  const isVisible = $derived(resultsState.state.isVisible);\n  const summary = $derived(resultsState.state.summary);\n  const songTitle = $derived(resultsState.state.songTitle);\n  const artistName = $derived(resultsState.state.artistName);\n\n  // Derived values\n  const letterGrade = $derived(\n    summary ? resultsState.getLetterGrade(summary.accuracyPercent) : 'F'\n  );\n  const accuracyColor = $derived(\n    summary ? resultsState.getAccuracyColor(summary.accuracyPercent) : ''\n  );\n\n  /**\n   * Handle close button\n   */\n  function handleClose() {\n    resultsState.hide();\n    onClose?.();\n  }\n\n  /**\n   * Handle retry button\n   */\n  function handleRetry() {\n    resultsState.hide();\n    onRetry?.();\n  }\n\n  /**\n   * Handle backdrop click\n   */\n  function handleBackdropClick(event: MouseEvent) {\n    if (event.target === event.currentTarget) {\n      handleClose();\n    }\n  }\n\n  /**\n   * Handle escape key\n   */\n  function handleKeydown(event: KeyboardEvent) {\n    if (event.key === 'Escape' && isVisible) {\n      handleClose();\n    }\n  }\n</script>\n\n<svelte:window onkeydown={handleKeydown} />\n\n{#if isVisible && summary}\n  <!-- svelte-ignore a11y_no_noninteractive_element_interactions -->\n  <!-- svelte-ignore a11y_click_events_have_key_events -->\n  <div\n    class=\"modal-backdrop\"\n    onclick={handleBackdropClick}\n    onkeydown={handleKeydown}\n    role=\"dialog\"\n    aria-modal=\"true\"\n    aria-labelledby=\"results-title\"\n    tabindex=\"-1\"\n  >\n    <div class=\"modal-content\">\n      <!-- Header -->\n      <div class=\"modal-header\">\n        <h2 id=\"results-title\" class=\"modal-title\">Results</h2>\n        {#if songTitle}\n          <div class=\"song-info\">\n            <span class=\"song-title\">{songTitle}</span>\n            {#if artistName}\n              <span class=\"song-artist\">by {artistName}</span>\n            {/if}\n          </div>\n        {/if}\n      </div>\n\n      <!-- Main Stats -->\n      <div class=\"stats-section\">\n        <!-- Letter Grade -->\n        <div class=\"grade-display\" style:--grade-color={accuracyColor}>\n          <span class=\"grade-letter\">{letterGrade}</span>\n        </div>\n\n        <!-- Accuracy -->\n        <div class=\"accuracy-display\" style:color={accuracyColor}>\n          <span class=\"accuracy-value\">{summary.accuracyPercent.toFixed(1)}%</span>\n          <span class=\"accuracy-label\">Accuracy</span>\n        </div>\n\n        <!-- Notes Hit -->\n        <div class=\"stats-row\">\n          <div class=\"stat-item\">\n            <span class=\"stat-value hit\">{summary.notesHit}</span>\n            <span class=\"stat-label\">Hit</span>\n          </div>\n          <div class=\"stat-divider\">/</div>\n          <div class=\"stat-item\">\n            <span class=\"stat-value total\">{summary.totalNotes}</span>\n            <span class=\"stat-label\">Total</span>\n          </div>\n          {#if summary.notesMissed > 0}\n            <div class=\"stat-item missed\">\n              <span class=\"stat-value\">{summary.notesMissed}</span>\n              <span class=\"stat-label\">Missed</span>\n            </div>\n          {/if}\n        </div>\n\n        <!-- Golden Notes (if any) -->\n        {#if summary.goldenNotesTotal > 0}\n          <div class=\"golden-stats\">\n            <span class=\"golden-icon\">â­</span>\n            <span class=\"golden-text\">\n              Golden Notes: {summary.goldenNotesHit}/{summary.goldenNotesTotal}\n            </span>\n          </div>\n        {/if}\n\n        <!-- Average Pitch Deviation -->\n        {#if summary.averagePitchDeviationCents > 0}\n          <div class=\"pitch-stats\">\n            <span class=\"pitch-label\">Avg. Pitch Deviation:</span>\n            <span class=\"pitch-value\">\n              {summary.averagePitchDeviationCents.toFixed(1)} cents\n            </span>\n          </div>\n        {/if}\n      </div>\n\n      <!-- Phrase Breakdown (collapsible) -->\n      {#if summary.phraseResults.length > 1}\n        <details class=\"phrase-details\">\n          <summary class=\"phrase-summary\">Phrase Breakdown</summary>\n          <div class=\"phrase-list\">\n            {#each summary.phraseResults as phrase}\n              <div\n                class=\"phrase-item\"\n                class:perfect={phrase.accuracyPercent === 100}\n                class:good={phrase.accuracyPercent >= 70 && phrase.accuracyPercent < 100}\n                class:poor={phrase.accuracyPercent < 70}\n              >\n                <span class=\"phrase-lyric\">{phrase.lyricPreview}</span>\n                <span class=\"phrase-accuracy\">\n                  {phrase.notesHit}/{phrase.totalNotes}\n                  ({phrase.accuracyPercent.toFixed(0)}%)\n                </span>\n              </div>\n            {/each}\n          </div>\n        </details>\n      {/if}\n\n      <!-- Actions -->\n      <div class=\"modal-actions\">\n        {#if onRetry}\n          <button class=\"action-btn retry-btn\" onclick={handleRetry}>\n            Try Again\n          </button>\n        {/if}\n        <button class=\"action-btn close-btn\" onclick={handleClose}>\n          Close\n        </button>\n      </div>\n    </div>\n  </div>\n{/if}\n\n<style>\n  .modal-backdrop {\n    position: fixed;\n    inset: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    background-color: rgba(0, 0, 0, 0.75);\n    z-index: 1000;\n    animation: fadeIn 0.2s ease;\n  }\n\n  @keyframes fadeIn {\n    from {\n      opacity: 0;\n    }\n    to {\n      opacity: 1;\n    }\n  }\n\n  .modal-content {\n    width: 90%;\n    max-width: 400px;\n    max-height: 80vh;\n    overflow-y: auto;\n    background-color: var(--color-surface);\n    border-radius: var(--radius-lg, 12px);\n    padding: var(--spacing-lg);\n    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);\n    animation: slideUp 0.3s ease;\n  }\n\n  @keyframes slideUp {\n    from {\n      transform: translateY(20px);\n      opacity: 0;\n    }\n    to {\n      transform: translateY(0);\n      opacity: 1;\n    }\n  }\n\n  .modal-header {\n    text-align: center;\n    margin-bottom: var(--spacing-lg);\n  }\n\n  .modal-title {\n    font-size: var(--font-size-xl);\n    font-weight: 700;\n    color: var(--color-text);\n    margin: 0 0 var(--spacing-sm);\n  }\n\n  .song-info {\n    display: flex;\n    flex-direction: column;\n    gap: 2px;\n  }\n\n  .song-title {\n    font-size: var(--font-size-md);\n    font-weight: 600;\n    color: var(--color-text);\n  }\n\n  .song-artist {\n    font-size: var(--font-size-sm);\n    color: var(--color-text-muted);\n  }\n\n  .stats-section {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    gap: var(--spacing-md);\n  }\n\n  .grade-display {\n    width: 80px;\n    height: 80px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    border: 4px solid var(--grade-color);\n    border-radius: 50%;\n  }\n\n  .grade-letter {\n    font-size: 48px;\n    font-weight: 800;\n    color: var(--grade-color);\n  }\n\n  .accuracy-display {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    gap: 2px;\n  }\n\n  .accuracy-value {\n    font-size: var(--font-size-2xl, 32px);\n    font-weight: 700;\n  }\n\n  .accuracy-label {\n    font-size: var(--font-size-sm);\n    text-transform: uppercase;\n    letter-spacing: 0.1em;\n    opacity: 0.7;\n  }\n\n  .stats-row {\n    display: flex;\n    align-items: center;\n    gap: var(--spacing-md);\n  }\n\n  .stat-item {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n  }\n\n  .stat-value {\n    font-size: var(--font-size-lg);\n    font-weight: 600;\n  }\n\n  .stat-value.hit {\n    color: var(--color-success, #28a745);\n  }\n\n  .stat-value.total {\n    color: var(--color-text);\n  }\n\n  .stat-item.missed .stat-value {\n    color: var(--color-error, #dc3545);\n  }\n\n  .stat-label {\n    font-size: var(--font-size-xs);\n    color: var(--color-text-muted);\n    text-transform: uppercase;\n  }\n\n  .stat-divider {\n    font-size: var(--font-size-lg);\n    color: var(--color-text-muted);\n  }\n\n  .golden-stats {\n    display: flex;\n    align-items: center;\n    gap: var(--spacing-xs);\n    padding: var(--spacing-xs) var(--spacing-sm);\n    background-color: rgba(255, 193, 7, 0.1);\n    border-radius: var(--radius-sm);\n  }\n\n  .golden-icon {\n    font-size: var(--font-size-md);\n  }\n\n  .golden-text {\n    font-size: var(--font-size-sm);\n    color: #ffc107;\n    font-weight: 500;\n  }\n\n  .pitch-stats {\n    display: flex;\n    gap: var(--spacing-xs);\n    font-size: var(--font-size-sm);\n    color: var(--color-text-muted);\n  }\n\n  .pitch-value {\n    font-weight: 500;\n    color: var(--color-text);\n  }\n\n  .phrase-details {\n    width: 100%;\n    margin-top: var(--spacing-md);\n    background-color: var(--color-bg);\n    border-radius: var(--radius-sm);\n  }\n\n  .phrase-summary {\n    padding: var(--spacing-sm);\n    font-size: var(--font-size-sm);\n    font-weight: 500;\n    cursor: pointer;\n    user-select: none;\n  }\n\n  .phrase-summary:hover {\n    color: var(--color-primary);\n  }\n\n  .phrase-list {\n    display: flex;\n    flex-direction: column;\n    gap: 2px;\n    padding: 0 var(--spacing-sm) var(--spacing-sm);\n  }\n\n  .phrase-item {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    padding: var(--spacing-xs) var(--spacing-sm);\n    background-color: var(--color-surface);\n    border-radius: var(--radius-sm);\n    font-size: var(--font-size-sm);\n    border-left: 3px solid transparent;\n  }\n\n  .phrase-item.perfect {\n    border-left-color: var(--color-success, #28a745);\n  }\n\n  .phrase-item.good {\n    border-left-color: var(--color-warning, #ffc107);\n  }\n\n  .phrase-item.poor {\n    border-left-color: var(--color-error, #dc3545);\n  }\n\n  .phrase-lyric {\n    color: var(--color-text);\n    flex: 1;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n  }\n\n  .phrase-accuracy {\n    color: var(--color-text-muted);\n    flex-shrink: 0;\n    margin-left: var(--spacing-sm);\n  }\n\n  .modal-actions {\n    display: flex;\n    gap: var(--spacing-sm);\n    margin-top: var(--spacing-lg);\n  }\n\n  .action-btn {\n    flex: 1;\n    padding: var(--spacing-md);\n    font-size: var(--font-size-md);\n    font-weight: 600;\n    border: none;\n    border-radius: var(--radius-md);\n    cursor: pointer;\n    transition: all 0.2s ease;\n  }\n\n  .retry-btn {\n    background-color: var(--color-primary);\n    color: white;\n  }\n\n  .retry-btn:hover {\n    background-color: var(--color-primary-dark, #4a7bc8);\n  }\n\n  .close-btn {\n    background-color: var(--color-bg);\n    color: var(--color-text);\n    border: 1px solid rgba(255, 255, 255, 0.1);\n  }\n\n  .close-btn:hover {\n    background-color: var(--color-surface);\n  }\n</style>\n","/**\n * Handoff State Store - Svelte 5 Runes\n *\n * Manages imported snapshot data from Student Notation.\n * This store handles the handoff lifecycle:\n * 1. Check for handoff on app load\n * 2. Import snapshot data\n * 3. Provide access to imported voices and grid structure\n * 4. Support \"Bring Back to Student Notation\" flow\n */\n\nimport {\n  consumeHandoffSlot,\n  checkForHandoff,\n  clearHandoffParams,\n  writeHandoffSlot,\n  navigateToStudentNotation,\n  type SingingTrainerSnapshot,\n  type SnapshotVoice,\n  type TimeGridStructure,\n  SNAPSHOT_SCHEMA_VERSION,\n} from '@mlt/handoff';\n\nexport interface HandoffState {\n  /** Whether a snapshot has been imported */\n  hasImportedSnapshot: boolean;\n  /** The imported snapshot (if any) */\n  snapshot: SingingTrainerSnapshot | null;\n  /** Loading state during handoff processing */\n  isLoading: boolean;\n  /** Error message if handoff failed */\n  error: string | null;\n  /** Transposition offset in semitones (positive = up) */\n  transpositionSemitones: number;\n}\n\nconst DEFAULT_STATE: HandoffState = {\n  hasImportedSnapshot: false,\n  snapshot: null,\n  isLoading: false,\n  error: null,\n  transpositionSemitones: 0,\n};\n\nfunction createHandoffState() {\n  let state = $state<HandoffState>({ ...DEFAULT_STATE });\n\n  return {\n    get state() {\n      return state;\n    },\n\n    /**\n     * Check for and consume any pending handoff on app initialization.\n     * Should be called once when the app loads.\n     */\n    async checkAndConsumeHandoff(): Promise<boolean> {\n      // First check URL params to see if we came from a handoff\n      const handoffInfo = checkForHandoff();\n\n      if (!handoffInfo) {\n        return false;\n      }\n\n      state.isLoading = true;\n      state.error = null;\n\n      try {\n        // Try to read and consume the snapshot from the handoff slot\n        const snapshot = await consumeHandoffSlot();\n\n        if (!snapshot) {\n          state.error = 'Handoff data expired or not found. Please try exporting again.';\n          state.isLoading = false;\n          clearHandoffParams();\n          return false;\n        }\n\n        // Validate schema version\n        if (snapshot.schemaVersion !== SNAPSHOT_SCHEMA_VERSION) {\n          state.error = `Incompatible snapshot version: ${snapshot.schemaVersion}. Expected: ${SNAPSHOT_SCHEMA_VERSION}`;\n          state.isLoading = false;\n          clearHandoffParams();\n          return false;\n        }\n\n        // Successfully imported\n        state.snapshot = snapshot;\n        state.hasImportedSnapshot = true;\n        state.isLoading = false;\n\n        // Clear URL params to keep the URL clean\n        clearHandoffParams();\n\n        console.log('[HandoffState] Successfully imported snapshot', {\n          voices: snapshot.voices.length,\n          microbeatCount: snapshot.timeGrid.microbeatCount,\n          tempo: snapshot.tempo,\n        });\n\n        return true;\n      } catch (error) {\n        console.error('[HandoffState] Failed to process handoff', error);\n        state.error = 'Failed to import data from Student Notation.';\n        state.isLoading = false;\n        clearHandoffParams();\n        return false;\n      }\n    },\n\n    /**\n     * Get the imported voices.\n     */\n    get voices(): SnapshotVoice[] {\n      return state.snapshot?.voices ?? [];\n    },\n\n    /**\n     * Get the time grid structure.\n     */\n    get timeGrid(): TimeGridStructure | null {\n      return state.snapshot?.timeGrid ?? null;\n    },\n\n    /**\n     * Get the tempo (with transposition applied to accompaniment).\n     */\n    get tempo(): number {\n      return state.snapshot?.tempo ?? 90;\n    },\n\n    /**\n     * Get the suggested pitch range based on imported notes.\n     */\n    get suggestedPitchRange(): { minMidi: number; maxMidi: number } | null {\n      if (!state.snapshot) {\n        return null;\n      }\n\n      const margin = 3; // Add a few semitones margin\n      const minMidi = state.snapshot.minMidiPitch;\n      const maxMidi = state.snapshot.maxMidiPitch;\n\n      if (minMidi === undefined || maxMidi === undefined) {\n        return null;\n      }\n\n      return {\n        minMidi: Math.max(21, minMidi - margin + state.transpositionSemitones),\n        maxMidi: Math.min(108, maxMidi + margin + state.transpositionSemitones),\n      };\n    },\n\n    /**\n     * Set transposition in semitones.\n     */\n    setTransposition(semitones: number) {\n      state.transpositionSemitones = semitones;\n    },\n\n    /**\n     * Transpose up by one semitone.\n     */\n    transposeUp() {\n      state.transpositionSemitones += 1;\n    },\n\n    /**\n     * Transpose down by one semitone.\n     */\n    transposeDown() {\n      state.transpositionSemitones -= 1;\n    },\n\n    /**\n     * Get a transposed MIDI pitch.\n     */\n    getTransposedMidi(originalMidi: number): number {\n      return originalMidi + state.transpositionSemitones;\n    },\n\n    /**\n     * Export current state back to Student Notation.\n     * Creates a new snapshot and navigates back.\n     */\n    async bringBackToStudentNotation(): Promise<void> {\n      if (!state.snapshot) {\n        console.warn('[HandoffState] No snapshot to bring back');\n        return;\n      }\n\n      // Create a modified snapshot for return\n      const returnSnapshot: SingingTrainerSnapshot = {\n        ...state.snapshot,\n        sourceApp: 'singing-trainer',\n        createdAt: Date.now(),\n        // Apply transposition to all voices\n        voices: state.snapshot.voices.map(voice => ({\n          ...voice,\n          notes: voice.notes.map(note => ({\n            ...note,\n            midiPitch: note.midiPitch + state.transpositionSemitones,\n          })),\n        })),\n      };\n\n      try {\n        const handoffId = await writeHandoffSlot(returnSnapshot);\n        console.log('[HandoffState] Handoff slot written for return', handoffId);\n        navigateToStudentNotation(handoffId);\n      } catch (error) {\n        console.error('[HandoffState] Failed to write return handoff', error);\n      }\n    },\n\n    /**\n     * Clear the imported snapshot.\n     */\n    clearSnapshot() {\n      state = { ...DEFAULT_STATE };\n    },\n\n    /**\n     * Reset the handoff state.\n     */\n    reset() {\n      state = { ...DEFAULT_STATE };\n    },\n  };\n}\n\nexport const handoffState = createHandoffState();\n","<script lang=\"ts\">\n  /**\n   * App Component\n   *\n   * Main application layout for the Singing Trainer.\n   */\n  import { onMount, onDestroy } from 'svelte';\n  import {\n    SingingCanvas,\n    TonicSelector,\n    DroneControls,\n    PitchHighlightToggle,\n    PitchReadout,\n    RangeControl,\n    DemoExerciseControls,\n    UltrastarControls,\n  } from './lib/components/index.js';\n  import { ResultsModal } from './lib/components/feedback/index.js';\n  import { handoffState } from './lib/stores/handoffState.svelte.js';\n  import { appState } from './lib/stores/appState.svelte.js';\n  import { highwayState } from './lib/stores/highwayState.svelte.js';\n  import { ultrastarState } from './lib/stores/ultrastarState.svelte.js';\n  import { resultsState } from './lib/stores/resultsState.svelte.js';\n  import { demoExerciseState } from './lib/stores/demoExerciseState.svelte.js';\n  import { startDetection, stopDetection } from './lib/services/pitchDetection.js';\n\n  // Settings panel state\n  let showSettings = $state(false);\n\n  // Reactive state for Ultrastar\n  const isUltrastarActive = $derived(ultrastarState.state.isActive);\n\n  // Register performance complete callbacks\n  $effect(() => {\n    // Register highway completion callback\n    const unsubscribe = highwayState.onPerformanceComplete((results) => {\n      // Check if this is an Ultrastar song\n      if (ultrastarState.state.isActive && ultrastarState.state.isPlaying) {\n        const summary = resultsState.calculateSummary(\n          results,\n          ultrastarState.state.targetNotes\n        );\n        resultsState.show(summary, {\n          title: ultrastarState.title,\n          artist: ultrastarState.artist,\n          source: 'ultrastar',\n        });\n        ultrastarState.setPlaying(false);\n      }\n      // Demo exercise handles its own results display\n    });\n\n    return unsubscribe;\n  });\n\n  // Handle results modal retry\n  function handleResultsRetry() {\n    if (resultsState.state.source === 'ultrastar') {\n      // Restart Ultrastar song\n      highwayState.reset();\n      highwayState.setTargetNotes(ultrastarState.state.targetNotes);\n      appState.setVisualizationMode('highway');\n    } else if (resultsState.state.source === 'demo') {\n      // Restart demo exercise - handled by DemoExerciseControls\n    }\n  }\n\n  // Check for handoff and auto-start pitch detection on mount\n  onMount(async () => {\n    const wasHandoff = await handoffState.checkAndConsumeHandoff();\n\n    if (wasHandoff) {\n      console.log('[App] Handoff detected and processed');\n\n      // Update the pitch range based on imported data\n      const suggestedRange = handoffState.suggestedPitchRange;\n      if (suggestedRange) {\n        appState.setYAxisRange(suggestedRange);\n      }\n    }\n\n    // Auto-start pitch detection\n    try {\n      await startDetection();\n      appState.setDetecting(true);\n      console.log('[App] Pitch detection auto-started');\n    } catch (err) {\n      console.error('[App] Failed to auto-start pitch detection:', err);\n    }\n  });\n\n  // Clean up on unmount\n  onDestroy(() => {\n    stopDetection();\n  });\n\n  // Reactive state\n  const hasImportedSnapshot = $derived(handoffState.state.hasImportedSnapshot);\n  const transposition = $derived(handoffState.state.transpositionSemitones);\n  const handoffError = $derived(handoffState.state.error);\n\n  function handleBringBack() {\n    handoffState.bringBackToStudentNotation();\n  }\n\n  function handleTransposeUp() {\n    handoffState.transposeUp();\n  }\n\n  function handleTransposeDown() {\n    handoffState.transposeDown();\n  }\n</script>\n\n<div class=\"app\">\n  <header class=\"header\">\n    <h1 class=\"title\">Singing Trainer</h1>\n    <div class=\"header-controls\">\n      {#if hasImportedSnapshot}\n        <div class=\"handoff-controls\">\n          <div class=\"transposition-control\">\n            <button class=\"transpose-btn\" onclick={handleTransposeDown} title=\"Transpose down\">-</button>\n            <span class=\"transposition-label\">\n              {transposition >= 0 ? '+' : ''}{transposition}\n            </span>\n            <button class=\"transpose-btn\" onclick={handleTransposeUp} title=\"Transpose up\">+</button>\n          </div>\n          <button class=\"bring-back-btn\" onclick={handleBringBack}>\n            Bring Back to Student Notation\n          </button>\n        </div>\n      {/if}\n    </div>\n  </header>\n\n  {#if handoffError}\n    <div class=\"error-banner\">\n      {handoffError}\n    </div>\n  {/if}\n\n  <main class=\"main\">\n    <aside class=\"sidebar sidebar--left\">\n      <div class=\"control-group\">\n        <PitchReadout />\n      </div>\n\n      <div class=\"control-group\">\n        <DemoExerciseControls />\n      </div>\n\n      <div class=\"control-group\">\n        <UltrastarControls />\n      </div>\n\n      <div class=\"control-group\">\n        <details class=\"settings-details\" bind:open={showSettings}>\n          <summary class=\"settings-summary\">Settings</summary>\n          <div class=\"settings-content\">\n            <TonicSelector />\n            <DroneControls />\n            <PitchHighlightToggle />\n          </div>\n        </details>\n      </div>\n\n      <div class=\"control-group\">\n        <RangeControl />\n      </div>\n\n      {#if hasImportedSnapshot}\n        <div class=\"control-group\">\n          <h3 class=\"control-group-title\">Imported Material</h3>\n          <div class=\"import-info\">\n            <span class=\"import-label\">Voices:</span>\n            <span class=\"import-value\">{handoffState.voices.length}</span>\n          </div>\n          <div class=\"import-info\">\n            <span class=\"import-label\">Tempo:</span>\n            <span class=\"import-value\">{handoffState.tempo} BPM</span>\n          </div>\n          {#if handoffState.timeGrid}\n            <div class=\"import-info\">\n              <span class=\"import-label\">Microbeats:</span>\n              <span class=\"import-value\">{handoffState.timeGrid.microbeatCount}</span>\n            </div>\n          {/if}\n        </div>\n      {/if}\n    </aside>\n\n    <section class=\"canvas-area\">\n      <SingingCanvas />\n    </section>\n  </main>\n\n  <!-- Results Modal -->\n  <ResultsModal onRetry={handleResultsRetry} />\n</div>\n\n<style>\n  .app {\n    display: flex;\n    flex-direction: column;\n    height: 100%;\n    width: 100%;\n  }\n\n  .header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: var(--spacing-md) var(--spacing-lg);\n    background-color: var(--color-bg-light);\n    border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n  }\n\n  .title {\n    font-size: var(--font-size-xl);\n    font-weight: 700;\n    color: var(--color-text);\n    margin: 0;\n  }\n\n  .header-controls {\n    display: flex;\n    gap: var(--spacing-md);\n  }\n\n  .main {\n    display: flex;\n    flex: 1;\n    overflow: hidden;\n  }\n\n  .sidebar {\n    display: flex;\n    flex-direction: column;\n    gap: var(--spacing-lg);\n    padding: var(--spacing-lg);\n    background-color: var(--color-bg-light);\n    border-right: 1px solid rgba(255, 255, 255, 0.1);\n    min-width: 260px;\n    max-width: 300px;\n    overflow-y: auto; /* Allow vertical scrolling */\n  }\n\n  .control-group {\n    display: flex;\n    flex-direction: column;\n    gap: var(--spacing-md);\n  }\n\n  .control-group-title {\n    font-size: var(--font-size-sm);\n    font-weight: 600;\n    color: var(--color-text-muted);\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n    margin: 0;\n  }\n\n  .canvas-area {\n    flex: 1;\n    display: flex;\n    padding: var(--spacing-lg);\n    overflow: hidden;\n  }\n\n  /* Handoff controls */\n  .handoff-controls {\n    display: flex;\n    align-items: center;\n    gap: var(--spacing-md);\n  }\n\n  .transposition-control {\n    display: flex;\n    align-items: center;\n    gap: var(--spacing-xs);\n    background-color: var(--color-bg);\n    border-radius: var(--radius-md);\n    padding: var(--spacing-xs) var(--spacing-sm);\n  }\n\n  .transpose-btn {\n    width: 28px;\n    height: 28px;\n    border: none;\n    border-radius: var(--radius-sm);\n    background-color: var(--color-bg-light);\n    color: var(--color-text);\n    font-size: var(--font-size-lg);\n    font-weight: 600;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    transition: background-color 0.15s ease;\n  }\n\n  .transpose-btn:hover {\n    background-color: var(--color-primary);\n    color: white;\n  }\n\n  .transposition-label {\n    font-size: var(--font-size-sm);\n    font-weight: 600;\n    color: var(--color-text);\n    min-width: 32px;\n    text-align: center;\n  }\n\n  .bring-back-btn {\n    padding: var(--spacing-sm) var(--spacing-md);\n    border: none;\n    border-radius: var(--radius-md);\n    background-color: var(--color-primary);\n    color: white;\n    font-size: var(--font-size-sm);\n    font-weight: 600;\n    cursor: pointer;\n    transition: background-color 0.15s ease;\n  }\n\n  .bring-back-btn:hover {\n    background-color: var(--color-primary-dark, #4a7bc8);\n  }\n\n  /* Error banner */\n  .error-banner {\n    background-color: var(--color-error, #dc3545);\n    color: white;\n    padding: var(--spacing-sm) var(--spacing-lg);\n    text-align: center;\n    font-size: var(--font-size-sm);\n  }\n\n  /* Import info */\n  .import-info {\n    display: flex;\n    justify-content: space-between;\n    font-size: var(--font-size-sm);\n    padding: var(--spacing-xs) 0;\n  }\n\n  .import-label {\n    color: var(--color-text-muted);\n  }\n\n  .import-value {\n    color: var(--color-text);\n    font-weight: 600;\n  }\n\n  /* Settings dropdown */\n  .settings-details {\n    background-color: var(--color-surface, rgba(255, 255, 255, 0.05));\n    border-radius: var(--radius-sm);\n    padding: var(--spacing-xs);\n  }\n\n  .settings-summary {\n    cursor: pointer;\n    font-size: var(--font-size-sm);\n    font-weight: 600;\n    color: var(--color-text-muted);\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n    padding: var(--spacing-xs);\n    user-select: none;\n    list-style: none;\n  }\n\n  .settings-summary::-webkit-details-marker {\n    display: none;\n  }\n\n  .settings-summary::before {\n    content: 'â–¶';\n    display: inline-block;\n    margin-right: var(--spacing-xs);\n    font-size: 0.7em;\n    transition: transform 0.2s ease;\n  }\n\n  .settings-details[open] .settings-summary::before {\n    transform: rotate(90deg);\n  }\n\n  .settings-summary:hover {\n    color: var(--color-primary);\n  }\n\n  .settings-content {\n    display: flex;\n    flex-direction: column;\n    gap: var(--spacing-md);\n    padding: var(--spacing-sm);\n    padding-top: var(--spacing-md);\n  }\n\n  @media (max-width: 900px) {\n    .header {\n      flex-wrap: wrap;\n      gap: var(--spacing-sm);\n      padding: var(--spacing-sm) var(--spacing-md);\n    }\n\n    .title {\n      font-size: var(--font-size-lg);\n    }\n\n    .header-controls {\n      width: 100%;\n      flex-wrap: wrap;\n      justify-content: flex-start;\n    }\n\n    .handoff-controls {\n      flex-wrap: wrap;\n    }\n\n    .main {\n      flex-direction: column;\n    }\n\n    .canvas-area {\n      order: 1;\n      padding: var(--spacing-md);\n      min-height: 300px;\n    }\n\n    .sidebar {\n      order: 2;\n      width: 100%;\n      max-width: none;\n      min-width: 0;\n      border-right: none;\n      border-top: 1px solid rgba(255, 255, 255, 0.1);\n      padding: var(--spacing-md);\n      max-height: 40vh;\n    }\n  }\n\n  @media (max-width: 600px) {\n    .canvas-area {\n      padding: var(--spacing-sm);\n    }\n\n    .sidebar {\n      max-height: 50vh;\n    }\n  }\n</style>\n","import { mount as svelteMount, unmount } from 'svelte';\nimport App from './App.svelte';\nimport './styles/global.css';\n\nexport type SingingTrainerInstance = {\n  destroy: () => void;\n};\n\nexport function mountSingingTrainer(container: HTMLElement): SingingTrainerInstance {\n  const app = svelteMount(App, { target: container });\n  return {\n    destroy: () => unmount(app),\n  };\n}\n\nexport const mount = mountSingingTrainer;\n\nexport default mountSingingTrainer;\n"],"names":["DEFAULT_STATE","createAppState","state","$","isDetecting","mode","tonic","useDegrees","show","enabled","range","octave","volume","appState","MAX_HISTORY_LENGTH","createPitchState","pitch","point","stable","pitchState","createHighwayState","engineService","animationFrameId","performanceCompleteCallback","convertToEngineFormat","notes","note","index","syncEngineState","engineState","performances","noteId","perf","animate","initializeEngine","createNoteHighwayService","event","data","hitData","engineNotes","noteIndex","i","x","pps","ms","midi","clarity","timeMs","callback","highwayState","DEFAULT_CONFIG","randomPitch","minMidi","maxMidi","getMicrobeatDurationMs","tempo","createDemoExerciseState","generateExerciseNotes","config","microbeatDurationMs","leadInMs","loop","loopStartTime","getPhaseFromTime","currentTimeMs","loopDurationMs","adjustedTimeMs","currentLoop","timeInLoop","microbeatInLoop","phase","newConfig","playing","result","loopIndex","sum","r","_a","demoExerciseState","container","containerWidth","containerHeight","trailCanvas","trailCtx","trailAnimationId","lastTrailLogAt","trailFrameSamples","trailFrameTimeTotal","cellWidth","showOctaveLabels","showFrequencyLabels","showRightLegend","LEGEND_COLUMN_WIDTH_UNITS","legendColumnWidth","legendCanvasWidth","showLegends","legendTotalWidth","gridWidth","gridOffsetX","getDebugTrailFlag","fullRowData","generateRowDataForMidiRange","viewportWindow","calculateViewportWindow","beatIntervalMs","beatTimeOffsetMs","legendHighlight","convertTargetNotes","n","trailConfig","getTonicPitchClass","singingConfig","highwayConfig","viewport","setupTrailCanvas","dpr","ctx","renderTrail","trailHistory","activeConfig","debugTrail","frameStart","nowLineX","coords","createTimeCoordinates","userPitchConfig","currentTime","drawUserPitchTrace","now","avgMs","startTrailLoop","stopTrailLoop","resizeObserver","entries","entry","onDestroy","div","root","PitchGrid","node","canvas","$$value","ReferenceAudioService","__publicField","Tone","dB","duration","frequency","startTimeoutId","endTimeoutId","durationMs","timeoutId","referenceAudio","CONFIG","mic","analyser","detector","isRunning","HIGHLIGHT_DEFAULT_SIZE","frequencyToMidi","animationLoop","waveform","isValidPitch","detectedPitch","nearestMidi","getNearestMidi","centsOffset","getCentsOffset","centsDistance","opacity","midiToPitchClass","startDetection","PitchDetector","err","cleanup","stopDetection","synth","isPlaying","currentNote","ensureSynth","oscillatorType","getNoteName","startDrone","s","stopDrone","updateDrone","newNote","toggleDrone","TONIC_OPTIONS","handleChange","target","select","option","root_1","OCTAVE_OPTIONS","handleToggle","handleOctaveChange","handleVolumeChange","button","text","div_1","label","$$anchor","oct","label_1","input","classes","select_value","midiToIndex","p","topIndex","bottomIndex","handleRangeChange","DualPitchWheel","showSettings","numLoops","referenceVolume","isActive","currentPhase","progress","results","hasResults","averageAccuracy","hitCount","totalCount","accuracy","calculateAccuracy","handleStop","useCurrentRange","useFullRange","handleStart","referenceTones","getPhaseLabel","getPitchName","getPitchByMidi","details","input_1","label_2","input_2","span","div_2","button_1","div_3","button_2","button_3","fragment","div_4","div_5","text_1","$$render","alternate","consequent","div_6","root_3","div_7","div_8","span_1","div_9","span_2","details_1","div_10","div_11","root_4","span_3","span_4","span_5","span_6","text_4","consequent_1","YOUTUBE_URL_PATTERNS","DEFAULT_SYNC_CONFIG","ULTRASTAR_BASE_MIDI","parseUltrastarFile","content","lines","line","metadata","extractMetadata","lineBreaks","totalBeats","parseNoteLines","error","colonIndex","key","value","firstChar","parts","beat","parseNoteLine","noteEnd","type","startBeat","lyric","extractYouTubeId","urlOrId","trimmed","pattern","match","convertToTargetNotes","song","baseMidi","bpm","msPerBeat","phraseIndex","sortedBreaks","a","b","firstNoteBeat","startTimeMs","targetNote","getSyncConfig","calculateSongDuration","detectPitchRange","midiNotes","createUltrastarState","onCompleteCallback","file","youtubeId","syncConfig","targetNotes","totalDurationMs","detectedRange","gapMs","videoGapSec","manualOffsetSec","deltaSec","offsetSec","ultrastarState","apiLoadPromise","isApiLoaded","loadYouTubeAPI","resolve","reject","script","createYouTubePlayer","elementId","videoId","options","width","height","onReady","onStateChange","onError","getYouTubeErrorMessage","createYouTubeState","player","syncIntervalId","timeUpdateCallback","containerId","playerState","timeSeconds","v","onTimeUpdate","intervalMs","expectedTimeSec","maxDriftMs","actualTime","youtubeState","createTransportSync","driftCheckIntervalMs","getYouTubeOffset","transportToYouTube","transportTimeMs","youTubeToTransport","youtubeTimeSec","checkDrift","expectedYouTubeTime","driftSec","driftMs","correctedTransportTimeMs","updateConfig","partial","adjustManualOffset","resetManualOffset","getManualOffset","getTotalOffset","formatOffset","offset","getSyncLoopConfig","playerId","isLoading","hasError","isEmbeddable","openOnYouTube","url","root_2","consequent_2","consequent_3","manualOffset","adjust","delta","reset","handleKeydown","button_4","transportSync","fileInput","hasVideo","songTitle","songArtist","handleFileSelect","_b","_c","_d","startOffset","startSyncLoop","stopSyncLoop","handleUnload","ytTime","currentTransport","openFilePicker","fragment_2","root_6","YouTubePlayer","node_4","SyncControls","node_5","node_3","root_7","root_8","alternate_1","consequent_4","node_6","root_9","consequent_5","alternate_2","NOTE_NAMES","noteName","cents","text_2","EMPTY_SUMMARY","createResultsState","summary","notesHit","goldenNotesHit","goldenNotesTotal","totalPitchDeviation","pitchDeviationCount","phraseMap","isGolden","phrase","totalNotes","notesMissed","accuracyPercent","averagePitchDeviationCents","phraseResults","resultsState","isVisible","artistName","letterGrade","accuracyColor","handleClose","handleRetry","handleBackdropClick","text_6","root_5","span_7","text_7","div_12","span_8","$0","text_8","div_13","div_14","span_9","span_10","text_9","text_10","div_15","node_7","styles","styles_1","text_5","consequent_7","createHandoffState","checkForHandoff","snapshot","consumeHandoffSlot","SNAPSHOT_SCHEMA_VERSION","clearHandoffParams","margin","semitones","originalMidi","returnSnapshot","voice","handoffId","writeHandoffSlot","navigateToStudentNotation","handoffState","handleResultsRetry","onMount","suggestedRange","hasImportedSnapshot","transposition","handoffError","handleBringBack","handleTransposeUp","handleTransposeDown","header","main","node_1","aside","PitchReadout","node_2","DemoExerciseControls","UltrastarControls","TonicSelector","DroneControls","PitchHighlightToggle","RangeControl","node_8","text_3","section","SingingCanvas","node_11","ResultsModal","mountSingingTrainer","app","svelteMount","App","unmount","mount"],"mappings":"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"}