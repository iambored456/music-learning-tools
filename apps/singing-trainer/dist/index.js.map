{"version":3,"file":"index.js","sources":["../src/lib/stores/appState.svelte.ts","../src/lib/stores/pitchState.svelte.ts","../src/lib/stores/highwayState.svelte.ts","../src/lib/stores/demoExerciseState.svelte.ts","../src/lib/components/SingingCanvas.svelte","../src/lib/services/referenceAudio.ts","../src/lib/services/pitchDetection.ts","../src/lib/services/droneAudio.ts","../src/lib/components/controls/TonicSelector.svelte","../src/lib/components/controls/DroneControls.svelte","../src/lib/components/controls/RangeControl.svelte","../src/lib/components/controls/PitchHighlightToggle.svelte","../src/lib/components/controls/DemoExerciseControls.svelte","../src/lib/components/feedback/PitchReadout.svelte","../src/lib/stores/handoffState.svelte.ts","../src/App.svelte","../src/index.ts"],"sourcesContent":["/**\n * App State Store - Svelte 5 Runes\n *\n * Main application state for the Singing Trainer.\n */\n\nexport type VisualizationMode = 'stationary' | 'highway';\nexport type TonicNote =\n  | 'C'\n  | 'C#'\n  | 'Db'\n  | 'D'\n  | 'D#'\n  | 'Eb'\n  | 'E'\n  | 'F'\n  | 'F#'\n  | 'Gb'\n  | 'G'\n  | 'G#'\n  | 'Ab'\n  | 'A'\n  | 'A#'\n  | 'Bb'\n  | 'B';\n\nexport interface DroneState {\n  isPlaying: boolean;\n  octave: number;\n  volume: number;\n}\n\nexport interface YAxisRange {\n  minMidi: number;\n  maxMidi: number;\n}\n\nexport interface AppState {\n  isDetecting: boolean;\n  visualizationMode: VisualizationMode;\n  tonic: TonicNote;\n  useDegrees: boolean;\n  showAccidentals: boolean;\n  pitchHighlightEnabled: boolean;\n  yAxisRange: YAxisRange;\n  drone: DroneState;\n}\n\nconst DEFAULT_STATE: AppState = {\n  isDetecting: false,\n  visualizationMode: 'highway',\n  tonic: 'C',\n  useDegrees: false,\n  showAccidentals: true,\n  pitchHighlightEnabled: true,\n  yAxisRange: { minMidi: 48, maxMidi: 72 }, // C3 to C5\n  drone: { isPlaying: false, octave: 3, volume: -12 },\n};\n\nfunction createAppState() {\n  let state = $state<AppState>({ ...DEFAULT_STATE });\n\n  return {\n    get state() {\n      return state;\n    },\n\n    toggleDetecting() {\n      state.isDetecting = !state.isDetecting;\n    },\n\n    setDetecting(isDetecting: boolean) {\n      state.isDetecting = isDetecting;\n    },\n\n    setVisualizationMode(mode: VisualizationMode) {\n      state.visualizationMode = mode;\n    },\n\n    setTonic(tonic: TonicNote) {\n      state.tonic = tonic;\n    },\n\n    setUseDegrees(useDegrees: boolean) {\n      state.useDegrees = useDegrees;\n    },\n\n    setShowAccidentals(show: boolean) {\n      state.showAccidentals = show;\n    },\n\n    togglePitchHighlight() {\n      state.pitchHighlightEnabled = !state.pitchHighlightEnabled;\n    },\n\n    setPitchHighlightEnabled(enabled: boolean) {\n      state.pitchHighlightEnabled = enabled;\n    },\n\n    setYAxisRange(range: YAxisRange) {\n      state.yAxisRange = range;\n    },\n\n    expandYAxisUpper() {\n      if (state.yAxisRange.maxMidi < 108) {\n        state.yAxisRange = { ...state.yAxisRange, maxMidi: state.yAxisRange.maxMidi + 1 };\n      }\n    },\n\n    contractYAxisUpper() {\n      if (state.yAxisRange.maxMidi > state.yAxisRange.minMidi + 6) {\n        state.yAxisRange = { ...state.yAxisRange, maxMidi: state.yAxisRange.maxMidi - 1 };\n      }\n    },\n\n    expandYAxisLower() {\n      if (state.yAxisRange.minMidi > 21) {\n        state.yAxisRange = { ...state.yAxisRange, minMidi: state.yAxisRange.minMidi - 1 };\n      }\n    },\n\n    contractYAxisLower() {\n      if (state.yAxisRange.minMidi < state.yAxisRange.maxMidi - 6) {\n        state.yAxisRange = { ...state.yAxisRange, minMidi: state.yAxisRange.minMidi + 1 };\n      }\n    },\n\n    toggleDrone() {\n      state.drone = { ...state.drone, isPlaying: !state.drone.isPlaying };\n    },\n\n    setDroneOctave(octave: number) {\n      state.drone = { ...state.drone, octave };\n    },\n\n    setDroneVolume(volume: number) {\n      state.drone = { ...state.drone, volume };\n    },\n\n    reset() {\n      state = { ...DEFAULT_STATE };\n    },\n  };\n}\n\nexport const appState = createAppState();\n","/**\n * Pitch State Store - Svelte 5 Runes\n *\n * Real-time pitch detection state including current pitch and history.\n */\n\nexport interface DetectedPitch {\n  frequency: number;\n  midi: number;\n  clarity: number;\n  pitchClass: number;\n}\n\nexport interface PitchHistoryPoint {\n  frequency: number;\n  midi: number;\n  time: number;\n  clarity: number;\n}\n\nexport interface StablePitch {\n  pitchClass: number | null;\n  opacity: number;\n  size: number;\n}\n\nexport interface PitchState {\n  currentPitch: DetectedPitch | null;\n  history: PitchHistoryPoint[];\n  stablePitch: StablePitch;\n}\n\nconst MAX_HISTORY_LENGTH = 200; // Cap history to bound trail render cost\n\nconst DEFAULT_STATE: PitchState = {\n  currentPitch: null,\n  history: [],\n  stablePitch: { pitchClass: null, opacity: 0, size: 1.0 },\n};\n\nfunction createPitchState() {\n  let state = $state<PitchState>({ ...DEFAULT_STATE });\n\n  return {\n    get state() {\n      return state;\n    },\n\n    setCurrentPitch(pitch: DetectedPitch | null) {\n      state.currentPitch = pitch;\n    },\n\n    addHistoryPoint(point: PitchHistoryPoint) {\n      state.history.push(point);\n      if (state.history.length > MAX_HISTORY_LENGTH) {\n        state.history.shift();\n      }\n    },\n\n    setStablePitch(stable: StablePitch) {\n      state.stablePitch = stable;\n    },\n\n    clearHistory() {\n      state.history = [];\n    },\n\n    reset() {\n      state = { ...DEFAULT_STATE };\n    },\n  };\n}\n\nexport const pitchState = createPitchState();\n","/**\n * Highway State Store - Svelte 5 Runes\n *\n * State for the \"Guitar Hero\" note highway visualization mode.\n * Now uses the @mlt/student-notation-engine highway service.\n */\n\nimport {\n  createNoteHighwayService,\n  type NoteHighwayServiceInstance,\n  type HighwayTargetNote,\n  type NotePerformance,\n} from '@mlt/student-notation-engine';\n\nexport interface TargetNote {\n  midi: number;\n  startTimeMs: number;\n  durationMs: number;\n  hit?: boolean;\n  lyric?: string; // For emoji/text display on notes\n}\n\nexport interface HighwayState {\n  isPlaying: boolean;\n  startTime: number | null;\n  currentTimeMs: number;\n  targetNotes: TargetNote[];\n  nowLineX: number;\n  pixelsPerSecond: number;\n  timeWindowMs: number;\n}\n\nconst DEFAULT_STATE: HighwayState = {\n  isPlaying: false,\n  startTime: null,\n  currentTimeMs: 0,\n  targetNotes: [],\n  nowLineX: 100, // Position of the \"now\" line from left edge\n  pixelsPerSecond: 200,\n  timeWindowMs: 4000,\n};\n\nfunction createHighwayState() {\n  let state = $state<HighwayState>({ ...DEFAULT_STATE });\n  let engineService: NoteHighwayServiceInstance | null = null;\n  let animationFrameId: number | null = null;\n\n  // Convert local TargetNote to engine HighwayTargetNote\n  function convertToEngineFormat(notes: TargetNote[]): HighwayTargetNote[] {\n    return notes.map((note, index) => ({\n      id: `target-${index}`,\n      midi: note.midi,\n      startTimeMs: note.startTimeMs,\n      durationMs: note.durationMs,\n      startColumn: 0, // Not used in target notes mode\n      endColumn: 0,   // Not used in target notes mode\n      color: '#3b82f6',\n      shape: 'oval' as const,\n      globalRow: 0,\n    }));\n  }\n\n  // Sync engine state to local state\n  function syncEngineState() {\n    if (!engineService) return;\n\n    const engineState = engineService.getState();\n    state.isPlaying = engineState.isPlaying && !engineState.isPaused;\n    state.currentTimeMs = engineState.currentTimeMs;\n\n    // Update hit status from engine performance\n    const performances = engineService.getPerformanceResults();\n    state.targetNotes = state.targetNotes.map((note, index) => {\n      const noteId = `target-${index}`;\n      const perf = performances.get(noteId);\n      return {\n        ...note,\n        hit: perf?.hitStatus === 'hit',\n      };\n    });\n  }\n\n  // Animation loop to sync state\n  function animate() {\n    if (state.isPlaying && engineService) {\n      syncEngineState();\n      animationFrameId = requestAnimationFrame(animate);\n    } else {\n      animationFrameId = null;\n    }\n  }\n\n  function initializeEngine() {\n    if (engineService) {\n      engineService.dispose();\n    }\n\n    // Create engine service with minimal config\n    engineService = createNoteHighwayService({\n      judgmentLinePosition: state.nowLineX / 800, // Assume 800px viewport\n      pixelsPerSecond: state.pixelsPerSecond,\n      lookAheadMs: state.timeWindowMs,\n      scrollMode: 'constant-speed',\n      leadInBeats: 0, // No onramp for singing trainer\n      playMetronomeDuringOnramp: false,\n      playTargetNotes: false,\n      playMetronome: false,\n      inputSources: ['microphone'],\n      feedbackConfig: {\n        onsetToleranceMs: 100,\n        releaseToleranceMs: 150,\n        pitchToleranceCents: 50,\n        hitThreshold: 70,\n      },\n      stateCallbacks: {\n        getTempo: () => 120,\n        getCellWidth: () => 20,\n        getViewportWidth: () => 800,\n      },\n      eventCallbacks: {\n        emit: (event, data) => {\n          // Log highway events for debugging\n          console.debug('[Highway]', event, data);\n\n          // Handle specific events with visual feedback (placeholder for Phase 6)\n          if (event === 'noteHit') {\n            const hitData = data as { noteId: string; note: any; performance: any };\n            console.log(\n              `[Highway] Note HIT: ${hitData.noteId}, accuracy: ${hitData.performance.accuracyTier || 'unknown'}`\n            );\n            // TODO Phase 6: Trigger visual effects (glow, particles, emboldening)\n          } else if (event === 'noteMissed') {\n            const missData = data as { noteId: string; note: any; performance: any };\n            console.log(`[Highway] Note MISSED: ${missData.noteId}`);\n            // TODO Phase 6: Trigger visual effects (fade, shake, miss indicator)\n          } else if (event === 'onrampComplete') {\n            console.log('[Highway] Onramp complete, playback starting!');\n          } else if (event === 'performanceComplete') {\n            console.log('[Highway] Performance complete!');\n            // TODO Phase 6: Show score screen with performance results\n          }\n        },\n      },\n    });\n\n    // Initialize with target notes\n    const engineNotes = convertToEngineFormat(state.targetNotes);\n    engineService.init(engineNotes);\n  }\n\n  return {\n    get state() {\n      return state;\n    },\n\n    get engineService() {\n      return engineService;\n    },\n\n    start() {\n      if (!engineService && state.targetNotes.length > 0) {\n        initializeEngine();\n      }\n\n      if (engineService) {\n        engineService.start();\n        state.isPlaying = true;\n        state.startTime = performance.now();\n        state.currentTimeMs = 0;\n        animate();\n      }\n    },\n\n    stop() {\n      if (engineService) {\n        engineService.stop();\n      }\n      state.isPlaying = false;\n      if (animationFrameId !== null) {\n        cancelAnimationFrame(animationFrameId);\n        animationFrameId = null;\n      }\n    },\n\n    pause() {\n      if (engineService) {\n        engineService.pause();\n      }\n      state.isPlaying = false;\n      if (animationFrameId !== null) {\n        cancelAnimationFrame(animationFrameId);\n        animationFrameId = null;\n      }\n    },\n\n    resume() {\n      if (engineService) {\n        engineService.resume();\n        state.isPlaying = true;\n        animate();\n      }\n    },\n\n    setTargetNotes(notes: TargetNote[]) {\n      state.targetNotes = notes;\n\n      // Reinitialize engine if it exists\n      if (engineService) {\n        const engineNotes = convertToEngineFormat(notes);\n        engineService.init(engineNotes);\n      }\n    },\n\n    markNoteHit(noteIndex: number) {\n      if (noteIndex >= 0 && noteIndex < state.targetNotes.length) {\n        state.targetNotes = state.targetNotes.map((note, i) =>\n          i === noteIndex ? { ...note, hit: true } : note\n        );\n      }\n    },\n\n    setNowLineX(x: number) {\n      state.nowLineX = x;\n    },\n\n    setPixelsPerSecond(pps: number) {\n      state.pixelsPerSecond = pps;\n    },\n\n    setTimeWindowMs(ms: number) {\n      state.timeWindowMs = ms;\n    },\n\n    recordPitchInput(midi: number, clarity: number) {\n      if (engineService && state.isPlaying) {\n        engineService.recordPitchInput(midi, clarity, 'microphone');\n      }\n    },\n\n    getPerformanceResults(): Map<string, NotePerformance> {\n      return engineService?.getPerformanceResults() ?? new Map();\n    },\n\n    reset() {\n      if (animationFrameId !== null) {\n        cancelAnimationFrame(animationFrameId);\n        animationFrameId = null;\n      }\n      if (engineService) {\n        engineService.dispose();\n        engineService = null;\n      }\n      state = { ...DEFAULT_STATE };\n    },\n  };\n}\n\nexport const highwayState = createHighwayState();\n","/**\r\n * Demo Exercise State Store - Svelte 5 Runes\r\n *\r\n * Manages the pitch-matching demo exercise with reference tones and graded user input.\r\n */\r\n\r\nimport type { NotePerformance } from '@mlt/student-notation-engine';\r\nimport type { TargetNote } from './highwayState.svelte.js';\r\n\r\nexport interface ExerciseConfig {\r\n  numLoops: number;\r\n  minMidi: number;\r\n  maxMidi: number;\r\n  tempo: number;\r\n  referenceVolume: number; // dB, -60 to 0\r\n}\r\n\r\nexport type ExercisePhase = 'reference' | 'rest1' | 'input' | 'rest2';\r\n\r\nexport interface ExerciseState {\r\n  isActive: boolean;\r\n  isPlaying: boolean;\r\n  config: ExerciseConfig;\r\n  currentLoop: number;\r\n  currentPhase: ExercisePhase;\r\n  currentPitch: number | null;\r\n  generatedNotes: TargetNote[];\r\n  results: ExerciseResult[];\r\n}\r\n\r\nexport interface ExerciseResult {\r\n  loopIndex: number;\r\n  targetPitch: number;\r\n  performance: NotePerformance | null;\r\n  accuracy: number; // 0-100%\r\n}\r\n\r\nconst DEFAULT_CONFIG: ExerciseConfig = {\r\n  numLoops: 5,\r\n  minMidi: 48, // Will be overridden with Y-axis range\r\n  maxMidi: 72,\r\n  tempo: 108,\r\n  referenceVolume: -12, // -12 dB default\r\n};\r\n\r\nconst DEFAULT_STATE: ExerciseState = {\r\n  isActive: false,\r\n  isPlaying: false,\r\n  config: { ...DEFAULT_CONFIG },\r\n  currentLoop: 0,\r\n  currentPhase: 'reference',\r\n  currentPitch: null,\r\n  generatedNotes: [],\r\n  results: [],\r\n};\r\n\r\n/**\r\n * Generate a random MIDI pitch within range\r\n */\r\nfunction randomPitch(minMidi: number, maxMidi: number): number {\r\n  return Math.floor(Math.random() * (maxMidi - minMidi + 1)) + minMidi;\r\n}\r\n\r\n/**\r\n * Calculate microbeat duration in milliseconds\r\n */\r\nfunction getMicrobeatDurationMs(tempo: number): number {\r\n  // Microbeat = eighth note = (60 / tempo) / 2 seconds\r\n  return (60 / tempo) * 1000 / 2;\r\n}\r\n\r\nfunction createDemoExerciseState() {\r\n  let state = $state<ExerciseState>({ ...DEFAULT_STATE });\r\n\r\n  /**\r\n   * Generate exercise notes with emojis\r\n   */\r\n  function generateExerciseNotes(config: ExerciseConfig): TargetNote[] {\r\n    const notes: TargetNote[] = [];\r\n    const microbeatDurationMs = getMicrobeatDurationMs(config.tempo);\r\n\r\n    // Add 2-second lead-in so notes don't start immediately\r\n    const leadInMs = 2000;\r\n\r\n    for (let loop = 0; loop < config.numLoops; loop++) {\r\n      const pitch = randomPitch(config.minMidi, config.maxMidi);\r\n      const loopStartTime = leadInMs + (loop * 32 * microbeatDurationMs);\r\n\r\n      // Reference note (0-8 microbeats) with ðŸ‘‚ emoji\r\n      notes.push({\r\n        midi: pitch,\r\n        startTimeMs: loopStartTime,\r\n        durationMs: 8 * microbeatDurationMs,\r\n        lyric: 'ðŸ‘‚',\r\n      });\r\n\r\n      // Rest 1 (8-16 microbeats) - no note\r\n\r\n      // User input note (16-24 microbeats) with ðŸŽ¤ emoji\r\n      notes.push({\r\n        midi: pitch,\r\n        startTimeMs: loopStartTime + (16 * microbeatDurationMs),\r\n        durationMs: 8 * microbeatDurationMs,\r\n        lyric: 'ðŸŽ¤',\r\n      });\r\n\r\n      // Rest 2 (24-32 microbeats) - no note\r\n    }\r\n\r\n    return notes;\r\n  }\r\n\r\n  /**\r\n   * Determine which phase we're in based on current time\r\n   */\r\n  function getPhaseFromTime(currentTimeMs: number, tempo: number): { loop: number; phase: ExercisePhase } {\r\n    const microbeatDurationMs = getMicrobeatDurationMs(tempo);\r\n    const loopDurationMs = 32 * microbeatDurationMs;\r\n    const leadInMs = 2000;\r\n\r\n    // Subtract lead-in time\r\n    const adjustedTimeMs = currentTimeMs - leadInMs;\r\n\r\n    // During lead-in, show as rest\r\n    if (adjustedTimeMs < 0) {\r\n      return { loop: 0, phase: 'rest2' };\r\n    }\r\n\r\n    const currentLoop = Math.floor(adjustedTimeMs / loopDurationMs);\r\n    const timeInLoop = adjustedTimeMs % loopDurationMs;\r\n    const microbeatInLoop = Math.floor(timeInLoop / microbeatDurationMs);\r\n\r\n    let phase: ExercisePhase;\r\n    if (microbeatInLoop < 8) {\r\n      phase = 'reference';\r\n    } else if (microbeatInLoop < 16) {\r\n      phase = 'rest1';\r\n    } else if (microbeatInLoop < 24) {\r\n      phase = 'input';\r\n    } else {\r\n      phase = 'rest2';\r\n    }\r\n\r\n    return { loop: currentLoop, phase };\r\n  }\r\n\r\n  return {\r\n    get state() {\r\n      return state;\r\n    },\r\n\r\n    /**\r\n     * Update exercise configuration\r\n     */\r\n    configure(newConfig: Partial<ExerciseConfig>) {\r\n      state.config = { ...state.config, ...newConfig };\r\n    },\r\n\r\n    /**\r\n     * Set pitch range from current Y-axis range\r\n     */\r\n    setPitchRange(minMidi: number, maxMidi: number) {\r\n      state.config.minMidi = minMidi;\r\n      state.config.maxMidi = maxMidi;\r\n    },\r\n\r\n    /**\r\n     * Start the demo exercise\r\n     */\r\n    start() {\r\n      // Generate notes\r\n      const notes = generateExerciseNotes(state.config);\r\n\r\n      state.generatedNotes = notes;\r\n      state.isActive = true;\r\n      state.isPlaying = false; // Will be set to true when playback starts\r\n      state.currentLoop = 0;\r\n      state.currentPhase = 'reference';\r\n      state.currentPitch = notes.length > 0 ? notes[0].midi : null;\r\n      state.results = [];\r\n    },\r\n\r\n    /**\r\n     * Stop the exercise\r\n     */\r\n    stop() {\r\n      state.isActive = false;\r\n      state.isPlaying = false;\r\n      state.currentLoop = 0;\r\n      state.currentPhase = 'reference';\r\n      state.currentPitch = null;\r\n    },\r\n\r\n    /**\r\n     * Mark exercise as playing (called when highway starts)\r\n     */\r\n    setPlaying(playing: boolean) {\r\n      state.isPlaying = playing;\r\n    },\r\n\r\n    /**\r\n     * Update current phase based on time\r\n     */\r\n    updatePhase(currentTimeMs: number) {\r\n      const { loop, phase } = getPhaseFromTime(currentTimeMs, state.config.tempo);\r\n      state.currentLoop = loop;\r\n      state.currentPhase = phase;\r\n\r\n      // Update current pitch\r\n      const noteIndex = loop * 2; // 2 notes per loop (reference + input)\r\n      if (noteIndex < state.generatedNotes.length) {\r\n        state.currentPitch = state.generatedNotes[noteIndex].midi;\r\n      }\r\n    },\r\n\r\n    /**\r\n     * Add a performance result for a completed loop\r\n     */\r\n    addResult(result: ExerciseResult) {\r\n      state.results.push(result);\r\n    },\r\n\r\n    /**\r\n     * Check if we already have a result for a specific loop\r\n     */\r\n    hasResultForLoop(loopIndex: number): boolean {\r\n      return state.results.some(r => r.loopIndex === loopIndex);\r\n    },\r\n\r\n    /**\r\n     * Get all results\r\n     */\r\n    getResults(): ExerciseResult[] {\r\n      return state.results;\r\n    },\r\n\r\n    /**\r\n     * Get current progress\r\n     */\r\n    getCurrentProgress(): { current: number; total: number } {\r\n      return {\r\n        current: state.currentLoop + 1,\r\n        total: state.config.numLoops,\r\n      };\r\n    },\r\n\r\n    /**\r\n     * Get generated notes for highway\r\n     */\r\n    getGeneratedNotes(): TargetNote[] {\r\n      return state.generatedNotes;\r\n    },\r\n\r\n    /**\r\n     * Calculate average accuracy from results\r\n     */\r\n    getAverageAccuracy(): number {\r\n      if (state.results.length === 0) return 0;\r\n      const total = state.results.reduce((sum, r) => sum + r.accuracy, 0);\r\n      return total / state.results.length;\r\n    },\r\n\r\n    /**\r\n     * Count hits\r\n     */\r\n    getHitCount(): number {\r\n      return state.results.filter(r => r.performance?.hitStatus === 'hit').length;\r\n    },\r\n\r\n    /**\r\n     * Reset to default state\r\n     */\r\n    reset() {\r\n      state = { ...DEFAULT_STATE, config: { ...state.config } };\r\n    },\r\n  };\r\n}\r\n\r\nexport const demoExerciseState = createDemoExerciseState();\r\n","<script lang=\"ts\">\n  /**\n   * SingingCanvas Component\n   *\n   * Wraps the shared PitchGrid component for singing/highway visualization modes.\n   */\n\n  import { onDestroy } from 'svelte';\n  import {\n    PitchGrid,\n    calculateViewportWindow,\n    createTimeCoordinates,\n    drawUserPitchTrace,\n  } from '@mlt/ui-components/canvas';\n  import type {\n    LegendHighlightConfig,\n    PitchGridMode,\n    PitchGridViewport,\n    SingingModeConfig,\n    HighwayModeConfig,\n    TargetNote as SharedTargetNote,\n    PitchTrailConfig,\n    UserPitchRenderConfig,\n    ViewportWindow,\n  } from '@mlt/ui-components/canvas';\n  import { generateRowDataForMidiRange, getTonicPitchClass, type PitchRowData } from '@mlt/pitch-data';\n  import { appState } from '../stores/appState.svelte.js';\n  import { pitchState } from '../stores/pitchState.svelte.js';\n  import { highwayState } from '../stores/highwayState.svelte.js';\n  import { demoExerciseState } from '../stores/demoExerciseState.svelte.js';\n\n  // Container element for measuring size\n  let container: HTMLDivElement | undefined = $state(undefined);\n  let containerWidth = $state(800);\n  let containerHeight = $state(400);\n\n  // Trail canvas overlay\n  let trailCanvas: HTMLCanvasElement | undefined = $state(undefined);\n  let trailCtx: CanvasRenderingContext2D | null = $state(null);\n  let trailAnimationId: number | null = $state(null);\n\n  let lastTrailLogAt = 0;\n  let trailFrameSamples = 0;\n  let trailFrameTimeTotal = 0;\n\n  const cellWidth = 20;\n  const showOctaveLabels = true;\n  const showFrequencyLabels = false;\n  const showRightLegend = $derived(containerWidth >= 720);\n\n  // Keep legend sizing in sync with PitchGrid\n  const LEGEND_COLUMN_WIDTH_UNITS = 3;\n  const legendColumnWidth = $derived(cellWidth * LEGEND_COLUMN_WIDTH_UNITS);\n  const legendCanvasWidth = $derived(legendColumnWidth * 2);\n  const showLegends = $derived(showOctaveLabels || showFrequencyLabels);\n  const legendTotalWidth = $derived(showLegends ? legendCanvasWidth * (showRightLegend ? 2 : 1) : 0);\n  const gridWidth = $derived(Math.max(0, containerWidth - legendTotalWidth));\n  const gridOffsetX = $derived(showLegends ? legendCanvasWidth : 0);\n  const getDebugTrailFlag = (): boolean => {\n    try {\n      const win = globalThis as typeof globalThis & { __ST_DEBUG_TRAIL?: boolean };\n      return Boolean(win.__ST_DEBUG_TRAIL);\n    } catch {\n      return false;\n    }\n  };\n\n  // Generate row data for the pitch grid based on y-axis range\n  // Uses the shared pitch data package which includes proper colors, frequencies, and enharmonic spellings\n  const fullRowData = $derived<PitchRowData[]>(\n    generateRowDataForMidiRange(appState.state.yAxisRange.minMidi, appState.state.yAxisRange.maxMidi)\n  );\n\n  // Calculate optimal viewport window that fills container height\n  const viewportWindow = $derived<ViewportWindow>(\n    calculateViewportWindow({\n      containerHeight,\n      fullRowData,\n      preferredCellHeight: 40,\n      minCellHeight: 20,\n    })\n  );\n\n  // Derive the PitchGrid mode from app state\n  const mode = $derived<PitchGridMode>(\n    appState.state.visualizationMode === 'highway' ? 'highway' : 'singing'\n  );\n\n  // Calculate beat interval based on exercise tempo\n  // 1 beat = 2 microbeats, beatIntervalMs = 60000 / tempo\n  const beatIntervalMs = $derived<number>(\n    (60 / demoExerciseState.state.config.tempo) * 1000 // ms per beat (quarter note)\n  );\n\n  // Lead-in time offset for beat line alignment (matches demoExerciseState)\n  const beatTimeOffsetMs = 2000;\n\n  const legendHighlight = $derived<LegendHighlightConfig | undefined>((() => {\n    if (!appState.state.pitchHighlightEnabled) {\n      return undefined;\n    }\n\n    const stable = pitchState.state.stablePitch;\n    if (stable.pitchClass === null || stable.opacity <= 0.01) {\n      return undefined;\n    }\n\n    return {\n      pitchClass: stable.pitchClass,\n      opacity: stable.opacity,\n      color: '#ffff00',\n    };\n  })());\n\n  // Convert local target notes to shared format\n  function convertTargetNotes(): SharedTargetNote[] {\n    return highwayState.state.targetNotes.map((n, i) => ({\n      id: `target-${i}`,\n      midi: n.midi,\n      startTimeMs: n.startTimeMs,\n      durationMs: n.durationMs,\n      label: n.lyric, // Pass emoji as label\n    }));\n  }\n\n  // Get pitch trail configuration with tonic-relative colors\n  const trailConfig = $derived<PitchTrailConfig>({\n    timeWindowMs: 4000,\n    pixelsPerSecond: 200,\n    circleRadius: 9.5,\n    proximityThreshold: 35,\n    maxConnections: 3,\n    connectorLineWidth: 2.5,\n    connectorColor: 'rgba(0,0,0,0.4)',\n    useTonicRelativeColors: true,\n    tonicPitchClass: getTonicPitchClass(appState.state.tonic),\n    clarityThreshold: 0.5,\n    maxOpacity: 0.9,\n  });\n\n  // Build singing mode config\n  const singingConfig = $derived<SingingModeConfig | undefined>(\n    mode === 'singing'\n      ? {\n          userPitch: pitchState.state.currentPitch\n            ? {\n                frequency: pitchState.state.currentPitch.frequency,\n                midi: pitchState.state.currentPitch.midi,\n                clarity: pitchState.state.currentPitch.clarity,\n                pitchClass: pitchState.state.currentPitch.pitchClass,\n              }\n            : null,\n          pitchHistory: [],\n          targetNotes: [],\n          pixelsPerSecond: 200,\n          timeWindowMs: 4000,\n          trailConfig,\n        }\n      : undefined\n  );\n\n  // Build highway mode config\n  const highwayConfig = $derived<HighwayModeConfig | undefined>(\n    mode === 'highway'\n      ? {\n          userPitch: pitchState.state.currentPitch\n            ? {\n                frequency: pitchState.state.currentPitch.frequency,\n                midi: pitchState.state.currentPitch.midi,\n                clarity: pitchState.state.currentPitch.clarity,\n                pitchClass: pitchState.state.currentPitch.pitchClass,\n              }\n            : null,\n          pitchHistory: [],\n          targetNotes: convertTargetNotes(),\n          nowLineX: highwayState.state.nowLineX,\n          pixelsPerSecond: highwayState.state.pixelsPerSecond,\n          currentTimeMs: highwayState.state.currentTimeMs,\n          timeWindowMs: highwayState.state.timeWindowMs,\n          trailConfig,\n        }\n      : undefined\n  );\n\n  // Viewport configuration using calculated window\n  const viewport = $derived<PitchGridViewport>({\n    startRow: viewportWindow.startRow,\n    endRow: viewportWindow.endRow,\n    zoomLevel: 1.0,\n    containerWidth,\n    containerHeight,\n  });\n\n  function setupTrailCanvas(): void {\n    if (!trailCanvas) return;\n\n    const dpr = window.devicePixelRatio || 1;\n    trailCanvas.width = gridWidth * dpr;\n    trailCanvas.height = containerHeight * dpr;\n    trailCanvas.style.width = `${gridWidth}px`;\n    trailCanvas.style.height = `${containerHeight}px`;\n    trailCanvas.style.left = `${gridOffsetX}px`;\n\n    const ctx = trailCanvas.getContext('2d');\n    if (!ctx) {\n      trailCtx = null;\n      return;\n    }\n\n    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);\n    trailCtx = ctx;\n  }\n\n  function renderTrail(): void {\n    if (!trailCtx || gridWidth <= 0) return;\n\n    trailCtx.clearRect(0, 0, gridWidth, containerHeight);\n\n    const trailHistory = pitchState.state.history;\n    if (trailHistory.length === 0) return;\n\n    // Support both stationary and highway modes\n    const activeConfig = mode === 'singing' ? singingConfig : highwayConfig;\n    if (!activeConfig) return;\n\n    const debugTrail = getDebugTrailFlag();\n    const frameStart = debugTrail ? performance.now() : 0;\n\n    // Use appropriate nowLineX based on mode\n    const nowLineX = mode === 'highway' && highwayConfig\n      ? highwayConfig.nowLineX\n      : 100;\n\n    const coords = createTimeCoordinates({\n      cellWidth,\n      cellHeight: viewportWindow.cellHeight,\n      viewport,\n      pixelsPerSecond: activeConfig.pixelsPerSecond ?? 200,\n      nowLineX,\n      currentTimeMs: mode === 'highway' && highwayConfig ? highwayConfig.currentTimeMs : 0,\n    });\n\n    const userPitchConfig: UserPitchRenderConfig = {\n      cellHeight: viewportWindow.cellHeight,\n      viewportWidth: gridWidth,\n      nowLineX,\n      pixelsPerSecond: activeConfig.pixelsPerSecond ?? 200,\n      timeWindowMs: activeConfig.timeWindowMs ?? 4000,\n      colorMode: 'color',\n      trailConfig,\n    };\n\n    const currentTime = performance.now();\n\n    drawUserPitchTrace(\n      trailCtx,\n      coords,\n      trailHistory,\n      currentTime,\n      userPitchConfig,\n      fullRowData\n    );\n\n    if (debugTrail) {\n      const now = performance.now();\n      trailFrameSamples += 1;\n      trailFrameTimeTotal += (now - frameStart);\n      if (now - lastTrailLogAt >= 1000) {\n        const avgMs = trailFrameSamples > 0 ? (trailFrameTimeTotal / trailFrameSamples) : 0;\n        console.log(\n          `[SingingTrail] points=${trailHistory.length} avgMs=${avgMs.toFixed(2)} gridWidth=${gridWidth}`\n        );\n        lastTrailLogAt = now;\n        trailFrameSamples = 0;\n        trailFrameTimeTotal = 0;\n      }\n    }\n  }\n\n  function startTrailLoop(): void {\n    if (trailAnimationId) return;\n\n    const loop = () => {\n      renderTrail();\n      trailAnimationId = requestAnimationFrame(loop);\n    };\n\n    trailAnimationId = requestAnimationFrame(loop);\n  }\n\n  function stopTrailLoop(): void {\n    if (trailAnimationId) {\n      cancelAnimationFrame(trailAnimationId);\n      trailAnimationId = null;\n    }\n    if (trailCtx && gridWidth > 0) {\n      trailCtx.clearRect(0, 0, gridWidth, containerHeight);\n    }\n  }\n\n  // Handle container resize\n  $effect(() => {\n    if (!container) return;\n\n    const resizeObserver = new ResizeObserver((entries) => {\n      for (const entry of entries) {\n        containerWidth = entry.contentRect.width;\n        containerHeight = entry.contentRect.height;\n      }\n    });\n\n    resizeObserver.observe(container);\n\n    return () => {\n      resizeObserver.disconnect();\n    };\n  });\n\n  $effect(() => {\n    void gridWidth;\n    void containerHeight;\n    void gridOffsetX;\n    void trailCanvas;\n    setupTrailCanvas();\n  });\n\n  $effect(() => {\n    void mode;\n    void trailCtx;\n    // Run trail loop for both stationary and highway modes\n    if (mode === 'singing' || mode === 'highway') {\n      startTrailLoop();\n    } else {\n      stopTrailLoop();\n    }\n  });\n\n  onDestroy(() => {\n    stopTrailLoop();\n  });\n</script>\n\n<div class=\"singing-canvas-container\" bind:this={container}>\n  <PitchGrid\n    {mode}\n    {fullRowData}\n    {viewport}\n    cellWidth={cellWidth}\n    cellHeight={viewportWindow.cellHeight}\n    colorMode=\"color\"\n    {showOctaveLabels}\n    {showFrequencyLabels}\n    {showRightLegend}\n    {singingConfig}\n    {highwayConfig}\n    legendHighlight={legendHighlight}\n    {beatIntervalMs}\n    {beatTimeOffsetMs}\n  />\n  <canvas\n    bind:this={trailCanvas}\n    class=\"pitch-trail-canvas\"\n  ></canvas>\n</div>\n\n<style>\n  .singing-canvas-container {\n    flex: 1;\n    width: 100%;\n    min-height: 300px;\n    position: relative;\n    background-color: var(--color-bg-light);\n    /* Subtle white overlay to make grid bounds more visible */\n    background-image: linear-gradient(rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.02));\n    border-radius: var(--radius-md);\n    overflow: hidden;\n  }\n\n  .pitch-trail-canvas {\n    position: absolute;\n    top: 0;\n    pointer-events: none;\n    z-index: 2;\n  }\n</style>\n","/**\r\n * Reference Audio Service\r\n *\r\n * Plays sine wave reference tones for the demo exercise.\r\n */\r\n\r\nimport * as Tone from 'tone';\r\n\r\nclass ReferenceAudioService {\r\n  private synth: Tone.Synth | null = null;\r\n  private scheduledTimeouts: number[] = []; // Store timeout IDs for cleanup\r\n  private volume: Tone.Volume | null = null;\r\n  private startTime: number = 0; // Performance.now() when playback started\r\n  private _isPlaying: boolean = false; // Track if a reference tone is currently playing\r\n\r\n  /**\r\n   * Check if a reference tone is currently playing\r\n   */\r\n  get isPlaying(): boolean {\r\n    return this._isPlaying;\r\n  }\r\n\r\n  /**\r\n   * Initialize the audio service\r\n   */\r\n  async init(): Promise<void> {\r\n    await Tone.start();\r\n\r\n    // Create volume node\r\n    this.volume = new Tone.Volume(-12).toDestination();\r\n\r\n    // Create synth with triangle wave (less likely to be picked up by mic as same frequency)\r\n    this.synth = new Tone.Synth({\r\n      oscillator: { type: 'triangle' },\r\n      envelope: {\r\n        attack: 0.05,\r\n        decay: 0.1,\r\n        sustain: 0.9,\r\n        release: 0.1,\r\n      },\r\n    }).connect(this.volume);\r\n  }\r\n\r\n  /**\r\n   * Set reference tone volume\r\n   */\r\n  setVolume(dB: number): void {\r\n    if (this.volume) {\r\n      this.volume.volume.value = dB;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Schedule all reference tones for the exercise\r\n   * Uses setTimeout for precise timing aligned with the highway animation\r\n   */\r\n  scheduleReferenceTones(\r\n    notes: Array<{ midi: number; startTimeMs: number; durationMs: number }>\r\n  ): void {\r\n    if (!this.synth) {\r\n      console.warn('[ReferenceAudio] Synth not initialized');\r\n      return;\r\n    }\r\n\r\n    // Clear any existing scheduled notes\r\n    this.clearScheduled();\r\n\r\n    // Record start time for synchronization\r\n    this.startTime = performance.now();\r\n\r\n    notes.forEach((note) => {\r\n      const duration = note.durationMs / 1000;\r\n      const frequency = Tone.Frequency(note.midi, 'midi').toFrequency();\r\n\r\n      // Schedule the note start\r\n      const startTimeoutId = window.setTimeout(() => {\r\n        if (this.synth) {\r\n          console.log(`[ReferenceAudio] Playing ${note.midi} at ${performance.now() - this.startTime}ms`);\r\n          this._isPlaying = true;\r\n          this.synth.triggerAttackRelease(frequency, duration);\r\n        }\r\n      }, note.startTimeMs);\r\n\r\n      // Schedule the note end (to clear isPlaying flag)\r\n      const endTimeoutId = window.setTimeout(() => {\r\n        this._isPlaying = false;\r\n      }, note.startTimeMs + note.durationMs);\r\n\r\n      this.scheduledTimeouts.push(startTimeoutId, endTimeoutId);\r\n    });\r\n\r\n    console.log(`[ReferenceAudio] Scheduled ${notes.length} reference tones`);\r\n  }\r\n\r\n  /**\r\n   * Play a single reference tone immediately\r\n   */\r\n  playTone(midi: number, durationMs: number): void {\r\n    if (!this.synth) {\r\n      console.warn('[ReferenceAudio] Synth not initialized');\r\n      return;\r\n    }\r\n\r\n    const frequency = Tone.Frequency(midi, 'midi').toFrequency();\r\n    const duration = durationMs / 1000;\r\n    this.synth.triggerAttackRelease(frequency, duration);\r\n  }\r\n\r\n  /**\r\n   * Clear all scheduled notes\r\n   */\r\n  clearScheduled(): void {\r\n    this.scheduledTimeouts.forEach((timeoutId) => {\r\n      window.clearTimeout(timeoutId);\r\n    });\r\n    this.scheduledTimeouts = [];\r\n  }\r\n\r\n  /**\r\n   * Stop all audio\r\n   */\r\n  stop(): void {\r\n    this.clearScheduled();\r\n    if (this.synth) {\r\n      this.synth.triggerRelease();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Dispose of audio resources\r\n   */\r\n  dispose(): void {\r\n    this.stop();\r\n    if (this.synth) {\r\n      this.synth.dispose();\r\n      this.synth = null;\r\n    }\r\n    if (this.volume) {\r\n      this.volume.dispose();\r\n      this.volume = null;\r\n    }\r\n  }\r\n}\r\n\r\n// Singleton instance\r\nexport const referenceAudio = new ReferenceAudioService();\r\n","/**\n * Pitch Detection Service\n *\n * Uses Pitchy.js for real-time pitch detection from microphone input.\n * Ported from the original JavaScript implementation.\n */\n\nimport * as Tone from 'tone';\nimport { PitchDetector } from 'pitchy';\nimport { getCentsOffset, getNearestMidi, midiToPitchClass } from '@mlt/pitch-utils';\nimport { pitchState, type DetectedPitch } from '../stores/pitchState.svelte.js';\nimport { highwayState } from '../stores/highwayState.svelte.js';\nimport { referenceAudio } from './referenceAudio.js';\n\n// Configuration\nconst CONFIG = {\n  FFT_SIZE: 2048,\n  CLARITY_THRESHOLD: 0.8,\n  MIN_PITCH_HZ: 60,\n  MAX_PITCH_HZ: 1600,\n  HIGHLIGHT_CENTS_RANGE: 50,\n  MIN_VOLUME_DB: -60,\n} as const;\n\n// Module state\nlet mic: Tone.UserMedia | null = null;\nlet analyser: Tone.Analyser | null = null;\nlet detector: ReturnType<typeof PitchDetector.forFloat32Array> | null = null;\nlet animationFrameId: number | null = null;\nlet isRunning = false;\n\nconst HIGHLIGHT_DEFAULT_SIZE = 1.0;\n\n/**\n * Convert frequency in Hz to MIDI note number\n */\nfunction frequencyToMidi(frequency: number): number {\n  return 12 * Math.log2(frequency / 440) + 69;\n}\n\n/**\n * The main detection and animation loop\n */\nfunction animationLoop(): void {\n  if (!isRunning || !analyser || !detector) {\n    animationFrameId = null;\n    return;\n  }\n\n  // Skip pitch detection while reference tone is playing (avoid mic picking up speakers)\n  if (referenceAudio.isPlaying) {\n    // Still add a silent history point to keep the trail continuous\n    pitchState.addHistoryPoint({\n      frequency: 0,\n      midi: 0,\n      time: performance.now(),\n      clarity: 0,\n    });\n    animationFrameId = requestAnimationFrame(animationLoop);\n    return;\n  }\n\n  // Get pitch from audio\n  const waveform = analyser.getValue() as Float32Array;\n  const [pitch, clarity] = detector.findPitch(waveform, Tone.getContext().sampleRate);\n\n  const isValidPitch =\n    pitch !== null &&\n    clarity > CONFIG.CLARITY_THRESHOLD &&\n    pitch > CONFIG.MIN_PITCH_HZ &&\n    pitch < CONFIG.MAX_PITCH_HZ;\n\n  // Update pitch state\n  if (isValidPitch) {\n    const midi = frequencyToMidi(pitch);\n    const detectedPitch: DetectedPitch = {\n      frequency: pitch,\n      midi,\n      clarity,\n      pitchClass: Math.round(midi) % 12,\n    };\n    pitchState.setCurrentPitch(detectedPitch);\n    pitchState.addHistoryPoint({\n      frequency: pitch,\n      midi,\n      time: performance.now(),\n      clarity,\n    });\n\n    // Record pitch input for highway performance tracking\n    highwayState.recordPitchInput(midi, clarity);\n  } else {\n    pitchState.addHistoryPoint({\n      frequency: 0,\n      midi: 0,\n      time: performance.now(),\n      clarity: 0,\n    });\n  }\n\n  // Highlight opacity based on cents deviation from nearest pitch\n  if (isValidPitch && pitchState.state.currentPitch) {\n    const midi = pitchState.state.currentPitch.midi;\n    const nearestMidi = getNearestMidi(midi);\n    const centsOffset = getCentsOffset(midi);\n    const centsDistance = Math.min(Math.abs(centsOffset), CONFIG.HIGHLIGHT_CENTS_RANGE);\n    const opacity = Math.max(0, 1 - (centsDistance / CONFIG.HIGHLIGHT_CENTS_RANGE));\n\n    pitchState.setStablePitch({\n      pitchClass: midiToPitchClass(nearestMidi),\n      opacity,\n      size: HIGHLIGHT_DEFAULT_SIZE,\n    });\n  } else {\n    pitchState.setStablePitch({ pitchClass: null, opacity: 0, size: HIGHLIGHT_DEFAULT_SIZE });\n  }\n\n  // Request next frame\n  animationFrameId = requestAnimationFrame(animationLoop);\n}\n\n/**\n * Start pitch detection from microphone\n */\nexport async function startDetection(): Promise<void> {\n  if (isRunning) return;\n\n  // Cancel any existing animation frame\n  if (animationFrameId !== null) {\n    cancelAnimationFrame(animationFrameId);\n  }\n\n  // Create audio nodes\n  mic = new Tone.UserMedia();\n  analyser = new Tone.Analyser('waveform', CONFIG.FFT_SIZE);\n  detector = PitchDetector.forFloat32Array(analyser.size);\n\n  try {\n    await Tone.start(); // Initialize audio context\n    await mic.open();\n    mic.connect(analyser);\n    isRunning = true;\n    animationLoop();\n  } catch (err) {\n    console.error('Microphone access denied or failed:', err);\n    cleanup();\n    throw err;\n  }\n}\n\n/**\n * Stop pitch detection\n */\nexport function stopDetection(): void {\n  isRunning = false;\n  cleanup();\n}\n\n/**\n * Clean up audio resources\n */\nfunction cleanup(): void {\n  if (animationFrameId !== null) {\n    cancelAnimationFrame(animationFrameId);\n    animationFrameId = null;\n  }\n\n  if (mic) {\n    mic.close();\n    mic = null;\n  }\n\n  analyser = null;\n  detector = null;\n\n  pitchState.setStablePitch({ pitchClass: null, opacity: 0, size: HIGHLIGHT_DEFAULT_SIZE });\n  pitchState.setCurrentPitch(null);\n}\n\n/**\n * Check if detection is currently running\n */\nexport function isDetecting(): boolean {\n  return isRunning;\n}\n","/**\n * Drone Audio Service\n *\n * Provides a sustained drone tone using Tone.js for pitch reference.\n */\n\nimport * as Tone from 'tone';\nimport { appState } from '../stores/appState.svelte.js';\n\n// Module state\nlet synth: Tone.PolySynth | null = null;\nlet isPlaying = false;\nlet currentNote: string | null = null;\n\n// Note name mapping\nconst NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];\n\n/**\n * Initialize the drone synth\n */\nfunction ensureSynth(): Tone.PolySynth {\n  if (!synth) {\n    synth = new Tone.PolySynth(Tone.Synth, {\n      oscillator: { type: 'sawtooth' },\n      envelope: {\n        attack: 0.3,\n        decay: 0.1,\n        sustain: 0.8,\n        release: 0.5,\n      },\n    }).toDestination();\n    const oscillatorType = synth.get().oscillator?.type ?? 'unknown';\n    console.log('[DroneAudio] Initialized drone synth', { oscillatorType });\n  }\n  return synth;\n}\n\n/**\n * Get the note name with octave from tonic and octave\n */\nfunction getNoteName(tonic: string, octave: number): string {\n  // Normalize tonic (handle flats)\n  const normalizedTonic = tonic.replace('b', '#').replace('Db', 'C#').replace('Eb', 'D#')\n    .replace('Gb', 'F#').replace('Ab', 'G#').replace('Bb', 'A#');\n  return `${normalizedTonic}${octave}`;\n}\n\n/**\n * Start playing the drone\n */\nexport async function startDrone(): Promise<void> {\n  // Ensure audio context is started (required for browsers)\n  await Tone.start();\n\n  const s = ensureSynth();\n  const note = getNoteName(appState.state.tonic, appState.state.drone.octave);\n\n  // Set volume (convert from dB scale used in app to Tone.js scale)\n  s.volume.value = appState.state.drone.volume;\n  console.log('[DroneAudio] Starting drone', {\n    note,\n    volume: s.volume.value,\n  });\n\n  // Release any current note before starting new one\n  if (currentNote) {\n    s.releaseAll();\n  }\n\n  currentNote = note;\n  s.triggerAttack(note);\n  isPlaying = true;\n}\n\n/**\n * Stop the drone\n */\nexport function stopDrone(): void {\n  if (synth && isPlaying) {\n    synth.releaseAll();\n    currentNote = null;\n    isPlaying = false;\n  }\n}\n\n/**\n * Update drone parameters (tonic, octave, volume)\n */\nexport function updateDrone(): void {\n  if (!isPlaying || !synth) return;\n\n  const newNote = getNoteName(appState.state.tonic, appState.state.drone.octave);\n  synth.volume.value = appState.state.drone.volume;\n  console.log('[DroneAudio] Updating drone', {\n    note: newNote,\n    volume: synth.volume.value,\n  });\n\n  if (newNote !== currentNote) {\n    synth.releaseAll();\n    synth.triggerAttack(newNote);\n    currentNote = newNote;\n  }\n}\n\n/**\n * Toggle drone on/off\n */\nexport async function toggleDrone(): Promise<void> {\n  if (isPlaying) {\n    stopDrone();\n  } else {\n    await startDrone();\n  }\n}\n\n/**\n * Check if drone is playing\n */\nexport function isDronePlaying(): boolean {\n  return isPlaying;\n}\n\n/**\n * Clean up resources\n */\nexport function dispose(): void {\n  stopDrone();\n  if (synth) {\n    synth.dispose();\n    synth = null;\n  }\n}\n","<script lang=\"ts\">\n  /**\n   * TonicSelector Component\n   *\n   * Dropdown for selecting the tonic/key center.\n   */\n\n  import { appState, type TonicNote } from '../../stores/appState.svelte.js';\n  import { updateDrone } from '../../services/droneAudio.js';\n\n  const TONIC_OPTIONS: TonicNote[] = [\n    'C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'\n  ];\n\n  function handleChange(event: Event) {\n    const target = event.target as HTMLSelectElement;\n    appState.setTonic(target.value as TonicNote);\n    updateDrone();\n  }\n</script>\n\n<div class=\"tonic-selector\">\n  <label for=\"tonic-select\">Key:</label>\n  <select\n    id=\"tonic-select\"\n    value={appState.state.tonic}\n    onchange={handleChange}\n  >\n    {#each TONIC_OPTIONS as tonic}\n      <option value={tonic}>{tonic}</option>\n    {/each}\n  </select>\n</div>\n\n<style>\n  .tonic-selector {\n    display: flex;\n    align-items: center;\n    gap: var(--spacing-sm);\n  }\n\n  label {\n    font-weight: 500;\n    color: var(--color-text-muted);\n  }\n\n  select {\n    padding: var(--spacing-sm) var(--spacing-md);\n    font-size: var(--font-size-base);\n    color: var(--color-text);\n    background-color: var(--color-surface);\n    border: 1px solid rgba(255, 255, 255, 0.1);\n    border-radius: var(--radius-sm);\n    cursor: pointer;\n    min-width: 70px;\n  }\n\n  select:hover {\n    border-color: var(--color-secondary);\n  }\n\n  select:focus {\n    outline: none;\n    border-color: var(--color-secondary);\n    box-shadow: 0 0 0 2px rgba(0, 217, 255, 0.2);\n  }\n</style>\n","<script lang=\"ts\">\n  /**\n   * DroneControls Component\n   *\n   * Controls for the drone reference tone.\n   */\n\n  import { appState } from '../../stores/appState.svelte.js';\n  import { toggleDrone, updateDrone } from '../../services/droneAudio.js';\n\n  const OCTAVE_OPTIONS = [2, 3, 4, 5];\n\n  async function handleToggle() {\n    await toggleDrone();\n    appState.toggleDrone();\n  }\n\n  function handleOctaveChange(event: Event) {\n    const target = event.target as HTMLSelectElement;\n    appState.setDroneOctave(parseInt(target.value, 10));\n    updateDrone();\n  }\n\n  function handleVolumeChange(event: Event) {\n    const target = event.target as HTMLInputElement;\n    appState.setDroneVolume(parseInt(target.value, 10));\n    updateDrone();\n  }\n</script>\n\n<div class=\"drone-controls\">\n  <button\n    class=\"drone-toggle\"\n    class:active={appState.state.drone.isPlaying}\n    onclick={handleToggle}\n  >\n    {appState.state.drone.isPlaying ? 'Drone On' : 'Drone Off'}\n  </button>\n\n  <div class=\"drone-settings\">\n    <label>\n      Oct:\n      <select value={appState.state.drone.octave} onchange={handleOctaveChange}>\n        {#each OCTAVE_OPTIONS as oct}\n          <option value={oct}>{oct}</option>\n        {/each}\n      </select>\n    </label>\n\n    <label>\n      Vol:\n      <input\n        type=\"range\"\n        min=\"-40\"\n        max=\"0\"\n        value={appState.state.drone.volume}\n        oninput={handleVolumeChange}\n      />\n    </label>\n  </div>\n</div>\n\n<style>\n  .drone-controls {\n    display: flex;\n    align-items: center;\n    gap: var(--spacing-md);\n  }\n\n  .drone-toggle {\n    padding: var(--spacing-sm) var(--spacing-md);\n    font-size: var(--font-size-sm);\n    font-weight: 500;\n    color: var(--color-text);\n    background-color: var(--color-surface);\n    border: 1px solid rgba(255, 255, 255, 0.1);\n    border-radius: var(--radius-sm);\n    transition: all 0.2s ease;\n  }\n\n  .drone-toggle:hover {\n    border-color: var(--color-secondary);\n  }\n\n  .drone-toggle.active {\n    background-color: var(--color-secondary);\n    color: var(--color-bg);\n    border-color: var(--color-secondary);\n  }\n\n  .drone-settings {\n    display: flex;\n    align-items: center;\n    gap: var(--spacing-md);\n  }\n\n  label {\n    display: flex;\n    align-items: center;\n    gap: var(--spacing-xs);\n    font-size: var(--font-size-sm);\n    color: var(--color-text-muted);\n  }\n\n  select {\n    padding: var(--spacing-xs) var(--spacing-sm);\n    font-size: var(--font-size-sm);\n    color: var(--color-text);\n    background-color: var(--color-surface);\n    border: 1px solid rgba(255, 255, 255, 0.1);\n    border-radius: var(--radius-sm);\n    cursor: pointer;\n  }\n\n  input[type='range'] {\n    width: 80px;\n    height: 4px;\n    cursor: pointer;\n  }\n</style>\n","<script lang=\"ts\">\n\t/**\n\t * RangeControl Component\n\t *\n\t * Wrapper for DualPitchWheel that integrates with singing-trainer app state.\n\t * Converts between MIDI values (used in app state) and indices (used by wheels).\n\t */\n\timport { DualPitchWheel } from '@mlt/ui-components/pitch-wheels';\n\timport type { PitchWheelRange } from '@mlt/ui-components/pitch-wheels';\n\timport { fullRowData } from '@mlt/pitch-data';\n\timport { appState } from '../../stores/appState.svelte';\n\n\t// Convert MIDI to index in fullRowData\n\tfunction midiToIndex(midi: number): number {\n\t\tconst index = fullRowData.findIndex((p) => p.midi === midi);\n\t\treturn index >= 0 ? index : 0;\n\t}\n\n\t// Current indices derived from app state\n\tconst topIndex = $derived(midiToIndex(appState.state.yAxisRange.maxMidi));\n\tconst bottomIndex = $derived(midiToIndex(appState.state.yAxisRange.minMidi));\n\n\t// Handle range change from wheels\n\tfunction handleRangeChange(range: PitchWheelRange) {\n\t\tconst minMidi = range.bottomPitch.midi ?? 21;\n\t\tconst maxMidi = range.topPitch.midi ?? 108;\n\t\tappState.setYAxisRange({ minMidi, maxMidi });\n\t}\n</script>\n\n<div class=\"range-control\">\n\t<h3 class=\"control-title\">Pitch Range</h3>\n\t<DualPitchWheel\n\t\t{fullRowData}\n\t\t{topIndex}\n\t\t{bottomIndex}\n\t\tminSpan={7}\n\t\tonrangechange={handleRangeChange}\n\t\tshowSummary={true}\n\t\twheelHeight={200}\n\t/>\n</div>\n\n<style>\n\t.range-control {\n\t\tdisplay: flex;\n\t\tflex-direction: column;\n\t\tgap: 12px;\n\t\tpadding: 16px;\n\t\tbackground: rgba(255, 255, 255, 0.05);\n\t\tborder-radius: 12px;\n\t}\n\n\t.control-title {\n\t\tmargin: 0;\n\t\tfont-size: 0.85rem;\n\t\tfont-weight: 600;\n\t\tcolor: rgba(255, 255, 255, 0.9);\n\t\ttext-align: center;\n\t\tletter-spacing: 0.5px;\n\t}\n</style>\n","<script lang=\"ts\">\n  /**\n   * PitchHighlightToggle Component\n   *\n   * Toggles the yellow pitch highlight overlay.\n   */\n\n  import { appState } from '../../stores/appState.svelte.js';\n\n  function handleToggle() {\n    appState.togglePitchHighlight();\n  }\n</script>\n\n<div class=\"pitch-highlight-toggle\">\n  <span class=\"toggle-label\">Pitch Highlight</span>\n  <button\n    class=\"toggle-button\"\n    class:active={appState.state.pitchHighlightEnabled}\n    onclick={handleToggle}\n  >\n    {appState.state.pitchHighlightEnabled ? 'On' : 'Off'}\n  </button>\n</div>\n\n<style>\n  .pitch-highlight-toggle {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    gap: var(--spacing-sm);\n  }\n\n  .toggle-label {\n    font-size: var(--font-size-sm);\n    color: var(--color-text-muted);\n  }\n\n  .toggle-button {\n    padding: var(--spacing-xs) var(--spacing-md);\n    font-size: var(--font-size-sm);\n    font-weight: 500;\n    color: var(--color-text);\n    background-color: var(--color-surface);\n    border: 1px solid rgba(255, 255, 255, 0.1);\n    border-radius: var(--radius-sm);\n    transition: all 0.2s ease;\n    min-width: 64px;\n  }\n\n  .toggle-button:hover {\n    border-color: var(--color-secondary);\n  }\n\n  .toggle-button.active {\n    background-color: var(--color-secondary);\n    color: var(--color-bg);\n    border-color: var(--color-secondary);\n  }\n</style>\n","<script lang=\"ts\">\r\n  /**\r\n   * Demo Exercise Controls Component\r\n   *\r\n   * UI for starting/stopping the pitch-matching demo exercise.\r\n   */\r\n\r\n  import { demoExerciseState } from '../../stores/demoExerciseState.svelte.js';\r\n  import { highwayState } from '../../stores/highwayState.svelte.js';\r\n  import { appState } from '../../stores/appState.svelte.js';\r\n  import { referenceAudio } from '../../services/referenceAudio.js';\r\n  import { getPitchByMidi } from '@mlt/pitch-data';\r\n  import { onDestroy } from 'svelte';\r\n\r\n  // Local state for settings panel\r\n  let showSettings = $state(false);\r\n  let numLoops = $state(5);\r\n  let tempo = $state(108);\r\n  let referenceVolume = $state(-12);\r\n\r\n  // Reactive state from stores\r\n  const isActive = $derived(demoExerciseState.state.isActive);\r\n  const isPlaying = $derived(demoExerciseState.state.isPlaying);\r\n  const currentPhase = $derived(demoExerciseState.state.currentPhase);\r\n  const progress = $derived(demoExerciseState.getCurrentProgress());\r\n  const results = $derived(demoExerciseState.getResults());\r\n  const hasResults = $derived(results.length > 0);\r\n\r\n  // Calculate stats from results\r\n  const averageAccuracy = $derived(demoExerciseState.getAverageAccuracy());\r\n  const hitCount = $derived(demoExerciseState.getHitCount());\r\n  const totalCount = $derived(results.length);\r\n\r\n  /**\r\n   * Track phase based on highway currentTimeMs\r\n   */\r\n  $effect(() => {\r\n    if (!isActive || !isPlaying) return;\r\n\r\n    const currentTimeMs = highwayState.state.currentTimeMs;\r\n    demoExerciseState.updatePhase(currentTimeMs);\r\n  });\r\n\r\n  /**\r\n   * Collect results from highway performance data\r\n   */\r\n  $effect(() => {\r\n    if (!isActive) return;\r\n\r\n    const performances = highwayState.getPerformanceResults();\r\n    const notes = demoExerciseState.getGeneratedNotes();\r\n\r\n    // Check each input note for completion\r\n    notes.forEach((note, index) => {\r\n      if (note.lyric !== 'ðŸŽ¤') return; // Only process input notes\r\n\r\n      const noteId = `target-${index}`;\r\n      const perf = performances.get(noteId);\r\n\r\n      if (perf && !demoExerciseState.hasResultForLoop(Math.floor(index / 2))) {\r\n        // Calculate accuracy percentage from performance data\r\n        const accuracy = calculateAccuracy(perf);\r\n\r\n        demoExerciseState.addResult({\r\n          loopIndex: Math.floor(index / 2),\r\n          targetPitch: note.midi,\r\n          accuracy,\r\n          performance: perf,\r\n        });\r\n      }\r\n    });\r\n  });\r\n\r\n  /**\r\n   * Calculate accuracy percentage from performance data\r\n   */\r\n  function calculateAccuracy(perf: any): number {\r\n    // Simple accuracy: 100% if hit, based on pitch accuracy if available\r\n    if (perf.hitStatus === 'hit') {\r\n      // If we have pitch accuracy data, use it\r\n      if (perf.pitchAccuracyCents !== undefined) {\r\n        const maxCents = 50; // Tolerance from config\r\n        const accuracy = Math.max(0, 100 - (Math.abs(perf.pitchAccuracyCents) / maxCents) * 100);\r\n        return accuracy;\r\n      }\r\n      return 100;\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  /**\r\n   * Cleanup on component destroy\r\n   */\r\n  onDestroy(() => {\r\n    if (isActive) {\r\n      handleStop();\r\n    }\r\n  });\r\n\r\n  /**\r\n   * Use current Y-axis range for pitch range\r\n   */\r\n  function useCurrentRange() {\r\n    const range = appState.state.yAxisRange;\r\n    demoExerciseState.setPitchRange(range.minMidi, range.maxMidi);\r\n  }\r\n\r\n  /**\r\n   * Use full piano range\r\n   */\r\n  function useFullRange() {\r\n    demoExerciseState.setPitchRange(21, 108); // A0 to C8\r\n  }\r\n\r\n  /**\r\n   * Start the demo exercise\r\n   */\r\n  async function handleStart() {\r\n    // Auto-switch to highway mode\r\n    appState.setVisualizationMode('highway');\r\n\r\n    // Update configuration\r\n    demoExerciseState.configure({\r\n      numLoops,\r\n      tempo,\r\n      referenceVolume,\r\n    });\r\n\r\n    // Set pitch range to current Y-axis range\r\n    useCurrentRange();\r\n\r\n    // Initialize reference audio\r\n    await referenceAudio.init();\r\n    referenceAudio.setVolume(referenceVolume);\r\n\r\n    // Start exercise (generates notes)\r\n    demoExerciseState.start();\r\n\r\n    const notes = demoExerciseState.getGeneratedNotes();\r\n\r\n    // Set highway state with generated notes\r\n    highwayState.setTargetNotes(notes);\r\n\r\n    // Start highway playback\r\n    highwayState.start();\r\n    demoExerciseState.setPlaying(true);\r\n\r\n    // Schedule reference tones (only the reference notes, not input notes)\r\n    const referenceTones = notes.filter(n => n.lyric === 'ðŸ‘‚');\r\n    referenceAudio.scheduleReferenceTones(referenceTones);\r\n  }\r\n\r\n  /**\r\n   * Stop the demo exercise\r\n   */\r\n  function handleStop() {\r\n    // Stop audio\r\n    referenceAudio.stop();\r\n\r\n    // Stop highway\r\n    highwayState.stop();\r\n\r\n    // Mark exercise as stopped\r\n    demoExerciseState.stop();\r\n  }\r\n\r\n  /**\r\n   * Get phase label for display\r\n   */\r\n  function getPhaseLabel(phase: string): string {\r\n    switch (phase) {\r\n      case 'reference':\r\n        return 'ðŸ‘‚ Listen';\r\n      case 'input':\r\n        return 'ðŸŽ¤ Sing';\r\n      default:\r\n        return 'Rest';\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get pitch name from MIDI number\r\n   */\r\n  function getPitchName(midi: number): string {\r\n    const pitch = getPitchByMidi(midi);\r\n    return pitch?.combined || `MIDI ${midi}`;\r\n  }\r\n</script>\r\n\r\n<div class=\"demo-exercise-panel\">\r\n  <h3 class=\"panel-title\">Demo Exercise</h3>\r\n\r\n  <!-- Settings (collapsed by default) -->\r\n  <details class=\"settings-details\" bind:open={showSettings}>\r\n    <summary class=\"settings-summary\">Settings</summary>\r\n    <div class=\"exercise-settings\">\r\n      <label class=\"setting-label\">\r\n        <span class=\"label-text\">Number of loops:</span>\r\n        <input\r\n          class=\"setting-input\"\r\n          type=\"number\"\r\n          min=\"1\"\r\n          max=\"20\"\r\n          bind:value={numLoops}\r\n          disabled={isActive}\r\n        />\r\n      </label>\r\n\r\n      <label class=\"setting-label\">\r\n        <span class=\"label-text\">Tempo (BPM):</span>\r\n        <input\r\n          class=\"setting-input\"\r\n          type=\"number\"\r\n          min=\"60\"\r\n          max=\"180\"\r\n          bind:value={tempo}\r\n          disabled={isActive}\r\n        />\r\n      </label>\r\n\r\n      <label class=\"setting-label\">\r\n        <span class=\"label-text\">Reference Volume:</span>\r\n        <input\r\n          class=\"setting-slider\"\r\n          type=\"range\"\r\n          min=\"-40\"\r\n          max=\"0\"\r\n          bind:value={referenceVolume}\r\n          disabled={isActive}\r\n        />\r\n        <span class=\"volume-value\">{referenceVolume} dB</span>\r\n      </label>\r\n\r\n      <div class=\"pitch-range-buttons\">\r\n        <button class=\"range-btn\" onclick={useCurrentRange} disabled={isActive}>\r\n          Use Current Range\r\n        </button>\r\n        <button class=\"range-btn\" onclick={useFullRange} disabled={isActive}>\r\n          Use Full Range\r\n        </button>\r\n      </div>\r\n    </div>\r\n  </details>\r\n\r\n  <!-- Main Controls -->\r\n  <div class=\"exercise-controls\">\r\n    {#if !isActive}\r\n      <button class=\"start-exercise-btn\" onclick={handleStart}>\r\n        Start Demo Exercise\r\n      </button>\r\n    {:else}\r\n      <button class=\"stop-exercise-btn\" onclick={handleStop}>\r\n        Stop Exercise\r\n      </button>\r\n\r\n      <div class=\"progress-indicator\">\r\n        Loop {progress.current} / {progress.total}\r\n      </div>\r\n\r\n      <div class=\"phase-indicator\">\r\n        {getPhaseLabel(currentPhase)}\r\n      </div>\r\n    {/if}\r\n  </div>\r\n\r\n  <!-- Results Display (after completion) -->\r\n  {#if hasResults && !isActive}\r\n    <div class=\"exercise-results\">\r\n      <h4 class=\"results-title\">Results</h4>\r\n      <div class=\"results-summary\">\r\n        <div class=\"stat\">\r\n          <span class=\"stat-label\">Average Accuracy:</span>\r\n          <span class=\"stat-value\">{averageAccuracy.toFixed(1)}%</span>\r\n        </div>\r\n        <div class=\"stat\">\r\n          <span class=\"stat-label\">Hits:</span>\r\n          <span class=\"stat-value\">{hitCount}/{totalCount}</span>\r\n        </div>\r\n      </div>\r\n\r\n      <details class=\"results-details\">\r\n        <summary class=\"results-summary-label\">Detailed Results</summary>\r\n        <div class=\"results-list\">\r\n          {#each results as result, i}\r\n            <div class=\"result-item\" class:hit={result.performance?.hitStatus === 'hit'}>\r\n              <span class=\"result-loop\">Loop {i + 1}:</span>\r\n              <span class=\"result-pitch\">{getPitchName(result.targetPitch)}</span>\r\n              <span class=\"result-accuracy\">{result.accuracy.toFixed(0)}%</span>\r\n              <span class=\"result-status\">\r\n                {result.performance?.hitStatus === 'hit' ? 'âœ“' : 'âœ—'}\r\n              </span>\r\n            </div>\r\n          {/each}\r\n        </div>\r\n      </details>\r\n    </div>\r\n  {/if}\r\n</div>\r\n\r\n<style>\r\n  .demo-exercise-panel {\r\n    display: flex;\r\n    flex-direction: column;\r\n    gap: var(--spacing-md);\r\n  }\r\n\r\n  .panel-title {\r\n    font-size: var(--font-size-sm);\r\n    font-weight: 600;\r\n    color: var(--color-text-muted);\r\n    text-transform: uppercase;\r\n    letter-spacing: 0.05em;\r\n    margin: 0;\r\n  }\r\n\r\n  /* Settings */\r\n  .settings-details {\r\n    background-color: var(--color-surface);\r\n    border-radius: var(--radius-sm);\r\n    padding: var(--spacing-xs);\r\n  }\r\n\r\n  .settings-summary {\r\n    cursor: pointer;\r\n    font-size: var(--font-size-sm);\r\n    font-weight: 500;\r\n    padding: var(--spacing-xs);\r\n    user-select: none;\r\n  }\r\n\r\n  .settings-summary:hover {\r\n    color: var(--color-primary);\r\n  }\r\n\r\n  .exercise-settings {\r\n    display: flex;\r\n    flex-direction: column;\r\n    gap: var(--spacing-sm);\r\n    padding: var(--spacing-sm);\r\n    padding-top: 0;\r\n  }\r\n\r\n  .setting-label {\r\n    display: flex;\r\n    flex-direction: column;\r\n    gap: var(--spacing-xs);\r\n    font-size: var(--font-size-sm);\r\n  }\r\n\r\n  .label-text {\r\n    color: var(--color-text-muted);\r\n    font-weight: 500;\r\n  }\r\n\r\n  .setting-input {\r\n    padding: var(--spacing-xs) var(--spacing-sm);\r\n    border: 1px solid rgba(255, 255, 255, 0.1);\r\n    border-radius: var(--radius-sm);\r\n    background-color: var(--color-bg);\r\n    color: var(--color-text);\r\n    font-size: var(--font-size-sm);\r\n    width: 100%;\r\n  }\r\n\r\n  .setting-input:disabled {\r\n    opacity: 0.5;\r\n    cursor: not-allowed;\r\n  }\r\n\r\n  .setting-slider {\r\n    width: 100%;\r\n    accent-color: var(--color-primary);\r\n  }\r\n\r\n  .volume-value {\r\n    font-size: var(--font-size-xs);\r\n    color: var(--color-text-muted);\r\n  }\r\n\r\n  .pitch-range-buttons {\r\n    display: flex;\r\n    gap: var(--spacing-xs);\r\n  }\r\n\r\n  .range-btn {\r\n    flex: 1;\r\n    padding: var(--spacing-xs) var(--spacing-sm);\r\n    font-size: var(--font-size-xs);\r\n    font-weight: 500;\r\n    background-color: var(--color-bg);\r\n    color: var(--color-text);\r\n    border: 1px solid rgba(255, 255, 255, 0.1);\r\n    border-radius: var(--radius-sm);\r\n    cursor: pointer;\r\n    transition: all 0.2s ease;\r\n  }\r\n\r\n  .range-btn:hover:not(:disabled) {\r\n    background-color: var(--color-primary);\r\n    color: white;\r\n  }\r\n\r\n  .range-btn:disabled {\r\n    opacity: 0.5;\r\n    cursor: not-allowed;\r\n  }\r\n\r\n  /* Main Controls */\r\n  .exercise-controls {\r\n    display: flex;\r\n    flex-direction: column;\r\n    gap: var(--spacing-sm);\r\n  }\r\n\r\n  .start-exercise-btn {\r\n    padding: var(--spacing-md);\r\n    font-size: var(--font-size-md);\r\n    font-weight: 600;\r\n    background-color: var(--color-primary);\r\n    color: white;\r\n    border: none;\r\n    border-radius: var(--radius-md);\r\n    cursor: pointer;\r\n    transition: background-color 0.2s ease;\r\n  }\r\n\r\n  .start-exercise-btn:hover {\r\n    background-color: var(--color-primary-dark, #4a7bc8);\r\n  }\r\n\r\n  .stop-exercise-btn {\r\n    padding: var(--spacing-md);\r\n    font-size: var(--font-size-md);\r\n    font-weight: 600;\r\n    background-color: var(--color-error, #dc3545);\r\n    color: white;\r\n    border: none;\r\n    border-radius: var(--radius-md);\r\n    cursor: pointer;\r\n    transition: background-color 0.2s ease;\r\n  }\r\n\r\n  .stop-exercise-btn:hover {\r\n    background-color: #c82333;\r\n  }\r\n\r\n  .progress-indicator {\r\n    text-align: center;\r\n    font-size: var(--font-size-md);\r\n    font-weight: 600;\r\n    color: var(--color-text);\r\n  }\r\n\r\n  .phase-indicator {\r\n    text-align: center;\r\n    font-size: var(--font-size-lg);\r\n    font-weight: 500;\r\n    padding: var(--spacing-sm);\r\n    background-color: var(--color-surface);\r\n    border-radius: var(--radius-sm);\r\n    color: var(--color-text);\r\n  }\r\n\r\n  /* Results */\r\n  .exercise-results {\r\n    display: flex;\r\n    flex-direction: column;\r\n    gap: var(--spacing-sm);\r\n    background-color: var(--color-surface);\r\n    border-radius: var(--radius-sm);\r\n    padding: var(--spacing-md);\r\n  }\r\n\r\n  .results-title {\r\n    font-size: var(--font-size-sm);\r\n    font-weight: 600;\r\n    margin: 0;\r\n    color: var(--color-text);\r\n  }\r\n\r\n  .results-summary {\r\n    display: flex;\r\n    flex-direction: column;\r\n    gap: var(--spacing-xs);\r\n  }\r\n\r\n  .stat {\r\n    display: flex;\r\n    justify-content: space-between;\r\n    font-size: var(--font-size-sm);\r\n  }\r\n\r\n  .stat-label {\r\n    color: var(--color-text-muted);\r\n  }\r\n\r\n  .stat-value {\r\n    color: var(--color-text);\r\n    font-weight: 600;\r\n  }\r\n\r\n  .results-details {\r\n    margin-top: var(--spacing-xs);\r\n  }\r\n\r\n  .results-summary-label {\r\n    cursor: pointer;\r\n    font-size: var(--font-size-sm);\r\n    font-weight: 500;\r\n    padding: var(--spacing-xs);\r\n    user-select: none;\r\n  }\r\n\r\n  .results-summary-label:hover {\r\n    color: var(--color-primary);\r\n  }\r\n\r\n  .results-list {\r\n    display: flex;\r\n    flex-direction: column;\r\n    gap: var(--spacing-xs);\r\n    padding-top: var(--spacing-sm);\r\n  }\r\n\r\n  .result-item {\r\n    display: grid;\r\n    grid-template-columns: auto 1fr auto auto;\r\n    gap: var(--spacing-xs);\r\n    align-items: center;\r\n    padding: var(--spacing-xs);\r\n    background-color: var(--color-bg);\r\n    border-radius: var(--radius-sm);\r\n    font-size: var(--font-size-sm);\r\n  }\r\n\r\n  .result-item.hit {\r\n    border-left: 3px solid var(--color-success, #28a745);\r\n  }\r\n\r\n  .result-item:not(.hit) {\r\n    border-left: 3px solid var(--color-error, #dc3545);\r\n  }\r\n\r\n  .result-loop {\r\n    color: var(--color-text-muted);\r\n    font-weight: 500;\r\n  }\r\n\r\n  .result-pitch {\r\n    color: var(--color-text);\r\n    font-weight: 600;\r\n  }\r\n\r\n  .result-accuracy {\r\n    color: var(--color-text);\r\n  }\r\n\r\n  .result-status {\r\n    font-size: var(--font-size-md);\r\n    font-weight: bold;\r\n  }\r\n\r\n  .result-item.hit .result-status {\r\n    color: var(--color-success, #28a745);\r\n  }\r\n\r\n  .result-item:not(.hit) .result-status {\r\n    color: var(--color-error, #dc3545);\r\n  }\r\n</style>\r\n","<script lang=\"ts\">\n  /**\n   * PitchReadout Component\n   *\n   * Displays the current detected pitch information.\n   */\n\n  import { pitchState } from '../../stores/pitchState.svelte.js';\n\n  const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];\n\n  const currentNote = $derived(() => {\n    const pitch = pitchState.state.currentPitch;\n    if (!pitch) return null;\n\n    const noteName = NOTE_NAMES[pitch.pitchClass];\n    const octave = Math.floor(pitch.midi / 12) - 1;\n    const cents = Math.round((pitch.midi - Math.round(pitch.midi)) * 100);\n\n    return {\n      name: noteName,\n      octave,\n      frequency: pitch.frequency.toFixed(1),\n      cents,\n      clarity: Math.round(pitch.clarity * 100),\n    };\n  });\n</script>\n\n<div class=\"pitch-readout\">\n  {#if currentNote()}\n    {@const note = currentNote()!}\n    <div class=\"note-display\">\n      <span class=\"note-name\">{note.name}</span>\n      <span class=\"octave\">{note.octave}</span>\n    </div>\n    <div class=\"details\">\n      <span class=\"frequency\">{note.frequency} Hz</span>\n      <span class=\"cents\" class:sharp={note.cents > 0} class:flat={note.cents < 0}>\n        {note.cents > 0 ? '+' : ''}{note.cents}Â¢\n      </span>\n      <span class=\"clarity\">{note.clarity}%</span>\n    </div>\n  {:else}\n    <div class=\"no-pitch\">\n      <span class=\"placeholder\">---</span>\n      <span class=\"hint\">Sing or hum into the microphone</span>\n    </div>\n  {/if}\n</div>\n\n<style>\n  .pitch-readout {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    justify-content: center;\n    padding: var(--spacing-lg);\n    background-color: var(--color-surface);\n    border-radius: var(--radius-md);\n    min-width: 200px;\n    min-height: 100px;\n  }\n\n  .note-display {\n    display: flex;\n    align-items: baseline;\n    gap: var(--spacing-xs);\n  }\n\n  .note-name {\n    font-size: var(--font-size-2xl);\n    font-weight: 700;\n    color: var(--color-secondary);\n  }\n\n  .octave {\n    font-size: var(--font-size-lg);\n    color: var(--color-text-muted);\n  }\n\n  .details {\n    display: flex;\n    gap: var(--spacing-md);\n    margin-top: var(--spacing-sm);\n    font-size: var(--font-size-sm);\n    color: var(--color-text-muted);\n  }\n\n  .cents {\n    font-weight: 500;\n  }\n\n  .cents.sharp {\n    color: var(--color-warning);\n  }\n\n  .cents.flat {\n    color: var(--color-primary);\n  }\n\n  .no-pitch {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    gap: var(--spacing-sm);\n  }\n\n  .placeholder {\n    font-size: var(--font-size-2xl);\n    color: var(--color-text-muted);\n  }\n\n  .hint {\n    font-size: var(--font-size-sm);\n    color: var(--color-text-muted);\n    opacity: 0.7;\n  }\n</style>\n","/**\n * Handoff State Store - Svelte 5 Runes\n *\n * Manages imported snapshot data from Student Notation.\n * This store handles the handoff lifecycle:\n * 1. Check for handoff on app load\n * 2. Import snapshot data\n * 3. Provide access to imported voices and grid structure\n * 4. Support \"Bring Back to Student Notation\" flow\n */\n\nimport {\n  consumeHandoffSlot,\n  checkForHandoff,\n  clearHandoffParams,\n  writeHandoffSlot,\n  navigateToStudentNotation,\n  type SingingTrainerSnapshot,\n  type SnapshotVoice,\n  type TimeGridStructure,\n  SNAPSHOT_SCHEMA_VERSION,\n} from '@mlt/handoff';\n\nexport interface HandoffState {\n  /** Whether a snapshot has been imported */\n  hasImportedSnapshot: boolean;\n  /** The imported snapshot (if any) */\n  snapshot: SingingTrainerSnapshot | null;\n  /** Loading state during handoff processing */\n  isLoading: boolean;\n  /** Error message if handoff failed */\n  error: string | null;\n  /** Transposition offset in semitones (positive = up) */\n  transpositionSemitones: number;\n}\n\nconst DEFAULT_STATE: HandoffState = {\n  hasImportedSnapshot: false,\n  snapshot: null,\n  isLoading: false,\n  error: null,\n  transpositionSemitones: 0,\n};\n\nfunction createHandoffState() {\n  let state = $state<HandoffState>({ ...DEFAULT_STATE });\n\n  return {\n    get state() {\n      return state;\n    },\n\n    /**\n     * Check for and consume any pending handoff on app initialization.\n     * Should be called once when the app loads.\n     */\n    async checkAndConsumeHandoff(): Promise<boolean> {\n      // First check URL params to see if we came from a handoff\n      const handoffInfo = checkForHandoff();\n\n      if (!handoffInfo) {\n        return false;\n      }\n\n      state.isLoading = true;\n      state.error = null;\n\n      try {\n        // Try to read and consume the snapshot from the handoff slot\n        const snapshot = await consumeHandoffSlot();\n\n        if (!snapshot) {\n          state.error = 'Handoff data expired or not found. Please try exporting again.';\n          state.isLoading = false;\n          clearHandoffParams();\n          return false;\n        }\n\n        // Validate schema version\n        if (snapshot.schemaVersion !== SNAPSHOT_SCHEMA_VERSION) {\n          state.error = `Incompatible snapshot version: ${snapshot.schemaVersion}. Expected: ${SNAPSHOT_SCHEMA_VERSION}`;\n          state.isLoading = false;\n          clearHandoffParams();\n          return false;\n        }\n\n        // Successfully imported\n        state.snapshot = snapshot;\n        state.hasImportedSnapshot = true;\n        state.isLoading = false;\n\n        // Clear URL params to keep the URL clean\n        clearHandoffParams();\n\n        console.log('[HandoffState] Successfully imported snapshot', {\n          voices: snapshot.voices.length,\n          microbeatCount: snapshot.timeGrid.microbeatCount,\n          tempo: snapshot.tempo,\n        });\n\n        return true;\n      } catch (error) {\n        console.error('[HandoffState] Failed to process handoff', error);\n        state.error = 'Failed to import data from Student Notation.';\n        state.isLoading = false;\n        clearHandoffParams();\n        return false;\n      }\n    },\n\n    /**\n     * Get the imported voices.\n     */\n    get voices(): SnapshotVoice[] {\n      return state.snapshot?.voices ?? [];\n    },\n\n    /**\n     * Get the time grid structure.\n     */\n    get timeGrid(): TimeGridStructure | null {\n      return state.snapshot?.timeGrid ?? null;\n    },\n\n    /**\n     * Get the tempo (with transposition applied to accompaniment).\n     */\n    get tempo(): number {\n      return state.snapshot?.tempo ?? 90;\n    },\n\n    /**\n     * Get the suggested pitch range based on imported notes.\n     */\n    get suggestedPitchRange(): { minMidi: number; maxMidi: number } | null {\n      if (!state.snapshot) {\n        return null;\n      }\n\n      const margin = 3; // Add a few semitones margin\n      const minMidi = state.snapshot.minMidiPitch;\n      const maxMidi = state.snapshot.maxMidiPitch;\n\n      if (minMidi === undefined || maxMidi === undefined) {\n        return null;\n      }\n\n      return {\n        minMidi: Math.max(21, minMidi - margin + state.transpositionSemitones),\n        maxMidi: Math.min(108, maxMidi + margin + state.transpositionSemitones),\n      };\n    },\n\n    /**\n     * Set transposition in semitones.\n     */\n    setTransposition(semitones: number) {\n      state.transpositionSemitones = semitones;\n    },\n\n    /**\n     * Transpose up by one semitone.\n     */\n    transposeUp() {\n      state.transpositionSemitones += 1;\n    },\n\n    /**\n     * Transpose down by one semitone.\n     */\n    transposeDown() {\n      state.transpositionSemitones -= 1;\n    },\n\n    /**\n     * Get a transposed MIDI pitch.\n     */\n    getTransposedMidi(originalMidi: number): number {\n      return originalMidi + state.transpositionSemitones;\n    },\n\n    /**\n     * Export current state back to Student Notation.\n     * Creates a new snapshot and navigates back.\n     */\n    async bringBackToStudentNotation(): Promise<void> {\n      if (!state.snapshot) {\n        console.warn('[HandoffState] No snapshot to bring back');\n        return;\n      }\n\n      // Create a modified snapshot for return\n      const returnSnapshot: SingingTrainerSnapshot = {\n        ...state.snapshot,\n        sourceApp: 'singing-trainer',\n        createdAt: Date.now(),\n        // Apply transposition to all voices\n        voices: state.snapshot.voices.map(voice => ({\n          ...voice,\n          notes: voice.notes.map(note => ({\n            ...note,\n            midiPitch: note.midiPitch + state.transpositionSemitones,\n          })),\n        })),\n      };\n\n      try {\n        const handoffId = await writeHandoffSlot(returnSnapshot);\n        console.log('[HandoffState] Handoff slot written for return', handoffId);\n        navigateToStudentNotation(handoffId);\n      } catch (error) {\n        console.error('[HandoffState] Failed to write return handoff', error);\n      }\n    },\n\n    /**\n     * Clear the imported snapshot.\n     */\n    clearSnapshot() {\n      state = { ...DEFAULT_STATE };\n    },\n\n    /**\n     * Reset the handoff state.\n     */\n    reset() {\n      state = { ...DEFAULT_STATE };\n    },\n  };\n}\n\nexport const handoffState = createHandoffState();\n","<script lang=\"ts\">\n  /**\n   * App Component\n   *\n   * Main application layout for the Singing Trainer.\n   */\n  import { onMount, onDestroy } from 'svelte';\n  import {\n    SingingCanvas,\n    TonicSelector,\n    DroneControls,\n    PitchHighlightToggle,\n    PitchReadout,\n    RangeControl,\n    DemoExerciseControls,\n  } from './lib/components/index.js';\n  import { handoffState } from './lib/stores/handoffState.svelte.js';\n  import { appState } from './lib/stores/appState.svelte.js';\n  import { startDetection, stopDetection } from './lib/services/pitchDetection.js';\n\n  // Settings panel state\n  let showSettings = $state(false);\n\n  // Check for handoff and auto-start pitch detection on mount\n  onMount(async () => {\n    const wasHandoff = await handoffState.checkAndConsumeHandoff();\n\n    if (wasHandoff) {\n      console.log('[App] Handoff detected and processed');\n\n      // Update the pitch range based on imported data\n      const suggestedRange = handoffState.suggestedPitchRange;\n      if (suggestedRange) {\n        appState.setYAxisRange(suggestedRange);\n      }\n    }\n\n    // Auto-start pitch detection\n    try {\n      await startDetection();\n      appState.setDetecting(true);\n      console.log('[App] Pitch detection auto-started');\n    } catch (err) {\n      console.error('[App] Failed to auto-start pitch detection:', err);\n    }\n  });\n\n  // Clean up on unmount\n  onDestroy(() => {\n    stopDetection();\n  });\n\n  // Reactive state\n  const hasImportedSnapshot = $derived(handoffState.state.hasImportedSnapshot);\n  const transposition = $derived(handoffState.state.transpositionSemitones);\n  const handoffError = $derived(handoffState.state.error);\n\n  function handleBringBack() {\n    handoffState.bringBackToStudentNotation();\n  }\n\n  function handleTransposeUp() {\n    handoffState.transposeUp();\n  }\n\n  function handleTransposeDown() {\n    handoffState.transposeDown();\n  }\n</script>\n\n<div class=\"app\">\n  <header class=\"header\">\n    <h1 class=\"title\">Singing Trainer</h1>\n    <div class=\"header-controls\">\n      {#if hasImportedSnapshot}\n        <div class=\"handoff-controls\">\n          <div class=\"transposition-control\">\n            <button class=\"transpose-btn\" onclick={handleTransposeDown} title=\"Transpose down\">-</button>\n            <span class=\"transposition-label\">\n              {transposition >= 0 ? '+' : ''}{transposition}\n            </span>\n            <button class=\"transpose-btn\" onclick={handleTransposeUp} title=\"Transpose up\">+</button>\n          </div>\n          <button class=\"bring-back-btn\" onclick={handleBringBack}>\n            Bring Back to Student Notation\n          </button>\n        </div>\n      {/if}\n    </div>\n  </header>\n\n  {#if handoffError}\n    <div class=\"error-banner\">\n      {handoffError}\n    </div>\n  {/if}\n\n  <main class=\"main\">\n    <aside class=\"sidebar sidebar--left\">\n      <div class=\"control-group\">\n        <PitchReadout />\n      </div>\n\n      <div class=\"control-group\">\n        <DemoExerciseControls />\n      </div>\n\n      <div class=\"control-group\">\n        <details class=\"settings-details\" bind:open={showSettings}>\n          <summary class=\"settings-summary\">Settings</summary>\n          <div class=\"settings-content\">\n            <TonicSelector />\n            <DroneControls />\n            <PitchHighlightToggle />\n          </div>\n        </details>\n      </div>\n\n      <div class=\"control-group\">\n        <RangeControl />\n      </div>\n\n      {#if hasImportedSnapshot}\n        <div class=\"control-group\">\n          <h3 class=\"control-group-title\">Imported Material</h3>\n          <div class=\"import-info\">\n            <span class=\"import-label\">Voices:</span>\n            <span class=\"import-value\">{handoffState.voices.length}</span>\n          </div>\n          <div class=\"import-info\">\n            <span class=\"import-label\">Tempo:</span>\n            <span class=\"import-value\">{handoffState.tempo} BPM</span>\n          </div>\n          {#if handoffState.timeGrid}\n            <div class=\"import-info\">\n              <span class=\"import-label\">Microbeats:</span>\n              <span class=\"import-value\">{handoffState.timeGrid.microbeatCount}</span>\n            </div>\n          {/if}\n        </div>\n      {/if}\n    </aside>\n\n    <section class=\"canvas-area\">\n      <SingingCanvas />\n    </section>\n  </main>\n</div>\n\n<style>\n  .app {\n    display: flex;\n    flex-direction: column;\n    height: 100%;\n    width: 100%;\n  }\n\n  .header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: var(--spacing-md) var(--spacing-lg);\n    background-color: var(--color-bg-light);\n    border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n  }\n\n  .title {\n    font-size: var(--font-size-xl);\n    font-weight: 700;\n    color: var(--color-text);\n    margin: 0;\n  }\n\n  .header-controls {\n    display: flex;\n    gap: var(--spacing-md);\n  }\n\n  .main {\n    display: flex;\n    flex: 1;\n    overflow: hidden;\n  }\n\n  .sidebar {\n    display: flex;\n    flex-direction: column;\n    gap: var(--spacing-lg);\n    padding: var(--spacing-lg);\n    background-color: var(--color-bg-light);\n    border-right: 1px solid rgba(255, 255, 255, 0.1);\n    min-width: 260px;\n    max-width: 300px;\n    overflow-y: auto; /* Allow vertical scrolling */\n  }\n\n  .control-group {\n    display: flex;\n    flex-direction: column;\n    gap: var(--spacing-md);\n  }\n\n  .control-group-title {\n    font-size: var(--font-size-sm);\n    font-weight: 600;\n    color: var(--color-text-muted);\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n    margin: 0;\n  }\n\n  .canvas-area {\n    flex: 1;\n    display: flex;\n    padding: var(--spacing-lg);\n    overflow: hidden;\n  }\n\n  /* Handoff controls */\n  .handoff-controls {\n    display: flex;\n    align-items: center;\n    gap: var(--spacing-md);\n  }\n\n  .transposition-control {\n    display: flex;\n    align-items: center;\n    gap: var(--spacing-xs);\n    background-color: var(--color-bg);\n    border-radius: var(--radius-md);\n    padding: var(--spacing-xs) var(--spacing-sm);\n  }\n\n  .transpose-btn {\n    width: 28px;\n    height: 28px;\n    border: none;\n    border-radius: var(--radius-sm);\n    background-color: var(--color-bg-light);\n    color: var(--color-text);\n    font-size: var(--font-size-lg);\n    font-weight: 600;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    transition: background-color 0.15s ease;\n  }\n\n  .transpose-btn:hover {\n    background-color: var(--color-primary);\n    color: white;\n  }\n\n  .transposition-label {\n    font-size: var(--font-size-sm);\n    font-weight: 600;\n    color: var(--color-text);\n    min-width: 32px;\n    text-align: center;\n  }\n\n  .bring-back-btn {\n    padding: var(--spacing-sm) var(--spacing-md);\n    border: none;\n    border-radius: var(--radius-md);\n    background-color: var(--color-primary);\n    color: white;\n    font-size: var(--font-size-sm);\n    font-weight: 600;\n    cursor: pointer;\n    transition: background-color 0.15s ease;\n  }\n\n  .bring-back-btn:hover {\n    background-color: var(--color-primary-dark, #4a7bc8);\n  }\n\n  /* Error banner */\n  .error-banner {\n    background-color: var(--color-error, #dc3545);\n    color: white;\n    padding: var(--spacing-sm) var(--spacing-lg);\n    text-align: center;\n    font-size: var(--font-size-sm);\n  }\n\n  /* Import info */\n  .import-info {\n    display: flex;\n    justify-content: space-between;\n    font-size: var(--font-size-sm);\n    padding: var(--spacing-xs) 0;\n  }\n\n  .import-label {\n    color: var(--color-text-muted);\n  }\n\n  .import-value {\n    color: var(--color-text);\n    font-weight: 600;\n  }\n\n  /* Settings dropdown */\n  .settings-details {\n    background-color: var(--color-surface, rgba(255, 255, 255, 0.05));\n    border-radius: var(--radius-sm);\n    padding: var(--spacing-xs);\n  }\n\n  .settings-summary {\n    cursor: pointer;\n    font-size: var(--font-size-sm);\n    font-weight: 600;\n    color: var(--color-text-muted);\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n    padding: var(--spacing-xs);\n    user-select: none;\n    list-style: none;\n  }\n\n  .settings-summary::-webkit-details-marker {\n    display: none;\n  }\n\n  .settings-summary::before {\n    content: 'â–¶';\n    display: inline-block;\n    margin-right: var(--spacing-xs);\n    font-size: 0.7em;\n    transition: transform 0.2s ease;\n  }\n\n  .settings-details[open] .settings-summary::before {\n    transform: rotate(90deg);\n  }\n\n  .settings-summary:hover {\n    color: var(--color-primary);\n  }\n\n  .settings-content {\n    display: flex;\n    flex-direction: column;\n    gap: var(--spacing-md);\n    padding: var(--spacing-sm);\n    padding-top: var(--spacing-md);\n  }\n\n  @media (max-width: 900px) {\n    .header {\n      flex-wrap: wrap;\n      gap: var(--spacing-sm);\n      padding: var(--spacing-sm) var(--spacing-md);\n    }\n\n    .title {\n      font-size: var(--font-size-lg);\n    }\n\n    .header-controls {\n      width: 100%;\n      flex-wrap: wrap;\n      justify-content: flex-start;\n    }\n\n    .handoff-controls {\n      flex-wrap: wrap;\n    }\n\n    .main {\n      flex-direction: column;\n    }\n\n    .canvas-area {\n      order: 1;\n      padding: var(--spacing-md);\n      min-height: 300px;\n    }\n\n    .sidebar {\n      order: 2;\n      width: 100%;\n      max-width: none;\n      min-width: 0;\n      border-right: none;\n      border-top: 1px solid rgba(255, 255, 255, 0.1);\n      padding: var(--spacing-md);\n      max-height: 40vh;\n    }\n  }\n\n  @media (max-width: 600px) {\n    .canvas-area {\n      padding: var(--spacing-sm);\n    }\n\n    .sidebar {\n      max-height: 50vh;\n    }\n  }\n</style>\n","import { mount as svelteMount, unmount } from 'svelte';\nimport App from './App.svelte';\nimport './styles/global.css';\n\nexport type SingingTrainerInstance = {\n  destroy: () => void;\n};\n\nexport function mountSingingTrainer(container: HTMLElement): SingingTrainerInstance {\n  const app = svelteMount(App, { target: container });\n  return {\n    destroy: () => unmount(app),\n  };\n}\n\nexport const mount = mountSingingTrainer;\n\nexport default mountSingingTrainer;\n"],"names":["DEFAULT_STATE","createAppState","state","$","isDetecting","mode","tonic","useDegrees","show","enabled","range","octave","volume","appState","MAX_HISTORY_LENGTH","createPitchState","pitch","point","stable","pitchState","createHighwayState","engineService","animationFrameId","convertToEngineFormat","notes","note","index","syncEngineState","engineState","performances","noteId","perf","animate","initializeEngine","createNoteHighwayService","event","data","hitData","engineNotes","noteIndex","i","x","pps","ms","midi","clarity","highwayState","DEFAULT_CONFIG","randomPitch","minMidi","maxMidi","getMicrobeatDurationMs","tempo","createDemoExerciseState","generateExerciseNotes","config","microbeatDurationMs","leadInMs","loop","loopStartTime","getPhaseFromTime","currentTimeMs","loopDurationMs","adjustedTimeMs","currentLoop","timeInLoop","microbeatInLoop","phase","newConfig","playing","result","loopIndex","r","sum","_a","demoExerciseState","container","containerWidth","containerHeight","trailCanvas","trailCtx","trailAnimationId","lastTrailLogAt","trailFrameSamples","trailFrameTimeTotal","cellWidth","showOctaveLabels","showFrequencyLabels","showRightLegend","LEGEND_COLUMN_WIDTH_UNITS","legendColumnWidth","legendCanvasWidth","showLegends","legendTotalWidth","gridWidth","gridOffsetX","getDebugTrailFlag","fullRowData","generateRowDataForMidiRange","viewportWindow","calculateViewportWindow","beatIntervalMs","beatTimeOffsetMs","legendHighlight","convertTargetNotes","n","trailConfig","getTonicPitchClass","singingConfig","highwayConfig","viewport","setupTrailCanvas","dpr","ctx","renderTrail","trailHistory","activeConfig","debugTrail","frameStart","nowLineX","coords","createTimeCoordinates","userPitchConfig","currentTime","drawUserPitchTrace","now","avgMs","startTrailLoop","stopTrailLoop","resizeObserver","entries","entry","onDestroy","div","root","PitchGrid","node","canvas","$$value","ReferenceAudioService","__publicField","Tone","dB","duration","frequency","startTimeoutId","endTimeoutId","durationMs","timeoutId","referenceAudio","CONFIG","mic","analyser","detector","isRunning","HIGHLIGHT_DEFAULT_SIZE","frequencyToMidi","animationLoop","waveform","isValidPitch","detectedPitch","nearestMidi","getNearestMidi","centsOffset","getCentsOffset","centsDistance","opacity","midiToPitchClass","startDetection","PitchDetector","err","cleanup","stopDetection","synth","isPlaying","currentNote","ensureSynth","oscillatorType","getNoteName","startDrone","s","stopDrone","updateDrone","newNote","toggleDrone","TONIC_OPTIONS","handleChange","target","select","option","root_1","OCTAVE_OPTIONS","handleToggle","handleOctaveChange","handleVolumeChange","button","text","div_1","label","$$anchor","oct","label_1","input","classes","select_value","midiToIndex","topIndex","bottomIndex","handleRangeChange","DualPitchWheel","showSettings","numLoops","referenceVolume","isActive","currentPhase","progress","results","hasResults","averageAccuracy","hitCount","totalCount","accuracy","calculateAccuracy","handleStop","useCurrentRange","useFullRange","handleStart","referenceTones","getPhaseLabel","getPitchName","getPitchByMidi","details","input_1","label_2","input_2","span","div_2","button_1","div_3","button_2","button_3","fragment","div_4","div_5","text_1","$$render","alternate","consequent","div_6","root_3","div_7","div_8","span_1","div_9","span_2","details_1","div_10","div_11","root_4","span_3","span_4","span_5","span_6","text_4","consequent_1","NOTE_NAMES","noteName","cents","text_2","root_2","createHandoffState","checkForHandoff","snapshot","consumeHandoffSlot","SNAPSHOT_SCHEMA_VERSION","clearHandoffParams","error","margin","semitones","originalMidi","returnSnapshot","voice","handoffId","writeHandoffSlot","navigateToStudentNotation","handoffState","onMount","suggestedRange","hasImportedSnapshot","transposition","handoffError","handleBringBack","handleTransposeUp","handleTransposeDown","header","main","node_1","aside","PitchReadout","node_2","DemoExerciseControls","node_3","TonicSelector","node_4","DroneControls","node_5","PitchHighlightToggle","node_6","RangeControl","node_7","div_12","div_13","consequent_2","text_3","consequent_3","section","SingingCanvas","node_10","mountSingingTrainer","app","svelteMount","App","unmount","mount"],"mappings":"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"}