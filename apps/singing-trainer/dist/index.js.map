{"version":3,"file":"index.js","sources":["../src/lib/stores/appState.svelte.ts","../src/lib/stores/pitchState.svelte.ts","../src/lib/stores/highwayState.svelte.ts","../src/lib/components/SingingCanvas.svelte","../src/lib/services/pitchDetection.ts","../src/lib/components/controls/StartButton.svelte","../src/lib/services/droneAudio.ts","../src/lib/components/controls/TonicSelector.svelte","../src/lib/components/controls/DroneControls.svelte","../src/lib/components/controls/ModeToggle.svelte","../src/lib/components/controls/RangeControl.svelte","../src/lib/components/feedback/PitchReadout.svelte","../src/lib/stores/handoffState.svelte.ts","../src/App.svelte","../src/index.ts"],"sourcesContent":["/**\n * App State Store - Svelte 5 Runes\n *\n * Main application state for the Singing Trainer.\n */\n\nexport type VisualizationMode = 'stationary' | 'highway';\nexport type TonicNote =\n  | 'C'\n  | 'C#'\n  | 'Db'\n  | 'D'\n  | 'D#'\n  | 'Eb'\n  | 'E'\n  | 'F'\n  | 'F#'\n  | 'Gb'\n  | 'G'\n  | 'G#'\n  | 'Ab'\n  | 'A'\n  | 'A#'\n  | 'Bb'\n  | 'B';\n\nexport interface DroneState {\n  isPlaying: boolean;\n  octave: number;\n  volume: number;\n}\n\nexport interface YAxisRange {\n  minMidi: number;\n  maxMidi: number;\n}\n\nexport interface AppState {\n  isDetecting: boolean;\n  visualizationMode: VisualizationMode;\n  tonic: TonicNote;\n  useDegrees: boolean;\n  showAccidentals: boolean;\n  yAxisRange: YAxisRange;\n  drone: DroneState;\n}\n\nconst DEFAULT_STATE: AppState = {\n  isDetecting: false,\n  visualizationMode: 'stationary',\n  tonic: 'C',\n  useDegrees: false,\n  showAccidentals: true,\n  yAxisRange: { minMidi: 48, maxMidi: 72 }, // C3 to C5\n  drone: { isPlaying: false, octave: 3, volume: -12 },\n};\n\nfunction createAppState() {\n  let state = $state<AppState>({ ...DEFAULT_STATE });\n\n  return {\n    get state() {\n      return state;\n    },\n\n    toggleDetecting() {\n      state.isDetecting = !state.isDetecting;\n    },\n\n    setDetecting(isDetecting: boolean) {\n      state.isDetecting = isDetecting;\n    },\n\n    setVisualizationMode(mode: VisualizationMode) {\n      state.visualizationMode = mode;\n    },\n\n    setTonic(tonic: TonicNote) {\n      state.tonic = tonic;\n    },\n\n    setUseDegrees(useDegrees: boolean) {\n      state.useDegrees = useDegrees;\n    },\n\n    setShowAccidentals(show: boolean) {\n      state.showAccidentals = show;\n    },\n\n    setYAxisRange(range: YAxisRange) {\n      state.yAxisRange = range;\n    },\n\n    expandYAxisUpper() {\n      if (state.yAxisRange.maxMidi < 108) {\n        state.yAxisRange = { ...state.yAxisRange, maxMidi: state.yAxisRange.maxMidi + 1 };\n      }\n    },\n\n    contractYAxisUpper() {\n      if (state.yAxisRange.maxMidi > state.yAxisRange.minMidi + 6) {\n        state.yAxisRange = { ...state.yAxisRange, maxMidi: state.yAxisRange.maxMidi - 1 };\n      }\n    },\n\n    expandYAxisLower() {\n      if (state.yAxisRange.minMidi > 21) {\n        state.yAxisRange = { ...state.yAxisRange, minMidi: state.yAxisRange.minMidi - 1 };\n      }\n    },\n\n    contractYAxisLower() {\n      if (state.yAxisRange.minMidi < state.yAxisRange.maxMidi - 6) {\n        state.yAxisRange = { ...state.yAxisRange, minMidi: state.yAxisRange.minMidi + 1 };\n      }\n    },\n\n    toggleDrone() {\n      state.drone = { ...state.drone, isPlaying: !state.drone.isPlaying };\n    },\n\n    setDroneOctave(octave: number) {\n      state.drone = { ...state.drone, octave };\n    },\n\n    setDroneVolume(volume: number) {\n      state.drone = { ...state.drone, volume };\n    },\n\n    reset() {\n      state = { ...DEFAULT_STATE };\n    },\n  };\n}\n\nexport const appState = createAppState();\n","/**\n * Pitch State Store - Svelte 5 Runes\n *\n * Real-time pitch detection state including current pitch and history.\n */\n\nexport interface DetectedPitch {\n  frequency: number;\n  midi: number;\n  clarity: number;\n  pitchClass: number;\n}\n\nexport interface PitchHistoryPoint {\n  frequency: number;\n  midi: number;\n  time: number;\n  clarity: number;\n}\n\nexport interface StablePitch {\n  pitchClass: number | null;\n  opacity: number;\n  size: number;\n}\n\nexport interface PitchState {\n  currentPitch: DetectedPitch | null;\n  history: PitchHistoryPoint[];\n  stablePitch: StablePitch;\n}\n\nconst MAX_HISTORY_LENGTH = 200; // Cap history to bound trail render cost\n\nconst DEFAULT_STATE: PitchState = {\n  currentPitch: null,\n  history: [],\n  stablePitch: { pitchClass: null, opacity: 0, size: 1.0 },\n};\n\nfunction createPitchState() {\n  let state = $state<PitchState>({ ...DEFAULT_STATE });\n\n  return {\n    get state() {\n      return state;\n    },\n\n    setCurrentPitch(pitch: DetectedPitch | null) {\n      state.currentPitch = pitch;\n    },\n\n    addHistoryPoint(point: PitchHistoryPoint) {\n      state.history.push(point);\n      if (state.history.length > MAX_HISTORY_LENGTH) {\n        state.history.shift();\n      }\n    },\n\n    setStablePitch(stable: StablePitch) {\n      state.stablePitch = stable;\n    },\n\n    clearHistory() {\n      state.history = [];\n    },\n\n    reset() {\n      state = { ...DEFAULT_STATE };\n    },\n  };\n}\n\nexport const pitchState = createPitchState();\n","/**\n * Highway State Store - Svelte 5 Runes\n *\n * State for the \"Guitar Hero\" note highway visualization mode.\n */\n\nexport interface TargetNote {\n  midi: number;\n  startTimeMs: number;\n  durationMs: number;\n  hit?: boolean;\n}\n\nexport interface HighwayState {\n  isPlaying: boolean;\n  startTime: number | null;\n  currentTimeMs: number;\n  targetNotes: TargetNote[];\n  nowLineX: number;\n  pixelsPerSecond: number;\n  timeWindowMs: number;\n}\n\nconst DEFAULT_STATE: HighwayState = {\n  isPlaying: false,\n  startTime: null,\n  currentTimeMs: 0,\n  targetNotes: [],\n  nowLineX: 100, // Position of the \"now\" line from left edge\n  pixelsPerSecond: 200,\n  timeWindowMs: 4000,\n};\n\nfunction createHighwayState() {\n  let state = $state<HighwayState>({ ...DEFAULT_STATE });\n  let animationFrameId: number | null = null;\n\n  function updateTime() {\n    if (state.isPlaying && state.startTime !== null) {\n      state.currentTimeMs = performance.now() - state.startTime;\n      animationFrameId = requestAnimationFrame(updateTime);\n    }\n  }\n\n  return {\n    get state() {\n      return state;\n    },\n\n    start() {\n      state.isPlaying = true;\n      state.startTime = performance.now();\n      state.currentTimeMs = 0;\n      animationFrameId = requestAnimationFrame(updateTime);\n    },\n\n    stop() {\n      state.isPlaying = false;\n      if (animationFrameId !== null) {\n        cancelAnimationFrame(animationFrameId);\n        animationFrameId = null;\n      }\n    },\n\n    pause() {\n      state.isPlaying = false;\n      if (animationFrameId !== null) {\n        cancelAnimationFrame(animationFrameId);\n        animationFrameId = null;\n      }\n    },\n\n    resume() {\n      if (state.startTime !== null) {\n        // Adjust start time to account for paused duration\n        const pausedDuration = performance.now() - (state.startTime + state.currentTimeMs);\n        state.startTime += pausedDuration;\n        state.isPlaying = true;\n        animationFrameId = requestAnimationFrame(updateTime);\n      }\n    },\n\n    setTargetNotes(notes: TargetNote[]) {\n      state.targetNotes = notes;\n    },\n\n    markNoteHit(noteIndex: number) {\n      if (noteIndex >= 0 && noteIndex < state.targetNotes.length) {\n        state.targetNotes = state.targetNotes.map((note, i) =>\n          i === noteIndex ? { ...note, hit: true } : note\n        );\n      }\n    },\n\n    setNowLineX(x: number) {\n      state.nowLineX = x;\n    },\n\n    setPixelsPerSecond(pps: number) {\n      state.pixelsPerSecond = pps;\n    },\n\n    setTimeWindowMs(ms: number) {\n      state.timeWindowMs = ms;\n    },\n\n    reset() {\n      if (animationFrameId !== null) {\n        cancelAnimationFrame(animationFrameId);\n        animationFrameId = null;\n      }\n      state = { ...DEFAULT_STATE };\n    },\n  };\n}\n\nexport const highwayState = createHighwayState();\n","<script lang=\"ts\">\n  /**\n   * SingingCanvas Component\n   *\n   * Wraps the shared PitchGrid component for singing/highway visualization modes.\n   */\n\n  import { onDestroy } from 'svelte';\n  import {\n    PitchGrid,\n    calculateViewportWindow,\n    createTimeCoordinates,\n    drawUserPitchTrace,\n  } from '@mlt/ui-components/canvas';\n  import type {\n    PitchGridMode,\n    PitchGridViewport,\n    SingingModeConfig,\n    HighwayModeConfig,\n    TargetNote as SharedTargetNote,\n    PitchTrailConfig,\n    UserPitchRenderConfig,\n    ViewportWindow,\n  } from '@mlt/ui-components/canvas';\n  import { generateRowDataForMidiRange, getTonicPitchClass, type PitchRowData } from '@mlt/pitch-data';\n  import { appState } from '../stores/appState.svelte.js';\n  import { pitchState } from '../stores/pitchState.svelte.js';\n  import { highwayState } from '../stores/highwayState.svelte.js';\n\n  // Container element for measuring size\n  let container: HTMLDivElement | undefined = $state(undefined);\n  let containerWidth = $state(800);\n  let containerHeight = $state(400);\n\n  // Trail canvas overlay\n  let trailCanvas: HTMLCanvasElement | undefined = $state(undefined);\n  let trailCtx: CanvasRenderingContext2D | null = $state(null);\n  let trailAnimationId: number | null = $state(null);\n\n  let lastTrailLogAt = 0;\n  let trailFrameSamples = 0;\n  let trailFrameTimeTotal = 0;\n\n  const cellWidth = 20;\n  const showOctaveLabels = true;\n  const showFrequencyLabels = false;\n\n  // Keep legend sizing in sync with PitchGrid\n  const LEGEND_COLUMN_WIDTH_UNITS = 3;\n  const legendColumnWidth = $derived(cellWidth * LEGEND_COLUMN_WIDTH_UNITS);\n  const legendCanvasWidth = $derived(legendColumnWidth * 2);\n  const legendTotalWidth = $derived((showOctaveLabels || showFrequencyLabels) ? legendCanvasWidth * 2 : 0);\n  const gridWidth = $derived(Math.max(0, containerWidth - legendTotalWidth));\n  const gridOffsetX = $derived((showOctaveLabels || showFrequencyLabels) ? legendCanvasWidth : 0);\n  const getDebugTrailFlag = (): boolean => {\n    try {\n      const win = globalThis as typeof globalThis & { __ST_DEBUG_TRAIL?: boolean };\n      return Boolean(win.__ST_DEBUG_TRAIL);\n    } catch {\n      return false;\n    }\n  };\n\n  // Generate row data for the pitch grid based on y-axis range\n  // Uses the shared pitch data package which includes proper colors, frequencies, and enharmonic spellings\n  const fullRowData = $derived<PitchRowData[]>(\n    generateRowDataForMidiRange(appState.state.yAxisRange.minMidi, appState.state.yAxisRange.maxMidi)\n  );\n\n  // Calculate optimal viewport window that fills container height\n  const viewportWindow = $derived<ViewportWindow>(\n    calculateViewportWindow({\n      containerHeight,\n      fullRowData,\n      preferredCellHeight: 40,\n      minCellHeight: 20,\n    })\n  );\n\n  // Derive the PitchGrid mode from app state\n  const mode = $derived<PitchGridMode>(\n    appState.state.visualizationMode === 'highway' ? 'highway' : 'singing'\n  );\n\n  // Convert local target notes to shared format\n  function convertTargetNotes(): SharedTargetNote[] {\n    return highwayState.state.targetNotes.map((n, i) => ({\n      id: `target-${i}`,\n      midi: n.midi,\n      startTimeMs: n.startTimeMs,\n      durationMs: n.durationMs,\n    }));\n  }\n\n  // Get pitch trail configuration with tonic-relative colors\n  const trailConfig = $derived<PitchTrailConfig>({\n    timeWindowMs: 4000,\n    pixelsPerSecond: 200,\n    circleRadius: 9.5,\n    proximityThreshold: 35,\n    maxConnections: 3,\n    connectorLineWidth: 2.5,\n    connectorColor: 'rgba(0,0,0,0.4)',\n    useTonicRelativeColors: true,\n    tonicPitchClass: getTonicPitchClass(appState.state.tonic),\n    clarityThreshold: 0.5,\n    maxOpacity: 0.9,\n  });\n\n  // Build singing mode config\n  const singingConfig = $derived<SingingModeConfig | undefined>(\n    mode === 'singing'\n      ? {\n          userPitch: pitchState.state.currentPitch\n            ? {\n                frequency: pitchState.state.currentPitch.frequency,\n                midi: pitchState.state.currentPitch.midi,\n                clarity: pitchState.state.currentPitch.clarity,\n                pitchClass: pitchState.state.currentPitch.pitchClass,\n              }\n            : null,\n          pitchHistory: [],\n          targetNotes: [],\n          pixelsPerSecond: 200,\n          timeWindowMs: 4000,\n          trailConfig,\n        }\n      : undefined\n  );\n\n  // Build highway mode config\n  const highwayConfig = $derived<HighwayModeConfig | undefined>(\n    mode === 'highway'\n      ? {\n          userPitch: pitchState.state.currentPitch\n            ? {\n                frequency: pitchState.state.currentPitch.frequency,\n                midi: pitchState.state.currentPitch.midi,\n                clarity: pitchState.state.currentPitch.clarity,\n                pitchClass: pitchState.state.currentPitch.pitchClass,\n              }\n            : null,\n          pitchHistory: [],\n          targetNotes: convertTargetNotes(),\n          nowLineX: highwayState.state.nowLineX,\n          pixelsPerSecond: highwayState.state.pixelsPerSecond,\n          currentTimeMs: highwayState.state.currentTimeMs,\n          timeWindowMs: highwayState.state.timeWindowMs,\n          trailConfig,\n        }\n      : undefined\n  );\n\n  // Viewport configuration using calculated window\n  const viewport = $derived<PitchGridViewport>({\n    startRow: viewportWindow.startRow,\n    endRow: viewportWindow.endRow,\n    zoomLevel: 1.0,\n    containerWidth,\n    containerHeight,\n  });\n\n  function setupTrailCanvas(): void {\n    if (!trailCanvas) return;\n\n    const dpr = window.devicePixelRatio || 1;\n    trailCanvas.width = gridWidth * dpr;\n    trailCanvas.height = containerHeight * dpr;\n    trailCanvas.style.width = `${gridWidth}px`;\n    trailCanvas.style.height = `${containerHeight}px`;\n    trailCanvas.style.left = `${gridOffsetX}px`;\n\n    const ctx = trailCanvas.getContext('2d');\n    if (!ctx) {\n      trailCtx = null;\n      return;\n    }\n\n    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);\n    trailCtx = ctx;\n  }\n\n  function renderTrail(): void {\n    if (!trailCtx || gridWidth <= 0) return;\n\n    trailCtx.clearRect(0, 0, gridWidth, containerHeight);\n\n    const trailHistory = pitchState.state.history;\n    if (trailHistory.length === 0) return;\n\n    if (mode !== 'singing' || !singingConfig) {\n      return;\n    }\n\n    const debugTrail = getDebugTrailFlag();\n    const frameStart = debugTrail ? performance.now() : 0;\n\n    const coords = createTimeCoordinates({\n      cellWidth,\n      cellHeight: viewportWindow.cellHeight,\n      viewport,\n      pixelsPerSecond: singingConfig.pixelsPerSecond ?? 200,\n      nowLineX: 100,\n      currentTimeMs: 0,\n    });\n\n    const userPitchConfig: UserPitchRenderConfig = {\n      cellHeight: viewportWindow.cellHeight,\n      viewportWidth: gridWidth,\n      nowLineX: 100,\n      pixelsPerSecond: singingConfig.pixelsPerSecond ?? 200,\n      timeWindowMs: singingConfig.timeWindowMs ?? 4000,\n      colorMode: 'color',\n      trailConfig,\n    };\n\n    const currentTime = performance.now();\n\n    drawUserPitchTrace(\n      trailCtx,\n      coords,\n      trailHistory,\n      currentTime,\n      userPitchConfig,\n      fullRowData\n    );\n\n    if (debugTrail) {\n      const now = performance.now();\n      trailFrameSamples += 1;\n      trailFrameTimeTotal += (now - frameStart);\n      if (now - lastTrailLogAt >= 1000) {\n        const avgMs = trailFrameSamples > 0 ? (trailFrameTimeTotal / trailFrameSamples) : 0;\n        console.log(\n          `[SingingTrail] points=${trailHistory.length} avgMs=${avgMs.toFixed(2)} gridWidth=${gridWidth}`\n        );\n        lastTrailLogAt = now;\n        trailFrameSamples = 0;\n        trailFrameTimeTotal = 0;\n      }\n    }\n  }\n\n  function startTrailLoop(): void {\n    if (trailAnimationId) return;\n\n    const loop = () => {\n      renderTrail();\n      trailAnimationId = requestAnimationFrame(loop);\n    };\n\n    trailAnimationId = requestAnimationFrame(loop);\n  }\n\n  function stopTrailLoop(): void {\n    if (trailAnimationId) {\n      cancelAnimationFrame(trailAnimationId);\n      trailAnimationId = null;\n    }\n    if (trailCtx && gridWidth > 0) {\n      trailCtx.clearRect(0, 0, gridWidth, containerHeight);\n    }\n  }\n\n  // Handle container resize\n  $effect(() => {\n    if (!container) return;\n\n    const resizeObserver = new ResizeObserver((entries) => {\n      for (const entry of entries) {\n        containerWidth = entry.contentRect.width;\n        containerHeight = entry.contentRect.height;\n      }\n    });\n\n    resizeObserver.observe(container);\n\n    return () => {\n      resizeObserver.disconnect();\n    };\n  });\n\n  $effect(() => {\n    void gridWidth;\n    void containerHeight;\n    void gridOffsetX;\n    void trailCanvas;\n    setupTrailCanvas();\n  });\n\n  $effect(() => {\n    void mode;\n    void trailCtx;\n    if (mode === 'singing') {\n      startTrailLoop();\n    } else {\n      stopTrailLoop();\n    }\n  });\n\n  onDestroy(() => {\n    stopTrailLoop();\n  });\n</script>\n\n<div class=\"singing-canvas-container\" bind:this={container}>\n  <PitchGrid\n    {mode}\n    {fullRowData}\n    {viewport}\n    cellWidth={cellWidth}\n    cellHeight={viewportWindow.cellHeight}\n    colorMode=\"color\"\n    {showOctaveLabels}\n    {showFrequencyLabels}\n    {singingConfig}\n    {highwayConfig}\n  />\n  <canvas\n    bind:this={trailCanvas}\n    class=\"pitch-trail-canvas\"\n  ></canvas>\n</div>\n\n<style>\n  .singing-canvas-container {\n    flex: 1;\n    width: 100%;\n    min-height: 300px;\n    position: relative;\n    background-color: var(--color-bg-light);\n    /* Subtle white overlay to make grid bounds more visible */\n    background-image: linear-gradient(rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.02));\n    border-radius: var(--radius-md);\n    overflow: hidden;\n  }\n\n  .pitch-trail-canvas {\n    position: absolute;\n    top: 0;\n    pointer-events: none;\n    z-index: 2;\n  }\n</style>\n","/**\n * Pitch Detection Service\n *\n * Uses Pitchy.js for real-time pitch detection from microphone input.\n * Ported from the original JavaScript implementation.\n */\n\nimport * as Tone from 'tone';\nimport { PitchDetector } from 'pitchy';\nimport { pitchState, type DetectedPitch } from '../stores/pitchState.svelte.js';\n\n// Configuration\nconst CONFIG = {\n  FFT_SIZE: 2048,\n  CLARITY_THRESHOLD: 0.8,\n  MIN_PITCH_HZ: 60,\n  MAX_PITCH_HZ: 1600,\n  STABILITY_THRESHOLD: 15,\n  HIGHLIGHT_FADE_SPEED: 0.2,\n  MIN_VOLUME_DB: -60,\n} as const;\n\n// Module state\nlet mic: Tone.UserMedia | null = null;\nlet analyser: Tone.Analyser | null = null;\nlet detector: ReturnType<typeof PitchDetector.forFloat32Array> | null = null;\nlet animationFrameId: number | null = null;\nlet isRunning = false;\n\n// Stability tracking\nlet stablePitchClass = -1;\nlet stablePitchCounter = 0;\nlet targetOpacity = 0;\nlet targetSize = 1.0;\n\n/**\n * Convert frequency in Hz to MIDI note number\n */\nfunction frequencyToMidi(frequency: number): number {\n  return 12 * Math.log2(frequency / 440) + 69;\n}\n\n/**\n * The main detection and animation loop\n */\nfunction animationLoop(): void {\n  if (!isRunning || !analyser || !detector) {\n    animationFrameId = null;\n    return;\n  }\n\n  // Get pitch from audio\n  const waveform = analyser.getValue() as Float32Array;\n  const [pitch, clarity] = detector.findPitch(waveform, Tone.getContext().sampleRate);\n\n  const isValidPitch =\n    pitch !== null &&\n    clarity > CONFIG.CLARITY_THRESHOLD &&\n    pitch > CONFIG.MIN_PITCH_HZ &&\n    pitch < CONFIG.MAX_PITCH_HZ;\n\n  // Update pitch state\n  if (isValidPitch) {\n    const midi = frequencyToMidi(pitch);\n    const detectedPitch: DetectedPitch = {\n      frequency: pitch,\n      midi,\n      clarity,\n      pitchClass: Math.round(midi) % 12,\n    };\n    pitchState.setCurrentPitch(detectedPitch);\n    pitchState.addHistoryPoint({\n      frequency: pitch,\n      midi,\n      time: performance.now(),\n      clarity,\n    });\n  } else {\n    pitchState.addHistoryPoint({\n      frequency: 0,\n      midi: 0,\n      time: performance.now(),\n      clarity: 0,\n    });\n  }\n\n  // Stability highlighting logic\n  const currentPitchClass = isValidPitch && pitchState.state.currentPitch\n    ? Math.round(pitchState.state.currentPitch.midi) % 12\n    : -1;\n\n  if (currentPitchClass === stablePitchClass && currentPitchClass !== -1) {\n    stablePitchCounter++;\n  } else {\n    stablePitchCounter = 0;\n    stablePitchClass = currentPitchClass;\n  }\n\n  targetOpacity = stablePitchCounter >= CONFIG.STABILITY_THRESHOLD ? 1 : 0;\n  targetSize = stablePitchCounter >= CONFIG.STABILITY_THRESHOLD ? 1.05 : 1.0;\n\n  const currentStable = pitchState.state.stablePitch;\n  const newOpacity =\n    currentStable.opacity + (targetOpacity - currentStable.opacity) * CONFIG.HIGHLIGHT_FADE_SPEED;\n  const newSize =\n    currentStable.size + (targetSize - currentStable.size) * CONFIG.HIGHLIGHT_FADE_SPEED;\n\n  pitchState.setStablePitch({\n    pitchClass: stablePitchClass >= 0 ? stablePitchClass : null,\n    opacity: newOpacity,\n    size: newSize,\n  });\n\n  // Request next frame\n  animationFrameId = requestAnimationFrame(animationLoop);\n}\n\n/**\n * Start pitch detection from microphone\n */\nexport async function startDetection(): Promise<void> {\n  if (isRunning) return;\n\n  // Cancel any existing animation frame\n  if (animationFrameId !== null) {\n    cancelAnimationFrame(animationFrameId);\n  }\n\n  // Create audio nodes\n  mic = new Tone.UserMedia();\n  analyser = new Tone.Analyser('waveform', CONFIG.FFT_SIZE);\n  detector = PitchDetector.forFloat32Array(analyser.size);\n\n  try {\n    await Tone.start(); // Initialize audio context\n    await mic.open();\n    mic.connect(analyser);\n    isRunning = true;\n    animationLoop();\n  } catch (err) {\n    console.error('Microphone access denied or failed:', err);\n    cleanup();\n    throw err;\n  }\n}\n\n/**\n * Stop pitch detection\n */\nexport function stopDetection(): void {\n  isRunning = false;\n  cleanup();\n}\n\n/**\n * Clean up audio resources\n */\nfunction cleanup(): void {\n  if (animationFrameId !== null) {\n    cancelAnimationFrame(animationFrameId);\n    animationFrameId = null;\n  }\n\n  if (mic) {\n    mic.close();\n    mic = null;\n  }\n\n  analyser = null;\n  detector = null;\n\n  // Reset stability tracking\n  stablePitchCounter = 0;\n  stablePitchClass = -1;\n\n  pitchState.setStablePitch({ pitchClass: null, opacity: 0, size: 1.0 });\n  pitchState.setCurrentPitch(null);\n}\n\n/**\n * Check if detection is currently running\n */\nexport function isDetecting(): boolean {\n  return isRunning;\n}\n","<script lang=\"ts\">\n  /**\n   * StartButton Component\n   *\n   * Button to start/stop pitch detection.\n   */\n\n  import { appState } from '../../stores/appState.svelte.js';\n  import { startDetection, stopDetection } from '../../services/pitchDetection.js';\n  import { pitchState } from '../../stores/pitchState.svelte.js';\n\n  let isLoading = $state(false);\n\n  async function handleClick() {\n    if (isLoading) return;\n\n    if (appState.state.isDetecting) {\n      stopDetection();\n      appState.setDetecting(false);\n      pitchState.reset();\n    } else {\n      isLoading = true;\n      try {\n        await startDetection();\n        appState.setDetecting(true);\n      } catch (err) {\n        console.error('Failed to start detection:', err);\n        alert('Could not access microphone. Please grant permission and try again.');\n      } finally {\n        isLoading = false;\n      }\n    }\n  }\n</script>\n\n<button\n  class=\"start-button\"\n  class:active={appState.state.isDetecting}\n  class:loading={isLoading}\n  onclick={handleClick}\n  disabled={isLoading}\n>\n  {#if isLoading}\n    <span class=\"spinner\"></span>\n    Starting...\n  {:else if appState.state.isDetecting}\n    <span class=\"icon\">&#9632;</span>\n    Stop\n  {:else}\n    <span class=\"icon\">&#9654;</span>\n    Start\n  {/if}\n</button>\n\n<style>\n  .start-button {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: var(--spacing-sm);\n    padding: var(--spacing-md) var(--spacing-xl);\n    font-size: var(--font-size-lg);\n    font-weight: 600;\n    color: white;\n    background: linear-gradient(135deg, var(--color-primary), #c0392b);\n    border-radius: var(--radius-lg);\n    box-shadow: var(--shadow-md);\n    transition: all 0.2s ease;\n    min-width: 140px;\n  }\n\n  .start-button:hover:not(:disabled) {\n    transform: translateY(-2px);\n    box-shadow: var(--shadow-lg);\n  }\n\n  .start-button:active:not(:disabled) {\n    transform: translateY(0);\n  }\n\n  .start-button.active {\n    background: linear-gradient(135deg, var(--color-success), #27ae60);\n  }\n\n  .start-button.loading {\n    opacity: 0.8;\n  }\n\n  .icon {\n    font-size: 1.2em;\n  }\n\n  .spinner {\n    width: 16px;\n    height: 16px;\n    border: 2px solid rgba(255, 255, 255, 0.3);\n    border-top-color: white;\n    border-radius: 50%;\n    animation: spin 0.8s linear infinite;\n  }\n\n  @keyframes spin {\n    to {\n      transform: rotate(360deg);\n    }\n  }\n</style>\n","/**\n * Drone Audio Service\n *\n * Provides a sustained drone tone using Tone.js for pitch reference.\n */\n\nimport * as Tone from 'tone';\nimport { appState } from '../stores/appState.svelte.js';\n\n// Module state\nlet synth: Tone.PolySynth | null = null;\nlet isPlaying = false;\nlet currentNote: string | null = null;\n\n// Note name mapping\nconst NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];\n\n/**\n * Initialize the drone synth\n */\nfunction ensureSynth(): Tone.PolySynth {\n  if (!synth) {\n    synth = new Tone.PolySynth(Tone.Synth, {\n      oscillator: { type: 'sawtooth' },\n      envelope: {\n        attack: 0.3,\n        decay: 0.1,\n        sustain: 0.8,\n        release: 0.5,\n      },\n    }).toDestination();\n    const oscillatorType = synth.get().oscillator?.type ?? 'unknown';\n    console.log('[DroneAudio] Initialized drone synth', { oscillatorType });\n  }\n  return synth;\n}\n\n/**\n * Get the note name with octave from tonic and octave\n */\nfunction getNoteName(tonic: string, octave: number): string {\n  // Normalize tonic (handle flats)\n  const normalizedTonic = tonic.replace('b', '#').replace('Db', 'C#').replace('Eb', 'D#')\n    .replace('Gb', 'F#').replace('Ab', 'G#').replace('Bb', 'A#');\n  return `${normalizedTonic}${octave}`;\n}\n\n/**\n * Start playing the drone\n */\nexport async function startDrone(): Promise<void> {\n  // Ensure audio context is started (required for browsers)\n  await Tone.start();\n\n  const s = ensureSynth();\n  const note = getNoteName(appState.state.tonic, appState.state.drone.octave);\n\n  // Set volume (convert from dB scale used in app to Tone.js scale)\n  s.volume.value = appState.state.drone.volume;\n  console.log('[DroneAudio] Starting drone', {\n    note,\n    volume: s.volume.value,\n  });\n\n  // Release any current note before starting new one\n  if (currentNote) {\n    s.releaseAll();\n  }\n\n  currentNote = note;\n  s.triggerAttack(note);\n  isPlaying = true;\n}\n\n/**\n * Stop the drone\n */\nexport function stopDrone(): void {\n  if (synth && isPlaying) {\n    synth.releaseAll();\n    currentNote = null;\n    isPlaying = false;\n  }\n}\n\n/**\n * Update drone parameters (tonic, octave, volume)\n */\nexport function updateDrone(): void {\n  if (!isPlaying || !synth) return;\n\n  const newNote = getNoteName(appState.state.tonic, appState.state.drone.octave);\n  synth.volume.value = appState.state.drone.volume;\n  console.log('[DroneAudio] Updating drone', {\n    note: newNote,\n    volume: synth.volume.value,\n  });\n\n  if (newNote !== currentNote) {\n    synth.releaseAll();\n    synth.triggerAttack(newNote);\n    currentNote = newNote;\n  }\n}\n\n/**\n * Toggle drone on/off\n */\nexport async function toggleDrone(): Promise<void> {\n  if (isPlaying) {\n    stopDrone();\n  } else {\n    await startDrone();\n  }\n}\n\n/**\n * Check if drone is playing\n */\nexport function isDronePlaying(): boolean {\n  return isPlaying;\n}\n\n/**\n * Clean up resources\n */\nexport function dispose(): void {\n  stopDrone();\n  if (synth) {\n    synth.dispose();\n    synth = null;\n  }\n}\n","<script lang=\"ts\">\n  /**\n   * TonicSelector Component\n   *\n   * Dropdown for selecting the tonic/key center.\n   */\n\n  import { appState, type TonicNote } from '../../stores/appState.svelte.js';\n  import { updateDrone } from '../../services/droneAudio.js';\n\n  const TONIC_OPTIONS: TonicNote[] = [\n    'C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'\n  ];\n\n  function handleChange(event: Event) {\n    const target = event.target as HTMLSelectElement;\n    appState.setTonic(target.value as TonicNote);\n    updateDrone();\n  }\n</script>\n\n<div class=\"tonic-selector\">\n  <label for=\"tonic-select\">Key:</label>\n  <select\n    id=\"tonic-select\"\n    value={appState.state.tonic}\n    onchange={handleChange}\n  >\n    {#each TONIC_OPTIONS as tonic}\n      <option value={tonic}>{tonic}</option>\n    {/each}\n  </select>\n</div>\n\n<style>\n  .tonic-selector {\n    display: flex;\n    align-items: center;\n    gap: var(--spacing-sm);\n  }\n\n  label {\n    font-weight: 500;\n    color: var(--color-text-muted);\n  }\n\n  select {\n    padding: var(--spacing-sm) var(--spacing-md);\n    font-size: var(--font-size-base);\n    color: var(--color-text);\n    background-color: var(--color-surface);\n    border: 1px solid rgba(255, 255, 255, 0.1);\n    border-radius: var(--radius-sm);\n    cursor: pointer;\n    min-width: 70px;\n  }\n\n  select:hover {\n    border-color: var(--color-secondary);\n  }\n\n  select:focus {\n    outline: none;\n    border-color: var(--color-secondary);\n    box-shadow: 0 0 0 2px rgba(0, 217, 255, 0.2);\n  }\n</style>\n","<script lang=\"ts\">\n  /**\n   * DroneControls Component\n   *\n   * Controls for the drone reference tone.\n   */\n\n  import { appState } from '../../stores/appState.svelte.js';\n  import { toggleDrone, updateDrone } from '../../services/droneAudio.js';\n\n  const OCTAVE_OPTIONS = [2, 3, 4, 5];\n\n  async function handleToggle() {\n    await toggleDrone();\n    appState.toggleDrone();\n  }\n\n  function handleOctaveChange(event: Event) {\n    const target = event.target as HTMLSelectElement;\n    appState.setDroneOctave(parseInt(target.value, 10));\n    updateDrone();\n  }\n\n  function handleVolumeChange(event: Event) {\n    const target = event.target as HTMLInputElement;\n    appState.setDroneVolume(parseInt(target.value, 10));\n    updateDrone();\n  }\n</script>\n\n<div class=\"drone-controls\">\n  <button\n    class=\"drone-toggle\"\n    class:active={appState.state.drone.isPlaying}\n    onclick={handleToggle}\n  >\n    {appState.state.drone.isPlaying ? 'Drone On' : 'Drone Off'}\n  </button>\n\n  <div class=\"drone-settings\">\n    <label>\n      Oct:\n      <select value={appState.state.drone.octave} onchange={handleOctaveChange}>\n        {#each OCTAVE_OPTIONS as oct}\n          <option value={oct}>{oct}</option>\n        {/each}\n      </select>\n    </label>\n\n    <label>\n      Vol:\n      <input\n        type=\"range\"\n        min=\"-40\"\n        max=\"0\"\n        value={appState.state.drone.volume}\n        oninput={handleVolumeChange}\n      />\n    </label>\n  </div>\n</div>\n\n<style>\n  .drone-controls {\n    display: flex;\n    align-items: center;\n    gap: var(--spacing-md);\n  }\n\n  .drone-toggle {\n    padding: var(--spacing-sm) var(--spacing-md);\n    font-size: var(--font-size-sm);\n    font-weight: 500;\n    color: var(--color-text);\n    background-color: var(--color-surface);\n    border: 1px solid rgba(255, 255, 255, 0.1);\n    border-radius: var(--radius-sm);\n    transition: all 0.2s ease;\n  }\n\n  .drone-toggle:hover {\n    border-color: var(--color-secondary);\n  }\n\n  .drone-toggle.active {\n    background-color: var(--color-secondary);\n    color: var(--color-bg);\n    border-color: var(--color-secondary);\n  }\n\n  .drone-settings {\n    display: flex;\n    align-items: center;\n    gap: var(--spacing-md);\n  }\n\n  label {\n    display: flex;\n    align-items: center;\n    gap: var(--spacing-xs);\n    font-size: var(--font-size-sm);\n    color: var(--color-text-muted);\n  }\n\n  select {\n    padding: var(--spacing-xs) var(--spacing-sm);\n    font-size: var(--font-size-sm);\n    color: var(--color-text);\n    background-color: var(--color-surface);\n    border: 1px solid rgba(255, 255, 255, 0.1);\n    border-radius: var(--radius-sm);\n    cursor: pointer;\n  }\n\n  input[type='range'] {\n    width: 80px;\n    height: 4px;\n    cursor: pointer;\n  }\n</style>\n","<script lang=\"ts\">\n  /**\n   * ModeToggle Component\n   *\n   * Toggle between stationary and highway visualization modes.\n   */\n\n  import { appState, type VisualizationMode } from '../../stores/appState.svelte.js';\n\n  const modes: { value: VisualizationMode; label: string }[] = [\n    { value: 'stationary', label: 'Stationary' },\n    { value: 'highway', label: 'Highway' },\n  ];\n\n  function handleClick(mode: VisualizationMode) {\n    appState.setVisualizationMode(mode);\n  }\n</script>\n\n<div class=\"mode-toggle\">\n  {#each modes as { value, label }}\n    <button\n      class=\"mode-button\"\n      class:active={appState.state.visualizationMode === value}\n      onclick={() => handleClick(value)}\n    >\n      {label}\n    </button>\n  {/each}\n</div>\n\n<style>\n  .mode-toggle {\n    display: flex;\n    background-color: var(--color-surface);\n    border-radius: var(--radius-md);\n    padding: 4px;\n  }\n\n  .mode-button {\n    padding: var(--spacing-sm) var(--spacing-md);\n    font-size: var(--font-size-sm);\n    font-weight: 500;\n    color: var(--color-text-muted);\n    background: transparent;\n    border-radius: var(--radius-sm);\n    transition: all 0.2s ease;\n  }\n\n  .mode-button:hover:not(.active) {\n    color: var(--color-text);\n  }\n\n  .mode-button.active {\n    color: var(--color-bg);\n    background-color: var(--color-secondary);\n  }\n</style>\n","<script lang=\"ts\">\n\t/**\n\t * RangeControl Component\n\t *\n\t * Wrapper for DualPitchWheel that integrates with singing-trainer app state.\n\t * Converts between MIDI values (used in app state) and indices (used by wheels).\n\t */\n\timport { DualPitchWheel } from '@mlt/ui-components/pitch-wheels';\n\timport type { PitchWheelRange } from '@mlt/ui-components/pitch-wheels';\n\timport { fullRowData } from '@mlt/pitch-data';\n\timport { appState } from '../../stores/appState.svelte';\n\n\t// Convert MIDI to index in fullRowData\n\tfunction midiToIndex(midi: number): number {\n\t\tconst index = fullRowData.findIndex((p) => p.midi === midi);\n\t\treturn index >= 0 ? index : 0;\n\t}\n\n\t// Current indices derived from app state\n\tconst topIndex = $derived(midiToIndex(appState.state.yAxisRange.maxMidi));\n\tconst bottomIndex = $derived(midiToIndex(appState.state.yAxisRange.minMidi));\n\n\t// Handle range change from wheels\n\tfunction handleRangeChange(range: PitchWheelRange) {\n\t\tconst minMidi = range.bottomPitch.midi ?? 21;\n\t\tconst maxMidi = range.topPitch.midi ?? 108;\n\t\tappState.setYAxisRange({ minMidi, maxMidi });\n\t}\n</script>\n\n<div class=\"range-control\">\n\t<h3 class=\"control-title\">Pitch Range</h3>\n\t<DualPitchWheel\n\t\t{fullRowData}\n\t\t{topIndex}\n\t\t{bottomIndex}\n\t\tminSpan={7}\n\t\tonrangechange={handleRangeChange}\n\t\tshowSummary={true}\n\t\twheelHeight={200}\n\t/>\n</div>\n\n<style>\n\t.range-control {\n\t\tdisplay: flex;\n\t\tflex-direction: column;\n\t\tgap: 12px;\n\t\tpadding: 16px;\n\t\tbackground: rgba(255, 255, 255, 0.05);\n\t\tborder-radius: 12px;\n\t}\n\n\t.control-title {\n\t\tmargin: 0;\n\t\tfont-size: 0.85rem;\n\t\tfont-weight: 600;\n\t\tcolor: rgba(255, 255, 255, 0.9);\n\t\ttext-align: center;\n\t\tletter-spacing: 0.5px;\n\t}\n</style>\n","<script lang=\"ts\">\n  /**\n   * PitchReadout Component\n   *\n   * Displays the current detected pitch information.\n   */\n\n  import { pitchState } from '../../stores/pitchState.svelte.js';\n\n  const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];\n\n  const currentNote = $derived(() => {\n    const pitch = pitchState.state.currentPitch;\n    if (!pitch) return null;\n\n    const noteName = NOTE_NAMES[pitch.pitchClass];\n    const octave = Math.floor(pitch.midi / 12) - 1;\n    const cents = Math.round((pitch.midi - Math.round(pitch.midi)) * 100);\n\n    return {\n      name: noteName,\n      octave,\n      frequency: pitch.frequency.toFixed(1),\n      cents,\n      clarity: Math.round(pitch.clarity * 100),\n    };\n  });\n</script>\n\n<div class=\"pitch-readout\">\n  {#if currentNote()}\n    {@const note = currentNote()!}\n    <div class=\"note-display\">\n      <span class=\"note-name\">{note.name}</span>\n      <span class=\"octave\">{note.octave}</span>\n    </div>\n    <div class=\"details\">\n      <span class=\"frequency\">{note.frequency} Hz</span>\n      <span class=\"cents\" class:sharp={note.cents > 0} class:flat={note.cents < 0}>\n        {note.cents > 0 ? '+' : ''}{note.cents}Â¢\n      </span>\n      <span class=\"clarity\">{note.clarity}%</span>\n    </div>\n  {:else}\n    <div class=\"no-pitch\">\n      <span class=\"placeholder\">---</span>\n      <span class=\"hint\">Sing or hum into the microphone</span>\n    </div>\n  {/if}\n</div>\n\n<style>\n  .pitch-readout {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    justify-content: center;\n    padding: var(--spacing-lg);\n    background-color: var(--color-surface);\n    border-radius: var(--radius-md);\n    min-width: 200px;\n    min-height: 100px;\n  }\n\n  .note-display {\n    display: flex;\n    align-items: baseline;\n    gap: var(--spacing-xs);\n  }\n\n  .note-name {\n    font-size: var(--font-size-2xl);\n    font-weight: 700;\n    color: var(--color-secondary);\n  }\n\n  .octave {\n    font-size: var(--font-size-lg);\n    color: var(--color-text-muted);\n  }\n\n  .details {\n    display: flex;\n    gap: var(--spacing-md);\n    margin-top: var(--spacing-sm);\n    font-size: var(--font-size-sm);\n    color: var(--color-text-muted);\n  }\n\n  .cents {\n    font-weight: 500;\n  }\n\n  .cents.sharp {\n    color: var(--color-warning);\n  }\n\n  .cents.flat {\n    color: var(--color-primary);\n  }\n\n  .no-pitch {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    gap: var(--spacing-sm);\n  }\n\n  .placeholder {\n    font-size: var(--font-size-2xl);\n    color: var(--color-text-muted);\n  }\n\n  .hint {\n    font-size: var(--font-size-sm);\n    color: var(--color-text-muted);\n    opacity: 0.7;\n  }\n</style>\n","/**\n * Handoff State Store - Svelte 5 Runes\n *\n * Manages imported snapshot data from Student Notation.\n * This store handles the handoff lifecycle:\n * 1. Check for handoff on app load\n * 2. Import snapshot data\n * 3. Provide access to imported voices and grid structure\n * 4. Support \"Bring Back to Student Notation\" flow\n */\n\nimport {\n  consumeHandoffSlot,\n  checkForHandoff,\n  clearHandoffParams,\n  writeHandoffSlot,\n  navigateToStudentNotation,\n  type SingingTrainerSnapshot,\n  type SnapshotVoice,\n  type TimeGridStructure,\n  SNAPSHOT_SCHEMA_VERSION,\n} from '@mlt/handoff';\n\nexport interface HandoffState {\n  /** Whether a snapshot has been imported */\n  hasImportedSnapshot: boolean;\n  /** The imported snapshot (if any) */\n  snapshot: SingingTrainerSnapshot | null;\n  /** Loading state during handoff processing */\n  isLoading: boolean;\n  /** Error message if handoff failed */\n  error: string | null;\n  /** Transposition offset in semitones (positive = up) */\n  transpositionSemitones: number;\n}\n\nconst DEFAULT_STATE: HandoffState = {\n  hasImportedSnapshot: false,\n  snapshot: null,\n  isLoading: false,\n  error: null,\n  transpositionSemitones: 0,\n};\n\nfunction createHandoffState() {\n  let state = $state<HandoffState>({ ...DEFAULT_STATE });\n\n  return {\n    get state() {\n      return state;\n    },\n\n    /**\n     * Check for and consume any pending handoff on app initialization.\n     * Should be called once when the app loads.\n     */\n    async checkAndConsumeHandoff(): Promise<boolean> {\n      // First check URL params to see if we came from a handoff\n      const handoffInfo = checkForHandoff();\n\n      if (!handoffInfo) {\n        return false;\n      }\n\n      state.isLoading = true;\n      state.error = null;\n\n      try {\n        // Try to read and consume the snapshot from the handoff slot\n        const snapshot = await consumeHandoffSlot();\n\n        if (!snapshot) {\n          state.error = 'Handoff data expired or not found. Please try exporting again.';\n          state.isLoading = false;\n          clearHandoffParams();\n          return false;\n        }\n\n        // Validate schema version\n        if (snapshot.schemaVersion !== SNAPSHOT_SCHEMA_VERSION) {\n          state.error = `Incompatible snapshot version: ${snapshot.schemaVersion}. Expected: ${SNAPSHOT_SCHEMA_VERSION}`;\n          state.isLoading = false;\n          clearHandoffParams();\n          return false;\n        }\n\n        // Successfully imported\n        state.snapshot = snapshot;\n        state.hasImportedSnapshot = true;\n        state.isLoading = false;\n\n        // Clear URL params to keep the URL clean\n        clearHandoffParams();\n\n        console.log('[HandoffState] Successfully imported snapshot', {\n          voices: snapshot.voices.length,\n          microbeatCount: snapshot.timeGrid.microbeatCount,\n          tempo: snapshot.tempo,\n        });\n\n        return true;\n      } catch (error) {\n        console.error('[HandoffState] Failed to process handoff', error);\n        state.error = 'Failed to import data from Student Notation.';\n        state.isLoading = false;\n        clearHandoffParams();\n        return false;\n      }\n    },\n\n    /**\n     * Get the imported voices.\n     */\n    get voices(): SnapshotVoice[] {\n      return state.snapshot?.voices ?? [];\n    },\n\n    /**\n     * Get the time grid structure.\n     */\n    get timeGrid(): TimeGridStructure | null {\n      return state.snapshot?.timeGrid ?? null;\n    },\n\n    /**\n     * Get the tempo (with transposition applied to accompaniment).\n     */\n    get tempo(): number {\n      return state.snapshot?.tempo ?? 90;\n    },\n\n    /**\n     * Get the suggested pitch range based on imported notes.\n     */\n    get suggestedPitchRange(): { minMidi: number; maxMidi: number } | null {\n      if (!state.snapshot) {\n        return null;\n      }\n\n      const margin = 3; // Add a few semitones margin\n      const minMidi = state.snapshot.minMidiPitch;\n      const maxMidi = state.snapshot.maxMidiPitch;\n\n      if (minMidi === undefined || maxMidi === undefined) {\n        return null;\n      }\n\n      return {\n        minMidi: Math.max(21, minMidi - margin + state.transpositionSemitones),\n        maxMidi: Math.min(108, maxMidi + margin + state.transpositionSemitones),\n      };\n    },\n\n    /**\n     * Set transposition in semitones.\n     */\n    setTransposition(semitones: number) {\n      state.transpositionSemitones = semitones;\n    },\n\n    /**\n     * Transpose up by one semitone.\n     */\n    transposeUp() {\n      state.transpositionSemitones += 1;\n    },\n\n    /**\n     * Transpose down by one semitone.\n     */\n    transposeDown() {\n      state.transpositionSemitones -= 1;\n    },\n\n    /**\n     * Get a transposed MIDI pitch.\n     */\n    getTransposedMidi(originalMidi: number): number {\n      return originalMidi + state.transpositionSemitones;\n    },\n\n    /**\n     * Export current state back to Student Notation.\n     * Creates a new snapshot and navigates back.\n     */\n    async bringBackToStudentNotation(): Promise<void> {\n      if (!state.snapshot) {\n        console.warn('[HandoffState] No snapshot to bring back');\n        return;\n      }\n\n      // Create a modified snapshot for return\n      const returnSnapshot: SingingTrainerSnapshot = {\n        ...state.snapshot,\n        sourceApp: 'singing-trainer',\n        createdAt: Date.now(),\n        // Apply transposition to all voices\n        voices: state.snapshot.voices.map(voice => ({\n          ...voice,\n          notes: voice.notes.map(note => ({\n            ...note,\n            midiPitch: note.midiPitch + state.transpositionSemitones,\n          })),\n        })),\n      };\n\n      try {\n        const handoffId = await writeHandoffSlot(returnSnapshot);\n        console.log('[HandoffState] Handoff slot written for return', handoffId);\n        navigateToStudentNotation(handoffId);\n      } catch (error) {\n        console.error('[HandoffState] Failed to write return handoff', error);\n      }\n    },\n\n    /**\n     * Clear the imported snapshot.\n     */\n    clearSnapshot() {\n      state = { ...DEFAULT_STATE };\n    },\n\n    /**\n     * Reset the handoff state.\n     */\n    reset() {\n      state = { ...DEFAULT_STATE };\n    },\n  };\n}\n\nexport const handoffState = createHandoffState();\n","<script lang=\"ts\">\n  /**\n   * App Component\n   *\n   * Main application layout for the Singing Trainer.\n   */\n  import { onMount } from 'svelte';\n  import {\n    SingingCanvas,\n    StartButton,\n    TonicSelector,\n    DroneControls,\n    ModeToggle,\n    PitchReadout,\n    RangeControl,\n  } from './lib/components/index.js';\n  import { handoffState } from './lib/stores/handoffState.svelte.js';\n  import { appState } from './lib/stores/appState.svelte.js';\n\n  // Check for handoff on mount\n  onMount(async () => {\n    const wasHandoff = await handoffState.checkAndConsumeHandoff();\n\n    if (wasHandoff) {\n      console.log('[App] Handoff detected and processed');\n\n      // Update the pitch range based on imported data\n      const suggestedRange = handoffState.suggestedPitchRange;\n      if (suggestedRange) {\n        appState.setYAxisRange(suggestedRange);\n      }\n    }\n  });\n\n  // Reactive state\n  const hasImportedSnapshot = $derived(handoffState.state.hasImportedSnapshot);\n  const transposition = $derived(handoffState.state.transpositionSemitones);\n  const handoffError = $derived(handoffState.state.error);\n\n  function handleBringBack() {\n    handoffState.bringBackToStudentNotation();\n  }\n\n  function handleTransposeUp() {\n    handoffState.transposeUp();\n  }\n\n  function handleTransposeDown() {\n    handoffState.transposeDown();\n  }\n</script>\n\n<div class=\"app\">\n  <header class=\"header\">\n    <h1 class=\"title\">Singing Trainer</h1>\n    <div class=\"header-controls\">\n      {#if hasImportedSnapshot}\n        <div class=\"handoff-controls\">\n          <div class=\"transposition-control\">\n            <button class=\"transpose-btn\" onclick={handleTransposeDown} title=\"Transpose down\">-</button>\n            <span class=\"transposition-label\">\n              {transposition >= 0 ? '+' : ''}{transposition}\n            </span>\n            <button class=\"transpose-btn\" onclick={handleTransposeUp} title=\"Transpose up\">+</button>\n          </div>\n          <button class=\"bring-back-btn\" onclick={handleBringBack}>\n            Bring Back to Student Notation\n          </button>\n        </div>\n      {/if}\n      <ModeToggle />\n    </div>\n  </header>\n\n  {#if handoffError}\n    <div class=\"error-banner\">\n      {handoffError}\n    </div>\n  {/if}\n\n  <main class=\"main\">\n    <aside class=\"sidebar sidebar--left\">\n      <div class=\"control-group\">\n        <StartButton />\n      </div>\n\n      <div class=\"control-group\">\n        <PitchReadout />\n      </div>\n\n      <div class=\"control-group\">\n        <h3 class=\"control-group-title\">Settings</h3>\n        <TonicSelector />\n        <DroneControls />\n      </div>\n\n      <div class=\"control-group\">\n        <RangeControl />\n      </div>\n\n      {#if hasImportedSnapshot}\n        <div class=\"control-group\">\n          <h3 class=\"control-group-title\">Imported Material</h3>\n          <div class=\"import-info\">\n            <span class=\"import-label\">Voices:</span>\n            <span class=\"import-value\">{handoffState.voices.length}</span>\n          </div>\n          <div class=\"import-info\">\n            <span class=\"import-label\">Tempo:</span>\n            <span class=\"import-value\">{handoffState.tempo} BPM</span>\n          </div>\n          {#if handoffState.timeGrid}\n            <div class=\"import-info\">\n              <span class=\"import-label\">Microbeats:</span>\n              <span class=\"import-value\">{handoffState.timeGrid.microbeatCount}</span>\n            </div>\n          {/if}\n        </div>\n      {/if}\n    </aside>\n\n    <section class=\"canvas-area\">\n      <SingingCanvas />\n    </section>\n  </main>\n</div>\n\n<style>\n  .app {\n    display: flex;\n    flex-direction: column;\n    height: 100%;\n    width: 100%;\n  }\n\n  .header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: var(--spacing-md) var(--spacing-lg);\n    background-color: var(--color-bg-light);\n    border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n  }\n\n  .title {\n    font-size: var(--font-size-xl);\n    font-weight: 700;\n    color: var(--color-text);\n    margin: 0;\n  }\n\n  .header-controls {\n    display: flex;\n    gap: var(--spacing-md);\n  }\n\n  .main {\n    display: flex;\n    flex: 1;\n    overflow: hidden;\n  }\n\n  .sidebar {\n    display: flex;\n    flex-direction: column;\n    gap: var(--spacing-lg);\n    padding: var(--spacing-lg);\n    background-color: var(--color-bg-light);\n    border-right: 1px solid rgba(255, 255, 255, 0.1);\n    min-width: 260px;\n    max-width: 300px;\n    overflow-y: auto; /* Allow vertical scrolling */\n  }\n\n  .control-group {\n    display: flex;\n    flex-direction: column;\n    gap: var(--spacing-md);\n  }\n\n  .control-group-title {\n    font-size: var(--font-size-sm);\n    font-weight: 600;\n    color: var(--color-text-muted);\n    text-transform: uppercase;\n    letter-spacing: 0.05em;\n    margin: 0;\n  }\n\n  .canvas-area {\n    flex: 1;\n    display: flex;\n    padding: var(--spacing-lg);\n    overflow: hidden;\n  }\n\n  /* Handoff controls */\n  .handoff-controls {\n    display: flex;\n    align-items: center;\n    gap: var(--spacing-md);\n  }\n\n  .transposition-control {\n    display: flex;\n    align-items: center;\n    gap: var(--spacing-xs);\n    background-color: var(--color-bg);\n    border-radius: var(--radius-md);\n    padding: var(--spacing-xs) var(--spacing-sm);\n  }\n\n  .transpose-btn {\n    width: 28px;\n    height: 28px;\n    border: none;\n    border-radius: var(--radius-sm);\n    background-color: var(--color-bg-light);\n    color: var(--color-text);\n    font-size: var(--font-size-lg);\n    font-weight: 600;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    transition: background-color 0.15s ease;\n  }\n\n  .transpose-btn:hover {\n    background-color: var(--color-primary);\n    color: white;\n  }\n\n  .transposition-label {\n    font-size: var(--font-size-sm);\n    font-weight: 600;\n    color: var(--color-text);\n    min-width: 32px;\n    text-align: center;\n  }\n\n  .bring-back-btn {\n    padding: var(--spacing-sm) var(--spacing-md);\n    border: none;\n    border-radius: var(--radius-md);\n    background-color: var(--color-primary);\n    color: white;\n    font-size: var(--font-size-sm);\n    font-weight: 600;\n    cursor: pointer;\n    transition: background-color 0.15s ease;\n  }\n\n  .bring-back-btn:hover {\n    background-color: var(--color-primary-dark, #4a7bc8);\n  }\n\n  /* Error banner */\n  .error-banner {\n    background-color: var(--color-error, #dc3545);\n    color: white;\n    padding: var(--spacing-sm) var(--spacing-lg);\n    text-align: center;\n    font-size: var(--font-size-sm);\n  }\n\n  /* Import info */\n  .import-info {\n    display: flex;\n    justify-content: space-between;\n    font-size: var(--font-size-sm);\n    padding: var(--spacing-xs) 0;\n  }\n\n  .import-label {\n    color: var(--color-text-muted);\n  }\n\n  .import-value {\n    color: var(--color-text);\n    font-weight: 600;\n  }\n</style>\n","import { mount as svelteMount, unmount } from 'svelte';\nimport App from './App.svelte';\nimport './styles/global.css';\n\nexport type SingingTrainerInstance = {\n  destroy: () => void;\n};\n\nexport function mountSingingTrainer(container: HTMLElement): SingingTrainerInstance {\n  const app = svelteMount(App, { target: container });\n  return {\n    destroy: () => unmount(app),\n  };\n}\n\nexport const mount = mountSingingTrainer;\n\nexport default mountSingingTrainer;\n"],"names":["DEFAULT_STATE","createAppState","state","$","isDetecting","mode","tonic","useDegrees","show","range","octave","volume","appState","MAX_HISTORY_LENGTH","createPitchState","pitch","point","stable","pitchState","createHighwayState","animationFrameId","updateTime","pausedDuration","notes","noteIndex","note","i","x","pps","ms","highwayState","container","containerWidth","containerHeight","trailCanvas","trailCtx","trailAnimationId","lastTrailLogAt","trailFrameSamples","trailFrameTimeTotal","cellWidth","showOctaveLabels","showFrequencyLabels","LEGEND_COLUMN_WIDTH_UNITS","legendColumnWidth","legendCanvasWidth","legendTotalWidth","gridWidth","gridOffsetX","getDebugTrailFlag","fullRowData","generateRowDataForMidiRange","viewportWindow","calculateViewportWindow","convertTargetNotes","n","trailConfig","getTonicPitchClass","singingConfig","highwayConfig","viewport","setupTrailCanvas","dpr","ctx","renderTrail","trailHistory","debugTrail","frameStart","coords","createTimeCoordinates","userPitchConfig","currentTime","drawUserPitchTrace","now","avgMs","startTrailLoop","loop","stopTrailLoop","resizeObserver","entries","entry","onDestroy","div","root","PitchGrid","node","canvas","$$value","CONFIG","mic","analyser","detector","isRunning","stablePitchClass","stablePitchCounter","targetOpacity","targetSize","frequencyToMidi","frequency","animationLoop","waveform","clarity","Tone","isValidPitch","midi","detectedPitch","currentPitchClass","currentStable","newOpacity","newSize","startDetection","PitchDetector","err","cleanup","stopDetection","isLoading","handleClick","button","$$render","consequent_1","alternate","consequent","alternate_1","classes","$$anchor","synth","isPlaying","currentNote","ensureSynth","oscillatorType","_a","getNoteName","startDrone","s","stopDrone","updateDrone","newNote","toggleDrone","TONIC_OPTIONS","handleChange","event","target","select","option","root_1","OCTAVE_OPTIONS","handleToggle","handleOctaveChange","handleVolumeChange","text","div_1","label","oct","label_1","input","select_value","modes","$$item","value","midiToIndex","index","p","topIndex","bottomIndex","handleRangeChange","minMidi","maxMidi","DualPitchWheel","NOTE_NAMES","noteName","cents","fragment","span","span_1","div_2","span_2","span_3","span_4","text_1","text_2","text_4","div_3","root_2","createHandoffState","checkForHandoff","snapshot","consumeHandoffSlot","SNAPSHOT_SCHEMA_VERSION","clearHandoffParams","error","margin","semitones","originalMidi","returnSnapshot","voice","handoffId","writeHandoffSlot","navigateToStudentNotation","handoffState","onMount","suggestedRange","hasImportedSnapshot","transposition","handoffError","handleBringBack","handleTransposeUp","handleTransposeDown","header","button_1","button_2","ModeToggle","node_1","div_4","main","node_2","aside","div_5","StartButton","node_3","div_6","PitchReadout","node_4","div_7","TonicSelector","node_5","DroneControls","node_6","div_8","RangeControl","node_7","div_9","root_3","div_10","div_11","div_12","root_4","consequent_2","text_3","consequent_3","section","SingingCanvas","node_10","mountSingingTrainer","app","svelteMount","App","unmount","mount"],"mappings":"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"}