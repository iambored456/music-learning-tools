import"./modulepreload-polyfill-B5Qt9EMX.js";import{o as en,q as Tn,r as Pn,v as Cn,w as Sn,x as Ve,y as xn,z as Pt,A as Ct,B as In,C as An,D as Rn,S as tn,E as Nn,F as kn,P as Ln,g as t,G as Dn,H as Hn,i as ke,k as E,I as En,J as On,K as Fn,L as Wn,M as Bn,N as Gn,O as Yn,Q as qn,R as Un,p as pe,u as Re,h as z,l as I,f as D,c as p,s as w,a as k,j as ye,e as Te,t as Z,b as Y,T as Vn,d as Oe,U as Ke,V as Je,$ as nn,W as Xn,X as jn,m as zn,n as Kn}from"./legacy-BJBcSenI.js";import{o as an,j as Ge,i as $,q as Zn,t as Jn,k as St,h as Ye,f as dt,u as Qn,w as $n,v as ei,x as ti,y as ni,A as tt,S as Nt}from"./navigation-BnREHJnM.js";import{s as xt,V as ii,S as sn,l as kt,U as ai,A as si,g as oi,P as ri}from"./vendor-tone-Cer4uW5H.js";import{P as li}from"./vendor-pitchy-DoA2xU7W.js";import{e as qe,i as et,s as st}from"./style-CtguFRYq.js";function It(e,n,i=!1){if(e.multiple){if(n==null)return;if(!Tn(n))return Pn();for(var a of e.options)a.selected=n.includes(Lt(a));return}for(a of e.options){var r=Lt(a);if(Cn(r,n)){a.selected=!0;return}}(!i||n!==void 0)&&(e.selectedIndex=-1)}function on(e){var n=new MutationObserver(()=>{It(e,e.__value)});n.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),en(()=>{n.disconnect()})}function Lt(e){return"__value"in e?e.__value:e.value}function ut(e,n,i=n){var a=new WeakSet;Sn(e,"input",async r=>{var o=r?e.defaultValue:e.value;if(o=ft(e)?ht(o):o,i(o),Ve!==null&&a.add(Ve),await xn(),o!==(o=n())){var s=e.selectionStart,c=e.selectionEnd,l=e.value.length;if(e.value=o??"",c!==null){var d=e.value.length;s===c&&c===l&&d>l?(e.selectionStart=d,e.selectionEnd=d):(e.selectionStart=s,e.selectionEnd=Math.min(c,d))}}}),Pt(n)==null&&e.value&&(i(ft(e)?ht(e.value):e.value),Ve!==null&&a.add(Ve)),Ct(()=>{var r=n();if(e===document.activeElement){var o=In??Ve;if(a.has(o))return}ft(e)&&r===ht(e.value)||e.type==="date"&&!r&&!e.value||r!==e.value&&(e.value=r??"")})}function ft(e){var n=e.type;return n==="number"||n==="range"}function ht(e){return e===""?null:+e}function Dt(e,n){return e===n||e?.[tn]===n}function Ne(e={},n,i,a){return An(()=>{var r,o;return Ct(()=>{r=o,o=[],Pt(()=>{e!==i(...o)&&(n(e,...o),r&&Dt(i(...r),e)&&n(null,...r))})}),()=>{Rn(()=>{o&&Dt(i(...o),e)&&n(null,...o)})}}),e}function rn(e,n,i,a,r){var o=()=>{a(i[e])};i.addEventListener(n,o),r?Ct(()=>{i[e]=r()}):o(),(i===document.body||i===window||i===document)&&en(()=>{i.removeEventListener(n,o)})}let nt=!1;function ci(e){var n=nt;try{return nt=!1,[e(),nt]}finally{nt=n}}function fe(e,n,i,a){var r=!Bn||(i&Gn)!==0,o=(i&Wn)!==0,s=(i&qn)!==0,c=a,l=!0,d=()=>(l&&(l=!1,c=s?Pt(a):a),c),g;if(o){var v=tn in e||Un in e;g=Nn(e,n)?.set??(v&&n in e?M=>e[n]=M:void 0)}var f,y=!1;o?[f,y]=ci(()=>e[n]):f=e[n],f===void 0&&a!==void 0&&(f=d(),g&&(r&&kn(),g(f)));var h;if(r?h=()=>{var M=e[n];return M===void 0?d():(l=!0,M)}:h=()=>{var M=e[n];return M!==void 0&&(c=void 0),M===void 0?c:M},r&&(i&Ln)===0)return h;if(g){var u=e.$$legacy;return(function(M,A){return arguments.length>0?((!r||!A||u||y)&&g(A?h():M),M):h()})}var m=!1,b=((i&Yn)!==0?Dn:Hn)(()=>(m=!1,h()));o&&t(b);var T=On;return(function(M,A){if(arguments.length>0){const C=A?t(b):r&&o?ke(M):M;return E(b,C),m=!0,c!==void 0&&(c=C),M}return En&&m||(T.f&Fn)!==0?b.v:t(b)})}const bt=["#ef8aab","#f48e7d","#e89955","#cdaa42","#a4ba57","#6ec482","#2dc8b1","#16c3da","#58b8f6","#8fa9ff","#ba9bf2","#db8fd4"],Ht=bt[0];function Et(e){const n=parseInt(e.slice(1),16);return[n>>16&255,n>>8&255,n&255]}function di(e,n,i){const a=Math.max(0,Math.min(1,i));return e.map((r,o)=>{const s=n[o]??r;return Math.round(r+a*(s-r))})}function ln(e,n=0){const i=Math.floor(e),a=e-i,r=(i%12-n+12)%12,o=(r+1)%12,s=Et(bt[r]??Ht),c=Et(bt[o]??Ht);return di(s,c,a)}const ui={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11};function fi(e){const n=e.replace(/\d+$/,"");return ui[n]??0}const gt={onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70,accuracyTiers:{perfect:{onsetMs:30,pitchCents:10,coverage:95},good:{onsetMs:75,pitchCents:25,coverage:85},okay:{onsetMs:150,pitchCents:50,coverage:70}}};function hi(e={}){const n={...gt,...e,accuracyTiers:e.accuracyTiers?{...gt.accuracyTiers,...e.accuracyTiers}:gt.accuracyTiers},i=new Map,a=new Map;function r(v,f){return(v-f)*100}function o(v,f){return Math.abs(r(v.midi,f))<=n.pitchToleranceCents}function s(v,f){return v.length===0?0:v.reduce((h,u)=>h+Math.abs(r(u.midi,f)),0)/v.length}function c(v,f,y,h){if(v.length===0)return 0;const u=v.filter(b=>o(b,f));if(u.length===0)return 0;let m=0;for(let b=0;b<u.length;b++){const T=u[b];if(!T)continue;const M=u[b+1];if(M)m+=M.timeMs-T.timeMs;else{const A=y+h,C=Math.min(50,A-T.timeMs);m+=C}}return m/h*100}function l(v,f,y){const h=n.accuracyTiers;if(!h)return"okay";const u=Math.abs(v);return u<=h.perfect.onsetMs&&f<=h.perfect.pitchCents&&y>=h.perfect.coverage?"perfect":u<=h.good.onsetMs&&f<=h.good.pitchCents&&y>=h.good.coverage?"good":u<=h.okay.onsetMs&&f<=h.okay.pitchCents&&y>=h.okay.coverage?"okay":"miss"}function d(v){const{note:f,samples:y,onsetSample:h,releaseSample:u}=v;let m=0;h?m=h.timeMs-f.startTimeMs:m=n.onsetToleranceMs*2;let b=0;const T=f.startTimeMs+f.durationMs;u?b=u.timeMs-T:b=n.releaseToleranceMs*2;const M=s(y,f.midi),A=c(y,f.midi,f.startTimeMs,f.durationMs),C=Math.abs(m)<=n.onsetToleranceMs,P=Math.abs(b)<=n.releaseToleranceMs,x=A>=n.hitThreshold,L=C&&P&&x?"hit":"miss",N=l(m,M,A);return{hitStatus:L,onsetAccuracyMs:m,releaseAccuracyMs:b,pitchAccuracyCents:M,pitchCoverage:A,pitchSamples:[...y],accuracyTier:N}}return{startNote(v,f){i.set(v,{note:f,samples:[],onsetSample:null,releaseSample:null,startedAt:performance.now()})},recordPitchSample(v){for(const[f,y]of i){const{note:h}=y,u=h.startTimeMs+h.durationMs,m=n.onsetToleranceMs,b=n.releaseToleranceMs;v.timeMs>=h.startTimeMs-m&&v.timeMs<=u+b&&(y.samples.push(v),!y.onsetSample&&v.timeMs>=h.startTimeMs-m&&v.timeMs<=h.startTimeMs+m&&o(v,h.midi)&&(y.onsetSample=v),v.timeMs>=u-b&&v.timeMs<=u+b&&(y.releaseSample=v))}},endNote(v){const f=i.get(v);if(!f)return null;const y=d(f);return a.set(v,y),i.delete(v),y},getCurrentPerformance(v){const f=i.get(v);if(!f)return null;const{note:y,samples:h,onsetSample:u}=f;let m=0;u&&(m=u.timeMs-y.startTimeMs);const b=s(h,y.midi),T=c(h,y.midi,y.startTimeMs,y.durationMs);return{onsetAccuracyMs:m,pitchAccuracyCents:b,pitchCoverage:T,pitchSamples:[...h]}},getAllPerformances(){return new Map(a)},reset(){i.clear(),a.clear()},dispose(){i.clear(),a.clear()}}}const Ot={judgmentLinePosition:.12,pixelsPerSecond:200,lookAheadMs:3e3,scrollMode:"constant-speed",leadInBeats:4,playMetronomeDuringOnramp:!0,playTargetNotes:!0,playMetronome:!1,inputSources:["microphone"],feedbackConfig:{onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70}};function gi(e){const n={...Ot,...e,feedbackConfig:{...Ot.feedbackConfig,...e.feedbackConfig}},{stateCallbacks:i,eventCallbacks:a,visualCallbacks:r,logger:o}=n,s={isPlaying:!1,isPaused:!1,currentTimeMs:0,scrollOffset:0,onrampComplete:!1,targetNotes:[],activeNotes:new Set,startTime:null},c=hi(n.feedbackConfig);let l=null;const d=new Set;function g(){const P=60/i.getTempo()*1e3;return n.leadInBeats*P}function v(){return i.getViewportWidth()*n.judgmentLinePosition}function f(C){const P=n.pixelsPerSecond/1e3,x=v(),L=g();return(C+L)*P-x}function y(C){const P=v(),x=i.getCellWidth(),L=C.startColumn*x-s.scrollOffset,N=C.endColumn*x-s.scrollOffset,H=n.feedbackConfig.onsetToleranceMs/1e3*n.pixelsPerSecond;return L<=P+H&&N>=P-H}function h(){const C=new Set;for(const P of s.targetNotes){const x=P.startTimeMs+P.durationMs,L=n.feedbackConfig.onsetToleranceMs;if(s.currentTimeMs>=P.startTimeMs-L&&s.currentTimeMs<=x+L)C.add(P.id),s.activeNotes.has(P.id)||(c.startNote(P.id,P),o?.debug("NoteHighway",`Note ${P.id} became active`,{note:P}));else if(s.activeNotes.has(P.id)){const N=c.endNote(P.id);if(N){P.performance=N;const O={noteId:P.id,note:P,performance:N};N.hitStatus==="hit"?(a.emit("noteHit",O),r?.onNoteHit?.(P.id,N.accuracyTier||"okay"),o?.info("NoteHighway",`Note hit: ${P.id}`,N)):(a.emit("noteMissed",O),r?.onNoteMiss?.(P.id),o?.info("NoteHighway",`Note missed: ${P.id}`,N))}}}s.activeNotes=C}function u(){for(const C of s.targetNotes){const P=y(C),x=d.has(C.id);P&&!x?(d.add(C.id),a.emit("noteEntered",{noteId:C.id,note:C})):!P&&x&&(d.delete(C.id),a.emit("noteExited",{noteId:C.id,note:C}))}}function m(){if(!s.onrampComplete)if(s.currentTimeMs>=0)s.onrampComplete=!0,a.emit("onrampComplete"),r?.clearOnrampCountdown?.(),o?.info("NoteHighway","Onramp complete",null);else{const P=60/i.getTempo()*1e3,x=Math.abs(s.currentTimeMs),L=Math.ceil(x/P);r?.updateOnrampCountdown?.(L)}}function b(){if(!s.isPlaying||s.isPaused||!s.startTime){l=null;return}const C=performance.now(),P=g();s.currentTimeMs=C-s.startTime-P,s.scrollOffset=f(s.currentTimeMs),m(),h(),u(),l=requestAnimationFrame(b)}function T(){l||(l=requestAnimationFrame(b))}function M(){l&&(cancelAnimationFrame(l),l=null)}return{init(C){s.targetNotes=C,o?.info("NoteHighway",`Initialized with ${C.length} notes`,null)},start(){s.isPlaying||(s.isPlaying=!0,s.isPaused=!1,s.currentTimeMs=-g(),s.scrollOffset=f(s.currentTimeMs),s.onrampComplete=!1,s.activeNotes.clear(),s.startTime=performance.now(),d.clear(),c.reset(),T(),a.emit("playbackStarted"),o?.info("NoteHighway","Playback started",{onrampDurationMs:g()}))},pause(){!s.isPlaying||s.isPaused||(s.isPaused=!0,M(),a.emit("playbackPaused"),o?.info("NoteHighway","Playback paused",{currentTimeMs:s.currentTimeMs}))},resume(){if(!s.isPlaying||!s.isPaused||!s.startTime)return;const C=performance.now()-(s.startTime+s.currentTimeMs+g());s.startTime+=C,s.isPaused=!1,T(),a.emit("playbackResumed"),o?.info("NoteHighway","Playback resumed",null)},stop(){if(!s.isPlaying)return;s.isPlaying=!1,s.isPaused=!1,s.currentTimeMs=0,s.scrollOffset=0,s.onrampComplete=!1,s.activeNotes.clear(),s.startTime=null,d.clear(),M(),r?.clearCanvas?.(),r?.clearOnrampCountdown?.(),a.emit("playbackStopped"),s.targetNotes.every(P=>P.performance!==void 0)&&a.emit("performanceComplete"),o?.info("NoteHighway","Playback stopped",null)},setScrollOffset(C){if(s.currentTimeMs=C,s.scrollOffset=f(C),s.isPlaying){const P=g();s.startTime=performance.now()-(C+P)}o?.debug("NoteHighway","Scroll offset set",{timeMs:C,scrollOffset:s.scrollOffset})},recordPitchInput(C,P,x){if(!s.isPlaying||s.isPaused||!n.inputSources.includes(x))return;const L={timeMs:s.currentTimeMs,midi:C,clarity:P,source:x};c.recordPitchSample(L)},getState(){return s},getVisibleNotes(){v();const C=i.getViewportWidth(),P=i.getCellWidth();return s.targetNotes.filter(x=>{const L=x.startColumn*P-s.scrollOffset;return x.endColumn*P-s.scrollOffset>=0&&L<=C})},getPerformanceResults(){return c.getAllPerformances()},getFeedbackCollector(){return c},dispose(){M(),c.dispose(),s.targetNotes=[],s.activeNotes.clear(),d.clear(),o?.info("NoteHighway","Service disposed",null)}}}function vi(e){const{cellHeight:n,columnWidths:i,viewport:a}=e,r=n/2,o=mi(i,e.cellWidth);return{getRowY(s){return(s-a.startRow+1)*r},getRowFromY(s){const c=s/r-1;return Math.round(c)+a.startRow},getColumnX(s){return s<0?0:s>=o.length?o[o.length-1]??0:o[s]??0},getColumnFromX(s){let c=0,l=o.length-1;for(;c<l;){const d=Math.floor((c+l)/2);(o[d]??0)<=s?c=d+1:l=d}return Math.max(0,c-1)}}}function cn(e){const{cellHeight:n,viewport:i,pixelsPerSecond:a,nowLineX:r=100,currentTimeMs:o=0}=e,s=n/2;return{getRowY(c){return(c-i.startRow+1)*s},getRowFromY(c){const l=c/s-1;return Math.round(l)+i.startRow},getColumnX(c){return 0},getColumnFromX(c){return 0},getTimeX(c){const l=c-o;return r+l/1e3*a},getTimeFromX(c){const l=(c-r)/a*1e3;return o+l}}}function mi(e,n){const i=[0];let a=0;for(let r=0;r<e.length;r++){const o=(e[r]??1)*n;a+=o,i.push(a)}return i}function pi(e,n){const{startRow:i,endRow:a}=e,r=Math.max(0,n.length-1);return{startRow:i,endRow:a,paddedStartRow:Math.max(0,i-1),paddedEndRow:Math.min(r,a+1)}}function vt(e,n,i,a){const r=a.getRowY(e),o=i;return r>=-o&&r<=n.containerHeight+o}function yi(e){let n=(e||"").replace(/\d/g,"").trim();return n=n.replace(/b/g,"b-").replace(/#/g,"b_"),n}function bi(e){switch(e){case"C":return{lineWidth:3.33,dash:[],color:"#adb5bd"};case"E":return{lineWidth:1,dash:[5,5],color:"#adb5bd"};case"G":return{lineWidth:1,dash:[],color:"#dee2e6"};case"B":case"A":case"F":case"Eb/Db":case"Db/C#":return{lineWidth:1,dash:[],color:"#ced4da"};default:return{lineWidth:1,dash:[],color:"#ced4da"}}}const it={stroke:"#c7cfd8",background:"rgba(207, 214, 222, 0.32)"};let Xe=null;function wi(){if(Xe)return Xe;if(typeof window>"u")return it;try{const e=window.getComputedStyle(document.documentElement);Xe={stroke:e.getPropertyValue("--c-anacrusis-border").trim()||it.stroke,background:e.getPropertyValue("--c-anacrusis-bg").trim()||it.background}}catch{Xe=it}return Xe}function Mi(e,n,i,a,r,o=0,s){const{fullRowData:c,viewportHeight:l,viewportWidth:d,cellHeight:g}=n,v=d,f=["B","A","F","Eâ™­/Dâ™¯","Dâ™­/Câ™¯"];for(let y=a;y<=r;y++){const h=c[y];if(!h||h.isBoundary)continue;const u=i.getRowY(y);if(u<-10||u>l+10)continue;const m=yi(h.pitch);if(f.includes(m))continue;const b=bi(m);m==="G"?(e.save(),e.fillStyle=b.color,e.fillRect(o,u-g/2,v-o,g),e.restore()):(e.beginPath(),e.moveTo(o,u),e.lineTo(v,u),e.lineWidth=b.lineWidth,e.strokeStyle=b.color,e.setLineDash(b.dash),e.stroke(),e.setLineDash([]))}}function _i(e,n,i,a){const{columnWidths:r,viewportHeight:o,macrobeatBoundaryStyles:s,placedTonicSigns:c}=n,l=r.length;for(let d=0;d<=l;d++){const g=d===0||d===l,v=Pi(d,c),f=c.some(b=>d===b.columnIndex+2),y=a.includes(d);if(!Ci(d,c))continue;let u=null;if(g||v||f)u={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(y){const b=a.indexOf(d),T=s[b]??"dashed";if(T==="anacrusis"){const{stroke:M}=wi();u={lineWidth:1,strokeStyle:M,dash:[4,4]}}else u={lineWidth:1,strokeStyle:"#adb5bd",dash:T==="solid"?[]:[5,5]}}if(!u)continue;const m=i.getColumnX(d);e.beginPath(),e.moveTo(m,0),e.lineTo(m,o),e.lineWidth=u.lineWidth,e.strokeStyle=u.strokeStyle,e.setLineDash(u.dash),e.stroke()}e.setLineDash([])}function Ti(e,n,i){const{viewportHeight:a,beatIntervalMs:r,measureIntervalMs:o,visibleTimeRange:s,nowLineX:c,beatTimeOffsetMs:l=0}=n,d=s.startMs-l,g=s.endMs-l,v=Math.floor(d/r),f=Math.ceil(g/r);for(let y=v;y<=f;y++){const h=l+y*r,u=i.getTimeX?.(h);if(u===void 0)continue;const m=o?(h-l)%o===0:!1;e.beginPath(),e.moveTo(u,0),e.lineTo(u,a),e.lineWidth=m?2:1,e.strokeStyle=m?"#adb5bd":"#dee2e6",e.setLineDash(m?[]:[5,5]),e.stroke()}e.setLineDash([]),c!==void 0&&(e.beginPath(),e.moveTo(c,0),e.lineTo(c,a),e.lineWidth=3,e.strokeStyle="#00ff00",e.setLineDash([]),e.stroke())}function Pi(e,n){return n.some(i=>i.columnIndex===e)}function Ci(e,n){return!n.some(i=>i.columnIndex+1===e)}const Si=.7,xi=.9,Ii=4,Ai=1,Ri=.15,Ni=.2,ki=1,At=1.5;function Ze(e,n){return Number.isFinite(e)&&e>0&&Number.isFinite(n)&&n>0}function dn(e){if(!e||typeof e.startColumnIndex!="number"||typeof e.endColumnIndex!="number")return!1;const n=e.shape==="circle"?e.startColumnIndex+1:e.startColumnIndex;return e.endColumnIndex>n}function ot(e){const n=e?.split("-")[1];return Number.parseInt(n??"0",10)}function un(e,n,i){const a=i*.25,r=e.uuid;if(!r)return 0;const o=n.filter(l=>!l.isDrum&&l.row===e.row&&l.startColumnIndex===e.startColumnIndex&&l.uuid&&l.uuid!==r);if(o.length===0)return 0;const s=[e,...o];return s.sort((l,d)=>ot(l.uuid)-ot(d.uuid)),s.findIndex(l=>l.uuid===r)*a}function Li(e,n,i){const a=i/2*.12,r=e.uuid;if(!r)return 0;const o=n.filter(l=>!l.isDrum&&l.row===e.row&&l.startColumnIndex===e.startColumnIndex&&l.uuid&&l.uuid!==r&&dn(l));if(o.length===0)return 0;const s=[e,...o];return s.sort((l,d)=>ot(l.uuid)-ot(d.uuid)),s.findIndex(l=>l.uuid===r)*a}function Di(e){if(!e)return{multiplier:1,category:"natural"};const n=e.includes("â™­"),i=e.includes("â™¯"),a=e.includes("/");return!n&&!i?{multiplier:1,category:"natural"}:a?{multiplier:.75,category:"both-accidentals"}:{multiplier:.88,category:"single-accidental"}}function wt(e,n,i,a,r,o){const{multiplier:s,category:c}=Di(n);let l;if(i==="circle"){const d=o*2*xi;switch(c){case"natural":l=d;break;case"single-accidental":l=d*.8;break;case"both-accidentals":l=d*.4;break;default:l=d*s}}else{const d=o*2*Si;switch(c){case"natural":l=d*1.5;break;case"single-accidental":l=d*1.2;break;case"both-accidentals":l=d;break;default:l=d*s}}if(!(l<Ii))if(e.fillStyle="#212529",e.font=`bold ${l}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle",i==="oval"&&c==="both-accidentals"&&n.includes("/")){const d=n.split("/"),g=l*1.1,v=g*(d.length-1),f=r-v/2;d.forEach((y,h)=>{const u=f+h*g,m=l*.08;e.fillText(y.trim(),a,u+m)})}else{const d=l*.08;e.fillText(n,a,r+d)}}function Hi(e,n,i,a,r,o,s){e.save(),e.beginPath(),e.arc(i,r,o,Math.PI/2,-Math.PI/2,!1),e.lineTo(a,r-o),e.arc(a,r,o,-Math.PI/2,Math.PI/2,!1),e.lineTo(i,r+o),e.closePath(),e.strokeStyle=n.color,e.lineWidth=s,e.shadowColor=n.color,e.shadowBlur=At,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore()}function Ft(e,n,i,a){const{config:r,coords:o,allNotes:s,getScaleDegreeLabel:c}=n,{cellWidth:l,cellHeight:d,columnWidths:g,degreeDisplayMode:v}=r,f=o.getRowY(a),y=o.getColumnX(i.startColumnIndex),u=(g[i.startColumnIndex]??1)*l;if(!Ze(u,d))return;const m=un(i,s,l),b=Math.max(.5,u*.15),T=y+u/2+m,M=u/2-b/2,A=d/2-b/2;if(Ze(M,A)&&(e.save(),e.beginPath(),e.ellipse(T,f,M,A,0,0,2*Math.PI),e.strokeStyle=i.color,e.lineWidth=b,e.shadowColor=i.color,e.shadowBlur=At,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore(),v!=="off"&&c)){const{label:C}=c(i);C&&wt(e,C,"oval",T,f,M)}}function Wt(e,n,i,a){const{config:r,coords:o,allNotes:s,getScaleDegreeLabel:c}=n,{cellWidth:l,cellHeight:d,degreeDisplayMode:g,longNoteStyle:v}=r,f=o.getRowY(a),y=o.getColumnX(i.startColumnIndex),u=o.getColumnX(i.startColumnIndex+1)-y;if(!Ze(u,d))return;const m=un(i,s,l),b=y+u+m,T=Math.max(Ai,u*Ri),M=d/2-T/2,A=dn(i);if(A&&v==="style2"){const P=b,x=o.getColumnX(i.endColumnIndex);if(Ze(x-P,M)&&(Hi(e,i,P,x,f,M,T),g!=="off"&&c)){const{label:L}=c(i);if(L){const N=(P+x)/2;wt(e,L,"circle",N,f,M)}}return}if(A){const P=o.getColumnX(i.endColumnIndex+1),x=Li(i,s,d),L=f+x;e.beginPath(),e.moveTo(b,L),e.lineTo(P,L),e.strokeStyle=i.color,e.lineWidth=Math.max(ki,u*Ni),e.stroke()}const C=u-T/2;if(Ze(C,M)&&(e.save(),e.beginPath(),e.ellipse(b,f,C,M,0,0,2*Math.PI),e.strokeStyle=i.color,e.lineWidth=T,e.shadowColor=i.color,e.shadowBlur=At,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore(),g!=="off"&&c)){const{label:P}=c(i);P&&wt(e,P,"circle",b,f,C)}}function Ei(e,n,i){const{config:a,coords:r}=n,{cellWidth:o,cellHeight:s}=a,c=r.getRowY(i.globalRow??i.row),l=r.getColumnX(i.columnIndex),g=r.getColumnX(i.columnIndex+1)-l,v=g*2,f=l+v/2,y=Math.min(v,s)/2*.9;if(y<2||(e.beginPath(),e.arc(f,c,y,0,2*Math.PI),e.strokeStyle="#212529",e.lineWidth=Math.max(.5,g*.05),e.stroke(),i.tonicNumber==null))return;const h=i.tonicNumber.toString(),u=y*1.5;u<6||(e.fillStyle="#212529",e.font=`bold ${u}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(h,f,c))}const Oi={timeWindowMs:4e3,pixelsPerSecond:200,circleRadius:9.5,proximityThreshold:35,maxConnections:3,connectorLineWidth:2.5,connectorColor:"rgba(0,0,0,0.4)",useTonicRelativeColors:!0,tonicPitchClass:0,clarityThreshold:.5,maxOpacity:.9};function fn(e){return{...Oi,...e}}function Bt(e,n,i,a,r,o,s){const c=fn(o.trailConfig);if(a<c.clarityThreshold||i<=0)return;const{cellHeight:l,colorMode:d}=o,g=hn(n,i,l,s),v=l/2*.8,f=d==="bw"?[128,128,128]:ln(i,c.tonicPitchClass);e.save(),e.beginPath(),e.arc(r,g,v+4,0,2*Math.PI),e.fillStyle=`rgba(${f[0]}, ${f[1]}, ${f[2]}, ${a*.3})`,e.fill(),e.beginPath(),e.arc(r,g,v,0,2*Math.PI),e.fillStyle=`rgba(${f[0]}, ${f[1]}, ${f[2]}, ${a})`,e.fill(),e.restore()}function hn(e,n,i,a){if(a.length===0||!a[0])return 0;const r=Math.floor(n),o=n-r,l=(a[0].midi??108)-r;if(l<0||l>=a.length)return l<0?0:e.getRowY(a.length-1);const d=e.getRowY(l),g=i/2;return d-o*g}function gn(e,n,i,a,r,o){const{viewportWidth:s,cellHeight:c,colorMode:l}=r,d=fn(r.trailConfig),g=d.timeWindowMs,v=d.pixelsPerSecond,f=r.nowLineX??s,y=i.filter(h=>h.midi>0&&h.clarity>=d.clarityThreshold).map(h=>{const u=a-h.time;if(u>=g||u<0)return null;const m=f-u/1e3*v,b=hn(n,h.midi,c,o),T=l==="bw"?[128,128,128]:ln(h.midi,d.tonicPitchClass);return{x:m,y:b,clarity:h.clarity,color:T}}).filter(h=>h!==null&&h.x>=0);if(y.length!==0){e.save(),e.strokeStyle=d.connectorColor,e.lineWidth=d.connectorLineWidth,e.beginPath();for(let h=0;h<y.length;h++){let u=0;for(let m=h+1;m<y.length&&u<d.maxConnections;m++){const b=y[h].x-y[m].x,T=y[h].y-y[m].y;Math.sqrt(b*b+T*T)<=d.proximityThreshold&&(e.moveTo(y[h].x,y[h].y),e.lineTo(y[m].x,y[m].y),u++)}}e.stroke();for(const h of y){const u=Math.min(h.clarity*d.maxOpacity,1);e.fillStyle=`rgba(${h.color[0]}, ${h.color[1]}, ${h.color[2]}, ${u})`,e.beginPath(),e.arc(h.x,h.y,d.circleRadius,0,2*Math.PI),e.fill()}e.restore()}}function Gt(e,n,i,a,r,o,s,c){const{cellHeight:l,nowLineX:d=100,pixelsPerSecond:g}=r,v=.5;for(const f of i){const y=(d??100)+(f.startTimeMs-a)/1e3*g,h=y+f.durationMs/1e3*g;if(h<0||y>r.viewportWidth)continue;let u;if(o){if(u=o.findIndex(P=>P.midi===f.midi),u===-1)continue}else u=Math.round(108-f.midi);const m=n.getRowY(u),b=l/2-2,T=f.color??"#4CAF50",M=y<=d&&h>=d,A=s!=null&&(c??0)>.5&&Math.abs(s-f.midi)<=v,C=M&&A;if(e.save(),e.beginPath(),e.arc(y,m,b,Math.PI/2,-Math.PI/2,!1),e.lineTo(h,m-b),e.arc(h,m,b,-Math.PI/2,Math.PI/2,!1),e.lineTo(y,m+b),e.closePath(),C?(e.strokeStyle="#FFD700",e.lineWidth=5,e.shadowColor="#FFD700",e.shadowBlur=20,e.stroke(),e.fillStyle="rgba(255, 215, 0, 0.3)",e.fill(),Fi(e,d,m,b)):(e.strokeStyle=T,e.lineWidth=3,e.shadowColor=T,e.shadowBlur=8,e.stroke()),e.shadowBlur=0,e.restore(),f.label){const P=y+b+4;e.fillStyle=C?"#FFD700":"#212529",e.font=`bold ${Math.max(16,b*1.2)}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="left",e.textBaseline="middle",e.fillText(f.label,P,m)}}}function Fi(e,n,i,a){const s=a*1.5;e.save(),e.fillStyle="#FFD700",e.shadowColor="#FFD700",e.shadowBlur=6;for(let c=0;c<8;c++){const l=c/8*Math.PI*2,d=n+Math.cos(l)*s,g=i+Math.sin(l)*s;e.beginPath(),e.arc(d,g,3,0,Math.PI*2),e.fill()}e.restore()}function Wi(e){const n=e.replace(/\d+$/,"");return n.length>0?n:e}function vn(e,n){return!Number.isFinite(n)||n<=0?e:Math.round(e*n)/n}function Bi(e,n,i,a){const r=Math.max(10,Math.min(e*1.2,n*1.2)),o=i<=3?1:.7,s=a<=1?1.08:1;return vn(r*o*s,a)}function Gi(e){const n=e.getContext("2d");return n&&(n.getTransform().a||window.devicePixelRatio)||1}function Yi(e){if(typeof e.midi=="number")return e.midi%12;if(typeof e.pitchClass=="number")return e.pitchClass;const n={C:0,D:2,E:4,F:5,G:7,A:9,B:11},i=e.pitch.charAt(0).toUpperCase();let a=n[i]??0;return(e.pitch.includes("#")||e.pitch.includes("â™¯"))&&a++,(e.pitch.includes("b")||e.pitch.includes("â™­"))&&a--,(a%12+12)%12}function qi(e,n){const{showFrequencyLabels:i,showOctaveLabels:a,accidentalMode:r}=n,o=v=>a?v:Wi(v);if(i)return String(Math.round(e.frequency));const{flatName:s,sharpName:c,isAccidental:l}=e,{sharp:d,flat:g}=r;return l?d&&g?o(e.pitch):d&&!g?o(c):g&&!d?o(s):null:o(s)}function Yt(e,n,i,a){const{fullRowData:r,cellWidth:o,cellHeight:s,legendColumnWidth:c,colorMode:l,accidentalMode:d}=n,{startRow:g,endRow:v,coords:f}=i,y=Gi(e.canvas),h=b=>vn(b,y),u=c;let m=0;for(const b of a){for(let T=g;T<=v;T++){const M=r[T];if(!M||M.isBoundary||M.column!==b)continue;const A=f.getRowY(T),C=!d.sharp&&!d.flat,P=M.isAccidental&&C,x=qi(M,n);if(x===null)continue;let L=l==="bw"?"#ffffff":M.hex||"#ffffff",N="FF";P&&(N="00"),e.fillStyle=P?"rgba(255,255,255,0)":L,e.fillRect(m,A-s/2,u,s),n.highlight&&typeof n.highlight.pitchClass=="number"&&n.highlight.opacity>.01&&Yi(M)===n.highlight.pitchClass&&(e.save(),e.globalAlpha=Math.min(Math.max(n.highlight.opacity,0),1),e.fillStyle=n.highlight.color??"#ffff00",e.fillRect(m,A-s/2,u,s),e.restore());const O=Bi(o,s,x.length,y);e.font=`bold ${O}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle";const H=h(m+u/2),U=h(A);e.strokeStyle=`#212529${N}`,e.lineWidth=Math.max(1.2,2.5/y),e.lineJoin="round",e.strokeText(x,H,U),e.fillStyle=`#ffffff${N}`,e.fillText(x,H,U)}m+=u}}function Ui(e,n,i,a){e&&(e.clearRect(0,0,e.canvas.width,e.canvas.height),Yt(e,i,a,["B","A"])),n&&(n.clearRect(0,0,n.canvas.width,n.canvas.height),Yt(n,i,a,["A","B"]))}var Vi=D('<canvas class="pitch-grid-legend pitch-grid-legend--left svelte-1b4jihh"></canvas>'),Xi=D('<canvas class="pitch-grid-legend pitch-grid-legend--right svelte-1b4jihh"></canvas>'),ji=D('<div class="pitch-grid-container svelte-1b4jihh"><!> <canvas class="pitch-grid-canvas svelte-1b4jihh"></canvas> <!></div>');function zi(e,n){pe(n,!0);let i=fe(n,"colorMode",3,"color"),a=fe(n,"degreeDisplayMode",3,"off"),r=fe(n,"accidentalMode",19,()=>({sharp:!0,flat:!0})),o=fe(n,"showFrequencyLabels",3,!1),s=fe(n,"showOctaveLabels",3,!0),c=fe(n,"showRightLegend",3,!0),l=fe(n,"placedNotes",19,()=>[]),d=fe(n,"placedTonicSigns",19,()=>[]),g=fe(n,"columnWidths",19,()=>[]),v=fe(n,"macrobeatGroupings",19,()=>[]),f=fe(n,"macrobeatBoundaryStyles",19,()=>[]),y=fe(n,"longNoteStyle",3,"style1"),h=fe(n,"beatIntervalMs",3,500),u=fe(n,"beatTimeOffsetMs",3,0),m=z(void 0),b=z(void 0),T=z(void 0),M=z(null),A=z(null),C=z(null),P=z(null);const x=3,L=I(()=>n.cellWidth*x),N=I(()=>t(L)*2),O=I(()=>s()||o()),H=I(()=>t(O)?t(N)*(c()?2:1):0),U=I(()=>Math.max(0,n.viewport.containerWidth-t(H))),ie=I(()=>n.mode==="notation"||n.mode==="playback"),te=I(()=>n.mode==="singing"),S=I(()=>n.mode==="highway");function q(){if(t(ie))return vi({cellWidth:n.cellWidth,cellHeight:n.cellHeight,columnWidths:g(),viewport:n.viewport,modulationMarkers:n.modulationMarkers});{const _=t(S)?n.highwayConfig:n.singingConfig;return cn({cellWidth:n.cellWidth,cellHeight:n.cellHeight,viewport:n.viewport,pixelsPerSecond:_?.pixelsPerSecond??200,nowLineX:_?.nowLineX??100,currentTimeMs:_?.currentTimeMs??0})}}function J(){if(!t(M)||!t(m))return;const _=q(),{paddedStartRow:F,paddedEndRow:B}=pi(n.viewport,n.fullRowData);t(M).clearRect(0,0,t(U),n.viewport.containerHeight);const oe={fullRowData:n.fullRowData,cellHeight:n.cellHeight,viewportHeight:n.viewport.containerHeight,viewportWidth:t(U),colorMode:i()};Mi(t(M),oe,_,F,B),t(ie)?le(t(M),_):t(te)?_e(t(M),_):t(S)&&Pe(t(M),_),t(O)&&(t(A)||t(C))&&Q(_,F,B)}function le(_,F){const B=W(v()),oe={columnWidths:g(),cellWidth:n.cellWidth,viewportHeight:n.viewport.containerHeight,macrobeatGroupings:v(),macrobeatBoundaryStyles:f(),placedTonicSigns:d()};_i(_,oe,F,B);const ge=l().filter(ne=>ne.isDrum||ne.globalRow===void 0?!1:vt(ne.globalRow,n.viewport,n.cellHeight,F)),Me=d().filter(ne=>ne.globalRow===void 0?!1:vt(ne.globalRow,n.viewport,n.cellHeight,F)),Ie={config:{cellWidth:n.cellWidth,cellHeight:n.cellHeight,columnWidths:g(),degreeDisplayMode:a(),accidentalMode:r(),longNoteStyle:y(),colorMode:i()},coords:F,allNotes:l()};for(const ne of ge)ne.shape==="oval"?Ft(_,Ie,ne,ne.globalRow):ne.shape==="circle"&&Wt(_,Ie,ne,ne.globalRow);for(const ne of Me)Ei(_,Ie,ne)}function _e(_,F){if(!n.singingConfig)return;const B={cellHeight:n.cellHeight,viewportWidth:t(U),pixelsPerSecond:n.singingConfig.pixelsPerSecond??200,timeWindowMs:n.singingConfig.timeWindowMs??4e3,colorMode:i(),trailConfig:n.singingConfig.trailConfig};n.singingConfig.pitchHistory&&n.singingConfig.pitchHistory.length>0&&gn(_,F,n.singingConfig.pitchHistory,performance.now(),B,n.fullRowData),n.singingConfig.targetNotes&&n.singingConfig.targetNotes.length>0&&Gt(_,F,n.singingConfig.targetNotes,performance.now(),B,n.fullRowData),n.singingConfig.userPitch&&n.singingConfig.userPitch.clarity>.5&&Bt(_,F,n.singingConfig.userPitch.midi,n.singingConfig.userPitch.clarity,t(U)-20,B,n.fullRowData)}function Pe(_,F){if(!n.highwayConfig)return;const B={cellHeight:n.cellHeight,viewportWidth:n.viewport.containerWidth,nowLineX:n.highwayConfig.nowLineX,pixelsPerSecond:n.highwayConfig.pixelsPerSecond??200,timeWindowMs:n.highwayConfig.timeWindowMs??4e3,colorMode:i(),trailConfig:n.highwayConfig.trailConfig};if(n.highwayConfig.scrollingGridData&&n.highwayConfig.scrollOffset!==void 0)Ce(_,F);else{const ge={startMs:n.highwayConfig.currentTimeMs-1e3,endMs:n.highwayConfig.currentTimeMs+t(U)/(n.highwayConfig.pixelsPerSecond??200)*1e3},Me={viewportWidth:t(U),viewportHeight:n.viewport.containerHeight,beatIntervalMs:h(),visibleTimeRange:ge,nowLineX:n.highwayConfig.nowLineX,beatTimeOffsetMs:u()};Ti(_,Me,F),n.highwayConfig.targetNotes&&n.highwayConfig.targetNotes.length>0&&Gt(_,F,n.highwayConfig.targetNotes,n.highwayConfig.currentTimeMs,B,n.fullRowData,n.highwayConfig.userPitch?.midi??null,n.highwayConfig.userPitch?.clarity??0)}ee(_,n.highwayConfig.nowLineX,n.viewport.containerHeight),n.highwayConfig.showOnrampCountdown&&n.highwayConfig.onrampBeatsRemaining!==void 0&&V(_,n.highwayConfig.onrampBeatsRemaining),n.highwayConfig.userPitch&&n.highwayConfig.userPitch.clarity>.5&&Bt(_,F,n.highwayConfig.userPitch.midi,n.highwayConfig.userPitch.clarity,n.highwayConfig.nowLineX,B,n.fullRowData)}function Ce(_,F){if(!n.highwayConfig?.scrollingGridData||n.highwayConfig.scrollOffset===void 0)return;const B=n.highwayConfig.scrollingGridData,oe=n.highwayConfig.scrollOffset,ge=W(B.macrobeatGroupings);for(let re=0;re<ge.length;re++){const ne=ge[re]*n.cellWidth-oe;if(ne>=-n.cellWidth&&ne<=t(U)+n.cellWidth){const Le=B.macrobeatBoundaryStyles[re]||"solid",He=Le==="solid"?2:1,Ue=Le==="dashed"?[5,5]:[];_.strokeStyle="#495057",_.lineWidth=He,_.setLineDash(Ue),_.beginPath(),_.moveTo(ne,0),_.lineTo(ne,n.viewport.containerHeight),_.stroke(),_.setLineDash([])}}const Me={cellWidth:n.cellWidth,cellHeight:n.cellHeight,columnWidths:B.columnWidths,degreeDisplayMode:a(),accidentalMode:r(),longNoteStyle:y(),colorMode:i()};for(const re of B.placedNotes){if(re.isDrum||re.globalRow===void 0||!vt(re.globalRow,n.viewport,n.cellHeight,F))continue;const Ie=re.startColumnIndex*n.cellWidth-oe;if(re.endColumnIndex*n.cellWidth-oe>=-n.cellWidth&&Ie<=t(U)+n.cellWidth){const Le={...F,getColumnX:Ue=>Ue*n.cellWidth-oe},He={config:Me,coords:Le,allNotes:B.placedNotes};re.shape==="oval"?Ft(_,He,re,re.globalRow):re.shape==="circle"&&Wt(_,He,re,re.globalRow)}}}function ee(_,F,B){_.strokeStyle="rgba(255, 0, 0, 0.9)",_.lineWidth=3,_.beginPath(),_.moveTo(F,0),_.lineTo(F,B),_.stroke()}function V(_,F){_.fillStyle="rgba(0, 0, 0, 0.7)",_.fillRect(t(U)/2-40,10,80,50),_.fillStyle="#ffffff",_.font="bold 36px sans-serif",_.textAlign="center",_.textBaseline="middle",_.fillText(F.toString(),t(U)/2,35)}function Q(_,F,B){const oe={fullRowData:n.fullRowData,cellWidth:n.cellWidth,cellHeight:n.cellHeight,legendColumnWidth:t(L),colorMode:i(),showFrequencyLabels:o(),showOctaveLabels:s(),accidentalMode:r(),highlight:n.legendHighlight},ge={startRow:F,endRow:B,coords:_};Ui(t(A),t(C),oe,ge)}function W(_){const F=[];let B=0;for(const oe of _)B+=oe,F.push(B);return F}function R(){if(t(P))return;function _(){J(),E(P,requestAnimationFrame(_),!0)}E(P,requestAnimationFrame(_),!0)}function K(){t(P)&&(cancelAnimationFrame(t(P)),E(P,null))}function se(){if(!t(m)||(E(M,t(m).getContext("2d"),!0),!t(M)))return;const _=window.devicePixelRatio||1;t(m).width=t(U)*_,t(m).height=n.viewport.containerHeight*_,t(m).style.width=`${t(U)}px`,t(m).style.height=`${n.viewport.containerHeight}px`,t(M).scale(_,_),t(b)&&(E(A,t(b).getContext("2d"),!0),t(A)&&(t(b).width=t(N)*_,t(b).height=n.viewport.containerHeight*_,t(b).style.width=`${t(N)}px`,t(b).style.height=`${n.viewport.containerHeight}px`,t(A).scale(_,_))),t(T)&&(E(C,t(T).getContext("2d"),!0),t(C)&&(t(T).width=t(N)*_,t(T).height=n.viewport.containerHeight*_,t(T).style.width=`${t(N)}px`,t(T).style.height=`${n.viewport.containerHeight}px`,t(C).scale(_,_))),J(),(t(te)||t(S))&&R()}an(()=>{se()}),Ge(()=>{K()}),Re(()=>{n.mode,n.viewport,n.cellWidth,n.cellHeight,i(),a(),l(),d(),g(),t(M)&&t(ie)&&J()}),Re(()=>{n.mode,t(te)||t(S)?R():(K(),t(M)&&J())}),Re(()=>{n.viewport.containerWidth,n.viewport.containerHeight,t(M)&&t(m)&&se()});var ue=ji(),be=p(ue);{var we=_=>{var F=Vi();Ne(F,B=>E(b,B),()=>t(b)),k(_,F)};$(be,_=>{t(O)&&_(we)})}var me=w(be,2);Ne(me,_=>E(m,_),()=>t(m));var X=w(me,2);{var ae=_=>{var F=Xi();Ne(F,B=>E(T,B),()=>t(T)),k(_,F)};$(X,_=>{t(O)&&c()&&_(ae)})}k(e,ue),ye()}const qt={isDetecting:!1,visualizationMode:"highway",tonic:"C",useDegrees:!1,showAccidentals:!0,pitchHighlightEnabled:!0,yAxisRange:{minMidi:40,maxMidi:72},drone:{isPlaying:!1,octave:3,volume:-12}};function Ki(){let e=z(ke({...qt}));return{get state(){return t(e)},toggleDetecting(){t(e).isDetecting=!t(e).isDetecting},setDetecting(n){t(e).isDetecting=n},setVisualizationMode(n){t(e).visualizationMode=n},setTonic(n){t(e).tonic=n},setUseDegrees(n){t(e).useDegrees=n},setShowAccidentals(n){t(e).showAccidentals=n},togglePitchHighlight(){t(e).pitchHighlightEnabled=!t(e).pitchHighlightEnabled},setPitchHighlightEnabled(n){t(e).pitchHighlightEnabled=n},setYAxisRange(n){t(e).yAxisRange=n},expandYAxisUpper(){t(e).yAxisRange.maxMidi<108&&(t(e).yAxisRange={...t(e).yAxisRange,maxMidi:t(e).yAxisRange.maxMidi+1})},contractYAxisUpper(){t(e).yAxisRange.maxMidi>t(e).yAxisRange.minMidi+6&&(t(e).yAxisRange={...t(e).yAxisRange,maxMidi:t(e).yAxisRange.maxMidi-1})},expandYAxisLower(){t(e).yAxisRange.minMidi>21&&(t(e).yAxisRange={...t(e).yAxisRange,minMidi:t(e).yAxisRange.minMidi-1})},contractYAxisLower(){t(e).yAxisRange.minMidi<t(e).yAxisRange.maxMidi-6&&(t(e).yAxisRange={...t(e).yAxisRange,minMidi:t(e).yAxisRange.minMidi+1})},toggleDrone(){t(e).drone={...t(e).drone,isPlaying:!t(e).drone.isPlaying}},setDroneOctave(n){t(e).drone={...t(e).drone,octave:n}},setDroneVolume(n){t(e).drone={...t(e).drone,volume:n}},reset(){E(e,{...qt},!0)}}}const j=Ki(),Zi=200,Ut={currentPitch:null,history:[],stablePitch:{pitchClass:null,opacity:0,size:1}};function Ji(){let e=z(ke({...Ut}));return{get state(){return t(e)},setCurrentPitch(n){t(e).currentPitch=n},addHistoryPoint(n){t(e).history.push(n),t(e).history.length>Zi&&t(e).history.shift()},setStablePitch(n){t(e).stablePitch=n},clearHistory(){t(e).history=[]},reset(){E(e,{...Ut},!0)}}}const ce=Ji(),Vt={isPlaying:!1,startTime:null,currentTimeMs:0,targetNotes:[],nowLineX:100,pixelsPerSecond:200,timeWindowMs:4e3};function Qi(){let e=z(ke({...Vt})),n=null,i=null,a=null;function r(l){return l.map((d,g)=>({id:`target-${g}`,midi:d.midi,startTimeMs:d.startTimeMs,durationMs:d.durationMs,startColumn:0,endColumn:0,color:"#3b82f6",shape:"oval",globalRow:0}))}function o(){if(!n)return;const l=n.getState();t(e).isPlaying=l.isPlaying&&!l.isPaused,t(e).currentTimeMs=l.currentTimeMs;const d=n.getPerformanceResults();t(e).targetNotes=t(e).targetNotes.map((g,v)=>{const f=`target-${v}`,y=d.get(f);return{...g,hit:y?.hitStatus==="hit"}})}function s(){t(e).isPlaying&&n?(o(),i=requestAnimationFrame(s)):i=null}function c(){n&&n.dispose(),n=gi({judgmentLinePosition:t(e).nowLineX/800,pixelsPerSecond:t(e).pixelsPerSecond,lookAheadMs:t(e).timeWindowMs,scrollMode:"constant-speed",leadInBeats:0,playMetronomeDuringOnramp:!1,playTargetNotes:!1,playMetronome:!1,inputSources:["microphone"],feedbackConfig:{onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70},stateCallbacks:{getTempo:()=>120,getCellWidth:()=>20,getViewportWidth:()=>800},eventCallbacks:{emit:(d,g)=>{if(console.debug("[Highway]",d,g),d==="noteHit"){const v=g;console.log(`[Highway] Note HIT: ${v.noteId}, accuracy: ${v.performance.accuracyTier||"unknown"}`)}else d==="noteMissed"?console.log(`[Highway] Note MISSED: ${g.noteId}`):d==="onrampComplete"?console.log("[Highway] Onramp complete, playback starting!"):d==="performanceComplete"&&(console.log("[Highway] Performance complete!"),a&&n&&a(n.getPerformanceResults()))}}});const l=r(t(e).targetNotes);n.init(l)}return{get state(){return t(e)},get engineService(){return n},start(){!n&&t(e).targetNotes.length>0&&c(),n&&(n.start(),t(e).isPlaying=!0,t(e).startTime=performance.now(),t(e).currentTimeMs=0,s())},stop(){n&&n.stop(),t(e).isPlaying=!1,i!==null&&(cancelAnimationFrame(i),i=null)},pause(){n&&n.pause(),t(e).isPlaying=!1,i!==null&&(cancelAnimationFrame(i),i=null)},resume(){n&&(n.resume(),t(e).isPlaying=!0,s())},setTargetNotes(l){if(t(e).targetNotes=l,n){const d=r(l);n.init(d)}},markNoteHit(l){l>=0&&l<t(e).targetNotes.length&&(t(e).targetNotes=t(e).targetNotes.map((d,g)=>g===l?{...d,hit:!0}:d))},setNowLineX(l){t(e).nowLineX=l},setPixelsPerSecond(l){t(e).pixelsPerSecond=l},setTimeWindowMs(l){t(e).timeWindowMs=l},recordPitchInput(l,d){n&&t(e).isPlaying&&n.recordPitchInput(l,d,"microphone")},getPerformanceResults(){return n?.getPerformanceResults()??new Map},setCurrentTime(l){t(e).currentTimeMs=l,n&&n.setScrollOffset(l)},onPerformanceComplete(l){return a=l,()=>{a=null}},reset(){i!==null&&(cancelAnimationFrame(i),i=null),n&&(n.dispose(),n=null),E(e,{...Vt},!0)}}}const de=Qi(),$i={numLoops:5,minMidi:48,maxMidi:72,tempo:108,referenceVolume:-12},Xt={isActive:!1,isPlaying:!1,config:{...$i},currentLoop:0,currentPhase:"reference",currentPitch:null,generatedNotes:[],results:[]};function ea(e,n){return Math.floor(Math.random()*(n-e+1))+e}function jt(e){return 60/e*1e3/2}function ta(){let e=z(ke({...Xt}));function n(a){const r=[],o=jt(a.tempo),s=2e3;for(let c=0;c<a.numLoops;c++){const l=ea(a.minMidi,a.maxMidi),d=s+c*32*o;r.push({midi:l,startTimeMs:d,durationMs:8*o,lyric:"ðŸ‘‚"}),r.push({midi:l,startTimeMs:d+16*o,durationMs:8*o,lyric:"ðŸŽ¤"})}return r}function i(a,r){const o=jt(r),s=32*o,l=a-2e3;if(l<0)return{loop:0,phase:"rest2"};const d=Math.floor(l/s),g=l%s,v=Math.floor(g/o);let f;return v<8?f="reference":v<16?f="rest1":v<24?f="input":f="rest2",{loop:d,phase:f}}return{get state(){return t(e)},configure(a){t(e).config={...t(e).config,...a}},setPitchRange(a,r){t(e).config.minMidi=a,t(e).config.maxMidi=r},start(){const a=n(t(e).config);t(e).generatedNotes=a,t(e).isActive=!0,t(e).isPlaying=!1,t(e).currentLoop=0,t(e).currentPhase="reference",t(e).currentPitch=a.length>0?a[0].midi:null,t(e).results=[]},stop(){t(e).isActive=!1,t(e).isPlaying=!1,t(e).currentLoop=0,t(e).currentPhase="reference",t(e).currentPitch=null},setPlaying(a){t(e).isPlaying=a},updatePhase(a){const{loop:r,phase:o}=i(a,t(e).config.tempo);t(e).currentLoop=r,t(e).currentPhase=o;const s=r*2;s<t(e).generatedNotes.length&&(t(e).currentPitch=t(e).generatedNotes[s].midi)},addResult(a){t(e).results.push(a)},hasResultForLoop(a){return t(e).results.some(r=>r.loopIndex===a)},getResults(){return t(e).results},getCurrentProgress(){return{current:t(e).currentLoop+1,total:t(e).config.numLoops}},getGeneratedNotes(){return t(e).generatedNotes},getAverageAccuracy(){return t(e).results.length===0?0:t(e).results.reduce((r,o)=>r+o.accuracy,0)/t(e).results.length},getHitCount(){return t(e).results.filter(a=>a.performance?.hitStatus==="hit").length},reset(){E(e,{...Xt,config:{...t(e).config}},!0)}}}const he=ta();var na=D('<div class="singing-canvas-container svelte-wysbg"><!> <canvas class="pitch-trail-canvas svelte-wysbg"></canvas></div>');function ia(e,n){pe(n,!0);let i=z(void 0),a=z(800),r=z(400),o=z(void 0),s=z(null),c=z(null),l=0,d=0,g=0;const v=20,f=!0,y=!1,h=I(()=>t(a)>=720),u=3,m=I(()=>v*u),b=I(()=>t(m)*2),T=I(()=>f),M=I(()=>t(T)?t(b)*(t(h)?2:1):0),A=I(()=>Math.max(0,t(a)-t(M))),C=I(()=>t(T)?t(b):0),P=()=>{try{return!!globalThis.__ST_DEBUG_TRAIL}catch{return!1}},x=I(()=>Zn(j.state.yAxisRange.minMidi,j.state.yAxisRange.maxMidi)),L=I(()=>Jn({containerHeight:t(r),fullRowData:t(x),preferredCellHeight:40,minCellHeight:20})),N=I(()=>j.state.visualizationMode==="highway"?"highway":"singing"),O=I(()=>60/he.state.config.tempo*1e3),H=2e3,U=I(()=>(()=>{if(!j.state.pitchHighlightEnabled)return;const W=ce.state.stablePitch;if(!(W.pitchClass===null||W.opacity<=.01))return{pitchClass:W.pitchClass,opacity:W.opacity,color:"#ffff00"}})());function ie(){return de.state.targetNotes.map((W,R)=>({id:`target-${R}`,midi:W.midi,startTimeMs:W.startTimeMs,durationMs:W.durationMs,label:W.lyric}))}const te=I(()=>({timeWindowMs:4e3,pixelsPerSecond:200,circleRadius:9.5,proximityThreshold:35,maxConnections:3,connectorLineWidth:2.5,connectorColor:"rgba(0,0,0,0.4)",useTonicRelativeColors:!0,tonicPitchClass:fi(j.state.tonic),clarityThreshold:.5,maxOpacity:.9})),S=I(()=>t(N)==="singing"?{userPitch:ce.state.currentPitch?{frequency:ce.state.currentPitch.frequency,midi:ce.state.currentPitch.midi,clarity:ce.state.currentPitch.clarity,pitchClass:ce.state.currentPitch.pitchClass}:null,pitchHistory:[],targetNotes:[],pixelsPerSecond:200,timeWindowMs:4e3,trailConfig:t(te)}:void 0),q=I(()=>t(N)==="highway"?{userPitch:ce.state.currentPitch?{frequency:ce.state.currentPitch.frequency,midi:ce.state.currentPitch.midi,clarity:ce.state.currentPitch.clarity,pitchClass:ce.state.currentPitch.pitchClass}:null,pitchHistory:[],targetNotes:ie(),nowLineX:de.state.nowLineX,pixelsPerSecond:de.state.pixelsPerSecond,currentTimeMs:de.state.currentTimeMs,timeWindowMs:de.state.timeWindowMs,trailConfig:t(te)}:void 0),J=I(()=>({startRow:t(L).startRow,endRow:t(L).endRow,zoomLevel:1,containerWidth:t(a),containerHeight:t(r)}));function le(){if(!t(o))return;const W=window.devicePixelRatio||1;t(o).width=t(A)*W,t(o).height=t(r)*W,t(o).style.width=`${t(A)}px`,t(o).style.height=`${t(r)}px`,t(o).style.left=`${t(C)}px`;const R=t(o).getContext("2d");if(!R){E(s,null);return}R.setTransform(W,0,0,W,0,0),E(s,R,!0)}function _e(){if(!t(s)||t(A)<=0)return;t(s).clearRect(0,0,t(A),t(r));const W=ce.state.history;if(W.length===0)return;const R=t(N)==="singing"?t(S):t(q);if(!R)return;const K=P(),se=K?performance.now():0,ue=t(N)==="highway"&&t(q)?t(q).nowLineX:100,be=cn({cellHeight:t(L).cellHeight,viewport:t(J),pixelsPerSecond:R.pixelsPerSecond??200,nowLineX:ue,currentTimeMs:t(N)==="highway"&&t(q)?t(q).currentTimeMs:0}),we={cellHeight:t(L).cellHeight,viewportWidth:t(A),nowLineX:ue,pixelsPerSecond:R.pixelsPerSecond??200,timeWindowMs:R.timeWindowMs??4e3,colorMode:"color",trailConfig:t(te)},me=performance.now();if(gn(t(s),be,W,me,we,t(x)),K){const X=performance.now();if(d+=1,g+=X-se,X-l>=1e3){const ae=d>0?g/d:0;console.log(`[SingingTrail] points=${W.length} avgMs=${ae.toFixed(2)} gridWidth=${t(A)}`),l=X,d=0,g=0}}}function Pe(){if(t(c))return;const W=()=>{_e(),E(c,requestAnimationFrame(W),!0)};E(c,requestAnimationFrame(W),!0)}function Ce(){t(c)&&(cancelAnimationFrame(t(c)),E(c,null)),t(s)&&t(A)>0&&t(s).clearRect(0,0,t(A),t(r))}Re(()=>{if(!t(i))return;const W=new ResizeObserver(R=>{for(const K of R)E(a,K.contentRect.width,!0),E(r,K.contentRect.height,!0)});return W.observe(t(i)),()=>{W.disconnect()}}),Re(()=>{t(A),t(r),t(C),t(o),le()}),Re(()=>{t(N),t(s),t(N)==="singing"||t(N)==="highway"?Pe():Ce()}),Ge(()=>{Ce()});var ee=na(),V=p(ee);zi(V,{get mode(){return t(N)},get fullRowData(){return t(x)},get viewport(){return t(J)},cellWidth:v,get cellHeight(){return t(L).cellHeight},colorMode:"color",showOctaveLabels:f,showFrequencyLabels:y,get showRightLegend(){return t(h)},get singingConfig(){return t(S)},get highwayConfig(){return t(q)},get legendHighlight(){return t(U)},get beatIntervalMs(){return t(O)},beatTimeOffsetMs:H});var Q=w(V,2);Ne(Q,W=>E(o,W),()=>t(o)),Ne(ee,W=>E(i,W),()=>t(i)),k(e,ee),ye()}const aa=100,mt=12;function sa(e){const n=Math.round(e);return(e-n)*aa}function oa(e){return Math.round(e)}function ra(e){return(Math.round(e)%mt+mt)%mt}class la{synth=null;scheduledTimeouts=[];volume=null;startTime=0;_isPlaying=!1;get isPlaying(){return this._isPlaying}async init(){await xt(),this.volume=new ii(-12).toDestination(),this.synth=new sn({oscillator:{type:"triangle"},envelope:{attack:.05,decay:.1,sustain:.9,release:.1}}).connect(this.volume)}setVolume(n){this.volume&&(this.volume.volume.value=n)}scheduleReferenceTones(n){if(!this.synth){console.warn("[ReferenceAudio] Synth not initialized");return}this.clearScheduled(),this.startTime=performance.now(),n.forEach(i=>{const a=i.durationMs/1e3,r=kt(i.midi,"midi").toFrequency(),o=window.setTimeout(()=>{this.synth&&(console.log(`[ReferenceAudio] Playing ${i.midi} at ${performance.now()-this.startTime}ms`),this._isPlaying=!0,this.synth.triggerAttackRelease(r,a))},i.startTimeMs),s=window.setTimeout(()=>{this._isPlaying=!1},i.startTimeMs+i.durationMs);this.scheduledTimeouts.push(o,s)}),console.log(`[ReferenceAudio] Scheduled ${n.length} reference tones`)}playTone(n,i){if(!this.synth){console.warn("[ReferenceAudio] Synth not initialized");return}const a=kt(n,"midi").toFrequency(),r=i/1e3;this.synth.triggerAttackRelease(a,r)}clearScheduled(){this.scheduledTimeouts.forEach(n=>{window.clearTimeout(n)}),this.scheduledTimeouts=[]}stop(){this.clearScheduled(),this.synth&&this.synth.triggerRelease()}dispose(){this.stop(),this.synth&&(this.synth.dispose(),this.synth=null),this.volume&&(this.volume.dispose(),this.volume=null)}}const je=new la,Fe={FFT_SIZE:2048,CLARITY_THRESHOLD:.8,MIN_PITCH_HZ:60,MAX_PITCH_HZ:1600,HIGHLIGHT_CENTS_RANGE:50};let We=null,Be=null,rt=null,De=null,lt=!1;const Mt=1;function ca(e){return 12*Math.log2(e/440)+69}function _t(){if(!lt||!Be||!rt){De=null;return}if(je.isPlaying){ce.addHistoryPoint({frequency:0,midi:0,time:performance.now(),clarity:0}),De=requestAnimationFrame(_t);return}const e=Be.getValue(),[n,i]=rt.findPitch(e,oi().sampleRate),a=n!==null&&i>Fe.CLARITY_THRESHOLD&&n>Fe.MIN_PITCH_HZ&&n<Fe.MAX_PITCH_HZ;if(a){const r=ca(n),o={frequency:n,midi:r,clarity:i,pitchClass:Math.round(r)%12};ce.setCurrentPitch(o),ce.addHistoryPoint({frequency:n,midi:r,time:performance.now(),clarity:i}),de.recordPitchInput(r,i)}else ce.addHistoryPoint({frequency:0,midi:0,time:performance.now(),clarity:0});if(a&&ce.state.currentPitch){const r=ce.state.currentPitch.midi,o=oa(r),s=sa(r),c=Math.min(Math.abs(s),Fe.HIGHLIGHT_CENTS_RANGE),l=Math.max(0,1-c/Fe.HIGHLIGHT_CENTS_RANGE);ce.setStablePitch({pitchClass:ra(o),opacity:l,size:Mt})}else ce.setStablePitch({pitchClass:null,opacity:0,size:Mt});De=requestAnimationFrame(_t)}async function da(){if(!lt){De!==null&&cancelAnimationFrame(De),We=new ai,Be=new si("waveform",Fe.FFT_SIZE),rt=li.forFloat32Array(Be.size);try{await xt(),await We.open(),We.connect(Be),lt=!0,_t()}catch(e){throw console.error("Microphone access denied or failed:",e),mn(),e}}}function ua(){lt=!1,mn()}function mn(){De!==null&&(cancelAnimationFrame(De),De=null),We&&(We.close(),We=null),Be=null,rt=null,ce.setStablePitch({pitchClass:null,opacity:0,size:Mt}),ce.setCurrentPitch(null)}Te(["click"]);let Ae=null,Qe=!1,$e=null;function fa(){if(!Ae){Ae=new ri(sn,{oscillator:{type:"sawtooth"},envelope:{attack:.3,decay:.1,sustain:.8,release:.5}}).toDestination();const e=Ae.get().oscillator?.type??"unknown";console.log("[DroneAudio] Initialized drone synth",{oscillatorType:e})}return Ae}function pn(e,n){return`${e.replace("b","#").replace("Db","C#").replace("Eb","D#").replace("Gb","F#").replace("Ab","G#").replace("Bb","A#")}${n}`}async function ha(){await xt();const e=fa(),n=pn(j.state.tonic,j.state.drone.octave);e.volume.value=j.state.drone.volume,console.log("[DroneAudio] Starting drone",{note:n,volume:e.volume.value}),$e&&e.releaseAll(),$e=n,e.triggerAttack(n),Qe=!0}function ga(){Ae&&Qe&&(Ae.releaseAll(),$e=null,Qe=!1)}function Tt(){if(!Qe||!Ae)return;const e=pn(j.state.tonic,j.state.drone.octave);Ae.volume.value=j.state.drone.volume,console.log("[DroneAudio] Updating drone",{note:e,volume:Ae.volume.value}),e!==$e&&(Ae.releaseAll(),Ae.triggerAttack(e),$e=e)}async function va(){Qe?ga():await ha()}var ma=D("<option> </option>"),pa=D('<div class="tonic-selector svelte-3w4ray"><label for="tonic-select" class="svelte-3w4ray">Key:</label> <select id="tonic-select" class="svelte-3w4ray"></select></div>');function ya(e,n){pe(n,!1);const i=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function a(c){const l=c.target;j.setTonic(l.value),Tt()}St();var r=pa(),o=w(p(r),2);o.__change=a,qe(o,5,()=>i,et,(c,l)=>{var d=ma(),g=p(d),v={};Z(()=>{Y(g,t(l)),v!==(v=t(l))&&(d.value=(d.__value=t(l))??"")}),k(c,d)});var s;on(o),Z(()=>{s!==(s=j.state.tonic)&&(o.value=(o.__value=j.state.tonic)??"",It(o,j.state.tonic))}),k(e,r),ye()}Te(["change"]);var ba=D("<option> </option>"),wa=D('<div class="drone-controls svelte-z4onaa"><button> </button> <div class="drone-settings svelte-z4onaa"><label class="svelte-z4onaa">Oct: <select class="svelte-z4onaa"></select></label> <label class="svelte-z4onaa">Vol: <input type="range" min="-40" max="0" class="svelte-z4onaa"/></label></div></div>');function Ma(e,n){pe(n,!1);const i=[2,3,4,5];async function a(){await va(),j.toggleDrone()}function r(m){const b=m.target;j.setDroneOctave(parseInt(b.value,10)),Tt()}function o(m){const b=m.target;j.setDroneVolume(parseInt(b.value,10)),Tt()}St();var s=wa(),c=p(s);let l;c.__click=a;var d=p(c),g=w(c,2),v=p(g),f=w(p(v));f.__change=r,qe(f,5,()=>i,et,(m,b)=>{var T=ba(),M=p(T),A={};Z(()=>{Y(M,t(b)),A!==(A=t(b))&&(T.value=(T.__value=t(b))??"")}),k(m,T)});var y;on(f);var h=w(v,2),u=w(p(h));u.__input=o,Z(()=>{l=Ye(c,1,"drone-toggle svelte-z4onaa",null,l,{active:j.state.drone.isPlaying}),Y(d,j.state.drone.isPlaying?"Drone On":"Drone Off"),y!==(y=j.state.drone.octave)&&(f.value=(f.__value=j.state.drone.octave)??"",It(f,j.state.drone.octave)),Vn(u,j.state.drone.volume)}),k(e,s),ye()}Te(["click","change","input"]);Te(["click"]);var _a=D('<div class="pitch-wheel-option svelte-i0c5ty"> </div>'),Ta=D('<div class="pitch-wheel svelte-i0c5ty" role="slider" tabindex="0" aria-valuemin="0"><div class="pitch-wheel-viewport svelte-i0c5ty"><div class="pitch-wheel-options svelte-i0c5ty"></div></div> <div class="pitch-wheel-overlay svelte-i0c5ty"></div></div>');function zt(e,n){pe(n,!0);let i=fe(n,"selectedIndex",15),a=fe(n,"ariaLabel",3,"Pitch selector");const r=40,o=r;let s=z(void 0),c=z(void 0),l=z(void 0),d=z(!1),g=z(null),v=z(0),f=z(0),y=z(r);const h=I(()=>n.options.map((S,q)=>Math.min(Math.abs(q-i()),3))),u=I(()=>t(c)?.clientHeight??0),m=I(()=>Math.max(0,(t(u)-t(y))/2)),b=I(()=>t(m)+i()*t(y)+t(y)/2),T=I(()=>t(u)>0?t(u)/2-t(b):0);function M(S){if(!n.options||n.options.length===0)return;let q=S;typeof n.onbeforechange=="function"&&(q=n.onbeforechange(S));const J=Math.max(0,Math.min(n.options.length-1,q));if(J!==i()&&(i(J),typeof n.onchange=="function")){const le=n.options[J];le&&n.onchange(J,le)}}function A(S){S!==0&&M(i()+S)}function C(S){S.preventDefault(),S.stopPropagation();const q=Math.sign(S.deltaY);q!==0&&A(q)}function P(S){S.key==="ArrowUp"?(S.preventDefault(),A(-1)):S.key==="ArrowDown"?(S.preventDefault(),A(1)):S.key==="Home"?(S.preventDefault(),M(0)):S.key==="End"&&(S.preventDefault(),M(n.options.length-1))}function x(S){if(S.preventDefault(),E(d,!0),E(g,S.pointerId,!0),E(v,S.clientY,!0),E(f,0),t(s)&&typeof t(s).setPointerCapture=="function")try{t(s).setPointerCapture(S.pointerId)}catch{}}function L(S){if(!t(d)||S.pointerId!==t(g))return;const q=S.clientY-t(v);if(E(v,S.clientY,!0),q===0)return;E(f,t(f)+q);const J=t(y)||o;for(;Math.abs(t(f))>=J;){const le=-Math.sign(t(f));A(le),E(f,t(f)-Math.sign(t(f))*J)}}function N(S){t(d)&&S.pointerId===t(g)&&(E(d,!1),E(g,null),E(f,0),t(s)?.hasPointerCapture?.(S.pointerId)&&t(s).releasePointerCapture(S.pointerId))}Re(()=>{if(!t(l)||!t(c))return;const S=()=>{const J=t(l)?.querySelector(".pitch-wheel-option");J&&E(y,J.offsetHeight||r,!0)};S();const q=new ResizeObserver(()=>{S()});return q.observe(t(c)),()=>{q.disconnect()}});var O=Ta();O.__keydown=P,O.__pointerdown=x,O.__pointermove=L,O.__pointerup=N;let H;var U=p(O),ie=p(U);let te;qe(ie,23,()=>n.options,S=>S.index,(S,q,J)=>{var le=_a(),_e=p(le);Z(()=>{Oe(le,"data-distance",t(h)[t(J)]),Y(_e,t(q).label)}),k(S,le)}),Ne(ie,S=>E(l,S),()=>t(l)),Ne(U,S=>E(c,S),()=>t(c)),Ne(O,S=>E(s,S),()=>t(s)),Z(()=>{Oe(O,"aria-label",a()),Oe(O,"aria-valuemax",n.options.length-1),Oe(O,"aria-valuenow",i()),Oe(O,"aria-valuetext",n.options[i()]?.label??""),H=st(O,"",H,{height:n.wheelHeight?`${n.wheelHeight}px`:"100%"}),te=st(ie,"",te,{"padding-top":`${t(m)??""}px`,"padding-bottom":`${t(m)??""}px`,transform:`translateY(${t(T)??""}px)`})}),Ke("wheel",O,C),Ke("pointercancel",O,N),Ke("pointerleave",O,N),k(e,O),ye()}Te(["keydown","pointerdown","pointermove","pointerup"]);var Pa=D('<button type="button"> </button>'),Ca=D('<div class="preset-buttons svelte-s7fyen"></div>');function Sa(e,n){pe(n,!0);function i(r){n.onPresetClick(r)}var a=Ca();qe(a,21,()=>n.presets,et,(r,o)=>{var s=Pa();let c;s.__click=()=>i(t(o));var l=p(s);Z(()=>{c=Ye(s,1,"preset-button svelte-s7fyen",null,c,{active:n.activePreset===t(o).label}),Y(l,t(o).label)}),k(r,s)}),k(e,a),ye()}Te(["click"]);const yn=7;function ct(e,n,i){return Number.isFinite(e)?Math.max(n,Math.min(i,Math.round(e))):n}function xa(e,n,i,a=yn){const r=Math.max(0,i-1),o=ct(e,0,r),s=Math.max(1,Math.round(a)),c=Math.max(0,o-(s-1));return ct(n,0,c)}function Ia(e,n,i,a=yn){const r=Math.max(0,i-1),o=ct(e,0,r),s=Math.max(1,Math.round(a)),c=Math.min(r,o+(s-1));return ct(n,c,r)}function Aa(e){return e.map((n,i)=>({index:i,label:n.pitch,midi:n.midi,toneNote:n.toneNote,frequency:n.frequency}))}function Ee(e,n){const i=e.findIndex(a=>a.midi===n);return i>=0?i:0}function Ra(e){return[{label:"Voice I",topIndex:Ee(e,81),bottomIndex:Ee(e,57)},{label:"Voice II",topIndex:Ee(e,72),bottomIndex:Ee(e,48)},{label:"Voice III",topIndex:Ee(e,64),bottomIndex:Ee(e,40)}]}var Na=D('<div class="summary-card svelte-s4iox0"><div class="summary-label svelte-s4iox0"> </div> <div class="summary-metadata svelte-s4iox0"> </div></div>'),ka=D('<div class="dual-pitch-wheel svelte-s4iox0"><div class="wheels-container svelte-s4iox0"><div class="wheel-column svelte-s4iox0"><div class="wheel-label svelte-s4iox0">High</div> <!></div> <div class="wheel-column svelte-s4iox0"><div class="wheel-label svelte-s4iox0">Low</div> <!></div></div> <!> <!></div>');function La(e,n){pe(n,!0);let i=fe(n,"topIndex",15),a=fe(n,"bottomIndex",15),r=fe(n,"minSpan",3,7),o=fe(n,"showSummary",3,!0),s=fe(n,"showPresets",3,!1);const c=I(()=>Aa(n.fullRowData)),l=I(()=>({topIndex:i(),bottomIndex:a(),topPitch:n.fullRowData[i()],bottomPitch:n.fullRowData[a()],span:a()-i()+1})),d=I(()=>t(l).topPitch&&t(l).bottomPitch?`${t(l).topPitch.pitch} â€“ ${t(l).bottomPitch.pitch}`:""),g=I(()=>`${t(l).span} ${t(l).span===1?"pitch":"pitches"}`),v=I(()=>!n.presets||n.presets.length===0?void 0:n.presets.find(U=>U.topIndex===i()&&U.bottomIndex===a())?.label);function f(H){return xa(a(),H,t(c).length,r())}function y(H){return Ia(i(),H,t(c).length,r())}function h(H,U){i(H),typeof n.onrangechange=="function"&&n.onrangechange(t(l))}function u(H,U){a(H),typeof n.onrangechange=="function"&&n.onrangechange(t(l))}function m(H){i(H.topIndex),a(H.bottomIndex),typeof n.onrangechange=="function"&&n.onrangechange(t(l))}var b=ka(),T=p(b),M=p(T),A=w(p(M),2);zt(A,{get options(){return t(c)},get selectedIndex(){return i()},onchange:h,onbeforechange:f,get wheelHeight(){return n.wheelHeight},ariaLabel:"High pitch selector"});var C=w(M,2),P=w(p(C),2);zt(P,{get options(){return t(c)},get selectedIndex(){return a()},onchange:u,onbeforechange:y,get wheelHeight(){return n.wheelHeight},ariaLabel:"Low pitch selector"});var x=w(T,2);{var L=H=>{var U=Na(),ie=p(U),te=p(ie),S=w(ie,2),q=p(S);Z(()=>{Y(te,t(d)),Y(q,t(g))}),k(H,U)};$(x,H=>{o()&&H(L)})}var N=w(x,2);{var O=H=>{Sa(H,{get presets(){return n.presets},get activePreset(){return t(v)},onPresetClick:m})};$(N,H=>{s()&&n.presets&&n.presets.length>0&&H(O)})}k(e,b),ye()}Te(["change"]);var Da=D('<div class="range-control svelte-150ksck"><h3 class="control-title svelte-150ksck">Pitch Range</h3> <!></div>');function Ha(e,n){pe(n,!0);function i(d){const g=dt.findIndex(v=>v.midi===d);return g>=0?g:0}const a=I(()=>i(j.state.yAxisRange.maxMidi)),r=I(()=>i(j.state.yAxisRange.minMidi)),o=Ra(dt);function s(d){const g=d.bottomPitch.midi??21,v=d.topPitch.midi??108;j.setYAxisRange({minMidi:g,maxMidi:v})}var c=Da(),l=w(p(c),2);La(l,{get fullRowData(){return dt},get topIndex(){return t(a)},get bottomIndex(){return t(r)},minSpan:7,onrangechange:s,showSummary:!0,wheelHeight:200,get presets(){return o},showPresets:!0}),k(e,c),ye()}var Ea=D('<div class="pitch-highlight-toggle svelte-1v98ldk"><span class="toggle-label svelte-1v98ldk">Pitch Highlight</span> <button> </button></div>');function Oa(e,n){pe(n,!1);function i(){j.togglePitchHighlight()}St();var a=Ea(),r=w(p(a),2);let o;r.__click=i;var s=p(r);Z(()=>{o=Ye(r,1,"toggle-button svelte-1v98ldk",null,o,{active:j.state.pitchHighlightEnabled}),Y(s,j.state.pitchHighlightEnabled?"On":"Off")}),k(e,a),ye()}Te(["click"]);var Fa=D('<button class="start-exercise-btn svelte-16rxcxh">Start Demo Exercise</button>'),Wa=D('<button class="stop-exercise-btn svelte-16rxcxh">Stop Exercise</button> <div class="progress-indicator svelte-16rxcxh"> </div> <div class="phase-indicator svelte-16rxcxh"> </div>',1),Ba=D('<div><span class="result-loop svelte-16rxcxh"></span> <span class="result-pitch svelte-16rxcxh"> </span> <span class="result-accuracy svelte-16rxcxh"> </span> <span class="result-status svelte-16rxcxh"> </span></div>'),Ga=D('<div class="exercise-results svelte-16rxcxh"><h4 class="results-title svelte-16rxcxh">Results</h4> <div class="results-summary svelte-16rxcxh"><div class="stat svelte-16rxcxh"><span class="stat-label svelte-16rxcxh">Average Accuracy:</span> <span class="stat-value svelte-16rxcxh"> </span></div> <div class="stat svelte-16rxcxh"><span class="stat-label svelte-16rxcxh">Hits:</span> <span class="stat-value svelte-16rxcxh"> </span></div></div> <details class="results-details svelte-16rxcxh"><summary class="results-summary-label svelte-16rxcxh">Detailed Results</summary> <div class="results-list svelte-16rxcxh"></div></details></div>'),Ya=D('<div class="demo-exercise-panel svelte-16rxcxh"><h3 class="panel-title svelte-16rxcxh">Demo Exercise</h3> <details class="settings-details svelte-16rxcxh"><summary class="settings-summary svelte-16rxcxh">Settings</summary> <div class="exercise-settings svelte-16rxcxh"><label class="setting-label svelte-16rxcxh"><span class="label-text svelte-16rxcxh">Number of loops:</span> <input class="setting-input svelte-16rxcxh" type="number" min="1" max="20"/></label> <label class="setting-label svelte-16rxcxh"><span class="label-text svelte-16rxcxh">Tempo (BPM):</span> <input class="setting-input svelte-16rxcxh" type="number" min="60" max="180"/></label> <label class="setting-label svelte-16rxcxh"><span class="label-text svelte-16rxcxh">Reference Volume:</span> <input class="setting-slider svelte-16rxcxh" type="range" min="-40" max="0"/> <span class="volume-value svelte-16rxcxh"> </span></label> <div class="pitch-range-buttons svelte-16rxcxh"><button class="range-btn svelte-16rxcxh">Use Current Range</button> <button class="range-btn svelte-16rxcxh">Use Full Range</button></div></div></details> <div class="exercise-controls svelte-16rxcxh"><!></div> <!></div>');function qa(e,n){pe(n,!0);let i=z(!1),a=z(5),r=z(108),o=z(-12);const s=I(()=>he.state.isActive),c=I(()=>he.state.isPlaying),l=I(()=>he.state.currentPhase),d=I(()=>he.getCurrentProgress()),g=I(()=>he.getResults()),v=I(()=>t(g).length>0),f=I(()=>he.getAverageAccuracy()),y=I(()=>he.getHitCount()),h=I(()=>t(g).length);Re(()=>{if(!t(s)||!t(c))return;const R=de.state.currentTimeMs;he.updatePhase(R)}),Re(()=>{if(!t(s))return;const R=de.getPerformanceResults();he.getGeneratedNotes().forEach((se,ue)=>{if(se.lyric!=="ðŸŽ¤")return;const be=`target-${ue}`,we=R.get(be);if(we&&!he.hasResultForLoop(Math.floor(ue/2))){const me=u(we);he.addResult({loopIndex:Math.floor(ue/2),targetPitch:se.midi,accuracy:me,performance:we})}})});function u(R){return R.hitStatus==="hit"?R.pitchAccuracyCents!==void 0?Math.max(0,100-Math.abs(R.pitchAccuracyCents)/50*100):100:0}Ge(()=>{t(s)&&M()});function m(){const R=j.state.yAxisRange;he.setPitchRange(R.minMidi,R.maxMidi)}function b(){he.setPitchRange(21,108)}async function T(){j.setVisualizationMode("highway"),he.configure({numLoops:t(a),tempo:t(r),referenceVolume:t(o)}),m(),await je.init(),je.setVolume(t(o)),he.start();const R=he.getGeneratedNotes();de.setTargetNotes(R),de.start(),he.setPlaying(!0);const K=R.filter(se=>se.lyric==="ðŸ‘‚");je.scheduleReferenceTones(K)}function M(){je.stop(),de.stop(),he.stop()}function A(R){switch(R){case"reference":return"ðŸ‘‚ Listen";case"input":return"ðŸŽ¤ Sing";default:return"Rest"}}function C(R){return Qn(R)?.pitch||`MIDI ${R}`}var P=Ya(),x=w(p(P),2),L=w(p(x),2),N=p(L),O=w(p(N),2),H=w(N,2),U=w(p(H),2),ie=w(H,2),te=w(p(ie),2),S=w(te,2),q=p(S),J=w(ie,2),le=p(J);le.__click=m;var _e=w(le,2);_e.__click=b;var Pe=w(x,2),Ce=p(Pe);{var ee=R=>{var K=Fa();K.__click=T,k(R,K)},V=R=>{var K=Wa(),se=Je(K);se.__click=M;var ue=w(se,2),be=p(ue),we=w(ue,2),me=p(we);Z(X=>{Y(be,`Loop ${t(d).current??""} / ${t(d).total??""}`),Y(me,X)},[()=>A(t(l))]),k(R,K)};$(Ce,R=>{t(s)?R(V,!1):R(ee)})}var Q=w(Pe,2);{var W=R=>{var K=Ga(),se=w(p(K),2),ue=p(se),be=w(p(ue),2),we=p(be),me=w(ue,2),X=w(p(me),2),ae=p(X),_=w(se,2),F=w(p(_),2);qe(F,21,()=>t(g),et,(B,oe,ge)=>{var Me=Ba();let re;var Ie=p(Me);Ie.textContent=`Loop ${ge+1}:`;var ne=w(Ie,2),Le=p(ne),He=w(ne,2),Ue=p(He),bn=w(He,2),wn=p(bn);Z((Mn,_n)=>{re=Ye(Me,1,"result-item svelte-16rxcxh",null,re,{hit:t(oe).performance?.hitStatus==="hit"}),Y(Le,Mn),Y(Ue,`${_n??""}%`),Y(wn,t(oe).performance?.hitStatus==="hit"?"âœ“":"âœ—")},[()=>C(t(oe).targetPitch),()=>t(oe).accuracy.toFixed(0)]),k(B,Me)}),Z(B=>{Y(we,`${B??""}%`),Y(ae,`${t(y)??""}/${t(h)??""}`)},[()=>t(f).toFixed(1)]),k(R,K)};$(Q,R=>{t(v)&&!t(s)&&R(W)})}Z(()=>{O.disabled=t(s),U.disabled=t(s),te.disabled=t(s),Y(q,`${t(o)??""} dB`),le.disabled=t(s),_e.disabled=t(s)}),ut(O,()=>t(a),R=>E(a,R)),ut(U,()=>t(r),R=>E(r,R)),ut(te,()=>t(o),R=>E(o,R)),rn("open","toggle",x,R=>E(i,R),()=>t(i)),k(e,P),ye()}Te(["click"]);const Ua=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,/^([a-zA-Z0-9_-]{11})$/],Va={gapMs:0,videoGapSec:0,manualOffsetSec:0},Rt=60;function Xa(e){try{const n=e.split(/\r?\n/).map(s=>s.trim()),i=ja(n);if(!i.bpm)return{success:!1,error:"Missing required #BPM tag"};const{notes:a,lineBreaks:r,totalBeats:o}=za(n);return a.length===0?{success:!1,error:"No valid notes found in file"}:{success:!0,song:{metadata:i,notes:a,lineBreaks:r,totalBeats:o}}}catch(n){return{success:!1,error:n instanceof Error?n.message:"Unknown parsing error"}}}function ja(e){const n={};for(const i of e){if(!i.startsWith("#"))continue;const a=i.indexOf(":");if(a===-1)continue;const r=i.slice(1,a).toUpperCase().trim(),o=i.slice(a+1).trim();switch(r){case"TITLE":n.title=o;break;case"ARTIST":n.artist=o;break;case"VIDEO":n.video=o;break;case"VIDEOGAP":n.videoGap=parseFloat(o.replace(",","."))||0;break;case"GAP":n.gap=parseFloat(o.replace(",","."))||0;break;case"BPM":n.bpm=parseFloat(o.replace(",","."))||0;break;case"MP3":case"AUDIO":n.mp3=o;break;case"LANGUAGE":n.language=o;break;case"GENRE":n.genre=o;break;case"YEAR":n.year=parseInt(o)||void 0;break;case"CREATOR":n.creator=o;break;case"COVER":n.cover=o;break;case"BACKGROUND":n.background=o;break;case"PREVIEWSTART":n.previewStart=parseFloat(o.replace(",","."))||0;break}}return{title:n.title||"Unknown Title",artist:n.artist||"Unknown Artist",bpm:n.bpm||0,...n}}function za(e){const n=[],i=[];let a=0;for(const r of e){if(r.length===0||r.startsWith("#"))continue;const o=r[0];if(o==="E")break;if(o==="-"){const s=r.slice(1).trim().split(/\s+/),c=parseInt(s[0])||0;i.push(c);continue}if([":","*","F","R"].includes(o)){const s=Ka(r);if(s){n.push(s);const c=s.startBeat+s.duration;c>a&&(a=c)}}}return{notes:n,lineBreaks:i,totalBeats:a}}function Ka(e){const n=e[0],a=e.slice(1).trim().split(/\s+/);if(a.length<3)return null;const r=parseInt(a[0]),o=parseInt(a[1]),s=parseInt(a[2]),c=a.slice(3).join(" ")||"";return isNaN(r)||isNaN(o)||isNaN(s)?null:{type:n,startBeat:r,duration:o,pitch:s,lyric:c}}function Za(e){if(!e)return null;const n=e.trim();for(const i of Ua){const a=n.match(i);if(a&&a[1])return a[1]}return null}function Kt(e,n=Rt){const{metadata:i,notes:a,lineBreaks:r}=e,{bpm:o}=i,s=60/o*1e3*4;let c=0;const l=[...r].sort((g,v)=>g-v),d=a.length>0?Math.min(...a.map(g=>g.startBeat)):0;return a.filter(g=>g.type!=="F").map(g=>{const v=(g.startBeat-d)*s,f=g.duration*s,y=n+g.pitch;for(;c<l.length&&g.startBeat>=l[c];)c++;const h={midi:y,startTimeMs:v,durationMs:f,lyric:g.lyric.trim()||void 0};return g.type==="*"&&(h.isGolden=!0),h})}function Ja(e){return{gapMs:e.gap||0,videoGapSec:e.videoGap||0,manualOffsetSec:0}}function Qa(e){const{metadata:n,notes:i,totalBeats:a}=e,{bpm:r}=n,o=60/r*1e3*4,s=i.length>0?Math.min(...i.map(l=>l.startBeat)):0;return(a-s)*o+2e3}function Zt(e,n=Rt){const i=e.notes.filter(o=>o.type!=="F"&&o.type!=="-").map(o=>n+o.pitch);if(i.length===0)return{minMidi:48,maxMidi:72};const a=Math.min(...i),r=Math.max(...i);return{minMidi:Math.max(24,a-3),maxMidi:Math.min(108,r+3)}}const Jt={isActive:!1,isLoading:!1,isPlaying:!1,song:null,targetNotes:[],youtubeId:null,syncConfig:{...Va},baseMidi:Rt,totalDurationMs:0,detectedRange:{minMidi:48,maxMidi:72},error:null};function $a(){let e=z(ke({...Jt})),n=null;return{get state(){return t(e)},async loadFile(i){t(e).isLoading=!0,t(e).error=null;try{const a=await i.text(),r=Xa(a);if(!r.success)return t(e).error=r.error,t(e).isLoading=!1,!1;const o=r.song,s=o.metadata.video?Za(o.metadata.video):null,c=Ja(o.metadata),l=Kt(o,t(e).baseMidi),d=Qa(o),g=Zt(o,t(e).baseMidi);return t(e).song=o,t(e).youtubeId=s,t(e).syncConfig=c,t(e).targetNotes=l,t(e).totalDurationMs=d,t(e).detectedRange=g,t(e).isActive=!0,t(e).isLoading=!1,!0}catch(a){return t(e).error=a instanceof Error?a.message:"Failed to load file",t(e).isLoading=!1,!1}},get youtubeOffset(){const{gapMs:i,videoGapSec:a,manualOffsetSec:r}=t(e).syncConfig;return i/1e3+a+r},adjustOffset(i){t(e).syncConfig={...t(e).syncConfig,manualOffsetSec:t(e).syncConfig.manualOffsetSec+i}},setManualOffset(i){t(e).syncConfig={...t(e).syncConfig,manualOffsetSec:i}},resetOffset(){t(e).syncConfig={...t(e).syncConfig,manualOffsetSec:0}},setBaseMidi(i){t(e).baseMidi=i,t(e).song&&(t(e).targetNotes=Kt(t(e).song,i),t(e).detectedRange=Zt(t(e).song,i))},setPlaying(i){t(e).isPlaying=i},onComplete(i){n=i},triggerComplete(){t(e).isPlaying=!1,n&&n()},checkCompletion(i){return!t(e).isPlaying||!t(e).isActive?!1:i>=t(e).totalDurationMs-500?(this.triggerComplete(),!0):!1},get title(){return t(e).song?.metadata.title||""},get artist(){return t(e).song?.metadata.artist||""},get hasVideo(){return t(e).youtubeId!==null},reset(){E(e,{...Jt},!0),n=null},unload(){t(e).isActive=!1,t(e).isPlaying=!1,t(e).song=null,t(e).targetNotes=[],t(e).youtubeId=null,t(e).totalDurationMs=0,t(e).error=null}}}const G=$a();let at=null,ze=!1;function es(){return at||(ze&&window.YT&&window.YT.Player?Promise.resolve():(at=new Promise((e,n)=>{if(window.YT&&window.YT.Player){ze=!0,e();return}window.onYouTubeIframeAPIReady=()=>{ze=!0,e()};const i=document.createElement("script");i.src="https://www.youtube.com/iframe_api",i.async=!0,i.onerror=()=>{n(new Error("Failed to load YouTube IFrame API"))},document.head.appendChild(i),setTimeout(()=>{ze||n(new Error("YouTube IFrame API load timeout"))},1e4)}),at))}function ts(e,n,i={}){if(!ze||!window.YT?.Player)throw new Error("YouTube API not loaded. Call loadYouTubeAPI() first.");const{width:a=320,height:r=180,onReady:o,onStateChange:s,onError:c}=i;return new window.YT.Player(e,{width:a,height:r,videoId:n,playerVars:{autoplay:0,controls:1,disablekb:1,enablejsapi:1,fs:0,modestbranding:1,origin:window.location.origin,playsinline:1,rel:0},events:{onReady:l=>{o?.(l.target)},onStateChange:l=>{s?.(l.data)},onError:l=>{c?.(l.data)}}})}function ns(e){switch(e){case YT.PlayerError.InvalidParam:return"Invalid video ID";case YT.PlayerError.Html5Error:return"HTML5 player error";case YT.PlayerError.VideoNotFound:return"Video not found";case YT.PlayerError.NotAllowedEmbedded:case YT.PlayerError.NotAllowedEmbedded2:return"Video cannot be embedded";default:return"Unknown player error"}}const pt={isApiLoaded:!1,isApiLoading:!1,isPlayerReady:!1,isPlaying:!1,currentTime:0,duration:0,videoId:null,error:null,isEmbeddable:!0,volume:100,isMuted:!1};function is(){let e=z(ke({...pt})),n=null,i=null,a=null;return{get state(){return t(e)},async initAPI(){if(t(e).isApiLoaded)return!0;if(t(e).isApiLoading)return!1;t(e).isApiLoading=!0,t(e).error=null;try{return await es(),t(e).isApiLoaded=!0,t(e).isApiLoading=!1,!0}catch(r){return t(e).error=r instanceof Error?r.message:"Failed to load YouTube API",t(e).isApiLoading=!1,!1}},async loadVideo(r,o){if(!t(e).isApiLoaded&&!await this.initAPI())return!1;if(n){try{n.destroy()}catch{}n=null}return t(e).isPlayerReady=!1,t(e).error=null,t(e).isEmbeddable=!0,t(e).videoId=r,new Promise(s=>{try{n=ts(o,r,{onReady:c=>{t(e).isPlayerReady=!0,t(e).duration=c.getDuration(),t(e).volume=c.getVolume(),t(e).isMuted=c.isMuted(),s(!0)},onStateChange:c=>{t(e).isPlaying=c===YT.PlayerState.PLAYING,c===YT.PlayerState.ENDED&&(t(e).isPlaying=!1,this.stopSyncLoop())},onError:c=>{t(e).error=ns(c),t(e).isEmbeddable=c!==YT.PlayerError.NotAllowedEmbedded&&c!==YT.PlayerError.NotAllowedEmbedded2,t(e).isPlayerReady=!1,s(!1)}})}catch(c){t(e).error=c instanceof Error?c.message:"Failed to create player",s(!1)}})},play(){n&&t(e).isPlayerReady&&n.playVideo()},pause(){n&&t(e).isPlayerReady&&n.pauseVideo()},stop(){n&&t(e).isPlayerReady&&(n.stopVideo(),t(e).isPlaying=!1),this.stopSyncLoop()},seekTo(r){n&&t(e).isPlayerReady&&(n.seekTo(Math.max(0,r),!0),t(e).currentTime=Math.max(0,r))},getCurrentTime(){return n&&t(e).isPlayerReady?n.getCurrentTime():t(e).currentTime},setVolume(r){const o=Math.max(0,Math.min(100,r));n&&t(e).isPlayerReady&&n.setVolume(o),t(e).volume=o},mute(){n&&t(e).isPlayerReady&&n.mute(),t(e).isMuted=!0},unmute(){n&&t(e).isPlayerReady&&n.unMute(),t(e).isMuted=!1},toggleMute(){t(e).isMuted?this.unmute():this.mute()},startSyncLoop(r,o=250){a=r,i!==null&&clearInterval(i),i=window.setInterval(()=>{if(n&&t(e).isPlayerReady&&t(e).isPlaying){const s=n.getCurrentTime();t(e).currentTime=s,a?.(s)}},o)},stopSyncLoop(){i!==null&&(clearInterval(i),i=null),a=null},correctDrift(r,o=150){if(!n||!t(e).isPlayerReady||!t(e).isPlaying)return!1;const s=n.getCurrentTime();return Math.abs(s-r)*1e3>o?(n.seekTo(r,!0),!0):!1},getVideoUrl(){return t(e).videoId?`https://www.youtube.com/watch?v=${t(e).videoId}`:null},dispose(){if(this.stopSyncLoop(),n){try{n.destroy()}catch{}n=null}E(e,{...pt,isApiLoaded:t(e).isApiLoaded},!0)},reset(){this.dispose(),E(e,{...pt},!0)}}}const ve=is();function as(e){let n={...e.syncConfig};const i=e.driftCheckIntervalMs??250,a=e.maxDriftMs??150;function r(){return n.gapMs/1e3+n.videoGapSec+n.manualOffsetSec}function o(u){return u/1e3+r()}function s(u){return(u-r())*1e3}function c(u,m){const b=o(u),T=m-b,M=Math.abs(T*1e3);if(M>a){const A=s(m);return{driftMs:M,needsCorrection:!0,correctedTransportTimeMs:A}}return{driftMs:M,needsCorrection:!1}}function l(u){n={...n,...u}}function d(u){n.manualOffsetSec+=u}function g(){n.manualOffsetSec=0}function v(){return n.manualOffsetSec}function f(){return r()}function y(){const u=n.manualOffsetSec;return`${u>=0?"+":""}${u.toFixed(2)}s`}function h(){return{intervalMs:i,maxDriftMs:a}}return{getYouTubeOffset:r,getTotalOffset:f,getManualOffset:v,getSyncLoopConfig:h,transportToYouTube:o,youTubeToTransport:s,checkDrift:c,updateConfig:l,adjustManualOffset:d,resetManualOffset:g,formatOffset:y,getConfig:()=>({...n})}}var ss=D('<div class="youtube-loading svelte-1pmfeb3"><div class="spinner svelte-1pmfeb3"></div> <span>Loading video...</span></div>'),os=D('<button class="fallback-btn svelte-1pmfeb3">Open on YouTube â†—</button>'),rs=D('<div class="youtube-error svelte-1pmfeb3"><span class="error-icon svelte-1pmfeb3">âš ï¸</span> <span class="error-message svelte-1pmfeb3"> </span> <!></div>'),ls=D('<div class="youtube-placeholder svelte-1pmfeb3"><span class="placeholder-icon svelte-1pmfeb3">ðŸŽ¬</span> <span class="placeholder-text svelte-1pmfeb3">No video loaded</span></div>'),cs=D('<div class="youtube-container svelte-1pmfeb3"><div class="youtube-player svelte-1pmfeb3"></div> <!> <!> <!></div>');function ds(e,n){pe(n,!0);const i=`youtube-player-${Math.random().toString(36).slice(2,9)}`,a=I(()=>ve.state.isApiLoading||ve.state.videoId&&!ve.state.isPlayerReady),r=I(()=>!!ve.state.error),o=I(()=>ve.state.isEmbeddable),s=I(()=>G.state.youtubeId);Re(()=>{t(s)&&ve.loadVideo(t(s),i)}),Ge(()=>{ve.dispose()});function c(){const m=ve.getVideoUrl();m&&window.open(m,"_blank","noopener,noreferrer")}var l=cs(),d=p(l),g=w(d,2);{var v=m=>{var b=ss();k(m,b)};$(g,m=>{t(a)&&t(s)&&m(v)})}var f=w(g,2);{var y=m=>{var b=rs(),T=w(p(b),2),M=p(T),A=w(T,2);{var C=P=>{var x=os();x.__click=c,k(P,x)};$(A,P=>{t(o)||P(C)})}Z(()=>Y(M,ve.state.error)),k(m,b)};$(f,m=>{t(r)&&m(y)})}var h=w(f,2);{var u=m=>{var b=ls();k(m,b)};$(h,m=>{!t(s)&&!t(a)&&!t(r)&&m(u)})}Z(()=>Oe(d,"id",i)),k(e,l),ye()}Te(["click"]);var us=D('<div class="sync-controls svelte-1xjjmjf"><div class="sync-header svelte-1xjjmjf"><span class="sync-label svelte-1xjjmjf">Sync Offset</span> <span class="sync-value svelte-1xjjmjf"> </span></div> <div class="sync-buttons svelte-1xjjmjf"><button class="sync-btn coarse svelte-1xjjmjf" title="Earlier by 0.1s">-0.1s</button> <button class="sync-btn fine svelte-1xjjmjf" title="Earlier by 0.01s">-0.01s</button> <button class="sync-btn reset svelte-1xjjmjf" title="Reset offset">0</button> <button class="sync-btn fine svelte-1xjjmjf" title="Later by 0.01s">+0.01s</button> <button class="sync-btn coarse svelte-1xjjmjf" title="Later by 0.1s">+0.1s</button></div> <div class="sync-hint svelte-1xjjmjf">Use arrow keys to adjust (Shift for coarse)</div></div>');function fs(e,n){pe(n,!0);const i=I(()=>G.state.syncConfig.manualOffsetSec),a=I(()=>G.state.isActive);function r(T){return`${T>=0?"+":""}${T.toFixed(2)}s`}function o(T){G.adjustOffset(T)}function s(){G.resetOffset()}function c(T){if(t(a)&&!(T.target instanceof HTMLInputElement))switch(T.key){case"ArrowLeft":T.preventDefault(),o(T.shiftKey?-.1:-.01);break;case"ArrowRight":T.preventDefault(),o(T.shiftKey?.1:.01);break}}var l=us();Ke("keydown",nn,c);var d=p(l),g=w(p(d),2),v=p(g),f=w(d,2),y=p(f);y.__click=()=>o(-.1);var h=w(y,2);h.__click=()=>o(-.01);var u=w(h,2);u.__click=s;var m=w(u,2);m.__click=()=>o(.01);var b=w(m,2);b.__click=()=>o(.1),Z(T=>{Y(v,T),y.disabled=!t(a),h.disabled=!t(a),u.disabled=!t(a)||t(i)===0,m.disabled=!t(a),b.disabled=!t(a)},[()=>r(t(i))]),k(e,l),ye()}Te(["click"]);var hs=D('<span class="spinner svelte-oab1bu"></span> Loading...',1),gs=D('<div class="error-message svelte-oab1bu"> </div>'),vs=D('<button class="upload-btn svelte-oab1bu"><!></button> <!>',1),ms=D('<div class="video-section svelte-oab1bu"><!> <!></div>'),ps=D('<button class="play-btn svelte-oab1bu">â–¶ Play</button>'),ys=D('<button class="stop-btn svelte-oab1bu">â¹ Stop</button>'),bs=D('<div class="progress-info svelte-oab1bu"><span class="time-display svelte-oab1bu"> </span></div>'),ws=D('<div class="song-info svelte-oab1bu"><div class="song-title svelte-oab1bu"> </div> <div class="song-artist svelte-oab1bu"> </div></div> <!> <div class="playback-controls svelte-oab1bu"><!> <button class="unload-btn svelte-oab1bu">Unload</button></div> <!>',1),Ms=D('<div class="ultrastar-panel svelte-oab1bu"><h3 class="panel-title svelte-oab1bu">Ultrastar Song</h3> <input type="file" accept=".txt" style="display: none;"/> <!></div>');function _s(e,n){pe(n,!0);let i=null,a;const r=I(()=>G.state.isActive),o=I(()=>G.state.isLoading),s=I(()=>G.state.isPlaying),c=I(()=>G.hasVideo),l=I(()=>G.title),d=I(()=>G.artist),g=I(()=>G.state.error);async function v(x){const L=x.target,N=L.files?.[0];if(!N)return;if(await G.loadFile(N)){i=as({syncConfig:G.state.syncConfig});const H=G.state.detectedRange;j.setYAxisRange({minMidi:H.minMidi,maxMidi:H.maxMidi}),de.setTargetNotes(G.state.targetNotes),console.log("[Ultrastar] File loaded:",{title:G.title,artist:G.artist,youtubeId:G.state.youtubeId,bpm:G.state.song?.metadata.bpm,gap:G.state.song?.metadata.gap,videoGap:G.state.song?.metadata.videoGap,noteCount:G.state.targetNotes.length,firstNotes:G.state.targetNotes.slice(0,3),lastNotes:G.state.targetNotes.slice(-3),totalDurationMs:G.state.totalDurationMs,pitchRange:H,syncConfig:G.state.syncConfig})}L.value=""}async function f(){if(t(r))if(j.setVisualizationMode("highway"),i&&i.updateConfig(G.state.syncConfig),de.setTargetNotes(G.state.targetNotes),G.setPlaying(!0),t(c)&&ve.state.isPlayerReady){const x=i?.getYouTubeOffset()??0;console.log("[Ultrastar] Starting playback:",{youtubeOffset:x,noteCount:G.state.targetNotes.length,firstNote:G.state.targetNotes[0],syncConfig:G.state.syncConfig}),de.setCurrentTime(0),ve.seekTo(x),ve.play(),u()}else de.start()}function y(){de.stop(),G.setPlaying(!1),ve.pause(),m()}function h(){y(),G.unload(),ve.dispose(),de.reset(),i=null}function u(){ve.startSyncLoop(x=>{if(!i)return;const L=i.youTubeToTransport(x),N=de.state.currentTimeMs;Math.abs(L-N)>50&&de.setCurrentTime(Math.max(0,L))},100)}function m(){ve.stopSyncLoop()}function b(){a?.click()}Ge(()=>{m(),ve.dispose()});var T=Ms(),M=w(p(T),2);M.__change=v,Ne(M,x=>a=x,()=>a);var A=w(M,2);{var C=x=>{var L=vs(),N=Je(L);N.__click=b;var O=p(N);{var H=S=>{var q=hs();k(S,q)},U=S=>{var q=Xn("Upload Ultrastar .txt");k(S,q)};$(O,S=>{t(o)?S(H):S(U,!1)})}var ie=w(N,2);{var te=S=>{var q=gs(),J=p(q);Z(()=>Y(J,t(g))),k(S,q)};$(ie,S=>{t(g)&&S(te)})}Z(()=>N.disabled=t(o)),k(x,L)},P=x=>{var L=ws(),N=Je(L),O=p(N),H=p(O),U=w(O,2),ie=p(U),te=w(N,2);{var S=V=>{var Q=ms(),W=p(Q);ds(W,{});var R=w(W,2);fs(R,{}),k(V,Q)};$(te,V=>{t(c)&&V(S)})}var q=w(te,2),J=p(q);{var le=V=>{var Q=ps();Q.__click=f,k(V,Q)},_e=V=>{var Q=ys();Q.__click=y,k(V,Q)};$(J,V=>{t(s)?V(_e,!1):V(le)})}var Pe=w(J,2);Pe.__click=h;var Ce=w(q,2);{var ee=V=>{var Q=bs(),W=p(Q),R=p(W);Z((K,se)=>Y(R,`${K??""}s
          / ${se??""}s`),[()=>Math.floor(de.state.currentTimeMs/1e3),()=>Math.floor(G.state.totalDurationMs/1e3)]),k(V,Q)};$(Ce,V=>{t(s)&&V(ee)})}Z(()=>{Y(H,t(l)),Y(ie,t(d)),Pe.disabled=t(s)}),k(x,L)};$(A,x=>{t(r)?x(P,!1):x(C)})}k(e,T),ye()}Te(["change","click"]);var Ts=D('<div class="note-display svelte-fwpoo3"><span class="note-name svelte-fwpoo3"> </span> <span class="octave svelte-fwpoo3"> </span></div> <div class="details svelte-fwpoo3"><span class="frequency"> </span> <span> </span> <span class="clarity"> </span></div>',1),Ps=D('<div class="no-pitch svelte-fwpoo3"><span class="placeholder svelte-fwpoo3">---</span> <span class="hint svelte-fwpoo3">Sing or hum into the microphone</span></div>'),Cs=D('<div class="pitch-readout svelte-fwpoo3"><!></div>');function Ss(e,n){pe(n,!0);const i=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],a=I(()=>()=>{const l=ce.state.currentPitch;if(!l)return null;const d=i[l.pitchClass],g=Math.floor(l.midi/12)-1,v=Math.round((l.midi-Math.round(l.midi))*100);return{name:d,octave:g,frequency:l.frequency.toFixed(1),cents:v,clarity:Math.round(l.clarity*100)}});var r=Cs(),o=p(r);{var s=l=>{const d=I(()=>t(a)());var g=Ts(),v=Je(g),f=p(v),y=p(f),h=w(f,2),u=p(h),m=w(v,2),b=p(m),T=p(b),M=w(b,2);let A;var C=p(M),P=w(M,2),x=p(P);Z(()=>{Y(y,t(d).name),Y(u,t(d).octave),Y(T,`${t(d).frequency??""} Hz`),A=Ye(M,1,"cents svelte-fwpoo3",null,A,{sharp:t(d).cents>0,flat:t(d).cents<0}),Y(C,`${t(d).cents>0?"+":""}${t(d).cents??""}Â¢`),Y(x,`${t(d).clarity??""}%`)}),k(l,g)},c=l=>{var d=Ps();k(l,d)};$(o,l=>{t(a)()?l(s):l(c,!1)})}k(e,r),ye()}const Qt={isVisible:!1,summary:null,songTitle:"",artistName:"",source:null},xs={totalNotes:0,notesHit:0,notesMissed:0,accuracyPercent:0,goldenNotesHit:0,goldenNotesTotal:0,phraseResults:[],averagePitchDeviationCents:0};function Is(){let e=z(ke({...Qt}));return{get state(){return t(e)},show(n,i={}){t(e).summary=n,t(e).songTitle=i.title||"",t(e).artistName=i.artist||"",t(e).source=i.source||null,t(e).isVisible=!0},hide(){t(e).isVisible=!1},clear(){E(e,{...Qt},!0)},calculateSummary(n,i){if(i.length===0)return{...xs};let a=0,r=0,o=0,s=0,c=0;const l=new Map;i.forEach((h,u)=>{const m=`target-${u}`,b=n.get(m),T=h.isGolden===!0,M=h.phraseIndex??0;T&&o++,l.has(M)||l.set(M,{hit:0,total:0,lyrics:[]});const A=l.get(M);A.total++,h.lyric&&A.lyrics.push(h.lyric),b?.hitStatus==="hit"&&(a++,A.hit++,T&&r++,typeof b.pitchAccuracyCents=="number"&&(s+=Math.abs(b.pitchAccuracyCents),c++))});const d=i.length,g=d-a,v=d>0?a/d*100:0,f=c>0?s/c:0,y=[];return l.forEach((h,u)=>{y.push({phraseIndex:u,notesHit:h.hit,totalNotes:h.total,accuracyPercent:h.total>0?h.hit/h.total*100:0,lyricPreview:h.lyrics.join("").trim().slice(0,30)||`Phrase ${u+1}`})}),y.sort((h,u)=>h.phraseIndex-u.phraseIndex),{totalNotes:d,notesHit:a,notesMissed:g,accuracyPercent:v,goldenNotesHit:r,goldenNotesTotal:o,phraseResults:y,averagePitchDeviationCents:f}},getLetterGrade(n){return n>=95?"S":n>=90?"A":n>=80?"B":n>=70?"C":n>=60?"D":"F"},getAccuracyColor(n){return n>=90?"var(--color-success, #28a745)":n>=70?"var(--color-warning, #ffc107)":"var(--color-error, #dc3545)"}}}const xe=Is();var As=D('<span class="song-artist svelte-1rv7phe"> </span>'),Rs=D('<div class="song-info svelte-1rv7phe"><span class="song-title svelte-1rv7phe"> </span> <!></div>'),Ns=D('<div class="stat-item missed svelte-1rv7phe"><span class="stat-value svelte-1rv7phe"> </span> <span class="stat-label svelte-1rv7phe">Missed</span></div>'),ks=D('<div class="golden-stats svelte-1rv7phe"><span class="golden-icon svelte-1rv7phe">â­</span> <span class="golden-text svelte-1rv7phe"> </span></div>'),Ls=D('<div class="pitch-stats svelte-1rv7phe"><span class="pitch-label">Avg. Pitch Deviation:</span> <span class="pitch-value svelte-1rv7phe"> </span></div>'),Ds=D('<div><span class="phrase-lyric svelte-1rv7phe"> </span> <span class="phrase-accuracy svelte-1rv7phe"> </span></div>'),Hs=D('<details class="phrase-details svelte-1rv7phe"><summary class="phrase-summary svelte-1rv7phe">Phrase Breakdown</summary> <div class="phrase-list svelte-1rv7phe"></div></details>'),Es=D('<button class="action-btn retry-btn svelte-1rv7phe">Try Again</button>'),Os=D('<div class="modal-backdrop svelte-1rv7phe" role="dialog" aria-modal="true" aria-labelledby="results-title" tabindex="-1"><div class="modal-content svelte-1rv7phe"><div class="modal-header svelte-1rv7phe"><h2 id="results-title" class="modal-title svelte-1rv7phe">Results</h2> <!></div> <div class="stats-section svelte-1rv7phe"><div class="grade-display svelte-1rv7phe"><span class="grade-letter svelte-1rv7phe"> </span></div> <div class="accuracy-display svelte-1rv7phe"><span class="accuracy-value svelte-1rv7phe"> </span> <span class="accuracy-label svelte-1rv7phe">Accuracy</span></div> <div class="stats-row svelte-1rv7phe"><div class="stat-item svelte-1rv7phe"><span class="stat-value hit svelte-1rv7phe"> </span> <span class="stat-label svelte-1rv7phe">Hit</span></div> <div class="stat-divider svelte-1rv7phe">/</div> <div class="stat-item svelte-1rv7phe"><span class="stat-value total svelte-1rv7phe"> </span> <span class="stat-label svelte-1rv7phe">Total</span></div> <!></div> <!> <!></div> <!> <div class="modal-actions svelte-1rv7phe"><!> <button class="action-btn close-btn svelte-1rv7phe">Close</button></div></div></div>');function Fs(e,n){pe(n,!0);const i=I(()=>xe.state.isVisible),a=I(()=>xe.state.summary),r=I(()=>xe.state.songTitle),o=I(()=>xe.state.artistName),s=I(()=>t(a)?xe.getLetterGrade(t(a).accuracyPercent):"F"),c=I(()=>t(a)?xe.getAccuracyColor(t(a).accuracyPercent):"");function l(){xe.hide(),n.onClose?.()}function d(){xe.hide(),n.onRetry?.()}function g(u){u.target===u.currentTarget&&l()}function v(u){u.key==="Escape"&&t(i)&&l()}var f=jn();Ke("keydown",nn,v);var y=Je(f);{var h=u=>{var m=Os();m.__click=g,m.__keydown=v;var b=p(m),T=p(b),M=w(p(T),2);{var A=X=>{var ae=Rs(),_=p(ae),F=p(_),B=w(_,2);{var oe=ge=>{var Me=As(),re=p(Me);Z(()=>Y(re,`by ${t(o)??""}`)),k(ge,Me)};$(B,ge=>{t(o)&&ge(oe)})}Z(()=>Y(F,t(r))),k(X,ae)};$(M,X=>{t(r)&&X(A)})}var C=w(T,2),P=p(C);let x;var L=p(P),N=p(L),O=w(P,2);let H;var U=p(O),ie=p(U),te=w(O,2),S=p(te),q=p(S),J=p(q),le=w(S,4),_e=p(le),Pe=p(_e),Ce=w(le,2);{var ee=X=>{var ae=Ns(),_=p(ae),F=p(_);Z(()=>Y(F,t(a).notesMissed)),k(X,ae)};$(Ce,X=>{t(a).notesMissed>0&&X(ee)})}var V=w(te,2);{var Q=X=>{var ae=ks(),_=w(p(ae),2),F=p(_);Z(()=>Y(F,`Golden Notes: ${t(a).goldenNotesHit??""}/${t(a).goldenNotesTotal??""}`)),k(X,ae)};$(V,X=>{t(a).goldenNotesTotal>0&&X(Q)})}var W=w(V,2);{var R=X=>{var ae=Ls(),_=w(p(ae),2),F=p(_);Z(B=>Y(F,`${B??""} cents`),[()=>t(a).averagePitchDeviationCents.toFixed(1)]),k(X,ae)};$(W,X=>{t(a).averagePitchDeviationCents>0&&X(R)})}var K=w(C,2);{var se=X=>{var ae=Hs(),_=w(p(ae),2);qe(_,21,()=>t(a).phraseResults,et,(F,B)=>{var oe=Ds();let ge;var Me=p(oe),re=p(Me),Ie=w(Me,2),ne=p(Ie);Z(Le=>{ge=Ye(oe,1,"phrase-item svelte-1rv7phe",null,ge,{perfect:t(B).accuracyPercent===100,good:t(B).accuracyPercent>=70&&t(B).accuracyPercent<100,poor:t(B).accuracyPercent<70}),Y(re,t(B).lyricPreview),Y(ne,`${t(B).notesHit??""}/${t(B).totalNotes??""}
                  (${Le??""}%)`)},[()=>t(B).accuracyPercent.toFixed(0)]),k(F,oe)}),k(X,ae)};$(K,X=>{t(a).phraseResults.length>1&&X(se)})}var ue=w(K,2),be=p(ue);{var we=X=>{var ae=Es();ae.__click=d,k(X,ae)};$(be,X=>{n.onRetry&&X(we)})}var me=w(be,2);me.__click=l,Z(X=>{x=st(P,"",x,{"--grade-color":t(c)}),Y(N,t(s)),H=st(O,"",H,{color:t(c)}),Y(ie,`${X??""}%`),Y(J,t(a).notesHit),Y(Pe,t(a).totalNotes)},[()=>t(a).accuracyPercent.toFixed(1)]),k(u,m)};$(y,u=>{t(i)&&t(a)&&u(h)})}k(e,f),ye()}Te(["click","keydown"]);const yt={hasImportedSnapshot:!1,snapshot:null,isLoading:!1,error:null,transpositionSemitones:0};function Ws(){let e=z(ke({...yt}));return{get state(){return t(e)},async checkAndConsumeHandoff(){if(!ti())return!1;t(e).isLoading=!0,t(e).error=null;try{const i=await ni();return i?i.schemaVersion!==Nt?(t(e).error=`Incompatible snapshot version: ${i.schemaVersion}. Expected: ${Nt}`,t(e).isLoading=!1,tt(),!1):(t(e).snapshot=i,t(e).hasImportedSnapshot=!0,t(e).isLoading=!1,tt(),console.log("[HandoffState] Successfully imported snapshot",{voices:i.voices.length,microbeatCount:i.timeGrid.microbeatCount,tempo:i.tempo}),!0):(t(e).error="Handoff data expired or not found. Please try exporting again.",t(e).isLoading=!1,tt(),!1)}catch(i){return console.error("[HandoffState] Failed to process handoff",i),t(e).error="Failed to import data from Student Notation.",t(e).isLoading=!1,tt(),!1}},get voices(){return t(e).snapshot?.voices??[]},get timeGrid(){return t(e).snapshot?.timeGrid??null},get tempo(){return t(e).snapshot?.tempo??90},get suggestedPitchRange(){if(!t(e).snapshot)return null;const n=3,i=t(e).snapshot.minMidiPitch,a=t(e).snapshot.maxMidiPitch;return i===void 0||a===void 0?null:{minMidi:Math.max(21,i-n+t(e).transpositionSemitones),maxMidi:Math.min(108,a+n+t(e).transpositionSemitones)}},setTransposition(n){t(e).transpositionSemitones=n},transposeUp(){t(e).transpositionSemitones+=1},transposeDown(){t(e).transpositionSemitones-=1},getTransposedMidi(n){return n+t(e).transpositionSemitones},async bringBackToStudentNotation(){if(!t(e).snapshot){console.warn("[HandoffState] No snapshot to bring back");return}const n={...t(e).snapshot,sourceApp:"singing-trainer",createdAt:Date.now(),voices:t(e).snapshot.voices.map(i=>({...i,notes:i.notes.map(a=>({...a,midiPitch:a.midiPitch+t(e).transpositionSemitones}))}))};try{const i=await $n(n);console.log("[HandoffState] Handoff slot written for return",i),ei(i)}catch(i){console.error("[HandoffState] Failed to write return handoff",i)}},clearSnapshot(){E(e,{...yt},!0)},reset(){E(e,{...yt},!0)}}}const Se=Ws();var Bs=D('<div class="handoff-controls svelte-1qpo30f"><div class="transposition-control svelte-1qpo30f"><button class="transpose-btn svelte-1qpo30f" title="Transpose down">-</button> <span class="transposition-label svelte-1qpo30f"> </span> <button class="transpose-btn svelte-1qpo30f" title="Transpose up">+</button></div> <button class="bring-back-btn svelte-1qpo30f">Bring Back to Student Notation</button></div>'),Gs=D('<div class="error-banner svelte-1qpo30f"> </div>'),Ys=D('<div class="import-info svelte-1qpo30f"><span class="import-label svelte-1qpo30f">Microbeats:</span> <span class="import-value svelte-1qpo30f"> </span></div>'),qs=D('<div class="control-group svelte-1qpo30f"><h3 class="control-group-title svelte-1qpo30f">Imported Material</h3> <div class="import-info svelte-1qpo30f"><span class="import-label svelte-1qpo30f">Voices:</span> <span class="import-value svelte-1qpo30f"> </span></div> <div class="import-info svelte-1qpo30f"><span class="import-label svelte-1qpo30f">Tempo:</span> <span class="import-value svelte-1qpo30f"> </span></div> <!></div>'),Us=D('<div class="app svelte-1qpo30f"><header class="header svelte-1qpo30f"><h1 class="title svelte-1qpo30f">Singing Trainer</h1> <div class="header-controls svelte-1qpo30f"><!></div></header> <!> <main class="main svelte-1qpo30f"><aside class="sidebar sidebar--left svelte-1qpo30f"><div class="control-group svelte-1qpo30f"><!></div> <div class="control-group svelte-1qpo30f"><!></div> <div class="control-group svelte-1qpo30f"><!></div> <div class="control-group svelte-1qpo30f"><details class="settings-details svelte-1qpo30f"><summary class="settings-summary svelte-1qpo30f">Settings</summary> <div class="settings-content svelte-1qpo30f"><!> <!> <!></div></details></div> <div class="control-group svelte-1qpo30f"><!></div> <!></aside> <section class="canvas-area svelte-1qpo30f"><!></section></main> <!></div>');function Vs(e,n){pe(n,!0);let i=z(!1);Re(()=>de.onPerformanceComplete(V=>{if(G.state.isActive&&G.state.isPlaying){const Q=xe.calculateSummary(V,G.state.targetNotes);xe.show(Q,{title:G.title,artist:G.artist,source:"ultrastar"}),G.setPlaying(!1)}}));function a(){xe.state.source==="ultrastar"?(de.reset(),de.setTargetNotes(G.state.targetNotes),j.setVisualizationMode("highway")):xe.state.source}an(async()=>{if(await Se.checkAndConsumeHandoff()){console.log("[App] Handoff detected and processed");const V=Se.suggestedPitchRange;V&&j.setYAxisRange(V)}try{await da(),j.setDetecting(!0),console.log("[App] Pitch detection auto-started")}catch(V){console.error("[App] Failed to auto-start pitch detection:",V)}}),Ge(()=>{ua()});const r=I(()=>Se.state.hasImportedSnapshot),o=I(()=>Se.state.transpositionSemitones),s=I(()=>Se.state.error);function c(){Se.bringBackToStudentNotation()}function l(){Se.transposeUp()}function d(){Se.transposeDown()}var g=Us(),v=p(g),f=w(p(v),2),y=p(f);{var h=ee=>{var V=Bs(),Q=p(V),W=p(Q);W.__click=d;var R=w(W,2),K=p(R),se=w(R,2);se.__click=l;var ue=w(Q,2);ue.__click=c,Z(()=>Y(K,`${t(o)>=0?"+":""}${t(o)??""}`)),k(ee,V)};$(y,ee=>{t(r)&&ee(h)})}var u=w(v,2);{var m=ee=>{var V=Gs(),Q=p(V);Z(()=>Y(Q,t(s))),k(ee,V)};$(u,ee=>{t(s)&&ee(m)})}var b=w(u,2),T=p(b),M=p(T),A=p(M);Ss(A,{});var C=w(M,2),P=p(C);qa(P,{});var x=w(C,2),L=p(x);_s(L,{});var N=w(x,2),O=p(N),H=w(p(O),2),U=p(H);ya(U,{});var ie=w(U,2);Ma(ie,{});var te=w(ie,2);Oa(te,{});var S=w(N,2),q=p(S);Ha(q,{});var J=w(S,2);{var le=ee=>{var V=qs(),Q=w(p(V),2),W=w(p(Q),2),R=p(W),K=w(Q,2),se=w(p(K),2),ue=p(se),be=w(K,2);{var we=me=>{var X=Ys(),ae=w(p(X),2),_=p(ae);Z(()=>Y(_,Se.timeGrid.microbeatCount)),k(me,X)};$(be,me=>{Se.timeGrid&&me(we)})}Z(()=>{Y(R,Se.voices.length),Y(ue,`${Se.tempo??""} BPM`)}),k(ee,V)};$(J,ee=>{t(r)&&ee(le)})}var _e=w(T,2),Pe=p(_e);ia(Pe,{});var Ce=w(b,2);Fs(Ce,{onRetry:a}),rn("open","toggle",O,ee=>E(i,ee),()=>t(i)),k(e,g),ye()}Te(["click"]);function Xs(e){const n=zn(Vs,{target:e});return{destroy:()=>{Kn(n)}}}const $t=document.getElementById("app");$t&&Xs($t);
