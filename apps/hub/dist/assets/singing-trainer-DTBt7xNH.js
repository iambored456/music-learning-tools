import"./modulepreload-polyfill-B5Qt9EMX.js";import{T as Nt,o as Cn,V as on,r as Pn,a5 as Ft,h as Wt,j as Sn,a6 as dt,b as In,$ as an,a0 as nt,a1 as Te,z as Pt,t as rn,a7 as kt,a3 as An,a8 as Rn,a9 as Hn,aa as Dn,I as Lt,ab as Ke,k as xn,a2 as it,p as Et,v as Nn,ac as Fn,ad as Wn,C as kn,ae as Ln}from"./navigation-CMqlkYeU.js";import{q as ln,r as En,v as On,w as Bn,x as qn,y as We,z as zn,A as St,B as It,C as Xn,D as Gn,E as Vn,S as cn,F as Yn,G as Un,P as jn,g as n,H as Kn,I as Zn,k as Fe,n as W,J as Jn,K as Qn,L as $n,M as ei,N as ti,O as ni,Q as ii,R as si,T as oi,p as Me,l as Se,j as z,o as x,f as Z,c as C,s as I,a as K,i as _e,h as Ie,t as he,d as ke,U as ht,b as $,m as ai,u as ri,V as li,W as un}from"./disclose-version-RGKqKYhl.js";import{e as st,s as Ot,i as At}from"./style-BdxRwvDC.js";function Rt(e,t,i=!1){if(e.multiple){if(t==null)return;if(!En(t))return On();for(var s of e.options)s.selected=t.includes(Bt(s));return}for(s of e.options){var a=Bt(s);if(Bn(a,t)){s.selected=!0;return}}(!i||t!==void 0)&&(e.selectedIndex=-1)}function dn(e){var t=new MutationObserver(()=>{Rt(e,e.__value)});t.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),ln(()=>{t.disconnect()})}function Bt(e){return"__value"in e?e.__value:e.value}function ft(e,t,i=t){var s=new WeakSet;qn(e,"input",async a=>{var o=a?e.defaultValue:e.value;if(o=gt(e)?mt(o):o,i(o),We!==null&&s.add(We),await zn(),o!==(o=t())){var r=e.selectionStart,l=e.selectionEnd,c=e.value.length;if(e.value=o??"",l!==null){var u=e.value.length;r===l&&l===c&&u>c?(e.selectionStart=u,e.selectionEnd=u):(e.selectionStart=r,e.selectionEnd=Math.min(l,u))}}}),St(t)==null&&e.value&&(i(gt(e)?mt(e.value):e.value),We!==null&&s.add(We)),It(()=>{var a=t();if(e===document.activeElement){var o=Xn??We;if(s.has(o))return}gt(e)&&a===mt(e.value)||e.type==="date"&&!a&&!e.value||a!==e.value&&(e.value=a??"")})}function gt(e){var t=e.type;return t==="number"||t==="range"}function mt(e){return e===""?null:+e}function qt(e,t){return e===t||e?.[cn]===t}function Ae(e={},t,i,s){return Gn(()=>{var a,o;return It(()=>{a=o,o=[],St(()=>{e!==i(...o)&&(t(e,...o),a&&qt(i(...a),e)&&t(null,...a))})}),()=>{Vn(()=>{o&&qt(i(...o),e)&&t(null,...o)})}}),e}function hn(e,t,i,s,a){var o=()=>{s(i[e])};i.addEventListener(t,o),a?It(()=>{i[e]=a()}):o(),(i===document.body||i===window||i===document)&&ln(()=>{i.removeEventListener(t,o)})}let Ze=!1;function ci(e){var t=Ze;try{return Ze=!1,[e(),Ze]}finally{Ze=t}}function ue(e,t,i,s){var a=!ti||(i&ni)!==0,o=(i&ei)!==0,r=(i&si)!==0,l=s,c=!0,u=()=>(c&&(c=!1,l=r?St(s):s),l),g;if(o){var h=cn in e||oi in e;g=Yn(e,t)?.set??(h&&t in e?_=>e[t]=_:void 0)}var d,p=!1;o?[d,p]=ci(()=>e[t]):d=e[t],d===void 0&&s!==void 0&&(d=u(),g&&(a&&Un(),g(d)));var m;if(a?m=()=>{var _=e[t];return _===void 0?u():(c=!0,_)}:m=()=>{var _=e[t];return _!==void 0&&(l=void 0),_===void 0?l:_},a&&(i&jn)===0)return m;if(g){var f=e.$$legacy;return(function(_,A){return arguments.length>0?((!a||!A||f||p)&&g(A?m():_),_):m()})}var v=!1,y=((i&ii)!==0?Kn:Zn)(()=>(v=!1,m()));o&&n(y);var b=Qn;return(function(_,A){if(arguments.length>0){const T=A?n(y):a&&o?Fe(_):_;return W(y,T),v=!0,l!==void 0&&(l=T),_}return Jn&&v||(b.f&$n)!==0?y.v:n(y)})}class Be extends Nt{constructor(){const t=Cn(Be.getDefaults(),arguments,["volume"]);super(t),this.name="UserMedia",this._volume=this.output=new on({context:this.context,volume:t.volume}),this.volume=this._volume.volume,Pn(this,"volume"),this.mute=t.mute}static getDefaults(){return Object.assign(Nt.getDefaults(),{mute:!1,volume:0})}open(t){return Ft(this,void 0,void 0,function*(){Wt(Be.supported,"UserMedia is not supported"),this.state==="started"&&this.close();const i=yield Be.enumerateDevices();Sn(t)?this._device=i[t]:(this._device=i.find(o=>o.label===t||o.deviceId===t),!this._device&&i.length>0&&(this._device=i[0]),Wt(dt(this._device),`No matching device ${t}`));const s={audio:{echoCancellation:!1,sampleRate:this.context.sampleRate,noiseSuppression:!1,mozNoiseSuppression:!1}};this._device&&(s.audio.deviceId=this._device.deviceId);const a=yield navigator.mediaDevices.getUserMedia(s);if(!this._stream){this._stream=a;const o=this.context.createMediaStreamSource(a);In(o,this.output),this._mediaStream=o}return this})}close(){return this._stream&&this._mediaStream&&(this._stream.getAudioTracks().forEach(t=>{t.stop()}),this._stream=void 0,this._mediaStream.disconnect(),this._mediaStream=void 0),this._device=void 0,this}static enumerateDevices(){return Ft(this,void 0,void 0,function*(){return(yield navigator.mediaDevices.enumerateDevices()).filter(i=>i.kind==="audioinput")})}get state(){return this._stream&&this._stream.active?"started":"stopped"}get deviceId(){if(this._device)return this._device.deviceId}get groupId(){if(this._device)return this._device.groupId}get label(){if(this._device)return this._device.label}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}dispose(){return super.dispose(),this.close(),this._volume.dispose(),this.volume.dispose(),this}static get supported(){return dt(navigator.mediaDevices)&&dt(navigator.mediaDevices.getUserMedia)}}const zt=["#ef8aab","#f48e7d","#e89955","#cdaa42","#a4ba57","#6ec482","#2dc8b1","#16c3da","#58b8f6","#8fa9ff","#ba9bf2","#db8fd4"];function Xt(e){const t=parseInt(e.slice(1),16);return[t>>16&255,t>>8&255,t&255]}function ui(e,t,i){const s=Math.max(0,Math.min(1,i));return e.map((a,o)=>Math.round(a+s*(t[o]-a)))}function fn(e,t=0){const i=Math.floor(e),s=e-i,a=(i%12-t+12)%12,o=(a+1)%12,r=Xt(zt[a]),l=Xt(zt[o]);return ui(r,l,s)}const di={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11};function hi(e){const t=e.replace(/\d+$/,"");return di[t]??0}const vt={onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70,accuracyTiers:{perfect:{onsetMs:30,pitchCents:10,coverage:95},good:{onsetMs:75,pitchCents:25,coverage:85},okay:{onsetMs:150,pitchCents:50,coverage:70}}};function fi(e={}){const t={...vt,...e,accuracyTiers:e.accuracyTiers?{...vt.accuracyTiers,...e.accuracyTiers}:vt.accuracyTiers},i=new Map,s=new Map;function a(h,d){return(h-d)*100}function o(h,d){return Math.abs(a(h.midi,d))<=t.pitchToleranceCents}function r(h,d){return h.length===0?0:h.reduce((m,f)=>m+Math.abs(a(f.midi,d)),0)/h.length}function l(h,d,p,m){if(h.length===0)return 0;const f=h.filter(y=>o(y,d));if(f.length===0)return 0;let v=0;for(let y=0;y<f.length;y++){const b=f[y],_=f[y+1];if(_)v+=_.timeMs-b.timeMs;else{const A=p+m,T=Math.min(50,A-b.timeMs);v+=T}}return v/m*100}function c(h,d,p){const m=t.accuracyTiers;if(!m)return"okay";const f=Math.abs(h);return f<=m.perfect.onsetMs&&d<=m.perfect.pitchCents&&p>=m.perfect.coverage?"perfect":f<=m.good.onsetMs&&d<=m.good.pitchCents&&p>=m.good.coverage?"good":f<=m.okay.onsetMs&&d<=m.okay.pitchCents&&p>=m.okay.coverage?"okay":"miss"}function u(h){const{note:d,samples:p,onsetSample:m,releaseSample:f}=h;let v=0;m?v=m.timeMs-d.startTimeMs:v=t.onsetToleranceMs*2;let y=0;const b=d.startTimeMs+d.durationMs;f?y=f.timeMs-b:y=t.releaseToleranceMs*2;const _=r(p,d.midi),A=l(p,d.midi,d.startTimeMs,d.durationMs),T=Math.abs(v)<=t.onsetToleranceMs,w=Math.abs(y)<=t.releaseToleranceMs,P=A>=t.hitThreshold,D=T&&w&&P?"hit":"miss",N=c(v,_,A);return{hitStatus:D,onsetAccuracyMs:v,releaseAccuracyMs:y,pitchAccuracyCents:_,pitchCoverage:A,pitchSamples:[...p],accuracyTier:N}}return{startNote(h,d){i.set(h,{note:d,samples:[],onsetSample:null,releaseSample:null,startedAt:performance.now()})},recordPitchSample(h){for(const[d,p]of i){const{note:m}=p,f=m.startTimeMs+m.durationMs,v=t.onsetToleranceMs,y=t.releaseToleranceMs;h.timeMs>=m.startTimeMs-v&&h.timeMs<=f+y&&(p.samples.push(h),!p.onsetSample&&h.timeMs>=m.startTimeMs-v&&h.timeMs<=m.startTimeMs+v&&o(h,m.midi)&&(p.onsetSample=h),h.timeMs>=f-y&&h.timeMs<=f+y&&(p.releaseSample=h))}},endNote(h){const d=i.get(h);if(!d)return null;const p=u(d);return s.set(h,p),i.delete(h),p},getCurrentPerformance(h){const d=i.get(h);if(!d)return null;const{note:p,samples:m,onsetSample:f}=d;let v=0;f&&(v=f.timeMs-p.startTimeMs);const y=r(m,p.midi),b=l(m,p.midi,p.startTimeMs,p.durationMs);return{onsetAccuracyMs:v,pitchAccuracyCents:y,pitchCoverage:b,pitchSamples:[...m]}},getAllPerformances(){return new Map(s)},reset(){i.clear(),s.clear()},dispose(){i.clear(),s.clear()}}}const Gt={judgmentLinePosition:.12,pixelsPerSecond:200,lookAheadMs:3e3,scrollMode:"constant-speed",leadInBeats:4,playMetronomeDuringOnramp:!0,playTargetNotes:!0,playMetronome:!1,inputSources:["microphone"],feedbackConfig:{onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70}};function gi(e){const t={...Gt,...e,feedbackConfig:{...Gt.feedbackConfig,...e.feedbackConfig}},{stateCallbacks:i,eventCallbacks:s,visualCallbacks:a,logger:o}=t,r={isPlaying:!1,isPaused:!1,currentTimeMs:0,scrollOffset:0,onrampComplete:!1,targetNotes:[],activeNotes:new Set,startTime:null},l=fi(t.feedbackConfig);let c=null;const u=new Set;function g(){const w=60/i.getTempo()*1e3;return t.leadInBeats*w}function h(){return i.getViewportWidth()*t.judgmentLinePosition}function d(T){const w=t.pixelsPerSecond/1e3,P=h(),D=g();return(T+D)*w-P}function p(T){const w=h(),P=i.getCellWidth(),D=T.startColumn*P-r.scrollOffset,N=T.endColumn*P-r.scrollOffset,X=t.feedbackConfig.onsetToleranceMs/1e3*t.pixelsPerSecond;return D<=w+X&&N>=w-X}function m(){const T=new Set;for(const w of r.targetNotes){const P=w.startTimeMs+w.durationMs,D=t.feedbackConfig.onsetToleranceMs;if(r.currentTimeMs>=w.startTimeMs-D&&r.currentTimeMs<=P+D)T.add(w.id),r.activeNotes.has(w.id)||(l.startNote(w.id,w),o?.debug("NoteHighway",`Note ${w.id} became active`,{note:w}));else if(r.activeNotes.has(w.id)){const N=l.endNote(w.id);if(N){w.performance=N;const R={noteId:w.id,note:w,performance:N};N.hitStatus==="hit"?(s.emit("noteHit",R),a?.onNoteHit?.(w.id,N.accuracyTier||"okay"),o?.info("NoteHighway",`Note hit: ${w.id}`,N)):(s.emit("noteMissed",R),a?.onNoteMiss?.(w.id),o?.info("NoteHighway",`Note missed: ${w.id}`,N))}}}r.activeNotes=T}function f(){for(const T of r.targetNotes){const w=p(T),P=u.has(T.id);w&&!P?(u.add(T.id),s.emit("noteEntered",{noteId:T.id,note:T})):!w&&P&&(u.delete(T.id),s.emit("noteExited",{noteId:T.id,note:T}))}}function v(){if(!r.onrampComplete)if(r.currentTimeMs>=0)r.onrampComplete=!0,s.emit("onrampComplete"),a?.clearOnrampCountdown?.(),o?.info("NoteHighway","Onramp complete",null);else{const w=60/i.getTempo()*1e3,P=Math.abs(r.currentTimeMs),D=Math.ceil(P/w);a?.updateOnrampCountdown?.(D)}}function y(){if(!r.isPlaying||r.isPaused||!r.startTime){c=null;return}const T=performance.now(),w=g();r.currentTimeMs=T-r.startTime-w,r.scrollOffset=d(r.currentTimeMs),v(),m(),f(),c=requestAnimationFrame(y)}function b(){c||(c=requestAnimationFrame(y))}function _(){c&&(cancelAnimationFrame(c),c=null)}return{init(T){r.targetNotes=T,o?.info("NoteHighway",`Initialized with ${T.length} notes`,null)},start(){r.isPlaying||(r.isPlaying=!0,r.isPaused=!1,r.currentTimeMs=-g(),r.scrollOffset=d(r.currentTimeMs),r.onrampComplete=!1,r.activeNotes.clear(),r.startTime=performance.now(),u.clear(),l.reset(),b(),s.emit("playbackStarted"),o?.info("NoteHighway","Playback started",{onrampDurationMs:g()}))},pause(){!r.isPlaying||r.isPaused||(r.isPaused=!0,_(),s.emit("playbackPaused"),o?.info("NoteHighway","Playback paused",{currentTimeMs:r.currentTimeMs}))},resume(){if(!r.isPlaying||!r.isPaused||!r.startTime)return;const T=performance.now()-(r.startTime+r.currentTimeMs+g());r.startTime+=T,r.isPaused=!1,b(),s.emit("playbackResumed"),o?.info("NoteHighway","Playback resumed",null)},stop(){if(!r.isPlaying)return;r.isPlaying=!1,r.isPaused=!1,r.currentTimeMs=0,r.scrollOffset=0,r.onrampComplete=!1,r.activeNotes.clear(),r.startTime=null,u.clear(),_(),a?.clearCanvas?.(),a?.clearOnrampCountdown?.(),s.emit("playbackStopped"),r.targetNotes.every(w=>w.performance!==void 0)&&s.emit("performanceComplete"),o?.info("NoteHighway","Playback stopped",null)},setScrollOffset(T){if(r.currentTimeMs=T,r.scrollOffset=d(T),r.isPlaying){const w=g();r.startTime=performance.now()-(T+w)}o?.debug("NoteHighway","Scroll offset set",{timeMs:T,scrollOffset:r.scrollOffset})},recordPitchInput(T,w,P){if(!r.isPlaying||r.isPaused||!t.inputSources.includes(P))return;const D={timeMs:r.currentTimeMs,midi:T,clarity:w,source:P};l.recordPitchSample(D)},getState(){return r},getVisibleNotes(){h();const T=i.getViewportWidth(),w=i.getCellWidth();return r.targetNotes.filter(P=>{const D=P.startColumn*w-r.scrollOffset;return P.endColumn*w-r.scrollOffset>=0&&D<=T})},getPerformanceResults(){return l.getAllPerformances()},getFeedbackCollector(){return l},dispose(){_(),l.dispose(),r.targetNotes=[],r.activeNotes.clear(),u.clear(),o?.info("NoteHighway","Service disposed",null)}}}function mi(e){const{cellHeight:t,columnWidths:i,viewport:s}=e,a=t/2,o=vi(i,e.cellWidth);return{getRowY(r){return(r-s.startRow+1)*a},getRowFromY(r){const l=r/a-1;return Math.round(l)+s.startRow},getColumnX(r){return r<0?0:r>=o.length?o[o.length-1]??0:o[r]??0},getColumnFromX(r){let l=0,c=o.length-1;for(;l<c;){const u=Math.floor((l+c)/2);(o[u]??0)<=r?l=u+1:c=u}return Math.max(0,l-1)}}}function gn(e){const{cellHeight:t,viewport:i,pixelsPerSecond:s,nowLineX:a=100,currentTimeMs:o=0}=e,r=t/2;return{getRowY(l){return(l-i.startRow+1)*r},getRowFromY(l){const c=l/r-1;return Math.round(c)+i.startRow},getColumnX(l){return 0},getColumnFromX(l){return 0},getTimeX(l){const c=l-o;return a+c/1e3*s},getTimeFromX(l){const c=(l-a)/s*1e3;return o+c}}}function vi(e,t){const i=[0];let s=0;for(let a=0;a<e.length;a++){const o=(e[a]??1)*t;s+=o,i.push(s)}return i}function pi(e,t){const{startRow:i,endRow:s}=e,a=Math.max(0,t.length-1);return{startRow:i,endRow:s,paddedStartRow:Math.max(0,i-1),paddedEndRow:Math.min(a,s+1)}}function pt(e,t,i,s){const a=s.getRowY(e),o=i;return a>=-o&&a<=t.containerHeight+o}function yi(e){let t=(e||"").replace(/\d/g,"").trim();return t=t.replace(/b/g,"b-").replace(/#/g,"b_"),t}function wi(e){switch(e){case"C":return{lineWidth:3.33,dash:[],color:"#adb5bd"};case"E":return{lineWidth:1,dash:[5,5],color:"#adb5bd"};case"G":return{lineWidth:1,dash:[],color:"#dee2e6"};case"B":case"A":case"F":case"Eb/Db":case"Db/C#":return{lineWidth:1,dash:[],color:"#ced4da"};default:return{lineWidth:1,dash:[],color:"#ced4da"}}}const Je={stroke:"#c7cfd8",background:"rgba(207, 214, 222, 0.32)"};let Le=null;function bi(){if(Le)return Le;if(typeof window>"u")return Je;try{const e=window.getComputedStyle(document.documentElement);Le={stroke:e.getPropertyValue("--c-anacrusis-border").trim()||Je.stroke,background:e.getPropertyValue("--c-anacrusis-bg").trim()||Je.background}}catch{Le=Je}return Le}function Mi(e,t,i,s,a,o=0,r){const{fullRowData:l,viewportHeight:c,viewportWidth:u,cellHeight:g}=t,h=u,d=["B","A","F","E♭/D♯","D♭/C♯"];for(let p=s;p<=a;p++){const m=l[p];if(!m||m.isBoundary)continue;const f=i.getRowY(p);if(f<-10||f>c+10)continue;const v=yi(m.pitch);if(d.includes(v))continue;const y=wi(v);v==="G"?(e.save(),e.fillStyle=y.color,e.fillRect(o,f-g/2,h-o,g),e.restore()):(e.beginPath(),e.moveTo(o,f),e.lineTo(h,f),e.lineWidth=y.lineWidth,e.strokeStyle=y.color,e.setLineDash(y.dash),e.stroke(),e.setLineDash([]))}}function _i(e,t,i,s){const{columnWidths:a,viewportHeight:o,macrobeatBoundaryStyles:r,placedTonicSigns:l}=t,c=a.length;for(let u=0;u<=c;u++){const g=u===0||u===c,h=Ci(u,l),d=l.some(y=>u===y.columnIndex+2),p=s.includes(u);if(!Pi(u,l))continue;let f=null;if(g||h||d)f={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(p){const y=s.indexOf(u),b=r[y]??"dashed";if(b==="anacrusis"){const{stroke:_}=bi();f={lineWidth:1,strokeStyle:_,dash:[4,4]}}else f={lineWidth:1,strokeStyle:"#adb5bd",dash:b==="solid"?[]:[5,5]}}if(!f)continue;const v=i.getColumnX(u);e.beginPath(),e.moveTo(v,0),e.lineTo(v,o),e.lineWidth=f.lineWidth,e.strokeStyle=f.strokeStyle,e.setLineDash(f.dash),e.stroke()}e.setLineDash([])}function Ti(e,t,i){const{viewportHeight:s,beatIntervalMs:a,measureIntervalMs:o,visibleTimeRange:r,nowLineX:l,beatTimeOffsetMs:c=0}=t,u=r.startMs-c,g=r.endMs-c,h=Math.floor(u/a),d=Math.ceil(g/a);for(let p=h;p<=d;p++){const m=c+p*a,f=i.getTimeX?.(m);if(f===void 0)continue;const v=o?(m-c)%o===0:!1;e.beginPath(),e.moveTo(f,0),e.lineTo(f,s),e.lineWidth=v?2:1,e.strokeStyle=v?"#adb5bd":"#dee2e6",e.setLineDash(v?[]:[5,5]),e.stroke()}e.setLineDash([]),l!==void 0&&(e.beginPath(),e.moveTo(l,0),e.lineTo(l,s),e.lineWidth=3,e.strokeStyle="#00ff00",e.setLineDash([]),e.stroke())}function Ci(e,t){return t.some(i=>i.columnIndex===e)}function Pi(e,t){return!t.some(i=>i.columnIndex+1===e)}const Si=.7,Ii=.9,Ai=4,Ri=1,Hi=.15,Di=.2,xi=1,Ht=1.5;function qe(e,t){return Number.isFinite(e)&&e>0&&Number.isFinite(t)&&t>0}function mn(e){if(!e||typeof e.startColumnIndex!="number"||typeof e.endColumnIndex!="number")return!1;const t=e.shape==="circle"?e.startColumnIndex+1:e.startColumnIndex;return e.endColumnIndex>t}function Qe(e){const t=e?.split("-")[1];return Number.parseInt(t??"0",10)}function vn(e,t,i){const s=i*.25,a=e.uuid;if(!a)return 0;const o=t.filter(c=>!c.isDrum&&c.row===e.row&&c.startColumnIndex===e.startColumnIndex&&c.uuid&&c.uuid!==a);if(o.length===0)return 0;const r=[e,...o];return r.sort((c,u)=>Qe(c.uuid)-Qe(u.uuid)),r.findIndex(c=>c.uuid===a)*s}function Ni(e,t,i){const s=i/2*.12,a=e.uuid;if(!a)return 0;const o=t.filter(c=>!c.isDrum&&c.row===e.row&&c.startColumnIndex===e.startColumnIndex&&c.uuid&&c.uuid!==a&&mn(c));if(o.length===0)return 0;const r=[e,...o];return r.sort((c,u)=>Qe(c.uuid)-Qe(u.uuid)),r.findIndex(c=>c.uuid===a)*s}function Fi(e){if(!e)return{multiplier:1,category:"natural"};const t=e.includes("♭"),i=e.includes("♯"),s=e.includes("/");return!t&&!i?{multiplier:1,category:"natural"}:s?{multiplier:.75,category:"both-accidentals"}:{multiplier:.88,category:"single-accidental"}}function Mt(e,t,i,s,a,o){const{multiplier:r,category:l}=Fi(t);let c;if(i==="circle"){const u=o*2*Ii;switch(l){case"natural":c=u;break;case"single-accidental":c=u*.8;break;case"both-accidentals":c=u*.4;break;default:c=u*r}}else{const u=o*2*Si;switch(l){case"natural":c=u*1.5;break;case"single-accidental":c=u*1.2;break;case"both-accidentals":c=u;break;default:c=u*r}}if(!(c<Ai))if(e.fillStyle="#212529",e.font=`bold ${c}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle",i==="oval"&&l==="both-accidentals"&&t.includes("/")){const u=t.split("/"),g=c*1.1,h=g*(u.length-1),d=a-h/2;u.forEach((p,m)=>{const f=d+m*g,v=c*.08;e.fillText(p.trim(),s,f+v)})}else{const u=c*.08;e.fillText(t,s,a+u)}}function Wi(e,t,i,s,a,o,r){e.save(),e.beginPath(),e.arc(i,a,o,Math.PI/2,-Math.PI/2,!1),e.lineTo(s,a-o),e.arc(s,a,o,-Math.PI/2,Math.PI/2,!1),e.lineTo(i,a+o),e.closePath(),e.strokeStyle=t.color,e.lineWidth=r,e.shadowColor=t.color,e.shadowBlur=Ht,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore()}function Vt(e,t,i,s){const{config:a,coords:o,allNotes:r,getScaleDegreeLabel:l}=t,{cellWidth:c,cellHeight:u,columnWidths:g,degreeDisplayMode:h}=a,d=o.getRowY(s),p=o.getColumnX(i.startColumnIndex),f=(g[i.startColumnIndex]??1)*c;if(!qe(f,u))return;const v=vn(i,r,c),y=Math.max(.5,f*.15),b=p+f/2+v,_=f/2-y/2,A=u/2-y/2;if(qe(_,A)&&(e.save(),e.beginPath(),e.ellipse(b,d,_,A,0,0,2*Math.PI),e.strokeStyle=i.color,e.lineWidth=y,e.shadowColor=i.color,e.shadowBlur=Ht,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore(),h!=="off"&&l)){const{label:T}=l(i);T&&Mt(e,T,"oval",b,d,_)}}function Yt(e,t,i,s){const{config:a,coords:o,allNotes:r,getScaleDegreeLabel:l}=t,{cellWidth:c,cellHeight:u,degreeDisplayMode:g,longNoteStyle:h}=a,d=o.getRowY(s),p=o.getColumnX(i.startColumnIndex),f=o.getColumnX(i.startColumnIndex+1)-p;if(!qe(f,u))return;const v=vn(i,r,c),y=p+f+v,b=Math.max(Ri,f*Hi),_=u/2-b/2,A=mn(i);if(A&&h==="style2"){const w=y,P=o.getColumnX(i.endColumnIndex);if(qe(P-w,_)&&(Wi(e,i,w,P,d,_,b),g!=="off"&&l)){const{label:D}=l(i);if(D){const N=(w+P)/2;Mt(e,D,"circle",N,d,_)}}return}if(A){const w=o.getColumnX(i.endColumnIndex+1),P=Ni(i,r,u),D=d+P;e.beginPath(),e.moveTo(y,D),e.lineTo(w,D),e.strokeStyle=i.color,e.lineWidth=Math.max(xi,f*Di),e.stroke()}const T=f-b/2;if(qe(T,_)&&(e.save(),e.beginPath(),e.ellipse(y,d,T,_,0,0,2*Math.PI),e.strokeStyle=i.color,e.lineWidth=b,e.shadowColor=i.color,e.shadowBlur=Ht,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore(),g!=="off"&&l)){const{label:w}=l(i);w&&Mt(e,w,"circle",y,d,T)}}function ki(e,t,i){const{config:s,coords:a}=t,{cellWidth:o,cellHeight:r}=s,l=a.getRowY(i.globalRow??i.row),c=a.getColumnX(i.columnIndex),g=a.getColumnX(i.columnIndex+1)-c,h=g*2,d=c+h/2,p=Math.min(h,r)/2*.9;if(p<2||(e.beginPath(),e.arc(d,l,p,0,2*Math.PI),e.strokeStyle="#212529",e.lineWidth=Math.max(.5,g*.05),e.stroke(),i.tonicNumber==null))return;const m=i.tonicNumber.toString(),f=p*1.5;f<6||(e.fillStyle="#212529",e.font=`bold ${f}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(m,d,l))}const Li={timeWindowMs:4e3,pixelsPerSecond:200,circleRadius:9.5,proximityThreshold:35,maxConnections:3,connectorLineWidth:2.5,connectorColor:"rgba(0,0,0,0.4)",useTonicRelativeColors:!0,tonicPitchClass:0,clarityThreshold:.5,maxOpacity:.9};function pn(e){return{...Li,...e}}function Ut(e,t,i,s,a,o,r){const l=pn(o.trailConfig);if(s<l.clarityThreshold||i<=0)return;const{cellHeight:c,colorMode:u}=o,g=yn(t,i,c,r),h=c/2*.8,d=u==="bw"?[128,128,128]:fn(i,l.tonicPitchClass);e.save(),e.beginPath(),e.arc(a,g,h+4,0,2*Math.PI),e.fillStyle=`rgba(${d[0]}, ${d[1]}, ${d[2]}, ${s*.3})`,e.fill(),e.beginPath(),e.arc(a,g,h,0,2*Math.PI),e.fillStyle=`rgba(${d[0]}, ${d[1]}, ${d[2]}, ${s})`,e.fill(),e.restore()}function yn(e,t,i,s){if(s.length===0||!s[0])return 0;const a=Math.floor(t),o=t-a,c=(s[0].midi??108)-a;if(c<0||c>=s.length)return c<0?0:e.getRowY(s.length-1);const u=e.getRowY(c),g=i/2;return u-o*g}function wn(e,t,i,s,a,o){const{viewportWidth:r,cellHeight:l,colorMode:c}=a,u=pn(a.trailConfig),g=u.timeWindowMs,h=u.pixelsPerSecond,d=a.nowLineX??r,p=i.filter(m=>m.midi>0&&m.clarity>=u.clarityThreshold).map(m=>{const f=s-m.time;if(f>=g||f<0)return null;const v=d-f/1e3*h,y=yn(t,m.midi,l,o),b=c==="bw"?[128,128,128]:fn(m.midi,u.tonicPitchClass);return{x:v,y,clarity:m.clarity,color:b}}).filter(m=>m!==null&&m.x>=0);if(p.length!==0){e.save(),e.strokeStyle=u.connectorColor,e.lineWidth=u.connectorLineWidth,e.beginPath();for(let m=0;m<p.length;m++){let f=0;for(let v=m+1;v<p.length&&f<u.maxConnections;v++){const y=p[m].x-p[v].x,b=p[m].y-p[v].y;Math.sqrt(y*y+b*b)<=u.proximityThreshold&&(e.moveTo(p[m].x,p[m].y),e.lineTo(p[v].x,p[v].y),f++)}}e.stroke();for(const m of p){const f=Math.min(m.clarity*u.maxOpacity,1);e.fillStyle=`rgba(${m.color[0]}, ${m.color[1]}, ${m.color[2]}, ${f})`,e.beginPath(),e.arc(m.x,m.y,u.circleRadius,0,2*Math.PI),e.fill()}e.restore()}}function jt(e,t,i,s,a,o,r,l){const{cellHeight:c,nowLineX:u=100,pixelsPerSecond:g}=a,h=.5;for(const d of i){const p=(u??100)+(d.startTimeMs-s)/1e3*g,m=p+d.durationMs/1e3*g;if(m<0||p>a.viewportWidth)continue;let f;if(o){if(f=o.findIndex(w=>w.midi===d.midi),f===-1)continue}else f=Math.round(108-d.midi);const v=t.getRowY(f),y=c/2-2,b=d.color??"#4CAF50",_=p<=u&&m>=u,A=r!=null&&(l??0)>.5&&Math.abs(r-d.midi)<=h,T=_&&A;if(e.save(),e.beginPath(),e.arc(p,v,y,Math.PI/2,-Math.PI/2,!1),e.lineTo(m,v-y),e.arc(m,v,y,-Math.PI/2,Math.PI/2,!1),e.lineTo(p,v+y),e.closePath(),T?(e.strokeStyle="#FFD700",e.lineWidth=5,e.shadowColor="#FFD700",e.shadowBlur=20,e.stroke(),e.fillStyle="rgba(255, 215, 0, 0.3)",e.fill(),Ei(e,u,v,y)):(e.strokeStyle=b,e.lineWidth=3,e.shadowColor=b,e.shadowBlur=8,e.stroke()),e.shadowBlur=0,e.restore(),d.label){const w=p+y+4;e.fillStyle=T?"#FFD700":"#212529",e.font=`bold ${Math.max(16,y*1.2)}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="left",e.textBaseline="middle",e.fillText(d.label,w,v)}}}function Ei(e,t,i,s){const r=s*1.5;e.save(),e.fillStyle="#FFD700",e.shadowColor="#FFD700",e.shadowBlur=6;for(let l=0;l<8;l++){const c=l/8*Math.PI*2,u=t+Math.cos(c)*r,g=i+Math.sin(c)*r;e.beginPath(),e.arc(u,g,3,0,Math.PI*2),e.fill()}e.restore()}function Oi(e){const t=e.replace(/\d+$/,"");return t.length>0?t:e}function bn(e,t){return!Number.isFinite(t)||t<=0?e:Math.round(e*t)/t}function Bi(e,t,i,s){const a=Math.max(10,Math.min(e*1.2,t*1.2)),o=i<=3?1:.7,r=s<=1?1.08:1;return bn(a*o*r,s)}function qi(e){const t=e.getContext("2d");return t&&(t.getTransform().a||window.devicePixelRatio)||1}function zi(e){if(typeof e.midi=="number")return e.midi%12;if(typeof e.pitchClass=="number")return e.pitchClass;const t={C:0,D:2,E:4,F:5,G:7,A:9,B:11},i=e.pitch.charAt(0).toUpperCase();let s=t[i]??0;return(e.pitch.includes("#")||e.pitch.includes("♯"))&&s++,(e.pitch.includes("b")||e.pitch.includes("♭"))&&s--,(s%12+12)%12}function Xi(e,t){const{showFrequencyLabels:i,showOctaveLabels:s,accidentalMode:a}=t,o=h=>s?h:Oi(h);if(i)return String(Math.round(e.frequency));const{flatName:r,sharpName:l,isAccidental:c}=e,{sharp:u,flat:g}=a;return c?u&&g?o(e.pitch):u&&!g?o(l):g&&!u?o(r):null:o(r)}function Kt(e,t,i,s){const{fullRowData:a,cellWidth:o,cellHeight:r,legendColumnWidth:l,colorMode:c,accidentalMode:u}=t,{startRow:g,endRow:h,coords:d}=i,p=qi(e.canvas),m=y=>bn(y,p),f=l;let v=0;for(const y of s){for(let b=g;b<=h;b++){const _=a[b];if(!_||_.isBoundary||_.column!==y)continue;const A=d.getRowY(b),T=!u.sharp&&!u.flat,w=_.isAccidental&&T,P=Xi(_,t);if(P===null)continue;let D=c==="bw"?"#ffffff":_.hex||"#ffffff",N="FF";w&&(N="00"),e.fillStyle=w?"rgba(255,255,255,0)":D,e.fillRect(v,A-r/2,f,r),t.highlight&&typeof t.highlight.pitchClass=="number"&&t.highlight.opacity>.01&&zi(_)===t.highlight.pitchClass&&(e.save(),e.globalAlpha=Math.min(Math.max(t.highlight.opacity,0),1),e.fillStyle=t.highlight.color??"#ffff00",e.fillRect(v,A-r/2,f,r),e.restore());const R=Bi(o,r,P.length,p);e.font=`bold ${R}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle";const X=m(v+f/2),Y=m(A);e.strokeStyle=`#212529${N}`,e.lineWidth=Math.max(1.2,2.5/p),e.lineJoin="round",e.strokeText(P,X,Y),e.fillStyle=`#ffffff${N}`,e.fillText(P,X,Y)}v+=f}}function Gi(e,t,i,s){e&&(e.clearRect(0,0,e.canvas.width,e.canvas.height),Kt(e,i,s,["B","A"])),t&&(t.clearRect(0,0,t.canvas.width,t.canvas.height),Kt(t,i,s,["A","B"]))}var Vi=Z('<canvas class="pitch-grid-legend pitch-grid-legend--left svelte-ui3s88"></canvas>'),Yi=Z('<canvas class="pitch-grid-legend pitch-grid-legend--right svelte-ui3s88"></canvas>'),Ui=Z('<div class="pitch-grid-container svelte-ui3s88"><!> <canvas class="pitch-grid-canvas svelte-ui3s88"></canvas> <!></div>');function ji(e,t){Me(t,!0);let i=ue(t,"colorMode",3,"color"),s=ue(t,"degreeDisplayMode",3,"off"),a=ue(t,"accidentalMode",19,()=>({sharp:!0,flat:!0})),o=ue(t,"showFrequencyLabels",3,!1),r=ue(t,"showOctaveLabels",3,!0),l=ue(t,"placedNotes",19,()=>[]),c=ue(t,"placedTonicSigns",19,()=>[]),u=ue(t,"columnWidths",19,()=>[]),g=ue(t,"macrobeatGroupings",19,()=>[]),h=ue(t,"macrobeatBoundaryStyles",19,()=>[]),d=ue(t,"longNoteStyle",3,"style1"),p=ue(t,"beatIntervalMs",3,500),m=ue(t,"beatTimeOffsetMs",3,0),f=z(void 0),v=z(void 0),y=z(void 0),b=z(null),_=z(null),A=z(null),T=z(null);const w=3,P=x(()=>t.cellWidth*w),D=x(()=>n(P)*2),N=x(()=>r()||o()?n(D)*2:0),R=x(()=>Math.max(0,t.viewport.containerWidth-n(N))),X=x(()=>t.mode==="notation"||t.mode==="playback"),Y=x(()=>t.mode==="singing"),J=x(()=>t.mode==="highway");function Q(){if(n(X))return mi({cellWidth:t.cellWidth,cellHeight:t.cellHeight,columnWidths:u(),viewport:t.viewport,modulationMarkers:t.modulationMarkers});{const M=n(J)?t.highwayConfig:t.singingConfig;return gn({cellWidth:t.cellWidth,cellHeight:t.cellHeight,viewport:t.viewport,pixelsPerSecond:M?.pixelsPerSecond??200,nowLineX:M?.nowLineX??100,currentTimeMs:M?.currentTimeMs??0})}}function S(){if(!n(b)||!n(f))return;const M=Q(),{paddedStartRow:k,paddedEndRow:E}=pi(t.viewport,t.fullRowData);n(b).clearRect(0,0,n(R),t.viewport.containerHeight);const le={fullRowData:t.fullRowData,cellHeight:t.cellHeight,viewportHeight:t.viewport.containerHeight,viewportWidth:n(R),colorMode:i()};Mi(n(b),le,M,k,E),n(X)?B(n(b),M):n(Y)?G(n(b),M):n(J)&&L(n(b),M),(r()||o())&&(n(_)||n(A))&&fe(M,k,E)}function B(M,k){const E=F(g()),le={columnWidths:u(),cellWidth:t.cellWidth,viewportHeight:t.viewport.containerHeight,macrobeatGroupings:g(),macrobeatBoundaryStyles:h(),placedTonicSigns:c()};_i(M,le,k,E);const ge=l().filter(V=>V.isDrum||V.globalRow===void 0?!1:pt(V.globalRow,t.viewport,t.cellHeight,k)),ve=c().filter(V=>V.globalRow===void 0?!1:pt(V.globalRow,t.viewport,t.cellHeight,k)),pe={config:{cellWidth:t.cellWidth,cellHeight:t.cellHeight,columnWidths:u(),degreeDisplayMode:s(),accidentalMode:a(),longNoteStyle:d(),colorMode:i()},coords:k,allNotes:l()};for(const V of ge)V.shape==="oval"?Vt(M,pe,V,V.globalRow):V.shape==="circle"&&Yt(M,pe,V,V.globalRow);for(const V of ve)ki(M,pe,V)}function G(M,k){if(!t.singingConfig)return;const E={cellHeight:t.cellHeight,viewportWidth:n(R),pixelsPerSecond:t.singingConfig.pixelsPerSecond??200,timeWindowMs:t.singingConfig.timeWindowMs??4e3,colorMode:i(),trailConfig:t.singingConfig.trailConfig};t.singingConfig.pitchHistory&&t.singingConfig.pitchHistory.length>0&&wn(M,k,t.singingConfig.pitchHistory,performance.now(),E,t.fullRowData),t.singingConfig.targetNotes&&t.singingConfig.targetNotes.length>0&&jt(M,k,t.singingConfig.targetNotes,performance.now(),E,t.fullRowData),t.singingConfig.userPitch&&t.singingConfig.userPitch.clarity>.5&&Ut(M,k,t.singingConfig.userPitch.midi,t.singingConfig.userPitch.clarity,n(R)-20,E,t.fullRowData)}function L(M,k){if(!t.highwayConfig)return;const E={cellHeight:t.cellHeight,viewportWidth:t.viewport.containerWidth,nowLineX:t.highwayConfig.nowLineX,pixelsPerSecond:t.highwayConfig.pixelsPerSecond??200,timeWindowMs:t.highwayConfig.timeWindowMs??4e3,colorMode:i(),trailConfig:t.highwayConfig.trailConfig};if(t.highwayConfig.scrollingGridData&&t.highwayConfig.scrollOffset!==void 0)ee(M,k);else{const ge={startMs:t.highwayConfig.currentTimeMs-1e3,endMs:t.highwayConfig.currentTimeMs+n(R)/(t.highwayConfig.pixelsPerSecond??200)*1e3},ve={viewportWidth:n(R),viewportHeight:t.viewport.containerHeight,beatIntervalMs:p(),visibleTimeRange:ge,nowLineX:t.highwayConfig.nowLineX,beatTimeOffsetMs:m()};Ti(M,ve,k),t.highwayConfig.targetNotes&&t.highwayConfig.targetNotes.length>0&&jt(M,k,t.highwayConfig.targetNotes,t.highwayConfig.currentTimeMs,E,t.fullRowData,t.highwayConfig.userPitch?.midi??null,t.highwayConfig.userPitch?.clarity??0)}ie(M,t.highwayConfig.nowLineX,t.viewport.containerHeight),t.highwayConfig.showOnrampCountdown&&t.highwayConfig.onrampBeatsRemaining!==void 0&&de(M,t.highwayConfig.onrampBeatsRemaining),t.highwayConfig.userPitch&&t.highwayConfig.userPitch.clarity>.5&&Ut(M,k,t.highwayConfig.userPitch.midi,t.highwayConfig.userPitch.clarity,t.highwayConfig.nowLineX,E,t.fullRowData)}function ee(M,k){if(!t.highwayConfig?.scrollingGridData||t.highwayConfig.scrollOffset===void 0)return;const E=t.highwayConfig.scrollingGridData,le=t.highwayConfig.scrollOffset,ge=F(E.macrobeatGroupings);for(let te=0;te<ge.length;te++){const V=ge[te]*t.cellWidth-le;if(V>=-t.cellWidth&&V<=n(R)+t.cellWidth){const Ce=E.macrobeatBoundaryStyles[te]||"solid",Pe=Ce==="solid"?2:1,He=Ce==="dashed"?[5,5]:[];M.strokeStyle="#495057",M.lineWidth=Pe,M.setLineDash(He),M.beginPath(),M.moveTo(V,0),M.lineTo(V,t.viewport.containerHeight),M.stroke(),M.setLineDash([])}}const ve={cellWidth:t.cellWidth,cellHeight:t.cellHeight,columnWidths:E.columnWidths,degreeDisplayMode:s(),accidentalMode:a(),longNoteStyle:d(),colorMode:i()};for(const te of E.placedNotes){if(te.isDrum||te.globalRow===void 0||!pt(te.globalRow,t.viewport,t.cellHeight,k))continue;const pe=te.startColumnIndex*t.cellWidth-le;if(te.endColumnIndex*t.cellWidth-le>=-t.cellWidth&&pe<=n(R)+t.cellWidth){const Ce={...k,getColumnX:He=>He*t.cellWidth-le},Pe={config:ve,coords:Ce,allNotes:E.placedNotes};te.shape==="oval"?Vt(M,Pe,te,te.globalRow):te.shape==="circle"&&Yt(M,Pe,te,te.globalRow)}}}function ie(M,k,E){M.strokeStyle="rgba(255, 0, 0, 0.9)",M.lineWidth=3,M.beginPath(),M.moveTo(k,0),M.lineTo(k,E),M.stroke()}function de(M,k){M.fillStyle="rgba(0, 0, 0, 0.7)",M.fillRect(n(R)/2-40,10,80,50),M.fillStyle="#ffffff",M.font="bold 36px sans-serif",M.textAlign="center",M.textBaseline="middle",M.fillText(k.toString(),n(R)/2,35)}function fe(M,k,E){const le={fullRowData:t.fullRowData,cellWidth:t.cellWidth,cellHeight:t.cellHeight,legendColumnWidth:n(P),colorMode:i(),showFrequencyLabels:o(),showOctaveLabels:r(),accidentalMode:a(),highlight:t.legendHighlight},ge={startRow:k,endRow:E,coords:M};Gi(n(_),n(A),le,ge)}function F(M){const k=[];let E=0;for(const le of M)E+=le,k.push(E);return k}function U(){if(n(T))return;function M(){S(),W(T,requestAnimationFrame(M),!0)}W(T,requestAnimationFrame(M),!0)}function se(){n(T)&&(cancelAnimationFrame(n(T)),W(T,null))}function H(){if(!n(f)||(W(b,n(f).getContext("2d"),!0),!n(b)))return;const M=window.devicePixelRatio||1;n(f).width=n(R)*M,n(f).height=t.viewport.containerHeight*M,n(f).style.width=`${n(R)}px`,n(f).style.height=`${t.viewport.containerHeight}px`,n(b).scale(M,M),n(v)&&(W(_,n(v).getContext("2d"),!0),n(_)&&(n(v).width=n(D)*M,n(v).height=t.viewport.containerHeight*M,n(v).style.width=`${n(D)}px`,n(v).style.height=`${t.viewport.containerHeight}px`,n(_).scale(M,M))),n(y)&&(W(A,n(y).getContext("2d"),!0),n(A)&&(n(y).width=n(D)*M,n(y).height=t.viewport.containerHeight*M,n(y).style.width=`${n(D)}px`,n(y).style.height=`${t.viewport.containerHeight}px`,n(A).scale(M,M))),S(),(n(Y)||n(J))&&U()}an(()=>{H()}),nt(()=>{se()}),Se(()=>{t.mode,t.viewport,t.cellWidth,t.cellHeight,i(),s(),l(),c(),u(),n(b)&&n(X)&&S()}),Se(()=>{t.mode,n(Y)||n(J)?U():(se(),n(b)&&S())}),Se(()=>{t.viewport.containerWidth,t.viewport.containerHeight,n(b)&&n(f)&&H()});var q=Ui(),j=C(q);{var oe=M=>{var k=Vi();Ae(k,E=>W(v,E),()=>n(v)),K(M,k)};Te(j,M=>{(r()||o())&&M(oe)})}var ae=I(j,2);Ae(ae,M=>W(f,M),()=>n(f));var re=I(ae,2);{var me=M=>{var k=Yi();Ae(k,E=>W(y,E),()=>n(y)),K(M,k)};Te(re,M=>{(r()||o())&&M(me)})}K(e,q),_e()}function Ki(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var yt,Zt;function Zi(){if(Zt)return yt;Zt=1;function e(t){if(this.size=t|0,this.size<=1||(this.size&this.size-1)!==0)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=t<<1;for(var i=new Array(this.size*2),s=0;s<i.length;s+=2){const u=Math.PI*s/this.size;i[s]=Math.cos(u),i[s+1]=-Math.sin(u)}this.table=i;for(var a=0,o=1;this.size>o;o<<=1)a++;this._width=a%2===0?a-1:a,this._bitrev=new Array(1<<this._width);for(var r=0;r<this._bitrev.length;r++){this._bitrev[r]=0;for(var l=0;l<this._width;l+=2){var c=this._width-l-2;this._bitrev[r]|=(r>>>l&3)<<c}}this._out=null,this._data=null,this._inv=0}return yt=e,e.prototype.fromComplexArray=function(i,s){for(var a=s||new Array(i.length>>>1),o=0;o<i.length;o+=2)a[o>>>1]=i[o];return a},e.prototype.createComplexArray=function(){const i=new Array(this._csize);for(var s=0;s<i.length;s++)i[s]=0;return i},e.prototype.toComplexArray=function(i,s){for(var a=s||this.createComplexArray(),o=0;o<a.length;o+=2)a[o]=i[o>>>1],a[o+1]=0;return a},e.prototype.completeSpectrum=function(i){for(var s=this._csize,a=s>>>1,o=2;o<a;o+=2)i[s-o]=i[o],i[s-o+1]=-i[o+1]},e.prototype.transform=function(i,s){if(i===s)throw new Error("Input and output buffers must be different");this._out=i,this._data=s,this._inv=0,this._transform4(),this._out=null,this._data=null},e.prototype.realTransform=function(i,s){if(i===s)throw new Error("Input and output buffers must be different");this._out=i,this._data=s,this._inv=0,this._realTransform4(),this._out=null,this._data=null},e.prototype.inverseTransform=function(i,s){if(i===s)throw new Error("Input and output buffers must be different");this._out=i,this._data=s,this._inv=1,this._transform4();for(var a=0;a<i.length;a++)i[a]/=this.size;this._out=null,this._data=null},e.prototype._transform4=function(){var i=this._out,s=this._csize,a=this._width,o=1<<a,r=s/o<<1,l,c,u=this._bitrev;if(r===4)for(l=0,c=0;l<s;l+=r,c++){const v=u[c];this._singleTransform2(l,v,o)}else for(l=0,c=0;l<s;l+=r,c++){const v=u[c];this._singleTransform4(l,v,o)}var g=this._inv?-1:1,h=this.table;for(o>>=2;o>=2;o>>=2){r=s/o<<1;var d=r>>>2;for(l=0;l<s;l+=r)for(var p=l+d,m=l,f=0;m<p;m+=2,f+=o){const v=m,y=v+d,b=y+d,_=b+d,A=i[v],T=i[v+1],w=i[y],P=i[y+1],D=i[b],N=i[b+1],R=i[_],X=i[_+1],Y=A,J=T,Q=h[f],S=g*h[f+1],B=w*Q-P*S,G=w*S+P*Q,L=h[2*f],ee=g*h[2*f+1],ie=D*L-N*ee,de=D*ee+N*L,fe=h[3*f],F=g*h[3*f+1],U=R*fe-X*F,se=R*F+X*fe,H=Y+ie,q=J+de,j=Y-ie,oe=J-de,ae=B+U,re=G+se,me=g*(B-U),M=g*(G-se),k=H+ae,E=q+re,le=H-ae,ge=q-re,ve=j+M,te=oe-me,pe=j-M,V=oe+me;i[v]=k,i[v+1]=E,i[y]=ve,i[y+1]=te,i[b]=le,i[b+1]=ge,i[_]=pe,i[_+1]=V}}},e.prototype._singleTransform2=function(i,s,a){const o=this._out,r=this._data,l=r[s],c=r[s+1],u=r[s+a],g=r[s+a+1],h=l+u,d=c+g,p=l-u,m=c-g;o[i]=h,o[i+1]=d,o[i+2]=p,o[i+3]=m},e.prototype._singleTransform4=function(i,s,a){const o=this._out,r=this._data,l=this._inv?-1:1,c=a*2,u=a*3,g=r[s],h=r[s+1],d=r[s+a],p=r[s+a+1],m=r[s+c],f=r[s+c+1],v=r[s+u],y=r[s+u+1],b=g+m,_=h+f,A=g-m,T=h-f,w=d+v,P=p+y,D=l*(d-v),N=l*(p-y),R=b+w,X=_+P,Y=A+N,J=T-D,Q=b-w,S=_-P,B=A-N,G=T+D;o[i]=R,o[i+1]=X,o[i+2]=Y,o[i+3]=J,o[i+4]=Q,o[i+5]=S,o[i+6]=B,o[i+7]=G},e.prototype._realTransform4=function(){var i=this._out,s=this._csize,a=this._width,o=1<<a,r=s/o<<1,l,c,u=this._bitrev;if(r===4)for(l=0,c=0;l<s;l+=r,c++){const ut=u[c];this._singleRealTransform2(l,ut>>>1,o>>>1)}else for(l=0,c=0;l<s;l+=r,c++){const ut=u[c];this._singleRealTransform4(l,ut>>>1,o>>>1)}var g=this._inv?-1:1,h=this.table;for(o>>=2;o>=2;o>>=2){r=s/o<<1;var d=r>>>1,p=d>>>1,m=p>>>1;for(l=0;l<s;l+=r)for(var f=0,v=0;f<=m;f+=2,v+=o){var y=l+f,b=y+p,_=b+p,A=_+p,T=i[y],w=i[y+1],P=i[b],D=i[b+1],N=i[_],R=i[_+1],X=i[A],Y=i[A+1],J=T,Q=w,S=h[v],B=g*h[v+1],G=P*S-D*B,L=P*B+D*S,ee=h[2*v],ie=g*h[2*v+1],de=N*ee-R*ie,fe=N*ie+R*ee,F=h[3*v],U=g*h[3*v+1],se=X*F-Y*U,H=X*U+Y*F,q=J+de,j=Q+fe,oe=J-de,ae=Q-fe,re=G+se,me=L+H,M=g*(G-se),k=g*(L-H),E=q+re,le=j+me,ge=oe+k,ve=ae-M;if(i[y]=E,i[y+1]=le,i[b]=ge,i[b+1]=ve,f===0){var te=q-re,pe=j-me;i[_]=te,i[_+1]=pe;continue}if(f!==m){var V=oe,Ce=-ae,Pe=q,He=-j,Ye=-g*k,ot=-g*M,at=-g*me,rt=-g*re,lt=V+Ye,ct=Ce+ot,Ue=Pe+rt,je=He-at,Dt=l+p-f,xt=l+d-f;i[Dt]=lt,i[Dt+1]=ct,i[xt]=Ue,i[xt+1]=je}}}},e.prototype._singleRealTransform2=function(i,s,a){const o=this._out,r=this._data,l=r[s],c=r[s+a],u=l+c,g=l-c;o[i]=u,o[i+1]=0,o[i+2]=g,o[i+3]=0},e.prototype._singleRealTransform4=function(i,s,a){const o=this._out,r=this._data,l=this._inv?-1:1,c=a*2,u=a*3,g=r[s],h=r[s+a],d=r[s+c],p=r[s+u],m=g+d,f=g-d,v=h+p,y=l*(h-p),b=m+v,_=f,A=-y,T=m-v,w=f,P=y;o[i]=b,o[i+1]=0,o[i+2]=_,o[i+3]=A,o[i+4]=T,o[i+5]=0,o[i+6]=w,o[i+7]=P},yt}var Ji=Zi();const Qi=Ki(Ji);class ze{_inputLength;_fft;_bufferSupplier;_paddedInputBuffer;_transformBuffer;_inverseBuffer;static forFloat32Array(t){return new ze(t,i=>new Float32Array(i))}static forFloat64Array(t){return new ze(t,i=>new Float64Array(i))}static forNumberArray(t){return new ze(t,i=>Array(i))}constructor(t,i){if(t<1)throw new Error("Input length must be at least one");this._inputLength=t,this._fft=new Qi(ts(2*t)),this._bufferSupplier=i,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}get inputLength(){return this._inputLength}autocorrelate(t,i=this._bufferSupplier(t.length)){if(t.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${t.length}`);for(let a=0;a<t.length;a++)this._paddedInputBuffer[a]=t[a];for(let a=t.length;a<this._paddedInputBuffer.length;a++)this._paddedInputBuffer[a]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const s=this._transformBuffer;for(let a=0;a<s.length;a+=2)s[a]=s[a]*s[a]+s[a+1]*s[a+1],s[a+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let a=0;a<t.length;a++)i[a]=this._inverseBuffer[2*a];return i}}function $i(e){const t=[];let i=!1,s=-1/0,a=-1;for(let o=1;o<e.length-1;o++)e[o-1]<=0&&e[o]>0?(i=!0,a=o,s=e[o]):e[o-1]>0&&e[o]<=0?(i=!1,a!==-1&&t.push(a)):i&&e[o]>s&&(s=e[o],a=o);return t}function es(e,t){const[i,s,a]=[e-1,e,e+1],[o,r,l]=[t[i],t[s],t[a]],c=o/2-r+l/2,u=-(o/2)*(s+a)+r*(i+a)-l/2*(i+s),g=o*s*a/2-r*i*a+l*i*s/2,h=-u/(2*c),d=c*h*h+u*h+g;return[h,d]}class Xe{_autocorrelator;_nsdfBuffer;_clarityThreshold=.9;_minVolumeAbsolute=0;_maxInputAmplitude=1;static forFloat32Array(t){return new Xe(t,i=>new Float32Array(i))}static forFloat64Array(t){return new Xe(t,i=>new Float64Array(i))}static forNumberArray(t){return new Xe(t,i=>Array(i))}constructor(t,i){this._autocorrelator=new ze(t,i),this._nsdfBuffer=i(t)}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(t){if(!Number.isFinite(t)||t<=0||t>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=t}set minVolumeAbsolute(t){if(!Number.isFinite(t)||t<0||t>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=t}set minVolumeDecibels(t){if(!Number.isFinite(t)||t>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(t/10)}set maxInputAmplitude(t){if(!Number.isFinite(t)||t<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=t}findPitch(t,i){if(this._belowMinimumVolume(t))return[0,0];this._nsdf(t);const s=$i(this._nsdfBuffer);if(s.length===0)return[0,0];const a=Math.max(...s.map(c=>this._nsdfBuffer[c])),o=s.find(c=>this._nsdfBuffer[c]>=this._clarityThreshold*a),[r,l]=es(o,this._nsdfBuffer);return[i/r,Math.min(l,1)]}_belowMinimumVolume(t){if(this._minVolumeAbsolute===0)return!1;let i=0;for(let s=0;s<t.length;s++)i+=t[s]**2;return Math.sqrt(i/t.length)<this._minVolumeAbsolute}_nsdf(t){this._autocorrelator.autocorrelate(t,this._nsdfBuffer);let i=2*this._nsdfBuffer[0],s;for(s=0;s<this._nsdfBuffer.length&&i>0;s++)this._nsdfBuffer[s]=2*this._nsdfBuffer[s]/i,i-=t[s]**2+t[t.length-s-1]**2;for(;s<this._nsdfBuffer.length;s++)this._nsdfBuffer[s]=0}}function ts(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e++,e}const ns=100,wt=12;function is(e){const t=Math.round(e);return(e-t)*ns}function ss(e){return Math.round(e)}function os(e){return(Math.round(e)%wt+wt)%wt}var as=Z('<div class="pitch-wheel-option svelte-53gwvz"> </div>'),rs=Z('<div class="pitch-wheel svelte-53gwvz" role="slider" tabindex="0" aria-valuemin="0"><div class="pitch-wheel-viewport svelte-53gwvz"><div class="pitch-wheel-options svelte-53gwvz"></div></div> <div class="pitch-wheel-overlay svelte-53gwvz"></div></div>');function Jt(e,t){Me(t,!0);let i=ue(t,"selectedIndex",15),s=ue(t,"ariaLabel",3,"Pitch selector");const a=40,o=a;let r=z(void 0),l=z(void 0),c=z(void 0),u=z(!1),g=z(null),h=z(0),d=z(0),p=z(a);const m=x(()=>t.options.map((S,B)=>Math.min(Math.abs(B-i()),3))),f=x(()=>n(l)?.clientHeight??0),v=x(()=>Math.max(0,(n(f)-n(p))/2)),y=x(()=>n(v)+i()*n(p)+n(p)/2),b=x(()=>n(f)>0?n(f)/2-n(y):0);function _(S){if(!t.options||t.options.length===0)return;let B=S;typeof t.onbeforechange=="function"&&(B=t.onbeforechange(S));const G=Math.max(0,Math.min(t.options.length-1,B));if(G!==i()&&(i(G),typeof t.onchange=="function")){const L=t.options[G];L&&t.onchange(G,L)}}function A(S){S!==0&&_(i()+S)}function T(S){S.preventDefault(),S.stopPropagation();const B=Math.sign(S.deltaY);B!==0&&A(B)}function w(S){S.key==="ArrowUp"?(S.preventDefault(),A(-1)):S.key==="ArrowDown"?(S.preventDefault(),A(1)):S.key==="Home"?(S.preventDefault(),_(0)):S.key==="End"&&(S.preventDefault(),_(t.options.length-1))}function P(S){if(W(u,!0),W(g,S.pointerId,!0),W(h,S.clientY,!0),W(d,0),n(r)&&typeof n(r).setPointerCapture=="function")try{n(r).setPointerCapture(S.pointerId)}catch{}}function D(S){if(!n(u)||S.pointerId!==n(g))return;const B=S.clientY-n(h);if(W(h,S.clientY,!0),B===0)return;W(d,n(d)+B);const G=n(p)||o;for(;Math.abs(n(d))>=G;){const L=-Math.sign(n(d));A(L),W(d,n(d)-Math.sign(n(d))*G)}}function N(S){n(u)&&S.pointerId===n(g)&&(W(u,!1),W(g,null),W(d,0),n(r)?.hasPointerCapture?.(S.pointerId)&&n(r).releasePointerCapture(S.pointerId))}Se(()=>{if(!n(c)||!n(l))return;const S=()=>{const G=n(c)?.querySelector(".pitch-wheel-option");G&&W(p,G.offsetHeight||a,!0)};S();const B=new ResizeObserver(()=>{S()});return B.observe(n(l)),()=>{B.disconnect()}});var R=rs();R.__keydown=w,R.__pointerdown=P,R.__pointermove=D,R.__pointerup=N;let X;var Y=C(R),J=C(Y);let Q;st(J,23,()=>t.options,S=>S.index,(S,B,G)=>{var L=as(),ee=C(L);he(()=>{ke(L,"data-distance",n(m)[n(G)]),$(ee,n(B).label)}),K(S,L)}),Ae(J,S=>W(c,S),()=>n(c)),Ae(Y,S=>W(l,S),()=>n(l)),Ae(R,S=>W(r,S),()=>n(r)),he(()=>{ke(R,"aria-label",s()),ke(R,"aria-valuemax",t.options.length-1),ke(R,"aria-valuenow",i()),ke(R,"aria-valuetext",t.options[i()]?.label??""),X=Ot(R,"",X,{height:t.wheelHeight?`${t.wheelHeight}px`:"100%"}),Q=Ot(J,"",Q,{"padding-top":`${n(v)??""}px`,"padding-bottom":`${n(v)??""}px`,transform:`translateY(${n(b)??""}px)`})}),ht("wheel",R,T),ht("pointercancel",R,N),ht("pointerleave",R,N),K(e,R),_e()}Ie(["keydown","pointerdown","pointermove","pointerup"]);const Mn=7;function $e(e,t,i){return Number.isFinite(e)?Math.max(t,Math.min(i,Math.round(e))):t}function ls(e,t,i,s=Mn){const a=Math.max(0,i-1),o=$e(e,0,a),r=Math.max(1,Math.round(s)),l=Math.max(0,o-(r-1));return $e(t,0,l)}function cs(e,t,i,s=Mn){const a=Math.max(0,i-1),o=$e(e,0,a),r=Math.max(1,Math.round(s)),l=Math.min(a,o+(r-1));return $e(t,l,a)}function us(e){return e.map((t,i)=>({index:i,label:t.pitch,midi:t.midi,toneNote:t.toneNote,frequency:t.frequency}))}var ds=Z('<div class="summary-card svelte-yqjxxp"><div class="summary-label svelte-yqjxxp"> </div> <div class="summary-metadata svelte-yqjxxp"> </div></div>'),hs=Z('<div class="dual-pitch-wheel svelte-yqjxxp"><div class="wheels-container svelte-yqjxxp"><div class="wheel-column svelte-yqjxxp"><div class="wheel-label svelte-yqjxxp">High</div> <!></div> <div class="wheel-column svelte-yqjxxp"><div class="wheel-label svelte-yqjxxp">Low</div> <!></div></div> <!></div>');function fs(e,t){Me(t,!0);let i=ue(t,"topIndex",15),s=ue(t,"bottomIndex",15),a=ue(t,"minSpan",3,7),o=ue(t,"showSummary",3,!0);const r=x(()=>us(t.fullRowData)),l=x(()=>({topIndex:i(),bottomIndex:s(),topPitch:t.fullRowData[i()],bottomPitch:t.fullRowData[s()],span:s()-i()+1})),c=x(()=>n(l).topPitch&&n(l).bottomPitch?`${n(l).topPitch.pitch} – ${n(l).bottomPitch.pitch}`:""),u=x(()=>`${n(l).span} ${n(l).span===1?"pitch":"pitches"}`);function g(w){return ls(s(),w,n(r).length,a())}function h(w){return cs(i(),w,n(r).length,a())}function d(w,P){i(w),typeof t.onrangechange=="function"&&t.onrangechange(n(l))}function p(w,P){s(w),typeof t.onrangechange=="function"&&t.onrangechange(n(l))}var m=hs(),f=C(m),v=C(f),y=I(C(v),2);Jt(y,{get options(){return n(r)},get selectedIndex(){return i()},onchange:d,onbeforechange:g,get wheelHeight(){return t.wheelHeight},ariaLabel:"High pitch selector"});var b=I(v,2),_=I(C(b),2);Jt(_,{get options(){return n(r)},get selectedIndex(){return s()},onchange:p,onbeforechange:h,get wheelHeight(){return t.wheelHeight},ariaLabel:"Low pitch selector"});var A=I(f,2);{var T=w=>{var P=ds(),D=C(P),N=C(D),R=I(D,2),X=C(R);he(()=>{$(N,n(c)),$(X,n(u))}),K(w,P)};Te(A,w=>{o()&&w(T)})}K(e,m),_e()}Ie(["change"]);var gs=Object.defineProperty,ms=(e,t,i)=>t in e?gs(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Ee=(e,t,i)=>ms(e,typeof t!="symbol"?t+"":t,i);const Qt={isDetecting:!1,visualizationMode:"highway",tonic:"C",useDegrees:!1,showAccidentals:!0,pitchHighlightEnabled:!0,yAxisRange:{minMidi:48,maxMidi:72},drone:{isPlaying:!1,octave:3,volume:-12}};function vs(){let e=z(Fe({...Qt}));return{get state(){return n(e)},toggleDetecting(){n(e).isDetecting=!n(e).isDetecting},setDetecting(t){n(e).isDetecting=t},setVisualizationMode(t){n(e).visualizationMode=t},setTonic(t){n(e).tonic=t},setUseDegrees(t){n(e).useDegrees=t},setShowAccidentals(t){n(e).showAccidentals=t},togglePitchHighlight(){n(e).pitchHighlightEnabled=!n(e).pitchHighlightEnabled},setPitchHighlightEnabled(t){n(e).pitchHighlightEnabled=t},setYAxisRange(t){n(e).yAxisRange=t},expandYAxisUpper(){n(e).yAxisRange.maxMidi<108&&(n(e).yAxisRange={...n(e).yAxisRange,maxMidi:n(e).yAxisRange.maxMidi+1})},contractYAxisUpper(){n(e).yAxisRange.maxMidi>n(e).yAxisRange.minMidi+6&&(n(e).yAxisRange={...n(e).yAxisRange,maxMidi:n(e).yAxisRange.maxMidi-1})},expandYAxisLower(){n(e).yAxisRange.minMidi>21&&(n(e).yAxisRange={...n(e).yAxisRange,minMidi:n(e).yAxisRange.minMidi-1})},contractYAxisLower(){n(e).yAxisRange.minMidi<n(e).yAxisRange.maxMidi-6&&(n(e).yAxisRange={...n(e).yAxisRange,minMidi:n(e).yAxisRange.minMidi+1})},toggleDrone(){n(e).drone={...n(e).drone,isPlaying:!n(e).drone.isPlaying}},setDroneOctave(t){n(e).drone={...n(e).drone,octave:t}},setDroneVolume(t){n(e).drone={...n(e).drone,volume:t}},reset(){W(e,{...Qt},!0)}}}const O=vs(),ps=200,$t={currentPitch:null,history:[],stablePitch:{pitchClass:null,opacity:0,size:1}};function ys(){let e=z(Fe({...$t}));return{get state(){return n(e)},setCurrentPitch(t){n(e).currentPitch=t},addHistoryPoint(t){n(e).history.push(t),n(e).history.length>ps&&n(e).history.shift()},setStablePitch(t){n(e).stablePitch=t},clearHistory(){n(e).history=[]},reset(){W(e,{...$t},!0)}}}const ne=ys(),en={isPlaying:!1,startTime:null,currentTimeMs:0,targetNotes:[],nowLineX:100,pixelsPerSecond:200,timeWindowMs:4e3};function ws(){let e=z(Fe({...en})),t=null,i=null;function s(l){return l.map((c,u)=>({id:`target-${u}`,midi:c.midi,startTimeMs:c.startTimeMs,durationMs:c.durationMs,startColumn:0,endColumn:0,color:"#3b82f6",shape:"oval",globalRow:0}))}function a(){if(!t)return;const l=t.getState();n(e).isPlaying=l.isPlaying&&!l.isPaused,n(e).currentTimeMs=l.currentTimeMs;const c=t.getPerformanceResults();n(e).targetNotes=n(e).targetNotes.map((u,g)=>{const h=`target-${g}`,d=c.get(h);return{...u,hit:d?.hitStatus==="hit"}})}function o(){n(e).isPlaying&&t?(a(),i=requestAnimationFrame(o)):i=null}function r(){t&&t.dispose(),t=gi({judgmentLinePosition:n(e).nowLineX/800,pixelsPerSecond:n(e).pixelsPerSecond,lookAheadMs:n(e).timeWindowMs,scrollMode:"constant-speed",leadInBeats:0,playMetronomeDuringOnramp:!1,playTargetNotes:!1,playMetronome:!1,inputSources:["microphone"],feedbackConfig:{onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70},stateCallbacks:{getTempo:()=>120,getCellWidth:()=>20,getViewportWidth:()=>800},eventCallbacks:{emit:(c,u)=>{if(console.debug("[Highway]",c,u),c==="noteHit"){const g=u;console.log(`[Highway] Note HIT: ${g.noteId}, accuracy: ${g.performance.accuracyTier||"unknown"}`)}else c==="noteMissed"?console.log(`[Highway] Note MISSED: ${u.noteId}`):c==="onrampComplete"?console.log("[Highway] Onramp complete, playback starting!"):c==="performanceComplete"&&console.log("[Highway] Performance complete!")}}});const l=s(n(e).targetNotes);t.init(l)}return{get state(){return n(e)},get engineService(){return t},start(){!t&&n(e).targetNotes.length>0&&r(),t&&(t.start(),n(e).isPlaying=!0,n(e).startTime=performance.now(),n(e).currentTimeMs=0,o())},stop(){t&&t.stop(),n(e).isPlaying=!1,i!==null&&(cancelAnimationFrame(i),i=null)},pause(){t&&t.pause(),n(e).isPlaying=!1,i!==null&&(cancelAnimationFrame(i),i=null)},resume(){t&&(t.resume(),n(e).isPlaying=!0,o())},setTargetNotes(l){if(n(e).targetNotes=l,t){const c=s(l);t.init(c)}},markNoteHit(l){l>=0&&l<n(e).targetNotes.length&&(n(e).targetNotes=n(e).targetNotes.map((c,u)=>u===l?{...c,hit:!0}:c))},setNowLineX(l){n(e).nowLineX=l},setPixelsPerSecond(l){n(e).pixelsPerSecond=l},setTimeWindowMs(l){n(e).timeWindowMs=l},recordPitchInput(l,c){t&&n(e).isPlaying&&t.recordPitchInput(l,c,"microphone")},getPerformanceResults(){return t?.getPerformanceResults()??new Map},reset(){i!==null&&(cancelAnimationFrame(i),i=null),t&&(t.dispose(),t=null),W(e,{...en},!0)}}}const we=ws(),bs={numLoops:5,minMidi:48,maxMidi:72,tempo:108,referenceVolume:-12},tn={isActive:!1,isPlaying:!1,config:{...bs},currentLoop:0,currentPhase:"reference",currentPitch:null,generatedNotes:[],results:[]};function Ms(e,t){return Math.floor(Math.random()*(t-e+1))+e}function nn(e){return 60/e*1e3/2}function _s(){let e=z(Fe({...tn}));function t(s){const a=[],o=nn(s.tempo),r=2e3;for(let l=0;l<s.numLoops;l++){const c=Ms(s.minMidi,s.maxMidi),u=r+l*32*o;a.push({midi:c,startTimeMs:u,durationMs:8*o,lyric:"👂"}),a.push({midi:c,startTimeMs:u+16*o,durationMs:8*o,lyric:"🎤"})}return a}function i(s,a){const o=nn(a),r=32*o,l=s-2e3;if(l<0)return{loop:0,phase:"rest2"};const c=Math.floor(l/r),u=l%r,g=Math.floor(u/o);let h;return g<8?h="reference":g<16?h="rest1":g<24?h="input":h="rest2",{loop:c,phase:h}}return{get state(){return n(e)},configure(s){n(e).config={...n(e).config,...s}},setPitchRange(s,a){n(e).config.minMidi=s,n(e).config.maxMidi=a},start(){const s=t(n(e).config);n(e).generatedNotes=s,n(e).isActive=!0,n(e).isPlaying=!1,n(e).currentLoop=0,n(e).currentPhase="reference",n(e).currentPitch=s.length>0?s[0].midi:null,n(e).results=[]},stop(){n(e).isActive=!1,n(e).isPlaying=!1,n(e).currentLoop=0,n(e).currentPhase="reference",n(e).currentPitch=null},setPlaying(s){n(e).isPlaying=s},updatePhase(s){const{loop:a,phase:o}=i(s,n(e).config.tempo);n(e).currentLoop=a,n(e).currentPhase=o;const r=a*2;r<n(e).generatedNotes.length&&(n(e).currentPitch=n(e).generatedNotes[r].midi)},addResult(s){n(e).results.push(s)},hasResultForLoop(s){return n(e).results.some(a=>a.loopIndex===s)},getResults(){return n(e).results},getCurrentProgress(){return{current:n(e).currentLoop+1,total:n(e).config.numLoops}},getGeneratedNotes(){return n(e).generatedNotes},getAverageAccuracy(){return n(e).results.length===0?0:n(e).results.reduce((s,a)=>s+a.accuracy,0)/n(e).results.length},getHitCount(){return n(e).results.filter(s=>{var a;return((a=s.performance)==null?void 0:a.hitStatus)==="hit"}).length},reset(){W(e,{...tn,config:{...n(e).config}},!0)}}}const ce=_s();var Ts=Z('<div class="singing-canvas-container svelte-15ar5r5"><!> <canvas class="pitch-trail-canvas svelte-15ar5r5"></canvas></div>');function Cs(e,t){Me(t,!0);let i=z(void 0),s=z(800),a=z(400),o=z(void 0),r=z(null),l=z(null),c=0,u=0,g=0;const h=20,d=!0,p=!1,m=3,f=x(()=>h*m),v=x(()=>n(f)*2),y=x(()=>n(v)*2),b=x(()=>Math.max(0,n(s)-n(y))),_=x(()=>n(v)),A=()=>{try{return!!globalThis.__ST_DEBUG_TRAIL}catch{return!1}},T=x(()=>Wn(O.state.yAxisRange.minMidi,O.state.yAxisRange.maxMidi)),w=x(()=>Fn({containerHeight:n(a),fullRowData:n(T),preferredCellHeight:40,minCellHeight:20})),P=x(()=>O.state.visualizationMode==="highway"?"highway":"singing"),D=x(()=>60/ce.state.config.tempo*1e3),N=2e3,R=x(()=>(()=>{if(!O.state.pitchHighlightEnabled)return;const F=ne.state.stablePitch;if(!(F.pitchClass===null||F.opacity<=.01))return{pitchClass:F.pitchClass,opacity:F.opacity,color:"#ffff00"}})());function X(){return we.state.targetNotes.map((F,U)=>({id:`target-${U}`,midi:F.midi,startTimeMs:F.startTimeMs,durationMs:F.durationMs,label:F.lyric}))}const Y=x(()=>({timeWindowMs:4e3,pixelsPerSecond:200,circleRadius:9.5,proximityThreshold:35,maxConnections:3,connectorLineWidth:2.5,connectorColor:"rgba(0,0,0,0.4)",useTonicRelativeColors:!0,tonicPitchClass:hi(O.state.tonic),clarityThreshold:.5,maxOpacity:.9})),J=x(()=>n(P)==="singing"?{userPitch:ne.state.currentPitch?{frequency:ne.state.currentPitch.frequency,midi:ne.state.currentPitch.midi,clarity:ne.state.currentPitch.clarity,pitchClass:ne.state.currentPitch.pitchClass}:null,pitchHistory:[],targetNotes:[],pixelsPerSecond:200,timeWindowMs:4e3,trailConfig:n(Y)}:void 0),Q=x(()=>n(P)==="highway"?{userPitch:ne.state.currentPitch?{frequency:ne.state.currentPitch.frequency,midi:ne.state.currentPitch.midi,clarity:ne.state.currentPitch.clarity,pitchClass:ne.state.currentPitch.pitchClass}:null,pitchHistory:[],targetNotes:X(),nowLineX:we.state.nowLineX,pixelsPerSecond:we.state.pixelsPerSecond,currentTimeMs:we.state.currentTimeMs,timeWindowMs:we.state.timeWindowMs,trailConfig:n(Y)}:void 0),S=x(()=>({startRow:n(w).startRow,endRow:n(w).endRow,zoomLevel:1,containerWidth:n(s),containerHeight:n(a)}));function B(){if(!n(o))return;const F=window.devicePixelRatio||1;n(o).width=n(b)*F,n(o).height=n(a)*F,n(o).style.width=`${n(b)}px`,n(o).style.height=`${n(a)}px`,n(o).style.left=`${n(_)}px`;const U=n(o).getContext("2d");if(!U){W(r,null);return}U.setTransform(F,0,0,F,0,0),W(r,U,!0)}function G(){if(!n(r)||n(b)<=0)return;n(r).clearRect(0,0,n(b),n(a));const F=ne.state.history;if(F.length===0)return;const U=n(P)==="singing"?n(J):n(Q);if(!U)return;const se=A(),H=se?performance.now():0,q=n(P)==="highway"&&n(Q)?n(Q).nowLineX:100,j=gn({cellHeight:n(w).cellHeight,viewport:n(S),pixelsPerSecond:U.pixelsPerSecond??200,nowLineX:q,currentTimeMs:n(P)==="highway"&&n(Q)?n(Q).currentTimeMs:0}),oe={cellHeight:n(w).cellHeight,viewportWidth:n(b),nowLineX:q,pixelsPerSecond:U.pixelsPerSecond??200,timeWindowMs:U.timeWindowMs??4e3,colorMode:"color",trailConfig:n(Y)},ae=performance.now();if(wn(n(r),j,F,ae,oe,n(T)),se){const re=performance.now();if(u+=1,g+=re-H,re-c>=1e3){const me=u>0?g/u:0;console.log(`[SingingTrail] points=${F.length} avgMs=${me.toFixed(2)} gridWidth=${n(b)}`),c=re,u=0,g=0}}}function L(){if(n(l))return;const F=()=>{G(),W(l,requestAnimationFrame(F),!0)};W(l,requestAnimationFrame(F),!0)}function ee(){n(l)&&(cancelAnimationFrame(n(l)),W(l,null)),n(r)&&n(b)>0&&n(r).clearRect(0,0,n(b),n(a))}Se(()=>{if(!n(i))return;const F=new ResizeObserver(U=>{for(const se of U)W(s,se.contentRect.width,!0),W(a,se.contentRect.height,!0)});return F.observe(n(i)),()=>{F.disconnect()}}),Se(()=>{n(b),n(a),n(_),n(o),B()}),Se(()=>{n(P),n(r),n(P)==="singing"||n(P)==="highway"?L():ee()}),nt(()=>{ee()});var ie=Ts(),de=C(ie);ji(de,{get mode(){return n(P)},get fullRowData(){return n(T)},get viewport(){return n(S)},cellWidth:h,get cellHeight(){return n(w).cellHeight},colorMode:"color",showOctaveLabels:d,showFrequencyLabels:p,get singingConfig(){return n(J)},get highwayConfig(){return n(Q)},get legendHighlight(){return n(R)},get beatIntervalMs(){return n(D)},beatTimeOffsetMs:N});var fe=I(de,2);Ae(fe,F=>W(o,F),()=>n(o)),Ae(ie,F=>W(i,F),()=>n(i)),K(e,ie),_e()}class Ps{constructor(){Ee(this,"synth",null),Ee(this,"scheduledTimeouts",[]),Ee(this,"volume",null),Ee(this,"startTime",0),Ee(this,"_isPlaying",!1)}get isPlaying(){return this._isPlaying}async init(){await Pt(),this.volume=new on(-12).toDestination(),this.synth=new rn({oscillator:{type:"triangle"},envelope:{attack:.05,decay:.1,sustain:.9,release:.1}}).connect(this.volume)}setVolume(t){this.volume&&(this.volume.volume.value=t)}scheduleReferenceTones(t){if(!this.synth){console.warn("[ReferenceAudio] Synth not initialized");return}this.clearScheduled(),this.startTime=performance.now(),t.forEach(i=>{const s=i.durationMs/1e3,a=kt(i.midi,"midi").toFrequency(),o=window.setTimeout(()=>{this.synth&&(console.log(`[ReferenceAudio] Playing ${i.midi} at ${performance.now()-this.startTime}ms`),this._isPlaying=!0,this.synth.triggerAttackRelease(a,s))},i.startTimeMs),r=window.setTimeout(()=>{this._isPlaying=!1},i.startTimeMs+i.durationMs);this.scheduledTimeouts.push(o,r)}),console.log(`[ReferenceAudio] Scheduled ${t.length} reference tones`)}playTone(t,i){if(!this.synth){console.warn("[ReferenceAudio] Synth not initialized");return}const s=kt(t,"midi").toFrequency(),a=i/1e3;this.synth.triggerAttackRelease(s,a)}clearScheduled(){this.scheduledTimeouts.forEach(t=>{window.clearTimeout(t)}),this.scheduledTimeouts=[]}stop(){this.clearScheduled(),this.synth&&this.synth.triggerRelease()}dispose(){this.stop(),this.synth&&(this.synth.dispose(),this.synth=null),this.volume&&(this.volume.dispose(),this.volume=null)}}const Oe=new Ps,De={FFT_SIZE:2048,CLARITY_THRESHOLD:.8,MIN_PITCH_HZ:60,MAX_PITCH_HZ:1600,HIGHLIGHT_CENTS_RANGE:50};let xe=null,Ne=null,et=null,Re=null,tt=!1;const _t=1;function Ss(e){return 12*Math.log2(e/440)+69}function Tt(){if(!tt||!Ne||!et){Re=null;return}if(Oe.isPlaying){ne.addHistoryPoint({frequency:0,midi:0,time:performance.now(),clarity:0}),Re=requestAnimationFrame(Tt);return}const e=Ne.getValue(),[t,i]=et.findPitch(e,Nn().sampleRate),s=t!==null&&i>De.CLARITY_THRESHOLD&&t>De.MIN_PITCH_HZ&&t<De.MAX_PITCH_HZ;if(s){const a=Ss(t),o={frequency:t,midi:a,clarity:i,pitchClass:Math.round(a)%12};ne.setCurrentPitch(o),ne.addHistoryPoint({frequency:t,midi:a,time:performance.now(),clarity:i}),we.recordPitchInput(a,i)}else ne.addHistoryPoint({frequency:0,midi:0,time:performance.now(),clarity:0});if(s&&ne.state.currentPitch){const a=ne.state.currentPitch.midi,o=ss(a),r=is(a),l=Math.min(Math.abs(r),De.HIGHLIGHT_CENTS_RANGE),c=Math.max(0,1-l/De.HIGHLIGHT_CENTS_RANGE);ne.setStablePitch({pitchClass:os(o),opacity:c,size:_t})}else ne.setStablePitch({pitchClass:null,opacity:0,size:_t});Re=requestAnimationFrame(Tt)}async function Is(){if(!tt){Re!==null&&cancelAnimationFrame(Re),xe=new Be,Ne=new xn("waveform",De.FFT_SIZE),et=Xe.forFloat32Array(Ne.size);try{await Pt(),await xe.open(),xe.connect(Ne),tt=!0,Tt()}catch(e){throw console.error("Microphone access denied or failed:",e),_n(),e}}}function As(){tt=!1,_n()}function _n(){Re!==null&&(cancelAnimationFrame(Re),Re=null),xe&&(xe.close(),xe=null),Ne=null,et=null,ne.setStablePitch({pitchClass:null,opacity:0,size:_t}),ne.setCurrentPitch(null)}Ie(["click"]);let be=null,Ge=!1,Ve=null;function Rs(){var e;if(!be){be=new kn(rn,{oscillator:{type:"sawtooth"},envelope:{attack:.3,decay:.1,sustain:.8,release:.5}}).toDestination();const t=((e=be.get().oscillator)==null?void 0:e.type)??"unknown";console.log("[DroneAudio] Initialized drone synth",{oscillatorType:t})}return be}function Tn(e,t){return`${e.replace("b","#").replace("Db","C#").replace("Eb","D#").replace("Gb","F#").replace("Ab","G#").replace("Bb","A#")}${t}`}async function Hs(){await Pt();const e=Rs(),t=Tn(O.state.tonic,O.state.drone.octave);e.volume.value=O.state.drone.volume,console.log("[DroneAudio] Starting drone",{note:t,volume:e.volume.value}),Ve&&e.releaseAll(),Ve=t,e.triggerAttack(t),Ge=!0}function Ds(){be&&Ge&&(be.releaseAll(),Ve=null,Ge=!1)}function Ct(){if(!Ge||!be)return;const e=Tn(O.state.tonic,O.state.drone.octave);be.volume.value=O.state.drone.volume,console.log("[DroneAudio] Updating drone",{note:e,volume:be.volume.value}),e!==Ve&&(be.releaseAll(),be.triggerAttack(e),Ve=e)}async function xs(){Ge?Ds():await Hs()}var Ns=Z("<option> </option>"),Fs=Z('<div class="tonic-selector svelte-16h7our"><label for="tonic-select" class="svelte-16h7our">Key:</label> <select id="tonic-select" class="svelte-16h7our"></select></div>');function Ws(e,t){Me(t,!0);const i=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function s(l){const c=l.target;O.setTonic(c.value),Ct()}var a=Fs(),o=I(C(a),2);o.__change=s,st(o,21,()=>i,At,(l,c)=>{var u=Ns(),g=C(u),h={};he(()=>{$(g,n(c)),h!==(h=n(c))&&(u.value=(u.__value=n(c))??"")}),K(l,u)});var r;dn(o),he(()=>{r!==(r=O.state.tonic)&&(o.value=(o.__value=O.state.tonic)??"",Rt(o,O.state.tonic))}),K(e,a),_e()}Ie(["change"]);var ks=Z("<option> </option>"),Ls=Z('<div class="drone-controls svelte-1rkr6nv"><button> </button> <div class="drone-settings svelte-1rkr6nv"><label class="svelte-1rkr6nv">Oct: <select class="svelte-1rkr6nv"></select></label> <label class="svelte-1rkr6nv">Vol: <input type="range" min="-40" max="0" class="svelte-1rkr6nv"/></label></div></div>');function Es(e,t){Me(t,!0);const i=[2,3,4,5];async function s(){await xs(),O.toggleDrone()}function a(v){const y=v.target;O.setDroneOctave(parseInt(y.value,10)),Ct()}function o(v){const y=v.target;O.setDroneVolume(parseInt(y.value,10)),Ct()}var r=Ls(),l=C(r);let c;l.__click=s;var u=C(l),g=I(l,2),h=C(g),d=I(C(h));d.__change=a,st(d,21,()=>i,At,(v,y)=>{var b=ks(),_=C(b),A={};he(()=>{$(_,n(y)),A!==(A=n(y))&&(b.value=(b.__value=n(y))??"")}),K(v,b)});var p;dn(d);var m=I(h,2),f=I(C(m));f.__input=o,he(()=>{c=it(l,1,"drone-toggle svelte-1rkr6nv",null,c,{active:O.state.drone.isPlaying}),$(u,O.state.drone.isPlaying?"Drone On":"Drone Off"),p!==(p=O.state.drone.octave)&&(d.value=(d.__value=O.state.drone.octave)??"",Rt(d,O.state.drone.octave)),li(f,O.state.drone.volume)}),K(e,r),_e()}Ie(["click","change","input"]);Ie(["click"]);var Os=Z('<div class="range-control svelte-1es7ond"><h3 class="control-title svelte-1es7ond">Pitch Range</h3> <!></div>');function Bs(e,t){Me(t,!0);function i(c){const u=Et.findIndex(g=>g.midi===c);return u>=0?u:0}const s=x(()=>i(O.state.yAxisRange.maxMidi)),a=x(()=>i(O.state.yAxisRange.minMidi));function o(c){const u=c.bottomPitch.midi??21,g=c.topPitch.midi??108;O.setYAxisRange({minMidi:u,maxMidi:g})}var r=Os(),l=I(C(r),2);fs(l,{get fullRowData(){return Et},get topIndex(){return n(s)},get bottomIndex(){return n(a)},minSpan:7,onrangechange:o,showSummary:!0,wheelHeight:200}),K(e,r),_e()}var qs=Z('<div class="pitch-highlight-toggle svelte-e7pwl1"><span class="toggle-label svelte-e7pwl1">Pitch Highlight</span> <button> </button></div>');function zs(e,t){Me(t,!0);function i(){O.togglePitchHighlight()}var s=qs(),a=I(C(s),2);let o;a.__click=i;var r=C(a);he(()=>{o=it(a,1,"toggle-button svelte-e7pwl1",null,o,{active:O.state.pitchHighlightEnabled}),$(r,O.state.pitchHighlightEnabled?"On":"Off")}),K(e,s),_e()}Ie(["click"]);var Xs=Z('<button class="start-exercise-btn svelte-118f0cc">Start Demo Exercise</button>'),Gs=Z('<button class="stop-exercise-btn svelte-118f0cc">Stop Exercise</button> <div class="progress-indicator svelte-118f0cc"> </div> <div class="phase-indicator svelte-118f0cc"> </div>',1),Vs=Z('<div><span class="result-loop svelte-118f0cc"></span> <span class="result-pitch svelte-118f0cc"> </span> <span class="result-accuracy svelte-118f0cc"> </span> <span class="result-status svelte-118f0cc"> </span></div>'),Ys=Z('<div class="exercise-results svelte-118f0cc"><h4 class="results-title svelte-118f0cc">Results</h4> <div class="results-summary svelte-118f0cc"><div class="stat svelte-118f0cc"><span class="stat-label svelte-118f0cc">Average Accuracy:</span> <span class="stat-value svelte-118f0cc"> </span></div> <div class="stat svelte-118f0cc"><span class="stat-label svelte-118f0cc">Hits:</span> <span class="stat-value svelte-118f0cc"> </span></div></div> <details class="results-details svelte-118f0cc"><summary class="results-summary-label svelte-118f0cc">Detailed Results</summary> <div class="results-list svelte-118f0cc"></div></details></div>'),Us=Z('<div class="demo-exercise-panel svelte-118f0cc"><h3 class="panel-title svelte-118f0cc">Demo Exercise</h3> <details class="settings-details svelte-118f0cc"><summary class="settings-summary svelte-118f0cc">Settings</summary> <div class="exercise-settings svelte-118f0cc"><label class="setting-label svelte-118f0cc"><span class="label-text svelte-118f0cc">Number of loops:</span> <input class="setting-input svelte-118f0cc" type="number" min="1" max="20"/></label> <label class="setting-label svelte-118f0cc"><span class="label-text svelte-118f0cc">Tempo (BPM):</span> <input class="setting-input svelte-118f0cc" type="number" min="60" max="180"/></label> <label class="setting-label svelte-118f0cc"><span class="label-text svelte-118f0cc">Reference Volume:</span> <input class="setting-slider svelte-118f0cc" type="range" min="-40" max="0"/> <span class="volume-value svelte-118f0cc"> </span></label> <div class="pitch-range-buttons svelte-118f0cc"><button class="range-btn svelte-118f0cc">Use Current Range</button> <button class="range-btn svelte-118f0cc">Use Full Range</button></div></div></details> <div class="exercise-controls svelte-118f0cc"><!></div> <!></div>');function js(e,t){Me(t,!0);let i=z(!1),s=z(5),a=z(108),o=z(-12);const r=x(()=>ce.state.isActive),l=x(()=>ce.state.isPlaying),c=x(()=>ce.state.currentPhase),u=x(()=>ce.getCurrentProgress()),g=x(()=>ce.getResults()),h=x(()=>n(g).length>0),d=x(()=>ce.getAverageAccuracy()),p=x(()=>ce.getHitCount()),m=x(()=>n(g).length);Se(()=>{if(!n(r)||!n(l))return;const H=we.state.currentTimeMs;ce.updatePhase(H)}),Se(()=>{if(!n(r))return;const H=we.getPerformanceResults();ce.getGeneratedNotes().forEach((q,j)=>{if(q.lyric!=="🎤")return;const oe=`target-${j}`,ae=H.get(oe);if(ae&&!ce.hasResultForLoop(Math.floor(j/2))){const re=f(ae);ce.addResult({loopIndex:Math.floor(j/2),targetPitch:q.midi,accuracy:re,performance:ae})}})});function f(H){return H.hitStatus==="hit"?H.pitchAccuracyCents!==void 0?Math.max(0,100-Math.abs(H.pitchAccuracyCents)/50*100):100:0}nt(()=>{n(r)&&_()});function v(){const H=O.state.yAxisRange;ce.setPitchRange(H.minMidi,H.maxMidi)}function y(){ce.setPitchRange(21,108)}async function b(){O.setVisualizationMode("highway"),ce.configure({numLoops:n(s),tempo:n(a),referenceVolume:n(o)}),v(),await Oe.init(),Oe.setVolume(n(o)),ce.start();const H=ce.getGeneratedNotes();we.setTargetNotes(H),we.start(),ce.setPlaying(!0);const q=H.filter(j=>j.lyric==="👂");Oe.scheduleReferenceTones(q)}function _(){Oe.stop(),we.stop(),ce.stop()}function A(H){switch(H){case"reference":return"👂 Listen";case"input":return"🎤 Sing";default:return"Rest"}}function T(H){const q=Ln(H);return q?.combined||`MIDI ${H}`}var w=Us(),P=I(C(w),2),D=I(C(P),2),N=C(D),R=I(C(N),2),X=I(N,2),Y=I(C(X),2),J=I(X,2),Q=I(C(J),2),S=I(Q,2),B=C(S),G=I(J,2),L=C(G);L.__click=v;var ee=I(L,2);ee.__click=y;var ie=I(P,2),de=C(ie);{var fe=H=>{var q=Xs();q.__click=b,K(H,q)},F=H=>{var q=Gs(),j=un(q);j.__click=_;var oe=I(j,2),ae=C(oe),re=I(oe,2),me=C(re);he(M=>{$(ae,`Loop ${n(u).current??""} / ${n(u).total??""}`),$(me,M)},[()=>A(n(c))]),K(H,q)};Te(de,H=>{n(r)?H(F,!1):H(fe)})}var U=I(ie,2);{var se=H=>{var q=Ys(),j=I(C(q),2),oe=C(j),ae=I(C(oe),2),re=C(ae),me=I(oe,2),M=I(C(me),2),k=C(M),E=I(j,2),le=I(C(E),2);st(le,21,()=>n(g),At,(ge,ve,te)=>{var pe=Vs();let V;var Ce=C(pe);Ce.textContent=`Loop ${te+1}:`;var Pe=I(Ce,2),He=C(Pe),Ye=I(Pe,2),ot=C(Ye),at=I(Ye,2),rt=C(at);he((lt,ct)=>{var Ue,je;V=it(pe,1,"result-item svelte-118f0cc",null,V,{hit:((Ue=n(ve).performance)==null?void 0:Ue.hitStatus)==="hit"}),$(He,lt),$(ot,`${ct??""}%`),$(rt,((je=n(ve).performance)==null?void 0:je.hitStatus)==="hit"?"✓":"✗")},[()=>T(n(ve).targetPitch),()=>n(ve).accuracy.toFixed(0)]),K(ge,pe)}),he(ge=>{$(re,`${ge??""}%`),$(k,`${n(p)??""}/${n(m)??""}`)},[()=>n(d).toFixed(1)]),K(H,q)};Te(U,H=>{n(h)&&!n(r)&&H(se)})}he(()=>{R.disabled=n(r),Y.disabled=n(r),Q.disabled=n(r),$(B,`${n(o)??""} dB`),L.disabled=n(r),ee.disabled=n(r)}),ft(R,()=>n(s),H=>W(s,H)),ft(Y,()=>n(a),H=>W(a,H)),ft(Q,()=>n(o),H=>W(o,H)),hn("open","toggle",P,H=>W(i,H),()=>n(i)),K(e,w),_e()}Ie(["click"]);var Ks=Z('<div class="note-display svelte-1hjl33a"><span class="note-name svelte-1hjl33a"> </span> <span class="octave svelte-1hjl33a"> </span></div> <div class="details svelte-1hjl33a"><span class="frequency"> </span> <span> </span> <span class="clarity"> </span></div>',1),Zs=Z('<div class="no-pitch svelte-1hjl33a"><span class="placeholder svelte-1hjl33a">---</span> <span class="hint svelte-1hjl33a">Sing or hum into the microphone</span></div>'),Js=Z('<div class="pitch-readout svelte-1hjl33a"><!></div>');function Qs(e,t){Me(t,!0);const i=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],s=x(()=>()=>{const c=ne.state.currentPitch;if(!c)return null;const u=i[c.pitchClass],g=Math.floor(c.midi/12)-1,h=Math.round((c.midi-Math.round(c.midi))*100);return{name:u,octave:g,frequency:c.frequency.toFixed(1),cents:h,clarity:Math.round(c.clarity*100)}});var a=Js(),o=C(a);{var r=c=>{const u=x(()=>n(s)());var g=Ks(),h=un(g),d=C(h),p=C(d),m=I(d,2),f=C(m),v=I(h,2),y=C(v),b=C(y),_=I(y,2);let A;var T=C(_),w=I(_,2),P=C(w);he(()=>{$(p,n(u).name),$(f,n(u).octave),$(b,`${n(u).frequency??""} Hz`),A=it(_,1,"cents svelte-1hjl33a",null,A,{sharp:n(u).cents>0,flat:n(u).cents<0}),$(T,`${n(u).cents>0?"+":""}${n(u).cents??""}¢`),$(P,`${n(u).clarity??""}%`)}),K(c,g)},l=c=>{var u=Zs();K(c,u)};Te(o,c=>{n(s)()?c(r):c(l,!1)})}K(e,a),_e()}const bt={hasImportedSnapshot:!1,snapshot:null,isLoading:!1,error:null,transpositionSemitones:0};function $s(){let e=z(Fe({...bt}));return{get state(){return n(e)},async checkAndConsumeHandoff(){if(!Hn())return!1;n(e).isLoading=!0,n(e).error=null;try{const t=await Dn();return t?t.schemaVersion!==Lt?(n(e).error=`Incompatible snapshot version: ${t.schemaVersion}. Expected: ${Lt}`,n(e).isLoading=!1,Ke(),!1):(n(e).snapshot=t,n(e).hasImportedSnapshot=!0,n(e).isLoading=!1,Ke(),console.log("[HandoffState] Successfully imported snapshot",{voices:t.voices.length,microbeatCount:t.timeGrid.microbeatCount,tempo:t.tempo}),!0):(n(e).error="Handoff data expired or not found. Please try exporting again.",n(e).isLoading=!1,Ke(),!1)}catch(t){return console.error("[HandoffState] Failed to process handoff",t),n(e).error="Failed to import data from Student Notation.",n(e).isLoading=!1,Ke(),!1}},get voices(){var t;return((t=n(e).snapshot)==null?void 0:t.voices)??[]},get timeGrid(){var t;return((t=n(e).snapshot)==null?void 0:t.timeGrid)??null},get tempo(){var t;return((t=n(e).snapshot)==null?void 0:t.tempo)??90},get suggestedPitchRange(){if(!n(e).snapshot)return null;const t=3,i=n(e).snapshot.minMidiPitch,s=n(e).snapshot.maxMidiPitch;return i===void 0||s===void 0?null:{minMidi:Math.max(21,i-t+n(e).transpositionSemitones),maxMidi:Math.min(108,s+t+n(e).transpositionSemitones)}},setTransposition(t){n(e).transpositionSemitones=t},transposeUp(){n(e).transpositionSemitones+=1},transposeDown(){n(e).transpositionSemitones-=1},getTransposedMidi(t){return t+n(e).transpositionSemitones},async bringBackToStudentNotation(){if(!n(e).snapshot){console.warn("[HandoffState] No snapshot to bring back");return}const t={...n(e).snapshot,sourceApp:"singing-trainer",createdAt:Date.now(),voices:n(e).snapshot.voices.map(i=>({...i,notes:i.notes.map(s=>({...s,midiPitch:s.midiPitch+n(e).transpositionSemitones}))}))};try{const i=await An(t);console.log("[HandoffState] Handoff slot written for return",i),Rn(i)}catch(i){console.error("[HandoffState] Failed to write return handoff",i)}},clearSnapshot(){W(e,{...bt},!0)},reset(){W(e,{...bt},!0)}}}const ye=$s();var eo=Z('<div class="handoff-controls svelte-1n46o8q"><div class="transposition-control svelte-1n46o8q"><button class="transpose-btn svelte-1n46o8q" title="Transpose down">-</button> <span class="transposition-label svelte-1n46o8q"> </span> <button class="transpose-btn svelte-1n46o8q" title="Transpose up">+</button></div> <button class="bring-back-btn svelte-1n46o8q">Bring Back to Student Notation</button></div>'),to=Z('<div class="error-banner svelte-1n46o8q"> </div>'),no=Z('<div class="import-info svelte-1n46o8q"><span class="import-label svelte-1n46o8q">Microbeats:</span> <span class="import-value svelte-1n46o8q"> </span></div>'),io=Z('<div class="control-group svelte-1n46o8q"><h3 class="control-group-title svelte-1n46o8q">Imported Material</h3> <div class="import-info svelte-1n46o8q"><span class="import-label svelte-1n46o8q">Voices:</span> <span class="import-value svelte-1n46o8q"> </span></div> <div class="import-info svelte-1n46o8q"><span class="import-label svelte-1n46o8q">Tempo:</span> <span class="import-value svelte-1n46o8q"> </span></div> <!></div>'),so=Z('<div class="app svelte-1n46o8q"><header class="header svelte-1n46o8q"><h1 class="title svelte-1n46o8q">Singing Trainer</h1> <div class="header-controls svelte-1n46o8q"><!></div></header> <!> <main class="main svelte-1n46o8q"><aside class="sidebar sidebar--left svelte-1n46o8q"><div class="control-group svelte-1n46o8q"><!></div> <div class="control-group svelte-1n46o8q"><!></div> <div class="control-group svelte-1n46o8q"><details class="settings-details svelte-1n46o8q"><summary class="settings-summary svelte-1n46o8q">Settings</summary> <div class="settings-content svelte-1n46o8q"><!> <!> <!></div></details></div> <div class="control-group svelte-1n46o8q"><!></div> <!></aside> <section class="canvas-area svelte-1n46o8q"><!></section></main></div>');function oo(e,t){Me(t,!0);let i=z(!1);an(async()=>{if(await ye.checkAndConsumeHandoff()){console.log("[App] Handoff detected and processed");const L=ye.suggestedPitchRange;L&&O.setYAxisRange(L)}try{await Is(),O.setDetecting(!0),console.log("[App] Pitch detection auto-started")}catch(L){console.error("[App] Failed to auto-start pitch detection:",L)}}),nt(()=>{As()});const s=x(()=>ye.state.hasImportedSnapshot),a=x(()=>ye.state.transpositionSemitones),o=x(()=>ye.state.error);function r(){ye.bringBackToStudentNotation()}function l(){ye.transposeUp()}function c(){ye.transposeDown()}var u=so(),g=C(u),h=I(C(g),2),d=C(h);{var p=L=>{var ee=eo(),ie=C(ee),de=C(ie);de.__click=c;var fe=I(de,2),F=C(fe),U=I(fe,2);U.__click=l;var se=I(ie,2);se.__click=r,he(()=>$(F,`${n(a)>=0?"+":""}${n(a)??""}`)),K(L,ee)};Te(d,L=>{n(s)&&L(p)})}var m=I(g,2);{var f=L=>{var ee=to(),ie=C(ee);he(()=>$(ie,n(o))),K(L,ee)};Te(m,L=>{n(o)&&L(f)})}var v=I(m,2),y=C(v),b=C(y),_=C(b);Qs(_,{});var A=I(b,2),T=C(A);js(T,{});var w=I(A,2),P=C(w),D=I(C(P),2),N=C(D);Ws(N,{});var R=I(N,2);Es(R,{});var X=I(R,2);zs(X,{});var Y=I(w,2),J=C(Y);Bs(J,{});var Q=I(Y,2);{var S=L=>{var ee=io(),ie=I(C(ee),2),de=I(C(ie),2),fe=C(de),F=I(ie,2),U=I(C(F),2),se=C(U),H=I(F,2);{var q=j=>{var oe=no(),ae=I(C(oe),2),re=C(ae);he(()=>$(re,ye.timeGrid.microbeatCount)),K(j,oe)};Te(H,j=>{ye.timeGrid&&j(q)})}he(()=>{$(fe,ye.voices.length),$(se,`${ye.tempo??""} BPM`)}),K(L,ee)};Te(Q,L=>{n(s)&&L(S)})}var B=I(y,2),G=C(B);Cs(G,{}),hn("open","toggle",P,L=>W(i,L),()=>n(i)),K(e,u),_e()}Ie(["click"]);function ao(e){const t=ai(oo,{target:e});return{destroy:()=>ri(t)}}const ro=ao,sn=document.getElementById("app");sn&&ro(sn);
