import"./modulepreload-polyfill-B5Qt9EMX.js";import{S as Ml,G as Ge,L as zs,a as $s,F as ni,C as oi,n as Pt,g as Hs,c as Gn,M as Pl,A as Tl,s as _o,T as et,V as or,b as Il,d as kl,e as Ll,P as Nl,f as Nt,h as ir,D as ii,i as Rl,j as Bl,k as Dl}from"./vendor-tone-Cer4uW5H.js";import{f as se,r as _l,c as Fl,n as xe,s as Wl,a as Ol,b as zl,g as Be,d as qs,z as Gs,D as _t,e as $l,i as Hl,h as ql,o as Ie,j as ke,k as vs,S as Gl,w as Vl,l as Xl,m as Ul,p as Yl}from"./navigation-BnREHJnM.js";import{p as Bi,g as jl,e as Ln,d as Ql,a as Kl,t as Zl,b as Jl,c as Vs,i as tc,f as cn,h as ec,s as Nn,m as si,j as nc}from"./vendor-tonal-NhM_OQIN.js";import{h as oc}from"./vendor-html2canvas-k0ITeQhV.js";import{e as ic,p as ve,h as Tt,i as dn,u as sc,f as bs,c as $e,s as Cn,t as ai,a as ri,j as be,g as nt,k as ft,l as li,d as ye,n as ac,m as rc}from"./legacy-BJBcSenI.js";const lc="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAAAXNSR0IArs4c6QAACC9JREFUeF7tnU9rXFUcQH93Jgm0iVXQrQtFIaAJdSvu9QNY/PMt/Br6BRR1objShXRjSlxLK1QRBXEnqYKplNTWRsR05sqb9KWvw5vJmzb32HFONk0mM+/enHc4eZle7kvb79/M4UdRAsNI8eyfP8cw9YqO48EjkkKX10ChyzOuR1BogLVCA5DvDKHQAGuFBiArNAdZoTnWFhpgrdAAZAvNQVZojrWFBlgrNADZQnOQFZpjbaEB1goNQLbQHGSF5lhbaIC1QgOQLTQHWaE51hYaYK3QAGQLzUEeRIqnb+242g5AbqEByL2c46e1U9EfjZUiolqxW/3b9tH83vjzpr2ueaxpr5tl7Hq+1b+zvK75s7FzVmhI6O8ePXNHaGDABR5CoYGTXxVaoQHQ1e89F/iXB63Q5RnXIyg0wFqhAci+y8FBVmiOtYUGWCs0ANlCc5AVmmNtoQHWCg1AttAcZIXmWFtogLVCA5AtNAdZoTnWFhpgrdAAZAvNQVZojnX64oObuV4bNR/rqQ7hzNOcK6F/OOPiJELr9Nb5/dHuoylHHJndGHn88ebX9eeTntPl8Unjjv/wbWPNy5yHOcdTf6+28iVO8iKNkV6/8Jfb6RY+44PI8dIfp2M4aQl04fEX6fAKDZxthQYg138UWujysBW6PON6BAsNsFZoALKF5iArNMfaQgOsFRqAbKE5yArNsbbQAGuFBiBbaA6yQnOsLTTAWqEByBaag6zQHGsLDbBWaACyheYgKzTH2kIDrCuhX7xxKgaNxUnTVhlW32v7aFsNOWn6sx6jy6rHeZizQgNCL+UUF9auxHK+e/P649aet01rlsV6k5ZQdtnzdBKSeZizQgNC93OKrbWdWIq7QgPDLuQQCg2cdoUGIPtHIQdZoTnWFhpgrdAAZAvNQVZojrWFBlgrNADZQnOQFZpjbaEB1goNQLbQHGSF5lhbaIC1QgOQLTQHWaE51hYaYK3QAGQLzUFWaI51enX7+mhh1v3ckbl+zaQ7S3d5vOvdrNvGmpc5V0J/eXrXxUmA1+mFi1tu1lgc9CB+PViPlIbFR1r0AdLGpfMKXdiCFIP47Z9NhS7MuTq8QhOQFRqgfDiEQgOoLTQAuX6Xw0uO8rAVujzjegQLDbBWaACyhQYhew2NwbbQAGoLDUC20CBkC43BttAAagsNQLbQIGQLjcG20ABqCw1AttAgZAuNwbbQAGoLDUC20CDkUaE3oudqu+LQLXRxxBGDSLF+cC1ySpGj3v+zuchx2mNtE6xf29xLtO2x8dceN2b1/OqYzZXm458f/SfznU/ajvnfzVmhAaFvRy9eObgcg9QHRlvsIRQaOP8KDUD2GpqDrNAcawsNsFZoALKF5iArNMfaQgOsFRqAbKE5yArNsbbQAGuFBiBbaA6yQnOsLTTAWqEByBaag6zQHGsLDbBWaACyheYgKzTHOp299Pk9e9vNw/2cx/E87HM+iF68fPBt3HZxUnGz00fbb9wjdL14sG3kaTc+7zrTWY8xbT71mA/7nPt5EBdXN6Mf7j7a1ZP7fV76ZPs1dx+9X3odX9fLg/hq9axCd+T1IE9T6Aeh1/G1Ct0R1Ak8TaFPAOJxh1Do4wid3PcV+uRYTjySQgOQ67ftvIYuD1uhyzM+eoNAocvDVujyjBWaYxwKzcH2GhpgrdAAZK+hOcgKzbG20ABrhQYgW2gOskJzrC00wFqhAcgWmoOs0BxrCw2wrlbbfX16w8VJAGuFBiAPUopnblyPYaoXzx634LW5k+j47p5dFkeOH7/59SxjV3AmzaUJbtrxuywAro51MnNWaEjozb3dGKYeMNpiD6HQwPmvCq3QAOiq867lKA9aocszdi0HxzgUmoNtoQHWCg1A9n1oDrJCc6wtNMBaoQHIFpqDrNAcawsNsFZoALKF5iArNMfaQgOsFRqAbKE5yArNsbbQAGuFBiDXhf50y73tSuMepIj1G1ddnFQadLWWY+fDc/noXuXjKxOPu8/6+Fais9xTfdI90asfum3F4aR7qs/BnFNOcfWx36OXXW1X2um0+965LgtsS8/jf338NExx5QmFJk6yQgOUFRqAXF9DW+jysBW6PON6BAsNsFZoALKFBiF7DY3BttAAagsNQLbQIGQLjcG20ABqCw1AttAgZAuNwbbQAGoLDUC20CBkC43BttAAagsNQLbQIGQLjcG20ADqqtC/PH4tennSnc6BSSzIEAoNnOgcw1jbfy4iefP60rgVujTh0Ya0w3jk1vMKDbBWaACyQgOQ/aOQg6zQHGsLDbBWaACyheYgKzTH2kIDrBUagGyhOcgKzbG20ABrhQYgW2gOskJzrC00wFqhAcgWmoOs0BxrCw2wVmgAsoXmICs0xzrtvvtmPryf87QdEpsTau7gWGK3xrYdIqvxZ9mtcdoOjvycR0Lvr7s4CfA67b3zsZs1Fgfdi5X+jxHRLz7Sog+Qrr/9mUIXtiDnXqwsf6PQhTmPfo8rdHnKCl2ecT2CQgOsFRqAXL/LYaHLw1bo8owtNMc4FJqD7SUHwFqhAchecnCQFZpjbaEB1goNQLbQHGSF5lhbaIC1QgOQLTQHWaE51hYaYK3QAGQLzUFWaI61hQZYV0IvLX/v4iSAtUITkPMw9laejBTuPloat0KXJlwtacyDuLqyGT2FLk5boYsjVmgA8dEQCg3QttAAZN/lACF7yYHBttAAagsNQLbQIGQLjcG20ABqCw1AttAgZAuNwbbQAGoLDUC20CBkC43BttAAagsNQLbQIGQLjcG20ABqCw1AttAgZAuNwf4X8h6Lm5rywjsAAAAASUVORK5CYII=",cc="/music-learning-tools/assets/clear-BoKs1BI5.svg",dc="data:image/svg+xml,%3csvg%20class='diamond-icon'%20viewBox='0%200%20120%20120'%20aria-hidden='true'%20focusable='false'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M60%205%20L35%2048.3%20L35%2071.7%20L60%20115%20L85%2071.7%20L85%2048.3%20Z'%20/%3e%3c/svg%3e",uc="/music-learning-tools/assets/eraser-vjnwKGf-.svg",hc="data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20fill='none'%20stroke='currentColor'%20stroke-width='2'%20stroke-dasharray='3%202'%20xmlns='http://www.w3.org/2000/svg'%3e%3cellipse%20cx='12'%20cy='12'%20rx='8'%20ry='6'%20transform='rotate(-15%2012%2012)'/%3e%3c/svg%3e",mc="/music-learning-tools/assets/loop-DCKCNdJ9.svg",fc="data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20fill='none'%20stroke='currentColor'%20stroke-width='2'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M18%202L6%2014l-2%206%206-2L22%206l-4-4z'/%3e%3cline%20x1='14'%20y1='6'%20x2='18'%20y2='10'/%3e%3c/svg%3e",pc="/music-learning-tools/assets/pause-BvM7-xog.svg",gc="/music-learning-tools/assets/play-z9TE0FgS.svg",vc="/music-learning-tools/assets/redo-C3TqBHBd.svg",bc="/music-learning-tools/assets/settings-TJsqx0gz.svg",yc="/music-learning-tools/assets/stop-BU_KSLYe.svg",wc="/music-learning-tools/assets/undo-D1s0pqx2.svg",Sc="/music-learning-tools/assets/volume-BF7HNWqG.svg",Cc="/music-learning-tools/assets/zoomIn-CqIKlW7B.svg",Ac="/music-learning-tools/assets/zoomOut-Cm9mM1qf.svg",xc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%20fill='none'%20stroke='currentColor'%20stroke-width='2'%20stroke-linecap='round'%20stroke-linejoin='round'%3e%3c!--%20Grid%20pattern%20--%3e%3cline%20x1='3'%20y1='3'%20x2='3'%20y2='21'%20/%3e%3cline%20x1='9'%20y1='3'%20x2='9'%20y2='21'%20/%3e%3cline%20x1='15'%20y1='3'%20x2='15'%20y2='21'%20/%3e%3cline%20x1='21'%20y1='3'%20x2='21'%20y2='21'%20/%3e%3cline%20x1='3'%20y1='6'%20x2='21'%20y2='6'%20/%3e%3cline%20x1='3'%20y1='12'%20x2='21'%20y2='12'%20/%3e%3cline%20x1='3'%20y1='18'%20x2='21'%20y2='18'%20/%3e%3c!--%20Eye%20with%20slash%20(hide)%20--%3e%3cpath%20d='M1%201%20L23%2023'%20stroke-width='2.5'/%3e%3c/svg%3e",Ec="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%20fill='none'%20stroke='currentColor'%20stroke-width='2'%20stroke-linecap='round'%20stroke-linejoin='round'%3e%3c!--%20Drum%20pattern%20--%3e%3cellipse%20cx='12'%20cy='7'%20rx='7'%20ry='3'/%3e%3cpath%20d='M%205%207%20L%205%2017%20Q%205%2020%2012%2020%20Q%2019%2020%2019%2017%20L%2019%207'/%3e%3cline%20x1='8'%20y1='10'%20x2='8'%20y2='16'/%3e%3cline%20x1='16'%20y1='10'%20x2='16'%20y2='16'/%3e%3c!--%20Slash%20(hide)%20--%3e%3cpath%20d='M2%202%20L22%2022'%20stroke-width='2.5'/%3e%3c/svg%3e",Mc="/music-learning-tools/assets/newPage-C3DkqRnq.svg",Pc="/music-learning-tools/assets/open-yWU2irvQ.svg",Tc="/music-learning-tools/assets/print-y0OmDKSR.svg",Ic="/music-learning-tools/assets/saveAs-DyEXJ3e_.svg",kc="/music-learning-tools/assets/dottedQuarterNote-Cf79kpGq.svg",Lc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='168'%20zoomAndPan='magnify'%20viewBox='0%200%20126%20231.75'%20height='309'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='f11b48ab54'%3e%3cpath%20d='M%200.0664062%200%20L%20125%200%20L%20125%20230.75%20L%200.0664062%20230.75%20Z%20M%200.0664062%200%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='9738701237'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23f11b48ab54)'%3e%3cpath%20style='%20stroke:none;fill-rule:nonzero;fill:%23000000;fill-opacity:1;'%20d='M%208.109375%20225.367188%20C%20-6.25%20212.289062%201.699219%20191.523438%2025.289062%20179.214844%20C%2033.234375%20175.371094%2039.132812%20173.574219%2049.386719%20173.832031%20C%2055.796875%20174.089844%2062.976562%20177.679688%2062.976562%20177.679688%20C%2062.976562%20131.273438%2062.71875%2043.585938%2062.71875%200.511719%20C%2065.285156%200.511719%2067.078125%200.257812%2070.667969%200.257812%20C%2070.667969%202.820312%2070.667969%204.871094%2070.667969%206.921875%20C%2070.667969%209.230469%2070.667969%2010.511719%2070.925781%2012.050781%20C%2073.488281%2028.203125%2077.078125%2034.613281%2095.023438%2054.355469%20C%20117.84375%2079.738281%20124.511719%2094.863281%20124.511719%20115.121094%20C%20124.253906%20134.09375%20107.589844%20174.601562%20104%20173.0625%20C%20109.125%20158.707031%20116.304688%20143.320312%20118.101562%20130.503906%20C%20120.40625%20114.863281%20114%2092.8125%20103.742188%2081.277344%20C%2095.539062%2071.53125%2076.050781%2063.070312%2070.667969%2063.070312%20C%2070.667969%2063.070312%2070.410156%20156.398438%2070.410156%20191.78125%20C%2070.410156%20197.675781%2065.027344%20208.1875%2061.949219%20211.777344%20C%2047.847656%20228.699219%2020.414062%20236.390625%208.109375%20225.367188%20Z%20M%208.109375%20225.367188%20'/%3e%3c/g%3e%3c/g%3e%3c/svg%3e",Nc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%3e%3ccircle%20cx='12'%20cy='12'%20r='10'%20stroke='currentColor'%20stroke-width='1.5'%20fill='none'/%3e%3cpath%20d='M%2012%2012%20L%2022%2012%20A%2010%2010%200%200%200%2012%202%20Z'%20fill='currentColor'/%3e%3c/svg%3e",Rc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%3e%3ccircle%20cx='12'%20cy='12'%20r='10'%20stroke='currentColor'%20stroke-width='1.5'%20fill='none'/%3e%3cpath%20d='M%2012%2012%20L%2022%2012%20A%2010%2010%200%200%200%2012%202%20Z'%20fill='currentColor'%20transform='rotate(180,%2012,%2012)'/%3e%3c/svg%3e",Bc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%3e%3ccircle%20cx='12'%20cy='12'%20r='10'%20stroke='currentColor'%20stroke-width='1.5'%20fill='none'/%3e%3cpath%20d='M%2012%2012%20L%2022%2012%20A%2010%2010%200%200%200%2012%202%20Z'%20fill='currentColor'%20transform='rotate(270,%2012,%2012)'/%3e%3c/svg%3e",Dc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%3e%3ccircle%20cx='12'%20cy='12'%20r='10'%20stroke='currentColor'%20stroke-width='1.5'%20fill='none'/%3e%3cpath%20d='M%2012%2012%20L%2022%2012%20A%2010%2010%200%200%200%2012%202%20Z'%20fill='currentColor'%20transform='rotate(90,%2012,%2012)'/%3e%3c/svg%3e",_c="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='111'%20zoomAndPan='magnify'%20viewBox='0%200%2083.25%20230.999992'%20height='308'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='084e4edff4'%3e%3cpath%20d='M%201%20165%20L%2081.761719%20165%20L%2081.761719%20229.226562%20L%201%20229.226562%20Z%20M%201%20165%20'/%3e%3c/clipPath%3e%3cclipPath%20id='fdeab4882e'%3e%3cpath%20d='M%2073%201.03125%20L%2081.761719%201.03125%20L%2081.761719%20192%20L%2073%20192%20Z%20M%2073%201.03125%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='45713f1632'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23084e4edff4)'%3e%3cpath%20style='%20stroke:none;fill-rule:evenodd;fill:%23000000;fill-opacity:0.9;'%20d='M%2057.546875%20222.390625%20C%2076.429688%20212.289062%2086.492188%20194.003906%2080.304688%20180.25%20C%2073.699219%20165.578125%2051.011719%20161.4375%2029.660156%20171.003906%20C%208.308594%20180.574219%20-3.664062%20200.25%202.9375%20214.921875%20C%209.542969%20229.59375%2032.230469%20233.734375%2053.582031%20224.164062%20C%2054.917969%20223.566406%2056.285156%20223.0625%2057.546875%20222.390625%20Z%20M%2057.546875%20222.390625%20'/%3e%3c/g%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23fdeab4882e)'%3e%3cpath%20style='fill:none;stroke-width:1.5;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%20299.504676%20305.984569%20L%20299.504676%20339.572267%20'%20transform='matrix(-5.561147,0,0,-5.549953,1743.335656,1885.43835)'/%3e%3c/g%3e%3c/g%3e%3c/svg%3e",Fc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='456e80bb30'%3e%3cpath%20d='M%2017.898438%2024.675781%20L%20111.859375%2024.675781%20L%20111.859375%20118.640625%20L%2017.898438%20118.640625%20Z%20M%2017.898438%2024.675781%20'/%3e%3c/clipPath%3e%3cclipPath%20id='87c9148330'%3e%3cpath%20d='M%2064.878906%2024.675781%20C%2038.933594%2024.675781%2017.898438%2045.710938%2017.898438%2071.660156%20C%2017.898438%2097.605469%2038.933594%20118.640625%2064.878906%20118.640625%20C%2090.828125%20118.640625%20111.859375%2097.605469%20111.859375%2071.660156%20C%20111.859375%2045.710938%2090.828125%2024.675781%2064.878906%2024.675781%20Z%20M%2064.878906%2024.675781%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='d7032f28cc'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23456e80bb30)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%2387c9148330)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%20-0.00202662%20C%2028.250074%20-0.00202662%200.0009548%2028.247092%200.0009548%2063.095541%20C%200.0009548%2097.938745%2028.250074%20126.187864%2063.093277%20126.187864%20C%2097.941726%20126.187864%20126.185599%2097.938745%20126.185599%2063.095541%20C%20126.185599%2028.247092%2097.941726%20-0.00202662%2063.093277%20-0.00202662%20Z%20M%2063.093277%20-0.00202662%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.67729)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(44.895794,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%2017.8125%200%20L%2017.8125%20-40.09375%20L%204.203125%20-40.09375%20L%204.203125%20-51.09375%20C%207.367188%20-51.09375%209.992188%20-51.253906%2012.078125%20-51.578125%20C%2014.171875%20-51.910156%2015.914062%20-52.6875%2017.3125%20-53.90625%20C%2018.71875%20-55.132812%2019.957031%20-57.09375%2021.03125%20-59.78125%20L%2031.3125%20-59.78125%20L%2031.3125%200%20Z%20M%2017.8125%200%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",Wc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='af2f53afe5'%3e%3cpath%20d='M%2017.898438%2024.566406%20L%20111.859375%2024.566406%20L%20111.859375%20118.527344%20L%2017.898438%20118.527344%20Z%20M%2017.898438%2024.566406%20'/%3e%3c/clipPath%3e%3cclipPath%20id='c8dd529e93'%3e%3cpath%20d='M%2064.878906%2024.566406%20C%2038.933594%2024.566406%2017.898438%2045.601562%2017.898438%2071.546875%20C%2017.898438%2097.496094%2038.933594%20118.527344%2064.878906%20118.527344%20C%2090.828125%20118.527344%20111.859375%2097.496094%20111.859375%2071.546875%20C%20111.859375%2045.601562%2090.828125%2024.566406%2064.878906%2024.566406%20Z%20M%2064.878906%2024.566406%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='4829c2bf70'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23af2f53afe5)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23c8dd529e93)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%200.00130943%20C%2028.250074%200.00130943%200.0009548%2028.250428%200.0009548%2063.093632%20C%200.0009548%2097.942081%2028.250074%20126.185954%2063.093277%20126.185954%20C%2097.941726%20126.185954%20126.185599%2097.942081%20126.185599%2063.093632%20C%20126.185599%2028.250428%2097.941726%200.00130943%2063.093277%200.00130943%20Z%20M%2063.093277%200.00130943%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.565431)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(38.720147,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%203.046875%200%20L%203.046875%20-11.1875%20C%2010.921875%20-16.726562%2017.179688%20-21.421875%2021.828125%20-25.265625%20C%2026.484375%20-29.117188%2029.835938%20-32.507812%2031.890625%20-35.4375%20C%2033.953125%20-38.363281%2034.984375%20-41.109375%2034.984375%20-43.671875%20C%2034.984375%20-45.992188%2034.160156%20-47.75%2032.515625%20-48.9375%20C%2030.878906%20-50.132812%2028.957031%20-50.734375%2026.75%20-50.734375%20C%2024.90625%20-50.734375%2023.085938%20-50.210938%2021.296875%20-49.171875%20C%2019.503906%20-48.128906%2018.28125%20-46.207031%2017.625%20-43.40625%20L%205.28125%20-47.875%20C%206.894531%20-52.050781%209.664062%20-55.253906%2013.59375%20-57.484375%20C%2017.53125%20-59.722656%2022.125%20-60.84375%2027.375%20-60.84375%20C%2031.4375%20-60.84375%2035.078125%20-60.171875%2038.296875%20-58.828125%20C%2041.515625%20-57.492188%2044.046875%20-55.523438%2045.890625%20-52.921875%20C%2047.742188%20-50.328125%2048.671875%20-47.15625%2048.671875%20-43.40625%20C%2048.671875%20-37.375%2046.148438%20-31.773438%2041.109375%20-26.609375%20C%2036.078125%20-21.453125%2029.175781%20-16.3125%2020.40625%20-11.1875%20L%2048.953125%20-11.1875%20L%2048.953125%200%20Z%20M%203.046875%200%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",Oc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='0551ece328'%3e%3cpath%20d='M%2017.898438%2024.675781%20L%20111.859375%2024.675781%20L%20111.859375%20118.640625%20L%2017.898438%20118.640625%20Z%20M%2017.898438%2024.675781%20'/%3e%3c/clipPath%3e%3cclipPath%20id='073daee785'%3e%3cpath%20d='M%2064.878906%2024.675781%20C%2038.933594%2024.675781%2017.898438%2045.710938%2017.898438%2071.660156%20C%2017.898438%2097.605469%2038.933594%20118.640625%2064.878906%20118.640625%20C%2090.828125%20118.640625%20111.859375%2097.605469%20111.859375%2071.660156%20C%20111.859375%2045.710938%2090.828125%2024.675781%2064.878906%2024.675781%20Z%20M%2064.878906%2024.675781%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='04a7d7f831'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%230551ece328)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23073daee785)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%20-0.00202662%20C%2028.250074%20-0.00202662%200.0009548%2028.247092%200.0009548%2063.095541%20C%200.0009548%2097.938745%2028.250074%20126.187864%2063.093277%20126.187864%20C%2097.941726%20126.187864%20126.185599%2097.938745%20126.185599%2063.095541%20C%20126.185599%2028.247092%2097.941726%20-0.00202662%2063.093277%20-0.00202662%20Z%20M%2063.093277%20-0.00202662%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.67729)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(37.869539,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%2026.046875%201.078125%20C%2022.703125%201.078125%2019.492188%200.597656%2016.421875%20-0.359375%20C%2013.347656%20-1.316406%2010.644531%20-2.789062%208.3125%20-4.78125%20C%205.988281%20-6.78125%204.203125%20-9.363281%202.953125%20-12.53125%20L%2015.296875%20-17%20C%2016.078125%20-14.082031%2017.507812%20-12.023438%2019.59375%20-10.828125%20C%2021.6875%20-9.628906%2023.953125%20-9.03125%2026.390625%20-9.03125%20C%2029.203125%20-9.03125%2031.441406%20-9.71875%2033.109375%20-11.09375%20C%2034.773438%20-12.46875%2035.609375%20-14.378906%2035.609375%20-16.828125%20C%2035.609375%20-19.265625%2034.832031%20-21.15625%2033.28125%20-22.5%20C%2031.738281%20-23.84375%2029.695312%20-24.769531%2027.15625%20-25.28125%20C%2024.625%20-25.789062%2021.863281%20-26.046875%2018.875%20-26.046875%20L%2018.875%20-35.53125%20C%2024.007812%20-35.53125%2027.960938%20-36.242188%2030.734375%20-37.671875%20C%2033.515625%20-39.109375%2034.90625%20-41.140625%2034.90625%20-43.765625%20C%2034.90625%20-46.085938%2033.960938%20-47.828125%2032.078125%20-48.984375%20C%2030.203125%20-50.148438%2028.039062%20-50.734375%2025.59375%20-50.734375%20C%2023.382812%20-50.734375%2021.351562%20-50.195312%2019.5%20-49.125%20C%2017.65625%20-48.050781%2016.4375%20-46.144531%2015.84375%20-43.40625%20L%203.578125%20-47.875%20C%204.773438%20-50.914062%206.535156%20-53.390625%208.859375%20-55.296875%20C%2011.179688%20-57.210938%2013.863281%20-58.613281%2016.90625%20-59.5%20C%2019.945312%20-60.394531%2023.109375%20-60.84375%2026.390625%20-60.84375%20C%2029.140625%20-60.84375%2031.828125%20-60.546875%2034.453125%20-59.953125%20C%2037.078125%20-59.359375%2039.445312%20-58.421875%2041.5625%20-57.140625%20C%2043.6875%20-55.859375%2045.390625%20-54.242188%2046.671875%20-52.296875%20C%2047.953125%20-50.359375%2048.59375%20-48.050781%2048.59375%20-45.375%20C%2048.59375%20-42.144531%2047.726562%20-39.320312%2046%20-36.90625%20C%2044.269531%20-34.488281%2042.359375%20-32.6875%2040.265625%20-31.5%20C%2042.234375%20-30.78125%2043.914062%20-29.644531%2045.3125%20-28.09375%20C%2046.71875%20-26.539062%2047.78125%20-24.835938%2048.5%20-22.984375%20C%2049.21875%20-21.140625%2049.578125%20-19.296875%2049.578125%20-17.453125%20C%2049.578125%20-13.273438%2048.472656%20-9.828125%2046.265625%20-7.109375%20C%2044.054688%20-4.398438%2041.160156%20-2.359375%2037.578125%20-0.984375%20C%2034.003906%200.390625%2030.160156%201.078125%2026.046875%201.078125%20Z%20M%2026.046875%201.078125%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",zc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='0f524ef70a'%3e%3cpath%20d='M%2017.898438%2024.675781%20L%20111.859375%2024.675781%20L%20111.859375%20118.640625%20L%2017.898438%20118.640625%20Z%20M%2017.898438%2024.675781%20'/%3e%3c/clipPath%3e%3cclipPath%20id='786a2dceed'%3e%3cpath%20d='M%2064.878906%2024.675781%20C%2038.933594%2024.675781%2017.898438%2045.710938%2017.898438%2071.660156%20C%2017.898438%2097.605469%2038.933594%20118.640625%2064.878906%20118.640625%20C%2090.828125%20118.640625%20111.859375%2097.605469%20111.859375%2071.660156%20C%20111.859375%2045.710938%2090.828125%2024.675781%2064.878906%2024.675781%20Z%20M%2064.878906%2024.675781%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='1bb9b822db'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%230f524ef70a)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23786a2dceed)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%20-0.00202662%20C%2028.250074%20-0.00202662%200.0009548%2028.247092%200.0009548%2063.095541%20C%200.0009548%2097.938745%2028.250074%20126.187864%2063.093277%20126.187864%20C%2097.941726%20126.187864%20126.185599%2097.938745%20126.185599%2063.095541%20C%20126.185599%2028.247092%2097.941726%20-0.00202662%2063.093277%20-0.00202662%20Z%20M%2063.093277%20-0.00202662%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.67729)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(36.937365,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%2031.140625%200%20L%2031.140625%20-12.625%20L%202.0625%20-12.625%20L%202.0625%20-22.546875%20L%2031.140625%20-59.78125%20L%2044.75%20-59.78125%20L%2044.75%20-24.609375%20L%2052.96875%20-24.609375%20L%2052.96875%20-12.625%20L%2044.75%20-12.625%20L%2044.75%200%20Z%20M%2016.828125%20-24.609375%20L%2031.140625%20-24.609375%20L%2031.140625%20-41.96875%20Z%20M%2016.828125%20-24.609375%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",$c="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='0d82974cc8'%3e%3cpath%20d='M%2017.898438%2024.789062%20L%20111.859375%2024.789062%20L%20111.859375%20118.753906%20L%2017.898438%20118.753906%20Z%20M%2017.898438%2024.789062%20'/%3e%3c/clipPath%3e%3cclipPath%20id='37694f020a'%3e%3cpath%20d='M%2064.878906%2024.789062%20C%2038.933594%2024.789062%2017.898438%2045.824219%2017.898438%2071.769531%20C%2017.898438%2097.71875%2038.933594%20118.753906%2064.878906%20118.753906%20C%2090.828125%20118.753906%20111.859375%2097.71875%20111.859375%2071.769531%20C%20111.859375%2045.824219%2090.828125%2024.789062%2064.878906%2024.789062%20Z%20M%2064.878906%2024.789062%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='22003a5ccc'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%230d82974cc8)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%2337694f020a)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%20-0.000119013%20C%2028.250074%20-0.000119013%200.0009548%2028.249%200.0009548%2063.092203%20C%200.0009548%2097.940652%2028.250074%20126.189771%2063.093277%20126.189771%20C%2097.941726%20126.189771%20126.185599%2097.940652%20126.185599%2063.092203%20C%20126.185599%2028.249%2097.941726%20-0.000119013%2063.093277%20-0.000119013%20Z%20M%2063.093277%20-0.000119013%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.789151)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(37.55493,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%2026.390625%201.078125%20C%2021.203125%201.078125%2016.59375%20-0.0664062%2012.5625%20-2.359375%20C%208.539062%20-4.660156%205.578125%20-8.019531%203.671875%20-12.4375%20L%2015.484375%20-16.734375%20C%2016.316406%20-13.804688%2017.671875%20-11.789062%2019.546875%20-10.6875%20C%2021.429688%20-9.582031%2023.476562%20-9.03125%2025.6875%20-9.03125%20C%2028.84375%20-9.03125%2031.4375%20-9.957031%2033.46875%20-11.8125%20C%2035.5%20-13.664062%2036.515625%20-16.320312%2036.515625%20-19.78125%20C%2036.515625%20-23.476562%2035.453125%20-26.191406%2033.328125%20-27.921875%20C%2031.210938%20-29.648438%2028.753906%20-30.515625%2025.953125%20-30.515625%20C%2021.535156%20-30.515625%2018.253906%20-28.578125%2016.109375%20-24.703125%20L%204.03125%20-29.171875%20L%207.78125%20-59.78125%20L%2047.78125%20-59.78125%20L%2047.78125%20-48.671875%20L%2019.0625%20-48.671875%20L%2017.71875%20-37.5%20C%2019.09375%20-38.507812%2020.894531%20-39.28125%2023.125%20-39.8125%20C%2025.363281%20-40.351562%2027.53125%20-40.625%2029.625%20-40.625%20C%2033.195312%20-40.625%2036.578125%20-39.847656%2039.765625%20-38.296875%20C%2042.960938%20-36.742188%2045.5625%20-34.429688%2047.5625%20-31.359375%20C%2049.5625%20-28.285156%2050.5625%20-24.425781%2050.5625%20-19.78125%20C%2050.5625%20-15.238281%2049.441406%20-11.414062%2047.203125%20-8.3125%20C%2044.960938%20-5.21875%2042.007812%20-2.878906%2038.34375%20-1.296875%20C%2034.675781%200.285156%2030.691406%201.078125%2026.390625%201.078125%20Z%20M%2026.390625%201.078125%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",Hc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='2a134d5da5'%3e%3cpath%20d='M%2017.898438%2024.675781%20L%20111.859375%2024.675781%20L%20111.859375%20118.640625%20L%2017.898438%20118.640625%20Z%20M%2017.898438%2024.675781%20'/%3e%3c/clipPath%3e%3cclipPath%20id='1436cb12ac'%3e%3cpath%20d='M%2064.878906%2024.675781%20C%2038.933594%2024.675781%2017.898438%2045.710938%2017.898438%2071.660156%20C%2017.898438%2097.605469%2038.933594%20118.640625%2064.878906%20118.640625%20C%2090.828125%20118.640625%20111.859375%2097.605469%20111.859375%2071.660156%20C%20111.859375%2045.710938%2090.828125%2024.675781%2064.878906%2024.675781%20Z%20M%2064.878906%2024.675781%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='0d388df51e'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%232a134d5da5)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%231436cb12ac)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%20-0.00202662%20C%2028.250074%20-0.00202662%200.0009548%2028.247092%200.0009548%2063.095541%20C%200.0009548%2097.938745%2028.250074%20126.187864%2063.093277%20126.187864%20C%2097.941726%20126.187864%20126.185599%2097.938745%20126.185599%2063.095541%20C%20126.185599%2028.247092%2097.941726%20-0.00202662%2063.093277%20-0.00202662%20Z%20M%2063.093277%20-0.00202662%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.67729)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(36.669365,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%2028.71875%201.078125%20C%2023%201.078125%2018.363281%20-0.113281%2014.8125%20-2.5%20C%2011.257812%20-4.882812%208.660156%20-8.222656%207.015625%20-12.515625%20C%205.378906%20-16.816406%204.5625%20-21.769531%204.5625%20-27.375%20C%204.5625%20-31.675781%205.035156%20-35.820312%205.984375%20-39.8125%20C%206.941406%20-43.8125%208.453125%20-47.390625%2010.515625%20-50.546875%20C%2012.578125%20-53.710938%2015.242188%20-56.21875%2018.515625%20-58.0625%20C%2021.796875%20-59.914062%2025.765625%20-60.84375%2030.421875%20-60.84375%20C%2034.953125%20-60.84375%2038.738281%20-60.050781%2041.78125%20-58.46875%20C%2044.832031%20-56.894531%2047.128906%20-54.796875%2048.671875%20-52.171875%20L%2036.515625%20-47.78125%20C%2035.910156%20-48.800781%2034.984375%20-49.59375%2033.734375%20-50.15625%20C%2032.484375%20-50.71875%2031.082031%20-51%2029.53125%20-51%20C%2026.363281%20-51%2023.78125%20-49.789062%2021.78125%20-47.375%20C%2019.789062%20-44.96875%2018.796875%20-41.195312%2018.796875%20-36.0625%20C%2020.285156%20-37.4375%2022.054688%20-38.507812%2024.109375%20-39.28125%20C%2026.171875%20-40.0625%2028.664062%20-40.453125%2031.59375%20-40.453125%20C%2035.113281%20-40.453125%2038.40625%20-39.628906%2041.46875%20-37.984375%20C%2044.539062%20-36.347656%2047.015625%20-34.019531%2048.890625%20-31%20C%2050.773438%20-27.988281%2051.71875%20-24.425781%2051.71875%20-20.3125%20C%2051.71875%20-16.195312%2050.734375%20-12.523438%2048.765625%20-9.296875%20C%2046.796875%20-6.078125%2044.082031%20-3.539062%2040.625%20-1.6875%20C%2037.164062%200.15625%2033.195312%201.078125%2028.71875%201.078125%20Z%20M%2028.640625%20-9.03125%20C%2031.554688%20-9.03125%2033.847656%20-10%2035.515625%20-11.9375%20C%2037.191406%20-13.882812%2038.03125%20-16.4375%2038.03125%20-19.59375%20C%2038.03125%20-22.757812%2037.191406%20-25.328125%2035.515625%20-27.296875%20C%2033.847656%20-29.265625%2031.523438%20-30.25%2028.546875%20-30.25%20C%2025.679688%20-30.25%2023.367188%20-29.289062%2021.609375%20-27.375%20C%2019.847656%20-25.46875%2018.96875%20-22.90625%2018.96875%20-19.6875%20C%2018.96875%20-16.46875%2019.847656%20-13.882812%2021.609375%20-11.9375%20C%2023.367188%20-10%2025.710938%20-9.03125%2028.640625%20-9.03125%20Z%20M%2028.640625%20-9.03125%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",qc="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='d5d49c9923'%3e%3cpath%20d='M%2017.898438%2024.675781%20L%20111.859375%2024.675781%20L%20111.859375%20118.640625%20L%2017.898438%20118.640625%20Z%20M%2017.898438%2024.675781%20'/%3e%3c/clipPath%3e%3cclipPath%20id='0ef729529e'%3e%3cpath%20d='M%2064.878906%2024.675781%20C%2038.933594%2024.675781%2017.898438%2045.710938%2017.898438%2071.660156%20C%2017.898438%2097.605469%2038.933594%20118.640625%2064.878906%20118.640625%20C%2090.828125%20118.640625%20111.859375%2097.605469%20111.859375%2071.660156%20C%20111.859375%2045.710938%2090.828125%2024.675781%2064.878906%2024.675781%20Z%20M%2064.878906%2024.675781%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='926e811c6f'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23d5d49c9923)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%230ef729529e)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%20-0.00202662%20C%2028.250074%20-0.00202662%200.0009548%2028.247092%200.0009548%2063.095541%20C%200.0009548%2097.938745%2028.250074%20126.187864%2063.093277%20126.187864%20C%2097.941726%20126.187864%20126.185599%2097.938745%20126.185599%2063.095541%20C%20126.185599%2028.247092%2097.941726%20-0.00202662%2063.093277%20-0.00202662%20Z%20M%2063.093277%20-0.00202662%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.67729)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(40.642754,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%207.421875%200%20L%2031.671875%20-48.59375%20L%201.34375%20-48.59375%20L%201.34375%20-59.78125%20L%2046.078125%20-59.78125%20L%2046.078125%20-48.59375%20L%2023.09375%200%20Z%20M%207.421875%200%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",Gc="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAYAAADimHc4AAAAAXNSR0IArs4c6QAABFNJREFUeF7tnU1rFEEQhqvBrOQbveshCupiUG/iSfwNfgRP/h7Be0RBEG8q6EExAQ+5SMRLFBWPEjeiyWqCaxQSoaXdDNszzi61U907U8u7t52pqp59n+nu6o+ZNYu3flhS+rFkaab1icgo/QFEZACgXHgAUK7+qAEl6w8AACBQAJ2wQLwQrgAQQkVBDJc/H9puEBlGHmotz05wPUVcVWdBRJZWR2tFfndlfHQDsJbeTU9VRswiF6IewNvpKc0DYd1pKFlLAFCk3oXyAYBQShaMAwAFhQvlNgwAHt5JT0e7jDo7P513LE/DxK5XjH5j+eVkfY0l+jg+qbsTvvbkV0fvPAX9Y74azit7zj/GJSSI70bCp1tjutcD5p55AEI1DQOK4wCc3QKAAcn9fzEAUJr07YIBAADEChj0AWINRQEAQCSf3Fk9gNmWNx3NWBbY6zzCp65JCs5h4tmqBuAGYkvja2QUD8VUA3BD9ucTDcXyEwEAp8mIaAMAEcXlhAYAjkoRbQAgoric0ADAUSmijbm4sKV2e7qbDVoaW9edhp55sZABkHz1RzV5SzTt6bD2p9sSjH/r9FrmScrqVk62rM73xp8Z1r6siDexKLSZXX6sugZ83amHH9WKJO3PGQD60yu4NQAEl7S/gADQn17BrQEguKT9BQSA/vQKbq0ewMbOcWRBwW8LZkCXP5/b/VDBBy/4qzOqa4D7mRd2VyoIgHkHuSGs5oEYAPBBR7EEgCiy8oMCAF+rKJYAEEVWftChAHBq+ZE3G9otfeo1TdxNsFg+nWt0e0PP777RnQXdXZzzlOr2+ER2xxNnBjuWT/oaX43VdW9Lubd4haMmv10YpKW19HL8JAAMUvNUWQBQmvTtggEAAKQKGPQBUgll/gAg00/srR7AyugxVhZk/+0eql7CpxqAk/NwqyW+C8sMoB5AfWujTP3EZesHsLmhe0lScxbkmqA6AIhrYeEAAFBYujCOABBGx8JRhgLAg6eXU8mxy5fdtvP05vT0FHB2M3nnbOfdM9mcO4mbbGX3I+ZvTk/n7e2L7BxLLnqm1dTdCa/evlS90Qm3Tlii9emm7gc0vtzUDWDtYHPvAREutWrZGQAoFwgAlKs/AQAACBSwROgDBPqJXQFALKEsgCX6fGCTtR4gKyiet+o+wG3MGv19lMi9OCj1EtNezy+3B3T5zzhnX5zqDxF7vVQ1G9MHlleWN2DVnIY6AJM/T+geCQNAvOaFE1l9E4QawMEcyQZNUCRhuWEBgKtUJLvhADB/Ve90NFma2HZpaCTCAwhrvt2YVwyAaL9p6J6O3rx+Xy0A9+d4tZHXADCAmppbBACUpfxeuQAAAGIFDPoAsYaiAAAgkk/urB7AvpH3yILk90HBCNbS99qRnLn9bnPwfjnZNQR3zj+Wd03h/2hNdQ1wT0k2a/WC9KrhBgAlcwAAABAogCZIIF4IVwAIoaIgBgAIxAvhOgQA/gLvdplS6vruLgAAAABJRU5ErkJggg==",Vc="/music-learning-tools/assets/favicon-Bc4v39Jn.ico",Xc="/music-learning-tools/assets/favicon-BsWgUeI5.svg",Uc="/music-learning-tools/assets/atkinsonHyperlegibleNextBold-CRDaWt1k.otf",Yc="/music-learning-tools/assets/atkinsonHyperlegibleNextRegular-DOJsAlq1.otf",jc="/music-learning-tools/assets/atkinsonHyperlegibleNextRegularItalic-DruWc0Qu.otf",Qc="data:application/manifest+json;base64,ew0KICAibmFtZSI6ICJTdHVkZW50Tm90YXRpb24iLA0KICAic2hvcnRfbmFtZSI6ICJTTiIsDQogICJpY29ucyI6IFsNCiAgICB7DQogICAgICAic3JjIjogIi93ZWItYXBwLW1hbmlmZXN0LTE5MngxOTIucG5nIiwNCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwNCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIsDQogICAgICAicHVycG9zZSI6ICJtYXNrYWJsZSINCiAgICB9LA0KICAgIHsNCiAgICAgICJzcmMiOiAiL3dlYi1hcHAtbWFuaWZlc3QtNTEyeDUxMi5wbmciLA0KICAgICAgInNpemVzIjogIjUxMng1MTIiLA0KICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIiwNCiAgICAgICJwdXJwb3NlIjogIm1hc2thYmxlIg0KICAgIH0NCiAgXSwNCiAgInRoZW1lX2NvbG9yIjogIiNmZmZmZmYiLA0KICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmZmZmIiwNCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSINCn0=",Kc="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAAAXNSR0IArs4c6QAACJhJREFUeF7tncFuG1UYRv9rO0ElaRFSt0gsCgKhNu0esUasQeQ9eAvEA4DoBsQKNmUBgWwRVSWKEEKCZUkXNICUJhAQajIedF1PNRnZjok6OmN8solke+Zen29OPju6vk7b7/9Rhj8IgSJSPP/nnRimHjK+g0YkBeAuAwXg2FcjKwCYgQKA8MdDKwCYgQKA8BWAh68AfAY2AJiBAoDwbQAevgLwGdgAYAYKAMK3AXj4CsBnYAOAGSgACN8G4OErAJ+BDQBmoAAgfBuAh68AfAY2AJiBAoDwbQAevgLwGdgAYAZF9OLS4Z0oXA6NpaAAGPqIflnGT+vnYjCeQ/5gRoqI6ne+uX5bfar1x1Uf6Gge23xqnv8k28xHAWABvnvqQvTBOSz70AoAXgG5ARQADMAGYOErAMvfl0AwfwWAA7AB2AAUgOVvA8D8FQAOwAZgA1AAlr8NAPNXADgAG4ANQAFY/jYAzF8B4ABsADYABWD52wAwfwWAA7AB2AAUgOVvA8D8FQAOIDfA59fdHp2KIQvwwwVXg1L8Rw3w1o2//H4AKIFhDOPZf9ZjmBfy+4MQSJtf/K0ACPqI4yjjlf0no1AAKIEIBcDQKwCI/tHQCgCmYAOA8MdDKwCYgQKA8BWAh68AfAY2AJiBAoDwbQAevgLwGdgAYAYKAMK3AXj4CsBnYAOAGSgACN8G4OErAJ+BDQBmoAAgfBuAh68AfAY2AJiBAoDwbQAefhbg5f1zrgYFo7ABQPiDMsXW+k6sRO/hNwPUvxigPq/mgvV5lk+3dcy0Oeb5LuD8FQAVoBefrf88FgCcyBIPrQBg+INSAUD8o6EVAExAAUD4vgnm4SsAn4ENAGagACB8G4CHrwB8BjYAmIECgPBtAB6+AvAZ2ABgBgoAwrcBePgKwGdgA4AZKAAI3wbg4SsAn4ENAGagACB8G4CHrwB8Bun17fvuDg3lMBj24su1e64GhfjnYdO1m1sKAAWQooi7xy9GLxXQDBw2Xb71qQJA10EW4JcHGwoA8R81gAJw9BWAY1+NrABgBgoAwq/+C2QDcCEoAMfeBuDZhwLwIfgSCMxAAUD4vgTqAHz/C4SHYAOAEdgAIHwboAPwbQA8BBsAjMAGAOHbAB2AbwPgIdgAYAQ2AAjfBugAfBsAD8EGACOwAUD4NkAH4EcR9x5ccTUoGIUNAMLPnwJ47ugghqm+4f+kTfZnbcpffwLV42ad47+ea9L5Z0FbrPkrACjAUfTjtaNv4jj1wVks99AKAOavACB83wPw8BWAz8AGADNQABC+DcDDVwA+AxsAzEABQPg2AA9fAfgMbAAwAwUA4dsAPHwF4DOwAcAMFACEbwPw8BWAz8AGADNQABC+DcDDVwA+AxsAzEABQPhVA2zculHbHXraUtnmBtL15bvTnkRbx8xazrtY8z+KXrx69K2rQUEP0ofbm7UrNV/Yk3ZLb17w8+yo3tYx0+aYKS7W/PtlEV+vXY1B+P0AlAPpo+0357maqfn9r8fNAny1dk0BwJQVAISvACD86j2ADcCFoAAc+2pkGwDMQAFA+DYAD18B+AxsADADBQDh2wA8fAXgM7ABwAwUAIRvA/DwFYDPwAYAM1AAEL4NwMNXAD4DGwDMQAFA+DYAD18B+AxsADADBQDh2wA8/H55HDfzcujS5dBUGjYART4iipTi0sH+6Hf+mfVJh/o0q8fVf+f7698OMOlpNY+rj1kf+yyfuFjU+SsAKMBxSnF1bzeK1ANnsdxDKwCYvwKA8H0PwMNXAD4DGwDMQAFA+DYAD18B+AxsADADBQDh2wA8fAXgM7ABwAwUAIRvA/DwFYDPwAYAM1AAEL4NwMNXAD4DGwDMQAFA+DYAD18B+AxsADADBQDhVw3w8Za7Q1Mx5GXQLxzsxtDVoFQEkXauv3Fie/RqV//6jdN2+q8/9rRvA5h0f3OsWeeYNK9J1BZp/r1hit2nf4te6XJoyoC0+95JAaiJLOO4WYCdiwpAZq8AIH0FAOFX7wFsAC4EBeDYVyPbAGAGCgDCtwF4+ArAZ2ADgBkoAAjfBuDhKwCfgQ0AZqAAIHwbgIevAHwGNgCYgQKA8G0AHr4C8BnYAGAGCgDCtwF4+ArAZ2ADgBkoAAjfBugA/GGKuxd/j361HLra37w5tRML1sf7qJ82/baOmTbHPJ8FnL8NcNqF1OL9ZRRx/vBylGn8BRnTNuY/7cMWk+bY1jFn+fKAtubSfN7zjNOYvwK0eIGfduqHAlyJqAQ47QDvf+wEFOCxI53/hAowP6u2HqkAbZGd47wKMAeklh+iAC0DnnV6BQDh+18gHr4C8BnYAGAGCgDCtwF4+ArAZ2ADgBkoAAjfBuDhKwCfgQ0AZqAAIHwbgIevAHwGNgCYgQKA8G0AHr4C8BnYAGAGCgDCf9QA7242V47zs1qSGeRl0OcPX3I1KJh32nvng5oAsxZ712dZPa7+O99ffSJimlPN4/Ixs26bROYsC9Kb5+nG/MuyH0/0f4yIPngJLPfQ6f7bn9gA0DWQBVhdua0AEP/Rn18F4OgrAMe+GlkBwAwUAIRfvQm2AbgQFIBjbwPw7EMB+BB8CQRmoAAgfF8C8fAVgM/ABgAzUAAQvg3Aw1cAPgMbAMxAAUD4NgAPXwH4DGwAMAMFAOHbADx8BeAzsAHADBQAhG8D8PCzAIOV7yNiMJ7MvJvv15edV3uCT7qt+Ryby9WnLQufxWbeOU4bO9/enfnbAKAHqSxib/WZSKMLwh+CgAIQ1Kv6LYv4dXUjejH+ggxwLss6tAKAyecGUAAwAD8QA8NXADYABWD52wAs/zy6L4HADBQAhO+/QTsA35dAeAg2ABiBDQDCtwE6AN8GwEOwAcAIbAAQvg3QAfg2AB6CDQBGYAOA8G2ADsC3AfAQbAAwAhsAhG8DdAC+DYCHYAOAEdgAIPzx0P8CpKm0wymYN9kAAAAASUVORK5CYII=",Zc="/music-learning-tools/assets/web-app-manifest-512x512-Dz8l3SBy.png",Jc=`<div id="app-loading-screen">\r
  <div class="loading-container">\r
    <div class="loading-logo">\r
      <svg viewBox="0 0 100 100" class="logo-svg">\r
        <circle cx="50" cy="50" r="45" class="logo-circle" />\r
        <path d="M 30 50 Q 50 30, 70 50 T 70 70" class="logo-path" />\r
      </svg>\r
    </div>\r
    <h1 class="loading-title">Student Notation</h1>\r
    <div class="loading-progress-container">\r
      <div class="loading-progress-bar">\r
        <div class="loading-progress-fill" id="loading-progress-fill"></div>\r
      </div>\r
      <div class="loading-progress-text" id="loading-progress-text">0%</div>\r
    </div>\r
    <div class="loading-status" id="loading-status">Initializing...</div>\r
  </div>\r
</div>\r
<!-- Sidebar for File/App Actions -->\r
<div id="sidebar-overlay"></div>\r
<aside id="sidebar" role="complementary" aria-label="Application settings and controls">\r
<div class="sidebar-container">\r
<div class="app-title">Student Notation</div>\r
</div>\r
<div class="sidebar-container">\r
<button class="sidebar-button" id="save-as-button" title="Save As"><img src="assets/sidebar/saveAs.svg" alt="Save As"><span class="sidebar-button-text">Save As</span></button>\r
<button class="sidebar-button" id="import-button" title="Open"><img src="assets/sidebar/open.svg" alt="Open"><span class="sidebar-button-text">Open</span></button>\r
<button class="sidebar-button" id="print-button" title="Print"><img src="assets/sidebar/print.svg" alt="Print"><span class="sidebar-button-text">Print</span></button>\r
<button class="sidebar-button" id="reset-canvas-button" title="New File"><img src="assets/sidebar/newPage.svg" alt="New Page"><span class="sidebar-button-text">New Page</span></button>\r
</div>\r
<div class="sidebar-container">\r
<h4 class="sidebar-section-header">Handoff</h4>\r
<button class="sidebar-button" id="take-to-singing-trainer-button" title="Take to Singing Trainer">\r
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\r
<path d="M7 17L17 7"/><path d="M7 7h10v10"/>\r
</svg>\r
<span class="sidebar-button-text">Take to Singing Trainer</span></button>\r
</div>\r
<div class="sidebar-container">\r
<button class="sidebar-button" id="hide-drumgrid-toggle" title="Toggle Drum Grid"><img src="assets/sidebar/hideDrums.svg" alt="Toggle Drum Grid"><span class="sidebar-button-text">Hide Drum Grid</span></button>\r
<button class="sidebar-button" id="hide-buttongrid-toggle" title="Toggle Button Grid"><img src="assets/sidebar/hideAnalysis.svg" alt="Toggle Button Grid"><span class="sidebar-button-text">Hide Button Grid</span></button>\r
<div class="sidebar-legend-toggle-row" role="group" aria-label="Legend visibility">\r
  <button class="sidebar-toggle-button" id="hide-leftlegend-toggle" type="button">Hide Left Legend</button>\r
  <button class="sidebar-toggle-button" id="hide-rightlegend-toggle" type="button">Hide Right Legend</button>\r
</div>\r
</div>\r
<div class="sidebar-container">\r
<h4 class="sidebar-section-header">Long Notes Style</h4>\r
<div class="toggle-button-group"><button class="sidebar-toggle-button active" id="long-note-style1-btn">Circle & Tails</button><button class="sidebar-toggle-button" id="long-note-style2-btn">Stadium</button></div>\r
</div>\r
<div class="sidebar-container">\r
<h4 class="sidebar-section-header">Playhead</h4>\r
<div class="toggle-button-group"><button class="sidebar-toggle-button active" id="playhead-mode-cursor-btn">Cursor Playhead</button><button class="sidebar-toggle-button" id="playhead-mode-microbeat-btn">Pulsing Microbeat</button><button class="sidebar-toggle-button" id="playhead-mode-macrobeat-btn">Pulsing Macrobeat</button></div>\r
</div>\r
</aside>\r
<main id="app-container" role="main">\r
  <!-- Toolbar Container -->\r
  <nav id="toolbar" role="navigation" aria-label="Music notation tools">\r
    <!-- Primary Toolbar -->\r
    <div id="toolbar-primary" class="toolbar-primary">\r
        <div class="primary-toolbar-grid-5x5">\r
            <!-- Row 1: settings, volume, blue notes -->\r
            <button class="toolkit-icon-button" id="settings-button" title="Settings"><img src="assets/icons/settings.svg" alt="Settings"></button>\r
            <div id="volume-control-wrapper">\r
                <button class="toolkit-icon-button" id="volume-icon-button" aria-label="Volume" title="Volume"><img src="assets/icons/volume.svg" alt="Volume"></button>\r
                <div id="volume-popup">\r
                    <input type="range" id="vertical-volume-slider" orient="vertical" min="0" max="100" value="70" step="1" />\r
                </div>\r
            </div>\r
            <div class="note circle-note" data-type="circle" data-color="#4a90e2"></div>\r
            <div class="note oval-note" data-type="oval" data-color="#4a90e2"></div>\r
            <div class="note diamond-note" data-type="diamond" data-color="#4a90e2" aria-label="Sixteenth note jewel">\r
                <svg class="diamond-icon" viewBox="0 0 120 120" aria-hidden="true" focusable="false">\r
                    <path d="M60 5 L35 48.3 L35 71.7 L60 115 L85 71.7 L85 48.3 Z" />\r
                </svg>\r
            </div>\r
            <!-- Row 2: zoom in/out, black notes -->\r
            <button class="toolkit-icon-button" id="grid-zoom-in" title="Zoom In"><img src="assets/icons/zoomIn.svg" alt="Zoom In"></button>\r
            <button class="toolkit-icon-button" id="grid-zoom-out" title="Zoom Out"><img src="assets/icons/zoomOut.svg" alt="Zoom Out"></button>\r
            <div class="note circle-note" data-type="circle" data-color="#2d2d2d"></div>\r
            <div class="note oval-note" data-type="oval" data-color="#2d2d2d"></div>\r
            <div class="note diamond-note" data-type="diamond" data-color="#2d2d2d" aria-label="Sixteenth note jewel">\r
                <svg class="diamond-icon" viewBox="0 0 120 120" aria-hidden="true" focusable="false">\r
                    <path d="M60 5 L35 48.3 L35 71.7 L60 115 L85 71.7 L85 48.3 Z" />\r
                </svg>\r
            </div>\r
            <!-- Row 3: redo/undo, red notes -->\r
            <button class="toolkit-icon-button" id="redo-button" title="Redo"><img src="assets/icons/redo.svg" alt="Redo"></button>\r
            <button class="toolkit-icon-button" id="undo-button" title="Undo"><img src="assets/icons/undo.svg" alt="Undo"></button>\r
            <div class="note circle-note" data-type="circle" data-color="#d66573"></div>\r
            <div class="note oval-note" data-type="oval" data-color="#d66573"></div>\r
            <div class="note diamond-note" data-type="diamond" data-color="#d66573" aria-label="Sixteenth note jewel">\r
                <svg class="diamond-icon" viewBox="0 0 120 120" aria-hidden="true" focusable="false">\r
                    <path d="M60 5 L35 48.3 L35 71.7 L60 115 L85 71.7 L85 48.3 Z" />\r
                </svg>\r
            </div>\r
            <!-- Row 4: clear/eraser, green notes -->\r
            <button class="toolkit-icon-button" id="clear-button" title="Clear"><img src="assets/icons/clear.svg" alt="Clear"></button>\r
            <button class="toolkit-icon-button eraser-button" id="eraser-tool-button" title="Eraser">\r
                <img src="assets/icons/eraser.svg" alt="Eraser" class="eraser-icon">\r
            </button>\r
            <div class="note circle-note" data-type="circle" data-color="#68a03f"></div>\r
            <div class="note oval-note" data-type="oval" data-color="#68a03f"></div>\r
            <div class="note diamond-note" data-type="diamond" data-color="#68a03f" aria-label="Sixteenth note jewel">\r
                <svg class="diamond-icon" viewBox="0 0 120 120" aria-hidden="true" focusable="false">\r
                    <path d="M60 5 L35 48.3 L35 71.7 L60 115 L85 71.7 L85 48.3 Z" />\r
                </svg>\r
            </div>\r
            <!-- Row 5: lasso/marker shortcuts, playback controls -->\r
            <button class="toolkit-icon-button" id="lasso-shortcut-button" title="Lasso Tool">\r
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="3 2">\r
                    <ellipse cx="12" cy="12" rx="8" ry="6" transform="rotate(-15 12 12)"/>\r
                </svg>\r
            </button>\r
            <button class="toolkit-icon-button" id="marker-shortcut-button" title="Marker Tool">\r
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                    <path d="M18 2L6 14l-2 6 6-2L22 6l-4-4z"/>\r
                    <line x1="14" y1="6" x2="18" y2="10"/>\r
                </svg>\r
            </button>\r
            <button class="toolkit-icon-button" id="play-button" title="Play"><img src="assets/icons/play.svg" alt="Play"></button>\r
            <button class="toolkit-icon-button" id="stop-button" title="Stop"><img src="assets/icons/stop.svg" alt="Stop"></button>\r
            <button class="toolkit-icon-button" id="loop-button" title="Loop"><img src="assets/icons/loop.svg" alt="Loop"></button>\r
        </div>\r
    </div>\r
    <!-- Secondary Toolbar -->\r
    <div id="toolbar-secondary" class="toolbar-secondary">\r
        <div class="tab-sidebar">\r
            <button class="tab-button" data-tab="timbre">Timbre</button>\r
            <button class="tab-button" data-tab="pitch">Pitch</button>\r
            <button class="tab-button" data-tab="rhythm">Rhythm</button>\r
        </div>\r
        <div class="tab-content">\r
            <!-- Timbre Tab -->\r
            <div class="tab-panel" id="timbre-panel">\r
                <!-- Presets/Effects Section (Separate) -->\r
                <div class="control-section preset-effects-container">\r
                    <div class="preset-effects-controls">\r
                            <div class="preset-effects-tabs">\r
                                <button class="preset-tab-button active" data-preset-tab="presets">Presets</button>\r
                                <button class="preset-tab-button" data-preset-tab="effects">Effects</button>\r
                            </div>\r
                            <div class="preset-effects-content">\r
                                <!-- Presets Tab -->\r
                                <div class="preset-tab-panel active" id="presets-panel">\r
                            <div class="preset-content-box">\r
                                <div class="preset-grid" id="preset-buttons">\r
                                    <div class="preset-column">\r
                                        <button class="preset-button" id="preset-sine">Sine</button>\r
                                        <button class="preset-button" id="preset-triangle">Triangle</button>\r
                                        <button class="preset-button" id="preset-square">Square</button>\r
                                        <button class="preset-button" id="preset-sawtooth">Sawtooth</button>\r
                                    </div>\r
                                    <div class="preset-column">\r
                                        <button class="preset-button" id="preset-piano">Piano</button>\r
                                        <button class="preset-button" id="preset-marimba">Marimba</button>\r
                                        <button class="preset-button" id="preset-woodwind">Woodwind</button>\r
                                        <button class="preset-button" id="preset-strings">Strings</button>\r
                                    </div>\r
                                </div>\r
                            </div>\r
                        </div>\r
                        <!-- Effects Tab -->\r
                        <div class="preset-tab-panel" id="effects-panel">\r
                            <div class="effects-content-box">\r
                                <div class="position-controls-container">\r
                                    <div class="position-control-group">\r
                                        <h5 class="position-label">Delay</h5>\r
                                        <div class="position-component-wrapper">\r
                                            <div class="position-component" id="delay-position"></div>\r
                                            <div id="delay-mix-wrapper"></div>\r
                                        </div>\r
                                        <div class="position-axis-labels" data-axis-x="Time" data-axis-y="Echoes"></div>\r
                                    </div>\r
                                    <div class="position-control-group">\r
                                        <h5 class="position-label">Vibrato</h5>\r
                                        <div class="position-component-wrapper">\r
                                            <div class="position-component" id="vibrato-position"></div>\r
                                            <div id="vibrato-mix-wrapper"></div>\r
                                        </div>\r
                                        <div class="position-axis-labels" data-axis-x="Speed" data-axis-y="Span"></div>\r
                                    </div>\r
                                    <div class="position-control-group">\r
                                        <h5 class="position-label">Tremolo</h5>\r
                                        <div class="position-component-wrapper">\r
                                            <div class="position-component" id="tremolo-position"></div>\r
                                            <div id="tremolo-mix-wrapper"></div>\r
                                        </div>\r
                                        <div class="position-axis-labels" data-axis-x="Speed" data-axis-y="Span"></div>\r
                                    </div>\r
                                </div>\r
                            </div>\r
                        </div>                        \r
                        <div class="effect-controls-container" id="effect-controls" style="display: none;">\r
                            <!-- Effect controls will be dynamically inserted here for data synchronization -->\r
                        </div>\r
                            </div>\r
                    </div>\r
                </div>\r
                <div class="control-section filter-container">\r
                    <!-- Row 1, Col 1: Blend slider -->\r
                    <div class="blend-slider-container"><div id="blend-slider-container"><div class="filter-blend-thumb" id="thumb-b" tabindex="0">B</div></div></div>\r
                    <!-- Row 2, Col 1: Bins grid (appended via JS) -->\r
                    <div class="filter-bins-wrapper"></div>\r
                    <!-- Row 3, Col 1: Cutoff slider -->\r
                    <div id="cutoff-slider-container"><div class="filter-cutoff-thumb" id="thumb-c" tabindex="0">C</div></div>\r
                    <!-- Row 2, Col 2: Vertical M slider (appended via JS) -->\r
                    <div class="filter-vertical-blend-wrapper"></div>\r
                </div>\r
                <div class="control-section adsr-container">\r
                    <!-- Row 1, Col 1: ADSR graph -->\r
                    <div class="adsr-graph-wrapper"><div id="adsr-envelope"></div></div>\r
                    <!-- Row 1, Col 2: Sustain slider -->\r
                    <div class="sustain-slider-wrapper"><div id="sustain-slider-track"><div id="sustain-slider-thumb" tabindex="0">S</div></div></div>\r
                    <!-- Row 2, Col 1: ADR slider -->\r
                    <div id="multi-thumb-slider-container"><div class="time-slider-thumb" id="thumb-a" tabindex="0">A</div><div class="time-slider-thumb" id="thumb-d" tabindex="0">D</div><div class="time-slider-thumb" id="thumb-r" tabindex="0">R</div></div>\r
                </div>\r
                  <!-- Waveform Section (Separate) -->\r
                  <div class="control-section">\r
                      <div class="waveform-section">\r
                          <div class="waveform-content-box">\r
                              <div class="waveform-display-wrapper">\r
                                  <canvas id="static-waveform-canvas"></canvas>\r
                                  <div class="waveform-speed-controls">\r
                                      <button class="waveform-speed-btn" data-speed="50">50%</button>\r
                                      <button class="waveform-speed-btn" data-speed="10">10%</button>\r
                                  </div>\r
                              </div>\r
                          </div>\r
                      </div>\r
                  </div>\r
              </div>\r
              <!-- Pitch Tab -->\r
            <div class="tab-panel" id="pitch-panel">\r
                <div class="control-section pitch-tabs-container">\r
                    <div class="pitch-tabs">\r
                        <button class="pitch-tab-button active" data-pitch-tab="range">Range</button>\r
                        <button class="pitch-tab-button" data-pitch-tab="chords">Chords</button>\r
                        <button class="pitch-tab-button" data-pitch-tab="draw">Draw</button>\r
                    </div>\r
                    <div class="pitch-tab-content">\r
                        <div class="pitch-tab-panel active" id="range-panel">\r
                            <div class="range-content-box">\r
                                <div class="range-layout">\r
                                   <div class="range-panel-section modes-section">\r
                                       <!-- <h4 class="panel-section-title">Modes</h4> -->\r
                                       <div class="tonic-modes-container">\r
                                           <div class="tonic-modes-grid">\r
                                               <button class="tonic-mode-button" data-tonic="1">\r
                                                   <img src="assets/tabicons/tonicShape_1.svg" alt="Major" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Major</span>\r
                                               </button>\r
                                               <button class="tonic-mode-button" data-tonic="2">\r
                                                   <img src="assets/tabicons/tonicShape_2.svg" alt="Dorian" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Dorian</span>\r
                                               </button>\r
                                               <button class="tonic-mode-button" data-tonic="3">\r
                                                   <img src="assets/tabicons/tonicShape_3.svg" alt="Phrygian" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Phrygian</span>\r
                                               </button>\r
                                               <button class="tonic-mode-button" data-tonic="4">\r
                                                   <img src="assets/tabicons/tonicShape_4.svg" alt="Lydian" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Lydian</span>\r
                                               </button>\r
                                               <button class="tonic-mode-button" data-tonic="5">\r
                                                   <img src="assets/tabicons/tonicShape_5.svg" alt="Mixolydian" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Mixolydian</span>\r
                                               </button>\r
                                               <button class="tonic-mode-button" data-tonic="6">\r
                                                   <img src="assets/tabicons/tonicShape_6.svg" alt="Minor" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Minor</span>\r
                                               </button>\r
                                               <button class="tonic-mode-button" data-tonic="7">\r
                                                   <img src="assets/tabicons/tonicShape_7.svg" alt="Locrian" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Locrian</span>\r
                                               </button>\r
                                           </div>\r
                                       </div>\r
                                   </div>\r
                                   <div class="range-panel-section degrees-section">\r
                                       <!-- <h4 class="panel-section-title">Degrees</h4> -->\r
                                       <div class="degree-visibility-toggle-container">\r
                                           <button class="degree-visibility-button" id="degree-visibility-toggle" type="button">\r
                                               Show Degrees\r
                                           </button>\r
                                       </div>\r
                                       <div class="degree-mode-toggle-container" id="degree-mode-toggle">\r
                                           <button class="degree-mode-button" data-mode="diatonic" type="button">Scale</button>\r
                                           <button class="degree-mode-button" data-mode="modal" type="button">Mode</button>\r
                                       </div>\r
                                       <label class="checkbox-label">\r
                                            <input type="checkbox" id="focus-colours-toggle">\r
                                            <span class="checkbox-text">Focus Colours</span>\r
                                        </label>\r
                                   </div>\r
                                   <div class="range-panel-section wheels-section">\r
                                       <!-- <h4 class="panel-section-title">Select Range</h4> -->\r
                                       <div class="clef-wheels-wrapper">\r
                                           <div class="clef-picker-column">\r
                                               <div class="clef-wheel" id="clef-top-wheel" tabindex="0" aria-label="Select top note">\r
                                                   <div class="clef-wheel-viewport">\r
                                                       <div class="clef-wheel-options"></div>\r
                                                   </div>\r
                                                   <div class="clef-wheel-overlay"></div>\r
                                               </div>\r
                                           </div>\r
                                           <div class="clef-picker-column">\r
                                               <div class="clef-wheel" id="clef-bottom-wheel" tabindex="0" aria-label="Select bottom note">\r
                                                   <div class="clef-wheel-viewport">\r
                                                       <div class="clef-wheel-options"></div>\r
                                                   </div>\r
                                                   <div class="clef-wheel-overlay"></div>\r
                                               </div>\r
                                           </div>\r
                                       </div>\r
                                   </div>\r
                                   <div class="range-panel-section presets-section">\r
                                       <!-- <h4 class="panel-section-title">Presets</h4> -->\r
                                       <div class="clef-presets-column">\r
                                           <div class="clef-preset-buttons">\r
                                               <button class="toolkit-button clef-preset-button" id="clef-full-range-button" type="button">\r
                                                   Full Range\r
                                               </button>\r
                                               <button class="toolkit-button clef-preset-button" id="clef-treble-button" type="button">\r
                                                   Treble\r
                                               </button>\r
                                               <button class="toolkit-button clef-preset-button" id="clef-alto-button" type="button">\r
                                                   Alto\r
                                               </button>\r
                                               <button class="toolkit-button clef-preset-button" id="clef-bass-button" type="button">\r
                                                   Bass\r
                                               </button>\r
                                               <button class="toolkit-button clef-preset-button" id="clef-voice1-button" type="button">\r
                                                   Voice I\r
                                               </button>\r
                                               <button class="toolkit-button clef-preset-button" id="clef-voice2-button" type="button">\r
                                                   Voice II\r
                                               </button>\r
                                               <button class="toolkit-button clef-preset-button" id="clef-voice3-button" type="button">\r
                                                   Voice III\r
                                               </button>\r
                                           </div>\r
                                       </div>\r
                                   </div>\r
                                </div>\r
                        </div>\r
                    </div>\r
                        <div class="pitch-tab-panel" id="chords-panel">\r
            <div class="chords-content-box">\r
                <div class="chords-layout">\r
                    <div class="chords-panel-section intervals-grid-section">\r
                        <h4 class="panel-section-title">Intervals</h4>\r
                        <div class="intervals-grid-column">\r
                            <div class="harmony-preset-grid intervals-4x4-grid">\r
                                <button class="harmony-preset-button">M6</button>\r
                                <button class="harmony-preset-button">A6</button>\r
                                <button class="harmony-preset-button">m7</button>\r
                                <button class="harmony-preset-button">M7</button>\r
                                <button class="harmony-preset-button">d5</button>\r
                                <button class="harmony-preset-button">P5</button>\r
                                <button class="harmony-preset-button">A5</button>\r
                                <button class="harmony-preset-button">m6</button>\r
                                <button class="harmony-preset-button">m3</button>\r
                                <button class="harmony-preset-button">M3</button>\r
                                <button class="harmony-preset-button">P4</button>\r
                                <button class="harmony-preset-button">A4</button>\r
                                <button class="harmony-preset-button">U</button>\r
                                <button class="harmony-preset-button">m2</button>\r
                                <button class="harmony-preset-button">M2</button>\r
                                <button class="harmony-preset-button">A2</button>\r
                            </div>\r
                        </div>\r
                    </div>\r
                    <div class="chords-panel-section unified-position-section">\r
                        <h4 class="panel-section-title">Position</h4>\r
                        <div class="unified-position-column">\r
                            <div class="unified-position-toggle" id="unified-position-toggle">\r
                                <div class="left-labels">\r
                                    <span class="state-label" data-step="0">Asc.</span>\r
                                    <span class="state-label" data-step="1">Desc.</span>\r
                                </div>\r
                                <div class="toggle-track">\r
                                    <div class="unified-slider"></div>\r
                                </div>\r
                                <div class="right-labels">\r
                                    <span class="state-label" data-step="0">Root</span>\r
                                    <span class="state-label" data-step="1">1st</span>\r
                                    <span class="state-label" data-step="2">2nd</span>\r
                                    <span class="state-label" data-step="3">3rd</span>\r
                                    <span class="state-label" data-step="4">4th</span>\r
                                    <span class="state-label" data-step="5">5th</span>\r
                                </div>\r
                            </div>\r
                        </div>\r
                    </div>\r
                    <div class="chords-panel-section chords-grid-section">\r
                        <h4 class="panel-section-title">Chords</h4>\r
                        <div class="chords-grid-column">\r
                            <div class="harmony-preset-grid chords-grid chords-grid-6col" id="chords-preset-grid">\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;]" title="Major triad">X</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;]" title="Minor triad">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5d&quot;]" title="Diminished triad">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;6m&quot;]" title="Augmented triad">X+</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7m&quot;]" title="Dominant 7">X</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;7m&quot;]" title="Minor 7">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7M&quot;]" title="Major 7">Xmaj</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5d&quot;, &quot;7m&quot;]" title="Half-diminished 7"></button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5d&quot;, &quot;6M&quot;]" title="Fully diminished 7">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;6M&quot;]" title="Major 6">X</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;2M&quot;, &quot;5P&quot;]" title="Suspended 2">Xsus2</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;4P&quot;, &quot;5P&quot;]" title="Suspended 4">Xsus4</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;7M&quot;]" title="Minor-major 7">xmaj</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;9M&quot;]" title="Major add 9">Xadd9</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;9M&quot;]" title="Minor add 9">xadd9</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;6M&quot;, &quot;9M&quot;]" title="Major 6/9">X6/9</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7m&quot;, &quot;9M&quot;]" title="Dominant 9">X9</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7m&quot;, &quot;9M&quot;, &quot;11P&quot;]" title="Dominant 11">X11</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7m&quot;, &quot;9M&quot;, &quot;13M&quot;]" title="Dominant 13">X13</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7M&quot;, &quot;9M&quot;]" title="Major 9">Xmaj9</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;7m&quot;, &quot;9M&quot;]" title="Minor 9">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;6M&quot;]" title="Minor 6">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;7m&quot;, &quot;9M&quot;, &quot;11P&quot;]" title="Minor 11">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7M&quot;, &quot;11A&quot;]" title="Major 7 sharp 11 (Lydian)">Xmaj711</button>\r
                            </div>\r
                        </div>\r
                    </div>\r
                </div>\r
            </div>\r
        </div>\r
                        <div class="pitch-tab-panel" id="draw-panel">\r
                            <div class="draw-content-box">\r
                                <div class="draw-layout-grid">\r
                                    <!-- Arrow Tool Panel -->\r
                                    <div class="draw-tool-panel" id="draw-arrow-controls" data-draw-tool="arrow">\r
                                        <div class="draw-tool-header">\r
                                            <button class="draw-tool-button" data-draw-tool="arrow" title="Arrow Tool">\r
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                    <line x1="4" y1="20" x2="20" y2="4"/>\r
                                                    <polyline points="14,4 20,4 20,10"/>\r
                                                </svg>\r
                                            </button>\r
                                        </div>\r
                                        <div class="draw-tool-options" id="arrow-tool-options">\r
                                            <div class="draw-option-group">\r
                                                <div class="draw-toolbar-row">\r
                                                    <!-- Stroke weight popup -->\r
                                                    <div class="draw-popup-trigger">\r
                                                        <button class="draw-toolbar-button" title="Stroke width">\r
                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                                <line x1="4" y1="12" x2="20" y2="12"/>\r
                                                            </svg>\r
                                                        </button>\r
                                                        <div class="draw-popup-menu">\r
                                                            <div class="draw-option-label">Stroke</div>\r
                                                            <input type="range" id="arrow-stroke-weight" min="1" max="20" value="4" aria-label="Arrow stroke weight">\r
                                                        </div>\r
                                                    </div>\r
\r
                                                    <!-- Line style popup -->\r
                                                    <div class="draw-popup-trigger">\r
                                                        <button class="draw-toolbar-button" title="Line style">\r
                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                                <line x1="4" y1="8" x2="20" y2="8" stroke-dasharray="4 3"/>\r
                                                                <line x1="4" y1="16" x2="20" y2="16"/>\r
                                                            </svg>\r
                                                        </button>\r
                                                        <div class="draw-popup-menu">\r
                                                            <div class="draw-option-label">Line Style</div>\r
                                                            <div class="draw-button-group">\r
                                                                <button class="draw-option-button active" data-line-style="solid">Solid</button>\r
                                                                <button class="draw-option-button" data-line-style="dashed">Dashed</button>\r
                                                            </div>\r
                                                        </div>\r
                                                    </div>\r
                                                </div>\r
                                                <div class="draw-toolbar-row">\r
                                                    <!-- Left arrowhead popup -->\r
                                                    <div class="draw-popup-trigger">\r
                                                        <button class="draw-toolbar-button" id="arrow-start-head-trigger" title="Start head">\r
                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                                <polyline points="9,5 3,12 9,19"/>\r
                                                                <line x1="3" y1="12" x2="21" y2="12"/>\r
                                                            </svg>\r
                                                        </button>\r
                                                                <div class="draw-popup-menu">\r
                                                                    <div class="draw-option-label">Start</div>\r
                                                                    <div class="draw-button-group">\r
                                                                    <button class="draw-option-button active" data-arrow-start="none">No head</button>\r
                                                                    <button class="draw-option-button" data-arrow-start="filled-arrow">Arrow</button>\r
                                                                    </div>\r
                                                                </div>\r
                                                            </div>\r
                                                    <!-- Swap heads -->\r
                                                    <button class="draw-toolbar-button" id="arrow-swap-heads" title="Swap heads">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <polyline points="9 5 15 5 15 11"/>\r
                                                            <polyline points="15 19 9 19 9 13"/>\r
                                                            <line x1="9" y1="5" x2="5" y2="9"/>\r
                                                            <line x1="15" y1="19" x2="19" y2="15"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <!-- Right arrowhead popup -->\r
                                                    <div class="draw-popup-trigger">\r
                                                        <button class="draw-toolbar-button" id="arrow-end-head-trigger" title="End head">\r
                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                                <polyline points="15,5 21,12 15,19"/>\r
                                                                <line x1="3" y1="12" x2="21" y2="12"/>\r
                                                            </svg>\r
                                                        </button>\r
                                                                <div class="draw-popup-menu">\r
                                                                    <div class="draw-option-label">End</div>\r
                                                                    <div class="draw-button-group">\r
                                                                    <button class="draw-option-button active" data-arrow-end="filled-arrow">Arrow</button>\r
                                                                    <button class="draw-option-button" data-arrow-end="none">No head</button>\r
                                                                    </div>\r
                                                                    <div class="draw-option-label">Head Size</div>\r
                                                                    <input type="range" id="arrow-head-size" min="8" max="32" value="12" aria-label="Arrowhead size">\r
                                                                </div>\r
                                                            </div>\r
                                                </div>\r
                                            </div>\r
                                        </div>\r
                                    </div>\r
                                    <!-- Text Tool Panel -->\r
                                    <div class="draw-tool-panel" id="draw-text-controls" data-draw-tool="text">\r
                                        <div class="draw-tool-header">\r
                                            <button class="draw-tool-button" data-draw-tool="text" title="Text Tool">\r
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                    <polyline points="4,7 4,4 20,4 20,7"/>\r
                                                    <line x1="12" y1="4" x2="12" y2="20"/>\r
                                                    <line x1="9" y1="20" x2="15" y2="20"/>\r
                                                </svg>\r
                                            </button>\r
                                        </div>\r
                                        <div class="draw-tool-options" id="text-tool-options">\r
                                            <div class="draw-option-group draw-toolbar-row">\r
                                                <!-- Size popup -->\r
                                                <div class="draw-popup-trigger">\r
                                                    <button class="draw-toolbar-button" title="Text size">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <path d="M4 18h16"/>\r
                                                            <path d="M8 18l4-12 4 12"/>\r
                                                            <path d="M10 12h4"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <div class="draw-popup-menu">\r
                                                        <div class="draw-option-label">Size (px)</div>\r
                                                        <input type="number" id="text-size-input" min="8" max="72" value="16" aria-label="Text size (px)">\r
                                                    </div>\r
                                                </div>\r
                                                <!-- Colour popup -->\r
                                                <div class="draw-popup-trigger">\r
                                                    <button class="draw-toolbar-button" title="Text colour">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <path d="M12 3l6 16"/>\r
                                                            <path d="M6 19l6-16"/>\r
                                                            <path d="M10 12h4"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <div class="draw-popup-menu">\r
                                                        <div class="draw-option-label">Colour</div>\r
                                                        <div class="draw-color-picker">\r
                                                            <button class="draw-color-button active" data-color="#000000" style="background-color: #000000;" aria-label="Black text"></button>\r
                                                            <button class="draw-color-button" data-color="#4a90e2" style="background-color: #4a90e2;" aria-label="Blue text"></button>\r
                                                            <button class="draw-color-button" data-color="#d66573" style="background-color: #d66573;" aria-label="Red text"></button>\r
                                                            <button class="draw-color-button" data-color="#68a03f" style="background-color: #68a03f;" aria-label="Green text"></button>\r
                                                        </div>\r
                                                    </div>\r
                                                </div>\r
                                                <!-- Style buttons -->\r
                                                <div class="text-style-rows">\r
                                                    <div class="draw-button-group">\r
                                                        <button class="draw-option-button" data-text-style="bold">B</button>\r
                                                        <button class="draw-option-button" data-text-style="italic">I</button>\r
                                                        <button class="draw-option-button" data-text-style="underline">U</button>\r
                                                    </div>\r
                                                    <div class="draw-button-group">\r
                                                        <button class="draw-option-button" data-text-style="background">Bg</button>\r
                                                        <button class="draw-option-button" data-text-style="superscript">x<sup>2</sup></button>\r
                                                        <button class="draw-option-button" data-text-style="subscript">x<sub>2</sub></button>\r
                                                    </div>\r
                                                </div>\r
                                            </div>\r
                                        </div>\r
                                    </div>\r
                                    <!-- Marker Tool Panel -->\r
                                    <div class="draw-tool-panel" id="draw-marker-controls" data-draw-tool="marker">\r
                                        <div class="draw-tool-header">\r
                                            <button class="draw-tool-button" data-draw-tool="marker" title="Marker Tool">\r
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                    <!-- Pointed marker tip -->\r
                                                    <path d="M18 2L6 14l-2 6 6-2L22 6l-4-4z"/>\r
                                                    <line x1="10" y1="18" x2="6" y2="14"/>\r
                                                </svg>\r
                                            </button>\r
                                        </div>\r
                                        <div class="draw-tool-options" id="marker-tool-options">\r
                                            <div class="draw-option-group draw-toolbar-row">\r
                                                <!-- Size popup -->\r
                                                <div class="draw-popup-trigger">\r
                                                    <button class="draw-toolbar-button" title="Marker size">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <path d="M6 19l12-14"/>\r
                                                            <path d="M6 19l-2 4 4-2"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <div class="draw-popup-menu">\r
                                                        <div class="draw-option-label">Size</div>\r
                                                        <input type="range" id="marker-size-input" min="2" max="20" value="6" aria-label="Marker size">\r
                                                    </div>\r
                                                </div>\r
                                                <!-- Colours popup -->\r
                                                <div class="draw-popup-trigger">\r
                                                    <button class="draw-toolbar-button" title="Marker colour">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <path d="M19 4l-7 7"/>\r
                                                            <path d="M5 20l3.5-1.5"/>\r
                                                            <path d="M16 7l1.5 1.5"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <div class="draw-popup-menu">\r
                                                        <div class="draw-option-label">Colours</div>\r
                                                        <div class="draw-color-picker">\r
                                                            <button class="draw-color-button" data-color="#4a90e2" style="background-color: #4a90e2;" aria-label="Blue marker"></button>\r
                                                            <button class="draw-color-button" data-color="#2d2d2d" style="background-color: #2d2d2d;" aria-label="Black marker"></button>\r
                                                            <button class="draw-color-button" data-color="#d66573" style="background-color: #d66573;" aria-label="Red marker"></button>\r
                                                            <button class="draw-color-button" data-color="#68a03f" style="background-color: #68a03f;" aria-label="Green marker"></button>\r
                                                        </div>\r
                                                    </div>\r
                                                </div>\r
                                            </div>\r
                                        </div>\r
                                    </div>\r
                                    <!-- Highlighter Tool Panel -->\r
                                    <div class="draw-tool-panel" id="draw-highlighter-controls" data-draw-tool="highlighter">\r
                                        <div class="draw-tool-header">\r
                                            <button class="draw-tool-button" data-draw-tool="highlighter" title="Highlighter Tool">\r
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity="0.5">\r
                                                    <!-- Flat highlighter head -->\r
                                                    <rect x="3" y="3" width="4" height="18" rx="1"/>\r
                                                    <path d="M7 5h12l-2 14H7z"/>\r
                                                </svg>\r
                                            </button>\r
                                        </div>\r
                                        <div class="draw-tool-options" id="highlighter-tool-options">\r
                                            <div class="draw-option-group draw-toolbar-row">\r
                                                <!-- Size popup -->\r
                                                <div class="draw-popup-trigger">\r
                                                    <button class="draw-toolbar-button" title="Highlighter size">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <rect x="5" y="5" width="10" height="10" rx="2"/>\r
                                                            <path d="M9 15l-2 4"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <div class="draw-popup-menu">\r
                                                        <div class="draw-option-label">Size</div>\r
                                                        <input type="range" id="highlighter-size-input" min="4" max="30" value="10" aria-label="Highlighter size">\r
                                                    </div>\r
                                                </div>\r
                                                <!-- Colours popup -->\r
                                                <div class="draw-popup-trigger">\r
                                                    <button class="draw-toolbar-button" title="Highlighter colour">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <rect x="7" y="7" width="10" height="10" rx="2"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <div class="draw-popup-menu">\r
                                                        <div class="draw-option-label">Colours</div>\r
                                                        <div class="draw-color-picker">\r
                                                            <button class="draw-color-button" data-color="#9fc5ff" style="background-color: #9fc5ff;" aria-label="Light blue highlighter"></button>\r
                                                            <button class="draw-color-button" data-color="#c2c2c2" style="background-color: #c2c2c2;" aria-label="Gray highlighter"></button>\r
                                                            <button class="draw-color-button" data-color="#ffd166" style="background-color: #ffd166;" aria-label="Yellow highlighter"></button>\r
                                                        </div>\r
                                                    </div>\r
                                                </div>\r
                                            </div>\r
                                        </div>\r
                                    </div>\r
                                    <!-- Lasso Tool Panel -->\r
                                    <div class="draw-tool-panel" id="draw-lasso-controls" data-draw-tool="lasso">\r
                                        <div class="draw-tool-header">\r
                                            <button class="draw-tool-button" data-draw-tool="lasso" title="Lasso Select">\r
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="3 2">\r
                                                    <ellipse cx="12" cy="12" rx="8" ry="6" transform="rotate(-15 12 12)"/>\r
                                                </svg>\r
                                            </button>\r
                                        </div>\r
                                        <div class="draw-tool-options" id="lasso-tool-options">\r
                                            <div class="draw-option-group draw-toolbar-row">\r
                                                <div class="draw-option-help">\r
                                                    Draw around notes to select and drag them as a group.\r
                                                </div>\r
                                            </div>\r
                                        </div>\r
                                    </div>\r
                                </div>\r
                            </div>\r
                        </div>\r
                    </div>\r
                </div>\r
            </div>\r
            <!-- Rhythm Tab -->\r
            <div class="tab-panel" id="rhythm-panel">\r
\r
                <!-- Stamps/Triplets Section (Separate) -->\r
                <div class="control-section rhythm-stamp-tabs-container">\r
                    <div class="rhythm-stamp-tabs-controls">\r
                        <div class="rhythm-tab-stamps">\r
                            <button class="rhythm-tab-button rhythm-stamp-tab-button active" data-rhythm-stamp-tab="sixteenth">Sixteenths</button>\r
                            <button class="rhythm-tab-button rhythm-stamp-tab-button" data-rhythm-stamp-tab="triplet">Triplets</button>\r
                        </div>\r
                        <div class="rhythm-stamp-tab-content">\r
                            <div class="rhythm-stamp-tab-panel active" id="sixteenth-stamps-panel">\r
                                <div id="sixteenth-stamps-toolbar-container" class="sixteenth-stamps-toolbar-container">\r
                                    <!-- Stamps toolbar will be rendered here by JavaScript -->\r
                                </div>\r
                            </div>\r
                            <div class="rhythm-stamp-tab-panel" id="triplet-stamps-panel">\r
                                <div id="triplet-stamps-toolbar-container" class="triplet-stamps-toolbar-container">\r
                                    <!-- Triplets toolbar will be rendered here by JavaScript -->\r
                                </div>\r
                            </div>\r
                        </div>\r
                    </div>\r
                </div>\r
                                <!-- Controls Section (Separate) -->\r
                <div class="control-section rhythm-controls-container">\r
                    <div class="rhythm-controls-section">\r
                        <button class="rhythm-tab-button rhythm-controls-tab-button active" disabled>Controls</button>\r
                        <div class="rhythm-controls-content-box">\r
                            <div class="tempo-content-box">\r
                                <div class="tempo-container">\r
                                    <div class="tempo-boxes-container">\r
                                        <div class="tempo-input-group tempo-row">\r
                                            <img src="assets/tabicons/eigthNote.svg" alt="Eighth Note Tempo" class="tempo-label-icon">\r
                                            <div id="eighth-note-tempo"></div>\r
                                        </div>\r
                                        <div class="tempo-input-group tempo-row">\r
                                            <img src="assets/tabicons/quarterNote.svg" alt="Quarter Note Tempo" class="tempo-label-icon">\r
                                            <div id="quarter-note-tempo"></div>\r
                                        </div>\r
                                        <div class="tempo-input-group tempo-row">\r
                                            <img src="assets/tabicons/dottedQuarterNote.svg" alt="Dotted Quarter Note Tempo" class="tempo-label-icon">\r
                                            <div id="dotted-quarter-tempo"></div>\r
                                        </div>\r
                                    </div>\r
                                    <div class="tempo-slider-container tempo-column-2">\r
                                        <input type="range" id="tempo-slider" min="30" max="240" value="90">\r
                                    </div>\r
                                </div>\r
                            </div>\r
                            <div class="rhythm-structure-container">\r
                                <div class="control-subsection">\r
                                    <h4>Add/Del Beat</h4>\r
                                    <div class="macrobeat-adjust-group">\r
                                        <button class="toolkit-button" id="macrobeat-decrease"></button>\r
                                        <button class="toolkit-button" id="macrobeat-increase">+</button>\r
                                    </div>\r
                                </div>\r
                                <div class="control-subsection">\r
                                    <h4>Pickup</h4>\r
                                    <div class="toggle-button-group"><button class="sidebar-toggle-button" id="anacrusis-on-btn">On</button><button class="sidebar-toggle-button" id="anacrusis-off-btn">Off</button></div>\r
                                </div>\r
                            </div>\r
                            <div class="modulation-container">\r
                                <div class="control-subsection">\r
                                    <h4>Modulation</h4>\r
                                    <div class="modulation-controls">\r
                                        <button class="toolkit-button modulation-ratio-btn" id="modulation-2-3-btn" data-ratio="2:3" title="Place 2:3 modulation marker (33% faster)">2:3 - 33% faster</button>\r
                                        <button class="toolkit-button modulation-ratio-btn" id="modulation-3-2-btn" data-ratio="3:2" title="Place 3:2 modulation marker (33% slower)">3:2 - 33% slower</button>\r
                                        <button class="toolkit-button" id="modulation-clear-btn" title="Clear all modulation markers">Clear</button>\r
                                    </div>\r
                                </div>\r
                            </div>\r
                        </div>\r
                    </div>\r
                </div>\r
            </div>\r
        </div>\r
    </div>\r
  </nav>\r
  <div id="canvas-container" role="region" aria-label="Musical notation canvas">\r
    <div id="canvas-content">\r
        <div id="grids-wrapper">\r
            <div id="button-grid">\r
                <div class="button-grid-left-cell">\r
                    <div class="left-cell-grid">\r
                        <div id="flat-toggle-btn" class="accidental-btn active" role="button" tabindex="0" aria-pressed="true"></div>\r
                        <div id="sharp-toggle-btn" class="accidental-btn active" role="button" tabindex="0" aria-pressed="true"></div>\r
                        <div id="hz-toggle-btn" class="accidental-btn" role="button" tabindex="0" aria-pressed="false">Hz</div>\r
                        <div id="spn-octave-toggle-btn" class="accidental-btn octave-toggle-btn active" role="button" tabindex="0" aria-pressed="true" title="Show SPN octave digits" aria-label="Toggle SPN octave digits">\r
                            <span class="octave-label">\r
                                A<span class="octave-digit">1</span>\r
                            </span>\r
                        </div>\r
                    </div>\r
                </div>\r
                <div class="button-grid-middle-cell">\r
                    <div id="beat-line-button-layer">\r
                        <div id="time-signature-row" class="beat-line-row"></div>\r
                        <div id="grouping-buttons-row" class="beat-line-row"></div>\r
                        <div id="boundary-buttons-row" class="beat-line-row"></div>\r
                    </div>\r
                </div>\r
                <div class="button-grid-right-cell">\r
                    <!-- Null/empty cell for alignment with pitch grid right legend -->\r
                </div>\r
            </div>\r
            <div id="pitch-grid-wrapper">\r
                <div id="pitch-grid-container">\r
                    <div id="grid-container">\r
                        <div id="pitch-canvas-wrapper">\r
                            <canvas id="legend-left-canvas"></canvas>\r
                            <canvas id="notation-grid"></canvas>\r
                            <canvas id="legend-right-canvas"></canvas>\r
                            <canvas id="playhead-canvas"></canvas>\r
                            <canvas id="hover-canvas"></canvas>\r
                        </div>\r
                    </div>\r
                </div>\r
            </div>\r
            <div id="grid-scrollbar-proxy" role="scrollbar" aria-label="Horizontal scroll for notation grids" tabindex="0">\r
                <div class="grid-scrollbar-inner"></div>\r
            </div>\r
            <div id="drum-grid-wrapper">\r
                <div class="drum-grid-left-cell">\r
                    <!-- Reserved for future drum legends/controls -->\r
                </div>\r
                <div class="drum-grid-middle-cell">\r
                    <div id="drum-canvas-wrapper">\r
                        <canvas id="drum-grid"></canvas>\r
                        <canvas id="drum-playhead-canvas"></canvas>\r
                        <canvas id="drum-hover-canvas"></canvas>\r
                    </div>\r
                </div>\r
                <div class="drum-grid-right-cell">\r
                    <!-- Placeholder for alignment with right legend spacing -->\r
                </div>\r
            </div>\r
        </div>\r
    </div>\r
</div>\r
</main>\r
<!-- Notification Overlay -->\r
<div id="notification-overlay">\r
    <div class="notification-modal">\r
        <div class="notification-header">\r
            <h3 class="notification-title">Notice</h3>\r
            <button class="notification-close"></button>\r
        </div>\r
        <div class="notification-message"></div>\r
        <div class="notification-actions">\r
            <button class="notification-button">OK</button>\r
        </div>\r
    </div>\r
</div>\r
<!-- ... (Print Preview Modal remains the same) ... -->\r
<div id="print-preview-overlay" class="hidden">\r
    <div id="print-preview-modal">\r
        <div class="print-preview-header">\r
            <h2>Print Preview</h2>\r
            <button id="print-close-button" class="close-button"></button>\r
        </div>\r
        <div class="print-preview-content">\r
            <div class="print-preview-canvas-wrapper">\r
                <canvas id="print-preview-canvas"></canvas>\r
                <canvas id="print-crop-overlay"></canvas>\r
            </div>\r
                <div class="print-preview-options">\r
                <div class="print-info-box">\r
                    <p>Use the crop handles on the preview to trim what gets sent to the printer.</p>\r
                </div>\r
                <h3>Layout</h3>\r
                <div class="print-option-row">\r
                    <label>Paper</label>\r
                    <select id="print-page-size" class="print-select">\r
                        <option value="letter">Letter (8.511)</option>\r
                        <option value="11x14">1114</option>\r
                        <option value="11x17">1117</option>\r
                    </select>\r
                </div>\r
                <div class="print-option-row">\r
                    <label>Orientation</label>\r
                    <button id="print-orientation-toggle" class="toggle-button">Landscape</button>\r
                </div>\r
                <div class="print-option-row">\r
                    <label>Buttons</label>\r
                    <button id="print-button-grid-toggle" class="toggle-button active">Include</button>\r
                </div>\r
                <div class="print-option-row">\r
                    <label>Drums</label>\r
                    <button id="print-drum-grid-toggle" class="toggle-button active">Include</button>\r
                </div>\r
                <div class="print-option-row">\r
                    <label>Left Legend</label>\r
                    <button id="print-left-legend-toggle" class="toggle-button active">Include</button>\r
                </div>\r
                <div class="print-option-row">\r
                    <label>Right Legend</label>\r
                    <button id="print-right-legend-toggle" class="toggle-button active">Include</button>\r
                </div>\r
                <div class="print-option-row">\r
                    <label>Color</label>\r
                    <button id="print-color-mode-toggle" class="toggle-button active">Color</button>\r
                </div>\r
            </div>\r
        </div>\r
        <div class="print-preview-footer">\r
            <button id="print-confirm-button" class="confirm-button">Print</button>\r
        </div>\r
    </div>\r
</div>\r
<div id="print-staging-area"></div>\r
\r
<!-- Svelte component mount points (headless components) -->\r
<!-- Toolbar bridges -->\r
<div data-svelte-component="playback-controls-bridge" style="display: none;"></div>\r
<div data-svelte-component="file-actions-bridge" style="display: none;"></div>\r
<div data-svelte-component="grid-controls-bridge" style="display: none;"></div>\r
<div data-svelte-component="modulation-bridge" style="display: none;"></div>\r
<div data-svelte-component="sidebar-bridge" style="display: none;"></div>\r
<div data-svelte-component="tool-selector-bridge" style="display: none;"></div>\r
<div data-svelte-component="audio-controls-bridge" style="display: none;"></div>\r
<!-- Tab management bridge -->\r
<div data-svelte-component="tab-management-bridge" style="display: none;"></div>\r
<!-- Modal bridges -->\r
<div data-svelte-component="print-preview-bridge" style="display: none;"></div>\r
`,td={attack:.01,decay:.1,sustain:.7,release:.3},ed={enabled:!1,blend:.5,cutoff:.5,resonance:0,type:"lowpass",mix:1},nd={speed:5,span:0},od={speed:5,span:0};function id(){const n=["#4a90e2","#e24a4a","#4ae24a","#e2e24a","#e24ae2","#4ae2e2","#e2a04a","#a04ae2"],t={};return n.forEach(e=>{const o=new Float32Array(32);o[0]=1;const i=new Float32Array(32);t[e]={name:"Sine",adsr:{...td},coeffs:o,phases:i,filter:{...ed},activePresetName:"sine",gain:1,vibrato:{...nd},tremelo:{...od}}}),t}function sd(){return{macrobeatGroupings:[2,2,2,2],macrobeatBoundaryStyles:["dashed","dashed","dashed","dashed"],hasAnacrusis:!1,baseMicrobeatPx:40,modulationMarkers:[]}}function ad(){const n=_l("G5","C4");return n||{topIndex:0,bottomIndex:Math.max(0,se.length-1)}}function rd(){const n=id();return{placedNotes:[],placedChords:[],tonicSignGroups:{},sixteenthStampPlacements:[],tripletStampPlacements:[],annotations:[],lassoSelection:{selectedItems:[],convexHull:null,isActive:!1},history:[{notes:[],tonicSignGroups:{},timbres:JSON.parse(JSON.stringify(n)),placedChords:[],sixteenthStampPlacements:[],tripletStampPlacements:[],annotations:[],lassoSelection:{selectedItems:[],convexHull:null,isActive:!1}}],historyIndex:0,fullRowData:[...se],pitchRange:ad(),...sd(),selectedModulationRatio:null,timbres:n,colorPalette:{"#4a90e2":{primary:"#4a90e2",light:"#a8c8f0"},"#e24a4a":{primary:"#e24a4a",light:"#f0a8a8"},"#4ae24a":{primary:"#4ae24a",light:"#a8f0a8"},"#e2e24a":{primary:"#e2e24a",light:"#f0f0a8"},"#e24ae2":{primary:"#e24ae2",light:"#f0a8f0"},"#4ae2e2":{primary:"#4ae2e2",light:"#a8f0f0"},"#e2a04a":{primary:"#e2a04a",light:"#f0d0a8"},"#a04ae2":{primary:"#a04ae2",light:"#d0a8f0"}},selectedTool:"note",previousTool:"note",selectedToolTonicNumber:1,selectedNote:{shape:"circle",color:"#4a90e2"},deviceProfile:{isMobile:!1,isTouch:!1,isCoarsePointer:!1,orientation:"landscape",width:0,height:0},activeChordId:null,activeChordIntervals:["1P"],isIntervalsInverted:!1,chordPositionState:0,gridPosition:0,viewportRows:0,logicRows:0,cellWidth:0,cellHeight:0,columnWidths:[],musicalColumnWidths:[],degreeDisplayMode:"off",accidentalMode:{sharp:!0,flat:!0},showFrequencyLabels:!1,showOctaveLabels:!0,focusColours:!1,isPlaying:!1,isPaused:!1,isLooping:!1,tempo:90,playheadMode:"cursor",waveformExtendedView:!1,adsrTimeAxisScale:1,isPrintPreviewActive:!1,printOptions:{pageSize:"letter",includeButtonGrid:!0,includeDrums:!0,includeLeftLegend:!0,includeRightLegend:!0,orientation:"landscape",colorMode:"color",cropTop:0,cropBottom:1,cropLeft:0,cropRight:1},longNoteStyle:"style1"}}function Xs(n){if(!(!n||n.isDrum)&&n.shape==="circle"&&typeof n.startColumnIndex=="number"){const t=n.startColumnIndex+1;(typeof n.endColumnIndex!="number"||n.endColumnIndex<t)&&(n.endColumnIndex=t)}}function ci(n,t){if(typeof n.row!="number")return;const e=t.length>0?t.length-1:-1;if(e<0)return;const o=typeof n.globalRow=="number"?n.globalRow:n.row,i=Math.max(0,Math.min(e,Math.round(o)));n.globalRow=i,n.row=i}function di(){return`uuid-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function ld(n={}){const{getMacrobeatInfo:t,getDegreeForNote:e,hasAccidental:o,log:i=()=>{}}=n;return{addNote(s){const a=this.state.placedNotes.find(c=>!c.isDrum&&c.row===s.row&&c.startColumnIndex===s.startColumnIndex&&c.color===s.color);if(a){if(this.state.degreeDisplayMode!=="off"&&e&&o){const c=e(a,this.state);if(c&&o(c))return a.enharmonicPreference=!a.enharmonicPreference,i("debug","[ENHARMONIC] Toggled enharmonic preference for note",{noteUuid:a.uuid,currentDegree:c,enharmonicPreference:a.enharmonicPreference}),this.emit("notesChanged"),a}return null}const r={...s,uuid:di()};return Xs(r),ci(r,this.state.fullRowData),this.state.placedNotes.push(r),this.emit("notesChanged"),r},updateNoteTail(s,a){let r=a;s.shape==="circle"&&(r=Math.max(s.startColumnIndex+1,a)),s.endColumnIndex=r,this.emit("notesChanged")},updateMultipleNoteTails(s,a){s.forEach(r=>{let c=a;r.shape==="circle"&&(c=Math.max(r.startColumnIndex+1,a)),r.endColumnIndex=c}),this.emit("notesChanged")},updateNoteRow(s,a){s.row=a,s.globalRow=a,this.emit("notesChanged")},updateMultipleNoteRows(s,a){s.forEach((r,c)=>{const d=a[c];d!==void 0&&(r.row=d,ci(r,this.state.fullRowData))}),this.emit("notesChanged")},updateNotePosition(s,a){s.startColumnIndex=a,s.endColumnIndex=s.shape==="circle"?a+1:a,this.emit("notesChanged")},updateMultipleNotePositions(s,a){s.forEach(r=>{r.startColumnIndex=a,r.endColumnIndex=r.shape==="circle"?a+1:a}),this.emit("notesChanged")},removeNote(s){const a=this.state.placedNotes.indexOf(s);a>-1&&(this.state.placedNotes.splice(a,1),this.emit("notesChanged"))},removeMultipleNotes(s){const a=new Set(s);this.state.placedNotes=this.state.placedNotes.filter(r=>!a.has(r)),this.emit("notesChanged")},eraseInPitchArea(s,a,r=1,c=!0){const d=s+r-1,u=a-1,h=a+1;let f=!1;const g=this.state.placedNotes.length;return this.state.placedNotes=this.state.placedNotes.filter(m=>{if(m.isDrum)return!0;if(m.shape==="circle"){const p=m.startColumnIndex+1,v=typeof m.endColumnIndex=="number"?Math.max(p,m.endColumnIndex):p,y=m.startColumnIndex<=d&&v>=s,w=m.row>=u&&m.row<=h;if(y&&w)return!1}else if(m.row>=u&&m.row<=h&&m.startColumnIndex<=d&&m.endColumnIndex>=s)return!1;return!0}),this.state.placedNotes.length<g&&(f=!0),f&&(this.emit("notesChanged"),c&&this.recordState()),f},addTonicSignGroup(s){i("debug","Starting addTonicSignGroup",{tonicSignGroup:s});const a=s[0];if(!a)return;const{preMacrobeatIndex:r}=a;if(i("debug","preMacrobeatIndex",{preMacrobeatIndex:r}),Object.entries(this.state.tonicSignGroups).find(([,g])=>g.some(m=>m.preMacrobeatIndex===r))){i("debug","Existing tonic already present for measure, skipping",{preMacrobeatIndex:r});return}if(!t){i("error","getMacrobeatInfo callback not provided");return}const d=t(this.state,r+1).startColumn;i("debug","Boundary column (canvas-space) for shifting notes",{boundaryColumn:d});const u=this.state.placedNotes.filter(g=>g.startColumnIndex>=d);i("debug","Notes that will be shifted",{noteRanges:u.map(g=>`${g.startColumnIndex}-${g.endColumnIndex}`)}),this.state.placedNotes.forEach(g=>{if(g.startColumnIndex>=d){const m=g.startColumnIndex,p=g.endColumnIndex;g.startColumnIndex=g.startColumnIndex+2,g.endColumnIndex=g.endColumnIndex+2,i("debug",`Shifted note from ${m}-${p} to ${g.startColumnIndex}-${g.endColumnIndex}`)}});const h=di(),f=s.map(g=>({...g,uuid:h,globalRow:typeof g.globalRow=="number"?g.globalRow:g.row}));this.state.tonicSignGroups[h]=f,i("debug","Added tonic group",{uuid:h,columns:f.map(g=>g.columnIndex)}),i("debug","Emitting events: notesChanged, rhythmStructureChanged"),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},eraseTonicSignAt(s,a=!0){const r=Object.entries(this.state.tonicSignGroups).find(([,g])=>g.some(m=>m.columnIndex===s));if(!r)return!1;if(!t)return i("error","getMacrobeatInfo callback not provided"),!1;const[c,d]=r,u=d[0];if(!u)return!1;const h=u.preMacrobeatIndex,f=t(this.state,h+1).startColumn;return delete this.state.tonicSignGroups[c],this.state.placedNotes.forEach(g=>{g.startColumnIndex>=f&&(g.startColumnIndex=g.startColumnIndex-2,g.endColumnIndex=g.endColumnIndex-2)}),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),a&&this.recordState(),!0},clearAllNotes(){this.state.placedNotes=[],this.state.tonicSignGroups={},this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},loadNotes(s){const a=(s||[]).map(r=>{const c={...r,uuid:r?.uuid??di()};return Xs(c),ci(c,this.state.fullRowData),c});this.state.placedNotes=a,this.emit("notesChanged"),this.recordState()}}}function cd(){return`sixteenth-stamp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function dd(n={}){const{getPlacedTonicSigns:t,isWithinTonicSpan:e,log:o=()=>{}}=n;return{addSixteenthStampPlacement(i,s,a,r="#4a90e2"){const c=s+2;if(t&&e){const f=t(this.state);(e(s,f)||e(s+1,f))&&o("debug","Cannot place sixteenth stamp - overlaps tonic column",{sixteenthStampId:i,startColumn:s,row:a})}const d=this.state.sixteenthStampPlacements.find(f=>f.row===a&&f.startColumn<c&&f.endColumn>s);d&&this.removeSixteenthStampPlacement(d.id);const u=a,h={id:cd(),sixteenthStampId:i,startColumn:s,endColumn:c,row:a,globalRow:u,color:r,timestamp:Date.now(),shapeOffsets:{}};return this.state.sixteenthStampPlacements.push(h),this.emit("sixteenthStampPlacementsChanged"),o("debug",`Added sixteenth stamp ${i} at canvas-space ${s}-${c},${a}`,{sixteenthStampId:i,startColumn:s,endColumn:c,row:a,placementId:h.id}),h},removeSixteenthStampPlacement(i){const s=this.state.sixteenthStampPlacements.findIndex(r=>r.id===i);if(s===-1)return!1;const a=this.state.sixteenthStampPlacements.splice(s,1)[0];return a?(this.emit("sixteenthStampPlacementsChanged"),o("debug",`Removed sixteenth stamp ${a.sixteenthStampId} at ${a.startColumn}-${a.endColumn},${a.row}`,{placementId:i,sixteenthStampId:a.sixteenthStampId,startColumn:a.startColumn,endColumn:a.endColumn,row:a.row}),!0):!1},eraseSixteenthStampsInArea(i,s,a,r){const c=[];for(const u of this.state.sixteenthStampPlacements){const h=u.startColumn<=s&&u.endColumn>=i,f=u.row>=a&&u.row<=r;h&&f&&c.push(u.id)}let d=!1;return c.forEach(u=>{this.removeSixteenthStampPlacement(u)&&(d=!0)}),d},getAllSixteenthStampPlacements(){return[...this.state.sixteenthStampPlacements]},getSixteenthStampAt(i,s){return this.state.sixteenthStampPlacements.find(a=>a.row===s&&i>=a.startColumn&&i<a.endColumn)||null},clearAllSixteenthStamps(){const i=this.state.sixteenthStampPlacements.length>0;this.state.sixteenthStampPlacements=[],i&&(this.emit("sixteenthStampPlacementsChanged"),o("info","Cleared all sixteenth stamp placements"))},getSixteenthStampPlaybackData(){return this.state.sixteenthStampPlacements.map(i=>{const s=this.state.fullRowData[i.row];return{sixteenthStampId:i.sixteenthStampId,column:i.startColumn,startColumn:i.startColumn,endColumn:i.endColumn,row:i.row,pitch:s?.toneNote||"",color:i.color,placement:i}}).filter(i=>i.pitch)},updateSixteenthStampShapeOffset(i,s,a){const r=this.state.sixteenthStampPlacements.find(c=>c.id===i);if(!r){o("warn","[SIXTEENTH STAMP SHAPE OFFSET] Placement not found",{placementId:i});return}r.shapeOffsets||(r.shapeOffsets={}),o("debug","[SIXTEENTH STAMP SHAPE OFFSET] Updating shape offset",{placementId:i,shapeKey:s,oldOffset:r.shapeOffsets[s]||0,newOffset:a,baseRow:r.row,targetRow:r.row+a}),r.shapeOffsets[s]=a,this.emit("sixteenthStampPlacementsChanged")},getSixteenthStampShapeRow(i,s){const a=i.shapeOffsets?.[s]||0;return i.row+a}}}function ud(){return`triplet-stamp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function hd(n={}){const{canvasToTime:t,timeToCanvas:e,getColumnMap:o,log:i=()=>{}}=n;return{addTripletStampPlacement(s){this.state.tripletStampPlacements||(this.state.tripletStampPlacements=[]);const a=s.startTimeIndex+s.span*2,r=this.state.tripletStampPlacements.find(d=>d.row!==s.row?!1:!(d.startTimeIndex+d.span*2<=s.startTimeIndex||a<=d.startTimeIndex));if(r&&this.removeTripletStampPlacement(r.id),this.state.sixteenthStampPlacements&&t&&o){const d=o(this.state);this.state.sixteenthStampPlacements.filter(h=>{if(h.row!==s.row)return!1;const f=t(h.startColumn,d);return f===null?!0:!(f+2<=s.startTimeIndex||f>=a)}).forEach(h=>{this.removeSixteenthStampPlacement&&this.removeSixteenthStampPlacement(h.id)})}const c={id:ud(),...s,shapeOffsets:s.shapeOffsets||{}};return this.state.tripletStampPlacements.push(c),this.emit("tripletStampPlacementsChanged"),this.emit("rhythmStructureChanged"),i("debug",`Added triplet stamp ${s.tripletStampId} at time ${s.startTimeIndex}, row ${s.row}`,{tripletStampId:s.tripletStampId,startTimeIndex:s.startTimeIndex,span:s.span,row:s.row,placementId:c.id}),c},removeTripletStampPlacement(s){if(!this.state.tripletStampPlacements)return!1;const a=this.state.tripletStampPlacements.findIndex(c=>c.id===s);if(a===-1)return!1;const r=this.state.tripletStampPlacements.splice(a,1)[0];return r?(this.emit("tripletStampPlacementsChanged"),i("debug",`Removed triplet stamp ${r.tripletStampId} at time ${r.startTimeIndex}, row ${r.row}`,{placementId:s,tripletStampId:r.tripletStampId,startTimeIndex:r.startTimeIndex,span:r.span,row:r.row}),!0):!1},eraseTripletStampsInArea(s,a,r,c){if(!this.state.tripletStampPlacements||!e||!o)return!1;const d=o(this.state),u=[];for(const f of this.state.tripletStampPlacements)if(f.row>=r&&f.row<=c){const g=f.span*2,m=e(f.startTimeIndex,d);m+g-1<s||m>a||u.push(f.id)}let h=!1;return u.forEach(f=>{this.removeTripletStampPlacement(f)&&(h=!0)}),h},getAllTripletStampPlacements(){return[...this.state.tripletStampPlacements||[]]},getTripletStampAt(s,a){return this.state.tripletStampPlacements&&this.state.tripletStampPlacements.find(r=>r.row===a&&s>=r.startTimeIndex&&s<r.startTimeIndex+r.span*2)||null},clearAllTripletStamps(){if(!this.state.tripletStampPlacements)return;const s=this.state.tripletStampPlacements.length>0;this.state.tripletStampPlacements=[],s&&(this.emit("tripletStampPlacementsChanged"),i("info","Cleared all triplet stamp placements"))},getTripletStampPlaybackData(){return this.state.tripletStampPlacements?this.state.tripletStampPlacements.map(s=>{const a=this.state.fullRowData[s.row];return{startTimeIndex:s.startTimeIndex,tripletStampId:s.tripletStampId,row:s.row,pitch:a?.toneNote??"",color:s.color,span:s.span,placement:s}}).filter(s=>s.pitch):[]},updateTripletStampShapeOffset(s,a,r){const c=this.state.tripletStampPlacements?.find(d=>d.id===s);if(!c){i("warn","[TRIPLET STAMP SHAPE OFFSET] Placement not found",{placementId:s});return}c.shapeOffsets||(c.shapeOffsets={}),i("debug","[TRIPLET STAMP SHAPE OFFSET] Updating shape offset",{placementId:s,shapeKey:a,oldOffset:c.shapeOffsets[a]||0,newOffset:r,baseRow:c.row,targetRow:c.row+r}),c.shapeOffsets[a]=r,this.emit("tripletStampPlacementsChanged")},getTripletStampShapeRow(s,a){const r=s.shapeOffsets?.[a]||0;return s.row+r}}}function Us(n){const t=JSON.parse(JSON.stringify(n));for(const e in t){const o=t[e];o.coeffs&&typeof o.coeffs=="object"&&!Array.isArray(o.coeffs)?o.coeffs=new Float32Array(Object.values(o.coeffs)):Array.isArray(o.coeffs)&&(o.coeffs=new Float32Array(o.coeffs)),o.phases&&typeof o.phases=="object"&&!Array.isArray(o.phases)?o.phases=new Float32Array(Object.values(o.phases)):Array.isArray(o.phases)&&(o.phases=new Float32Array(o.phases))}return t}function md(n,t){if(n)try{const e=n.getItem(t);if(e===null)return;const o=JSON.parse(e);if(o.timbres)for(const i in o.timbres){const s=o.timbres[i];if(s.coeffs&&typeof s.coeffs=="object"){const a=Array.isArray(s.coeffs)?s.coeffs:Object.values(s.coeffs);s.coeffs=new Float32Array(a)}if(s.phases&&typeof s.phases=="object"){const a=Array.isArray(s.phases)?s.phases:Object.values(s.phases);s.phases=new Float32Array(a)}}if(o.pitchRange){const i=se.length,s=Math.max(0,i-1),a=Math.max(0,Math.min(s,o.pitchRange.topIndex??0)),r=Math.max(a,Math.min(s,o.pitchRange.bottomIndex??s));o.pitchRange={topIndex:a,bottomIndex:r}}if("playheadMode"in o){const i=o.playheadMode;i!=="cursor"&&i!=="microbeat"&&i!=="macrobeat"&&delete o.playheadMode}return o.fullRowData=[...se],o}catch{return}}function fd(n,t,e){if(t)try{const o=JSON.parse(JSON.stringify({placedNotes:n.placedNotes,placedChords:n.placedChords,tonicSignGroups:n.tonicSignGroups,sixteenthStampPlacements:n.sixteenthStampPlacements,tripletStampPlacements:n.tripletStampPlacements,timbres:n.timbres,macrobeatGroupings:n.macrobeatGroupings,macrobeatBoundaryStyles:n.macrobeatBoundaryStyles,hasAnacrusis:n.hasAnacrusis,baseMicrobeatPx:n.baseMicrobeatPx,modulationMarkers:n.modulationMarkers,tempo:n.tempo,activeChordIntervals:n.activeChordIntervals,selectedNote:n.selectedNote,annotations:n.annotations,pitchRange:n.pitchRange,degreeDisplayMode:n.degreeDisplayMode,showOctaveLabels:n.showOctaveLabels,longNoteStyle:n.longNoteStyle,playheadMode:n.playheadMode}));if(n.timbres)for(const s in n.timbres){const a=n.timbres[s],r=o.timbres?.[s];a?.coeffs&&r&&(r.coeffs=Array.from(a.coeffs)),a?.phases&&r&&(r.phases=Array.from(a.phases))}const i=JSON.stringify(o);t.setItem(e,i)}catch{}}function pd(n={}){const{storageKey:t="studentNotationState",storage:e,initialState:o,onClearState:i,noteActionCallbacks:s={},sixteenthStampActionCallbacks:a={},tripletStampActionCallbacks:r={},rhythmActionCallbacks:c={}}=n,d={},u=md(e,t),h=!u,m={state:{...rd(),...u,...o},isColdStart:h,on(p,v){d[p]||(d[p]=[]),d[p].push(v)},off(p,v){if(d[p]){const y=d[p].indexOf(v);y>-1&&d[p].splice(y,1)}},emit(p,v){d[p]&&d[p].forEach(y=>{try{y(v)}catch(w){console.error(`Error in listener for event "${p}"`,w)}})},dispose(){for(const p in d)delete d[p]},saveState(){fd(m.state,e,t)},recordState(){m.state.history=m.state.history.slice(0,m.state.historyIndex+1);const p=JSON.parse(JSON.stringify(m.state.timbres)),v={notes:JSON.parse(JSON.stringify(m.state.placedNotes)),tonicSignGroups:JSON.parse(JSON.stringify(m.state.tonicSignGroups)),placedChords:JSON.parse(JSON.stringify(m.state.placedChords)),sixteenthStampPlacements:JSON.parse(JSON.stringify(m.state.sixteenthStampPlacements)),tripletStampPlacements:JSON.parse(JSON.stringify(m.state.tripletStampPlacements||[])),timbres:p,annotations:m.state.annotations?JSON.parse(JSON.stringify(m.state.annotations)):[],lassoSelection:JSON.parse(JSON.stringify(m.state.lassoSelection))};m.state.history.push(v),m.state.historyIndex++,m.emit("historyChanged"),m.saveState()},undo(){if(m.state.historyIndex>0){m.state.historyIndex--;const p=m.state.history[m.state.historyIndex];if(!p)return;m.state.placedNotes=JSON.parse(JSON.stringify(p.notes)),m.state.tonicSignGroups=JSON.parse(JSON.stringify(p.tonicSignGroups)),m.state.sixteenthStampPlacements=JSON.parse(JSON.stringify(p.sixteenthStampPlacements||[])),m.state.tripletStampPlacements=JSON.parse(JSON.stringify(p.tripletStampPlacements||[])),m.state.timbres=Us(p.timbres),m.state.annotations=p.annotations?JSON.parse(JSON.stringify(p.annotations)):[],m.emit("notesChanged"),m.emit("sixteenthStampPlacementsChanged"),m.emit("tripletStampPlacementsChanged"),m.emit("rhythmStructureChanged"),m.state.selectedNote?.color&&m.emit("timbreChanged",m.state.selectedNote.color),m.emit("annotationsChanged"),m.emit("historyChanged")}},redo(){if(m.state.historyIndex<m.state.history.length-1){m.state.historyIndex++;const p=m.state.history[m.state.historyIndex];if(!p)return;m.state.placedNotes=JSON.parse(JSON.stringify(p.notes)),m.state.tonicSignGroups=JSON.parse(JSON.stringify(p.tonicSignGroups)),m.state.sixteenthStampPlacements=JSON.parse(JSON.stringify(p.sixteenthStampPlacements||[])),m.state.tripletStampPlacements=JSON.parse(JSON.stringify(p.tripletStampPlacements||[])),m.state.timbres=Us(p.timbres),m.state.annotations=p.annotations?JSON.parse(JSON.stringify(p.annotations)):[],m.emit("notesChanged"),m.emit("sixteenthStampPlacementsChanged"),m.emit("tripletStampPlacementsChanged"),m.emit("rhythmStructureChanged"),m.state.selectedNote?.color&&m.emit("timbreChanged",m.state.selectedNote.color),m.emit("annotationsChanged"),m.emit("historyChanged")}},clearSavedState(){e&&(e.removeItem(t),e.removeItem("effectDialValues")),i&&i()},setPlaybackState(p,v){m.state.isPlaying=p,m.state.isPaused=v,m.emit("playbackStateChanged",{isPlaying:p,isPaused:v})},setLooping(p){m.state.isLooping=p,m.emit("loopingChanged",p)},setTempo(p){m.state.tempo=p,m.emit("tempoChanged",p)},setPlayheadMode(p){m.state.playheadMode=p,m.emit("playheadModeChanged",p)},setSelectedTool(p,v){const y=m.state.selectedTool;if(m.state.previousTool=y,m.state.selectedTool=p,v!==void 0){const w=typeof v=="string"?parseInt(v,10):v;isNaN(w)||(m.state.selectedToolTonicNumber=w)}m.emit("toolChanged",{newTool:p,oldTool:y})},setSelectedNote(p,v){const y={...m.state.selectedNote};m.state.selectedNote={shape:p,color:v},m.emit("noteChanged",{newNote:m.state.selectedNote,oldNote:y})},setPitchRange(p){m.state.pitchRange={...m.state.pitchRange,...p},m.emit("pitchRangeChanged",m.state.pitchRange)},setDegreeDisplayMode(p){m.state.degreeDisplayMode=p,m.emit("degreeDisplayModeChanged",p)},setLongNoteStyle(p){m.state.longNoteStyle=p,m.emit("longNoteStyleChanged",p)},toggleAccidentalMode(p){m.state.accidentalMode[p]=!m.state.accidentalMode[p],m.emit("accidentalModeChanged",m.state.accidentalMode)},toggleFrequencyLabels(){m.state.showFrequencyLabels=!m.state.showFrequencyLabels,m.emit("frequencyLabelsChanged",m.state.showFrequencyLabels)},toggleOctaveLabels(){m.state.showOctaveLabels=!m.state.showOctaveLabels,m.emit("octaveLabelsChanged",m.state.showOctaveLabels)},toggleFocusColours(){m.state.focusColours=!m.state.focusColours,m.emit("focusColoursChanged",m.state.focusColours)},toggleWaveformExtendedView(){m.state.waveformExtendedView=!m.state.waveformExtendedView,m.emit("waveformExtendedViewChanged",m.state.waveformExtendedView)},setLayoutConfig(p){p.cellWidth!==void 0&&(m.state.cellWidth=p.cellWidth),p.cellHeight!==void 0&&(m.state.cellHeight=p.cellHeight),p.columnWidths!==void 0&&(m.state.columnWidths=p.columnWidths),m.emit("layoutConfigChanged",p)},setDeviceProfile(p){m.state.deviceProfile={...m.state.deviceProfile,...p},m.emit("deviceProfileChanged",m.state.deviceProfile)},setPrintPreviewActive(p){m.state.isPrintPreviewActive=p,m.emit("printPreviewStateChanged",p)},setPrintOptions(p){m.state.printOptions={...m.state.printOptions,...p},m.emit("printOptionsChanged",m.state.printOptions)},setAdsrTimeAxisScale(p){m.state.adsrTimeAxisScale=p,m.emit("adsrTimeAxisScaleChanged",p)},setAdsrComponentWidth(){},shiftGridUp(){},shiftGridDown(){},setGridPosition(){},setKeySignature(p){m.state.keySignature=p,m.emit("keySignatureChanged",p)},setActiveChordIntervals(p){m.state.activeChordIntervals=p,m.emit("activeChordIntervalsChanged",p)},setIntervalsInversion(p){m.state.isIntervalsInverted=p,m.emit("intervalsInversionChanged",p)},setChordPosition(p){m.state.chordPositionState=p,m.emit("chordPositionChanged",p)},setADSR(p,v){m.state.timbres[p]&&(m.state.timbres[p].adsr={...m.state.timbres[p].adsr,...v},m.emit("timbreChanged",p))},setHarmonicCoefficients(p,v){m.state.timbres[p]&&(m.state.timbres[p].coeffs=v,m.emit("timbreChanged",p))},setHarmonicPhases(p,v){m.state.timbres[p]&&(m.state.timbres[p].phases=v,m.emit("timbreChanged",p))},setFilterSettings(p,v){m.state.timbres[p]&&(m.state.timbres[p].filter={...m.state.timbres[p].filter,...v},m.emit("timbreChanged",p))},applyPreset(p,v){m.state.timbres[p]&&(Object.assign(m.state.timbres[p],v),m.emit("timbreChanged",p))},...ld(s),...dd(a),...hd(r),...Fl(c)};return e&&(m.on("tempoChanged",()=>m.saveState()),m.on("degreeDisplayModeChanged",()=>m.saveState()),m.on("longNoteStyleChanged",()=>m.saveState()),m.on("playheadModeChanged",()=>m.saveState())),h&&e&&m.saveState(),m}class gd extends Ml{presetGain;vibratoLFO;vibratoDepth;vibratoGain;tremoloLFO;tremoloDepth;tremoloGain;hpFilter;lpFilterForBP;lpFilterSolo;hpOutput;bpOutput;lpOutput;hp_bp_fade;main_fade;wetDryFade;constructor(t){super(t),this.presetGain=new Ge(t.gain||1),this.vibratoLFO=new zs(0,0),this.vibratoDepth=new $s(-1,1),this.vibratoGain=new Ge(0),this.vibratoLFO.connect(this.vibratoDepth),this.vibratoDepth.connect(this.vibratoGain),this.vibratoGain.connect(this.oscillator.frequency),this.tremoloLFO=new zs(0,0),this.tremoloDepth=new $s(0,1),this.tremoloGain=new Ge(1),this.tremoloLFO.connect(this.tremoloDepth),this.tremoloDepth.connect(this.tremoloGain.gain),this.hpFilter=new ni({type:"highpass"}),this.lpFilterForBP=new ni({type:"lowpass"}),this.lpFilterSolo=new ni({type:"lowpass"}),this.hpOutput=new Ge,this.bpOutput=new Ge,this.lpOutput=new Ge,this.hp_bp_fade=new oi(0),this.main_fade=new oi(0),this.wetDryFade=new oi(0),this.oscillator.connect(this.presetGain),this.presetGain.connect(this.wetDryFade.a),this.presetGain.connect(this.hpFilter),this.hpFilter.connect(this.hpOutput),this.hpFilter.connect(this.lpFilterForBP),this.lpFilterForBP.connect(this.bpOutput),this.presetGain.connect(this.lpFilterSolo),this.lpFilterSolo.connect(this.lpOutput),this.hpOutput.connect(this.hp_bp_fade.a),this.bpOutput.connect(this.hp_bp_fade.b),this.lpOutput.connect(this.main_fade.b),this.hp_bp_fade.connect(this.main_fade.a),this.main_fade.connect(this.wetDryFade.b),this.wetDryFade.connect(this.tremoloGain),this.tremoloGain.connect(this.envelope),t.filter&&this._setFilter(t.filter),t.vibrato?this._setVibrato(t.vibrato):this._setVibrato({speed:0,span:0}),t.tremelo?this._setTremolo(t.tremelo):this._setTremolo({speed:0,span:0})}_setPresetGain(t){this.presetGain&&(this.presetGain.gain.value=t)}_setVibrato(t,e=Pt()){if(!this.vibratoLFO||!this.vibratoGain)return;const o=t.speed/100*16,s=(Hs()?.rawContext?.state??Gn.state)==="running";if(t.speed===0||t.span===0){s&&this.vibratoLFO.state==="started"&&this.vibratoLFO.stop(e),this.vibratoLFO.frequency.value=0,this.vibratoGain.gain.value=0;return}s&&this.vibratoLFO.state!=="started"&&this.vibratoLFO.start(e),this.vibratoLFO.frequency.value=o;const c=t.span/100*50/1200,h=440*(Math.pow(2,c)-1);this.vibratoGain.gain.value=h}_setTremolo(t,e=Pt()){if(!this.tremoloLFO||!this.tremoloGain)return;const o=t.speed/100*16,s=(Hs()?.rawContext?.state??Gn.state)==="running";if(t.speed===0||t.span===0){s&&this.tremoloLFO.state==="started"&&this.tremoloLFO.stop(e),this.tremoloLFO.frequency.value=0,this.tremoloGain.gain.cancelScheduledValues(e),this.tremoloGain.gain.value=1;return}s&&this.tremoloLFO.state!=="started"&&this.tremoloLFO.start(e),this.tremoloLFO.frequency.value=o;const a=t.span/100,r=Math.max(0,1-a),c=1;this.tremoloDepth.min=r,this.tremoloDepth.max=c}_setFilter(t){this.wetDryFade.fade.value=t.enabled?1:0;const e=Pl(t.cutoff+35).toFrequency(),o=t.resonance/100*12+.1;this.hpFilter.set({frequency:e,Q:o}),this.lpFilterForBP.set({frequency:e,Q:o}),this.lpFilterSolo.set({frequency:e,Q:o});const i=t.blend;i<=1?(this.main_fade.fade.value=0,this.hp_bp_fade.fade.value=i):(this.main_fade.fade.value=i-1,this.hp_bp_fade.fade.value=1)}}const sr={polyphonyReference:32,smoothingTauMs:200,masterGainRampMs:50,gainUpdateIntervalMs:16};function ar(n=sr.polyphonyReference){return 1/Math.sqrt(n)}class vd{masterGain;options;perVoiceBaselineGain;activeVoiceCount=0;smoothedVoiceCount;gainUpdateLoopId=null;constructor(t,e={}){this.masterGain=t,this.options={...sr,...e},this.perVoiceBaselineGain=ar(this.options.polyphonyReference),this.smoothedVoiceCount=this.options.polyphonyReference}start(){this.stop(),this.gainUpdateLoopId=setInterval(()=>this.updateMasterGain(),this.options.gainUpdateIntervalMs)}stop(){this.gainUpdateLoopId!==null&&(clearInterval(this.gainUpdateLoopId),this.gainUpdateLoopId=null)}noteOn(t=1){t<=0||(this.activeVoiceCount+=t)}noteOff(t=1){t<=0||(this.activeVoiceCount=Math.max(0,this.activeVoiceCount-t))}clampActiveVoiceCountToAtMost(t){Number.isFinite(t)&&(this.activeVoiceCount=Math.max(0,Math.min(this.activeVoiceCount,Math.floor(t))))}resetActiveVoiceCount(){this.activeVoiceCount=0}getActiveVoiceCount(){return this.activeVoiceCount}updateMasterGain(){const{polyphonyReference:t,smoothingTauMs:e,masterGainRampMs:o,gainUpdateIntervalMs:i}=this.options,s=Pt();if(this.activeVoiceCount===0){this.smoothedVoiceCount=.01*t+(1-.01)*this.smoothedVoiceCount;return}const a=i/1e3,r=1-Math.exp(-a/(e/1e3)),c=Math.max(1,this.activeVoiceCount);this.smoothedVoiceCount=r*c+(1-r)*this.smoothedVoiceCount;const d=Math.sqrt(t/this.smoothedVoiceCount),u=this.perVoiceBaselineGain*d;this.masterGain.gain.rampTo(u,o/1e3,s)}}const bd={clippingWarningThresholdDb:-3,clippingMonitorIntervalMs:500,clippingWarningCooldownMs:2e3};class yd{meter;options;clippingMonitorId=null;lastClippingWarningAt=0;constructor(t,e={}){this.meter=t,this.options={...bd,...e}}start(){this.stop(),this.lastClippingWarningAt=0,this.clippingMonitorId=setInterval(()=>{const t=this.meter.getValue(),e=Array.isArray(t)?t[0]:t;if(e===void 0||e<=this.options.clippingWarningThresholdDb)return;const o=Date.now();o-this.lastClippingWarningAt<this.options.clippingWarningCooldownMs||(this.lastClippingWarningAt=o,this.options.onWarning?.(e))},this.options.clippingMonitorIntervalMs)}stop(){this.clippingMonitorId!==null&&(clearInterval(this.clippingMonitorId),this.clippingMonitorId=null)}}function wd(n){const{timbres:t,masterVolume:e=0,effectsManager:o,harmonicFilter:i,logger:s,audioInit:a,getDrumVolume:r}=n,c={};let d=null,u=null,h=null,f=null,g=null,m={},p=null,v=null;const y={...t},w=s??{debug:()=>{},info:()=>{},warn:()=>{}};function S(E){if(i)return i.getFilteredCoefficients(E);const x=y[E];return x?.coeffs?x.coeffs:new Float32Array([0,1])}function M(E){const x=E.reduce((A,k)=>A+Math.abs(k),0);return x>1?Array.from(E).map(A=>A/x):Array.from(E)}const P={init(){this.stopBackgroundMonitors(),d=new Ge(ar()),p=new vd(d),p.start(),u=new or(e),h=new Il({threshold:-12,ratio:3,attack:.01,release:.1,knee:6}),f=new kl(-3),g=new Ll,d.connect(u),u.connect(h),h.connect(f),f.toDestination(),f.connect(g),g&&(v=new yd(g,{onWarning:E=>{w.warn("SynthEngine","Limiter input approaching clipping threshold",{level:E},"audio")}}),v.start());for(const E in y){const x=y[E];if(!x)continue;x.vibrato||(x.vibrato={speed:0,span:0}),x.tremelo||(x.tremelo={speed:0,span:0});const A=S(E),k=M(A),C=x.gain||1,N=new Nl({voice:gd,options:{oscillator:{type:"custom",partials:k},envelope:x.adsr,filter:x.filter,vibrato:x.vibrato,tremelo:x.tremelo,gain:C}}).connect(d);o&&d&&o.applySynthEffects(N,E,d);const L=N.triggerAttack.bind(N);N.triggerAttack=function(...W){const H=L(...W);return setTimeout(()=>{const Q=this._activeVoices;o?Q&&Q.size>0?Q.forEach(D=>{D.effectsApplied||(o.applyEffectsToVoice(D,E),D.effectsApplied=!0)}):this._voices&&Array.isArray(this._voices)&&this._voices.forEach(D=>{D&&!D.effectsApplied&&(o.applyEffectsToVoice(D,E),D.effectsApplied=!0)}):Q&&Q.size>0?Q.forEach(D=>{D._setVibrato&&D.vibratoApplied!==!0&&(D._setVibrato(this._currentVibrato),D.vibratoApplied=!0),D._setTremolo&&D.tremoloApplied!==!0&&(D._setTremolo(this._currentTremolo),D.tremoloApplied=!0)}):this._voices&&Array.isArray(this._voices)&&this._voices.forEach(D=>{D?._setVibrato&&D.vibratoApplied!==!0&&(D._setVibrato(this._currentVibrato),D.vibratoApplied=!0),D?._setTremolo&&D.tremoloApplied!==!0&&(D._setTremolo(this._currentTremolo),D.tremoloApplied=!0)})},10),H},N._currentVibrato=x.vibrato,N._currentTremolo=x.tremelo,N._currentFilter=x.filter,c[E]=N,w.debug("SynthEngine",`Created filtered synth for color: ${E}`,null,"audio")}w.info("SynthEngine","Initialized with multi-timbral support",null,"audio")},updateSynthForColor(E){const x=y[E],A=c[E];if(!A||!x)return;x.vibrato||(x.vibrato={speed:0,span:0}),x.tremelo||(x.tremelo={speed:0,span:0}),w.debug("SynthEngine",`Updating timbre for color ${E}`,null,"audio");const k=S(E),C=M(k);A.set({oscillator:{partials:C},envelope:x.adsr}),o&&d&&o.applySynthEffects(A,E,d),A._currentVibrato=x.vibrato,A._currentTremolo=x.tremelo,A._currentFilter=x.filter;const N=A._activeVoices;N&&N.size>0?N.forEach(L=>{if(L._setFilter&&L._setFilter(x.filter),L._setVibrato&&(L._setVibrato(x.vibrato),L.vibratoApplied=!0),L._setTremolo&&(L._setTremolo(x.tremelo),L.tremoloApplied=!0),L._setPresetGain){const W=x.gain||1;L._setPresetGain(W)}}):A._voices&&Array.isArray(A._voices)&&A._voices.forEach(L=>{if(L?._setVibrato&&(L._setVibrato(x.vibrato),L.vibratoApplied=!0),L?._setTremolo&&(L._setTremolo(x.tremelo),L.tremoloApplied=!0),L?._setFilter&&L._setFilter(x.filter),L?._setPresetGain){const W=x.gain||1;L._setPresetGain(W)}})},setBpm(E){try{et?.bpm&&(et.bpm.value=E,w.debug("SynthEngine",`Tone.Transport BPM updated to ${E}`,null,"audio"))}catch(x){w.warn("SynthEngine","Unable to update BPM on Tone.Transport",{tempo:E,error:x},"audio")}},setVolume(E){u&&(u.volume.value=E)},async playNote(E,x,A=Pt()){await(a||(()=>_o()))();const C=Object.keys(c);if(C.length===0)return;const[N]=C;if(!N)return;const L=c[N];L&&L.triggerAttackRelease(E,x,A)},triggerAttack(E,x,A=Pt(),k=!1){const C=c[x];if(C)if(p?.noteOn(1),k&&r){const N=r(),L=C.volume.value,W=L+20*Math.log10(N);C.volume.value=W,C.triggerAttack(E,A),setTimeout(()=>{C?.volume&&(C.volume.value=L)},100)}else C.triggerAttack(E,A)},triggerAttackInteractive(E,x){P.triggerAttack(E,x,Pt()+.02)},quickReleasePitches(E,x){const A=c[x];if(!A||!E||E.length===0)return;let k;try{const N=(typeof A.get=="function"?A.get():null)?.envelope?.release;k=typeof N=="number"?N:void 0,A.set({envelope:{release:.01}}),E.forEach(W=>{A.triggerRelease(W,Pt())});const L=A._activeVoices?.size??A._voices?.length??p?.getActiveVoiceCount()??0;p?.clampActiveVoiceCountToAtMost(L)}catch(C){w.warn("SynthEngine","quickReleasePitches failed",{err:C,color:x,pitches:E},"audio")}finally{if(k!==void 0)try{A.set({envelope:{release:k}})}catch{}}},triggerRelease(E,x,A=Pt()){const k=c[x];if(!k)return;k.triggerRelease(E,A),p?.noteOff(1);const C=k._activeVoices?.size??k._voices?.length??p?.getActiveVoiceCount()??0;p?.clampActiveVoiceCountToAtMost(C)},releaseAll(){for(const E in c)c[E]?.releaseAll();p?.resetActiveVoiceCount()},createWaveformAnalyzer(E){const x=c[E];return x?(m[E]||(m[E]=new Tl("waveform",1024),x.connect(m[E]),w.debug("SynthEngine",`Created waveform analyzer for color: ${E}`,null,"waveform")),m[E]):(w.warn("SynthEngine",`No synth found for color: ${E}`,null,"audio"),null)},getWaveformAnalyzer(E){return m[E]||null},getAllWaveformAnalyzers(){const E=new Map;for(const x in m)m[x]&&E.set(x,m[x]);return E},removeWaveformAnalyzer(E){m[E]&&(m[E].dispose(),delete m[E],w.debug("SynthEngine",`Removed waveform analyzer for color: ${E}`,null,"waveform"))},disposeAllWaveformAnalyzers(){for(const E in m)m[E]&&m[E].dispose();m={},w.debug("SynthEngine","Disposed all waveform analyzers",null,"waveform")},getSynth(E){return c[E]||null},getAllSynths(){return{...c}},getMainVolumeNode(){return u||null},getMasterGainNode(){return d||null},stopBackgroundMonitors(){v?.stop(),p?.stop()},dispose(){this.stopBackgroundMonitors(),this.disposeAllWaveformAnalyzers();for(const E in c)c[E]?.dispose();d?.dispose(),u?.dispose(),h?.dispose(),f?.dispose(),g?.dispose(),w.debug("SynthEngine","Disposed SynthEngine",null,"audio")}};return P}const Ys=1e-4;function Sd(n){const{getMacrobeatInfo:t,getPlacedTonicSigns:e,getTonicSpanColumnIndices:o,updatePlayheadModel:i,logger:s}=n;let a=[],r=0,c=0,d=0;const u=s??{debug:()=>{}};function h(m){return 60/(m*2)}function f(m,p,v){let y=0;u.debug("TimeMapCalculator","[TIMEMAP] Building timeMap",{columnCount:p.length,tonicSignCount:v.length,microbeatDuration:m});const w=p.length,S=o(v);for(let M=0;M<w;M++){a[M]=y;const P=S.has(M);if(P?u.debug("TimeMapCalculator",`[TIMEMAP] Column ${M} is tonic, not advancing time`):y+=(p[M]||0)*m,M<5){const E=a[M];E!==void 0&&u.debug("TimeMapCalculator",`[TIMEMAP] timeMap[${M}] = ${E.toFixed(3)}s (isTonic: ${P})`)}}w>0&&(a[w]=y),u.debug("TimeMapCalculator",`[TIMEMAP] Complete. Total columns: ${w}, Final time: ${y.toFixed(3)}s`)}function g(m){const p=a.length>0?a[a.length-1]??0:0;if(!Number.isFinite(p)||p===0){r=0;return}const v=m.modulationMarkers?.filter(S=>S.active)||[];if(v.length===0){r=p;return}const y=[...v].sort((S,M)=>S.measureIndex-M.measureIndex);let w=p;for(const S of y){const M=t(S.measureIndex);if(M){const P=M.endColumn-1,E=a[P]??p,x=p-E,A=x*S.ratio;w=w-x+A}}r=w}return{getMicrobeatDuration:h,calculate(m){u.debug("TimeMapCalculator","calculate",{tempo:`${m.tempo} BPM`}),a=[];const p=h(m.tempo),{columnWidths:v}=m,y=e();f(p,v,y),u.timing?.("TimeMapCalculator","calculate",{totalDuration:`${a[a.length-1]?.toFixed(2)}s`}),g(m),i?.({timeMap:a,musicalEndTime:r,columnWidths:m.columnWidths,cellWidth:m.cellWidth})},getTimeMap(){return a},getMusicalEndTime(){return r},findNonAnacrusisStart(m){if(!m.hasAnacrusis)return u.debug("TimeMapCalculator","[ANACRUSIS] No anacrusis, starting from time 0"),0;for(let p=0;p<m.macrobeatBoundaryStyles.length;p++)if(m.macrobeatBoundaryStyles[p]==="solid"){const v=t(p+1);if(v){const y=a[v.startColumn]||0;return u.debug("TimeMapCalculator",`[ANACRUSIS] Found solid boundary at macrobeat ${p}, non-anacrusis starts at column ${v.startColumn}, time ${y.toFixed(3)}s`),y}}return u.debug("TimeMapCalculator","[ANACRUSIS] No solid boundary found, starting from time 0"),0},applyModulationToTime(m,p,v){const y=v.modulationMarkers?.filter(M=>M.active)||[];if(y.length===0)return m;const w=[...y].sort((M,P)=>M.measureIndex-P.measureIndex);let S=m;p<5&&u.debug("TimeMapCalculator",`[MODULATION] Column ${p}: baseTime ${m.toFixed(3)}s, ${w.length} active markers`);for(const M of w){const P=t(M.measureIndex);if(P){const E=P.endColumn;if(p>E){const x=a[E]!==void 0?a[E]:0,A=m-x,k=A*M.ratio;S=S-A+k,p<5&&u.debug("TimeMapCalculator",`[MODULATION] Column ${p}: Applied marker at measure ${M.measureIndex} (col ${E}), ratio ${M.ratio}, adjustedTime ${S.toFixed(3)}s`)}}}return S},setLoopBounds(m,p,v){const y=h(v),w=Math.max(y,.001),S=Number.isFinite(m)?m:0;let M=Number.isFinite(p)?p:S+w;M<=S&&(M=S+w),c=S,d=M,et&&(et.loopStart=S,et.loopEnd=M)},getConfiguredLoopBounds(){return{loopStart:c,loopEnd:d}},setConfiguredLoopBounds(m,p){c=m,d=p},clearConfiguredLoopBounds(){c=0,d=0},reapplyConfiguredLoopBounds(m){if(d>c){const p=Nt(et.loopStart).toSeconds(),v=Nt(et.loopEnd).toSeconds(),y=Math.abs(p-c),w=Math.abs(v-d);(y>Ys||w>Ys)&&(et.loopStart=c,et.loopEnd=d),et.loop!==m&&(et.loop=m)}},updateLoopBoundsFromTimeline(m){const p=this.findNonAnacrusisStart(m),v=r;this.setLoopBounds(p,v,m.tempo)}}}const Cd={H:"https://tonejs.github.io/audio/drum-samples/CR78/hihat.mp3",M:"https://tonejs.github.io/audio/drum-samples/CR78/snare.mp3",L:"https://tonejs.github.io/audio/drum-samples/CR78/kick.mp3"},Ad=1e-4;function xd(n={}){const{samples:t=Cd,synthEngine:e,initialVolume:o=0}=n;let i=null,s=null;const a=new Map;function r(c,d){let u=Number.isFinite(d)?d:Pt();const h=a.get(c)??-1/0;return u>h||(u=h+Ad),a.set(c,u),u}if(s=new or(o),i=new ir(t).connect(s),e){const c=e.getMainVolumeNode?.();c?s.connect(c):s.toDestination()}else s.toDestination();return{getPlayers(){return i},getVolumeNode(){return s},trigger(c,d){if(!i)return;const u=r(c,d);i.player(c)?.start(u)},reset(){a.clear()},dispose(){i?.dispose(),s?.dispose(),i=null,s=null,a.clear()}}}const js="",Qs="";function Ed(n){const{synthEngine:t,stateCallbacks:e,eventCallbacks:o,visualCallbacks:i,logger:s,audioInit:a,playbackMode:r="standard"}=n,c=s??{debug:()=>{},info:()=>{},warn:()=>{}};let d=null,u=!1,h=null,f=null,g=1;const m=[];function p(C,N){const L=N.fullRowData[C];return L?L.toneNote.replace(js,"b").replace(Qs,"#"):"C4"}function v(C,N){const L=C.globalRow??C.row,W=N.fullRowData[L];return W?W.toneNote.replace(js,"b").replace(Qs,"#"):"C4"}function y(){if(!h)return;const C=e.getState();c.debug("TransportService","scheduleNotes","Clearing previous transport events and rescheduling all notes"),et.cancel(),f?.reset(),h.calculate(C),i?.clearAdsrVisuals?.();const N=h.getTimeMap(),{loopEnd:L}=h.getConfiguredLoopBounds(),W=h.findNonAnacrusisStart(C);c.debug("TransportService",`[ANACRUSIS] hasAnacrusis: ${C.hasAnacrusis}, anacrusisOffset: ${W.toFixed(3)}s`),C.placedNotes.forEach((D,U)=>{const V=D.startColumnIndex,j=D.endColumnIndex,at=N[V];if(at===void 0){c.warn("TransportService",`[NOTE SCHEDULE] Note ${U}: timeMap[${V}] undefined, skipping`);return}const mt=h.applyModulationToTime(at,V,C),vt=N[j+1];if(vt===void 0){c.warn("TransportService",`Skipping note with invalid endColumnIndex: ${D.endColumnIndex+1}`);return}const T=h.applyModulationToTime(vt,j+1,C)-mt;D.isDrum?w(D,mt):S(D,mt,T,L,C)});const H=e.getStampPlaybackData?.()??[];H.forEach(D=>{M(D,N,C)});const Q=e.getTripletPlaybackData?.()??[];Q.forEach(D=>{P(D,N,C)}),c.debug("TransportService","scheduleNotes",`Finished scheduling ${C.placedNotes.length} notes, ${H.length} stamps, and ${Q.length} triplets`)}function w(C,N){const L=e.getState();et.schedule(W=>{if(L.isPaused)return;const H=C.drumTrack;if(H==null)return;const Q=String(H);f?.trigger(Q,W),ii.schedule(()=>{i?.triggerDrumNotePop?.(C.startColumnIndex,H)},W)},N)}function S(C,N,L,W,H){const Q=v(C,H),D=C.color,U=C.globalRow??C.row,V=H.fullRowData[U]?.hex||"#888888",j=C.uuid,at=H.timbres[D];if(!at){c.warn("TransportService",`Timbre not found for color ${D}. Skipping note ${j}`);return}let mt=N+L;const dt=W-.001;mt>=W&&(mt=Math.max(N+.001,dt)),et.schedule(T=>{e.getState().isPaused||(t.triggerAttack(Q,D,T),ii.schedule(()=>{i?.triggerAdsrVisual?.(j,"attack",V,at.adsr),o.emit("noteAttack",{noteId:j,color:D})},T))},N),et.schedule(T=>{t.triggerRelease(Q,D,T),ii.schedule(()=>{i?.triggerAdsrVisual?.(j,"release",V,at.adsr),o.emit("noteRelease",{noteId:j,color:D})},T)},mt)}function M(C,N,L){const W=C.column,H=N[W];if(H===void 0)return;(e.getStampScheduleEvents?.(C.sixteenthStampId,C.placement)??[]).forEach(D=>{E(D,H,C.row,C.color,L)})}function P(C,N,L){const W=e.timeToCanvas?.(C.startTimeIndex,L)??C.startTimeIndex,H=N[W];if(H===void 0)return;(e.getTripletScheduleEvents?.(C.tripletStampId,C.placement)??[]).forEach(D=>{E(D,H,C.row,C.color,L)})}function E(C,N,L,W,H){const Q=Nt(C.offset).toSeconds(),D=Nt(C.duration).toSeconds(),U=N+Q,V=U+D,j=L+C.rowOffset,at=p(j,H);et.schedule(mt=>{e.getState().isPaused||t.triggerAttack(at,W,mt)},U),et.schedule(mt=>{e.getState().isPaused||t.triggerRelease(at,W,mt)},V)}function x(){const N=e.getState().tempo,L=1e-4,W=.5,H=U=>U?.xPosition??477.5,Q=typeof et?.bpm?.value=="number"?et.bpm.value:N;g=N!==0?Q/N:1,u=!0;function D(){if(!u||!h)return;if(et.state==="stopped"){d=requestAnimationFrame(D);return}const U=e.getState(),V=Nt(et.loopEnd).toSeconds(),j=U.isLooping,at=h.getMusicalEndTime(),mt=j&&V>0?V:at,vt=et.seconds,dt=vt>=mt-.001;if(!j&&dt){c.info("TransportService","Playback reached end. Stopping playhead."),k.stop();return}if(U.isPaused){d=requestAnimationFrame(D);return}const T=h.getTimeMap();i?.clearPlayheadCanvas?.(),i?.clearDrumPlayheadCanvas?.();let _=vt;if(j){const tt=Nt(et.loopStart).toSeconds(),pt=Nt(et.loopEnd).toSeconds()-tt;pt>0&&(_=(vt-tt)%pt+tt)}const G=e.getCanvasWidth?.()??1e3,X=e.getPlacedTonicSigns?.()??[],z=e.getTonicSpanColumnIndices?.(X)??new Set;let rt=0,R=0,F=0,I=-1;for(let tt=0;tt<T.length-1;tt++){const ut=T[tt],pt=T[tt+1];if(!(ut===void 0||pt===void 0)&&_>=ut&&_<pt){let bt=tt;for(;z.has(bt)&&bt<T.length-1;)bt++;const gt=e.getColumnStartX?.(bt)??0,K=e.getColumnWidth?.(bt)??10;if(R=gt,F=K,I=bt,z.has(tt))rt=gt;else{const st=pt-ut,ht=_-ut,Rt=st>0?ht/st:0;rt=gt+Rt*K}break}}const $=Math.min(rt,G);A(U,$,N,H,L,W);const O=i?.getPlayheadCanvasHeight?.()??500,q=i?.getDrumCanvasHeight?.()??100,Z=U.playheadMode==="macrobeat"&&I>=0?e.getMacrobeatHighlightRect?.(I):null,B=Z?.x??R,J=Z?.width??F;$>=0&&(U.playheadMode==="macrobeat"||U.playheadMode==="microbeat"?(i?.drawPlayheadHighlight?.(B,J,O,performance.now()),i?.drawDrumPlayheadHighlight?.(B,J,q,performance.now())):(i?.drawPlayheadLine?.($,O),i?.drawDrumPlayheadLine?.($,q)));const ot=U.playheadMode==="macrobeat"||U.playheadMode==="microbeat";i?.updateBeatLineHighlight?.(B,J,ot),d=requestAnimationFrame(D)}D()}function A(C,N,L,W,H,Q){if(!h)return;const U=(Array.isArray(C.modulationMarkers)?C.modulationMarkers:[]).filter(V=>V?.active&&typeof V.ratio=="number"&&V.ratio!==0).sort((V,j)=>W(V)-W(j));if(U.length>0){let V=1;for(const j of U){const at=W(j);if(N+Q>=at)V*=1/j.ratio;else break}if((!Number.isFinite(V)||V<=0)&&(V=1),Math.abs(V-g)>H){const j=L*V;et.bpm.value=j,h.reapplyConfiguredLoopBounds(C.isLooping),g=V,c.debug("TransportService",`Tempo multiplier updated to ${V.toFixed(3)} (${j.toFixed(2)} BPM)`)}}else Math.abs(g-1)>H&&(et.bpm.value=L,h.reapplyConfiguredLoopBounds(C.isLooping),g=1,c.debug("TransportService",`Tempo reset to base ${L} BPM`))}const k={init(){const C=e.getState();h=Sd({getMacrobeatInfo:e.getMacrobeatInfo??(()=>null),getPlacedTonicSigns:e.getPlacedTonicSigns??(()=>[]),getTonicSpanColumnIndices:e.getTonicSpanColumnIndices??(()=>new Set),logger:c}),f=xd({samples:{H:"/audio/drums/hi.mp3",M:"/audio/drums/mid.mp3",L:"/audio/drums/lo.mp3"},synthEngine:{getMainVolumeNode:()=>t.getMainVolumeNode()}}),et.bpm.value=C.tempo;const N=()=>this.handleStateChange(),L=()=>this.handleStateChange(),W=()=>this.handleStateChange(),H=()=>{if(h&&h.getTimeMap().length>0){const V=e.getState();h.calculate(V)}this.handleStateChange()},Q=V=>{const j=V?.oldConfig?.columnWidths||[],at=V?.newConfig?.columnWidths||[];j.length!==at.length&&h&&h.calculate(e.getState())},D=V=>{if(c.info("TransportService",`tempoChanged triggered with new value: ${V} BPM`),et.state==="started"){const j=et.position;et.pause(),d&&(cancelAnimationFrame(d),d=null),et.bpm.value=V,h?.reapplyConfiguredLoopBounds(e.getState().isLooping),y(),et.start(void 0,j),r==="standard"&&x()}else et.bpm.value=V,h?.reapplyConfiguredLoopBounds(e.getState().isLooping),h?.calculate(e.getState())},U=V=>{et.loop=V;const j=Nt(et.loopStart).toSeconds(),at=Nt(et.loopEnd).toSeconds();V&&at<=j&&h&&(et.loopEnd=j+Math.max(h.getMicrobeatDuration(e.getState().tempo),.001)),V&&h?h.setConfiguredLoopBounds(Nt(et.loopStart).toSeconds(),Nt(et.loopEnd).toSeconds()):h?.clearConfiguredLoopBounds()};o.on("rhythmStructureChanged",N),o.on("notesChanged",L),o.on("sixteenthStampPlacementsChanged",W),o.on("modulationMarkersChanged",H),o.on("layoutConfigChanged",Q),o.on("tempoChanged",D),o.on("loopingChanged",U),m.push(()=>{}),et.on("stop",()=>{c.info("TransportService","Tone.Transport 'stop' fired. Resetting playback state"),o.setPlaybackState?.(!1,!1),i?.clearAdsrVisuals?.(),d&&(cancelAnimationFrame(d),d=null)}),c.info("TransportService","Initialized")},handleStateChange(){if(et.state==="started"){c.debug("TransportService","handleStateChange: Notes or rhythm changed during playback. Rescheduling");const N=et.position;et.pause(),y(),et.start(void 0,N)}else h?.calculate(e.getState())},start(){c.info("TransportService","Starting playback"),(a||(()=>_o()))().then(()=>{y();const N=e.getState();h?.getTimeMap();const L=h?.getMusicalEndTime()??0,W=h?.findNonAnacrusisStart(N)??0;h?.setLoopBounds(W,L,N.tempo),et.bpm.value=N.tempo;const H=Pt()+.1;et.start(H,0),r==="standard"&&x(),o.emit("playbackStarted")})},resume(){c.info("TransportService","Resuming playback"),(a||(()=>_o()))().then(()=>{et.start(),r==="standard"&&x(),o.emit("playbackResumed")})},pause(){c.info("TransportService","Pausing playback"),et.pause(),d&&(cancelAnimationFrame(d),d=null),o.emit("playbackPaused")},stop(){c.info("TransportService","Stopping playback and clearing visuals"),u=!1,d&&(cancelAnimationFrame(d),d=null),et.stop(),et.cancel(),f?.reset();const C=e.getState();et.bpm.value=C.tempo,h?.reapplyConfiguredLoopBounds(C.isLooping),t.releaseAll(),i?.clearPlayheadCanvas?.(),i?.clearDrumPlayheadCanvas?.(),i?.updateBeatLineHighlight?.(0,0,!1),o.emit("playbackStopped")},dispose(){this.stop(),f?.dispose(),m.forEach(C=>C()),c.debug("TransportService","Disposed")}};return k}const Md={latencyHint:"playback",lookAhead:.1};function Pd(n={}){const{latencyHint:t,lookAhead:e}={...Md,...n};let o=!1;if(Gn.state==="suspended")try{Rl(new Bl({latencyHint:t})),o=!0}catch(i){console.warn("Failed to create new AudioContext, using default:",i)}return e!==void 0&&(Gn.lookAhead=e),o}class Td{logLevel;enabledLevels;categories;constructor(){this.logLevel="ERROR",this.enabledLevels={DEBUG:!1,INFO:!1,WARN:!1,ERROR:!0},this.categories={general:!1,state:!1,canvas:!1,audio:!1,ui:!1,layout:!1,harmony:!1,performance:!1,initialization:!1,transport:!1,grid:!1,toolbar:!1,zoom:!1,scroll:!1,keyboard:!1,mouse:!1,adsr:!1,filter:!1,waveform:!1,debug:!1}}enable(...t){t.forEach(e=>{Object.prototype.hasOwnProperty.call(this.categories,e)&&(this.categories[e]=!0)})}disable(...t){t.forEach(e=>{Object.prototype.hasOwnProperty.call(this.categories,e)&&(this.categories[e]=!1)})}enableAll(){Object.keys(this.categories).forEach(t=>{this.categories[t]=!0}),this.setLevel("DEBUG")}disableAll(){Object.keys(this.categories).forEach(t=>{this.categories[t]=!1}),this.setLevel("ERROR")}isCategoryEnabled(t){return this.categories[t]===!0}setLevel(t){const o=["DEBUG","INFO","WARN","ERROR"].indexOf(t);o!==-1&&(this.logLevel=t,this.enabledLevels={DEBUG:o<=0,INFO:o<=1,WARN:o<=2,ERROR:o<=3})}logWithConsole(t,e,o,i=null){if(typeof console<"u"&&console[t]){const s=i!==null?[e,o,i]:[e,o];console[t](...s)}}event(t,e,o="",i="ui"){!this.enabledLevels.INFO||this.isCategoryEnabled(i)}state(t,e,o=null,i="state"){!this.enabledLevels.INFO||this.isCategoryEnabled(i)}debug(t,e,o=null,i="debug"){!this.enabledLevels.DEBUG||!this.isCategoryEnabled(i)||this.logWithConsole("debug",t,e,o)}timing(t,e,o,i="performance"){!this.enabledLevels.DEBUG||!this.isCategoryEnabled(i)||this.logWithConsole("debug",t,e,o)}warn(t,e,o=null,i="general"){!this.enabledLevels.WARN||!this.isCategoryEnabled(i)||this.logWithConsole("warn",t,e,o)}error(t,e,o=null,i="general"){this.enabledLevels.ERROR&&this.logWithConsole("error",t,e,o)}info(t,e,o=null,i="general"){!this.enabledLevels.INFO||!this.isCategoryEnabled(i)||this.logWithConsole("info",t,e,o)}getConfig(){return{logLevel:this.logLevel,enabledLevels:{...this.enabledLevels},enabledCategories:Object.entries(this.categories).filter(([,t])=>t).map(([t])=>t)}}getAvailableCategories(){return Object.keys(this.categories)}section(t){this.enabledLevels.INFO&&this.info("Logger",`===== ${t} =====`,null,"general")}initStart(t){this.enabledLevels.INFO&&this.info(t,"init start",null,"initialization")}initSuccess(t){this.enabledLevels.INFO&&this.info(t,"init success",null,"initialization")}initFailed(t,e){if(this.enabledLevels.ERROR){const o=e?`init failed: ${e}`:"init failed";this.error(t,o,null,"initialization")}}moduleLoaded(t,e="initialization"){this.isCategoryEnabled(e)&&this.enabledLevels.INFO&&this.info(t,"loaded",null,e)}log(t,e,o=null){this.info(t,e,o,"general")}}const b=new Td;typeof window<"u"&&(window.logger=b);b.moduleLoaded("EngineStore","general");function Ks(){return{entries:[],visualToCanvas:new Map,visualToTime:new Map,canvasToVisual:new Map,canvasToTime:new Map,timeToCanvas:new Map,timeToVisual:new Map,macrobeatBoundaries:[],totalVisualColumns:0,totalCanvasColumns:0,totalTimeColumns:0,totalWidthUnmodulated:0}}const Id="studentNotationState",kd={getItem:n=>localStorage.getItem(n),setItem:(n,t)=>localStorage.setItem(n,t),removeItem:n=>localStorage.removeItem(n)},ao=(n,t,e,o,i)=>{const s=i||"general";switch(n){case"debug":b.debug(t,e,o,s);break;case"info":b.info(t,e,o,s);break;case"warn":b.warn(t,e,o,s);break;case"error":b.error(t,e,o,s);break}};let ee={};function Ld(n){ee=n,b.info("EngineStore","Column map callbacks registered")}const l=pd({storageKey:Id,storage:kd,onClearState:()=>{localStorage.removeItem("effectDialValues"),window.location.reload()},noteActionCallbacks:{getMacrobeatInfo:(n,t)=>{const e=n.macrobeatGroupings||[];let o=0;for(let s=0;s<t&&s<e.length;s++)o+=e[s]||2;const i=o+(e[t]||2)-1;return{startColumn:o,endColumn:i}},log:(n,t,e)=>ao(n,"noteActions",t,e)},rhythmActionCallbacks:{getColumnMap:n=>ee.getColumnMap?ee.getColumnMap(n):Ks(),visualToTimeIndex:(n,t,e)=>ee.visualToTimeIndex?ee.visualToTimeIndex(n,t,e):t,timeIndexToVisualColumn:(n,t,e)=>ee.timeIndexToVisualColumn?ee.timeIndexToVisualColumn(n,t,e):t,getTimeBoundaryAfterMacrobeat:(n,t,e)=>{if(ee.getTimeBoundaryAfterMacrobeat)return ee.getTimeBoundaryAfterMacrobeat(n,t,e);let o=0;for(let i=0;i<=t&&i<e.length;i++)o+=e[i]||2;return o},log:ao},sixteenthStampActionCallbacks:{log:(n,t,e)=>ao(n,"sixteenthStampActions",t,e)},tripletStampActionCallbacks:{canvasToTime:(n,t)=>t.canvasToTime.get(n)??null,timeToCanvas:(n,t)=>t.timeToCanvas.get(n)??n,getColumnMap:n=>ee.getColumnMap?ee.getColumnMap(n):Ks(),log:(n,t,e)=>ao(n,"tripletStampActions",t,e)}}),Ae=[{pitch:"C8",flatName:"C8",sharpName:"C8",toneNote:"C8",frequency:4186.01,column:"A",hex:"#fcfcfc",isAccidental:!1},{pitch:"B7",flatName:"B7",sharpName:"B7",toneNote:"B7",frequency:3951.07,column:"B",hex:"#fcf7fc",isAccidental:!1},{pitch:"B/A7",flatName:"B7",sharpName:"A7",toneNote:"Bb7",frequency:3729.31,column:"A",hex:"#f7f5fd",isAccidental:!0},{pitch:"A7",flatName:"A7",sharpName:"A7",toneNote:"A7",frequency:3520,column:"B",hex:"#f0f4ff",isAccidental:!1},{pitch:"A/G7",flatName:"A7",sharpName:"G7",toneNote:"Ab7",frequency:3322.44,column:"A",hex:"#e6f3fd",isAccidental:!0},{pitch:"G7",flatName:"G7",sharpName:"G7",toneNote:"G7",frequency:3135.96,column:"B",hex:"#def3f7",isAccidental:!1},{pitch:"G/F7",flatName:"G7",sharpName:"F7",toneNote:"Gb7",frequency:2959.96,column:"A",hex:"#daf2ec",isAccidental:!0},{pitch:"F7",flatName:"F7",sharpName:"F7",toneNote:"F7",frequency:2793.83,column:"B",hex:"#dcefdf",isAccidental:!1},{pitch:"E7",flatName:"E7",sharpName:"E7",toneNote:"E7",frequency:2637.02,column:"A",hex:"#e3ebd1",isAccidental:!1},{pitch:"E/D7",flatName:"E7",sharpName:"D7",toneNote:"Eb7",frequency:2489.02,column:"B",hex:"#eee4c8",isAccidental:!0},{pitch:"D7",flatName:"D7",sharpName:"D7",toneNote:"D7",frequency:2349.32,column:"A",hex:"#f8dcc6",isAccidental:!1},{pitch:"D/C7",flatName:"D7",sharpName:"C7",toneNote:"Db7",frequency:2217.46,column:"B",hex:"#fcd4cd",isAccidental:!0},{pitch:"C7",flatName:"C7",sharpName:"C7",toneNote:"C7",frequency:2093,column:"A",hex:"#facfdb",isAccidental:!1},{pitch:"B6",flatName:"B6",sharpName:"B6",toneNote:"B6",frequency:1975.53,column:"B",hex:"#efcdeb",isAccidental:!1},{pitch:"B/A6",flatName:"B6",sharpName:"A6",toneNote:"Bb6",frequency:1864.66,column:"A",hex:"#ddcff9",isAccidental:!0},{pitch:"A6",flatName:"A6",sharpName:"A6",toneNote:"A6",frequency:1760,column:"B",hex:"#c4d3ff",isAccidental:!1},{pitch:"A/G6",flatName:"A6",sharpName:"G6",toneNote:"Ab6",frequency:1661.22,column:"A",hex:"#abd9fa",isAccidental:!0},{pitch:"G6",flatName:"G6",sharpName:"G6",toneNote:"G6",frequency:1567.94,column:"B",hex:"#98dde9",isAccidental:!1},{pitch:"G/F6",flatName:"G6",sharpName:"F6",toneNote:"Gb6",frequency:1479.98,column:"A",hex:"#96ddcf",isAccidental:!0},{pitch:"F6",flatName:"F6",sharpName:"F6",toneNote:"F6",frequency:1396.91,column:"B",hex:"#a6d9b0",isAccidental:!1},{pitch:"E6",flatName:"E6",sharpName:"E6",toneNote:"E6",frequency:1318.51,column:"A",hex:"#c0d093",isAccidental:!1},{pitch:"E/D6",flatName:"E6",sharpName:"D6",toneNote:"Eb6",frequency:1244.51,column:"B",hex:"#dbc383",isAccidental:!0},{pitch:"D6",flatName:"D6",sharpName:"D6",toneNote:"D6",frequency:1174.66,column:"A",hex:"#efb586",isAccidental:!1},{pitch:"D/C6",flatName:"D6",sharpName:"C6",toneNote:"Db6",frequency:1108.73,column:"B",hex:"#f8a99c",isAccidental:!0},{pitch:"C6",flatName:"C6",sharpName:"C6",toneNote:"C6",frequency:1046.5,column:"A",hex:"#f3a2bb",isAccidental:!1},{pitch:"B5",flatName:"B5",sharpName:"B5",toneNote:"B5",frequency:987.77,column:"B",hex:"#e1a3db",isAccidental:!1},{pitch:"B/A5",flatName:"B5",sharpName:"A5",toneNote:"Bb5",frequency:932.33,column:"A",hex:"#c3a9f4",isAccidental:!0},{pitch:"A5",flatName:"A5",sharpName:"A5",toneNote:"A5",frequency:880,column:"B",hex:"#9ab2ff",isAccidental:!1},{pitch:"A/G5",flatName:"A5",sharpName:"G5",toneNote:"Ab5",frequency:830.61,column:"A",hex:"#67bdf7",isAccidental:!0},{pitch:"G5",flatName:"G5",sharpName:"G5",toneNote:"G5",frequency:783.99,column:"B",hex:"#30c6dc",isAccidental:!1},{pitch:"G/F5",flatName:"G5",sharpName:"F5",toneNote:"Gb5",frequency:739.99,column:"A",hex:"#32c8b2",isAccidental:!0},{pitch:"F5",flatName:"F5",sharpName:"F5",toneNote:"F5",frequency:698.46,column:"B",hex:"#6dc281",isAccidental:!1},{pitch:"E5",flatName:"E5",sharpName:"E5",toneNote:"E5",frequency:659.25,column:"A",hex:"#a0b556",isAccidental:!1},{pitch:"E/D5",flatName:"E5",sharpName:"D5",toneNote:"Eb5",frequency:622.25,column:"B",hex:"#c5a33f",isAccidental:!0},{pitch:"D5",flatName:"D5",sharpName:"D5",toneNote:"D5",frequency:587.33,column:"A",hex:"#dc9150",isAccidental:!1},{pitch:"D/C5",flatName:"D5",sharpName:"C5",toneNote:"Db5",frequency:554.37,column:"B",hex:"#e38475",isAccidental:!0},{pitch:"C5",flatName:"C5",sharpName:"C5",toneNote:"C5",frequency:523.25,column:"A",hex:"#dc7f9d",isAccidental:!1},{pitch:"B4",flatName:"B4",sharpName:"B4",toneNote:"B4",frequency:493.88,column:"B",hex:"#c781c0",isAccidental:!1},{pitch:"B/A4",flatName:"B4",sharpName:"A4",toneNote:"Bb4",frequency:466.16,column:"A",hex:"#a68ad8",isAccidental:!0},{pitch:"A4",flatName:"A4",sharpName:"A4",toneNote:"A4",frequency:440,column:"B",hex:"#7d94e0",isAccidental:!1},{pitch:"A/G4",flatName:"A4",sharpName:"G4",toneNote:"Ab4",frequency:415.3,column:"A",hex:"#4c9fd5",isAccidental:!0},{pitch:"G4",flatName:"G4",sharpName:"G4",toneNote:"G4",frequency:392,column:"B",hex:"#0fa6ba",isAccidental:!1},{pitch:"G/F4",flatName:"G4",sharpName:"F4",toneNote:"Gb4",frequency:369.99,column:"A",hex:"#24a794",isAccidental:!0},{pitch:"F4",flatName:"F4",sharpName:"F4",toneNote:"F4",frequency:349.23,column:"B",hex:"#5aa26a",isAccidental:!1},{pitch:"E4",flatName:"E4",sharpName:"E4",toneNote:"E4",frequency:329.63,column:"A",hex:"#849646",isAccidental:!1},{pitch:"E/D4",flatName:"E4",sharpName:"D4",toneNote:"Eb4",frequency:311.13,column:"B",hex:"#a38733",isAccidental:!0},{pitch:"D4",flatName:"D4",sharpName:"D4",toneNote:"D4",frequency:293.66,column:"A",hex:"#b67740",isAccidental:!1},{pitch:"D/C4",flatName:"D4",sharpName:"C4",toneNote:"Db4",frequency:277.18,column:"B",hex:"#bc6c5f",isAccidental:!0},{pitch:"C4",flatName:"C4",sharpName:"C4",toneNote:"C4",frequency:261.63,column:"A",hex:"#b56880",isAccidental:!1},{pitch:"B3",flatName:"B3",sharpName:"B3",toneNote:"B3",frequency:246.94,column:"B",hex:"#a3699e",isAccidental:!1},{pitch:"B/A3",flatName:"B3",sharpName:"A3",toneNote:"Bb3",frequency:233.08,column:"A",hex:"#8870b1",isAccidental:!0},{pitch:"A3",flatName:"A3",sharpName:"A3",toneNote:"A3",frequency:220,column:"B",hex:"#6578b7",isAccidental:!1},{pitch:"A/G3",flatName:"A3",sharpName:"G3",toneNote:"Ab3",frequency:207.65,column:"A",hex:"#3c81ad",isAccidental:!0},{pitch:"G3",flatName:"G3",sharpName:"G3",toneNote:"G3",frequency:196,column:"B",hex:"#0e8696",isAccidental:!1},{pitch:"G/F3",flatName:"G3",sharpName:"F3",toneNote:"Gb3",frequency:185,column:"A",hex:"#1b8777",isAccidental:!0},{pitch:"F3",flatName:"F3",sharpName:"F3",toneNote:"F3",frequency:174.61,column:"B",hex:"#478255",isAccidental:!1},{pitch:"E3",flatName:"E3",sharpName:"E3",toneNote:"E3",frequency:164.81,column:"A",hex:"#697836",isAccidental:!1},{pitch:"E/D3",flatName:"E3",sharpName:"D3",toneNote:"Eb3",frequency:155.56,column:"B",hex:"#836b27",isAccidental:!0},{pitch:"D3",flatName:"D3",sharpName:"D3",toneNote:"D3",frequency:146.83,column:"A",hex:"#925e32",isAccidental:!1},{pitch:"D/C3",flatName:"D3",sharpName:"C3",toneNote:"Db3",frequency:138.59,column:"B",hex:"#96554b",isAccidental:!0},{pitch:"C3",flatName:"C3",sharpName:"C3",toneNote:"C3",frequency:130.81,column:"A",hex:"#905165",isAccidental:!1},{pitch:"B2",flatName:"B2",sharpName:"B2",toneNote:"B2",frequency:123.47,column:"B",hex:"#80527c",isAccidental:!1},{pitch:"B/A2",flatName:"B2",sharpName:"A2",toneNote:"Bb2",frequency:116.54,column:"A",hex:"#6a578c",isAccidental:!0},{pitch:"A2",flatName:"A2",sharpName:"A2",toneNote:"A2",frequency:110,column:"B",hex:"#4e5e90",isAccidental:!1},{pitch:"A/G2",flatName:"A2",sharpName:"G2",toneNote:"Ab2",frequency:103.83,column:"A",hex:"#2d6488",isAccidental:!0},{pitch:"G2",flatName:"G2",sharpName:"G2",toneNote:"G2",frequency:98,column:"B",hex:"#096875",isAccidental:!1},{pitch:"G/F2",flatName:"G2",sharpName:"F2",toneNote:"Gb2",frequency:92.5,column:"A",hex:"#13685b",isAccidental:!0},{pitch:"F2",flatName:"F2",sharpName:"F2",toneNote:"F2",frequency:87.31,column:"B",hex:"#356440",isAccidental:!1},{pitch:"E2",flatName:"E2",sharpName:"E2",toneNote:"E2",frequency:82.41,column:"A",hex:"#505c28",isAccidental:!1},{pitch:"E/D2",flatName:"E2",sharpName:"D2",toneNote:"Eb2",frequency:77.78,column:"B",hex:"#63511c",isAccidental:!0},{pitch:"D2",flatName:"D2",sharpName:"D2",toneNote:"D2",frequency:73.42,column:"A",hex:"#6e4724",isAccidental:!1},{pitch:"D/C2",flatName:"D2",sharpName:"C2",toneNote:"Db2",frequency:69.3,column:"B",hex:"#713f37",isAccidental:!0},{pitch:"C2",flatName:"C2",sharpName:"C2",toneNote:"C2",frequency:65.41,column:"A",hex:"#6c3c4b",isAccidental:!1},{pitch:"B1",flatName:"B1",sharpName:"B1",toneNote:"B1",frequency:61.74,column:"B",hex:"#603c5d",isAccidental:!1},{pitch:"B/A1",flatName:"B1",sharpName:"A1",toneNote:"Bb1",frequency:58.27,column:"A",hex:"#4e4068",isAccidental:!0},{pitch:"A1",flatName:"A1",sharpName:"A1",toneNote:"A1",frequency:55,column:"B",hex:"#38446b",isAccidental:!1},{pitch:"A/G1",flatName:"A1",sharpName:"G1",toneNote:"Ab1",frequency:51.91,column:"A",hex:"#1f4964",isAccidental:!0},{pitch:"G1",flatName:"G1",sharpName:"G1",toneNote:"G1",frequency:49,column:"B",hex:"#044b55",isAccidental:!1},{pitch:"G/F1",flatName:"G1",sharpName:"F1",toneNote:"Gb1",frequency:46.25,column:"A",hex:"#0c4b41",isAccidental:!0},{pitch:"F1",flatName:"F1",sharpName:"F1",toneNote:"F1",frequency:43.65,column:"B",hex:"#24472c",isAccidental:!1},{pitch:"E1",flatName:"E1",sharpName:"E1",toneNote:"E1",frequency:41.2,column:"A",hex:"#38401a",isAccidental:!1},{pitch:"E/D1",flatName:"E1",sharpName:"D1",toneNote:"Eb1",frequency:38.89,column:"B",hex:"#463811",isAccidental:!0},{pitch:"D1",flatName:"D1",sharpName:"D1",toneNote:"D1",frequency:36.71,column:"A",hex:"#4d3017",isAccidental:!1},{pitch:"D/C1",flatName:"D1",sharpName:"C1",toneNote:"Db1",frequency:34.65,column:"B",hex:"#4f2a24",isAccidental:!0},{pitch:"C1",flatName:"C1",sharpName:"C1",toneNote:"C1",frequency:32.7,column:"A",hex:"#4a2733",isAccidental:!1},{pitch:"B0",flatName:"B0",sharpName:"B0",toneNote:"B0",frequency:30.87,column:"B",hex:"#41273f",isAccidental:!1},{pitch:"B/A0",flatName:"B0",sharpName:"A0",toneNote:"Bb0",frequency:29.14,column:"A",hex:"#342a46",isAccidental:!0},{pitch:"A0",flatName:"A0",sharpName:"A0",toneNote:"A0",frequency:27.5,column:"B",hex:"#242c48",isAccidental:!1}],Nd=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"],Ot=n=>n.tonicSignGroups?Object.values(n.tonicSignGroups).flat():[],Ut=(n,t)=>{const e=Dt.getColumnMap(n),{macrobeatGroupings:o}=n,i=o[t]??0;let s=null,a=null;for(const r of e.entries)r.macrobeatIndex===t&&r.type==="beat"&&((s===null||r.canvasIndex!==null&&r.canvasIndex<s)&&(s=r.canvasIndex),(a===null||r.canvasIndex!==null&&r.canvasIndex>a)&&(a=r.canvasIndex));if(s===null||a===null){let r=0;const c=Ot(n);c.some(d=>d.preMacrobeatIndex===-1)&&(r+=2);for(let d=0;d<t;d++)r+=o[d]??0,c.some(u=>u.preMacrobeatIndex===d)&&(r+=2);s=r,a=s+i-1}return{startColumn:s,endColumn:a,grouping:i}},Rd=n=>n.placedNotes.filter(t=>!t.isDrum),Bd=n=>n.placedNotes.filter(t=>t.isDrum),Dd=(n,t)=>{const o=Ot(n).filter(d=>d.columnIndex<=t);if(o.length===0)return{keyTonic:"C",keyMode:"major"};const i=o.reduce((d,u)=>u.columnIndex>d.columnIndex?u:d),s=typeof i.globalRow=="number"?i.globalRow:i.row,a=Ae[s]??n.fullRowData[i.row];if(!a)return{keyTonic:"C",keyMode:"major"};const r=Bi(a.toneNote),c=Nd[i.tonicNumber-1]||"major";return{keyTonic:r,keyMode:c}},un=12,_d=50,Fd=.5,ie=3,ro=1,Rn=30,Vn=30,Xn=.5,Zs=3,Wd=.7,Od=.9,zd=4,$d=1.5,Hd=.15,qd=.2,Gd=1,Un=1.5,Vd="#CCCCCC",rr=1,Js=3,ta=5,Xd=7,xo=16,Ud=0,Yd=255;class jd{cachedMap=null;cacheKey=null;getColumnMap(t){const e=this.buildCacheKey(t);return this.cachedMap&&this.isCacheValid(e)?this.cachedMap:(this.cachedMap=this.buildColumnMap(t),this.cacheKey=e,this.cachedMap)}invalidate(){this.cachedMap=null,this.cacheKey=null}buildCacheKey(t){const o=Ot(t).map(i=>`${i.columnIndex}:${i.preMacrobeatIndex}:${i.uuid||""}`).sort().join("|");return{macrobeatGroupings:[...t.macrobeatGroupings],tonicSignsHash:o,macrobeatBoundaryStyles:[...t.macrobeatBoundaryStyles]}}isCacheValid(t){return this.cacheKey?this.cacheKey.tonicSignsHash===t.tonicSignsHash&&JSON.stringify(this.cacheKey.macrobeatGroupings)===JSON.stringify(t.macrobeatGroupings)&&JSON.stringify(this.cacheKey.macrobeatBoundaryStyles)===JSON.stringify(t.macrobeatBoundaryStyles):!1}buildColumnMap(t){const{macrobeatGroupings:e,macrobeatBoundaryStyles:o}=t,s=[...Ot(t)].sort((P,E)=>P.preMacrobeatIndex-E.preMacrobeatIndex),a=[],r=[];let c=0,d=0,u=0,h=0,f=0;const g=P=>{for(;f<s.length;){const E=s[f];if(!E||E.preMacrobeatIndex!==P)break;const x=E.uuid||"";for(let k=0;k<2;k++)a.push({visualIndex:c,canvasIndex:d,timeIndex:null,type:"tonic",widthMultiplier:ro,xOffsetUnmodulated:h,macrobeatIndex:null,beatInMacrobeat:null,isMacrobeatStart:!1,isMacrobeatEnd:!1,isPlayable:!1,tonicSignUuid:k===0?x:null}),c++,d++,h+=ro;const A=x;do f++;while(f<s.length&&(s[f]?.uuid||"")===A)}};for(let P=0;P<2;P++)a.push({visualIndex:c,canvasIndex:null,timeIndex:null,type:"legend-left",widthMultiplier:ie,xOffsetUnmodulated:h,macrobeatIndex:null,beatInMacrobeat:null,isMacrobeatStart:!1,isMacrobeatEnd:!1,isPlayable:!1,tonicSignUuid:null}),c++,h+=ie;g(-1),e.forEach((P,E)=>{for(let A=0;A<P;A++)a.push({visualIndex:c,canvasIndex:d,timeIndex:u,type:"beat",widthMultiplier:ro,xOffsetUnmodulated:h,macrobeatIndex:E,beatInMacrobeat:A,isMacrobeatStart:A===0,isMacrobeatEnd:A===P-1,isPlayable:!0,tonicSignUuid:null}),c++,d++,u++,h+=ro;const x=o[E]||"dashed";r.push({macrobeatIndex:E,visualColumn:c-1,canvasColumn:d-1,timeColumn:u-1,boundaryType:x,isMeasureStart:x==="solid"}),g(E)});for(let P=0;P<2;P++)a.push({visualIndex:c,canvasIndex:null,timeIndex:null,type:"legend-right",widthMultiplier:ie,xOffsetUnmodulated:h,macrobeatIndex:null,beatInMacrobeat:null,isMacrobeatStart:!1,isMacrobeatEnd:!1,isPlayable:!1,tonicSignUuid:null}),c++,h+=ie;const m=new Map,p=new Map,v=new Map,y=new Map,w=new Map,S=new Map;return a.forEach(P=>{m.set(P.visualIndex,P.canvasIndex),p.set(P.visualIndex,P.timeIndex),P.canvasIndex!==null&&(v.set(P.canvasIndex,P.visualIndex),y.set(P.canvasIndex,P.timeIndex)),P.timeIndex!==null&&(P.canvasIndex!==null&&w.set(P.timeIndex,P.canvasIndex),S.set(P.timeIndex,P.visualIndex))}),{entries:a,visualToCanvas:m,visualToTime:p,canvasToVisual:v,canvasToTime:y,timeToCanvas:w,timeToVisual:S,macrobeatBoundaries:r,totalVisualColumns:c,totalCanvasColumns:d,totalTimeColumns:u,totalWidthUnmodulated:h}}}const Dt=new jd;function Qd(n){n.on("rhythmStructureChanged",()=>{Dt.invalidate()})}function Kd(n,t){return Dt.getColumnMap(t).visualToTime.get(n)??null}function Oe(n,t){return Dt.getColumnMap(t).canvasToTime.get(n)??null}function Yt(n,t){const o=Dt.getColumnMap(t).timeToCanvas.get(n);return o!==void 0?o:n}function Zd(n,t){const o=Dt.getColumnMap(t).timeToVisual.get(n);return o!==void 0?o:n+2}function Jd(n,t){const e=Dt.getColumnMap(t),o=e.canvasToVisual.get(n);return o!==void 0&&e.entries[o]||null}function tu(n,t){return Jd(n,t)?.isPlayable??!1}function eu(n){const t=Dt.getColumnMap(n),e=[];for(const o of t.entries)o.canvasIndex!==null&&(e[o.canvasIndex]=o.widthMultiplier);return e}function Di(n,...t){}const Kt={COMPRESSION_2_3:2/3,EXPANSION_3_2:3/2};function nu(n,t){if(!t||!t.macrobeatGroupings)return n*4;if(n===0)return 0;const e=n-1,o=Ut(t,e);if(o){const s=o.endColumn+1;return Di("log","[MODULATION] Found measure info, canvas-space endColumn:",o.endColumn,"first column after:",s),s}return n*4}function lr(n){return Math.abs(n-Kt.COMPRESSION_2_3)<.001?"2:3":Math.abs(n-Kt.EXPANSION_3_2)<.001?"3:2":`${n}`}function cr(n){const t="#ffc107";return Math.abs(n-Kt.COMPRESSION_2_3)<.001||Math.abs(n-Kt.EXPANSION_3_2)<.001,t}function ea(){const n=[{startColumn:0,endColumn:1/0,scale:1}];return{segments:n,getScaleForColumn(t){return 1},microbeatToCanvasX(){return 0},canvasXToMicrobeat(){return 0},getSegmentAtX(){return n[0]||null},getGhostGridPositions(){return[]}}}function ou(n,t,e=null){if(!n||n.length===0)return ea();const o=[...n.filter(d=>d.active)].sort((d,u)=>d.measureIndex-u.measureIndex);if(o.length===0)return ea();const i=o.map(d=>{const u=nu(d.measureIndex,e);return Di("log",`[MODULATION] Marker at measure ${d.measureIndex} calculated column=${u}`),Di("log","[MODULATION] Final marker position:",{id:d.id,measureIndex:d.measureIndex,columnIndex:u}),{...d,columnIndex:u}}),s=[];let a=1;const r=i[0];if(i.length===0||r&&r.columnIndex>0){const d=r?r.columnIndex:1/0;s.push({startColumn:0,endColumn:d,scale:1})}for(let d=0;d<i.length;d++){const u=i[d],h=i[d+1],f=h?h.columnIndex:1/0;a*=u.ratio,s.push({startColumn:u.columnIndex,endColumn:f,scale:a,marker:u})}return{segments:s,getScaleForColumn(d){for(const u of s)if(d>=u.startColumn&&d<u.endColumn)return u.scale;return 1},microbeatToCanvasX(d){return 0},canvasXToMicrobeat(d){return 0},getSegmentAtX(d){return s[0]||null},getGhostGridPositions(d,u){return[]}}}class iu{cachedPixelMap=null;lastPixelMapHash=null;getColumnPixelPosition(t,e,o){const i=this.getOrBuildPixelMap(e,o),s=i.columnPositions.get(Math.floor(t));if(s)return s;const a=i.columnPositions.size;return t===a&&i.columnPositions.get(a-1)?{canvasIndex:t,xStart:i.totalPixelWidth,xEnd:i.totalPixelWidth,width:0,modulationScale:1}:this.calculateFallbackPosition(t,e)}columnToPixelX(t,e,o){const i=Math.floor(t),s=t-i,a=this.getColumnPixelPosition(i,e,o);return a.xStart+s*a.width}pixelXToColumn(t,e,o){const i=this.getOrBuildPixelMap(e,o),s=Array.from(i.columnPositions.values()).sort((c,d)=>c.canvasIndex-d.canvasIndex);for(const c of s)if(t>=c.xStart&&t<c.xEnd){const d=(t-c.xStart)/c.width;return c.canvasIndex+d}if(s.length===0)return 0;const a=s[0];return!a||t<a.xStart?0:s[s.length-1]?.canvasIndex??0}invalidate(){this.cachedPixelMap=null,this.lastPixelMapHash=null}getOrBuildPixelMap(t,e){const o=this.buildPixelMapHash(t,e);return this.cachedPixelMap&&this.lastPixelMapHash===o?this.cachedPixelMap:(this.cachedPixelMap=this.buildPixelMap(t,e),this.lastPixelMapHash=o,this.cachedPixelMap)}buildPixelMapHash(t,e){const o=t.modulationMarkers?JSON.stringify(t.modulationMarkers.map(i=>({id:i.id,col:i.columnIndex,ratio:i.ratio}))):"none";return JSON.stringify({cellWidth:t.cellWidth,modulation:o,columnCount:e?Dt.getColumnMap(e).totalCanvasColumns:0})}buildPixelMap(t,e){const{cellWidth:o,modulationMarkers:i}=t,s=Dt.getColumnMap(e),a=new Map,r=t.baseMicrobeatPx??o,c=i&&i.length>0?ou(i,r,e):null;let d=0;for(const u of s.entries){if(u.canvasIndex===null)continue;const h=u.widthMultiplier*o,f=c?c.getScaleForColumn(u.canvasIndex):1,g=h*f;a.set(u.canvasIndex,{canvasIndex:u.canvasIndex,xStart:d,xEnd:d+g,width:g,modulationScale:f}),d+=g}return{columnPositions:a,totalPixelWidth:d}}calculateFallbackPosition(t,e){const{cellWidth:o}=e,i=o;return{canvasIndex:t,xStart:t*i,xEnd:(t+1)*i,width:i,modulationScale:1}}}const ze=new iu;function su(n){n.on("rhythmStructureChanged",()=>{ze.invalidate()})}function au(n,t){const e=t.state||t;return ze.columnToPixelX(n,t,e)}function dr(n){const t=n.state||n;return ze.getOrBuildPixelMap(n,t).totalPixelWidth}function ru(n){return eu(n)}function lu(n,t){return n.reduce((e,o)=>e+o,0)*t}let en=1,hn=0,Ve,mn,_i,Bn,Dn,Ce,Fi,Wi,ur,hr,mr,fr,ne,_n,Oi,ui=null,Eo=!1,Fn=!1,hi=!1,mi=!1,zi=!1,na=0,lo=null,fn=null,$i=0,pr=null,fi=!1,co=0;const cu=new Promise(n=>{pr=()=>n()});let pi=0,gi=0;function gr(){const n=document.getElementById("pitch-grid-container"),t=hn||window.innerHeight||0;return n?.clientHeight||(t?t*.7:0)}function oa(n,t){return $l(n,t,{baseUnit:Rn,paddingRows:1})}function pn(){const n=l.state.fullRowData.length,t=Math.max(0,n-1),e=l.state.pitchRange||{topIndex:0,bottomIndex:t};return xe(e,n,_t)}function Mo(){fn!==null&&(cancelAnimationFrame(fn),fn=null),$i+=1,Fn=!1}function uo(n,t){const e=l.state.fullRowData.length,o=pn(),i=xe(n,e,_t);if(i.topIndex===o.topIndex&&i.bottomIndex===o.bottomIndex)return;const s=o.topIndex,a=Be(o);l.setPitchRange(i),l.emit("scrollChanged");const r=i.topIndex-s;if(r!==0&&l.emit("scrollByUnits",r),Be(i)!==a){he(),l.emit("zoomChanged");return}document.dispatchEvent(new CustomEvent("canvasResized",{detail:{source:t}}))}function ho(n,t,e){Mo(),Fn=!0;const o=l.state.fullRowData.length,i=pn(),s=xe(n,o,_t);if(s.topIndex===i.topIndex&&s.bottomIndex===i.bottomIndex){Fn=!1;return}const a=$i,r=performance.now(),c=Math.max(0,Math.round(t));let d=i.topIndex;const u=f=>f<.5?4*f*f*f:1-Math.pow(-2*f+2,3)/2,h=()=>{if(a!==$i)return;const f=performance.now(),g=c>0?(f-r)/c:1,m=Math.max(0,Math.min(1,g)),p=u(m),v=Math.round(i.topIndex+(s.topIndex-i.topIndex)*p),y=Math.round(i.bottomIndex+(s.bottomIndex-i.bottomIndex)*p),w=xe({topIndex:v,bottomIndex:y},o,_t);l.setPitchRange(w),l.emit("scrollChanged");const S=w.topIndex-d;if(S!==0&&(l.emit("scrollByUnits",S),d=w.topIndex),he(),l.emit("zoomChanged"),m<1){fn=requestAnimationFrame(h);return}fn=null,Fn=!1};fn=requestAnimationFrame(h)}function du(){try{if(globalThis.__SN_DEBUG_VIEWPORT)return!0}catch{}try{if(new URLSearchParams(window.location.search).get("debugViewport")==="1")return!0}catch{}try{return localStorage.getItem("sn:debugViewport")==="1"}catch{return!1}}let uu=!1;function vr(n,t){if(du())try{const e=performance?.now?.()??Date.now();if(e-na<500)return;na=e,uu=!0}catch{}}function hu(){const n=window?.devicePixelRatio??1;return!Number.isFinite(n)||n<=0?1:n}function He(n,t,e,o,i){if(!n)return!1;const s=Number.isFinite(o)&&o>0?o:1;n.dataset.pixelRatio=`${s}`;let a=!1;if(typeof t=="number"){const r=Math.max(1,Math.round(t*s));Math.abs(n.width-r)>.5&&(n.width=r,a=!0),n.style.width=`${t}px`,n.dataset.logicalWidth=`${t}`}if(typeof e=="number"){const r=Math.max(1,Math.round(e*s));Math.abs(n.height-r)>.5&&(n.height=r,a=!0),n.style.height=`${e}px`,n.dataset.logicalHeight=`${e}`}if(a){const r=i||n.getContext("2d");r&&r.setTransform(s,0,0,s,0,0)}return a}function mu(){Ve=document.getElementById("pitch-grid-wrapper"),mn=document.getElementById("notation-grid"),Bn=document.getElementById("legend-left-canvas"),Dn=document.getElementById("legend-right-canvas"),Ce=document.getElementById("drum-grid-wrapper"),Fi=document.getElementById("drum-grid"),ur=document.getElementById("drum-playhead-canvas"),hr=document.getElementById("playhead-canvas"),mr=document.getElementById("hover-canvas"),fr=document.getElementById("drum-hover-canvas"),ne=document.getElementById("button-grid"),_n=document.getElementById("grid-scrollbar-proxy"),Oi=_n?.querySelector(".grid-scrollbar-inner")||null;const n=document.getElementById("canvas-container");if(!Ve||!mn||!n)return{};_i=mn.getContext("2d"),Wi=Fi?.getContext("2d")||null;const t=Bn?.getContext("2d")||null,e=Dn?.getContext("2d")||null;return{ctx:_i,drumCtx:Wi,legendLeftCtx:t,legendRightCtx:e,canvasContainer:n}}function fu(){if(zi)return;const n=(l.state.columnWidths?.length||0)>0,t=!!(l.state.cellWidth&&l.state.cellWidth>0);!n||!t||(zi=!0,pr?.())}function he(){if(!Ve||Ve.clientHeight===0){hi||(b.warn("LayoutService","Pitch grid wrapper not ready for layout (height=0). Retrying on next frame.",null,"layout"),hi=!0),requestAnimationFrame(he);return}if(hi=!1,Eo)return;Eo=!0;const n=document.getElementById("pitch-grid-container");Ve.clientWidth;const t=window.innerHeight;(Math.abs(t-hn)>3||hn===0)&&(hn=t);const o=Rn,i=o*Fd,s=pn(),a=gr(),r=Math.max(1,Be(s));en=oa(a,r);const c=Math.round(o*en),d=Math.round(i*en);l.setLayoutConfig({cellHeight:c,cellWidth:d});const u=ru(l.state);l.setLayoutConfig({columnWidths:u}),fu(),(!l.state.cellWidth||!u.length)&&b.warn("LayoutService","Unexpected layout configuration",{cellWidth:l.state.cellWidth,columnCount:u.length},"layout");const f=u.reduce((T,_)=>T+_,0)*l.state.cellWidth,g=Vt.getModulatedCanvasWidth(),m=l.state.modulationMarkers&&l.state.modulationMarkers.length>0,p=m?g:f,v=ie*2*l.state.cellWidth,y=ie*2*l.state.cellWidth,w=Math.round(p+v+y),S=hu();document.getElementById("drum-grid-wrapper");const M=document.getElementById("grids-wrapper"),P=w+"px";if(n&&(n.style.width=P),Ve&&(Ve.style.width=P),Ce&&(Ce.style.width=P),Oi&&_n){Oi.style.width=P;const T=M?.getBoundingClientRect().width||0;w>T?_n.style.display="":_n.style.display="none"}const E=Math.max(Vn,Xn*l.state.cellHeight),x=Zs*E,A=`${x}px`,k=l.state.columnWidths?.length??0;let C=0;if(m){const T={cellWidth:l.state.cellWidth,columnWidths:l.state.columnWidths,modulationMarkers:l.state.modulationMarkers,baseMicrobeatPx:l.state.cellWidth,cellHeight:l.state.cellHeight,state:l.state};C=dr(T)}else for(let T=0;T<k;T++)C+=(l.state.columnWidths[T]||0)*l.state.cellWidth;if(k===0&&b.warn("LayoutService","Column widths array is empty.",{columnWidthsCount:k,columnWidths:l.state.columnWidths},"layout"),C<50&&k>0&&b.warn("LayoutService","Computed button-grid middle cell width is unexpectedly small.",{middleCellWidth:C,columnWidthsSample:l.state.columnWidths?.slice(0,10),cellWidth:l.state.cellWidth,macrobeatGroupings:l.state.macrobeatGroupings},"layout"),ne){const T=ne.querySelector(".button-grid-left-cell"),_=ne.querySelector(".button-grid-middle-cell"),G=ne.querySelector(".button-grid-right-cell"),X=ie*2*l.state.cellWidth,z=ie*2*l.state.cellWidth;(Math.abs(gi-x)>5||gi===0)&&(ne.style.height=A,gi=x);const F=(O,q)=>{if(!O)return;const Z=`${Math.max(0,q)}px`;O.style.width=Z,O.style.flex=`0 0 ${Z}`,O.style.maxWidth=Z,O.style.minWidth=Z,O.style.height=A};if(T){F(T,X);const O=T.getBoundingClientRect();X>0&&O.width===0&&b.warn("LayoutService","Left button-grid cell measured width is 0 after assignment.",{assignedWidth:X,measuredWidth:O.width,computedDisplay:window.getComputedStyle(T).display},"layout")}if(_){C===0&&b.warn("LayoutService","Calculated middle button-grid width is 0. Check column width data.",{columnWidths:l.state.columnWidths,cellWidth:l.state.cellWidth},"layout"),F(_,C);const O=_.getBoundingClientRect();if(C>0&&O.width===0&&b.warn("LayoutService","Middle button-grid cell assigned width but still measures 0.",{assignedWidth:C,measuredWidth:O.width,computedStyles:window.getComputedStyle(_)},"layout"),Math.abs(O.width-C)>5&&(b.warn("LayoutService","Middle cell measured width does not match assigned width.",{assignedWidth:C,measuredWidth:O.width,styleWidth:_.style.width,cellWidth:l.state.cellWidth},"layout"),requestAnimationFrame(()=>{const q=_.getBoundingClientRect();Math.abs(q.width-C)>5&&b.warn("LayoutService","Middle cell still mismatched after RAF.",{assignedWidth:C,measuredWidth:q.width,delta:q.width-C,computedStyles:window.getComputedStyle(_)},"layout")})),!mi){const q=_.querySelector("#beat-line-button-layer");if(q){const Z=q.getBoundingClientRect();if(Z.width===0){const B=window.getComputedStyle(q);b.warn("LayoutService","#beat-line-button-layer width is 0 despite middle cell sizing.",{beatLineRect:Z,beatLineStyles:{display:B.display,position:B.position,flex:{direction:B.flexDirection,grow:B.flexGrow,shrink:B.flexShrink,basis:B.flexBasis},width:B.width,minWidth:B.minWidth,maxWidth:B.maxWidth},middleRect:O,middleCellComputedWidth:B.width},"layout"),mi=!0}}else b.warn("LayoutService","Could not find #beat-line-button-layer inside middle cell to measure.",null,"layout"),mi=!0}}if(G){F(G,z);const O=G.getBoundingClientRect();z>0&&O.width===0&&b.warn("LayoutService","Right button-grid cell measured width is 0 after assignment.",{assignedWidth:z,measuredWidth:O.width,computedDisplay:window.getComputedStyle(G).display},"layout")}const I=X+C+z;Number.isFinite(I)&&I>0&&(ne.style.width=P,ne.style.maxWidth=P,ne.style.minWidth=P),ne.getBoundingClientRect().width===0&&b.warn("LayoutService","Entire button grid wrapper width is 0 after layout pass.",{leftCellWidth:X,middleCellWidth:C,rightCellWidth:z,wrapperStyles:window.getComputedStyle(ne)},"layout")}const N=Math.max(Vn,Xn*l.state.cellHeight),L=Zs*N,W=`${L}px`,H=n?.clientHeight||0;if(H>0){const T=l.state.cellHeight,_=l.state.cellWidth,G=Math.max(1,Be(s)),X=oa(H,G),z=Math.round(o*X),rt=Math.round(i*X);l.setLayoutConfig({cellHeight:z,cellWidth:rt}),en=X,(z!==T||rt!==_)&&(fi=!0)}const Q=Math.round(ie*2*l.state.cellWidth),D=Math.round(ie*2*l.state.cellWidth),U=Math.round(p),V=[{element:mn,context:_i},{element:hr},{element:mr}];if(V.forEach(({element:T,context:_})=>{He(T,U,H,S,_),T&&(T.style.left=`${Q}px`)}),He(Bn,Q,H,S,null),He(Dn,D,H,S,null),[{element:Fi,context:Wi},{element:ur},{element:fr}].forEach(({element:T,context:_})=>{He(T,U,L,S,_)}),Ce){const T=Ce.querySelector(".drum-grid-left-cell"),_=Ce.querySelector(".drum-grid-middle-cell"),G=Ce.querySelector(".drum-grid-right-cell"),X=(rt,R)=>{if(!rt)return;const F=`${Math.max(0,Math.round(R))}px`;rt.style.width=F,rt.style.flex=`0 0 ${F}`,rt.style.maxWidth=F,rt.style.minWidth=F,rt.style.height=W};X(T,Q),X(_,U),X(G,D);const z=_?.querySelector("#drum-canvas-wrapper");z&&(z.style.width="100%",z.style.height=W)}const mt=Math.abs(pi-L)>5||pi===0;Ce&&mt&&(Ce.style.height=W,pi=L);const vt=S,dt=U;lo&&clearTimeout(lo),lo=setTimeout(()=>{lo=null;const _=document.getElementById("pitch-grid-container")?.clientHeight||0;V.forEach(({element:G,context:X})=>{He(G,dt,_,vt,X),G&&(G.style.left=`${Q}px`)}),He(Bn,Q,_,vt,null),He(Dn,D,_,vt,null),vr("deferredResize",{finalContainerHeight:_,pitchCanvasLogicalHeight:mn?.dataset?.logicalHeight,legendLeftLogicalHeight:Bn?.dataset?.logicalHeight,legendRightLogicalHeight:Dn?.dataset?.logicalHeight}),document.dispatchEvent(new CustomEvent("canvasResized",{detail:{source:"layoutService-deferred"}}))});try{const T=l.state.fullRowData.length,_=Math.max(0,T-1),G=l.state.pitchRange||{topIndex:0,bottomIndex:_},X=xe(G,T,_t);(G.topIndex!==X.topIndex||G.bottomIndex!==X.bottomIndex)&&l.setPitchRange(X)}catch{}l.emit("layoutConfigChanged"),Eo=!1,fi?(fi=!1,co<1?(co+=1,requestAnimationFrame(he)):b.warn("LayoutService","Skipped additional layout pass after repeated final zoom adjustments.",{finalRecalcAttempts:co},"layout")):co=0}const Vt={init(){const{ctx:n,drumCtx:t,legendLeftCtx:e,legendRightCtx:o}=mu();requestAnimationFrame(he),this.initScrollHandler();const i=()=>{Eo||(ui!==null&&clearTimeout(ui),ui=setTimeout(()=>{he()},_d))};return window.addEventListener("resize",i),l.on("zoomIn",s=>{this.zoomIn(s)}),l.on("zoomOut",s=>{this.zoomOut(s)}),{ctx:n,drumCtx:t,legendLeftCtx:e,legendRightCtx:o}},waitForInitialLayout(){return zi?Promise.resolve():cu},getCurrentZoomLevel(){return en},setZoomLevel(n){const t=Number.isFinite(n)&&n>0?n:1,e=gr(),o=l.state.fullRowData.length,i=Math.max(0,o-1);if(!o||o<=0)return;const s=2*e/(t*Rn),a=Math.max(_t,Math.min(o,Math.round(s)-1)),r=pn(),c=(r.topIndex+r.bottomIndex)/2,d=(a-1)/2;let u=Math.round(c-d),h=u+a-1;if(u<0&&(h+=-u,u=0),h>i){const f=h-i;u-=f,h=i}uo({topIndex:u,bottomIndex:h},"setZoomLevel")},setPitchViewportRange(n,t={}){const e=t.source??"setPitchViewportRange",o=Math.max(0,Math.round(t.animateMs??0));if(o>0){ho(n,o);return}uo(n,e)},_canScrollRange(n){const t=l.state.pitchRange;if(!t||!Ae||Ae.length===0)return!1;const e=Ae.length-1,o=typeof n=="string"?n==="up"?-1:1:n,i=o<0&&t.topIndex>0,s=o>0&&t.bottomIndex<e;return i||s},initScrollHandler(){const n=document.getElementById("pitch-grid-wrapper");n&&n.addEventListener("wheel",t=>{if(t.preventDefault(),t.ctrlKey||t.metaKey)t.deltaY<0?this.zoomIn({source:"wheel"}):this.zoomOut({source:"wheel"});else{const e=t.deltaY>0?1:-1;this._canScrollRange(e)&&this.scrollByUnits(e)}},{passive:!1})},zoomIn(n){const t=l.state.fullRowData.length;if(!t)return;const e=pn(),o=Be(e),i=qs(o,t),s=Gs(e,"in",{totalRanks:t,minSpan:_t,zoomStep:i}),a=Be(s),r=n?.source??"unknown",c=r==="wheel"?0:280;b.debug("LayoutService",`[Zoom] Range zoom in (span ${o} -> ${a})`,{source:r},"layout"),c>0?ho(s,c):(uo(s,`zoomIn:${r}`),l.emit("zoomChanged"))},zoomOut(n){const t=l.state.fullRowData.length;if(!t)return;const e=pn(),o=Be(e),i=qs(o,t),s=Gs(e,"out",{totalRanks:t,minSpan:_t,zoomStep:i}),a=Be(s),r=n?.source??"unknown",c=r==="wheel"?0:280;b.debug("LayoutService",`[Zoom] Range zoom out (span ${o} -> ${a})`,{source:r},"layout"),c>0?ho(s,c):(uo(s,`zoomOut:${r}`),l.emit("zoomChanged"))},resetZoom(n){const t=l.state.fullRowData.length;if(!t)return;const e=Math.max(0,t-1);n?.source,ho({topIndex:0,bottomIndex:e},320)},scroll(n){const e=this.getViewportInfo().startRank;l.emit("scrollChanged");const s=this.getViewportInfo().startRank-e;s!==0&&l.emit("scrollByUnits",s),l.emit("layoutConfigChanged")},scrollByUnits(n){Mo();const t=l.state.pitchRange;if(!t||!Ae||Ae.length===0)return;const e=Math.sign(n||0);if(e===0)return;const o=Ae.length,i=xe(t,o,_t),s=zl(i,e,o);s.topIndex===i.topIndex&&s.bottomIndex===i.bottomIndex||(l.setPitchRange(s),l.emit("scrollChanged"),l.emit("scrollByUnits",e),document.dispatchEvent(new CustomEvent("canvasResized",{detail:{source:"viewportScroll"}})))},setViewportTopIndex(n){Mo();const t=l.state.pitchRange||{topIndex:0,bottomIndex:Math.max(0,l.state.fullRowData.length-1)},e=l.state.fullRowData.length,o=xe(t,e,_t),i=Ol(o,n,e,_t),s=i.topIndex-(o.topIndex??0);i.topIndex===o.topIndex&&i.bottomIndex===o.bottomIndex||(l.setPitchRange(i),l.emit("scrollChanged"),s!==0&&l.emit("scrollByUnits",s),he(),l.emit("zoomChanged"))},setViewportBottomIndex(n){Mo();const t=l.state.pitchRange||{topIndex:0,bottomIndex:Math.max(0,l.state.fullRowData.length-1)},e=l.state.fullRowData.length,o=xe(t,e,_t),i=Wl(o,n,e,_t),s=i.topIndex-(o.topIndex??0);b.debug("LayoutService","setViewportBottomIndex",{requestedBottom:n,currentRange:t,normalized:o,nextRange:i,willUpdate:!(i.topIndex===o.topIndex&&i.bottomIndex===o.bottomIndex)},"layout"),!(i.topIndex===o.topIndex&&i.bottomIndex===o.bottomIndex)&&(l.setPitchRange(i),l.emit("scrollChanged"),s!==0&&l.emit("scrollByUnits",s),he(),l.emit("zoomChanged"))},scrollByPixels(n,t=0){const o=this.getViewportInfo().startRank;l.state.fullRowData.length,l.state.cellHeight,l.emit("scrollChanged");const a=this.getViewportInfo().startRank-o;a!==0&&l.emit("scrollByUnits",a),l.emit("layoutConfigChanged")},getViewportInfo(){const n=l.state.fullRowData.length,t=Math.max(0,n-1),e=document.getElementById("pitch-grid-container"),o=e?.clientHeight||hn*.7,i=l.state.cellHeight||Rn,s=i/2,a=xe(l.state.pitchRange||{topIndex:0,bottomIndex:t},n,_t),r=Math.max(0,Math.min(t,a.topIndex??0)),c=Math.max(r,Math.min(t,a.bottomIndex??t)),d=Math.min(n,c+1),u=r*s,h=document.getElementById("legend-left-canvas"),f=document.getElementById("legend-right-canvas"),g=s?o/s:0,m=Math.max(1,c-r+1),p=m*s,v=l.state.fullRowData[r],y=l.state.fullRowData[c],w=r<=0,S=c>=t;return vr("getViewportInfo",{containerHeight:o,containerRectHeight:e?.getBoundingClientRect?.().height,cellHeight:i,halfUnit:s,ratio:g,rowCount:m,coveragePx:p,coverageGapPx:o-p,totalRanks:n,pitchRange:a,startRank:r,endRank:d,atTopGamutEdge:w,atBottomGamutEdge:S,scrollOffset:u,startRowSummary:v?{pitch:v.pitch,column:v.column,isBoundary:!!v.isBoundary}:null,endRowSummary:y?{pitch:y.pitch,column:y.column,isBoundary:!!y.isBoundary}:null,pitchCanvasLogicalHeight:mn?.dataset?.logicalHeight,legendLeftLogicalHeight:h?.dataset?.logicalHeight,legendRightLogicalHeight:f?.dataset?.logicalHeight,legendLeftCssHeight:h?.getBoundingClientRect?.().height,legendRightCssHeight:f?.getBoundingClientRect?.().height}),{zoomLevel:en,viewportHeight:hn,containerHeight:o,cellHeight:i,halfUnit:s,startRank:r,endRank:d,scrollOffset:u}},getMacrobeatWidthPx(n,t){return t*n.cellWidth},getColumnX(n){const t=l.state.cellWidth||40,e=l.state.columnWidths||[];return au(n,{cellWidth:t,columnWidths:e,modulationMarkers:l.state.modulationMarkers,baseMicrobeatPx:t,state:l.state})},getCanvasWidth(){return lu(l.state.columnWidths,l.state.cellWidth)},getModulatedCanvasWidth(){const n=this.getCanvasWidth();if(!l.state.modulationMarkers||l.state.modulationMarkers.length===0)return n;try{const t=l.state.cellWidth||40,e=l.state.columnWidths||[],o={cellWidth:t,columnWidths:e,modulationMarkers:l.state.modulationMarkers,baseMicrobeatPx:t,cellHeight:l.state.cellHeight||40,state:l.state};return dr(o)}catch{return n}},recalculateLayout(){he()},reflow(){he()},get isZooming(){return Fn}};let vi=null,bi=null,yi=null,wi=null;const Yn={setContexts({ctx:n,drumCtx:t,legendLeftCtx:e,legendRightCtx:o}){vi=n??null,bi=t??null,yi=e??null,wi=o??null},getPitchContext(){return vi||b.error("CanvasContextService","Pitch context requested before it was set.",null,"canvas"),vi},getDrumContext(){return bi||b.error("CanvasContextService","Drum context requested before it was set.",null,"canvas"),bi},getLegendLeftContext(){return yi||b.error("CanvasContextService","Legend left context requested before it was set.",null,"canvas"),yi},getLegendRightContext(){return wi||b.error("CanvasContextService","Legend right context requested before it was set.",null,"canvas"),wi}},$t={getViewportInfo:()=>Vt.getViewportInfo(),setViewportTopIndex(n){Vt.setViewportTopIndex?.(n)},setViewportBottomIndex(n){Vt.setViewportBottomIndex?.(n)},setPitchViewportRange(n,t={}){Vt.setPitchViewportRange?.(n,t)}};let gn=null,vn=null;l.on("modulationMarkersChanged",()=>{});l.on("scrollChanged",()=>{gn=null,vn=null});l.on("zoomChanged",()=>{gn=null,vn=null});l.on("pitchRangeChanged",()=>{gn=null,vn=null});function ys(){const n=performance.now();return(!gn||!vn||n-vn>1)&&(gn=$t.getViewportInfo(),vn=n),gn}function Y(n,t){const e=l.state,o={cellWidth:t.cellWidth,modulationMarkers:t.modulationMarkers,baseMicrobeatPx:t.baseMicrobeatPx,columnWidths:t.columnWidths,state:e};return ze.columnToPixelX(n,o,e)}function ct(n,t){const e=ys(),o=n-e.startRank,i=t.cellHeight/2;return(o+1)*i}function pu(n){let t=(n||"").replace(/\d/g,"").trim();return t=t.replace(/b/g,"b-").replace(/#/g,"b_"),t}function gu(n){switch(n){case"C":return{lineWidth:3.33,dash:[],color:"#adb5bd"};case"E":return{lineWidth:1,dash:[5,5],color:"#adb5bd"};case"G":return{lineWidth:1,dash:[],color:"#dee2e6"};case"B":case"A":case"F":case"Eb/Db":case"Db/C#":return{lineWidth:1,dash:[],color:"#ced4da"};default:return{lineWidth:1,dash:[],color:"#ced4da"}}}function vu(){const n=ys(),{startRank:t,endRank:e}=n,o=Math.max(t,e-1);return{startRow:t,endRow:o}}function Hi(n,t){const e=l.state,o={cellWidth:t.cellWidth,modulationMarkers:t.modulationMarkers,baseMicrobeatPx:t.baseMicrobeatPx,columnWidths:t.columnWidths,state:e};return ze.pixelXToColumn(n,o,e)}function bu(n,t){const e=ys(),o=t.cellHeight/2;return n/o-1+e.startRank}function br(n,t){return t.some(e=>e.columnIndex===n)}function qi(n,t){return t.some(e=>n===e.columnIndex||n===e.columnIndex+1)}function jn(n,t){const e=Ot(t);return!qi(n,e)}function yr(n,t){for(const e of t)if(n===e.columnIndex+1)return!1;return t.some(e=>n===e.columnIndex+2),!0}function yu(n){const t=new Set;return n.forEach(e=>{t.add(e.columnIndex),t.add(e.columnIndex+1)}),t}function Wt(n){if(!n)return 0;const t=n.dataset?.logicalWidth,e=t!==void 0?Number(t):NaN;return Number.isFinite(e)?e:n.width||0}function xt(n){if(!n)return 0;const t=n.dataset?.logicalHeight,e=t!==void 0?Number(t):NaN;return Number.isFinite(e)?e:n.height||0}function wu(n){if(!n)return 1;const t=n.dataset?.pixelRatio,e=t!==void 0?Number(t):NaN;return Number.isFinite(e)&&e>0?e:1}const Si={stroke:"#c7cfd8",background:"rgba(207, 214, 222, 0.32)"};let mo=null;function wr(){if(mo)return mo;if(typeof window>"u")return Si;const n=window.getComputedStyle(document.documentElement);return mo={stroke:n.getPropertyValue("--c-anacrusis-border").trim()||Si.stroke,background:n.getPropertyValue("--c-anacrusis-bg").trim()||Si.background},mo}function Su(n){if(n.length===0)return[];const t=[...n].sort((o,i)=>o.start-i.start),e=[];for(const o of t){if(e.length===0){e.push({...o});continue}const i=e[e.length-1];o.start<=i.end?i.end=Math.max(i.end,o.end):e.push({...o})}return e}function Cu(n){const t=[],e=xu();return e!==null&&e>0&&t.push({start:Y(0,n),end:Y(e,n)}),Ot(l.state).forEach(i=>{const s=Y(i.columnIndex,n),a=Y(i.columnIndex+2,n);t.push({start:s,end:a})}),Su(t)}function Au(n,t,e){const o=new Set([n,t]);e.forEach(a=>{const r=Math.max(n,Math.min(t,a.start)),c=Math.max(n,Math.min(t,a.end));c>r&&(o.add(r),o.add(c))});const i=Array.from(o).sort((a,r)=>a-r),s=[];for(let a=0;a<i.length-1;a++){const r=i[a],c=i[a+1],d=(r+c)/2,u=e.some(h=>d>=h.start&&d<h.end);c>r&&s.push({from:r,to:c,light:u})}return s}function xu(){const n=l.state;if(!n?.hasAnacrusis||!Array.isArray(n.macrobeatBoundaryStyles))return null;const t=n.macrobeatBoundaryStyles.findIndex(o=>o==="solid");if(t<0)return null;const e=Ut(n,t);return e?e.endColumn+1:null}function Eu(n,t,e,o){const i=Cu(t),{stroke:s}=wr();for(let a=e;a<=o;a++){const r=t.fullRowData[a];if(!r||r.isBoundary)continue;const c=ct(a,t);if(c<-10||c>t.viewportHeight+10)continue;const d=pu(r.pitch);if(["B","A","F","E/D","D/C"].includes(d))continue;const h=gu(d),f=t.musicalColumnWidths&&t.musicalColumnWidths.length>0?t.musicalColumnWidths:t.columnWidths||[],g=Y(0,t),m=Y(f.length,t),p=Au(g,m,i);d==="G"?p.forEach(v=>{const y=v.to-v.from;y<=0||(n.save(),n.fillStyle=v.light?s:h.color,n.globalAlpha=v.light?.5:1,n.fillRect(v.from,c-t.cellHeight/2,y,t.cellHeight),n.restore())}):p.forEach(v=>{v.to-v.from<=0||(n.beginPath(),n.moveTo(v.from,c),n.lineTo(v.to,c),n.lineWidth=h.lineWidth,n.strokeStyle=v.light?s:h.color,n.setLineDash(h.dash),n.globalAlpha=v.light?.6:1,n.stroke(),n.setLineDash([]),n.globalAlpha=1)})}}function Mu(n,t,e,o){Eu(n,t,e,o)}function Pu(n,t){Tu(n,t)}function Tu(n,t){const{columnWidths:e,macrobeatGroupings:o,macrobeatBoundaryStyles:i,placedTonicSigns:s}=t,r=(t.musicalColumnWidths&&t.musicalColumnWidths.length>0?t.musicalColumnWidths:e).length,c=o.map((d,u)=>{const{endColumn:h}=Ut(l.state,u);return h+1});for(let d=0;d<=r;d++){const u=d===0||d===r,h=br(d,s),f=s.some(y=>d===y.columnIndex+2),g=c.includes(d);if(!yr(d,s))continue;let p=null;if(u||h||f)p={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(g){const y=c.indexOf(d),w=i[y]??"dashed";if(w==="anacrusis"){const{stroke:S}=wr();p={lineWidth:1,strokeStyle:S,dash:[4,4]}}else p={lineWidth:1,strokeStyle:"#adb5bd",dash:w==="solid"?[]:[5,5]}}if(!p)continue;const v=Y(d,t);n.beginPath(),n.moveTo(v,0),n.lineTo(v,xt(n.canvas)),n.lineWidth=p.lineWidth,n.strokeStyle=p.strokeStyle,n.setLineDash(p.dash),n.stroke()}n.setLineDash([])}let ia=0;function Sr(){try{if(globalThis.__SN_DEBUG_VIEWPORT)return!0}catch{}try{if(new URLSearchParams(window.location.search).get("debugViewport")==="1")return!0}catch{}try{return localStorage.getItem("sn:debugViewport")==="1"}catch{return!1}}let Iu=!1;function ku(n,t){if(Sr())try{const e=performance?.now?.()??Date.now();if(e-ia<500)return;ia=e,Iu=!0}catch{}}const sa=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"];function Lu(n){const t=n.replace(/\d+$/,"");return t.length>0?t:n}function Cr(n,t){return!Number.isFinite(t)||t<=0?n:Math.round(n*t)/t}function Nu(n,t,e,o){const i=Math.max(10,Math.min(n*1.2,t*1.2)),s=e<=3?1:.7,a=o<=1?1.08:1;return Cr(i*s*a,o)}function Ru(n,t){const e=t[n];if(!e)return null;const i=e.pitch.replace(/\d+$/,"");return(i.includes("/")?i.split("/")[0]??i:i).replace(//g,"b").replace(//g,"#")}function Bu(n,t){if(!n||!t)return[];const e=t-1;if(e<0||e>=sa.length)return b.warn("LegendRenderer",`Invalid tonic number: ${t}`,null,"grid"),[];const o=sa[e];try{const i=`${n} ${o}`;return jl(i).notes||[]}catch(i){return b.warn("LegendRenderer",`Could not generate ${o} scale`,{tonic:n,error:i},"grid"),[]}}function Fo(n){return n?n.replace(/\d+$/,"").replace(/T-/g,"b").replace(/T_/g,"#").replace(/-/g,"b").replace(/_/g,"#").replace(//g,"b").replace(//g,"#"):""}function Du(n){const t=new Set;return n.forEach(e=>{const o=Fo(e);if(o){t.add(o);try{const i=Fo(Ln(o));i&&t.add(i)}catch{}}}),t}function aa(n,t){if(!t.size)return!0;const e=Fo(n.toneNote||n.pitch);if(!e)return!1;if(t.has(e))return!0;try{const o=Fo(Ln(e));if(o&&t.has(o))return!0}catch{}return e.includes("/")?e.split("/").some(o=>t.has(o)):!1}function _u(n,t,e,o,i){const{fullRowData:s,columnWidths:a,cellWidth:r,cellHeight:c,colorMode:d}=e,u=d??"color",{sharp:h,flat:f}=l.state.accidentalMode,{focusColours:g,showFrequencyLabels:m}=l.state,p=e.showOctaveLabels??!0,v=A=>p?A:Lu(A),y=(A,k)=>{if(!Sr())return;const C=c/2,N=xt(A.canvas),L=ct(i,e),W=L+C,H=document.getElementById("pitch-grid-container")?.clientHeight??null,Q=s.length,D=o<=0,U=i>=Q-1,V=dt=>{if(dt===null)return null;const T=s[dt];return T?{rowIndex:dt,pitch:T.pitch,column:T.column,isBoundary:!!T.isBoundary}:{rowIndex:dt,exists:!1}},j=dt=>{let T=null,_=null;for(let G=o;G<=i;G++){const X=s[G];!X||X.isDummy||X.column===dt&&(T===null&&(T=G),_=G)}return{first:T,last:_}},at=j("A"),mt=j("B"),vt=dt=>{if(dt===null)return null;const T=ct(dt,e);return{rowIndex:dt,y:T,topEdge:T-C,bottomEdge:T+C,gapCanvasMinusBottomEdge:N-(T+C)}};ku("legendCoverage",{side:k,startRow:o,endRow:i,atTopGamutEdge:D,atBottomGamutEdge:U,cellHeight:c,halfUnit:C,yEnd:L,bottomEdge:W,canvasHeight:N,gapCanvasMinusBottomEdge:N-W,containerHeight:H,gapCanvasMinusContainer:typeof H=="number"?N-H:null,startRowSummary:V(o),endRowSummary:V(i),firstLastA:{...at,firstSummary:V(at.first),lastSummary:V(at.last)},firstLastB:{...mt,firstSummary:V(mt.first),lastSummary:V(mt.last)},aLastCoverage:vt(at.last),bLastCoverage:vt(mt.last)})};let w=[],S=new Set;if(g){const A=Ot(l.state),k=new Set;A.length||b.info("LegendRenderer","Focus Colours ON but no tonic placements found",null,"grid"),A.forEach(C=>{const N=Ru(C.row,s),L=Bu(N,C.tonicNumber);b.debug("LegendRenderer","Focus Colours tonic scale",{tonicNote:N,tonicNumber:C.tonicNumber,scaleNotes:L},"grid"),L.forEach(W=>k.add(W))}),w=Array.from(k),b.debug("LegendRenderer","Focus Colours combined scale",{focusScale:w},"grid"),S=Du(w)}const M=(A,k=[],C=null)=>{if(m){const Q=g&&S.size>0,D=C?aa(C,S):!1;return Q&&C&&!D?null:C&&C.frequency?String(C.frequency):A}if(!C){if(!A.includes("/"))return v(A);const Q=A.slice(-1),D=A.substring(0,A.length-1),[U,V]=D.split("/");return v(h&&f?`${U}/${V}${Q}`:h?`${V}${Q}`:f?`${U}${Q}`:`${V}${Q}`)}const{flatName:N,sharpName:L,isAccidental:W}=C;if(!W)return v(N);let H;return h&&f?H=C.pitch:h&&!f?H=L:f&&!h?H=N:H=L,v(H)},P=()=>!h&&!f,E=A=>{A.clearRect(0,0,Wt(A.canvas),xt(A.canvas))};function x(A,k,C,N){const L=ie*2*r,W=[L/2,L/2],H=wu(A.canvas),Q=j=>Cr(j,H);let D=0,U=0,V=0;C.forEach((j,at)=>{const mt=W[at]??0;for(let vt=o;vt<=i;vt++){const dt=s[vt];if(!(!dt||dt.isDummy)&&dt.column===j){const T=ct(vt,e),_=dt.isAccidental??dt.pitch.includes("/"),G=!m&&_&&P(),X=aa(dt,S),z=M(dt.pitch,N,dt);if(z===null)continue;const rt=!!dt.isBoundary;let R=u==="bw"?"#ffffff":dt.hex||"#ffffff";g&&!X&&!m&&(R="#ffffff");const F=G||rt?"00":g&&!X?"55":"FF";g&&S.size>0&&(V+=1,X||(U+=1)),A.fillStyle=G?"rgba(255,255,255,0)":R,A.fillRect(D,T-c/2,mt,c);const I=Nu(r,c,z.length,H);A.font=`bold ${I}px 'Atkinson Hyperlegible', sans-serif`,A.textAlign="center",A.textBaseline="middle";const $=Q(D+mt/2),O=Q(T);A.strokeStyle=`#212529${F}`,A.lineWidth=Math.max(1.2,2.5/H),A.lineJoin="round",A.strokeText(z,$,O),A.fillStyle=`#ffffff${F}`,A.fillText(z,$,O)}}D+=mt}),g&&S.size>0&&b.debug("LegendRenderer","Focus filter summary (separate)",{side:k===0?"left":"right",startCol:k,relevantScale:N,totalLabels:V,filteredLabels:U},"grid")}n&&(E(n),y(n,"left"),x(n,0,["B","A"],w)),t&&(E(t),y(t,"right"),x(t,a.length,["A","B"],w))}const Ar={0:{degree:1,alt:0},1:{degree:2,alt:-1},2:{degree:2,alt:0},3:{degree:3,alt:-1},4:{degree:3,alt:0},5:{degree:4,alt:0},6:{degree:5,alt:-1},7:{degree:5,alt:0},8:{degree:6,alt:-1},9:{degree:6,alt:0},10:{degree:7,alt:-1},11:{degree:7,alt:0}};function Fu(n){if(Math.abs(n.num)!==8||n.alt>=0)return null;const e=(n.semitones%12+12)%12;return Ar[e]||null}function ra(n){if(!n)return null;const t=ec(n);if(t?.num===void 0)return null;const e=Fu(t);if(e){const c=e.degree,d=e.alt;let u="";return d<0?u="".repeat(Math.abs(d)):d>0&&(u="".repeat(d)),`${u}${c}`}const o=(t.semitones%12+12)%12,i=Ar[o];if(!i){const c=Math.abs(t.num),d=t.alt;let u="";return d<0?u="".repeat(Math.abs(d)):d>0&&(u="".repeat(d)),`${u}${c}`}const s=i.degree,a=i.alt;let r="";return a<0?r="".repeat(Math.abs(a)):a>0&&(r="".repeat(a)),`${r}${s}`}function la(n){return n&&{"1":"2","2":"1","2":"3","3":"2","4":"5","5":"4","5":"6","6":"5","6":"7","7":"6"}[n]||null}function ca(n){return!!(n&&(n.includes("")||n.includes("")))}const Ci={getEnharmonicDegree:la,hasAccidental:ca,getDegreeForNote(n,t){if(!n||!t)return null;const{keyTonic:e,keyMode:o}=Dd(t,n.startColumnIndex);if(!e)return null;const i=n.globalRow??n.row,s=t.fullRowData[i]?.toneNote;if(!s)return null;const a=Bi(s)||s;let r=e;if(t.degreeDisplayMode!=="modal"&&o!=="major"){const f=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"].indexOf(o);if(f>0){const m=["1P","2M","3M","4P","5P","6M","7M"][f];if(m){const p=tc(m);r=cn(e,p)||r}}}const d=Vs(r,a),u=ra(d);if(n.enharmonicPreference&&u&&ca(u)){const h=la(u);if(h)return h}return u},getDegreesForNotes(n,t){return!n||n.length===0?[]:n.map(e=>{const o=Bi(e)||e,i=Vs(t,o);return ra(i)}).filter(e=>e!==null)},getRomanNumeralForNotes(n,t){if(!n||n.length<2)return null;const[e]=Ql(n);if(!e)return null;const o=Kl(e),i=o?.symbol;if(!i)return null;const[s]=Zl(t,[i]);if(!s)return null;const a=Jl(s),r=a?.roman;if(!r)return null;let c=a.name.replace(r,"");const d=o?.tonic||t;return c==="6"&&(c="add6"),{roman:r,ext:c,root:d}}},Gi="",Vi="",Wo="/",io=()=>window.animationEffectsManager,Xi=()=>l.state.placedNotes,Oo=n=>{const t=n?.split("-")[1];return Number.parseInt(t??"0",10)};function xr(n){if(!n||typeof n.startColumnIndex!="number"||typeof n.endColumnIndex!="number")return!1;const t=n.shape==="circle"?n.startColumnIndex+1:n.startColumnIndex;return n.endColumnIndex>t}function Er(n,t,e){const{cellWidth:o}=e,i=o*.25,s=n.uuid;if(!s)return 0;const a=t.filter(d=>!d.isDrum&&d.row===n.row&&d.startColumnIndex===n.startColumnIndex&&d.uuid&&d.uuid!==s);if(a.length===0)return 0;const r=[n,...a];return r.sort((d,u)=>Oo(d.uuid)-Oo(u.uuid)),r.findIndex(d=>d.uuid===s)*i}function Mr(n,t){const{cellHeight:e}=t,o=io();return o?.shouldAnimateNote?.(n)?(o.getVibratoYOffset?.(n.color)??0)*e:0}function Pr(n,t,e){const o=io(),i=o?.hasReverbEffect;if(!(typeof i=="function"?i(t.color):!!i))return{shouldApply:!1,blur:0,spread:0};const{cellWidth:a}=e,r=o?.getReverbEffect,c=typeof r=="function"?r(t.color):void 0;if(!c)return{shouldApply:!1,blur:0,spread:0};const d=c.blur*(a/2),u=c.spread*(a/3);return{shouldApply:d>0||u>0,blur:d,spread:u}}function Tr(n,t,e,o,i,s,a){const r=io();if(!r?.hasDelayEffect?.(t.color))return;const{cellWidth:c}=e,d=r.getDelayEffects?.(t.color);!d||d.length===0||d.forEach((u,h)=>{const f=u.delay/500*c*2,g=o+f,m=s*u.scale,p=a*u.scale;n.save(),n.globalAlpha=u.opacity*.6,n.beginPath(),n.ellipse(g,i,m,p,0,0,2*Math.PI),n.strokeStyle=t.color,n.lineWidth=Math.max(.5,m*.1),n.setLineDash([2,2]),n.stroke(),n.restore()})}function Ir(n,t,e,o,i,s){const a=io();if(!a?.shouldFillNote?.(t))return;const r=a.getFillLevel?.(t)??0;if(r<=0)return;n.save();const c=1-r,d=n.createRadialGradient(e,o,0,e,o,Math.max(i,s));d.addColorStop(0,"transparent"),d.addColorStop(Math.max(0,c-.05),"transparent"),d.addColorStop(c,`${t.color}1F`),d.addColorStop(1,`${t.color}BF`),n.beginPath(),n.ellipse(e,o,i,s,0,0,2*Math.PI),n.clip(),n.fillStyle=d,n.fillRect(e-i-10,o-s-10,(i+10)*2,(s+10)*2),n.restore()}function Wu(n,t,e,o,i,s){const a=io();if(!a?.shouldFillNote?.(t))return;const r=a.getFillLevel?.(t)??0;if(r<=0)return;n.save(),n.beginPath(),n.arc(e,i,s,Math.PI/2,-Math.PI/2,!1),n.lineTo(o,i-s),n.arc(o,i,s,-Math.PI/2,Math.PI/2,!1),n.lineTo(e,i+s),n.closePath(),n.clip();const c=(e+o)/2,d=o-e,u=Math.max(d/2+s,s),h=1-r,f=n.createRadialGradient(c,i,0,c,i,u);f.addColorStop(0,"transparent"),f.addColorStop(Math.max(0,h-.05),"transparent"),f.addColorStop(h,`${t.color}1F`),f.addColorStop(1,`${t.color}BF`),n.fillStyle=f,n.fillRect(e-s-10,i-s-10,d+(s+10)*2,(s+10)*2),n.restore()}function Ou(n,t,e,o,i,s,a,r){if(Wu(n,t,o,i,s,a),n.save(),n.beginPath(),n.arc(o,s,a,Math.PI/2,-Math.PI/2,!1),n.lineTo(i,s-a),n.arc(i,s,a,-Math.PI/2,Math.PI/2,!1),n.lineTo(o,s+a),n.closePath(),n.strokeStyle=t.color,n.lineWidth=r,n.shadowColor=t.color,n.shadowBlur=Un,n.stroke(),n.shadowBlur=0,n.shadowColor="transparent",n.restore(),e.degreeDisplayMode!=="off"){const c=(o+i)/2;ws(n,t,e,c,s,a)}}function zu(n,t,e){const{cellHeight:o}=e,i=o/2*.12,s=n.uuid;if(!s)return 0;const a=t.filter(d=>!d.isDrum&&d.row===n.row&&d.startColumnIndex===n.startColumnIndex&&d.uuid&&d.uuid!==s&&xr(d));if(a.length===0)return 0;const r=[n,...a];return r.sort((d,u)=>Oo(d.uuid)-Oo(u.uuid)),r.findIndex(d=>d.uuid===s)*i}function $u(n,t){const e=Ci.getDegreeForNote(n,t);if(!e)return{label:null,isAccidental:!1};if(!Ci.hasAccidental(e))return{label:e,isAccidental:!1};const i=l.state.accidentalMode||{},s=i.sharp??!0,a=i.flat??!0;if(!s&&!a)return{label:null,isAccidental:!0};let r=e.includes(Gi)?e:null,c=e.includes(Vi)?e:null;const d=Ci.getEnharmonicDegree(e);d&&(d.includes(Gi)&&!r&&(r=d),d.includes(Vi)&&!c&&(c=d));let u=null;if(s&&a){const h=[];r&&h.push(r),c&&(!r||c!==r)&&h.push(c),u=h.join(Wo),u||(u=e)}else s?u=r||e:a&&(u=c||e);return{label:u,isAccidental:!0}}function Hu(n){if(!n)return{multiplier:1,category:"natural"};const t=n.includes(Vi),e=n.includes(Gi),o=n.includes(Wo);return!t&&!e?{multiplier:1,category:"natural"}:o?{multiplier:.75,category:"both-accidentals"}:{multiplier:.88,category:"single-accidental"}}function ws(n,t,e,o,i,s,a){const{label:r}=$u(t,e);if(!r)return;const{multiplier:c,category:d}=Hu(r);let u;if(t.shape==="circle"){const f=s*2*Od;switch(d){case"natural":u=f;break;case"single-accidental":u=f*.8;break;case"both-accidentals":u=f*.4;break;default:u=f*c}}else{const f=s*2*Wd;switch(d){case"natural":u=f*1.5;break;case"single-accidental":u=f*1.2;break;case"both-accidentals":u=f;break;default:u=f*c}}const h=u;if(!(h<zd))if(n.fillStyle="#212529",n.font=`bold ${h}px 'Atkinson Hyperlegible', sans-serif`,n.textAlign="center",n.textBaseline="middle",t.shape==="oval"&&d==="both-accidentals"&&r.includes(Wo)){const f=r.split(Wo),g=h*1.1,m=g*(f.length-1),p=i-m/2;f.forEach((v,y)=>{const w=p+y*g,S=h*.08;n.fillText(v.trim(),o,w+S)})}else{const f=h*.08;n.fillText(r,o,i+f)}}function Wn(n,t){return Number.isFinite(n)&&n>0&&Number.isFinite(t)&&t>0}function Ss(n,t,e,o){const{cellWidth:i,cellHeight:s,modulationMarkers:a}=t,r=ct(o,t),c=Mr(e,t),d=r+c,u=Y(e.startColumnIndex,t);let h;if(a&&a.length>0?h=Y(e.startColumnIndex+1,t)-u:h=i,!Wn(h,s))return;const f=Er(e,Xi(),t),g=u+h+f,m=Math.max($d,h*Hd),p=s/2-m/2,v=xr(e),y=l.state.longNoteStyle||"style1";if(v&&y==="style2"){const M=g,P=Y(e.endColumnIndex,t);if(!Wn(P-M,p))return;Ou(n,e,t,M,P,d,p,m);return}if(v){const M=Y(e.endColumnIndex+1,t),P=zu(e,Xi(),t),E=d+P;n.beginPath(),n.moveTo(g,E),n.lineTo(M,E),n.strokeStyle=e.color,n.lineWidth=Math.max(Gd,h*qd),n.stroke()}const w=h-m/2;if(!Wn(w,p))return;Tr(n,e,t,g,d,w,p),n.save(),Ir(n,e,g,d,w,p);const S=Pr(n,e,t);S.shouldApply&&(n.shadowColor=e.color,n.shadowBlur=Un+S.blur,n.shadowOffsetX=S.spread),n.beginPath(),n.ellipse(g,d,w,p,0,0,2*Math.PI),n.strokeStyle=e.color,n.lineWidth=m,S.shouldApply||(n.shadowColor=e.color,n.shadowBlur=Un),n.stroke(),n.shadowBlur=0,n.shadowColor="transparent",n.shadowOffsetX=0,n.restore(),t.degreeDisplayMode!=="off"&&ws(n,e,t,g,d,w)}function Cs(n,t,e,o){const{columnWidths:i,cellWidth:s,cellHeight:a,modulationMarkers:r}=t,c=ct(o,t),d=Mr(e,t),u=c+d,h=Y(e.startColumnIndex,t);let f;if(r&&r.length>0?f=Y(e.startColumnIndex+1,t)-h:f=((t.musicalColumnWidths&&t.musicalColumnWidths.length>0?t.musicalColumnWidths:i)[e.startColumnIndex]??0)*s,!Wn(f,a))return;const g=Er(e,Xi(),t),m=Math.max(.5,f*.15),p=h+f/2+g,v=f/2-m/2,y=a/2-m/2;if(!Wn(v,y))return;Tr(n,e,t,p,u,v,y),n.save(),Ir(n,e,p,u,v,y);const w=Pr(n,e,t);w.shouldApply&&(n.shadowColor=e.color,n.shadowBlur=Un+w.blur,n.shadowOffsetX=w.spread),n.beginPath(),n.ellipse(p,u,v,y,0,0,2*Math.PI),n.strokeStyle=e.color,n.lineWidth=m,w.shouldApply||(n.shadowColor=e.color,n.shadowBlur=Un),n.stroke(),n.shadowBlur=0,n.shadowColor="transparent",n.shadowOffsetX=0,n.restore(),t.degreeDisplayMode!=="off"&&ws(n,e,t,p,u,v)}function kr(n,t,e){const{cellWidth:o,cellHeight:i,modulationMarkers:s}=t,a=ct(e.globalRow??e.row,t);let r=e.columnIndex;if(e.uuid){const v=Dt.getColumnMap(l.state).entries.find(y=>y.type==="tonic"&&y.tonicSignUuid===e.uuid&&typeof y.canvasIndex=="number");v&&typeof v.canvasIndex=="number"&&(r=v.canvasIndex)}const c=Y(r,t);let d;s&&s.length>0?d=Y(r+1,t)-c:d=o;const u=d*2,h=c+u/2,f=Math.min(u,i)/2*.9;if(f<2||(n.beginPath(),n.arc(h,a,f,0,2*Math.PI),n.strokeStyle="#212529",n.lineWidth=Math.max(.5,d*.05),n.stroke(),e.tonicNumber==null))return;const g=e.tonicNumber.toString(),m=f*1.5;m<6||(n.fillStyle="#212529",n.font=`bold ${m}px 'Atkinson Hyperlegible', sans-serif`,n.textAlign="center",n.textBaseline="middle",n.fillText(g,h,a))}const Ui=[{id:1,diamonds:[0],ovals:[],label:"left 8th"},{id:2,diamonds:[1],ovals:[],label:"e"},{id:3,diamonds:[2],ovals:[],label:"right 8th"},{id:4,diamonds:[3],ovals:[],label:"a"},{id:5,diamonds:[0,1],ovals:[],label:"1 e"},{id:6,diamonds:[1,2],ovals:[],label:"e &"},{id:7,diamonds:[2,3],ovals:[],label:"& a"},{id:8,diamonds:[0,2],ovals:[],label:"two 8ths"},{id:9,diamonds:[1,3],ovals:[],label:"e a"},{id:10,diamonds:[0,1,2],ovals:[],label:"1 e + right 8th"},{id:11,diamonds:[1,2,3],ovals:[],label:"e & a"},{id:12,diamonds:[0,1,3],ovals:[],label:"1 e a"},{id:13,diamonds:[0,2,3],ovals:[],label:"left 8th + & a"},{id:14,diamonds:[0,3],ovals:[],label:"left 8th + a"},{id:15,diamonds:[0,1,2,3],ovals:[],label:"1 e & a"}];function Qo(n){return Ui.find(t=>t.id===n)}function da(n,t,e,o){const i=Math.sqrt(3)/2*e,s=Math.max(1,o-2*i),a=t-(s/2+i),r=a+i,c=r+s,d=c+i,u=n-e/2,h=n+e/2;return`M ${[`${n},${a}`,`${u},${r}`,`${u},${c}`,`${n},${d}`,`${h},${c}`,`${h},${r}`].join(" ")} Z`.replace(/,/g," ")}class qu{options;constructor(t={}){this.options={diamondW:30,diamondH:120,ovalRx:30,ovalRy:60,strokeWidth:2,...t}}renderToCanvas(t,e,o,i,s,a,r="#000",c=null,d=null){const u=s/100*.8,h=a/100*.8,f=this.options.diamondW*u,g=this.options.diamondH*h,m=this.options.ovalRx*u,p=this.options.ovalRy*h,v=[.125,.375,.625,.875].map(w=>o+w*s),y=i+a/2;t.save(),t.strokeStyle=r,t.fillStyle=r,t.lineWidth=this.options.strokeWidth,t.lineCap="round",t.lineJoin="round",e.ovals.forEach(w=>{const S=w===0?o+.25*s:o+.75*s;let M=y;if(c&&d){const P=`oval_${w}`,E=c.shapeOffsets?.[P]||0,x=c.row+E;M=d(x)}t.beginPath(),t.ellipse(S,M,m,p,0,0,Math.PI*2),t.stroke()}),e.diamonds.forEach(w=>{const S=v[w];if(S===void 0)return;let M=y;if(c&&d){const x=`diamond_${w}`,A=c.shapeOffsets?.[x]||0,k=c.row+A;M=d(k)}const P=da(S,M,f,g),E=new Path2D(P);t.stroke(E)}),t.restore()}renderToSVG(t,e=100,o=100){const i=document.createElementNS("http://www.w3.org/2000/svg","svg");i.setAttribute("viewBox",`0 0 ${e} ${o}`),i.style.color="#000000";const s=Math.min(e/100,o/100)*.8,a=this.options.diamondW*s,r=this.options.diamondH*s,c=this.options.ovalRx*s,d=this.options.ovalRy*s,u=[12.5,37.5,62.5,87.5],h=o/2;return t.ovals.forEach(f=>{const g=f===0?25:75,m=document.createElementNS("http://www.w3.org/2000/svg","ellipse");m.setAttribute("cx",String(g)),m.setAttribute("cy",String(h)),m.setAttribute("rx",String(c)),m.setAttribute("ry",String(d)),m.setAttribute("fill","none"),m.setAttribute("stroke","currentColor"),m.setAttribute("stroke-width",String(this.options.strokeWidth*2)),m.setAttribute("stroke-linecap","round"),i.appendChild(m)}),t.diamonds.forEach(f=>{const g=u[f];if(g===void 0)return;const m=da(g,h,a,r),p=document.createElementNS("http://www.w3.org/2000/svg","path");p.setAttribute("d",m),p.setAttribute("fill","none"),p.setAttribute("stroke","currentColor"),p.setAttribute("stroke-width",String(this.options.strokeWidth*2)),p.setAttribute("stroke-linejoin","round"),p.setAttribute("stroke-linecap","round"),i.appendChild(p)}),i}}const As=new qu;b.moduleLoaded("SixteenthStampRenderer","stamps");function Gu(n,t){const e=l.getAllSixteenthStampPlacements?.()??l.state?.sixteenthStampPlacements??[];e.length!==0&&(b.debug("SixteenthStampRenderer",`Rendering ${e.length} stamps`,{count:e.length},"stamps"),e.forEach(o=>{Vu(n,o,t)}))}function Vu(n,t,e){const o=Qo(t.sixteenthStampId);if(!o)return;const{startColumn:i,row:s,color:a}=t,r=l.state,c=Y(i,e),u=ct(s,e)-e.cellHeight/2,h=Oe(i,r);let f;if(h!==null){const w=h+2;f=Yt(w,r)}else f=i+2;const m=Y(f,e)-c,p=e.cellHeight,v=Wt(n.canvas);if(c+m<0||c>v)return;const y=w=>ct(w,e);As.renderToCanvas(n,o,c,u,m,p,a,t,y),n.save(),n.globalAlpha=.1,n.fillStyle=a,n.fillRect(c+1,u+1,m-2,p-2),n.restore(),b.debug("SixteenthStampRenderer",`Rendered stamp ${t.sixteenthStampId} at ${i}-${f},${s}`,{sixteenthStampId:t.sixteenthStampId,startColumn:i,effectiveEndColumn:f,row:s,stampX:c,stampY:u,hasOffsets:!!t.shapeOffsets},"stamps")}function Xu(n,t,e,o,i){if(!o)return;const s=l.state,a=Y(t,i),c=ct(e,i)-i.cellHeight/2,d=Oe(t,s);let u;if(d!==null){const m=d+2;u=Yt(m,s)}else u=t+2;const f=Y(u,i)-a,g=i.cellHeight;n.save(),n.globalAlpha=.6,As.renderToCanvas(n,o,a,c,f,g,i.previewColor||"#4a90e2"),n.restore()}function ua(n,t,e){return[{id:t+0,span:n,hits:[0],label:`${e} [1]`},{id:t+1,span:n,hits:[1],label:`${e} [2]`},{id:t+2,span:n,hits:[2],label:`${e} [3]`},{id:t+3,span:n,hits:[0,1],label:`${e} [1 2]`},{id:t+4,span:n,hits:[1,2],label:`${e} [2 3]`},{id:t+5,span:n,hits:[0,2],label:`${e} [1 3]`},{id:t+6,span:n,hits:[0,1,2],label:`${e} [1 2 3]`}]}const Po=[...ua("eighth",1,"8th triplet"),...ua("quarter",8,"Quarter triplet")],Lr={eighth:1,quarter:2},Nr=[16.6667,50,83.3333];function Ko(n){return Po.find(t=>t.id===n)}b.moduleLoaded("TripletStampRenderer","triplets");function Uu(n,t){const e=l.getAllTripletStampPlacements?.()??l.state?.tripletStampPlacements??[];e.length!==0&&(b.debug("TripletStampRenderer",`Rendering ${e.length} triplet groups`,{count:e.length},"triplets"),e.forEach(o=>{Yu(n,o,t)}))}function Yu(n,t,e){const o=Ko(t.tripletStampId);if(!o)return;const{startTimeIndex:i,span:s,row:a,color:r}=t,c=s*2,d=Yt(i,l.state),u=d+c,h=Y(d,e),f=ct(a,e),g=f-e.cellHeight/2,p=Y(u,e)-h,v=e.cellHeight,y=Wt(n.canvas);if(h+p<0||h>y)return;Rr(n,o,h,f,p,v,r,t,S=>ct(S,e)),n.save(),n.globalAlpha=.1,n.fillStyle=r,n.fillRect(h+1,g+1,p-2,v-2),n.restore()}function Rr(n,t,e,o,i,s,a,r=null,c=null){const d=i/100*.8,u=s/100*.8,h=Math.max(1,3*u);t.hits.forEach(f=>{const g=Nr[f]??50,m=e+i*g/100;let p=o;if(r&&c){const v=`triplet_${f}`,y=r.shapeOffsets?.[v]||0,w=r.row+y;p=c(w),y!==0&&b.debug("TripletStampRenderer","Drawing notehead with offset",{slot:f,shapeKey:v,rowOffset:y,baseRow:r.row,shapeRow:w,y:p},"triplets")}ju(n,m,p,a,h,d,u)})}function ju(n,t,e,o="currentColor",i=4,s=1,a=1){const r=20*s,c=60*a;n.strokeStyle=o,n.lineWidth=i,n.fillStyle="none",n.beginPath(),n.ellipse(t,e,r,c,0,0,2*Math.PI),n.stroke()}function Qu(n,t,e,o,i){if(!o)return;const a=(o.span==="eighth"?1:2)*2,r=Yt(t,l.state),c=Y(r,i),d=ct(e,i),u=r+a,f=Y(u,i)-c,g=i.cellHeight;n.save(),n.globalAlpha=.6;const m=i.previewColor||"#4a90e2";Rr(n,o,c,d,f,g,m),n.restore()}function Ku(n,t){if(n===0)return Y(0,t);const e=n-1,o=Ut(l.state,e);return o?Y(o.endColumn+1,t):(b.warn("ModulationRenderer","Could not find measure info for index",{measureIndex:n},"grid"),n*200)}function Br(n,t){const{modulationMarkers:e}=t;if(!e||e.length===0)return;const o=e.filter(s=>s.active).map(s=>{let a;if(s.columnIndex!==null&&s.columnIndex!==void 0)a=Y(s.columnIndex+1,t);else if(s.macrobeatIndex!==null&&s.macrobeatIndex!==void 0&&s.macrobeatIndex>=0){const r=Ut(l.state,s.macrobeatIndex);r?a=Y(r.endColumn+1,t):(b.warn("ModulationRenderer","Could not find macrobeat info for index",{macrobeatIndex:s.macrobeatIndex},"grid"),a=s.xPosition??0)}else s.measureIndex!==null&&s.measureIndex!==void 0?a=Ku(s.measureIndex,t):a=s.xPosition??0;return{...s,xCanvas:a}});n.save();const i=t.showModulationLabel!==!1;o.forEach(s=>{Zu(n,s,i)}),n.restore()}function Zu(n,t,e){const o=t.xCanvas,i=t.ratio,s=cr(i),a=lr(i);Ju(n,o,s),e&&th(n,o,a,s)}function Ju(n,t,e){const i=xt(n.canvas);n.beginPath(),n.moveTo(t,0),n.lineTo(t,i),n.lineWidth=3,n.strokeStyle=e,n.setLineDash([]),n.stroke()}function th(n,t,e,o){const s="Arial, sans-serif";n.font=`14px ${s}`,n.textAlign="center",n.textBaseline="middle";const u=n.measureText(e).width,h=14,f=u+12,g=h+12,m=t-f/2,p=20;eh(n,m,p,f,g,8,o),n.fillStyle="#212529",n.fillText(e,t,p+g/2)}function eh(n,t,e,o,i,s,a){n.beginPath(),n.moveTo(t+s,e),n.lineTo(t+o-s,e),n.quadraticCurveTo(t+o,e,t+o,e+s),n.lineTo(t+o,e+i-s),n.quadraticCurveTo(t+o,e+i,t+o-s,e+i),n.lineTo(t+s,e+i),n.quadraticCurveTo(t,e+i,t,e+i-s),n.lineTo(t,e+s),n.quadraticCurveTo(t,e,t+s,e),n.closePath(),n.fillStyle=a,n.fill(),n.strokeStyle="rgba(0, 0, 0, 0.2)",n.lineWidth=1,n.stroke()}function ha(n,t,e){const{xCanvas:o}=e,i=6,s=40;return Math.abs(n-o)<=i/2?t<=s?{marker:e,type:"label",canDrag:!1}:{marker:e,type:"barline",canDrag:!0}:null}function ma(n){if(!n)return"default";switch(n.type){case"label":return"pointer";case"barline":return n.canDrag?"ew-resize":"pointer";default:return"default"}}function ae(n){return n.x??n.col??0}function re(n){return n.y??n.row??0}function Qn(n,t){if(!t||t.length<3)return!1;const e=ae(n),o=re(n);let i=!1;for(let s=0,a=t.length-1;s<t.length;a=s++){const r=ae(t[s]),c=re(t[s]),d=ae(t[a]),u=re(t[a]);c>o!=u>o&&e<(d-r)*(o-c)/(u-c)+r&&(i=!i)}return i}function nh(n){if(!n||n.length<3)return n;const t=n.map(s=>({x:ae(s),y:re(s)}));if(t.length===0)return[];let e=t[0];for(let s=1;s<t.length;s++){const a=t[s];(a.y<e.y||a.y===e.y&&a.x<e.x)&&(e=a)}const o=t.filter(s=>s!==e);if(o.sort((s,a)=>{const r=Math.atan2(s.y-e.y,s.x-e.x),c=Math.atan2(a.y-e.y,a.x-e.x);if(r!==c)return r-c;const d=Math.hypot(s.x-e.x,s.y-e.y),u=Math.hypot(a.x-e.x,a.y-e.y);return d-u}),o.length===0)return[e];const i=[e,o[0]];for(let s=1;s<o.length;s++){const a=o[s];for(;i.length>1&&!oh(i[i.length-2],i[i.length-1],a);)i.pop();i.push(a)}return i}function oh(n,t,e){const o=ae(n),i=re(n),s=ae(t),a=re(t),r=ae(e),c=re(e);return(s-o)*(c-i)-(a-i)*(r-o)>0}function ih(n,t,e,o=10){const i=ae(n),s=re(n),a=ae(t),r=re(t),c=ae(e),d=re(e),u=c-a,h=d-r,f=u*u+h*h;if(f===0)return Math.hypot(i-a,s-r)<=o;let g=((i-a)*u+(s-r)*h)/f;g=Math.max(0,Math.min(1,g));const m=a+g*u,p=r+g*h;return Math.hypot(i-m,s-p)<=o}function fa(n,t,e=10){if(!t||t.length<2)return!1;for(let o=0;o<t.length;o++){const i=t[o],s=t[(o+1)%t.length];if(ih(n,i,s,e))return!0}return!1}function sh(n,t){const{centerX:e,centerY:o,rx:i,ry:s}=t,a=16;for(let r=0;r<a;r++){const c=r/a*2*Math.PI,d=e+i*Math.cos(c),u=o+s*Math.sin(c);if(Qn({x:d,y:u},n))return!0}return!!Qn({x:e,y:o},n)}function pa(n,t){const{x:e,y:o,width:i,height:s}=t,a=[{x:e,y:o},{x:e+i,y:o},{x:e+i,y:o+s},{x:e,y:o+s}];for(const r of a)if(Qn(r,n))return!0;for(const r of n){const c=ae(r),d=re(r);if(c>=e&&c<=e+i&&d>=o&&d<=o+s)return!0}return!1}function Dr(n,t,e,o,i,s){const a=i-e,r=s-o,c=a*a+r*r;if(c===0){const m=n-e,p=t-o;return Math.sqrt(m*m+p*p)}let d=((n-e)*a+(t-o)*r)/c;d=Math.max(0,Math.min(1,d));const u=e+d*a,h=o+d*r,f=n-u,g=t-h;return Math.sqrt(f*f+g*g)}function ah(n){const{x:t,y:e,annotations:o,getRenderOptions:i}=n,s=10;let a=!1;const r=i();return{nextAnnotations:o.filter(d=>{let u=!0;if(d.type==="arrow"){const h=Y(d.startCol,r),f=ct(d.startRow,r),g=Y(d.endCol,r),m=ct(d.endRow,r);Dr(t,e,h,f,g,m)<s&&(u=!1,a=!0)}else if(d.type==="text"){const h=Y(d.col,r),f=ct(d.row,r),g=Y(d.col+d.widthCols,r),m=ct(d.row+d.heightRows,r);t>=h&&t<=g&&e>=f&&e<=m&&(u=!1,a=!0)}else if(d.type==="marker"||d.type==="highlighter")for(let h=0;h<d.path.length;h++){const f=Y(d.path[h].col,r),g=ct(d.path[h].row,r),m=t-f,p=e-g;if(Math.sqrt(m*m+p*p)<s){u=!1,a=!0;break}}return u}),changed:a}}function rh(n){const{lassoPath:t,state:e,renderOptions:o,isAdditive:i,existingSelectedItems:s}=n,a=[];i&&Array.isArray(s)&&a.push(...s),e.placedNotes.forEach((c,d)=>{if(c.isDrum)return;const u=c.startColumnIndex,h=Y(u,o),f=ct(c.row,o),{cellWidth:g,cellHeight:m}=o;let p=g;o.modulationMarkers&&o.modulationMarkers.length>0&&(p=Y(u+1,o)-h);const v=c.shape==="oval"?h+p:h+p/2,y=f,w=c.shape==="oval"?p:p/2,S=m/2;if(sh(t,{centerX:v,centerY:y,rx:w,ry:S})){const M=`note-${c.row}-${u}-${c.color}-${c.shape}`;a.find(P=>P.id===M)||a.push({type:"note",id:M,data:c,index:d})}}),e.sixteenthStampPlacements.forEach((c,d)=>{const{cellWidth:u,cellHeight:h}=o,f=Y(c.startColumn,o),g=ct(c.row,o)-h/2,m=u*2;if(pa(t,{x:f,y:g,width:m,height:h})){const v=`sixteenth-stamp-${c.row}-${c.startColumn}-${c.sixteenthStampId}`;a.find(y=>y.id===v)||a.push({type:"sixteenthStamp",id:v,data:c,index:d})}}),e.tripletStampPlacements.forEach((c,d)=>{const{cellHeight:u}=o,h=Yt(c.startTimeIndex,e),f=h+c.span*2,g=Y(h,o),m=Y(f,o)-g,p=ct(c.row,o)-u/2;if(pa(t,{x:g,y:p,width:m,height:u})){const y=`triplet-stamp-${c.row}-${h}-${c.tripletStampId}`;a.find(w=>w.id===y)||a.push({type:"tripletStamp",id:y,data:c,index:d})}});const r=Kn({selectedItems:a,renderOptions:o,state:e});return{selectedItems:a,convexHull:r,isActive:a.length>0}}function Kn(n){const{selectedItems:t,renderOptions:e,state:o}=n;if(!t.length)return null;const i=o??l.state,s=t.map(a=>{const r=a.type==="note"?a.data.startColumnIndex:a.type==="sixteenthStamp"?a.data.startColumn:Yt(a.data.startTimeIndex,i),c=Y(r,e),d=ct(a.data.row,e);return{x:c,y:d}});return nh(s)}function lh(n){const{canvasX:t,canvasY:e,state:o,renderOptions:i,selection:s}=n;if(!s?.isActive)return null;const a=n.thresholdPx??15;let r=null;if(o.placedNotes.forEach(u=>{const h=u.startColumnIndex,f=Y(h,i),g=ct(u.row,i);Math.hypot(t-f,e-g)<=a&&(r=`note-${u.row}-${h}-${u.color}-${u.shape}`)}),r||o.sixteenthStampPlacements.forEach(u=>{const h=u.startColumn+1,f=Y(h,i),g=ct(u.row,i);Math.hypot(t-f,e-g)<=a&&(r=`sixteenth-stamp-${u.row}-${u.startColumn}-${u.sixteenthStampId}`)}),r||o.tripletStampPlacements.forEach(u=>{const h=Yt(u.startTimeIndex,o),f=h+u.span,g=Y(f,i),m=ct(u.row,i);Math.hypot(t-g,e-m)<=a&&(r=`triplet-stamp-${u.row}-${h}-${u.tripletStampId}`)}),!r)return null;const c=s.selectedItems.filter(u=>u.id!==r),d=Kn({selectedItems:c,renderOptions:i});return{nextSelection:{selectedItems:c,convexHull:d,isActive:c.length>0},changed:!0}}function ch(n){const{selection:t,selectionDragStart:e,selectionDragTotal:o,currentPointerGrid:i,initialDragStartRank:s,currentStartRank:a,renderOptions:r}=n,c=s!==null?a-s:0,d=i.row-c,u=Math.round(i.col-e.col),h=Math.round(d-e.row),f={col:u-o.col,row:h-o.row};if(f.col===0&&f.row===0)return{moved:!1,nextSelectionDragTotal:o,nextConvexHull:t.convexHull};const g=(y,w)=>typeof w=="number"?w:y,m=(y,w)=>{const S=l.state.columnWidths?.length??0;let M=y;for(;M>=0&&M<S;){const P=Oe(M,l.state);if(P!==null)return P;M+=w}return null};t.selectedItems.forEach(y=>{if(y.type==="note"){const S=g(y.data.row,y.data.globalRow)+f.row;y.data.globalRow=S,y.data.row=S,y.data.startColumnIndex=y.data.startColumnIndex+f.col,y.data.endColumnIndex=y.data.endColumnIndex+f.col}else if(y.type==="sixteenthStamp"){const S=g(y.data.row,y.data.globalRow)+f.row;y.data.globalRow=S,y.data.row=S,y.data.startColumn=y.data.startColumn+f.col,y.data.endColumn=y.data.endColumn+f.col}else if(y.type==="tripletStamp"){const S=g(y.data.row,y.data.globalRow)+f.row;if(y.data.globalRow=S,y.data.row=S,f.col!==0){const P=Yt(y.data.startTimeIndex,l.state)+f.col,E=Math.sign(f.col)||1,x=m(P,E);x!==null&&(y.data.startTimeIndex=x)}}});const p={col:u,row:h},v=Kn({selectedItems:t.selectedItems,renderOptions:r,state:l.state});return t.convexHull=v,{moved:!0,nextSelectionDragTotal:p,nextConvexHull:v}}function dh(n){const{ctx:t,annotation:e,isTemp:o=!1,isSelected:i=!1,isHovered:s=!1,getStrokeWidth:a,getLineDash:r}=n,{startX:c,startY:d,endX:u,endY:h,settings:f}=e;t.save(),i&&(t.strokeStyle="#4a90e2",t.lineWidth=a(f.strokeWeight)+4,t.globalAlpha=.3,t.setLineDash([]),t.beginPath(),t.moveTo(c,d),t.lineTo(u,h),t.stroke(),t.globalAlpha=1),s&&!i&&(t.strokeStyle="#4a90e2",t.lineWidth=a(f.strokeWeight)+4,t.globalAlpha=.15,t.setLineDash([]),t.beginPath(),t.moveTo(c,d),t.lineTo(u,h),t.stroke(),t.globalAlpha=1),t.strokeStyle=o?"rgba(0, 0, 0, 0.5)":"#000000",t.lineWidth=a(f.strokeWeight),t.setLineDash(r(f.lineStyle));const g=Math.atan2(h-d,u-c),m=f.arrowheadSize||12;let p=c,v=d,y=u,w=h;f.startArrowhead!=="none"&&(p=c+Math.cos(g)*m,v=d+Math.sin(g)*m),f.endArrowhead!=="none"&&(y=u-Math.cos(g)*m,w=h-Math.sin(g)*m),t.beginPath(),t.moveTo(p,v),t.lineTo(y,w),t.stroke(),f.startArrowhead!=="none"&&ga({ctx:t,x:c,y:d,angle:g+Math.PI,type:f.startArrowhead,size:m}),f.endArrowhead!=="none"&&ga({ctx:t,x:u,y:h,angle:g,type:f.endArrowhead,size:m}),t.restore()}function ga(n){const{ctx:t,x:e,y:o,angle:i,type:s,size:a}=n;switch(t.save(),t.translate(e,o),t.rotate(i),t.setLineDash([]),s){case"filled":case"filled-arrow":t.beginPath(),t.moveTo(0,0),t.lineTo(-a,-a/2),t.lineTo(-a,a/2),t.closePath(),t.fillStyle=t.strokeStyle,t.fill();break;case"unfilled":case"unfilled-arrow":t.beginPath(),t.moveTo(0,0),t.lineTo(-a,-a/2),t.lineTo(-a,a/2),t.closePath(),t.stroke();break;case"circle":t.beginPath(),t.arc(0,0,a/3,0,Math.PI*2),t.fillStyle=t.strokeStyle,t.fill();break}t.restore()}b.moduleLoaded("AnnotationService","annotation");class uh{canvas;ctx;currentTool;toolSettings;tempEraserMode;isDrawing;currentPath;startPoint;tempAnnotation;selectedAnnotation;hoverAnnotation;eraserCursor;isDragging;dragOffset;isResizing;resizeHandle;resizeStartBounds;isDraggingSelection;selectionDragStart;selectionDragTotal;lastPointerPosition;initialDragStartRank;constructor(){this.toolSettings=null,this.tempEraserMode=!1,this.currentTool=null,this.isDrawing=!1,this.currentPath=[],this.startPoint=null,this.tempAnnotation=null,this.selectedAnnotation=null,this.hoverAnnotation=null,this.eraserCursor=null,this.isDragging=!1,this.dragOffset=null,this.isResizing=!1,this.resizeHandle=null,this.resizeStartBounds=null,this.isDraggingSelection=!1,this.selectionDragStart=null,this.selectionDragTotal=null,this.lastPointerPosition=null,this.initialDragStartRank=null}initialize(){const t=document.getElementById("notation-grid");if(!(t instanceof HTMLCanvasElement)){b.error("AnnotationService","Pitch grid canvas not found",null,"annotation");return}const e=t.getContext("2d");if(!e){b.error("AnnotationService","Pitch grid context not available",null,"annotation");return}this.canvas=t,this.ctx=e,this.setupEventListeners(),l.on("annotationsChanged",()=>{this.selectedAnnotation=null,this.render()}),l.on("scrollByUnits",o=>{typeof o=="number"&&this.handleSelectionScroll(o)}),b.initSuccess("AnnotationService")}setupEventListeners(){this.canvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this.handleMouseMove.bind(this)),this.canvas.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvas.addEventListener("mouseleave",this.handleMouseLeave.bind(this)),this.canvas.addEventListener("dblclick",this.handleDoubleClick.bind(this)),this.canvas.addEventListener("wheel",this.handleWheel.bind(this),{passive:!0}),this.canvas.addEventListener("contextmenu",t=>t.preventDefault()),this.registerScrollSyncTarget(document.getElementById("pitch-grid-wrapper")),this.registerScrollSyncTarget(document.getElementById("canvas-container")),window.addEventListener("scroll",this.handleScroll.bind(this),{passive:!0}),window.addEventListener("wheel",this.handleWheel.bind(this),{passive:!0}),document.addEventListener("keydown",this.handleKeyDown.bind(this))}handleKeyDown(t){if(!this.selectedAnnotation)return;const e=document.activeElement;if(e instanceof HTMLElement){const o=e.isContentEditable,i=e.tagName.toLowerCase();if(["input","textarea"].includes(i)||o)return}(t.key==="Delete"||t.key==="Backspace")&&(t.preventDefault(),this.deleteSelectedAnnotation())}deleteSelectedAnnotation(){if(!this.selectedAnnotation)return;const t=l.state.annotations.indexOf(this.selectedAnnotation);t>-1&&(l.state.annotations.splice(t,1),this.selectedAnnotation=null,l.recordState(),this.render(),b.log("AnnotationService","Deleted annotation","annotation"))}resize(){const t=document.getElementById("notation-grid");t instanceof HTMLCanvasElement&&(this.canvas.width=t.width,this.canvas.height=t.height,this.render())}getRenderOptions(){return{columnWidths:l.state.columnWidths,cellWidth:l.state.cellWidth,cellHeight:l.state.cellHeight,modulationMarkers:l.state.modulationMarkers,baseMicrobeatPx:l.state.cellWidth}}canvasToGrid(t,e){const o=this.getRenderOptions();return{col:Hi(t,o),row:bu(e,o)}}canvasToGridFresh(t,e){const o=this.getRenderOptions(),i=$t.getViewportInfo(),s=o.cellHeight/2;return{col:Hi(t,o),row:e/s+i.startRank-1}}gridToCanvas(t,e){const o=this.getRenderOptions();return{x:Y(t,o),y:ct(e,o)}}setTool(t,e){if(this.currentTool=t,this.toolSettings=e,this.canvas)switch(t){case"arrow":case"text":this.canvas.style.cursor="crosshair";break;case"marker":case"highlighter":this.canvas.style.cursor=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16'><circle cx='8' cy='8' r='4' fill='rgba(0,0,0,0.5)'/></svg>") 8 8, crosshair`;break;case"lasso":this.canvas.style.cursor="crosshair";break;default:this.canvas.style.cursor="default"}}handleMouseDown(t){if(!this.currentTool||!this.toolSettings)return;const e=this.canvas.getBoundingClientRect(),o=t.clientX-e.left,i=t.clientY-e.top;this.lastPointerPosition={clientX:t.clientX,clientY:t.clientY};const s=this.canvasToGridFresh(o,i);if(t.button===2){if(this.currentTool==="lasso"&&l.state.lassoSelection?.isActive){this.removeFromLassoSelection(o,i);return}this.tempEraserMode=!0,this.isDrawing=!0,this.eraseAtPoint(o,i),this.showEraserCursor(o,i);return}if(this.selectedAnnotation?.type==="text"){const r=this.getResizeHandleAt(o,i,this.selectedAnnotation);if(r){this.isResizing=!0,this.resizeHandle=r,this.resizeStartBounds={col:this.selectedAnnotation.col,row:this.selectedAnnotation.row,widthCols:this.selectedAnnotation.widthCols,heightRows:this.selectedAnnotation.heightRows,mouseCol:s.col,mouseRow:s.row};return}}if(l.state.lassoSelection?.isActive&&l.state.lassoSelection.convexHull){const r=fa({x:o,y:i},l.state.lassoSelection.convexHull,10),c=Qn({x:o,y:i},l.state.lassoSelection.convexHull);if(r||c){this.isDraggingSelection=!0,this.selectionDragStart={col:s.col,row:s.row},this.selectionDragTotal={col:0,row:0},this.lastPointerPosition={clientX:t.clientX,clientY:t.clientY},this.initialDragStartRank=$t.getViewportInfo().startRank;return}}const a=this.getAnnotationAt(o,i);if(a&&(a.type==="arrow"||a.type==="text")){if(this.selectedAnnotation===a){this.isDragging=!0,a.type==="arrow"?this.dragOffset={startCol:s.col-a.startCol,startRow:s.row-a.startRow,endCol:s.col-a.endCol,endRow:s.row-a.endRow}:a.type==="text"&&(this.dragOffset={col:s.col-a.col,row:s.row-a.row});return}if(this.currentTool==="text"&&a.type==="text"){this.editTextAnnotation(a);return}this.selectedAnnotation=a,this.loadAnnotationSettings(a),this.render();return}else this.selectedAnnotation=null;switch(this.isDrawing=!0,this.startPoint=s,this.currentPath=[s],this.currentTool){case"arrow":this.tempAnnotation={type:"arrow",startCol:s.col,startRow:s.row,endCol:s.col,endRow:s.row,settings:{...this.toolSettings.arrow}};break;case"text":this.tempAnnotation={type:"text",startCol:s.col,startRow:s.row,endCol:s.col,endRow:s.row};break;case"marker":case"highlighter":this.tempAnnotation={type:this.currentTool,path:[s],settings:{...this.toolSettings[this.currentTool]}};break;case"lasso":this.tempAnnotation={type:"lasso",path:[{x:o,y:i}]};break}}handleMouseMove(t){const e=this.canvas.getBoundingClientRect(),o=t.clientX-e.left,i=t.clientY-e.top;this.lastPointerPosition={clientX:t.clientX,clientY:t.clientY};const s=this.canvasToGridFresh(o,i);if(this.tempEraserMode){this.eraseAtPoint(o,i),this.showEraserCursor(o,i);return}if(this.isResizing&&this.selectedAnnotation?.type==="text"){if(!this.resizeHandle||!this.resizeStartBounds)return;const a=s.col-this.resizeStartBounds.mouseCol,r=s.row-this.resizeStartBounds.mouseRow;let c=this.resizeStartBounds.col,d=this.resizeStartBounds.row,u=this.resizeStartBounds.widthCols,h=this.resizeStartBounds.heightRows;this.resizeHandle.includes("n")&&(d=this.resizeStartBounds.row+r,h=this.resizeStartBounds.heightRows-r),this.resizeHandle.includes("s")&&(h=this.resizeStartBounds.heightRows+r),this.resizeHandle.includes("w")&&(c=this.resizeStartBounds.col+a,u=this.resizeStartBounds.widthCols-a),this.resizeHandle.includes("e")&&(u=this.resizeStartBounds.widthCols+a);const f=2,g=1;u<f&&(this.resizeHandle.includes("w")&&(c=this.resizeStartBounds.col+this.resizeStartBounds.widthCols-f),u=f),h<g&&(this.resizeHandle.includes("n")&&(d=this.resizeStartBounds.row+this.resizeStartBounds.heightRows-g),h=g),this.selectedAnnotation.col=c,this.selectedAnnotation.row=d,this.selectedAnnotation.widthCols=u,this.selectedAnnotation.heightRows=h,this.render();return}if(this.isDraggingSelection&&this.selectionDragStart&&this.selectionDragTotal){this.applySelectionDrag(o,i);return}if(this.isDragging&&this.selectedAnnotation){this.selectedAnnotation.type==="arrow"?(this.selectedAnnotation.startCol=s.col-this.dragOffset.startCol,this.selectedAnnotation.startRow=s.row-this.dragOffset.startRow,this.selectedAnnotation.endCol=s.col-this.dragOffset.endCol,this.selectedAnnotation.endRow=s.row-this.dragOffset.endRow):this.selectedAnnotation.type==="text"&&(this.selectedAnnotation.col=s.col-this.dragOffset.col,this.selectedAnnotation.row=s.row-this.dragOffset.row),this.render();return}if(!this.isDrawing){this.updateHover(o,i);return}if(this.tempAnnotation)switch(this.currentTool){case"arrow":this.tempAnnotation.endCol=s.col,this.tempAnnotation.endRow=s.row,this.render();break;case"text":this.tempAnnotation.endCol=s.col,this.tempAnnotation.endRow=s.row,this.render();break;case"marker":case"highlighter":if(this.tempAnnotation.path.length>0){const a=this.tempAnnotation.path[this.tempAnnotation.path.length-1],r=this.interpolatePoints(a,s);this.tempAnnotation.path.push(...r)}else this.tempAnnotation.path.push(s);this.render();break;case"lasso":this.tempAnnotation.path.push({x:o,y:i}),this.render();break}}handleMouseUp(t){if(this.isResizing){this.isResizing=!1,this.resizeHandle=null,this.resizeStartBounds=null,l.recordState();return}if(this.isDraggingSelection){this.isDraggingSelection=!1,this.selectionDragStart=null,this.selectionDragTotal=null,this.lastPointerPosition=null,this.initialDragStartRank=null,l.recordState();return}if(this.isDragging){this.isDragging=!1,this.dragOffset=null,l.recordState();return}if(this.isDrawing){if(this.isDrawing=!1,this.tempEraserMode){this.tempEraserMode=!1,this.render();return}if(this.tempAnnotation){if(this.currentTool==="text"){const{startCol:e,startRow:o,endCol:i,endRow:s}=this.tempAnnotation,a=Math.abs(i-e),r=Math.abs(s-o),c=Math.min(e,i),d=Math.min(o,s);a>.5&&r>.2?this.createTextAnnotation(c,d,a,r):this.createTextAnnotation(e,o,8,2),this.tempAnnotation=null,this.render();return}this.currentTool==="lasso"?this.handleLassoSelection(t.shiftKey):(l.state.annotations.push(this.tempAnnotation),this.currentTool==="arrow"&&(this.selectedAnnotation=this.tempAnnotation),l.recordState()),this.tempAnnotation=null,this.render()}}}handleWheel(t){!this.isDraggingSelection||!this.selectionDragStart||!this.selectionDragTotal||((t.clientX!==0||t.clientY!==0)&&(this.lastPointerPosition={clientX:t.clientX,clientY:t.clientY}),requestAnimationFrame(()=>this.applySelectionDragFromLastPointer()))}handleScroll(){!this.isDraggingSelection||!this.selectionDragStart||!this.selectionDragTotal||requestAnimationFrame(()=>this.applySelectionDragFromLastPointer())}applySelectionDragFromLastPointer(){if(!this.canvas||!this.lastPointerPosition)return;const t=this.canvas.getBoundingClientRect(),e=this.lastPointerPosition.clientX-t.left,o=this.lastPointerPosition.clientY-t.top;this.applySelectionDrag(e,o)}registerScrollSyncTarget(t){t&&(t.addEventListener("wheel",this.handleWheel.bind(this),{passive:!0}),t.addEventListener("scroll",this.handleScroll.bind(this),{passive:!0}))}applySelectionDrag(t,e){if(!this.isDraggingSelection||!this.selectionDragStart||!this.selectionDragTotal)return;const o=this.getRenderOptions(),s=$t.getViewportInfo().startRank,a=this.canvasToGridFresh(t,e),{moved:r,nextSelectionDragTotal:c}=ch({selection:l.state.lassoSelection,selectionDragStart:this.selectionDragStart,selectionDragTotal:this.selectionDragTotal,currentPointerGrid:a,initialDragStartRank:this.initialDragStartRank,currentStartRank:s,renderOptions:o});r&&(this.selectionDragTotal.col=c.col,this.selectionDragTotal.row=c.row,this.render())}handleSelectionScroll(t){if(!l.state.lassoSelection?.isActive||this.isDraggingSelection)return;const e=this.getRenderOptions();l.state.lassoSelection.convexHull=Kn({selectedItems:l.state.lassoSelection.selectedItems,renderOptions:e}),this.render()}handleMouseLeave(t){this.isDrawing&&this.handleMouseUp(t)}handleDoubleClick(t){const e=this.canvas.getBoundingClientRect(),o=t.clientX-e.left,i=t.clientY-e.top,s=this.getAnnotationAt(o,i);s?.type==="text"&&this.editTextAnnotation(s)}editTextAnnotation(t){const{col:e,row:o,widthCols:i,heightRows:s,text:a,settings:r}=t,c=l.state.annotations.indexOf(t);c>-1&&(l.state.annotations.splice(c,1),this.selectedAnnotation=null,this.render()),this.createTextAnnotation(e,o,i,s,a,r)}createTextAnnotation(t,e,o,i,s=null,a=null){this.isDrawing=!1;const r=this.gridToCanvas(t,e),c=this.gridToCanvas(t+o,e+i),d=r.x,u=r.y,h=c.x-d,f=c.y-u,m=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',p=a||this.toolSettings.text,v=document.createElement("div");v.contentEditable="true",v.className="annotation-text-input",v.textContent=s||"Type here...";const y=p.size,w=y*1.2;v.style.width=`${h}px`,v.style.height=`${f}px`,v.style.padding=p.background?"4px 8px":"4px",v.style.border="2px dashed rgba(74, 144, 226, 0.5)",v.style.backgroundColor=p.background?"#ffffff":"transparent",v.style.color=p.color,v.style.fontSize=`${y}px`,v.style.lineHeight=`${w}px`,v.style.fontWeight=p.bold?"bold":"normal",v.style.fontStyle=p.italic?"italic":"normal",v.style.textDecoration=p.underline?"underline":"none",p.superscript?(v.style.fontSize=`${y*.6}px`,v.style.verticalAlign="super"):p.subscript&&(v.style.fontSize=`${y*.6}px`,v.style.verticalAlign="sub"),v.style.outline="none",v.style.zIndex="10000",v.style.position="fixed",v.style.cursor="text",v.style.pointerEvents="auto",v.style.fontFamily=m,v.style.whiteSpace="pre-wrap",v.style.wordWrap="break-word",v.style.overflow="hidden",v.style.boxSizing="border-box";const S=this.canvas.getBoundingClientRect();v.style.left=`${S.left+d}px`,v.style.top=`${S.top+u}px`,document.body.appendChild(v),v.focus();const M=document.createRange();M.selectNodeContents(v);const P=window.getSelection();P&&(P.removeAllRanges(),P.addRange(M));let E=!1;const x=()=>{if(E)return;E=!0;const k=v.textContent.trim();if(k&&k!=="Type here..."){const C={type:"text",col:t,row:e,widthCols:o,heightRows:i,text:k,settings:{...p}};l.state.annotations.push(C),this.selectedAnnotation=l.state.annotations[l.state.annotations.length-1],l.recordState(),this.render()}document.body.contains(v)&&document.body.removeChild(v)};let A=!1;v.addEventListener("input",()=>{!A&&v.textContent==="Type here..."&&(v.textContent="",A=!0)}),setTimeout(()=>{v.addEventListener("blur",x)},100),v.addEventListener("keydown",k=>{k.key==="Enter"&&!k.shiftKey&&(k.preventDefault(),x()),k.key==="Escape"&&(E=!0,document.body.contains(v)&&document.body.removeChild(v))})}handleLassoSelection(t=!1){if(!this.tempAnnotation?.path)return;const e=this.getRenderOptions();l.state.lassoSelection=rh({lassoPath:this.tempAnnotation.path,state:l.state,renderOptions:e,isAdditive:t,existingSelectedItems:l.state.lassoSelection?.selectedItems}),l.recordState(),b.log("AnnotationService",`Lasso selection completed: ${l.state.lassoSelection.selectedItems.length} items selected`,"annotation"),this.render()}updateLassoConvexHull(){if(!l.state.lassoSelection?.isActive||!l.state.lassoSelection.selectedItems?.length)return;const t=this.getRenderOptions();l.state.lassoSelection.convexHull=Kn({selectedItems:l.state.lassoSelection.selectedItems,renderOptions:t})}removeFromLassoSelection(t,e){if(!l.state.lassoSelection?.isActive)return;const o=this.getRenderOptions(),i=lh({canvasX:t,canvasY:e,state:l.state,renderOptions:o,selection:l.state.lassoSelection});i?.changed&&(l.state.lassoSelection=i.nextSelection,l.recordState(),this.render(),b.log("AnnotationService",`Removed item from lasso selection. ${i.nextSelection.selectedItems.length} items remain.`,"annotation"))}drawTempAnnotation(){if(this.tempAnnotation)switch(this.tempAnnotation.type){case"arrow":this.drawArrow(this.tempAnnotation,!0);break;case"text":this.drawTextBoxPreview(this.tempAnnotation);break;case"marker":this.drawPath(this.tempAnnotation,!1);break;case"highlighter":this.drawPath(this.tempAnnotation,!0);break;case"lasso":this.drawLassoPath(this.tempAnnotation);break}}drawTextBoxPreview(t){const{startX:e,startY:o,endX:i,endY:s}=t,a=this.ctx,r=Math.min(e,i),c=Math.min(o,s),d=Math.abs(i-e),u=Math.abs(s-o);a.save(),a.strokeStyle="rgba(74, 144, 226, 0.6)",a.lineWidth=2,a.setLineDash([5,5]),a.strokeRect(r,c,d,u),this.toolSettings.text.background&&(a.fillStyle="rgba(255, 255, 255, 0.8)",a.fillRect(r,c,d,u)),a.restore()}render(){Zn.render()}drawArrow(t,e=!1,o=!1,i=!1){dh({ctx:this.ctx,annotation:t,isTemp:e,isSelected:o,isHovered:i,getStrokeWidth:this.getStrokeWidth.bind(this),getLineDash:this.getLineDash.bind(this)})}wrapText(t,e,o){const i=e.split(`
`),s=[];return i.forEach(a=>{if(!a.trim()){s.push("");return}const r=a.split(" ");let c="";r.forEach((d,u)=>{const h=c?c+" "+d:d;t.measureText(h).width>o&&c?(s.push(c),c=d):c=h}),c&&s.push(c)}),s}drawText(t,e=!1,o=!1){const{x:i,y:s,text:a,settings:r}=t,c=this.ctx;c.save();const u=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',h=this.getSizeValue(r.size);c.font=`${r.italic?"italic ":""}${r.bold?"bold ":""}${h} ${u}`,c.textBaseline="top";const f=parseInt(h)*1.2,g=t.width||0,m=t.height||0,p=r.background?16:8,v=g-p,y=this.wrapText(c,a,v);if(r.background){c.fillStyle="#ffffff";const S=8;c.fillRect(i-S/2,s-S/2,g+S,m+S/2)}if(o&&!e){c.fillStyle="rgba(74, 144, 226, 0.1)";const S=r.background?8:2;c.fillRect(i-S/2,s-S/2,g+S,m+S/2)}if(e){c.fillStyle="rgba(74, 144, 226, 0.2)";const S=r.background?8:2;c.fillRect(i-S/2,s-S/2,g+S,m+S/2)}c.fillStyle=r.color;const w=parseInt(h);y.forEach((S,M)=>{const P=s+M*f;this.drawTextWithSuperscripts(c,S,i,P,w,r,u)}),e&&this.drawResizeHandles(i,s,g,m),c.restore()}drawTextWithSuperscripts(t,e,o,i,s,a,r){if(a.superscript||a.subscript){t.save();const h=s*.6,f=a.superscript?-s*.4:s*.3;if(t.font=`${a.italic?"italic ":""}${a.bold?"bold ":""}${h}px ${r}`,t.fillText(e,o,i+f),a.underline){const g=t.measureText(e);t.beginPath(),t.strokeStyle=a.color,t.lineWidth=1,t.moveTo(o,i+f+h*1.2-2),t.lineTo(o+g.width,i+f+h*1.2-2),t.stroke()}t.restore();return}let c=o;const d=this.parseFormattedText(e),u=(h,f)=>{const g=h;if(g){if(t.save(),f==="superscript"){const m=s*.6,p=-s*.4;t.font=`${a.italic?"italic ":""}${a.bold?"bold ":""}${m}px ${r}`,t.fillText(g,c,i+p),c+=t.measureText(g).width}else if(f==="subscript"){const m=s*.6,p=s*.3;t.font=`${a.italic?"italic ":""}${a.bold?"bold ":""}${m}px ${r}`,t.fillText(g,c,i+p),c+=t.measureText(g).width}else{if(t.font=`${a.italic?"italic ":""}${a.bold?"bold ":""}${s}px ${r}`,t.fillText(g,c,i),a.underline){const m=t.measureText(g);t.beginPath(),t.strokeStyle=a.color,t.lineWidth=1,t.moveTo(c,i+s*1.2-2),t.lineTo(c+m.width,i+s*1.2-2),t.stroke()}c+=t.measureText(g).width}t.restore()}};d.forEach(h=>{u(h.text,h.format)})}parseFormattedText(t){const e=[];let o=0,i="",s=!1;for(;o<t.length;){if(t.substr(o,5)==="<sup>"){i&&(e.push({text:i,format:"normal"}),i="");const a=t.indexOf("</sup>",o);if(a!==-1){const r=t.substring(o+5,a);e.push({text:r,format:"superscript"}),o=a+6;continue}}if(t.substr(o,5)==="<sub>"){i&&(e.push({text:i,format:"normal"}),i="");const a=t.indexOf("</sub>",o);if(a!==-1){const r=t.substring(o+5,a);e.push({text:r,format:"subscript"}),o=a+6;continue}}if(t[o]==="^"&&!s){i&&(e.push({text:i,format:"normal"}),i=""),s=!0,o++;continue}if(s&&t[o]===" "){i&&(e.push({text:i,format:"superscript"}),i=""),s=!1,e.push({text:" ",format:"normal"}),o++;continue}i+=t[o],o++}return i&&e.push({text:i,format:s?"superscript":"normal"}),e}drawResizeHandles(t,e,o,i){const s=this.ctx,a=8,r=[{pos:"nw",x:t,y:e},{pos:"n",x:t+o/2,y:e},{pos:"ne",x:t+o,y:e},{pos:"e",x:t+o,y:e+i/2},{pos:"se",x:t+o,y:e+i},{pos:"s",x:t+o/2,y:e+i},{pos:"sw",x:t,y:e+i},{pos:"w",x:t,y:e+i/2}];s.save(),r.forEach(c=>{s.fillStyle="#4a90e2",s.strokeStyle="#ffffff",s.lineWidth=2,s.fillRect(c.x-a/2,c.y-a/2,a,a),s.strokeRect(c.x-a/2,c.y-a/2,a,a)}),s.restore()}drawPath(t,e){const{path:o,settings:i}=t,s=this.ctx;if(!(o.length<2)){s.save(),e&&(s.globalAlpha=.3),s.strokeStyle=i.color,s.lineWidth=this.getStrokeWidth(i.size),s.lineCap="round",s.lineJoin="round",s.beginPath(),s.moveTo(o[0].x,o[0].y);for(let a=1;a<o.length;a++)s.lineTo(o[a].x,o[a].y);s.stroke(),s.restore()}}drawLassoPath(t){const{path:e}=t,o=this.ctx;if(!(e.length<2)){o.save(),o.strokeStyle="rgba(0, 100, 255, 0.8)",o.lineWidth=2,o.setLineDash([5,5]),o.beginPath(),o.moveTo(e[0].x,e[0].y);for(let i=1;i<e.length;i++)o.lineTo(e[i].x,e[i].y);o.lineTo(e[0].x,e[0].y),o.stroke(),o.restore()}}getStrokeWidth(t){if(typeof t=="number")return t;switch(t){case"small":return 2;case"medium":return 4;case"large":return 6;default:return 2}}getLineDash(t){switch(t){case"solid":return[];case"dashed-big":return[10,5];case"dashed-small":return[5,3];case"dotted":return[2,3];default:return[]}}getSizeValue(t){if(typeof t=="number")return`${t}px`;switch(t){case"small":return"14px";case"medium":return"18px";case"large":return"24px";default:return"16px"}}updateHover(t,e){const o=this.hoverAnnotation,i=typeof document<"u"&&document.body?.dataset?.cursorOverride==="stamp";if(this.selectedAnnotation?.type==="text"){const a=this.getResizeHandleAt(t,e,this.selectedAnnotation);if(a){const r={nw:"nwse-resize",n:"ns-resize",ne:"nesw-resize",e:"ew-resize",se:"nwse-resize",s:"ns-resize",sw:"nesw-resize",w:"ew-resize"};this.canvas.style.cursor=r[a]??"default";return}}if(l.state.lassoSelection?.isActive&&l.state.lassoSelection.convexHull){const a=fa({x:t,y:e},l.state.lassoSelection.convexHull,10),r=Qn({x:t,y:e},l.state.lassoSelection.convexHull);if(a||r){this.canvas.style.cursor="move";return}}const s=this.getAnnotationAt(t,e);s&&(s.type==="arrow"||s.type==="text")?(i||(this.currentTool==="text"&&s.type==="text"?this.selectedAnnotation===s?this.canvas.style.cursor="move":this.canvas.style.cursor="pointer":this.canvas.style.cursor="move"),this.hoverAnnotation=s):(i||(this.currentTool?this.setTool(this.currentTool,this.toolSettings):o&&(this.canvas.style.cursor="default")),this.hoverAnnotation=null),o!==this.hoverAnnotation&&this.render()}getResizeHandleAt(t,e,o){if(o?.type!=="text")return null;const s=8/2+2,a=this.getRenderOptions(),r=Y(o.col,a),c=ct(o.row,a),d=Y(o.col+o.widthCols,a),u=ct(o.row+o.heightRows,a),h=d-r,f=u-c,g=[{pos:"nw",x:r,y:c},{pos:"n",x:r+h/2,y:c},{pos:"ne",x:r+h,y:c},{pos:"e",x:r+h,y:c+f/2},{pos:"se",x:r+h,y:c+f},{pos:"s",x:r+h/2,y:c+f},{pos:"sw",x:r,y:c+f},{pos:"w",x:r,y:c+f/2}];for(const m of g)if(Math.sqrt(Math.pow(t-m.x,2)+Math.pow(e-m.y,2))<=s)return m.pos;return null}getAnnotationAt(t,e){for(let i=l.state.annotations.length-1;i>=0;i--){const s=l.state.annotations[i];if(s.type==="arrow"){if(Dr(t,e,s.startX,s.startY,s.endX,s.endY)<10)return s}else if(s.type==="text"){const a=this.getRenderOptions(),r=Y(s.col,a),c=ct(s.row,a),d=Y(s.col+s.widthCols,a),u=ct(s.row+s.heightRows,a),h=d-r,f=u-c;if(t>=r&&t<=r+h&&e>=c&&e<=c+f)return s}}return null}showEraserCursor(t,e){this.render();const i=(l.state.cellWidth||40)*2;this.ctx.save(),this.ctx.fillStyle="rgba(220, 53, 69, 0.3)",this.ctx.fillRect(t-i/2,e-i/2,i,i),this.ctx.restore()}loadAnnotationSettings(t){if(t.type==="arrow"&&window.drawToolsController){const e=t.settings;window.drawToolsController.settings.arrow={...e},window.drawToolsController.renderArrowOptions()}else if(t.type==="text"&&window.drawToolsController){const e=t.settings;window.drawToolsController.settings.text={...e},window.drawToolsController.renderTextOptions()}}applyCurrentSettingsToSelected(){this.selectedAnnotation&&(this.selectedAnnotation.type==="arrow"&&this.toolSettings.arrow?(this.selectedAnnotation.settings={...this.toolSettings.arrow},this.render()):this.selectedAnnotation.type==="text"&&this.toolSettings.text&&(this.selectedAnnotation.settings={...this.toolSettings.text},this.render()))}clearAnnotations(){l.state.annotations=[],this.render()}eraseAtPoint(t,e){const{nextAnnotations:o,changed:i}=ah({x:t,y:e,annotations:l.state.annotations,getRenderOptions:()=>this.getRenderOptions()});return l.state.annotations=o,i&&this.render(),i}interpolatePoints(t,e){const o=[],i=e.col-t.col,s=e.row-t.row,a=Math.sqrt(i*i+s*s),r=Math.max(1,Math.floor(a/.1));for(let c=1;c<=r;c++){const d=c/r;o.push({col:t.col+d*i,row:t.row+d*s})}return o}deleteAnnotationAt(t,e){this.eraseAtPoint(t,e)}getAnnotations(){return l.state.annotations}loadAnnotations(t){l.state.annotations=t||[],this.render()}applyInlineFormatting(t){const e=document.querySelector(".annotation-text-input");if(!e)return;const o=window.getSelection();if(!o||!o.rangeCount)return;const i=o.getRangeAt(0),s=i.toString();if(!s)return;let a;if(t==="superscript")a=`<sup>${s}</sup>`;else if(t==="subscript")a=`<sub>${s}</sub>`;else return;i.deleteContents();const r=document.createTextNode(a);i.insertNode(r),i.setStartAfter(r),i.setEndAfter(r),o.removeAllRanges(),o.addRange(i),e instanceof HTMLElement&&e.focus()}}const Ct=new uh;function va(n){if(n?.type!=="arrow")return!1;const t=n,e=t.settings;return typeof t.startCol=="number"&&typeof t.startRow=="number"&&typeof t.endCol=="number"&&typeof t.endRow=="number"&&!!e&&typeof e.strokeWeight=="number"&&typeof e.lineStyle=="string"}function ba(n){if(n?.type!=="text")return!1;const t=n,e=t.settings;return typeof t.col=="number"&&typeof t.row=="number"&&typeof t.widthCols=="number"&&typeof t.heightRows=="number"&&typeof t.text=="string"&&!!e&&typeof e.size=="number"&&typeof e.color=="string"}function hh(n){if(n?.type!=="text")return!1;const t=n,e=typeof n.col=="number";return typeof t.startCol=="number"&&typeof t.startRow=="number"&&typeof t.endCol=="number"&&typeof t.endRow=="number"&&!e}function ya(n){if(!n||n.type!=="marker"&&n.type!=="highlighter")return!1;const t=n,e=t.settings;return Array.isArray(t.path)&&!!e&&typeof e.color=="string"&&(typeof e.size=="number"||e.size==="small"||e.size==="medium"||e.size==="large")}function mh(n){return n?.type==="lasso"&&Array.isArray(n.path)}function fh(n,t){const e=l.state.annotations,o=Ct.tempAnnotation,i=Ct.selectedAnnotation,s=Ct.hoverAnnotation;if(e&&e.length>0&&e.forEach(r=>{const c=r===i,d=r===s;switch(r.type){case"arrow":va(r)&&wa(n,r,c,d,t);break;case"text":ba(r)&&Ca(n,r,c,d,t);break;case"marker":case"highlighter":ya(r)&&Aa(n,r,t);break}}),o)switch(o.type){case"arrow":va(o)&&wa(n,o,!1,!1,t);break;case"text":hh(o)?yh(n,o,t):ba(o)&&Ca(n,o,!1,!1,t);break;case"marker":case"highlighter":ya(o)&&Aa(n,o,t);break;case"lasso":mh(o)&&Sh(n,o);break}const a=l.state.lassoSelection;a?.isActive&&Array.isArray(a.convexHull)&&(Ct.updateLassoConvexHull(),Ch(n,a.convexHull))}function wa(n,t,e=!1,o=!1,i){const{startCol:s,startRow:a,endCol:r,endRow:c,settings:d}=t,u=Y(s,i),h=ct(a,i),f=Y(r,i),g=ct(c,i);n.save(),n.strokeStyle=t.color||"#000000",n.lineWidth=Yi(d.strokeWeight),n.setLineDash(wh(d.lineStyle));const m=Math.atan2(g-h,f-u),p=d.arrowheadSize||12;let v=u,y=h,w=f,S=g;d.startArrowhead&&d.startArrowhead!=="none"&&(v=u+Math.cos(m)*p,y=h+Math.sin(m)*p),d.endArrowhead&&d.endArrowhead!=="none"&&(w=f-Math.cos(m)*p,S=g-Math.sin(m)*p),n.beginPath(),n.moveTo(v,y),n.lineTo(w,S),n.stroke(),n.setLineDash([]),d.startArrowhead&&d.startArrowhead!=="none"&&Sa(n,u,h,m+Math.PI,d.startArrowhead,p),d.endArrowhead&&d.endArrowhead!=="none"&&Sa(n,f,g,m,d.endArrowhead,p),(e||o)&&(n.strokeStyle=e?"rgba(74, 144, 226, 0.6)":"rgba(74, 144, 226, 0.3)",n.lineWidth=Yi(d.strokeWeight)+4,n.setLineDash([]),n.beginPath(),n.moveTo(u,h),n.lineTo(f,g),n.stroke()),n.restore()}function Sa(n,t,e,o,i,s){switch(n.save(),n.translate(t,e),n.rotate(o),i){case"filled":case"filled-arrow":n.beginPath(),n.moveTo(0,0),n.lineTo(-s,-s/2),n.lineTo(-s,s/2),n.closePath(),n.fillStyle=n.strokeStyle,n.fill();break;case"unfilled":case"unfilled-arrow":n.beginPath(),n.moveTo(0,0),n.lineTo(-s,-s/2),n.lineTo(-s,s/2),n.closePath(),n.stroke();break;case"circle":n.beginPath(),n.arc(0,0,s/3,0,Math.PI*2),n.fillStyle=n.strokeStyle,n.fill();break}n.restore()}function Ca(n,t,e=!1,o=!1,i){const{col:s,row:a,text:r,widthCols:c,heightRows:d,settings:u}=t,h=Y(s,i),f=ct(a,i),g=Y(s+(typeof c=="number"?c:2),i)-h,m=ct(a+(typeof d=="number"?d:1),i)-f;n.save(),n.textBaseline="top";const v=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',y=u.size,w=y*1.2,S=u.background?8:4,M=4,P=g-S*2,E=ph(n,r,P,y,u,v);u.background&&(n.fillStyle="#ffffff",n.fillRect(h,f,g,m)),o&&!e&&(n.fillStyle="rgba(74, 144, 226, 0.1)",n.fillRect(h,f,g,m)),e&&(n.fillStyle="rgba(74, 144, 226, 0.2)",n.fillRect(h,f,g,m)),n.fillStyle=u.color,E.forEach((x,A)=>{const k=f+M+A*w;gh(n,x,h+S,k,y,u,v)}),e&&bh(n,h,f,g,m),n.restore()}function ph(n,t,e,o,i,s){n.font=`${i.italic?"italic ":""}${i.bold?"bold ":""}${o}px ${s}`;const a=t.split(`
`),r=[];return a.forEach(c=>{if(!c.trim()){r.push("");return}const d=c.split(" ");let u="";d.forEach(h=>{const f=u?u+" "+h:h;n.measureText(f).width>e&&u?(r.push(u),u=h):u=f}),u&&r.push(u)}),r}function gh(n,t,e,o,i,s,a){if(s.superscript||s.subscript){n.save();const d=i*.6,u=s.superscript?-i*.4:i*.3;if(n.font=`${s.italic?"italic ":""}${s.bold?"bold ":""}${d}px ${a}`,n.fillText(t,e,o+u),s.underline){const h=n.measureText(t);n.beginPath(),n.strokeStyle=s.color,n.lineWidth=1,n.moveTo(e,o+u+d*1.2-2),n.lineTo(e+h.width,o+u+d*1.2-2),n.stroke()}n.restore();return}const r=vh(t);let c=e;r.forEach(d=>{if(n.save(),d.format==="superscript"){const u=i*.6,h=-i*.4;n.font=`${s.italic?"italic ":""}${s.bold?"bold ":""}${u}px ${a}`,n.fillText(d.text,c,o+h),c+=n.measureText(d.text).width}else if(d.format==="subscript"){const u=i*.6,h=i*.3;n.font=`${s.italic?"italic ":""}${s.bold?"bold ":""}${u}px ${a}`,n.fillText(d.text,c,o+h),c+=n.measureText(d.text).width}else{if(n.font=`${s.italic?"italic ":""}${s.bold?"bold ":""}${i}px ${a}`,n.fillText(d.text,c,o),s.underline){const u=n.measureText(d.text);n.beginPath(),n.strokeStyle=s.color,n.lineWidth=1,n.moveTo(c,o+i*1.2-2),n.lineTo(c+u.width,o+i*1.2-2),n.stroke()}c+=n.measureText(d.text).width}n.restore()})}function vh(n){const t=[];let e=0,o="",i=!1;for(;e<n.length;){if(n.substr(e,5)==="<sup>"){o&&(t.push({text:o,format:"normal"}),o="");const s=n.indexOf("</sup>",e);if(s!==-1){const a=n.substring(e+5,s);t.push({text:a,format:"superscript"}),e=s+6;continue}}if(n.substr(e,5)==="<sub>"){o&&(t.push({text:o,format:"normal"}),o="");const s=n.indexOf("</sub>",e);if(s!==-1){const a=n.substring(e+5,s);t.push({text:a,format:"subscript"}),e=s+6;continue}}if(n[e]==="^"&&!i){o&&(t.push({text:o,format:"normal"}),o=""),i=!0,e++;continue}if(i&&n[e]===" "){o&&(t.push({text:o,format:"superscript"}),o=""),i=!1,t.push({text:" ",format:"normal"}),e++;continue}o+=n[e],e++}return o&&t.push({text:o,format:i?"superscript":"normal"}),t}function bh(n,t,e,o,i){const a=[{x:t,y:e},{x:t+o/2,y:e},{x:t+o,y:e},{x:t+o,y:e+i/2},{x:t+o,y:e+i},{x:t+o/2,y:e+i},{x:t,y:e+i},{x:t,y:e+i/2}];n.save(),a.forEach(r=>{n.fillStyle="#4a90e2",n.strokeStyle="#ffffff",n.lineWidth=2,n.fillRect(r.x-8/2,r.y-8/2,8,8),n.strokeRect(r.x-8/2,r.y-8/2,8,8)}),n.restore()}function yh(n,t,e){const{startCol:o,startRow:i,endCol:s,endRow:a}=t,r=Y(o,e),c=ct(i,e),d=Y(s,e),u=ct(a,e),h=Math.min(r,d),f=Math.min(c,u),g=Math.abs(d-r),m=Math.abs(u-c);n.save(),n.strokeStyle="rgba(74, 144, 226, 0.6)",n.lineWidth=2,n.setLineDash([5,5]),n.strokeRect(h,f,g,m),n.restore()}function Aa(n,t,e){const{path:o,settings:i,type:s}=t;if(!o||o.length<2)return;const a=o.map(c=>({x:Y(c.col,e),y:ct(c.row,e)}));n.save(),s==="highlighter"&&(n.globalAlpha=.3),n.strokeStyle=i.color,n.lineWidth=typeof i.size=="number"?i.size:Yi(i.size),n.lineCap="round",n.lineJoin="round",n.beginPath();const r=a[0];if(!r){n.restore();return}n.moveTo(r.x,r.y);for(let c=1;c<a.length;c++){const d=a[c];d&&n.lineTo(d.x,d.y)}n.stroke(),n.restore()}function Yi(n){if(typeof n=="number")return n;switch(n){case"small":return 2;case"medium":return 4;case"large":return 6;default:return 4}}function wh(n){switch(n){case"solid":return[];case"dashed-big":return[10,5];case"dashed-small":return[5,3];case"dotted":return[2,3];default:return[]}}function Sh(n,t){const e=t.path;if(!e||e.length<2)return;const o=e[0];if(o){n.save(),n.strokeStyle="#4a90e2",n.lineWidth=2,n.setLineDash([5,5]),n.globalAlpha=.7,n.beginPath(),n.moveTo(o.x,o.y);for(let i=1;i<e.length;i++){const s=e[i];s&&n.lineTo(s.x,s.y)}e.length>2&&n.lineTo(o.x,o.y),n.stroke(),n.restore()}}function Ch(n,t){if(!t||t.length<3)return;const e=t[0];if(e){n.save(),n.strokeStyle="#4a90e2",n.lineWidth=2,n.setLineDash([8,4]),n.globalAlpha=.8,n.beginPath(),n.moveTo(e.x,e.y);for(let o=1;o<t.length;o++){const i=t[o];i&&n.lineTo(i.x,i.y)}n.closePath(),n.stroke(),n.fillStyle="rgba(74, 144, 226, 0.1)",n.fill(),n.restore()}}let xa=0;function _r(){try{if(globalThis.__SN_DEBUG_VIEWPORT)return!0}catch{}try{if(new URLSearchParams(window.location.search).get("debugViewport")==="1")return!0}catch{}try{return localStorage.getItem("sn:debugViewport")==="1"}catch{return!1}}let Ah=!1;function xh(n,t){if(_r())try{const e=performance?.now?.()??Date.now();if(e-xa<500)return;xa=e,Ah=!0}catch{}}function Eh(n,t){const e={...l.state,...t};if(!e.columnWidths?.length||!e.fullRowData?.length)return;n.clearRect(0,0,Wt(n.canvas),xt(n.canvas));const{startRow:o,endRow:i}=vu(),s=Math.max(0,o-1),a=Math.max(0,(e.fullRowData?.length??1)-1),r=Math.min(a,i+1);if(_r()){const p=xt(n.canvas),v=e.cellHeight/2,y=ct(i,e),w=y+v,S=e.fullRowData?.length??0,M=o<=0,P=S>0?i>=S-1:!1,E=e.fullRowData?.[o],x=e.fullRowData?.[i];xh("pitchCanvasCoverage",{startRow:o,endRow:i,paddedStartRow:s,paddedEndRow:r,atTopGamutEdge:M,atBottomGamutEdge:P,canvasHeight:p,containerHeight:e.viewportHeight,halfUnit:v,yEnd:y,bottomEdge:w,gapCanvasMinusBottomEdge:p-w,gapCanvasMinusContainer:p-e.viewportHeight,startRowSummary:E?{pitch:E.pitch,column:E.column,isBoundary:!!E.isBoundary}:null,endRowSummary:x?{pitch:x.pitch,column:x.column,isBoundary:!!x.isBoundary}:null})}const c=e.cellHeight,d=p=>{const v=ct(p,e);return v>=-c&&v<=e.viewportHeight+c},u=e.placedTonicSigns.filter(p=>p.globalRow===void 0?!1:d(p.globalRow)),h=Yn.getLegendLeftContext(),f=Yn.getLegendRightContext();_u(h,f,e,s,r),Mu(n,e,s,r),Pu(n,e);const g=t.placedNotes.filter(p=>p.isDrum||p.globalRow===void 0?!1:d(p.globalRow)),m=u;g.forEach(p=>{p.shape==="oval"?Cs(n,e,p,p.globalRow):p.shape==="circle"&&Ss(n,e,p,p.globalRow)}),m.forEach(p=>{kr(n,e,p)}),Gu(n,e),Uu(n,e),Br(n,e),fh(n,e)}const Fr={getTimeSignatureSegments(){const n=l.state,t=n.macrobeatGroupings??[],e=n.macrobeatBoundaryStyles??[],o=[];let i=!!n.hasAnacrusis,s=Ut(n,0).startColumn,a=0,r=!1;return t.forEach((c,d)=>{a+=c,c===3&&(r=!0);const u=d===t.length-1,f=e[d]==="solid";if(f||u){const m=Ut(n,d).endColumn+1,p=Array.isArray(n.modulationMarkers)&&n.modulationMarkers.length>0,v={...n,modulationMarkers:p?n.modulationMarkers:[],cellWidth:n.cellWidth,columnWidths:n.columnWidths,musicalColumnWidths:n.musicalColumnWidths,baseMicrobeatPx:n.cellWidth},y=Y(s,v),w=Y(m,v),S=r?`${a}/8`:`${a/2}/4`;o.push({label:S,centerX:(y+w)/2,startX:y,endX:w,isAnacrusis:i}),u||(s=m,a=0,r=!1,f&&(i=!1))}}),o},getRhythmUIButtons(){const n=l.state,t=n.macrobeatGroupings??[],e=n.macrobeatBoundaryStyles??[],o=[],i=Ot(n),s=new Set(i.map(a=>a.columnIndex+2));return t.forEach((a,r)=>{const c=Ut(n,r),{startColumn:d,endColumn:u}=c,h={...n,modulationMarkers:n.modulationMarkers||[],cellWidth:n.cellWidth,columnWidths:n.columnWidths,musicalColumnWidths:n.columnWidths,baseMicrobeatPx:n.cellWidth},f=Y(d,h),g=Y(u+1,h),m=(f+g)/2,p=e[r]??null,v=r>0?e[r-1]??null:null,y=v!==null&&s.has(d);o.push({type:"grouping",content:a,x:m,startX:f,endX:g,index:r,nextBoundaryStyle:p,prevBoundaryStyle:v,hasLeftDivider:y}),r<t.length-1&&o.push({type:"boundary",boundaryStyle:p,x:g,index:r})}),o}},Mh="data-rhythm-ui-element",ji=n=>`${Math.round(n*100)/100}px`,Ph=n=>{n.querySelectorAll(`[${Mh}]`).forEach(t=>t.remove())},Th=n=>{const t=document.getElementById("notation-grid");if(!t)return null;const e=t.getBoundingClientRect(),o=n.getBoundingClientRect();return e.width===0?null:e.left-o.left},Ih=(n,t)=>{const e=document.createElement("button");return e.type="button",e.className="grouping-segment",e.dataset.rhythmUiElement="grouping",e.dataset.index=`${n.index}`,e.textContent=`${n.content}`,e.style.left=ji(t+n.startX),e.style.width=ji(Math.max(0,n.endX-n.startX)),e.dataset.nextBoundaryStyle=`${n.nextBoundaryStyle??""}`,e.dataset.prevBoundaryStyle=`${n.prevBoundaryStyle??""}`,e.dataset.hasLeftDivider=n.hasLeftDivider?"true":"false",e.setAttribute("aria-label",`Toggle macrobeat grouping (${n.content}) at position ${n.index+1}`),e.addEventListener("click",o=>{o.stopPropagation(),l.toggleMacrobeatGrouping(n.index)}),e},kh=(n,t)=>{const e=document.createElement("button");e.type="button",e.className="buttonGrid-ui-button buttonGrid-ui-button--boundary",e.dataset.rhythmUiElement="boundary",e.dataset.index=`${n.index}`,e.style.left=ji(t+n.x),e.setAttribute("aria-label","Cycle boundary style");const o=document.createElement("span");return o.className="boundary-diamond",o.dataset.style=n.boundaryStyle||"dashed",e.appendChild(o),e.addEventListener("click",i=>{i.stopPropagation(),l.cycleMacrobeatBoundaryStyle(n.index)}),e};function Wr(){const n=document.getElementById("beat-line-button-layer");if(!n){b.warn("rhythmUI","Cannot render rhythm UI without beat-line container",null,"ui");return}const t=Th(n);if(t===null)return;const e=n.querySelector("#grouping-buttons-row"),o=n.querySelector("#boundary-buttons-row");Ph(n);const i=Fr.getRhythmUIButtons();if(!Array.isArray(i)||i.length===0)return;const s=document.createDocumentFragment(),a=document.createDocumentFragment();i.forEach(r=>{r.type==="grouping"?s.appendChild(Ih(r,t)):r.type==="boundary"&&a.appendChild(kh(r,t))}),e?e.appendChild(s):n.appendChild(s),o?o.appendChild(a):n.appendChild(a)}const Lh={init:Nh};function Nh(){Wr()}const Rh={getTimeSignatureOptions(){return{"Single Macrobeat":[{label:"1/4",groupings:[2],description:"one 2-beat"},{label:"2/8",groupings:[2],description:"one 2-beat"},{label:"3/8",groupings:[3],description:"one 3-beat"}],"Two Macrobeats":[{label:"2/4",groupings:[2,2],description:"two 2-beats"},{label:"4/8",groupings:[2,2],description:"two 2-beats"},{label:"5/8",groupings:[2,3],description:"2+3"},{label:"5/8",groupings:[3,2],description:"3+2"},{label:"6/8",groupings:[3,3],description:"two 3-beats"}],"Three Macrobeats":[{label:"3/4",groupings:[2,2,2],description:"three 2-beats"},{label:"7/8",groupings:[2,2,3],description:"2+2+3"},{label:"7/8",groupings:[3,2,2],description:"3+2+2"},{label:"7/8",groupings:[2,3,2],description:"2+3+2"},{label:"8/8",groupings:[3,3,2],description:"3+3+2"},{label:"8/8",groupings:[3,2,3],description:"3+2+3"},{label:"8/8",groupings:[2,3,3],description:"2+3+3"},{label:"9/8",groupings:[3,3,3],description:"three 3-beats"}],"Four Macrobeats":[{label:"4/4",groupings:[2,2,2,2],description:"four 2-beats"},{label:"10/8",groupings:[2,2,3,3],description:"2+2+3+3"},{label:"10/8",groupings:[2,3,2,3],description:"2+3+2+3"},{label:"10/8",groupings:[2,3,3,2],description:"2+3+3+2"},{label:"10/8",groupings:[3,2,3,2],description:"3+2+3+2"},{label:"10/8",groupings:[3,3,2,2],description:"3+3+2+2"},{label:"10/8",groupings:[3,2,2,3],description:"3+2+2+3"},{label:"11/8",groupings:[3,3,3,2],description:"3+3+3+2"},{label:"11/8",groupings:[3,3,2,3],description:"3+3+2+3"},{label:"11/8",groupings:[3,2,3,3],description:"3+2+3+3"},{label:"11/8",groupings:[2,3,3,3],description:"2+3+3+3"},{label:"12/8",groupings:[3,3,3,3],description:"four 3-beats"}],"Five Macrobeats":[{label:"5/4",groupings:[2,2,2,2,2],description:"five 2-beats"},{label:"11/8",groupings:[2,2,2,2,3],description:"2+2+2+2+3"},{label:"11/8",groupings:[2,2,2,3,2],description:"2+2+2+3+2"},{label:"11/8",groupings:[2,2,3,2,2],description:"2+2+3+2+2"},{label:"11/8",groupings:[2,3,2,2,2],description:"2+3+2+2+2"},{label:"11/8",groupings:[3,2,2,2,2],description:"3+2+2+2+2"},{label:"12/8",groupings:[2,2,2,3,3],description:"2+2+2+3+3"},{label:"12/8",groupings:[2,2,3,2,3],description:"2+2+3+2+3"},{label:"12/8",groupings:[2,2,3,3,2],description:"2+2+3+3+2"},{label:"12/8",groupings:[2,3,2,2,3],description:"2+3+2+2+3"},{label:"12/8",groupings:[2,3,2,3,2],description:"2+3+2+3+2"},{label:"12/8",groupings:[2,3,3,2,2],description:"2+3+3+2+2"},{label:"12/8",groupings:[3,2,2,2,3],description:"3+2+2+2+3"},{label:"12/8",groupings:[3,2,2,3,2],description:"3+2+2+3+2"},{label:"12/8",groupings:[3,2,3,2,2],description:"3+2+3+2+2"},{label:"12/8",groupings:[3,3,2,2,2],description:"3+3+2+2+2"},{label:"13/8",groupings:[3,2,2,3,3],description:"3+2+2+3+3"},{label:"13/8",groupings:[3,3,2,3,2],description:"3+3+2+3+2"},{label:"13/8",groupings:[3,3,3,2,2],description:"3+3+3+2+2"},{label:"15/8",groupings:[3,3,3,3,3],description:"five 3-beats"}]}},generateDropdownHTML(){const n=this.getTimeSignatureOptions();let t='<div id="time-signature-dropdown" class="time-signature-dropdown hidden">';return Object.entries(n).forEach(([e,o])=>{t+='<div class="dropdown-category">',t+=`<div class="dropdown-category-header">${e}</div>`,o.forEach((i,s)=>{const a=`${e}-${s}`;t+=`<div class="dropdown-option" data-groupings="${JSON.stringify(i.groupings)}" data-key="${a}">`,t+=`<span class="dropdown-label">${i.label}</span>`,t+=`<span class="dropdown-description">${i.description}</span>`,t+="</div>"}),t+="</div>"}),t+="</div>",t},getTimeSignatureLabel(n){const t=n.reduce((o,i)=>o+i,0);return n.includes(3)?`${t}/8`:`${t/2}/4`}};let zo=null;function Bh(){const n=document.getElementById("beat-line-button-layer");if(!n)return;const t=n.querySelector("#time-signature-row")||n;n.querySelectorAll(".time-signature-label").forEach(c=>c.remove());const o=document.getElementById("notation-grid");if(!o)return;const i=o.getBoundingClientRect(),s=n.getBoundingClientRect(),a=i.left-s.left;Fr.getTimeSignatureSegments().forEach((c,d)=>{const u=document.createElement("div");u.className="time-signature-label",c.isAnacrusis&&u.classList.add("anacrusis-label"),u.textContent=c.label,u.style.position="absolute",u.style.left=`${a+c.startX}px`,u.style.width=`${Math.max(0,c.endX-c.startX)}px`,u.style.transform="none",u.style.pointerEvents="auto",u.addEventListener("click",h=>{h.stopPropagation(),_h(u,d)}),t.appendChild(u)}),Dh()}function Dh(){if(!document.getElementById("time-signature-dropdown")){const n=Rh.generateDropdownHTML();document.body.insertAdjacentHTML("beforeend",n),document.getElementById("time-signature-dropdown")?.addEventListener("click",Wh)}}function _h(n,t){const e=document.getElementById("time-signature-dropdown");if(!e)return;e.dataset.measureIndex=String(t);const o=n.getBoundingClientRect();e.style.left=`${o.left}px`,e.style.top=`${o.bottom+5}px`;const i=e.getBoundingClientRect(),s=window.innerWidth,a=window.innerHeight;o.left+i.width>s&&(e.style.left=`${s-i.width-10}px`),o.bottom+i.height>a&&(e.style.top=`${o.top-i.height-5}px`),e.classList.remove("hidden"),zo={dropdown:e,measureIndex:t},setTimeout(()=>{document.addEventListener("click",Fh,{once:!0})},0)}function Fh(n){const t=document.getElementById("time-signature-dropdown"),e=n.target;t&&e&&!t.contains(e)&&(t.classList.add("hidden"),zo=null)}function Wh(n){const e=n.target?.closest(".dropdown-option");if(!e)return;const o=e.dataset.groupings,i=zo?.measureIndex??NaN;if(!(!o||Number.isNaN(i)))try{const s=JSON.parse(o);l.updateTimeSignature(i,s),document.getElementById("time-signature-dropdown")?.classList.add("hidden"),zo=null}catch{}}b.moduleLoaded("PitchGridController","grid");function Oh(){const n=Yn.getPitchContext();if(!n?.canvas){b.error("PitchGridController","Pitch grid context not available for rendering",null,"grid");return}const t=$t.getViewportInfo(),e={placedNotes:Rd(l.state),placedTonicSigns:Ot(l.state),fullRowData:l.state.fullRowData,columnWidths:l.state.columnWidths,cellWidth:l.state.cellWidth,cellHeight:l.state.cellHeight,rowHeight:l.state.cellHeight*.5,macrobeatGroupings:l.state.macrobeatGroupings,macrobeatBoundaryStyles:l.state.macrobeatBoundaryStyles,accidentalMode:l.state.accidentalMode,showFrequencyLabels:l.state.showFrequencyLabels,showOctaveLabels:l.state.showOctaveLabels,colorMode:"color",degreeDisplayMode:l.state.degreeDisplayMode,zoomLevel:t.zoomLevel,viewportHeight:t.containerHeight,modulationMarkers:l.state.modulationMarkers,showModulationLabel:!1};b.debug("PitchGridController","renderPitchGrid options",{columns:e.columnWidths?.length,rows:e.fullRowData?.length,placedNotes:e.placedNotes.length,tonicSigns:e.placedTonicSigns.length,zoomLevel:e.zoomLevel,viewportHeight:e.viewportHeight},"grid"),Eh(n,e)}const Zn={render(){Oh()},renderMacrobeatTools(){Wr(),Bh()}},On={},Le={},zh=600,Ai=.25,Ea={letter:{width:8.5,height:11},"11x14":{width:11,height:14},"11x17":{width:11,height:17}};async function $h(n,t){const e=document.getElementById("button-grid");if(!e)return b.warn("PrintService","Button grid element not found",null,"print"),null;const o=e.querySelector(".button-grid-left-cell"),i=e.querySelector(".button-grid-right-cell");try{const s=e.getBoundingClientRect(),a=o?.getBoundingClientRect().width??0,r=i?.getBoundingClientRect().width??0,c=Math.min(window.devicePixelRatio||1,2),d=await oc(e,{scale:c,backgroundColor:"#ffffff",logging:!1,useCORS:!0}),u=s.width>0?d.width/s.width:1,h=n?0:Math.round(a*u),f=t?0:Math.round(r*u),g=Math.max(0,Math.min(d.width-1,h)),m=Math.max(g+1,Math.min(d.width,d.width-f)),p=Math.max(1,m-g),v=document.createElement("canvas");v.width=p,v.height=d.height,(v.getContext("2d",{willReadFrequently:!0})||v.getContext("2d")).drawImage(d,g,0,p,d.height,0,0,p,d.height);const w=Xh(v,n,t);return b.debug("PrintService",`Captured button grid: ${w.width}x${w.height}`,null,"print"),w}catch(s){return b.error("PrintService","Failed to capture button grid",s,"print"),null}}function Hh(n,t){const e=document.getElementById("notation-grid"),o=document.getElementById("legend-left-canvas"),i=document.getElementById("legend-right-canvas");if(!e)return b.warn("PrintService","Notation grid canvas not found",null,"print"),null;const s=n&&o?o.width:0,a=t&&i?i.width:0,r=s+e.width+a,c=s,d=document.createElement("canvas");d.width=r,d.height=e.height;const u=d.getContext("2d");return n&&o&&s>0&&u.drawImage(o,0,0),u.drawImage(e,c,0),t&&i&&a>0&&u.drawImage(i,c+e.width,0),b.debug("PrintService",`Captured pitch grid: ${d.width}x${d.height}`,null,"print"),d}function qh(n,t){const e=document.getElementById("drum-grid"),o=document.querySelector(".drum-grid-left-cell"),i=document.querySelector(".drum-grid-right-cell");if(!e||e.width===0)return b.debug("PrintService","Drum grid not found or empty",null,"print"),null;const s=e.offsetWidth?e.width/e.offsetWidth:1,a=n?Math.max(0,Math.round((o?.offsetWidth||0)*s)):0,r=t?Math.max(0,Math.round((i?.offsetWidth||0)*s)):0,c=a+e.width+r,d=getComputedStyle(document.documentElement).getPropertyValue("--c-surface")||"#ffffff",u=document.createElement("canvas");u.width=c,u.height=e.height;const h=u.getContext("2d");return h.fillStyle=d.trim()||"#ffffff",h.fillRect(0,0,c,e.height),h.drawImage(e,a,0),b.debug("PrintService",`Captured drum grid: ${u.width}x${u.height}`,null,"print"),u}function Gh(n){const t=document.createElement("canvas");t.width=n.width,t.height=n.height;const e=t.getContext("2d");e.drawImage(n,0,0);const o=e.getImageData(0,0,t.width,t.height),i=o.data;for(let s=0;s<i.length;s+=4){const a=i[s]*.299+i[s+1]*.587+i[s+2]*.114;i[s]=a,i[s+1]=a,i[s+2]=a}return e.putImageData(o,0,0),t}async function Vh(n,t){b.debug("PrintService","Generating score canvas...",{printOptions:n,targetDimensions:t},"print");const e=[];if(n.includeButtonGrid){const M=await Or(n.includeLeftLegend,n.includeRightLegend);M&&e.push({canvas:M,name:"buttons"})}const o=Hh(n.includeLeftLegend,n.includeRightLegend);if(o&&e.push({canvas:o,name:"pitch"}),n.includeDrums){const M=qh(n.includeLeftLegend,n.includeRightLegend);M&&e.push({canvas:M,name:"drums"})}if(e.length===0)return b.warn("PrintService","No content captured for printing",null,"print"),null;n.colorMode==="bw"&&(e.forEach(M=>{M.canvas=Gh(M.canvas)}),b.debug("PrintService","Applied black & white filter",null,"print"));const i=Math.max(...e.map(M=>M.canvas.width)),s=e.reduce((M,P)=>M+P.canvas.height,0),a=n.cropTop||0,r=n.cropBottom||1,c=n.cropLeft||0,d=n.cropRight||1,u=s*(r-a),h=i*(d-c),f=s*a,g=i*c;b.debug("PrintService",`Applying crop: top=${a.toFixed(2)}, bottom=${r.toFixed(2)}, left=${c.toFixed(2)}, right=${d.toFixed(2)}`,null,"print");const m=Math.min(t.width/h,t.height/u),p=document.createElement("canvas");p.width=h*m,p.height=u*m;const v=p.getContext("2d");v.fillStyle="#FFFFFF",v.fillRect(0,0,p.width,p.height);const y=document.createElement("canvas");y.width=i,y.height=s;const w=y.getContext("2d");let S=0;return e.forEach(({canvas:M,name:P})=>{w.drawImage(M,0,S),b.debug("PrintService",`Drew ${P} at y=${S}, height=${M.height}`,null,"print"),S+=M.height}),v.drawImage(y,g,f,h,u,0,0,p.width,p.height),b.debug("PrintService",`Generated composite canvas: ${p.width}x${p.height}`,null,"print"),p}const To={generateScoreCanvas:Vh,async generateAndPrint(){const n=l.state.printOptions,t=300,e=n.pageSize,o=e&&e in Ea?e:"letter",i=Ea[o],s=n.orientation==="landscape"?i.height:i.width,a=n.orientation==="landscape"?i.width:i.height,r=Math.max(1,s-2*Ai),c=Math.max(1,a-2*Ai),d=r*t,u=c*t;b.info("PrintService","Generating print canvas at high resolution",{width:d,height:u,options:n},"print");const h=await this.generateScoreCanvas(n,{width:d,height:u});if(!h){b.error("PrintService","Failed to generate print canvas",null,"print");return}const f=document.getElementById("print-staging-area");f.innerHTML="";const g=document.getElementById("print-style-rules");g.textContent=`@page { size: ${s}in ${a}in; margin: ${Ai}in; }`;const m=document.createElement("img");m.src=h.toDataURL("image/png"),m.style.width="100%",m.style.height="auto",f.appendChild(m),b.info("PrintService","Opening print dialog",null,"print"),setTimeout(()=>window.print(),100)},async prefetchButtonGridSnapshot(n=!0,t=!0){try{await Or(n,t)}catch(e){b.warn("PrintService","Button grid prefetch failed",e,"print")}},invalidateButtonGridSnapshot(){zr()}};function Xh(n,t,e){if(!n)return n;const o=document.getElementById("notation-grid"),i=document.getElementById("legend-left-canvas"),s=document.getElementById("legend-right-canvas"),a=t&&i?i.width:0,r=e&&s?s.width:0,c=(o?.width??0)+a+r||n.width;if(!c||c===n.width)return n;const d=c/n.width,u=Math.max(1,Math.round(n.height*d)),h=document.createElement("canvas");return h.width=c,h.height=u,(h.getContext("2d",{willReadFrequently:!0})||h.getContext("2d")).drawImage(n,0,0,h.width,h.height),h}async function Or(n,t){const e=`${n}-${t}`;return On[e]!==void 0?On[e]??null:(Le[e]||(Le[e]=(async()=>{await Uh();const o=await $h(n,t);return On[e]=o,Le[e]=null,o})().catch(o=>{throw Le[e]=null,o})),Le[e])}function Uh(){return new Promise(n=>{typeof window.requestIdleCallback=="function"?requestIdleCallback(()=>n(),{timeout:zh}):requestAnimationFrame(()=>n())})}function zr(){Object.keys(On).forEach(n=>{delete On[n]}),Object.keys(Le).forEach(n=>{delete Le[n]})}typeof window<"u"&&window.addEventListener("resize",()=>zr());function me(n,t){if(!n)return`rgba(204, 204, 204, ${t})`;const e=parseInt(n.slice(rr,Js),xo),o=parseInt(n.slice(Js,ta),xo),i=parseInt(n.slice(ta,Xd),xo);return`rgba(${e}, ${o}, ${i}, ${t})`}function Zo(n,t){if(!n||typeof n!="string")return Vd;const e=parseInt(n.slice(rr),xo),o=t<0?Ud:Yd,i=t<0?t*-1:t,s=e>>16,a=e>>8&255,r=e&255;return"#"+(16777216+(Math.round((o-s)*i)+s)*65536+(Math.round((o-a)*i)+a)*256+(Math.round((o-r)*i)+r)).toString(16).slice(1)}const Yh=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor"/>\r
</svg>`,jh=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(90, 12, 12)"/>\r
</svg>`,Qh=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(180, 12, 12)"/>\r
</svg>`,Kh=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(270, 12, 12)"/>\r
</svg>`,$r=un;function Tn(n,t){const{blend:e,cutoff:o,resonance:i}=t,s=(o-1)/30,a=20,r=n-s,c=s-n;let d=1/(1+Math.pow(Math.max(0,r*a),2)),u=1/(1+Math.pow(Math.max(0,c*a),2));const h=.01;d<h&&(d=0),u<h&&(u=0);const f=d*u;let g;e<=1?g=u*(1-e)+f*e:g=f*(2-e)+d*(e-1);const m=1-(i||0)/105,p=Math.max(.01,.2*m*m),v=Math.exp(-Math.pow((n-s)/p,2)),y=(i||0)/100*.6,w=g+v*y,S=Math.max(0,Math.min(1,w));return S<h?0:S}function Zh(n,t){const e=t/100;return 1-e+e*n}function Jn(n,t){const e=t.mix||0;if(e===0)return new Float32Array(n);const o=new Float32Array(n.length),i=e/100;for(let s=0;s<n.length;s++){const a=n[s]??0,r=(s+.5)/$r,c=Tn(r,t);if(c<a){const h=(a-c)*i;o[s]=a-h}else o[s]=a;const d=o[s]??0;o[s]=Math.max(0,d)}return o}function Qi(n){const t=l.state.timbres[n];if(!t)return new Float32Array($r);const e=t.filter;return e&&e.enabled!==!1&&(e.mix||0)>0?Jn(t.coeffs,e):new Float32Array(t.coeffs)}b.moduleLoaded("HarmonicBins with Columnar Structure");function Ki(n,...t){}const Io={0:Yh,90:jh,180:Qh,270:Kh},pe=un;let Bt=null,kt=null,Ft=new Float32Array(pe).fill(0),St=null,Qt=new Float32Array(pe).fill(0);const xs=[],Zi=[];let nn=!1,Zt=null;const fo=new Array(pe).fill(null);let po=!1;const go=new Float32Array(pe).fill(1);new Float32Array(pe).fill(0);function Ji(){if(!St||((!Bt||!kt||!Zt)&&(Bt=document.getElementById("filter-overlay-canvas"),Zt=document.querySelector(".harmonic-bins-grid"),Bt&&(kt=Bt.getContext("2d"))),!Bt||!kt||!Zt))return;const{width:n,height:t}=Bt;kt.clearRect(0,0,n,t);const o=t*.95,i=t,s=l.state.timbres[St]?.filter,a=s&&s.enabled!==!1;if(s&&a){const r=s.mix||0;if(r===0){go.fill(1);return}const c=[];for(let g=0;g<pe;g++){const m=(g+.5)/pe,p=Tn(m,s);go[g]=Zh(p,r),c.push({bin:g+1,rawFilterAmp:p.toFixed(3),afterMix:(go[g]??0).toFixed(3)})}kt.beginPath();const d=2;for(let g=0;g<=n;g+=d){const m=g/n,p=Tn(m,s),v=i-p*o;g===0?kt.moveTo(g,v):kt.lineTo(g,v)}const h=.4+r/100*.6;kt.strokeStyle=me(Zo(St,-.3),h),kt.lineWidth=2.5,kt.stroke();const f=r/100;if(f>0){kt.beginPath(),kt.moveTo(0,0),kt.lineTo(n,0);const g=Tn(1,s),m=i-g*o;kt.lineTo(n,m);for(let p=n;p>=0;p-=2){const v=p/n,y=Tn(v,s),w=i-y*o;kt.lineTo(p,w)}kt.closePath(),kt.fillStyle=`rgba(255, 255, 255, ${f})`,kt.fill()}}else go.fill(1)}function zn(){if(!St)return;const n=St;xs.forEach((t,e)=>{const o=t.sliderTrack.querySelector(".slider-fill"),i=t.sliderTrack.querySelector(".harmonic-label-internal");if(!o||!i)return;const s=Ft[e]??0;if(o.style.height=`${s*100}%`,s>0){const r=Zo(n,-.1);o.style.backgroundColor=me(r,1)}else o.style.backgroundColor="transparent";const a=o.querySelector("canvas");a&&a.remove(),s>.1?(i.style.color="rgba(255, 255, 255, 0.35)",i.style.textShadow="0 0 2px rgba(0,0,0,0.3)"):(i.style.color="rgba(51, 51, 51, 0.5)",i.style.textShadow="0 0 1px rgba(255,255,255,0.3)")}),Ji()}function Ma(n,t=null){if(!St||!Zt)return;const e=n.target instanceof Element?n.target:null;if(Ki("log","[BINS DRAG] handleBinPointerEvent called",{clientX:n.clientX,clientY:n.clientY}),b.debug("HarmonicBins","handleBinPointerEvent called",{target:e?.className},"filter"),e?.classList.contains("phase-button")||e?.closest(".phase-button")||e?.tagName==="path"||e?.tagName==="svg"){b.debug("HarmonicBins","Blocking phase button interaction in handleBinPointerEvent",null,"filter");return}if(t===null){const h=Zt.getBoundingClientRect(),f=n.clientX-h.left,g=h.width/pe,m=Math.floor(f/g);t=Math.max(0,Math.min(pe-1,m))}if(b.debug("HarmonicBins","handleBinPointerEvent - binIndex",{binIndex:t},"filter"),t===null)return;const o=l.state.timbres[St];if(!o)return;const i=xs[t];if(!i)return;const a=i.sliderTrack.getBoundingClientRect(),r=n.clientY-a.top,c=a.height,d=(c-r)/c,u=Math.max(0,Math.min(1,d));if(Ki("log","[BINS DRAG] Setting bin",t+1,"value:",u.toFixed(3)),u===0){b.debug("HarmonicBins","Setting coefficient to zero immediately for bin",{binIndex:t},"filter");const h=new Float32Array(o.coeffs);h[t]=0,Ft[t]=0,l.setHarmonicCoefficients(St,h);const f=fo[t];typeof f=="number"&&(clearTimeout(f),fo[t]=null),nn||(wt.triggerAttack("C4",St),l.emit("spacebarPlayback",{color:St,isPlaying:!0}),nn=!0);const g=l.state.timbres[St]?.filter;g&&g.enabled!==!1&&(g.mix||0)>0&&Jn(h,g),window.waveformVisualizer?.generateWaveform&&window.waveformVisualizer.generateWaveform(),b.debug("HarmonicBins",`Set coefficient H${t+1} to 0 for color ${St}`,null,"filter")}else{const h=fo[t];typeof h=="number"&&(clearTimeout(h),fo[t]=null),nn||(wt.triggerAttack("C4",St),l.emit("spacebarPlayback",{color:St,isPlaying:!0}),nn=!0),b.debug("HarmonicBins","BEFORE creating newCoeffs - store coeffs",{coeffs:o.coeffs},"filter");const f=new Float32Array(o.coeffs);b.debug("HarmonicBins","AFTER copying to newCoeffs",{newCoeffs:f},"filter"),f[t]=u,Ft[t]=u,b.debug("HarmonicBins",`AFTER setting newCoeffs[${t}] = ${u}`,{newCoeffs:f},"filter"),l.setHarmonicCoefficients(St,f);const g=l.state.timbres[St]?.filter;g&&g.enabled!==!1&&(g.mix||0)>0&&Jn(f,g),window.waveformVisualizer?.generateWaveform&&window.waveformVisualizer.generateWaveform(),b.debug("HarmonicBins",`Updated coefficient H${t+1} to ${u} for color ${St}`,null,"filter"),b.debug("HarmonicBins","All coefficients",{newCoeffs:f},"filter")}zn()}function ts(n,t,e,o){const i=e.coeffs,s=e.phases||new Float32Array(i.length).fill(0);let a=!0,r=!0;if(n.length!==i.length)a=!1;else for(let d=0;d<n.length;d++){const u=n[d]??0,h=i[d]??0;if(Math.abs(u-h)>.001){a=!1;break}}if(t.length!==s.length)r=!1;else for(let d=0;d<t.length;d++){const u=t[d]??0,h=s[d]??0;if(Math.abs(u-h)>.001){r=!1;break}}return a&&r}function Pa(n){if(!n)return;St=n;const t=l.state.timbres[n];t&&(t.filter?t.filter.enabled===void 0&&(t.filter.enabled=!0):t.filter={enabled:!0,blend:1,cutoff:16,resonance:0,type:"lowpass",mix:0},b.debug("HarmonicBins","updateForNewColor - timbre.coeffs",{coeffs:t.coeffs},"filter"),b.debug("HarmonicBins","updateForNewColor - timbre.phases",{phases:t.phases},"filter"),Ft=new Float32Array(t.coeffs),t.phases?Qt=new Float32Array(t.phases):Qt=new Float32Array(Ft.length).fill(0),ts(Ft,Qt,t),b.debug("HarmonicBins","updateForNewColor - final coeffs",{coeffs:Ft},"filter"),b.debug("HarmonicBins","updateForNewColor - final phases",{phases:Qt},"filter"),Zi.forEach(({phaseBtn:e},o)=>{if(!e)return;let s=(Qt[o]||0)%(2*Math.PI);s<0&&(s+=2*Math.PI);const a=.1;let r=0;Math.abs(s-Math.PI/2)<a?r=90:Math.abs(s-Math.PI)<a?r=180:Math.abs(s-3*Math.PI/2)<a&&(r=270),e.innerHTML=Io[r]}),zn())}function Jh(){const n=document.querySelector(".filter-container"),t=n?.querySelector(".filter-bins-wrapper"),e=n?.querySelector(".filter-vertical-blend-wrapper");if(!n||!t||!e){b.error("HarmonicBins","Missing required elements - aborting init",null,"audio");return}Zt=document.createElement("div"),Zt.className="harmonic-bins-grid";for(let r=0;r<pe;r++){const c=document.createElement("div");c.className="slider-column";const d=document.createElement("div");d.className="slider-track";const u=document.createElement("div");u.className="slider-fill",d.appendChild(u);const h=document.createElement("div");h.className="harmonic-label-internal",h.textContent=`${r+1}`,d.appendChild(h),c.appendChild(d);const f=document.createElement("button");f.className="phase-button",f.innerHTML=Io[0],f.dataset.binIndex=String(r),f.addEventListener("pointerenter",()=>{if(po){const m=Pt(),p=wt.synths,v=St;if(v&&p?.[v]?.activeNotes?.C4){const y=p[v].activeNotes.C4;y.oscillators?.[r]&&y.oscillators[r].volume.linearRampTo(-1/0,.015,m)}setTimeout(()=>{const y=St,w=y?l.state.timbres[y]:void 0;if(!y||!w)return;const S=new Float32Array(w.coeffs);S[r]=0,Ft[r]=0,l.setHarmonicCoefficients(y,S);const M=l.state.timbres[y]?.filter;M&&M.enabled!==!1&&(M.mix||0)>0&&Jn(S,M),zn()},.015*1e3)}}),f.addEventListener("click",g=>{if(po){g.preventDefault();return}const m=St;if(!m)return;b.debug("HarmonicBins","Phase button click handler started",null,"filter"),b.debug("HarmonicBins","Current coeffs before phase change",{coeffs:Ft},"filter"),g.preventDefault();const p=new Float32Array(Qt),v=new Float32Array(Qt);let w=(v[r]||0)%(2*Math.PI);w<0&&(w+=2*Math.PI);const S=.1;let M=0;Math.abs(w)<S?M=Math.PI/2:Math.abs(w-Math.PI/2)<S?M=Math.PI:Math.abs(w-Math.PI)<S?M=3*Math.PI/2:M=0,v[r]=M,Qt=v,window.waveformVisualizer?.startPhaseTransition&&window.waveformVisualizer.startPhaseTransition(p,v,r),l.setHarmonicPhases(m,v);const P=M===0?0:Math.abs(M-Math.PI/2)<S?90:Math.abs(M-Math.PI)<S?180:270;f.innerHTML=Io[P],b.debug("HarmonicBins",`Phase button clicked for H${r+1}, new phase: ${P}`,null,"filter")}),c.appendChild(f),Zt.appendChild(c),xs.push({column:c,label:h,sliderTrack:d,sliderFill:u,phaseBtn:f}),Zi.push({phaseBtn:f})}Zt.addEventListener("pointerdown",r=>{const c=r.target instanceof Element?r.target:null;if(Ki("log","[BINS DRAG] Pointerdown event fired",{target:c,className:c?.className}),c?.classList.contains("phase-button")||c?.closest(".phase-button")){b.debug("HarmonicBins","Pointerdown blocked - phase button clicked",null,"filter");return}if(b.debug("HarmonicBins","Pointerdown - handling bin interaction",null,"filter"),r.preventDefault(),po=!0,!St)return;const d=St;wt.triggerAttack("C4",d),l.emit("spacebarPlayback",{color:d,isPlaying:!0}),nn=!0,Ma(r);const u=f=>Ma(f),h=()=>{window.removeEventListener("pointermove",u),window.removeEventListener("pointerup",h),po=!1;const f=!!window.waveformVisualizer?.generateWaveform;l.recordState(),wt.triggerRelease("C4",d),l.emit("spacebarPlayback",{color:d,isPlaying:!1}),nn=!1,f?setTimeout(()=>{window.waveformVisualizer?.generateWaveform?.()},0):b.warn("HarmonicBins","Static waveform visualizer not ready when drag ended",null,"audio")};window.addEventListener("pointermove",u),window.addEventListener("pointerup",h)}),Bt=document.createElement("canvas"),Bt.id="filter-overlay-canvas",Bt.className="filter-overlay-canvas",Bt.style.pointerEvents="none",kt=Bt.getContext("2d"),Zt.appendChild(Bt);const o=document.createElement("div");o.className="vertical-blend-wrapper";const i=document.createElement("div");i.id="vertical-blend-track";const s=document.createElement("div");s.id="vertical-blend-thumb",s.textContent="M",i.appendChild(s),o.appendChild(i),t.appendChild(Zt),e.appendChild(o);const a=()=>{if(!Bt)return;const r=Bt.getBoundingClientRect();(Bt.width!==r.width||Bt.height!==r.height)&&(Bt.width=r.width,Bt.height=r.height,Ji())};St=l.state.selectedNote?.color||"#4a90e2",Pa(St),l.on("timbreChanged",r=>{if(r&&r===St){b.debug("HarmonicBins","timbreChanged event - checking what changed",null,"filter");const c=l.state.timbres[r];if(!c)return;const d=c.coeffs,u=c.phases;let h=!1;if(b.debug("HarmonicBins","Comparing coefficients...",null,"filter"),b.debug("HarmonicBins","Local coeffs",{coeffs:Ft},"filter"),b.debug("HarmonicBins","Store coeffs",{newCoeffs:d},"filter"),Ft.length!==d.length)b.debug("HarmonicBins","Array length mismatch - coeffsChanged = true",null,"filter"),h=!0;else for(let f=0;f<d.length;f++){const g=Ft[f]??0,m=d[f]??0,p=Math.abs(g-m);if(p>.001){b.debug("HarmonicBins",`Coefficient ${f} changed: ${g} -> ${m} (diff: ${p})`,null,"filter"),h=!0;break}}b.debug("HarmonicBins","Force syncing local coeffs with store",null,"filter"),ts(Ft,Qt,c),Ft=new Float32Array(d),u?Qt=new Float32Array(u):Qt=new Float32Array(Ft.length).fill(0),ts(Ft,Qt,c),h?(b.debug("HarmonicBins","Coefficients changed - updating visuals",null,"filter"),zn()):(b.debug("HarmonicBins","No coefficient changes detected - but local coeffs synced",null,"filter"),Ji()),Zi.forEach(({phaseBtn:f},g)=>{if(!f)return;let p=(Qt[g]||0)%(2*Math.PI);p<0&&(p+=2*Math.PI);const v=.1;let y=0;Math.abs(p-Math.PI/2)<v?y=90:Math.abs(p-Math.PI)<v?y=180:Math.abs(p-3*Math.PI/2)<v&&(y=270),f.innerHTML=Io[y]})}}),l.on("noteChanged",({newNote:r}={})=>{r?.color&&r.color!==St&&Pa(r.color)}),l.on("filterChanged",r=>{const c=St;if(c&&r===c){zn();const d=l.state.timbres[c],u=d?.filter;if(!d)return;u&&u.enabled!==!1&&(u.mix||0)>0?Jn(d.coeffs,u):new Float32Array(d.coeffs)}}),new ResizeObserver(a).observe(Zt),a(),b.info("HarmonicBins","Initialized with columnar div structure and perfect alignment",null,"filter")}b.moduleLoaded("EngineAudio","general");let lt=null;const wt={init(){b.info("EngineAudio","Initializing with engine createSynthEngine()",null,"audio"),lt=wd({timbres:l.state.timbres,masterVolume:0,harmonicFilter:{getFilteredCoefficients:n=>Qi(n)},effectsManager:window.audioEffectsManager?{applySynthEffects:(n,t,e)=>{window.audioEffectsManager?.applySynthEffects(n,t,e)},applyEffectsToVoice:(n,t)=>{window.audioEffectsManager?.applyEffectsToVoice(n,t)}}:void 0,logger:{debug:(n,t,e)=>{b.debug(n,t,e,"audio")},info:(n,t,e)=>{b.info(n,t,e,"audio")},warn:(n,t,e)=>{b.warn(n,t,e,"audio")}}}),lt.init(),l.on("timbreChanged",n=>{n&&this.updateSynthForColor(n)}),l.on("filterChanged",n=>{n&&this.updateSynthForColor(n)}),l.on("audioEffectChanged",n=>{if(!n||!n.color||!n.effectType)return;const{effectType:t,color:e}=n;(t==="vibrato"||t==="tremolo")&&this.updateSynthForColor(e)}),l.on("volumeChanged",n=>{typeof n=="number"&&this.setVolume(n)}),window.synthEngine=this,b.info("EngineAudio","Initialization complete",null,"audio")},updateSynthForColor(n){if(!lt)return;const t=l.state.timbres[n];t&&(t.vibrato||(t.vibrato={speed:0,span:0}),t.tremelo||(t.tremelo={speed:0,span:0}),lt.updateSynthForColor(n))},playNote(n,t,e){lt&&lt.playNote(n,t,e)},triggerAttack(n,t,e,o){lt&&lt.triggerAttack(n,t,e,o)},triggerAttackInteractive(n,t){lt&&lt.triggerAttackInteractive(n,t)},triggerRelease(n,t,e){lt&&lt.triggerRelease(n,t,e)},releaseAll(){lt&&lt.releaseAll()},quickReleasePitches(n,t){lt&&lt.quickReleasePitches(n,t)},setSynth(n,t){lt&&lt.setSynth?.(n,t)},getSynth(n){return lt?lt.getSynth(n):null},getAllSynths(){return lt?lt.getAllSynths():{}},setBpm(n){lt&&lt.setBpm(n)},setVolume(n){lt&&lt.setVolume(n)},getMasterGainNode(){return lt?lt.getMasterGainNode():null},getMainVolumeNode(){return lt?lt.getMainVolumeNode():null},createWaveformAnalyzer(n){return lt?lt.createWaveformAnalyzer(n):null},getWaveformAnalyzer(n){return lt?lt.getWaveformAnalyzer(n):null},getAllWaveformAnalyzers(){return lt?lt.getAllWaveformAnalyzers():new Map},removeWaveformAnalyzer(n){lt&&lt.removeWaveformAnalyzer(n)},disposeAllWaveformAnalyzers(){lt&&lt.disposeAllWaveformAnalyzers()},stopBackgroundMonitors(){lt&&lt.stopBackgroundMonitors()},teardown(){this.dispose()},dispose(){lt&&(lt.dispose(),lt=null)}};class tm{elements=new Map;initialized=!1;init(){this.initialized||(this.cacheElement("notationGrid","notation-grid"),this.cacheElement("playheadCanvas","playhead-canvas"),this.cacheElement("hoverCanvas","hover-canvas"),this.cacheElement("drumGrid","drum-grid"),this.cacheElement("drumPlayheadCanvas","drum-playhead-canvas"),this.cacheElement("drumHoverCanvas","drum-hover-canvas"),this.cacheElement("appContainer","app-container"),this.cacheElement("pitchGridWrapper","pitch-grid-wrapper"),this.cacheElement("drumGridWrapper","drum-grid-wrapper"),this.cacheElement("eraserButton","eraser-tool-button"),this.cacheElement("playButton","play-button"),this.cacheElement("stopButton","stop-button"),this.cacheElement("clearButton","clear-button"),this.cacheElement("loopButton","loop-button"),this.cacheElement("undoButton","undo-button"),this.cacheElement("redoButton","redo-button"),this.cacheElement("noteBankContainer","note-bank-container"),this.cacheElement("tonicModeGrid","tonic-mode-grid"),this.cacheElement("degreeVisibilityToggle","degree-visibility-toggle"),this.cacheElement("degreeModeToggle","degree-mode-toggle"),this.cacheElement("flatBtn","flat-toggle-btn"),this.cacheElement("sharpBtn","sharp-toggle-btn"),this.cacheElement("frequencyBtn","hz-toggle-btn"),this.cacheElement("octaveLabelBtn","spn-octave-toggle-btn"),this.cacheElement("focusColoursToggle","focus-colours-toggle"),this.cacheElement("harmonyContainerMain","chordShape-container"),this.cacheElement("tempoSlider","tempo-slider"),this.cacheElement("volumeSlider","vertical-volume-slider"),this.initialized=!0)}cacheElement(t,e){const o=document.getElementById(e);o&&this.elements.set(t,o)}get(t){return this.initialized?this.elements.get(t)??null:null}getMultiple(...t){const e={};return t.forEach(o=>{e[o]=this.get(o)}),e}has(t){return this.elements.has(t)}refresh(){this.elements.clear(),this.initialized=!1,this.init()}getStats(){const t=this.elements.size,e=Array.from(this.elements.values()).filter(o=>o!==null).length;return{totalCached:t,foundElements:e,missingElements:t-e}}}const Te=new tm;let em=[],nm=0,Ta=null,ko=[];function om(){const n=l.state,t=Dt.getColumnMap(n);if(Ta!==t){Ta=t,ko=[];for(const e of t.entries){if(e.type!=="beat"||e.canvasIndex===null||e.macrobeatIndex===null)continue;const o=e.macrobeatIndex,i=ko[o];if(!i){ko[o]={start:e.canvasIndex,end:e.canvasIndex};continue}i.start=Math.min(i.start,e.canvasIndex),i.end=Math.max(i.end,e.canvasIndex)}}}function Es(){return{cellWidth:l.state.cellWidth,modulationMarkers:l.state.modulationMarkers,baseMicrobeatPx:l.state.baseMicrobeatPx}}function Ia(){return em}function im(){return nm}function $o(n){const t=Es(),e=Math.max(0,Math.floor(n));return ze.getColumnPixelPosition(e,t,l.state)?.xStart??0}function Hr(n){const t=Es(),e=Math.max(0,Math.floor(n));return ze.getColumnPixelPosition(e,t,l.state)?.width??0}function sm(){return Array.isArray(l.state.columnWidths)?l.state.columnWidths.length:0}function am(){const n=Es(),t=sm();return ze.getColumnPixelPosition(t,n,l.state)?.xStart??0}function es(n){const t=l.state;om();const e=Dt.getColumnMap(t),o=e.canvasToVisual.get(Math.floor(n));if(o===void 0)return null;const s=e.entries[o]?.macrobeatIndex;if(s==null)return null;const a=ko[s];if(!a)return null;const r=$o(a.start),c=$o(a.end+1);return{x:r,width:Math.max(0,c-r)}}const rm={hz:0,minAlpha:.2,maxAlpha:.2,maxExpandPx:0,colorRgb:"rgb(255, 235, 0)"};function In(n,t,e,o,i,s,a=rm){if(!Number.isFinite(t)||!Number.isFinite(e)||!Number.isFinite(o)||!Number.isFinite(i)||o<=0||i<=0)return;const r=s/1e3,c=a.hz>0?.5+.5*Math.sin(r*(2*Math.PI)*a.hz):1,d=a.minAlpha+(a.maxAlpha-a.minAlpha)*c,u=Math.min(a.maxExpandPx,Math.max(0,o*.1))*c;n.save(),n.globalAlpha=d,n.fillStyle=a.colorRgb,n.fillRect(t-u/2,e,o+u,i),n.restore()}class lm{canvas=null;ctx=null;animationFrameId=null;_lastColumnIndex=null;_lastColumnProgress=0;_lastColumnStartX=0;_lastColumnWidth=0;_lastDebugLogTime=0;activeAnimations=new Map;popDuration={scaleUp:100,scaleDown:300};popScale=1.5;ensureContext(){return this.canvas||(this.canvas=document.getElementById("drum-playhead-canvas")),this.canvas?(this.ctx||(this.ctx=this.canvas.getContext("2d")),this.ctx):null}initialize(){this.canvas=document.getElementById("drum-playhead-canvas"),this.canvas&&(this.ctx=this.canvas.getContext("2d"),l.on("playbackStateChanged",()=>this.handlePlaybackStateChange()),l.on("tempoChanged",()=>this.invalidateTimeMap()))}drawPlayheadLine(t){const e=this.ensureContext();if(!e||!this.canvas)return;const o=xt(this.canvas);e.strokeStyle="rgba(255, 0, 0, 0.8)",e.lineWidth=2,e.beginPath(),e.moveTo(t,0),e.lineTo(t,o),e.stroke()}drawColumnHighlight(t,e,o){const i=this.ensureContext();if(!i||!this.canvas)return;const s=xt(this.canvas);In(i,t,0,e,s,o)}handlePlaybackStateChange(){l.state.isPlaying&&!l.state.isPaused?this.startRendering():this.stopRendering({clear:!l.state.isPaused})}invalidateTimeMap(){}startRendering(){this.animationFrameId||this.render()}stopRendering({clear:t}={clear:!0}){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),t&&this.ctx&&this.canvas&&this.ctx.clearRect(0,0,Wt(this.canvas),xt(this.canvas))}render(){if(!l.state.isPlaying||l.state.isPaused||!this.ctx||!this.canvas){this.animationFrameId=null;return}this.ctx.clearRect(0,0,Wt(this.canvas),xt(this.canvas));const t=Number(et.seconds||0),e=this.calculateXFromTime(t);if(e===null){this.animationFrameId=requestAnimationFrame(()=>this.render());return}const o=xt(this.canvas);if(l.state.playheadMode==="macrobeat"){const i=this._lastColumnIndex,s=(i!==null?es(i):null)??(i!==null?es(i+1):null);s?In(this.ctx,s.x,0,s.width,o,performance.now()):In(this.ctx,this._lastColumnStartX,0,this._lastColumnWidth,o,performance.now())}else l.state.playheadMode==="microbeat"?In(this.ctx,this._lastColumnStartX,0,this._lastColumnWidth,o,performance.now()):(this.ctx.strokeStyle="#FF6B35",this.ctx.lineWidth=3,this.ctx.shadowColor="#FF6B35",this.ctx.shadowBlur=6,this.ctx.beginPath(),this.ctx.moveTo(e,0),this.ctx.lineTo(e,o),this.ctx.stroke(),this.ctx.shadowBlur=0);this.debugPlayhead(et.seconds,e),this.animationFrameId=requestAnimationFrame(()=>this.render())}calculateXFromTime(t){this._lastColumnIndex=null,this._lastColumnProgress=0,this._lastColumnStartX=0,this._lastColumnWidth=0;const e=Ia();if(!Array.isArray(e)||e.length<2)return null;for(let o=0;o<e.length-1;o++){const i=e[o],s=e[o+1];if(!(typeof i!="number"||typeof s!="number")&&t>=i&&t<s){const a=s-i,r=t-i,c=$o(o)??0,d=Hr(o)??0;return this._lastColumnIndex=o,this._lastColumnProgress=a>0?r/a:0,this._lastColumnStartX=c,this._lastColumnWidth=d,c+(a>0?r/a*d:0)}}return null}debugPlayhead(t,e){if(!window.__DEBUG_PLAYHEAD_SYNC__)return;const o=performance.now();if(o-this._lastDebugLogTime<250)return;this._lastDebugLogTime=o;const i=Ia(),s=this._lastColumnIndex,a=Array.isArray(i)&&s!==null&&s>=0?i[s]:void 0,r=Array.isArray(i)&&s!==null&&s+1<i.length?i[s+1]:void 0,c=Array.isArray(i)?i[i.length-1]??0:0,d=im(),u={transportSeconds:Number(t.toFixed(3)),drumX:Number((e??0).toFixed(2)),columnIndex:s,columnProgress:Number(this._lastColumnProgress.toFixed(3)),drumStartTime:Number(a?.toFixed(3)??NaN),transportStartTime:Number(a?.toFixed(3)??NaN),startDelta:0,drumEndTime:Number(r?.toFixed(3)??NaN),transportEndTime:Number(r?.toFixed(3)??NaN),endDelta:0,drumTimelineEnd:Number(c.toFixed(3)),transportTimelineEnd:Number(d.toFixed(3)),timelineDelta:Number((c-d).toFixed(3)),toneLoopStart:Number(Number(et.loopStart??0).toFixed(3)),toneLoopEnd:Number(Number(et.loopEnd??0).toFixed(3)),storeLooping:l.state.isLooping};b.debug("DrumPlayheadRenderer","Playhead diagnostics",u,"canvas")}triggerNotePop(t,e){const o=`${t}-${e}`;this.activeAnimations.set(o,{startTime:performance.now(),phase:"scaleUp"}),window.drumGridRenderer&&window.drumGridRenderer.render()}getAnimationScale(t,e){const o=`${t}-${e}`,i=this.activeAnimations.get(o);if(!i)return 1;const s=performance.now(),a=s-i.startTime;if(i.phase==="scaleUp"){if(a>=this.popDuration.scaleUp)return i.phase="scaleDown",i.startTime=s,this.popScale;{const r=a/this.popDuration.scaleUp;return 1+(this.popScale-1)*r}}else if(i.phase==="scaleDown"){if(a>=this.popDuration.scaleDown)return this.activeAnimations.delete(o),1;{const r=a/this.popDuration.scaleDown;return this.popScale-(this.popScale-1)*r}}return 1}hasActiveAnimations(){return this.activeAnimations.size>0}cleanupAnimations(){const t=performance.now();for(const[e,o]of this.activeAnimations.entries()){const i=t-o.startTime,s=o.phase==="scaleUp"?this.popDuration.scaleUp:this.popDuration.scaleUp+this.popDuration.scaleDown;i>s&&this.activeAnimations.delete(e)}}}const Pe=new lm;b.moduleLoaded("SixteenthStampPlacements","stamps");function cm(n,t,e,o="#4a90e2"){return Qo(n)?l.addSixteenthStampPlacement(n,t,e,o):(b.warn("SixteenthStampPlacements",`Invalid sixteenth stamp ID: ${n}`,{sixteenthStampId:n},"stamps"),null)}function dm(n,t,e,o){return l.eraseSixteenthStampsInArea(n,t,e,o)}function qr(){l.clearAllSixteenthStamps()}function um(){return l.getSixteenthStampPlaybackData()}b.moduleLoaded("SixteenthStampScheduler","stamps");const ka=["0","16n","8n",{"8n":1,"16n":1}];function Gr(n,t=null){const e=Qo(n);if(!e)return b.warn("SixteenthStampScheduler",`Unknown sixteenth stamp ID: ${n}`,{sixteenthStampId:n},"stamps"),[];const o=[];return e.ovals.forEach(i=>{const s=`oval_${i}`,a=t?.shapeOffsets?.[s]||0;o.push({offset:ka[i],duration:"8n",type:"oval",slot:i,shapeKey:s,rowOffset:a})}),e.diamonds.forEach(i=>{const s=`diamond_${i}`,a=t?.shapeOffsets?.[s]||0;o.push({offset:ka[i],duration:"16n",type:"diamond",slot:i,shapeKey:s,rowOffset:a})}),o}b.moduleLoaded("TripletStampPlacements","triplets");function hm(n,t,e,o="#4a90e2"){const i=Ko(n);if(!i)return b.warn("TripletStampPlacements",`Invalid triplet stamp ID: ${n}`,{tripletStampId:n},"triplets"),null;const s=Lr[i.span]??1;if(!mm(t,s,e))return b.debug("TripletStampPlacements",`Cannot place triplet at time ${t}, row ${e} - collision detected`,{tripletStampId:n,startTimeIndex:t,row:e,span:s},"triplets"),null;const a=e,r={id:`triplet_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,tripletStampId:n,startTimeIndex:t,span:s,row:e,globalRow:a,color:o,timestamp:Date.now()};return l.addTripletStampPlacement(r)}function mm(n,t,e){const o=l.state,i=Ot(o),s=t*2,a=Yt(n,o);for(const r of i){const c=r.columnIndex,d=r.columnIndex+1;if(c>=a&&c<a+s||a>=c&&a<=d)return!1}if(o.sixteenthStampPlacements){for(const r of o.sixteenthStampPlacements)if(r.row===e){const c=Oe(r.startColumn,o);if(c===null)return!1;const d=c+2,u=n+s;if(!(d<=n||c>=u))return!1}}if(o.tripletStampPlacements){for(const r of o.tripletStampPlacements)if(r.row===e){const c=r.startTimeIndex+r.span*2;if(!(n+s<=r.startTimeIndex||n>=c))return!1}}return!0}function fm(n,t,e,o){const i=l.state;if(!i.tripletStampPlacements)return!1;const s=[];for(const a of i.tripletStampPlacements)if(a.row>=e&&a.row<=o){const r=a.span*2,c=Yt(a.startTimeIndex,i);c+r-1<n||c>t||s.push(a.id)}return s.length>0?(s.forEach(a=>l.removeTripletStampPlacement(a)),b.debug("TripletStampPlacements",`Erased ${s.length} triplet groups`,{removedIds:s,eraseArea:{eraseStartCol:n,eraseEndCol:t,eraseStartRow:e,eraseEndRow:o}},"triplets"),!0):!1}function pm(){return l.getTripletStampPlaybackData()}function Vr(){l.clearAllTripletStamps(),b.info("TripletStampPlacements","Cleared all triplet stamp placements",null,"triplets")}b.moduleLoaded("TripletScheduler","triplets");function Xr(n,t=null){const e=Ko(n);if(!e)return b.warn("TripletScheduler",`Unknown triplet stamp ID: ${n}`,{tripletStampId:n},"triplets"),[];const o=[],i=e.span==="eighth"?"8t":"4t",s=i;return e.hits.forEach(a=>{const r=`triplet_${a}`,c=t?.shapeOffsets?.[r]||0;let d;if(a===0)d="0";else if(a===1)d=i;else if(a===2){const u=Nt(i).toSeconds();d=Nt(u*2).toNotation()}else{const u=Nt(i).toSeconds();d=Nt(u*a).toNotation()}o.push({offset:d,duration:s,type:e.span==="eighth"?"triplet-eighth":"triplet-quarter",slot:a,shapeKey:r,rowOffset:c}),b.debug("TripletScheduler",`Triplet stamp ${n} ${e.span} at slot ${a} with offset "${d}", rowOffset: ${c}`,"triplets")}),b.debug("TripletScheduler",`Total events for triplet stamp ${n}:`,o.length,"triplets"),o}b.moduleLoaded("EngineTransport","general");let zt=null;const An=()=>Te.get("playheadCanvas")??document.getElementById("playhead-canvas"),vo=()=>Te.get("drumPlayheadCanvas")??document.getElementById("drum-playhead-canvas"),gm=()=>Te.get("beatLineHighlight")??document.getElementById("beat-line-highlight"),Ee={init(){b.info("EngineTransport","Initializing with engine createTransportService()",null,"transport"),zt=Ed({synthEngine:wt,stateCallbacks:{getState:()=>({tempo:l.state.tempo,columnWidths:l.state.columnWidths,hasAnacrusis:l.state.hasAnacrusis,macrobeatBoundaryStyles:l.state.macrobeatBoundaryStyles,modulationMarkers:l.state.modulationMarkers,isLooping:l.state.isLooping,isPaused:l.state.isPaused,cellWidth:l.state.cellWidth,placedNotes:l.state.placedNotes,timbres:l.state.timbres,fullRowData:l.state.fullRowData,playheadMode:l.state.playheadMode}),getStampPlaybackData:()=>um().map(n=>({sixteenthStampId:String(n.sixteenthStampId),column:n.column,row:n.row,color:n.color,placement:n.placement})),getStampScheduleEvents:(n,t)=>{const e=typeof n=="string"?Number(n):n;return Number.isFinite(e)?Gr(e,t??null):[]},getTripletPlaybackData:()=>pm().map(n=>({tripletStampId:String(n.tripletStampId),startTimeIndex:n.startTimeIndex,row:n.row,color:n.color,placement:n.placement})),getTripletScheduleEvents:(n,t)=>{const e=typeof n=="string"?Number(n):n;return Number.isFinite(e)?Xr(e,t??null):[]},timeToCanvas:(n,t)=>Yt(n,t),getPlacedTonicSigns:()=>Ot(l.state),getTonicSpanColumnIndices:n=>yu(n),getMacrobeatInfo:n=>Ut(l.state,n),getColumnStartX:n=>$o(n),getColumnWidth:n=>Hr(n),getCanvasWidth:()=>am(),getMacrobeatHighlightRect:n=>es(n)},eventCallbacks:{on:(n,t)=>l.on(n,t),emit:(n,t)=>l.emit(n,t),setPlaybackState:(n,t)=>l.setPlaybackState(n,t)},visualCallbacks:{clearPlayheadCanvas:()=>{const n=An();if(!n)return;const t=n.getContext("2d");if(!t)return;const e=Wt(n),o=xt(n);t.clearRect(0,0,e,o)},clearDrumPlayheadCanvas:()=>{const n=vo();if(!n)return;const t=n.getContext("2d");if(!t)return;const e=Wt(n),o=xt(n);t.clearRect(0,0,e,o)},drawPlayheadLine:(n,t)=>{const e=An();if(!e)return;const o=e.getContext("2d");o&&(o.strokeStyle="rgba(255, 0, 0, 0.8)",o.lineWidth=2,o.beginPath(),o.moveTo(n,0),o.lineTo(n,t),o.stroke())},drawPlayheadHighlight:(n,t,e,o)=>{const i=An();if(!i)return;const s=i.getContext("2d");s&&In(s,n,0,t,e,o)},drawDrumPlayheadLine:(n,t)=>{vo()&&Pe.drawPlayheadLine(n)},drawDrumPlayheadHighlight:(n,t,e,o)=>{vo()&&Pe.drawColumnHighlight(n,t,o)},updateBeatLineHighlight:(n,t,e)=>{const o=gm();o&&(e?(o.style.left=`${n}px`,o.style.width=`${t}px`,o.style.display="block"):o.style.display="none")},triggerDrumNotePop:(n,t)=>{Pe.triggerNotePop(n,t)},triggerAdsrVisual:(n,t,e,o)=>{window.adsrComponent&&window.adsrComponent.triggerPlayheadVisual(n,t,e,o)},clearAdsrVisuals:()=>{window.adsrComponent&&window.adsrComponent.clearAllPlayheadVisuals()},getPlayheadCanvasWidth:()=>{const n=An();return n?Wt(n):0},getPlayheadCanvasHeight:()=>{const n=An();return n?xt(n):0},getDrumCanvasHeight:()=>{const n=vo();return n?xt(n):0}},logger:{debug:(n,t,e)=>{b.debug(n,t,e,"transport")},info:(n,t,e)=>{b.info(n,t,e,"transport")},warn:(n,t,e)=>{b.warn(n,t,e,"transport")}}}),zt.init(),b.info("EngineTransport","Initialization complete",null,"transport")},handleStateChange(){zt&&zt.handleStateChange()},start(){zt&&zt.start()},resume(){zt&&zt.resume()},pause(){zt&&zt.pause()},stop(){zt&&zt.stop()},dispose(){zt&&(zt.dispose(),zt=null)}},vm=/(Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini)/i,Ur=900;let La=!1,Lo=Ur,xi=!1;const bm=Object.freeze({isMobile:!1,isTouch:!1,isCoarsePointer:!1,orientation:"landscape",width:0,height:0});function Ms(){return typeof window<"u"?window:null}function ym(){const n=Ms();if(!n)return{...bm};const{innerWidth:t=0,innerHeight:e=0}=n,o=n.matchMedia?n.matchMedia("(orientation: portrait)"):null,i=o?o.matches?"portrait":"landscape":e>=t?"portrait":"landscape",s=!!(n.matchMedia&&n.matchMedia("(pointer: coarse)").matches),a=!!(n.matchMedia&&n.matchMedia("(hover: none)").matches),r=typeof navigator<"u"?navigator:null,c=r?.maxTouchPoints??r?.msMaxTouchPoints??0,d="ontouchstart"in n||c>0,u=r?.userAgent?vm.test(r.userAgent):!1,h=t>0?t<=Lo:!1;return{isMobile:!!(u||d&&(s||a||h)),isTouch:d,isCoarsePointer:s,orientation:i,width:t,height:e}}function wm(n){if(typeof document>"u")return;[document.documentElement,document.body].filter(Boolean).forEach(e=>{e.classList.toggle("is-mobile",!!n.isMobile),e.classList.toggle("is-touch",!!n.isTouch),e.classList.toggle("orientation-portrait",n.orientation==="portrait"),e.classList.toggle("orientation-landscape",n.orientation==="landscape")})}function bo(){if(xi)return;const n=Ms();n&&(xi=!0,n.requestAnimationFrame(()=>{xi=!1;const t=ym();l.setDeviceProfile(t),wm(t)}))}function Sm(n,t){return n?typeof n.addEventListener=="function"?(n.addEventListener("change",t),()=>n.removeEventListener("change",t)):typeof n.addListener=="function"?(n.addListener(t),()=>n.removeListener(t)):()=>{}:()=>{}}function Cm(n={}){const t=Ms();if(!t||La)return;Lo=n.maxMobileWidth??Ur,La=!0;const e=()=>bo(),o=()=>bo();t.addEventListener("resize",e),t.addEventListener("orientationchange",o),[t.matchMedia&&t.matchMedia("(pointer: coarse)"),t.matchMedia&&t.matchMedia("(hover: none)"),t.matchMedia&&t.matchMedia(`(max-width: ${Lo}px)`),t.matchMedia&&t.matchMedia("(orientation: portrait)")].filter(Boolean).forEach(s=>{Sm(s,bo)}),bo(),b.debug("DeviceProfileService",`Initialized (breakpoint <= ${Lo}px)`,null,"ui")}const Am=()=>{const n="/music-learning-tools/";return n.endsWith("/")?n:`${n}/`},xm=`${Am()}assets/`;function Em(n=""){const t=n.replace(/^\/+/,"");return`${xm}${t}`}function ue(n){return Em(`icons/${n}`)}class Mm{tasks=[];completedTasks=0;totalTasks=0;startTime=null;loadingScreen=null;progressBar=null;progressText=null;statusText=null;initialized=!1;cache={fonts:new Map,icons:new Map,modules:new Map};diagnostics=[];createLoadingScreen(){if(this.loadingScreen)return;const t=document.getElementById("app-loading-screen");t?this.loadingScreen=t:(this.loadingScreen=document.createElement("div"),this.loadingScreen.id="app-loading-screen",this.loadingScreen.innerHTML=`
            <div class="loading-container">
                <div class="loading-logo">
                    <svg viewBox="0 0 100 100" class="logo-svg">
                        <circle cx="50" cy="50" r="45" class="logo-circle" />
                        <path d="M 30 50 Q 50 30, 70 50 T 70 70" class="logo-path" />
                    </svg>
                </div>
                <h1 class="loading-title">Student Notation</h1>
                <div class="loading-progress-container">
                    <div class="loading-progress-bar">
                        <div class="loading-progress-fill" id="loading-progress-fill"></div>
                    </div>
                    <div class="loading-progress-text" id="loading-progress-text">0%</div>
                </div>
                <div class="loading-status" id="loading-status">Initializing...</div>
            </div>
        `,document.body.appendChild(this.loadingScreen)),this.progressBar=this.loadingScreen.querySelector("#loading-progress-fill"),this.progressText=this.loadingScreen.querySelector("#loading-progress-text"),this.statusText=this.loadingScreen.querySelector("#loading-status")}registerTask(t,e=1){this.tasks.push({name:t,weight:e,completed:!1}),this.totalTasks+=e}completeTask(t){const e=this.tasks.find(o=>o.name===t&&!o.completed);e&&(e.completed=!0,this.completedTasks+=e.weight,this.updateProgress())}updateProgress(){if(!this.progressBar||!this.progressText)return;const t=this.totalTasks>0?this.completedTasks/this.totalTasks*100:0;this.progressBar.style.width=`${t}%`,this.progressText.textContent=`${Math.floor(t)}%`,t>=100&&this.completeLoading()}async nextFrame(){await new Promise(t=>{typeof requestAnimationFrame=="function"?requestAnimationFrame(()=>t()):setTimeout(t,0)})}setStatus(t){this.statusText&&(this.statusText.textContent=t)}start(){this.initialized||(this.initialized=!0,this.startTime=performance.now())}completeLoading(){this.loadingScreen&&(this.loadingScreen.classList.add("fade-out"),setTimeout(()=>{this.loadingScreen?.remove(),this.loadingScreen=null},400))}showError(t){if(this.statusText){const e=t instanceof Error?t.message:String(t);this.statusText.textContent=`Error: ${e}`,this.statusText.style.color="#ff4444"}}init(){this.createLoadingScreen(),this.start()}updateStatus(t){this.setStatus(t)}async complete(){this.completeLoading()}async preloadIcon(t){if(this.cache.icons.has(t))return this.cache.icons.get(t);const e=ue(t);return this.cache.icons.set(t,e),e}getDiagnostics(){return[...this.diagnostics]}}const it=new Mm;let Ps=!1,Ts=[],No=null;function Yr(){Ps=!0}function Pm(){Ps=!1}function jr(n){try{return JSON.parse(JSON.stringify(n,(t,e)=>e instanceof Float32Array?{__type:"Float32Array",data:Array.from(e)}:e))}catch{return null}}function ns(n,t,e="root"){const o=[];if(!n||!t)return o;if(typeof n!=typeof t)return o.push({path:e,type:"type_change",oldValue:typeof n,newValue:typeof t,timestamp:Date.now()}),o;if(typeof n!="object")return n!==t&&o.push({path:e,type:"value_change",oldValue:n,newValue:t,timestamp:Date.now()}),o;if(Array.isArray(n)){if(!Array.isArray(t))return o.push({path:e,type:"array_to_non_array",oldLength:n.length,newType:typeof t,timestamp:Date.now()}),o;n.length!==t.length&&o.push({path:e,type:"array_length_change",oldLength:n.length,newLength:t.length,timestamp:Date.now()});const s=Math.max(n.length,t.length);for(let a=0;a<s;a++){const r=ns(n[a],t[a],`${e}[${a}]`);o.push(...r)}return o}const i=new Set([...Object.keys(n),...Object.keys(t)]);for(const s of i)if(!(s in n))o.push({path:`${e}.${String(s)}`,type:"property_added",newValue:t[s],timestamp:Date.now()});else if(!(s in t))o.push({path:`${e}.${String(s)}`,type:"property_removed",oldValue:n[s],timestamp:Date.now()});else{const a=ns(n[s],t[s],`${e}.${String(s)}`);o.push(...a)}return o}function Tm(n){No=jr(n)}function Im(n,t="unknown"){if(!Ps||!No)return;const e=jr(n),o=ns(No,e);if(o.length>0){const i=o.filter(s=>!s.path.includes("tempo")&&!s.path.includes("isPlaying")&&!s.path.includes("fullRowData")&&!s.path.includes("columnWidths"));i.length>0&&Ts.push({action:t,mutations:i,timestamp:Date.now()})}No=e}function km(){return[...Ts]}function Lm(){Ts=[]}typeof window<"u"&&(window.stateGuard={enable:Yr,disable:Pm,getLog:km,clearLog:Lm});b.moduleLoaded("RhythmPlaybackService");class Nm{scheduledEvents=[];isInitialized=!1;constructor(){this.scheduledEvents=[],this.isInitialized=!1}init(){return this.initialize()}refresh(){this.stopCurrentPattern()}async initialize(){this.isInitialized||(this.isInitialized=!0,b.info("RhythmPlaybackService","Initialized"),window.rhythmPlaybackService=this)}playRhythmPattern(t,e,o,i="oval",s=null){if(!this.isInitialized){b.warn("RhythmPlaybackService","Not initialized, call initialize() first");return}this.stopCurrentPattern();const a=Gr(t,s);if(!a||a.length===0){b.warn("RhythmPlaybackService",`No events found for sixteenth stamp ${t}`);return}b.debug("RhythmPlaybackService",`Playing pattern for sixteenth stamp ${t}: ${a.length} notes`,{sixteenthStampId:t,basePitch:e,color:o,events:a,hasShapeOffsets:!!s?.shapeOffsets});const r=Pt(),c=s?.globalRow??s?.row;a.forEach((d,u)=>{try{const h=Nt(String(d.offset)).toSeconds(),f=r+h,g=Nt(String(d.duration)).toSeconds(),m=i==="circle"?g*2:g,p=f+m;let v=e;if(c!==void 0&&d.rowOffset!==0){const y=c+d.rowOffset,w=l.state.fullRowData[y];w&&(v=w.toneNote.replace("","b").replace("","#"))}wt.triggerAttack(v,o,f),wt.triggerRelease(v,o,p),this.scheduledEvents.push({pitch:v,color:o,attackTime:f,releaseTime:p})}catch(h){b.warn("RhythmPlaybackService",`Error scheduling note ${u+1}`,h)}}),b.info("RhythmPlaybackService",`Scheduled ${a.length} notes for rhythm pattern ${t}`)}stopCurrentPattern(){this.scheduledEvents.length!==0&&(b.debug("RhythmPlaybackService",`Clearing ${this.scheduledEvents.length} scheduled events`),wt.releaseAll(),this.scheduledEvents=[])}getSixteenthStampAtPosition(t,e){return l.state.sixteenthStampPlacements&&l.state.sixteenthStampPlacements.find(i=>{const s=i.row===e,a=t>=i.startColumn&&t<i.endColumn;return s&&a})||null}playTripletPattern(t,e,o,i=null){if(!this.isInitialized){b.warn("RhythmPlaybackService","Not initialized, call initialize() first");return}this.stopCurrentPattern();const s=Xr(t,i);if(!s||s.length===0){b.warn("RhythmPlaybackService",`No events found for triplet ${t}`);return}b.debug("RhythmPlaybackService",`Playing triplet pattern ${t}: ${s.length} notes`,{tripletStampId:t,basePitch:e,color:o,events:s,hasShapeOffsets:!!i?.shapeOffsets});const a=Pt(),r=i?.globalRow??i?.row;s.forEach((c,d)=>{try{const u=Nt(c.offset).toSeconds(),h=a+u,f=Nt(c.duration).toSeconds(),g=h+f;let m=e;if(r!==void 0&&c.rowOffset!==0){const p=r+c.rowOffset,v=l.state.fullRowData[p];v&&(m=v.toneNote.replace("?T-","b").replace("?T_","#"))}wt.triggerAttack(m,o,h),wt.triggerRelease(m,o,g),this.scheduledEvents.push({pitch:m,color:o,attackTime:h,releaseTime:g})}catch(u){b.warn("RhythmPlaybackService",`Error scheduling triplet note ${d+1}`,u)}}),b.info("RhythmPlaybackService",`Scheduled ${s.length} notes for triplet pattern ${t}`)}getTripletStampAtPosition(t,e){return l.state.tripletStampPlacements&&l.state.tripletStampPlacements.find(o=>o.row===e&&t>=o.startTimeIndex&&t<o.startTimeIndex+o.span*2)||null}dispose(){this.stopCurrentPattern(),this.isInitialized=!1,b.info("RhythmPlaybackService","Disposed")}}const It=new Nm,Rm={H:"https://tonejs.github.io/audio/drum-samples/CR78/hihat.mp3",M:"https://tonejs.github.io/audio/drum-samples/CR78/snare.mp3",L:"https://tonejs.github.io/audio/drum-samples/CR78/kick.mp3"};let yo=null,Na=!1;async function Bm(){if(!Na){yo=new ir(Rm);try{await yo.loaded,Na=!0}catch(n){console.warn("Drum sample preloading failed, will load on-demand:",n),yo?.dispose(),yo=null}}}const Qr=[];function At(...n){Qr.push(n)}const Kr={enableModulationTool(){l.setSelectedTool("modulation"),At("[MODULATION TEST] Modulation tool enabled. Click on the grid to place markers."),At("[MODULATION TEST] Click marker labels to toggle 2:3  3:2"),At("[MODULATION TEST] Drag marker barlines to move them")},addTestMarker(){const t=this.findNearestGridLine(200),e=this.findMeasureIndexForX(t.x),o=l.addModulationMarker(e,Kt.COMPRESSION_2_3,t.x,t.columnIndex);return At("[MODULATION TEST] Added test marker at measure",e,"columnIndex=",t.columnIndex,"x=",t.x,"(snapped from",200,")"),o},addTestMarker2(){const t=this.findNearestGridLine(400),e=this.findMeasureIndexForX(t.x),o=l.addModulationMarker(e,Kt.EXPANSION_3_2,t.x,t.columnIndex);return At("[MODULATION TEST] Added test marker 2 at measure",e,"columnIndex=",t.columnIndex,"x=",t.x,"(snapped from",400,")"),o},findNearestGridLine(n){const t=l.state;let e=0,o=0,i=1/0,s=0;for(let a=0;a<t.columnWidths.length;a++){const r=Math.abs(s-n);r<i&&(i=r,o=s,e=a);const c=t.columnWidths[a]||0;s+=c*t.cellWidth}return At("[MODULATION TEST] findNearestGridLine:",{targetX:n,closestColumnIndex:e,closestX:o,minDistance:i}),{columnIndex:e,x:o}},findMeasureIndexForX(n){const t=l.state.cellWidth||40,e=5,o=Math.round(n/t);return Math.max(1,Math.round(o/e))},clearAllMarkers(){[...l.state.modulationMarkers||[]].forEach(t=>{l.removeModulationMarker(t.id)}),At("[MODULATION TEST] Cleared all markers")},testMapping(){const n=l.state.baseMicrobeatPx||l.state.cellWidth||40;At("[MODULATION TEST] Base microbeat pixels:",n),At("[MODULATION TEST] Modulation markers:",l.state.modulationMarkers);const t=typeof window<"u"?window.getModulationMapping?.():void 0;t&&(At("[MODULATION TEST] Coordinate mapping:",t),[0,100,200,300,400,500].forEach(o=>{const i=t.canvasXToMicrobeat(o),s=t.microbeatToCanvasX(i);At(`[MODULATION TEST] x=${o}  microbeat=${i.toFixed(3)}  x=${s.toFixed(1)}`)}))},testVisualExpansion(){At("[MODULATION TEST] Testing visual grid expansion..."),this.clearAllMarkers();const n=this.addTestMarker2();At("[MODULATION TEST] Added 3:2 expansion marker:",n),typeof window<"u"&&window.LayoutService?.recalculateLayout&&(At("[MODULATION TEST] Manually triggering layout recalculation..."),window.LayoutService.recalculateLayout()),setTimeout(()=>{At("[MODULATION TEST] Grid should now show expansion after x=400"),At("[MODULATION TEST] Container should be wider to accommodate expansion"),At("[MODULATION TEST] Check console for [LAYOUT], [GETCOLX], [GRIDLINES], and [NOTES] logs")},100)},testVisualCompression(){At("[MODULATION TEST] Testing visual grid compression..."),this.clearAllMarkers();const n=this.addTestMarker();At("[MODULATION TEST] Added 2:3 compression marker:",n),typeof window<"u"&&window.LayoutService?.recalculateLayout&&(At("[MODULATION TEST] Manually triggering layout recalculation..."),window.LayoutService.recalculateLayout()),setTimeout(()=>{At("[MODULATION TEST] Grid should now show compression after x=200"),At("[MODULATION TEST] Container should adjust to accommodate compression"),At("[MODULATION TEST] Check console for [LAYOUT], [GETCOLX], [GRIDLINES], and [NOTES] logs")},100)},logState(){At("[MODULATION TEST] Current state:",{selectedTool:l.state.selectedTool,modulationMarkers:l.state.modulationMarkers,baseMicrobeatPx:l.state.baseMicrobeatPx,cellWidth:l.state.cellWidth})}};typeof window<"u"&&(window.ModulationTest=Kr,window.ModulationTestLogs=Qr);b.moduleLoaded("ToolbarComponent","toolbar");const Dm={init(){b.info("ToolbarComponent","Toolbar init called (all controls managed by Svelte)",null,"toolbar")}};var _m=bs('<img alt="Pause" class="svelte-1k8p4m2"/>'),Fm=bs('<img alt="Play" class="svelte-1k8p4m2"/>'),Wm=bs('<div class="playback-controls svelte-1k8p4m2"><button class="toolbar-button svelte-1k8p4m2"><!></button> <button class="toolbar-button svelte-1k8p4m2" title="Stop"><img alt="Stop" class="svelte-1k8p4m2"/></button> <button><img alt="Loop" class="svelte-1k8p4m2"/></button> <div class="separator svelte-1k8p4m2"></div> <button class="toolbar-button svelte-1k8p4m2" title="Clear All Notes"><img alt="Clear" class="svelte-1k8p4m2"/></button> <div class="separator svelte-1k8p4m2"></div> <button class="toolbar-button svelte-1k8p4m2" title="Undo"><img alt="Undo" class="svelte-1k8p4m2"/></button> <button class="toolbar-button svelte-1k8p4m2" title="Redo"><img alt="Redo" class="svelte-1k8p4m2"/></button></div>');function Om(n,t){ve(t,!0);let e=Tt(dn(l.state.isPlaying)),o=Tt(dn(l.state.isPaused)),i=Tt(dn(l.state.isLooping)),s=Tt(l.state.historyIndex>0),a=Tt(l.state.historyIndex<l.state.history.length-1);sc(()=>{const D=j=>{j&&(ft(e,j.isPlaying,!0),ft(o,j.isPaused,!0))},U=j=>{j!==void 0&&ft(i,j,!0)},V=()=>{ft(s,l.state.historyIndex>0),ft(a,l.state.historyIndex<l.state.history.length-1)};return l.on("playbackStateChanged",D),l.on("loopingChanged",U),l.on("historyChanged",V),V(),()=>{}});const r=li(()=>ue("play.svg")),c=li(()=>ue("pause.svg")),d=li(()=>nt(e)&&!nt(o));function u(){nt(e)&&nt(o)?(l.setPlaybackState(!0,!1),Ee.resume()):nt(e)&&!nt(o)?(l.setPlaybackState(!0,!0),Ee.pause()):(l.setPlaybackState(!0,!1),Ee.start())}function h(){l.setPlaybackState(!1,!1),Ee.stop()}function f(){l.clearAllNotes(),qr(),Vr()}function g(){l.setLooping(!nt(i))}function m(){l.undo()}function p(){l.redo()}var v=Wm(),y=$e(v);y.__click=u;var w=$e(y);{var S=D=>{var U=_m();ai(()=>ye(U,"src",nt(c))),ri(D,U)},M=D=>{var U=Fm();ai(()=>ye(U,"src",nt(r))),ri(D,U)};Hl(w,D=>{nt(d)?D(S):D(M,!1)})}var P=Cn(y,2);P.__click=h;var E=$e(P),x=Cn(P,2);let A;x.__click=g;var k=$e(x),C=Cn(x,4);C.__click=f;var N=$e(C),L=Cn(C,4);L.__click=m;var W=$e(L),H=Cn(L,2);H.__click=p;var Q=$e(H);ai((D,U,V,j,at)=>{ye(y,"title",nt(d)?"Pause":"Play"),ye(E,"src",D),A=ql(x,1,"toolbar-button svelte-1k8p4m2",null,A,{active:nt(i)}),ye(x,"title",nt(i)?"Disable Loop":"Enable Loop"),ye(k,"src",U),ye(N,"src",V),L.disabled=!nt(s),ye(W,"src",j),H.disabled=!nt(a),ye(Q,"src",at)},[()=>ue("stop.svg"),()=>ue("loop.svg"),()=>ue("clear.svg"),()=>ue("undo.svg"),()=>ue("redo.svg")]),ri(n,v),be()}ic(["click"]);function zm(n,t){ve(t,!0);let e=Tt(dn(l.state.isPlaying)),o=Tt(dn(l.state.isPaused)),i=Tt(dn(l.state.isLooping)),s=Tt(l.state.historyIndex>0),a=Tt(l.state.historyIndex<l.state.history.length-1),r=null,c=null,d=null,u=null,h=null,f=null;function g(){nt(e)&&nt(o)?(l.setPlaybackState(!0,!1),Ee.resume()):nt(e)&&!nt(o)?(l.setPlaybackState(!0,!0),Ee.pause()):(l.setPlaybackState(!0,!1),Ee.start())}function m(){l.setPlaybackState(!1,!1),Ee.stop(),c?.blur()}function p(){u?.classList.add("flash"),setTimeout(()=>u?.classList.remove("flash"),300),l.clearAllNotes(),qr(),Vr(),u?.blur()}function v(){l.setLooping(!nt(i))}function y(){l.undo(),h?.blur()}function w(){l.redo(),f?.blur()}function S(){if(!r)return;const E=`<img src="${ue("play.svg")}" alt="Play">`,x=`<img src="${ue("pause.svg")}" alt="Pause">`;r.innerHTML=nt(e)&&!nt(o)?x:E}function M(){d&&d.classList.toggle("active",nt(i))}function P(){h&&(h.disabled=!nt(s)),f&&(f.disabled=!nt(a))}Ie(()=>{r=document.getElementById("play-button"),c=document.getElementById("stop-button"),d=document.getElementById("loop-button"),u=document.getElementById("clear-button"),h=document.getElementById("undo-button"),f=document.getElementById("redo-button"),r?.addEventListener("click",g),c?.addEventListener("click",m),d?.addEventListener("click",v),u?.addEventListener("click",p),h?.addEventListener("click",y),f?.addEventListener("click",w);const E=k=>{k&&(ft(e,k.isPlaying,!0),ft(o,k.isPaused,!0),S())},x=k=>{k!==void 0&&(ft(i,k,!0),M())},A=()=>{ft(s,l.state.historyIndex>0),ft(a,l.state.historyIndex<l.state.history.length-1),P()};l.on("playbackStateChanged",E),l.on("loopingChanged",x),l.on("historyChanged",A),S(),M(),P(),console.log("[Svelte] PlaybackControlsBridge mounted")}),ke(()=>{r?.removeEventListener("click",g),c?.removeEventListener("click",m),d?.removeEventListener("click",v),u?.removeEventListener("click",p),h?.removeEventListener("click",y),f?.removeEventListener("click",w),console.log("[Svelte] PlaybackControlsBridge unmounted")}),be()}function $m(n,t){ve(t,!1);let e=null,o=null,i=null,s=null;function a(){const m=new Date,p=m.toLocaleDateString("en-US",{month:"long"}),v=m.getDate();return`SN-score-${p}${v}.csv`}async function r(m){try{const p={suggestedName:a(),types:[{description:"Student Notation CSV File",accept:{"text/csv":[".csv"]}}]},y=await(await window.showSaveFilePicker(p)).createWritable();await y.write(m),await y.close()}catch(p){p.name!=="AbortError"&&b.error("FileActionsBridge","Error saving file with picker",p,"toolbar")}}function c(m){const p=document.createElement("a"),v=URL.createObjectURL(m);p.setAttribute("href",v),p.setAttribute("download",a()),document.body.appendChild(p),p.click(),document.body.removeChild(p),URL.revokeObjectURL(v)}function d(){return l.state.placedNotes.map(m=>[m.row,m.startColumnIndex,m.endColumnIndex,m.color,m.shape,m.tonicNumber||"",m.isDrum,m.drumTrack||""].join(",")).join(`
`)}async function u(){const m=d(),p=new Blob([m],{type:"text/csv;charset=utf-8;"});window.showSaveFilePicker?await r(p):c(p)}function h(){const m=document.createElement("input");m.type="file",m.accept=".csv,.txt",m.onchange=p=>{const y=p.target.files?.[0];if(!y)return;const w=new FileReader;w.onload=S=>{const M=S.target?.result;if(!M){b.warn("FileActionsBridge","Imported file was empty",null,"toolbar");return}const P=new Set(["circle","oval","diamond"]),E=[];if(M.split(`
`).map(x=>x.trim()).filter(x=>x.length>0).forEach(x=>{const A=x.split(",");if(A.length<7){b.warn("FileActionsBridge","Skipping invalid note row",{line:x},"toolbar");return}const k=Number.parseInt(A[0]??"",10),C=Number.parseInt(A[1]??"",10),N=Number.parseInt(A[2]??"",10),L=(A[3]??"").trim(),W=(A[4]??"").trim().toLowerCase(),H=A[5]?Number.parseInt(A[5],10):null,Q=(A[6]??"").trim().toLowerCase()==="true",D=A[7]?Number.parseInt(A[7],10):null,U=typeof D=="number"&&Number.isFinite(D)?D:void 0;if(!L){b.warn("FileActionsBridge","Skipping note with missing color",{line:x},"toolbar");return}if(!Number.isFinite(k)||!Number.isFinite(C)||!Number.isFinite(N)){b.warn("FileActionsBridge","Skipping note with invalid coordinates",{line:x},"toolbar");return}const V=P.has(W)?W:"circle";P.has(W)||b.warn("FileActionsBridge",`Unknown shape "${W}", defaulting to circle`,null,"toolbar"),E.push({row:k,startColumnIndex:C,endColumnIndex:N,color:L,shape:V,tonicNumber:H,isDrum:Q,drumTrack:U})}),E.length===0){b.warn("FileActionsBridge","No valid notes found in imported file",null,"toolbar");return}l.loadNotes(E)},w.readAsText(y)},m.click()}function f(){document.body.classList.remove("sidebar-open"),l.emit("printPreviewStateChanged",!0)}function g(){window.confirm("Are you sure you want to reset the canvas? This will clear all your work and cannot be undone.")&&l.clearSavedState()}Ie(()=>{e=document.getElementById("save-as-button"),o=document.getElementById("import-button"),i=document.getElementById("print-button"),s=document.getElementById("reset-canvas-button"),e?.addEventListener("click",()=>{u()}),o?.addEventListener("click",h),i?.addEventListener("click",f),s?.addEventListener("click",g),console.log("[Svelte] FileActionsBridge mounted")}),ke(()=>{e?.removeEventListener("click",()=>{u()}),o?.removeEventListener("click",h),i?.removeEventListener("click",f),s?.removeEventListener("click",g),console.log("[Svelte] FileActionsBridge unmounted")}),vs(),be()}function Hm(n,t){ve(t,!1);let e=null,o=null,i=null,s=null;function a(){const h=document.querySelector('.tab-button[data-tab="pitch"]'),f=document.querySelector('.pitch-tab-button[data-pitch-tab="range"]');h?.click(),f?.click()}function r(){a(),l.emit("zoomIn",{source:"button"}),e?.blur()}function c(){a(),l.emit("zoomOut",{source:"button"}),o?.blur()}function d(){l.increaseMacrobeatCount()}function u(){l.decreaseMacrobeatCount()}Ie(()=>{e=document.getElementById("grid-zoom-in"),o=document.getElementById("grid-zoom-out"),i=document.getElementById("macrobeat-increase"),s=document.getElementById("macrobeat-decrease"),e?.addEventListener("click",r),o?.addEventListener("click",c),i?.addEventListener("click",d),s?.addEventListener("click",u),console.log("[Svelte] GridControlsBridge mounted")}),ke(()=>{e?.removeEventListener("click",r),o?.removeEventListener("click",c),i?.removeEventListener("click",d),s?.removeEventListener("click",u),console.log("[Svelte] GridControlsBridge unmounted")}),vs(),be()}function qm(n,t){ve(t,!0);let e=null,o=null,i=null,s=Tt(null);function a(){nt(s)===Kt.COMPRESSION_2_3?(ft(s,null),e?.classList.remove("active"),l.setSelectedTool("note"),b.info("ModulationBridge","2:3 modulation tool deactivated",null,"ui")):(ft(s,Kt.COMPRESSION_2_3,!0),e?.classList.add("active"),o?.classList.remove("active"),l.setSelectedTool("modulation"),l.state.selectedModulationRatio=nt(s),b.info("ModulationBridge","2:3 modulation tool activated",null,"ui"))}function r(){nt(s)===Kt.EXPANSION_3_2?(ft(s,null),o?.classList.remove("active"),l.setSelectedTool("note"),b.info("ModulationBridge","3:2 modulation tool deactivated",null,"ui")):(ft(s,Kt.EXPANSION_3_2,!0),o?.classList.add("active"),e?.classList.remove("active"),l.setSelectedTool("modulation"),l.state.selectedModulationRatio=nt(s),b.info("ModulationBridge","3:2 modulation tool activated",null,"ui"))}function c(){const f=(l.state.modulationMarkers||[]).length;if(f===0){b.info("ModulationBridge","No modulation markers to clear",null,"ui");return}l.clearModulationMarkers(),b.info("ModulationBridge",`Cleared ${f} modulation markers`,null,"ui")}function d(){if(!i)return;const f=(l.state.modulationMarkers||[]).length;f===0?(i.disabled=!0,i.style.opacity="0.5"):(i.disabled=!1,i.style.opacity="1"),i.textContent=f>0?`Clear (${f})`:"Clear"}function u(f){const g=f;(typeof g=="string"?g:g.newTool||g)!=="modulation"&&(ft(s,null),e?.classList.remove("active"),o?.classList.remove("active"))}function h(){d()}Ie(()=>{if(e=document.getElementById("modulation-2-3-btn"),o=document.getElementById("modulation-3-2-btn"),i=document.getElementById("modulation-clear-btn"),!e||!o||!i){b.warn("ModulationBridge","Modulation control buttons not found in DOM",null,"ui");return}e.addEventListener("click",a),o.addEventListener("click",r),i.addEventListener("click",c),l.on("toolChanged",u),l.on("modulationMarkersChanged",h),d(),b.info("ModulationBridge","Modulation controls initialized",null,"ui"),console.log("[Svelte] ModulationBridge mounted")}),ke(()=>{e?.removeEventListener("click",a),o?.removeEventListener("click",r),i?.removeEventListener("click",c),console.log("[Svelte] ModulationBridge unmounted")}),be()}function Gm(n,t){const e=n.endMicrobeatCol<t.startMicrobeatCol,o=t.endMicrobeatCol<n.startMicrobeatCol;return!e&&!o}function Vm(n,t){const e=Math.max(n.startMicrobeatCol,t.startMicrobeatCol),o=Math.min(n.endMicrobeatCol,t.endMicrobeatCol);if(e>o)return[];const i=[];for(let s=e;s<=o;s++)i.push(s);return i}function Xm(n){const t=[],e=n.notes;for(let o=0;o<e.length;o++)for(let i=o+1;i<e.length;i++){const s=e[o],a=e[i];if(Gm(s,a)){const r=Vm(s,a);t.push({voiceId:n.voiceId,color:n.color,conflictColumns:r,note1:{startMicrobeatCol:s.startMicrobeatCol,endMicrobeatCol:s.endMicrobeatCol,midiPitch:s.midiPitch},note2:{startMicrobeatCol:a.startMicrobeatCol,endMicrobeatCol:a.endMicrobeatCol,midiPitch:a.midiPitch}})}}return t}function Um(n){const t=`Note 1: cols ${n.note1.startMicrobeatCol}-${n.note1.endMicrobeatCol}, MIDI ${n.note1.midiPitch}`,e=`Note 2: cols ${n.note2.startMicrobeatCol}-${n.note2.endMicrobeatCol}, MIDI ${n.note2.midiPitch}`,o=n.conflictColumns.length===1?`column ${n.conflictColumns[0]}`:`columns ${n.conflictColumns[0]}-${n.conflictColumns[n.conflictColumns.length-1]}`;return`Voice "${n.voiceId}" (${n.color}): Overlap at ${o}
  ${t}
  ${e}`}function Ym(n){const t=[],e=[];if(n.schemaVersion!==1&&e.push(`Unsupported schema version: ${n.schemaVersion}. Expected: 1`),n.timeGrid||e.push("Missing required field: timeGrid"),(!n.voices||!Array.isArray(n.voices))&&e.push("Missing or invalid field: voices"),n.clefPitchRange){const{minMidi:o,maxMidi:i}=n.clefPitchRange;!Number.isFinite(o)||!Number.isFinite(i)?e.push("Invalid clefPitchRange: MIDI values must be finite numbers"):o>i&&e.push("Invalid clefPitchRange: minMidi exceeds maxMidi")}if(n.voices)for(const o of n.voices){const i=Xm(o);t.push(...i)}for(const o of t)e.push(Um(o));return{isValid:t.length===0&&e.length===0,conflicts:t,errorMessages:e}}function jm(n){const t=Ym(n);if(t.isValid)return{isValid:!0,summary:"Validation passed. Ready to export to Singing Trainer.",details:t};const e=new Set(t.conflicts.map(i=>i.voiceId));return{isValid:!1,summary:`Cannot export: ${t.conflicts.length} overlap(s) found in ${e.size} voice(s).`,details:t}}function Qm(n){return n.reduce((t,e)=>t+e,0)}function Km(n){if(n.length===0)return 2;const t=n.filter(o=>o===2).length;return n.filter(o=>o===3).length>t?3:2}function Zm(n,t,e){const o=e.topIndex+n;return o<0||o>=t.length?-1:t[o]?.midi??-1}function Jm(n,t,e){const o=e.topIndex+n;return o<0||o>=t.length?"Unknown":t[o]?.toneNote??"Unknown"}function tf(n,t){const e=n[t.topIndex],o=n[t.bottomIndex],i=e?.midi,s=o?.midi;return typeof i!="number"||typeof s!="number"?null:{minMidi:Math.min(i,s),maxMidi:Math.max(i,s)}}function ef(n,t,e={}){const o=n.placedNotes.filter(f=>!f.isDrum),i=new Map;for(const f of o){const g=f.color;i.has(g)||i.set(g,[]),i.get(g).push(f)}const s=[];let a=1/0,r=-1/0;for(const[f,g]of i){const m=[];for(const p of g){const v=Zm(p.row,n.fullRowData,n.pitchRange),y=Jm(p.row,n.fullRowData,n.pitchRange);v>0&&(a=Math.min(a,v),r=Math.max(r,v)),m.push({startMicrobeatCol:p.startColumnIndex,endMicrobeatCol:p.endColumnIndex,midiPitch:v,pitchName:y,shape:p.shape})}m.sort((p,v)=>p.startMicrobeatCol-v.startMicrobeatCol),s.push({voiceId:f,color:f,notes:m})}const c={microbeatCount:Qm(n.macrobeatGroupings),microbeatsPerMacrobeat:Km(n.macrobeatGroupings),macrobeatGroupings:[...n.macrobeatGroupings],macrobeatBoundaryStyles:[...n.macrobeatBoundaryStyles]},d=[];if(n.annotations&&Array.isArray(n.annotations))for(const f of n.annotations)d.push({type:"freehand",id:f.id??`overlay-${Date.now()}`,data:f,coordinateSystem:"pixel"});const u=e.includeClefPitchRange===!1?null:tf(n.fullRowData,n.pitchRange),h={schemaVersion:Gl,createdAt:Date.now(),sourceFileId:t,sourceApp:"student-notation",timeGrid:c,voices:s,tempo:n.tempo,minMidiPitch:a===1/0?void 0:a,maxMidiPitch:r===-1/0?void 0:r};return u&&(h.clefPitchRange=u),e.preferredPitchRangeSource&&(h.preferredPitchRangeSource=e.preferredPitchRangeSource),d.length>0&&(h.visualOverlays=d),e.tonalCenter&&(h.tonalCenter=e.tonalCenter),h}function nf(n,t){ve(t,!0);let e=null,o=null,i=null,s=null,a=null,r=null,c=null,d=null,u=null,h=null,f=null,g=null,m=null,p=null,v=null,y=null,w=null,S=null,M=null,P=null,E=null,x=null,A=Tt(!0),k=Tt(!0),C=Tt(!0),N=Tt(!0);const L="app.volumeSliderValue";function W(B){return Math.min(100,Math.max(0,B))}function H(){try{const B=window.localStorage.getItem(L);if(B!==null){const J=Number(B);if(!Number.isNaN(J))return W(J)}}catch{}return 70}function Q(B){try{window.localStorage.setItem(L,String(W(B)))}catch{}}function D(){document.body.classList.toggle("sidebar-open")}function U(B){if(B.stopPropagation(),!a||!s)return;const J=a.classList.toggle("visible");s.classList.toggle("active",J)}function V(){const B=parseInt(this.value,10),J=B===0?-1/0:B/100*37.5-50;l.emit("volumeChanged",J),Q(B)}function j(B){!a||!s||!a.contains(B.target)&&B.target!==s&&(a.classList.remove("visible"),s.classList.remove("active"))}function at(){l.setAnacrusis(!0)}function mt(){l.setAnacrusis(!1)}function vt(B){const J=B;c?.classList.toggle("active",J),d?.classList.toggle("active",!J)}function dt(){l.setLongNoteStyle("style1")}function T(){l.setLongNoteStyle("style2")}function _(B){const J=B;u?.classList.toggle("active",J==="style1"),h?.classList.toggle("active",J==="style2")}function G(){l.setPlayheadMode("cursor")}function X(){l.setPlayheadMode("microbeat")}function z(){l.setPlayheadMode("macrobeat")}function rt(B){const J=B==="macrobeat"?"macrobeat":B==="microbeat"?"microbeat":"cursor";f?.classList.toggle("active",J==="cursor"),g?.classList.toggle("active",J==="microbeat"),m?.classList.toggle("active",J==="macrobeat")}function R(){ft(A,!nt(A)),v&&(v.style.display=nt(A)?"flex":"none");const B=p?.querySelector(".sidebar-button-text");B&&(B.textContent=nt(A)?"Hide Drum Grid":"Show Drum Grid"),setTimeout(()=>Vt.recalculateLayout(),10)}function F(){ft(k,!nt(k)),w&&(w.style.display=nt(k)?"flex":"none");const B=y?.querySelector(".sidebar-button-text");B&&(B.textContent=nt(k)?"Hide Button Grid":"Show Button Grid"),setTimeout(()=>Vt.recalculateLayout(),10)}function I(){ft(C,!nt(C)),M&&(M.style.display=nt(C)?"block":"none"),S&&(S.textContent=nt(C)?"Hide Left Legend":"Show Left Legend"),setTimeout(()=>Vt.recalculateLayout(),10)}function $(){ft(N,!nt(N)),E&&(E.style.display=nt(N)?"block":"none"),P&&(P.textContent=nt(N)?"Hide Right Legend":"Show Right Legend"),setTimeout(()=>Vt.recalculateLayout(),10)}function O(B,J,ot=[]){const tt=document.getElementById("notification-overlay"),ut=tt?.querySelector(".notification-message"),pt=tt?.querySelector(".notification-title");if(!tt||!ut){alert(`${B}

${J}${ot.length>0?`

`+ot.join(`
`):""}`);return}pt&&(pt.textContent=B);const bt=ot.length>0?`<ul style="text-align: left; margin-top: 8px; padding-left: 20px;">${ot.map(ht=>`<li style="margin-bottom: 4px;">${ht.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</li>`).join("")}</ul>`:"";ut.innerHTML=`<p>${J.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</p>${bt}`,tt.classList.add("visible");const gt=tt.querySelector(".notification-close"),K=tt.querySelector(".notification-button"),st=()=>{tt.classList.remove("visible"),gt?.removeEventListener("click",st),K?.removeEventListener("click",st)};gt?.addEventListener("click",st),K?.addEventListener("click",st)}function q(){return l.state.placedNotes.some(B=>!B.isDrum)}async function Z(){if(console.log("[Svelte] Take to Singing Trainer clicked"),!q()){O("Cannot Export","No notes to export. Add some pitch notes to the grid before exporting to Singing Trainer.");return}const B={placedNotes:l.state.placedNotes,macrobeatGroupings:l.state.macrobeatGroupings,macrobeatBoundaryStyles:l.state.macrobeatBoundaryStyles,fullRowData:l.state.fullRowData,pitchRange:l.state.pitchRange,tempo:l.state.tempo,annotations:l.state.annotations},J=ef(B),ot=jm(J);if(!ot.isValid){console.warn("[Svelte] Handoff validation failed",ot.details);const tt=[];for(const ut of ot.details.conflicts){const pt=ut.conflictColumns.length===1?`column ${ut.conflictColumns[0]}`:`columns ${ut.conflictColumns[0]}-${ut.conflictColumns[ut.conflictColumns.length-1]}`;tt.push(`Voice "${ut.color}": Overlap at ${pt}`)}O("Cannot Export to Singing Trainer",ot.summary,tt);return}try{const tt=await Vl(J);console.log("[Svelte] Handoff slot written",tt),Xl(tt)}catch(tt){console.error("[Svelte] Failed to write handoff slot",tt),O("Export Failed","An error occurred while preparing the handoff. Please try again.")}}Ie(()=>{if(e=document.getElementById("settings-button"),o=document.getElementById("sidebar"),i=document.getElementById("sidebar-overlay"),s=document.getElementById("volume-icon-button"),a=document.getElementById("volume-popup"),r=document.getElementById("vertical-volume-slider"),c=document.getElementById("anacrusis-on-btn"),d=document.getElementById("anacrusis-off-btn"),u=document.getElementById("long-note-style1-btn"),h=document.getElementById("long-note-style2-btn"),f=document.getElementById("playhead-mode-cursor-btn"),g=document.getElementById("playhead-mode-microbeat-btn"),m=document.getElementById("playhead-mode-macrobeat-btn"),p=document.getElementById("hide-drumgrid-toggle"),v=document.getElementById("drum-grid-wrapper"),y=document.getElementById("hide-buttongrid-toggle"),w=document.getElementById("button-grid"),S=document.getElementById("hide-leftlegend-toggle"),M=document.getElementById("legend-left-canvas"),P=document.getElementById("hide-rightlegend-toggle"),E=document.getElementById("legend-right-canvas"),x=document.getElementById("take-to-singing-trainer-button"),e&&o&&i&&(e.addEventListener("click",D),i.addEventListener("click",D)),s&&a&&r){const B=H();r.value=String(B),s.addEventListener("click",U),r.addEventListener("input",V),document.addEventListener("click",j),r.dispatchEvent(new Event("input"))}if(c&&d&&(c.addEventListener("click",at),d.addEventListener("click",mt),l.on("anacrusisChanged",vt),c.classList.toggle("active",l.state.hasAnacrusis),d.classList.toggle("active",!l.state.hasAnacrusis)),u&&h){u.addEventListener("click",dt),h.addEventListener("click",T),l.on("longNoteStyleChanged",_);const B=l.state.longNoteStyle||"style1";u.classList.toggle("active",B==="style1"),h.classList.toggle("active",B==="style2")}if(f&&g&&m){f.addEventListener("click",G),g.addEventListener("click",X),m.addEventListener("click",z),l.on("playheadModeChanged",rt);const B=l.state.playheadMode||"cursor";f.classList.toggle("active",B==="cursor"),g.classList.toggle("active",B==="microbeat"),m.classList.toggle("active",B==="macrobeat")}p&&v&&p.addEventListener("click",R),y&&w&&y.addEventListener("click",F),S&&M&&S.addEventListener("click",I),P&&E&&P.addEventListener("click",$),x&&x.addEventListener("click",()=>{Z()}),console.log("[Svelte] SidebarBridge mounted")}),ke(()=>{e?.removeEventListener("click",D),i?.removeEventListener("click",D),s?.removeEventListener("click",U),r?.removeEventListener("input",V),document.removeEventListener("click",j),c?.removeEventListener("click",at),d?.removeEventListener("click",mt),u?.removeEventListener("click",dt),h?.removeEventListener("click",T),f?.removeEventListener("click",G),g?.removeEventListener("click",X),m?.removeEventListener("click",z),p?.removeEventListener("click",R),y?.removeEventListener("click",F),S?.removeEventListener("click",I),P?.removeEventListener("click",$),console.log("[Svelte] SidebarBridge unmounted")}),be()}const Jo={selectedSixteenthStampId:1,updateSixteenthStampColors:n=>{},init(){this.render(),this.bindEvents(),b.info("SixteenthStampsToolbar","Sixteenth stamps toolbar initialized",null,"stamps")},render(){const n=document.getElementById("sixteenth-stamps-toolbar-container");if(!n){b.warn("SixteenthStampsToolbar","Container not found",null,"stamps");return}n.innerHTML="";const t=document.createElement("div");t.className="sixteenth-stamps-grid",[[1,2,3,4],[5,8,14,6,9,7],[10,13,12,11,15]].forEach((o,i)=>{const s=document.createElement("div");s.className=`sixteenth-stamps-row sixteenth-stamps-row-${i+1}`,o.forEach(a=>{const r=Ui.find(c=>c.id===a);if(r){const c=this.createSixteenthStampButton(r);s.appendChild(c)}}),t.appendChild(s)}),n.appendChild(t),this.setInitialSelection(this.selectedSixteenthStampId)},createSixteenthStampButton(n){const t=document.createElement("button");t.className="sixteenth-stamp-button",t.dataset.sixteenthStampId=`${n.id}`,t.setAttribute("title",`${n.id}: ${n.label}`);const e=this.createSixteenthStampPreview(n);return t.appendChild(e),t},createSixteenthStampPreview(n){const t=As.renderToSVG(n,100,100);return t.setAttribute("width","40"),t.setAttribute("height","40"),t},bindEvents(){const n=document.getElementById("sixteenth-stamps-toolbar-container");if(!n)return;n.addEventListener("click",e=>{const o=e.target?.closest(".sixteenth-stamp-button");if(o){const i=parseInt(o.dataset.sixteenthStampId||"",10);Number.isNaN(i)||this.selectSixteenthStamp(i)}}),this.updateSixteenthStampColors=e=>{if(!e||!n)return;const o=(d,u=50)=>{const h=parseInt(d.slice(1,3),16),f=parseInt(d.slice(3,5),16),g=parseInt(d.slice(5,7),16),m=Math.min(255,Math.floor(h+(255-h)*(u/100))),p=Math.min(255,Math.floor(f+(255-f)*(u/100))),v=Math.min(255,Math.floor(g+(255-g)*(u/100)));return`#${m.toString(16).padStart(2,"0")}${p.toString(16).padStart(2,"0")}${v.toString(16).padStart(2,"0")}`},i=(d,u=20)=>{const h=parseInt(d.slice(1,3),16),f=parseInt(d.slice(3,5),16),g=parseInt(d.slice(5,7),16),m=Math.max(0,Math.floor(h*(1-u/100))),p=Math.max(0,Math.floor(f*(1-u/100))),v=Math.max(0,Math.floor(g*(1-u/100)));return`#${m.toString(16).padStart(2,"0")}${p.toString(16).padStart(2,"0")}${v.toString(16).padStart(2,"0")}`},s=l.state.colorPalette[e]||{primary:e,light:e},a=o(s.light,60),r=s.primary,c=i(r,20);n.style.setProperty("--c-accent",r),n.style.setProperty("--c-accent-light",a),n.style.setProperty("--c-accent-hover",c)},l.on("noteChanged",({newNote:e}={})=>{e?.color&&this.updateSixteenthStampColors(e.color)});const t=l.state.selectedNote;t?.color&&this.updateSixteenthStampColors(t.color),l.on("toolChanged",({newTool:e}={})=>{e&&e!=="sixteenthStamp"&&this.clearSelection()}),l.on("tripletStampToolSelected",()=>{this.clearSelection()})},setInitialSelection(n){this.selectedSixteenthStampId=n;const t=document.getElementById("sixteenth-stamps-toolbar-container");t&&t.querySelectorAll(".sixteenth-stamp-button").forEach(e=>{const o=e;o.classList.toggle("active",parseInt(o.dataset.sixteenthStampId||"",10)===n)})},selectSixteenthStamp(n){this.selectedSixteenthStampId=n;const t=document.getElementById("sixteenth-stamps-toolbar-container");t&&t.querySelectorAll(".sixteenth-stamp-button").forEach(e=>{const o=e;o.classList.toggle("active",parseInt(o.dataset.sixteenthStampId||"",10)===n)}),l.setSelectedTool("sixteenthStamp"),l.emit("sixteenthStampSelected",n),l.emit("sixteenthStampToolSelected")},clearSelection(){const n=document.getElementById("sixteenth-stamps-toolbar-container");n&&n.querySelectorAll(".sixteenth-stamp-button").forEach(t=>{t.classList.remove("active")})},getSelectedSixteenthStamp(){return Ui.find(t=>t.id===this.selectedSixteenthStampId)}};class of{overlay;modal;title;message;actionsContainer;closeButton;constructor(){this.overlay=document.getElementById("notification-overlay"),this.modal=this.overlay?.querySelector(".notification-modal"),this.title=this.overlay?.querySelector(".notification-title"),this.message=this.overlay?.querySelector(".notification-message"),this.actionsContainer=this.overlay?.querySelector(".notification-actions"),this.closeButton=this.overlay?.querySelector(".notification-close"),this.setupEventListeners()}setupEventListeners(){this.overlay&&(this.closeButton?.addEventListener("click",()=>this.hide()),this.overlay.addEventListener("click",t=>{t.target===this.overlay&&this.hide()}),document.addEventListener("keydown",t=>{t.key==="Escape"&&this.overlay?.classList.contains("visible")&&this.hide()}))}show(t={}){const e=this.overlay;if(!e)return;const{title:o="Notice",message:i="",buttons:s=[{text:"OK",primary:!0,action:()=>this.hide()}]}=t;this.title&&(this.title.textContent=o),this.message&&(this.message.textContent=i);const a=this.actionsContainer;a&&(a.innerHTML="",s.forEach(r=>{const c=document.createElement("button");c.className=`notification-button ${r.primary?"":"secondary"}`,c.textContent=r.text,c.addEventListener("click",()=>{r.action?r.action():this.hide()}),a.appendChild(c)})),e.classList.add("visible"),setTimeout(()=>{this.actionsContainer?.querySelector(".notification-button")?.focus()},100)}hide(){this.overlay&&this.overlay.classList.remove("visible")}alert(t,e="Notice"){this.show({title:e,message:t,buttons:[{text:"OK",primary:!0,action:()=>this.hide()}]})}confirm(t,e="Confirm"){return new Promise(o=>{this.show({title:e,message:t,buttons:[{text:"Cancel",primary:!1,action:()=>{this.hide(),o(!1)}},{text:"OK",primary:!0,action:()=>{this.hide(),o(!0)}}]})})}}const Ra=new of,os=40,sf=os;class Ba{element;viewportEl;optionsEl;onChange;onBeforeChange;options;optionNodes=[];selectedIndex=0;pointerActive=!1;pointerId=null;lastPointerY=0;deltaBuffer=0;optionHeight=os;resizeObserver=null;constructor(t,e,o,i,s){this.element=t,this.viewportEl=t?.querySelector(".clef-wheel-viewport"),this.optionsEl=t?.querySelector(".clef-wheel-options"),this.onChange=i,this.onBeforeChange=s||null,this.options=e,!(!t||!this.viewportEl||!this.optionsEl)&&(this.renderOptions(),this.setIndex(o,{silent:!0}),this.attachEvents(),this.observeSize())}renderOptions(){const t=this.optionsEl;t&&(t.innerHTML="",this.optionNodes=this.options.map((e,o)=>{const i=document.createElement("div");return i.className="clef-wheel-option",i.dataset.index=o.toString(),i.textContent=e.label,t.appendChild(i),i}))}attachEvents(){if(!this.element)return;this.element.addEventListener("wheel",e=>{e.preventDefault(),e.stopPropagation();const o=Math.sign(e.deltaY);o!==0&&this.increment(o)},{passive:!1}),this.element.addEventListener("keydown",e=>{e.key==="ArrowUp"?(e.preventDefault(),this.increment(-1)):e.key==="ArrowDown"?(e.preventDefault(),this.increment(1)):e.key==="Home"?(e.preventDefault(),this.setIndex(0)):e.key==="End"&&(e.preventDefault(),this.setIndex(this.options.length-1))}),this.element.addEventListener("pointerdown",e=>{if(this.pointerActive=!0,this.pointerId=e.pointerId,this.lastPointerY=e.clientY,this.deltaBuffer=0,typeof this.element?.setPointerCapture=="function")try{this.element.setPointerCapture(this.pointerId)}catch{}}),this.element.addEventListener("pointermove",e=>{if(!this.pointerActive||e.pointerId!==this.pointerId)return;const o=e.clientY-this.lastPointerY;if(this.lastPointerY=e.clientY,o===0)return;this.deltaBuffer+=o;const i=this.optionHeight||sf;for(;Math.abs(this.deltaBuffer)>=i;){const s=-Math.sign(this.deltaBuffer);this.increment(s),this.deltaBuffer-=Math.sign(this.deltaBuffer)*i}});const t=e=>{this.pointerActive&&e.pointerId===this.pointerId&&(this.pointerActive=!1,this.pointerId=null,this.deltaBuffer=0,this.element?.hasPointerCapture?.(e.pointerId)&&this.element.releasePointerCapture(e.pointerId))};this.element.addEventListener("pointerup",t),this.element.addEventListener("pointercancel",t),this.element.addEventListener("pointerleave",t)}observeSize(){this.element&&(typeof ResizeObserver=="function"?(this.resizeObserver=new ResizeObserver(t=>{for(const e of t)e.target===this.element&&e.contentRect.height>0&&this.updateVisuals()}),this.resizeObserver.observe(this.element)):window.addEventListener("resize",()=>this.updateVisuals()))}getIndex(){return this.selectedIndex}increment(t){t===0||!this.options||this.options.length===0||this.setIndex(this.selectedIndex+t)}setIndex(t,{silent:e=!1}={}){if(!this.optionsEl)return;let o=t;!e&&typeof this.onBeforeChange=="function"&&(o=this.onBeforeChange(t));const i=Math.max(0,Math.min(this.options.length-1,o));if(i===this.selectedIndex){this.updateVisuals();return}if(this.selectedIndex=i,this.updateVisuals(),!e&&typeof this.onChange=="function"){const s=this.options[i];s&&this.onChange(i,s)}}updateVisuals(){if(!this.optionsEl||!this.viewportEl)return;const t=this.viewportEl.clientHeight||0,e=this.optionNodes?.[this.selectedIndex],o=this.optionNodes?.[0],i=e?.offsetHeight||o?.offsetHeight||os;if(this.optionHeight=i,this.optionNodes?.forEach((c,d)=>{const u=Math.abs(d-this.selectedIndex);c.dataset.distance=String(Math.min(u,3))}),t===0||i===0)return;const s=Math.max(0,(t-i)/2);this.optionsEl.style.paddingTop=`${s}px`,this.optionsEl.style.paddingBottom=`${s}px`;const a=e?e.offsetTop+i/2:s+i/2,r=t/2-a;this.optionsEl.style.transform=`translateY(${r}px)`}}class af{initialized=!1;topPicker=null;bottomPicker=null;topWheel=null;bottomWheel=null;rangeLabel=null;rangeCount=null;fullRangeButton=null;trebleButton=null;altoButton=null;bassButton=null;presetContainer=null;presetButtons=[];activePresetId=null;masterOptions=[];presetRanges={};init(){if(this.initialized)return;if(this.topWheel=document.getElementById("clef-top-wheel"),this.bottomWheel=document.getElementById("clef-bottom-wheel"),this.rangeLabel=document.getElementById("clef-range-label"),this.rangeCount=document.getElementById("clef-range-count"),this.fullRangeButton=document.getElementById("clef-full-range-button"),this.trebleButton=document.getElementById("clef-treble-button"),this.altoButton=document.getElementById("clef-alto-button"),this.bassButton=document.getElementById("clef-bass-button"),this.presetContainer=document.querySelector(".clef-preset-buttons"),this.presetButtons=Array.from(document.querySelectorAll(".clef-preset-button")),!this.topWheel||!this.bottomWheel){b.warn("ClefViewportController","Clef tab elements not found; skipping initialization",null,"ui");return}this.masterOptions=Ae.map((e,o)=>({index:o,label:e.pitch,toneNote:e.toneNote,frequency:e.frequency}));const t=this.getViewportRange();this.topPicker=new Ba(this.topWheel,this.masterOptions,t.topIndex,e=>this.handleTopSelection(e),e=>this.constrainTopIndex(e)),this.bottomPicker=new Ba(this.bottomWheel,this.masterOptions,t.bottomIndex,e=>this.handleBottomSelection(e),e=>this.constrainBottomIndex(e)),this.computePresetRanges(),this.fullRangeButton&&this.fullRangeButton.addEventListener("click",()=>this.applyPresetView("full")),this.trebleButton&&this.trebleButton.addEventListener("click",()=>this.applyPresetView("treble")),this.altoButton&&this.altoButton.addEventListener("click",()=>this.applyPresetView("alto")),this.bassButton&&this.bassButton.addEventListener("click",()=>this.applyPresetView("bass")),l.on("pitchRangeChanged",()=>{this.syncFromViewport()}),l.on("zoomChanged",()=>{this.syncFromViewport()}),this.calculateAndSetWheelHeight(),window.addEventListener("resize",()=>this.calculateAndSetWheelHeight()),this.syncFromViewport(),this.initialized=!0,b.moduleLoaded("ClefViewportController","ui")}refreshWheelVisuals(){this.topPicker?.updateVisuals(),this.bottomPicker?.updateVisuals()}getViewportRange(){const t=Math.max(0,this.masterOptions.length-1),e=$t.getViewportInfo(),o=e?.startRank??l.state.pitchRange?.topIndex??0,i=e?.endRank??o+1,s=Math.max(0,Math.min(t,o)),a=Math.max(s,Math.min(t,i-1));return{topIndex:s,bottomIndex:a}}syncFromViewport(){if(!this.topPicker||!this.bottomPicker)return;const{topIndex:t,bottomIndex:e}=this.getViewportRange();this.topPicker.setIndex(t,{silent:!0}),this.bottomPicker.setIndex(e,{silent:!0}),this.updateSummary(t,e),this.updatePresetHighlight(t,e)}constrainTopIndex=t=>{if(!this.bottomPicker)return t;const e=this.bottomPicker.getIndex(),o=this.masterOptions.length;return Ul(e,t,o,_t)};constrainBottomIndex=t=>{if(!this.topPicker)return t;const e=this.topPicker.getIndex(),o=this.masterOptions.length;return Yl(e,t,o,_t)};handleTopSelection(t){b.debug("ClefViewportController","handleTopSelection called",{newTopIndex:t},"ui"),$t.setViewportTopIndex(t)}handleBottomSelection(t){b.debug("ClefViewportController","handleBottomSelection called",{newBottomIndex:t},"ui"),$t.setViewportBottomIndex(t)}updateSummary(t,e){const o=this.masterOptions[t],i=this.masterOptions[e],s=e-t+1;this.rangeLabel&&o&&i&&(this.rangeLabel.textContent=`${o.label}  ${i.label}`),this.rangeCount&&(this.rangeCount.textContent=`${s} ${s===1?"pitch":"pitches"}`)}computePresetRanges(){const t=(e,o)=>{const i=this.findToneNoteIndex(e),s=this.findToneNoteIndex(o);return i===-1||s===-1?null:{topIndex:Math.min(i,s),bottomIndex:Math.max(i,s)}};this.presetRanges={full:{topIndex:0,bottomIndex:Math.max(0,this.masterOptions.length-1)},treble:t("G5","C4"),alto:t("A4","D3"),bass:t("C4","E2"),voice1:t("A5","A3"),voice2:t("C5","C3"),voice3:t("E4","E2")}}updatePresetHighlight(t,e){let o=null;Object.entries(this.presetRanges).forEach(([i,s])=>{s&&s.topIndex===t&&s.bottomIndex===e&&(o=i)}),this.activePresetId=o,this.presetButtons?.length&&(this.presetButtons.forEach(i=>{const s=i.dataset?.preset?i.dataset.preset??"":(i.id||"").replace(/^clef-/,"").replace(/-button$/,"").replace(/-range$/,"").replace(/-/g,""),a=this.activePresetId&&s===this.activePresetId;i.classList.toggle("active",!!a)}),this.presetContainer&&this.presetContainer.classList.toggle("locked",!1))}applyPresetView(t){const e=this.presetRanges[t];if(!e){b.warn("ClefViewportController","Preset range could not be resolved",{preset:t},"ui");return}const o=t==="full"?420:280;$t.setPitchViewportRange(e,{animateMs:o,source:`preset:${t}`})}findNoteIndex(t){return this.masterOptions.findIndex(e=>e.label===t)}findToneNoteIndex(t){return this.masterOptions.findIndex(e=>e.toneNote===t)}calculateAndSetWheelHeight(){const t=document.querySelector(".range-panel-section.wheels-section"),e=t?.querySelector(".panel-section-title");if(!t||!this.topWheel||!this.bottomWheel)return;const o=t.clientHeight,i=e?.offsetHeight||0,a=o-i-15,r=Math.max(120,Math.min(a,300));this.topWheel.style.setProperty("--clef-wheel-height",`${r}px`),this.bottomWheel.style.setProperty("--clef-wheel-height",`${r}px`),setTimeout(()=>{this.topPicker?.updateVisuals(),this.bottomPicker?.updateVisuals()},0)}}const Da=new af,rf={X:["1P","3M","5P"],x:["1P","3m","5P"],"x":["1P","3m","5d"],"X+":["1P","3M","5A"],"X":["1P","3M","5P","7m"],"x":["1P","3m","5P","7m"],"Xmaj":["1P","3M","5P","7M"],"":["1P","3m","5d","7m"],"x":["1P","3m","5d","6M"],"X":["1P","3M","5P","6M"],Xsus2:["1P","2M","5P"],Xsus4:["1P","4P","5P"]},lf={"xmaj":["1P","3m","5P","7M"],Xadd9:["1P","3M","5P","9M"],xadd9:["1P","3m","5P","9M"],"X6/9":["1P","3M","5P","6M","9M"],X9:["1P","3M","5P","7m","9M"],X11:["1P","3M","5P","7m","9M","11P"],X13:["1P","3M","5P","7m","9M","13M"],Xmaj9:["1P","3M","5P","7M","9M"],"x":["1P","3m","5P","7m","9M"],"x":["1P","3m","5P","6M"],"x":["1P","3m","5P","7m","9M","11P"],"Xmaj711":["1P","3M","5P","7M","11A"]},_a={...rf,...lf},Fa={M6:["6M"],A6:["6A"],m7:["7m"],M7:["7M"],d5:["5d"],P5:["5P"],A5:["5A"],m6:["6m"],m3:["3m"],M3:["3M"],P4:["4P"],A4:["4A"],U:["1P"],m2:["2m"],M2:["2M"],A2:["2A"]},cf={"9m":"2m","9M":"2M","9A":"2A","11P":"4P","11A":"4A","13m":"6m","13M":"6M","13A":"6A"};function Ei(n){return cf[n]??n}function df(n,t){ve(t,!0);const e=15;let o=Tt("diatonic"),i=Tt("position"),s=null,a=null,r=null,c=null,d=null,u=null,h=null,f=null,g=null,m=null,p=null,v=null,y=null,w=null,S=[];function M(){return Object.keys(l.state.tonicSignGroups).length>0}function P(R=l.state.degreeDisplayMode){const F=r?.querySelector('[data-mode="diatonic"]'),I=r?.querySelector('[data-mode="modal"]');if(!F||!I)return;R!=="off"&&ft(o,R,!0);const $=R==="off"?nt(o):R,O=R==="off";[F,I].forEach(q=>{q.disabled=O,q.classList.toggle("disabled",O)}),r&&r.classList.toggle("disabled",O),F.classList.toggle("active",$==="diatonic"),F.setAttribute("aria-pressed",$==="diatonic"?"true":"false"),I.classList.toggle("active",$==="modal"),I.setAttribute("aria-pressed",$==="modal"?"true":"false")}function E(R,F){if(!F)return;const I=R!=="off";F.classList.toggle("active",I),F.setAttribute("aria-pressed",I?"true":"false")}function x(){if(y&&(y.querySelectorAll(".harmony-preset-button").forEach(R=>{R.classList.remove("selected","partial-match")}),l.state.activeChordIntervals)){const R=l.state.activeChordIntervals,F=R.toString(),I=R.map(Ei),$=y.querySelectorAll(".harmony-preset-button");for(const O of $){const q=O.textContent?.trim()??"",Z=_a[q];if(!Z)continue;const B=Z.toString(),J=Z.map(Ei);if(B===F){O.classList.add("selected");continue}I.every(tt=>J.includes(tt))&&O.classList.add("partial-match")}}}function A(){if(w&&(w.querySelectorAll(".harmony-preset-button").forEach(R=>R.classList.remove("selected")),l.state.activeChordIntervals)){const F=l.state.activeChordIntervals.map(Ei);w.querySelectorAll(".harmony-preset-button").forEach(I=>{const $=I.textContent?.trim()??"",q=Fa[$]?.[0];q&&F.includes(q)&&I.classList.add("selected")})}}const k=(R,F=50)=>{const I=parseInt(R.slice(1,3),16),$=parseInt(R.slice(3,5),16),O=parseInt(R.slice(5,7),16),q=Math.min(255,Math.floor(I+(255-I)*(F/100))),Z=Math.min(255,Math.floor($+(255-$)*(F/100))),B=Math.min(255,Math.floor(O+(255-O)*(F/100)));return`#${q.toString(16).padStart(2,"0")}${Z.toString(16).padStart(2,"0")}${B.toString(16).padStart(2,"0")}`},C=(R,F=1)=>{const I=R.startsWith("#")?R.slice(1):R;if(I.length!==6)return R;const $=parseInt(I.slice(0,2),16),O=parseInt(I.slice(2,4),16),q=parseInt(I.slice(4,6),16);return`rgba(${$}, ${O}, ${q}, ${F})`},N=(R,F)=>{if(!R)return;const I=k(F,50),$=k(I,60);R.style.setProperty("--c-accent",F),R.style.setProperty("--c-accent-light",$),R.style.setProperty("--harmony-partial-bg",C($,.25)),R.style.setProperty("--harmony-partial-border",C(F,.4)),R.style.setProperty("--harmony-partial-bg-hover",C($,.4)),R.style.setProperty("--harmony-partial-border-hover",C(F,.6))};function L(){return(l.state.activeChordIntervals?.length??0)===2?"inversion":"position"}function W(){const R=l.state.activeChordIntervals?.length??1;return R===2?2:Math.max(1,R)}function H(){return L()==="inversion"?l.state.isIntervalsInverted?1:0:l.state.chordPositionState}function Q(R){L()==="inversion"?l.setIntervalsInversion(R===1):l.setChordPosition(R)}function D(){if(!v)return;const R=L(),F=H(),I=l.state.activeChordIntervals?.length??1;v.classList.toggle("inversion-mode",R==="inversion"),v.classList.toggle("position-mode",R==="position"),v.classList.remove("state-1","state-2","state-3","state-4","state-5"),F>=1&&F<=5&&v.classList.add(`state-${F}`);for(let $=1;$<=5;$++)v.classList.remove(`disabled-state-${$}`);R==="position"&&(I<=1?v.classList.add("disabled-state-1"):I===2?v.classList.add("disabled-state-2"):I===3?v.classList.add("disabled-state-3"):I===4?v.classList.add("disabled-state-4"):I===5&&v.classList.add("disabled-state-5"))}function U(){const R=L(),F=l.state.activeChordIntervals?.length??1;if(nt(i)!==R){if(R==="inversion"){const I=l.state.chordPositionState===0;l.setIntervalsInversion(!I)}else l.setChordPosition(0);ft(i,R,!0)}else if(R==="position"){const I=Math.max(0,F-1);l.state.chordPositionState>I&&l.setChordPosition(0)}D()}function V(){U()}function j(R=l.state.selectedToolTonicNumber){if(!S.length)return;const F=S[0]?parseInt(S[0].dataset.tonic??"1",10):1,I=typeof R=="number"?R:parseInt(String(R??""),10),$=Number.isNaN(I)?F:I;S.forEach(O=>{const q=O.dataset.tonic,B=(q?parseInt(q,10):NaN)===$;O.classList.toggle("selected",B),O.setAttribute("aria-pressed",B?"true":"false")})}function at(){return d?.classList.contains("active")?"modal":c?.classList.contains("active")?"diatonic":nt(o)}function mt(){const R=document.querySelector('[data-tab="rhythm"]');R&&!R.classList.contains("active")&&R.click();const F=document.querySelector('[data-rhythm-stamp-tab="sixteenth"]');F&&!F.classList.contains("active")&&F.click()}const vt=R=>{[u,h,g].forEach(F=>{F&&(F.classList.toggle("accidental-btn--disabled",R),F.setAttribute("aria-disabled",R?"true":"false"))})},dt=R=>{R!==void 0&&(f&&(f.classList.toggle("active",R),f.setAttribute("aria-pressed",R?"true":"false")),vt(R))},T=R=>{R!==void 0&&g&&(g.classList.toggle("active",R),g.setAttribute("aria-pressed",R?"true":"false"))};function _({newTool:R}={}){if(s?.classList.remove("selected"),p&&p.classList.remove("active-tool"),R==="eraser")s?.classList.add("selected");else if(R==="chord")p?.classList.add("active-tool");else if(R==="note"){const F=l.state.selectedNote;if(F){const I=document.querySelector(`.note-pair[data-color='${F.color}']`);I?.classList.add("selected"),I?.querySelector(`.note[data-type='${F.shape}']`)?.classList.add("selected")}}j()}function G(){x(),A(),V()}function X({newNote:R}={}){if(!R?.color||!R.shape)return;const{color:F,shape:I}=R;document.querySelectorAll(".note, .note-pair").forEach(q=>q.classList.remove("selected"));const $=document.querySelector(`.note[data-color='${F}'][data-type='${I}']`);if($)$.classList.add("selected");else{const q=document.querySelector(`.note-pair[data-color='${F}']`);q?.classList.add("selected"),q?.querySelector(`.note[data-type='${I}']`)?.classList.add("selected")}N(p,F);const O=document.querySelector(".tab-sidebar");O&&O.style.setProperty("--c-accent",F)}function z(R){R&&(E(R,a),P(R))}function rt(R){R&&(h?.classList.toggle("active",R.sharp),u?.classList.toggle("active",R.flat))}Ie(()=>{const R=Te.getMultiple("noteBankContainer","eraserButton","degreeVisibilityToggle","degreeModeToggle","flatBtn","sharpBtn","frequencyBtn","octaveLabelBtn","focusColoursToggle");s=R.eraserButton,a=R.degreeVisibilityToggle??null,r=R.degreeModeToggle,c=r?.querySelector('[data-mode="diatonic"]')??null,d=r?.querySelector('[data-mode="modal"]')??null,u=R.flatBtn,h=R.sharpBtn,f=R.frequencyBtn,g=R.octaveLabelBtn,m=R.focusColoursToggle,p=document.querySelector(".pitch-tabs-container"),v=document.getElementById("unified-position-toggle"),y=document.querySelector("#chords-panel .chords-grid"),w=document.querySelector("#chords-panel .intervals-4x4-grid"),S=Array.from(document.querySelectorAll(".tonic-mode-button")),Da.init(),document.querySelectorAll(".note").forEach(K=>{K.addEventListener("click",()=>{const st=K.dataset.type,ht=K.dataset.color||K.closest(".note-pair")?.dataset.color;if(!(!st||!ht)){if(st==="diamond"){l.setSelectedNote("diamond",ht);const Rt=document.querySelector(".sixteenth-stamp-button.active"),Et=Rt?parseInt(Rt.dataset.sixteenthStampId??"",10):NaN;if(l.state.selectedTool==="sixteenthStamp"&&Rt&&!Number.isNaN(Et)&&Et!==e)return;mt(),Jo.selectSixteenthStamp(e);return}l.setSelectedNote(st,ht),l.setSelectedTool("note")}})}),s&&s.addEventListener("click",()=>{if(l.state.selectedTool==="eraser"){l.setSelectedTool(l.state.previousTool||"note");return}l.setSelectedTool("eraser")});const I=document.getElementById("lasso-shortcut-button");I&&I.addEventListener("click",()=>{document.querySelector('[data-tab="pitch"]')?.click(),document.querySelector('[data-pitch-tab="draw"]')?.click(),document.querySelector('button.draw-tool-button[data-draw-tool="lasso"]')?.click()});const $=document.getElementById("marker-shortcut-button");$&&$.addEventListener("click",()=>{document.querySelector('[data-tab="pitch"]')?.click(),document.querySelector('[data-pitch-tab="draw"]')?.click(),document.querySelector('button.draw-tool-button[data-draw-tool="marker"]')?.click()}),S.length&&(S.forEach(K=>{K.addEventListener("click",()=>{const st=K.getAttribute("data-tonic");if(!st)return;const ht=parseInt(st,10);l.setSelectedTool("tonicization",ht),j(ht)})}),j()),y&&y.querySelectorAll(".harmony-preset-button").forEach(K=>{K.addEventListener("click",()=>{const st=K.textContent?.trim()??"",ht=_a[st];ht&&ht.length>0&&(l.setActiveChordIntervals(ht),l.setSelectedTool("chord")),K.blur()}),K.addEventListener("dblclick",()=>{K.classList.contains("selected")&&l.setSelectedTool("note"),K.blur()})}),w&&w.querySelectorAll(".harmony-preset-button").forEach(K=>{K.addEventListener("click",()=>{const st=K.textContent?.trim()??"",ht=Fa[st];if(ht&&ht.length>0){const Rt=ht[0];if(!Rt)return;let Et=l.state.selectedTool==="chord"&&l.state.activeChordIntervals?[...l.state.activeChordIntervals]:["1P"];Et.includes(Rt)?Rt!=="1P"&&(Et=Et.filter(Ke=>Ke!==Rt)):Et.push(Rt),Et.includes("1P")||Et.unshift("1P");const le=["1P","2m","2M","2A","3m","3M","4P","4A","5d","5P","5A","6m","6M","6A","7m","7M","9M","11P","11A","13M"];Et.sort((Ke,El)=>le.indexOf(Ke)-le.indexOf(El)),l.setActiveChordIntervals(Et),l.setSelectedTool("chord")}K.blur()}),K.addEventListener("dblclick",()=>{l.setActiveChordIntervals(["1P"]),l.setSelectedTool("chord"),K.blur()})});const O=document.querySelectorAll(".pitch-tab-button"),q=document.querySelectorAll(".pitch-tab-panel");O.forEach(K=>{K.addEventListener("click",()=>{const st=K.dataset.pitchTab;st&&(O.forEach(ht=>ht.classList.remove("active")),K.classList.add("active"),q.forEach(ht=>ht.classList.remove("active")),document.getElementById(`${st}-panel`)?.classList.add("active"),localStorage.setItem("selectedPitchTab",st),st==="chords"&&V(),st==="range"&&setTimeout(()=>Da.refreshWheelVisuals(),0))})});const Z=localStorage.getItem("selectedPitchTab")||"chords",B=document.querySelector(`[data-pitch-tab="${Z}"]`);B&&(O.forEach(K=>K.classList.remove("active")),q.forEach(K=>K.classList.remove("active")),B.classList.add("active"),document.getElementById(`${Z}-panel`)?.classList.add("active"));const J=document.querySelectorAll(".rhythm-stamp-tab-button"),ot=document.querySelectorAll(".rhythm-stamp-tab-panel");J.forEach(K=>{K.addEventListener("click",()=>{const st=K.dataset.rhythmStampTab;st&&(J.forEach(ht=>ht.classList.remove("active")),K.classList.add("active"),ot.forEach(ht=>ht.classList.remove("active")),document.getElementById(`${st}-stamps-panel`)?.classList.add("active"),localStorage.setItem("selectedRhythmStampTab",st))})});const tt=localStorage.getItem("selectedRhythmStampTab")||localStorage.getItem("selectedRhythmTab"),ut=tt==="stamps"?"sixteenth":tt==="triplets"?"triplet":tt||"sixteenth",pt=document.querySelector(`[data-rhythm-stamp-tab="${ut}"]`);pt&&(J.forEach(K=>K.classList.remove("active")),ot.forEach(K=>K.classList.remove("active")),pt.classList.add("active"),document.getElementById(`${ut}-stamps-panel`)?.classList.add("active")),v&&(v.querySelector(".toggle-track")?.addEventListener("click",()=>{const st=H(),ht=W();Q((st+1)%ht),v?.blur()}),v.querySelectorAll(".left-labels .state-label").forEach(st=>{st.addEventListener("click",()=>{L()==="inversion"&&Q(parseInt(st.dataset.step??"0",10))})}),v.querySelectorAll(".right-labels .state-label").forEach(st=>{st.addEventListener("click",()=>{if(L()!=="position")return;const ht=parseInt(st.dataset.step??"0",10);ht<W()&&Q(ht)})}),l.on("chordPositionChanged",D),l.on("intervalsInversionChanged",D),D()),a&&a.addEventListener("click",()=>{if(l.state.degreeDisplayMode==="off"){if(!M()){Ra.alert("Please place a tonal center on the canvas before showing degrees.","Tonal Center Required");return}l.setDegreeDisplayMode(at())}else l.setDegreeDisplayMode("off");a?.blur()}),c&&c.addEventListener("click",()=>{l.state.degreeDisplayMode!=="off"&&l.state.degreeDisplayMode!=="diatonic"&&l.setDegreeDisplayMode("diatonic"),c?.blur()}),d&&d.addEventListener("click",()=>{l.state.degreeDisplayMode!=="off"&&l.state.degreeDisplayMode!=="modal"&&l.setDegreeDisplayMode("modal"),d?.blur()}),u&&u.addEventListener("click",()=>{l.state.showFrequencyLabels&&l.toggleFrequencyLabels(),l.toggleAccidentalMode("flat"),u?.blur()}),h&&h.addEventListener("click",()=>{l.state.showFrequencyLabels&&l.toggleFrequencyLabels(),l.toggleAccidentalMode("sharp"),h?.blur()}),f&&f.addEventListener("click",()=>{l.toggleFrequencyLabels(),f?.blur()}),g&&g.addEventListener("click",()=>{l.state.showFrequencyLabels&&l.toggleFrequencyLabels(),l.toggleOctaveLabels(),g?.blur()}),m&&m.addEventListener("change",()=>{if(!l.state.focusColours&&!M()){Ra.alert("Please place a tonal center on the canvas before enabling focus colours.","Tonal Center Required"),m&&(m.checked=!1);return}l.toggleFocusColours()}),l.on("toolChanged",_),l.on("activeChordIntervalsChanged",G),l.on("noteChanged",X),l.on("degreeDisplayModeChanged",z),l.on("accidentalModeChanged",rt),l.on("frequencyLabelsChanged",dt),l.on("octaveLabelsChanged",T),dt(l.state.showFrequencyLabels),T(l.state.showOctaveLabels),p&&l.state.selectedNote&&N(p,l.state.selectedNote.color);const bt=document.querySelector(".tab-sidebar");bt&&l.state.selectedNote&&bt.style.setProperty("--c-accent",l.state.selectedNote.color),setTimeout(()=>V(),50);const gt=l.state.degreeDisplayMode;E(gt,a),P(gt),x(),A(),V(),console.log("[Svelte] ToolSelectorBridge mounted")}),ke(()=>{console.log("[Svelte] ToolSelectorBridge unmounted")}),be()}class Mi{parent;settings;_em;_value;decimalPlaces;colors;element;_minDimension;actual=0;hasMoved=!1;clicked=!1;_start={y:0};_changeFactor=1;constructor(t,e={}){const o=typeof t=="string"?document.querySelector(t):t;if(this.parent=o,!this.parent)throw new Error("DraggableNumber: parent element not found");const i={size:[60,30],value:0,min:0,max:2e4,step:1,decimalPlaces:2,colors:{fill:"#e7e7e7",dark:"#333",light:"#fff",accent:"#b35"},useAppStyling:!1},s={fill:e.colors?.fill??i.colors.fill,dark:e.colors?.dark??i.colors.dark,light:e.colors?.light??i.colors.light,accent:e.colors?.accent??i.colors.accent};this.settings={...i,...e,colors:s},this._em=new hf,this._value=new uf(this.settings.min,this.settings.max,this.settings.step,this.settings.value),this.decimalPlaces=this.settings.decimalPlaces,this.colors=this.settings.colors,this.element=document.createElement("input"),this.element.type="text",this.parent.appendChild(this.element);const[a,r]=this.settings.size;this._minDimension=Math.min(a,r),this.settings.useAppStyling?(this.element.className="draggable-number-input",this.element.style.cssText=[`width:${a}px`,`height:${r}px`,"background-color: var(--c-surface)","color: var(--c-text)","border: 1px solid var(--c-border)","border-radius: var(--border-radius-sm)","font-family: var(--main-font)","font-weight: 400","font-size: 14px","text-align: center","outline: none","padding: 0","box-sizing: border-box","user-select: text"].join(";")):this.element.style.cssText=[`width:${a}px`,`height:${r}px`,`background-color:${this.colors.fill}`,`color:${this.colors.dark}`,"font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif","font-weight:500",`font-size:${this._minDimension/2}px`,"border: none","outline: none",`padding:${this._minDimension/4}px ${this._minDimension/4}px`,"box-sizing:border-box","user-select:text"].join(";"),ff(this.element,c=>/^-?\d*\.?\d*$/.test(c)),this.actual=0,this.hasMoved=!1,this.clicked=!1,this.element.value=Wa(this._value.value,this.decimalPlaces),this._bind()}on(t,e){return this._em.on(t,e),()=>this._em.off(t,e)}emit(t,e){this._em.emit(t,e)}get value(){return this._value.value}set value(t){this._value.update(t),this.emit("change",this._value.value),this._render()}get min(){return this._value.min}set min(t){this._value.min=t,this._render()}get max(){return this._value.max}set max(t){this._value.max=t,this._render()}get step(){return this._value.step}set step(t){this._value.step=t,this._render()}passiveUpdate(t){this._value.update(t),this._render()}link(t){this.min=t.min,this.max=t.max,this.step=t.step,typeof t.on=="function"&&t.on("change",e=>this.passiveUpdate(e)),this.on("change",e=>{"value"in t&&(t.value=e)}),this.value=t.value}_bind(){this.element.addEventListener("blur",()=>{this.settings.useAppStyling?(this.element.style.backgroundColor="var(--c-surface)",this.element.style.color="var(--c-text)"):(this.element.style.backgroundColor=this.colors.fill,this.element.style.color=this.colors.dark);const t=parseFloat(this.element.value);!Number.isNaN(t)&&t!==this.value?this.value=t:this._render()}),this.element.addEventListener("keydown",t=>{if(t.key==="Enter"){this.element.blur();const e=parseFloat(this.element.value);Number.isNaN(e)||(this.value=e)}},!0),this.element.addEventListener("mousedown",t=>this._onMouseDown(t)),this.element.addEventListener("dragstart",t=>t.preventDefault())}_onMouseDown(t){this.hasMoved=!1,this.clicked=!0,this.element.readOnly=!0,this.actual=this.value,this._start={y:t.clientY};const e=this.element.getBoundingClientRect(),o=(t.clientX-e.left)/e.width;this._changeFactor=mf(o);const i=a=>this._onMouseMove(a),s=()=>this._onMouseUp(i,s);window.addEventListener("mousemove",i),window.addEventListener("mouseup",s)}_onMouseMove(t){if(!this.clicked)return;this.hasMoved=!0;const e=t.clientY-this._start.y,i=Is(this.max-this.min,0,1e3)/200*Math.pow(this._changeFactor,2),s=this.actual-e*i;this._value.update(s),this._render(),this._value.changed&&this.emit("change",this._value.value)}_onMouseUp(t,e){this.clicked=!1,window.removeEventListener("mousemove",t),window.removeEventListener("mouseup",e),this.hasMoved?document.body.focus():(this.element.readOnly=!1,this.element.focus(),this.element.setSelectionRange(0,this.element.value.length),this.settings.useAppStyling?(this.element.style.backgroundColor="var(--c-accent)",this.element.style.color="var(--c-surface)"):(this.element.style.backgroundColor=this.colors.accent,this.element.style.color=this.colors.light))}_render(){this.element.value=Wa(this._value.value,this.decimalPlaces)}}class uf{min;max;step;_value;changed;constructor(t,e,o,i){this.min=Number(t),this.max=Number(e),this.step=Number(o)||1,this._value=0,this.changed=!1,this.update(i)}get value(){return this._value}update(t){const e=Is(Number(t),this.min,this.max),o=this._stepTo(e),i=this._value;this._value=o,this.changed=o!==i}_stepTo(t){if(!isFinite(this.step)||this.step<=0)return t;const e=Math.round((t-this.min)/this.step);return this.min+e*this.step}}class hf{_m;constructor(){this._m=new Map}on(t,e){const o=this._m.get(t)||[];o.push(e),this._m.set(t,o)}off(t,e){const o=this._m.get(t);if(!o)return;const i=o.indexOf(e);i>=0&&o.splice(i,1)}emit(t,e){const o=this._m.get(t);if(o)for(const i of o.slice())i(e)}}function Is(n,t,e){return Math.max(t,Math.min(e,n))}function mf(n){return 1-Is(n,0,1)}function Wa(n,t=2){return isFinite(n)?Number(n).toFixed(Math.max(0,t)).replace(/\.0+$/,"").replace(/(\.\d*?)0+$/,"$1"):""}function ff(n,t){let e=n.value;n.addEventListener("input",()=>{t(n.value)?e=n.value:n.value=e})}class pf{isActive=!1;pulseIntervals=new Map;tempoElements=new Map;popDuration={scaleUp:40,scaleDown:80};popScale=1.4;activeAnimations=new Map;constructor(){this.initElements()}initElements(){[{type:"eighth",containerId:"eighth-note-tempo",bpmMultiplier:2},{type:"quarter",containerId:"quarter-note-tempo",bpmMultiplier:1},{type:"dottedQuarter",containerId:"dotted-quarter-tempo",bpmMultiplier:.666}].forEach(({type:e,containerId:o,bpmMultiplier:i})=>{const s=document.getElementById(o),a=s?.parentElement,r=a?.querySelector(".tempo-label-icon");s&&r?this.tempoElements.set(e,{container:s,icon:r,bpmMultiplier:i,originalTransform:s.style.transform||"",originalIconTransform:r.style.transform||""}):b.warn("TempoVisualizer",`Could not find elements for ${e} tempo`,{container:!!s,icon:!!r,tempoGroup:!!a},"toolbar")})}start(){this.isActive||(this.isActive=!0,this.tempoElements.size===0&&this.initElements(),this.tempoElements.forEach((t,e)=>{this.startPulseForType(e)}))}stop(){this.isActive&&(this.isActive=!1,this.pulseIntervals.forEach(t=>{clearInterval(t)}),this.pulseIntervals.clear(),this.activeAnimations.clear(),this.tempoElements.forEach(t=>{t.container.style.transform=t.originalTransform,t.icon.style.transform=t.originalIconTransform}))}startPulseForType(t){const e=this.tempoElements.get(t);if(!e)return;const s=60/(l.state.tempo*e.bpmMultiplier)*1e3;this.triggerPulse(t);const a=setInterval(()=>{this.isActive&&this.triggerPulse(t)},s);this.pulseIntervals.set(t,a)}triggerPulse(t){const o={startTime:performance.now(),phase:"scaleUp"};this.activeAnimations.set(t,o);const i=this.isActive;this.isActive=!0,this.activeAnimations.size===1&&this.animationLoop(),i||setTimeout(()=>{this.activeAnimations.size===0&&(this.isActive=!1)},this.popDuration.scaleUp+this.popDuration.scaleDown+50)}animationLoop(){if(this.activeAnimations.size===0||!this.isActive)return;const t=performance.now();this.activeAnimations.forEach((e,o)=>{const i=this.calculateScale(e,t);this.applyScale(o,i),i===1&&e.phase==="complete"&&this.activeAnimations.delete(o)}),this.activeAnimations.size>0&&requestAnimationFrame(()=>this.animationLoop())}calculateScale(t,e){const o=e-t.startTime;if(t.phase==="scaleUp"){if(o>=this.popDuration.scaleUp)return t.phase="scaleDown",t.startTime=e,this.popScale;{const i=Math.min(o/this.popDuration.scaleUp,1);return 1+(this.popScale-1)*i}}else if(t.phase==="scaleDown"){if(o>=this.popDuration.scaleDown)return t.phase="complete",1;{const i=Math.min(o/this.popDuration.scaleDown,1);return this.popScale-(this.popScale-1)*i}}return 1}applyScale(t,e){const o=this.tempoElements.get(t);if(!o)return;const i=`scale(${e})`;o.container.style.transform=o.originalTransform+" "+i,o.icon.style.transform=o.originalIconTransform+" "+i;const s=e<this.popScale?"transform 0.08s ease-out":"none";o.container.style.transition=s,o.icon.style.transition=s}updateTempo(){this.isActive&&(this.stop(),this.start())}}const Ze=new pf,je=un,ce={blend:2,cutoff:31,resonance:0,type:"lowpass"};function so(){return{coeffs:new Float32Array(je).fill(0),phases:new Float32Array(je).fill(0)}}function gf(){const n=so();return n.coeffs[0]=1,n}function vf(){const n=so();for(let t=1;t<=je;t+=2){const e=t-1;n.coeffs[e]=1/t,n.phases[e]=0}return n}function bf(){const n=so();for(let t=1;t<=je;t+=2){const e=t-1;n.coeffs[e]=1/(t*t),n.phases[e]=Math.PI/2}return n}function yf(){const n=so();for(let t=1;t<=je;t++){const e=t-1;n.coeffs[e]=1/t,n.phases[e]=t&1?0:Math.PI}return n}const wf={strings:{amps:[.995,.94,.425,.48,0,.365,.04,.085,0,.09,0,0],phases:[0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,0]},piano:{amps:[1,.7,.6,.5,.4,.32,.25,.2,.17,.14,.12,.1],phases:Array(12).fill(0)},marimba:{amps:[1,.2,.15,.7,.05,.18,.03,.05,.02,.01,0,0],phases:Array(12).fill(0)},woodwind:{amps:[1,.05,.5,.05,.3,.05,.2,.05,.12,.05,.08,.05],phases:Array(12).fill(0)}};function wo(n){const t=so(),e=wf[n];if(!e)return t;const o=Math.min(je,e.amps.length);for(let i=0;i<o;i++)t.coeffs[i]=e.amps[i]||0,t.phases[i]=e.phases[i]||0;return t}const xn={attack:.1,decay:.2,sustain:.8,release:.3},Sf={sine:{name:"sine",gain:1,adsr:xn,...gf(),filter:{...ce}},triangle:{name:"triangle",gain:.81,adsr:xn,...bf(),filter:{...ce}},square:{name:"square",gain:4/Math.PI,adsr:xn,...vf(),filter:{...ce}},sawtooth:{name:"sawtooth",gain:2/Math.PI,adsr:xn,...yf(),filter:{...ce}},trapezium:{name:"trapezium",gain:4/Math.PI,adsr:xn,coeffs:new Float32Array([.993,0,.314,0,.168,0,.101,0,.06,0,.033,0]),phases:new Float32Array(je).fill(0),filter:{...ce}},impulse:{name:"impulse",gain:.18,adsr:{attack:.01,decay:.3,sustain:0,release:.2},coeffs:new Float32Array([1,.9,.8,.7,.6,.5,.4,.3,.2,.1,0,0]),phases:new Float32Array([0,Math.PI*1.5,Math.PI,Math.PI/2,0,Math.PI*1.5,Math.PI,Math.PI/2,0,Math.PI*1.5,Math.PI,0]),filter:{...ce}},strings:{name:"strings",gain:.49,adsr:{attack:.08,decay:.4,sustain:.7,release:.5},...wo("strings"),filter:{...ce,cutoff:28}},piano:{name:"piano",gain:.8,adsr:{attack:.01,decay:1.5,sustain:0,release:.4},...wo("piano"),filter:{...ce,cutoff:28}},marimba:{name:"marimba",gain:.9,adsr:{attack:.01,decay:.8,sustain:0,release:.4},...wo("marimba"),filter:{...ce,cutoff:25}},woodwind:{name:"woodwind",gain:.6,adsr:{attack:.1,decay:.2,sustain:.8,release:.3},...wo("woodwind"),filter:{...ce}}};function Cf(n,t){ve(t,!0);let e=null,o=null,i=null,s=null,a=null,r=Tt(!1);const c=(x,A=20)=>{const k=parseInt(x.slice(1,3),16),C=parseInt(x.slice(3,5),16),N=parseInt(x.slice(5,7),16),L=Math.max(0,Math.floor(k*(1-A/100))),W=Math.max(0,Math.floor(C*(1-A/100))),H=Math.max(0,Math.floor(N*(1-A/100)));return`#${L.toString(16).padStart(2,"0")}${W.toString(16).padStart(2,"0")}${H.toString(16).padStart(2,"0")}`},d=(x,A=50)=>{const k=parseInt(x.slice(1,3),16),C=parseInt(x.slice(3,5),16),N=parseInt(x.slice(5,7),16),L=Math.min(255,Math.floor(k+(255-k)*(A/100))),W=Math.min(255,Math.floor(C+(255-C)*(A/100))),H=Math.min(255,Math.floor(N+(255-N)*(A/100)));return`#${L.toString(16).padStart(2,"0")}${W.toString(16).padStart(2,"0")}${H.toString(16).padStart(2,"0")}`};function u(x){const A=Math.round(x),k=e||document.getElementById("tempo-slider");k&&parseInt(k.value,10)!==A&&(k.value=`${A}`);const C=A*2,N=Math.round(A/1.5);o&&o.value!==C&&o.passiveUpdate(C),i&&i.value!==A&&i.passiveUpdate(A),s&&s.value!==N&&s.passiveUpdate(N),l.state.tempo!==A&&(l.setTempo(A),Ze.updateTempo())}function h(x){if(!x)return;const A=x.closest(".tempo-slider-container");if(!A||A.querySelector(".tempo-slider-marks"))return;const k=[60,90,120,160,200],C=document.createElement("div");C.className="tempo-slider-marks",A.appendChild(C);const N=Number(x.min)||0,L=Number(x.max)||1,W=Math.max(L-N,1),H=[],Q=()=>{const V=x.getBoundingClientRect().height||x.clientHeight,j=getComputedStyle(x),at=parseFloat(j.getPropertyValue("--slider-thumb-size"))||0,mt=parseFloat(j.getPropertyValue("--slider-thumb-border"))||0,vt=at+mt*2,dt=Math.max(V-vt,1),T=vt/2;H.forEach(({el:_,bpm:G})=>{if(G<N||G>L){_.style.display="none";return}_.style.display="";const X=(G-N)/W,z=T+dt*X;_.style.bottom=`${z}px`})};k.forEach(U=>{const V=document.createElement("span");V.className="tempo-slider-mark",V.setAttribute("aria-hidden","true"),C.appendChild(V),H.push({el:V,bpm:U})}),Q(),new ResizeObserver(Q).observe(x)}function f(x){if(!x||!a)return;const A=l.state.timbres[x],k=l.state.colorPalette[x]||{primary:x,light:x},C=k.light,N=k.primary;document.querySelectorAll(".preset-button").forEach(W=>{const H=W,Q=H.id.replace("preset-",""),D=A?.activePresetName===Q;H.classList.toggle("selected",D)});const L=d(C,60);a.style.setProperty("--c-accent",N),a.style.setProperty("--c-accent-light",L),a.style.setProperty("--c-accent-hover",c(N,20))}function g(){ft(r,!0),Ze.start()}function m(){ft(r,!0),Ze.start()}function p(x){const A=x.target,k=A?parseInt(A.value,10):NaN;u(k)}function v(){e?.blur()}function y(){nt(r)&&(ft(r,!1),Ze.stop())}function w(){nt(r)&&(ft(r,!1),Ze.stop())}function S(){nt(r)&&(ft(r,!1),Ze.stop())}function M(x){x?.newNote?.color?f(x.newNote.color):(document.querySelectorAll(".preset-button").forEach(A=>A.classList.remove("selected")),a&&(a.style.setProperty("--c-accent","#4A90E2"),a.style.setProperty("--c-accent-hover","#357ABD")))}function P(x){x&&x===l.state.selectedNote?.color&&f(x)}function E(x){x!==void 0&&u(x)}Ie(()=>{e=document.getElementById("tempo-slider"),a=document.querySelector(".preset-effects-container");const x={size:[45,24],step:1,decimalPlaces:0,useAppStyling:!0};o=new Mi("#eighth-note-tempo",{...x,value:180,min:60,max:480}),i=new Mi("#quarter-note-tempo",{...x,value:90,min:30,max:240}),s=new Mi("#dotted-quarter-tempo",{...x,value:60,min:20,max:160}),o.on("change",k=>{!isNaN(k)&&k>0&&u(k/2)}),i.on("change",k=>{!isNaN(k)&&k>0&&u(k)}),s.on("change",k=>{!isNaN(k)&&k>0&&u(k*1.5)}),u(l.state.tempo),e?(h(e),e.addEventListener("mousedown",g),e.addEventListener("touchstart",m),e.addEventListener("input",p),e.addEventListener("mouseup",v),u(l.state.tempo)):b.warn("AudioControlsBridge","Tempo slider not found - will initialize when rhythm tab is opened",null,"toolbar"),document.addEventListener("mouseup",y),document.addEventListener("touchend",w),document.addEventListener("touchcancel",S),document.querySelectorAll(".preset-button").forEach(k=>{const C=k,N=C.id.replace("preset-",""),L=Sf[N];L&&C.addEventListener("click",()=>{const W=l.state.selectedNote?.color;W&&(l.applyPreset(W,L),setTimeout(()=>f(W),10)),C.blur()})}),l.on("noteChanged",M),l.on("timbreChanged",P),l.on("tempoChanged",E);const A=l.state.selectedNote?.color;A&&f(A),console.log("[Svelte] AudioControlsBridge mounted")}),ke(()=>{e?.removeEventListener("mousedown",g),e?.removeEventListener("touchstart",m),e?.removeEventListener("input",p),e?.removeEventListener("mouseup",v),document.removeEventListener("mouseup",y),document.removeEventListener("touchend",w),document.removeEventListener("touchcancel",S),console.log("[Svelte] AudioControlsBridge unmounted")}),be()}function Af(n,t){ve(t,!1);const e="selectedTab",o="selectedPresetTab",i="timbre",s="presets";function a(T){try{localStorage.setItem(e,T),b.debug("TabManagement",`Saved tab to localStorage: ${T}`,void 0,"ui")}catch(_){b.warn("TabManagement","Failed to save tab to localStorage",_,"ui")}}function r(){try{return localStorage.getItem(e)||i}catch(T){return b.warn("TabManagement","Failed to read tab from localStorage",T,"ui"),i}}function c(T){try{localStorage.setItem(o,T),b.debug("TabManagement",`Saved preset tab to localStorage: ${T}`,void 0,"ui")}catch(_){b.warn("TabManagement","Failed to save preset tab to localStorage",_,"ui")}}function d(){try{return localStorage.getItem(o)||s}catch(T){return b.warn("TabManagement","Failed to read preset tab from localStorage",T,"ui"),s}}let u=null,h=null,f=null;const g=new Map,m=new Map,p=new Map,v=[{label:"effectsPanelActive",selector:"#effects-panel.preset-tab-panel.active"},{label:"effectsPanel",selector:"#effects-panel"},{label:"effectsContentBox",selector:"#effects-panel .effects-content-box"},{label:"presetsPanelActive",selector:"#presets-panel.preset-tab-panel.active"},{label:"presetsPanel",selector:"#presets-panel"},{label:"presetContentBox",selector:"#presets-panel .preset-content-box"},{label:"presetEffectsContent",selector:".preset-effects-content"},{label:"presetEffectsControls",selector:".preset-effects-controls"},{label:"presetEffectsContainer",selector:".preset-effects-container"},{label:"presetEffectsTabs",selector:".preset-effects-tabs"}];let y=null,w=null;const S=new Map;let M=null,P="",E=!1,x=null;function A(T,_){if(!T)return{selector:_,missing:!0};const G=T,X=G.getBoundingClientRect(),z=window.getComputedStyle(G),rt=G.parentElement,R=rt?.getBoundingClientRect(),F=rt?window.getComputedStyle(rt):null;return{selector:_,tag:G.tagName.toLowerCase(),id:G.id||null,className:G.className||null,rectWidth:Number(X.width.toFixed(1)),rectHeight:Number(X.height.toFixed(1)),offsetWidth:G.offsetWidth,clientWidth:G.clientWidth,scrollWidth:G.scrollWidth,computed:{display:z.display,position:z.position,width:z.width,minWidth:z.minWidth,maxWidth:z.maxWidth,flex:z.flex,flexGrow:z.flexGrow,flexShrink:z.flexShrink,flexBasis:z.flexBasis,alignSelf:z.alignSelf,alignItems:z.alignItems,justifyContent:z.justifyContent,justifySelf:z.justifySelf,gap:z.gap,boxSizing:z.boxSizing,paddingLeft:z.paddingLeft,paddingRight:z.paddingRight,borderLeftWidth:z.borderLeftWidth,borderRightWidth:z.borderRightWidth,overflowX:z.overflowX,overflowY:z.overflowY},parent:rt?{tag:rt.tagName.toLowerCase(),id:rt.id||null,className:rt.className||null,rectWidth:Number((R?.width||0).toFixed(1)),computedWidth:F?.width,display:F?.display,flex:F?.flex}:null}}function k(T){const _=Array.from(document.querySelectorAll(T));return{selector:T,count:_.length,entries:_.map((G,X)=>({index:X,...A(G,T)}))}}function C(T,_,G=4){if(!T)return{selector:_,missing:!0,chain:[]};const X=[];let z=T,rt=0;for(;z&&rt<G;){const R=z.getBoundingClientRect(),F=window.getComputedStyle(z);X.push({tag:z.tagName.toLowerCase(),id:z.id||null,className:z.className||null,rectWidth:Number(R.width.toFixed(1)),offsetWidth:z.offsetWidth,clientWidth:z.clientWidth,computed:{display:F.display,width:F.width,minWidth:F.minWidth,maxWidth:F.maxWidth,flex:F.flex,flexGrow:F.flexGrow,flexShrink:F.flexShrink,flexBasis:F.flexBasis,alignItems:F.alignItems,justifyContent:F.justifyContent,alignSelf:F.alignSelf,boxSizing:F.boxSizing,paddingLeft:F.paddingLeft,paddingRight:F.paddingRight,gap:F.gap}}),z=z.parentElement,rt+=1}return{selector:_,missing:!1,chain:X}}function N(T){const _=Object.keys(T.elements).sort(),G={activePresetTab:T.activePresetTab,activePresetPanelId:T.activePresetPanelId};return _.forEach(X=>{const z=T.elements[X];if(!z||z.missing){G[X]="missing";return}G[X]={rectWidth:z.rectWidth,rectHeight:z.rectHeight,offsetWidth:z.offsetWidth,clientWidth:z.clientWidth,scrollWidth:z.scrollWidth}}),JSON.stringify(G)}function L(T,_,G,X){if(_.missing||X.missing)return{pair:`${T} vs ${G}`,missing:!0};const z=["rectWidth","offsetWidth","clientWidth","scrollWidth"],rt=["display","position","width","minWidth","maxWidth","flex","alignSelf","boxSizing","paddingLeft","paddingRight","borderLeftWidth","borderRightWidth","overflowX","overflowY"],R=["computedWidth","display","flex"],F=[];return z.forEach(I=>{const $=_[I],O=X[I];$!==O&&F.push({property:I,[T]:$,[G]:O})}),rt.forEach(I=>{const $=_.computed?.[I],O=X.computed?.[I];$!==O&&F.push({property:`computed.${I}`,[T]:$,[G]:O})}),R.forEach(I=>{const $=_.parent?.[I],O=X.parent?.[I];$!==O&&F.push({property:`parent.${I}`,[T]:$,[G]:O})}),{pair:`${T} vs ${G}`,missing:!1,differences:F}}function W(T){E&&(P=P?`${P}; ${T}`:T,M===null&&(M=requestAnimationFrame(()=>{const _=P||"auto";M=null,P="",U(_)})))}function H(){y&&v.forEach(T=>{document.querySelectorAll(T.selector).forEach(_=>{S.has(_)||(S.set(_,T.label),y.observe(_))})})}function Q(){y||(E=!0,x=null,y=new ResizeObserver(T=>{const _=T.map(G=>S.get(G.target)||G.target.id||G.target.tagName.toLowerCase()).filter(Boolean);_.length&&W(`Resize: ${_.join(", ")}`)}),w=new MutationObserver(()=>H()),document.body?w.observe(document.body,{childList:!0,subtree:!0}):document.addEventListener("DOMContentLoaded",()=>{w?.observe(document.body,{childList:!0,subtree:!0}),H(),W("init")},{once:!0}),window.addEventListener("resize",()=>W("window resize")),H(),W("init"))}function D(){E=!1,x=null,y&&(y.disconnect(),y=null),w&&(w.disconnect(),w=null),S.clear(),M!==null&&(cancelAnimationFrame(M),M=null),P=""}function U(T){requestAnimationFrame(()=>{const _=document.querySelector(".preset-tab-button.active"),G=document.querySelector(".preset-tab-panel.active"),X=A(document.querySelector("#effects-panel.preset-tab-panel.active"),"#effects-panel.preset-tab-panel.active"),z=A(document.getElementById("effects-panel"),"#effects-panel"),rt=A(document.querySelector("#effects-panel .effects-content-box"),"#effects-panel .effects-content-box"),R=A(document.querySelector("#presets-panel.preset-tab-panel.active"),"#presets-panel.preset-tab-panel.active"),F=A(document.getElementById("presets-panel"),"#presets-panel"),I=A(document.querySelector("#presets-panel .preset-content-box"),"#presets-panel .preset-content-box"),$=A(document.querySelector(".preset-effects-content"),".preset-effects-content"),O=A(document.querySelector(".preset-effects-controls"),".preset-effects-controls"),q=A(document.querySelector(".preset-effects-container"),".preset-effects-container"),Z=A(document.querySelector(".preset-effects-tabs"),".preset-effects-tabs"),B={reason:T,activePresetTab:_?.dataset?.presetTab||null,activePresetPanelId:G?.id||null,elements:{effectsPanelActive:X,effectsPanel:z,effectsContentBox:rt,presetsPanelActive:R,presetsPanel:F,presetContentBox:I,presetEffectsContent:$,presetEffectsControls:O,presetEffectsContainer:q,presetEffectsTabs:Z},comparisons:{activePanelVsEffectsContent:L("effectsPanelActive",X.missing?z:X,"effectsContentBox",rt),panelVsEffectsContent:L("effectsPanel",z,"effectsContentBox",rt),contentBoxes:L("effectsContentBox",rt,"presetContentBox",I),panels:L("effectsPanel",z,"presetsPanel",F),tabsVsEffectsContent:L("presetEffectsTabs",Z,"effectsContentBox",rt)},chains:{effectsPanelActive:C(document.querySelector("#effects-panel.preset-tab-panel.active"),"#effects-panel.preset-tab-panel.active"),effectsContentBox:C(document.querySelector("#effects-panel .effects-content-box"),"#effects-panel .effects-content-box"),presetEffectsContent:C(document.querySelector(".preset-effects-content"),".preset-effects-content")},lists:{presetTabButtons:k(".preset-effects-tabs .preset-tab-button")}},J=N(B);(T.startsWith("Resize")||T==="auto"||T==="init"||T==="window resize")&&J===x||(x=J,console.groupCollapsed(`[Sizing] Preset/Effects widths (${T})`),console.log(B),console.groupEnd())})}function V(T){window.enablePresetEffectsSizingDiagnostics&&U(T)}function j(){const T=r();document.querySelectorAll(".tab-button").forEach(X=>X.classList.remove("active")),document.querySelectorAll(".tab-panel").forEach(X=>X.classList.remove("active"));const _=document.querySelector(`[data-tab="${T}"]`),G=document.getElementById(`${T}-panel`);_&&G?(_.classList.add("active"),G.classList.add("active"),T==="rhythm"&&setTimeout(()=>{const X=window.initTempoSliderIfNeeded;typeof X=="function"&&X()},200)):b.warn("TabManagement",`Could not restore tab: ${T}. Tab button or panel not found.`)}function at(){const T=d();document.querySelectorAll(".preset-tab-button:not([disabled])").forEach(X=>X.classList.remove("active")),document.querySelectorAll(".preset-tab-panel").forEach(X=>X.classList.remove("active"));const _=document.querySelector(`[data-preset-tab="${T}"]`),G=document.getElementById(`${T}-panel`);if(_&&G&&!_.hasAttribute("disabled")){_.classList.add("active"),G.classList.add("active");const X=document.querySelector(".harmonic-bins-container");X&&(T==="effects"?X.style.display="none":X.style.display="flex")}else b.warn("TabManagement",`Could not restore preset tab: ${T}. Tab button or panel not found.`);V("restore preset tab")}function mt(){j(),u=document.querySelectorAll(".tab-button"),u.forEach(T=>{const _=()=>{const G=T.dataset.tab;if(!G)return;document.querySelectorAll(".tab-button").forEach(z=>z.classList.remove("active")),T.classList.add("active"),document.querySelectorAll(".tab-panel").forEach(z=>z.classList.remove("active"));const X=document.getElementById(`${G}-panel`);X&&X.classList.add("active"),a(G),G==="rhythm"&&setTimeout(()=>{const z=window.initTempoSliderIfNeeded;typeof z=="function"&&z()},50)};T.addEventListener("click",_),g.set(T,_)}),b.info("TabManagementBridge","Main tabs initialized",null,"ui")}function vt(){at(),h=document.querySelectorAll(".preset-tab-button"),h.forEach(T=>{const _=()=>{const G=T.dataset.presetTab;if(!G)return;document.querySelectorAll(".preset-tab-button:not([disabled])").forEach(rt=>rt.classList.remove("active")),T.classList.add("active"),document.querySelectorAll(".preset-tab-panel").forEach(rt=>rt.classList.remove("active"));const X=document.getElementById(`${G}-panel`);X&&X.classList.add("active"),c(G);const z=document.querySelector(".harmonic-bins-container");z&&(G==="effects"?z.style.display="none":z.style.display="flex"),V(`preset tab click: ${G}`)};T.addEventListener("click",_),m.set(T,_)}),b.info("TabManagementBridge","Preset tabs initialized",null,"ui")}function dt(){f=document.querySelectorAll(".pitch-tab-button"),f.forEach(T=>{const _=()=>{const G=T.dataset.pitchTab;if(!G)return;document.querySelectorAll(".pitch-tab-button").forEach(z=>z.classList.remove("active")),T.classList.add("active"),document.querySelectorAll(".pitch-tab-panel").forEach(z=>z.classList.remove("active"));const X=document.getElementById(`${G}-panel`);X&&X.classList.add("active")};T.addEventListener("click",_),p.set(T,_)}),b.info("TabManagementBridge","Pitch tabs initialized",null,"ui")}Ie(()=>{mt(),vt(),dt(),window.logPresetEffectsSizing=(T="manual")=>{U(T)},window.enablePresetEffectsSizingAutoLog=()=>{window.enablePresetEffectsSizingDiagnostics=!0,Q()},window.disablePresetEffectsSizingAutoLog=()=>{window.enablePresetEffectsSizingDiagnostics=!1,D()},window.enablePresetEffectsSizingDiagnostics&&Q(),console.log("[Svelte] TabManagementBridge mounted")}),ke(()=>{g.forEach((T,_)=>{_.removeEventListener("click",T)}),g.clear(),m.forEach((T,_)=>{_.removeEventListener("click",T)}),m.clear(),p.forEach((T,_)=>{_.removeEventListener("click",T)}),p.clear(),console.log("[Svelte] TabManagementBridge unmounted")}),vs(),be()}function xf(n,t){ve(t,!0);const e=16,o={letter:{width:8.5,height:11},"11x14":{width:11,height:14},"11x17":{width:11,height:17}};let i=null,s=null,a=null,r=null,c=null,d=null,u=null,h=null,f=null,g=null,m=null,p=null,v=null,y=Tt(!1),w=Tt(null);const S=20,M=5;let P=null,E=null;function x(){l.state.isPrintPreviewActive||l.setPrintPreviewActive(!0),i?.classList.remove("hidden");const I=ot=>ot?getComputedStyle(ot).display!=="none":!1,$=l.state.printOptions.pageSize,O=$&&$ in o?$:"letter",q=I(document.getElementById("button-grid")),Z=I(document.getElementById("drum-grid-wrapper")),B=I(document.getElementById("legend-left-canvas")),J=I(document.getElementById("legend-right-canvas"));l.setPrintOptions({pageSize:O,cropTop:0,cropBottom:1,cropLeft:0,cropRight:1,includeButtonGrid:q,includeDrums:Z,includeLeftLegend:B,includeRightLegend:J}),q&&To.prefetchButtonGridSnapshot(B,J),N()}function A(){l.state.isPrintPreviewActive&&l.setPrintPreviewActive(!1),i?.classList.add("hidden")}function k(I,$){const q=l.state.printOptions[I]===$[0]?$[1]:$[0];l.setPrintOptions({[I]:q})}function C(){if([h,f,g,m,p,v].some(ut=>ut===null))return;const $=l.state.printOptions.pageSize,O=$&&$ in o?$:"letter",{orientation:q,colorMode:Z,includeButtonGrid:B,includeDrums:J,includeLeftLegend:ot,includeRightLegend:tt}=l.state.printOptions;u&&(u.value=O),h&&(h.textContent=q.charAt(0).toUpperCase()+q.slice(1)),f&&(f.textContent=Z==="color"?"Color":"B&W",f.classList.toggle("active",Z==="color")),g&&(g.textContent=B?"Include":"Exclude",g.classList.toggle("active",B)),m&&(m.textContent=J?"Include":"Exclude",m.classList.toggle("active",J)),p&&(p.textContent=ot?"Include":"Exclude",p.classList.toggle("active",ot)),v&&(v.textContent=tt?"Include":"Exclude",v.classList.toggle("active",tt))}async function N(){if(!l.state.isPrintPreviewActive||!s||!a)return;C();const I=d?.clientWidth??0,$=d?.clientHeight??0;if(I===0||$===0)return;const{orientation:O}=l.state.printOptions,q=l.state.printOptions.pageSize,Z=q&&q in o?q:"letter",B=o[Z],J=O==="landscape"?B.height:B.width,ot=O==="landscape"?B.width:B.height,tt=.25,ut=J/ot,pt=e*2;let bt=Math.max(I-pt,100),gt=Math.max($-pt,100);bt/gt>ut?bt=gt*ut:gt=bt/ut;const K=tt/J*bt,st=bt-2*K,ht=gt-2*K,Rt={...l.state.printOptions,cropTop:0,cropBottom:1,cropLeft:0,cropRight:1},Et=await To.generateScoreCanvas(Rt,{width:st,height:ht});if(!Et)return;s.width=bt,s.height=gt,a.fillStyle="#FFFFFF",a.fillRect(0,0,bt,gt),a.strokeStyle="#E0E0E0",a.lineWidth=1,a.strokeRect(K,K,st,ht);const le=K+Math.max(0,(st-Et.width)/2),Ke=K+Math.max(0,(ht-Et.height)/2);a.drawImage(Et,le,Ke),L(K,st,ht),W(bt,gt,{contentTop:Ke,contentLeft:le,contentWidth:Et.width,contentHeight:Et.height})}function L(I,$,O){if(!a)return;a.strokeStyle="#CCCCCC",a.lineWidth=1;const q=10,Z=I+$,B=I+O;a.beginPath(),a.moveTo(I,I-q),a.lineTo(I,I+q),a.moveTo(I-q,I),a.lineTo(I+q,I),a.moveTo(Z,I-q),a.lineTo(Z,I+q),a.moveTo(Z-q,I),a.lineTo(Z+q,I),a.moveTo(I,B-q),a.lineTo(I,B+q),a.moveTo(I-q,B),a.lineTo(I+q,B),a.moveTo(Z,B-q),a.lineTo(Z,B+q),a.moveTo(Z-q,B),a.lineTo(Z+q,B),a.stroke()}function W(I,$,O){const q=s?.getBoundingClientRect(),Z=d?.getBoundingClientRect();if(!q||!Z||!r||!c)return;r.width=I,r.height=$,r.style.left=`${q.left-Z.left}px`,r.style.top=`${q.top-Z.top}px`,r.style.width=`${I}px`,r.style.height=`${$}px`;const{cropTop:B,cropBottom:J,cropLeft:ot,cropRight:tt}=l.state.printOptions,{contentTop:ut,contentLeft:pt,contentHeight:bt,contentWidth:gt}=O,K=ut+B*bt,st=ut+J*bt,ht=pt+ot*gt,Rt=pt+tt*gt,Et=ut+bt,le=pt+gt;c.clearRect(0,0,I,$),c.fillStyle="rgba(0, 0, 0, 0.5)",B>0&&c.fillRect(pt,ut,gt,K-ut),J<1&&c.fillRect(pt,st,gt,Et-st),ot>0&&c.fillRect(pt,K,ht-pt,st-K),tt<1&&c.fillRect(Rt,K,le-Rt,st-K),H(K,pt,le,"top"),H(st,pt,le,"bottom"),Q(ht,ut,Et,"left"),Q(Rt,ut,Et,"right"),P={pageWidth:I,pageHeight:$,contentTop:ut,contentLeft:pt,contentHeight:bt,contentWidth:gt,cropTopY:K,cropBottomY:st,cropLeftX:ht,cropRightX:Rt}}function H(I,$,O,q){if(!c)return;const Z=60,B=O-$,J=$+(B-Z)/2,ot=q==="top"?I-S-4:I+4;c.fillStyle="#4a90e2",c.fillRect($,I-1,B,2),c.fillRect(J,ot,Z,S),c.strokeStyle="#FFFFFF",c.lineWidth=2,c.strokeRect(J,ot,Z,S),c.strokeStyle="#FFFFFF",c.lineWidth=1;const tt=3,ut=6,pt=30,bt=$+(B-pt)/2;for(let gt=0;gt<tt;gt++){const K=ot+S/2+(gt-1)*ut;c.beginPath(),c.moveTo(bt,K),c.lineTo(bt+pt,K),c.stroke()}}function Q(I,$,O,q){if(!c)return;const Z=60,B=O-$,J=$+(B-Z)/2,ot=q==="left"?I-S-4:I+4;c.fillStyle="#4a90e2",c.fillRect(I-1,$,2,B),c.fillRect(ot,J,S,Z),c.strokeStyle="#FFFFFF",c.lineWidth=2,c.strokeRect(ot,J,S,Z),c.strokeStyle="#FFFFFF",c.lineWidth=1;const tt=3,ut=6,pt=30,bt=$+(B-pt)/2;for(let gt=0;gt<tt;gt++){const K=ot+S/2+(gt-1)*ut;c.beginPath(),c.moveTo(K,bt),c.lineTo(K,bt+pt),c.stroke()}}function D(I){if(!P||!r)return;const $=r.getBoundingClientRect(),O=I.clientX-$.left,q=I.clientY-$.top,Z=O>=P.contentLeft&&O<=P.contentLeft+P.contentWidth,B=q>=P.contentTop&&q<=P.contentTop+P.contentHeight,J=Z&&Math.abs(q-P.cropTopY)<S+M,ot=Z&&Math.abs(q-P.cropBottomY)<S+M,tt=B&&Math.abs(O-P.cropLeftX)<S+M,ut=B&&Math.abs(O-P.cropRightX)<S+M;J?(ft(y,!0),ft(w,"top"),r.style.cursor="ns-resize"):ot?(ft(y,!0),ft(w,"bottom"),r.style.cursor="ns-resize"):tt?(ft(y,!0),ft(w,"left"),r.style.cursor="ew-resize"):ut&&(ft(y,!0),ft(w,"right"),r.style.cursor="ew-resize")}function U(I){if(!P||!r)return;const $=r.getBoundingClientRect(),O=I.clientX-$.left,q=I.clientY-$.top;if(nt(y)&&nt(w)){V(O,q);return}const Z=O>=P.contentLeft&&O<=P.contentLeft+P.contentWidth,B=q>=P.contentTop&&q<=P.contentTop+P.contentHeight,J=Z&&Math.abs(q-P.cropTopY)<S+M,ot=Z&&Math.abs(q-P.cropBottomY)<S+M,tt=B&&Math.abs(O-P.cropLeftX)<S+M,ut=B&&Math.abs(O-P.cropRightX)<S+M;J||ot?r.style.cursor="ns-resize":tt||ut?r.style.cursor="ew-resize":r.style.cursor="default"}function V(I,$){if(!P)return;const{contentTop:O,contentLeft:q,contentHeight:Z,contentWidth:B}=P,J=.05;if(nt(w)==="top"){const ot=Math.max(0,Math.min(1,($-O)/Z)),tt=l.state.printOptions.cropBottom;ot<tt-J&&l.setPrintOptions({cropTop:ot})}else if(nt(w)==="bottom"){const ot=Math.max(0,Math.min(1,($-O)/Z)),tt=l.state.printOptions.cropTop;ot>tt+J&&l.setPrintOptions({cropBottom:ot})}else if(nt(w)==="left"){const ot=Math.max(0,Math.min(1,(I-q)/B)),tt=l.state.printOptions.cropRight;ot<tt-J&&l.setPrintOptions({cropLeft:ot})}else if(nt(w)==="right"){const ot=Math.max(0,Math.min(1,(I-q)/B)),tt=l.state.printOptions.cropLeft;ot>tt+J&&l.setPrintOptions({cropRight:ot})}}function j(){ft(y,!1),ft(w,null),r&&(r.style.cursor="default")}function at(){A()}function mt(){To.generateAndPrint(),A()}function vt(){k("orientation",["landscape","portrait"])}function dt(){k("colorMode",["color","bw"])}function T(){k("includeButtonGrid",[!0,!1])}function _(){k("includeDrums",[!0,!1])}function G(){k("includeLeftLegend",[!0,!1])}function X(){k("includeRightLegend",[!0,!1])}function z(){if(!u)return;const I=u.value;I in o&&l.setPrintOptions({pageSize:I})}function rt(I){I!==void 0&&(I?x():A())}function R(){N()}function F(){l.state.isPrintPreviewActive&&N()}Ie(()=>{i=document.getElementById("print-preview-overlay"),s=document.getElementById("print-preview-canvas"),a=s?.getContext("2d")??null,r=document.getElementById("print-crop-overlay"),c=r?.getContext("2d")??null,d=s?.parentElement??null,u=document.getElementById("print-page-size"),h=document.getElementById("print-orientation-toggle"),f=document.getElementById("print-color-mode-toggle"),g=document.getElementById("print-button-grid-toggle"),m=document.getElementById("print-drum-grid-toggle"),p=document.getElementById("print-left-legend-toggle"),v=document.getElementById("print-right-legend-toggle"),document.getElementById("print-close-button")?.addEventListener("click",at),document.getElementById("print-confirm-button")?.addEventListener("click",mt),h?.addEventListener("click",vt),f?.addEventListener("click",dt),g?.addEventListener("click",T),m?.addEventListener("click",_),p?.addEventListener("click",G),v?.addEventListener("click",X),u?.addEventListener("change",z),r?.addEventListener("mousedown",D),r?.addEventListener("mousemove",U),r?.addEventListener("mouseup",j),r?.addEventListener("mouseleave",j),l.on("printPreviewStateChanged",rt),l.on("printOptionsChanged",R),l.on("notesChanged",F),d&&(E=new ResizeObserver(()=>{l.state.isPrintPreviewActive&&N()}),E.observe(d)),console.log("[Svelte] PrintPreviewBridge mounted")}),ke(()=>{document.getElementById("print-close-button")?.removeEventListener("click",at),document.getElementById("print-confirm-button")?.removeEventListener("click",mt),h?.removeEventListener("click",vt),f?.removeEventListener("click",dt),g?.removeEventListener("click",T),m?.removeEventListener("click",_),p?.removeEventListener("click",G),v?.removeEventListener("click",X),u?.removeEventListener("change",z),r?.removeEventListener("mousedown",D),r?.removeEventListener("mousemove",U),r?.removeEventListener("mouseup",j),r?.removeEventListener("mouseleave",j),E?.disconnect(),console.log("[Svelte] PrintPreviewBridge unmounted")}),be()}const Ef={"playback-controls":Om,"playback-controls-bridge":zm,"file-actions-bridge":$m,"grid-controls-bridge":Hm,"modulation-bridge":qm,"sidebar-bridge":nf,"tool-selector-bridge":df,"audio-controls-bridge":Cf,"tab-management-bridge":Af,"print-preview-bridge":xf},is=[];function Mf(){document.querySelectorAll("[data-svelte-component]").forEach(t=>{const e=t.getAttribute("data-svelte-component");if(!e)return;const o=Ef[e];if(!o){console.warn(`[Svelte] Unknown component: ${e}`);return}try{t.innerHTML="";const i=rc(o,{target:t});is.push({target:t,component:i}),console.log(`[Svelte] Mounted: ${e}`)}catch(i){console.error(`[Svelte] Failed to mount ${e}:`,i)}})}function Pf(){is.forEach(({component:n})=>{try{ac(n)}catch(t){console.error("[Svelte] Failed to unmount component:",t)}}),is.length=0}function Tf(){Dm.init(),Mf(),b.initSuccess("UiComponents")}function ti(n,t){if(!(typeof window>"u"||!window.__adsrFlowDebug)){if(t===void 0){console.log("[ADSR Flow]",n);return}console.log("[ADSR Flow]",n,t)}}const oe={container:null,parentContainer:null,sustainTrack:null,sustainThumb:null,multiSliderContainer:null,thumbA:null,thumbD:null,thumbR:null};function If(){return oe.container=document.querySelector("#adsr-envelope"),oe.parentContainer=oe.container?.closest(".adsr-container")||null,oe.sustainTrack=document.getElementById("sustain-slider-track"),oe.sustainThumb=document.getElementById("sustain-slider-thumb"),oe.multiSliderContainer=document.getElementById("multi-thumb-slider-container"),oe.thumbA=document.getElementById("thumb-a"),oe.thumbD=document.getElementById("thumb-d"),oe.thumbR=document.getElementById("thumb-r"),oe}const kf={init:If,get elements(){return oe}};function Zr(){return tl*l.state.adsrTimeAxisScale}function Jr(n,t){const e=l.state.timbres[t.currentColor];if(!e)return;const{sustain:o}=e.adsr,i=.01;n.d=Math.max(n.a+i,n.d),n.r=Math.max(n.d+i,n.r);const s=n.a,a=n.d-n.a,r=n.r-n.d;if(isNaN(s)||isNaN(a)||isNaN(r)){b.error("AdsrInteractions","NaN value detected before setting ADSR. Aborting update.",{newAttack:s,newDecay:a,newRelease:r},"audio");return}const c={attack:s,decay:a,release:r,sustain:o};l.setADSR(t.currentColor,c),ti("adsrInteractions:updateADSRFromAbsoluteTimes",{color:t.currentColor,adsr:c})}function Lf(n,t){let e=!1;const o=a=>{if(!e||!n.sustainTrack)return;const r=n.sustainTrack.getBoundingClientRect();let d=100-(a.clientY-r.top)/r.height*100;d=Math.max(0,Math.min(100,d));const h=(window.waveformVisualizer?.getNormalizedAmplitude()||1)*100;d=Math.min(d,h);const f=l.state.timbres[t.currentColor];if(!f)return;const g={...f.adsr,sustain:d/100};l.setADSR(t.currentColor,g),ti("adsrInteractions:sustainSlider",{color:t.currentColor,adsr:g})},i=a=>{e=!0,o(a)},s=()=>{e=!1};n.sustainTrack?.addEventListener("pointerdown",i),document.addEventListener("pointermove",o),document.addEventListener("pointerup",s)}function Nf(n,t){let e=null;const o=a=>{if(!e||!n.multiSliderContainer)return;const r=n.multiSliderContainer.getBoundingClientRect();let d=(a.clientX-r.left)/r.width*100;d=Math.max(0,Math.min(100,d));const u=d/100*Zr(),h=l.state.timbres[t.currentColor];if(!h)return;const{attack:f,decay:g,release:m}=h.adsr,p={a:f,d:f+g,r:f+g+m};e.id==="thumb-a"&&(p.a=u),e.id==="thumb-d"&&(p.d=u),e.id==="thumb-r"&&(p.r=u),Jr(p,t)},i=a=>{const r=a.target;r.classList.contains("time-slider-thumb")&&(e=r,o(a))},s=()=>{e=null};n.multiSliderContainer?.addEventListener("pointerdown",i),document.addEventListener("pointermove",o),document.addEventListener("pointerup",s)}function Rf(n,t){let e=null;const o=a=>{if(!e)return;const r=t.svgContainer,c=r.createSVGPoint();c.x=a.clientX,c.y=a.clientY;const d=r.getScreenCTM();if(!d)return;const u=c.matrixTransform(d.inverse());let h=u.x/t.width*100,f=1-u.y/t.height;h=Math.max(0,Math.min(100,h)),f=Math.max(0,Math.min(1,f));const g=h/100*Zr(),m=l.state.timbres[t.currentColor];if(!m)return;const{attack:p,decay:v,release:y}=m.adsr;let w=m.adsr.sustain;const S={a:p,d:p+v,r:p+v+y};switch(e.id){case"attack-node":S.a=g;break;case"decay-sustain-node":{S.d=g;const E=window.waveformVisualizer?.getNormalizedAmplitude()||1;w=Math.min(f,E);break}case"release-node":S.r=g;break}const M=l.state.timbres[t.currentColor];if(!M)return;const P=M.adsr.sustain;if(w!==P){const E={attack:p,decay:v,release:y,sustain:w};l.setADSR(t.currentColor,E),ti("adsrInteractions:nodeDragSustain",{color:t.currentColor,adsr:E})}Jr(S,t)},i=a=>{const r=a.target;r.classList.contains("adsr-node")&&(e=r,e.style.cursor="grabbing",o(a))},s=()=>{e&&(e.style.cursor="grab",e=null)};t.nodeLayer.addEventListener("pointerdown",i),document.addEventListener("pointermove",o),document.addEventListener("pointerup",s)}function Bf(n){const t=n.ui;Lf(t,n),Nf(t,n),Rf(t,n)}function Df(n,{width:t,height:e},o){for(;n.firstChild;)n.removeChild(n.firstChild);if(o>0){for(let r=1;r<=5;r++)if(r<=o){const c=r/o*t,d=document.createElementNS("http://www.w3.org/2000/svg","text");d.setAttribute("x",String(c)),d.setAttribute("y",String(e-5)),d.setAttribute("fill","#d0d0d0"),d.setAttribute("font-size","24"),d.setAttribute("font-weight","bold"),d.setAttribute("text-anchor","middle"),d.setAttribute("dominant-baseline","auto"),d.setAttribute("opacity","0.3"),d.textContent=`${r}s`,n.appendChild(d)}}const i=l.state.tempo;if(i<=0||o<=0)return;const s=30/i;let a=0;for(let r=s;r<o;r+=s){const c=r/o*t,d=document.createElementNS("http://www.w3.org/2000/svg","line");d.setAttribute("x1",String(c)),d.setAttribute("y1","0"),d.setAttribute("x2",String(c)),d.setAttribute("y2",String(e));const u=(a+1)%2===0;d.setAttribute("stroke",u?"#adb5bd":"#ced4da"),d.setAttribute("stroke-width",u?"1":"0.5"),d.setAttribute("stroke-dasharray","3,3"),n.appendChild(d),a++}}function _f(n,t,e,{height:o,width:i},s,a,r){for(;n.firstChild;)n.removeChild(n.firstChild);for(;t.firstChild;)t.removeChild(t.firstChild);if(e.length<4)return;const c=e[0],d=e[1],u=e[2],h=e[3];if(!c||!d||!u||!h)return;const f=l.state.colorPalette[s]||{primary:s,light:s},g=f.primary,m=f.light;let p={time:0,feedback:0};if(window.effectsCoordinator&&(p=window.effectsCoordinator.getEffectParameters(s,"delay")),r&&r.clearRect(0,0,i,o),(p.time||0)>0&&(p.feedback||0)>0&&a){const A=Math.max(.01,(p.time||0)/100*.5),k=Math.min(.95,(p.feedback||0)/100),C=.05;let N=k,L=0;for(;N>C&&L<10;){L++;const W=A*L/a*i,H=e.map(U=>({x:U.x+W,y:U.y})),Q=H[0],D=H[3];if(!(!Q||!D)){if(Q.x<i){const U=document.createElementNS("http://www.w3.org/2000/svg","polygon"),V=`${Q.x},${o} `+H.map(at=>`${at.x},${at.y}`).join(" ")+` ${Math.min(D.x,i)},${o}`;U.setAttribute("points",V),U.setAttribute("fill",me(m,.7*N)),U.setAttribute("class","delay-echo"),n.appendChild(U);const j=document.createElementNS("http://www.w3.org/2000/svg","polyline");j.setAttribute("points",H.map(at=>`${at.x},${at.y}`).join(" ")),j.setAttribute("stroke-width","2"),j.setAttribute("fill","none"),j.setAttribute("stroke",me(g,N)),j.setAttribute("class","delay-echo"),n.appendChild(j)}N*=k}}}const v=document.createElementNS("http://www.w3.org/2000/svg","polygon"),y=`0,${o} `+e.map(A=>`${A.x},${A.y}`).join(" ")+` ${i},${o}`;v.setAttribute("points",y),v.setAttribute("fill",me(m,.7)),n.appendChild(v);const w=document.createElementNS("http://www.w3.org/2000/svg","line");w.setAttribute("x1",String(c.x)),w.setAttribute("y1",String(c.y)),w.setAttribute("x2",String(d.x)),w.setAttribute("y2",String(d.y)),w.setAttribute("stroke",g),w.setAttribute("stroke-width","2"),n.appendChild(w);const S=document.createElementNS("http://www.w3.org/2000/svg","line");S.setAttribute("x1",String(d.x)),S.setAttribute("y1",String(d.y)),S.setAttribute("x2",String(u.x)),S.setAttribute("y2",String(u.y)),S.setAttribute("stroke",g),S.setAttribute("stroke-width","2"),n.appendChild(S);const M=1,P=document.createElementNS("http://www.w3.org/2000/svg","line");P.setAttribute("x1",String(u.x)),P.setAttribute("y1",String(u.y)),P.setAttribute("x2",String(h.x)),P.setAttribute("y2",String(h.y)),P.setAttribute("stroke",me(g,M)),P.setAttribute("stroke-width","2"),n.appendChild(P);const E=["attack-node","decay-sustain-node","release-node"];[d,u,h].forEach((A,k)=>{const C=document.createElementNS("http://www.w3.org/2000/svg","circle");C.setAttribute("id",E[k]),C.setAttribute("class","adsr-node"),C.setAttribute("cx",String(A.x)),C.setAttribute("cy",String(A.y)),C.setAttribute("r","8"),C.setAttribute("fill",g),C.setAttribute("stroke",Zo(g,-.3)),C.setAttribute("stroke-width","2"),C.style.cursor="grab";const N=document.createElementNS("http://www.w3.org/2000/svg","title");C.appendChild(N),t.appendChild(C)})}function Ff(n,t){if(!n)return;const e=Zo(t,-.2);n.style.setProperty("--c-accent",t),n.style.setProperty("--c-accent-hover",e)}const Mt={};let te=null,Qe=!1;function Wf(n,t){const e=document.createElementNS("http://www.w3.org/2000/svg","g");e.setAttribute("data-playhead-id",n);const o=document.createElementNS("http://www.w3.org/2000/svg","line");o.setAttribute("stroke",t),o.setAttribute("stroke-width","2"),o.setAttribute("stroke-dasharray","3,3"),e.appendChild(o);const i=document.createElementNS("http://www.w3.org/2000/svg","circle");return i.setAttribute("r","5"),i.setAttribute("fill",t),e.appendChild(i),e}function Of(n,t,e,o=null){if(!(!te||!o)){if(t==="attack"){Mt[n]&&(Mt[n].requestId!==null&&cancelAnimationFrame(Mt[n].requestId),Mt[n].group.remove());const i=Wf(n,e);te.playheadLayer.appendChild(i),Mt[n]={group:i,phase:t,color:e,adsr:o,requestId:null,startTimestamp:Pt(),elapsed:0},ks(n)}else if(t==="release"){if(Qe)return;const i=Mt[n];if(!i)return;i.requestId!==null&&cancelAnimationFrame(i.requestId),i.phase="release",i.adsr=o,i.startTimestamp=Pt(),i.elapsed=0,Ns(n)}}}function ks(n){if(!Mt[n]||Qe||!te)return;const t=Mt[n];if(!t.adsr)return;const{attack:e,decay:o}=t.adsr,i=te.calculateEnvelopePoints(t.adsr);if(i.length<4)return;const s=i[0],a=i[1],r=i[2],c=Pt()-t.startTimestamp;t.elapsed=c;const d=e+o,u=Math.min(c,d);let h,f;if(u<=e){const p=e>0?u/e:1;h=s.x+p*(a.x-s.x),f=s.y+p*(a.y-s.y)}else{const p=u-e,v=o>0?p/o:1;h=a.x+v*(r.x-a.x),f=a.y+v*(r.y-a.y)}const[g,m]=t.group.children;g.setAttribute("x1",String(h)),g.setAttribute("y1","0"),g.setAttribute("x2",String(h)),g.setAttribute("y2",String(te.height)),m.setAttribute("cx",String(h)),m.setAttribute("cy",String(f)),u<d?t.requestId=requestAnimationFrame(()=>ks(n)):(t.phase="sustain",Ls(n))}function Ls(n){if(!Mt[n]||Qe||!te)return;const t=Mt[n];if(!t.adsr)return;const e=te.calculateEnvelopePoints(t.adsr);if(e.length<4)return;const o=e[2],[i,s]=t.group.children;i.setAttribute("x1",String(o.x)),i.setAttribute("y1","0"),i.setAttribute("x2",String(o.x)),i.setAttribute("y2",String(te.height)),s.setAttribute("cx",String(o.x)),s.setAttribute("cy",String(o.y)),t.requestId=requestAnimationFrame(()=>Ls(n))}function Ns(n){if(!Mt[n]||Qe||!te)return;const t=Mt[n];if(!t.adsr)return;const{release:e}=t.adsr,o=te.calculateEnvelopePoints(t.adsr);if(o.length<4)return;const i=o[2],s=o[3],a=Pt()-t.startTimestamp;t.elapsed=a;const r=Math.min(a,e),c=e>0?r/e:1,d=i.x+c*(s.x-i.x),u=i.y+c*(s.y-i.y),[h,f]=t.group.children;h.setAttribute("x1",String(d)),h.setAttribute("y1","0"),h.setAttribute("x2",String(d)),h.setAttribute("y2",String(te.height)),f.setAttribute("cx",String(d)),f.setAttribute("cy",String(u)),r<e?t.requestId=requestAnimationFrame(()=>Ns(n)):(t.group.remove(),delete Mt[n])}function zf(){Qe=!0;for(const n in Mt){const t=Mt[n];t&&t.requestId!==null&&(cancelAnimationFrame(t.requestId),t.requestId=null)}}function $f(){Qe=!1;for(const n in Mt){const t=Mt[n];t&&(t.startTimestamp=Pt()-t.elapsed,t.phase==="attack"?ks(n):t.phase==="sustain"?Ls(n):t.phase==="release"&&Ns(n))}}function Hf(){Qe=!1;for(const n in Mt){const t=Mt[n];t&&(t.requestId!==null&&cancelAnimationFrame(t.requestId),t.group.remove())}for(const n in Mt)delete Mt[n]}function qf(n){return te=n,{trigger:Of,pause:zf,resume:$f,clearAll:Hf}}const Jt={adsrComponent:null},tl=2.5;class Gf{ui;currentColor;attack;decay;sustain;release;width;height;reverbCanvas=null;reverbCtx=null;svgContainer;gridLayer;envelopeLayer;nodeLayer;playheadLayer;playheadManager;constructor(){if(this.ui=kf.init(),!this.ui.container)throw b.error("AdsrComponent","ADSR container element not found",null,"adsr"),new Error("ADSR container element not found");this.currentColor=l.state.selectedNote?.color||"#4a90e2",this.attack=0,this.decay=0,this.sustain=0,this.release=0,this.width=0,this.height=0,this.createSVGLayers(),this.resize(),this.playheadManager=qf(this),Jt.adsrComponent=this,Bf(this),this.listenForStoreChanges(),this.initControls();const t=this.ui.container;t&&new ResizeObserver(()=>this.resize()).observe(t),this.updateFromStore(),b.info("ADSR Component","Initialized",null,"adsr")}resize(){if(this.ui.container){if(this.width=this.ui.container.clientWidth,this.height=this.ui.container.clientHeight,this.reverbCanvas){const t=window.devicePixelRatio||1;this.reverbCanvas.width=this.width*t,this.reverbCanvas.height=this.height*t,this.reverbCtx&&(this.reverbCtx.setTransform(1,0,0,1,0,0),this.reverbCtx.scale(t,t))}this.svgContainer&&this.svgContainer.setAttribute("viewBox",`0 0 ${this.width} ${this.height}`),this.render()}}updateFromStore(){const t=l.state.timbres[this.currentColor];if(!t)return;const{attack:e,decay:o,sustain:i,release:s}=t.adsr;this.attack=e,this.decay=o,this.sustain=i,this.release=s,this.render(),this.updateControls()}getCurrentMaxTime(){return tl*l.state.adsrTimeAxisScale}initControls(){const t=document.getElementById("adsr-time-scale"),e=document.getElementById("adsr-time-scale-value");t&&e&&(t.value=String(l.state.adsrTimeAxisScale),e.textContent=`${l.state.adsrTimeAxisScale}x`,t.addEventListener("input",o=>{const i=o.currentTarget;if(!i)return;const s=parseFloat(i.value);Number.isFinite(s)&&(l.setAdsrTimeAxisScale(s),e.textContent=`${s}x`)}))}listenForStoreChanges(){l.on("noteChanged",t=>{const e=t?.newNote?.color;e&&e!==this.currentColor&&(this.currentColor=e,this.updateFromStore())}),l.on("timbreChanged",t=>{t===this.currentColor&&this.updateFromStore()}),l.on("tempoChanged",()=>this.render()),l.on("adsrTimeAxisScaleChanged",()=>{this.render(),this.updateControls()}),l.on("tremoloAmplitudeUpdate",t=>{t?.activeColors?.includes(this.currentColor)&&this.render()}),l.on("playbackStateChanged",t=>{if(!t)return;const{isPlaying:e,isPaused:o}=t;e?o?this.playheadManager.pause():this.playheadManager.resume():this.playheadManager.clearAll()}),l.on("audioEffectChanged",t=>{if(!t)return;const{effectType:e,color:o}=t;o===this.currentColor&&(e==="delay"||e==="reverb")&&this.render()})}createSVGLayers(){this.ui.container&&(this.reverbCanvas=document.createElement("canvas"),this.reverbCanvas.className="adsr-reverb-canvas",this.reverbCanvas.style.position="absolute",this.reverbCanvas.style.top="0",this.reverbCanvas.style.left="0",this.reverbCanvas.style.width="100%",this.reverbCanvas.style.height="100%",this.reverbCanvas.style.pointerEvents="none",this.ui.container.appendChild(this.reverbCanvas),this.reverbCtx=this.reverbCanvas.getContext("2d"),this.svgContainer=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svgContainer.setAttribute("width","100%"),this.svgContainer.setAttribute("height","100%"),this.ui.container.appendChild(this.svgContainer),this.gridLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.gridLayer),this.envelopeLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.envelopeLayer),this.nodeLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.nodeLayer),this.playheadLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.playheadLayer))}calculateEnvelopePoints(t){const{attack:e,decay:o,sustain:i,release:s}=t??{attack:this.attack,decay:this.decay,sustain:this.sustain,release:this.release};if(!this.width||!this.height)return[];const a=p=>p/this.getCurrentMaxTime()*this.width;let r=1;const c=window.animationEffectsManager;c?.shouldTremoloBeRunning?.()&&(r=c.getADSRTremoloAmplitudeMultiplier(this.currentColor));const d=window.waveformVisualizer?.calculatedAmplitude??1,u=d*r;b.debug("AdsrComponent","[ADSR] Amplitude calculation",{originalAmplitude:d,tremoloMultiplier:r,normalizedAmplitude:u});const h={x:0,y:this.height},f={x:a(e),y:this.height*(1-u)},g={x:a(e+o),y:this.height*(1-Math.min(i*u,u))},m={x:a(e+o+s),y:this.height};return[h,f,g,m]}render(){if(!this.width||!this.height||!this.gridLayer||!this.envelopeLayer||!this.nodeLayer)return;const t={width:this.width,height:this.height},e=this.calculateEnvelopePoints(),o=this.getCurrentMaxTime();Df(this.gridLayer,t,o),_f(this.envelopeLayer,this.nodeLayer,e,t,this.currentColor,o,this.reverbCtx),Ff(this.ui.parentContainer,this.currentColor)}updateControls(){const{sustainThumb:t,sustainTrack:e,thumbA:o,thumbD:i,thumbR:s,multiSliderContainer:a}=this.ui;if(!t||!e||!o||!i||!s||!a)return;const r=l.state.timbres[this.currentColor];if(!r)return;let c=1;const d=window.animationEffectsManager;d?.shouldTremoloBeRunning?.()&&(c=d.getADSRTremoloAmplitudeMultiplier(this.currentColor));const h=(window.waveformVisualizer?.calculatedAmplitude||1)*c,f=h*100;if(this.sustain>h){const A={...r.adsr,sustain:h};l.setADSR(this.currentColor,A),ti("adsrComponent:clampSustain",{color:this.currentColor,adsr:A,normalizedAmplitude:h}),this.sustain=h}const g=this.sustain*100;t.style.bottom=`${g}%`,e.style.setProperty("--sustain-progress",`${g}%`);const m=100-f;e.style.setProperty("--ineligible-height",`${m}%`);const p=this.getCurrentMaxTime(),v=this.attack/p*100,y=(this.attack+this.decay)/p*100,w=(this.attack+this.decay+this.release)/p*100;o.style.left=`${v}%`,i.style.left=`${y}%`,s.style.left=`${w}%`,a.style.setProperty("--adr-progress",`${w}%`);const S=A=>`${A.toFixed(3)}s`,M=A=>`${(A*100).toFixed(0)}%`;o.title=`Attack: ${S(this.attack)}`,i.title=`Decay: ${S(this.decay)}`,s.title=`Release: ${S(this.release)}`,t.title=`Sustain: ${M(this.sustain)}`;const P=this.nodeLayer.querySelector("#attack-node > title");P&&(P.textContent=`Attack: ${S(this.attack)}`);const E=this.nodeLayer.querySelector("#decay-sustain-node > title");E&&(E.textContent=`Decay: ${S(this.decay)}
Sustain: ${M(this.sustain)}`);const x=this.nodeLayer.querySelector("#release-node > title");x&&(x.textContent=`Release: ${S(this.release)}`)}}function Vf(){return document.getElementById("adsr-envelope")?new Gf:null}function ss(n,...t){}let on,to,De,eo,$n,Hn,bn,as=!1,rs=!1,ls=!1,Xt;const Ho=1,el=31,nl=0,qo=2;function Xf(){if(!Xt)return null;const n=l.state.timbres[Xt];return n?(n.filter?n.filter.enabled===void 0&&(n.filter.enabled=!0):n.filter={enabled:!0,blend:1,cutoff:16,resonance:0,type:"lowpass",mix:0},n.filter):null}function Pi(){const n=Xf();if(!n)return;const{cutoff:t=16,blend:e=0,mix:o=0}=n;if(on&&to){const i=(qo-e)/(qo-nl);on.style.left=`${i*100}%`,to.style.setProperty("--progress",`${i*100}%`)}if(Hn&&bn){const i=(o||0)/100;Hn.style.bottom=`${i*100}%`,bn.style.setProperty("--blend-progress",`${i*100}%`)}if(De&&eo){const i=(t-Ho)/(el-Ho);De.style.left=`${i*100}%`,De.style.top="50%",De.style.transform="translate(-50%, -50%)",eo.style.setProperty("--progress",`${i*100}%`)}$n&&Xt&&$n.style.setProperty("--c-accent",Xt)}function Uf(n){if(!as||!Xt||!eo)return;const t=eo.getBoundingClientRect(),e=n.clientX-t.left,o=t.width;let i=e/o;i=Math.max(0,Math.min(1,i));const s=i*(el-Ho)+Ho;l.setFilterSettings(Xt,{cutoff:s})}function Yf(n){if(!rs||!Xt||!to)return;const t=to.getBoundingClientRect(),e=n.clientX-t.left,o=t.width;let i=e/o;i=Math.max(0,Math.min(1,i));const s=qo-i*(qo-nl);l.setFilterSettings(Xt,{blend:s})}function jf(n){if(!ls||!Xt||!bn)return;const t=bn.getBoundingClientRect(),e=n.clientY-t.top,o=t.height;let i=1-e/o;i=Math.max(0,Math.min(1,i));const s=i*100;l.setFilterSettings(Xt,{mix:s})}function Qf(){if($n=document.querySelector(".filter-container"),on=document.getElementById("thumb-b"),to=document.getElementById("blend-slider-container"),De=document.getElementById("thumb-c"),eo=document.getElementById("cutoff-slider-container"),!$n||!on||!De){b.error("FilterControls","Missing required elements",{container:$n,blendThumb:on,cutoffThumb:De},"filter");return}Kf(),on.addEventListener("pointerdown",n=>{n.preventDefault(),rs=!0,document.body.style.cursor="ew-resize";const t=o=>{ss("log","[BLEND SLIDER] Moving",{clientX:o.clientX}),Yf(o)},e=()=>{rs=!1,document.body.style.cursor="default",window.removeEventListener("pointermove",t),window.removeEventListener("pointerup",e),l.recordState()};window.addEventListener("pointermove",t),window.addEventListener("pointerup",e)}),De.addEventListener("pointerdown",n=>{n.preventDefault(),as=!0,document.body.style.cursor="ew-resize";const t=o=>{ss("log","[CUTOFF SLIDER] Moving",{clientX:o.clientX}),Uf(o)},e=()=>{as=!1,document.body.style.cursor="default",window.removeEventListener("pointermove",t),window.removeEventListener("pointerup",e),l.recordState()};window.addEventListener("pointermove",t),window.addEventListener("pointerup",e)}),l.on("noteChanged",({newNote:n}={})=>{n?.color&&n.color!==Xt&&(Xt=n.color,Pi())}),l.on("timbreChanged",n=>{n&&n===Xt&&Pi()}),Xt=l.state.selectedNote?.color||"#4a90e2",Pi()}function Kf(){if(bn=document.getElementById("vertical-blend-track"),Hn=document.getElementById("vertical-blend-thumb"),!bn||!Hn){b.error("FilterControls","Vertical blend slider elements not found",null,"filter");return}Hn.addEventListener("pointerdown",n=>{n.preventDefault(),ls=!0,document.body.style.cursor="ns-resize";const t=o=>{ss("log","[VERTICAL BLEND] Moving",{clientY:o.clientY}),jf(o)},e=()=>{ls=!1,document.body.style.cursor="default",window.removeEventListener("pointermove",t),window.removeEventListener("pointerup",e),l.recordState()};window.addEventListener("pointermove",t),window.addEventListener("pointerup",e)})}const Ti=()=>window.synthEngine??null,Oa=()=>window.animationEffectsManager??null;b.moduleLoaded("DynamicWaveformVisualizer");class Zf{canvas=null;ctx=null;currentColor=null;isPlaybackActive=!1;liveAnalysers=new Map;liveWaveforms=new Map;playbackAnimationId=null;animationSpeed=100;frameSkipCounter=0;onWaveformUpdate;initialize(t,e){return this.canvas=t,this.ctx=e,this.currentColor=l.state.selectedNote?.color||"#4a90e2",this.setupEventListeners(),b.info("DynamicWaveformVisualizer","Initialized with canvas context",null,"waveform"),!0}setupEventListeners(){l.on("noteChanged",({newNote:t}={})=>{t?.color&&t.color!==this.currentColor&&(this.currentColor=t.color)}),l.on("playbackStateChanged",({isPlaying:t=!1,isPaused:e=!1}={})=>{t&&!e?this.startLiveVisualization():this.stopLiveVisualization()}),l.on("spacebarPlayback",({color:t,isPlaying:e=!1}={})=>{e&&t?this.startSingleNoteVisualization(t):this.stopLiveVisualization()}),l.on("tremoloAmplitudeUpdate",({activeColors:t}={})=>{this.isPlaybackActive&&t?.some(e=>this.liveWaveforms.has(e))&&b.debug("DynamicWaveformVisualizer","Tremolo update received for active colors",t,"waveform")}),b.info("DynamicWaveformVisualizer","Event subscriptions established",null,"waveform")}setAnimationSpeed(t){this.animationSpeed=t,this.frameSkipCounter=0}startLiveVisualization(){this.isPlaybackActive||(this.isPlaybackActive=!0,this.setupLiveAnalysers(),this.updateContainerState(!0),this.animateLiveWaveforms(),b.debug("DynamicWaveformVisualizer","Started live visualization",null,"waveform"))}startSingleNoteVisualization(t){this.isPlaybackActive||(this.isPlaybackActive=!0,this.setupSingleAnalyser(t),this.updateContainerState(!0),this.animateLiveWaveforms(),b.debug("DynamicWaveformVisualizer",`Started single note visualization for ${t}`,null,"waveform"))}stopLiveVisualization(){this.isPlaybackActive=!1;const t=Ti();this.liveAnalysers.forEach((e,o)=>{t?.removeWaveformAnalyzer?.(o)}),this.liveAnalysers.clear(),this.liveWaveforms.clear(),this.playbackAnimationId&&(cancelAnimationFrame(this.playbackAnimationId),this.playbackAnimationId=null),this.updateContainerState(!1),b.debug("DynamicWaveformVisualizer","Stopped live visualization",null,"waveform")}updateContainerState(t){const e=this.canvas?.parentElement;e&&(t?(e.classList.add("live-mode"),l.state.isPlaying&&!l.state.isPaused&&e.classList.add("pulsing")):e.classList.remove("live-mode","pulsing"))}setupLiveAnalysers(){const t=Ti();if(!t){b.warn("DynamicWaveformVisualizer","SynthEngine not available for live analysis",null,"waveform");return}this.getActivePlayingColors().forEach(o=>{const i=t.createWaveformAnalyzer?.(o);i&&(this.liveAnalysers.set(o,i),this.liveWaveforms.set(o,new Float32Array(1024)),b.debug("DynamicWaveformVisualizer",`Created analyser for ${o}`,null,"waveform"))})}setupSingleAnalyser(t){const e=Ti();if(!e)return;const o=e.createWaveformAnalyzer?.(t);o&&(this.liveAnalysers.set(t,o),this.liveWaveforms.set(t,new Float32Array(1024)),b.debug("DynamicWaveformVisualizer",`Created single analyser for ${t}`,null,"waveform"))}getActivePlayingColors(){const t=new Set,e=l.state.placedNotes;l.state.isPlaying&&e.forEach(i=>{!i.isDrum&&i.color&&t.add(i.color)}),t.size===0&&this.currentColor&&t.add(this.currentColor);const o=Array.from(t);return b.debug("DynamicWaveformVisualizer","Active playing colors detected",o,"waveform"),o}animateLiveWaveforms(){if(!this.isPlaybackActive)return;this.frameSkipCounter++;const t=Math.max(1,Math.floor(100/Math.max(this.animationSpeed,1)));if(this.frameSkipCounter%t!==0){this.playbackAnimationId=requestAnimationFrame(()=>this.animateLiveWaveforms());return}this.liveAnalysers.forEach((e,o)=>{const i=e.getValue();this.liveWaveforms.set(o,i)}),this.onWaveformUpdate?.(),this.playbackAnimationId=requestAnimationFrame(()=>this.animateLiveWaveforms())}drawLiveWaveforms(t,e,o){if(!this.ctx)return;const s=Array.from(this.liveWaveforms.keys());if(s.length===1){const a=s[0];if(!a)return;const r=this.liveWaveforms.get(a);this.drawSingleLiveWaveform(r,a,t,e,o)}else s.length>1&&s.forEach(a=>{if(!a)return;const r=this.liveWaveforms.get(a);this.drawLayeredLiveWaveform(r,a,t,e,o,s.length)})}drawSingleLiveWaveform(t,e,o,i,s){const a=this.ctx;if(!a||!t||t.length===0)return;const r=Oa();let c=s;if(r){const v=r.getTremoloAmplitudeMultiplier(e);c*=v}let d=0;const u=r?.vibratoCanvasEffect,h=u?.animations.get(e);u&&h&&u.shouldBeRunning()&&(d=Math.sin(h.phase)*h.amplitude*.4);let f=0;for(let v=0;v<t.length;v++){const y=t[v]??0;f=Math.max(f,Math.abs(y))}const g=f>1?1/f:1;a.strokeStyle=e,a.lineWidth=2,a.beginPath();const p=t.length/o*(1+d);for(let v=0;v<o;v++){const y=d*o*.3,w=v+y,S=Math.floor(w*p),M=Math.max(0,Math.min(t.length-1,S)),P=(t[M]??0)*g,E=i-P*c;v===0?a.moveTo(v,E):a.lineTo(v,E)}a.stroke(),b.debug("DynamicWaveformVisualizer",`Drew single live waveform for ${e} with tremolo and vibrato stretch`,{amplitudeRatio:c/s,vibratoStretch:d},"waveform")}drawLayeredLiveWaveform(t,e,o,i,s,a){const r=this.ctx;if(!r||!t||t.length===0)return;const c=Oa();let d=s;c&&(d*=c.getTremoloAmplitudeMultiplier(e));let u=0;const h=c?.vibratoCanvasEffect,f=h?.animations.get(e);h&&f&&h.shouldBeRunning()&&(u=Math.sin(f.phase)*f.amplitude*.4);let g=0;for(let w=0;w<t.length;w++){const S=t[w]??0;g=Math.max(g,Math.abs(S))}const m=g>1?1/g:1,p=Math.max(.4,1/a);r.strokeStyle=me(e,p*2),r.lineWidth=1.5,r.beginPath();const y=t.length/o*(1+u);for(let w=0;w<o;w++){const S=u*o*.3,M=w+S,P=Math.floor(M*y),E=Math.max(0,Math.min(t.length-1,P)),x=(t[E]??0)*m,A=i-x*d*.7;w===0?r.moveTo(w,A):r.lineTo(w,A)}r.stroke()}isLiveMode(){return this.isPlaybackActive}getLiveColors(){return Array.from(this.liveWaveforms.keys())}dispose(){this.stopLiveVisualization(),b.info("DynamicWaveformVisualizer","Disposed",null,"waveform")}}const Jf=512,qe=360,En=480,tp=()=>window.animationEffectsManager;b.moduleLoaded("StaticWaveformVisualizer");class ep{canvas=null;ctx=null;currentColor=null;animationFrameId=null;waveformData=new Float32Array(Jf);isInitialized=!1;isTransitioning=!1;transitionStartTime=0;transitionDuration=300;fromWaveform=null;toWaveform=null;transitionAnimationId=null;dynamicVisualizer=new Zf;animationSpeed=100;frameSkipCounter=0;resizeObserver=null;calculatedAmplitude=0;constructor(){b.info("StaticWaveformVisualizer","Initialized with dynamic visualizer integration",null,"waveform")}initialize(){if(this.canvas=document.getElementById("static-waveform-canvas"),!this.canvas)return!1;const t=this.canvas.getContext("2d");if(!t)return!1;this.ctx=t,this.currentColor=l.state.selectedNote?.color||"#4a90e2";const e=this.canvas.parentElement;return e&&typeof ResizeObserver<"u"&&(this.resizeObserver?.disconnect(),this.resizeObserver=new ResizeObserver(()=>this.resize()),this.resizeObserver.observe(e)),this.resize(),this.setupEventListeners(),this.dynamicVisualizer.initialize(this.canvas,this.ctx),this.dynamicVisualizer.onWaveformUpdate=()=>this.draw(),this.generateWaveform(),this.isInitialized=!0,!0}resize(){if(!this.canvas||!this.ctx)return;const t=this.canvas.parentElement;if(!t)return;const{clientWidth:e,clientHeight:o}=t,i=this.canvas.width,s=this.canvas.height;if((e===0||o===0)&&this.canvas.width>0&&this.canvas.height>0)return;const r=Math.abs(e-i),c=Math.abs(o-s);(r>2||c>2)&&(this.canvas.width=e,this.canvas.height=o,this.draw())}setupEventListeners(){l.on("noteChanged",(e={})=>{const o=e.newNote?.color;o&&o!==this.currentColor&&(this.currentColor=o,this.generateWaveform())}),l.on("timbreChanged",e=>{e&&e===this.currentColor&&this.generateWaveform()}),l.on("waveformExtendedViewChanged",()=>{this.generateWaveform(),this.updateToggleButton()}),document.querySelectorAll(".tab-button").forEach(e=>{e.addEventListener("click",()=>{e.dataset.tab==="timbre"&&setTimeout(()=>this.resize(),100)})}),this.setupSpeedControls(),this.setupExtendToggle()}setupSpeedControls(){const t=Array.from(document.querySelectorAll(".waveform-speed-btn"));t.length!==0&&t.forEach(e=>{e.addEventListener("click",()=>{const o=e.dataset.speed,i=o?parseInt(o,10):NaN;Number.isFinite(i)&&(e.classList.contains("active")?(e.classList.remove("active"),this.setAnimationSpeed(100)):(t.forEach(s=>s.classList.remove("active")),e.classList.add("active"),this.setAnimationSpeed(i)))})})}setAnimationSpeed(t){Number.isFinite(t)&&(this.animationSpeed=t,this.frameSkipCounter=0,this.dynamicVisualizer.setAnimationSpeed(t))}setupExtendToggle(){const t=document.getElementById("waveform-extend-toggle");t instanceof HTMLElement&&(t.addEventListener("click",()=>{l.toggleWaveformExtendedView()}),this.updateToggleButton())}updateToggleButton(){const t=document.getElementById("waveform-extend-toggle");if(!(t instanceof HTMLElement))return;const e=l.state.waveformExtendedView;t.classList.toggle("extended",e),t.textContent=e?"480 View":"360 View",t.title=e?"Switch to 360 waveform view":"Switch to 480 waveform view (shows extra 120)"}generateWaveform(){if(this.isTransitioning||!this.currentColor)return;const t=l.state.timbres[this.currentColor];if(!t?.coeffs)return;const e=Qi(this.currentColor),o=t.phases??new Float32Array(un),i=this.waveformData.length;this.waveformData.fill(0);let s=0;for(let a=0;a<i;a++){const c=(l.state.waveformExtendedView?En:qe)/qe,d=a/i*c*2*Math.PI;let u=0;for(let h=0;h<un;h++){const f=e[h]??0;if(f<=.001)continue;const g=o[h]??0,m=h+1;u+=f*Math.sin(m*d+g)}this.waveformData[a]=u,s=Math.max(s,Math.abs(u))}if(this.calculatedAmplitude=Math.min(1,s),s>1){const a=1/s;for(let r=0;r<this.waveformData.length;r++){const c=this.waveformData[r]??0;this.waveformData[r]=c*a}}this.draw()}startPhaseTransition(t,e,o){!this.isInitialized||!this.currentColor||(this.isTransitioning&&this.transitionAnimationId&&cancelAnimationFrame(this.transitionAnimationId),this.fromWaveform=new Float32Array(this.waveformData),this.generateTargetWaveform(e),this.toWaveform=new Float32Array(this.waveformData),this.waveformData=this.fromWaveform,this.isTransitioning=!0,this.transitionStartTime=performance.now(),this.animateTransition())}generateTargetWaveform(t){if(!this.currentColor||!t||!l.state.timbres[this.currentColor]?.coeffs)return;const o=Qi(this.currentColor),i=t instanceof Float32Array?t:new Float32Array(t),s=this.waveformData.length;this.waveformData.fill(0);let a=0;for(let r=0;r<s;r++){const d=(l.state.waveformExtendedView?En:qe)/qe,u=r/s*d*2*Math.PI;let h=0;for(let f=0;f<un;f++){const g=o[f]??0;if(g<=.001)continue;const m=i[f]??0,p=f+1;h+=g*Math.sin(p*u+m)}this.waveformData[r]=h,a=Math.max(a,Math.abs(h))}if(this.calculatedAmplitude=Math.min(1,a),a>1){const r=1/a;for(let c=0;c<this.waveformData.length;c++){const d=this.waveformData[c]??0;this.waveformData[c]=d*r}}}animateTransition(){const t=this.fromWaveform,e=this.toWaveform;if(!this.isTransitioning||!t||!e)return;const o=performance.now()-this.transitionStartTime,i=Math.min(o/this.transitionDuration,1),s=1-Math.pow(1-i,3);for(let a=0;a<this.waveformData.length;a++){const r=t[a]??0,c=e[a]??0;this.waveformData[a]=r+(c-r)*s}this.draw(),i>=1?(this.isTransitioning=!1,this.fromWaveform=null,this.toWaveform=null,this.transitionAnimationId=null):this.transitionAnimationId=requestAnimationFrame(()=>this.animateTransition())}normalizeWaveform(){let t=0;for(let e=0;e<this.waveformData.length;e++){const o=this.waveformData[e]??0;t=Math.max(t,Math.abs(o))}if(t>0){const e=.9/t;for(let o=0;o<this.waveformData.length;o++){const i=this.waveformData[o]??0;this.waveformData[o]=i*e}}}draw(){const t=this.ctx,e=this.canvas;if(!t||!e)return;const{width:o,height:i}=e,s=i/2,a=i/2;t.fillStyle="#ffffff",t.fillRect(0,0,o,i),this.drawGrid(o,i,s,a),this.dynamicVisualizer.isLiveMode()?this.dynamicVisualizer.drawLiveWaveforms(o,s,a):this.drawWaveform(o,s,a),o>200&&i>100&&this.drawLabels(o,i)}drawGrid(t,e,o,i){const s=this.ctx;if(!s)return;s.strokeStyle="#ced4da",s.lineWidth=1,s.setLineDash([2,2]),s.beginPath(),s.moveTo(0,o),s.lineTo(t,o),s.stroke();const a=l.state.waveformExtendedView?En:qe;if((l.state.waveformExtendedView?[90,180,270,360,450]:[90,180,270]).forEach(h=>{const f=t/a*h;s.beginPath(),s.moveTo(f,0),s.lineTo(f,e),s.stroke()}),l.state.waveformExtendedView){const h=t/En*qe;s.fillStyle="rgba(128, 128, 128, 0.15)",s.fillRect(h,0,t-h,e)}[.5].forEach(h=>{const f=o-i*h,g=o+i*h;s.beginPath(),s.moveTo(0,f),s.lineTo(t,f),s.moveTo(0,g),s.lineTo(t,g),s.stroke()}),s.setLineDash([]),s.strokeStyle="#999999",s.lineWidth=1;const d=o-i,u=o+i;s.beginPath(),s.moveTo(0,d),s.lineTo(t,d),s.stroke(),s.beginPath(),s.moveTo(0,u),s.lineTo(t,u),s.stroke()}drawWaveform(t,e,o){const i=this.ctx;if(!i||this.waveformData.length===0)return;const s=this.currentColor||"#4a90e2";i.strokeStyle=s,i.lineWidth=2,i.beginPath();const a=this.waveformData.length/t;for(let c=0;c<t;c++){const d=Math.floor(c*a),u=this.waveformData[d]||0,h=e-u*o;c===0?i.moveTo(c,h):i.lineTo(c,h)}i.stroke(),i.lineTo(t,e),i.lineTo(0,e),i.closePath();const r=i.createLinearGradient(0,e-o,0,e+o);r.addColorStop(0,me(s,.3)),r.addColorStop(.5,me(s,.1)),r.addColorStop(1,me(s,.3)),i.fillStyle=r,i.fill()}drawLabels(t,e){const o=this.ctx;if(!o)return;const i=l.state.waveformExtendedView,s=i?En:qe,a=i?["0","90","180","270","360","450"]:["0","90","180","270","360"],r=i?[0,90,180,270,360,450]:[0,90,180,270,360];o.fillStyle="#666666",o.font='12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',o.textAlign="center",a.forEach((c,d)=>{const u=r[d]??0,h=t/s*u+10;o.fillText(c,h,e/2+4)}),o.textAlign="left",o.fillText("+1.0",5,15),o.fillText("-1.0",5,e-8)}getNormalizedAmplitude(){return this.calculatedAmplitude||0}getADSRTremoloAmplitude(){const t=this.calculatedAmplitude||0,e=tp();if(this.currentColor&&e?.getADSRTremoloAmplitudeMultiplier){const o=e.getADSRTremoloAmplitudeMultiplier(this.currentColor);return t*o}return t}startSingleNoteVisualization(t){this.dynamicVisualizer.startSingleNoteVisualization(t)}stopLiveVisualization(){this.dynamicVisualizer.stopLiveVisualization()}startLiveVisualization(){this.dynamicVisualizer.startLiveVisualization()}dispose(){this.dynamicVisualizer.dispose(),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.transitionAnimationId&&(cancelAnimationFrame(this.transitionAnimationId),this.transitionAnimationId=null),this.resizeObserver?.disconnect(),this.resizeObserver=null,this.isTransitioning=!1,this.fromWaveform=null,this.toWaveform=null,this.isInitialized=!1}}const ol=new ep;window.waveformVisualizer=ol;function np(){return ol.initialize()}class Rs{effectName;animations;activeNoteAnimations;ghostNoteAnimation;activeSoundingNotes;isPlaybackActive;hasActiveInteraction;hasDialInteraction;constructor(t){this.effectName=t,this.animations=new Map,this.activeNoteAnimations=new Map,this.ghostNoteAnimation=null,this.activeSoundingNotes=new Map,this.isPlaybackActive=!1,this.hasActiveInteraction=!1,this.hasDialInteraction=!1,b.info(`${t}AnimationEffect`,"Base initialized",null,"animation")}initBase(){l.on("visualEffectChanged",t=>{if(!t)return;const{effectType:e,color:o,effectParams:i}=t;e===this.effectName.toLowerCase()&&this.updateAnimationParameters(o,i)}),l.on("playbackStarted",()=>{this.isPlaybackActive=!0,this.requestAnimationStateUpdate()}),l.on("playbackStopped",()=>{this.isPlaybackActive=!1,this.activeNoteAnimations.clear(),this.activeSoundingNotes.clear(),this.requestAnimationStateUpdate()}),l.on("noteInteractionStart",t=>{t&&this.onNoteInteractionStart(t.noteId,t.color)}),l.on("noteInteractionEnd",t=>{const e=t?.noteId;e&&this.onNoteInteractionEnd(e)}),l.on("ghostNoteUpdated",t=>{t&&this.onGhostNoteUpdated(t.color)}),l.on("ghostNoteCleared",()=>this.onGhostNoteCleared()),l.on("spacebarPlayback",t=>{t&&(this.isPlaybackActive=t.isPlaying,this.requestAnimationStateUpdate())}),l.on("noteAttack",t=>{t&&this.onNoteAttack(t.noteId,t.color)}),l.on("noteRelease",t=>{t&&this.onNoteRelease(t.noteId,t.color)}),l.on("effectDialInteractionStart",t=>{t&&t.effectType===this.effectName.toLowerCase()&&this.onDialInteractionStart(t.color)}),l.on("effectDialInteractionEnd",t=>{t&&t.effectType===this.effectName.toLowerCase()&&this.onDialInteractionEnd(t.color)}),b.info(`${this.effectName}AnimationEffect`,"Base event subscriptions established",null,"animation")}shouldAnimateColor(t){return this.animations.has(t)}shouldAnimateNote(t){if(!t?.color||!this.shouldAnimateColor(t.color))return!1;if(this.hasDialInteraction&&this.activeNoteAnimations.has("dial-preview")){const e=this.activeNoteAnimations.get("dial-preview");if(e&&t.color===e)return!0}return!!(this.isPlaybackActive&&t.uuid&&this.activeSoundingNotes.has(t.uuid)||this.hasActiveInteraction&&t.uuid&&this.activeNoteAnimations.has(t.uuid)||!t.uuid&&this.ghostNoteAnimation&&this.ghostNoteAnimation.color===t.color&&this.isPlaybackActive)}shouldBeRunning(){const t=this.animations.size>0;return t?!!(this.isPlaybackActive||this.hasActiveInteraction||this.hasDialInteraction||this.ghostNoteAnimation!==null||t):!1}onNoteInteractionStart(t,e){this.shouldAnimateColor(e)&&(this.activeNoteAnimations.set(t,e),this.hasActiveInteraction=!0,b.debug(`${this.effectName}AnimationEffect`,`Started interaction animation for note ${t} (${e})`,null,"animation"),this.requestAnimationStateUpdate())}onNoteInteractionEnd(t){this.activeNoteAnimations.delete(t),this.hasActiveInteraction=this.activeNoteAnimations.size>0,b.debug(`${this.effectName}AnimationEffect`,`Ended interaction animation for note ${t}`,null,"animation"),this.requestAnimationStateUpdate()}onGhostNoteUpdated(t){this.shouldAnimateColor(t)?(this.ghostNoteAnimation={color:t,active:!0},b.debug(`${this.effectName}AnimationEffect`,`Ghost note animation updated for color ${t}`,null,"animation")):this.ghostNoteAnimation=null}onGhostNoteCleared(){this.ghostNoteAnimation=null,b.debug(`${this.effectName}AnimationEffect`,"Ghost note animation cleared",null,"animation")}onNoteAttack(t,e){this.shouldAnimateColor(e)&&(this.activeSoundingNotes.set(t,e),b.debug(`${this.effectName}AnimationEffect`,`Note attack: ${t} (${e}) added to active sounding notes`,null,"animation"),this.requestAnimationStateUpdate())}onNoteRelease(t,e){this.activeSoundingNotes.delete(t),b.debug(`${this.effectName}AnimationEffect`,`Note release: ${t} (${e}) removed from active sounding notes`,null,"animation"),this.requestAnimationStateUpdate()}onDialInteractionStart(t){this.shouldAnimateColor(t)&&(this.hasDialInteraction=!0,this.activeNoteAnimations.set("dial-preview",t),b.debug(`${this.effectName}AnimationEffect`,`Dial interaction started for ${t}`,null,"animation"),this.requestAnimationStateUpdate())}onDialInteractionEnd(t){this.hasDialInteraction=!1,this.activeNoteAnimations.delete("dial-preview"),b.debug(`${this.effectName}AnimationEffect`,`Dial interaction ended for ${t}`,null,"animation"),this.requestAnimationStateUpdate()}getActiveColors(){const t=new Set;for(const[,e]of this.activeSoundingNotes.entries())this.shouldAnimateColor(e)&&t.add(e);for(const[,e]of this.activeNoteAnimations.entries())this.shouldAnimateColor(e)&&t.add(e);return this.ghostNoteAnimation&&this.shouldAnimateColor(this.ghostNoteAnimation.color)&&t.add(this.ghostNoteAnimation.color),Array.from(t)}disposeBase(){this.animations.clear(),this.activeNoteAnimations.clear(),this.activeSoundingNotes.clear(),this.ghostNoteAnimation=null,b.info(`${this.effectName}AnimationEffect`,"Base disposed",null,"animation")}requestAnimationStateUpdate(){window.animationEffectsManager?.updateAnimationState()}}b.moduleLoaded("VibratoCanvasEffect");class op extends Rs{constructor(){super("Vibrato"),b.info("VibratoCanvasEffect","Initialized for canvas note positions",null,"animation")}init(){return this.initBase(),b.info("VibratoCanvasEffect","Ready for canvas animation",null,"animation"),!0}updateAnimationParameters(t,e){const{speed:o,span:i}=e;if(o===0||i===0)this.animations.delete(t),b.debug("VibratoCanvasEffect",`Disabled vibrato animation for ${t}`,null,"animation");else{const s=this.animations.get(t),a=o/100*16,r=i/100*.5,c={frequency:a,amplitude:r,phase:s?.phase||0,lastUpdate:performance.now()};this.animations.set(t,c),b.debug("VibratoCanvasEffect",`Updated vibrato animation for ${t}`,{frequency:a,amplitude:r,preservedPhase:!!s},"animation")}}updateAnimationPhases(t){this.animations.forEach(e=>{const o=(t-e.lastUpdate)/1e3;e.phase+=e.frequency*o*2*Math.PI,e.lastUpdate=t,e.phase>4*Math.PI&&(e.phase-=4*Math.PI)})}getVibratoYOffset(t){if(!t)return 0;const e=this.animations.get(t);if(!e||window.animationEffectsManager&&!window.animationEffectsManager.shouldVibratoBeRunning())return 0;const o=Math.sin(e.phase),i=-o*e.amplitude;return b.debug("VibratoCanvasEffect","Visual vibrato",{sine:o.toFixed(3),offset:i.toFixed(3),phase:e.phase.toFixed(3)},"effects"),i}shouldBeRunning(){return this.animations.size>0?this.isPlaybackActive||this.hasActiveInteraction||this.hasDialInteraction||this.ghostNoteAnimation!==null&&this.isPlaybackActive:!1}shouldAnimateColor(t){const e=this.animations.get(t);return e?e.frequency>0&&e.amplitude>0:!1}dispose(){this.disposeBase(),b.info("VibratoCanvasEffect","Disposed",null,"animation")}}b.moduleLoaded("TremoloWaveformEffect");class ip extends Rs{constructor(){super("Tremolo"),b.info("TremoloWaveformEffect","Initialized for waveform/ADSR amplitude",null,"animation")}init(){return this.initBase(),b.info("TremoloWaveformEffect","Ready for waveform/ADSR animation",null,"animation"),!0}updateAnimationParameters(t,e){const{speed:o,span:i}=e;if(o===0||i===0)this.animations.delete(t),b.debug("TremoloWaveformEffect",`Disabled tremolo animation for ${t}`,null,"animation");else{const s=this.animations.get(t),a=o/100*16,r=i/100,c=window.Tone?.now?.(),d=typeof c=="number"?c*1e3:performance.now(),u={frequency:a,span:r,phase:s?.phase||0,lastUpdate:d};this.animations.set(t,u),b.debug("TremoloWaveformEffect",`Updated tremolo animation for ${t}`,{frequency:a,span:r,preservedPhase:!!s},"animation")}}updateAnimationPhases(t){let e=0;const o=window.Tone?.now?.(),i=typeof o=="number"?o*1e3:t;if(this.animations.forEach((s,a)=>{const r=(i-s.lastUpdate)/1e3,c=s.phase;s.phase+=s.frequency*r*2*Math.PI,s.lastUpdate=i,e++,Math.abs(s.phase-c)<.001&&b.warn("TremoloWaveformEffect",`Phase not advancing for ${a}`,{deltaSeconds:Number(r.toFixed(4)),frequency:s.frequency},"animation"),s.phase>4*Math.PI&&(s.phase-=4*Math.PI)}),e>0&&Math.random()<.05){const s=window.Tone?.now?"Tone.js":"performance";b.debug("TremoloWaveformEffect","Timing sample",{hasTone:!!window.Tone,hasToneNow:!!window.Tone?.now,toneTime:i,currentTime:t,timingSource:s},"animation")}}getTremoloAmplitudeMultiplier(t){const e=this.animations.get(t);if(!e||window.animationEffectsManager&&!window.animationEffectsManager.shouldTremoloBeRunning())return 1;const o=window.waveformVisualizer?.calculatedAmplitude??1,i=Math.sin(e.phase),s=e.span,a=o,r=o*(1-s),c=(a+r)/2,d=(a-r)/2,h=(c+i*d)/o,f=window.Tone?.now?.(),m=(typeof f=="number"?f*1e3:performance.now())-e.lastUpdate;if(m>100&&e.span>0){const p=e.frequency*(m/1e3)*2*Math.PI;p>.1&&b.warn("TremoloWaveformEffect",`Phase stagnation detected for ${t}`,{phase:Number(e.phase.toFixed(3)),millisecondsSinceUpdate:Number(m.toFixed(1)),expectedAdvancement:Number(p.toFixed(3))},"animation")}return Math.max(0,Math.min(1,h))}getADSRTremoloAmplitudeMultiplier(t){return this.getTremoloAmplitudeMultiplier(t)}shouldAnimateColor(t){const e=this.animations.get(t);return e?e.frequency>0&&e.span>0:!1}dispose(){this.disposeBase(),b.info("TremoloWaveformEffect","Disposed",null,"animation")}}b.moduleLoaded("EnvelopeFillEffect");class sp{activeFills;instanceId;constructor(){this.activeFills=new Map,this.instanceId=Math.random().toString(36).substring(7),b.info("EnvelopeFillEffect","Initialized",null,"animation")}init(){l.on("noteAttack",t=>{const e=t?.noteId,o=t?.color;if(!e||!o)return;const i=l.state.timbres?.[o];if(!i){b.warn("EnvelopeFillEffect","No timbre found for color",{color:o},"effects");return}this.activeFills.set(e,{fillLevel:0,color:o,startTime:Pt(),adsr:i.adsr,phase:"attack"}),b.debug("EnvelopeFillEffect",`Started fill animation for note ${e}`,null,"animation"),window.animationEffectsManager?.updateAnimationState()}),l.on("noteRelease",t=>{const e=t?.noteId;if(!e)return;const o=this.activeFills.get(e);o?(o.phase="release",o.releaseStartTime=Pt(),o.releaseStartLevel=o.fillLevel,b.debug("EnvelopeFillEffect",`Started release phase for note ${e}`,null,"animation")):b.warn("EnvelopeFillEffect","No fill data found for release",{noteId:e},"effects")}),l.on("playbackStopped",()=>{this.activeFills.clear(),window.animationEffectsManager?.updateAnimationState(),l.emit("animationUpdate",{type:"envelopeFill",activeColors:[],hasEnvelopeFills:!1})}),b.info("EnvelopeFillEffect","Event subscriptions established",null,"animation")}updateAnimationPhases(t){const e=Pt();for(const[o,i]of this.activeFills.entries()){const{adsr:s,startTime:a,phase:r,releaseStartTime:c,releaseStartLevel:d}=i,u=e-a;if(r==="attack"){const h=s.attack||.01;u<h?i.fillLevel=u/h:(i.phase="decay",i.decayStartTime=e)}else if(r==="decay"){const h=s.decay||.1,f=e-(i.decayStartTime??e),g=s.sustain??.5;if(f<h){const m=f/h;i.fillLevel=1-m*(1-g)}else i.phase="sustain",i.fillLevel=g}else if(r==="sustain"){const h=s.sustain??.5;i.fillLevel=h}else if(r==="release"){const h=s.release||.5,f=c?e-c:0,g=d??i.fillLevel;if(f<h){const m=f/h;i.fillLevel=g*(1-m)}else this.activeFills.delete(o),b.debug("EnvelopeFillEffect",`Completed fill animation for note ${o}`,null,"animation"),this.activeFills.size===0&&window.animationEffectsManager?.updateAnimationState()}}}getFillLevel(t){if(!t.uuid)return 0;const e=this.activeFills.get(t.uuid);return e?e.fillLevel:0}shouldFillNote(t){return t.uuid?this.activeFills.has(t.uuid):!1}shouldBeRunning(){return this.activeFills.size>0}dispose(){this.activeFills.clear(),b.info("EnvelopeFillEffect","Disposed",null,"animation")}}b.moduleLoaded("DelayADSREffect");class ap extends Rs{constructor(){super("Delay"),b.info("DelayADSREffect","Initialized for delay visualization (PLACEHOLDER)",null,"animation")}init(){return this.initBase(),b.info("DelayADSREffect","Ready for delay animation (PLACEHOLDER)",null,"animation"),!0}updateAnimationParameters(t,e){const{time:o,feedback:i}=e;if(o===0&&i===0)this.animations.delete(t),b.debug("DelayADSREffect",`Disabled delay animation for ${t}`,null,"animation");else{const s=o/100*500,a=i/100,r={delayTime:s,feedback:a,echoCount:Math.floor(a*5),lastTrigger:0,echoPhases:[],lastUpdate:performance.now()};this.animations.set(t,r),b.debug("DelayADSREffect",`Updated delay animation for ${t} (PLACEHOLDER)`,{delayTime:s,feedback:a},"animation")}}updateAnimationPhases(t){this.animations.forEach(e=>{e.lastUpdate=t})}getDelayEffects(t){const e=this.animations.get(t);if(!e)return[];const o=[];for(let i=0;i<e.echoCount;i++)o.push({delay:e.delayTime*(i+1),opacity:1-i*.3,scale:1-i*.1,active:!1});return o}triggerDelay(t,e){const o=this.animations.get(t);o&&(o.lastTrigger=e,b.debug("DelayADSREffect",`Triggered delay for ${t} (PLACEHOLDER)`,null,"animation"))}shouldBeRunning(){return this.animations.size>0?this.isPlaybackActive||this.hasActiveInteraction||this.ghostNoteAnimation!==null:!1}shouldAnimateColor(t){const e=this.animations.get(t);return e?e.delayTime>0||e.feedback>0:!1}dispose(){this.disposeBase(),b.info("DelayADSREffect","Disposed",null,"animation")}}b.moduleLoaded("AnimationEffectsManager");class rp{vibratoEffect;tremoloEffect;envelopeFillEffect;delayEffect;isRunning;animationFrameId;lastTime;lastRenderTrigger;constructor(){this.vibratoEffect=new op,this.tremoloEffect=new ip,this.envelopeFillEffect=new sp,this.delayEffect=new ap,this.isRunning=!1,this.animationFrameId=null,this.lastTime=0,this.lastRenderTrigger=0,b.info("AnimationEffectsManager","Initialized with single animation loop",null,"animation")}init(){return this.vibratoEffect.init(),this.tremoloEffect.init(),this.envelopeFillEffect.init(),this.delayEffect.init(),l.on("visualEffectChanged",t=>{const e=t?.effectType;(e==="vibrato"||e==="tremolo")&&(setTimeout(()=>this.updateAnimationState(),0),e==="tremolo"&&setTimeout(()=>this.triggerTremoloAmplitudeUpdate(),0))}),l.on("audioEffectChanged",t=>{if(!t)return;const{effectType:e,color:o,effectParams:i}=t;!o||!i||e==="delay"&&this.delayEffect.updateAnimationParameters(o,i)}),b.info("AnimationEffectsManager","Event subscriptions established",null,"animation"),!0}animate(t){this.isRunning&&(this.lastTime=t,this.vibratoEffect.updateAnimationPhases(t),this.tremoloEffect.updateAnimationPhases(t),this.envelopeFillEffect.updateAnimationPhases(t),this.triggerVisualUpdates(t),this.animationFrameId=requestAnimationFrame(e=>this.animate(e)))}start(){this.isRunning||(this.isRunning=!0,this.lastTime=performance.now(),this.animationFrameId=requestAnimationFrame(t=>this.animate(t)),b.debug("AnimationEffectsManager","Single animation loop started",null,"animation"))}stop(){this.isRunning&&(this.isRunning=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.triggerFinalUpdates(),b.debug("AnimationEffectsManager","Animation loop stopped",null,"animation"))}shouldTremoloBeRunning(){if(!(this.tremoloEffect.animations.size>0))return!1;const e=this.tremoloEffect.activeSoundingNotes.size>0,o=this.tremoloEffect.hasDialInteraction;return e||o}shouldVibratoBeRunning(){return this.vibratoEffect.animations.size>0?this.vibratoEffect.isPlaybackActive||this.vibratoEffect.hasActiveInteraction||this.vibratoEffect.hasDialInteraction||this.vibratoEffect.ghostNoteAnimation!==null:!1}shouldEnvelopeFillBeRunning(){return this.envelopeFillEffect.shouldBeRunning()}updateAnimationState(){const t=this.shouldVibratoBeRunning(),e=this.shouldTremoloBeRunning(),o=this.shouldEnvelopeFillBeRunning(),i=t||e||o;i&&!this.isRunning?this.start():!i&&this.isRunning&&this.stop()}triggerVisualUpdates(t){if(!this.lastRenderTrigger||t-this.lastRenderTrigger>=16.67){this.lastRenderTrigger=t;const e=this.vibratoEffect.getActiveColors(),o=this.tremoloEffect.getActiveColors(),i=this.envelopeFillEffect.activeFills.size>0;(e.length>0||i)&&l.emit("animationUpdate",{type:e.length>0?"vibrato":"envelopeFill",activeColors:e,hasEnvelopeFills:i}),o.length>0&&l.emit("tremoloAmplitudeUpdate",{activeColors:o})}}triggerFinalUpdates(){const t=Array.from(this.vibratoEffect.animations.keys());t.length>0&&l.emit("animationUpdate",{type:"vibrato",activeColors:t});const e=Array.from(this.tremoloEffect.animations.keys());e.length>0&&l.emit("tremoloAmplitudeUpdate",{activeColors:e})}shouldAnimateNote(t){return this.vibratoEffect.shouldAnimateNote(t)}getVibratoYOffset(t){return this.vibratoEffect.getVibratoYOffset(t)}getTremoloAmplitudeMultiplier(t){return this.tremoloEffect.getTremoloAmplitudeMultiplier(t)}getADSRTremoloAmplitudeMultiplier(t){return this.tremoloEffect.getADSRTremoloAmplitudeMultiplier(t)}getFillLevel(t){return this.envelopeFillEffect.getFillLevel(t)}shouldFillNote(t){return this.envelopeFillEffect.shouldFillNote(t)}getDelayEffects(t){return this.delayEffect.getDelayEffects(t)}hasDelayEffect(t){return this.delayEffect.shouldAnimateColor(t)}triggerTremoloAmplitudeUpdate(){const t=this.tremoloEffect.getActiveColors();t.length>0&&l.emit("tremoloAmplitudeUpdate",{activeColors:t})}getAllActiveColors(){const t=this.vibratoEffect.getActiveColors(),e=this.tremoloEffect.getActiveColors();return[...new Set([...t,...e])]}dispose(){this.stop(),this.vibratoEffect.dispose(),this.tremoloEffect.dispose(),this.envelopeFillEffect.dispose(),this.delayEffect.dispose(),b.info("AnimationEffectsManager","Disposed",null,"animation")}}const za=new rp;b.moduleLoaded("VibratoAudioEffect");class lp{currentSettings=new Map;constructor(){b.info("VibratoAudioEffect","Initialized",null,"audio")}init(){return b.info("VibratoAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(t,e){const{speed:o,span:i}=t;this.currentSettings.set(e,{speed:o,span:i}),b.debug("VibratoAudioEffect",`Updated parameters for ${e}`,{speed:o,span:i},"audio")}applyToVoice(t,e){if(!t||typeof t._setVibrato!="function")return;const o=this.currentSettings.get(e);if(!o){b.debug("VibratoAudioEffect",`No vibrato settings found for color ${e}`,null,"audio");return}try{t._setVibrato(o),t.vibratoApplied=!0,b.debug("VibratoAudioEffect",`Applied vibrato to voice for ${e}`,o,"audio")}catch(i){b.warn("VibratoAudioEffect",`Failed to apply vibrato to voice for ${e}`,i,"audio")}}getCurrentSettings(t){return this.currentSettings.get(t)??{speed:0,span:0}}getEffectInstance(){return null}createVibratoSettings(t,e){if(t===0||e===0)return null;const o=t/100*16,i=e/100*50;return{frequency:o,depth:i}}disableForColor(t){this.updateParameters({speed:0,span:0},t)}dispose(){this.currentSettings.clear(),b.info("VibratoAudioEffect","Disposed",null,"audio")}}b.moduleLoaded("TremoloAudioEffect");class cp{currentSettings=new Map;constructor(){b.info("TremoloAudioEffect","Initialized",null,"audio")}init(){return b.info("TremoloAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(t,e){const{speed:o,span:i}=t;this.currentSettings.set(e,{speed:o,span:i}),b.debug("TremoloAudioEffect",`Updated parameters for ${e}`,{speed:o,span:i},"audio")}applyToVoice(t,e){if(!t||typeof t._setTremolo!="function")return;const o=this.currentSettings.get(e);if(!o){b.debug("TremoloAudioEffect",`No tremolo settings found for color ${e}`,null,"audio");return}try{t._setTremolo(o),t.tremoloApplied=!0,b.debug("TremoloAudioEffect",`Applied tremolo to voice for ${e}`,o,"audio")}catch(i){b.warn("TremoloAudioEffect",`Failed to apply tremolo to voice for ${e}`,i,"audio")}}getCurrentSettings(t){return this.currentSettings.get(t)??{speed:0,span:0}}getEffectInstance(){return null}createTremoloSettings(t,e){if(t===0||e===0)return null;const o=t/100*16,i=e/100;return{frequency:o,depth:i}}disableForColor(t){this.updateParameters({speed:0,span:0},t)}dispose(){this.currentSettings.clear(),b.info("TremoloAudioEffect","Disposed",null,"audio")}}b.moduleLoaded("DelayAudioEffect");const dp=()=>window.synthEngine;class up{currentSettings=new Map;delayInstances=new Map;init(){return b.info("DelayAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(t,e){const{time:o,feedback:i,wet:s}=t;this.currentSettings.set(e,{time:o,feedback:i,wet:s}),b.debug("DelayAudioEffect",`Updated parameters for ${e}`,{time:o,feedback:i,wet:s},"audio");let a=this.delayInstances.get(e);a?this.updateDelayInstance(a,o,i,s):(o>0||i>0)&&(a=this.createDelayInstance(o,i,s),a&&(this.delayInstances.set(e,a),b.debug("DelayAudioEffect",`Created new delay instance for ${e}`,{time:o,feedback:i,wet:s},"audio"),dp()?.updateSynthForColor?.(e)))}applyToVoice(t,e){if(!t)return;const o=this.currentSettings.get(e);if(!(!o||o.time===0&&o.feedback===0))try{let i=this.delayInstances.get(e);if(!i){if(i=this.createDelayInstance(o.time,o.feedback,o.wet),!i)return;this.delayInstances.set(e,i)}if(typeof t.isDisposed=="function"&&t.isDisposed())return;try{t.connect?.(i)}catch{t.output?.connect?.(i)}b.debug("DelayAudioEffect",`Applied delay to voice for ${e}`,o,"audio")}catch(i){b.warn("DelayAudioEffect",`Failed to apply delay to voice for ${e}`,i,"audio")}}getCurrentSettings(t){return this.currentSettings.get(t)??{time:0,feedback:0,wet:0}}getEffectInstance(t){const e=this.getCurrentSettings(t);return e.time>0&&e.wet>0?this.delayInstances.get(t)??null:null}createDelayInstance(t,e,o=30){if(t===0&&e===0)return null;const i=Math.max(.01,t/100*.5),s=Math.min(.95,e/100),a=o/100,r=new Dl({delayTime:i,feedback:s,wet:a});return r._wetAmount=a,b.debug("DelayAudioEffect","Created delay instance",{delayTime:i,feedbackAmount:s,wetAmount:a},"audio"),r}updateDelayInstance(t,e,o,i=15){const s=Math.max(.01,e/100*.5),a=Math.min(.95,o/100),r=i/100;try{t.delayTime.value=s,t.feedback.value=a,t._crossFade&&(t._crossFade.fade.value=r),t._wetAmount=r,b.debug("DelayAudioEffect","Updated delay instance",{delayTime:s,feedbackAmount:a,wetAmount:r},"audio")}catch(c){b.warn("DelayAudioEffect","Failed to update delay instance",c,"audio")}}createDelaySettings(t,e,o=30){if(t===0&&e===0)return null;const i=Math.max(.01,t/100*.5),s=Math.min(.95,e/100),a=o/100;return{time:i,feedback:s,wet:a}}disableForColor(t){this.updateParameters({time:0,feedback:0,wet:0},t);const e=this.delayInstances.get(t);if(e)try{e._crossFade?.dispose(),e.dispose()}finally{this.delayInstances.delete(t)}}dispose(){this.delayInstances.forEach((t,e)=>{try{t._crossFade?.dispose(),t.dispose()}catch(o){b.warn("DelayAudioEffect",`Failed to dispose delay for ${e}`,o,"audio")}}),this.currentSettings.clear(),this.delayInstances.clear(),b.info("DelayAudioEffect","Disposed",null,"audio")}}b.moduleLoaded("AudioEffectsManager");const hp=()=>window.synthEngine;class mp{vibratoEffect=new lp;tremoloEffect=new cp;delayEffect=new up;init(){return this.vibratoEffect.init(),this.tremoloEffect.init(),this.delayEffect.init(),l.on("audioEffectChanged",t=>{if(!t)return;const{effectType:e,parameter:o,value:i,color:s,effectParams:a}=t;this.handleAudioEffectChange(e,o,i,s,a)}),b.info("AudioEffectsManager","Event subscriptions established",null,"audio"),!0}handleAudioEffectChange(t,e,o,i,s){switch(b.debug("AudioEffectsManager",`Processing audio effect: ${t}.${e} = ${o} for ${i}`,null,"audio"),t){case"vibrato":this.vibratoEffect.updateParameters(s,i);break;case"tremolo":this.tremoloEffect.updateParameters(s,i);break;case"delay":this.delayEffect.updateParameters(s,i);break;default:b.debug("AudioEffectsManager",`Effect type ${t} not handled by audio system`,null,"audio")}}getEffectHandler(t){switch(t){case"vibrato":return this.vibratoEffect;case"tremolo":return this.tremoloEffect;case"delay":return this.delayEffect;default:return null}}applySynthEffects(t,e,o){const i=this.delayEffect.getEffectInstance(e);try{t.disconnect()}catch{}let s=t;if(i)try{s.connect(i),s=i}catch(a){b.error("AudioEffectsManager","Delay connection error",a,"audio")}try{s.connect(o);const a=hp()?.getWaveformAnalyzer?.(e);a&&t.connect(a)}catch(a){b.error("AudioEffectsManager","masterGain connection error",a,"audio")}}applyEffectsToVoice(t,e){this.vibratoEffect.applyToVoice(t,e),this.tremoloEffect.applyToVoice(t,e)}dispose(){this.vibratoEffect.dispose(),this.tremoloEffect.dispose(),this.delayEffect.dispose(),b.info("AudioEffectsManager","Disposed",null,"audio")}}const $a=new mp;b.moduleLoaded("EffectsCoordinator");class fp{constructor(){this.effectParameters=new Map,this.defaultEffects={vibrato:{speed:0,span:0,wet:100},tremolo:{speed:0,span:0,wet:100},delay:{time:0,feedback:0,wet:20}},b.info("EffectsCoordinator","Initialized as main coordinator",null,"effects")}init(){return Object.keys(l.state.timbres).forEach(t=>{this.initializeColorEffects(t)}),l.on("timbreCreated",({color:t})=>{this.initializeColorEffects(t)}),this.loadSavedValues(),b.info("EffectsCoordinator","Event subscriptions established",null,"effects"),!0}initializeColorEffects(t){if(!this.effectParameters.has(t)){const e={};Object.entries(this.defaultEffects).forEach(([i,s])=>{e[i]={...s}}),this.effectParameters.set(t,e);const o=l.state.timbres[t];o&&(o.vibrato&&(e.vibrato={...o.vibrato}),o.tremelo&&(e.tremolo={...o.tremelo})),b.debug("EffectsCoordinator",`Initialized effects for color ${t}`,e,"effects")}}updateParameter(t,e,o,i){if(!i){b.warn("EffectsCoordinator","Cannot update parameter: no color provided",{effectType:t,parameter:e,value:o},"effects");return}this.initializeColorEffects(i);const s=this.effectParameters.get(i);s[t]||(s[t]={...this.defaultEffects[t]}),s[t][e]=o,this.notifyAudioSystem(t,e,o,i,s[t]),this.notifyAnimationSystem(t,e,o,i,s[t]),this.updateTimbreState(t,s[t],i),this.saveValues()}notifyAudioSystem(t,e,o,i,s){l.emit("audioEffectChanged",{effectType:t,parameter:e,value:o,color:i,effectParams:{...s}}),b.debug("EffectsCoordinator",`Notified audio system: ${t}.${e} = ${o} for ${i}`,null,"effects")}notifyAnimationSystem(t,e,o,i,s){(t==="vibrato"||t==="tremolo")&&(l.emit("visualEffectChanged",{effectType:t,parameter:e,value:o,color:i,effectParams:{...s}}),b.debug("EffectsCoordinator",`Notified animation system: ${t}.${e} = ${o} for ${i}`,null,"effects"))}updateTimbreState(t,e,o){const i=l.state.timbres[o];if(!i)return;const a={vibrato:"vibrato",tremolo:"tremelo"}[t];a&&(i[a]||(i[a]={}),Object.assign(i[a],e),l.recordState())}getEffectParameters(t,e){const o=this.effectParameters.get(t);return o?.[e]?{...o[e]}:{...this.defaultEffects[e]}}getAllEffectParameters(t){const e=this.effectParameters.get(t);return e?{...e}:{...this.defaultEffects}}resetColorEffects(t){const e={};Object.entries(this.defaultEffects).forEach(([o,i])=>{e[o]={...i}}),this.effectParameters.set(t,e),Object.keys(e).forEach(o=>{Object.keys(e[o]).forEach(i=>{this.notifyAudioSystem(o,i,e[o][i],t,e[o]),this.notifyAnimationSystem(o,i,e[o][i],t,e[o])})}),b.info("EffectsCoordinator",`Reset all effects for color ${t}`,e,"effects")}saveValues(){const t={};Object.keys(l.state.timbres).forEach(e=>{const o=this.effectParameters.get(e);o&&(t[e]={vibrato:o.vibrato||{speed:0,span:0,wet:100},tremelo:o.tremolo||{speed:0,span:0,wet:100},delay:o.delay||{time:0,feedback:0,wet:20}})});try{localStorage.setItem("effectDialValues",JSON.stringify(t)),b.debug("EffectsCoordinator","Saved effect values to localStorage",null,"effects")}catch(e){b.warn("EffectsCoordinator","Failed to save effect values to localStorage",e,"effects")}}loadSavedValues(){try{const t=localStorage.getItem("effectDialValues");if(!t){b.debug("EffectsCoordinator","No saved effect values found",null,"effects");return}const e=JSON.parse(t);b.debug("EffectsCoordinator","Loading saved effect values",null,"effects"),Object.keys(e).forEach(o=>{const i=l.state.timbres[o],s=e[o];i&&s&&(s.vibrato&&Object.entries(s.vibrato).forEach(([a,r])=>{typeof r=="number"&&this.updateParameter("vibrato",a,r,o)}),s.tremelo&&Object.entries(s.tremelo).forEach(([a,r])=>{typeof r=="number"&&this.updateParameter("tremolo",a,r,o)}),s.delay&&Object.entries(s.delay).forEach(([a,r])=>{typeof r=="number"&&this.updateParameter("delay",a,r,o)}))}),b.info("EffectsCoordinator","Applied saved effect values",null,"effects"),window.synthEngine&&Object.keys(e).forEach(o=>{const i=e[o];i.delay&&(i.delay.time>0||i.delay.feedback>0)&&(window.synthEngine.updateSynthForColor(o),b.debug("EffectsCoordinator",`Re-applied effects to synth for ${o}`,null,"effects"))})}catch(t){b.warn("EffectsCoordinator","Failed to load saved effect values",t,"effects")}}dispose(){this.effectParameters.clear(),b.info("EffectsCoordinator","Disposed",null,"effects")}}const sn=new fp;class pp{currentEffect=null;effectControlsContainer=null;effectButtons=[];dials=[];currentColor=null;isDialInteractionActive=!1;lastPreviewAt={};previewThrottleMs=180;previewDurationMs=220;previewPitch="C4";holdPreviews={};effectConfigs={delay:{name:"Delay",controls:{time:{label:"Time",min:0,max:100,default:0,unit:"%"},feedback:{label:"Echoes",min:0,max:95,default:0,unit:"%"},wet:{label:"Mix",min:0,max:100,default:15,unit:"%"}}},vibrato:{name:"Vibrato",controls:{speed:{label:"Speed",min:0,max:100,default:0,unit:"%"},span:{label:"Span",min:0,max:100,default:0,unit:"%"}}},tremolo:{name:"Tremolo",controls:{speed:{label:"Speed",min:0,max:100,default:0,unit:"%"},span:{label:"Span",min:0,max:100,default:0,unit:"%"}}}};init(){return b.initStart("Effects Controller"),this.effectControlsContainer=document.getElementById("effect-controls"),this.effectButtons=document.querySelectorAll(".effect-button[data-effect]"),this.effectButtons.length>0&&this.setupEventListeners(),this.initializeSelectedColorTracking(),this.setupGlobalMouseUpHandler(),b.initSuccess("Effects Controller"),!0}setupGlobalMouseUpHandler(){document.addEventListener("mouseup",()=>{this.isDialInteractionActive&&this.onDialInteractionEnd(this.currentEffect)})}setupEventListeners(){this.effectButtons.forEach(t=>{t.addEventListener("click",e=>{const i=e.currentTarget.dataset.effect;i&&this.selectEffect(i)})})}selectEffect(t){if(b.debug("Effects",`Selecting effect: ${t}`,null,"ui"),!this.effectConfigs[t]){b.info("Effects",`Effect ${t} not configured`,null,"ui");return}if(this.effectButtons.forEach(e=>{e.classList.remove("active"),e.dataset.effect===t&&e.classList.add("active")}),this.currentEffect===t){this.currentEffect=null,this.hideEffectControls();return}this.currentEffect=t,this.showEffectControls(t)}showEffectControls(t){const e=this.effectConfigs[t];if(!e||!this.effectControlsContainer){b.warn("Effects",`No configuration found for effect: ${t}`,null,"ui");return}this.clearControls(),this.effectControlsContainer.innerHTML='<div class="effect-controls"></div>';const o=this.effectControlsContainer.querySelector(".effect-controls");o&&Object.entries(e.controls).forEach(([i,s])=>{const r=(this.currentColor?sn.getEffectParameters?.(this.currentColor,t):null)?.[i]??s.default??0,c=document.createElement("div");c.className="effect-slider-group",c.style.cssText="margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;",o.appendChild(c);const d=document.createElement("label");d.className="effect-slider-label",d.textContent=s.label,d.style.cssText="display: block; margin-bottom: 5px; font-weight: bold; color: #333;",c.appendChild(d);const u=document.createElement("input");u.type="range",u.min=`${s.min}`,u.max=`${s.max}`,u.value=`${r}`,u.className="effect-slider",u.style.cssText="width: 100%; margin: 5px 0;",c.appendChild(u);const h=document.createElement("div");h.className="effect-slider-value";const f=s.unit?`${Math.round(r)}${s.unit}`:Math.round(r);h.textContent=`${f}`,h.style.cssText="text-align: center; font-size: 12px; color: #666;",c.appendChild(h),this.dials.push({dial:{element:u,value:r,destroy:()=>{}},control:i,effectType:t,valueDisplay:h,controlConfig:s});const g=m=>{const p=m.target;if(!p)return;const v=parseFloat(p.value),y=s.unit?`${Math.round(v)}${s.unit}`:Math.round(v);h.textContent=`${y}`,b.debug("Effects",`${t} ${i}: ${v}`,null,"audio"),this.onEffectParameterChange(t,i,v)};u.addEventListener("input",g),u.addEventListener("change",g),u.addEventListener("mousedown",()=>this.onDialInteractionStart(t)),u.addEventListener("mouseup",()=>this.onDialInteractionEnd(t)),u.addEventListener("mouseleave",m=>{(m.buttons&1)===1&&this.onDialInteractionEnd(t)})})}hideEffectControls(){this.clearControls(),this.currentEffect=null}clearControls(){this.dials.forEach(t=>t.dial.destroy()),this.dials=[],this.effectControlsContainer&&(this.effectControlsContainer.innerHTML="")}onEffectParameterChange(t,e,o){const i=this.currentColor||l.state.selectedNote?.color;i&&sn.updateParameter(t,e,o,i)}updateEffect(t,e){const o=this.currentColor||l.state.selectedNote?.color;o&&Object.entries(e).forEach(([i,s])=>{typeof s=="number"&&sn.updateParameter(t,i,s,o)})}getEffectState(t){const e=this.currentColor||l.state.selectedNote?.color;return e?sn.getEffectParameters(e,t)||{}:{}}getActiveColor(){return this.currentColor||l.state.selectedNote?.color||null}getPreviewNotes(){const t=this.getActiveColor();if(!t)return null;const e=l.state.placedNotes.slice().reverse().find(a=>!a.isDrum),o=e?l.state.fullRowData[e.row]?.toneNote||this.previewPitch:this.previewPitch,i=l.state.selectedTool;let s=[o];return i==="chord"&&Array.isArray(l.state.activeChordIntervals)&&(s=l.state.activeChordIntervals.map(r=>Nn(cn(o,r)))),{pitches:s,root:o,color:t}}previewEffect(t){const e=this.getActiveColor();if(!e)return;const o=Date.now(),i=this.lastPreviewAt[t]??0;if(o-i<this.previewThrottleMs)return;this.lastPreviewAt[t]=o;const{isPlaying:s,isPaused:a}=l.state;if(s&&!a)return;const r=`effect-preview-${t}`;l.emit?.("noteAttack",{noteId:r,color:e});try{wt.triggerAttack(this.previewPitch,e),setTimeout(()=>wt.triggerRelease(this.previewPitch,e),this.previewDurationMs)}catch(c){b.warn("Effects","Preview trigger failed",{err:c},"audio")}finally{setTimeout(()=>l.emit?.("noteRelease",{noteId:r,color:e}),this.previewDurationMs)}}startHoldPreview(t){if(this.holdPreviews[t])return;const e=this.getPreviewNotes();if(!e)return;const{pitches:o,root:i,color:s}=e,a=`effect-hold-${t}-${Date.now()}`;this.holdPreviews[t]={pitches:o,root:i,color:s,noteId:a};const{isPlaying:r,isPaused:c}=l.state;if(r&&!c)return;o.forEach(f=>wt.triggerAttack(f,s));const d=l.state.fullRowData.find(f=>f.toneNote===i),u=d?d.hex:"#888888",h=l.state.timbres[s];h&&Jt.adsrComponent?.playheadManager.trigger(a,"attack",u,h.adsr),l.emit("spacebarPlayback",{note:i,color:s,isPlaying:!0}),l.emit("noteAttack",{noteId:a,color:s})}stopHoldPreview(t){const e=this.holdPreviews[t];if(!e)return;delete this.holdPreviews[t];const{pitches:o,root:i,color:s,noteId:a}=e;o.forEach(u=>wt.triggerRelease(u,s));const r=l.state.fullRowData.find(u=>u.toneNote===i),c=r?r.hex:"#888888",d=l.state.timbres[s];d&&Jt.adsrComponent?.playheadManager.trigger(a,"release",c,d.adsr),l.emit("spacebarPlayback",{note:i,color:s,isPlaying:!1}),l.emit("noteRelease",{noteId:a,color:s})}initializeSelectedColorTracking(){l.on("noteChanged",({newNote:t}={})=>{this.currentColor=t?.color||null,this.currentColor&&this.currentEffect&&this.showEffectControls(this.currentEffect)}),this.currentColor=l.state.selectedNote?.color||null}onDialInteractionStart(t){if(this.isDialInteractionActive=!0,t){b.debug("Effects",`Dial interaction start for ${t}`,null,"ui");const e=this.getActiveColor();e&&l.emit("effectDialInteractionStart",{effectType:t,color:e}),this.startHoldPreview(t)}}onDialInteractionEnd(t){if(this.isDialInteractionActive=!1,t){b.debug("Effects",`Dial interaction end for ${t}`,null,"ui");const e=this.getActiveColor();e&&l.emit("effectDialInteractionEnd",{effectType:t,color:e}),this.stopHoldPreview(t)}}}const Ne=new pp;class gp{listeners=new Map;on(t,e){const o=this.listeners.get(t)||[];o.push(e),this.listeners.set(t,o)}off(t,e){const o=this.listeners.get(t);if(!o)return;const i=o.indexOf(e);i>=0&&o.splice(i,1)}emit(t,e){const o=this.listeners.get(t);o&&o.slice().forEach(i=>i(e))}}class vp{static DEBUG=!1;debugLog(...t){}_root;_svgWrapper;_bg;_gridFill;_gridPatternRect;_dial;_crosshairV;_crosshairH;_label;_em=new gp;_patternId;_size;_mode;_minX;_maxX;_stepX;_minY;_maxY;_stepY;_reverseX;_x;_y;_normX;_normY;_dragging=!1;colors={accent:"#4a90e2",fill:"#1f1f1f",stroke:"#555",grid:"#333",text:"#fff"};constructor(t,e={}){if(this._root=typeof t=="string"?document.querySelector(t):t,!this._root)throw new Error("Position: target not found");const{size:o=[200,200],mode:i="absolute",x:s=.5,minX:a=0,maxX:r=1,stepX:c=0,y:d=.5,minY:u=0,maxY:h=1,stepY:f=0,reverseX:g=!1,colors:m}=e;this._patternId=`pos-grid-${Math.random().toString(36).slice(2,8)}`;try{const y=getComputedStyle(document.documentElement),w=y.getPropertyValue("--c-surface").trim(),S=y.getPropertyValue("--c-border").trim(),M=y.getPropertyValue("--c-border-strong").trim(),P=y.getPropertyValue("--c-text").trim();this.colors={...this.colors,fill:w||this.colors.fill,stroke:S||this.colors.stroke,grid:M||this.colors.grid,text:P||this.colors.text}}catch{}this._size=o,this._mode=i,this._minX=a,this._maxX=r,this._stepX=c,this._minY=u,this._maxY=h,this._stepY=f,this._reverseX=g,m&&(this.colors={...this.colors,...m}),this._x=s,this._y=d,this._normX=0,this._normY=0,this._svgWrapper=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._svgWrapper.setAttribute("width",`${o[0]}`),this._svgWrapper.setAttribute("height",`${o[1]}`),this._svgWrapper.setAttribute("viewBox",`0 0 ${o[0]} ${o[1]}`),this._svgWrapper.style.touchAction="none";const p=document.createElementNS("http://www.w3.org/2000/svg","defs"),v=document.createElementNS("http://www.w3.org/2000/svg","pattern");v.setAttribute("id",this._patternId),v.setAttribute("width","20"),v.setAttribute("height","20"),v.setAttribute("patternUnits","userSpaceOnUse"),this._gridPatternRect=document.createElementNS("http://www.w3.org/2000/svg","rect"),this._gridPatternRect.setAttribute("width","20"),this._gridPatternRect.setAttribute("height","20"),this._gridPatternRect.setAttribute("fill","none"),this._gridPatternRect.setAttribute("stroke",this.colors.grid),this._gridPatternRect.setAttribute("stroke-width","1"),v.appendChild(this._gridPatternRect),p.appendChild(v),this._svgWrapper.appendChild(p),this._bg=document.createElementNS("http://www.w3.org/2000/svg","rect"),this._bg.setAttribute("x","0"),this._bg.setAttribute("y","0"),this._bg.setAttribute("width",`${o[0]}`),this._bg.setAttribute("height",`${o[1]}`),this._bg.setAttribute("fill",this.colors.fill),this._bg.setAttribute("stroke",this.colors.stroke),this._svgWrapper.appendChild(this._bg),this._gridFill=document.createElementNS("http://www.w3.org/2000/svg","rect"),this._gridFill.setAttribute("x","0"),this._gridFill.setAttribute("y","0"),this._gridFill.setAttribute("width",`${o[0]}`),this._gridFill.setAttribute("height",`${o[1]}`),this._gridFill.setAttribute("fill",`url(#${this._patternId})`),this._gridFill.setAttribute("opacity","0.2"),this._svgWrapper.appendChild(this._gridFill),this._crosshairV=document.createElementNS("http://www.w3.org/2000/svg","line"),this._crosshairH=document.createElementNS("http://www.w3.org/2000/svg","line"),[this._crosshairV,this._crosshairH].forEach(y=>{y.setAttribute("stroke",this.colors.grid),y.setAttribute("stroke-width","1"),y.setAttribute("opacity","0.6"),this._svgWrapper.appendChild(y)}),this._dial=document.createElementNS("http://www.w3.org/2000/svg","circle"),this._dial.setAttribute("r","10"),this._dial.setAttribute("fill",this.colors.accent),this._dial.setAttribute("stroke","#fff"),this._dial.setAttribute("stroke-width","2"),this._svgWrapper.appendChild(this._dial),this._label=document.createElementNS("http://www.w3.org/2000/svg","text"),this._label.setAttribute("x","8"),this._label.setAttribute("y",`${o[1]-8}`),this._label.setAttribute("fill",this.colors.text),this._label.setAttribute("font-size","12"),this._label.setAttribute("font-family","monospace"),this._label.setAttribute("opacity","0"),this._label.textContent="",this._svgWrapper.appendChild(this._label),this._root.innerHTML="",this._root.appendChild(this._svgWrapper),this._bind(),this.setColors(),this._updateFromValues()}on(t,e){return this._em.on(t,e),()=>this._em.off(t,e)}get value(){return{x:this._x,y:this._y}}get normalized(){return{x:this._normX,y:this._normY}}set x(t){this._x=this._clamp(this._maybeStep(t,this._minX,this._maxX,this._stepX),this._minX,this._maxX),this._updateFromValues()}get x(){return this._x}set y(t){this._y=this._clamp(this._maybeStep(t,this._minY,this._maxY,this._stepY),this._minY,this._maxY),this._updateFromValues()}get y(){return this._y}set minX(t){this._minX=t,this._updateFromValues()}set maxX(t){this._maxX=t,this._updateFromValues()}set minY(t){this._minY=t,this._updateFromValues()}set maxY(t){this._maxY=t,this._updateFromValues()}set stepX(t){this._stepX=t}set stepY(t){this._stepY=t}resize(t,e){this._size=[t,e],this._svgWrapper.setAttribute("width",`${t}`),this._svgWrapper.setAttribute("height",`${e}`),this._svgWrapper.setAttribute("viewBox",`0 0 ${t} ${e}`),this._label.setAttribute("y",`${e-8}`),this._updateFromValues()}destroy(){this._root.innerHTML=""}setColors(t={}){this.colors={...this.colors,...t},this._bg.setAttribute("fill",this.colors.fill),this._bg.setAttribute("stroke",this.colors.stroke),this._gridPatternRect.setAttribute("stroke",this.colors.grid),this._gridFill.setAttribute("fill",`url(#${this._patternId})`),this._crosshairV.setAttribute("stroke",this.colors.grid),this._crosshairH.setAttribute("stroke",this.colors.grid),this._dial.setAttribute("fill",this.colors.accent),this._label.setAttribute("fill",this.colors.text)}_updateFromValues(){if(this._x===this._minX&&this._y===this._minY)this.debugLog("At origin (off state)",{x:this._x,y:this._y});else{const o=this._x,i=this._y;if(this._x===this._minX){const s=this._stepX>0?this._stepX:Math.max((this._maxX-this._minX)/100,.01);this._x=this._minX+s}if(this._y===this._minY){const s=this._stepY>0?this._stepY:Math.max((this._maxY-this._minY)/100,.01);this._y=this._minY+s}this.debugLog("Adjusted single-axis zero",{from:{x:o,y:i},to:{x:this._x,y:this._y}})}const t=(this._x-this._minX)/(this._maxX-this._minX||1),e=(this._y-this._minY)/(this._maxY-this._minY||1);this._normX=this._clamp(t,0,1),this._normY=this._clamp(e,0,1),this._updateGraphics(),this._em.emit("change",{x:this._x,y:this._y})}_updateGraphics(){const[t,e]=this._size,o=this._reverseX?(1-this._normX)*t:this._normX*t,i=this._mode==="absolute"?this._normY*e:(1-this._normY)*e;this._dial.setAttribute("cx",`${o}`),this._dial.setAttribute("cy",`${i}`),this._crosshairV.setAttribute("x1",`${o}`),this._crosshairV.setAttribute("x2",`${o}`),this._crosshairV.setAttribute("y1","0"),this._crosshairV.setAttribute("y2",`${e}`),this._crosshairH.setAttribute("x1","0"),this._crosshairH.setAttribute("x2",`${t}`),this._crosshairH.setAttribute("y1",`${i}`),this._crosshairH.setAttribute("y2",`${i}`),this._label.textContent=`x:${this._x.toFixed(3)} y:${this._y.toFixed(3)}`}_bind(){const t=i=>{this._dragging=!0,this._handlePointer(i),i.target.setPointerCapture?.(i.pointerId)},e=i=>{this._dragging&&this._handlePointer(i)},o=i=>{this._dragging=!1,i.target.releasePointerCapture?.(i.pointerId)};this._svgWrapper.addEventListener("pointerdown",t),this._svgWrapper.addEventListener("pointermove",e),this._svgWrapper.addEventListener("pointerup",o),this._svgWrapper.addEventListener("pointercancel",o)}_handlePointer(t){const e=this._svgWrapper.getBoundingClientRect(),o=(t.clientX-e.left)/e.width,i=this._reverseX?1-o:o,s=(t.clientY-e.top)/e.height;this._normX=this._clamp(i,0,1);const a=this._mode==="relative"?1-s:s;if(this._normY=this._clamp(a,0,1),this._x=this._minX+this._normX*(this._maxX-this._minX),this._y=this._minY+this._normY*(this._maxY-this._minY),this.debugLog("Pointer move",{raw:{nx:i,ny:s},norm:{x:this._normX,y:this._normY},value:{x:this._x,y:this._y},mode:this._mode}),this._stepX>0){const r=this._maybeStep(this._x,this._minX,this._maxX,this._stepX);this._x=r}if(this._stepY>0){const r=this._maybeStep(this._y,this._minY,this._maxY,this._stepY);this._y=r}if(!(this._x===this._minX&&this._y===this._minY)){if(this._x===this._minX){const r=this._stepX>0?this._stepX:Math.max((this._maxX-this._minX)/100,.01);this._x=this._minX+r}if(this._y===this._minY){const r=this._stepY>0?this._stepY:Math.max((this._maxY-this._minY)/100,.01);this._y=this._minY+r}}this._normX=this._clamp((this._x-this._minX)/(this._maxX-this._minX||1),0,1),this._normY=this._clamp((this._y-this._minY)/(this._maxY-this._minY||1),0,1),this._updateGraphics(),this._em.emit("change",{x:this._x,y:this._y})}_maybeStep(t,e,o,i){if(i<=0)return t;const s=t-e,a=Math.round(s/i),r=e+a*i;return this._clamp(r,e,o)}_clamp(t,e,o){return Math.max(e,Math.min(o,t))}}b.moduleLoaded("CartesianSliderController");class bp{sliders={};resizeObservers=[];effectConfigs;isDragging={};constructor(){this.effectConfigs={delay:{containerId:"delay-position",xParam:"time",yParam:"feedback",xRange:{min:0,max:100,step:1},yRange:{min:0,max:95,step:1},backgroundOpacity:.2},vibrato:{containerId:"vibrato-position",xParam:"speed",yParam:"span",xRange:{min:0,max:100,step:1},yRange:{min:0,max:100,step:1},backgroundOpacity:.5},tremolo:{containerId:"tremolo-position",xParam:"speed",yParam:"span",xRange:{min:0,max:100,step:1},yRange:{min:0,max:100,step:1},backgroundOpacity:.5}},b.info("CartesianSliderController","Initialized",null,"ui")}init(){return b.initStart("Cartesian Slider Controller"),Object.entries(this.effectConfigs).forEach(([t,e])=>{this.createSliderComponent(t,e)}),this.initializeColorTracking(),b.initSuccess("Cartesian Slider Controller"),!0}createSliderComponent(t,e){const o=document.getElementById(e.containerId);if(!o){b.warn("CartesianSliderController",`Container not found for ${t}`,{containerId:e.containerId},"ui");return}try{t==="delay"&&setTimeout(()=>{console.group("[Effects Width Debug]");const d=document.querySelector(".position-controls-container"),u=document.querySelector(".effects-content-box"),h=document.getElementById("effects-panel"),f=document.querySelector(".preset-effects-content"),g=document.querySelector(".preset-effects-controls"),m=(p,v)=>{if(!v){console.log(`${p}: NOT FOUND`);return}const y=getComputedStyle(v),w=v.getBoundingClientRect();console.log(`${p}:`,{actualWidth:w.width,computedWidth:y.width,flex:`${y.flexGrow} ${y.flexShrink} ${y.flexBasis}`,minWidth:y.minWidth,maxWidth:y.maxWidth})};m("position-controls-container",d),m("effects-content-box",u),m("effects-panel",h),m("preset-effects-content",f),m("preset-effects-controls",g),console.groupEnd()},100);const[i,s]=this.getSliderComponentSize(o),a=new vp(o,{size:[i,s],mode:"relative",x:e.xRange.min,minX:e.xRange.min,maxX:e.xRange.max,stepX:e.xRange.step,y:e.yRange.min,minY:e.yRange.min,maxY:e.yRange.max,stepY:e.yRange.step});this.sliders[t]=a,this.observeSliderResize(o,a,i,s),a.on("change",({x:d,y:u})=>{this.onSliderChange(t,e.xParam,d,e.yParam,u)});const r=()=>{this.isDragging[t]=!0,this.onSliderInteractionStart(t),Ne.startHoldPreview(t)},c=()=>{this.isDragging[t]&&(this.isDragging[t]=!1,this.onSliderInteractionEnd(t),Ne.stopHoldPreview(t))};o.addEventListener("pointerdown",r),["pointerup","pointerleave","pointercancel"].forEach(d=>{o.addEventListener(d,c)}),this.loadInitialValues(t,e,a),b.debug("CartesianSliderController",`Created slider component for ${t}`,null,"ui")}catch(i){b.error("CartesianSliderController",`Failed to create slider component for ${t}`,i,"ui")}}getSliderComponentSize(t){const o=t.getBoundingClientRect();let i=o?.width||t.clientWidth||t.offsetWidth||120,s=o?.height||t.clientHeight||t.offsetHeight||i;return(!i||i<10)&&(i=120),(!s||s<10)&&(s=i),[Math.round(i),Math.round(s)]}observeSliderResize(t,e,o,i){if(typeof ResizeObserver>"u")return;const s={currentWidth:Math.round(o)||0,currentHeight:Math.round(i)||0},a=new ResizeObserver(r=>{for(const c of r){const{width:d,height:u}=c.contentRect,h=Math.round(d),f=Math.round(u||d);!h||!f||h===s.currentWidth&&f===s.currentHeight||(s.currentWidth=h,s.currentHeight=f,e.resize(h,f))}});a.observe(t),this.resizeObservers.push(a)}onSliderChange(t,e,o,i,s){Ne.updateEffect(t,{[e]:o,[i]:s})}onSliderInteractionStart(t){const e=Ne.getActiveColor();b.debug("CartesianSliderController",`Interaction start for ${t}`,null,"ui"),l.emit("effectDialInteractionStart",{effectType:t,color:e})}onSliderInteractionEnd(t){const e=Ne.getActiveColor();b.debug("CartesianSliderController",`Interaction end for ${t}`,null,"ui"),l.emit("effectDialInteractionEnd",{effectType:t,color:e})}loadInitialValues(t,e,o){const i=Ne.getEffectState(t)||{},s=i[e.xParam],a=i[e.yParam],r=typeof s=="number"?s:e.xRange.min,c=typeof a=="number"?a:e.yRange.min;o.x=r,o.y=c}initializeColorTracking(){l.on("noteChanged",({newNote:t}={})=>{t?.color&&this.applyColorPalette(t.color)}),l.state.selectedNote?.color&&this.applyColorPalette(l.state.selectedNote.color)}applyColorPalette(t){const e=l.state.colorPalette[t]||{primary:t,light:t},o=(r,c)=>{const d=m=>Math.max(0,Math.min(255,m)),u=r.replace("#",""),h=d(parseInt(u.slice(0,2),16)+c),f=d(parseInt(u.slice(2,4),16)+c),g=d(parseInt(u.slice(4,6),16)+c);return`#${h.toString(16).padStart(2,"0")}${f.toString(16).padStart(2,"0")}${g.toString(16).padStart(2,"0")}`},i=e.primary,s=e.light||o(i,80),a=(r,c)=>{const d=r.replace("#",""),u=parseInt(d.slice(0,2),16),h=parseInt(d.slice(2,4),16),f=parseInt(d.slice(4,6),16);return`rgba(${u}, ${h}, ${f}, ${c})`};Object.entries(this.sliders).forEach(([r,c])=>{const u=this.effectConfigs[r]?.backgroundOpacity??.5;c.setColors({accent:e.primary,fill:a(s,u),stroke:"#c3c9d0",grid:"#d7dce4",text:"#3c4048"})})}}const Ha=new bp;function yp(){Vf(),Jh(),Qf(),b.initStart("Waveform Visualizer"),np()?b.initSuccess("Waveform Visualizer"):b.initFailed("Waveform Visualizer"),b.initStart("Effects Managers"),za.init(),$a.init(),sn.init(),Ne.init(),Ha.init();const n=window;n.effectsCoordinator=sn,n.animationEffectsManager=za,n.audioEffectsManager=$a,n.effectsController=Ne,n.cartesianSliderController=Ha,b.initSuccess("Effects Managers")}function wp({cx:n,cy:t,rx:e,ry:o,stroke:i="currentColor",strokeWidth:s=3}){const a=document.createElementNS("http://www.w3.org/2000/svg","ellipse");return a.setAttribute("cx",`${n}`),a.setAttribute("cy",`${t}`),a.setAttribute("rx",`${e}`),a.setAttribute("ry",`${o}`),a.setAttribute("fill","none"),a.setAttribute("stroke",i),a.setAttribute("stroke-width",`${s}`),a.setAttribute("stroke-linecap","round"),a}function Sp(n,t=48,e=48){const o=document.createElementNS("http://www.w3.org/2000/svg","svg"),i=n.span==="quarter",s=i?200:100;o.setAttribute("viewBox",`0 0 ${s} 100`),o.setAttribute("width",`${t}`),o.setAttribute("height",`${e}`),o.setAttribute("aria-label",n.label),o.style.color="#000000";const r=50,c=i?32:16,d=40,u=i?[33.33,100,166.67]:[16.67,50,83.33];return n.hits.forEach(h=>{const f=wp({cx:u[h]??0,cy:r,rx:c,ry:d,stroke:"currentColor",strokeWidth:3});o.appendChild(f)}),o}const no={selectedTripletStampId:1,init(){this.render(),this.bindEvents(),b.info("TripletStampsToolbar","Triplet stamps toolbar initialized",null,"triplets")},render(){const n=document.getElementById("triplet-stamps-toolbar-container");if(!n){b.warn("TripletStampsToolbar","Container not found",null,"triplets");return}n.innerHTML="";const t=Po.filter(i=>i.span==="eighth"),e=Po.filter(i=>i.span==="quarter"),o=document.createElement("div");if(o.className="triplet-stamps-grid",t.length>0){const i=document.createElement("div");i.className="triplet-stamps-row triplet-stamps-eighth-row",t.forEach(s=>{const a=this.createTripletStampButton(s);i.appendChild(a)}),o.appendChild(i)}if(e.length>0){const i=document.createElement("div");if(i.className="triplet-stamps-row triplet-stamps-quarter-row",e.slice(0,3).forEach(s=>{const a=this.createTripletStampButton(s);a.classList.add("triplet-stamp-button-wide"),i.appendChild(a)}),o.appendChild(i),e.length>3){const s=document.createElement("div");s.className="triplet-stamps-row triplet-stamps-quarter-row",e.slice(3).forEach(a=>{const r=this.createTripletStampButton(a);r.classList.add("triplet-stamp-button-wide"),s.appendChild(r)}),o.appendChild(s)}}n.appendChild(o),this.setInitialSelection(this.selectedTripletStampId)},createTripletStampButton(n){const t=document.createElement("button");t.className="triplet-stamp-button",t.dataset.tripletStampId=`${n.id}`,t.setAttribute("title",n.label||`Triplet ${n.id}`);const o=n.span==="quarter"?80:40,s=Sp(n,o,40);return s.style.width="100%",s.style.height="100%",s.style.maxWidth="100%",s.style.maxHeight="100%",t.appendChild(s),t},bindEvents(){const n=document.getElementById("triplet-stamps-toolbar-container");n&&(n.addEventListener("click",t=>{const e=t.target?.closest(".triplet-stamp-button");if(!e)return;const o=parseInt(e.dataset.tripletStampId||"",10);Number.isNaN(o)||this.selectTripletStamp(o)}),l.on("toolChanged",({newTool:t}={})=>{t&&t!=="tripletStamp"&&this.clearSelection()}),l.on("sixteenthStampToolSelected",()=>{this.clearSelection()}))},setInitialSelection(n){this.selectedTripletStampId=n;const t=document.getElementById("triplet-stamps-toolbar-container");t&&t.querySelectorAll(".triplet-stamp-button").forEach(e=>{const o=e;o.classList.toggle("active",parseInt(o.dataset.tripletStampId||"",10)===n)})},selectTripletStamp(n){this.selectedTripletStampId=n;const t=document.getElementById("triplet-stamps-toolbar-container");t&&t.querySelectorAll(".triplet-stamp-button").forEach(e=>{const o=e;o.classList.toggle("active",parseInt(o.dataset.tripletStampId||"",10)===n)}),l.setSelectedTool("tripletStamp"),l.emit("tripletStampSelected",n),l.emit("tripletStampToolSelected")},clearSelection(){const n=document.getElementById("triplet-stamps-toolbar-container");n&&n.querySelectorAll(".triplet-stamp-button").forEach(t=>{t.classList.remove("active")})},getSelectedTripletStamp(){return Po.find(t=>t.id===this.selectedTripletStampId)}};function Cp(){Lh.init(),It.initialize?.()??It.init?.(),Jo.init(),no.init(),b.initSuccess("RhythmUi")}class Ap{gridsWrapper=null;pitchGridWrapper=null;drumGridWrapper=null;gridScrollbarProxy=null;isInitialized=!1;lastScrollTime=0;isSyncingFromProxy=!1;isSyncingFromWrapper=!1;handleWrapperScroll;handleProxyScroll;init(){if(this.gridsWrapper=document.getElementById("grids-wrapper"),this.pitchGridWrapper=document.getElementById("pitch-grid-wrapper"),this.drumGridWrapper=document.getElementById("drum-grid-wrapper"),this.gridScrollbarProxy=document.getElementById("grid-scrollbar-proxy"),!this.gridsWrapper||!this.pitchGridWrapper||!this.drumGridWrapper){b.error("ScrollSyncService","Required elements not found for scroll sync",null,"scroll");return}this.setupScrollSynchronization(),this.isInitialized=!0,b.info("ScrollSyncService","Initialized with unified grids-wrapper structure",null,"scroll")}setupScrollSynchronization(){this.handleWrapperScroll=this.handleWrapperScrollInternal.bind(this),this.handleProxyScroll=this.handleProxyScrollInternal.bind(this),this.gridsWrapper.addEventListener("scroll",this.handleWrapperScroll,{passive:!0}),this.gridScrollbarProxy?this.gridScrollbarProxy.addEventListener("scroll",this.handleProxyScroll,{passive:!0}):b.warn("ScrollSyncService","Grid scrollbar proxy not found; falling back to native scrollbars.",null,"scroll")}handleWrapperScrollInternal(t){if(this.isSyncingFromProxy||!this.gridsWrapper)return;const e=Date.now();if(this.lastScrollTime=e,this.gridScrollbarProxy){const i=this.gridsWrapper.scrollLeft;Math.abs(this.gridScrollbarProxy.scrollLeft-i)>.5&&(this.isSyncingFromWrapper=!0,this.gridScrollbarProxy.scrollLeft=i,this.isSyncingFromWrapper=!1)}const o=t.target;b.debug("ScrollSyncService",`Unified scroll: ${o?.scrollLeft??0}px`,null,"scroll")}handleProxyScrollInternal(){if(this.isSyncingFromWrapper||!this.gridScrollbarProxy)return;const t=this.gridScrollbarProxy.scrollLeft;this.gridsWrapper&&Math.abs(this.gridsWrapper.scrollLeft-t)>.5&&(this.isSyncingFromProxy=!0,this.gridsWrapper.scrollLeft=t,this.isSyncingFromProxy=!1)}syncScrollTo(t){!this.isInitialized||!this.gridsWrapper||(this.isSyncingFromProxy=!0,this.isSyncingFromWrapper=!0,this.gridsWrapper.scrollLeft=t,this.gridScrollbarProxy&&(this.gridScrollbarProxy.scrollLeft=t),this.isSyncingFromProxy=!1,this.isSyncingFromWrapper=!1)}}const xp=new Ap,Ii={stroke:"#c7cfd8",background:"rgba(207, 214, 222, 0.32)"};let So=null;function il(){if(So)return So;if(typeof window>"u")return Ii;const n=window.getComputedStyle(document.documentElement);return So={stroke:n.getPropertyValue("--c-anacrusis-border").trim()||Ii.stroke,background:n.getPropertyValue("--c-anacrusis-bg").trim()||Ii.background},So}function Ep(n){if(n.length===0)return[];const t=[...n].sort((o,i)=>o.start-i.start),e=[];for(const o of t){if(e.length===0){e.push({...o});continue}const i=e[e.length-1];o.start<=i.end?i.end=Math.max(i.end,o.end):e.push({...o})}return e}function Mp(n){const t=[],e=Tp(l.state);return e!==null&&e>0&&t.push({start:Ue(0,n),end:Ue(e,n)}),n.placedTonicSigns.forEach(o=>{const i=Ue(o.columnIndex,n),s=Ue(o.columnIndex+2,n);t.push({start:i,end:s})}),Ep(t)}function Pp(n,t,e){const o=new Set([n,t]);e.forEach(a=>{const r=Math.max(n,Math.min(t,a.start)),c=Math.max(n,Math.min(t,a.end));c>r&&(o.add(r),o.add(c))});const i=Array.from(o).sort((a,r)=>a-r),s=[];for(let a=0;a<i.length-1;a++){const r=i[a],c=i[a+1],d=(r+c)/2,u=e.some(h=>d>=h.start&&d<h.end);c>r&&s.push({from:r,to:c,light:u})}return s}function Tp(n){if(!n.hasAnacrusis||!Array.isArray(n.macrobeatBoundaryStyles))return null;const t=n.macrobeatBoundaryStyles.findIndex(o=>o==="solid");if(t<0)return null;const e=Ut(n,t);return e?e.endColumn+1:null}function Ue(n,t){return Y(n,t)}function sl(n,t,e,o,i,s,a=1){const r=e+i/2,c=o+s/2,d=Math.min(i,s)*.4*a;if(n.beginPath(),t===0)n.moveTo(r,c-d),n.lineTo(r-d,c+d),n.lineTo(r+d,c+d),n.closePath();else if(t===1)n.moveTo(r,c-d),n.lineTo(r+d,c),n.lineTo(r,c+d),n.lineTo(r-d,c),n.closePath();else{for(let h=0;h<5;h++){const f=2*Math.PI/5*h-Math.PI/2,g=r+d*Math.cos(f),m=c+d*Math.sin(f);h===0?n.moveTo(g,m):n.lineTo(g,m)}n.closePath()}n.fill()}function Ip(n,t){const{columnWidths:e,musicalColumnWidths:o,macrobeatGroupings:i,macrobeatBoundaryStyles:s,placedTonicSigns:a}=t,c=(o&&o.length>0?o:e).length,d=i.map((u,h)=>{const{endColumn:f}=Ut(l.state,h);return f+1});for(let u=0;u<=c;u++){const h=u===0||u===c,f=br(u,a),g=a.some(w=>u===w.columnIndex+2),m=d.includes(u);if(!yr(u,a))continue;let v=null;if(h||f||g)v={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(m){const w=d.indexOf(u),S=s[w];if(S==="anacrusis"){const{stroke:M}=il();v={lineWidth:1,strokeStyle:M,dash:[4,4]}}else v={lineWidth:1,strokeStyle:"#adb5bd",dash:S==="solid"?[]:[5,5]}}if(!v)continue;const y=Ue(u,t);n.beginPath(),n.moveTo(y,0),n.lineTo(y,xt(n.canvas)),n.lineWidth=v.lineWidth,n.strokeStyle=v.strokeStyle,n.setLineDash(v.dash),n.stroke()}n.setLineDash([])}function kp(n,t){const{placedNotes:e,columnWidths:o,cellWidth:i,cellHeight:s,placedTonicSigns:a}=t;n.clearRect(0,0,Wt(n.canvas),xt(n.canvas));const r=Math.max(Vn,Xn*s),c=o.length,d=["H","M","L"],u=Mp(t),h=Pp(0,Wt(n.canvas),u),{stroke:f}=il();for(let g=0;g<4;g++){const m=g*r;h.forEach(p=>{p.to<=p.from||(n.beginPath(),n.moveTo(p.from,m),n.lineTo(p.to,m),n.strokeStyle=p.light?f:"#ced4da",n.lineWidth=1,n.globalAlpha=p.light?.6:1,n.stroke(),n.globalAlpha=1)})}Ip(n,t);for(let g=0;g<c;g++){if(a.some(v=>g===v.columnIndex||g===v.columnIndex+1))continue;const m=Ue(g,t);let p;t.modulationMarkers&&t.modulationMarkers.length>0?p=Ue(g+1,t)-m:p=(o[g]??0)*i;for(let v=0;v<3;v++){const y=v*r,w=d[v],S=e.find(M=>M.isDrum&&(typeof M.drumTrack=="number"?String(M.drumTrack):M.drumTrack)===w&&M.startColumnIndex===g);if(S){n.fillStyle=S.color;const M=Pe.getAnimationScale(g,w);sl(n,v,m,y,p,r,M)}else n.fillStyle="#ced4da",n.beginPath(),n.arc(m+p/2,y+r/2,2,0,Math.PI*2),n.fill()}}t.modulationMarkers&&t.modulationMarkers.length>0&&Br(n,t)}const ge={getColumnIndex(n){const{cellWidth:t,modulationMarkers:e,cellHeight:o,musicalColumnWidths:i}=l.state,s=l.state.columnWidths||[];if(t===0)return 0;const a={...l.state,modulationMarkers:e,cellWidth:t,columnWidths:s,baseMicrobeatPx:l.state.baseMicrobeatPx||t},r=Hi(n,a),c=Math.floor(r);return c},getPitchRowIndex(n){const t=$t.getViewportInfo();if(!t?.halfUnit||t.halfUnit===0)return-1;const e=t.halfUnit,o=Math.round(n/e-1),i=t.startRank+o,s=t.startRank,a=Math.max(s,(t.endRank??s+1)-1);return Math.max(s,Math.min(a,i))},getDrumRowIndex(n){const t=Math.max(Vn,Xn*l.state.cellHeight);return t===0?-1:Math.floor(n/t)}},Bs=["H","M","L"],Lp="canvas-container",Np="drum-grid-wrapper",al="eraser-tool-button",Rp="drum-grid",Bp="drum-hover-canvas";let qt=null,Go=!1,oo=!1,Ro=1,we=null,qa=0;const Dp=500,Vo=n=>{l.state.musicalColumnWidths&&l.state.musicalColumnWidths.length>0?l.state.musicalColumnWidths:l.state.columnWidths;const t={modulationMarkers:l.state.modulationMarkers||[],columnWidths:l.state.columnWidths,cellWidth:l.state.cellWidth,cellHeight:l.state.cellHeight,baseMicrobeatPx:l.state.baseMicrobeatPx||l.state.cellWidth||40};return Y(n,t)},rl=n=>{if(l.state.modulationMarkers&&l.state.modulationMarkers.length>0){const i=Vo(n);return Vo(n+1)-i}return((l.state.musicalColumnWidths&&l.state.musicalColumnWidths.length>0?l.state.musicalColumnWidths:l.state.columnWidths)[n]??1)*l.state.cellWidth},Xo=()=>Math.max(Vn,Xn*l.state.cellHeight),Ds=()=>{qt&&qt.clearRect(0,0,Wt(qt.canvas),xt(qt.canvas))};function cs(n,t,e){if(!qt)return;const o=Vo(n),i=t*Xo(),s=rl(n);qt.fillStyle=e,qt.fillRect(o,i,s,Xo())}function _p(n,t){if(!qt)return;const e=Vo(n),o=t*Xo(),i=rl(n),s=Bs[t];if(!s)return;const a=Pe.getAnimationScale(n,s),r=l.state.selectedTool?.color??"#212529";qt.globalAlpha=.4,qt.fillStyle=r,sl(qt,t,e,o,i,Xo(),a),qt.globalAlpha=1}const ll=()=>document.getElementById(Lp)?.scrollLeft??0;function Fp(n){const t=n.currentTarget;if(!t)return;const e=t.getBoundingClientRect(),o=n.clientX-e.left,i=n.clientY-e.top,s=ge.getColumnIndex(o+ll()),a=ge.getDrumRowIndex(i),r=l.state.musicalColumnWidths&&l.state.musicalColumnWidths.length>0?l.state.musicalColumnWidths.length:l.state.columnWidths.length;if(!qt||s<0||s>=r||a<0||a>2){_s();return}Ds();const c=Bs[a];c&&(Go?(l.eraseDrumNoteAt?.(s,c,!1)&&(oo=!0),cs(s,a,"rgba(220, 53, 69, 0.3)")):(cs(s,a,"rgba(74, 144, 226, 0.2)"),_p(s,a)))}function _s(){Ds()}function Wp(n){n.preventDefault();const t=n.currentTarget;if(!t)return;const e=t.getBoundingClientRect(),o=n.clientX-e.left,i=n.clientY-e.top,s=ge.getColumnIndex(o+ll()),a=l.state.musicalColumnWidths&&l.state.musicalColumnWidths.length>0?l.state.musicalColumnWidths.length:l.state.columnWidths.length;if(s<0||s>=a||!tu(s,l.state))return;const r=ge.getDrumRowIndex(i);if(r<0||r>2)return;const c=Bs[r];if(c){if(n.button===2){Go=!0,oo=!1,document.getElementById(al)?.classList.add("erasing-active"),l.eraseDrumNoteAt?.(s,c,!1)&&(oo=!0),Ds(),cs(s,r,"rgba(220, 53, 69, 0.3)");return}if(n.button===0){const d=l.state.selectedTool?.color??"#000000",u={isDrum:!0,drumTrack:c,startColumnIndex:s,endColumnIndex:s,color:d,shape:c==="H"?"triangle":c==="M"?"square":"pentagon"};l.toggleDrumNote?.(u);const f=window.transportService?.drumPlayers;f?.player&&(f.player(c).start(),Pe.triggerNotePop(s,c))}}}function Op(){Go&&(oo&&l.recordState?.(),Go=!1,oo=!1,document.getElementById(al)?.classList.remove("erasing-active")),_s()}function zp(){const n=document.getElementById(Np),t=n?.querySelector(".drum-grid-left-cell");if(!n||!t)return;let e=t.querySelector(".drum-left-content");if(!e){e=document.createElement("div"),e.className="drum-left-content";const a=e,r=document.createElement("button");r.className="drum-volume-button",r.type="button",r.setAttribute("aria-label","Drum volume"),r.innerHTML=`
      <span class="drum-volume-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" focusable="false" role="img">
          <path d="M3 10v4h4l5 5V5L7 10H3z" fill="currentColor"></path>
          <path d="M16 8.82v6.36c1.18-.85 2-2.22 2-3.64s-.82-2.79-2-3.64z" fill="currentColor"></path>
          <path d="M16 4v2c2.9 1.06 5 3.86 5 7s-2.1 5.94-5 7v2c4.01-1.15 7-4.97 7-9s-2.99-7.85-7-9z" fill="currentColor"></path>
        </svg>
      </span>
    `,r.style.gridRow="1 / span 3",r.style.gridColumn="1",["H","M","L"].forEach((c,d)=>{const u=document.createElement("span");u.className="drum-track-label",u.textContent=c,u.style.gridColumn="2",u.style.gridRow=`${d+1}`,a.appendChild(u)}),a.appendChild(r),t.appendChild(a)}const o=document.createElement("div");o.className="drum-volume-control",we=document.createElement("input"),we.type="range",we.min="0",we.max="100",we.value="100",we.className="drum-volume-slider",we.style.cssText="width: 80px; margin: 0;",we.addEventListener("input",a=>{const r=a.currentTarget;Ro=Number(r.value)/100;const c=window.drumVolumeNode;if(c?.volume){const d=Ro===0?-60:20*Math.log10(Ro);c.volume.value=d;const h=window.transportService?.drumPlayers,f=Date.now();h?.player&&f-qa>=Dp&&(h.player("M").start("+0.1"),qa=f)}}),o.appendChild(we),t.appendChild(o);const i=()=>{if(!o)return;o.classList.contains("visible")?o.classList.remove("visible"):o.classList.add("visible")},s=t.querySelector(".drum-volume-button");s&&s.addEventListener("click",a=>{a.stopPropagation(),i()}),document.addEventListener("click",a=>{const r=a.target,c=r?.closest(".drum-volume-control"),d=r?.closest(".drum-volume-button");!c&&!d&&o.classList.remove("visible")})}function $p(){return Ro}window.getDrumVolume=$p;function Hp(){const n=document.getElementById(Rp),t=document.getElementById(Bp);!n||!t||(qt=t.getContext("2d"),n.addEventListener("mousedown",Wp),n.addEventListener("mousemove",Fp),n.addEventListener("mouseleave",_s),n.addEventListener("contextmenu",e=>e.preventDefault()),window.addEventListener("mouseup",Op),zp())}function Ga(){const n=Yn.getDrumContext();if(!n?.canvas)return;const t={placedNotes:Bd(l.state),placedTonicSigns:Ot(l.state),columnWidths:l.state.columnWidths,musicalColumnWidths:l.state.musicalColumnWidths,cellWidth:l.state.cellWidth,cellHeight:l.state.cellHeight,macrobeatGroupings:l.state.macrobeatGroupings,macrobeatBoundaryStyles:l.state.macrobeatBoundaryStyles,modulationMarkers:l.state.modulationMarkers,baseMicrobeatPx:l.state.cellWidth};kp(n,t)}const jt={animationFrameId:null,render(){Ga(),Pe.hasActiveAnimations()?jt.animationFrameId||jt.startAnimationLoop():jt.stopAnimationLoop()},startAnimationLoop(){if(jt.animationFrameId)return;const n=()=>{Pe.cleanupAnimations(),Ga(),Pe.hasActiveAnimations()?jt.animationFrameId=requestAnimationFrame(n):jt.animationFrameId=null};jt.animationFrameId=requestAnimationFrame(n)},stopAnimationLoop(){jt.animationFrameId&&(cancelAnimationFrame(jt.animationFrameId),jt.animationFrameId=null)}};window.drumGridRenderer=jt;function Va(n){if(n)return n.uuid}function cl(n,t=null){const e=Array.isArray(t)?t:n.macrobeatGroupings||[],i=[...Ot(n)].sort((u,h)=>u.preMacrobeatIndex-h.preMacrobeatIndex);let s=0;const a=[];let r=0;const c=u=>{a.push({visualIndex:a.length,type:`legend-${u}`,timeIndex:null})},d=u=>{for(;s<i.length;){const h=i[s];if(h?.preMacrobeatIndex!==u)break;a.push({visualIndex:a.length,type:"tonic",timeIndex:null}),a.push({visualIndex:a.length,type:"tonic",timeIndex:null});const f=Va(h);if(f)do s++;while(s<i.length&&Va(i[s])===f);else s++}};return c("left"),c("left"),d(-1),e.forEach((u,h)=>{for(let f=0;f<u;f++)a.push({visualIndex:a.length,type:"time",timeIndex:r++});d(h)}),c("right"),c("right"),{entries:a,totalTimeColumns:r}}function qp(n,t,e=null){if(e!==null){const{entries:o}=cl(n,e),i=o[t];return i?i.timeIndex:null}return Kd(t,n)}function Gp(n,t,e=null){if(t==null)return null;if(e!==null){const{entries:o,totalTimeColumns:i}=cl(n,e);if(t<0||t>=i)return null;const s=o.find(a=>a.timeIndex===t);return s?s.visualIndex:null}return Zd(t,n)}let Co=!1,Re="C4",Uo=null;function Bo(){return{pitches:[],rootNote:Re,color:l.state.selectedNote?.color||"#000000"}}let de=Bo();function Vp(){const n=document.activeElement;if(!(n instanceof HTMLElement))return!0;const t=n.tagName.toLowerCase();return!(["input","textarea","select"].includes(t)||n.isContentEditable)}function Xp(n){const t=n.globalRow??n.row,e=l.state.fullRowData[t];return e?e.toneNote:"C4"}function Xa(){const n=l.state.placedNotes.slice().reverse().find(t=>!t.isDrum);Re=n?Xp(n):"C4"}function Ua(n){const{activeChordIntervals:t}=l.state;return!n||!t?.length?[]:t.map(e=>{const o=cn(n,e);return Nn(o)})}function Up(){Xa(),l.on("notesChanged",Xa),document.addEventListener("keydown",n=>{if(n.code!=="Enter"||Co||n.repeat||!Vp())return;n.preventDefault(),Co=!0;const t=l.state.selectedNote?.color;let e,o=[];if(Uo&&t){const i=l.state.fullRowData[Uo.row];e=i?i.toneNote:Re,l.state.selectedTool==="chord"?o=Ua(e):o=[e]}else t&&Re&&(e=Re,l.state.selectedTool==="chord"?o=Ua(Re):o=[Re]);if(o.length>0&&t&&e){de={pitches:[...o],rootNote:e,color:t},o.forEach(d=>{wt.triggerAttack(d,t)});const i=l.state.fullRowData.find(d=>d.toneNote===e),s=i?i.hex:"#888888",a=l.state.timbres[t];if(!a)return;const r=a.adsr;Jt.adsrComponent?.playheadManager.trigger("spacebar","attack",s,r),l.emit("spacebarPlayback",{note:e,color:t,isPlaying:!0});const c=`spacebar-${Date.now()}`;l.emit("noteAttack",{noteId:c,color:t}),de.noteId=c}}),document.addEventListener("keyup",n=>{if(n.code!=="Enter"||!Co)return;n.preventDefault(),Co=!1;const t=de.pitches;if(!Array.isArray(t)||t.length===0){de=Bo();return}const e=de.color;if(e){t.forEach(c=>{wt.triggerRelease(c,e)});const o=de.rootNote??Re,i=l.state.fullRowData.find(c=>c.toneNote===o),s=i?i.hex:"#888888",a=l.state.timbres[e];if(!a){de=Bo();return}const r=a.adsr;Jt.adsrComponent?.playheadManager.trigger("spacebar","release",s,r),l.emit("spacebarPlayback",{note:o,color:e,isPlaying:!1}),de.noteId&&l.emit("noteRelease",{noteId:de.noteId,color:e})}de=Bo()})}function dl(n,t){Uo={col:n,row:t};const e=l.state.selectedNote?.color;e&&l.emit("ghostNoteUpdated",{color:e})}function ul(){Uo=null,l.emit("ghostNoteCleared")}const Yp={single:40,chord:20,transient:30};function hl(n){return String(n)}function jp(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}const Ya={single:0,chord:0,transient:0},_e=new Map;function ja(n,t){const e=hl(t),o=_e.get(n)??new Set;o.add(e),_e.set(n,o)}function Qa(n,t){const e=_e.get(n);e&&(e.delete(hl(t)),e.size===0&&_e.delete(n))}const Ht={shouldPlayPreview(n){const t=jp(),e=Yp[n],o=Ya[n];return t-o<e?!1:(Ya[n]=t,!0)},triggerAttack(n,t,e={}){const o=e.kind??"single";return!e.bypassThrottle&&!this.shouldPlayPreview(o)?!1:(wt.triggerAttack(n,t),ja(t,n),!0)},triggerAttacks(n,t,e={}){const o=e.kind??"chord";return!e.bypassThrottle&&!this.shouldPlayPreview(o)?!1:(n.forEach(i=>{wt.triggerAttack(i,t),ja(t,i)}),!0)},triggerRelease(n,t){wt.triggerRelease(n,t),Qa(t,n)},releasePitches(n,t){n.forEach(e=>{this.triggerRelease(e,t)})},quickReleasePitches(n,t){!n||n.length===0||(wt.quickReleasePitches(n,t),n.forEach(e=>Qa(t,e)))},playTransient(n,t,e=100){this.triggerAttack(n,t,{kind:"transient"})&&setTimeout(()=>this.triggerRelease(n,t),e)},releaseAll(n){if(typeof n=="string"){const t=_e.get(n);if(!t)return;Array.from(t.values()).forEach(e=>{wt.triggerRelease(e,n)}),_e.delete(n);return}for(const[t,e]of _e.entries())Array.from(e.values()).forEach(o=>{wt.triggerRelease(o,t)});_e.clear()}};class Qp{isDragging=!1;draggedModulationMarker=null;lastModulationHoverResult=null;handleMouseDown(t,e){for(const o of l.state.modulationMarkers||[]){const i=o.xCanvas??o.xPosition??0,s=ha(t,e,{...o,xCanvas:i});if(s){if(s.type==="label"){const a=o.ratio===Kt.COMPRESSION_2_3?Kt.EXPANSION_3_2:Kt.COMPRESSION_2_3;return l.setModulationRatio(o.id,a),!0}if(s.type==="barline"&&s.canDrag)return this.isDragging=!0,this.draggedModulationMarker=o,document.body.style.cursor=ma(s),!0}}return!1}handlePlacementClick(t,e){if(l.state.selectedTool!=="modulation")return!1;const o=l.state.selectedModulationRatio;if(typeof o!="number")return b.warn("PitchGridModulationToolInteractor","No modulation ratio selected before placement",null,"grid"),!0;const i=e(t);if(!i)return b.warn("PitchGridModulationToolInteractor","Modulation placement must be near a measure boundary",{clickX:t},"grid"),!0;b.debug("PitchGridModulationToolInteractor","Placing modulation marker at boundary",{measureIndex:i.measureIndex,ratio:o,clickX:t,boundaryX:i.xPosition},"grid");const s=l.addModulationMarker(i.measureIndex,o,i.xPosition,null,i.macrobeatIndex);return b.debug("PitchGridModulationToolInteractor","Modulation marker placed",{markerId:s,measureIndex:i.measureIndex,ratio:o},"grid"),!0}handleMouseMove(t){if(!this.isDragging||!this.draggedModulationMarker)return!1;const e=l.state.baseMicrobeatPx||l.state.cellWidth||40,o=Math.round(t/e)*e;return l.moveModulationMarker(this.draggedModulationMarker.id,o),!0}getHoveredMarker(t,e){for(const o of l.state.modulationMarkers||[]){const i=o.xCanvas??o.xPosition??0,s=ha(t,e,{...o,xCanvas:i});if(s)return s}return null}updateCursor(t,e){if(e){t.style.cursor=ma(e),this.lastModulationHoverResult=e;return}this.lastModulationHoverResult&&(t.style.cursor="default",this.lastModulationHoverResult=null)}handleMouseUp(){return this.isDragging?(this.isDragging=!1,this.draggedModulationMarker=null,!0):!1}}class Kp{handleExistingNoteMouseDown(t,e,o,i){if(l.state.selectedTool!=="note")return{handled:!1,state:o};const s=l.state.placedNotes.find(h=>!h.isDrum&&h.row===e&&t>=h.startColumnIndex&&t<=h.endColumnIndex);if(!s)return{handled:!1,state:o};const a=i.getPitchForRow(e);if(!a)return{handled:!0,state:o};const r=window.waveformVisualizer;r&&(r.currentColor=s.color,r.generateWaveform(),r.startSingleNoteVisualization(s.color));const c=It.getSixteenthStampAtPosition(t,e);if(c)return It.playRhythmPattern(c.sixteenthStampId,a,s.color,s.shape,c),{handled:!0,state:{...o,activePreviewPitches:[a],activeNote:s}};Ht.triggerAttack(a,s.color,{kind:"single",bypassThrottle:!0});const d=l.state.fullRowData[e]?.hex||"#888888",u=l.state.timbres[s.color]?.adsr;return u&&Jt.adsrComponent?.playheadManager.trigger(s.uuid,"attack",d,u),{handled:!0,state:{...o,activePreviewPitches:[a],activeNote:s}}}attemptPlaceNoteAt(t,e,o,i,s){if(l.state.selectedTool!=="note")return{placed:!1,state:o,shouldStartDragging:!1};if(!jn(t,l.state))return{placed:!1,state:o,shouldStartDragging:!1};const a=l.state.selectedNote;if(!a)return{placed:!1,state:o,shouldStartDragging:!1};const{shape:r,color:c}=a;if(r==="circle"&&!jn(t+1,l.state))return{placed:!1,state:o,shouldStartDragging:!1};const d=r==="circle"?t+1:t,u={row:e,startColumnIndex:t,endColumnIndex:d,color:c,shape:r,isDrum:!1},h=l.addNote(u);if(!h)return{placed:!1,state:o,shouldStartDragging:!1};const f={...o,activeNote:h,lastDragRow:e};h.uuid&&l.emit("noteInteractionStart",{noteId:h.uuid,color:h.color});const g=s.getPitchForRow(e);if(g){h.uuid&&(i.add(h.uuid),l.emit("noteAttack",{noteId:h.uuid,color:h.color})),f.activePreviewPitches=[g],Ht.triggerAttack(g,h.color,{kind:"single",bypassThrottle:!0});const m=l.state.fullRowData[e]?.hex||"#888888",p=l.state.timbres[h.color]?.adsr;p&&Jt.adsrComponent?.playheadManager.trigger(h.uuid,"attack",m,p);const v=window.waveformVisualizer;v&&(v.currentColor=h.color,v.generateWaveform(),v.startSingleNoteVisualization(h.color))}return{placed:!0,state:f,shouldStartDragging:!0}}handleActiveNoteDrag(t,e,o,i){const s=o.activeNote;if(!s)return o;const a=t,r=e,c=s.uuid;if(s.shape==="circle"){if(a!==s.endColumnIndex&&l.updateNoteTail(s,a),r!==o.lastDragRow){const d=i.getPitchForRow(r);if(!d)return o;o.activePreviewPitches.length>0&&Ht.quickReleasePitches(o.activePreviewPitches,s.color);const u=l.state.placedNotes.find(v=>v.uuid===c);u&&l.updateNoteRow(u,r);const f=l.state.placedNotes.find(v=>v.uuid===c)||u||s;let g=o.activePreviewPitches;Ht.triggerAttack(d,f.color,{kind:"single"})&&(g=[d]);const m=l.state.fullRowData[r]?.hex||"#888888",p=l.state.timbres[f.color]?.adsr;return p&&f.uuid&&Jt.adsrComponent?.playheadManager.trigger(f.uuid,"attack",m,p),{...o,activeNote:f,lastDragRow:r,activePreviewPitches:g}}return o}if(s.shape==="oval"){const d=t;if(d!==s.startColumnIndex&&l.updateNotePosition(s,d),r!==o.lastDragRow){const u=i.getPitchForRow(r);if(!u)return o;o.activePreviewPitches.length>0&&Ht.quickReleasePitches(o.activePreviewPitches,s.color);const h=l.state.placedNotes.find(y=>y.uuid===c);h&&l.updateNoteRow(h,r);const g=l.state.placedNotes.find(y=>y.uuid===c)||h||s;let m=o.activePreviewPitches;Ht.triggerAttack(u,g.color,{kind:"single"})&&(m=[u]);const p=l.state.fullRowData[r]?.hex||"#888888",v=l.state.timbres[g.color]?.adsr;return v&&g.uuid&&Jt.adsrComponent?.playheadManager.trigger(g.uuid,"attack",p,v),{...o,activeNote:g,lastDragRow:r,activePreviewPitches:m}}}return o}}class Zp{handleMouseDown(t,e){if(l.state.selectedTool!=="eraser")return{handled:!1,shouldStartDrag:!1};l.eraseInPitchArea(t,e,2,!1);const o=t+2-1,i=e-1,s=e+1;return dm(t,o,i,s),fm(t,o,i,s),{handled:!0,shouldStartDrag:!0}}handleMouseMove(t,e,o){if(!o)return!1;l.eraseInPitchArea(t,e,2,!1);const i=t+2-1,s=e-1,a=e+1;return l.eraseSixteenthStampsInArea(t,i,s,a),l.eraseTripletStampsInArea(t,i,s,a),!0}}class Jp{handleMouseDown(t,e,o,i,s){if(l.state.selectedTool!=="chord")return{handled:!1,state:o,shouldStartDragging:!1};if(!jn(t,l.state))return{handled:!0,state:o,shouldStartDragging:!1};const a=s.getPitchForRow(e);if(!a)return{handled:!0,state:o,shouldStartDragging:!1};const r=s.getChordPitchesForRootPitch(a),c=l.state.selectedNote;if(!c)return{handled:!0,state:o,shouldStartDragging:!1};const{shape:d,color:u}=c;Ht.triggerAttacks(r,u,{kind:"chord",bypassThrottle:!0});const h=l.state.fullRowData[e]?.hex||"#888888",f=l.state.timbres[u]?.adsr;f&&Jt.adsrComponent?.playheadManager.trigger("chord_preview","attack",h,f);const g=[];return r.forEach(m=>{const p=l.state.fullRowData.findIndex(S=>S.toneNote===m);if(p===-1)return;const v=d==="circle"?t+1:t,y={row:p,startColumnIndex:t,endColumnIndex:v,color:u,shape:d,isDrum:!1},w=l.addNote(y);w&&(g.push(w),w.uuid&&(i.add(w.uuid),l.emit("noteAttack",{noteId:w.uuid,color:w.color}),l.emit("noteInteractionStart",{noteId:w.uuid,color:w.color})))}),{handled:!0,shouldStartDragging:!0,state:{...o,activeChordNotes:g,activePreviewPitches:[...r],lastDragRow:e}}}handleActiveChordDrag(t,e,o,i){if(!o.activeChordNotes||o.activeChordNotes.length===0)return o;const s=o.activeChordNotes[0];if(!s)return o;const a=s.color,r=e;if(s.shape==="circle"){const c=t,d=o.activeChordNotes.filter(u=>c!==u.endColumnIndex);if(d.length>0&&l.updateMultipleNoteTails(d,c),r!==o.lastDragRow){const u=o.lastDragRow??s.row,h=r-u;if(h===0)return o;Ht.quickReleasePitches(o.activePreviewPitches,a);const f=o.activeChordNotes.map(p=>p.row+h);if(!f.every(p=>i.getPitchForRow(p)!==null))return o;l.updateMultipleNoteRows(o.activeChordNotes,f);const m=f.map(p=>i.getPitchForRow(p)).filter(p=>typeof p=="string");return Ht.triggerAttacks(m,a,{kind:"chord"}),{...o,activePreviewPitches:m,lastDragRow:r}}return o}if(s.shape==="oval"){const c=t,d=o.activeChordNotes.filter(p=>c!==p.startColumnIndex);d.length>0&&l.updateMultipleNotePositions(d,c);const u=o.lastDragRow!==null?o.lastDragRow:s.row,h=r-u;if(h===0)return o;Ht.quickReleasePitches(o.activePreviewPitches,a);const f=o.activeChordNotes.map(p=>p.row+h);if(!f.every(p=>i.getPitchForRow(p)!==null))return o;l.updateMultipleNoteRows(o.activeChordNotes,f);const m=f.map(p=>i.getPitchForRow(p)).filter(p=>typeof p=="string");return Ht.triggerAttacks(m,a,{kind:"chord"}),{...o,activePreviewPitches:m,lastDragRow:r}}return o}}function tg(n,t,e,o){const i=Qo(e.sixteenthStampId);if(!i)return null;const s=Y(e.startColumn,o),a=o.cellWidth*2,r=o.cellHeight,c=[.125,.375,.625,.875].map(d=>s+d*a);for(const d of i.diamonds){const u=`diamond_${d}`,h=e.shapeOffsets?.[u]||0,f=e.row+h,g=ct(f,o),m=c[d];if(m===void 0)continue;const p=Math.sqrt(Math.pow(n-m,2)+Math.pow(t-g,2)),v=Math.min(a*.2,r*1);if(p<v)return{type:"diamond",slot:d??0,shapeKey:u,cx:m,cy:g,placement:e}}for(const d of i.ovals){const u=`oval_${d}`,h=e.shapeOffsets?.[u]||0,f=e.row+h,g=ct(f,o),m=d===0?s+.25*a:s+.75*a,p=Math.sqrt(Math.pow(n-m,2)+Math.pow(t-g,2)),v=Math.min(a*.25,r*1);if(p<v)return{type:"oval",slot:d,shapeKey:u,cx:m,cy:g,placement:e}}return null}function Ka(n,t,e,o){for(const i of e){const s=tg(n,t,i,o);if(s)return s}return null}class eg{draggedStampShape=null;isDraggingShape(){return this.draggedStampShape!==null}tryStartShapeDrag(t){const e=l.getAllSixteenthStampPlacements(),o={...l.state},i=Ka(t.actualX,t.canvasY,e,o);return i?(this.draggedStampShape={...i,startRow:l.getSixteenthStampShapeRow(i.placement,i.shapeKey),startMouseY:t.canvasY},!0):!1}handleMouseDown(t){if(this.tryStartShapeDrag({actualX:t.actualX,canvasY:t.canvasY}))return{handled:!0};if(l.state.selectedTool!=="sixteenthStamp")return{handled:!1};const e=It.getSixteenthStampAtPosition(t.colIndex,t.rowIndex);if(e){const d=t.getPitchForRow(t.rowIndex);if(!d)return{handled:!0};const u=l.state.placedNotes.find(f=>!f.isDrum&&f.row===t.rowIndex&&t.colIndex>=f.startColumnIndex&&t.colIndex<=f.endColumnIndex),h=u?u.shape:"oval";return It.playRhythmPattern(e.sixteenthStampId,d,e.color,h,e),{handled:!0,activePreviewPitches:[d]}}const o=Jo.getSelectedSixteenthStamp();if(!o)return{handled:!0};const i=t.getTimeAlignedCanvasColumn(t.colIndex);if(i===null)return{handled:!0};const s=l.state.selectedNote;if(!s)return{handled:!0};const{color:a,shape:r}=s;cm(o.id,i,t.rowIndex,a);const c=t.getPitchForRow(t.rowIndex);return c?(It.playRhythmPattern(o.id,c,a,r),l.recordState(),{handled:!0,activePreviewPitches:[c]}):(l.recordState(),{handled:!0})}handleMouseMove(t){if(!this.draggedStampShape)return!1;const e=t.rowIndex-this.draggedStampShape.placement.row;if(l.updateSixteenthStampShapeOffset(this.draggedStampShape.placement.id,this.draggedStampShape.shapeKey,e),t.rowIndex!==this.draggedStampShape.startRow){const o=t.getPitchForRow(t.rowIndex);if(o){const i=this.draggedStampShape.placement.color||l.state.selectedNote?.color;i&&Ht.playTransient(o,i,100)}this.draggedStampShape.startRow=t.rowIndex}return t.canvasEl&&(t.canvasEl.style.cursor="ns-resize"),!0}updateHoverCursor(t){if(l.state.selectedTool!=="sixteenthStamp"||this.draggedStampShape)return;const e=t.canvasEl;if(!e)return;const o=l.getAllSixteenthStampPlacements(),i={...l.state};Ka(t.actualX,t.canvasY,o,i)||ng(t.actualX,t.canvasY,o,i)?e.style.cursor="grab":e.style.cursor="default"}handleMouseUp(){if(!this.draggedStampShape)return!1;this.draggedStampShape=null,l.recordState();const t=document.getElementById("notation-grid");return t&&(t.style.cursor="default"),!0}}function ng(n,t,e,o){const i=o.columnWidths||[];for(const s of e){const a=s.startColumn,r=Math.min(s.endColumn,i.length),c=Y(a,o),d=Y(r,o),h=ct(s.row,o)-o.cellHeight/2;if(n>=c&&n<=d&&t>=h&&t<=h+o.cellHeight)return!0}return!1}function og(n,t,e,o){const i=Ko(e.tripletStampId);if(!i)return null;const s=e.span*2,a=Yt(e.startTimeIndex,l.state),r=a+s,c=Y(a,o),u=Y(r,o)-c,h=o.cellHeight;for(const f of i.hits){const g=`triplet_${f}`,m=e.shapeOffsets?.[g]||0,p=e.row+m,v=ct(p,o),y=Nr[f];if(y===void 0)continue;const w=c+u*y/100,S=Math.sqrt(Math.pow(n-w,2)+Math.pow(t-v,2)),M=Math.min(u*.15,h*1);if(S<M)return{type:"tripletStamp",slot:f,shapeKey:g,cx:w,cy:v,placement:e}}return null}function Za(n,t,e,o){for(const i of e){const s=og(n,t,i,o);if(s)return s}return null}class ig{draggedTripletShape=null;isDraggingShape(){return this.draggedTripletShape!==null}tryStartShapeDrag(t){const e=l.getAllTripletStampPlacements(),o={...l.state},i=Za(t.actualX,t.canvasY,e,o);return i?(this.draggedTripletShape={...i,startRow:l.getTripletStampShapeRow(i.placement,i.shapeKey),startMouseY:t.canvasY},!0):!1}handleMouseDown(t){if(this.tryStartShapeDrag({actualX:t.actualX,canvasY:t.canvasY}))return{handled:!0};if(l.state.selectedTool!=="tripletStamp")return{handled:!1};const e=Oe(t.colIndex,l.state);if(e===null)return{handled:!0};const o=e,i=It.getTripletStampAtPosition(o,t.rowIndex);if(i){const c=t.getPitchForRow(t.rowIndex);return c?(It.playTripletPattern(i.tripletStampId,c,i.color,i),{handled:!0,activePreviewPitches:[c]}):{handled:!0}}const s=no.getSelectedTripletStamp();if(!s||!l.state.selectedNote)return{handled:!0};const a=hm(s.id,o,t.rowIndex,l.state.selectedNote.color),r=t.getPitchForRow(t.rowIndex);return r&&a?(It.playTripletPattern(s.id,r,l.state.selectedNote.color,a),l.recordState(),{handled:!0,activePreviewPitches:[r]}):(l.recordState(),{handled:!0})}handleMouseMove(t){if(!this.draggedTripletShape)return!1;const e=t.rowIndex-this.draggedTripletShape.placement.row;if(l.updateTripletStampShapeOffset(this.draggedTripletShape.placement.id,this.draggedTripletShape.shapeKey,e),t.rowIndex!==this.draggedTripletShape.startRow){const o=t.getPitchForRow(t.rowIndex);if(o){const i=this.draggedTripletShape.placement.color||l.state.selectedNote?.color;i&&Ht.playTransient(o,i,100)}this.draggedTripletShape.startRow=t.rowIndex}return t.canvasEl&&(t.canvasEl.style.cursor="ns-resize"),!0}updateHoverCursor(t){if(l.state.selectedTool!=="tripletStamp"||this.draggedTripletShape)return;const e=t.canvasEl;if(!e)return;const o=l.getAllTripletStampPlacements(),i={...l.state};Za(t.actualX,t.canvasY,o,i)||sg(t.actualX,t.canvasY,o,i)?e.style.cursor="grab":e.style.cursor="default"}handleMouseUp(){if(!this.draggedTripletShape)return!1;this.draggedTripletShape=null,l.recordState();const t=document.getElementById("notation-grid");return t&&(t.style.cursor="default"),!0}}function sg(n,t,e,o){for(const i of e){const s=i.span*2,a=Yt(i.startTimeIndex,l.state),r=a+s,c=Y(a,o),d=Y(r,o),h=ct(i.row,o)-o.cellHeight/2;if(n>=c&&n<=d&&t>=h&&t<=h+o.cellHeight)return!0}return!1}function ag(n){const{macrobeatGroupings:t,macrobeatBoundaryStyles:e,columnWidths:o}=l.state,i=o.length;if(n<0||n>=i)return null;let s=-1;for(let h=0;h<t.length;h++){const{startColumn:f,endColumn:g}=Ut(l.state,h);if(n>=f&&n<=g){s=h;break}}if(s===-1)return null;let a=0;for(let h=s-1;h>=0;h--)if(e[h]==="solid"){a=h+1;break}const r=a-1;return(h=>h<=0?!0:e[h-1]==="solid")(a)?{drawColumn:Ut(l.state,a).startColumn,preMacrobeatIndex:r}:null}function Ja(n){return n.replace(/\d+$/,"")}class rg{lastHoveredTonicPoint=null;lastHoveredOctaveRows=[];resetHoverState(){this.lastHoveredTonicPoint=null,this.lastHoveredOctaveRows=[]}handleMouseMove(t){if(l.state.selectedTool!=="tonicization")return(this.lastHoveredTonicPoint||this.lastHoveredOctaveRows.length>0)&&this.resetHoverState(),!1;const e=ag(t.colIndex);if(!e)return this.resetHoverState(),!0;if(Ot(l.state).some(u=>u.preMacrobeatIndex===e.preMacrobeatIndex))return this.resetHoverState(),!0;const s=t.getPitchForRow(t.rowIndex);if(!s)return this.resetHoverState(),!0;const a=Ja(s),r=Ae.map((u,h)=>({rowData:u,masterIndex:h})).filter(({rowData:u})=>u.toneNote&&Ja(u.toneNote)===a).map(({masterIndex:u})=>u);this.lastHoveredTonicPoint=e,this.lastHoveredOctaveRows=r;const c=r.filter(u=>u>=0&&u<l.state.fullRowData.length);t.hoverCtx.globalAlpha=.5;const d={...l.state,zoomLevel:$t.getViewportInfo().zoomLevel};return c.forEach(u=>{const h={row:u,globalRow:u,columnIndex:e.drawColumn,tonicNumber:l.state.selectedToolTonicNumber,preMacrobeatIndex:e.preMacrobeatIndex};kr(t.hoverCtx,d,h)}),t.hoverCtx.globalAlpha=1,!0}handleMouseDown(){if(l.state.selectedTool!=="tonicization")return!1;if(!this.lastHoveredTonicPoint||this.lastHoveredOctaveRows.length===0)return!0;const t=this.lastHoveredTonicPoint;if(Ot(l.state).some(s=>s.preMacrobeatIndex===t.preMacrobeatIndex))return this.resetHoverState(),!0;const i=this.lastHoveredOctaveRows.map(s=>({row:s,tonicNumber:l.state.selectedToolTonicNumber,preMacrobeatIndex:t.preMacrobeatIndex,columnIndex:t.drawColumn}));return l.addTonicSignGroup(i),this.resetHoverState(),!0}}class lg{constructor(t){this.deps=t}handleToolMouseDown(t){const{toolType:e,colIndex:o,rowIndex:i,actualX:s,canvasY:a}=t,r=t.state;if(e==="chord"){const c=this.deps.chordToolInteractor.handleMouseDown(o,i,{activeChordNotes:r.activeChordNotes,lastDragRow:r.lastDragRow,activePreviewPitches:r.activePreviewPitches},this.deps.placementFillNoteIds,{getPitchForRow:this.deps.getPitchForRow,getChordPitchesForRootPitch:this.deps.getChordPitchesForRootPitch});return{handled:c.handled,state:{...r,isDragging:c.shouldStartDragging?!0:r.isDragging,activeChordNotes:c.state.activeChordNotes,lastDragRow:c.state.lastDragRow,activePreviewPitches:c.state.activePreviewPitches}}}if(e==="tonicization")return this.deps.tonicizationToolInteractor.handleMouseDown(),{handled:!0,state:r};if(e==="eraser"){const c=this.deps.eraserToolInteractor.handleMouseDown(o,i);return{handled:c.handled,state:{...r,isEraserDragActive:c.handled?c.shouldStartDrag:r.isEraserDragActive}}}if(e==="sixteenthStamp"){const c=this.deps.stampToolInteractor.handleMouseDown({colIndex:o,rowIndex:i,actualX:s,canvasY:a,getPitchForRow:this.deps.getPitchForRow,getTimeAlignedCanvasColumn:this.deps.getTimeAlignedCanvasColumn});return{handled:c.handled,state:{...r,activePreviewPitches:c.activePreviewPitches??r.activePreviewPitches}}}if(e==="tripletStamp"){const c=this.deps.tripletToolInteractor.handleMouseDown({colIndex:o,rowIndex:i,actualX:s,canvasY:a,getPitchForRow:this.deps.getPitchForRow});return{handled:c.handled,state:{...r,activePreviewPitches:c.activePreviewPitches??r.activePreviewPitches}}}if(e==="modulation")return this.deps.modulationToolInteractor.handlePlacementClick(s,this.deps.findNearestMeasureBoundary),{handled:!0,state:r};if(e==="note"){const c=this.deps.noteToolInteractor.attemptPlaceNoteAt(o,i,{activeNote:r.activeNote,lastDragRow:r.lastDragRow,activePreviewPitches:r.activePreviewPitches},this.deps.placementFillNoteIds,{getPitchForRow:this.deps.getPitchForRow});return{handled:!0,state:{...r,isDragging:c.placed&&c.shouldStartDragging?!0:r.isDragging,activeNote:c.state.activeNote,lastDragRow:c.state.lastDragRow,activePreviewPitches:c.state.activePreviewPitches}}}return{handled:!1,state:r}}handleToolMouseMoveBeforeBoundsCheck(t){const{actualX:e,rowIndex:o,canvasEl:i,state:s}=t;return this.deps.modulationToolInteractor.handleMouseMove(e)?{handled:!0,state:s}:this.deps.stampToolInteractor.handleMouseMove({rowIndex:o,canvasEl:i,getPitchForRow:this.deps.getPitchForRow})?{handled:!0,state:s}:this.deps.tripletToolInteractor.handleMouseMove({rowIndex:o,canvasEl:i,getPitchForRow:this.deps.getPitchForRow})?{handled:!0,state:s}:{handled:!1,state:s}}handleNoteOrChordDragMouseMove(t){const{colIndex:e,rowIndex:o}=t,i=t.state;if(!i.isDragging||!i.activeNote&&i.activeChordNotes.length===0)return{handled:!1,state:i};if(i.activeNote){const a=this.deps.noteToolInteractor.handleActiveNoteDrag(e,o,{activeNote:i.activeNote,lastDragRow:i.lastDragRow,activePreviewPitches:i.activePreviewPitches},{getPitchForRow:this.deps.getPitchForRow});return{handled:!0,state:{...i,activeNote:a.activeNote,lastDragRow:a.lastDragRow,activePreviewPitches:a.activePreviewPitches}}}const s=this.deps.chordToolInteractor.handleActiveChordDrag(e,o,{activeChordNotes:i.activeChordNotes,lastDragRow:i.lastDragRow,activePreviewPitches:i.activePreviewPitches},{getPitchForRow:this.deps.getPitchForRow});return{handled:!0,state:{...i,activeChordNotes:s.activeChordNotes,lastDragRow:s.lastDragRow,activePreviewPitches:s.activePreviewPitches}}}handleToolHoverVisuals(t){const{toolType:e,actualX:o,canvasY:i,pitchHoverCtx:s,canvasEl:a}=t;e==="sixteenthStamp"?this.deps.stampToolInteractor.updateHoverCursor({actualX:o,canvasY:i,canvasEl:a}):e==="tripletStamp"&&this.deps.tripletToolInteractor.updateHoverCursor({actualX:o,canvasY:i,canvasEl:a});const r=this.deps.modulationToolInteractor.getHoveredMarker(o,i);if(e==="modulation"&&!r&&s){const c=t.findNearestMeasureBoundary(o),d=t.selectedModulationRatio;c&&typeof d=="number"&&t.drawModulationPreview(s,c.xPosition,d)}a&&this.deps.modulationToolInteractor.updateCursor(a,r)}handleToolMouseUp(){return!!(this.deps.stampToolInteractor.handleMouseUp()||this.deps.tripletToolInteractor.handleMouseUp()||this.deps.modulationToolInteractor.handleMouseUp())}handleChordToolHover(t){if(l.state.selectedTool!=="chord")return!1;const e=this.deps.getPitchForRow(t.rowIndex);if(!e)return!0;const o=this.deps.getChordPitchesForRootPitch(e),i=l.state.selectedNote;if(!i)return!0;const{shape:s,color:a}=i;return t.pitchHoverCtx.globalAlpha=.4,o.forEach(r=>{const c=l.state.fullRowData.findIndex(f=>f.toneNote===r);if(c<=-1)return;const d=s==="circle"?t.colIndex+1:t.colIndex,u={row:c,startColumnIndex:t.colIndex,endColumnIndex:d,color:a,shape:s,isDrum:!1},h={...l.state,zoomLevel:t.zoomLevel};s==="oval"?t.drawSingleColumnOvalNote(t.pitchHoverCtx,h,u,c):t.drawTwoColumnOvalNote(t.pitchHoverCtx,h,u,c)}),t.pitchHoverCtx.globalAlpha=1,!0}}class cg{isActive=!1;actionTaken=!1;previousTool=null;getIsActive(){return this.isActive}handleMouseDown(t){const{event:e,colIndex:o,rowIndex:i,annotationService:s}=t;if(e.button!==2)return!1;e.preventDefault(),this.isActive=!0,this.actionTaken=!1,l.state.selectedTool!=="eraser"&&(this.previousTool=l.state.selectedTool,l.setSelectedTool("eraser")),Te.get("eraserButton")?.classList.add("erasing-active"),this.actionTaken||=!!l.eraseInPitchArea(o,i,2,!1),this.actionTaken||=!!l.eraseTonicSignAt(o,!1);const a=o+2-1,r=i-1,c=i+1;this.actionTaken||=!!l.eraseSixteenthStampsInArea(o,a,r,c),this.actionTaken||=!!l.eraseTripletStampsInArea(o,a,r,c);const d=e.target instanceof Element?e.target:null;if(d){const u=d.getBoundingClientRect(),h=e.clientX-u.left,f=e.clientY-u.top;this.actionTaken||=!!s.eraseAtPoint(h,f)}return!0}handleMouseMove(t){if(!this.isActive)return!1;const{event:e,colIndex:o,rowIndex:i,annotationService:s}=t;this.actionTaken||=!!l.eraseInPitchArea(o,i,2,!1),this.actionTaken||=!!l.eraseTonicSignAt(o,!1);const a=o+2-1,r=i-1,c=i+1;this.actionTaken||=!!l.eraseSixteenthStampsInArea(o,a,r,c),this.actionTaken||=!!l.eraseTripletStampsInArea(o,a,r,c);const d=e.target instanceof Element?e.target:null;if(d){const u=d.getBoundingClientRect(),h=e.clientX-u.left,f=e.clientY-u.top;this.actionTaken||=!!s.eraseAtPoint(h,f)}return!0}handleGlobalMouseUp(){return this.isActive?(this.actionTaken&&l.recordState(),this.isActive=!1,this.actionTaken=!1,this.previousTool&&(l.setSelectedTool(this.previousTool),this.previousTool=null),Te.get("eraserButton")?.classList.remove("erasing-active"),!0):!1}}class dg{constructor(t,e){this.deps=t,this.options=e}pitchCanvasElement=null;mobileLongPressTimer=null;mobileTouchState=null;mobileGhostActive=!1;setPitchCanvasElement(t){this.pitchCanvasElement=t}handleTouchStart(t){if(!this.deps.shouldUseMobileLongPress()||this.mobileTouchState)return;const e=t.changedTouches?.[0];if(!e)return;const o=this.getTouchGridPosition(e);!o||!this.deps.isPositionWithinPitchGrid(o.colIndex,o.rowIndex)||(t.preventDefault(),this.mobileTouchState={identifier:e.identifier,colIndex:o.colIndex,rowIndex:o.rowIndex},this.mobileLongPressTimer=window.setTimeout(()=>{this.activateMobileGhostPreview()},this.options.longPressDelayMs))}handleTouchMove(t){if(!this.mobileTouchState)return;const e=this.findTouchById(t.changedTouches,this.mobileTouchState.identifier)||this.findTouchById(t.touches,this.mobileTouchState.identifier);if(!e)return;const o=this.getTouchGridPosition(e);if(!o){this.resetMobileTouchState({clearOverlay:this.mobileGhostActive});return}if(!this.deps.isPositionWithinPitchGrid(o.colIndex,o.rowIndex)){this.resetMobileTouchState({clearOverlay:this.mobileGhostActive});return}t.preventDefault(),this.mobileTouchState.colIndex=o.colIndex,this.mobileTouchState.rowIndex=o.rowIndex,this.mobileGhostActive&&this.renderMobileGhostPreview()}handleTouchEnd(t){if(!this.mobileTouchState||!this.findTouchById(t.changedTouches,this.mobileTouchState.identifier))return;t.preventDefault();const o=this.mobileGhostActive,i=this.mobileTouchState.colIndex,s=this.mobileTouchState.rowIndex;if(this.resetMobileTouchState(),!o||this.deps.getSelectedTool()!=="note")return;this.deps.attemptPlaceNoteAt(i,s)?this.deps.onNotePlaced():this.deps.onNoteNotPlaced()}handleTouchCancel(){this.resetMobileTouchState({clearOverlay:this.mobileGhostActive})}getTouchGridPosition(t){if(!this.pitchCanvasElement)return null;const e=this.pitchCanvasElement.getBoundingClientRect(),o=t.clientX-e.left,i=t.clientY-e.top,s=document.getElementById("canvas-container")?.scrollLeft??0,a=ge.getColumnIndex(o+s),r=ge.getPitchRowIndex(i);return{colIndex:a,rowIndex:r}}findTouchById(t,e){if(!t)return null;for(let o=0;o<t.length;o++){const i=t.item(o);if(i&&i.identifier===e)return i}return null}renderMobileGhostPreview(){const t=this.deps.getPitchHoverCtx();!t||!this.mobileTouchState||(t.clearRect(0,0,Wt(t.canvas),xt(t.canvas)),this.deps.drawHoverHighlight(this.mobileTouchState.colIndex,this.mobileTouchState.rowIndex,this.deps.getNoteHoverColor(this.options.ghostAlpha)),this.deps.drawGhostNote(this.mobileTouchState.colIndex,this.mobileTouchState.rowIndex),this.deps.setGhostNotePosition(this.mobileTouchState.colIndex,this.mobileTouchState.rowIndex))}activateMobileGhostPreview(){if(this.mobileTouchState){if(!this.deps.isPositionWithinPitchGrid(this.mobileTouchState.colIndex,this.mobileTouchState.rowIndex)){this.resetMobileTouchState({clearOverlay:!1});return}this.mobileGhostActive=!0,this.renderMobileGhostPreview()}}resetMobileTouchState({clearOverlay:t=!1}={}){this.mobileLongPressTimer&&(clearTimeout(this.mobileLongPressTimer),this.mobileLongPressTimer=null),t&&this.mobileGhostActive&&this.deps.clearOverlay(),this.mobileTouchState=null,this.mobileGhostActive=!1}}function ug(n,t){const{activeChordIntervals:e,isIntervalsInverted:o,chordPositionState:i}=t;if(!n||!e||e.length===0)return[];if(o&&e.length===2&&e[0]==="1P"){const r="-"+e[1],c=cn(n,r),d=Nn(c),u=d.includes("#")&&Ln(d).includes("b")?Ln(d):d;return[n,u]}const s=e.map(a=>{const r=cn(n,a),c=Nn(r);if(c.includes("#")){const d=Ln(c);if(d.includes("b"))return d}return c});if(e.length>=3&&i>0){const a=[...s];for(let g=0;g<i;g++){const m=a.shift();if(!m)break;const p=cn(m,"8P");a.push(Nn(p)??m)}const r=a[0],c=n;if(!r)return s;const d=si(r),u=si(c);if(d===null||u===null)return s;let h=0,f=d;for(;f>u;)f-=12,h-=12;for(;f+12<=u;)f+=12,h+=12;return a.map(g=>{const m=si(g);if(m===null)return g;const p=m+h;return nc(p)??g})}return s}let Yo=!1,ds=null,us=null,hs=null,kn=null;const Ye="grab";function hg(n){if(Yo){n&&(n.style.cursor=Ye);return}ds=document.body.style.cursor||null,us=document.documentElement.style.cursor||null,hs=n?.style.cursor??null,kn=n??null,n&&(n.style.cursor=Ye),document.body.style.cursor=Ye,document.documentElement.style.cursor=Ye,document.body.dataset.cursorOverride="stamp",Yo=!0}function ml(){Yo&&(kn&&kn.style.cursor===Ye&&(kn.style.cursor=hs??""),document.body.style.cursor===Ye&&(document.body.style.cursor=ds??""),document.documentElement.style.cursor===Ye&&(document.documentElement.style.cursor=us??""),document.body.dataset.cursorOverride==="stamp"&&delete document.body.dataset.cursorOverride,Yo=!1,ds=null,us=null,hs=null,kn=null)}let yt=null,We=!1,Lt=null,Me=[],Gt=[];const an=new Set;let Fe=!1,fe=null;const fl=new Qp,Fs=new Kp,pl=new Zp,mg=new Jp,Ws=new eg,Os=new ig,jo=new rg,ei=new cg,rn=new lg({noteToolInteractor:Fs,chordToolInteractor:mg,eraserToolInteractor:pl,stampToolInteractor:Ws,tripletToolInteractor:Os,modulationToolInteractor:fl,tonicizationToolInteractor:jo,placementFillNoteIds:an,getPitchForRow:yn,getTimeAlignedCanvasColumn:ms,getChordPitchesForRootPitch:n=>ug(n,l.state),findNearestMeasureBoundary:Cl}),fg=275,pg=.25,Mn=new dg({shouldUseMobileLongPress:bg,isPositionWithinPitchGrid:yl,getSelectedTool:()=>l.state.selectedTool,getPitchHoverCtx:()=>yt,clearOverlay:wn,drawHoverHighlight:qn,getNoteHoverColor:vl,drawGhostNote:wl,setGhostNotePosition:dl,attemptPlaceNoteAt:vg,onNotePlaced:Sl,onNoteNotPlaced:wn},{longPressDelayMs:fg,ghostAlpha:pg}),gl="#4a90e2";function gg(n,t=1){const e=n.startsWith("#")?n.slice(1):n;if(e.length!==6)return n;const o=parseInt(e.slice(0,2),16),i=parseInt(e.slice(2,4),16),s=parseInt(e.slice(4,6),16);return`rgba(${o}, ${i}, ${s}, ${t})`}function vl(n=.2){const t=l.state.selectedNote?.color||gl;return gg(t,n)}function tr(){return l.state.selectedNote?.color||gl}function bl(){return!!Ct.currentTool}function yn(n){const t=l.state.fullRowData[n];return!t||t.isBoundary?null:t.toneNote}function ms(n){const t=n+2,e=qp(l.state,t);if(e===null)return null;const o=Gp(l.state,e);return o===null?null:Math.max(0,o-2)}function yl(n,t){const e=(l.state.selectedTool==="note"||l.state.selectedTool==="chord")&&l.state.selectedNote?.shape==="circle",i=(l.state.musicalColumnWidths&&l.state.musicalColumnWidths.length>0?l.state.musicalColumnWidths:l.state.columnWidths||[]).length,s=e?i-1:i;return n<0||n>=s?!1:yn(t)!==null}function qn(n,t,e){if(!yt)return;const o={...l.state,zoomLevel:$t.getViewportInfo().zoomLevel},i=Y(n,o),a=ct(t,l.state)-l.state.cellHeight/2,r=l.state.selectedTool;let c;if(l.state.modulationMarkers&&l.state.modulationMarkers.length>0?c=Y(n+1,o)-i:c=(l.state.columnWidths[n]??1)*l.state.cellWidth,r==="eraser"||ei.getIsActive())l.state.modulationMarkers&&l.state.modulationMarkers.length>0?c=Y(n+2,o)-i:c=l.state.cellWidth*2;else if(r==="note"&&l.state.selectedNote?.shape==="circle")l.state.modulationMarkers&&l.state.modulationMarkers.length>0?c=Y(n+2,o)-i:c=l.state.cellWidth*2;else if(r==="sixteenthStamp")l.state.modulationMarkers&&l.state.modulationMarkers.length>0?c=Y(n+2,o)-i:c=l.state.cellWidth*2;else if(r==="tripletStamp"){const d=no.getSelectedTripletStamp();if(d){const h=2*(d.span==="eighth"?1:2);l.state.modulationMarkers&&l.state.modulationMarkers.length>0?c=Y(n+h,o)-i:c=l.state.cellWidth*h}else c=l.state.cellWidth*2}else r==="tonicization"&&(l.state.modulationMarkers&&l.state.modulationMarkers.length>0?c=Y(n+2,o)-i:c=l.state.cellWidth*2);yt.fillStyle=e,yt.fillRect(i,a,c,l.state.cellHeight)}function wl(n,t,e=!1){if(!yt||!l.state.selectedNote)return;const o=l.state.selectedTool,{shape:i,color:s}=l.state.selectedNote;if(yt.globalAlpha=e?.2:.4,o==="note"){const a=i==="circle"?n+1:n,r={uuid:"ghost-note",globalRow:t,row:t,startColumnIndex:n,endColumnIndex:a,color:s,shape:i,isDrum:!1},c={...l.state,zoomLevel:$t.getViewportInfo().zoomLevel};i==="oval"?Cs(yt,c,r,t):Ss(yt,c,r,t)}yt.globalAlpha=1}function vg(n,t){const e=Fs.attemptPlaceNoteAt(n,t,{activeNote:Lt,lastDragRow:fe,activePreviewPitches:Gt},an,{getPitchForRow:yn});return Lt=e.state.activeNote,fe=e.state.lastDragRow,Gt=e.state.activePreviewPitches,e.placed&&e.shouldStartDragging&&(We=!0),e.placed}function bg(){if(l.state.selectedTool!=="note")return!1;const n=l.state.deviceProfile;if(n&&typeof n.isMobile=="boolean")return n.isMobile;if(typeof window<"u"&&typeof window.matchMedia=="function")try{return window.matchMedia("(pointer: coarse)").matches}catch{return!1}return!1}function yg(n){if(bl()){wn();return}if(!yt)return;const t=n.target instanceof Element?n.target:null;if(!t)return;const e=t.getBoundingClientRect(),o=n.clientX-e.left,i=n.clientY-e.top,s=document.getElementById("canvas-container")?.scrollLeft??0,a=ge.getColumnIndex(o+s),r=ge.getPitchRowIndex(i);if(!yl(a,r)){l.state.selectedTool;return}if(n.button===2&&ei.handleMouseDown({event:n,colIndex:a,rowIndex:r,annotationService:Ct})){yt.clearRect(0,0,Wt(yt.canvas),xt(yt.canvas)),qn(a,r,"rgba(220, 53, 69, 0.3)");return}if(n.button===0){const c=o+s;if(fl.handleMouseDown(c,i))return;const d=Fs.handleExistingNoteMouseDown(a,r,{activeNote:Lt,lastDragRow:fe,activePreviewPitches:Gt},{getPitchForRow:yn});if(d.handled){Lt=d.state.activeNote,fe=d.state.lastDragRow,Gt=d.state.activePreviewPitches;return}const u=l.state.selectedTool;if(u==="note"||u==="chord"){const f=Ws.tryStartShapeDrag({actualX:o+s,canvasY:i}),g=!f&&Os.tryStartShapeDrag({actualX:o+s,canvasY:i});if(f||g)return;const m=It.getSixteenthStampAtPosition(a,r),p=Oe(a,l.state),v=p===null?null:It.getTripletStampAtPosition(p,r);if(m||v)return}const h=rn.handleToolMouseDown({toolType:u,colIndex:a,rowIndex:r,actualX:o+s,canvasY:i,state:{isDragging:We,isEraserDragActive:Fe,activeNote:Lt,activeChordNotes:Me,activePreviewPitches:Gt,lastDragRow:fe}});if(h.handled){We=h.state.isDragging,Fe=h.state.isEraserDragActive,Lt=h.state.activeNote,Me=h.state.activeChordNotes,Gt=h.state.activePreviewPitches,fe=h.state.lastDragRow;return}}}function wg(n){if(bl()){wn();return}if(!yt)return;const t=n.target instanceof Element?n.target:null;if(!t)return;const e=t.getBoundingClientRect(),o=n.clientX-e.left,i=n.clientY-e.top,s=document.getElementById("canvas-container")?.scrollLeft??0,a=ge.getColumnIndex(o+s),r=ge.getPitchRowIndex(i);if(!yt)return;yt.clearRect(0,0,Wt(yt.canvas),xt(yt.canvas));const c=n.target instanceof HTMLElement?n.target:null,d=l.state.selectedTool,u=o+s,h=Oe(a,l.state);if(rn.handleToolMouseMoveBeforeBoundsCheck({actualX:u,rowIndex:r,canvasEl:c,state:{isDragging:We,isEraserDragActive:Fe,activeNote:Lt,activeChordNotes:Me,activePreviewPitches:Gt,lastDragRow:fe}}).handled)return;rn.handleToolHoverVisuals({toolType:d,actualX:u,canvasY:i,pitchHoverCtx:yt,canvasEl:c,selectedModulationRatio:l.state.selectedModulationRatio,findNearestMeasureBoundary:Cl,drawModulationPreview:Sg});const g=(l.state.selectedTool==="note"||l.state.selectedTool==="chord")&&l.state.selectedNote?.shape==="circle",m=l.state.columnWidths.length,p=g?m-1:m;if(a<0||a>=p||yn(r)===null){jo.resetHoverState(),ul();return}dl(a,r);const v=It.getSixteenthStampAtPosition(a,r),y=h===null?null:It.getTripletStampAtPosition(h,r),w=!!(v||y),S=w&&(d==="note"||d==="chord");if(w&&d!=="eraser"&&!Ws.isDraggingShape()&&!Os.isDraggingShape()?hg(c):ml(),(d==="sixteenthStamp"||d==="tripletStamp")&&w)return;const E=rn.handleNoteOrChordDragMouseMove({colIndex:a,rowIndex:r,state:{isDragging:We,isEraserDragActive:Fe,activeNote:Lt,activeChordNotes:Me,activePreviewPitches:Gt,lastDragRow:fe}});if(E.handled){We=E.state.isDragging,Fe=E.state.isEraserDragActive,Lt=E.state.activeNote,Me=E.state.activeChordNotes,Gt=E.state.activePreviewPitches,fe=E.state.lastDragRow;return}if(!S&&rn.handleChordToolHover({colIndex:a,rowIndex:r,pitchHoverCtx:yt,zoomLevel:$t.getViewportInfo().zoomLevel,drawSingleColumnOvalNote:Cs,drawTwoColumnOvalNote:Ss}))return;if(ei.handleMouseMove({event:n,colIndex:a,rowIndex:r,annotationService:Ct})){qn(a,r,"rgba(220, 53, 69, 0.3)");return}if(pl.handleMouseMove(a,r,Fe)){qn(a,r,"rgba(220, 53, 69, 0.3)");return}if(yt&&jo.handleMouseMove({colIndex:a,rowIndex:r,hoverCtx:yt,getPitchForRow:yn})||S)return;const x=Ot(l.state),A=l.state.selectedNote?.shape==="circle";let k=null,C=!0;if(l.state.selectedTool==="note"||l.state.selectedTool==="chord")C=jn(a,l.state)&&(!A||jn(a+1,l.state));else if(l.state.selectedTool==="sixteenthStamp"){const W=ms(a);C=W!==null&&!qi(W,x)&&!qi(W+1,x)}else if(l.state.selectedTool==="tripletStamp"){const W=no.getSelectedTripletStamp();if(W){const H=Oe(a,l.state);if(H===null)C=!1;else{k=H;const D=(Lr[W.span]??1)*2,U=Yt(k,l.state);C=!0;for(const V of x){const j=V.columnIndex,at=V.columnIndex+1;if(j>=U&&j<U+D){C=!1;break}if(U>=j&&U<=at){C=!1;break}}}}}const N=l.state.selectedTool==="eraser"?"rgba(220, 53, 69, 0.3)":C?vl(.2):"rgba(220, 53, 69, 0.15)";if(qn(a,r,N),l.state.selectedTool==="sixteenthStamp"){const W=Jo.getSelectedSixteenthStamp();if(W&&C){const H=ms(a);if(H===null)return;const Q={cellWidth:l.state.cellWidth,cellHeight:l.state.cellHeight,columnWidths:l.state.columnWidths,musicalColumnWidths:l.state.columnWidths,modulationMarkers:l.state.modulationMarkers,baseMicrobeatPx:l.state.cellWidth,macrobeatGroupings:l.state.macrobeatGroupings,previewColor:tr()};Xu(yt,H,r,W,Q)}}else if(l.state.selectedTool==="tripletStamp"){const W=no.getSelectedTripletStamp();if(W&&C&&k!==null){const H={cellWidth:l.state.cellWidth,cellHeight:l.state.cellHeight,columnWidths:l.state.columnWidths,musicalColumnWidths:l.state.columnWidths,modulationMarkers:l.state.modulationMarkers,baseMicrobeatPx:l.state.cellWidth,macrobeatGroupings:l.state.macrobeatGroupings,previewColor:tr()};Qu(yt,k,r,W,H)}}else C&&wl(a,r)}function wn(){yt&&yt.clearRect(0,0,Wt(yt.canvas),xt(yt.canvas)),ml(),jo.resetHoverState(),ul()}function Sl(){if(!rn.handleToolMouseUp()){if(Gt.length>0){It.stopCurrentPattern();const n=Lt?.color??Me[0]?.color??l.state.selectedNote?.color;n&&Ht.releasePitches(Gt,n);const t=Lt;if(t&&n){const o=l.state.timbres[n]?.adsr;if(o){const i=l.state.fullRowData[t.row]?.hex||"#888888";Jt.adsrComponent?.playheadManager.trigger(t.uuid,"release",i,o)}}else if(n){const o=Gt[0];if(!o){Gt=[];return}const i=l.state.fullRowData.find(s=>s.toneNote===o);if(i){const s=l.state.timbres[n]?.adsr;if(s){const a=i.hex;Jt.adsrComponent?.playheadManager.trigger("chord_preview","release",a,s)}}}Gt=[];const e=window.waveformVisualizer;e&&e.stopLiveVisualization()}Lt?.uuid&&an.has(Lt.uuid)&&(l.emit("noteRelease",{noteId:Lt.uuid,color:Lt.color}),an.delete(Lt.uuid)),Me.forEach(n=>{n?.uuid&&an.has(n.uuid)&&(l.emit("noteRelease",{noteId:n.uuid,color:n.color}),an.delete(n.uuid))}),We&&l.recordState(),We=!1,fe=null,Lt?.uuid&&l.emit("noteInteractionEnd",{noteId:Lt.uuid}),Me.forEach(n=>{n.uuid&&l.emit("noteInteractionEnd",{noteId:n.uuid})}),Lt=null,Me=[],Fe&&(l.recordState(),Fe=!1),ei.handleGlobalMouseUp(),wn()}}function Cl(n){const{macrobeatBoundaryStyles:t}=l.state,e=100,o=[],i=l.state.modulationMarkers&&l.state.modulationMarkers.length>0;b.debug("PitchGridInteractor","Boundary calculation modulation state",{hasModulation:i},"grid");for(let c=0;c<t.length;c++)if(t[c]==="solid"){const d=Ut(l.state,c);if(d){const u=d.endColumn+1,h=Y(u,{...l.state,modulationMarkers:l.state.modulationMarkers||[],cellWidth:l.state.cellWidth,columnWidths:l.state.columnWidths,musicalColumnWidths:l.state.columnWidths,baseMicrobeatPx:l.state.cellWidth});b.debug("PitchGridInteractor","Computed measure boundary",{boundaryIndex:c,endColumn:d.endColumn,calculatedX:h,method:"canvas-space"},"grid"),o.push({measureIndex:c+1,xPosition:h,macrobeatIndex:c})}}const s=Y(0,{...l.state,modulationMarkers:l.state.modulationMarkers||[],cellWidth:l.state.cellWidth,columnWidths:l.state.columnWidths,musicalColumnWidths:l.state.columnWidths,baseMicrobeatPx:l.state.cellWidth});b.debug("PitchGridInteractor","Start boundary position",{startBoundaryX:s,method:"canvas-space"},"grid"),o.unshift({measureIndex:0,xPosition:s,macrobeatIndex:-1}),b.debug("PitchGridInteractor","Available measure boundaries",{boundaries:o},"grid"),b.debug("PitchGridInteractor","Modulation click context",{clickX:n,tolerance:e},"grid");let a=null,r=1/0;return o.forEach(c=>{const d=Math.abs(n-c.xPosition);b.debug("PitchGridInteractor","Boundary distance check",{boundaryX:c.xPosition,distance:d},"grid"),d<=e&&d<r&&(r=d,a=c)}),a?b.debug("PitchGridInteractor","Found closest boundary",{boundary:a,distance:r},"grid"):b.debug("PitchGridInteractor","No boundary found within tolerance",{tolerance:e},"grid"),a}function Sg(n,t,e){if(!e)return;const o=cr(e),i=lr(e);n.save();const s=3,a=2,r=xt(n.canvas);n.strokeStyle=o,n.lineWidth=a,n.globalAlpha=.7,n.setLineDash([]);for(let c=-1;c<=1;c++){const d=t+c*s;n.beginPath(),n.moveTo(d,0),n.lineTo(d,r),n.stroke()}n.globalAlpha=.8,n.font="12px Arial, sans-serif",n.textAlign="center",n.textBaseline="top",n.fillStyle=o,n.fillText(`Preview: ${i}`,t,10),n.restore()}function Cg(){const n=document.getElementById("notation-grid"),t=document.getElementById("hover-canvas");if(!n||!t){b.error("PitchGridInteractor","Could not find required canvas elements.",{hasPitchCanvas:!!n,hasHoverCanvas:!!t},"grid");return}if(yt=t.getContext("2d"),!yt){b.error("PitchGridInteractor","Could not get hover canvas context.",null,"grid");return}Mn.setPitchCanvasElement(n),n.addEventListener("mousedown",yg),n.addEventListener("mousemove",wg),n.addEventListener("mouseleave",wn),n.addEventListener("contextmenu",e=>e.preventDefault()),n.addEventListener("touchstart",e=>Mn.handleTouchStart(e),{passive:!1}),n.addEventListener("touchmove",e=>Mn.handleTouchMove(e),{passive:!1}),n.addEventListener("touchend",e=>Mn.handleTouchEnd(e),{passive:!1}),n.addEventListener("touchcancel",()=>Mn.handleTouchCancel(),{passive:!1}),window.addEventListener("mouseup",Sl)}const Ag={init(){Cg(),Hp(),document.addEventListener("canvasResized",()=>{this.renderPitchGrid(),this.renderDrumGrid()}),l.on("animationUpdate",n=>{n.type==="vibrato"&&n.activeColors&&n.activeColors.length>0?this.renderPitchGrid():n.type==="envelopeFill"||n.hasEnvelopeFills?this.renderPitchGrid():n.type==="combined"&&n.vibratoColors&&n.vibratoColors.length>0&&this.renderPitchGrid()}),b.debug("GridManager","Initialized pitch and drum grid interactions",null,"grid")},renderPitchGrid:Zn.render,renderDrumGrid:jt.render};function xg(){const n=Vt.init();return Yn.setContexts(n),xp.init(),Ag.init(),n}class Eg{currentTool=null;toolButtons=[];toolPanels=[];lastSelectedNote=null;optionsContainers={arrow:null,text:null,marker:null,highlighter:null,lasso:null};settings={arrow:{lineStyle:"solid",strokeWeight:4,startArrowhead:"none",endArrowhead:"filled-arrow",arrowheadSize:12},text:{color:"#000000",size:16,bold:!1,italic:!1,underline:!1,background:!1,superscript:!1,subscript:!1},marker:{color:"#4a90e2",size:6},highlighter:{color:"#4a90e2",size:10},lasso:{}};initialize(){if(this.toolButtons=document.querySelectorAll(".draw-tool-button"),this.toolPanels=document.querySelectorAll(".draw-tool-panel"),this.optionsContainers={arrow:document.getElementById("arrow-tool-options"),text:document.getElementById("text-tool-options"),marker:document.getElementById("marker-tool-options"),highlighter:document.getElementById("highlighter-tool-options"),lasso:document.getElementById("lasso-tool-options")},!this.toolButtons.length||!this.optionsContainers.arrow){b.warn("DrawToolsController","Could not find draw tool elements",null,"draw");return}this.attachEventListeners(),this.setupChordTabListeners(),this.setupMainTabListeners(),this.populateAllPanels(),this.initializePanelWidthSync(),this.logPanelMetrics(),window.addEventListener("resize",()=>this.logPanelMetrics(),{passive:!0}),l.on("noteChanged",({newNote:t}={})=>{this.lastSelectedNote=t??null,this.currentTool&&this.deselectAllTools()})}attachEventListeners(){this.toolButtons.forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.drawTool;this.selectTool(e)})})}setupMainTabListeners(){document.querySelectorAll(".tab-button").forEach(e=>{e.addEventListener("click",()=>{e.dataset.tab!=="pitch"&&this.currentTool&&(this.deselectAllTools(),this.restoreLastSelectedNote())})})}setupChordTabListeners(){document.querySelectorAll(".pitch-tab-button").forEach(e=>{e.addEventListener("click",()=>{e.dataset.pitchTab!=="draw"&&this.currentTool&&(this.deselectAllTools(),this.restoreLastSelectedNote())})})}restoreLastSelectedNote(){this.lastSelectedNote?(l.setSelectedNote(this.lastSelectedNote.shape,this.lastSelectedNote.color),l.setSelectedTool("note")):l.state.selectedNote&&(l.setSelectedNote(l.state.selectedNote.shape,l.state.selectedNote.color),l.setSelectedTool("note"))}deselectAllTools(){this.toolButtons.forEach(t=>t.classList.remove("active")),this.toolPanels.forEach(t=>t.classList.remove("active")),this.currentTool=null,Ct.setTool(null,null),l.state.selectedTool==="draw"&&l.setSelectedTool("note")}selectTool(t){this.toolButtons.forEach(o=>o.classList.remove("active")),this.toolPanels.forEach(o=>o.classList.remove("active"));const e=Array.from(this.toolButtons).find(o=>o.dataset.drawTool===t);e&&(e.classList.add("active"),e.closest(".draw-tool-panel")?.classList.add("active")),this.currentTool=t,Ct.setTool(t,this.settings),l.setSelectedTool("draw"),l.state.selectedNote={shape:"circle",color:l.state.selectedNote?.color||"#4a90e2"}}populateAllPanels(){this.populateArrowOptions(),this.populateTextOptions(),this.populateMarkerOptions(),this.populateHighlighterOptions()}initializePanelWidthSync(){const t=Array.from(this.toolPanels);t.length&&t.forEach(e=>{e.style.minWidth="",e.style.width="fit-content",e.style.maxWidth="100%",e.style.flex="0 0 auto"})}logPanelMetrics(){try{const t=document.querySelector(".draw-layout-grid");Array.from(this.toolPanels??[]).forEach(o=>{o.getBoundingClientRect()}),t?.getBoundingClientRect()}catch{}}populateArrowOptions(){const t=this.optionsContainers.arrow;if(!t)return;const e=t.querySelector("#arrow-start-head-trigger"),o=t.querySelector("#arrow-end-head-trigger"),i=(f,g)=>g!=="filled-arrow"?`
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="4" y1="12" x2="20" y2="12"/>
          </svg>
        `:f==="start"?`
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9,5 3,12 9,19"/>
            <line x1="3" y1="12" x2="21" y2="12"/>
          </svg>
        `:`
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15,5 21,12 15,19"/>
          <line x1="3" y1="12" x2="21" y2="12"/>
        </svg>
      `,s=(f,g,m)=>{f&&(f.innerHTML=i(g,m))},a=t.querySelector("#arrow-stroke-weight");a&&(a.value=`${this.settings.arrow.strokeWeight}`,a.addEventListener("input",()=>{this.settings.arrow.strokeWeight=parseInt(a.value,10),Ct.setTool("arrow",this.settings)}));const r=t.querySelector("#arrow-head-size");r&&(r.value=`${this.settings.arrow.arrowheadSize}`,r.addEventListener("input",()=>{this.settings.arrow.arrowheadSize=parseInt(r.value,10),Ct.setTool("arrow",this.settings)}));const c=Array.from(t.querySelectorAll("[data-line-style]"));if(c.length){const f=g=>{c.forEach(m=>m.classList.toggle("active",m.dataset.lineStyle===g))};f(this.settings.arrow.lineStyle),c.forEach(g=>{g.addEventListener("click",()=>{const m=g.dataset.lineStyle;m&&(this.settings.arrow.lineStyle=m,f(m),Ct.setTool("arrow",this.settings))})})}const d=Array.from(t.querySelectorAll("[data-arrow-start]"));if(d.length){const f=g=>{d.forEach(m=>m.classList.toggle("active",m.dataset.arrowStart===g)),s(e,"start",g)};f(this.settings.arrow.startArrowhead),d.forEach(g=>{g.addEventListener("click",()=>{const m=g.dataset.arrowStart;m&&(this.settings.arrow.startArrowhead=m,f(m),Ct.setTool("arrow",this.settings))})})}const u=Array.from(t.querySelectorAll("[data-arrow-end]"));if(u.length){const f=g=>{u.forEach(m=>m.classList.toggle("active",m.dataset.arrowEnd===g)),s(o,"end",g)};f(this.settings.arrow.endArrowhead),u.forEach(g=>{g.addEventListener("click",()=>{const m=g.dataset.arrowEnd;m&&(this.settings.arrow.endArrowhead=m,f(m),Ct.setTool("arrow",this.settings))})})}const h=t.querySelector("#arrow-swap-heads");h&&h.addEventListener("click",()=>{const f=this.settings.arrow.startArrowhead;if(this.settings.arrow.startArrowhead=this.settings.arrow.endArrowhead,this.settings.arrow.endArrowhead=f,d.length){const g=this.settings.arrow.startArrowhead;d.forEach(m=>m.classList.toggle("active",m.dataset.arrowStart===g)),s(e,"start",g)}if(u.length){const g=this.settings.arrow.endArrowhead;u.forEach(m=>m.classList.toggle("active",m.dataset.arrowEnd===g)),s(o,"end",g)}Ct.setTool("arrow",this.settings)})}populateTextOptions(){const t=this.optionsContainers.text;if(!t)return;const e=t.querySelector("#text-size-input");e&&(e.value=`${this.settings.text.size}`,e.addEventListener("input",()=>{this.settings.text.size=parseInt(e.value,10),Ct.setTool("text",this.settings)}));const o=Array.from(t.querySelectorAll(".draw-color-button"));if(o.length){const s=a=>{o.forEach(r=>{const c=r.dataset.color||"";r.classList.toggle("active",c.toLowerCase()===a.toLowerCase())})};s(this.settings.text.color),o.forEach(a=>{a.addEventListener("click",()=>{const r=a.dataset.color;r&&(this.settings.text.color=r,s(r),Ct.setTool("text",this.settings))})})}const i=Array.from(t.querySelectorAll("[data-text-style]"));if(i.length){const s=["bold","italic","underline","background","superscript","subscript"],a=r=>{this.settings.text[r]=!this.settings.text[r],Ct.setTool("text",this.settings)};i.forEach(r=>{const c=r.dataset.textStyle;c&&s.includes(c)&&r.classList.toggle("active",!!this.settings.text[c])}),i.forEach(r=>{r.addEventListener("click",()=>{const c=r.dataset.textStyle;!c||!s.includes(c)||(a(c),r.classList.toggle("active",!!this.settings.text[c]))})})}}populateMarkerOptions(){const t=this.optionsContainers.marker;if(!t)return;const e=t.querySelector("#marker-size-input");e&&(e.value=`${this.settings.marker.size}`,e.addEventListener("input",()=>{this.settings.marker.size=parseInt(e.value,10),Ct.setTool("marker",this.settings)}));const o=Array.from(t.querySelectorAll(".draw-color-button"));if(o.length){const i=s=>{o.forEach(a=>{const r=a.dataset.color||"";a.classList.toggle("active",r.toLowerCase()===s.toLowerCase())})};i(this.settings.marker.color),o.forEach(s=>{s.addEventListener("click",()=>{const a=s.dataset.color;a&&(this.settings.marker.color=a,i(a),Ct.setTool("marker",this.settings))})})}}populateHighlighterOptions(){const t=this.optionsContainers.highlighter;if(!t)return;const e=t.querySelector("#highlighter-size-input");e&&(e.value=`${this.settings.highlighter.size}`,e.addEventListener("input",()=>{this.settings.highlighter.size=parseInt(e.value,10),Ct.setTool("highlighter",this.settings)}));const o=Array.from(t.querySelectorAll(".draw-color-button"));if(o.length){const i=s=>{o.forEach(a=>{const r=a.dataset.color||"";a.classList.toggle("active",r.toLowerCase()===s.toLowerCase())})};i(this.settings.highlighter.color),o.forEach(s=>{s.addEventListener("click",()=>{const a=s.dataset.color;a&&(this.settings.highlighter.color=a,i(a),Ct.setTool("highlighter",this.settings))})})}}}const Mg=new Eg;function Pg(){return Ct.initialize(),Mg.initialize?.(),b.initSuccess("DrawSystem"),typeof window<"u"&&(window.annotationService=Ct),{annotationService:Ct}}b.moduleLoaded("KeyboardHandler","keyboard");function Tg(){document.addEventListener("keydown",n=>{const t=document.activeElement;if(!t)return;const e=t.tagName.toLowerCase(),o=t.contentEditable==="true";if(["input","textarea"].includes(e)||o)return;if(n.ctrlKey&&n.key.toLowerCase()==="p"){n.preventDefault(),b.info("KeyboardHandler","Ctrl+P pressed. Opening print preview",null,"keyboard"),l.emit("printPreviewStateChanged",!0);return}if(n.ctrlKey&&n.key.toLowerCase()==="z"){n.preventDefault(),l.undo();return}if(n.ctrlKey&&n.key.toLowerCase()==="y"){n.preventDefault(),l.redo();return}let i=!1;switch(n.key){case"Backspace":case"Delete":if(l.state.lassoSelection?.isActive){const s=l.state.lassoSelection.selectedItems;s.forEach(a=>{if(a.type==="note"){const r=a.data,c=l.state.placedNotes.findIndex(d=>d.uuid===r.uuid);c!==-1&&l.state.placedNotes.splice(c,1)}else if(a.type==="sixteenthStamp"){const r=a.data,c=l.state.sixteenthStampPlacements.findIndex(d=>d.id===r.id);c!==-1&&l.state.sixteenthStampPlacements.splice(c,1)}else if(a.type==="tripletStamp"){const r=a.data,c=l.state.tripletStampPlacements.findIndex(d=>d.id===r.id);c!==-1&&l.state.tripletStampPlacements.splice(c,1)}}),l.state.lassoSelection={selectedItems:[],convexHull:null,isActive:!1},l.recordState(),l.emit("render"),i=!0,b.info("KeyboardHandler",`Deleted ${s.length} items from lasso selection`,null,"keyboard")}break}i&&n.preventDefault()}),b.info("KeyboardHandler","Initialized",null,"keyboard")}b.moduleLoaded("TransportKeyboardShortcuts","keyboard");function Ig(){const n=document.activeElement;if(!(n instanceof HTMLElement))return!0;const t=n.tagName.toLowerCase();return!(["input","textarea","select"].includes(t)||n.isContentEditable)}function kg(){let n=!1;document.addEventListener("keydown",t=>{if(t.code!=="Space"||n||t.repeat||!Ig())return;const e=document.getElementById("play-button");e&&(t.preventDefault(),n=!0,e.click())}),document.addEventListener("keyup",t=>{t.code==="Space"&&(n=!1)}),b.info("TransportKeyboardShortcuts","Initialized",null,"keyboard")}const Lg=[{label:"Toolbar",selector:"#toolbar"},{label:"Toolbar Primary",selector:"#toolbar-primary"},{label:"Primary Actions Grid",selector:"#toolbar-primary .primary-toolbar-actions"},{label:"Primary Playback Row",selector:"#toolbar-primary .primary-toolbar-playback"},{label:"Toolbar Secondary",selector:"#toolbar-secondary"},{label:"Toolbar Preset Controls",selector:"#toolbar-secondary .preset-effects-controls"},{label:"Toolbar Tab Sidebar",selector:"#toolbar-secondary .tab-sidebar"},{label:"Sidebar",selector:"#sidebar"},{label:"Timbre Tab Panel",selector:"#timbre-panel"},{label:"Pitch Tab Panel",selector:"#pitch-panel"},{label:"Rhythm Tab Panel",selector:"#rhythm-panel"},{label:"Macrobeat Tools",selector:"#canvas-macrobeat-tools, #macrobeat-tools"},{label:"Waveform Card",selector:"#timbre-panel .waveform-content-box"},{label:"Preset Card",selector:"#timbre-panel .preset-content-box"},{label:"Effects Card",selector:"#timbre-panel #effects-panel .effects-content-box"},{label:"Envelope Card",selector:"#adsr-envelope"},{label:"Harmonics Card",selector:".harmonic-bins-container"},{label:"Canvas Container",selector:"#canvas-container"},{label:"Pitch Grid Wrapper",selector:"#pitch-grid-wrapper"},{label:"Pitch Grid Container",selector:"#pitch-grid-container"},{label:"Drum Grid Wrapper",selector:"#drum-grid-wrapper"},{label:"Drum Grid",selector:"#drum-grid"}],fs=new Map;let ps,ki,Li=null,Pn="",ln=!1;function Ao(n){return Number.isFinite(n)?Number(n.toFixed(1)):n}function Ng(n){const t=n.getBoundingClientRect(),e=window.getComputedStyle(n);return{tag:n.tagName.toLowerCase(),id:n.id||null,class:n.className||null,top:Ao(t.top),left:Ao(t.left),width:Ao(t.width),height:Ao(t.height),offsetWidth:n.offsetWidth,offsetHeight:n.offsetHeight,scrollWidth:n.scrollWidth,scrollHeight:n.scrollHeight,clientWidth:n.clientWidth,clientHeight:n.clientHeight,display:e.display,position:e.position,overflowX:e.overflowX,overflowY:e.overflowY,transform:e.transform!=="none"?e.transform:void 0}}function Al(n="manual"){const t=window.__uiDiagnosticsTrackedElements;if(!t)return[];if(!ln&&n!=="manual")return[];Do();const e=[];return t.forEach(o=>{const i=Array.from(document.querySelectorAll(o.selector));if(!i.length){e.push({label:o.label,selector:o.selector,missing:!0});return}i.forEach((s,a)=>{const r=i.length>1?`${o.label} [${a}]`:o.label,c=Ng(s);e.push({label:r,selector:o.selector,info:c})})}),window.__uiDiagnosticsLastSnapshot=e,e}function tn(n){ln&&(Pn=Pn?`${Pn}; ${n}`:n,Li===null&&(Li=requestAnimationFrame(()=>{const t=Pn||"auto";Li=null,Pn="",Al(t)})))}function Do(){const n=window.__uiDiagnosticsTrackedElements;!n||!ps||n.forEach(t=>{document.querySelectorAll(t.selector).forEach(o=>{fs.has(o)||(fs.set(o,t.label),ps.observe(o),o.addEventListener("scroll",()=>tn(`${t.label} scroll`),{passive:!0}))})})}function Rg(n={}){if(window.__uiDiagnosticsInitialized)return;window.__uiDiagnosticsInitialized=!0;const{elements:t,autoLog:e=!1}=n;ln=!!e,window.__uiDiagnosticsAutoLog=ln;const o=t||Lg;window.__uiDiagnosticsTrackedElements=o,ps=new ResizeObserver(i=>{const s=i.map(a=>fs.get(a.target)||a.target.id||a.target.tagName.toLowerCase()).filter(Boolean);s.length&&tn(`Resize: ${s.join(", ")}`)}),ki=new MutationObserver(()=>Do()),document.body?ki.observe(document.body,{childList:!0,subtree:!0}):document.addEventListener("DOMContentLoaded",()=>{ki.observe(document.body,{childList:!0,subtree:!0}),Do(),tn("init")},{once:!0}),window.addEventListener("resize",()=>tn("window resize")),Do(),tn("init"),window.logUIState=(i="manual")=>Al(i),window.enableUIDiagnosticsAutoLog=()=>{ln=!0,window.__uiDiagnosticsAutoLog=!0,tn("auto-log enabled")},window.disableUIDiagnosticsAutoLog=()=>{ln=!1,window.__uiDiagnosticsAutoLog=!1}}function Bg(){b.section("SETTING UP INPUT HANDLERS"),Tg(),kg(),Up(),window.enableUIDiagnostics&&Rg()}function Dg(){l.on("tempoChanged",()=>{wt.setBpm(l.state.tempo)}),l.on("layoutChanged",()=>{Vt.reflow()}),l.on("rhythmPatternChanged",()=>{It.refresh&&It.refresh()});const n=()=>{try{Zn.render(),jt.render?.(),b.debug("StateSubscriptions","renderAll invoked",null,"grid")}catch(t){b.error("StateSubscriptions","renderAll failed",t,"grid")}};return l.on("notesChanged",n),l.on("sixteenthStampPlacementsChanged",n),l.on("tripletStampPlacementsChanged",n),l.on("accidentalModeChanged",n),l.on("frequencyLabelsChanged",n),l.on("focusColoursChanged",n),l.on("octaveLabelsChanged",n),l.on("degreeDisplayModeChanged",n),l.on("longNoteStyleChanged",n),l.on("layoutConfigChanged",()=>{Zn.renderMacrobeatTools()}),l.on("rhythmStructureChanged",()=>{Vt.reflow()}),l.on("modulationMarkersChanged",()=>{Vt.reflow(),n()}),b.initSuccess("StateSubscriptions"),{renderAll:n}}let gs=!1,Xe=[],Ni=!1,Je=null,Ri=!1;function _g(){Ni=!1,Je=null,Ri=!1,window.initAudio=async()=>{if(!Ni)return Je||(Je=(async()=>{try{Gn.state!=="running"&&(await _o(),b.info("Main.js","AudioContext started successfully")),Ni=!0}catch(e){throw b.error("Main.js","Could not start AudioContext",e),Je=null,e}})(),Je)};const n=()=>{Ri||(Ri=!0,window.initAudio?.().catch(e=>b.warn("Main.js","Failed to initialize audio after user interaction",e,"initialization")),document.removeEventListener("click",n,!0),document.removeEventListener("keydown",n,!0),document.removeEventListener("touchstart",n,!0))},t=()=>{typeof wt.teardown=="function"&&wt.teardown()};document.addEventListener("click",n,!0),document.addEventListener("keydown",n,!0),document.addEventListener("touchstart",n,!0),window.addEventListener("beforeunload",t),Xe.push(()=>document.removeEventListener("click",n,!0)),Xe.push(()=>document.removeEventListener("keydown",n,!0)),Xe.push(()=>document.removeEventListener("touchstart",n,!0)),Xe.push(()=>window.removeEventListener("beforeunload",t)),Xe.push(()=>{delete window.initAudio})}const Sn={domCache:!1,layoutService:!1,canvasContextService:!1,synthEngine:!1,transportService:!1,scrollSync:!1,uiComponents:!1,audioComponents:!1,rhythmPlaybackService:!1,initialized:!1},Fg={top:"G5",bottom:"C4"};function Wg(n){if(!n?.top||!n?.bottom)return null;const t=se.findIndex(o=>o.toneNote===n.top),e=se.findIndex(o=>o.toneNote===n.bottom);return t===-1||e===-1?(b.warn("Main.js","Failed to resolve preset range from tone notes",n),null):{topIndex:Math.min(t,e),bottomIndex:Math.max(t,e)}}function Og(){return Wg(Fg)}function Se(n){Sn[n]=!0}function er(n,t=5e3){return new Promise((e,o)=>{if(Sn[n]){e();return}const i=Date.now(),s=()=>{Sn[n]?e():Date.now()-i>t?o(new Error(`Component ${n} not ready within ${t}ms`)):setTimeout(s,50)};s()})}function xl(){Object.keys(Sn).forEach(n=>{Sn[n]=!1})}async function zg(){window.initStartTime=Date.now(),b.info("Main.js","Initialization triggered"),b.section("STARTING INITIALIZATION");const n=["dom-cache","drum-samples","state-setup","canvas-services","layout-ready","synth-engine","rhythm-playback","transport-service","input-handlers","store-hooks","ui-components","audio-components","state-subscriptions","initial-render","finalize"];try{it.init(),n.forEach(a=>it.registerTask(a)),await it.nextFrame(),Cm(),Pd({latencyHint:"playback",lookAhead:.1}),b.info("Main.js","AudioContext configured with latencyHint: playback"),(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&Yr(),it.updateStatus("Initializing interface..."),Te.init(),Se("domCache"),it.completeTask("dom-cache"),await it.nextFrame(),it.updateStatus("Loading audio samples..."),await Bm(),it.completeTask("drum-samples"),b.info("Main.js","Drum samples preloaded"),await it.nextFrame(),(()=>{const a=Te.get("appContainer")||document.getElementById("app-container");if(a){const r=["click","keydown","touchstart"],c=()=>{window.initAudio?.()};r.forEach(d=>{a.addEventListener(d,c,{once:!0})})}})(),it.updateStatus("Preparing core systems..."),Tm(l.state);const e=l.state.pitchRange||{topIndex:0,bottomIndex:se.length-1},o=Math.max(0,Math.min(se.length-1,e.topIndex??0)),i=Math.max(o,Math.min(se.length-1,e.bottomIndex??se.length-1));l.state.pitchRange={topIndex:o,bottomIndex:i},l.state.fullRowData=[...se],it.completeTask("state-setup"),await it.nextFrame(),it.updateStatus("Sizing canvas..."),xg(),Se("layoutService"),Se("canvasContextService"),it.completeTask("canvas-services"),await it.nextFrame(),it.updateStatus("Calculating layout..."),await Vt.waitForInitialLayout(),it.completeTask("layout-ready"),await it.nextFrame(),it.updateStatus("Initializing synth engine..."),wt.init(),Se("synthEngine"),it.completeTask("synth-engine"),await it.nextFrame(),it.updateStatus("Preparing rhythm playback..."),It.initialize().catch(a=>{b.warn("Main.js","RhythmPlaybackService initialization deferred (needs user interaction)",a,"initialization")}),Se("rhythmPlaybackService"),it.completeTask("rhythm-playback"),await it.nextFrame(),it.updateStatus("Configuring transport..."),Ee.init(),Se("transportService"),it.completeTask("transport-service"),await it.nextFrame(),it.updateStatus("Registering input handlers..."),Bg(),it.completeTask("input-handlers"),await it.nextFrame(),it.updateStatus("Syncing state services..."),Qd(l),su(l),Ld({getColumnMap:a=>Dt.getColumnMap(a),visualToTimeIndex:(a,r)=>Dt.getColumnMap(a).visualToTime.get(r)??null,timeIndexToVisualColumn:(a,r)=>Dt.getColumnMap(a).timeToVisual.get(r)??null,getTimeBoundaryAfterMacrobeat:(a,r)=>{const d=Dt.getColumnMap(a).macrobeatBoundaries.find(u=>u.macrobeatIndex===r);return d?d.timeColumn+1:0}}),it.completeTask("store-hooks"),await it.nextFrame(),it.updateStatus("Loading interface components..."),Tf(),Se("uiComponents"),it.completeTask("ui-components"),await it.nextFrame(),await er("uiComponents"),it.updateStatus("Preparing audio components..."),yp(),Se("audioComponents"),it.completeTask("audio-components"),await it.nextFrame(),Im(l.state,"audio-components-initialization"),Cp(),Pg(),await er("audioComponents"),b.section("SETTING UP STATE SUBSCRIPTIONS"),it.updateStatus("Binding state subscriptions...");const{renderAll:s}=Dg();if(it.completeTask("state-subscriptions"),await it.nextFrame(),b.section("PERFORMING INITIAL RENDER"),l.setSelectedTool("note"),l.setSelectedNote("circle","#4a90e2"),it.updateStatus("Rendering workspace..."),s(),Zn.renderMacrobeatTools(),it.completeTask("initial-render"),To.prefetchButtonGridSnapshot(),await it.nextFrame(),Se("initialized"),b.section("INITIALIZATION COMPLETE"),it.updateStatus("Finalizing..."),it.completeTask("finalize"),await it.nextFrame(),l.isColdStart){const a=Og();a?$t.setPitchViewportRange(a,{animateMs:0,source:"coldStart:treble"}):b.warn("Main.js","Treble Clef preset range could not be resolved during cold start")}await it.complete(),window.ModulationTest=Kr}catch(t){b.error("Main.js","Initialization failed",t,"initialization"),b.error("Main.js","Component readiness snapshot at failure",{...Sn},"initialization");const e=t instanceof Error?t:new Error(String(t));it.showError(e);const o=document.createElement("div");o.style.cssText=`
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #ff4444; color: white; padding: 20px; border-radius: 8px;
            z-index: 10000; font-family: monospace; max-width: 80vw;
        `,o.innerHTML=`
            <h3>Initialization Error</h3>
            <p>The application failed to initialize properly.</p>
            <details>
                <summary>Technical Details</summary>
                <pre>${e.message}</pre>
                <pre>Stack: ${e.stack}</pre>
            </details>
            <button onclick="location.reload()">Reload Page</button>
        `,document.body.appendChild(o)}}function $g(){gs||(gs=!0,xl(),_g(),Te.refresh(),zg())}function Hg(){Xe.forEach(t=>t()),Xe=[];try{Pf()}catch(t){b.warn("Main.js","Failed to unmount Svelte components",t,"cleanup")}typeof wt.teardown=="function"&&wt.teardown(),typeof It.dispose=="function"&&It.dispose();const n=["is-mobile","is-touch","orientation-portrait","orientation-landscape"];[document.documentElement,document.body].forEach(t=>{n.forEach(e=>t?.classList.remove(e))}),xl(),gs=!1}const qg=Object.assign({"../public/apple-touch-icon.png":lc,"../public/assets/icons/clear.svg":cc,"../public/assets/icons/diamond-note.svg":dc,"../public/assets/icons/eraser.svg":uc,"../public/assets/icons/lasso-tool.svg":hc,"../public/assets/icons/loop.svg":mc,"../public/assets/icons/marker-tool.svg":fc,"../public/assets/icons/pause.svg":pc,"../public/assets/icons/play.svg":gc,"../public/assets/icons/redo.svg":vc,"../public/assets/icons/settings.svg":bc,"../public/assets/icons/stop.svg":yc,"../public/assets/icons/undo.svg":wc,"../public/assets/icons/volume.svg":Sc,"../public/assets/icons/zoomIn.svg":Cc,"../public/assets/icons/zoomOut.svg":Ac,"../public/assets/sidebar/hideAnalysis.svg":xc,"../public/assets/sidebar/hideDrums.svg":Ec,"../public/assets/sidebar/newPage.svg":Mc,"../public/assets/sidebar/open.svg":Pc,"../public/assets/sidebar/print.svg":Tc,"../public/assets/sidebar/saveAs.svg":Ic,"../public/assets/tabicons/dottedQuarterNote.svg":kc,"../public/assets/tabicons/eigthNote.svg":Lc,"../public/assets/tabicons/phaseButton_0.svg":Nc,"../public/assets/tabicons/phaseButton_180.svg":Rc,"../public/assets/tabicons/phaseButton_270.svg":Bc,"../public/assets/tabicons/phaseButton_90.svg":Dc,"../public/assets/tabicons/quarterNote.svg":_c,"../public/assets/tabicons/tonicShape_1.svg":Fc,"../public/assets/tabicons/tonicShape_2.svg":Wc,"../public/assets/tabicons/tonicShape_3.svg":Oc,"../public/assets/tabicons/tonicShape_4.svg":zc,"../public/assets/tabicons/tonicShape_5.svg":$c,"../public/assets/tabicons/tonicShape_6.svg":Hc,"../public/assets/tabicons/tonicShape_7.svg":qc,"../public/favicon-96x96.png":Gc,"../public/favicon.ico":Vc,"../public/favicon.svg":Xc,"../public/fonts/atkinsonHyperlegibleNextBold.otf":Uc,"../public/fonts/atkinsonHyperlegibleNextRegular.otf":Yc,"../public/fonts/atkinsonHyperlegibleNextRegularItalic.otf":jc,"../public/site.webmanifest":Qc,"../public/web-app-manifest-192x192.png":Kc,"../public/web-app-manifest-512x512.png":Zc}),Gg="../public/";function Vg(n){const t=n.replace(/^\/+/,""),e=`${Gg}${t}`;return qg[e]??n}function Xg(n){n.querySelectorAll("[src], [href]").forEach(e=>{const o=e.hasAttribute("src")?"src":"href",i=e.getAttribute(o);!i||i.startsWith("http")||i.startsWith("data:")||i.startsWith("#")||!i.startsWith("assets/")&&!i.startsWith("fonts/")&&!i.startsWith("favicon")||e.setAttribute(o,Vg(i))})}function Ug(n){return n.innerHTML=Jc,Xg(n),$g(),{destroy:()=>{Hg(),n.innerHTML=""}}}const nr=document.getElementById("app");nr&&Ug(nr);
