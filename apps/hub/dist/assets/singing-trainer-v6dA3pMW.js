import"./modulepreload-polyfill-B5Qt9EMX.js";import{T as Nt,o as Cn,V as on,r as Pn,a5 as Ft,h as Wt,j as Sn,a6 as dt,b as In,$ as an,a0 as it,a1 as Pe,z as Pt,t as rn,a7 as kt,a3 as An,a8 as Rn,a9 as Hn,aa as Dn,I as Lt,ab as Ke,k as xn,a2 as st,p as Et,v as Nn,ac as Fn,ad as Wn,C as kn,ae as Ln}from"./navigation-CMqlkYeU.js";import{q as ln,r as En,v as On,w as Bn,x as qn,y as Le,z as zn,A as St,B as It,C as Xn,D as Gn,E as Vn,S as cn,F as Yn,G as Un,P as jn,g as n,H as Jn,I as Kn,k as ke,n as F,J as Zn,K as Qn,L as $n,M as ei,N as ti,O as ni,Q as ii,R as si,T as oi,p as _e,l as Ie,j as G,o as x,f as j,c as C,s as A,a as U,i as Te,h as Ae,t as he,d as Ee,U as ht,b as K,m as ai,u as ri,V as li,W as un}from"./disclose-version-RGKqKYhl.js";import{e as ot,s as Ot,i as At}from"./style-BdxRwvDC.js";function Rt(e,t,i=!1){if(e.multiple){if(t==null)return;if(!En(t))return On();for(var s of e.options)s.selected=t.includes(Bt(s));return}for(s of e.options){var a=Bt(s);if(Bn(a,t)){s.selected=!0;return}}(!i||t!==void 0)&&(e.selectedIndex=-1)}function dn(e){var t=new MutationObserver(()=>{Rt(e,e.__value)});t.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),ln(()=>{t.disconnect()})}function Bt(e){return"__value"in e?e.__value:e.value}function ft(e,t,i=t){var s=new WeakSet;qn(e,"input",async a=>{var o=a?e.defaultValue:e.value;if(o=gt(e)?mt(o):o,i(o),Le!==null&&s.add(Le),await zn(),o!==(o=t())){var r=e.selectionStart,l=e.selectionEnd,c=e.value.length;if(e.value=o??"",l!==null){var u=e.value.length;r===l&&l===c&&u>c?(e.selectionStart=u,e.selectionEnd=u):(e.selectionStart=r,e.selectionEnd=Math.min(l,u))}}}),St(t)==null&&e.value&&(i(gt(e)?mt(e.value):e.value),Le!==null&&s.add(Le)),It(()=>{var a=t();if(e===document.activeElement){var o=Xn??Le;if(s.has(o))return}gt(e)&&a===mt(e.value)||e.type==="date"&&!a&&!e.value||a!==e.value&&(e.value=a??"")})}function gt(e){var t=e.type;return t==="number"||t==="range"}function mt(e){return e===""?null:+e}function qt(e,t){return e===t||e?.[cn]===t}function He(e={},t,i,s){return Gn(()=>{var a,o;return It(()=>{a=o,o=[],St(()=>{e!==i(...o)&&(t(e,...o),a&&qt(i(...a),e)&&t(null,...a))})}),()=>{Vn(()=>{o&&qt(i(...o),e)&&t(null,...o)})}}),e}function hn(e,t,i,s,a){var o=()=>{s(i[e])};i.addEventListener(t,o),a?It(()=>{i[e]=a()}):o(),(i===document.body||i===window||i===document)&&ln(()=>{i.removeEventListener(t,o)})}let Ze=!1;function ci(e){var t=Ze;try{return Ze=!1,[e(),Ze]}finally{Ze=t}}function ae(e,t,i,s){var a=!ti||(i&ni)!==0,o=(i&ei)!==0,r=(i&si)!==0,l=s,c=!0,u=()=>(c&&(c=!1,l=r?St(s):s),l),f;if(o){var h=cn in e||oi in e;f=Yn(e,t)?.set??(h&&t in e?b=>e[t]=b:void 0)}var d,p=!1;o?[d,p]=ci(()=>e[t]):d=e[t],d===void 0&&s!==void 0&&(d=u(),f&&(a&&Un(),f(d)));var g;if(a?g=()=>{var b=e[t];return b===void 0?u():(c=!0,b)}:g=()=>{var b=e[t];return b!==void 0&&(l=void 0),b===void 0?l:b},a&&(i&jn)===0)return g;if(f){var m=e.$$legacy;return(function(b,P){return arguments.length>0?((!a||!P||m||p)&&f(P?g():b),b):g()})}var v=!1,y=((i&ii)!==0?Jn:Kn)(()=>(v=!1,g()));o&&n(y);var T=Qn;return(function(b,P){if(arguments.length>0){const _=P?n(y):a&&o?ke(b):b;return F(y,_),v=!0,l!==void 0&&(l=_),b}return Zn&&v||(T.f&$n)!==0?y.v:n(y)})}class ze extends Nt{constructor(){const t=Cn(ze.getDefaults(),arguments,["volume"]);super(t),this.name="UserMedia",this._volume=this.output=new on({context:this.context,volume:t.volume}),this.volume=this._volume.volume,Pn(this,"volume"),this.mute=t.mute}static getDefaults(){return Object.assign(Nt.getDefaults(),{mute:!1,volume:0})}open(t){return Ft(this,void 0,void 0,function*(){Wt(ze.supported,"UserMedia is not supported"),this.state==="started"&&this.close();const i=yield ze.enumerateDevices();Sn(t)?this._device=i[t]:(this._device=i.find(o=>o.label===t||o.deviceId===t),!this._device&&i.length>0&&(this._device=i[0]),Wt(dt(this._device),`No matching device ${t}`));const s={audio:{echoCancellation:!1,sampleRate:this.context.sampleRate,noiseSuppression:!1,mozNoiseSuppression:!1}};this._device&&(s.audio.deviceId=this._device.deviceId);const a=yield navigator.mediaDevices.getUserMedia(s);if(!this._stream){this._stream=a;const o=this.context.createMediaStreamSource(a);In(o,this.output),this._mediaStream=o}return this})}close(){return this._stream&&this._mediaStream&&(this._stream.getAudioTracks().forEach(t=>{t.stop()}),this._stream=void 0,this._mediaStream.disconnect(),this._mediaStream=void 0),this._device=void 0,this}static enumerateDevices(){return Ft(this,void 0,void 0,function*(){return(yield navigator.mediaDevices.enumerateDevices()).filter(i=>i.kind==="audioinput")})}get state(){return this._stream&&this._stream.active?"started":"stopped"}get deviceId(){if(this._device)return this._device.deviceId}get groupId(){if(this._device)return this._device.groupId}get label(){if(this._device)return this._device.label}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}dispose(){return super.dispose(),this.close(),this._volume.dispose(),this.volume.dispose(),this}static get supported(){return dt(navigator.mediaDevices)&&dt(navigator.mediaDevices.getUserMedia)}}const zt=["#ef8aab","#f48e7d","#e89955","#cdaa42","#a4ba57","#6ec482","#2dc8b1","#16c3da","#58b8f6","#8fa9ff","#ba9bf2","#db8fd4"];function Xt(e){const t=parseInt(e.slice(1),16);return[t>>16&255,t>>8&255,t&255]}function ui(e,t,i){const s=Math.max(0,Math.min(1,i));return e.map((a,o)=>Math.round(a+s*(t[o]-a)))}function fn(e,t=0){const i=Math.floor(e),s=e-i,a=(i%12-t+12)%12,o=(a+1)%12,r=Xt(zt[a]),l=Xt(zt[o]);return ui(r,l,s)}const di={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11};function hi(e){const t=e.replace(/\d+$/,"");return di[t]??0}const vt={onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70,accuracyTiers:{perfect:{onsetMs:30,pitchCents:10,coverage:95},good:{onsetMs:75,pitchCents:25,coverage:85},okay:{onsetMs:150,pitchCents:50,coverage:70}}};function fi(e={}){const t={...vt,...e,accuracyTiers:e.accuracyTiers?{...vt.accuracyTiers,...e.accuracyTiers}:vt.accuracyTiers},i=new Map,s=new Map;function a(h,d){return(h-d)*100}function o(h,d){return Math.abs(a(h.midi,d))<=t.pitchToleranceCents}function r(h,d){return h.length===0?0:h.reduce((g,m)=>g+Math.abs(a(m.midi,d)),0)/h.length}function l(h,d,p,g){if(h.length===0)return 0;const m=h.filter(y=>o(y,d));if(m.length===0)return 0;let v=0;for(let y=0;y<m.length;y++){const T=m[y],b=m[y+1];if(b)v+=b.timeMs-T.timeMs;else{const P=p+g,_=Math.min(50,P-T.timeMs);v+=_}}return v/g*100}function c(h,d,p){const g=t.accuracyTiers;if(!g)return"okay";const m=Math.abs(h);return m<=g.perfect.onsetMs&&d<=g.perfect.pitchCents&&p>=g.perfect.coverage?"perfect":m<=g.good.onsetMs&&d<=g.good.pitchCents&&p>=g.good.coverage?"good":m<=g.okay.onsetMs&&d<=g.okay.pitchCents&&p>=g.okay.coverage?"okay":"miss"}function u(h){const{note:d,samples:p,onsetSample:g,releaseSample:m}=h;let v=0;g?v=g.timeMs-d.startTimeMs:v=t.onsetToleranceMs*2;let y=0;const T=d.startTimeMs+d.durationMs;m?y=m.timeMs-T:y=t.releaseToleranceMs*2;const b=r(p,d.midi),P=l(p,d.midi,d.startTimeMs,d.durationMs),_=Math.abs(v)<=t.onsetToleranceMs,w=Math.abs(y)<=t.releaseToleranceMs,I=P>=t.hitThreshold,D=_&&w&&I?"hit":"miss",H=c(v,b,P);return{hitStatus:D,onsetAccuracyMs:v,releaseAccuracyMs:y,pitchAccuracyCents:b,pitchCoverage:P,pitchSamples:[...p],accuracyTier:H}}return{startNote(h,d){i.set(h,{note:d,samples:[],onsetSample:null,releaseSample:null,startedAt:performance.now()})},recordPitchSample(h){for(const[d,p]of i){const{note:g}=p,m=g.startTimeMs+g.durationMs,v=t.onsetToleranceMs,y=t.releaseToleranceMs;h.timeMs>=g.startTimeMs-v&&h.timeMs<=m+y&&(p.samples.push(h),!p.onsetSample&&h.timeMs>=g.startTimeMs-v&&h.timeMs<=g.startTimeMs+v&&o(h,g.midi)&&(p.onsetSample=h),h.timeMs>=m-y&&h.timeMs<=m+y&&(p.releaseSample=h))}},endNote(h){const d=i.get(h);if(!d)return null;const p=u(d);return s.set(h,p),i.delete(h),p},getCurrentPerformance(h){const d=i.get(h);if(!d)return null;const{note:p,samples:g,onsetSample:m}=d;let v=0;m&&(v=m.timeMs-p.startTimeMs);const y=r(g,p.midi),T=l(g,p.midi,p.startTimeMs,p.durationMs);return{onsetAccuracyMs:v,pitchAccuracyCents:y,pitchCoverage:T,pitchSamples:[...g]}},getAllPerformances(){return new Map(s)},reset(){i.clear(),s.clear()},dispose(){i.clear(),s.clear()}}}const Gt={judgmentLinePosition:.12,pixelsPerSecond:200,lookAheadMs:3e3,scrollMode:"constant-speed",leadInBeats:4,playMetronomeDuringOnramp:!0,playTargetNotes:!0,playMetronome:!1,inputSources:["microphone"],feedbackConfig:{onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70}};function gi(e){const t={...Gt,...e,feedbackConfig:{...Gt.feedbackConfig,...e.feedbackConfig}},{stateCallbacks:i,eventCallbacks:s,visualCallbacks:a,logger:o}=t,r={isPlaying:!1,isPaused:!1,currentTimeMs:0,scrollOffset:0,onrampComplete:!1,targetNotes:[],activeNotes:new Set,startTime:null},l=fi(t.feedbackConfig);let c=null;const u=new Set;function f(){const w=60/i.getTempo()*1e3;return t.leadInBeats*w}function h(){return i.getViewportWidth()*t.judgmentLinePosition}function d(_){const w=t.pixelsPerSecond/1e3,I=h(),D=f();return(_+D)*w-I}function p(_){const w=h(),I=i.getCellWidth(),D=_.startColumn*I-r.scrollOffset,H=_.endColumn*I-r.scrollOffset,V=t.feedbackConfig.onsetToleranceMs/1e3*t.pixelsPerSecond;return D<=w+V&&H>=w-V}function g(){const _=new Set;for(const w of r.targetNotes){const I=w.startTimeMs+w.durationMs,D=t.feedbackConfig.onsetToleranceMs;if(r.currentTimeMs>=w.startTimeMs-D&&r.currentTimeMs<=I+D)_.add(w.id),r.activeNotes.has(w.id)||(l.startNote(w.id,w),o?.debug("NoteHighway",`Note ${w.id} became active`,{note:w}));else if(r.activeNotes.has(w.id)){const H=l.endNote(w.id);if(H){w.performance=H;const N={noteId:w.id,note:w,performance:H};H.hitStatus==="hit"?(s.emit("noteHit",N),a?.onNoteHit?.(w.id,H.accuracyTier||"okay"),o?.info("NoteHighway",`Note hit: ${w.id}`,H)):(s.emit("noteMissed",N),a?.onNoteMiss?.(w.id),o?.info("NoteHighway",`Note missed: ${w.id}`,H))}}}r.activeNotes=_}function m(){for(const _ of r.targetNotes){const w=p(_),I=u.has(_.id);w&&!I?(u.add(_.id),s.emit("noteEntered",{noteId:_.id,note:_})):!w&&I&&(u.delete(_.id),s.emit("noteExited",{noteId:_.id,note:_}))}}function v(){if(!r.onrampComplete)if(r.currentTimeMs>=0)r.onrampComplete=!0,s.emit("onrampComplete"),a?.clearOnrampCountdown?.(),o?.info("NoteHighway","Onramp complete",null);else{const w=60/i.getTempo()*1e3,I=Math.abs(r.currentTimeMs),D=Math.ceil(I/w);a?.updateOnrampCountdown?.(D)}}function y(){if(!r.isPlaying||r.isPaused||!r.startTime){c=null;return}const _=performance.now(),w=f();r.currentTimeMs=_-r.startTime-w,r.scrollOffset=d(r.currentTimeMs),v(),g(),m(),c=requestAnimationFrame(y)}function T(){c||(c=requestAnimationFrame(y))}function b(){c&&(cancelAnimationFrame(c),c=null)}return{init(_){r.targetNotes=_,o?.info("NoteHighway",`Initialized with ${_.length} notes`,null)},start(){r.isPlaying||(r.isPlaying=!0,r.isPaused=!1,r.currentTimeMs=-f(),r.scrollOffset=d(r.currentTimeMs),r.onrampComplete=!1,r.activeNotes.clear(),r.startTime=performance.now(),u.clear(),l.reset(),T(),s.emit("playbackStarted"),o?.info("NoteHighway","Playback started",{onrampDurationMs:f()}))},pause(){!r.isPlaying||r.isPaused||(r.isPaused=!0,b(),s.emit("playbackPaused"),o?.info("NoteHighway","Playback paused",{currentTimeMs:r.currentTimeMs}))},resume(){if(!r.isPlaying||!r.isPaused||!r.startTime)return;const _=performance.now()-(r.startTime+r.currentTimeMs+f());r.startTime+=_,r.isPaused=!1,T(),s.emit("playbackResumed"),o?.info("NoteHighway","Playback resumed",null)},stop(){if(!r.isPlaying)return;r.isPlaying=!1,r.isPaused=!1,r.currentTimeMs=0,r.scrollOffset=0,r.onrampComplete=!1,r.activeNotes.clear(),r.startTime=null,u.clear(),b(),a?.clearCanvas?.(),a?.clearOnrampCountdown?.(),s.emit("playbackStopped"),r.targetNotes.every(w=>w.performance!==void 0)&&s.emit("performanceComplete"),o?.info("NoteHighway","Playback stopped",null)},setScrollOffset(_){if(r.currentTimeMs=_,r.scrollOffset=d(_),r.isPlaying){const w=f();r.startTime=performance.now()-(_+w)}o?.debug("NoteHighway","Scroll offset set",{timeMs:_,scrollOffset:r.scrollOffset})},recordPitchInput(_,w,I){if(!r.isPlaying||r.isPaused||!t.inputSources.includes(I))return;const D={timeMs:r.currentTimeMs,midi:_,clarity:w,source:I};l.recordPitchSample(D)},getState(){return r},getVisibleNotes(){h();const _=i.getViewportWidth(),w=i.getCellWidth();return r.targetNotes.filter(I=>{const D=I.startColumn*w-r.scrollOffset;return I.endColumn*w-r.scrollOffset>=0&&D<=_})},getPerformanceResults(){return l.getAllPerformances()},getFeedbackCollector(){return l},dispose(){b(),l.dispose(),r.targetNotes=[],r.activeNotes.clear(),u.clear(),o?.info("NoteHighway","Service disposed",null)}}}function mi(e){const{cellHeight:t,columnWidths:i,viewport:s}=e,a=t/2,o=vi(i,e.cellWidth);return{getRowY(r){return(r-s.startRow+1)*a},getRowFromY(r){const l=r/a-1;return Math.round(l)+s.startRow},getColumnX(r){return r<0?0:r>=o.length?o[o.length-1]??0:o[r]??0},getColumnFromX(r){let l=0,c=o.length-1;for(;l<c;){const u=Math.floor((l+c)/2);(o[u]??0)<=r?l=u+1:c=u}return Math.max(0,l-1)}}}function gn(e){const{cellHeight:t,viewport:i,pixelsPerSecond:s,nowLineX:a=100,currentTimeMs:o=0}=e,r=t/2;return{getRowY(l){return(l-i.startRow+1)*r},getRowFromY(l){const c=l/r-1;return Math.round(c)+i.startRow},getColumnX(l){return 0},getColumnFromX(l){return 0},getTimeX(l){const c=l-o;return a+c/1e3*s},getTimeFromX(l){const c=(l-a)/s*1e3;return o+c}}}function vi(e,t){const i=[0];let s=0;for(let a=0;a<e.length;a++){const o=(e[a]??1)*t;s+=o,i.push(s)}return i}function pi(e,t){const{startRow:i,endRow:s}=e,a=Math.max(0,t.length-1);return{startRow:i,endRow:s,paddedStartRow:Math.max(0,i-1),paddedEndRow:Math.min(a,s+1)}}function pt(e,t,i,s){const a=s.getRowY(e),o=i;return a>=-o&&a<=t.containerHeight+o}function yi(e){let t=(e||"").replace(/\d/g,"").trim();return t=t.replace(/b/g,"b-").replace(/#/g,"b_"),t}function wi(e){switch(e){case"C":return{lineWidth:3.33,dash:[],color:"#adb5bd"};case"E":return{lineWidth:1,dash:[5,5],color:"#adb5bd"};case"G":return{lineWidth:1,dash:[],color:"#dee2e6"};case"B":case"A":case"F":case"Eb/Db":case"Db/C#":return{lineWidth:1,dash:[],color:"#ced4da"};default:return{lineWidth:1,dash:[],color:"#ced4da"}}}const Qe={stroke:"#c7cfd8",background:"rgba(207, 214, 222, 0.32)"};let Oe=null;function bi(){if(Oe)return Oe;if(typeof window>"u")return Qe;try{const e=window.getComputedStyle(document.documentElement);Oe={stroke:e.getPropertyValue("--c-anacrusis-border").trim()||Qe.stroke,background:e.getPropertyValue("--c-anacrusis-bg").trim()||Qe.background}}catch{Oe=Qe}return Oe}function Mi(e,t,i,s,a,o=0,r){const{fullRowData:l,viewportHeight:c,viewportWidth:u,cellHeight:f}=t,h=u,d=["B","A","F","E♭/D♯","D♭/C♯"];for(let p=s;p<=a;p++){const g=l[p];if(!g||g.isBoundary)continue;const m=i.getRowY(p);if(m<-10||m>c+10)continue;const v=yi(g.pitch);if(d.includes(v))continue;const y=wi(v);v==="G"?(e.save(),e.fillStyle=y.color,e.fillRect(o,m-f/2,h-o,f),e.restore()):(e.beginPath(),e.moveTo(o,m),e.lineTo(h,m),e.lineWidth=y.lineWidth,e.strokeStyle=y.color,e.setLineDash(y.dash),e.stroke(),e.setLineDash([]))}}function _i(e,t,i,s){const{columnWidths:a,viewportHeight:o,macrobeatBoundaryStyles:r,placedTonicSigns:l}=t,c=a.length;for(let u=0;u<=c;u++){const f=u===0||u===c,h=Ci(u,l),d=l.some(y=>u===y.columnIndex+2),p=s.includes(u);if(!Pi(u,l))continue;let m=null;if(f||h||d)m={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(p){const y=s.indexOf(u),T=r[y]??"dashed";if(T==="anacrusis"){const{stroke:b}=bi();m={lineWidth:1,strokeStyle:b,dash:[4,4]}}else m={lineWidth:1,strokeStyle:"#adb5bd",dash:T==="solid"?[]:[5,5]}}if(!m)continue;const v=i.getColumnX(u);e.beginPath(),e.moveTo(v,0),e.lineTo(v,o),e.lineWidth=m.lineWidth,e.strokeStyle=m.strokeStyle,e.setLineDash(m.dash),e.stroke()}e.setLineDash([])}function Ti(e,t,i){const{viewportHeight:s,beatIntervalMs:a,measureIntervalMs:o,visibleTimeRange:r,nowLineX:l,beatTimeOffsetMs:c=0}=t,u=r.startMs-c,f=r.endMs-c,h=Math.floor(u/a),d=Math.ceil(f/a);for(let p=h;p<=d;p++){const g=c+p*a,m=i.getTimeX?.(g);if(m===void 0)continue;const v=o?(g-c)%o===0:!1;e.beginPath(),e.moveTo(m,0),e.lineTo(m,s),e.lineWidth=v?2:1,e.strokeStyle=v?"#adb5bd":"#dee2e6",e.setLineDash(v?[]:[5,5]),e.stroke()}e.setLineDash([]),l!==void 0&&(e.beginPath(),e.moveTo(l,0),e.lineTo(l,s),e.lineWidth=3,e.strokeStyle="#00ff00",e.setLineDash([]),e.stroke())}function Ci(e,t){return t.some(i=>i.columnIndex===e)}function Pi(e,t){return!t.some(i=>i.columnIndex+1===e)}const Si=.7,Ii=.9,Ai=4,Ri=1,Hi=.15,Di=.2,xi=1,Ht=1.5;function Xe(e,t){return Number.isFinite(e)&&e>0&&Number.isFinite(t)&&t>0}function mn(e){if(!e||typeof e.startColumnIndex!="number"||typeof e.endColumnIndex!="number")return!1;const t=e.shape==="circle"?e.startColumnIndex+1:e.startColumnIndex;return e.endColumnIndex>t}function $e(e){const t=e?.split("-")[1];return Number.parseInt(t??"0",10)}function vn(e,t,i){const s=i*.25,a=e.uuid;if(!a)return 0;const o=t.filter(c=>!c.isDrum&&c.row===e.row&&c.startColumnIndex===e.startColumnIndex&&c.uuid&&c.uuid!==a);if(o.length===0)return 0;const r=[e,...o];return r.sort((c,u)=>$e(c.uuid)-$e(u.uuid)),r.findIndex(c=>c.uuid===a)*s}function Ni(e,t,i){const s=i/2*.12,a=e.uuid;if(!a)return 0;const o=t.filter(c=>!c.isDrum&&c.row===e.row&&c.startColumnIndex===e.startColumnIndex&&c.uuid&&c.uuid!==a&&mn(c));if(o.length===0)return 0;const r=[e,...o];return r.sort((c,u)=>$e(c.uuid)-$e(u.uuid)),r.findIndex(c=>c.uuid===a)*s}function Fi(e){if(!e)return{multiplier:1,category:"natural"};const t=e.includes("♭"),i=e.includes("♯"),s=e.includes("/");return!t&&!i?{multiplier:1,category:"natural"}:s?{multiplier:.75,category:"both-accidentals"}:{multiplier:.88,category:"single-accidental"}}function Mt(e,t,i,s,a,o){const{multiplier:r,category:l}=Fi(t);let c;if(i==="circle"){const u=o*2*Ii;switch(l){case"natural":c=u;break;case"single-accidental":c=u*.8;break;case"both-accidentals":c=u*.4;break;default:c=u*r}}else{const u=o*2*Si;switch(l){case"natural":c=u*1.5;break;case"single-accidental":c=u*1.2;break;case"both-accidentals":c=u;break;default:c=u*r}}if(!(c<Ai))if(e.fillStyle="#212529",e.font=`bold ${c}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle",i==="oval"&&l==="both-accidentals"&&t.includes("/")){const u=t.split("/"),f=c*1.1,h=f*(u.length-1),d=a-h/2;u.forEach((p,g)=>{const m=d+g*f,v=c*.08;e.fillText(p.trim(),s,m+v)})}else{const u=c*.08;e.fillText(t,s,a+u)}}function Wi(e,t,i,s,a,o,r){e.save(),e.beginPath(),e.arc(i,a,o,Math.PI/2,-Math.PI/2,!1),e.lineTo(s,a-o),e.arc(s,a,o,-Math.PI/2,Math.PI/2,!1),e.lineTo(i,a+o),e.closePath(),e.strokeStyle=t.color,e.lineWidth=r,e.shadowColor=t.color,e.shadowBlur=Ht,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore()}function Vt(e,t,i,s){const{config:a,coords:o,allNotes:r,getScaleDegreeLabel:l}=t,{cellWidth:c,cellHeight:u,columnWidths:f,degreeDisplayMode:h}=a,d=o.getRowY(s),p=o.getColumnX(i.startColumnIndex),m=(f[i.startColumnIndex]??1)*c;if(!Xe(m,u))return;const v=vn(i,r,c),y=Math.max(.5,m*.15),T=p+m/2+v,b=m/2-y/2,P=u/2-y/2;if(Xe(b,P)&&(e.save(),e.beginPath(),e.ellipse(T,d,b,P,0,0,2*Math.PI),e.strokeStyle=i.color,e.lineWidth=y,e.shadowColor=i.color,e.shadowBlur=Ht,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore(),h!=="off"&&l)){const{label:_}=l(i);_&&Mt(e,_,"oval",T,d,b)}}function Yt(e,t,i,s){const{config:a,coords:o,allNotes:r,getScaleDegreeLabel:l}=t,{cellWidth:c,cellHeight:u,degreeDisplayMode:f,longNoteStyle:h}=a,d=o.getRowY(s),p=o.getColumnX(i.startColumnIndex),m=o.getColumnX(i.startColumnIndex+1)-p;if(!Xe(m,u))return;const v=vn(i,r,c),y=p+m+v,T=Math.max(Ri,m*Hi),b=u/2-T/2,P=mn(i);if(P&&h==="style2"){const w=y,I=o.getColumnX(i.endColumnIndex);if(Xe(I-w,b)&&(Wi(e,i,w,I,d,b,T),f!=="off"&&l)){const{label:D}=l(i);if(D){const H=(w+I)/2;Mt(e,D,"circle",H,d,b)}}return}if(P){const w=o.getColumnX(i.endColumnIndex+1),I=Ni(i,r,u),D=d+I;e.beginPath(),e.moveTo(y,D),e.lineTo(w,D),e.strokeStyle=i.color,e.lineWidth=Math.max(xi,m*Di),e.stroke()}const _=m-T/2;if(Xe(_,b)&&(e.save(),e.beginPath(),e.ellipse(y,d,_,b,0,0,2*Math.PI),e.strokeStyle=i.color,e.lineWidth=T,e.shadowColor=i.color,e.shadowBlur=Ht,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore(),f!=="off"&&l)){const{label:w}=l(i);w&&Mt(e,w,"circle",y,d,_)}}function ki(e,t,i){const{config:s,coords:a}=t,{cellWidth:o,cellHeight:r}=s,l=a.getRowY(i.globalRow??i.row),c=a.getColumnX(i.columnIndex),f=a.getColumnX(i.columnIndex+1)-c,h=f*2,d=c+h/2,p=Math.min(h,r)/2*.9;if(p<2||(e.beginPath(),e.arc(d,l,p,0,2*Math.PI),e.strokeStyle="#212529",e.lineWidth=Math.max(.5,f*.05),e.stroke(),i.tonicNumber==null))return;const g=i.tonicNumber.toString(),m=p*1.5;m<6||(e.fillStyle="#212529",e.font=`bold ${m}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(g,d,l))}const Li={timeWindowMs:4e3,pixelsPerSecond:200,circleRadius:9.5,proximityThreshold:35,maxConnections:3,connectorLineWidth:2.5,connectorColor:"rgba(0,0,0,0.4)",useTonicRelativeColors:!0,tonicPitchClass:0,clarityThreshold:.5,maxOpacity:.9};function pn(e){return{...Li,...e}}function Ut(e,t,i,s,a,o,r){const l=pn(o.trailConfig);if(s<l.clarityThreshold||i<=0)return;const{cellHeight:c,colorMode:u}=o,f=yn(t,i,c,r),h=c/2*.8,d=u==="bw"?[128,128,128]:fn(i,l.tonicPitchClass);e.save(),e.beginPath(),e.arc(a,f,h+4,0,2*Math.PI),e.fillStyle=`rgba(${d[0]}, ${d[1]}, ${d[2]}, ${s*.3})`,e.fill(),e.beginPath(),e.arc(a,f,h,0,2*Math.PI),e.fillStyle=`rgba(${d[0]}, ${d[1]}, ${d[2]}, ${s})`,e.fill(),e.restore()}function yn(e,t,i,s){if(s.length===0||!s[0])return 0;const a=Math.floor(t),o=t-a,c=(s[0].midi??108)-a;if(c<0||c>=s.length)return c<0?0:e.getRowY(s.length-1);const u=e.getRowY(c),f=i/2;return u-o*f}function wn(e,t,i,s,a,o){const{viewportWidth:r,cellHeight:l,colorMode:c}=a,u=pn(a.trailConfig),f=u.timeWindowMs,h=u.pixelsPerSecond,d=a.nowLineX??r,p=i.filter(g=>g.midi>0&&g.clarity>=u.clarityThreshold).map(g=>{const m=s-g.time;if(m>=f||m<0)return null;const v=d-m/1e3*h,y=yn(t,g.midi,l,o),T=c==="bw"?[128,128,128]:fn(g.midi,u.tonicPitchClass);return{x:v,y,clarity:g.clarity,color:T}}).filter(g=>g!==null&&g.x>=0);if(p.length!==0){e.save(),e.strokeStyle=u.connectorColor,e.lineWidth=u.connectorLineWidth,e.beginPath();for(let g=0;g<p.length;g++){let m=0;for(let v=g+1;v<p.length&&m<u.maxConnections;v++){const y=p[g].x-p[v].x,T=p[g].y-p[v].y;Math.sqrt(y*y+T*T)<=u.proximityThreshold&&(e.moveTo(p[g].x,p[g].y),e.lineTo(p[v].x,p[v].y),m++)}}e.stroke();for(const g of p){const m=Math.min(g.clarity*u.maxOpacity,1);e.fillStyle=`rgba(${g.color[0]}, ${g.color[1]}, ${g.color[2]}, ${m})`,e.beginPath(),e.arc(g.x,g.y,u.circleRadius,0,2*Math.PI),e.fill()}e.restore()}}function jt(e,t,i,s,a,o,r,l){const{cellHeight:c,nowLineX:u=100,pixelsPerSecond:f}=a,h=.5;for(const d of i){const p=(u??100)+(d.startTimeMs-s)/1e3*f,g=p+d.durationMs/1e3*f;if(g<0||p>a.viewportWidth)continue;let m;if(o){if(m=o.findIndex(w=>w.midi===d.midi),m===-1)continue}else m=Math.round(108-d.midi);const v=t.getRowY(m),y=c/2-2,T=d.color??"#4CAF50",b=p<=u&&g>=u,P=r!=null&&(l??0)>.5&&Math.abs(r-d.midi)<=h,_=b&&P;if(e.save(),e.beginPath(),e.arc(p,v,y,Math.PI/2,-Math.PI/2,!1),e.lineTo(g,v-y),e.arc(g,v,y,-Math.PI/2,Math.PI/2,!1),e.lineTo(p,v+y),e.closePath(),_?(e.strokeStyle="#FFD700",e.lineWidth=5,e.shadowColor="#FFD700",e.shadowBlur=20,e.stroke(),e.fillStyle="rgba(255, 215, 0, 0.3)",e.fill(),Ei(e,u,v,y)):(e.strokeStyle=T,e.lineWidth=3,e.shadowColor=T,e.shadowBlur=8,e.stroke()),e.shadowBlur=0,e.restore(),d.label){const w=p+y+4;e.fillStyle=_?"#FFD700":"#212529",e.font=`bold ${Math.max(16,y*1.2)}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="left",e.textBaseline="middle",e.fillText(d.label,w,v)}}}function Ei(e,t,i,s){const r=s*1.5;e.save(),e.fillStyle="#FFD700",e.shadowColor="#FFD700",e.shadowBlur=6;for(let l=0;l<8;l++){const c=l/8*Math.PI*2,u=t+Math.cos(c)*r,f=i+Math.sin(c)*r;e.beginPath(),e.arc(u,f,3,0,Math.PI*2),e.fill()}e.restore()}function Oi(e){const t=e.replace(/\d+$/,"");return t.length>0?t:e}function bn(e,t){return!Number.isFinite(t)||t<=0?e:Math.round(e*t)/t}function Bi(e,t,i,s){const a=Math.max(10,Math.min(e*1.2,t*1.2)),o=i<=3?1:.7,r=s<=1?1.08:1;return bn(a*o*r,s)}function qi(e){const t=e.getContext("2d");return t&&(t.getTransform().a||window.devicePixelRatio)||1}function zi(e){if(typeof e.midi=="number")return e.midi%12;if(typeof e.pitchClass=="number")return e.pitchClass;const t={C:0,D:2,E:4,F:5,G:7,A:9,B:11},i=e.pitch.charAt(0).toUpperCase();let s=t[i]??0;return(e.pitch.includes("#")||e.pitch.includes("♯"))&&s++,(e.pitch.includes("b")||e.pitch.includes("♭"))&&s--,(s%12+12)%12}function Xi(e,t){const{showFrequencyLabels:i,showOctaveLabels:s,accidentalMode:a}=t,o=h=>s?h:Oi(h);if(i)return String(Math.round(e.frequency));const{flatName:r,sharpName:l,isAccidental:c}=e,{sharp:u,flat:f}=a;return c?u&&f?o(e.pitch):u&&!f?o(l):f&&!u?o(r):null:o(r)}function Jt(e,t,i,s){const{fullRowData:a,cellWidth:o,cellHeight:r,legendColumnWidth:l,colorMode:c,accidentalMode:u}=t,{startRow:f,endRow:h,coords:d}=i,p=qi(e.canvas),g=y=>bn(y,p),m=l;let v=0;for(const y of s){for(let T=f;T<=h;T++){const b=a[T];if(!b||b.isBoundary||b.column!==y)continue;const P=d.getRowY(T),_=!u.sharp&&!u.flat,w=b.isAccidental&&_,I=Xi(b,t);if(I===null)continue;let D=c==="bw"?"#ffffff":b.hex||"#ffffff",H="FF";w&&(H="00"),e.fillStyle=w?"rgba(255,255,255,0)":D,e.fillRect(v,P-r/2,m,r),t.highlight&&typeof t.highlight.pitchClass=="number"&&t.highlight.opacity>.01&&zi(b)===t.highlight.pitchClass&&(e.save(),e.globalAlpha=Math.min(Math.max(t.highlight.opacity,0),1),e.fillStyle=t.highlight.color??"#ffff00",e.fillRect(v,P-r/2,m,r),e.restore());const N=Bi(o,r,I.length,p);e.font=`bold ${N}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle";const V=g(v+m/2),B=g(P);e.strokeStyle=`#212529${H}`,e.lineWidth=Math.max(1.2,2.5/p),e.lineJoin="round",e.strokeText(I,V,B),e.fillStyle=`#ffffff${H}`,e.fillText(I,V,B)}v+=m}}function Gi(e,t,i,s){e&&(e.clearRect(0,0,e.canvas.width,e.canvas.height),Jt(e,i,s,["B","A"])),t&&(t.clearRect(0,0,t.canvas.width,t.canvas.height),Jt(t,i,s,["A","B"]))}var Vi=j('<canvas class="pitch-grid-legend pitch-grid-legend--left svelte-ui3s88"></canvas>'),Yi=j('<canvas class="pitch-grid-legend pitch-grid-legend--right svelte-ui3s88"></canvas>'),Ui=j('<div class="pitch-grid-container svelte-ui3s88"><!> <canvas class="pitch-grid-canvas svelte-ui3s88"></canvas> <!></div>');function ji(e,t){_e(t,!0);let i=ae(t,"colorMode",3,"color"),s=ae(t,"degreeDisplayMode",3,"off"),a=ae(t,"accidentalMode",19,()=>({sharp:!0,flat:!0})),o=ae(t,"showFrequencyLabels",3,!1),r=ae(t,"showOctaveLabels",3,!0),l=ae(t,"showRightLegend",3,!0),c=ae(t,"placedNotes",19,()=>[]),u=ae(t,"placedTonicSigns",19,()=>[]),f=ae(t,"columnWidths",19,()=>[]),h=ae(t,"macrobeatGroupings",19,()=>[]),d=ae(t,"macrobeatBoundaryStyles",19,()=>[]),p=ae(t,"longNoteStyle",3,"style1"),g=ae(t,"beatIntervalMs",3,500),m=ae(t,"beatTimeOffsetMs",3,0),v=G(void 0),y=G(void 0),T=G(void 0),b=G(null),P=G(null),_=G(null),w=G(null);const I=3,D=x(()=>t.cellWidth*I),H=x(()=>n(D)*2),N=x(()=>r()||o()),V=x(()=>n(N)?n(H)*(l()?2:1):0),B=x(()=>Math.max(0,t.viewport.containerWidth-n(V))),$=x(()=>t.mode==="notation"||t.mode==="playback"),Z=x(()=>t.mode==="singing"),S=x(()=>t.mode==="highway");function E(){if(n($))return mi({cellWidth:t.cellWidth,cellHeight:t.cellHeight,columnWidths:f(),viewport:t.viewport,modulationMarkers:t.modulationMarkers});{const M=n(S)?t.highwayConfig:t.singingConfig;return gn({cellWidth:t.cellWidth,cellHeight:t.cellHeight,viewport:t.viewport,pixelsPerSecond:M?.pixelsPerSecond??200,nowLineX:M?.nowLineX??100,currentTimeMs:M?.currentTimeMs??0})}}function X(){if(!n(b)||!n(v))return;const M=E(),{paddedStartRow:L,paddedEndRow:O}=pi(t.viewport,t.fullRowData);n(b).clearRect(0,0,n(B),t.viewport.containerHeight);const ie={fullRowData:t.fullRowData,cellHeight:t.cellHeight,viewportHeight:t.viewport.containerHeight,viewportWidth:n(B),colorMode:i()};Mi(n(b),ie,M,L,O),n($)?k(n(b),M):n(Z)?ee(n(b),M):n(S)&&se(n(b),M),n(N)&&(n(P)||n(_))&&fe(M,L,O)}function k(M,L){const O=W(h()),ie={columnWidths:f(),cellWidth:t.cellWidth,viewportHeight:t.viewport.containerHeight,macrobeatGroupings:h(),macrobeatBoundaryStyles:d(),placedTonicSigns:u()};_i(M,ie,L,O);const ve=c().filter(J=>J.isDrum||J.globalRow===void 0?!1:pt(J.globalRow,t.viewport,t.cellHeight,L)),pe=u().filter(J=>J.globalRow===void 0?!1:pt(J.globalRow,t.viewport,t.cellHeight,L)),we={config:{cellWidth:t.cellWidth,cellHeight:t.cellHeight,columnWidths:f(),degreeDisplayMode:s(),accidentalMode:a(),longNoteStyle:p(),colorMode:i()},coords:L,allNotes:c()};for(const J of ve)J.shape==="oval"?Vt(M,we,J,J.globalRow):J.shape==="circle"&&Yt(M,we,J,J.globalRow);for(const J of pe)ki(M,we,J)}function ee(M,L){if(!t.singingConfig)return;const O={cellHeight:t.cellHeight,viewportWidth:n(B),pixelsPerSecond:t.singingConfig.pixelsPerSecond??200,timeWindowMs:t.singingConfig.timeWindowMs??4e3,colorMode:i(),trailConfig:t.singingConfig.trailConfig};t.singingConfig.pitchHistory&&t.singingConfig.pitchHistory.length>0&&wn(M,L,t.singingConfig.pitchHistory,performance.now(),O,t.fullRowData),t.singingConfig.targetNotes&&t.singingConfig.targetNotes.length>0&&jt(M,L,t.singingConfig.targetNotes,performance.now(),O,t.fullRowData),t.singingConfig.userPitch&&t.singingConfig.userPitch.clarity>.5&&Ut(M,L,t.singingConfig.userPitch.midi,t.singingConfig.userPitch.clarity,n(B)-20,O,t.fullRowData)}function se(M,L){if(!t.highwayConfig)return;const O={cellHeight:t.cellHeight,viewportWidth:t.viewport.containerWidth,nowLineX:t.highwayConfig.nowLineX,pixelsPerSecond:t.highwayConfig.pixelsPerSecond??200,timeWindowMs:t.highwayConfig.timeWindowMs??4e3,colorMode:i(),trailConfig:t.highwayConfig.trailConfig};if(t.highwayConfig.scrollingGridData&&t.highwayConfig.scrollOffset!==void 0)ue(M,L);else{const ve={startMs:t.highwayConfig.currentTimeMs-1e3,endMs:t.highwayConfig.currentTimeMs+n(B)/(t.highwayConfig.pixelsPerSecond??200)*1e3},pe={viewportWidth:n(B),viewportHeight:t.viewport.containerHeight,beatIntervalMs:g(),visibleTimeRange:ve,nowLineX:t.highwayConfig.nowLineX,beatTimeOffsetMs:m()};Ti(M,pe,L),t.highwayConfig.targetNotes&&t.highwayConfig.targetNotes.length>0&&jt(M,L,t.highwayConfig.targetNotes,t.highwayConfig.currentTimeMs,O,t.fullRowData,t.highwayConfig.userPitch?.midi??null,t.highwayConfig.userPitch?.clarity??0)}le(M,t.highwayConfig.nowLineX,t.viewport.containerHeight),t.highwayConfig.showOnrampCountdown&&t.highwayConfig.onrampBeatsRemaining!==void 0&&de(M,t.highwayConfig.onrampBeatsRemaining),t.highwayConfig.userPitch&&t.highwayConfig.userPitch.clarity>.5&&Ut(M,L,t.highwayConfig.userPitch.midi,t.highwayConfig.userPitch.clarity,t.highwayConfig.nowLineX,O,t.fullRowData)}function ue(M,L){if(!t.highwayConfig?.scrollingGridData||t.highwayConfig.scrollOffset===void 0)return;const O=t.highwayConfig.scrollingGridData,ie=t.highwayConfig.scrollOffset,ve=W(O.macrobeatGroupings);for(let Q=0;Q<ve.length;Q++){const J=ve[Q]*t.cellWidth-ie;if(J>=-t.cellWidth&&J<=n(B)+t.cellWidth){const Re=O.macrobeatBoundaryStyles[Q]||"solid",Se=Re==="solid"?2:1,xe=Re==="dashed"?[5,5]:[];M.strokeStyle="#495057",M.lineWidth=Se,M.setLineDash(xe),M.beginPath(),M.moveTo(J,0),M.lineTo(J,t.viewport.containerHeight),M.stroke(),M.setLineDash([])}}const pe={cellWidth:t.cellWidth,cellHeight:t.cellHeight,columnWidths:O.columnWidths,degreeDisplayMode:s(),accidentalMode:a(),longNoteStyle:p(),colorMode:i()};for(const Q of O.placedNotes){if(Q.isDrum||Q.globalRow===void 0||!pt(Q.globalRow,t.viewport,t.cellHeight,L))continue;const we=Q.startColumnIndex*t.cellWidth-ie;if(Q.endColumnIndex*t.cellWidth-ie>=-t.cellWidth&&we<=n(B)+t.cellWidth){const Re={...L,getColumnX:xe=>xe*t.cellWidth-ie},Se={config:pe,coords:Re,allNotes:O.placedNotes};Q.shape==="oval"?Vt(M,Se,Q,Q.globalRow):Q.shape==="circle"&&Yt(M,Se,Q,Q.globalRow)}}}function le(M,L,O){M.strokeStyle="rgba(255, 0, 0, 0.9)",M.lineWidth=3,M.beginPath(),M.moveTo(L,0),M.lineTo(L,O),M.stroke()}function de(M,L){M.fillStyle="rgba(0, 0, 0, 0.7)",M.fillRect(n(B)/2-40,10,80,50),M.fillStyle="#ffffff",M.font="bold 36px sans-serif",M.textAlign="center",M.textBaseline="middle",M.fillText(L.toString(),n(B)/2,35)}function fe(M,L,O){const ie={fullRowData:t.fullRowData,cellWidth:t.cellWidth,cellHeight:t.cellHeight,legendColumnWidth:n(D),colorMode:i(),showFrequencyLabels:o(),showOctaveLabels:r(),accidentalMode:a(),highlight:t.legendHighlight},ve={startRow:L,endRow:O,coords:M};Gi(n(P),n(_),ie,ve)}function W(M){const L=[];let O=0;for(const ie of M)O+=ie,L.push(O);return L}function R(){if(n(w))return;function M(){X(),F(w,requestAnimationFrame(M),!0)}F(w,requestAnimationFrame(M),!0)}function q(){n(w)&&(cancelAnimationFrame(n(w)),F(w,null))}function Y(){if(!n(v)||(F(b,n(v).getContext("2d"),!0),!n(b)))return;const M=window.devicePixelRatio||1;n(v).width=n(B)*M,n(v).height=t.viewport.containerHeight*M,n(v).style.width=`${n(B)}px`,n(v).style.height=`${t.viewport.containerHeight}px`,n(b).scale(M,M),n(y)&&(F(P,n(y).getContext("2d"),!0),n(P)&&(n(y).width=n(H)*M,n(y).height=t.viewport.containerHeight*M,n(y).style.width=`${n(H)}px`,n(y).style.height=`${t.viewport.containerHeight}px`,n(P).scale(M,M))),n(T)&&(F(_,n(T).getContext("2d"),!0),n(_)&&(n(T).width=n(H)*M,n(T).height=t.viewport.containerHeight*M,n(T).style.width=`${n(H)}px`,n(T).style.height=`${t.viewport.containerHeight}px`,n(_).scale(M,M))),X(),(n(Z)||n(S))&&R()}an(()=>{Y()}),it(()=>{q()}),Ie(()=>{t.mode,t.viewport,t.cellWidth,t.cellHeight,i(),s(),c(),u(),f(),n(b)&&n($)&&X()}),Ie(()=>{t.mode,n(Z)||n(S)?R():(q(),n(b)&&X())}),Ie(()=>{t.viewport.containerWidth,t.viewport.containerHeight,n(b)&&n(v)&&Y()});var ne=Ui(),oe=C(ne);{var ce=M=>{var L=Vi();He(L,O=>F(y,O),()=>n(y)),U(M,L)};Pe(oe,M=>{n(N)&&M(ce)})}var ge=A(oe,2);He(ge,M=>F(v,M),()=>n(v));var me=A(ge,2);{var Ce=M=>{var L=Yi();He(L,O=>F(T,O),()=>n(T)),U(M,L)};Pe(me,M=>{n(N)&&l()&&M(Ce)})}U(e,ne),Te()}function Ji(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var yt,Kt;function Ki(){if(Kt)return yt;Kt=1;function e(t){if(this.size=t|0,this.size<=1||(this.size&this.size-1)!==0)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=t<<1;for(var i=new Array(this.size*2),s=0;s<i.length;s+=2){const u=Math.PI*s/this.size;i[s]=Math.cos(u),i[s+1]=-Math.sin(u)}this.table=i;for(var a=0,o=1;this.size>o;o<<=1)a++;this._width=a%2===0?a-1:a,this._bitrev=new Array(1<<this._width);for(var r=0;r<this._bitrev.length;r++){this._bitrev[r]=0;for(var l=0;l<this._width;l+=2){var c=this._width-l-2;this._bitrev[r]|=(r>>>l&3)<<c}}this._out=null,this._data=null,this._inv=0}return yt=e,e.prototype.fromComplexArray=function(i,s){for(var a=s||new Array(i.length>>>1),o=0;o<i.length;o+=2)a[o>>>1]=i[o];return a},e.prototype.createComplexArray=function(){const i=new Array(this._csize);for(var s=0;s<i.length;s++)i[s]=0;return i},e.prototype.toComplexArray=function(i,s){for(var a=s||this.createComplexArray(),o=0;o<a.length;o+=2)a[o]=i[o>>>1],a[o+1]=0;return a},e.prototype.completeSpectrum=function(i){for(var s=this._csize,a=s>>>1,o=2;o<a;o+=2)i[s-o]=i[o],i[s-o+1]=-i[o+1]},e.prototype.transform=function(i,s){if(i===s)throw new Error("Input and output buffers must be different");this._out=i,this._data=s,this._inv=0,this._transform4(),this._out=null,this._data=null},e.prototype.realTransform=function(i,s){if(i===s)throw new Error("Input and output buffers must be different");this._out=i,this._data=s,this._inv=0,this._realTransform4(),this._out=null,this._data=null},e.prototype.inverseTransform=function(i,s){if(i===s)throw new Error("Input and output buffers must be different");this._out=i,this._data=s,this._inv=1,this._transform4();for(var a=0;a<i.length;a++)i[a]/=this.size;this._out=null,this._data=null},e.prototype._transform4=function(){var i=this._out,s=this._csize,a=this._width,o=1<<a,r=s/o<<1,l,c,u=this._bitrev;if(r===4)for(l=0,c=0;l<s;l+=r,c++){const v=u[c];this._singleTransform2(l,v,o)}else for(l=0,c=0;l<s;l+=r,c++){const v=u[c];this._singleTransform4(l,v,o)}var f=this._inv?-1:1,h=this.table;for(o>>=2;o>=2;o>>=2){r=s/o<<1;var d=r>>>2;for(l=0;l<s;l+=r)for(var p=l+d,g=l,m=0;g<p;g+=2,m+=o){const v=g,y=v+d,T=y+d,b=T+d,P=i[v],_=i[v+1],w=i[y],I=i[y+1],D=i[T],H=i[T+1],N=i[b],V=i[b+1],B=P,$=_,Z=h[m],S=f*h[m+1],E=w*Z-I*S,X=w*S+I*Z,k=h[2*m],ee=f*h[2*m+1],se=D*k-H*ee,ue=D*ee+H*k,le=h[3*m],de=f*h[3*m+1],fe=N*le-V*de,W=N*de+V*le,R=B+se,q=$+ue,Y=B-se,ne=$-ue,oe=E+fe,ce=X+W,ge=f*(E-fe),me=f*(X-W),Ce=R+oe,M=q+ce,L=R-oe,O=q-ce,ie=Y+me,ve=ne-ge,pe=Y-me,Q=ne+ge;i[v]=Ce,i[v+1]=M,i[y]=ie,i[y+1]=ve,i[T]=L,i[T+1]=O,i[b]=pe,i[b+1]=Q}}},e.prototype._singleTransform2=function(i,s,a){const o=this._out,r=this._data,l=r[s],c=r[s+1],u=r[s+a],f=r[s+a+1],h=l+u,d=c+f,p=l-u,g=c-f;o[i]=h,o[i+1]=d,o[i+2]=p,o[i+3]=g},e.prototype._singleTransform4=function(i,s,a){const o=this._out,r=this._data,l=this._inv?-1:1,c=a*2,u=a*3,f=r[s],h=r[s+1],d=r[s+a],p=r[s+a+1],g=r[s+c],m=r[s+c+1],v=r[s+u],y=r[s+u+1],T=f+g,b=h+m,P=f-g,_=h-m,w=d+v,I=p+y,D=l*(d-v),H=l*(p-y),N=T+w,V=b+I,B=P+H,$=_-D,Z=T-w,S=b-I,E=P-H,X=_+D;o[i]=N,o[i+1]=V,o[i+2]=B,o[i+3]=$,o[i+4]=Z,o[i+5]=S,o[i+6]=E,o[i+7]=X},e.prototype._realTransform4=function(){var i=this._out,s=this._csize,a=this._width,o=1<<a,r=s/o<<1,l,c,u=this._bitrev;if(r===4)for(l=0,c=0;l<s;l+=r,c++){const ut=u[c];this._singleRealTransform2(l,ut>>>1,o>>>1)}else for(l=0,c=0;l<s;l+=r,c++){const ut=u[c];this._singleRealTransform4(l,ut>>>1,o>>>1)}var f=this._inv?-1:1,h=this.table;for(o>>=2;o>=2;o>>=2){r=s/o<<1;var d=r>>>1,p=d>>>1,g=p>>>1;for(l=0;l<s;l+=r)for(var m=0,v=0;m<=g;m+=2,v+=o){var y=l+m,T=y+p,b=T+p,P=b+p,_=i[y],w=i[y+1],I=i[T],D=i[T+1],H=i[b],N=i[b+1],V=i[P],B=i[P+1],$=_,Z=w,S=h[v],E=f*h[v+1],X=I*S-D*E,k=I*E+D*S,ee=h[2*v],se=f*h[2*v+1],ue=H*ee-N*se,le=H*se+N*ee,de=h[3*v],fe=f*h[3*v+1],W=V*de-B*fe,R=V*fe+B*de,q=$+ue,Y=Z+le,ne=$-ue,oe=Z-le,ce=X+W,ge=k+R,me=f*(X-W),Ce=f*(k-R),M=q+ce,L=Y+ge,O=ne+Ce,ie=oe-me;if(i[y]=M,i[y+1]=L,i[T]=O,i[T+1]=ie,m===0){var ve=q-ce,pe=Y-ge;i[b]=ve,i[b+1]=pe;continue}if(m!==g){var Q=ne,we=-oe,J=q,Re=-Y,Se=-f*Ce,xe=-f*me,at=-f*ge,rt=-f*ce,lt=Q+Se,ct=we+xe,je=J+rt,Je=Re-at,Dt=l+p-m,xt=l+d-m;i[Dt]=lt,i[Dt+1]=ct,i[xt]=je,i[xt+1]=Je}}}},e.prototype._singleRealTransform2=function(i,s,a){const o=this._out,r=this._data,l=r[s],c=r[s+a],u=l+c,f=l-c;o[i]=u,o[i+1]=0,o[i+2]=f,o[i+3]=0},e.prototype._singleRealTransform4=function(i,s,a){const o=this._out,r=this._data,l=this._inv?-1:1,c=a*2,u=a*3,f=r[s],h=r[s+a],d=r[s+c],p=r[s+u],g=f+d,m=f-d,v=h+p,y=l*(h-p),T=g+v,b=m,P=-y,_=g-v,w=m,I=y;o[i]=T,o[i+1]=0,o[i+2]=b,o[i+3]=P,o[i+4]=_,o[i+5]=0,o[i+6]=w,o[i+7]=I},yt}var Zi=Ki();const Qi=Ji(Zi);class Ge{_inputLength;_fft;_bufferSupplier;_paddedInputBuffer;_transformBuffer;_inverseBuffer;static forFloat32Array(t){return new Ge(t,i=>new Float32Array(i))}static forFloat64Array(t){return new Ge(t,i=>new Float64Array(i))}static forNumberArray(t){return new Ge(t,i=>Array(i))}constructor(t,i){if(t<1)throw new Error("Input length must be at least one");this._inputLength=t,this._fft=new Qi(ts(2*t)),this._bufferSupplier=i,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}get inputLength(){return this._inputLength}autocorrelate(t,i=this._bufferSupplier(t.length)){if(t.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${t.length}`);for(let a=0;a<t.length;a++)this._paddedInputBuffer[a]=t[a];for(let a=t.length;a<this._paddedInputBuffer.length;a++)this._paddedInputBuffer[a]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const s=this._transformBuffer;for(let a=0;a<s.length;a+=2)s[a]=s[a]*s[a]+s[a+1]*s[a+1],s[a+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let a=0;a<t.length;a++)i[a]=this._inverseBuffer[2*a];return i}}function $i(e){const t=[];let i=!1,s=-1/0,a=-1;for(let o=1;o<e.length-1;o++)e[o-1]<=0&&e[o]>0?(i=!0,a=o,s=e[o]):e[o-1]>0&&e[o]<=0?(i=!1,a!==-1&&t.push(a)):i&&e[o]>s&&(s=e[o],a=o);return t}function es(e,t){const[i,s,a]=[e-1,e,e+1],[o,r,l]=[t[i],t[s],t[a]],c=o/2-r+l/2,u=-(o/2)*(s+a)+r*(i+a)-l/2*(i+s),f=o*s*a/2-r*i*a+l*i*s/2,h=-u/(2*c),d=c*h*h+u*h+f;return[h,d]}class Ve{_autocorrelator;_nsdfBuffer;_clarityThreshold=.9;_minVolumeAbsolute=0;_maxInputAmplitude=1;static forFloat32Array(t){return new Ve(t,i=>new Float32Array(i))}static forFloat64Array(t){return new Ve(t,i=>new Float64Array(i))}static forNumberArray(t){return new Ve(t,i=>Array(i))}constructor(t,i){this._autocorrelator=new Ge(t,i),this._nsdfBuffer=i(t)}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(t){if(!Number.isFinite(t)||t<=0||t>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=t}set minVolumeAbsolute(t){if(!Number.isFinite(t)||t<0||t>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=t}set minVolumeDecibels(t){if(!Number.isFinite(t)||t>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(t/10)}set maxInputAmplitude(t){if(!Number.isFinite(t)||t<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=t}findPitch(t,i){if(this._belowMinimumVolume(t))return[0,0];this._nsdf(t);const s=$i(this._nsdfBuffer);if(s.length===0)return[0,0];const a=Math.max(...s.map(c=>this._nsdfBuffer[c])),o=s.find(c=>this._nsdfBuffer[c]>=this._clarityThreshold*a),[r,l]=es(o,this._nsdfBuffer);return[i/r,Math.min(l,1)]}_belowMinimumVolume(t){if(this._minVolumeAbsolute===0)return!1;let i=0;for(let s=0;s<t.length;s++)i+=t[s]**2;return Math.sqrt(i/t.length)<this._minVolumeAbsolute}_nsdf(t){this._autocorrelator.autocorrelate(t,this._nsdfBuffer);let i=2*this._nsdfBuffer[0],s;for(s=0;s<this._nsdfBuffer.length&&i>0;s++)this._nsdfBuffer[s]=2*this._nsdfBuffer[s]/i,i-=t[s]**2+t[t.length-s-1]**2;for(;s<this._nsdfBuffer.length;s++)this._nsdfBuffer[s]=0}}function ts(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e++,e}const ns=100,wt=12;function is(e){const t=Math.round(e);return(e-t)*ns}function ss(e){return Math.round(e)}function os(e){return(Math.round(e)%wt+wt)%wt}var as=j('<div class="pitch-wheel-option svelte-53gwvz"> </div>'),rs=j('<div class="pitch-wheel svelte-53gwvz" role="slider" tabindex="0" aria-valuemin="0"><div class="pitch-wheel-viewport svelte-53gwvz"><div class="pitch-wheel-options svelte-53gwvz"></div></div> <div class="pitch-wheel-overlay svelte-53gwvz"></div></div>');function Zt(e,t){_e(t,!0);let i=ae(t,"selectedIndex",15),s=ae(t,"ariaLabel",3,"Pitch selector");const a=40,o=a;let r=G(void 0),l=G(void 0),c=G(void 0),u=G(!1),f=G(null),h=G(0),d=G(0),p=G(a);const g=x(()=>t.options.map((S,E)=>Math.min(Math.abs(E-i()),3))),m=x(()=>n(l)?.clientHeight??0),v=x(()=>Math.max(0,(n(m)-n(p))/2)),y=x(()=>n(v)+i()*n(p)+n(p)/2),T=x(()=>n(m)>0?n(m)/2-n(y):0);function b(S){if(!t.options||t.options.length===0)return;let E=S;typeof t.onbeforechange=="function"&&(E=t.onbeforechange(S));const X=Math.max(0,Math.min(t.options.length-1,E));if(X!==i()&&(i(X),typeof t.onchange=="function")){const k=t.options[X];k&&t.onchange(X,k)}}function P(S){S!==0&&b(i()+S)}function _(S){S.preventDefault(),S.stopPropagation();const E=Math.sign(S.deltaY);E!==0&&P(E)}function w(S){S.key==="ArrowUp"?(S.preventDefault(),P(-1)):S.key==="ArrowDown"?(S.preventDefault(),P(1)):S.key==="Home"?(S.preventDefault(),b(0)):S.key==="End"&&(S.preventDefault(),b(t.options.length-1))}function I(S){if(F(u,!0),F(f,S.pointerId,!0),F(h,S.clientY,!0),F(d,0),n(r)&&typeof n(r).setPointerCapture=="function")try{n(r).setPointerCapture(S.pointerId)}catch{}}function D(S){if(!n(u)||S.pointerId!==n(f))return;const E=S.clientY-n(h);if(F(h,S.clientY,!0),E===0)return;F(d,n(d)+E);const X=n(p)||o;for(;Math.abs(n(d))>=X;){const k=-Math.sign(n(d));P(k),F(d,n(d)-Math.sign(n(d))*X)}}function H(S){n(u)&&S.pointerId===n(f)&&(F(u,!1),F(f,null),F(d,0),n(r)?.hasPointerCapture?.(S.pointerId)&&n(r).releasePointerCapture(S.pointerId))}Ie(()=>{if(!n(c)||!n(l))return;const S=()=>{const X=n(c)?.querySelector(".pitch-wheel-option");X&&F(p,X.offsetHeight||a,!0)};S();const E=new ResizeObserver(()=>{S()});return E.observe(n(l)),()=>{E.disconnect()}});var N=rs();N.__keydown=w,N.__pointerdown=I,N.__pointermove=D,N.__pointerup=H;let V;var B=C(N),$=C(B);let Z;ot($,23,()=>t.options,S=>S.index,(S,E,X)=>{var k=as(),ee=C(k);he(()=>{Ee(k,"data-distance",n(g)[n(X)]),K(ee,n(E).label)}),U(S,k)}),He($,S=>F(c,S),()=>n(c)),He(B,S=>F(l,S),()=>n(l)),He(N,S=>F(r,S),()=>n(r)),he(()=>{Ee(N,"aria-label",s()),Ee(N,"aria-valuemax",t.options.length-1),Ee(N,"aria-valuenow",i()),Ee(N,"aria-valuetext",t.options[i()]?.label??""),V=Ot(N,"",V,{height:t.wheelHeight?`${t.wheelHeight}px`:"100%"}),Z=Ot($,"",Z,{"padding-top":`${n(v)??""}px`,"padding-bottom":`${n(v)??""}px`,transform:`translateY(${n(T)??""}px)`})}),ht("wheel",N,_),ht("pointercancel",N,H),ht("pointerleave",N,H),U(e,N),Te()}Ae(["keydown","pointerdown","pointermove","pointerup"]);const Mn=7;function et(e,t,i){return Number.isFinite(e)?Math.max(t,Math.min(i,Math.round(e))):t}function ls(e,t,i,s=Mn){const a=Math.max(0,i-1),o=et(e,0,a),r=Math.max(1,Math.round(s)),l=Math.max(0,o-(r-1));return et(t,0,l)}function cs(e,t,i,s=Mn){const a=Math.max(0,i-1),o=et(e,0,a),r=Math.max(1,Math.round(s)),l=Math.min(a,o+(r-1));return et(t,l,a)}function us(e){return e.map((t,i)=>({index:i,label:t.pitch,midi:t.midi,toneNote:t.toneNote,frequency:t.frequency}))}var ds=j('<div class="summary-card svelte-yqjxxp"><div class="summary-label svelte-yqjxxp"> </div> <div class="summary-metadata svelte-yqjxxp"> </div></div>'),hs=j('<div class="dual-pitch-wheel svelte-yqjxxp"><div class="wheels-container svelte-yqjxxp"><div class="wheel-column svelte-yqjxxp"><div class="wheel-label svelte-yqjxxp">High</div> <!></div> <div class="wheel-column svelte-yqjxxp"><div class="wheel-label svelte-yqjxxp">Low</div> <!></div></div> <!></div>');function fs(e,t){_e(t,!0);let i=ae(t,"topIndex",15),s=ae(t,"bottomIndex",15),a=ae(t,"minSpan",3,7),o=ae(t,"showSummary",3,!0);const r=x(()=>us(t.fullRowData)),l=x(()=>({topIndex:i(),bottomIndex:s(),topPitch:t.fullRowData[i()],bottomPitch:t.fullRowData[s()],span:s()-i()+1})),c=x(()=>n(l).topPitch&&n(l).bottomPitch?`${n(l).topPitch.pitch} – ${n(l).bottomPitch.pitch}`:""),u=x(()=>`${n(l).span} ${n(l).span===1?"pitch":"pitches"}`);function f(w){return ls(s(),w,n(r).length,a())}function h(w){return cs(i(),w,n(r).length,a())}function d(w,I){i(w),typeof t.onrangechange=="function"&&t.onrangechange(n(l))}function p(w,I){s(w),typeof t.onrangechange=="function"&&t.onrangechange(n(l))}var g=hs(),m=C(g),v=C(m),y=A(C(v),2);Zt(y,{get options(){return n(r)},get selectedIndex(){return i()},onchange:d,onbeforechange:f,get wheelHeight(){return t.wheelHeight},ariaLabel:"High pitch selector"});var T=A(v,2),b=A(C(T),2);Zt(b,{get options(){return n(r)},get selectedIndex(){return s()},onchange:p,onbeforechange:h,get wheelHeight(){return t.wheelHeight},ariaLabel:"Low pitch selector"});var P=A(m,2);{var _=w=>{var I=ds(),D=C(I),H=C(D),N=A(D,2),V=C(N);he(()=>{K(H,n(c)),K(V,n(u))}),U(w,I)};Pe(P,w=>{o()&&w(_)})}U(e,g),Te()}Ae(["change"]);var gs=Object.defineProperty,ms=(e,t,i)=>t in e?gs(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Be=(e,t,i)=>ms(e,typeof t!="symbol"?t+"":t,i);const Qt={isDetecting:!1,visualizationMode:"highway",tonic:"C",useDegrees:!1,showAccidentals:!0,pitchHighlightEnabled:!0,yAxisRange:{minMidi:48,maxMidi:72},drone:{isPlaying:!1,octave:3,volume:-12}};function vs(){let e=G(ke({...Qt}));return{get state(){return n(e)},toggleDetecting(){n(e).isDetecting=!n(e).isDetecting},setDetecting(t){n(e).isDetecting=t},setVisualizationMode(t){n(e).visualizationMode=t},setTonic(t){n(e).tonic=t},setUseDegrees(t){n(e).useDegrees=t},setShowAccidentals(t){n(e).showAccidentals=t},togglePitchHighlight(){n(e).pitchHighlightEnabled=!n(e).pitchHighlightEnabled},setPitchHighlightEnabled(t){n(e).pitchHighlightEnabled=t},setYAxisRange(t){n(e).yAxisRange=t},expandYAxisUpper(){n(e).yAxisRange.maxMidi<108&&(n(e).yAxisRange={...n(e).yAxisRange,maxMidi:n(e).yAxisRange.maxMidi+1})},contractYAxisUpper(){n(e).yAxisRange.maxMidi>n(e).yAxisRange.minMidi+6&&(n(e).yAxisRange={...n(e).yAxisRange,maxMidi:n(e).yAxisRange.maxMidi-1})},expandYAxisLower(){n(e).yAxisRange.minMidi>21&&(n(e).yAxisRange={...n(e).yAxisRange,minMidi:n(e).yAxisRange.minMidi-1})},contractYAxisLower(){n(e).yAxisRange.minMidi<n(e).yAxisRange.maxMidi-6&&(n(e).yAxisRange={...n(e).yAxisRange,minMidi:n(e).yAxisRange.minMidi+1})},toggleDrone(){n(e).drone={...n(e).drone,isPlaying:!n(e).drone.isPlaying}},setDroneOctave(t){n(e).drone={...n(e).drone,octave:t}},setDroneVolume(t){n(e).drone={...n(e).drone,volume:t}},reset(){F(e,{...Qt},!0)}}}const z=vs(),ps=200,$t={currentPitch:null,history:[],stablePitch:{pitchClass:null,opacity:0,size:1}};function ys(){let e=G(ke({...$t}));return{get state(){return n(e)},setCurrentPitch(t){n(e).currentPitch=t},addHistoryPoint(t){n(e).history.push(t),n(e).history.length>ps&&n(e).history.shift()},setStablePitch(t){n(e).stablePitch=t},clearHistory(){n(e).history=[]},reset(){F(e,{...$t},!0)}}}const te=ys(),en={isPlaying:!1,startTime:null,currentTimeMs:0,targetNotes:[],nowLineX:100,pixelsPerSecond:200,timeWindowMs:4e3};function ws(){let e=G(ke({...en})),t=null,i=null;function s(l){return l.map((c,u)=>({id:`target-${u}`,midi:c.midi,startTimeMs:c.startTimeMs,durationMs:c.durationMs,startColumn:0,endColumn:0,color:"#3b82f6",shape:"oval",globalRow:0}))}function a(){if(!t)return;const l=t.getState();n(e).isPlaying=l.isPlaying&&!l.isPaused,n(e).currentTimeMs=l.currentTimeMs;const c=t.getPerformanceResults();n(e).targetNotes=n(e).targetNotes.map((u,f)=>{const h=`target-${f}`,d=c.get(h);return{...u,hit:d?.hitStatus==="hit"}})}function o(){n(e).isPlaying&&t?(a(),i=requestAnimationFrame(o)):i=null}function r(){t&&t.dispose(),t=gi({judgmentLinePosition:n(e).nowLineX/800,pixelsPerSecond:n(e).pixelsPerSecond,lookAheadMs:n(e).timeWindowMs,scrollMode:"constant-speed",leadInBeats:0,playMetronomeDuringOnramp:!1,playTargetNotes:!1,playMetronome:!1,inputSources:["microphone"],feedbackConfig:{onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70},stateCallbacks:{getTempo:()=>120,getCellWidth:()=>20,getViewportWidth:()=>800},eventCallbacks:{emit:(c,u)=>{if(console.debug("[Highway]",c,u),c==="noteHit"){const f=u;console.log(`[Highway] Note HIT: ${f.noteId}, accuracy: ${f.performance.accuracyTier||"unknown"}`)}else c==="noteMissed"?console.log(`[Highway] Note MISSED: ${u.noteId}`):c==="onrampComplete"?console.log("[Highway] Onramp complete, playback starting!"):c==="performanceComplete"&&console.log("[Highway] Performance complete!")}}});const l=s(n(e).targetNotes);t.init(l)}return{get state(){return n(e)},get engineService(){return t},start(){!t&&n(e).targetNotes.length>0&&r(),t&&(t.start(),n(e).isPlaying=!0,n(e).startTime=performance.now(),n(e).currentTimeMs=0,o())},stop(){t&&t.stop(),n(e).isPlaying=!1,i!==null&&(cancelAnimationFrame(i),i=null)},pause(){t&&t.pause(),n(e).isPlaying=!1,i!==null&&(cancelAnimationFrame(i),i=null)},resume(){t&&(t.resume(),n(e).isPlaying=!0,o())},setTargetNotes(l){if(n(e).targetNotes=l,t){const c=s(l);t.init(c)}},markNoteHit(l){l>=0&&l<n(e).targetNotes.length&&(n(e).targetNotes=n(e).targetNotes.map((c,u)=>u===l?{...c,hit:!0}:c))},setNowLineX(l){n(e).nowLineX=l},setPixelsPerSecond(l){n(e).pixelsPerSecond=l},setTimeWindowMs(l){n(e).timeWindowMs=l},recordPitchInput(l,c){t&&n(e).isPlaying&&t.recordPitchInput(l,c,"microphone")},getPerformanceResults(){return t?.getPerformanceResults()??new Map},reset(){i!==null&&(cancelAnimationFrame(i),i=null),t&&(t.dispose(),t=null),F(e,{...en},!0)}}}const be=ws(),bs={numLoops:5,minMidi:48,maxMidi:72,tempo:108,referenceVolume:-12},tn={isActive:!1,isPlaying:!1,config:{...bs},currentLoop:0,currentPhase:"reference",currentPitch:null,generatedNotes:[],results:[]};function Ms(e,t){return Math.floor(Math.random()*(t-e+1))+e}function nn(e){return 60/e*1e3/2}function _s(){let e=G(ke({...tn}));function t(s){const a=[],o=nn(s.tempo),r=2e3;for(let l=0;l<s.numLoops;l++){const c=Ms(s.minMidi,s.maxMidi),u=r+l*32*o;a.push({midi:c,startTimeMs:u,durationMs:8*o,lyric:"👂"}),a.push({midi:c,startTimeMs:u+16*o,durationMs:8*o,lyric:"🎤"})}return a}function i(s,a){const o=nn(a),r=32*o,l=s-2e3;if(l<0)return{loop:0,phase:"rest2"};const c=Math.floor(l/r),u=l%r,f=Math.floor(u/o);let h;return f<8?h="reference":f<16?h="rest1":f<24?h="input":h="rest2",{loop:c,phase:h}}return{get state(){return n(e)},configure(s){n(e).config={...n(e).config,...s}},setPitchRange(s,a){n(e).config.minMidi=s,n(e).config.maxMidi=a},start(){const s=t(n(e).config);n(e).generatedNotes=s,n(e).isActive=!0,n(e).isPlaying=!1,n(e).currentLoop=0,n(e).currentPhase="reference",n(e).currentPitch=s.length>0?s[0].midi:null,n(e).results=[]},stop(){n(e).isActive=!1,n(e).isPlaying=!1,n(e).currentLoop=0,n(e).currentPhase="reference",n(e).currentPitch=null},setPlaying(s){n(e).isPlaying=s},updatePhase(s){const{loop:a,phase:o}=i(s,n(e).config.tempo);n(e).currentLoop=a,n(e).currentPhase=o;const r=a*2;r<n(e).generatedNotes.length&&(n(e).currentPitch=n(e).generatedNotes[r].midi)},addResult(s){n(e).results.push(s)},hasResultForLoop(s){return n(e).results.some(a=>a.loopIndex===s)},getResults(){return n(e).results},getCurrentProgress(){return{current:n(e).currentLoop+1,total:n(e).config.numLoops}},getGeneratedNotes(){return n(e).generatedNotes},getAverageAccuracy(){return n(e).results.length===0?0:n(e).results.reduce((s,a)=>s+a.accuracy,0)/n(e).results.length},getHitCount(){return n(e).results.filter(s=>{var a;return((a=s.performance)==null?void 0:a.hitStatus)==="hit"}).length},reset(){F(e,{...tn,config:{...n(e).config}},!0)}}}const re=_s();var Ts=j('<div class="singing-canvas-container svelte-15ar5r5"><!> <canvas class="pitch-trail-canvas svelte-15ar5r5"></canvas></div>');function Cs(e,t){_e(t,!0);let i=G(void 0),s=G(800),a=G(400),o=G(void 0),r=G(null),l=G(null),c=0,u=0,f=0;const h=20,d=!0,p=!1,g=x(()=>n(s)>=720),m=3,v=x(()=>h*m),y=x(()=>n(v)*2),T=x(()=>d),b=x(()=>n(T)?n(y)*(n(g)?2:1):0),P=x(()=>Math.max(0,n(s)-n(b))),_=x(()=>n(T)?n(y):0),w=()=>{try{return!!globalThis.__ST_DEBUG_TRAIL}catch{return!1}},I=x(()=>Wn(z.state.yAxisRange.minMidi,z.state.yAxisRange.maxMidi)),D=x(()=>Fn({containerHeight:n(a),fullRowData:n(I),preferredCellHeight:40,minCellHeight:20})),H=x(()=>z.state.visualizationMode==="highway"?"highway":"singing"),N=x(()=>60/re.state.config.tempo*1e3),V=2e3,B=x(()=>(()=>{if(!z.state.pitchHighlightEnabled)return;const W=te.state.stablePitch;if(!(W.pitchClass===null||W.opacity<=.01))return{pitchClass:W.pitchClass,opacity:W.opacity,color:"#ffff00"}})());function $(){return be.state.targetNotes.map((W,R)=>({id:`target-${R}`,midi:W.midi,startTimeMs:W.startTimeMs,durationMs:W.durationMs,label:W.lyric}))}const Z=x(()=>({timeWindowMs:4e3,pixelsPerSecond:200,circleRadius:9.5,proximityThreshold:35,maxConnections:3,connectorLineWidth:2.5,connectorColor:"rgba(0,0,0,0.4)",useTonicRelativeColors:!0,tonicPitchClass:hi(z.state.tonic),clarityThreshold:.5,maxOpacity:.9})),S=x(()=>n(H)==="singing"?{userPitch:te.state.currentPitch?{frequency:te.state.currentPitch.frequency,midi:te.state.currentPitch.midi,clarity:te.state.currentPitch.clarity,pitchClass:te.state.currentPitch.pitchClass}:null,pitchHistory:[],targetNotes:[],pixelsPerSecond:200,timeWindowMs:4e3,trailConfig:n(Z)}:void 0),E=x(()=>n(H)==="highway"?{userPitch:te.state.currentPitch?{frequency:te.state.currentPitch.frequency,midi:te.state.currentPitch.midi,clarity:te.state.currentPitch.clarity,pitchClass:te.state.currentPitch.pitchClass}:null,pitchHistory:[],targetNotes:$(),nowLineX:be.state.nowLineX,pixelsPerSecond:be.state.pixelsPerSecond,currentTimeMs:be.state.currentTimeMs,timeWindowMs:be.state.timeWindowMs,trailConfig:n(Z)}:void 0),X=x(()=>({startRow:n(D).startRow,endRow:n(D).endRow,zoomLevel:1,containerWidth:n(s),containerHeight:n(a)}));function k(){if(!n(o))return;const W=window.devicePixelRatio||1;n(o).width=n(P)*W,n(o).height=n(a)*W,n(o).style.width=`${n(P)}px`,n(o).style.height=`${n(a)}px`,n(o).style.left=`${n(_)}px`;const R=n(o).getContext("2d");if(!R){F(r,null);return}R.setTransform(W,0,0,W,0,0),F(r,R,!0)}function ee(){if(!n(r)||n(P)<=0)return;n(r).clearRect(0,0,n(P),n(a));const W=te.state.history;if(W.length===0)return;const R=n(H)==="singing"?n(S):n(E);if(!R)return;const q=w(),Y=q?performance.now():0,ne=n(H)==="highway"&&n(E)?n(E).nowLineX:100,oe=gn({cellHeight:n(D).cellHeight,viewport:n(X),pixelsPerSecond:R.pixelsPerSecond??200,nowLineX:ne,currentTimeMs:n(H)==="highway"&&n(E)?n(E).currentTimeMs:0}),ce={cellHeight:n(D).cellHeight,viewportWidth:n(P),nowLineX:ne,pixelsPerSecond:R.pixelsPerSecond??200,timeWindowMs:R.timeWindowMs??4e3,colorMode:"color",trailConfig:n(Z)},ge=performance.now();if(wn(n(r),oe,W,ge,ce,n(I)),q){const me=performance.now();if(u+=1,f+=me-Y,me-c>=1e3){const Ce=u>0?f/u:0;console.log(`[SingingTrail] points=${W.length} avgMs=${Ce.toFixed(2)} gridWidth=${n(P)}`),c=me,u=0,f=0}}}function se(){if(n(l))return;const W=()=>{ee(),F(l,requestAnimationFrame(W),!0)};F(l,requestAnimationFrame(W),!0)}function ue(){n(l)&&(cancelAnimationFrame(n(l)),F(l,null)),n(r)&&n(P)>0&&n(r).clearRect(0,0,n(P),n(a))}Ie(()=>{if(!n(i))return;const W=new ResizeObserver(R=>{for(const q of R)F(s,q.contentRect.width,!0),F(a,q.contentRect.height,!0)});return W.observe(n(i)),()=>{W.disconnect()}}),Ie(()=>{n(P),n(a),n(_),n(o),k()}),Ie(()=>{n(H),n(r),n(H)==="singing"||n(H)==="highway"?se():ue()}),it(()=>{ue()});var le=Ts(),de=C(le);ji(de,{get mode(){return n(H)},get fullRowData(){return n(I)},get viewport(){return n(X)},cellWidth:h,get cellHeight(){return n(D).cellHeight},colorMode:"color",showOctaveLabels:d,showFrequencyLabels:p,get showRightLegend(){return n(g)},get singingConfig(){return n(S)},get highwayConfig(){return n(E)},get legendHighlight(){return n(B)},get beatIntervalMs(){return n(N)},beatTimeOffsetMs:V});var fe=A(de,2);He(fe,W=>F(o,W),()=>n(o)),He(le,W=>F(i,W),()=>n(i)),U(e,le),Te()}class Ps{constructor(){Be(this,"synth",null),Be(this,"scheduledTimeouts",[]),Be(this,"volume",null),Be(this,"startTime",0),Be(this,"_isPlaying",!1)}get isPlaying(){return this._isPlaying}async init(){await Pt(),this.volume=new on(-12).toDestination(),this.synth=new rn({oscillator:{type:"triangle"},envelope:{attack:.05,decay:.1,sustain:.9,release:.1}}).connect(this.volume)}setVolume(t){this.volume&&(this.volume.volume.value=t)}scheduleReferenceTones(t){if(!this.synth){console.warn("[ReferenceAudio] Synth not initialized");return}this.clearScheduled(),this.startTime=performance.now(),t.forEach(i=>{const s=i.durationMs/1e3,a=kt(i.midi,"midi").toFrequency(),o=window.setTimeout(()=>{this.synth&&(console.log(`[ReferenceAudio] Playing ${i.midi} at ${performance.now()-this.startTime}ms`),this._isPlaying=!0,this.synth.triggerAttackRelease(a,s))},i.startTimeMs),r=window.setTimeout(()=>{this._isPlaying=!1},i.startTimeMs+i.durationMs);this.scheduledTimeouts.push(o,r)}),console.log(`[ReferenceAudio] Scheduled ${t.length} reference tones`)}playTone(t,i){if(!this.synth){console.warn("[ReferenceAudio] Synth not initialized");return}const s=kt(t,"midi").toFrequency(),a=i/1e3;this.synth.triggerAttackRelease(s,a)}clearScheduled(){this.scheduledTimeouts.forEach(t=>{window.clearTimeout(t)}),this.scheduledTimeouts=[]}stop(){this.clearScheduled(),this.synth&&this.synth.triggerRelease()}dispose(){this.stop(),this.synth&&(this.synth.dispose(),this.synth=null),this.volume&&(this.volume.dispose(),this.volume=null)}}const qe=new Ps,Ne={FFT_SIZE:2048,CLARITY_THRESHOLD:.8,MIN_PITCH_HZ:60,MAX_PITCH_HZ:1600,HIGHLIGHT_CENTS_RANGE:50};let Fe=null,We=null,tt=null,De=null,nt=!1;const _t=1;function Ss(e){return 12*Math.log2(e/440)+69}function Tt(){if(!nt||!We||!tt){De=null;return}if(qe.isPlaying){te.addHistoryPoint({frequency:0,midi:0,time:performance.now(),clarity:0}),De=requestAnimationFrame(Tt);return}const e=We.getValue(),[t,i]=tt.findPitch(e,Nn().sampleRate),s=t!==null&&i>Ne.CLARITY_THRESHOLD&&t>Ne.MIN_PITCH_HZ&&t<Ne.MAX_PITCH_HZ;if(s){const a=Ss(t),o={frequency:t,midi:a,clarity:i,pitchClass:Math.round(a)%12};te.setCurrentPitch(o),te.addHistoryPoint({frequency:t,midi:a,time:performance.now(),clarity:i}),be.recordPitchInput(a,i)}else te.addHistoryPoint({frequency:0,midi:0,time:performance.now(),clarity:0});if(s&&te.state.currentPitch){const a=te.state.currentPitch.midi,o=ss(a),r=is(a),l=Math.min(Math.abs(r),Ne.HIGHLIGHT_CENTS_RANGE),c=Math.max(0,1-l/Ne.HIGHLIGHT_CENTS_RANGE);te.setStablePitch({pitchClass:os(o),opacity:c,size:_t})}else te.setStablePitch({pitchClass:null,opacity:0,size:_t});De=requestAnimationFrame(Tt)}async function Is(){if(!nt){De!==null&&cancelAnimationFrame(De),Fe=new ze,We=new xn("waveform",Ne.FFT_SIZE),tt=Ve.forFloat32Array(We.size);try{await Pt(),await Fe.open(),Fe.connect(We),nt=!0,Tt()}catch(e){throw console.error("Microphone access denied or failed:",e),_n(),e}}}function As(){nt=!1,_n()}function _n(){De!==null&&(cancelAnimationFrame(De),De=null),Fe&&(Fe.close(),Fe=null),We=null,tt=null,te.setStablePitch({pitchClass:null,opacity:0,size:_t}),te.setCurrentPitch(null)}Ae(["click"]);let Me=null,Ye=!1,Ue=null;function Rs(){var e;if(!Me){Me=new kn(rn,{oscillator:{type:"sawtooth"},envelope:{attack:.3,decay:.1,sustain:.8,release:.5}}).toDestination();const t=((e=Me.get().oscillator)==null?void 0:e.type)??"unknown";console.log("[DroneAudio] Initialized drone synth",{oscillatorType:t})}return Me}function Tn(e,t){return`${e.replace("b","#").replace("Db","C#").replace("Eb","D#").replace("Gb","F#").replace("Ab","G#").replace("Bb","A#")}${t}`}async function Hs(){await Pt();const e=Rs(),t=Tn(z.state.tonic,z.state.drone.octave);e.volume.value=z.state.drone.volume,console.log("[DroneAudio] Starting drone",{note:t,volume:e.volume.value}),Ue&&e.releaseAll(),Ue=t,e.triggerAttack(t),Ye=!0}function Ds(){Me&&Ye&&(Me.releaseAll(),Ue=null,Ye=!1)}function Ct(){if(!Ye||!Me)return;const e=Tn(z.state.tonic,z.state.drone.octave);Me.volume.value=z.state.drone.volume,console.log("[DroneAudio] Updating drone",{note:e,volume:Me.volume.value}),e!==Ue&&(Me.releaseAll(),Me.triggerAttack(e),Ue=e)}async function xs(){Ye?Ds():await Hs()}var Ns=j("<option> </option>"),Fs=j('<div class="tonic-selector svelte-16h7our"><label for="tonic-select" class="svelte-16h7our">Key:</label> <select id="tonic-select" class="svelte-16h7our"></select></div>');function Ws(e,t){_e(t,!0);const i=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function s(l){const c=l.target;z.setTonic(c.value),Ct()}var a=Fs(),o=A(C(a),2);o.__change=s,ot(o,21,()=>i,At,(l,c)=>{var u=Ns(),f=C(u),h={};he(()=>{K(f,n(c)),h!==(h=n(c))&&(u.value=(u.__value=n(c))??"")}),U(l,u)});var r;dn(o),he(()=>{r!==(r=z.state.tonic)&&(o.value=(o.__value=z.state.tonic)??"",Rt(o,z.state.tonic))}),U(e,a),Te()}Ae(["change"]);var ks=j("<option> </option>"),Ls=j('<div class="drone-controls svelte-1rkr6nv"><button> </button> <div class="drone-settings svelte-1rkr6nv"><label class="svelte-1rkr6nv">Oct: <select class="svelte-1rkr6nv"></select></label> <label class="svelte-1rkr6nv">Vol: <input type="range" min="-40" max="0" class="svelte-1rkr6nv"/></label></div></div>');function Es(e,t){_e(t,!0);const i=[2,3,4,5];async function s(){await xs(),z.toggleDrone()}function a(v){const y=v.target;z.setDroneOctave(parseInt(y.value,10)),Ct()}function o(v){const y=v.target;z.setDroneVolume(parseInt(y.value,10)),Ct()}var r=Ls(),l=C(r);let c;l.__click=s;var u=C(l),f=A(l,2),h=C(f),d=A(C(h));d.__change=a,ot(d,21,()=>i,At,(v,y)=>{var T=ks(),b=C(T),P={};he(()=>{K(b,n(y)),P!==(P=n(y))&&(T.value=(T.__value=n(y))??"")}),U(v,T)});var p;dn(d);var g=A(h,2),m=A(C(g));m.__input=o,he(()=>{c=st(l,1,"drone-toggle svelte-1rkr6nv",null,c,{active:z.state.drone.isPlaying}),K(u,z.state.drone.isPlaying?"Drone On":"Drone Off"),p!==(p=z.state.drone.octave)&&(d.value=(d.__value=z.state.drone.octave)??"",Rt(d,z.state.drone.octave)),li(m,z.state.drone.volume)}),U(e,r),Te()}Ae(["click","change","input"]);Ae(["click"]);var Os=j('<div class="range-control svelte-1es7ond"><h3 class="control-title svelte-1es7ond">Pitch Range</h3> <!></div>');function Bs(e,t){_e(t,!0);function i(c){const u=Et.findIndex(f=>f.midi===c);return u>=0?u:0}const s=x(()=>i(z.state.yAxisRange.maxMidi)),a=x(()=>i(z.state.yAxisRange.minMidi));function o(c){const u=c.bottomPitch.midi??21,f=c.topPitch.midi??108;z.setYAxisRange({minMidi:u,maxMidi:f})}var r=Os(),l=A(C(r),2);fs(l,{get fullRowData(){return Et},get topIndex(){return n(s)},get bottomIndex(){return n(a)},minSpan:7,onrangechange:o,showSummary:!0,wheelHeight:200}),U(e,r),Te()}var qs=j('<div class="pitch-highlight-toggle svelte-e7pwl1"><span class="toggle-label svelte-e7pwl1">Pitch Highlight</span> <button> </button></div>');function zs(e,t){_e(t,!0);function i(){z.togglePitchHighlight()}var s=qs(),a=A(C(s),2);let o;a.__click=i;var r=C(a);he(()=>{o=st(a,1,"toggle-button svelte-e7pwl1",null,o,{active:z.state.pitchHighlightEnabled}),K(r,z.state.pitchHighlightEnabled?"On":"Off")}),U(e,s),Te()}Ae(["click"]);var Xs=j('<button class="start-exercise-btn svelte-118f0cc">Start Demo Exercise</button>'),Gs=j('<button class="stop-exercise-btn svelte-118f0cc">Stop Exercise</button> <div class="progress-indicator svelte-118f0cc"> </div> <div class="phase-indicator svelte-118f0cc"> </div>',1),Vs=j('<div><span class="result-loop svelte-118f0cc"></span> <span class="result-pitch svelte-118f0cc"> </span> <span class="result-accuracy svelte-118f0cc"> </span> <span class="result-status svelte-118f0cc"> </span></div>'),Ys=j('<div class="exercise-results svelte-118f0cc"><h4 class="results-title svelte-118f0cc">Results</h4> <div class="results-summary svelte-118f0cc"><div class="stat svelte-118f0cc"><span class="stat-label svelte-118f0cc">Average Accuracy:</span> <span class="stat-value svelte-118f0cc"> </span></div> <div class="stat svelte-118f0cc"><span class="stat-label svelte-118f0cc">Hits:</span> <span class="stat-value svelte-118f0cc"> </span></div></div> <details class="results-details svelte-118f0cc"><summary class="results-summary-label svelte-118f0cc">Detailed Results</summary> <div class="results-list svelte-118f0cc"></div></details></div>'),Us=j('<div class="demo-exercise-panel svelte-118f0cc"><h3 class="panel-title svelte-118f0cc">Demo Exercise</h3> <details class="settings-details svelte-118f0cc"><summary class="settings-summary svelte-118f0cc">Settings</summary> <div class="exercise-settings svelte-118f0cc"><label class="setting-label svelte-118f0cc"><span class="label-text svelte-118f0cc">Number of loops:</span> <input class="setting-input svelte-118f0cc" type="number" min="1" max="20"/></label> <label class="setting-label svelte-118f0cc"><span class="label-text svelte-118f0cc">Tempo (BPM):</span> <input class="setting-input svelte-118f0cc" type="number" min="60" max="180"/></label> <label class="setting-label svelte-118f0cc"><span class="label-text svelte-118f0cc">Reference Volume:</span> <input class="setting-slider svelte-118f0cc" type="range" min="-40" max="0"/> <span class="volume-value svelte-118f0cc"> </span></label> <div class="pitch-range-buttons svelte-118f0cc"><button class="range-btn svelte-118f0cc">Use Current Range</button> <button class="range-btn svelte-118f0cc">Use Full Range</button></div></div></details> <div class="exercise-controls svelte-118f0cc"><!></div> <!></div>');function js(e,t){_e(t,!0);let i=G(!1),s=G(5),a=G(108),o=G(-12);const r=x(()=>re.state.isActive),l=x(()=>re.state.isPlaying),c=x(()=>re.state.currentPhase),u=x(()=>re.getCurrentProgress()),f=x(()=>re.getResults()),h=x(()=>n(f).length>0),d=x(()=>re.getAverageAccuracy()),p=x(()=>re.getHitCount()),g=x(()=>n(f).length);Ie(()=>{if(!n(r)||!n(l))return;const R=be.state.currentTimeMs;re.updatePhase(R)}),Ie(()=>{if(!n(r))return;const R=be.getPerformanceResults();re.getGeneratedNotes().forEach((q,Y)=>{if(q.lyric!=="🎤")return;const ne=`target-${Y}`,oe=R.get(ne);if(oe&&!re.hasResultForLoop(Math.floor(Y/2))){const ce=m(oe);re.addResult({loopIndex:Math.floor(Y/2),targetPitch:q.midi,accuracy:ce,performance:oe})}})});function m(R){return R.hitStatus==="hit"?R.pitchAccuracyCents!==void 0?Math.max(0,100-Math.abs(R.pitchAccuracyCents)/50*100):100:0}it(()=>{n(r)&&b()});function v(){const R=z.state.yAxisRange;re.setPitchRange(R.minMidi,R.maxMidi)}function y(){re.setPitchRange(21,108)}async function T(){z.setVisualizationMode("highway"),re.configure({numLoops:n(s),tempo:n(a),referenceVolume:n(o)}),v(),await qe.init(),qe.setVolume(n(o)),re.start();const R=re.getGeneratedNotes();be.setTargetNotes(R),be.start(),re.setPlaying(!0);const q=R.filter(Y=>Y.lyric==="👂");qe.scheduleReferenceTones(q)}function b(){qe.stop(),be.stop(),re.stop()}function P(R){switch(R){case"reference":return"👂 Listen";case"input":return"🎤 Sing";default:return"Rest"}}function _(R){const q=Ln(R);return q?.combined||`MIDI ${R}`}var w=Us(),I=A(C(w),2),D=A(C(I),2),H=C(D),N=A(C(H),2),V=A(H,2),B=A(C(V),2),$=A(V,2),Z=A(C($),2),S=A(Z,2),E=C(S),X=A($,2),k=C(X);k.__click=v;var ee=A(k,2);ee.__click=y;var se=A(I,2),ue=C(se);{var le=R=>{var q=Xs();q.__click=T,U(R,q)},de=R=>{var q=Gs(),Y=un(q);Y.__click=b;var ne=A(Y,2),oe=C(ne),ce=A(ne,2),ge=C(ce);he(me=>{K(oe,`Loop ${n(u).current??""} / ${n(u).total??""}`),K(ge,me)},[()=>P(n(c))]),U(R,q)};Pe(ue,R=>{n(r)?R(de,!1):R(le)})}var fe=A(se,2);{var W=R=>{var q=Ys(),Y=A(C(q),2),ne=C(Y),oe=A(C(ne),2),ce=C(oe),ge=A(ne,2),me=A(C(ge),2),Ce=C(me),M=A(Y,2),L=A(C(M),2);ot(L,21,()=>n(f),At,(O,ie,ve)=>{var pe=Vs();let Q;var we=C(pe);we.textContent=`Loop ${ve+1}:`;var J=A(we,2),Re=C(J),Se=A(J,2),xe=C(Se),at=A(Se,2),rt=C(at);he((lt,ct)=>{var je,Je;Q=st(pe,1,"result-item svelte-118f0cc",null,Q,{hit:((je=n(ie).performance)==null?void 0:je.hitStatus)==="hit"}),K(Re,lt),K(xe,`${ct??""}%`),K(rt,((Je=n(ie).performance)==null?void 0:Je.hitStatus)==="hit"?"✓":"✗")},[()=>_(n(ie).targetPitch),()=>n(ie).accuracy.toFixed(0)]),U(O,pe)}),he(O=>{K(ce,`${O??""}%`),K(Ce,`${n(p)??""}/${n(g)??""}`)},[()=>n(d).toFixed(1)]),U(R,q)};Pe(fe,R=>{n(h)&&!n(r)&&R(W)})}he(()=>{N.disabled=n(r),B.disabled=n(r),Z.disabled=n(r),K(E,`${n(o)??""} dB`),k.disabled=n(r),ee.disabled=n(r)}),ft(N,()=>n(s),R=>F(s,R)),ft(B,()=>n(a),R=>F(a,R)),ft(Z,()=>n(o),R=>F(o,R)),hn("open","toggle",I,R=>F(i,R),()=>n(i)),U(e,w),Te()}Ae(["click"]);var Js=j('<div class="note-display svelte-1hjl33a"><span class="note-name svelte-1hjl33a"> </span> <span class="octave svelte-1hjl33a"> </span></div> <div class="details svelte-1hjl33a"><span class="frequency"> </span> <span> </span> <span class="clarity"> </span></div>',1),Ks=j('<div class="no-pitch svelte-1hjl33a"><span class="placeholder svelte-1hjl33a">---</span> <span class="hint svelte-1hjl33a">Sing or hum into the microphone</span></div>'),Zs=j('<div class="pitch-readout svelte-1hjl33a"><!></div>');function Qs(e,t){_e(t,!0);const i=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],s=x(()=>()=>{const c=te.state.currentPitch;if(!c)return null;const u=i[c.pitchClass],f=Math.floor(c.midi/12)-1,h=Math.round((c.midi-Math.round(c.midi))*100);return{name:u,octave:f,frequency:c.frequency.toFixed(1),cents:h,clarity:Math.round(c.clarity*100)}});var a=Zs(),o=C(a);{var r=c=>{const u=x(()=>n(s)());var f=Js(),h=un(f),d=C(h),p=C(d),g=A(d,2),m=C(g),v=A(h,2),y=C(v),T=C(y),b=A(y,2);let P;var _=C(b),w=A(b,2),I=C(w);he(()=>{K(p,n(u).name),K(m,n(u).octave),K(T,`${n(u).frequency??""} Hz`),P=st(b,1,"cents svelte-1hjl33a",null,P,{sharp:n(u).cents>0,flat:n(u).cents<0}),K(_,`${n(u).cents>0?"+":""}${n(u).cents??""}¢`),K(I,`${n(u).clarity??""}%`)}),U(c,f)},l=c=>{var u=Ks();U(c,u)};Pe(o,c=>{n(s)()?c(r):c(l,!1)})}U(e,a),Te()}const bt={hasImportedSnapshot:!1,snapshot:null,isLoading:!1,error:null,transpositionSemitones:0};function $s(){let e=G(ke({...bt}));return{get state(){return n(e)},async checkAndConsumeHandoff(){if(!Hn())return!1;n(e).isLoading=!0,n(e).error=null;try{const t=await Dn();return t?t.schemaVersion!==Lt?(n(e).error=`Incompatible snapshot version: ${t.schemaVersion}. Expected: ${Lt}`,n(e).isLoading=!1,Ke(),!1):(n(e).snapshot=t,n(e).hasImportedSnapshot=!0,n(e).isLoading=!1,Ke(),console.log("[HandoffState] Successfully imported snapshot",{voices:t.voices.length,microbeatCount:t.timeGrid.microbeatCount,tempo:t.tempo}),!0):(n(e).error="Handoff data expired or not found. Please try exporting again.",n(e).isLoading=!1,Ke(),!1)}catch(t){return console.error("[HandoffState] Failed to process handoff",t),n(e).error="Failed to import data from Student Notation.",n(e).isLoading=!1,Ke(),!1}},get voices(){var t;return((t=n(e).snapshot)==null?void 0:t.voices)??[]},get timeGrid(){var t;return((t=n(e).snapshot)==null?void 0:t.timeGrid)??null},get tempo(){var t;return((t=n(e).snapshot)==null?void 0:t.tempo)??90},get suggestedPitchRange(){if(!n(e).snapshot)return null;const t=3,i=n(e).snapshot.minMidiPitch,s=n(e).snapshot.maxMidiPitch;return i===void 0||s===void 0?null:{minMidi:Math.max(21,i-t+n(e).transpositionSemitones),maxMidi:Math.min(108,s+t+n(e).transpositionSemitones)}},setTransposition(t){n(e).transpositionSemitones=t},transposeUp(){n(e).transpositionSemitones+=1},transposeDown(){n(e).transpositionSemitones-=1},getTransposedMidi(t){return t+n(e).transpositionSemitones},async bringBackToStudentNotation(){if(!n(e).snapshot){console.warn("[HandoffState] No snapshot to bring back");return}const t={...n(e).snapshot,sourceApp:"singing-trainer",createdAt:Date.now(),voices:n(e).snapshot.voices.map(i=>({...i,notes:i.notes.map(s=>({...s,midiPitch:s.midiPitch+n(e).transpositionSemitones}))}))};try{const i=await An(t);console.log("[HandoffState] Handoff slot written for return",i),Rn(i)}catch(i){console.error("[HandoffState] Failed to write return handoff",i)}},clearSnapshot(){F(e,{...bt},!0)},reset(){F(e,{...bt},!0)}}}const ye=$s();var eo=j('<div class="handoff-controls svelte-1n46o8q"><div class="transposition-control svelte-1n46o8q"><button class="transpose-btn svelte-1n46o8q" title="Transpose down">-</button> <span class="transposition-label svelte-1n46o8q"> </span> <button class="transpose-btn svelte-1n46o8q" title="Transpose up">+</button></div> <button class="bring-back-btn svelte-1n46o8q">Bring Back to Student Notation</button></div>'),to=j('<div class="error-banner svelte-1n46o8q"> </div>'),no=j('<div class="import-info svelte-1n46o8q"><span class="import-label svelte-1n46o8q">Microbeats:</span> <span class="import-value svelte-1n46o8q"> </span></div>'),io=j('<div class="control-group svelte-1n46o8q"><h3 class="control-group-title svelte-1n46o8q">Imported Material</h3> <div class="import-info svelte-1n46o8q"><span class="import-label svelte-1n46o8q">Voices:</span> <span class="import-value svelte-1n46o8q"> </span></div> <div class="import-info svelte-1n46o8q"><span class="import-label svelte-1n46o8q">Tempo:</span> <span class="import-value svelte-1n46o8q"> </span></div> <!></div>'),so=j('<div class="app svelte-1n46o8q"><header class="header svelte-1n46o8q"><h1 class="title svelte-1n46o8q">Singing Trainer</h1> <div class="header-controls svelte-1n46o8q"><!></div></header> <!> <main class="main svelte-1n46o8q"><aside class="sidebar sidebar--left svelte-1n46o8q"><div class="control-group svelte-1n46o8q"><!></div> <div class="control-group svelte-1n46o8q"><!></div> <div class="control-group svelte-1n46o8q"><details class="settings-details svelte-1n46o8q"><summary class="settings-summary svelte-1n46o8q">Settings</summary> <div class="settings-content svelte-1n46o8q"><!> <!> <!></div></details></div> <div class="control-group svelte-1n46o8q"><!></div> <!></aside> <section class="canvas-area svelte-1n46o8q"><!></section></main></div>');function oo(e,t){_e(t,!0);let i=G(!1);an(async()=>{if(await ye.checkAndConsumeHandoff()){console.log("[App] Handoff detected and processed");const k=ye.suggestedPitchRange;k&&z.setYAxisRange(k)}try{await Is(),z.setDetecting(!0),console.log("[App] Pitch detection auto-started")}catch(k){console.error("[App] Failed to auto-start pitch detection:",k)}}),it(()=>{As()});const s=x(()=>ye.state.hasImportedSnapshot),a=x(()=>ye.state.transpositionSemitones),o=x(()=>ye.state.error);function r(){ye.bringBackToStudentNotation()}function l(){ye.transposeUp()}function c(){ye.transposeDown()}var u=so(),f=C(u),h=A(C(f),2),d=C(h);{var p=k=>{var ee=eo(),se=C(ee),ue=C(se);ue.__click=c;var le=A(ue,2),de=C(le),fe=A(le,2);fe.__click=l;var W=A(se,2);W.__click=r,he(()=>K(de,`${n(a)>=0?"+":""}${n(a)??""}`)),U(k,ee)};Pe(d,k=>{n(s)&&k(p)})}var g=A(f,2);{var m=k=>{var ee=to(),se=C(ee);he(()=>K(se,n(o))),U(k,ee)};Pe(g,k=>{n(o)&&k(m)})}var v=A(g,2),y=C(v),T=C(y),b=C(T);Qs(b,{});var P=A(T,2),_=C(P);js(_,{});var w=A(P,2),I=C(w),D=A(C(I),2),H=C(D);Ws(H,{});var N=A(H,2);Es(N,{});var V=A(N,2);zs(V,{});var B=A(w,2),$=C(B);Bs($,{});var Z=A(B,2);{var S=k=>{var ee=io(),se=A(C(ee),2),ue=A(C(se),2),le=C(ue),de=A(se,2),fe=A(C(de),2),W=C(fe),R=A(de,2);{var q=Y=>{var ne=no(),oe=A(C(ne),2),ce=C(oe);he(()=>K(ce,ye.timeGrid.microbeatCount)),U(Y,ne)};Pe(R,Y=>{ye.timeGrid&&Y(q)})}he(()=>{K(le,ye.voices.length),K(W,`${ye.tempo??""} BPM`)}),U(k,ee)};Pe(Z,k=>{n(s)&&k(S)})}var E=A(y,2),X=C(E);Cs(X,{}),hn("open","toggle",I,k=>F(i,k),()=>n(i)),U(e,u),Te()}Ae(["click"]);function ao(e){const t=ai(oo,{target:e});return{destroy:()=>ri(t)}}const ro=ao,sn=document.getElementById("app");sn&&ro(sn);
