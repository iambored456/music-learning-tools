import{T as lt,o as xt,V as Dt,r as zt,_ as mt,h as vt,j as Rt,E as ct,b as Mt}from"./index-Dhemq2HR.js";class k extends lt{constructor(){const r=xt(k.getDefaults(),arguments,["volume"]);super(r),this.name="UserMedia",this._volume=this.output=new Dt({context:this.context,volume:r.volume}),this.volume=this._volume.volume,zt(this,"volume"),this.mute=r.mute}static getDefaults(){return Object.assign(lt.getDefaults(),{mute:!1,volume:0})}open(r){return mt(this,void 0,void 0,function*(){vt(k.supported,"UserMedia is not supported"),this.state==="started"&&this.close();const t=yield k.enumerateDevices();Rt(r)?this._device=t[r]:(this._device=t.find(s=>s.label===r||s.deviceId===r),!this._device&&t.length>0&&(this._device=t[0]),vt(ct(this._device),`No matching device ${r}`));const e={audio:{echoCancellation:!1,sampleRate:this.context.sampleRate,noiseSuppression:!1,mozNoiseSuppression:!1}};this._device&&(e.audio.deviceId=this._device.deviceId);const n=yield navigator.mediaDevices.getUserMedia(e);if(!this._stream){this._stream=n;const s=this.context.createMediaStreamSource(n);Mt(s,this.output),this._mediaStream=s}return this})}close(){return this._stream&&this._mediaStream&&(this._stream.getAudioTracks().forEach(r=>{r.stop()}),this._stream=void 0,this._mediaStream.disconnect(),this._mediaStream=void 0),this._device=void 0,this}static enumerateDevices(){return mt(this,void 0,void 0,function*(){return(yield navigator.mediaDevices.enumerateDevices()).filter(t=>t.kind==="audioinput")})}get state(){return this._stream&&this._stream.active?"started":"stopped"}get deviceId(){if(this._device)return this._device.deviceId}get groupId(){if(this._device)return this._device.groupId}get label(){if(this._device)return this._device.label}get mute(){return this._volume.mute}set mute(r){this._volume.mute=r}dispose(){return super.dispose(),this.close(),this._volume.dispose(),this.volume.dispose(),this}static get supported(){return ct(navigator.mediaDevices)&&ct(navigator.mediaDevices.getUserMedia)}}function St(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}var ht,_t;function Ct(){if(_t)return ht;_t=1;function o(r){if(this.size=r|0,this.size<=1||(this.size&this.size-1)!==0)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=r<<1;for(var t=new Array(this.size*2),e=0;e<t.length;e+=2){const l=Math.PI*e/this.size;t[e]=Math.cos(l),t[e+1]=-Math.sin(l)}this.table=t;for(var n=0,s=1;this.size>s;s<<=1)n++;this._width=n%2===0?n-1:n,this._bitrev=new Array(1<<this._width);for(var a=0;a<this._bitrev.length;a++){this._bitrev[a]=0;for(var i=0;i<this._width;i+=2){var c=this._width-i-2;this._bitrev[a]|=(a>>>i&3)<<c}}this._out=null,this._data=null,this._inv=0}return ht=o,o.prototype.fromComplexArray=function(t,e){for(var n=e||new Array(t.length>>>1),s=0;s<t.length;s+=2)n[s>>>1]=t[s];return n},o.prototype.createComplexArray=function(){const t=new Array(this._csize);for(var e=0;e<t.length;e++)t[e]=0;return t},o.prototype.toComplexArray=function(t,e){for(var n=e||this.createComplexArray(),s=0;s<n.length;s+=2)n[s]=t[s>>>1],n[s+1]=0;return n},o.prototype.completeSpectrum=function(t){for(var e=this._csize,n=e>>>1,s=2;s<n;s+=2)t[e-s]=t[s],t[e-s+1]=-t[s+1]},o.prototype.transform=function(t,e){if(t===e)throw new Error("Input and output buffers must be different");this._out=t,this._data=e,this._inv=0,this._transform4(),this._out=null,this._data=null},o.prototype.realTransform=function(t,e){if(t===e)throw new Error("Input and output buffers must be different");this._out=t,this._data=e,this._inv=0,this._realTransform4(),this._out=null,this._data=null},o.prototype.inverseTransform=function(t,e){if(t===e)throw new Error("Input and output buffers must be different");this._out=t,this._data=e,this._inv=1,this._transform4();for(var n=0;n<t.length;n++)t[n]/=this.size;this._out=null,this._data=null},o.prototype._transform4=function(){var t=this._out,e=this._csize,n=this._width,s=1<<n,a=e/s<<1,i,c,l=this._bitrev;if(a===4)for(i=0,c=0;i<e;i+=a,c++){const f=l[c];this._singleTransform2(i,f,s)}else for(i=0,c=0;i<e;i+=a,c++){const f=l[c];this._singleTransform4(i,f,s)}var h=this._inv?-1:1,u=this.table;for(s>>=2;s>=2;s>>=2){a=e/s<<1;var v=a>>>2;for(i=0;i<e;i+=a)for(var p=i+v,b=i,m=0;b<p;b+=2,m+=s){const f=b,_=f+v,d=_+v,g=d+v,w=t[f],A=t[f+1],F=t[_],y=t[_+1],T=t[d],B=t[d+1],I=t[g],x=t[g+1],D=w,z=A,R=u[m],M=h*u[m+1],S=F*R-y*M,C=F*M+y*R,P=u[2*m],U=h*u[2*m+1],K=T*P-B*U,j=T*U+B*P,G=u[3*m],H=h*u[3*m+1],J=I*G-x*H,Q=I*H+x*G,W=D+K,E=z+j,V=D-K,X=z-j,Y=S+J,N=C+Q,$=h*(S-J),Z=h*(C-Q),L=W+Y,tt=E+N,et=W-Y,rt=E-N,st=V+Z,nt=X-$,it=V-Z,ot=X+$;t[f]=L,t[f+1]=tt,t[_]=st,t[_+1]=nt,t[d]=et,t[d+1]=rt,t[g]=it,t[g+1]=ot}}},o.prototype._singleTransform2=function(t,e,n){const s=this._out,a=this._data,i=a[e],c=a[e+1],l=a[e+n],h=a[e+n+1],u=i+l,v=c+h,p=i-l,b=c-h;s[t]=u,s[t+1]=v,s[t+2]=p,s[t+3]=b},o.prototype._singleTransform4=function(t,e,n){const s=this._out,a=this._data,i=this._inv?-1:1,c=n*2,l=n*3,h=a[e],u=a[e+1],v=a[e+n],p=a[e+n+1],b=a[e+c],m=a[e+c+1],f=a[e+l],_=a[e+l+1],d=h+b,g=u+m,w=h-b,A=u-m,F=v+f,y=p+_,T=i*(v-f),B=i*(p-_),I=d+F,x=g+y,D=w+B,z=A-T,R=d-F,M=g-y,S=w-B,C=A+T;s[t]=I,s[t+1]=x,s[t+2]=D,s[t+3]=z,s[t+4]=R,s[t+5]=M,s[t+6]=S,s[t+7]=C},o.prototype._realTransform4=function(){var t=this._out,e=this._csize,n=this._width,s=1<<n,a=e/s<<1,i,c,l=this._bitrev;if(a===4)for(i=0,c=0;i<e;i+=a,c++){const at=l[c];this._singleRealTransform2(i,at>>>1,s>>>1)}else for(i=0,c=0;i<e;i+=a,c++){const at=l[c];this._singleRealTransform4(i,at>>>1,s>>>1)}var h=this._inv?-1:1,u=this.table;for(s>>=2;s>=2;s>>=2){a=e/s<<1;var v=a>>>1,p=v>>>1,b=p>>>1;for(i=0;i<e;i+=a)for(var m=0,f=0;m<=b;m+=2,f+=s){var _=i+m,d=_+p,g=d+p,w=g+p,A=t[_],F=t[_+1],y=t[d],T=t[d+1],B=t[g],I=t[g+1],x=t[w],D=t[w+1],z=A,R=F,M=u[f],S=h*u[f+1],C=y*M-T*S,P=y*S+T*M,U=u[2*f],K=h*u[2*f+1],j=B*U-I*K,G=B*K+I*U,H=u[3*f],J=h*u[3*f+1],Q=x*H-D*J,W=x*J+D*H,E=z+j,V=R+G,X=z-j,Y=R-G,N=C+Q,$=P+W,Z=h*(C-Q),L=h*(P-W),tt=E+N,et=V+$,rt=X+L,st=Y-Z;if(t[_]=tt,t[_+1]=et,t[d]=rt,t[d+1]=st,m===0){var nt=E-N,it=V-$;t[g]=nt,t[g+1]=it;continue}if(m!==b){var ot=X,dt=-Y,pt=E,gt=-V,bt=-h*L,yt=-h*Z,wt=-h*$,Ft=-h*N,At=ot+bt,Tt=dt+yt,Bt=pt+Ft,It=gt-wt,ut=i+p-m,ft=i+v-m;t[ut]=At,t[ut+1]=Tt,t[ft]=Bt,t[ft+1]=It}}}},o.prototype._singleRealTransform2=function(t,e,n){const s=this._out,a=this._data,i=a[e],c=a[e+n],l=i+c,h=i-c;s[t]=l,s[t+1]=0,s[t+2]=h,s[t+3]=0},o.prototype._singleRealTransform4=function(t,e,n){const s=this._out,a=this._data,i=this._inv?-1:1,c=n*2,l=n*3,h=a[e],u=a[e+n],v=a[e+c],p=a[e+l],b=h+v,m=h-v,f=u+p,_=i*(u-p),d=b+f,g=m,w=-_,A=b-f,F=m,y=_;s[t]=d,s[t+1]=0,s[t+2]=g,s[t+3]=w,s[t+4]=A,s[t+5]=0,s[t+6]=F,s[t+7]=y},ht}var Et=Ct();const Vt=St(Et);class q{_inputLength;_fft;_bufferSupplier;_paddedInputBuffer;_transformBuffer;_inverseBuffer;static forFloat32Array(r){return new q(r,t=>new Float32Array(t))}static forFloat64Array(r){return new q(r,t=>new Float64Array(t))}static forNumberArray(r){return new q(r,t=>Array(t))}constructor(r,t){if(r<1)throw new Error("Input length must be at least one");this._inputLength=r,this._fft=new Vt(Pt(2*r)),this._bufferSupplier=t,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}get inputLength(){return this._inputLength}autocorrelate(r,t=this._bufferSupplier(r.length)){if(r.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${r.length}`);for(let n=0;n<r.length;n++)this._paddedInputBuffer[n]=r[n];for(let n=r.length;n<this._paddedInputBuffer.length;n++)this._paddedInputBuffer[n]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const e=this._transformBuffer;for(let n=0;n<e.length;n+=2)e[n]=e[n]*e[n]+e[n+1]*e[n+1],e[n+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let n=0;n<r.length;n++)t[n]=this._inverseBuffer[2*n];return t}}function Nt(o){const r=[];let t=!1,e=-1/0,n=-1;for(let s=1;s<o.length-1;s++)o[s-1]<=0&&o[s]>0?(t=!0,n=s,e=o[s]):o[s-1]>0&&o[s]<=0?(t=!1,n!==-1&&r.push(n)):t&&o[s]>e&&(e=o[s],n=s);return r}function $t(o,r){const[t,e,n]=[o-1,o,o+1],[s,a,i]=[r[t],r[e],r[n]],c=s/2-a+i/2,l=-(s/2)*(e+n)+a*(t+n)-i/2*(t+e),h=s*e*n/2-a*t*n+i*t*e/2,u=-l/(2*c),v=c*u*u+l*u+h;return[u,v]}class O{_autocorrelator;_nsdfBuffer;_clarityThreshold=.9;_minVolumeAbsolute=0;_maxInputAmplitude=1;static forFloat32Array(r){return new O(r,t=>new Float32Array(t))}static forFloat64Array(r){return new O(r,t=>new Float64Array(t))}static forNumberArray(r){return new O(r,t=>Array(t))}constructor(r,t){this._autocorrelator=new q(r,t),this._nsdfBuffer=t(r)}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(r){if(!Number.isFinite(r)||r<=0||r>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=r}set minVolumeAbsolute(r){if(!Number.isFinite(r)||r<0||r>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=r}set minVolumeDecibels(r){if(!Number.isFinite(r)||r>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(r/10)}set maxInputAmplitude(r){if(!Number.isFinite(r)||r<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=r}findPitch(r,t){if(this._belowMinimumVolume(r))return[0,0];this._nsdf(r);const e=Nt(this._nsdfBuffer);if(e.length===0)return[0,0];const n=Math.max(...e.map(c=>this._nsdfBuffer[c])),s=e.find(c=>this._nsdfBuffer[c]>=this._clarityThreshold*n),[a,i]=$t(s,this._nsdfBuffer);return[t/a,Math.min(i,1)]}_belowMinimumVolume(r){if(this._minVolumeAbsolute===0)return!1;let t=0;for(let e=0;e<r.length;e++)t+=r[e]**2;return Math.sqrt(t/r.length)<this._minVolumeAbsolute}_nsdf(r){this._autocorrelator.autocorrelate(r,this._nsdfBuffer);let t=2*this._nsdfBuffer[0],e;for(e=0;e<this._nsdfBuffer.length&&t>0;e++)this._nsdfBuffer[e]=2*this._nsdfBuffer[e]/t,t-=r[e]**2+r[r.length-e-1]**2;for(;e<this._nsdfBuffer.length;e++)this._nsdfBuffer[e]=0}}function Pt(o){return o--,o|=o>>1,o|=o>>2,o|=o>>4,o|=o>>8,o|=o>>16,o++,o}export{O as P,k as U};
