import"./modulepreload-polyfill-B5Qt9EMX.js";import{T as zt,o as Fn,V as pn,r as En,a5 as Gt,h as Vt,j as Wn,a6 as bt,b as On,$ as yn,a0 as qe,a1 as le,z as kt,t as bn,a7 as Yt,a3 as Bn,a8 as qn,a9 as zn,aa as Gn,I as Xt,ab as at,k as Vn,a2 as tt,p as Ut,v as Yn,ac as Xn,ad as Un,C as jn,ae as Jn}from"./navigation-coB-it1T.js";import{q as wn,r as Zn,v as Qn,w as Kn,x as $n,y as ze,z as es,A as Lt,B as Ft,C as ts,D as ns,E as ss,S as Mn,F as is,G as as,P as os,g as n,H as rs,I as ls,k as ke,n as B,J as cs,K as us,L as ds,M as fs,N as hs,O as gs,Q as vs,R as ms,T as ps,p as Te,l as Ne,j as K,o as D,f as E,c as b,s as P,a as k,i as Pe,h as Se,t as ne,d as Ee,U as Ue,b as Y,m as ys,u as bs,V as ws,W as Ms,X as Ke,$ as _n,Y as _s}from"./disclose-version-BIqUv_GW.js";import{e as nt,s as lt,i as ht}from"./style-CtA89Tjh.js";function Et(e,t,s=!1){if(e.multiple){if(t==null)return;if(!Zn(t))return Qn();for(var i of e.options)i.selected=t.includes(jt(i));return}for(i of e.options){var o=jt(i);if(Kn(o,t)){i.selected=!0;return}}(!s||t!==void 0)&&(e.selectedIndex=-1)}function Tn(e){var t=new MutationObserver(()=>{Et(e,e.__value)});t.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),wn(()=>{t.disconnect()})}function jt(e){return"__value"in e?e.__value:e.value}function wt(e,t,s=t){var i=new WeakSet;$n(e,"input",async o=>{var a=o?e.defaultValue:e.value;if(a=Mt(e)?_t(a):a,s(a),ze!==null&&i.add(ze),await es(),a!==(a=t())){var r=e.selectionStart,c=e.selectionEnd,l=e.value.length;if(e.value=a??"",c!==null){var u=e.value.length;r===c&&c===l&&u>l?(e.selectionStart=u,e.selectionEnd=u):(e.selectionStart=r,e.selectionEnd=Math.min(c,u))}}}),Lt(t)==null&&e.value&&(s(Mt(e)?_t(e.value):e.value),ze!==null&&i.add(ze)),Ft(()=>{var o=t();if(e===document.activeElement){var a=ts??ze;if(i.has(a))return}Mt(e)&&o===_t(e.value)||e.type==="date"&&!o&&!e.value||o!==e.value&&(e.value=o??"")})}function Mt(e){var t=e.type;return t==="number"||t==="range"}function _t(e){return e===""?null:+e}function Jt(e,t){return e===t||e?.[Mn]===t}function xe(e={},t,s,i){return ns(()=>{var o,a;return Ft(()=>{o=a,a=[],Lt(()=>{e!==s(...a)&&(t(e,...a),o&&Jt(s(...o),e)&&t(null,...o))})}),()=>{ss(()=>{a&&Jt(s(...a),e)&&t(null,...a)})}}),e}function Pn(e,t,s,i,o){var a=()=>{i(s[e])};s.addEventListener(t,a),o?Ft(()=>{s[e]=o()}):a(),(s===document.body||s===window||s===document)&&wn(()=>{s.removeEventListener(t,a)})}let ot=!1;function Ts(e){var t=ot;try{return ot=!1,[e(),ot]}finally{ot=t}}function pe(e,t,s,i){var o=!hs||(s&gs)!==0,a=(s&fs)!==0,r=(s&ms)!==0,c=i,l=!0,u=()=>(l&&(l=!1,c=r?Lt(i):i),c),f;if(a){var h=Mn in e||ps in e;f=is(e,t)?.set??(h&&t in e?w=>e[t]=w:void 0)}var m,p=!1;a?[m,p]=Ts(()=>e[t]):m=e[t],m===void 0&&i!==void 0&&(m=u(),f&&(o&&as(),f(m)));var v;if(o?v=()=>{var w=e[t];return w===void 0?u():(l=!0,w)}:v=()=>{var w=e[t];return w!==void 0&&(c=void 0),w===void 0?c:w},o&&(s&os)===0)return v;if(f){var d=e.$$legacy;return(function(w,I){return arguments.length>0?((!o||!I||d||p)&&f(I?v():w),w):v()})}var g=!1,y=((s&vs)!==0?rs:ls)(()=>(g=!1,v()));a&&n(y);var _=us;return(function(w,I){if(arguments.length>0){const C=I?n(y):o&&a?ke(w):w;return B(y,C),g=!0,c!==void 0&&(c=C),w}return cs&&g||(_.f&ds)!==0?y.v:n(y)})}class je extends zt{constructor(){const t=Fn(je.getDefaults(),arguments,["volume"]);super(t),this.name="UserMedia",this._volume=this.output=new pn({context:this.context,volume:t.volume}),this.volume=this._volume.volume,En(this,"volume"),this.mute=t.mute}static getDefaults(){return Object.assign(zt.getDefaults(),{mute:!1,volume:0})}open(t){return Gt(this,void 0,void 0,function*(){Vt(je.supported,"UserMedia is not supported"),this.state==="started"&&this.close();const s=yield je.enumerateDevices();Wn(t)?this._device=s[t]:(this._device=s.find(a=>a.label===t||a.deviceId===t),!this._device&&s.length>0&&(this._device=s[0]),Vt(bt(this._device),`No matching device ${t}`));const i={audio:{echoCancellation:!1,sampleRate:this.context.sampleRate,noiseSuppression:!1,mozNoiseSuppression:!1}};this._device&&(i.audio.deviceId=this._device.deviceId);const o=yield navigator.mediaDevices.getUserMedia(i);if(!this._stream){this._stream=o;const a=this.context.createMediaStreamSource(o);On(a,this.output),this._mediaStream=a}return this})}close(){return this._stream&&this._mediaStream&&(this._stream.getAudioTracks().forEach(t=>{t.stop()}),this._stream=void 0,this._mediaStream.disconnect(),this._mediaStream=void 0),this._device=void 0,this}static enumerateDevices(){return Gt(this,void 0,void 0,function*(){return(yield navigator.mediaDevices.enumerateDevices()).filter(s=>s.kind==="audioinput")})}get state(){return this._stream&&this._stream.active?"started":"stopped"}get deviceId(){if(this._device)return this._device.deviceId}get groupId(){if(this._device)return this._device.groupId}get label(){if(this._device)return this._device.label}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}dispose(){return super.dispose(),this.close(),this._volume.dispose(),this.volume.dispose(),this}static get supported(){return bt(navigator.mediaDevices)&&bt(navigator.mediaDevices.getUserMedia)}}const Zt=["#ef8aab","#f48e7d","#e89955","#cdaa42","#a4ba57","#6ec482","#2dc8b1","#16c3da","#58b8f6","#8fa9ff","#ba9bf2","#db8fd4"];function Qt(e){const t=parseInt(e.slice(1),16);return[t>>16&255,t>>8&255,t&255]}function Ps(e,t,s){const i=Math.max(0,Math.min(1,s));return e.map((o,a)=>Math.round(o+i*(t[a]-o)))}function Cn(e,t=0){const s=Math.floor(e),i=e-s,o=(s%12-t+12)%12,a=(o+1)%12,r=Qt(Zt[o]),c=Qt(Zt[a]);return Ps(r,c,i)}const Cs={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11};function Ss(e){const t=e.replace(/\d+$/,"");return Cs[t]??0}const Tt={onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70,accuracyTiers:{perfect:{onsetMs:30,pitchCents:10,coverage:95},good:{onsetMs:75,pitchCents:25,coverage:85},okay:{onsetMs:150,pitchCents:50,coverage:70}}};function As(e={}){const t={...Tt,...e,accuracyTiers:e.accuracyTiers?{...Tt.accuracyTiers,...e.accuracyTiers}:Tt.accuracyTiers},s=new Map,i=new Map;function o(h,m){return(h-m)*100}function a(h,m){return Math.abs(o(h.midi,m))<=t.pitchToleranceCents}function r(h,m){return h.length===0?0:h.reduce((v,d)=>v+Math.abs(o(d.midi,m)),0)/h.length}function c(h,m,p,v){if(h.length===0)return 0;const d=h.filter(y=>a(y,m));if(d.length===0)return 0;let g=0;for(let y=0;y<d.length;y++){const _=d[y],w=d[y+1];if(w)g+=w.timeMs-_.timeMs;else{const I=p+v,C=Math.min(50,I-_.timeMs);g+=C}}return g/v*100}function l(h,m,p){const v=t.accuracyTiers;if(!v)return"okay";const d=Math.abs(h);return d<=v.perfect.onsetMs&&m<=v.perfect.pitchCents&&p>=v.perfect.coverage?"perfect":d<=v.good.onsetMs&&m<=v.good.pitchCents&&p>=v.good.coverage?"good":d<=v.okay.onsetMs&&m<=v.okay.pitchCents&&p>=v.okay.coverage?"okay":"miss"}function u(h){const{note:m,samples:p,onsetSample:v,releaseSample:d}=h;let g=0;v?g=v.timeMs-m.startTimeMs:g=t.onsetToleranceMs*2;let y=0;const _=m.startTimeMs+m.durationMs;d?y=d.timeMs-_:y=t.releaseToleranceMs*2;const w=r(p,m.midi),I=c(p,m.midi,m.startTimeMs,m.durationMs),C=Math.abs(g)<=t.onsetToleranceMs,M=Math.abs(y)<=t.releaseToleranceMs,S=I>=t.hitThreshold,H=C&&M&&S?"hit":"miss",R=l(g,w,I);return{hitStatus:H,onsetAccuracyMs:g,releaseAccuracyMs:y,pitchAccuracyCents:w,pitchCoverage:I,pitchSamples:[...p],accuracyTier:R}}return{startNote(h,m){s.set(h,{note:m,samples:[],onsetSample:null,releaseSample:null,startedAt:performance.now()})},recordPitchSample(h){for(const[m,p]of s){const{note:v}=p,d=v.startTimeMs+v.durationMs,g=t.onsetToleranceMs,y=t.releaseToleranceMs;h.timeMs>=v.startTimeMs-g&&h.timeMs<=d+y&&(p.samples.push(h),!p.onsetSample&&h.timeMs>=v.startTimeMs-g&&h.timeMs<=v.startTimeMs+g&&a(h,v.midi)&&(p.onsetSample=h),h.timeMs>=d-y&&h.timeMs<=d+y&&(p.releaseSample=h))}},endNote(h){const m=s.get(h);if(!m)return null;const p=u(m);return i.set(h,p),s.delete(h),p},getCurrentPerformance(h){const m=s.get(h);if(!m)return null;const{note:p,samples:v,onsetSample:d}=m;let g=0;d&&(g=d.timeMs-p.startTimeMs);const y=r(v,p.midi),_=c(v,p.midi,p.startTimeMs,p.durationMs);return{onsetAccuracyMs:g,pitchAccuracyCents:y,pitchCoverage:_,pitchSamples:[...v]}},getAllPerformances(){return new Map(i)},reset(){s.clear(),i.clear()},dispose(){s.clear(),i.clear()}}}const Kt={judgmentLinePosition:.12,pixelsPerSecond:200,lookAheadMs:3e3,scrollMode:"constant-speed",leadInBeats:4,playMetronomeDuringOnramp:!0,playTargetNotes:!0,playMetronome:!1,inputSources:["microphone"],feedbackConfig:{onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70}};function Is(e){const t={...Kt,...e,feedbackConfig:{...Kt.feedbackConfig,...e.feedbackConfig}},{stateCallbacks:s,eventCallbacks:i,visualCallbacks:o,logger:a}=t,r={isPlaying:!1,isPaused:!1,currentTimeMs:0,scrollOffset:0,onrampComplete:!1,targetNotes:[],activeNotes:new Set,startTime:null},c=As(t.feedbackConfig);let l=null;const u=new Set;function f(){const M=60/s.getTempo()*1e3;return t.leadInBeats*M}function h(){return s.getViewportWidth()*t.judgmentLinePosition}function m(C){const M=t.pixelsPerSecond/1e3,S=h(),H=f();return(C+H)*M-S}function p(C){const M=h(),S=s.getCellWidth(),H=C.startColumn*S-r.scrollOffset,R=C.endColumn*S-r.scrollOffset,J=t.feedbackConfig.onsetToleranceMs/1e3*t.pixelsPerSecond;return H<=M+J&&R>=M-J}function v(){const C=new Set;for(const M of r.targetNotes){const S=M.startTimeMs+M.durationMs,H=t.feedbackConfig.onsetToleranceMs;if(r.currentTimeMs>=M.startTimeMs-H&&r.currentTimeMs<=S+H)C.add(M.id),r.activeNotes.has(M.id)||(c.startNote(M.id,M),a?.debug("NoteHighway",`Note ${M.id} became active`,{note:M}));else if(r.activeNotes.has(M.id)){const R=c.endNote(M.id);if(R){M.performance=R;const x={noteId:M.id,note:M,performance:R};R.hitStatus==="hit"?(i.emit("noteHit",x),o?.onNoteHit?.(M.id,R.accuracyTier||"okay"),a?.info("NoteHighway",`Note hit: ${M.id}`,R)):(i.emit("noteMissed",x),o?.onNoteMiss?.(M.id),a?.info("NoteHighway",`Note missed: ${M.id}`,R))}}}r.activeNotes=C}function d(){for(const C of r.targetNotes){const M=p(C),S=u.has(C.id);M&&!S?(u.add(C.id),i.emit("noteEntered",{noteId:C.id,note:C})):!M&&S&&(u.delete(C.id),i.emit("noteExited",{noteId:C.id,note:C}))}}function g(){if(!r.onrampComplete)if(r.currentTimeMs>=0)r.onrampComplete=!0,i.emit("onrampComplete"),o?.clearOnrampCountdown?.(),a?.info("NoteHighway","Onramp complete",null);else{const M=60/s.getTempo()*1e3,S=Math.abs(r.currentTimeMs),H=Math.ceil(S/M);o?.updateOnrampCountdown?.(H)}}function y(){if(!r.isPlaying||r.isPaused||!r.startTime){l=null;return}const C=performance.now(),M=f();r.currentTimeMs=C-r.startTime-M,r.scrollOffset=m(r.currentTimeMs),g(),v(),d(),l=requestAnimationFrame(y)}function _(){l||(l=requestAnimationFrame(y))}function w(){l&&(cancelAnimationFrame(l),l=null)}return{init(C){r.targetNotes=C,a?.info("NoteHighway",`Initialized with ${C.length} notes`,null)},start(){r.isPlaying||(r.isPlaying=!0,r.isPaused=!1,r.currentTimeMs=-f(),r.scrollOffset=m(r.currentTimeMs),r.onrampComplete=!1,r.activeNotes.clear(),r.startTime=performance.now(),u.clear(),c.reset(),_(),i.emit("playbackStarted"),a?.info("NoteHighway","Playback started",{onrampDurationMs:f()}))},pause(){!r.isPlaying||r.isPaused||(r.isPaused=!0,w(),i.emit("playbackPaused"),a?.info("NoteHighway","Playback paused",{currentTimeMs:r.currentTimeMs}))},resume(){if(!r.isPlaying||!r.isPaused||!r.startTime)return;const C=performance.now()-(r.startTime+r.currentTimeMs+f());r.startTime+=C,r.isPaused=!1,_(),i.emit("playbackResumed"),a?.info("NoteHighway","Playback resumed",null)},stop(){if(!r.isPlaying)return;r.isPlaying=!1,r.isPaused=!1,r.currentTimeMs=0,r.scrollOffset=0,r.onrampComplete=!1,r.activeNotes.clear(),r.startTime=null,u.clear(),w(),o?.clearCanvas?.(),o?.clearOnrampCountdown?.(),i.emit("playbackStopped"),r.targetNotes.every(M=>M.performance!==void 0)&&i.emit("performanceComplete"),a?.info("NoteHighway","Playback stopped",null)},setScrollOffset(C){if(r.currentTimeMs=C,r.scrollOffset=m(C),r.isPlaying){const M=f();r.startTime=performance.now()-(C+M)}a?.debug("NoteHighway","Scroll offset set",{timeMs:C,scrollOffset:r.scrollOffset})},recordPitchInput(C,M,S){if(!r.isPlaying||r.isPaused||!t.inputSources.includes(S))return;const H={timeMs:r.currentTimeMs,midi:C,clarity:M,source:S};c.recordPitchSample(H)},getState(){return r},getVisibleNotes(){h();const C=s.getViewportWidth(),M=s.getCellWidth();return r.targetNotes.filter(S=>{const H=S.startColumn*M-r.scrollOffset;return S.endColumn*M-r.scrollOffset>=0&&H<=C})},getPerformanceResults(){return c.getAllPerformances()},getFeedbackCollector(){return c},dispose(){w(),c.dispose(),r.targetNotes=[],r.activeNotes.clear(),u.clear(),a?.info("NoteHighway","Service disposed",null)}}}function Rs(e){const{cellHeight:t,columnWidths:s,viewport:i}=e,o=t/2,a=Ns(s,e.cellWidth);return{getRowY(r){return(r-i.startRow+1)*o},getRowFromY(r){const c=r/o-1;return Math.round(c)+i.startRow},getColumnX(r){return r<0?0:r>=a.length?a[a.length-1]??0:a[r]??0},getColumnFromX(r){let c=0,l=a.length-1;for(;c<l;){const u=Math.floor((c+l)/2);(a[u]??0)<=r?c=u+1:l=u}return Math.max(0,c-1)}}}function Sn(e){const{cellHeight:t,viewport:s,pixelsPerSecond:i,nowLineX:o=100,currentTimeMs:a=0}=e,r=t/2;return{getRowY(c){return(c-s.startRow+1)*r},getRowFromY(c){const l=c/r-1;return Math.round(l)+s.startRow},getColumnX(c){return 0},getColumnFromX(c){return 0},getTimeX(c){const l=c-a;return o+l/1e3*i},getTimeFromX(c){const l=(c-o)/i*1e3;return a+l}}}function Ns(e,t){const s=[0];let i=0;for(let o=0;o<e.length;o++){const a=(e[o]??1)*t;i+=a,s.push(i)}return s}function Ds(e,t){const{startRow:s,endRow:i}=e,o=Math.max(0,t.length-1);return{startRow:s,endRow:i,paddedStartRow:Math.max(0,s-1),paddedEndRow:Math.min(o,i+1)}}function Pt(e,t,s,i){const o=i.getRowY(e),a=s;return o>=-a&&o<=t.containerHeight+a}function Hs(e){let t=(e||"").replace(/\d/g,"").trim();return t=t.replace(/b/g,"b-").replace(/#/g,"b_"),t}function xs(e){switch(e){case"C":return{lineWidth:3.33,dash:[],color:"#adb5bd"};case"E":return{lineWidth:1,dash:[5,5],color:"#adb5bd"};case"G":return{lineWidth:1,dash:[],color:"#dee2e6"};case"B":case"A":case"F":case"Eb/Db":case"Db/C#":return{lineWidth:1,dash:[],color:"#ced4da"};default:return{lineWidth:1,dash:[],color:"#ced4da"}}}const rt={stroke:"#c7cfd8",background:"rgba(207, 214, 222, 0.32)"};let Ge=null;function ks(){if(Ge)return Ge;if(typeof window>"u")return rt;try{const e=window.getComputedStyle(document.documentElement);Ge={stroke:e.getPropertyValue("--c-anacrusis-border").trim()||rt.stroke,background:e.getPropertyValue("--c-anacrusis-bg").trim()||rt.background}}catch{Ge=rt}return Ge}function Ls(e,t,s,i,o,a=0,r){const{fullRowData:c,viewportHeight:l,viewportWidth:u,cellHeight:f}=t,h=u,m=["B","A","F","E♭/D♯","D♭/C♯"];for(let p=i;p<=o;p++){const v=c[p];if(!v||v.isBoundary)continue;const d=s.getRowY(p);if(d<-10||d>l+10)continue;const g=Hs(v.pitch);if(m.includes(g))continue;const y=xs(g);g==="G"?(e.save(),e.fillStyle=y.color,e.fillRect(a,d-f/2,h-a,f),e.restore()):(e.beginPath(),e.moveTo(a,d),e.lineTo(h,d),e.lineWidth=y.lineWidth,e.strokeStyle=y.color,e.setLineDash(y.dash),e.stroke(),e.setLineDash([]))}}function Fs(e,t,s,i){const{columnWidths:o,viewportHeight:a,macrobeatBoundaryStyles:r,placedTonicSigns:c}=t,l=o.length;for(let u=0;u<=l;u++){const f=u===0||u===l,h=Ws(u,c),m=c.some(y=>u===y.columnIndex+2),p=i.includes(u);if(!Os(u,c))continue;let d=null;if(f||h||m)d={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(p){const y=i.indexOf(u),_=r[y]??"dashed";if(_==="anacrusis"){const{stroke:w}=ks();d={lineWidth:1,strokeStyle:w,dash:[4,4]}}else d={lineWidth:1,strokeStyle:"#adb5bd",dash:_==="solid"?[]:[5,5]}}if(!d)continue;const g=s.getColumnX(u);e.beginPath(),e.moveTo(g,0),e.lineTo(g,a),e.lineWidth=d.lineWidth,e.strokeStyle=d.strokeStyle,e.setLineDash(d.dash),e.stroke()}e.setLineDash([])}function Es(e,t,s){const{viewportHeight:i,beatIntervalMs:o,measureIntervalMs:a,visibleTimeRange:r,nowLineX:c,beatTimeOffsetMs:l=0}=t,u=r.startMs-l,f=r.endMs-l,h=Math.floor(u/o),m=Math.ceil(f/o);for(let p=h;p<=m;p++){const v=l+p*o,d=s.getTimeX?.(v);if(d===void 0)continue;const g=a?(v-l)%a===0:!1;e.beginPath(),e.moveTo(d,0),e.lineTo(d,i),e.lineWidth=g?2:1,e.strokeStyle=g?"#adb5bd":"#dee2e6",e.setLineDash(g?[]:[5,5]),e.stroke()}e.setLineDash([]),c!==void 0&&(e.beginPath(),e.moveTo(c,0),e.lineTo(c,i),e.lineWidth=3,e.strokeStyle="#00ff00",e.setLineDash([]),e.stroke())}function Ws(e,t){return t.some(s=>s.columnIndex===e)}function Os(e,t){return!t.some(s=>s.columnIndex+1===e)}const Bs=.7,qs=.9,zs=4,Gs=1,Vs=.15,Ys=.2,Xs=1,Wt=1.5;function Je(e,t){return Number.isFinite(e)&&e>0&&Number.isFinite(t)&&t>0}function An(e){if(!e||typeof e.startColumnIndex!="number"||typeof e.endColumnIndex!="number")return!1;const t=e.shape==="circle"?e.startColumnIndex+1:e.startColumnIndex;return e.endColumnIndex>t}function ct(e){const t=e?.split("-")[1];return Number.parseInt(t??"0",10)}function In(e,t,s){const i=s*.25,o=e.uuid;if(!o)return 0;const a=t.filter(l=>!l.isDrum&&l.row===e.row&&l.startColumnIndex===e.startColumnIndex&&l.uuid&&l.uuid!==o);if(a.length===0)return 0;const r=[e,...a];return r.sort((l,u)=>ct(l.uuid)-ct(u.uuid)),r.findIndex(l=>l.uuid===o)*i}function Us(e,t,s){const i=s/2*.12,o=e.uuid;if(!o)return 0;const a=t.filter(l=>!l.isDrum&&l.row===e.row&&l.startColumnIndex===e.startColumnIndex&&l.uuid&&l.uuid!==o&&An(l));if(a.length===0)return 0;const r=[e,...a];return r.sort((l,u)=>ct(l.uuid)-ct(u.uuid)),r.findIndex(l=>l.uuid===o)*i}function js(e){if(!e)return{multiplier:1,category:"natural"};const t=e.includes("♭"),s=e.includes("♯"),i=e.includes("/");return!t&&!s?{multiplier:1,category:"natural"}:i?{multiplier:.75,category:"both-accidentals"}:{multiplier:.88,category:"single-accidental"}}function Nt(e,t,s,i,o,a){const{multiplier:r,category:c}=js(t);let l;if(s==="circle"){const u=a*2*qs;switch(c){case"natural":l=u;break;case"single-accidental":l=u*.8;break;case"both-accidentals":l=u*.4;break;default:l=u*r}}else{const u=a*2*Bs;switch(c){case"natural":l=u*1.5;break;case"single-accidental":l=u*1.2;break;case"both-accidentals":l=u;break;default:l=u*r}}if(!(l<zs))if(e.fillStyle="#212529",e.font=`bold ${l}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle",s==="oval"&&c==="both-accidentals"&&t.includes("/")){const u=t.split("/"),f=l*1.1,h=f*(u.length-1),m=o-h/2;u.forEach((p,v)=>{const d=m+v*f,g=l*.08;e.fillText(p.trim(),i,d+g)})}else{const u=l*.08;e.fillText(t,i,o+u)}}function Js(e,t,s,i,o,a,r){e.save(),e.beginPath(),e.arc(s,o,a,Math.PI/2,-Math.PI/2,!1),e.lineTo(i,o-a),e.arc(i,o,a,-Math.PI/2,Math.PI/2,!1),e.lineTo(s,o+a),e.closePath(),e.strokeStyle=t.color,e.lineWidth=r,e.shadowColor=t.color,e.shadowBlur=Wt,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore()}function $t(e,t,s,i){const{config:o,coords:a,allNotes:r,getScaleDegreeLabel:c}=t,{cellWidth:l,cellHeight:u,columnWidths:f,degreeDisplayMode:h}=o,m=a.getRowY(i),p=a.getColumnX(s.startColumnIndex),d=(f[s.startColumnIndex]??1)*l;if(!Je(d,u))return;const g=In(s,r,l),y=Math.max(.5,d*.15),_=p+d/2+g,w=d/2-y/2,I=u/2-y/2;if(Je(w,I)&&(e.save(),e.beginPath(),e.ellipse(_,m,w,I,0,0,2*Math.PI),e.strokeStyle=s.color,e.lineWidth=y,e.shadowColor=s.color,e.shadowBlur=Wt,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore(),h!=="off"&&c)){const{label:C}=c(s);C&&Nt(e,C,"oval",_,m,w)}}function en(e,t,s,i){const{config:o,coords:a,allNotes:r,getScaleDegreeLabel:c}=t,{cellWidth:l,cellHeight:u,degreeDisplayMode:f,longNoteStyle:h}=o,m=a.getRowY(i),p=a.getColumnX(s.startColumnIndex),d=a.getColumnX(s.startColumnIndex+1)-p;if(!Je(d,u))return;const g=In(s,r,l),y=p+d+g,_=Math.max(Gs,d*Vs),w=u/2-_/2,I=An(s);if(I&&h==="style2"){const M=y,S=a.getColumnX(s.endColumnIndex);if(Je(S-M,w)&&(Js(e,s,M,S,m,w,_),f!=="off"&&c)){const{label:H}=c(s);if(H){const R=(M+S)/2;Nt(e,H,"circle",R,m,w)}}return}if(I){const M=a.getColumnX(s.endColumnIndex+1),S=Us(s,r,u),H=m+S;e.beginPath(),e.moveTo(y,H),e.lineTo(M,H),e.strokeStyle=s.color,e.lineWidth=Math.max(Xs,d*Ys),e.stroke()}const C=d-_/2;if(Je(C,w)&&(e.save(),e.beginPath(),e.ellipse(y,m,C,w,0,0,2*Math.PI),e.strokeStyle=s.color,e.lineWidth=_,e.shadowColor=s.color,e.shadowBlur=Wt,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore(),f!=="off"&&c)){const{label:M}=c(s);M&&Nt(e,M,"circle",y,m,C)}}function Zs(e,t,s){const{config:i,coords:o}=t,{cellWidth:a,cellHeight:r}=i,c=o.getRowY(s.globalRow??s.row),l=o.getColumnX(s.columnIndex),f=o.getColumnX(s.columnIndex+1)-l,h=f*2,m=l+h/2,p=Math.min(h,r)/2*.9;if(p<2||(e.beginPath(),e.arc(m,c,p,0,2*Math.PI),e.strokeStyle="#212529",e.lineWidth=Math.max(.5,f*.05),e.stroke(),s.tonicNumber==null))return;const v=s.tonicNumber.toString(),d=p*1.5;d<6||(e.fillStyle="#212529",e.font=`bold ${d}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(v,m,c))}const Qs={timeWindowMs:4e3,pixelsPerSecond:200,circleRadius:9.5,proximityThreshold:35,maxConnections:3,connectorLineWidth:2.5,connectorColor:"rgba(0,0,0,0.4)",useTonicRelativeColors:!0,tonicPitchClass:0,clarityThreshold:.5,maxOpacity:.9};function Rn(e){return{...Qs,...e}}function tn(e,t,s,i,o,a,r){const c=Rn(a.trailConfig);if(i<c.clarityThreshold||s<=0)return;const{cellHeight:l,colorMode:u}=a,f=Nn(t,s,l,r),h=l/2*.8,m=u==="bw"?[128,128,128]:Cn(s,c.tonicPitchClass);e.save(),e.beginPath(),e.arc(o,f,h+4,0,2*Math.PI),e.fillStyle=`rgba(${m[0]}, ${m[1]}, ${m[2]}, ${i*.3})`,e.fill(),e.beginPath(),e.arc(o,f,h,0,2*Math.PI),e.fillStyle=`rgba(${m[0]}, ${m[1]}, ${m[2]}, ${i})`,e.fill(),e.restore()}function Nn(e,t,s,i){if(i.length===0||!i[0])return 0;const o=Math.floor(t),a=t-o,l=(i[0].midi??108)-o;if(l<0||l>=i.length)return l<0?0:e.getRowY(i.length-1);const u=e.getRowY(l),f=s/2;return u-a*f}function Dn(e,t,s,i,o,a){const{viewportWidth:r,cellHeight:c,colorMode:l}=o,u=Rn(o.trailConfig),f=u.timeWindowMs,h=u.pixelsPerSecond,m=o.nowLineX??r,p=s.filter(v=>v.midi>0&&v.clarity>=u.clarityThreshold).map(v=>{const d=i-v.time;if(d>=f||d<0)return null;const g=m-d/1e3*h,y=Nn(t,v.midi,c,a),_=l==="bw"?[128,128,128]:Cn(v.midi,u.tonicPitchClass);return{x:g,y,clarity:v.clarity,color:_}}).filter(v=>v!==null&&v.x>=0);if(p.length!==0){e.save(),e.strokeStyle=u.connectorColor,e.lineWidth=u.connectorLineWidth,e.beginPath();for(let v=0;v<p.length;v++){let d=0;for(let g=v+1;g<p.length&&d<u.maxConnections;g++){const y=p[v].x-p[g].x,_=p[v].y-p[g].y;Math.sqrt(y*y+_*_)<=u.proximityThreshold&&(e.moveTo(p[v].x,p[v].y),e.lineTo(p[g].x,p[g].y),d++)}}e.stroke();for(const v of p){const d=Math.min(v.clarity*u.maxOpacity,1);e.fillStyle=`rgba(${v.color[0]}, ${v.color[1]}, ${v.color[2]}, ${d})`,e.beginPath(),e.arc(v.x,v.y,u.circleRadius,0,2*Math.PI),e.fill()}e.restore()}}function nn(e,t,s,i,o,a,r,c){const{cellHeight:l,nowLineX:u=100,pixelsPerSecond:f}=o,h=.5;for(const m of s){const p=(u??100)+(m.startTimeMs-i)/1e3*f,v=p+m.durationMs/1e3*f;if(v<0||p>o.viewportWidth)continue;let d;if(a){if(d=a.findIndex(M=>M.midi===m.midi),d===-1)continue}else d=Math.round(108-m.midi);const g=t.getRowY(d),y=l/2-2,_=m.color??"#4CAF50",w=p<=u&&v>=u,I=r!=null&&(c??0)>.5&&Math.abs(r-m.midi)<=h,C=w&&I;if(e.save(),e.beginPath(),e.arc(p,g,y,Math.PI/2,-Math.PI/2,!1),e.lineTo(v,g-y),e.arc(v,g,y,-Math.PI/2,Math.PI/2,!1),e.lineTo(p,g+y),e.closePath(),C?(e.strokeStyle="#FFD700",e.lineWidth=5,e.shadowColor="#FFD700",e.shadowBlur=20,e.stroke(),e.fillStyle="rgba(255, 215, 0, 0.3)",e.fill(),Ks(e,u,g,y)):(e.strokeStyle=_,e.lineWidth=3,e.shadowColor=_,e.shadowBlur=8,e.stroke()),e.shadowBlur=0,e.restore(),m.label){const M=p+y+4;e.fillStyle=C?"#FFD700":"#212529",e.font=`bold ${Math.max(16,y*1.2)}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="left",e.textBaseline="middle",e.fillText(m.label,M,g)}}}function Ks(e,t,s,i){const r=i*1.5;e.save(),e.fillStyle="#FFD700",e.shadowColor="#FFD700",e.shadowBlur=6;for(let c=0;c<8;c++){const l=c/8*Math.PI*2,u=t+Math.cos(l)*r,f=s+Math.sin(l)*r;e.beginPath(),e.arc(u,f,3,0,Math.PI*2),e.fill()}e.restore()}function $s(e){const t=e.replace(/\d+$/,"");return t.length>0?t:e}function Hn(e,t){return!Number.isFinite(t)||t<=0?e:Math.round(e*t)/t}function ei(e,t,s,i){const o=Math.max(10,Math.min(e*1.2,t*1.2)),a=s<=3?1:.7,r=i<=1?1.08:1;return Hn(o*a*r,i)}function ti(e){const t=e.getContext("2d");return t&&(t.getTransform().a||window.devicePixelRatio)||1}function ni(e){if(typeof e.midi=="number")return e.midi%12;if(typeof e.pitchClass=="number")return e.pitchClass;const t={C:0,D:2,E:4,F:5,G:7,A:9,B:11},s=e.pitch.charAt(0).toUpperCase();let i=t[s]??0;return(e.pitch.includes("#")||e.pitch.includes("♯"))&&i++,(e.pitch.includes("b")||e.pitch.includes("♭"))&&i--,(i%12+12)%12}function si(e,t){const{showFrequencyLabels:s,showOctaveLabels:i,accidentalMode:o}=t,a=h=>i?h:$s(h);if(s)return String(Math.round(e.frequency));const{flatName:r,sharpName:c,isAccidental:l}=e,{sharp:u,flat:f}=o;return l?u&&f?a(e.pitch):u&&!f?a(c):f&&!u?a(r):null:a(r)}function sn(e,t,s,i){const{fullRowData:o,cellWidth:a,cellHeight:r,legendColumnWidth:c,colorMode:l,accidentalMode:u}=t,{startRow:f,endRow:h,coords:m}=s,p=ti(e.canvas),v=y=>Hn(y,p),d=c;let g=0;for(const y of i){for(let _=f;_<=h;_++){const w=o[_];if(!w||w.isBoundary||w.column!==y)continue;const I=m.getRowY(_),C=!u.sharp&&!u.flat,M=w.isAccidental&&C,S=si(w,t);if(S===null)continue;let H=l==="bw"?"#ffffff":w.hex||"#ffffff",R="FF";M&&(R="00"),e.fillStyle=M?"rgba(255,255,255,0)":H,e.fillRect(g,I-r/2,d,r),t.highlight&&typeof t.highlight.pitchClass=="number"&&t.highlight.opacity>.01&&ni(w)===t.highlight.pitchClass&&(e.save(),e.globalAlpha=Math.min(Math.max(t.highlight.opacity,0),1),e.fillStyle=t.highlight.color??"#ffff00",e.fillRect(g,I-r/2,d,r),e.restore());const x=ei(a,r,S.length,p);e.font=`bold ${x}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle";const J=v(g+d/2),z=v(I);e.strokeStyle=`#212529${R}`,e.lineWidth=Math.max(1.2,2.5/p),e.lineJoin="round",e.strokeText(S,J,z),e.fillStyle=`#ffffff${R}`,e.fillText(S,J,z)}g+=d}}function ii(e,t,s,i){e&&(e.clearRect(0,0,e.canvas.width,e.canvas.height),sn(e,s,i,["B","A"])),t&&(t.clearRect(0,0,t.canvas.width,t.canvas.height),sn(t,s,i,["A","B"]))}var ai=E('<canvas class="pitch-grid-legend pitch-grid-legend--left svelte-ui3s88"></canvas>'),oi=E('<canvas class="pitch-grid-legend pitch-grid-legend--right svelte-ui3s88"></canvas>'),ri=E('<div class="pitch-grid-container svelte-ui3s88"><!> <canvas class="pitch-grid-canvas svelte-ui3s88"></canvas> <!></div>');function li(e,t){Te(t,!0);let s=pe(t,"colorMode",3,"color"),i=pe(t,"degreeDisplayMode",3,"off"),o=pe(t,"accidentalMode",19,()=>({sharp:!0,flat:!0})),a=pe(t,"showFrequencyLabels",3,!1),r=pe(t,"showOctaveLabels",3,!0),c=pe(t,"showRightLegend",3,!0),l=pe(t,"placedNotes",19,()=>[]),u=pe(t,"placedTonicSigns",19,()=>[]),f=pe(t,"columnWidths",19,()=>[]),h=pe(t,"macrobeatGroupings",19,()=>[]),m=pe(t,"macrobeatBoundaryStyles",19,()=>[]),p=pe(t,"longNoteStyle",3,"style1"),v=pe(t,"beatIntervalMs",3,500),d=pe(t,"beatTimeOffsetMs",3,0),g=K(void 0),y=K(void 0),_=K(void 0),w=K(null),I=K(null),C=K(null),M=K(null);const S=3,H=D(()=>t.cellWidth*S),R=D(()=>n(H)*2),x=D(()=>r()||a()),J=D(()=>n(x)?n(R)*(c()?2:1):0),z=D(()=>Math.max(0,t.viewport.containerWidth-n(J))),$=D(()=>t.mode==="notation"||t.mode==="playback"),Q=D(()=>t.mode==="singing"),A=D(()=>t.mode==="highway");function O(){if(n($))return Rs({cellWidth:t.cellWidth,cellHeight:t.cellHeight,columnWidths:f(),viewport:t.viewport,modulationMarkers:t.modulationMarkers});{const T=n(A)?t.highwayConfig:t.singingConfig;return Sn({cellWidth:t.cellWidth,cellHeight:t.cellHeight,viewport:t.viewport,pixelsPerSecond:T?.pixelsPerSecond??200,nowLineX:T?.nowLineX??100,currentTimeMs:T?.currentTimeMs??0})}}function U(){if(!n(w)||!n(g))return;const T=O(),{paddedStartRow:F,paddedEndRow:W}=Ds(t.viewport,t.fullRowData);n(w).clearRect(0,0,n(z),t.viewport.containerHeight);const ae={fullRowData:t.fullRowData,cellHeight:t.cellHeight,viewportHeight:t.viewport.containerHeight,viewportWidth:n(z),colorMode:s()};Ls(n(w),ae,T,F,W),n($)?ie(n(w),T):n(Q)?ve(n(w),T):n(A)&&ye(n(w),T),n(x)&&(n(I)||n(C))&&ee(T,F,W)}function ie(T,F){const W=L(h()),ae={columnWidths:f(),cellWidth:t.cellWidth,viewportHeight:t.viewport.containerHeight,macrobeatGroupings:h(),macrobeatBoundaryStyles:m(),placedTonicSigns:u()};Fs(T,ae,F,W);const ge=l().filter(re=>re.isDrum||re.globalRow===void 0?!1:Pt(re.globalRow,t.viewport,t.cellHeight,F)),be=u().filter(re=>re.globalRow===void 0?!1:Pt(re.globalRow,t.viewport,t.cellHeight,F)),Ce={config:{cellWidth:t.cellWidth,cellHeight:t.cellHeight,columnWidths:f(),degreeDisplayMode:i(),accidentalMode:o(),longNoteStyle:p(),colorMode:s()},coords:F,allNotes:l()};for(const re of ge)re.shape==="oval"?$t(T,Ce,re,re.globalRow):re.shape==="circle"&&en(T,Ce,re,re.globalRow);for(const re of be)Zs(T,Ce,re)}function ve(T,F){if(!t.singingConfig)return;const W={cellHeight:t.cellHeight,viewportWidth:n(z),pixelsPerSecond:t.singingConfig.pixelsPerSecond??200,timeWindowMs:t.singingConfig.timeWindowMs??4e3,colorMode:s(),trailConfig:t.singingConfig.trailConfig};t.singingConfig.pitchHistory&&t.singingConfig.pitchHistory.length>0&&Dn(T,F,t.singingConfig.pitchHistory,performance.now(),W,t.fullRowData),t.singingConfig.targetNotes&&t.singingConfig.targetNotes.length>0&&nn(T,F,t.singingConfig.targetNotes,performance.now(),W,t.fullRowData),t.singingConfig.userPitch&&t.singingConfig.userPitch.clarity>.5&&tn(T,F,t.singingConfig.userPitch.midi,t.singingConfig.userPitch.clarity,n(z)-20,W,t.fullRowData)}function ye(T,F){if(!t.highwayConfig)return;const W={cellHeight:t.cellHeight,viewportWidth:t.viewport.containerWidth,nowLineX:t.highwayConfig.nowLineX,pixelsPerSecond:t.highwayConfig.pixelsPerSecond??200,timeWindowMs:t.highwayConfig.timeWindowMs??4e3,colorMode:s(),trailConfig:t.highwayConfig.trailConfig};if(t.highwayConfig.scrollingGridData&&t.highwayConfig.scrollOffset!==void 0)Me(T,F);else{const ge={startMs:t.highwayConfig.currentTimeMs-1e3,endMs:t.highwayConfig.currentTimeMs+n(z)/(t.highwayConfig.pixelsPerSecond??200)*1e3},be={viewportWidth:n(z),viewportHeight:t.viewport.containerHeight,beatIntervalMs:v(),visibleTimeRange:ge,nowLineX:t.highwayConfig.nowLineX,beatTimeOffsetMs:d()};Es(T,be,F),t.highwayConfig.targetNotes&&t.highwayConfig.targetNotes.length>0&&nn(T,F,t.highwayConfig.targetNotes,t.highwayConfig.currentTimeMs,W,t.fullRowData,t.highwayConfig.userPitch?.midi??null,t.highwayConfig.userPitch?.clarity??0)}j(T,t.highwayConfig.nowLineX,t.viewport.containerHeight),t.highwayConfig.showOnrampCountdown&&t.highwayConfig.onrampBeatsRemaining!==void 0&&X(T,t.highwayConfig.onrampBeatsRemaining),t.highwayConfig.userPitch&&t.highwayConfig.userPitch.clarity>.5&&tn(T,F,t.highwayConfig.userPitch.midi,t.highwayConfig.userPitch.clarity,t.highwayConfig.nowLineX,W,t.fullRowData)}function Me(T,F){if(!t.highwayConfig?.scrollingGridData||t.highwayConfig.scrollOffset===void 0)return;const W=t.highwayConfig.scrollingGridData,ae=t.highwayConfig.scrollOffset,ge=L(W.macrobeatGroupings);for(let oe=0;oe<ge.length;oe++){const re=ge[oe]*t.cellWidth-ae;if(re>=-t.cellWidth&&re<=n(z)+t.cellWidth){const De=W.macrobeatBoundaryStyles[oe]||"solid",He=De==="solid"?2:1,Fe=De==="dashed"?[5,5]:[];T.strokeStyle="#495057",T.lineWidth=He,T.setLineDash(Fe),T.beginPath(),T.moveTo(re,0),T.lineTo(re,t.viewport.containerHeight),T.stroke(),T.setLineDash([])}}const be={cellWidth:t.cellWidth,cellHeight:t.cellHeight,columnWidths:W.columnWidths,degreeDisplayMode:i(),accidentalMode:o(),longNoteStyle:p(),colorMode:s()};for(const oe of W.placedNotes){if(oe.isDrum||oe.globalRow===void 0||!Pt(oe.globalRow,t.viewport,t.cellHeight,F))continue;const Ce=oe.startColumnIndex*t.cellWidth-ae;if(oe.endColumnIndex*t.cellWidth-ae>=-t.cellWidth&&Ce<=n(z)+t.cellWidth){const De={...F,getColumnX:Fe=>Fe*t.cellWidth-ae},He={config:be,coords:De,allNotes:W.placedNotes};oe.shape==="oval"?$t(T,He,oe,oe.globalRow):oe.shape==="circle"&&en(T,He,oe,oe.globalRow)}}}function j(T,F,W){T.strokeStyle="rgba(255, 0, 0, 0.9)",T.lineWidth=3,T.beginPath(),T.moveTo(F,0),T.lineTo(F,W),T.stroke()}function X(T,F){T.fillStyle="rgba(0, 0, 0, 0.7)",T.fillRect(n(z)/2-40,10,80,50),T.fillStyle="#ffffff",T.font="bold 36px sans-serif",T.textAlign="center",T.textBaseline="middle",T.fillText(F.toString(),n(z)/2,35)}function ee(T,F,W){const ae={fullRowData:t.fullRowData,cellWidth:t.cellWidth,cellHeight:t.cellHeight,legendColumnWidth:n(H),colorMode:s(),showFrequencyLabels:a(),showOctaveLabels:r(),accidentalMode:o(),highlight:t.legendHighlight},ge={startRow:F,endRow:W,coords:T};ii(n(I),n(C),ae,ge)}function L(T){const F=[];let W=0;for(const ae of T)W+=ae,F.push(W);return F}function N(){if(n(M))return;function T(){U(),B(M,requestAnimationFrame(T),!0)}B(M,requestAnimationFrame(T),!0)}function V(){n(M)&&(cancelAnimationFrame(n(M)),B(M,null))}function te(){if(!n(g)||(B(w,n(g).getContext("2d"),!0),!n(w)))return;const T=window.devicePixelRatio||1;n(g).width=n(z)*T,n(g).height=t.viewport.containerHeight*T,n(g).style.width=`${n(z)}px`,n(g).style.height=`${t.viewport.containerHeight}px`,n(w).scale(T,T),n(y)&&(B(I,n(y).getContext("2d"),!0),n(I)&&(n(y).width=n(R)*T,n(y).height=t.viewport.containerHeight*T,n(y).style.width=`${n(R)}px`,n(y).style.height=`${t.viewport.containerHeight}px`,n(I).scale(T,T))),n(_)&&(B(C,n(_).getContext("2d"),!0),n(C)&&(n(_).width=n(R)*T,n(_).height=t.viewport.containerHeight*T,n(_).style.width=`${n(R)}px`,n(_).style.height=`${t.viewport.containerHeight}px`,n(C).scale(T,T))),U(),(n(Q)||n(A))&&N()}yn(()=>{te()}),qe(()=>{V()}),Ne(()=>{t.mode,t.viewport,t.cellWidth,t.cellHeight,s(),i(),l(),u(),f(),n(w)&&n($)&&U()}),Ne(()=>{t.mode,n(Q)||n(A)?N():(V(),n(w)&&U())}),Ne(()=>{t.viewport.containerWidth,t.viewport.containerHeight,n(w)&&n(g)&&te()});var ce=ri(),ue=b(ce);{var me=T=>{var F=ai();xe(F,W=>B(y,W),()=>n(y)),k(T,F)};le(ue,T=>{n(x)&&T(me)})}var he=P(ue,2);xe(he,T=>B(g,T),()=>n(g));var q=P(he,2);{var se=T=>{var F=oi();xe(F,W=>B(_,W),()=>n(_)),k(T,F)};le(q,T=>{n(x)&&c()&&T(se)})}k(e,ce),Pe()}function ci(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Ct,an;function ui(){if(an)return Ct;an=1;function e(t){if(this.size=t|0,this.size<=1||(this.size&this.size-1)!==0)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=t<<1;for(var s=new Array(this.size*2),i=0;i<s.length;i+=2){const u=Math.PI*i/this.size;s[i]=Math.cos(u),s[i+1]=-Math.sin(u)}this.table=s;for(var o=0,a=1;this.size>a;a<<=1)o++;this._width=o%2===0?o-1:o,this._bitrev=new Array(1<<this._width);for(var r=0;r<this._bitrev.length;r++){this._bitrev[r]=0;for(var c=0;c<this._width;c+=2){var l=this._width-c-2;this._bitrev[r]|=(r>>>c&3)<<l}}this._out=null,this._data=null,this._inv=0}return Ct=e,e.prototype.fromComplexArray=function(s,i){for(var o=i||new Array(s.length>>>1),a=0;a<s.length;a+=2)o[a>>>1]=s[a];return o},e.prototype.createComplexArray=function(){const s=new Array(this._csize);for(var i=0;i<s.length;i++)s[i]=0;return s},e.prototype.toComplexArray=function(s,i){for(var o=i||this.createComplexArray(),a=0;a<o.length;a+=2)o[a]=s[a>>>1],o[a+1]=0;return o},e.prototype.completeSpectrum=function(s){for(var i=this._csize,o=i>>>1,a=2;a<o;a+=2)s[i-a]=s[a],s[i-a+1]=-s[a+1]},e.prototype.transform=function(s,i){if(s===i)throw new Error("Input and output buffers must be different");this._out=s,this._data=i,this._inv=0,this._transform4(),this._out=null,this._data=null},e.prototype.realTransform=function(s,i){if(s===i)throw new Error("Input and output buffers must be different");this._out=s,this._data=i,this._inv=0,this._realTransform4(),this._out=null,this._data=null},e.prototype.inverseTransform=function(s,i){if(s===i)throw new Error("Input and output buffers must be different");this._out=s,this._data=i,this._inv=1,this._transform4();for(var o=0;o<s.length;o++)s[o]/=this.size;this._out=null,this._data=null},e.prototype._transform4=function(){var s=this._out,i=this._csize,o=this._width,a=1<<o,r=i/a<<1,c,l,u=this._bitrev;if(r===4)for(c=0,l=0;c<i;c+=r,l++){const g=u[l];this._singleTransform2(c,g,a)}else for(c=0,l=0;c<i;c+=r,l++){const g=u[l];this._singleTransform4(c,g,a)}var f=this._inv?-1:1,h=this.table;for(a>>=2;a>=2;a>>=2){r=i/a<<1;var m=r>>>2;for(c=0;c<i;c+=r)for(var p=c+m,v=c,d=0;v<p;v+=2,d+=a){const g=v,y=g+m,_=y+m,w=_+m,I=s[g],C=s[g+1],M=s[y],S=s[y+1],H=s[_],R=s[_+1],x=s[w],J=s[w+1],z=I,$=C,Q=h[d],A=f*h[d+1],O=M*Q-S*A,U=M*A+S*Q,ie=h[2*d],ve=f*h[2*d+1],ye=H*ie-R*ve,Me=H*ve+R*ie,j=h[3*d],X=f*h[3*d+1],ee=x*j-J*X,L=x*X+J*j,N=z+ye,V=$+Me,te=z-ye,ce=$-Me,ue=O+ee,me=U+L,he=f*(O-ee),q=f*(U-L),se=N+ue,T=V+me,F=N-ue,W=V-me,ae=te+q,ge=ce-he,be=te-q,oe=ce+he;s[g]=se,s[g+1]=T,s[y]=ae,s[y+1]=ge,s[_]=F,s[_+1]=W,s[w]=be,s[w+1]=oe}}},e.prototype._singleTransform2=function(s,i,o){const a=this._out,r=this._data,c=r[i],l=r[i+1],u=r[i+o],f=r[i+o+1],h=c+u,m=l+f,p=c-u,v=l-f;a[s]=h,a[s+1]=m,a[s+2]=p,a[s+3]=v},e.prototype._singleTransform4=function(s,i,o){const a=this._out,r=this._data,c=this._inv?-1:1,l=o*2,u=o*3,f=r[i],h=r[i+1],m=r[i+o],p=r[i+o+1],v=r[i+l],d=r[i+l+1],g=r[i+u],y=r[i+u+1],_=f+v,w=h+d,I=f-v,C=h-d,M=m+g,S=p+y,H=c*(m-g),R=c*(p-y),x=_+M,J=w+S,z=I+R,$=C-H,Q=_-M,A=w-S,O=I-R,U=C+H;a[s]=x,a[s+1]=J,a[s+2]=z,a[s+3]=$,a[s+4]=Q,a[s+5]=A,a[s+6]=O,a[s+7]=U},e.prototype._realTransform4=function(){var s=this._out,i=this._csize,o=this._width,a=1<<o,r=i/a<<1,c,l,u=this._bitrev;if(r===4)for(c=0,l=0;c<i;c+=r,l++){const yt=u[l];this._singleRealTransform2(c,yt>>>1,a>>>1)}else for(c=0,l=0;c<i;c+=r,l++){const yt=u[l];this._singleRealTransform4(c,yt>>>1,a>>>1)}var f=this._inv?-1:1,h=this.table;for(a>>=2;a>=2;a>>=2){r=i/a<<1;var m=r>>>1,p=m>>>1,v=p>>>1;for(c=0;c<i;c+=r)for(var d=0,g=0;d<=v;d+=2,g+=a){var y=c+d,_=y+p,w=_+p,I=w+p,C=s[y],M=s[y+1],S=s[_],H=s[_+1],R=s[w],x=s[w+1],J=s[I],z=s[I+1],$=C,Q=M,A=h[g],O=f*h[g+1],U=S*A-H*O,ie=S*O+H*A,ve=h[2*g],ye=f*h[2*g+1],Me=R*ve-x*ye,j=R*ye+x*ve,X=h[3*g],ee=f*h[3*g+1],L=J*X-z*ee,N=J*ee+z*X,V=$+Me,te=Q+j,ce=$-Me,ue=Q-j,me=U+L,he=ie+N,q=f*(U-L),se=f*(ie-N),T=V+me,F=te+he,W=ce+se,ae=ue-q;if(s[y]=T,s[y+1]=F,s[_]=W,s[_+1]=ae,d===0){var ge=V-me,be=te-he;s[w]=ge,s[w+1]=be;continue}if(d!==v){var oe=ce,Ce=-ue,re=V,De=-te,He=-f*se,Fe=-f*q,gt=-f*he,vt=-f*me,mt=oe+He,pt=Ce+Fe,st=re+vt,it=De-gt,Bt=c+p-d,qt=c+m-d;s[Bt]=mt,s[Bt+1]=pt,s[qt]=st,s[qt+1]=it}}}},e.prototype._singleRealTransform2=function(s,i,o){const a=this._out,r=this._data,c=r[i],l=r[i+o],u=c+l,f=c-l;a[s]=u,a[s+1]=0,a[s+2]=f,a[s+3]=0},e.prototype._singleRealTransform4=function(s,i,o){const a=this._out,r=this._data,c=this._inv?-1:1,l=o*2,u=o*3,f=r[i],h=r[i+o],m=r[i+l],p=r[i+u],v=f+m,d=f-m,g=h+p,y=c*(h-p),_=v+g,w=d,I=-y,C=v-g,M=d,S=y;a[s]=_,a[s+1]=0,a[s+2]=w,a[s+3]=I,a[s+4]=C,a[s+5]=0,a[s+6]=M,a[s+7]=S},Ct}var di=ui();const fi=ci(di);class Ze{_inputLength;_fft;_bufferSupplier;_paddedInputBuffer;_transformBuffer;_inverseBuffer;static forFloat32Array(t){return new Ze(t,s=>new Float32Array(s))}static forFloat64Array(t){return new Ze(t,s=>new Float64Array(s))}static forNumberArray(t){return new Ze(t,s=>Array(s))}constructor(t,s){if(t<1)throw new Error("Input length must be at least one");this._inputLength=t,this._fft=new fi(vi(2*t)),this._bufferSupplier=s,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}get inputLength(){return this._inputLength}autocorrelate(t,s=this._bufferSupplier(t.length)){if(t.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${t.length}`);for(let o=0;o<t.length;o++)this._paddedInputBuffer[o]=t[o];for(let o=t.length;o<this._paddedInputBuffer.length;o++)this._paddedInputBuffer[o]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const i=this._transformBuffer;for(let o=0;o<i.length;o+=2)i[o]=i[o]*i[o]+i[o+1]*i[o+1],i[o+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let o=0;o<t.length;o++)s[o]=this._inverseBuffer[2*o];return s}}function hi(e){const t=[];let s=!1,i=-1/0,o=-1;for(let a=1;a<e.length-1;a++)e[a-1]<=0&&e[a]>0?(s=!0,o=a,i=e[a]):e[a-1]>0&&e[a]<=0?(s=!1,o!==-1&&t.push(o)):s&&e[a]>i&&(i=e[a],o=a);return t}function gi(e,t){const[s,i,o]=[e-1,e,e+1],[a,r,c]=[t[s],t[i],t[o]],l=a/2-r+c/2,u=-(a/2)*(i+o)+r*(s+o)-c/2*(s+i),f=a*i*o/2-r*s*o+c*s*i/2,h=-u/(2*l),m=l*h*h+u*h+f;return[h,m]}class Qe{_autocorrelator;_nsdfBuffer;_clarityThreshold=.9;_minVolumeAbsolute=0;_maxInputAmplitude=1;static forFloat32Array(t){return new Qe(t,s=>new Float32Array(s))}static forFloat64Array(t){return new Qe(t,s=>new Float64Array(s))}static forNumberArray(t){return new Qe(t,s=>Array(s))}constructor(t,s){this._autocorrelator=new Ze(t,s),this._nsdfBuffer=s(t)}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(t){if(!Number.isFinite(t)||t<=0||t>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=t}set minVolumeAbsolute(t){if(!Number.isFinite(t)||t<0||t>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=t}set minVolumeDecibels(t){if(!Number.isFinite(t)||t>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(t/10)}set maxInputAmplitude(t){if(!Number.isFinite(t)||t<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=t}findPitch(t,s){if(this._belowMinimumVolume(t))return[0,0];this._nsdf(t);const i=hi(this._nsdfBuffer);if(i.length===0)return[0,0];const o=Math.max(...i.map(l=>this._nsdfBuffer[l])),a=i.find(l=>this._nsdfBuffer[l]>=this._clarityThreshold*o),[r,c]=gi(a,this._nsdfBuffer);return[s/r,Math.min(c,1)]}_belowMinimumVolume(t){if(this._minVolumeAbsolute===0)return!1;let s=0;for(let i=0;i<t.length;i++)s+=t[i]**2;return Math.sqrt(s/t.length)<this._minVolumeAbsolute}_nsdf(t){this._autocorrelator.autocorrelate(t,this._nsdfBuffer);let s=2*this._nsdfBuffer[0],i;for(i=0;i<this._nsdfBuffer.length&&s>0;i++)this._nsdfBuffer[i]=2*this._nsdfBuffer[i]/s,s-=t[i]**2+t[t.length-i-1]**2;for(;i<this._nsdfBuffer.length;i++)this._nsdfBuffer[i]=0}}function vi(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e++,e}const mi=100,St=12;function pi(e){const t=Math.round(e);return(e-t)*mi}function yi(e){return Math.round(e)}function bi(e){return(Math.round(e)%St+St)%St}var wi=E('<div class="pitch-wheel-option svelte-53gwvz"> </div>'),Mi=E('<div class="pitch-wheel svelte-53gwvz" role="slider" tabindex="0" aria-valuemin="0"><div class="pitch-wheel-viewport svelte-53gwvz"><div class="pitch-wheel-options svelte-53gwvz"></div></div> <div class="pitch-wheel-overlay svelte-53gwvz"></div></div>');function on(e,t){Te(t,!0);let s=pe(t,"selectedIndex",15),i=pe(t,"ariaLabel",3,"Pitch selector");const o=40,a=o;let r=K(void 0),c=K(void 0),l=K(void 0),u=K(!1),f=K(null),h=K(0),m=K(0),p=K(o);const v=D(()=>t.options.map((A,O)=>Math.min(Math.abs(O-s()),3))),d=D(()=>n(c)?.clientHeight??0),g=D(()=>Math.max(0,(n(d)-n(p))/2)),y=D(()=>n(g)+s()*n(p)+n(p)/2),_=D(()=>n(d)>0?n(d)/2-n(y):0);function w(A){if(!t.options||t.options.length===0)return;let O=A;typeof t.onbeforechange=="function"&&(O=t.onbeforechange(A));const U=Math.max(0,Math.min(t.options.length-1,O));if(U!==s()&&(s(U),typeof t.onchange=="function")){const ie=t.options[U];ie&&t.onchange(U,ie)}}function I(A){A!==0&&w(s()+A)}function C(A){A.preventDefault(),A.stopPropagation();const O=Math.sign(A.deltaY);O!==0&&I(O)}function M(A){A.key==="ArrowUp"?(A.preventDefault(),I(-1)):A.key==="ArrowDown"?(A.preventDefault(),I(1)):A.key==="Home"?(A.preventDefault(),w(0)):A.key==="End"&&(A.preventDefault(),w(t.options.length-1))}function S(A){if(B(u,!0),B(f,A.pointerId,!0),B(h,A.clientY,!0),B(m,0),n(r)&&typeof n(r).setPointerCapture=="function")try{n(r).setPointerCapture(A.pointerId)}catch{}}function H(A){if(!n(u)||A.pointerId!==n(f))return;const O=A.clientY-n(h);if(B(h,A.clientY,!0),O===0)return;B(m,n(m)+O);const U=n(p)||a;for(;Math.abs(n(m))>=U;){const ie=-Math.sign(n(m));I(ie),B(m,n(m)-Math.sign(n(m))*U)}}function R(A){n(u)&&A.pointerId===n(f)&&(B(u,!1),B(f,null),B(m,0),n(r)?.hasPointerCapture?.(A.pointerId)&&n(r).releasePointerCapture(A.pointerId))}Ne(()=>{if(!n(l)||!n(c))return;const A=()=>{const U=n(l)?.querySelector(".pitch-wheel-option");U&&B(p,U.offsetHeight||o,!0)};A();const O=new ResizeObserver(()=>{A()});return O.observe(n(c)),()=>{O.disconnect()}});var x=Mi();x.__keydown=M,x.__pointerdown=S,x.__pointermove=H,x.__pointerup=R;let J;var z=b(x),$=b(z);let Q;nt($,23,()=>t.options,A=>A.index,(A,O,U)=>{var ie=wi(),ve=b(ie);ne(()=>{Ee(ie,"data-distance",n(v)[n(U)]),Y(ve,n(O).label)}),k(A,ie)}),xe($,A=>B(l,A),()=>n(l)),xe(z,A=>B(c,A),()=>n(c)),xe(x,A=>B(r,A),()=>n(r)),ne(()=>{Ee(x,"aria-label",i()),Ee(x,"aria-valuemax",t.options.length-1),Ee(x,"aria-valuenow",s()),Ee(x,"aria-valuetext",t.options[s()]?.label??""),J=lt(x,"",J,{height:t.wheelHeight?`${t.wheelHeight}px`:"100%"}),Q=lt($,"",Q,{"padding-top":`${n(g)??""}px`,"padding-bottom":`${n(g)??""}px`,transform:`translateY(${n(_)??""}px)`})}),Ue("wheel",x,C),Ue("pointercancel",x,R),Ue("pointerleave",x,R),k(e,x),Pe()}Se(["keydown","pointerdown","pointermove","pointerup"]);const xn=7;function ut(e,t,s){return Number.isFinite(e)?Math.max(t,Math.min(s,Math.round(e))):t}function _i(e,t,s,i=xn){const o=Math.max(0,s-1),a=ut(e,0,o),r=Math.max(1,Math.round(i)),c=Math.max(0,a-(r-1));return ut(t,0,c)}function Ti(e,t,s,i=xn){const o=Math.max(0,s-1),a=ut(e,0,o),r=Math.max(1,Math.round(i)),c=Math.min(o,a+(r-1));return ut(t,c,o)}function Pi(e){return e.map((t,s)=>({index:s,label:t.pitch,midi:t.midi,toneNote:t.toneNote,frequency:t.frequency}))}var Ci=E('<div class="summary-card svelte-yqjxxp"><div class="summary-label svelte-yqjxxp"> </div> <div class="summary-metadata svelte-yqjxxp"> </div></div>'),Si=E('<div class="dual-pitch-wheel svelte-yqjxxp"><div class="wheels-container svelte-yqjxxp"><div class="wheel-column svelte-yqjxxp"><div class="wheel-label svelte-yqjxxp">High</div> <!></div> <div class="wheel-column svelte-yqjxxp"><div class="wheel-label svelte-yqjxxp">Low</div> <!></div></div> <!></div>');function Ai(e,t){Te(t,!0);let s=pe(t,"topIndex",15),i=pe(t,"bottomIndex",15),o=pe(t,"minSpan",3,7),a=pe(t,"showSummary",3,!0);const r=D(()=>Pi(t.fullRowData)),c=D(()=>({topIndex:s(),bottomIndex:i(),topPitch:t.fullRowData[s()],bottomPitch:t.fullRowData[i()],span:i()-s()+1})),l=D(()=>n(c).topPitch&&n(c).bottomPitch?`${n(c).topPitch.pitch} – ${n(c).bottomPitch.pitch}`:""),u=D(()=>`${n(c).span} ${n(c).span===1?"pitch":"pitches"}`);function f(M){return _i(i(),M,n(r).length,o())}function h(M){return Ti(s(),M,n(r).length,o())}function m(M,S){s(M),typeof t.onrangechange=="function"&&t.onrangechange(n(c))}function p(M,S){i(M),typeof t.onrangechange=="function"&&t.onrangechange(n(c))}var v=Si(),d=b(v),g=b(d),y=P(b(g),2);on(y,{get options(){return n(r)},get selectedIndex(){return s()},onchange:m,onbeforechange:f,get wheelHeight(){return t.wheelHeight},ariaLabel:"High pitch selector"});var _=P(g,2),w=P(b(_),2);on(w,{get options(){return n(r)},get selectedIndex(){return i()},onchange:p,onbeforechange:h,get wheelHeight(){return t.wheelHeight},ariaLabel:"Low pitch selector"});var I=P(d,2);{var C=M=>{var S=Ci(),H=b(S),R=b(H),x=P(H,2),J=b(x);ne(()=>{Y(R,n(l)),Y(J,n(u))}),k(M,S)};le(I,M=>{a()&&M(C)})}k(e,v),Pe()}Se(["change"]);var Ii=Object.defineProperty,Ri=(e,t,s)=>t in e?Ii(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,Ve=(e,t,s)=>Ri(e,typeof t!="symbol"?t+"":t,s);const rn={isDetecting:!1,visualizationMode:"highway",tonic:"C",useDegrees:!1,showAccidentals:!0,pitchHighlightEnabled:!0,yAxisRange:{minMidi:48,maxMidi:72},drone:{isPlaying:!1,octave:3,volume:-12}};function Ni(){let e=K(ke({...rn}));return{get state(){return n(e)},toggleDetecting(){n(e).isDetecting=!n(e).isDetecting},setDetecting(t){n(e).isDetecting=t},setVisualizationMode(t){n(e).visualizationMode=t},setTonic(t){n(e).tonic=t},setUseDegrees(t){n(e).useDegrees=t},setShowAccidentals(t){n(e).showAccidentals=t},togglePitchHighlight(){n(e).pitchHighlightEnabled=!n(e).pitchHighlightEnabled},setPitchHighlightEnabled(t){n(e).pitchHighlightEnabled=t},setYAxisRange(t){n(e).yAxisRange=t},expandYAxisUpper(){n(e).yAxisRange.maxMidi<108&&(n(e).yAxisRange={...n(e).yAxisRange,maxMidi:n(e).yAxisRange.maxMidi+1})},contractYAxisUpper(){n(e).yAxisRange.maxMidi>n(e).yAxisRange.minMidi+6&&(n(e).yAxisRange={...n(e).yAxisRange,maxMidi:n(e).yAxisRange.maxMidi-1})},expandYAxisLower(){n(e).yAxisRange.minMidi>21&&(n(e).yAxisRange={...n(e).yAxisRange,minMidi:n(e).yAxisRange.minMidi-1})},contractYAxisLower(){n(e).yAxisRange.minMidi<n(e).yAxisRange.maxMidi-6&&(n(e).yAxisRange={...n(e).yAxisRange,minMidi:n(e).yAxisRange.minMidi+1})},toggleDrone(){n(e).drone={...n(e).drone,isPlaying:!n(e).drone.isPlaying}},setDroneOctave(t){n(e).drone={...n(e).drone,octave:t}},setDroneVolume(t){n(e).drone={...n(e).drone,volume:t}},reset(){B(e,{...rn},!0)}}}const Z=Ni(),Di=200,ln={currentPitch:null,history:[],stablePitch:{pitchClass:null,opacity:0,size:1}};function Hi(){let e=K(ke({...ln}));return{get state(){return n(e)},setCurrentPitch(t){n(e).currentPitch=t},addHistoryPoint(t){n(e).history.push(t),n(e).history.length>Di&&n(e).history.shift()},setStablePitch(t){n(e).stablePitch=t},clearHistory(){n(e).history=[]},reset(){B(e,{...ln},!0)}}}const de=Hi(),cn={isPlaying:!1,startTime:null,currentTimeMs:0,targetNotes:[],nowLineX:100,pixelsPerSecond:200,timeWindowMs:4e3};function xi(){let e=K(ke({...cn})),t=null,s=null,i=null;function o(l){return l.map((u,f)=>({id:`target-${f}`,midi:u.midi,startTimeMs:u.startTimeMs,durationMs:u.durationMs,startColumn:0,endColumn:0,color:"#3b82f6",shape:"oval",globalRow:0}))}function a(){if(!t)return;const l=t.getState();n(e).isPlaying=l.isPlaying&&!l.isPaused,n(e).currentTimeMs=l.currentTimeMs;const u=t.getPerformanceResults();n(e).targetNotes=n(e).targetNotes.map((f,h)=>{const m=`target-${h}`,p=u.get(m);return{...f,hit:p?.hitStatus==="hit"}})}function r(){n(e).isPlaying&&t?(a(),s=requestAnimationFrame(r)):s=null}function c(){t&&t.dispose(),t=Is({judgmentLinePosition:n(e).nowLineX/800,pixelsPerSecond:n(e).pixelsPerSecond,lookAheadMs:n(e).timeWindowMs,scrollMode:"constant-speed",leadInBeats:0,playMetronomeDuringOnramp:!1,playTargetNotes:!1,playMetronome:!1,inputSources:["microphone"],feedbackConfig:{onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70},stateCallbacks:{getTempo:()=>120,getCellWidth:()=>20,getViewportWidth:()=>800},eventCallbacks:{emit:(u,f)=>{if(console.debug("[Highway]",u,f),u==="noteHit"){const h=f;console.log(`[Highway] Note HIT: ${h.noteId}, accuracy: ${h.performance.accuracyTier||"unknown"}`)}else u==="noteMissed"?console.log(`[Highway] Note MISSED: ${f.noteId}`):u==="onrampComplete"?console.log("[Highway] Onramp complete, playback starting!"):u==="performanceComplete"&&(console.log("[Highway] Performance complete!"),i&&t&&i(t.getPerformanceResults()))}}});const l=o(n(e).targetNotes);t.init(l)}return{get state(){return n(e)},get engineService(){return t},start(){!t&&n(e).targetNotes.length>0&&c(),t&&(t.start(),n(e).isPlaying=!0,n(e).startTime=performance.now(),n(e).currentTimeMs=0,r())},stop(){t&&t.stop(),n(e).isPlaying=!1,s!==null&&(cancelAnimationFrame(s),s=null)},pause(){t&&t.pause(),n(e).isPlaying=!1,s!==null&&(cancelAnimationFrame(s),s=null)},resume(){t&&(t.resume(),n(e).isPlaying=!0,r())},setTargetNotes(l){if(n(e).targetNotes=l,t){const u=o(l);t.init(u)}},markNoteHit(l){l>=0&&l<n(e).targetNotes.length&&(n(e).targetNotes=n(e).targetNotes.map((u,f)=>f===l?{...u,hit:!0}:u))},setNowLineX(l){n(e).nowLineX=l},setPixelsPerSecond(l){n(e).pixelsPerSecond=l},setTimeWindowMs(l){n(e).timeWindowMs=l},recordPitchInput(l,u){t&&n(e).isPlaying&&t.recordPitchInput(l,u,"microphone")},getPerformanceResults(){return t?.getPerformanceResults()??new Map},setCurrentTime(l){n(e).currentTimeMs=l,t&&t.setScrollOffset(l)},onPerformanceComplete(l){return i=l,()=>{i=null}},reset(){s!==null&&(cancelAnimationFrame(s),s=null),t&&(t.dispose(),t=null),B(e,{...cn},!0)}}}const fe=xi(),ki={numLoops:5,minMidi:48,maxMidi:72,tempo:108,referenceVolume:-12},un={isActive:!1,isPlaying:!1,config:{...ki},currentLoop:0,currentPhase:"reference",currentPitch:null,generatedNotes:[],results:[]};function Li(e,t){return Math.floor(Math.random()*(t-e+1))+e}function dn(e){return 60/e*1e3/2}function Fi(){let e=K(ke({...un}));function t(i){const o=[],a=dn(i.tempo),r=2e3;for(let c=0;c<i.numLoops;c++){const l=Li(i.minMidi,i.maxMidi),u=r+c*32*a;o.push({midi:l,startTimeMs:u,durationMs:8*a,lyric:"👂"}),o.push({midi:l,startTimeMs:u+16*a,durationMs:8*a,lyric:"🎤"})}return o}function s(i,o){const a=dn(o),r=32*a,c=i-2e3;if(c<0)return{loop:0,phase:"rest2"};const l=Math.floor(c/r),u=c%r,f=Math.floor(u/a);let h;return f<8?h="reference":f<16?h="rest1":f<24?h="input":h="rest2",{loop:l,phase:h}}return{get state(){return n(e)},configure(i){n(e).config={...n(e).config,...i}},setPitchRange(i,o){n(e).config.minMidi=i,n(e).config.maxMidi=o},start(){const i=t(n(e).config);n(e).generatedNotes=i,n(e).isActive=!0,n(e).isPlaying=!1,n(e).currentLoop=0,n(e).currentPhase="reference",n(e).currentPitch=i.length>0?i[0].midi:null,n(e).results=[]},stop(){n(e).isActive=!1,n(e).isPlaying=!1,n(e).currentLoop=0,n(e).currentPhase="reference",n(e).currentPitch=null},setPlaying(i){n(e).isPlaying=i},updatePhase(i){const{loop:o,phase:a}=s(i,n(e).config.tempo);n(e).currentLoop=o,n(e).currentPhase=a;const r=o*2;r<n(e).generatedNotes.length&&(n(e).currentPitch=n(e).generatedNotes[r].midi)},addResult(i){n(e).results.push(i)},hasResultForLoop(i){return n(e).results.some(o=>o.loopIndex===i)},getResults(){return n(e).results},getCurrentProgress(){return{current:n(e).currentLoop+1,total:n(e).config.numLoops}},getGeneratedNotes(){return n(e).generatedNotes},getAverageAccuracy(){return n(e).results.length===0?0:n(e).results.reduce((i,o)=>i+o.accuracy,0)/n(e).results.length},getHitCount(){return n(e).results.filter(i=>{var o;return((o=i.performance)==null?void 0:o.hitStatus)==="hit"}).length},reset(){B(e,{...un,config:{...n(e).config}},!0)}}}const we=Fi();var Ei=E('<div class="singing-canvas-container svelte-15ar5r5"><!> <canvas class="pitch-trail-canvas svelte-15ar5r5"></canvas></div>');function Wi(e,t){Te(t,!0);let s=K(void 0),i=K(800),o=K(400),a=K(void 0),r=K(null),c=K(null),l=0,u=0,f=0;const h=20,m=!0,p=!1,v=D(()=>n(i)>=720),d=3,g=D(()=>h*d),y=D(()=>n(g)*2),_=D(()=>m),w=D(()=>n(_)?n(y)*(n(v)?2:1):0),I=D(()=>Math.max(0,n(i)-n(w))),C=D(()=>n(_)?n(y):0),M=()=>{try{return!!globalThis.__ST_DEBUG_TRAIL}catch{return!1}},S=D(()=>Un(Z.state.yAxisRange.minMidi,Z.state.yAxisRange.maxMidi)),H=D(()=>Xn({containerHeight:n(o),fullRowData:n(S),preferredCellHeight:40,minCellHeight:20})),R=D(()=>Z.state.visualizationMode==="highway"?"highway":"singing"),x=D(()=>60/we.state.config.tempo*1e3),J=2e3,z=D(()=>(()=>{if(!Z.state.pitchHighlightEnabled)return;const L=de.state.stablePitch;if(!(L.pitchClass===null||L.opacity<=.01))return{pitchClass:L.pitchClass,opacity:L.opacity,color:"#ffff00"}})());function $(){return fe.state.targetNotes.map((L,N)=>({id:`target-${N}`,midi:L.midi,startTimeMs:L.startTimeMs,durationMs:L.durationMs,label:L.lyric}))}const Q=D(()=>({timeWindowMs:4e3,pixelsPerSecond:200,circleRadius:9.5,proximityThreshold:35,maxConnections:3,connectorLineWidth:2.5,connectorColor:"rgba(0,0,0,0.4)",useTonicRelativeColors:!0,tonicPitchClass:Ss(Z.state.tonic),clarityThreshold:.5,maxOpacity:.9})),A=D(()=>n(R)==="singing"?{userPitch:de.state.currentPitch?{frequency:de.state.currentPitch.frequency,midi:de.state.currentPitch.midi,clarity:de.state.currentPitch.clarity,pitchClass:de.state.currentPitch.pitchClass}:null,pitchHistory:[],targetNotes:[],pixelsPerSecond:200,timeWindowMs:4e3,trailConfig:n(Q)}:void 0),O=D(()=>n(R)==="highway"?{userPitch:de.state.currentPitch?{frequency:de.state.currentPitch.frequency,midi:de.state.currentPitch.midi,clarity:de.state.currentPitch.clarity,pitchClass:de.state.currentPitch.pitchClass}:null,pitchHistory:[],targetNotes:$(),nowLineX:fe.state.nowLineX,pixelsPerSecond:fe.state.pixelsPerSecond,currentTimeMs:fe.state.currentTimeMs,timeWindowMs:fe.state.timeWindowMs,trailConfig:n(Q)}:void 0),U=D(()=>({startRow:n(H).startRow,endRow:n(H).endRow,zoomLevel:1,containerWidth:n(i),containerHeight:n(o)}));function ie(){if(!n(a))return;const L=window.devicePixelRatio||1;n(a).width=n(I)*L,n(a).height=n(o)*L,n(a).style.width=`${n(I)}px`,n(a).style.height=`${n(o)}px`,n(a).style.left=`${n(C)}px`;const N=n(a).getContext("2d");if(!N){B(r,null);return}N.setTransform(L,0,0,L,0,0),B(r,N,!0)}function ve(){if(!n(r)||n(I)<=0)return;n(r).clearRect(0,0,n(I),n(o));const L=de.state.history;if(L.length===0)return;const N=n(R)==="singing"?n(A):n(O);if(!N)return;const V=M(),te=V?performance.now():0,ce=n(R)==="highway"&&n(O)?n(O).nowLineX:100,ue=Sn({cellHeight:n(H).cellHeight,viewport:n(U),pixelsPerSecond:N.pixelsPerSecond??200,nowLineX:ce,currentTimeMs:n(R)==="highway"&&n(O)?n(O).currentTimeMs:0}),me={cellHeight:n(H).cellHeight,viewportWidth:n(I),nowLineX:ce,pixelsPerSecond:N.pixelsPerSecond??200,timeWindowMs:N.timeWindowMs??4e3,colorMode:"color",trailConfig:n(Q)},he=performance.now();if(Dn(n(r),ue,L,he,me,n(S)),V){const q=performance.now();if(u+=1,f+=q-te,q-l>=1e3){const se=u>0?f/u:0;console.log(`[SingingTrail] points=${L.length} avgMs=${se.toFixed(2)} gridWidth=${n(I)}`),l=q,u=0,f=0}}}function ye(){if(n(c))return;const L=()=>{ve(),B(c,requestAnimationFrame(L),!0)};B(c,requestAnimationFrame(L),!0)}function Me(){n(c)&&(cancelAnimationFrame(n(c)),B(c,null)),n(r)&&n(I)>0&&n(r).clearRect(0,0,n(I),n(o))}Ne(()=>{if(!n(s))return;const L=new ResizeObserver(N=>{for(const V of N)B(i,V.contentRect.width,!0),B(o,V.contentRect.height,!0)});return L.observe(n(s)),()=>{L.disconnect()}}),Ne(()=>{n(I),n(o),n(C),n(a),ie()}),Ne(()=>{n(R),n(r),n(R)==="singing"||n(R)==="highway"?ye():Me()}),qe(()=>{Me()});var j=Ei(),X=b(j);li(X,{get mode(){return n(R)},get fullRowData(){return n(S)},get viewport(){return n(U)},cellWidth:h,get cellHeight(){return n(H).cellHeight},colorMode:"color",showOctaveLabels:m,showFrequencyLabels:p,get showRightLegend(){return n(v)},get singingConfig(){return n(A)},get highwayConfig(){return n(O)},get legendHighlight(){return n(z)},get beatIntervalMs(){return n(x)},beatTimeOffsetMs:J});var ee=P(X,2);xe(ee,L=>B(a,L),()=>n(a)),xe(j,L=>B(s,L),()=>n(s)),k(e,j),Pe()}class Oi{constructor(){Ve(this,"synth",null),Ve(this,"scheduledTimeouts",[]),Ve(this,"volume",null),Ve(this,"startTime",0),Ve(this,"_isPlaying",!1)}get isPlaying(){return this._isPlaying}async init(){await kt(),this.volume=new pn(-12).toDestination(),this.synth=new bn({oscillator:{type:"triangle"},envelope:{attack:.05,decay:.1,sustain:.9,release:.1}}).connect(this.volume)}setVolume(t){this.volume&&(this.volume.volume.value=t)}scheduleReferenceTones(t){if(!this.synth){console.warn("[ReferenceAudio] Synth not initialized");return}this.clearScheduled(),this.startTime=performance.now(),t.forEach(s=>{const i=s.durationMs/1e3,o=Yt(s.midi,"midi").toFrequency(),a=window.setTimeout(()=>{this.synth&&(console.log(`[ReferenceAudio] Playing ${s.midi} at ${performance.now()-this.startTime}ms`),this._isPlaying=!0,this.synth.triggerAttackRelease(o,i))},s.startTimeMs),r=window.setTimeout(()=>{this._isPlaying=!1},s.startTimeMs+s.durationMs);this.scheduledTimeouts.push(a,r)}),console.log(`[ReferenceAudio] Scheduled ${t.length} reference tones`)}playTone(t,s){if(!this.synth){console.warn("[ReferenceAudio] Synth not initialized");return}const i=Yt(t,"midi").toFrequency(),o=s/1e3;this.synth.triggerAttackRelease(i,o)}clearScheduled(){this.scheduledTimeouts.forEach(t=>{window.clearTimeout(t)}),this.scheduledTimeouts=[]}stop(){this.clearScheduled(),this.synth&&this.synth.triggerRelease()}dispose(){this.stop(),this.synth&&(this.synth.dispose(),this.synth=null),this.volume&&(this.volume.dispose(),this.volume=null)}}const Ye=new Oi,We={FFT_SIZE:2048,CLARITY_THRESHOLD:.8,MIN_PITCH_HZ:60,MAX_PITCH_HZ:1600,HIGHLIGHT_CENTS_RANGE:50};let Oe=null,Be=null,dt=null,Le=null,ft=!1;const Dt=1;function Bi(e){return 12*Math.log2(e/440)+69}function Ht(){if(!ft||!Be||!dt){Le=null;return}if(Ye.isPlaying){de.addHistoryPoint({frequency:0,midi:0,time:performance.now(),clarity:0}),Le=requestAnimationFrame(Ht);return}const e=Be.getValue(),[t,s]=dt.findPitch(e,Yn().sampleRate),i=t!==null&&s>We.CLARITY_THRESHOLD&&t>We.MIN_PITCH_HZ&&t<We.MAX_PITCH_HZ;if(i){const o=Bi(t),a={frequency:t,midi:o,clarity:s,pitchClass:Math.round(o)%12};de.setCurrentPitch(a),de.addHistoryPoint({frequency:t,midi:o,time:performance.now(),clarity:s}),fe.recordPitchInput(o,s)}else de.addHistoryPoint({frequency:0,midi:0,time:performance.now(),clarity:0});if(i&&de.state.currentPitch){const o=de.state.currentPitch.midi,a=yi(o),r=pi(o),c=Math.min(Math.abs(r),We.HIGHLIGHT_CENTS_RANGE),l=Math.max(0,1-c/We.HIGHLIGHT_CENTS_RANGE);de.setStablePitch({pitchClass:bi(a),opacity:l,size:Dt})}else de.setStablePitch({pitchClass:null,opacity:0,size:Dt});Le=requestAnimationFrame(Ht)}async function qi(){if(!ft){Le!==null&&cancelAnimationFrame(Le),Oe=new je,Be=new Vn("waveform",We.FFT_SIZE),dt=Qe.forFloat32Array(Be.size);try{await kt(),await Oe.open(),Oe.connect(Be),ft=!0,Ht()}catch(e){throw console.error("Microphone access denied or failed:",e),kn(),e}}}function zi(){ft=!1,kn()}function kn(){Le!==null&&(cancelAnimationFrame(Le),Le=null),Oe&&(Oe.close(),Oe=null),Be=null,dt=null,de.setStablePitch({pitchClass:null,opacity:0,size:Dt}),de.setCurrentPitch(null)}Se(["click"]);let Re=null,$e=!1,et=null;function Gi(){var e;if(!Re){Re=new jn(bn,{oscillator:{type:"sawtooth"},envelope:{attack:.3,decay:.1,sustain:.8,release:.5}}).toDestination();const t=((e=Re.get().oscillator)==null?void 0:e.type)??"unknown";console.log("[DroneAudio] Initialized drone synth",{oscillatorType:t})}return Re}function Ln(e,t){return`${e.replace("b","#").replace("Db","C#").replace("Eb","D#").replace("Gb","F#").replace("Ab","G#").replace("Bb","A#")}${t}`}async function Vi(){await kt();const e=Gi(),t=Ln(Z.state.tonic,Z.state.drone.octave);e.volume.value=Z.state.drone.volume,console.log("[DroneAudio] Starting drone",{note:t,volume:e.volume.value}),et&&e.releaseAll(),et=t,e.triggerAttack(t),$e=!0}function Yi(){Re&&$e&&(Re.releaseAll(),et=null,$e=!1)}function xt(){if(!$e||!Re)return;const e=Ln(Z.state.tonic,Z.state.drone.octave);Re.volume.value=Z.state.drone.volume,console.log("[DroneAudio] Updating drone",{note:e,volume:Re.volume.value}),e!==et&&(Re.releaseAll(),Re.triggerAttack(e),et=e)}async function Xi(){$e?Yi():await Vi()}var Ui=E("<option> </option>"),ji=E('<div class="tonic-selector svelte-16h7our"><label for="tonic-select" class="svelte-16h7our">Key:</label> <select id="tonic-select" class="svelte-16h7our"></select></div>');function Ji(e,t){Te(t,!0);const s=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function i(c){const l=c.target;Z.setTonic(l.value),xt()}var o=ji(),a=P(b(o),2);a.__change=i,nt(a,21,()=>s,ht,(c,l)=>{var u=Ui(),f=b(u),h={};ne(()=>{Y(f,n(l)),h!==(h=n(l))&&(u.value=(u.__value=n(l))??"")}),k(c,u)});var r;Tn(a),ne(()=>{r!==(r=Z.state.tonic)&&(a.value=(a.__value=Z.state.tonic)??"",Et(a,Z.state.tonic))}),k(e,o),Pe()}Se(["change"]);var Zi=E("<option> </option>"),Qi=E('<div class="drone-controls svelte-1rkr6nv"><button> </button> <div class="drone-settings svelte-1rkr6nv"><label class="svelte-1rkr6nv">Oct: <select class="svelte-1rkr6nv"></select></label> <label class="svelte-1rkr6nv">Vol: <input type="range" min="-40" max="0" class="svelte-1rkr6nv"/></label></div></div>');function Ki(e,t){Te(t,!0);const s=[2,3,4,5];async function i(){await Xi(),Z.toggleDrone()}function o(g){const y=g.target;Z.setDroneOctave(parseInt(y.value,10)),xt()}function a(g){const y=g.target;Z.setDroneVolume(parseInt(y.value,10)),xt()}var r=Qi(),c=b(r);let l;c.__click=i;var u=b(c),f=P(c,2),h=b(f),m=P(b(h));m.__change=o,nt(m,21,()=>s,ht,(g,y)=>{var _=Zi(),w=b(_),I={};ne(()=>{Y(w,n(y)),I!==(I=n(y))&&(_.value=(_.__value=n(y))??"")}),k(g,_)});var p;Tn(m);var v=P(h,2),d=P(b(v));d.__input=a,ne(()=>{l=tt(c,1,"drone-toggle svelte-1rkr6nv",null,l,{active:Z.state.drone.isPlaying}),Y(u,Z.state.drone.isPlaying?"Drone On":"Drone Off"),p!==(p=Z.state.drone.octave)&&(m.value=(m.__value=Z.state.drone.octave)??"",Et(m,Z.state.drone.octave)),ws(d,Z.state.drone.volume)}),k(e,r),Pe()}Se(["click","change","input"]);Se(["click"]);var $i=E('<div class="range-control svelte-1es7ond"><h3 class="control-title svelte-1es7ond">Pitch Range</h3> <!></div>');function ea(e,t){Te(t,!0);function s(l){const u=Ut.findIndex(f=>f.midi===l);return u>=0?u:0}const i=D(()=>s(Z.state.yAxisRange.maxMidi)),o=D(()=>s(Z.state.yAxisRange.minMidi));function a(l){const u=l.bottomPitch.midi??21,f=l.topPitch.midi??108;Z.setYAxisRange({minMidi:u,maxMidi:f})}var r=$i(),c=P(b(r),2);Ai(c,{get fullRowData(){return Ut},get topIndex(){return n(i)},get bottomIndex(){return n(o)},minSpan:7,onrangechange:a,showSummary:!0,wheelHeight:200}),k(e,r),Pe()}var ta=E('<div class="pitch-highlight-toggle svelte-e7pwl1"><span class="toggle-label svelte-e7pwl1">Pitch Highlight</span> <button> </button></div>');function na(e,t){Te(t,!0);function s(){Z.togglePitchHighlight()}var i=ta(),o=P(b(i),2);let a;o.__click=s;var r=b(o);ne(()=>{a=tt(o,1,"toggle-button svelte-e7pwl1",null,a,{active:Z.state.pitchHighlightEnabled}),Y(r,Z.state.pitchHighlightEnabled?"On":"Off")}),k(e,i),Pe()}Se(["click"]);var sa=E('<button class="start-exercise-btn svelte-118f0cc">Start Demo Exercise</button>'),ia=E('<button class="stop-exercise-btn svelte-118f0cc">Stop Exercise</button> <div class="progress-indicator svelte-118f0cc"> </div> <div class="phase-indicator svelte-118f0cc"> </div>',1),aa=E('<div><span class="result-loop svelte-118f0cc"></span> <span class="result-pitch svelte-118f0cc"> </span> <span class="result-accuracy svelte-118f0cc"> </span> <span class="result-status svelte-118f0cc"> </span></div>'),oa=E('<div class="exercise-results svelte-118f0cc"><h4 class="results-title svelte-118f0cc">Results</h4> <div class="results-summary svelte-118f0cc"><div class="stat svelte-118f0cc"><span class="stat-label svelte-118f0cc">Average Accuracy:</span> <span class="stat-value svelte-118f0cc"> </span></div> <div class="stat svelte-118f0cc"><span class="stat-label svelte-118f0cc">Hits:</span> <span class="stat-value svelte-118f0cc"> </span></div></div> <details class="results-details svelte-118f0cc"><summary class="results-summary-label svelte-118f0cc">Detailed Results</summary> <div class="results-list svelte-118f0cc"></div></details></div>'),ra=E('<div class="demo-exercise-panel svelte-118f0cc"><h3 class="panel-title svelte-118f0cc">Demo Exercise</h3> <details class="settings-details svelte-118f0cc"><summary class="settings-summary svelte-118f0cc">Settings</summary> <div class="exercise-settings svelte-118f0cc"><label class="setting-label svelte-118f0cc"><span class="label-text svelte-118f0cc">Number of loops:</span> <input class="setting-input svelte-118f0cc" type="number" min="1" max="20"/></label> <label class="setting-label svelte-118f0cc"><span class="label-text svelte-118f0cc">Tempo (BPM):</span> <input class="setting-input svelte-118f0cc" type="number" min="60" max="180"/></label> <label class="setting-label svelte-118f0cc"><span class="label-text svelte-118f0cc">Reference Volume:</span> <input class="setting-slider svelte-118f0cc" type="range" min="-40" max="0"/> <span class="volume-value svelte-118f0cc"> </span></label> <div class="pitch-range-buttons svelte-118f0cc"><button class="range-btn svelte-118f0cc">Use Current Range</button> <button class="range-btn svelte-118f0cc">Use Full Range</button></div></div></details> <div class="exercise-controls svelte-118f0cc"><!></div> <!></div>');function la(e,t){Te(t,!0);let s=K(!1),i=K(5),o=K(108),a=K(-12);const r=D(()=>we.state.isActive),c=D(()=>we.state.isPlaying),l=D(()=>we.state.currentPhase),u=D(()=>we.getCurrentProgress()),f=D(()=>we.getResults()),h=D(()=>n(f).length>0),m=D(()=>we.getAverageAccuracy()),p=D(()=>we.getHitCount()),v=D(()=>n(f).length);Ne(()=>{if(!n(r)||!n(c))return;const N=fe.state.currentTimeMs;we.updatePhase(N)}),Ne(()=>{if(!n(r))return;const N=fe.getPerformanceResults();we.getGeneratedNotes().forEach((V,te)=>{if(V.lyric!=="🎤")return;const ce=`target-${te}`,ue=N.get(ce);if(ue&&!we.hasResultForLoop(Math.floor(te/2))){const me=d(ue);we.addResult({loopIndex:Math.floor(te/2),targetPitch:V.midi,accuracy:me,performance:ue})}})});function d(N){return N.hitStatus==="hit"?N.pitchAccuracyCents!==void 0?Math.max(0,100-Math.abs(N.pitchAccuracyCents)/50*100):100:0}qe(()=>{n(r)&&w()});function g(){const N=Z.state.yAxisRange;we.setPitchRange(N.minMidi,N.maxMidi)}function y(){we.setPitchRange(21,108)}async function _(){Z.setVisualizationMode("highway"),we.configure({numLoops:n(i),tempo:n(o),referenceVolume:n(a)}),g(),await Ye.init(),Ye.setVolume(n(a)),we.start();const N=we.getGeneratedNotes();fe.setTargetNotes(N),fe.start(),we.setPlaying(!0);const V=N.filter(te=>te.lyric==="👂");Ye.scheduleReferenceTones(V)}function w(){Ye.stop(),fe.stop(),we.stop()}function I(N){switch(N){case"reference":return"👂 Listen";case"input":return"🎤 Sing";default:return"Rest"}}function C(N){const V=Jn(N);return V?.pitch||`MIDI ${N}`}var M=ra(),S=P(b(M),2),H=P(b(S),2),R=b(H),x=P(b(R),2),J=P(R,2),z=P(b(J),2),$=P(J,2),Q=P(b($),2),A=P(Q,2),O=b(A),U=P($,2),ie=b(U);ie.__click=g;var ve=P(ie,2);ve.__click=y;var ye=P(S,2),Me=b(ye);{var j=N=>{var V=sa();V.__click=_,k(N,V)},X=N=>{var V=ia(),te=Ke(V);te.__click=w;var ce=P(te,2),ue=b(ce),me=P(ce,2),he=b(me);ne(q=>{Y(ue,`Loop ${n(u).current??""} / ${n(u).total??""}`),Y(he,q)},[()=>I(n(l))]),k(N,V)};le(Me,N=>{n(r)?N(X,!1):N(j)})}var ee=P(ye,2);{var L=N=>{var V=oa(),te=P(b(V),2),ce=b(te),ue=P(b(ce),2),me=b(ue),he=P(ce,2),q=P(b(he),2),se=b(q),T=P(te,2),F=P(b(T),2);nt(F,21,()=>n(f),ht,(W,ae,ge)=>{var be=aa();let oe;var Ce=b(be);Ce.textContent=`Loop ${ge+1}:`;var re=P(Ce,2),De=b(re),He=P(re,2),Fe=b(He),gt=P(He,2),vt=b(gt);ne((mt,pt)=>{var st,it;oe=tt(be,1,"result-item svelte-118f0cc",null,oe,{hit:((st=n(ae).performance)==null?void 0:st.hitStatus)==="hit"}),Y(De,mt),Y(Fe,`${pt??""}%`),Y(vt,((it=n(ae).performance)==null?void 0:it.hitStatus)==="hit"?"✓":"✗")},[()=>C(n(ae).targetPitch),()=>n(ae).accuracy.toFixed(0)]),k(W,be)}),ne(W=>{Y(me,`${W??""}%`),Y(se,`${n(p)??""}/${n(v)??""}`)},[()=>n(m).toFixed(1)]),k(N,V)};le(ee,N=>{n(h)&&!n(r)&&N(L)})}ne(()=>{x.disabled=n(r),z.disabled=n(r),Q.disabled=n(r),Y(O,`${n(a)??""} dB`),ie.disabled=n(r),ve.disabled=n(r)}),wt(x,()=>n(i),N=>B(i,N)),wt(z,()=>n(o),N=>B(o,N)),wt(Q,()=>n(a),N=>B(a,N)),Pn("open","toggle",S,N=>B(s,N),()=>n(s)),k(e,M),Pe()}Se(["click"]);const ca=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,/^([a-zA-Z0-9_-]{11})$/],ua={gapMs:0,videoGapSec:0,manualOffsetSec:0},Ot=60;function da(e){try{const t=e.split(/\r?\n/).map(r=>r.trim()),s=fa(t);if(!s.bpm)return{success:!1,error:"Missing required #BPM tag"};const{notes:i,lineBreaks:o,totalBeats:a}=ha(t);return i.length===0?{success:!1,error:"No valid notes found in file"}:{success:!0,song:{metadata:s,notes:i,lineBreaks:o,totalBeats:a}}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Unknown parsing error"}}}function fa(e){const t={};for(const s of e){if(!s.startsWith("#"))continue;const i=s.indexOf(":");if(i===-1)continue;const o=s.slice(1,i).toUpperCase().trim(),a=s.slice(i+1).trim();switch(o){case"TITLE":t.title=a;break;case"ARTIST":t.artist=a;break;case"VIDEO":t.video=a;break;case"VIDEOGAP":t.videoGap=parseFloat(a.replace(",","."))||0;break;case"GAP":t.gap=parseFloat(a.replace(",","."))||0;break;case"BPM":t.bpm=parseFloat(a.replace(",","."))||0;break;case"MP3":case"AUDIO":t.mp3=a;break;case"LANGUAGE":t.language=a;break;case"GENRE":t.genre=a;break;case"YEAR":t.year=parseInt(a)||void 0;break;case"CREATOR":t.creator=a;break;case"COVER":t.cover=a;break;case"BACKGROUND":t.background=a;break;case"PREVIEWSTART":t.previewStart=parseFloat(a.replace(",","."))||0;break}}return{title:t.title||"Unknown Title",artist:t.artist||"Unknown Artist",bpm:t.bpm||0,...t}}function ha(e){const t=[],s=[];let i=0;for(const o of e){if(o.length===0||o.startsWith("#"))continue;const a=o[0];if(a==="E")break;if(a==="-"){const r=o.slice(1).trim().split(/\s+/),c=parseInt(r[0])||0;s.push(c);continue}if([":","*","F","R"].includes(a)){const r=ga(o);if(r){t.push(r);const c=r.startBeat+r.duration;c>i&&(i=c)}}}return{notes:t,lineBreaks:s,totalBeats:i}}function ga(e){const t=e[0],s=e.slice(1).trim().split(/\s+/);if(s.length<3)return null;const i=parseInt(s[0]),o=parseInt(s[1]),a=parseInt(s[2]),r=s.slice(3).join(" ")||"";return isNaN(i)||isNaN(o)||isNaN(a)?null:{type:t,startBeat:i,duration:o,pitch:a,lyric:r}}function va(e){if(!e)return null;const t=e.trim();for(const s of ca){const i=t.match(s);if(i&&i[1])return i[1]}return null}function fn(e,t=Ot){const{metadata:s,notes:i,lineBreaks:o}=e,{bpm:a}=s,r=60/a*1e3*4;let c=0;const l=[...o].sort((f,h)=>f-h),u=i.length>0?Math.min(...i.map(f=>f.startBeat)):0;return i.filter(f=>f.type!=="F").map(f=>{const h=(f.startBeat-u)*r,m=f.duration*r,p=t+f.pitch;for(;c<l.length&&f.startBeat>=l[c];)c++;const v={midi:p,startTimeMs:h,durationMs:m,lyric:f.lyric.trim()||void 0};return f.type==="*"&&(v.isGolden=!0),v})}function ma(e){return{gapMs:e.gap||0,videoGapSec:e.videoGap||0,manualOffsetSec:0}}function pa(e){const{metadata:t,notes:s,totalBeats:i}=e,{bpm:o}=t,a=60/o*1e3*4,r=s.length>0?Math.min(...s.map(c=>c.startBeat)):0;return(i-r)*a+2e3}function hn(e,t=Ot){const s=e.notes.filter(a=>a.type!=="F"&&a.type!=="-").map(a=>t+a.pitch);if(s.length===0)return{minMidi:48,maxMidi:72};const i=Math.min(...s),o=Math.max(...s);return{minMidi:Math.max(24,i-3),maxMidi:Math.min(108,o+3)}}const gn={isActive:!1,isLoading:!1,isPlaying:!1,song:null,targetNotes:[],youtubeId:null,syncConfig:{...ua},baseMidi:Ot,totalDurationMs:0,detectedRange:{minMidi:48,maxMidi:72},error:null};function ya(){let e=K(ke({...gn})),t=null;return{get state(){return n(e)},async loadFile(s){n(e).isLoading=!0,n(e).error=null;try{const i=await s.text(),o=da(i);if(!o.success)return n(e).error=o.error,n(e).isLoading=!1,!1;const a=o.song,r=a.metadata.video?va(a.metadata.video):null,c=ma(a.metadata),l=fn(a,n(e).baseMidi),u=pa(a),f=hn(a,n(e).baseMidi);return n(e).song=a,n(e).youtubeId=r,n(e).syncConfig=c,n(e).targetNotes=l,n(e).totalDurationMs=u,n(e).detectedRange=f,n(e).isActive=!0,n(e).isLoading=!1,!0}catch(i){return n(e).error=i instanceof Error?i.message:"Failed to load file",n(e).isLoading=!1,!1}},get youtubeOffset(){const{gapMs:s,videoGapSec:i,manualOffsetSec:o}=n(e).syncConfig;return s/1e3+i+o},adjustOffset(s){n(e).syncConfig={...n(e).syncConfig,manualOffsetSec:n(e).syncConfig.manualOffsetSec+s}},setManualOffset(s){n(e).syncConfig={...n(e).syncConfig,manualOffsetSec:s}},resetOffset(){n(e).syncConfig={...n(e).syncConfig,manualOffsetSec:0}},setBaseMidi(s){n(e).baseMidi=s,n(e).song&&(n(e).targetNotes=fn(n(e).song,s),n(e).detectedRange=hn(n(e).song,s))},setPlaying(s){n(e).isPlaying=s},onComplete(s){t=s},triggerComplete(){n(e).isPlaying=!1,t&&t()},checkCompletion(s){return!n(e).isPlaying||!n(e).isActive?!1:s>=n(e).totalDurationMs-500?(this.triggerComplete(),!0):!1},get title(){var s;return((s=n(e).song)==null?void 0:s.metadata.title)||""},get artist(){var s;return((s=n(e).song)==null?void 0:s.metadata.artist)||""},get hasVideo(){return n(e).youtubeId!==null},reset(){B(e,{...gn},!0),t=null},unload(){n(e).isActive=!1,n(e).isPlaying=!1,n(e).song=null,n(e).targetNotes=[],n(e).youtubeId=null,n(e).totalDurationMs=0,n(e).error=null}}}const G=ya();let At=null,Xe=!1;function ba(){return At||(Xe&&window.YT&&window.YT.Player?Promise.resolve():(At=new Promise((e,t)=>{if(window.YT&&window.YT.Player){Xe=!0,e();return}window.onYouTubeIframeAPIReady=()=>{Xe=!0,e()};const s=document.createElement("script");s.src="https://www.youtube.com/iframe_api",s.async=!0,s.onerror=()=>{t(new Error("Failed to load YouTube IFrame API"))},document.head.appendChild(s),setTimeout(()=>{Xe||t(new Error("YouTube IFrame API load timeout"))},1e4)}),At))}function wa(e,t,s={}){var i;if(!Xe||!((i=window.YT)!=null&&i.Player))throw new Error("YouTube API not loaded. Call loadYouTubeAPI() first.");const{width:o=320,height:a=180,onReady:r,onStateChange:c,onError:l}=s;return new window.YT.Player(e,{width:o,height:a,videoId:t,playerVars:{autoplay:0,controls:1,disablekb:1,enablejsapi:1,fs:0,modestbranding:1,origin:window.location.origin,playsinline:1,rel:0},events:{onReady:u=>{r?.(u.target)},onStateChange:u=>{c?.(u.data)},onError:u=>{l?.(u.data)}}})}function Ma(e){switch(e){case YT.PlayerError.InvalidParam:return"Invalid video ID";case YT.PlayerError.Html5Error:return"HTML5 player error";case YT.PlayerError.VideoNotFound:return"Video not found";case YT.PlayerError.NotAllowedEmbedded:case YT.PlayerError.NotAllowedEmbedded2:return"Video cannot be embedded";default:return"Unknown player error"}}const It={isApiLoaded:!1,isApiLoading:!1,isPlayerReady:!1,isPlaying:!1,currentTime:0,duration:0,videoId:null,error:null,isEmbeddable:!0,volume:100,isMuted:!1};function _a(){let e=K(ke({...It})),t=null,s=null,i=null;return{get state(){return n(e)},async initAPI(){if(n(e).isApiLoaded)return!0;if(n(e).isApiLoading)return!1;n(e).isApiLoading=!0,n(e).error=null;try{return await ba(),n(e).isApiLoaded=!0,n(e).isApiLoading=!1,!0}catch(o){return n(e).error=o instanceof Error?o.message:"Failed to load YouTube API",n(e).isApiLoading=!1,!1}},async loadVideo(o,a){if(!n(e).isApiLoaded&&!await this.initAPI())return!1;if(t){try{t.destroy()}catch{}t=null}return n(e).isPlayerReady=!1,n(e).error=null,n(e).isEmbeddable=!0,n(e).videoId=o,new Promise(r=>{try{t=wa(a,o,{onReady:c=>{n(e).isPlayerReady=!0,n(e).duration=c.getDuration(),n(e).volume=c.getVolume(),n(e).isMuted=c.isMuted(),r(!0)},onStateChange:c=>{n(e).isPlaying=c===YT.PlayerState.PLAYING,c===YT.PlayerState.ENDED&&(n(e).isPlaying=!1,this.stopSyncLoop())},onError:c=>{n(e).error=Ma(c),n(e).isEmbeddable=c!==YT.PlayerError.NotAllowedEmbedded&&c!==YT.PlayerError.NotAllowedEmbedded2,n(e).isPlayerReady=!1,r(!1)}})}catch(c){n(e).error=c instanceof Error?c.message:"Failed to create player",r(!1)}})},play(){t&&n(e).isPlayerReady&&t.playVideo()},pause(){t&&n(e).isPlayerReady&&t.pauseVideo()},stop(){t&&n(e).isPlayerReady&&(t.stopVideo(),n(e).isPlaying=!1),this.stopSyncLoop()},seekTo(o){t&&n(e).isPlayerReady&&(t.seekTo(Math.max(0,o),!0),n(e).currentTime=Math.max(0,o))},getCurrentTime(){return t&&n(e).isPlayerReady?t.getCurrentTime():n(e).currentTime},setVolume(o){const a=Math.max(0,Math.min(100,o));t&&n(e).isPlayerReady&&t.setVolume(a),n(e).volume=a},mute(){t&&n(e).isPlayerReady&&t.mute(),n(e).isMuted=!0},unmute(){t&&n(e).isPlayerReady&&t.unMute(),n(e).isMuted=!1},toggleMute(){n(e).isMuted?this.unmute():this.mute()},startSyncLoop(o,a=250){i=o,s!==null&&clearInterval(s),s=window.setInterval(()=>{if(t&&n(e).isPlayerReady&&n(e).isPlaying){const r=t.getCurrentTime();n(e).currentTime=r,i?.(r)}},a)},stopSyncLoop(){s!==null&&(clearInterval(s),s=null),i=null},correctDrift(o,a=150){if(!t||!n(e).isPlayerReady||!n(e).isPlaying)return!1;const r=t.getCurrentTime();return Math.abs(r-o)*1e3>a?(t.seekTo(o,!0),!0):!1},getVideoUrl(){return n(e).videoId?`https://www.youtube.com/watch?v=${n(e).videoId}`:null},dispose(){if(this.stopSyncLoop(),t){try{t.destroy()}catch{}t=null}B(e,{...It,isApiLoaded:n(e).isApiLoaded},!0)},reset(){this.dispose(),B(e,{...It},!0)}}}const _e=_a();function Ta(e){let t={...e.syncConfig};const s=e.driftCheckIntervalMs??250,i=e.maxDriftMs??150;function o(){return t.gapMs/1e3+t.videoGapSec+t.manualOffsetSec}function a(d){return d/1e3+o()}function r(d){return(d-o())*1e3}function c(d,g){const y=a(d),_=g-y,w=Math.abs(_*1e3);if(w>i){const I=r(g);return{driftMs:w,needsCorrection:!0,correctedTransportTimeMs:I}}return{driftMs:w,needsCorrection:!1}}function l(d){t={...t,...d}}function u(d){t.manualOffsetSec+=d}function f(){t.manualOffsetSec=0}function h(){return t.manualOffsetSec}function m(){return o()}function p(){const d=t.manualOffsetSec;return`${d>=0?"+":""}${d.toFixed(2)}s`}function v(){return{intervalMs:s,maxDriftMs:i}}return{getYouTubeOffset:o,getTotalOffset:m,getManualOffset:h,getSyncLoopConfig:v,transportToYouTube:a,youTubeToTransport:r,checkDrift:c,updateConfig:l,adjustManualOffset:u,resetManualOffset:f,formatOffset:p,getConfig:()=>({...t})}}var Pa=E('<div class="youtube-loading svelte-10347yi"><div class="spinner svelte-10347yi"></div> <span>Loading video...</span></div>'),Ca=E('<button class="fallback-btn svelte-10347yi">Open on YouTube ↗</button>'),Sa=E('<div class="youtube-error svelte-10347yi"><span class="error-icon svelte-10347yi">⚠️</span> <span class="error-message svelte-10347yi"> </span> <!></div>'),Aa=E('<div class="youtube-placeholder svelte-10347yi"><span class="placeholder-icon svelte-10347yi">🎬</span> <span class="placeholder-text svelte-10347yi">No video loaded</span></div>'),Ia=E('<div class="youtube-container svelte-10347yi"><div class="youtube-player svelte-10347yi"></div> <!> <!> <!></div>');function Ra(e,t){Te(t,!0);const s=`youtube-player-${Math.random().toString(36).slice(2,9)}`,i=D(()=>_e.state.isApiLoading||_e.state.videoId&&!_e.state.isPlayerReady),o=D(()=>!!_e.state.error),a=D(()=>_e.state.isEmbeddable),r=D(()=>G.state.youtubeId);Ne(()=>{n(r)&&_e.loadVideo(n(r),s)}),qe(()=>{_e.dispose()});function c(){const g=_e.getVideoUrl();g&&window.open(g,"_blank","noopener,noreferrer")}var l=Ia(),u=b(l),f=P(u,2);{var h=g=>{var y=Pa();k(g,y)};le(f,g=>{n(i)&&n(r)&&g(h)})}var m=P(f,2);{var p=g=>{var y=Sa(),_=P(b(y),2),w=b(_),I=P(_,2);{var C=M=>{var S=Ca();S.__click=c,k(M,S)};le(I,M=>{n(a)||M(C)})}ne(()=>Y(w,_e.state.error)),k(g,y)};le(m,g=>{n(o)&&g(p)})}var v=P(m,2);{var d=g=>{var y=Aa();k(g,y)};le(v,g=>{!n(r)&&!n(i)&&!n(o)&&g(d)})}ne(()=>Ee(u,"id",s)),k(e,l),Pe()}Se(["click"]);var Na=E('<div class="sync-controls svelte-1yzfvpa"><div class="sync-header svelte-1yzfvpa"><span class="sync-label svelte-1yzfvpa">Sync Offset</span> <span class="sync-value svelte-1yzfvpa"> </span></div> <div class="sync-buttons svelte-1yzfvpa"><button class="sync-btn coarse svelte-1yzfvpa" title="Earlier by 0.1s">-0.1s</button> <button class="sync-btn fine svelte-1yzfvpa" title="Earlier by 0.01s">-0.01s</button> <button class="sync-btn reset svelte-1yzfvpa" title="Reset offset">0</button> <button class="sync-btn fine svelte-1yzfvpa" title="Later by 0.01s">+0.01s</button> <button class="sync-btn coarse svelte-1yzfvpa" title="Later by 0.1s">+0.1s</button></div> <div class="sync-hint svelte-1yzfvpa">Use arrow keys to adjust (Shift for coarse)</div></div>');function Da(e,t){Te(t,!0);const s=D(()=>G.state.syncConfig.manualOffsetSec),i=D(()=>G.state.isActive);function o(_){return`${_>=0?"+":""}${_.toFixed(2)}s`}function a(_){G.adjustOffset(_)}function r(){G.resetOffset()}function c(_){if(n(i)&&!(_.target instanceof HTMLInputElement))switch(_.key){case"ArrowLeft":_.preventDefault(),a(_.shiftKey?-.1:-.01);break;case"ArrowRight":_.preventDefault(),a(_.shiftKey?.1:.01);break}}var l=Na();Ue("keydown",_n,c);var u=b(l),f=P(b(u),2),h=b(f),m=P(u,2),p=b(m);p.__click=()=>a(-.1);var v=P(p,2);v.__click=()=>a(-.01);var d=P(v,2);d.__click=r;var g=P(d,2);g.__click=()=>a(.01);var y=P(g,2);y.__click=()=>a(.1),ne(_=>{Y(h,_),p.disabled=!n(i),v.disabled=!n(i),d.disabled=!n(i)||n(s)===0,g.disabled=!n(i),y.disabled=!n(i)},[()=>o(n(s))]),k(e,l),Pe()}Se(["click"]);var Ha=E('<span class="spinner svelte-183tp03"></span> Loading...',1),xa=E('<div class="error-message svelte-183tp03"> </div>'),ka=E('<button class="upload-btn svelte-183tp03"><!></button> <!>',1),La=E('<div class="video-section svelte-183tp03"><!> <!></div>'),Fa=E('<button class="play-btn svelte-183tp03">▶ Play</button>'),Ea=E('<button class="stop-btn svelte-183tp03">⏹ Stop</button>'),Wa=E('<div class="progress-info svelte-183tp03"><span class="time-display svelte-183tp03"> </span></div>'),Oa=E('<div class="song-info svelte-183tp03"><div class="song-title svelte-183tp03"> </div> <div class="song-artist svelte-183tp03"> </div></div> <!> <div class="playback-controls svelte-183tp03"><!> <button class="unload-btn svelte-183tp03">Unload</button></div> <!>',1),Ba=E('<div class="ultrastar-panel svelte-183tp03"><h3 class="panel-title svelte-183tp03">Ultrastar Song</h3> <input type="file" accept=".txt" style="display: none;"/> <!></div>');function qa(e,t){Te(t,!0);let s=null,i;const o=D(()=>G.state.isActive),a=D(()=>G.state.isLoading),r=D(()=>G.state.isPlaying),c=D(()=>G.hasVideo),l=D(()=>G.title),u=D(()=>G.artist),f=D(()=>G.state.error);async function h(S){var H,R,x,J;const z=S.target,$=(H=z.files)==null?void 0:H[0];if($){if(await G.loadFile($)){s=Ta({syncConfig:G.state.syncConfig});const Q=G.state.detectedRange;Z.setYAxisRange({minMidi:Q.minMidi,maxMidi:Q.maxMidi}),fe.setTargetNotes(G.state.targetNotes),console.log("[Ultrastar] File loaded:",{title:G.title,artist:G.artist,youtubeId:G.state.youtubeId,bpm:(R=G.state.song)==null?void 0:R.metadata.bpm,gap:(x=G.state.song)==null?void 0:x.metadata.gap,videoGap:(J=G.state.song)==null?void 0:J.metadata.videoGap,noteCount:G.state.targetNotes.length,firstNotes:G.state.targetNotes.slice(0,3),lastNotes:G.state.targetNotes.slice(-3),totalDurationMs:G.state.totalDurationMs,pitchRange:Q,syncConfig:G.state.syncConfig})}z.value=""}}async function m(){if(n(o))if(Z.setVisualizationMode("highway"),s&&s.updateConfig(G.state.syncConfig),fe.setTargetNotes(G.state.targetNotes),G.setPlaying(!0),n(c)&&_e.state.isPlayerReady){const S=s?.getYouTubeOffset()??0;console.log("[Ultrastar] Starting playback:",{youtubeOffset:S,noteCount:G.state.targetNotes.length,firstNote:G.state.targetNotes[0],syncConfig:G.state.syncConfig}),fe.setCurrentTime(0),_e.seekTo(S),_e.play(),d()}else fe.start()}function p(){fe.stop(),G.setPlaying(!1),_e.pause(),g()}function v(){p(),G.unload(),_e.dispose(),fe.reset(),s=null}function d(){_e.startSyncLoop(S=>{if(!s)return;const H=s.youTubeToTransport(S),R=fe.state.currentTimeMs;Math.abs(H-R)>50&&fe.setCurrentTime(Math.max(0,H))},100)}function g(){_e.stopSyncLoop()}function y(){i?.click()}qe(()=>{g(),_e.dispose()});var _=Ba(),w=P(b(_),2);w.__change=h,xe(w,S=>i=S,()=>i);var I=P(w,2);{var C=S=>{var H=ka(),R=Ke(H);R.__click=y;var x=b(R);{var J=A=>{var O=Ha();k(A,O)},z=A=>{var O=_s("Upload Ultrastar .txt");k(A,O)};le(x,A=>{n(a)?A(J):A(z,!1)})}var $=P(R,2);{var Q=A=>{var O=xa(),U=b(O);ne(()=>Y(U,n(f))),k(A,O)};le($,A=>{n(f)&&A(Q)})}ne(()=>R.disabled=n(a)),k(S,H)},M=S=>{var H=Oa(),R=Ke(H),x=b(R),J=b(x),z=P(x,2),$=b(z),Q=P(R,2);{var A=X=>{var ee=La(),L=b(ee);Ra(L,{});var N=P(L,2);Da(N,{}),k(X,ee)};le(Q,X=>{n(c)&&X(A)})}var O=P(Q,2),U=b(O);{var ie=X=>{var ee=Fa();ee.__click=m,k(X,ee)},ve=X=>{var ee=Ea();ee.__click=p,k(X,ee)};le(U,X=>{n(r)?X(ve,!1):X(ie)})}var ye=P(U,2);ye.__click=v;var Me=P(O,2);{var j=X=>{var ee=Wa(),L=b(ee),N=b(L);ne((V,te)=>Y(N,`${V??""}s
          / ${te??""}s`),[()=>Math.floor(fe.state.currentTimeMs/1e3),()=>Math.floor(G.state.totalDurationMs/1e3)]),k(X,ee)};le(Me,X=>{n(r)&&X(j)})}ne(()=>{Y(J,n(l)),Y($,n(u)),ye.disabled=n(r)}),k(S,H)};le(I,S=>{n(o)?S(M,!1):S(C)})}k(e,_),Pe()}Se(["change","click"]);var za=E('<div class="note-display svelte-1hjl33a"><span class="note-name svelte-1hjl33a"> </span> <span class="octave svelte-1hjl33a"> </span></div> <div class="details svelte-1hjl33a"><span class="frequency"> </span> <span> </span> <span class="clarity"> </span></div>',1),Ga=E('<div class="no-pitch svelte-1hjl33a"><span class="placeholder svelte-1hjl33a">---</span> <span class="hint svelte-1hjl33a">Sing or hum into the microphone</span></div>'),Va=E('<div class="pitch-readout svelte-1hjl33a"><!></div>');function Ya(e,t){Te(t,!0);const s=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],i=D(()=>()=>{const l=de.state.currentPitch;if(!l)return null;const u=s[l.pitchClass],f=Math.floor(l.midi/12)-1,h=Math.round((l.midi-Math.round(l.midi))*100);return{name:u,octave:f,frequency:l.frequency.toFixed(1),cents:h,clarity:Math.round(l.clarity*100)}});var o=Va(),a=b(o);{var r=l=>{const u=D(()=>n(i)());var f=za(),h=Ke(f),m=b(h),p=b(m),v=P(m,2),d=b(v),g=P(h,2),y=b(g),_=b(y),w=P(y,2);let I;var C=b(w),M=P(w,2),S=b(M);ne(()=>{Y(p,n(u).name),Y(d,n(u).octave),Y(_,`${n(u).frequency??""} Hz`),I=tt(w,1,"cents svelte-1hjl33a",null,I,{sharp:n(u).cents>0,flat:n(u).cents<0}),Y(C,`${n(u).cents>0?"+":""}${n(u).cents??""}¢`),Y(S,`${n(u).clarity??""}%`)}),k(l,f)},c=l=>{var u=Ga();k(l,u)};le(a,l=>{n(i)()?l(r):l(c,!1)})}k(e,o),Pe()}const vn={isVisible:!1,summary:null,songTitle:"",artistName:"",source:null},Xa={totalNotes:0,notesHit:0,notesMissed:0,accuracyPercent:0,goldenNotesHit:0,goldenNotesTotal:0,phraseResults:[],averagePitchDeviationCents:0};function Ua(){let e=K(ke({...vn}));return{get state(){return n(e)},show(t,s={}){n(e).summary=t,n(e).songTitle=s.title||"",n(e).artistName=s.artist||"",n(e).source=s.source||null,n(e).isVisible=!0},hide(){n(e).isVisible=!1},clear(){B(e,{...vn},!0)},calculateSummary(t,s){if(s.length===0)return{...Xa};let i=0,o=0,a=0,r=0,c=0;const l=new Map;s.forEach((v,d)=>{const g=`target-${d}`,y=t.get(g),_=v.isGolden===!0,w=v.phraseIndex??0;_&&a++,l.has(w)||l.set(w,{hit:0,total:0,lyrics:[]});const I=l.get(w);I.total++,v.lyric&&I.lyrics.push(v.lyric),y?.hitStatus==="hit"&&(i++,I.hit++,_&&o++,typeof y.pitchAccuracyCents=="number"&&(r+=Math.abs(y.pitchAccuracyCents),c++))});const u=s.length,f=u-i,h=u>0?i/u*100:0,m=c>0?r/c:0,p=[];return l.forEach((v,d)=>{p.push({phraseIndex:d,notesHit:v.hit,totalNotes:v.total,accuracyPercent:v.total>0?v.hit/v.total*100:0,lyricPreview:v.lyrics.join("").trim().slice(0,30)||`Phrase ${d+1}`})}),p.sort((v,d)=>v.phraseIndex-d.phraseIndex),{totalNotes:u,notesHit:i,notesMissed:f,accuracyPercent:h,goldenNotesHit:o,goldenNotesTotal:a,phraseResults:p,averagePitchDeviationCents:m}},getLetterGrade(t){return t>=95?"S":t>=90?"A":t>=80?"B":t>=70?"C":t>=60?"D":"F"},getAccuracyColor(t){return t>=90?"var(--color-success, #28a745)":t>=70?"var(--color-warning, #ffc107)":"var(--color-error, #dc3545)"}}}const Ie=Ua();var ja=E('<span class="song-artist svelte-10siv4r"> </span>'),Ja=E('<div class="song-info svelte-10siv4r"><span class="song-title svelte-10siv4r"> </span> <!></div>'),Za=E('<div class="stat-item missed svelte-10siv4r"><span class="stat-value svelte-10siv4r"> </span> <span class="stat-label svelte-10siv4r">Missed</span></div>'),Qa=E('<div class="golden-stats svelte-10siv4r"><span class="golden-icon svelte-10siv4r">⭐</span> <span class="golden-text svelte-10siv4r"> </span></div>'),Ka=E('<div class="pitch-stats svelte-10siv4r"><span class="pitch-label">Avg. Pitch Deviation:</span> <span class="pitch-value svelte-10siv4r"> </span></div>'),$a=E('<div><span class="phrase-lyric svelte-10siv4r"> </span> <span class="phrase-accuracy svelte-10siv4r"> </span></div>'),eo=E('<details class="phrase-details svelte-10siv4r"><summary class="phrase-summary svelte-10siv4r">Phrase Breakdown</summary> <div class="phrase-list svelte-10siv4r"></div></details>'),to=E('<button class="action-btn retry-btn svelte-10siv4r">Try Again</button>'),no=E('<div class="modal-backdrop svelte-10siv4r" role="dialog" aria-modal="true" aria-labelledby="results-title" tabindex="-1"><div class="modal-content svelte-10siv4r"><div class="modal-header svelte-10siv4r"><h2 id="results-title" class="modal-title svelte-10siv4r">Results</h2> <!></div> <div class="stats-section svelte-10siv4r"><div class="grade-display svelte-10siv4r"><span class="grade-letter svelte-10siv4r"> </span></div> <div class="accuracy-display svelte-10siv4r"><span class="accuracy-value svelte-10siv4r"> </span> <span class="accuracy-label svelte-10siv4r">Accuracy</span></div> <div class="stats-row svelte-10siv4r"><div class="stat-item svelte-10siv4r"><span class="stat-value hit svelte-10siv4r"> </span> <span class="stat-label svelte-10siv4r">Hit</span></div> <div class="stat-divider svelte-10siv4r">/</div> <div class="stat-item svelte-10siv4r"><span class="stat-value total svelte-10siv4r"> </span> <span class="stat-label svelte-10siv4r">Total</span></div> <!></div> <!> <!></div> <!> <div class="modal-actions svelte-10siv4r"><!> <button class="action-btn close-btn svelte-10siv4r">Close</button></div></div></div>');function so(e,t){Te(t,!0);const s=D(()=>Ie.state.isVisible),i=D(()=>Ie.state.summary),o=D(()=>Ie.state.songTitle),a=D(()=>Ie.state.artistName),r=D(()=>n(i)?Ie.getLetterGrade(n(i).accuracyPercent):"F"),c=D(()=>n(i)?Ie.getAccuracyColor(n(i).accuracyPercent):"");function l(){var d;Ie.hide(),(d=t.onClose)==null||d.call(t)}function u(){var d;Ie.hide(),(d=t.onRetry)==null||d.call(t)}function f(d){d.target===d.currentTarget&&l()}function h(d){d.key==="Escape"&&n(s)&&l()}var m=Ms();Ue("keydown",_n,h);var p=Ke(m);{var v=d=>{var g=no();g.__click=f,g.__keydown=h;var y=b(g),_=b(y),w=P(b(_),2);{var I=q=>{var se=Ja(),T=b(se),F=b(T),W=P(T,2);{var ae=ge=>{var be=ja(),oe=b(be);ne(()=>Y(oe,`by ${n(a)??""}`)),k(ge,be)};le(W,ge=>{n(a)&&ge(ae)})}ne(()=>Y(F,n(o))),k(q,se)};le(w,q=>{n(o)&&q(I)})}var C=P(_,2),M=b(C);let S;var H=b(M),R=b(H),x=P(M,2);let J;var z=b(x),$=b(z),Q=P(x,2),A=b(Q),O=b(A),U=b(O),ie=P(A,4),ve=b(ie),ye=b(ve),Me=P(ie,2);{var j=q=>{var se=Za(),T=b(se),F=b(T);ne(()=>Y(F,n(i).notesMissed)),k(q,se)};le(Me,q=>{n(i).notesMissed>0&&q(j)})}var X=P(Q,2);{var ee=q=>{var se=Qa(),T=P(b(se),2),F=b(T);ne(()=>Y(F,`Golden Notes: ${n(i).goldenNotesHit??""}/${n(i).goldenNotesTotal??""}`)),k(q,se)};le(X,q=>{n(i).goldenNotesTotal>0&&q(ee)})}var L=P(X,2);{var N=q=>{var se=Ka(),T=P(b(se),2),F=b(T);ne(W=>Y(F,`${W??""} cents`),[()=>n(i).averagePitchDeviationCents.toFixed(1)]),k(q,se)};le(L,q=>{n(i).averagePitchDeviationCents>0&&q(N)})}var V=P(C,2);{var te=q=>{var se=eo(),T=P(b(se),2);nt(T,21,()=>n(i).phraseResults,ht,(F,W)=>{var ae=$a();let ge;var be=b(ae),oe=b(be),Ce=P(be,2),re=b(Ce);ne(De=>{ge=tt(ae,1,"phrase-item svelte-10siv4r",null,ge,{perfect:n(W).accuracyPercent===100,good:n(W).accuracyPercent>=70&&n(W).accuracyPercent<100,poor:n(W).accuracyPercent<70}),Y(oe,n(W).lyricPreview),Y(re,`${n(W).notesHit??""}/${n(W).totalNotes??""}
                  (${De??""}%)`)},[()=>n(W).accuracyPercent.toFixed(0)]),k(F,ae)}),k(q,se)};le(V,q=>{n(i).phraseResults.length>1&&q(te)})}var ce=P(V,2),ue=b(ce);{var me=q=>{var se=to();se.__click=u,k(q,se)};le(ue,q=>{t.onRetry&&q(me)})}var he=P(ue,2);he.__click=l,ne(q=>{S=lt(M,"",S,{"--grade-color":n(c)}),Y(R,n(r)),J=lt(x,"",J,{color:n(c)}),Y($,`${q??""}%`),Y(U,n(i).notesHit),Y(ye,n(i).totalNotes)},[()=>n(i).accuracyPercent.toFixed(1)]),k(d,g)};le(p,d=>{n(s)&&n(i)&&d(v)})}k(e,m),Pe()}Se(["click","keydown"]);const Rt={hasImportedSnapshot:!1,snapshot:null,isLoading:!1,error:null,transpositionSemitones:0};function io(){let e=K(ke({...Rt}));return{get state(){return n(e)},async checkAndConsumeHandoff(){if(!zn())return!1;n(e).isLoading=!0,n(e).error=null;try{const t=await Gn();return t?t.schemaVersion!==Xt?(n(e).error=`Incompatible snapshot version: ${t.schemaVersion}. Expected: ${Xt}`,n(e).isLoading=!1,at(),!1):(n(e).snapshot=t,n(e).hasImportedSnapshot=!0,n(e).isLoading=!1,at(),console.log("[HandoffState] Successfully imported snapshot",{voices:t.voices.length,microbeatCount:t.timeGrid.microbeatCount,tempo:t.tempo}),!0):(n(e).error="Handoff data expired or not found. Please try exporting again.",n(e).isLoading=!1,at(),!1)}catch(t){return console.error("[HandoffState] Failed to process handoff",t),n(e).error="Failed to import data from Student Notation.",n(e).isLoading=!1,at(),!1}},get voices(){var t;return((t=n(e).snapshot)==null?void 0:t.voices)??[]},get timeGrid(){var t;return((t=n(e).snapshot)==null?void 0:t.timeGrid)??null},get tempo(){var t;return((t=n(e).snapshot)==null?void 0:t.tempo)??90},get suggestedPitchRange(){if(!n(e).snapshot)return null;const t=3,s=n(e).snapshot.minMidiPitch,i=n(e).snapshot.maxMidiPitch;return s===void 0||i===void 0?null:{minMidi:Math.max(21,s-t+n(e).transpositionSemitones),maxMidi:Math.min(108,i+t+n(e).transpositionSemitones)}},setTransposition(t){n(e).transpositionSemitones=t},transposeUp(){n(e).transpositionSemitones+=1},transposeDown(){n(e).transpositionSemitones-=1},getTransposedMidi(t){return t+n(e).transpositionSemitones},async bringBackToStudentNotation(){if(!n(e).snapshot){console.warn("[HandoffState] No snapshot to bring back");return}const t={...n(e).snapshot,sourceApp:"singing-trainer",createdAt:Date.now(),voices:n(e).snapshot.voices.map(s=>({...s,notes:s.notes.map(i=>({...i,midiPitch:i.midiPitch+n(e).transpositionSemitones}))}))};try{const s=await Bn(t);console.log("[HandoffState] Handoff slot written for return",s),qn(s)}catch(s){console.error("[HandoffState] Failed to write return handoff",s)}},clearSnapshot(){B(e,{...Rt},!0)},reset(){B(e,{...Rt},!0)}}}const Ae=io();var ao=E('<div class="handoff-controls svelte-1n46o8q"><div class="transposition-control svelte-1n46o8q"><button class="transpose-btn svelte-1n46o8q" title="Transpose down">-</button> <span class="transposition-label svelte-1n46o8q"> </span> <button class="transpose-btn svelte-1n46o8q" title="Transpose up">+</button></div> <button class="bring-back-btn svelte-1n46o8q">Bring Back to Student Notation</button></div>'),oo=E('<div class="error-banner svelte-1n46o8q"> </div>'),ro=E('<div class="import-info svelte-1n46o8q"><span class="import-label svelte-1n46o8q">Microbeats:</span> <span class="import-value svelte-1n46o8q"> </span></div>'),lo=E('<div class="control-group svelte-1n46o8q"><h3 class="control-group-title svelte-1n46o8q">Imported Material</h3> <div class="import-info svelte-1n46o8q"><span class="import-label svelte-1n46o8q">Voices:</span> <span class="import-value svelte-1n46o8q"> </span></div> <div class="import-info svelte-1n46o8q"><span class="import-label svelte-1n46o8q">Tempo:</span> <span class="import-value svelte-1n46o8q"> </span></div> <!></div>'),co=E('<div class="app svelte-1n46o8q"><header class="header svelte-1n46o8q"><h1 class="title svelte-1n46o8q">Singing Trainer</h1> <div class="header-controls svelte-1n46o8q"><!></div></header> <!> <main class="main svelte-1n46o8q"><aside class="sidebar sidebar--left svelte-1n46o8q"><div class="control-group svelte-1n46o8q"><!></div> <div class="control-group svelte-1n46o8q"><!></div> <div class="control-group svelte-1n46o8q"><!></div> <div class="control-group svelte-1n46o8q"><details class="settings-details svelte-1n46o8q"><summary class="settings-summary svelte-1n46o8q">Settings</summary> <div class="settings-content svelte-1n46o8q"><!> <!> <!></div></details></div> <div class="control-group svelte-1n46o8q"><!></div> <!></aside> <section class="canvas-area svelte-1n46o8q"><!></section></main> <!></div>');function uo(e,t){Te(t,!0);let s=K(!1);Ne(()=>fe.onPerformanceComplete(j=>{if(G.state.isActive&&G.state.isPlaying){const X=Ie.calculateSummary(j,G.state.targetNotes);Ie.show(X,{title:G.title,artist:G.artist,source:"ultrastar"}),G.setPlaying(!1)}}));function i(){Ie.state.source==="ultrastar"?(fe.reset(),fe.setTargetNotes(G.state.targetNotes),Z.setVisualizationMode("highway")):Ie.state.source}yn(async()=>{if(await Ae.checkAndConsumeHandoff()){console.log("[App] Handoff detected and processed");const j=Ae.suggestedPitchRange;j&&Z.setYAxisRange(j)}try{await qi(),Z.setDetecting(!0),console.log("[App] Pitch detection auto-started")}catch(j){console.error("[App] Failed to auto-start pitch detection:",j)}}),qe(()=>{zi()});const o=D(()=>Ae.state.hasImportedSnapshot),a=D(()=>Ae.state.transpositionSemitones),r=D(()=>Ae.state.error);function c(){Ae.bringBackToStudentNotation()}function l(){Ae.transposeUp()}function u(){Ae.transposeDown()}var f=co(),h=b(f),m=P(b(h),2),p=b(m);{var v=j=>{var X=ao(),ee=b(X),L=b(ee);L.__click=u;var N=P(L,2),V=b(N),te=P(N,2);te.__click=l;var ce=P(ee,2);ce.__click=c,ne(()=>Y(V,`${n(a)>=0?"+":""}${n(a)??""}`)),k(j,X)};le(p,j=>{n(o)&&j(v)})}var d=P(h,2);{var g=j=>{var X=oo(),ee=b(X);ne(()=>Y(ee,n(r))),k(j,X)};le(d,j=>{n(r)&&j(g)})}var y=P(d,2),_=b(y),w=b(_),I=b(w);Ya(I,{});var C=P(w,2),M=b(C);la(M,{});var S=P(C,2),H=b(S);qa(H,{});var R=P(S,2),x=b(R),J=P(b(x),2),z=b(J);Ji(z,{});var $=P(z,2);Ki($,{});var Q=P($,2);na(Q,{});var A=P(R,2),O=b(A);ea(O,{});var U=P(A,2);{var ie=j=>{var X=lo(),ee=P(b(X),2),L=P(b(ee),2),N=b(L),V=P(ee,2),te=P(b(V),2),ce=b(te),ue=P(V,2);{var me=he=>{var q=ro(),se=P(b(q),2),T=b(se);ne(()=>Y(T,Ae.timeGrid.microbeatCount)),k(he,q)};le(ue,he=>{Ae.timeGrid&&he(me)})}ne(()=>{Y(N,Ae.voices.length),Y(ce,`${Ae.tempo??""} BPM`)}),k(j,X)};le(U,j=>{n(o)&&j(ie)})}var ve=P(_,2),ye=b(ve);Wi(ye,{});var Me=P(y,2);so(Me,{onRetry:i}),Pn("open","toggle",x,j=>B(s,j),()=>n(s)),k(e,f),Pe()}Se(["click"]);function fo(e){const t=ys(uo,{target:e});return{destroy:()=>bs(t)}}const ho=fo,mn=document.getElementById("app");mn&&ho(mn);
