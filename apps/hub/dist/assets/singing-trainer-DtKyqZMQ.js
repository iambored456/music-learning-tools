import"./modulepreload-polyfill-B5Qt9EMX.js";import{C as Qt,D as Mn,F as Tn,G as _n,H as Pn,I as Ve,J as Cn,K as Sn,L as $t,M as xn,p as pe,u as Re,g as t,o as K,v as A,f as L,c as p,s as w,k as F,a as H,r as ye,q as Le,n as _e,e as Ge,i as et,t as J,b as q,N as In,h as Fe,d as st,A as Ke,y as Je,$ as en,O as An,x as Rn,m as Nn,B as kn}from"./legacy-CpVVXpx-.js";import{t as fe,o as tn,j as Ye,i as ee,q as Ne,u as Hn,v as Ln,k as _t,h as qe,f as ct,x as Dn,w as En,y as On,A as Fn,C as Wn,E as tt,S as It}from"./navigation-CidcP4BR.js";import{s as Pt,V as Bn,S as nn,l as At,U as Gn,A as Yn,g as qn,P as Un}from"./vendor-tone-Cer4uW5H.js";import{P as Vn}from"./vendor-pitchy-DoA2xU7W.js";function Ct(e,n,i=!1){if(e.multiple){if(n==null)return;if(!Mn(n))return Tn();for(var s of e.options)s.selected=n.includes(Rt(s));return}for(s of e.options){var r=Rt(s);if(_n(r,n)){s.selected=!0;return}}(!i||n!==void 0)&&(e.selectedIndex=-1)}function sn(e){var n=new MutationObserver(()=>{Ct(e,e.__value)});n.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),Qt(()=>{n.disconnect()})}function Rt(e){return"__value"in e?e.__value:e.value}function dt(e,n,i=n){var s=new WeakSet;Pn(e,"input",async r=>{var o=r?e.defaultValue:e.value;if(o=ut(e)?ft(o):o,i(o),Ve!==null&&s.add(Ve),await Cn(),o!==(o=n())){var a=e.selectionStart,c=e.selectionEnd,l=e.value.length;if(e.value=o??"",c!==null){var d=e.value.length;a===c&&c===l&&d>l?(e.selectionStart=d,e.selectionEnd=d):(e.selectionStart=a,e.selectionEnd=Math.min(c,d))}}}),Sn(n)==null&&e.value&&(i(ut(e)?ft(e.value):e.value),Ve!==null&&s.add(Ve)),$t(()=>{var r=n();if(e===document.activeElement){var o=xn??Ve;if(s.has(o))return}ut(e)&&r===ft(e.value)||e.type==="date"&&!r&&!e.value||r!==e.value&&(e.value=r??"")})}function ut(e){var n=e.type;return n==="number"||n==="range"}function ft(e){return e===""?null:+e}function an(e,n,i,s,r){var o=()=>{s(i[e])};i.addEventListener(n,o),r?$t(()=>{i[e]=r()}):o(),(i===document.body||i===window||i===document)&&Qt(()=>{i.removeEventListener(n,o)})}const yt=["#ef8aab","#f48e7d","#e89955","#cdaa42","#a4ba57","#6ec482","#2dc8b1","#16c3da","#58b8f6","#8fa9ff","#ba9bf2","#db8fd4"],Nt=yt[0];function kt(e){const n=parseInt(e.slice(1),16);return[n>>16&255,n>>8&255,n&255]}function Xn(e,n,i){const s=Math.max(0,Math.min(1,i));return e.map((r,o)=>{const a=n[o]??r;return Math.round(r+s*(a-r))})}function on(e,n=0){const i=Math.floor(e),s=e-i,r=(i%12-n+12)%12,o=(r+1)%12,a=kt(yt[r]??Nt),c=kt(yt[o]??Nt);return Xn(a,c,s)}const jn={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11};function zn(e){const n=e.replace(/\d+$/,"");return jn[n]??0}const ht={onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70,accuracyTiers:{perfect:{onsetMs:30,pitchCents:10,coverage:95},good:{onsetMs:75,pitchCents:25,coverage:85},okay:{onsetMs:150,pitchCents:50,coverage:70}}};function Kn(e={}){const n={...ht,...e,accuracyTiers:e.accuracyTiers?{...ht.accuracyTiers,...e.accuracyTiers}:ht.accuracyTiers},i=new Map,s=new Map;function r(h,u){return(h-u)*100}function o(h,u){return Math.abs(r(h.midi,u))<=n.pitchToleranceCents}function a(h,u){return h.length===0?0:h.reduce((v,f)=>v+Math.abs(r(f.midi,u)),0)/h.length}function c(h,u,y,v){if(h.length===0)return 0;const f=h.filter(b=>o(b,u));if(f.length===0)return 0;let m=0;for(let b=0;b<f.length;b++){const T=f[b];if(!T)continue;const C=f[b+1];if(C)m+=C.timeMs-T.timeMs;else{const I=y+v,P=Math.min(50,I-T.timeMs);m+=P}}return m/v*100}function l(h,u,y){const v=n.accuracyTiers;if(!v)return"okay";const f=Math.abs(h);return f<=v.perfect.onsetMs&&u<=v.perfect.pitchCents&&y>=v.perfect.coverage?"perfect":f<=v.good.onsetMs&&u<=v.good.pitchCents&&y>=v.good.coverage?"good":f<=v.okay.onsetMs&&u<=v.okay.pitchCents&&y>=v.okay.coverage?"okay":"miss"}function d(h){const{note:u,samples:y,onsetSample:v,releaseSample:f}=h;let m=0;v?m=v.timeMs-u.startTimeMs:m=n.onsetToleranceMs*2;let b=0;const T=u.startTimeMs+u.durationMs;f?b=f.timeMs-T:b=n.releaseToleranceMs*2;const C=a(y,u.midi),I=c(y,u.midi,u.startTimeMs,u.durationMs),P=Math.abs(m)<=n.onsetToleranceMs,_=Math.abs(b)<=n.releaseToleranceMs,x=I>=n.hitThreshold,N=P&&_&&x?"hit":"miss",k=l(m,C,I);return{hitStatus:N,onsetAccuracyMs:m,releaseAccuracyMs:b,pitchAccuracyCents:C,pitchCoverage:I,pitchSamples:[...y],accuracyTier:k}}return{startNote(h,u){i.set(h,{note:u,samples:[],onsetSample:null,releaseSample:null,startedAt:performance.now()})},recordPitchSample(h){for(const[u,y]of i){const{note:v}=y,f=v.startTimeMs+v.durationMs,m=n.onsetToleranceMs,b=n.releaseToleranceMs;h.timeMs>=v.startTimeMs-m&&h.timeMs<=f+b&&(y.samples.push(h),!y.onsetSample&&h.timeMs>=v.startTimeMs-m&&h.timeMs<=v.startTimeMs+m&&o(h,v.midi)&&(y.onsetSample=h),h.timeMs>=f-b&&h.timeMs<=f+b&&(y.releaseSample=h))}},endNote(h){const u=i.get(h);if(!u)return null;const y=d(u);return s.set(h,y),i.delete(h),y},getCurrentPerformance(h){const u=i.get(h);if(!u)return null;const{note:y,samples:v,onsetSample:f}=u;let m=0;f&&(m=f.timeMs-y.startTimeMs);const b=a(v,y.midi),T=c(v,y.midi,y.startTimeMs,y.durationMs);return{onsetAccuracyMs:m,pitchAccuracyCents:b,pitchCoverage:T,pitchSamples:[...v]}},getAllPerformances(){return new Map(s)},reset(){i.clear(),s.clear()},dispose(){i.clear(),s.clear()}}}const Ht={judgmentLinePosition:.12,pixelsPerSecond:200,lookAheadMs:3e3,scrollMode:"constant-speed",leadInBeats:4,playMetronomeDuringOnramp:!0,playTargetNotes:!0,playMetronome:!1,inputSources:["microphone"],feedbackConfig:{onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70}};function Zn(e){const n={...Ht,...e,feedbackConfig:{...Ht.feedbackConfig,...e.feedbackConfig}},{stateCallbacks:i,eventCallbacks:s,visualCallbacks:r,logger:o}=n,a={isPlaying:!1,isPaused:!1,currentTimeMs:0,scrollOffset:0,onrampComplete:!1,targetNotes:[],activeNotes:new Set,startTime:null},c=Kn(n.feedbackConfig);let l=null;const d=new Set;function g(){const _=60/i.getTempo()*1e3;return n.leadInBeats*_}function h(){return i.getViewportWidth()*n.judgmentLinePosition}function u(P){const _=n.pixelsPerSecond/1e3,x=h(),N=g();return(P+N)*_-x}function y(P){const _=h(),x=i.getCellWidth(),N=P.startColumn*x-a.scrollOffset,k=P.endColumn*x-a.scrollOffset,E=n.feedbackConfig.onsetToleranceMs/1e3*n.pixelsPerSecond;return N<=_+E&&k>=_-E}function v(){const P=new Set;for(const _ of a.targetNotes){const x=_.startTimeMs+_.durationMs,N=n.feedbackConfig.onsetToleranceMs;if(a.currentTimeMs>=_.startTimeMs-N&&a.currentTimeMs<=x+N)P.add(_.id),a.activeNotes.has(_.id)||(c.startNote(_.id,_),o?.debug("NoteHighway",`Note ${_.id} became active`,{note:_}));else if(a.activeNotes.has(_.id)){const k=c.endNote(_.id);if(k){_.performance=k;const D={noteId:_.id,note:_,performance:k};k.hitStatus==="hit"?(s.emit("noteHit",D),r?.onNoteHit?.(_.id,k.accuracyTier||"okay"),o?.info("NoteHighway",`Note hit: ${_.id}`,k)):(s.emit("noteMissed",D),r?.onNoteMiss?.(_.id),o?.info("NoteHighway",`Note missed: ${_.id}`,k))}}}a.activeNotes=P}function f(){for(const P of a.targetNotes){const _=y(P),x=d.has(P.id);_&&!x?(d.add(P.id),s.emit("noteEntered",{noteId:P.id,note:P})):!_&&x&&(d.delete(P.id),s.emit("noteExited",{noteId:P.id,note:P}))}}function m(){if(!a.onrampComplete)if(a.currentTimeMs>=0)a.onrampComplete=!0,s.emit("onrampComplete"),r?.clearOnrampCountdown?.(),o?.info("NoteHighway","Onramp complete",null);else{const _=60/i.getTempo()*1e3,x=Math.abs(a.currentTimeMs),N=Math.ceil(x/_);r?.updateOnrampCountdown?.(N)}}function b(){if(!a.isPlaying||a.isPaused||!a.startTime){l=null;return}const P=performance.now(),_=g();a.currentTimeMs=P-a.startTime-_,a.scrollOffset=u(a.currentTimeMs),m(),v(),f(),l=requestAnimationFrame(b)}function T(){l||(l=requestAnimationFrame(b))}function C(){l&&(cancelAnimationFrame(l),l=null)}return{init(P){a.targetNotes=P,o?.info("NoteHighway",`Initialized with ${P.length} notes`,null)},start(){a.isPlaying||(a.isPlaying=!0,a.isPaused=!1,a.currentTimeMs=-g(),a.scrollOffset=u(a.currentTimeMs),a.onrampComplete=!1,a.activeNotes.clear(),a.startTime=performance.now(),d.clear(),c.reset(),T(),s.emit("playbackStarted"),o?.info("NoteHighway","Playback started",{onrampDurationMs:g()}))},pause(){!a.isPlaying||a.isPaused||(a.isPaused=!0,C(),s.emit("playbackPaused"),o?.info("NoteHighway","Playback paused",{currentTimeMs:a.currentTimeMs}))},resume(){if(!a.isPlaying||!a.isPaused||!a.startTime)return;const P=performance.now()-(a.startTime+a.currentTimeMs+g());a.startTime+=P,a.isPaused=!1,T(),s.emit("playbackResumed"),o?.info("NoteHighway","Playback resumed",null)},stop(){if(!a.isPlaying)return;a.isPlaying=!1,a.isPaused=!1,a.currentTimeMs=0,a.scrollOffset=0,a.onrampComplete=!1,a.activeNotes.clear(),a.startTime=null,d.clear(),C(),r?.clearCanvas?.(),r?.clearOnrampCountdown?.(),s.emit("playbackStopped"),a.targetNotes.every(_=>_.performance!==void 0)&&s.emit("performanceComplete"),o?.info("NoteHighway","Playback stopped",null)},setScrollOffset(P){if(a.currentTimeMs=P,a.scrollOffset=u(P),a.isPlaying){const _=g();a.startTime=performance.now()-(P+_)}o?.debug("NoteHighway","Scroll offset set",{timeMs:P,scrollOffset:a.scrollOffset})},recordPitchInput(P,_,x){if(!a.isPlaying||a.isPaused||!n.inputSources.includes(x))return;const N={timeMs:a.currentTimeMs,midi:P,clarity:_,source:x};c.recordPitchSample(N)},getState(){return a},getVisibleNotes(){h();const P=i.getViewportWidth(),_=i.getCellWidth();return a.targetNotes.filter(x=>{const N=x.startColumn*_-a.scrollOffset;return x.endColumn*_-a.scrollOffset>=0&&N<=P})},getPerformanceResults(){return c.getAllPerformances()},getFeedbackCollector(){return c},dispose(){C(),c.dispose(),a.targetNotes=[],a.activeNotes.clear(),d.clear(),o?.info("NoteHighway","Service disposed",null)}}}function Jn(e){const{cellHeight:n,columnWidths:i,viewport:s}=e,r=n/2,o=Qn(i,e.cellWidth);return{getRowY(a){return(a-s.startRow+1)*r},getRowFromY(a){const c=a/r-1;return Math.round(c)+s.startRow},getColumnX(a){return a<0?0:a>=o.length?o[o.length-1]??0:o[a]??0},getColumnFromX(a){let c=0,l=o.length-1;for(;c<l;){const d=Math.floor((c+l)/2);(o[d]??0)<=a?c=d+1:l=d}return Math.max(0,c-1)}}}function rn(e){const{cellHeight:n,viewport:i,pixelsPerSecond:s,nowLineX:r=100,currentTimeMs:o=0}=e,a=n/2;return{getRowY(c){return(c-i.startRow+1)*a},getRowFromY(c){const l=c/a-1;return Math.round(l)+i.startRow},getColumnX(c){return 0},getColumnFromX(c){return 0},getTimeX(c){const l=c-o;return r+l/1e3*s},getTimeFromX(c){const l=(c-r)/s*1e3;return o+l}}}function Qn(e,n){const i=[0];let s=0;for(let r=0;r<e.length;r++){const o=(e[r]??1)*n;s+=o,i.push(s)}return i}function $n(e,n){const{startRow:i,endRow:s}=e,r=Math.max(0,n.length-1);return{startRow:i,endRow:s,paddedStartRow:Math.max(0,i-1),paddedEndRow:Math.min(r,s+1)}}function gt(e,n,i,s){const r=s.getRowY(e),o=i;return r>=-o&&r<=n.containerHeight+o}function ei(e){let n=(e||"").replace(/\d/g,"").trim();return n=n.replace(/b/g,"b-").replace(/#/g,"b_"),n}function ti(e){switch(e){case"C":return{lineWidth:3.33,dash:[],color:"#adb5bd"};case"E":return{lineWidth:1,dash:[5,5],color:"#adb5bd"};case"G":return{lineWidth:1,dash:[],color:"#dee2e6"};case"B":case"A":case"F":case"Eb/Db":case"Db/C#":return{lineWidth:1,dash:[],color:"#ced4da"};default:return{lineWidth:1,dash:[],color:"#ced4da"}}}const nt={stroke:"#c7cfd8",background:"rgba(207, 214, 222, 0.32)"};let Xe=null;function ni(){if(Xe)return Xe;if(typeof window>"u")return nt;try{const e=window.getComputedStyle(document.documentElement);Xe={stroke:e.getPropertyValue("--c-anacrusis-border").trim()||nt.stroke,background:e.getPropertyValue("--c-anacrusis-bg").trim()||nt.background}}catch{Xe=nt}return Xe}function ii(e,n,i,s,r,o=0,a){const{fullRowData:c,viewportHeight:l,viewportWidth:d,cellHeight:g}=n,h=d,u=["B","A","F","Eâ™­/Dâ™¯","Dâ™­/Câ™¯"];for(let y=s;y<=r;y++){const v=c[y];if(!v||v.isBoundary)continue;const f=i.getRowY(y);if(f<-10||f>l+10)continue;const m=ei(v.pitch);if(u.includes(m))continue;const b=ti(m);m==="G"?(e.save(),e.fillStyle=b.color,e.fillRect(o,f-g/2,h-o,g),e.restore()):(e.beginPath(),e.moveTo(o,f),e.lineTo(h,f),e.lineWidth=b.lineWidth,e.strokeStyle=b.color,e.setLineDash(b.dash),e.stroke(),e.setLineDash([]))}}function si(e,n,i,s){const{columnWidths:r,viewportHeight:o,macrobeatBoundaryStyles:a,placedTonicSigns:c}=n,l=r.length;for(let d=0;d<=l;d++){const g=d===0||d===l,h=oi(d,c),u=c.some(b=>d===b.columnIndex+2),y=s.includes(d);if(!ri(d,c))continue;let f=null;if(g||h||u)f={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(y){const b=s.indexOf(d),T=a[b]??"dashed";if(T==="anacrusis"){const{stroke:C}=ni();f={lineWidth:1,strokeStyle:C,dash:[4,4]}}else f={lineWidth:1,strokeStyle:"#adb5bd",dash:T==="solid"?[]:[5,5]}}if(!f)continue;const m=i.getColumnX(d);e.beginPath(),e.moveTo(m,0),e.lineTo(m,o),e.lineWidth=f.lineWidth,e.strokeStyle=f.strokeStyle,e.setLineDash(f.dash),e.stroke()}e.setLineDash([])}function ai(e,n,i){const{viewportHeight:s,beatIntervalMs:r,measureIntervalMs:o,visibleTimeRange:a,nowLineX:c,beatTimeOffsetMs:l=0}=n,d=a.startMs-l,g=a.endMs-l,h=Math.floor(d/r),u=Math.ceil(g/r);for(let y=h;y<=u;y++){const v=l+y*r,f=i.getTimeX?.(v);if(f===void 0)continue;const m=o?(v-l)%o===0:!1;e.beginPath(),e.moveTo(f,0),e.lineTo(f,s),e.lineWidth=m?2:1,e.strokeStyle=m?"#adb5bd":"#dee2e6",e.setLineDash(m?[]:[5,5]),e.stroke()}e.setLineDash([]),c!==void 0&&(e.beginPath(),e.moveTo(c,0),e.lineTo(c,s),e.lineWidth=3,e.strokeStyle="#00ff00",e.setLineDash([]),e.stroke())}function oi(e,n){return n.some(i=>i.columnIndex===e)}function ri(e,n){return!n.some(i=>i.columnIndex+1===e)}const li=.7,ci=.9,di=4,ui=1,fi=.15,hi=.2,gi=1,St=1.5;function Ze(e,n){return Number.isFinite(e)&&e>0&&Number.isFinite(n)&&n>0}function ln(e){if(!e||typeof e.startColumnIndex!="number"||typeof e.endColumnIndex!="number")return!1;const n=e.shape==="circle"?e.startColumnIndex+1:e.startColumnIndex;return e.endColumnIndex>n}function at(e){const n=e?.split("-")[1];return Number.parseInt(n??"0",10)}function cn(e,n,i){const s=i*.25,r=e.uuid;if(!r)return 0;const o=n.filter(l=>!l.isDrum&&l.row===e.row&&l.startColumnIndex===e.startColumnIndex&&l.uuid&&l.uuid!==r);if(o.length===0)return 0;const a=[e,...o];return a.sort((l,d)=>at(l.uuid)-at(d.uuid)),a.findIndex(l=>l.uuid===r)*s}function vi(e,n,i){const s=i/2*.12,r=e.uuid;if(!r)return 0;const o=n.filter(l=>!l.isDrum&&l.row===e.row&&l.startColumnIndex===e.startColumnIndex&&l.uuid&&l.uuid!==r&&ln(l));if(o.length===0)return 0;const a=[e,...o];return a.sort((l,d)=>at(l.uuid)-at(d.uuid)),a.findIndex(l=>l.uuid===r)*s}function mi(e){if(!e)return{multiplier:1,category:"natural"};const n=e.includes("â™­"),i=e.includes("â™¯"),s=e.includes("/");return!n&&!i?{multiplier:1,category:"natural"}:s?{multiplier:.75,category:"both-accidentals"}:{multiplier:.88,category:"single-accidental"}}function bt(e,n,i,s,r,o){const{multiplier:a,category:c}=mi(n);let l;if(i==="circle"){const d=o*2*ci;switch(c){case"natural":l=d;break;case"single-accidental":l=d*.8;break;case"both-accidentals":l=d*.4;break;default:l=d*a}}else{const d=o*2*li;switch(c){case"natural":l=d*1.5;break;case"single-accidental":l=d*1.2;break;case"both-accidentals":l=d;break;default:l=d*a}}if(!(l<di))if(e.fillStyle="#212529",e.font=`bold ${l}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle",i==="oval"&&c==="both-accidentals"&&n.includes("/")){const d=n.split("/"),g=l*1.1,h=g*(d.length-1),u=r-h/2;d.forEach((y,v)=>{const f=u+v*g,m=l*.08;e.fillText(y.trim(),s,f+m)})}else{const d=l*.08;e.fillText(n,s,r+d)}}function pi(e,n,i,s,r,o,a){e.save(),e.beginPath(),e.arc(i,r,o,Math.PI/2,-Math.PI/2,!1),e.lineTo(s,r-o),e.arc(s,r,o,-Math.PI/2,Math.PI/2,!1),e.lineTo(i,r+o),e.closePath(),e.strokeStyle=n.color,e.lineWidth=a,e.shadowColor=n.color,e.shadowBlur=St,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore()}function Lt(e,n,i,s){const{config:r,coords:o,allNotes:a,getScaleDegreeLabel:c}=n,{cellWidth:l,cellHeight:d,columnWidths:g,degreeDisplayMode:h}=r,u=o.getRowY(s),y=o.getColumnX(i.startColumnIndex),f=(g[i.startColumnIndex]??1)*l;if(!Ze(f,d))return;const m=cn(i,a,l),b=Math.max(.5,f*.15),T=y+f/2+m,C=f/2-b/2,I=d/2-b/2;if(Ze(C,I)&&(e.save(),e.beginPath(),e.ellipse(T,u,C,I,0,0,2*Math.PI),e.strokeStyle=i.color,e.lineWidth=b,e.shadowColor=i.color,e.shadowBlur=St,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore(),h!=="off"&&c)){const{label:P}=c(i);P&&bt(e,P,"oval",T,u,C)}}function Dt(e,n,i,s){const{config:r,coords:o,allNotes:a,getScaleDegreeLabel:c}=n,{cellWidth:l,cellHeight:d,degreeDisplayMode:g,longNoteStyle:h}=r,u=o.getRowY(s),y=o.getColumnX(i.startColumnIndex),f=o.getColumnX(i.startColumnIndex+1)-y;if(!Ze(f,d))return;const m=cn(i,a,l),b=y+f+m,T=Math.max(ui,f*fi),C=d/2-T/2,I=ln(i);if(I&&h==="style2"){const _=b,x=o.getColumnX(i.endColumnIndex);if(Ze(x-_,C)&&(pi(e,i,_,x,u,C,T),g!=="off"&&c)){const{label:N}=c(i);if(N){const k=(_+x)/2;bt(e,N,"circle",k,u,C)}}return}if(I){const _=o.getColumnX(i.endColumnIndex+1),x=vi(i,a,d),N=u+x;e.beginPath(),e.moveTo(b,N),e.lineTo(_,N),e.strokeStyle=i.color,e.lineWidth=Math.max(gi,f*hi),e.stroke()}const P=f-T/2;if(Ze(P,C)&&(e.save(),e.beginPath(),e.ellipse(b,u,P,C,0,0,2*Math.PI),e.strokeStyle=i.color,e.lineWidth=T,e.shadowColor=i.color,e.shadowBlur=St,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore(),g!=="off"&&c)){const{label:_}=c(i);_&&bt(e,_,"circle",b,u,P)}}function yi(e,n,i){const{config:s,coords:r}=n,{cellWidth:o,cellHeight:a}=s,c=r.getRowY(i.globalRow??i.row),l=r.getColumnX(i.columnIndex),g=r.getColumnX(i.columnIndex+1)-l,h=g*2,u=l+h/2,y=Math.min(h,a)/2*.9;if(y<2||(e.beginPath(),e.arc(u,c,y,0,2*Math.PI),e.strokeStyle="#212529",e.lineWidth=Math.max(.5,g*.05),e.stroke(),i.tonicNumber==null))return;const v=i.tonicNumber.toString(),f=y*1.5;f<6||(e.fillStyle="#212529",e.font=`bold ${f}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(v,u,c))}const bi={timeWindowMs:4e3,pixelsPerSecond:200,circleRadius:9.5,proximityThreshold:35,maxConnections:3,connectorLineWidth:2.5,connectorColor:"rgba(0,0,0,0.4)",useTonicRelativeColors:!0,tonicPitchClass:0,clarityThreshold:.5,maxOpacity:.9};function dn(e){return{...bi,...e}}function Et(e,n,i,s,r,o,a){const c=dn(o.trailConfig);if(s<c.clarityThreshold||i<=0)return;const{cellHeight:l,colorMode:d}=o,g=un(n,i,l,a),h=l/2*.8,u=d==="bw"?[128,128,128]:on(i,c.tonicPitchClass);e.save(),e.beginPath(),e.arc(r,g,h+4,0,2*Math.PI),e.fillStyle=`rgba(${u[0]}, ${u[1]}, ${u[2]}, ${s*.3})`,e.fill(),e.beginPath(),e.arc(r,g,h,0,2*Math.PI),e.fillStyle=`rgba(${u[0]}, ${u[1]}, ${u[2]}, ${s})`,e.fill(),e.restore()}function un(e,n,i,s){if(s.length===0||!s[0])return 0;const r=Math.floor(n),o=n-r,l=(s[0].midi??108)-r;if(l<0||l>=s.length)return l<0?0:e.getRowY(s.length-1);const d=e.getRowY(l),g=i/2;return d-o*g}function fn(e,n,i,s,r,o){const{viewportWidth:a,cellHeight:c,colorMode:l}=r,d=dn(r.trailConfig),g=d.timeWindowMs,h=d.pixelsPerSecond,u=r.nowLineX??a,y=i.filter(v=>v.midi>0&&v.clarity>=d.clarityThreshold).map(v=>{const f=s-v.time;if(f>=g||f<0)return null;const m=u-f/1e3*h,b=un(n,v.midi,c,o),T=l==="bw"?[128,128,128]:on(v.midi,d.tonicPitchClass);return{x:m,y:b,clarity:v.clarity,color:T}}).filter(v=>v!==null&&v.x>=0);if(y.length!==0){e.save(),e.strokeStyle=d.connectorColor,e.lineWidth=d.connectorLineWidth,e.beginPath();for(let v=0;v<y.length;v++){let f=0;for(let m=v+1;m<y.length&&f<d.maxConnections;m++){const b=y[v].x-y[m].x,T=y[v].y-y[m].y;Math.sqrt(b*b+T*T)<=d.proximityThreshold&&(e.moveTo(y[v].x,y[v].y),e.lineTo(y[m].x,y[m].y),f++)}}e.stroke();for(const v of y){const f=Math.min(v.clarity*d.maxOpacity,1);e.fillStyle=`rgba(${v.color[0]}, ${v.color[1]}, ${v.color[2]}, ${f})`,e.beginPath(),e.arc(v.x,v.y,d.circleRadius,0,2*Math.PI),e.fill()}e.restore()}}function Ot(e,n,i,s,r,o,a,c){const{cellHeight:l,nowLineX:d=100,pixelsPerSecond:g}=r,h=.5;for(const u of i){const y=(d??100)+(u.startTimeMs-s)/1e3*g,v=y+u.durationMs/1e3*g;if(v<0||y>r.viewportWidth)continue;let f;if(o){if(f=o.findIndex(x=>x.midi===u.midi),f===-1)continue}else f=Math.round(108-u.midi);const m=n.getRowY(f),b=l/2-2,T=u.color??"#4CAF50",C=y<=d&&v>=d,I=a!=null&&(c??0)>.5&&Math.abs(a-u.midi)<=h,P=C&&I;e.save(),e.beginPath();const _=v-y;if(_>=2*b){const x=y+b,N=v-b;e.arc(x,m,b,Math.PI/2,-Math.PI/2,!1),e.lineTo(N,m-b),e.arc(N,m,b,-Math.PI/2,Math.PI/2,!1),e.lineTo(x,m+b)}else{const x=(y+v)/2,N=_/2;e.ellipse(x,m,N,b,0,0,2*Math.PI)}if(e.closePath(),P?(e.strokeStyle="#FFD700",e.lineWidth=5,e.shadowColor="#FFD700",e.shadowBlur=20,e.stroke(),e.fillStyle="rgba(255, 215, 0, 0.3)",e.fill(),wi(e,d,m,b)):(e.strokeStyle=T,e.lineWidth=3,e.shadowColor=T,e.shadowBlur=8,e.stroke()),e.shadowBlur=0,e.restore(),u.label){const x=y+4;e.fillStyle=P?"#FFD700":"#212529",e.font=`bold ${Math.max(16,b*1.2)}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="left",e.textBaseline="middle",e.fillText(u.label,x,m)}}}function wi(e,n,i,s){const a=s*1.5;e.save(),e.fillStyle="#FFD700",e.shadowColor="#FFD700",e.shadowBlur=6;for(let c=0;c<8;c++){const l=c/8*Math.PI*2,d=n+Math.cos(l)*a,g=i+Math.sin(l)*a;e.beginPath(),e.arc(d,g,3,0,Math.PI*2),e.fill()}e.restore()}function Mi(e){const n=e.replace(/\d+$/,"");return n.length>0?n:e}function hn(e,n){return!Number.isFinite(n)||n<=0?e:Math.round(e*n)/n}function Ti(e,n,i,s){const r=Math.max(10,Math.min(e*1.2,n*1.2)),o=i<=3?1:.7,a=s<=1?1.08:1;return hn(r*o*a,s)}function _i(e){const n=e.getContext("2d");return n&&(n.getTransform().a||window.devicePixelRatio)||1}function Pi(e){if(typeof e.midi=="number")return e.midi%12;if(typeof e.pitchClass=="number")return e.pitchClass;const n={C:0,D:2,E:4,F:5,G:7,A:9,B:11},i=e.pitch.charAt(0).toUpperCase();let s=n[i]??0;return(e.pitch.includes("#")||e.pitch.includes("â™¯"))&&s++,(e.pitch.includes("b")||e.pitch.includes("â™­"))&&s--,(s%12+12)%12}function Ci(e){return e?Array.isArray(e)?e:[e]:[]}function Si(e,n){const{showFrequencyLabels:i,showOctaveLabels:s,accidentalMode:r}=n,o=h=>s?h:Mi(h);if(i)return String(Math.round(e.frequency));const{flatName:a,sharpName:c,isAccidental:l}=e,{sharp:d,flat:g}=r;return l?d&&g?o(e.pitch):d&&!g?o(c):g&&!d?o(a):null:o(a)}function Ft(e,n,i,s){const{fullRowData:r,cellWidth:o,cellHeight:a,legendColumnWidth:c,colorMode:l,accidentalMode:d}=n,{startRow:g,endRow:h,coords:u}=i,y=_i(e.canvas),v=T=>hn(T,y),f=Ci(n.highlight),m=c;let b=0;for(const T of s){for(let C=g;C<=h;C++){const I=r[C];if(!I||I.isBoundary||I.column!==T)continue;const P=u.getRowY(C),_=!d.sharp&&!d.flat,x=I.isAccidental&&_,N=Si(I,n);if(N===null)continue;let k=l==="bw"?"#ffffff":I.hex||"#ffffff",D="FF";if(x&&(D="00"),e.fillStyle=x?"rgba(255,255,255,0)":k,e.fillRect(b,P-a/2,m,a),f.length>0)for(const z of f){if(z.opacity<=0)continue;let S=!1;typeof z.midi=="number"?S=typeof I.midi=="number"&&I.midi===Math.round(z.midi):typeof z.pitchClass=="number"&&(S=Pi(I)===z.pitchClass),S&&(e.save(),e.globalAlpha=Math.min(Math.max(z.opacity,0),1),e.fillStyle=z.color??"#ffff00",e.fillRect(b,P-a/2,m,a),e.restore())}const E=Ti(o,a,N.length,y);e.font=`bold ${E}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle";const U=v(b+m/2),te=v(P);e.strokeStyle=`#212529${D}`,e.lineWidth=Math.max(1.2,2.5/y),e.lineJoin="round",e.strokeText(N,U,te),e.fillStyle=`#ffffff${D}`,e.fillText(N,U,te)}b+=m}}function xi(e,n,i,s){e&&(e.clearRect(0,0,e.canvas.width,e.canvas.height),Ft(e,i,s,["B","A"])),n&&(n.clearRect(0,0,n.canvas.width,n.canvas.height),Ft(n,i,s,["A","B"]))}var Ii=L('<canvas class="pitch-grid-legend pitch-grid-legend--left svelte-1b4jihh"></canvas>'),Ai=L('<canvas class="pitch-grid-legend pitch-grid-legend--right svelte-1b4jihh"></canvas>'),Ri=L('<div class="pitch-grid-container svelte-1b4jihh"><!> <canvas class="pitch-grid-canvas svelte-1b4jihh"></canvas> <!></div>');function Ni(e,n){pe(n,!0);let i=fe(n,"colorMode",3,"color"),s=fe(n,"degreeDisplayMode",3,"off"),r=fe(n,"accidentalMode",19,()=>({sharp:!0,flat:!0})),o=fe(n,"showFrequencyLabels",3,!1),a=fe(n,"showOctaveLabels",3,!0),c=fe(n,"showRightLegend",3,!0),l=fe(n,"placedNotes",19,()=>[]),d=fe(n,"placedTonicSigns",19,()=>[]),g=fe(n,"columnWidths",19,()=>[]),h=fe(n,"macrobeatGroupings",19,()=>[]),u=fe(n,"macrobeatBoundaryStyles",19,()=>[]),y=fe(n,"longNoteStyle",3,"style1"),v=fe(n,"beatIntervalMs",3,500),f=fe(n,"beatTimeOffsetMs",3,0),m=K(void 0),b=K(void 0),T=K(void 0),C=K(null),I=K(null),P=K(null),_=K(null);const x=3,N=A(()=>n.cellWidth*x),k=A(()=>t(N)*2),D=A(()=>a()||o()),E=A(()=>t(D)?t(k)*(c()?2:1):0),U=A(()=>Math.max(0,n.viewport.containerWidth-t(E))),te=A(()=>n.mode==="notation"||n.mode==="playback"),z=A(()=>n.mode==="singing"),S=A(()=>n.mode==="highway");function G(){if(t(te))return Jn({cellWidth:n.cellWidth,cellHeight:n.cellHeight,columnWidths:g(),viewport:n.viewport,tempoModulationMarkers:n.tempoModulationMarkers});{const M=t(S)?n.highwayConfig:n.singingConfig;return rn({cellWidth:n.cellWidth,cellHeight:n.cellHeight,viewport:n.viewport,pixelsPerSecond:M?.pixelsPerSecond??200,nowLineX:M?.nowLineX??100,currentTimeMs:M?.currentTimeMs??0})}}function Q(){if(!t(C)||!t(m))return;const M=G(),{paddedStartRow:O,paddedEndRow:W}=$n(n.viewport,n.fullRowData);t(C).clearRect(0,0,t(U),n.viewport.containerHeight);const oe={fullRowData:n.fullRowData,cellHeight:n.cellHeight,viewportHeight:n.viewport.containerHeight,viewportWidth:t(U),colorMode:i()};ii(t(C),oe,M,O,W),t(te)?le(t(C),M):t(z)?Te(t(C),M):t(S)&&Pe(t(C),M),t(D)&&(t(I)||t(P))&&$(M,O,W)}function le(M,O){const W=B(h()),oe={columnWidths:g(),cellWidth:n.cellWidth,viewportHeight:n.viewport.containerHeight,macrobeatGroupings:h(),macrobeatBoundaryStyles:u(),placedTonicSigns:d()};si(M,oe,O,W);const ge=l().filter(ie=>ie.isDrum||ie.globalRow===void 0?!1:gt(ie.globalRow,n.viewport,n.cellHeight,O)),Me=d().filter(ie=>ie.globalRow===void 0?!1:gt(ie.globalRow,n.viewport,n.cellHeight,O)),Ie={config:{cellWidth:n.cellWidth,cellHeight:n.cellHeight,columnWidths:g(),degreeDisplayMode:s(),accidentalMode:r(),longNoteStyle:y(),colorMode:i()},coords:O,allNotes:l()};for(const ie of ge)ie.shape==="oval"?Lt(M,Ie,ie,ie.globalRow):ie.shape==="circle"&&Dt(M,Ie,ie,ie.globalRow);for(const ie of Me)yi(M,Ie,ie)}function Te(M,O){if(!n.singingConfig)return;const W={cellHeight:n.cellHeight,viewportWidth:t(U),pixelsPerSecond:n.singingConfig.pixelsPerSecond??200,timeWindowMs:n.singingConfig.timeWindowMs??4e3,colorMode:i(),trailConfig:n.singingConfig.trailConfig};n.singingConfig.pitchHistory&&n.singingConfig.pitchHistory.length>0&&fn(M,O,n.singingConfig.pitchHistory,performance.now(),W,n.fullRowData),n.singingConfig.targetNotes&&n.singingConfig.targetNotes.length>0&&Ot(M,O,n.singingConfig.targetNotes,performance.now(),W,n.fullRowData),n.singingConfig.userPitch&&n.singingConfig.userPitch.clarity>.5&&Et(M,O,n.singingConfig.userPitch.midi,n.singingConfig.userPitch.clarity,t(U)-20,W,n.fullRowData)}function Pe(M,O){if(!n.highwayConfig)return;const W={cellHeight:n.cellHeight,viewportWidth:n.viewport.containerWidth,nowLineX:n.highwayConfig.nowLineX,pixelsPerSecond:n.highwayConfig.pixelsPerSecond??200,timeWindowMs:n.highwayConfig.timeWindowMs??4e3,colorMode:i(),trailConfig:n.highwayConfig.trailConfig};if(n.highwayConfig.scrollingGridData&&n.highwayConfig.scrollOffset!==void 0)Ce(M,O);else{const ge={startMs:n.highwayConfig.currentTimeMs-1e3,endMs:n.highwayConfig.currentTimeMs+t(U)/(n.highwayConfig.pixelsPerSecond??200)*1e3},Me={viewportWidth:t(U),viewportHeight:n.viewport.containerHeight,beatIntervalMs:v(),visibleTimeRange:ge,nowLineX:n.highwayConfig.nowLineX,beatTimeOffsetMs:f()};ai(M,Me,O),n.highwayConfig.targetNotes&&n.highwayConfig.targetNotes.length>0&&Ot(M,O,n.highwayConfig.targetNotes,n.highwayConfig.currentTimeMs,W,n.fullRowData,n.highwayConfig.userPitch?.midi??null,n.highwayConfig.userPitch?.clarity??0)}ne(M,n.highwayConfig.nowLineX,n.viewport.containerHeight),n.highwayConfig.showOnrampCountdown&&n.highwayConfig.onrampBeatsRemaining!==void 0&&V(M,n.highwayConfig.onrampBeatsRemaining),n.highwayConfig.userPitch&&n.highwayConfig.userPitch.clarity>.5&&Et(M,O,n.highwayConfig.userPitch.midi,n.highwayConfig.userPitch.clarity,n.highwayConfig.nowLineX,W,n.fullRowData)}function Ce(M,O){if(!n.highwayConfig?.scrollingGridData||n.highwayConfig.scrollOffset===void 0)return;const W=n.highwayConfig.scrollingGridData,oe=n.highwayConfig.scrollOffset,ge=B(W.macrobeatGroupings);for(let re=0;re<ge.length;re++){const ie=ge[re]*n.cellWidth-oe;if(ie>=-n.cellWidth&&ie<=t(U)+n.cellWidth){const ke=W.macrobeatBoundaryStyles[re]||"solid",De=ke==="solid"?2:1,Ue=ke==="dashed"?[5,5]:[];M.strokeStyle="#495057",M.lineWidth=De,M.setLineDash(Ue),M.beginPath(),M.moveTo(ie,0),M.lineTo(ie,n.viewport.containerHeight),M.stroke(),M.setLineDash([])}}const Me={cellWidth:n.cellWidth,cellHeight:n.cellHeight,columnWidths:W.columnWidths,degreeDisplayMode:s(),accidentalMode:r(),longNoteStyle:y(),colorMode:i()};for(const re of W.placedNotes){if(re.isDrum||re.globalRow===void 0||!gt(re.globalRow,n.viewport,n.cellHeight,O))continue;const Ie=re.startColumnIndex*n.cellWidth-oe;if(re.endColumnIndex*n.cellWidth-oe>=-n.cellWidth&&Ie<=t(U)+n.cellWidth){const ke={...O,getColumnX:Ue=>Ue*n.cellWidth-oe},De={config:Me,coords:ke,allNotes:W.placedNotes};re.shape==="oval"?Lt(M,De,re,re.globalRow):re.shape==="circle"&&Dt(M,De,re,re.globalRow)}}}function ne(M,O,W){M.strokeStyle="rgba(255, 0, 0, 0.9)",M.lineWidth=3,M.beginPath(),M.moveTo(O,0),M.lineTo(O,W),M.stroke()}function V(M,O){M.fillStyle="rgba(0, 0, 0, 0.7)",M.fillRect(t(U)/2-40,10,80,50),M.fillStyle="#ffffff",M.font="bold 36px sans-serif",M.textAlign="center",M.textBaseline="middle",M.fillText(O.toString(),t(U)/2,35)}function $(M,O,W){const oe={fullRowData:n.fullRowData,cellWidth:n.cellWidth,cellHeight:n.cellHeight,legendColumnWidth:t(N),colorMode:i(),showFrequencyLabels:o(),showOctaveLabels:a(),accidentalMode:r(),highlight:n.legendHighlight},ge={startRow:O,endRow:W,coords:M};xi(t(I),t(P),oe,ge)}function B(M){const O=[];let W=0;for(const oe of M)W+=oe,O.push(W);return O}function R(){if(t(_))return;function M(){Q(),F(_,requestAnimationFrame(M),!0)}F(_,requestAnimationFrame(M),!0)}function Z(){t(_)&&(cancelAnimationFrame(t(_)),F(_,null))}function ae(){if(!t(m)||(F(C,t(m).getContext("2d"),!0),!t(C)))return;const M=window.devicePixelRatio||1;t(m).width=t(U)*M,t(m).height=n.viewport.containerHeight*M,t(m).style.width=`${t(U)}px`,t(m).style.height=`${n.viewport.containerHeight}px`,t(C).scale(M,M),t(b)&&(F(I,t(b).getContext("2d"),!0),t(I)&&(t(b).width=t(k)*M,t(b).height=n.viewport.containerHeight*M,t(b).style.width=`${t(k)}px`,t(b).style.height=`${n.viewport.containerHeight}px`,t(I).scale(M,M))),t(T)&&(F(P,t(T).getContext("2d"),!0),t(P)&&(t(T).width=t(k)*M,t(T).height=n.viewport.containerHeight*M,t(T).style.width=`${t(k)}px`,t(T).style.height=`${n.viewport.containerHeight}px`,t(P).scale(M,M))),Q(),(t(z)||t(S))&&R()}tn(()=>{ae()}),Ye(()=>{Z()}),Re(()=>{n.mode,n.viewport,n.cellWidth,n.cellHeight,i(),s(),l(),d(),g(),t(C)&&t(te)&&Q()}),Re(()=>{n.mode,t(z)||t(S)?R():(Z(),t(C)&&Q())}),Re(()=>{n.viewport.containerWidth,n.viewport.containerHeight,t(C)&&t(m)&&ae()});var ue=Ri(),be=p(ue);{var we=M=>{var O=Ii();Ne(O,W=>F(b,W),()=>t(b)),H(M,O)};ee(be,M=>{t(D)&&M(we)})}var me=w(be,2);Ne(me,M=>F(m,M),()=>t(m));var X=w(me,2);{var se=M=>{var O=Ai();Ne(O,W=>F(T,W),()=>t(T)),H(M,O)};ee(X,M=>{t(D)&&c()&&M(se)})}H(e,ue),ye()}const Wt={isDetecting:!1,visualizationMode:"highway",tonic:"C",useDegrees:!1,showAccidentals:!0,pitchHighlightEnabled:!0,yAxisRange:{minMidi:40,maxMidi:72},drone:{isPlaying:!1,octave:3,volume:-12}};function ki(){let e=K(Le({...Wt}));return{get state(){return t(e)},toggleDetecting(){t(e).isDetecting=!t(e).isDetecting},setDetecting(n){t(e).isDetecting=n},setVisualizationMode(n){t(e).visualizationMode=n},setTonic(n){t(e).tonic=n},setUseDegrees(n){t(e).useDegrees=n},setShowAccidentals(n){t(e).showAccidentals=n},togglePitchHighlight(){t(e).pitchHighlightEnabled=!t(e).pitchHighlightEnabled},setPitchHighlightEnabled(n){t(e).pitchHighlightEnabled=n},setYAxisRange(n){t(e).yAxisRange=n},expandYAxisUpper(){t(e).yAxisRange.maxMidi<108&&(t(e).yAxisRange={...t(e).yAxisRange,maxMidi:t(e).yAxisRange.maxMidi+1})},contractYAxisUpper(){t(e).yAxisRange.maxMidi>t(e).yAxisRange.minMidi+6&&(t(e).yAxisRange={...t(e).yAxisRange,maxMidi:t(e).yAxisRange.maxMidi-1})},expandYAxisLower(){t(e).yAxisRange.minMidi>21&&(t(e).yAxisRange={...t(e).yAxisRange,minMidi:t(e).yAxisRange.minMidi-1})},contractYAxisLower(){t(e).yAxisRange.minMidi<t(e).yAxisRange.maxMidi-6&&(t(e).yAxisRange={...t(e).yAxisRange,minMidi:t(e).yAxisRange.minMidi+1})},toggleDrone(){t(e).drone={...t(e).drone,isPlaying:!t(e).drone.isPlaying}},setDroneOctave(n){t(e).drone={...t(e).drone,octave:n}},setDroneVolume(n){t(e).drone={...t(e).drone,volume:n}},reset(){F(e,{...Wt},!0)}}}const j=ki(),Hi=200,Bt={currentPitch:null,history:[],stablePitch:{highlights:[],size:1}};function Li(){let e=K(Le({...Bt}));return{get state(){return t(e)},setCurrentPitch(n){t(e).currentPitch=n},addHistoryPoint(n){t(e).history.push(n),t(e).history.length>Hi&&t(e).history.shift()},setStablePitch(n){t(e).stablePitch=n},clearHistory(){t(e).history=[]},reset(){F(e,{...Bt},!0)}}}const ce=Li(),Gt={isPlaying:!1,startTime:null,currentTimeMs:0,targetNotes:[],nowLineX:100,pixelsPerSecond:200,timeWindowMs:4e3};function Di(){let e=K(Le({...Gt})),n=null,i=null,s=null;function r(l){return l.map((d,g)=>({id:`target-${g}`,midi:d.midi,startTimeMs:d.startTimeMs,durationMs:d.durationMs,startColumn:0,endColumn:0,color:"#3b82f6",shape:"oval",globalRow:0}))}function o(){if(!n)return;const l=n.getState();t(e).isPlaying=l.isPlaying&&!l.isPaused,t(e).currentTimeMs=l.currentTimeMs;const d=n.getPerformanceResults();t(e).targetNotes=t(e).targetNotes.map((g,h)=>{const u=`target-${h}`,y=d.get(u);return{...g,hit:y?.hitStatus==="hit"}})}function a(){t(e).isPlaying&&n?(o(),i=requestAnimationFrame(a)):i=null}function c(){n&&n.dispose(),n=Zn({judgmentLinePosition:t(e).nowLineX/800,pixelsPerSecond:t(e).pixelsPerSecond,lookAheadMs:t(e).timeWindowMs,scrollMode:"constant-speed",leadInBeats:0,playMetronomeDuringOnramp:!1,playTargetNotes:!1,playMetronome:!1,inputSources:["microphone"],feedbackConfig:{onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70},stateCallbacks:{getTempo:()=>120,getCellWidth:()=>20,getViewportWidth:()=>800},eventCallbacks:{emit:(d,g)=>{if(console.debug("[Highway]",d,g),d==="noteHit"){const h=g;console.log(`[Highway] Note HIT: ${h.noteId}, accuracy: ${h.performance.accuracyTier||"unknown"}`)}else d==="noteMissed"?console.log(`[Highway] Note MISSED: ${g.noteId}`):d==="onrampComplete"?console.log("[Highway] Onramp complete, playback starting!"):d==="performanceComplete"&&(console.log("[Highway] Performance complete!"),s&&n&&s(n.getPerformanceResults()))}}});const l=r(t(e).targetNotes);n.init(l)}return{get state(){return t(e)},get engineService(){return n},start(){!n&&t(e).targetNotes.length>0&&c(),n&&(n.start(),t(e).isPlaying=!0,t(e).startTime=performance.now(),t(e).currentTimeMs=0,a())},stop(){n&&n.stop(),t(e).isPlaying=!1,i!==null&&(cancelAnimationFrame(i),i=null)},pause(){n&&n.pause(),t(e).isPlaying=!1,i!==null&&(cancelAnimationFrame(i),i=null)},resume(){n&&(n.resume(),t(e).isPlaying=!0,a())},setTargetNotes(l){if(t(e).targetNotes=l,n){const d=r(l);n.init(d)}},markNoteHit(l){l>=0&&l<t(e).targetNotes.length&&(t(e).targetNotes=t(e).targetNotes.map((d,g)=>g===l?{...d,hit:!0}:d))},setNowLineX(l){t(e).nowLineX=l},setPixelsPerSecond(l){t(e).pixelsPerSecond=l},setTimeWindowMs(l){t(e).timeWindowMs=l},recordPitchInput(l,d){n&&t(e).isPlaying&&n.recordPitchInput(l,d,"microphone")},getPerformanceResults(){return n?.getPerformanceResults()??new Map},setCurrentTime(l){t(e).currentTimeMs=l,n&&n.setScrollOffset(l)},onPerformanceComplete(l){return s=l,()=>{s=null}},reset(){i!==null&&(cancelAnimationFrame(i),i=null),n&&(n.dispose(),n=null),F(e,{...Gt},!0)}}}const de=Di(),Ei={numLoops:5,minMidi:48,maxMidi:72,tempo:108,referenceVolume:-12},Yt={isActive:!1,isPlaying:!1,config:{...Ei},currentLoop:0,currentPhase:"reference",currentPitch:null,generatedNotes:[],results:[]};function Oi(e,n){return Math.floor(Math.random()*(n-e+1))+e}function qt(e){return 60/e*1e3/2}function Fi(){let e=K(Le({...Yt}));function n(s){const r=[],o=qt(s.tempo),a=2e3;for(let c=0;c<s.numLoops;c++){const l=Oi(s.minMidi,s.maxMidi),d=a+c*32*o;r.push({midi:l,startTimeMs:d,durationMs:8*o,lyric:"ðŸ‘‚"}),r.push({midi:l,startTimeMs:d+16*o,durationMs:8*o,lyric:"ðŸŽ¤"})}return r}function i(s,r){const o=qt(r),a=32*o,l=s-2e3;if(l<0)return{loop:0,phase:"rest2"};const d=Math.floor(l/a),g=l%a,h=Math.floor(g/o);let u;return h<8?u="reference":h<16?u="rest1":h<24?u="input":u="rest2",{loop:d,phase:u}}return{get state(){return t(e)},configure(s){t(e).config={...t(e).config,...s}},setPitchRange(s,r){t(e).config.minMidi=s,t(e).config.maxMidi=r},start(){const s=n(t(e).config);t(e).generatedNotes=s,t(e).isActive=!0,t(e).isPlaying=!1,t(e).currentLoop=0,t(e).currentPhase="reference",t(e).currentPitch=s.length>0?s[0].midi:null,t(e).results=[]},stop(){t(e).isActive=!1,t(e).isPlaying=!1,t(e).currentLoop=0,t(e).currentPhase="reference",t(e).currentPitch=null},setPlaying(s){t(e).isPlaying=s},updatePhase(s){const{loop:r,phase:o}=i(s,t(e).config.tempo);t(e).currentLoop=r,t(e).currentPhase=o;const a=r*2;a<t(e).generatedNotes.length&&(t(e).currentPitch=t(e).generatedNotes[a].midi)},addResult(s){t(e).results.push(s)},hasResultForLoop(s){return t(e).results.some(r=>r.loopIndex===s)},getResults(){return t(e).results},getCurrentProgress(){return{current:t(e).currentLoop+1,total:t(e).config.numLoops}},getGeneratedNotes(){return t(e).generatedNotes},getAverageAccuracy(){return t(e).results.length===0?0:t(e).results.reduce((r,o)=>r+o.accuracy,0)/t(e).results.length},getHitCount(){return t(e).results.filter(s=>s.performance?.hitStatus==="hit").length},reset(){F(e,{...Yt,config:{...t(e).config}},!0)}}}const he=Fi();var Wi=L('<div class="singing-canvas-container svelte-wysbg"><!> <canvas class="pitch-trail-canvas svelte-wysbg"></canvas></div>');function Bi(e,n){pe(n,!0);let i=K(void 0),s=K(800),r=K(400),o=K(void 0),a=K(null),c=K(null),l=0,d=0,g=0;const h=20,u=!0,y=!1,v=A(()=>t(s)>=720),f=3,m=A(()=>h*f),b=A(()=>t(m)*2),T=A(()=>u),C=A(()=>t(T)?t(b)*(t(v)?2:1):0),I=A(()=>Math.max(0,t(s)-t(C))),P=A(()=>t(T)?t(b):0),_=()=>{try{return!!globalThis.__ST_DEBUG_TRAIL}catch{return!1}},x=A(()=>Hn(j.state.yAxisRange.minMidi,j.state.yAxisRange.maxMidi)),N=A(()=>Ln({containerHeight:t(r),fullRowData:t(x),preferredCellHeight:40,minCellHeight:20})),k=A(()=>j.state.visualizationMode==="highway"?"highway":"singing"),D=A(()=>60/he.state.config.tempo*1e3),E=2e3,U=A(()=>(()=>{if(!j.state.pitchHighlightEnabled)return;const B=ce.state.stablePitch;if(B.highlights.length!==0)return B.highlights.map(R=>({pitchClass:R.pitchClass,midi:R.midi,opacity:R.opacity,color:"#ffff00"}))})());function te(){return de.state.targetNotes.map((B,R)=>({id:`target-${R}`,midi:B.midi,startTimeMs:B.startTimeMs,durationMs:B.durationMs,label:B.lyric}))}const z=A(()=>({timeWindowMs:4e3,pixelsPerSecond:200,circleRadius:9.5,proximityThreshold:35,maxConnections:3,connectorLineWidth:2.5,connectorColor:"rgba(0,0,0,0.4)",useTonicRelativeColors:!0,tonicPitchClass:zn(j.state.tonic),clarityThreshold:.5,maxOpacity:.9})),S=A(()=>t(k)==="singing"?{userPitch:ce.state.currentPitch?{frequency:ce.state.currentPitch.frequency,midi:ce.state.currentPitch.midi,clarity:ce.state.currentPitch.clarity,pitchClass:ce.state.currentPitch.pitchClass}:null,pitchHistory:[],targetNotes:[],pixelsPerSecond:200,timeWindowMs:4e3,trailConfig:t(z)}:void 0),G=A(()=>t(k)==="highway"?{userPitch:ce.state.currentPitch?{frequency:ce.state.currentPitch.frequency,midi:ce.state.currentPitch.midi,clarity:ce.state.currentPitch.clarity,pitchClass:ce.state.currentPitch.pitchClass}:null,pitchHistory:[],targetNotes:te(),nowLineX:de.state.nowLineX,pixelsPerSecond:de.state.pixelsPerSecond,currentTimeMs:de.state.currentTimeMs,timeWindowMs:de.state.timeWindowMs,trailConfig:t(z)}:void 0),Q=A(()=>({startRow:t(N).startRow,endRow:t(N).endRow,zoomLevel:1,containerWidth:t(s),containerHeight:t(r)}));function le(){if(!t(o))return;const B=window.devicePixelRatio||1;t(o).width=t(I)*B,t(o).height=t(r)*B,t(o).style.width=`${t(I)}px`,t(o).style.height=`${t(r)}px`,t(o).style.left=`${t(P)}px`;const R=t(o).getContext("2d");if(!R){F(a,null);return}R.setTransform(B,0,0,B,0,0),F(a,R,!0)}function Te(){if(!t(a)||t(I)<=0)return;t(a).clearRect(0,0,t(I),t(r));const B=ce.state.history;if(B.length===0)return;const R=t(k)==="singing"?t(S):t(G);if(!R)return;const Z=_(),ae=Z?performance.now():0,ue=t(k)==="highway"&&t(G)?t(G).nowLineX:100,be=rn({cellHeight:t(N).cellHeight,viewport:t(Q),pixelsPerSecond:R.pixelsPerSecond??200,nowLineX:ue,currentTimeMs:t(k)==="highway"&&t(G)?t(G).currentTimeMs:0}),we={cellHeight:t(N).cellHeight,viewportWidth:t(I),nowLineX:ue,pixelsPerSecond:R.pixelsPerSecond??200,timeWindowMs:R.timeWindowMs??4e3,colorMode:"color",trailConfig:t(z)},me=performance.now();if(fn(t(a),be,B,me,we,t(x)),Z){const X=performance.now();if(d+=1,g+=X-ae,X-l>=1e3){const se=d>0?g/d:0;console.log(`[SingingTrail] points=${B.length} avgMs=${se.toFixed(2)} gridWidth=${t(I)}`),l=X,d=0,g=0}}}function Pe(){if(t(c))return;const B=()=>{Te(),F(c,requestAnimationFrame(B),!0)};F(c,requestAnimationFrame(B),!0)}function Ce(){t(c)&&(cancelAnimationFrame(t(c)),F(c,null)),t(a)&&t(I)>0&&t(a).clearRect(0,0,t(I),t(r))}Re(()=>{if(!t(i))return;const B=new ResizeObserver(R=>{for(const Z of R)F(s,Z.contentRect.width,!0),F(r,Z.contentRect.height,!0)});return B.observe(t(i)),()=>{B.disconnect()}}),Re(()=>{t(I),t(r),t(P),t(o),le()}),Re(()=>{t(k),t(a),t(k)==="singing"||t(k)==="highway"?Pe():Ce()}),Ye(()=>{Ce()});var ne=Wi(),V=p(ne);Ni(V,{get mode(){return t(k)},get fullRowData(){return t(x)},get viewport(){return t(Q)},cellWidth:h,get cellHeight(){return t(N).cellHeight},colorMode:"color",showOctaveLabels:u,showFrequencyLabels:y,get showRightLegend(){return t(v)},get singingConfig(){return t(S)},get highwayConfig(){return t(G)},get legendHighlight(){return t(U)},get beatIntervalMs(){return t(D)},beatTimeOffsetMs:E});var $=w(V,2);Ne($,B=>F(o,B),()=>t(o)),Ne(ne,B=>F(i,B),()=>t(i)),H(e,ne),ye()}const Ut=100,vt=12;function Vt(e){return(Math.round(e)%vt+vt)%vt}class Gi{synth=null;scheduledTimeouts=[];volume=null;startTime=0;_isPlaying=!1;get isPlaying(){return this._isPlaying}async init(){await Pt(),this.volume=new Bn(-12).toDestination(),this.synth=new nn({oscillator:{type:"triangle"},envelope:{attack:.05,decay:.1,sustain:.9,release:.1}}).connect(this.volume)}setVolume(n){this.volume&&(this.volume.volume.value=n)}scheduleReferenceTones(n){if(!this.synth){console.warn("[ReferenceAudio] Synth not initialized");return}this.clearScheduled(),this.startTime=performance.now(),n.forEach(i=>{const s=i.durationMs/1e3,r=At(i.midi,"midi").toFrequency(),o=window.setTimeout(()=>{this.synth&&(console.log(`[ReferenceAudio] Playing ${i.midi} at ${performance.now()-this.startTime}ms`),this._isPlaying=!0,this.synth.triggerAttackRelease(r,s))},i.startTimeMs),a=window.setTimeout(()=>{this._isPlaying=!1},i.startTimeMs+i.durationMs);this.scheduledTimeouts.push(o,a)}),console.log(`[ReferenceAudio] Scheduled ${n.length} reference tones`)}playTone(n,i){if(!this.synth){console.warn("[ReferenceAudio] Synth not initialized");return}const s=At(n,"midi").toFrequency(),r=i/1e3;this.synth.triggerAttackRelease(s,r)}clearScheduled(){this.scheduledTimeouts.forEach(n=>{window.clearTimeout(n)}),this.scheduledTimeouts=[]}stop(){this.clearScheduled(),this.synth&&this.synth.triggerRelease()}dispose(){this.stop(),this.synth&&(this.synth.dispose(),this.synth=null),this.volume&&(this.volume.dispose(),this.volume=null)}}const je=new Gi,Ee={FFT_SIZE:2048,CLARITY_THRESHOLD:.8,MIN_PITCH_HZ:60,MAX_PITCH_HZ:1600,HIGHLIGHT_CORE_CENTS:25,HIGHLIGHT_CROSSFADE_CENTS:50};let We=null,Be=null,ot=null,He=null,rt=!1;const wt=1;function Yi(e){return 12*Math.log2(e/440)+69}function Mt(){if(!rt||!Be||!ot){He=null;return}if(je.isPlaying){ce.addHistoryPoint({frequency:0,midi:0,time:performance.now(),clarity:0}),He=requestAnimationFrame(Mt);return}const e=Be.getValue(),[n,i]=ot.findPitch(e,qn().sampleRate),s=n!==null&&i>Ee.CLARITY_THRESHOLD&&n>Ee.MIN_PITCH_HZ&&n<Ee.MAX_PITCH_HZ;if(s){const r=Yi(n),o={frequency:n,midi:r,clarity:i,pitchClass:Math.round(r)%12};ce.setCurrentPitch(o),ce.addHistoryPoint({frequency:n,midi:r,time:performance.now(),clarity:i}),de.recordPitchInput(r,i)}else ce.addHistoryPoint({frequency:0,midi:0,time:performance.now(),clarity:0});if(s&&ce.state.currentPitch){const r=ce.state.currentPitch.midi,o=Math.floor(r),a=o+1,c=(r-o)*Ut,l=Ee.HIGHLIGHT_CORE_CENTS,d=Ut-Ee.HIGHLIGHT_CORE_CENTS;let g=0,h=0;if(c<=l)g=1;else if(c>=d)h=1;else{const y=(c-l)/Ee.HIGHLIGHT_CROSSFADE_CENTS;g=1-y,h=y}const u=[];g>0&&u.push({pitchClass:Vt(o),midi:o,opacity:g}),h>0&&u.push({pitchClass:Vt(a),midi:a,opacity:h}),ce.setStablePitch({highlights:u,size:wt})}else ce.setStablePitch({highlights:[],size:wt});He=requestAnimationFrame(Mt)}async function qi(){if(!rt){He!==null&&cancelAnimationFrame(He),We=new Gn,Be=new Yn("waveform",Ee.FFT_SIZE),ot=Vn.forFloat32Array(Be.size);try{await Pt(),await We.open(),We.connect(Be),rt=!0,Mt()}catch(e){throw console.error("Microphone access denied or failed:",e),gn(),e}}}function Ui(){rt=!1,gn()}function gn(){He!==null&&(cancelAnimationFrame(He),He=null),We&&(We.close(),We=null),Be=null,ot=null,ce.setStablePitch({highlights:[],size:wt}),ce.setCurrentPitch(null)}_e(["click"]);let Ae=null,Qe=!1,$e=null;function Vi(){if(!Ae){Ae=new Un(nn,{oscillator:{type:"sawtooth"},envelope:{attack:.3,decay:.1,sustain:.8,release:.5}}).toDestination();const e=Ae.get().oscillator?.type??"unknown";console.log("[DroneAudio] Initialized drone synth",{oscillatorType:e})}return Ae}function vn(e,n){return`${e.replace("b","#").replace("Db","C#").replace("Eb","D#").replace("Gb","F#").replace("Ab","G#").replace("Bb","A#")}${n}`}async function Xi(){await Pt();const e=Vi(),n=vn(j.state.tonic,j.state.drone.octave);e.volume.value=j.state.drone.volume,console.log("[DroneAudio] Starting drone",{note:n,volume:e.volume.value}),$e&&e.releaseAll(),$e=n,e.triggerAttack(n),Qe=!0}function ji(){Ae&&Qe&&(Ae.releaseAll(),$e=null,Qe=!1)}function Tt(){if(!Qe||!Ae)return;const e=vn(j.state.tonic,j.state.drone.octave);Ae.volume.value=j.state.drone.volume,console.log("[DroneAudio] Updating drone",{note:e,volume:Ae.volume.value}),e!==$e&&(Ae.releaseAll(),Ae.triggerAttack(e),$e=e)}async function zi(){Qe?ji():await Xi()}var Ki=L("<option> </option>"),Zi=L('<div class="tonic-selector svelte-3w4ray"><label for="tonic-select" class="svelte-3w4ray">Key:</label> <select id="tonic-select" class="svelte-3w4ray"></select></div>');function Ji(e,n){pe(n,!1);const i=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function s(c){const l=c.target;j.setTonic(l.value),Tt()}_t();var r=Zi(),o=w(p(r),2);o.__change=s,Ge(o,5,()=>i,et,(c,l)=>{var d=Ki(),g=p(d),h={};J(()=>{q(g,t(l)),h!==(h=t(l))&&(d.value=(d.__value=t(l))??"")}),H(c,d)});var a;sn(o),J(()=>{a!==(a=j.state.tonic)&&(o.value=(o.__value=j.state.tonic)??"",Ct(o,j.state.tonic))}),H(e,r),ye()}_e(["change"]);var Qi=L("<option> </option>"),$i=L('<div class="drone-controls svelte-z4onaa"><button> </button> <div class="drone-settings svelte-z4onaa"><label class="svelte-z4onaa">Oct: <select class="svelte-z4onaa"></select></label> <label class="svelte-z4onaa">Vol: <input type="range" min="-40" max="0" class="svelte-z4onaa"/></label></div></div>');function es(e,n){pe(n,!1);const i=[2,3,4,5];async function s(){await zi(),j.toggleDrone()}function r(m){const b=m.target;j.setDroneOctave(parseInt(b.value,10)),Tt()}function o(m){const b=m.target;j.setDroneVolume(parseInt(b.value,10)),Tt()}_t();var a=$i(),c=p(a);let l;c.__click=s;var d=p(c),g=w(c,2),h=p(g),u=w(p(h));u.__change=r,Ge(u,5,()=>i,et,(m,b)=>{var T=Qi(),C=p(T),I={};J(()=>{q(C,t(b)),I!==(I=t(b))&&(T.value=(T.__value=t(b))??"")}),H(m,T)});var y;sn(u);var v=w(h,2),f=w(p(v));f.__input=o,J(()=>{l=qe(c,1,"drone-toggle svelte-z4onaa",null,l,{active:j.state.drone.isPlaying}),q(d,j.state.drone.isPlaying?"Drone On":"Drone Off"),y!==(y=j.state.drone.octave)&&(u.value=(u.__value=j.state.drone.octave)??"",Ct(u,j.state.drone.octave)),In(f,j.state.drone.volume)}),H(e,a),ye()}_e(["click","change","input"]);_e(["click"]);var ts=L('<div class="pitch-wheel-option svelte-i0c5ty"> </div>'),ns=L('<div class="pitch-wheel svelte-i0c5ty" role="slider" tabindex="0" aria-valuemin="0"><div class="pitch-wheel-viewport svelte-i0c5ty"><div class="pitch-wheel-options svelte-i0c5ty"></div></div> <div class="pitch-wheel-overlay svelte-i0c5ty"></div></div>');function Xt(e,n){pe(n,!0);let i=fe(n,"selectedIndex",15),s=fe(n,"ariaLabel",3,"Pitch selector");const r=40,o=r;let a=K(void 0),c=K(void 0),l=K(void 0),d=K(!1),g=K(null),h=K(0),u=K(0),y=K(r);const v=A(()=>n.options.map((S,G)=>Math.min(Math.abs(G-i()),3))),f=A(()=>t(c)?.clientHeight??0),m=A(()=>Math.max(0,(t(f)-t(y))/2)),b=A(()=>t(m)+i()*t(y)+t(y)/2),T=A(()=>t(f)>0?t(f)/2-t(b):0);function C(S){if(!n.options||n.options.length===0)return;let G=S;typeof n.onbeforechange=="function"&&(G=n.onbeforechange(S));const Q=Math.max(0,Math.min(n.options.length-1,G));if(Q!==i()&&(i(Q),typeof n.onchange=="function")){const le=n.options[Q];le&&n.onchange(Q,le)}}function I(S){S!==0&&C(i()+S)}function P(S){S.preventDefault(),S.stopPropagation();const G=Math.sign(S.deltaY);G!==0&&I(G)}function _(S){S.key==="ArrowUp"?(S.preventDefault(),I(-1)):S.key==="ArrowDown"?(S.preventDefault(),I(1)):S.key==="Home"?(S.preventDefault(),C(0)):S.key==="End"&&(S.preventDefault(),C(n.options.length-1))}function x(S){if(S.preventDefault(),F(d,!0),F(g,S.pointerId,!0),F(h,S.clientY,!0),F(u,0),t(a)&&typeof t(a).setPointerCapture=="function")try{t(a).setPointerCapture(S.pointerId)}catch{}}function N(S){if(!t(d)||S.pointerId!==t(g))return;const G=S.clientY-t(h);if(F(h,S.clientY,!0),G===0)return;F(u,t(u)+G);const Q=t(y)||o;for(;Math.abs(t(u))>=Q;){const le=-Math.sign(t(u));I(le),F(u,t(u)-Math.sign(t(u))*Q)}}function k(S){t(d)&&S.pointerId===t(g)&&(F(d,!1),F(g,null),F(u,0),t(a)?.hasPointerCapture?.(S.pointerId)&&t(a).releasePointerCapture(S.pointerId))}Re(()=>{if(!t(l)||!t(c))return;const S=()=>{const Q=t(l)?.querySelector(".pitch-wheel-option");Q&&F(y,Q.offsetHeight||r,!0)};S();const G=new ResizeObserver(()=>{S()});return G.observe(t(c)),()=>{G.disconnect()}});var D=ns();D.__keydown=_,D.__pointerdown=x,D.__pointermove=N,D.__pointerup=k;let E;var U=p(D),te=p(U);let z;Ge(te,23,()=>n.options,S=>S.index,(S,G,Q)=>{var le=ts(),Te=p(le);J(()=>{Fe(le,"data-distance",t(v)[t(Q)]),q(Te,t(G).label)}),H(S,le)}),Ne(te,S=>F(l,S),()=>t(l)),Ne(U,S=>F(c,S),()=>t(c)),Ne(D,S=>F(a,S),()=>t(a)),J(()=>{Fe(D,"aria-label",s()),Fe(D,"aria-valuemax",n.options.length-1),Fe(D,"aria-valuenow",i()),Fe(D,"aria-valuetext",n.options[i()]?.label??""),E=st(D,"",E,{height:n.wheelHeight?`${n.wheelHeight}px`:"100%"}),z=st(te,"",z,{"padding-top":`${t(m)??""}px`,"padding-bottom":`${t(m)??""}px`,transform:`translateY(${t(T)??""}px)`})}),Ke("wheel",D,P),Ke("pointercancel",D,k),Ke("pointerleave",D,k),H(e,D),ye()}_e(["keydown","pointerdown","pointermove","pointerup"]);var is=L('<button type="button"> </button>'),ss=L('<div class="preset-buttons svelte-s7fyen"></div>');function as(e,n){pe(n,!0);function i(r){n.onPresetClick(r)}var s=ss();Ge(s,21,()=>n.presets,et,(r,o)=>{var a=is();let c;a.__click=()=>i(t(o));var l=p(a);J(()=>{c=qe(a,1,"preset-button svelte-s7fyen",null,c,{active:n.activePreset===t(o).label}),q(l,t(o).label)}),H(r,a)}),H(e,s),ye()}_e(["click"]);const mn=7;function lt(e,n,i){return Number.isFinite(e)?Math.max(n,Math.min(i,Math.round(e))):n}function os(e,n,i,s=mn){const r=Math.max(0,i-1),o=lt(e,0,r),a=Math.max(1,Math.round(s)),c=Math.max(0,o-(a-1));return lt(n,0,c)}function rs(e,n,i,s=mn){const r=Math.max(0,i-1),o=lt(e,0,r),a=Math.max(1,Math.round(s)),c=Math.min(r,o+(a-1));return lt(n,c,r)}function ls(e){return e.map((n,i)=>({index:i,label:n.pitch,midi:n.midi,toneNote:n.toneNote,frequency:n.frequency}))}function Oe(e,n){const i=e.findIndex(s=>s.midi===n);return i>=0?i:0}function cs(e){return[{label:"Voice I",topIndex:Oe(e,81),bottomIndex:Oe(e,57)},{label:"Voice II",topIndex:Oe(e,72),bottomIndex:Oe(e,48)},{label:"Voice III",topIndex:Oe(e,64),bottomIndex:Oe(e,40)}]}var ds=L('<div class="summary-card svelte-s4iox0"><div class="summary-label svelte-s4iox0"> </div> <div class="summary-metadata svelte-s4iox0"> </div></div>'),us=L('<div class="dual-pitch-wheel svelte-s4iox0"><div class="wheels-container svelte-s4iox0"><div class="wheel-column svelte-s4iox0"><div class="wheel-label svelte-s4iox0">High</div> <!></div> <div class="wheel-column svelte-s4iox0"><div class="wheel-label svelte-s4iox0">Low</div> <!></div></div> <!> <!></div>');function fs(e,n){pe(n,!0);let i=fe(n,"topIndex",15),s=fe(n,"bottomIndex",15),r=fe(n,"minSpan",3,7),o=fe(n,"showSummary",3,!0),a=fe(n,"showPresets",3,!1);const c=A(()=>ls(n.fullRowData)),l=A(()=>({topIndex:i(),bottomIndex:s(),topPitch:n.fullRowData[i()],bottomPitch:n.fullRowData[s()],span:s()-i()+1})),d=A(()=>t(l).topPitch&&t(l).bottomPitch?`${t(l).topPitch.pitch} â€“ ${t(l).bottomPitch.pitch}`:""),g=A(()=>`${t(l).span} ${t(l).span===1?"pitch":"pitches"}`),h=A(()=>!n.presets||n.presets.length===0?void 0:n.presets.find(U=>U.topIndex===i()&&U.bottomIndex===s())?.label);function u(E){return os(s(),E,t(c).length,r())}function y(E){return rs(i(),E,t(c).length,r())}function v(E,U){i(E),typeof n.onrangechange=="function"&&n.onrangechange(t(l))}function f(E,U){s(E),typeof n.onrangechange=="function"&&n.onrangechange(t(l))}function m(E){i(E.topIndex),s(E.bottomIndex),typeof n.onrangechange=="function"&&n.onrangechange(t(l))}var b=us(),T=p(b),C=p(T),I=w(p(C),2);Xt(I,{get options(){return t(c)},get selectedIndex(){return i()},onchange:v,onbeforechange:u,get wheelHeight(){return n.wheelHeight},ariaLabel:"High pitch selector"});var P=w(C,2),_=w(p(P),2);Xt(_,{get options(){return t(c)},get selectedIndex(){return s()},onchange:f,onbeforechange:y,get wheelHeight(){return n.wheelHeight},ariaLabel:"Low pitch selector"});var x=w(T,2);{var N=E=>{var U=ds(),te=p(U),z=p(te),S=w(te,2),G=p(S);J(()=>{q(z,t(d)),q(G,t(g))}),H(E,U)};ee(x,E=>{o()&&E(N)})}var k=w(x,2);{var D=E=>{as(E,{get presets(){return n.presets},get activePreset(){return t(h)},onPresetClick:m})};ee(k,E=>{a()&&n.presets&&n.presets.length>0&&E(D)})}H(e,b),ye()}_e(["change"]);var hs=L('<div class="range-control svelte-150ksck"><h3 class="control-title svelte-150ksck">Pitch Range</h3> <!></div>');function gs(e,n){pe(n,!0);function i(d){const g=ct.findIndex(h=>h.midi===d);return g>=0?g:0}const s=A(()=>i(j.state.yAxisRange.maxMidi)),r=A(()=>i(j.state.yAxisRange.minMidi)),o=cs(ct);function a(d){const g=d.bottomPitch.midi??21,h=d.topPitch.midi??108;j.setYAxisRange({minMidi:g,maxMidi:h})}var c=hs(),l=w(p(c),2);fs(l,{get fullRowData(){return ct},get topIndex(){return t(s)},get bottomIndex(){return t(r)},minSpan:7,onrangechange:a,showSummary:!0,wheelHeight:200,get presets(){return o},showPresets:!0}),H(e,c),ye()}var vs=L('<div class="pitch-highlight-toggle svelte-1v98ldk"><span class="toggle-label svelte-1v98ldk">Pitch Highlight</span> <button> </button></div>');function ms(e,n){pe(n,!1);function i(){j.togglePitchHighlight()}_t();var s=vs(),r=w(p(s),2);let o;r.__click=i;var a=p(r);J(()=>{o=qe(r,1,"toggle-button svelte-1v98ldk",null,o,{active:j.state.pitchHighlightEnabled}),q(a,j.state.pitchHighlightEnabled?"On":"Off")}),H(e,s),ye()}_e(["click"]);var ps=L('<button class="start-exercise-btn svelte-16rxcxh">Start Demo Exercise</button>'),ys=L('<button class="stop-exercise-btn svelte-16rxcxh">Stop Exercise</button> <div class="progress-indicator svelte-16rxcxh"> </div> <div class="phase-indicator svelte-16rxcxh"> </div>',1),bs=L('<div><span class="result-loop svelte-16rxcxh"></span> <span class="result-pitch svelte-16rxcxh"> </span> <span class="result-accuracy svelte-16rxcxh"> </span> <span class="result-status svelte-16rxcxh"> </span></div>'),ws=L('<div class="exercise-results svelte-16rxcxh"><h4 class="results-title svelte-16rxcxh">Results</h4> <div class="results-summary svelte-16rxcxh"><div class="stat svelte-16rxcxh"><span class="stat-label svelte-16rxcxh">Average Accuracy:</span> <span class="stat-value svelte-16rxcxh"> </span></div> <div class="stat svelte-16rxcxh"><span class="stat-label svelte-16rxcxh">Hits:</span> <span class="stat-value svelte-16rxcxh"> </span></div></div> <details class="results-details svelte-16rxcxh"><summary class="results-summary-label svelte-16rxcxh">Detailed Results</summary> <div class="results-list svelte-16rxcxh"></div></details></div>'),Ms=L('<div class="demo-exercise-panel svelte-16rxcxh"><h3 class="panel-title svelte-16rxcxh">Demo Exercise</h3> <details class="settings-details svelte-16rxcxh"><summary class="settings-summary svelte-16rxcxh">Settings</summary> <div class="exercise-settings svelte-16rxcxh"><label class="setting-label svelte-16rxcxh"><span class="label-text svelte-16rxcxh">Number of loops:</span> <input class="setting-input svelte-16rxcxh" type="number" min="1" max="20"/></label> <label class="setting-label svelte-16rxcxh"><span class="label-text svelte-16rxcxh">Tempo (BPM):</span> <input class="setting-input svelte-16rxcxh" type="number" min="60" max="180"/></label> <label class="setting-label svelte-16rxcxh"><span class="label-text svelte-16rxcxh">Reference Volume:</span> <input class="setting-slider svelte-16rxcxh" type="range" min="-40" max="0"/> <span class="volume-value svelte-16rxcxh"> </span></label> <div class="pitch-range-buttons svelte-16rxcxh"><button class="range-btn svelte-16rxcxh">Use Current Range</button> <button class="range-btn svelte-16rxcxh">Use Full Range</button></div></div></details> <div class="exercise-controls svelte-16rxcxh"><!></div> <!></div>');function Ts(e,n){pe(n,!0);let i=K(!1),s=K(5),r=K(108),o=K(-12);const a=A(()=>he.state.isActive),c=A(()=>he.state.isPlaying),l=A(()=>he.state.currentPhase),d=A(()=>he.getCurrentProgress()),g=A(()=>he.getResults()),h=A(()=>t(g).length>0),u=A(()=>he.getAverageAccuracy()),y=A(()=>he.getHitCount()),v=A(()=>t(g).length);Re(()=>{if(!t(a)||!t(c))return;const R=de.state.currentTimeMs;he.updatePhase(R)}),Re(()=>{if(!t(a))return;const R=de.getPerformanceResults();he.getGeneratedNotes().forEach((ae,ue)=>{if(ae.lyric!=="ðŸŽ¤")return;const be=`target-${ue}`,we=R.get(be);if(we&&!he.hasResultForLoop(Math.floor(ue/2))){const me=f(we);he.addResult({loopIndex:Math.floor(ue/2),targetPitch:ae.midi,accuracy:me,performance:we})}})});function f(R){return R.hitStatus==="hit"?R.pitchAccuracyCents!==void 0?Math.max(0,100-Math.abs(R.pitchAccuracyCents)/50*100):100:0}Ye(()=>{t(a)&&C()});function m(){const R=j.state.yAxisRange;he.setPitchRange(R.minMidi,R.maxMidi)}function b(){he.setPitchRange(21,108)}async function T(){j.setVisualizationMode("highway"),he.configure({numLoops:t(s),tempo:t(r),referenceVolume:t(o)}),m(),await je.init(),je.setVolume(t(o)),he.start();const R=he.getGeneratedNotes();de.setTargetNotes(R),de.start(),he.setPlaying(!0);const Z=R.filter(ae=>ae.lyric==="ðŸ‘‚");je.scheduleReferenceTones(Z)}function C(){je.stop(),de.stop(),he.stop()}function I(R){switch(R){case"reference":return"ðŸ‘‚ Listen";case"input":return"ðŸŽ¤ Sing";default:return"Rest"}}function P(R){return Dn(R)?.pitch||`MIDI ${R}`}var _=Ms(),x=w(p(_),2),N=w(p(x),2),k=p(N),D=w(p(k),2),E=w(k,2),U=w(p(E),2),te=w(E,2),z=w(p(te),2),S=w(z,2),G=p(S),Q=w(te,2),le=p(Q);le.__click=m;var Te=w(le,2);Te.__click=b;var Pe=w(x,2),Ce=p(Pe);{var ne=R=>{var Z=ps();Z.__click=T,H(R,Z)},V=R=>{var Z=ys(),ae=Je(Z);ae.__click=C;var ue=w(ae,2),be=p(ue),we=w(ue,2),me=p(we);J(X=>{q(be,`Loop ${t(d).current??""} / ${t(d).total??""}`),q(me,X)},[()=>I(t(l))]),H(R,Z)};ee(Ce,R=>{t(a)?R(V,!1):R(ne)})}var $=w(Pe,2);{var B=R=>{var Z=ws(),ae=w(p(Z),2),ue=p(ae),be=w(p(ue),2),we=p(be),me=w(ue,2),X=w(p(me),2),se=p(X),M=w(ae,2),O=w(p(M),2);Ge(O,21,()=>t(g),et,(W,oe,ge)=>{var Me=bs();let re;var Ie=p(Me);Ie.textContent=`Loop ${ge+1}:`;var ie=w(Ie,2),ke=p(ie),De=w(ie,2),Ue=p(De),pn=w(De,2),yn=p(pn);J((bn,wn)=>{re=qe(Me,1,"result-item svelte-16rxcxh",null,re,{hit:t(oe).performance?.hitStatus==="hit"}),q(ke,bn),q(Ue,`${wn??""}%`),q(yn,t(oe).performance?.hitStatus==="hit"?"âœ“":"âœ—")},[()=>P(t(oe).targetPitch),()=>t(oe).accuracy.toFixed(0)]),H(W,Me)}),J(W=>{q(we,`${W??""}%`),q(se,`${t(y)??""}/${t(v)??""}`)},[()=>t(u).toFixed(1)]),H(R,Z)};ee($,R=>{t(h)&&!t(a)&&R(B)})}J(()=>{D.disabled=t(a),U.disabled=t(a),z.disabled=t(a),q(G,`${t(o)??""} dB`),le.disabled=t(a),Te.disabled=t(a)}),dt(D,()=>t(s),R=>F(s,R)),dt(U,()=>t(r),R=>F(r,R)),dt(z,()=>t(o),R=>F(o,R)),an("open","toggle",x,R=>F(i,R),()=>t(i)),H(e,_),ye()}_e(["click"]);const _s=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,/^([a-zA-Z0-9_-]{11})$/],Ps={gapMs:0,videoGapSec:0,manualOffsetSec:0},xt=60;function Cs(e){try{const n=e.split(/\r?\n/).map(a=>a.trim()),i=Ss(n);if(!i.bpm)return{success:!1,error:"Missing required #BPM tag"};const{notes:s,lineBreaks:r,totalBeats:o}=xs(n);return s.length===0?{success:!1,error:"No valid notes found in file"}:{success:!0,song:{metadata:i,notes:s,lineBreaks:r,totalBeats:o}}}catch(n){return{success:!1,error:n instanceof Error?n.message:"Unknown parsing error"}}}function Ss(e){const n={};for(const i of e){if(!i.startsWith("#"))continue;const s=i.indexOf(":");if(s===-1)continue;const r=i.slice(1,s).toUpperCase().trim(),o=i.slice(s+1).trim();switch(r){case"TITLE":n.title=o;break;case"ARTIST":n.artist=o;break;case"VIDEO":n.video=o;break;case"VIDEOGAP":n.videoGap=parseFloat(o.replace(",","."))||0;break;case"GAP":n.gap=parseFloat(o.replace(",","."))||0;break;case"BPM":n.bpm=parseFloat(o.replace(",","."))||0;break;case"MP3":case"AUDIO":n.mp3=o;break;case"LANGUAGE":n.language=o;break;case"GENRE":n.genre=o;break;case"YEAR":n.year=parseInt(o)||void 0;break;case"CREATOR":n.creator=o;break;case"COVER":n.cover=o;break;case"BACKGROUND":n.background=o;break;case"PREVIEWSTART":n.previewStart=parseFloat(o.replace(",","."))||0;break}}return{title:n.title||"Unknown Title",artist:n.artist||"Unknown Artist",bpm:n.bpm||0,...n}}function xs(e){const n=[],i=[];let s=0;for(const r of e){if(r.length===0||r.startsWith("#"))continue;const o=r[0];if(o==="E")break;if(o==="-"){const a=r.slice(1).trim().split(/\s+/),c=parseInt(a[0])||0;i.push(c);continue}if([":","*","F","R"].includes(o)){const a=Is(r);if(a){n.push(a);const c=a.startBeat+a.duration;c>s&&(s=c)}}}return{notes:n,lineBreaks:i,totalBeats:s}}function Is(e){const n=e[0],s=e.slice(1).trim().split(/\s+/);if(s.length<3)return null;const r=parseInt(s[0]),o=parseInt(s[1]),a=parseInt(s[2]),c=s.slice(3).join(" ")||"";return isNaN(r)||isNaN(o)||isNaN(a)?null:{type:n,startBeat:r,duration:o,pitch:a,lyric:c}}function As(e){if(!e)return null;const n=e.trim();for(const i of _s){const s=n.match(i);if(s&&s[1])return s[1]}return null}function jt(e,n=xt){const{metadata:i,notes:s,lineBreaks:r}=e,{bpm:o}=i,a=60/o*1e3*4;let c=0;const l=[...r].sort((g,h)=>g-h),d=s.length>0?Math.min(...s.map(g=>g.startBeat)):0;return s.filter(g=>g.type!=="F").map(g=>{const h=(g.startBeat-d)*a,u=g.duration*a,y=n+g.pitch;for(;c<l.length&&g.startBeat>=l[c];)c++;const v={midi:y,startTimeMs:h,durationMs:u,lyric:g.lyric.trim()||void 0};return g.type==="*"&&(v.isGolden=!0),v})}function Rs(e){return{gapMs:e.gap||0,videoGapSec:e.videoGap||0,manualOffsetSec:0}}function Ns(e){const{metadata:n,notes:i,totalBeats:s}=e,{bpm:r}=n,o=60/r*1e3*4,a=i.length>0?Math.min(...i.map(l=>l.startBeat)):0;return(s-a)*o+2e3}function zt(e,n=xt){const i=e.notes.filter(o=>o.type!=="F"&&o.type!=="-").map(o=>n+o.pitch);if(i.length===0)return{minMidi:48,maxMidi:72};const s=Math.min(...i),r=Math.max(...i);return{minMidi:Math.max(24,s-3),maxMidi:Math.min(108,r+3)}}const Kt={isActive:!1,isLoading:!1,isPlaying:!1,song:null,targetNotes:[],youtubeId:null,syncConfig:{...Ps},baseMidi:xt,totalDurationMs:0,detectedRange:{minMidi:48,maxMidi:72},error:null};function ks(){let e=K(Le({...Kt})),n=null;return{get state(){return t(e)},async loadFile(i){t(e).isLoading=!0,t(e).error=null;try{const s=await i.text(),r=Cs(s);if(!r.success)return t(e).error=r.error,t(e).isLoading=!1,!1;const o=r.song,a=o.metadata.video?As(o.metadata.video):null,c=Rs(o.metadata),l=jt(o,t(e).baseMidi),d=Ns(o),g=zt(o,t(e).baseMidi);return t(e).song=o,t(e).youtubeId=a,t(e).syncConfig=c,t(e).targetNotes=l,t(e).totalDurationMs=d,t(e).detectedRange=g,t(e).isActive=!0,t(e).isLoading=!1,!0}catch(s){return t(e).error=s instanceof Error?s.message:"Failed to load file",t(e).isLoading=!1,!1}},get youtubeOffset(){const{gapMs:i,videoGapSec:s,manualOffsetSec:r}=t(e).syncConfig;return i/1e3+s+r},adjustOffset(i){t(e).syncConfig={...t(e).syncConfig,manualOffsetSec:t(e).syncConfig.manualOffsetSec+i}},setManualOffset(i){t(e).syncConfig={...t(e).syncConfig,manualOffsetSec:i}},resetOffset(){t(e).syncConfig={...t(e).syncConfig,manualOffsetSec:0}},setBaseMidi(i){t(e).baseMidi=i,t(e).song&&(t(e).targetNotes=jt(t(e).song,i),t(e).detectedRange=zt(t(e).song,i))},setPlaying(i){t(e).isPlaying=i},onComplete(i){n=i},triggerComplete(){t(e).isPlaying=!1,n&&n()},checkCompletion(i){return!t(e).isPlaying||!t(e).isActive?!1:i>=t(e).totalDurationMs-500?(this.triggerComplete(),!0):!1},get title(){return t(e).song?.metadata.title||""},get artist(){return t(e).song?.metadata.artist||""},get hasVideo(){return t(e).youtubeId!==null},reset(){F(e,{...Kt},!0),n=null},unload(){t(e).isActive=!1,t(e).isPlaying=!1,t(e).song=null,t(e).targetNotes=[],t(e).youtubeId=null,t(e).totalDurationMs=0,t(e).error=null}}}const Y=ks();let it=null,ze=!1;function Hs(){return it||(ze&&window.YT&&window.YT.Player?Promise.resolve():(it=new Promise((e,n)=>{if(window.YT&&window.YT.Player){ze=!0,e();return}window.onYouTubeIframeAPIReady=()=>{ze=!0,e()};const i=document.createElement("script");i.src="https://www.youtube.com/iframe_api",i.async=!0,i.onerror=()=>{n(new Error("Failed to load YouTube IFrame API"))},document.head.appendChild(i),setTimeout(()=>{ze||n(new Error("YouTube IFrame API load timeout"))},1e4)}),it))}function Ls(e,n,i={}){if(!ze||!window.YT?.Player)throw new Error("YouTube API not loaded. Call loadYouTubeAPI() first.");const{width:s=320,height:r=180,onReady:o,onStateChange:a,onError:c}=i;return new window.YT.Player(e,{width:s,height:r,videoId:n,playerVars:{autoplay:0,controls:1,disablekb:1,enablejsapi:1,fs:0,modestbranding:1,origin:window.location.origin,playsinline:1,rel:0},events:{onReady:l=>{o?.(l.target)},onStateChange:l=>{a?.(l.data)},onError:l=>{c?.(l.data)}}})}function Ds(e){switch(e){case YT.PlayerError.InvalidParam:return"Invalid video ID";case YT.PlayerError.Html5Error:return"HTML5 player error";case YT.PlayerError.VideoNotFound:return"Video not found";case YT.PlayerError.NotAllowedEmbedded:case YT.PlayerError.NotAllowedEmbedded2:return"Video cannot be embedded";default:return"Unknown player error"}}const mt={isApiLoaded:!1,isApiLoading:!1,isPlayerReady:!1,isPlaying:!1,currentTime:0,duration:0,videoId:null,error:null,isEmbeddable:!0,volume:100,isMuted:!1};function Es(){let e=K(Le({...mt})),n=null,i=null,s=null;return{get state(){return t(e)},async initAPI(){if(t(e).isApiLoaded)return!0;if(t(e).isApiLoading)return!1;t(e).isApiLoading=!0,t(e).error=null;try{return await Hs(),t(e).isApiLoaded=!0,t(e).isApiLoading=!1,!0}catch(r){return t(e).error=r instanceof Error?r.message:"Failed to load YouTube API",t(e).isApiLoading=!1,!1}},async loadVideo(r,o){if(!t(e).isApiLoaded&&!await this.initAPI())return!1;if(n){try{n.destroy()}catch{}n=null}return t(e).isPlayerReady=!1,t(e).error=null,t(e).isEmbeddable=!0,t(e).videoId=r,new Promise(a=>{try{n=Ls(o,r,{onReady:c=>{t(e).isPlayerReady=!0,t(e).duration=c.getDuration(),t(e).volume=c.getVolume(),t(e).isMuted=c.isMuted(),a(!0)},onStateChange:c=>{t(e).isPlaying=c===YT.PlayerState.PLAYING,c===YT.PlayerState.ENDED&&(t(e).isPlaying=!1,this.stopSyncLoop())},onError:c=>{t(e).error=Ds(c),t(e).isEmbeddable=c!==YT.PlayerError.NotAllowedEmbedded&&c!==YT.PlayerError.NotAllowedEmbedded2,t(e).isPlayerReady=!1,a(!1)}})}catch(c){t(e).error=c instanceof Error?c.message:"Failed to create player",a(!1)}})},play(){n&&t(e).isPlayerReady&&n.playVideo()},pause(){n&&t(e).isPlayerReady&&n.pauseVideo()},stop(){n&&t(e).isPlayerReady&&(n.stopVideo(),t(e).isPlaying=!1),this.stopSyncLoop()},seekTo(r){n&&t(e).isPlayerReady&&(n.seekTo(Math.max(0,r),!0),t(e).currentTime=Math.max(0,r))},getCurrentTime(){return n&&t(e).isPlayerReady?n.getCurrentTime():t(e).currentTime},setVolume(r){const o=Math.max(0,Math.min(100,r));n&&t(e).isPlayerReady&&n.setVolume(o),t(e).volume=o},mute(){n&&t(e).isPlayerReady&&n.mute(),t(e).isMuted=!0},unmute(){n&&t(e).isPlayerReady&&n.unMute(),t(e).isMuted=!1},toggleMute(){t(e).isMuted?this.unmute():this.mute()},startSyncLoop(r,o=250){s=r,i!==null&&clearInterval(i),i=window.setInterval(()=>{if(n&&t(e).isPlayerReady&&t(e).isPlaying){const a=n.getCurrentTime();t(e).currentTime=a,s?.(a)}},o)},stopSyncLoop(){i!==null&&(clearInterval(i),i=null),s=null},correctDrift(r,o=150){if(!n||!t(e).isPlayerReady||!t(e).isPlaying)return!1;const a=n.getCurrentTime();return Math.abs(a-r)*1e3>o?(n.seekTo(r,!0),!0):!1},getVideoUrl(){return t(e).videoId?`https://www.youtube.com/watch?v=${t(e).videoId}`:null},dispose(){if(this.stopSyncLoop(),n){try{n.destroy()}catch{}n=null}F(e,{...mt,isApiLoaded:t(e).isApiLoaded},!0)},reset(){this.dispose(),F(e,{...mt},!0)}}}const ve=Es();function Os(e){let n={...e.syncConfig};const i=e.driftCheckIntervalMs??250,s=e.maxDriftMs??150;function r(){return n.gapMs/1e3+n.videoGapSec+n.manualOffsetSec}function o(f){return f/1e3+r()}function a(f){return(f-r())*1e3}function c(f,m){const b=o(f),T=m-b,C=Math.abs(T*1e3);if(C>s){const I=a(m);return{driftMs:C,needsCorrection:!0,correctedTransportTimeMs:I}}return{driftMs:C,needsCorrection:!1}}function l(f){n={...n,...f}}function d(f){n.manualOffsetSec+=f}function g(){n.manualOffsetSec=0}function h(){return n.manualOffsetSec}function u(){return r()}function y(){const f=n.manualOffsetSec;return`${f>=0?"+":""}${f.toFixed(2)}s`}function v(){return{intervalMs:i,maxDriftMs:s}}return{getYouTubeOffset:r,getTotalOffset:u,getManualOffset:h,getSyncLoopConfig:v,transportToYouTube:o,youTubeToTransport:a,checkDrift:c,updateConfig:l,adjustManualOffset:d,resetManualOffset:g,formatOffset:y,getConfig:()=>({...n})}}var Fs=L('<div class="youtube-loading svelte-1pmfeb3"><div class="spinner svelte-1pmfeb3"></div> <span>Loading video...</span></div>'),Ws=L('<button class="fallback-btn svelte-1pmfeb3">Open on YouTube â†—</button>'),Bs=L('<div class="youtube-error svelte-1pmfeb3"><span class="error-icon svelte-1pmfeb3">âš ï¸</span> <span class="error-message svelte-1pmfeb3"> </span> <!></div>'),Gs=L('<div class="youtube-placeholder svelte-1pmfeb3"><span class="placeholder-icon svelte-1pmfeb3">ðŸŽ¬</span> <span class="placeholder-text svelte-1pmfeb3">No video loaded</span></div>'),Ys=L('<div class="youtube-container svelte-1pmfeb3"><div class="youtube-player svelte-1pmfeb3"></div> <!> <!> <!></div>');function qs(e,n){pe(n,!0);const i=`youtube-player-${Math.random().toString(36).slice(2,9)}`,s=A(()=>ve.state.isApiLoading||ve.state.videoId&&!ve.state.isPlayerReady),r=A(()=>!!ve.state.error),o=A(()=>ve.state.isEmbeddable),a=A(()=>Y.state.youtubeId);Re(()=>{t(a)&&ve.loadVideo(t(a),i)}),Ye(()=>{ve.dispose()});function c(){const m=ve.getVideoUrl();m&&window.open(m,"_blank","noopener,noreferrer")}var l=Ys(),d=p(l),g=w(d,2);{var h=m=>{var b=Fs();H(m,b)};ee(g,m=>{t(s)&&t(a)&&m(h)})}var u=w(g,2);{var y=m=>{var b=Bs(),T=w(p(b),2),C=p(T),I=w(T,2);{var P=_=>{var x=Ws();x.__click=c,H(_,x)};ee(I,_=>{t(o)||_(P)})}J(()=>q(C,ve.state.error)),H(m,b)};ee(u,m=>{t(r)&&m(y)})}var v=w(u,2);{var f=m=>{var b=Gs();H(m,b)};ee(v,m=>{!t(a)&&!t(s)&&!t(r)&&m(f)})}J(()=>Fe(d,"id",i)),H(e,l),ye()}_e(["click"]);var Us=L('<div class="sync-controls svelte-1xjjmjf"><div class="sync-header svelte-1xjjmjf"><span class="sync-label svelte-1xjjmjf">Sync Offset</span> <span class="sync-value svelte-1xjjmjf"> </span></div> <div class="sync-buttons svelte-1xjjmjf"><button class="sync-btn coarse svelte-1xjjmjf" title="Earlier by 0.1s">-0.1s</button> <button class="sync-btn fine svelte-1xjjmjf" title="Earlier by 0.01s">-0.01s</button> <button class="sync-btn reset svelte-1xjjmjf" title="Reset offset">0</button> <button class="sync-btn fine svelte-1xjjmjf" title="Later by 0.01s">+0.01s</button> <button class="sync-btn coarse svelte-1xjjmjf" title="Later by 0.1s">+0.1s</button></div> <div class="sync-hint svelte-1xjjmjf">Use arrow keys to adjust (Shift for coarse)</div></div>');function Vs(e,n){pe(n,!0);const i=A(()=>Y.state.syncConfig.manualOffsetSec),s=A(()=>Y.state.isActive);function r(T){return`${T>=0?"+":""}${T.toFixed(2)}s`}function o(T){Y.adjustOffset(T)}function a(){Y.resetOffset()}function c(T){if(t(s)&&!(T.target instanceof HTMLInputElement))switch(T.key){case"ArrowLeft":T.preventDefault(),o(T.shiftKey?-.1:-.01);break;case"ArrowRight":T.preventDefault(),o(T.shiftKey?.1:.01);break}}var l=Us();Ke("keydown",en,c);var d=p(l),g=w(p(d),2),h=p(g),u=w(d,2),y=p(u);y.__click=()=>o(-.1);var v=w(y,2);v.__click=()=>o(-.01);var f=w(v,2);f.__click=a;var m=w(f,2);m.__click=()=>o(.01);var b=w(m,2);b.__click=()=>o(.1),J(T=>{q(h,T),y.disabled=!t(s),v.disabled=!t(s),f.disabled=!t(s)||t(i)===0,m.disabled=!t(s),b.disabled=!t(s)},[()=>r(t(i))]),H(e,l),ye()}_e(["click"]);var Xs=L('<span class="spinner svelte-oab1bu"></span> Loading...',1),js=L('<div class="error-message svelte-oab1bu"> </div>'),zs=L('<button class="upload-btn svelte-oab1bu"><!></button> <!>',1),Ks=L('<div class="video-section svelte-oab1bu"><!> <!></div>'),Zs=L('<button class="play-btn svelte-oab1bu">â–¶ Play</button>'),Js=L('<button class="stop-btn svelte-oab1bu">â¹ Stop</button>'),Qs=L('<div class="progress-info svelte-oab1bu"><span class="time-display svelte-oab1bu"> </span></div>'),$s=L('<div class="song-info svelte-oab1bu"><div class="song-title svelte-oab1bu"> </div> <div class="song-artist svelte-oab1bu"> </div></div> <!> <div class="playback-controls svelte-oab1bu"><!> <button class="unload-btn svelte-oab1bu">Unload</button></div> <!>',1),ea=L('<div class="ultrastar-panel svelte-oab1bu"><h3 class="panel-title svelte-oab1bu">Ultrastar Song</h3> <input type="file" accept=".txt" style="display: none;"/> <!></div>');function ta(e,n){pe(n,!0);let i=null,s;const r=A(()=>Y.state.isActive),o=A(()=>Y.state.isLoading),a=A(()=>Y.state.isPlaying),c=A(()=>Y.hasVideo),l=A(()=>Y.title),d=A(()=>Y.artist),g=A(()=>Y.state.error);async function h(x){const N=x.target,k=N.files?.[0];if(!k)return;if(await Y.loadFile(k)){i=Os({syncConfig:Y.state.syncConfig});const E=Y.state.detectedRange;j.setYAxisRange({minMidi:E.minMidi,maxMidi:E.maxMidi}),de.setTargetNotes(Y.state.targetNotes),console.log("[Ultrastar] File loaded:",{title:Y.title,artist:Y.artist,youtubeId:Y.state.youtubeId,bpm:Y.state.song?.metadata.bpm,gap:Y.state.song?.metadata.gap,videoGap:Y.state.song?.metadata.videoGap,noteCount:Y.state.targetNotes.length,firstNotes:Y.state.targetNotes.slice(0,3),lastNotes:Y.state.targetNotes.slice(-3),totalDurationMs:Y.state.totalDurationMs,pitchRange:E,syncConfig:Y.state.syncConfig})}N.value=""}async function u(){if(t(r))if(j.setVisualizationMode("highway"),i&&i.updateConfig(Y.state.syncConfig),de.setTargetNotes(Y.state.targetNotes),Y.setPlaying(!0),t(c)&&ve.state.isPlayerReady){const x=i?.getYouTubeOffset()??0;console.log("[Ultrastar] Starting playback:",{youtubeOffset:x,noteCount:Y.state.targetNotes.length,firstNote:Y.state.targetNotes[0],syncConfig:Y.state.syncConfig}),de.setCurrentTime(0),ve.seekTo(x),ve.play(),f()}else de.start()}function y(){de.stop(),Y.setPlaying(!1),ve.pause(),m()}function v(){y(),Y.unload(),ve.dispose(),de.reset(),i=null}function f(){ve.startSyncLoop(x=>{if(!i)return;const N=i.youTubeToTransport(x),k=de.state.currentTimeMs;Math.abs(N-k)>50&&de.setCurrentTime(Math.max(0,N))},100)}function m(){ve.stopSyncLoop()}function b(){s?.click()}Ye(()=>{m(),ve.dispose()});var T=ea(),C=w(p(T),2);C.__change=h,Ne(C,x=>s=x,()=>s);var I=w(C,2);{var P=x=>{var N=zs(),k=Je(N);k.__click=b;var D=p(k);{var E=S=>{var G=Xs();H(S,G)},U=S=>{var G=An("Upload Ultrastar .txt");H(S,G)};ee(D,S=>{t(o)?S(E):S(U,!1)})}var te=w(k,2);{var z=S=>{var G=js(),Q=p(G);J(()=>q(Q,t(g))),H(S,G)};ee(te,S=>{t(g)&&S(z)})}J(()=>k.disabled=t(o)),H(x,N)},_=x=>{var N=$s(),k=Je(N),D=p(k),E=p(D),U=w(D,2),te=p(U),z=w(k,2);{var S=V=>{var $=Ks(),B=p($);qs(B,{});var R=w(B,2);Vs(R,{}),H(V,$)};ee(z,V=>{t(c)&&V(S)})}var G=w(z,2),Q=p(G);{var le=V=>{var $=Zs();$.__click=u,H(V,$)},Te=V=>{var $=Js();$.__click=y,H(V,$)};ee(Q,V=>{t(a)?V(Te,!1):V(le)})}var Pe=w(Q,2);Pe.__click=v;var Ce=w(G,2);{var ne=V=>{var $=Qs(),B=p($),R=p(B);J((Z,ae)=>q(R,`${Z??""}s
          / ${ae??""}s`),[()=>Math.floor(de.state.currentTimeMs/1e3),()=>Math.floor(Y.state.totalDurationMs/1e3)]),H(V,$)};ee(Ce,V=>{t(a)&&V(ne)})}J(()=>{q(E,t(l)),q(te,t(d)),Pe.disabled=t(a)}),H(x,N)};ee(I,x=>{t(r)?x(_,!1):x(P)})}H(e,T),ye()}_e(["change","click"]);var na=L('<div class="note-display svelte-fwpoo3"><span class="note-name svelte-fwpoo3"> </span> <span class="octave svelte-fwpoo3"> </span></div> <div class="details svelte-fwpoo3"><span class="frequency"> </span> <span> </span> <span class="clarity"> </span></div>',1),ia=L('<div class="no-pitch svelte-fwpoo3"><span class="placeholder svelte-fwpoo3">---</span> <span class="hint svelte-fwpoo3">Sing or hum into the microphone</span></div>'),sa=L('<div class="pitch-readout svelte-fwpoo3"><!></div>');function aa(e,n){pe(n,!0);const i=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],s=A(()=>()=>{const l=ce.state.currentPitch;if(!l)return null;const d=i[l.pitchClass],g=Math.floor(l.midi/12)-1,h=Math.round((l.midi-Math.round(l.midi))*100);return{name:d,octave:g,frequency:l.frequency.toFixed(1),cents:h,clarity:Math.round(l.clarity*100)}});var r=sa(),o=p(r);{var a=l=>{const d=A(()=>t(s)());var g=na(),h=Je(g),u=p(h),y=p(u),v=w(u,2),f=p(v),m=w(h,2),b=p(m),T=p(b),C=w(b,2);let I;var P=p(C),_=w(C,2),x=p(_);J(()=>{q(y,t(d).name),q(f,t(d).octave),q(T,`${t(d).frequency??""} Hz`),I=qe(C,1,"cents svelte-fwpoo3",null,I,{sharp:t(d).cents>0,flat:t(d).cents<0}),q(P,`${t(d).cents>0?"+":""}${t(d).cents??""}Â¢`),q(x,`${t(d).clarity??""}%`)}),H(l,g)},c=l=>{var d=ia();H(l,d)};ee(o,l=>{t(s)()?l(a):l(c,!1)})}H(e,r),ye()}const Zt={isVisible:!1,summary:null,songTitle:"",artistName:"",source:null},oa={totalNotes:0,notesHit:0,notesMissed:0,accuracyPercent:0,goldenNotesHit:0,goldenNotesTotal:0,phraseResults:[],averagePitchDeviationCents:0};function ra(){let e=K(Le({...Zt}));return{get state(){return t(e)},show(n,i={}){t(e).summary=n,t(e).songTitle=i.title||"",t(e).artistName=i.artist||"",t(e).source=i.source||null,t(e).isVisible=!0},hide(){t(e).isVisible=!1},clear(){F(e,{...Zt},!0)},calculateSummary(n,i){if(i.length===0)return{...oa};let s=0,r=0,o=0,a=0,c=0;const l=new Map;i.forEach((v,f)=>{const m=`target-${f}`,b=n.get(m),T=v.isGolden===!0,C=v.phraseIndex??0;T&&o++,l.has(C)||l.set(C,{hit:0,total:0,lyrics:[]});const I=l.get(C);I.total++,v.lyric&&I.lyrics.push(v.lyric),b?.hitStatus==="hit"&&(s++,I.hit++,T&&r++,typeof b.pitchAccuracyCents=="number"&&(a+=Math.abs(b.pitchAccuracyCents),c++))});const d=i.length,g=d-s,h=d>0?s/d*100:0,u=c>0?a/c:0,y=[];return l.forEach((v,f)=>{y.push({phraseIndex:f,notesHit:v.hit,totalNotes:v.total,accuracyPercent:v.total>0?v.hit/v.total*100:0,lyricPreview:v.lyrics.join("").trim().slice(0,30)||`Phrase ${f+1}`})}),y.sort((v,f)=>v.phraseIndex-f.phraseIndex),{totalNotes:d,notesHit:s,notesMissed:g,accuracyPercent:h,goldenNotesHit:r,goldenNotesTotal:o,phraseResults:y,averagePitchDeviationCents:u}},getLetterGrade(n){return n>=95?"S":n>=90?"A":n>=80?"B":n>=70?"C":n>=60?"D":"F"},getAccuracyColor(n){return n>=90?"var(--color-success, #28a745)":n>=70?"var(--color-warning, #ffc107)":"var(--color-error, #dc3545)"}}}const xe=ra();var la=L('<span class="song-artist svelte-1rv7phe"> </span>'),ca=L('<div class="song-info svelte-1rv7phe"><span class="song-title svelte-1rv7phe"> </span> <!></div>'),da=L('<div class="stat-item missed svelte-1rv7phe"><span class="stat-value svelte-1rv7phe"> </span> <span class="stat-label svelte-1rv7phe">Missed</span></div>'),ua=L('<div class="golden-stats svelte-1rv7phe"><span class="golden-icon svelte-1rv7phe">â­</span> <span class="golden-text svelte-1rv7phe"> </span></div>'),fa=L('<div class="pitch-stats svelte-1rv7phe"><span class="pitch-label">Avg. Pitch Deviation:</span> <span class="pitch-value svelte-1rv7phe"> </span></div>'),ha=L('<div><span class="phrase-lyric svelte-1rv7phe"> </span> <span class="phrase-accuracy svelte-1rv7phe"> </span></div>'),ga=L('<details class="phrase-details svelte-1rv7phe"><summary class="phrase-summary svelte-1rv7phe">Phrase Breakdown</summary> <div class="phrase-list svelte-1rv7phe"></div></details>'),va=L('<button class="action-btn retry-btn svelte-1rv7phe">Try Again</button>'),ma=L('<div class="modal-backdrop svelte-1rv7phe" role="dialog" aria-modal="true" aria-labelledby="results-title" tabindex="-1"><div class="modal-content svelte-1rv7phe"><div class="modal-header svelte-1rv7phe"><h2 id="results-title" class="modal-title svelte-1rv7phe">Results</h2> <!></div> <div class="stats-section svelte-1rv7phe"><div class="grade-display svelte-1rv7phe"><span class="grade-letter svelte-1rv7phe"> </span></div> <div class="accuracy-display svelte-1rv7phe"><span class="accuracy-value svelte-1rv7phe"> </span> <span class="accuracy-label svelte-1rv7phe">Accuracy</span></div> <div class="stats-row svelte-1rv7phe"><div class="stat-item svelte-1rv7phe"><span class="stat-value hit svelte-1rv7phe"> </span> <span class="stat-label svelte-1rv7phe">Hit</span></div> <div class="stat-divider svelte-1rv7phe">/</div> <div class="stat-item svelte-1rv7phe"><span class="stat-value total svelte-1rv7phe"> </span> <span class="stat-label svelte-1rv7phe">Total</span></div> <!></div> <!> <!></div> <!> <div class="modal-actions svelte-1rv7phe"><!> <button class="action-btn close-btn svelte-1rv7phe">Close</button></div></div></div>');function pa(e,n){pe(n,!0);const i=A(()=>xe.state.isVisible),s=A(()=>xe.state.summary),r=A(()=>xe.state.songTitle),o=A(()=>xe.state.artistName),a=A(()=>t(s)?xe.getLetterGrade(t(s).accuracyPercent):"F"),c=A(()=>t(s)?xe.getAccuracyColor(t(s).accuracyPercent):"");function l(){xe.hide(),n.onClose?.()}function d(){xe.hide(),n.onRetry?.()}function g(f){f.target===f.currentTarget&&l()}function h(f){f.key==="Escape"&&t(i)&&l()}var u=Rn();Ke("keydown",en,h);var y=Je(u);{var v=f=>{var m=ma();m.__click=g,m.__keydown=h;var b=p(m),T=p(b),C=w(p(T),2);{var I=X=>{var se=ca(),M=p(se),O=p(M),W=w(M,2);{var oe=ge=>{var Me=la(),re=p(Me);J(()=>q(re,`by ${t(o)??""}`)),H(ge,Me)};ee(W,ge=>{t(o)&&ge(oe)})}J(()=>q(O,t(r))),H(X,se)};ee(C,X=>{t(r)&&X(I)})}var P=w(T,2),_=p(P);let x;var N=p(_),k=p(N),D=w(_,2);let E;var U=p(D),te=p(U),z=w(D,2),S=p(z),G=p(S),Q=p(G),le=w(S,4),Te=p(le),Pe=p(Te),Ce=w(le,2);{var ne=X=>{var se=da(),M=p(se),O=p(M);J(()=>q(O,t(s).notesMissed)),H(X,se)};ee(Ce,X=>{t(s).notesMissed>0&&X(ne)})}var V=w(z,2);{var $=X=>{var se=ua(),M=w(p(se),2),O=p(M);J(()=>q(O,`Golden Notes: ${t(s).goldenNotesHit??""}/${t(s).goldenNotesTotal??""}`)),H(X,se)};ee(V,X=>{t(s).goldenNotesTotal>0&&X($)})}var B=w(V,2);{var R=X=>{var se=fa(),M=w(p(se),2),O=p(M);J(W=>q(O,`${W??""} cents`),[()=>t(s).averagePitchDeviationCents.toFixed(1)]),H(X,se)};ee(B,X=>{t(s).averagePitchDeviationCents>0&&X(R)})}var Z=w(P,2);{var ae=X=>{var se=ga(),M=w(p(se),2);Ge(M,21,()=>t(s).phraseResults,et,(O,W)=>{var oe=ha();let ge;var Me=p(oe),re=p(Me),Ie=w(Me,2),ie=p(Ie);J(ke=>{ge=qe(oe,1,"phrase-item svelte-1rv7phe",null,ge,{perfect:t(W).accuracyPercent===100,good:t(W).accuracyPercent>=70&&t(W).accuracyPercent<100,poor:t(W).accuracyPercent<70}),q(re,t(W).lyricPreview),q(ie,`${t(W).notesHit??""}/${t(W).totalNotes??""}
                  (${ke??""}%)`)},[()=>t(W).accuracyPercent.toFixed(0)]),H(O,oe)}),H(X,se)};ee(Z,X=>{t(s).phraseResults.length>1&&X(ae)})}var ue=w(Z,2),be=p(ue);{var we=X=>{var se=va();se.__click=d,H(X,se)};ee(be,X=>{n.onRetry&&X(we)})}var me=w(be,2);me.__click=l,J(X=>{x=st(_,"",x,{"--grade-color":t(c)}),q(k,t(a)),E=st(D,"",E,{color:t(c)}),q(te,`${X??""}%`),q(Q,t(s).notesHit),q(Pe,t(s).totalNotes)},[()=>t(s).accuracyPercent.toFixed(1)]),H(f,m)};ee(y,f=>{t(i)&&t(s)&&f(v)})}H(e,u),ye()}_e(["click","keydown"]);const pt={hasImportedSnapshot:!1,snapshot:null,isLoading:!1,error:null,transpositionSemitones:0};function ya(){let e=K(Le({...pt}));return{get state(){return t(e)},async checkAndConsumeHandoff(){if(!Fn())return!1;t(e).isLoading=!0,t(e).error=null;try{const i=await Wn();return i?i.schemaVersion!==It?(t(e).error=`Incompatible snapshot version: ${i.schemaVersion}. Expected: ${It}`,t(e).isLoading=!1,tt(),!1):(t(e).snapshot=i,t(e).hasImportedSnapshot=!0,t(e).isLoading=!1,tt(),console.log("[HandoffState] Successfully imported snapshot",{voices:i.voices.length,microbeatCount:i.timeGrid.microbeatCount,tempo:i.tempo}),!0):(t(e).error="Handoff data expired or not found. Please try exporting again.",t(e).isLoading=!1,tt(),!1)}catch(i){return console.error("[HandoffState] Failed to process handoff",i),t(e).error="Failed to import data from Student Notation.",t(e).isLoading=!1,tt(),!1}},get voices(){return t(e).snapshot?.voices??[]},get timeGrid(){return t(e).snapshot?.timeGrid??null},get tempo(){return t(e).snapshot?.tempo??90},get suggestedPitchRange(){if(!t(e).snapshot)return null;const n=3,i=t(e).snapshot.minMidiPitch,s=t(e).snapshot.maxMidiPitch;return i===void 0||s===void 0?null:{minMidi:Math.max(21,i-n+t(e).transpositionSemitones),maxMidi:Math.min(108,s+n+t(e).transpositionSemitones)}},setTransposition(n){t(e).transpositionSemitones=n},transposeUp(){t(e).transpositionSemitones+=1},transposeDown(){t(e).transpositionSemitones-=1},getTransposedMidi(n){return n+t(e).transpositionSemitones},async bringBackToStudentNotation(){if(!t(e).snapshot){console.warn("[HandoffState] No snapshot to bring back");return}const n={...t(e).snapshot,sourceApp:"singing-trainer",createdAt:Date.now(),voices:t(e).snapshot.voices.map(i=>({...i,notes:i.notes.map(s=>({...s,midiPitch:s.midiPitch+t(e).transpositionSemitones}))}))};try{const i=await En(n);console.log("[HandoffState] Handoff slot written for return",i),On(i)}catch(i){console.error("[HandoffState] Failed to write return handoff",i)}},clearSnapshot(){F(e,{...pt},!0)},reset(){F(e,{...pt},!0)}}}const Se=ya();var ba=L('<div class="handoff-controls svelte-1qpo30f"><div class="transposition-control svelte-1qpo30f"><button class="transpose-btn svelte-1qpo30f" title="Transpose down">-</button> <span class="transposition-label svelte-1qpo30f"> </span> <button class="transpose-btn svelte-1qpo30f" title="Transpose up">+</button></div> <button class="bring-back-btn svelte-1qpo30f">Bring Back to Student Notation</button></div>'),wa=L('<div class="error-banner svelte-1qpo30f"> </div>'),Ma=L('<div class="import-info svelte-1qpo30f"><span class="import-label svelte-1qpo30f">Microbeats:</span> <span class="import-value svelte-1qpo30f"> </span></div>'),Ta=L('<div class="control-group svelte-1qpo30f"><h3 class="control-group-title svelte-1qpo30f">Imported Material</h3> <div class="import-info svelte-1qpo30f"><span class="import-label svelte-1qpo30f">Voices:</span> <span class="import-value svelte-1qpo30f"> </span></div> <div class="import-info svelte-1qpo30f"><span class="import-label svelte-1qpo30f">Tempo:</span> <span class="import-value svelte-1qpo30f"> </span></div> <!></div>'),_a=L('<div class="app svelte-1qpo30f"><header class="header svelte-1qpo30f"><h1 class="title svelte-1qpo30f">Singing Trainer</h1> <div class="header-controls svelte-1qpo30f"><!></div></header> <!> <main class="main svelte-1qpo30f"><aside class="sidebar sidebar--left svelte-1qpo30f"><div class="control-group svelte-1qpo30f"><!></div> <div class="control-group svelte-1qpo30f"><!></div> <div class="control-group svelte-1qpo30f"><!></div> <div class="control-group svelte-1qpo30f"><details class="settings-details svelte-1qpo30f"><summary class="settings-summary svelte-1qpo30f">Settings</summary> <div class="settings-content svelte-1qpo30f"><!> <!> <!></div></details></div> <div class="control-group svelte-1qpo30f"><!></div> <!></aside> <section class="canvas-area svelte-1qpo30f"><!></section></main> <!></div>');function Pa(e,n){pe(n,!0);let i=K(!1);Re(()=>de.onPerformanceComplete(V=>{if(Y.state.isActive&&Y.state.isPlaying){const $=xe.calculateSummary(V,Y.state.targetNotes);xe.show($,{title:Y.title,artist:Y.artist,source:"ultrastar"}),Y.setPlaying(!1)}}));function s(){xe.state.source==="ultrastar"?(de.reset(),de.setTargetNotes(Y.state.targetNotes),j.setVisualizationMode("highway")):xe.state.source}tn(async()=>{if(await Se.checkAndConsumeHandoff()){console.log("[App] Handoff detected and processed");const V=Se.suggestedPitchRange;V&&j.setYAxisRange(V)}try{await qi(),j.setDetecting(!0),console.log("[App] Pitch detection auto-started")}catch(V){console.error("[App] Failed to auto-start pitch detection:",V)}}),Ye(()=>{Ui()});const r=A(()=>Se.state.hasImportedSnapshot),o=A(()=>Se.state.transpositionSemitones),a=A(()=>Se.state.error);function c(){Se.bringBackToStudentNotation()}function l(){Se.transposeUp()}function d(){Se.transposeDown()}var g=_a(),h=p(g),u=w(p(h),2),y=p(u);{var v=ne=>{var V=ba(),$=p(V),B=p($);B.__click=d;var R=w(B,2),Z=p(R),ae=w(R,2);ae.__click=l;var ue=w($,2);ue.__click=c,J(()=>q(Z,`${t(o)>=0?"+":""}${t(o)??""}`)),H(ne,V)};ee(y,ne=>{t(r)&&ne(v)})}var f=w(h,2);{var m=ne=>{var V=wa(),$=p(V);J(()=>q($,t(a))),H(ne,V)};ee(f,ne=>{t(a)&&ne(m)})}var b=w(f,2),T=p(b),C=p(T),I=p(C);aa(I,{});var P=w(C,2),_=p(P);Ts(_,{});var x=w(P,2),N=p(x);ta(N,{});var k=w(x,2),D=p(k),E=w(p(D),2),U=p(E);Ji(U,{});var te=w(U,2);es(te,{});var z=w(te,2);ms(z,{});var S=w(k,2),G=p(S);gs(G,{});var Q=w(S,2);{var le=ne=>{var V=Ta(),$=w(p(V),2),B=w(p($),2),R=p(B),Z=w($,2),ae=w(p(Z),2),ue=p(ae),be=w(Z,2);{var we=me=>{var X=Ma(),se=w(p(X),2),M=p(se);J(()=>q(M,Se.timeGrid.microbeatCount)),H(me,X)};ee(be,me=>{Se.timeGrid&&me(we)})}J(()=>{q(R,Se.voices.length),q(ue,`${Se.tempo??""} BPM`)}),H(ne,V)};ee(Q,ne=>{t(r)&&ne(le)})}var Te=w(T,2),Pe=p(Te);Bi(Pe,{});var Ce=w(b,2);pa(Ce,{onRetry:s}),an("open","toggle",D,ne=>F(i,ne),()=>t(i)),H(e,g),ye()}_e(["click"]);function Ca(e){const n=Nn(Pa,{target:e});return{destroy:()=>{kn(n)}}}const Jt=document.getElementById("app");Jt&&Ca(Jt);
