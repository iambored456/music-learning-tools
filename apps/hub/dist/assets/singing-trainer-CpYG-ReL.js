import"./modulepreload-polyfill-B5Qt9EMX.js";import{o as mn,q as Fn,r as On,v as Wn,w as Bn,x as qe,y as zn,z as Dt,A as Ht,B as qn,C as Yn,D as Gn,S as pn,E as Vn,F as Un,P as jn,g as n,G as Xn,H as Kn,i as Ee,k as B,I as Zn,J as Jn,K as Qn,L as $n,M as ei,N as ti,O as ni,Q as ii,R as si,p as Te,u as Re,h as J,l as N,f as F,c as b,s as P,a as E,j as Pe,e as Se,t as te,b as G,T as ai,d as Fe,U as Ue,V as Je,$ as yn,W as oi,X as ri,m as li}from"./legacy-BJBcSenI.js";import{T as zt,o as ci,V as bn,r as ui,a6 as qt,h as Yt,j as di,a7 as pt,b as fi,_ as _n,$ as ze,Y as le,a8 as hi,a9 as vi,z as Et,t as wn,aa as Gt,k as gi,v as mi,C as pi,a0 as Lt,Z as et,p as Vt,ab as yi,a2 as bi,ac as _i,ad as wi,ae as Mi,af as nt,a1 as Ut}from"./navigation-Dpq1k5cw.js";import{e as tt,i as dt,s as ot}from"./style-CtguFRYq.js";function kt(e,t,i=!1){if(e.multiple){if(t==null)return;if(!Fn(t))return On();for(var s of e.options)s.selected=t.includes(jt(s));return}for(s of e.options){var o=jt(s);if(Wn(o,t)){s.selected=!0;return}}(!i||t!==void 0)&&(e.selectedIndex=-1)}function Mn(e){var t=new MutationObserver(()=>{kt(e,e.__value)});t.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),mn(()=>{t.disconnect()})}function jt(e){return"__value"in e?e.__value:e.value}function yt(e,t,i=t){var s=new WeakSet;Bn(e,"input",async o=>{var a=o?e.defaultValue:e.value;if(a=bt(e)?_t(a):a,i(a),qe!==null&&s.add(qe),await zn(),a!==(a=t())){var r=e.selectionStart,c=e.selectionEnd,l=e.value.length;if(e.value=a??"",c!==null){var u=e.value.length;r===c&&c===l&&u>l?(e.selectionStart=u,e.selectionEnd=u):(e.selectionStart=r,e.selectionEnd=Math.min(c,u))}}}),Dt(t)==null&&e.value&&(i(bt(e)?_t(e.value):e.value),qe!==null&&s.add(qe)),Ht(()=>{var o=t();if(e===document.activeElement){var a=qn??qe;if(s.has(a))return}bt(e)&&o===_t(e.value)||e.type==="date"&&!o&&!e.value||o!==e.value&&(e.value=o??"")})}function bt(e){var t=e.type;return t==="number"||t==="range"}function _t(e){return e===""?null:+e}function Xt(e,t){return e===t||e?.[pn]===t}function He(e={},t,i,s){return Yn(()=>{var o,a;return Ht(()=>{o=a,a=[],Dt(()=>{e!==i(...a)&&(t(e,...a),o&&Xt(i(...o),e)&&t(null,...o))})}),()=>{Gn(()=>{a&&Xt(i(...a),e)&&t(null,...a)})}}),e}function Tn(e,t,i,s,o){var a=()=>{s(i[e])};i.addEventListener(t,a),o?Ht(()=>{i[e]=o()}):a(),(i===document.body||i===window||i===document)&&mn(()=>{i.removeEventListener(t,a)})}let it=!1;function Ti(e){var t=it;try{return it=!1,[e(),it]}finally{it=t}}function pe(e,t,i,s){var o=!ei||(i&ti)!==0,a=(i&$n)!==0,r=(i&ii)!==0,c=s,l=!0,u=()=>(l&&(l=!1,c=r?Dt(s):s),c),f;if(a){var g=pn in e||si in e;f=Vn(e,t)?.set??(g&&t in e?_=>e[t]=_:void 0)}var h,p=!1;a?[h,p]=Ti(()=>e[t]):h=e[t],h===void 0&&s!==void 0&&(h=u(),f&&(o&&Un(),f(h)));var m;if(o?m=()=>{var _=e[t];return _===void 0?u():(l=!0,_)}:m=()=>{var _=e[t];return _!==void 0&&(c=void 0),_===void 0?c:_},o&&(i&jn)===0)return m;if(f){var d=e.$$legacy;return(function(_,I){return arguments.length>0?((!o||!I||d||p)&&f(I?m():_),_):m()})}var v=!1,y=((i&ni)!==0?Xn:Kn)(()=>(v=!1,m()));a&&n(y);var w=Jn;return(function(_,I){if(arguments.length>0){const C=I?n(y):o&&a?Ee(_):_;return B(y,C),v=!0,c!==void 0&&(c=C),_}return Zn&&v||(w.f&Qn)!==0?y.v:n(y)})}class je extends zt{constructor(){const t=ci(je.getDefaults(),arguments,["volume"]);super(t),this.name="UserMedia",this._volume=this.output=new bn({context:this.context,volume:t.volume}),this.volume=this._volume.volume,ui(this,"volume"),this.mute=t.mute}static getDefaults(){return Object.assign(zt.getDefaults(),{mute:!1,volume:0})}open(t){return qt(this,void 0,void 0,function*(){Yt(je.supported,"UserMedia is not supported"),this.state==="started"&&this.close();const i=yield je.enumerateDevices();di(t)?this._device=i[t]:(this._device=i.find(a=>a.label===t||a.deviceId===t),!this._device&&i.length>0&&(this._device=i[0]),Yt(pt(this._device),`No matching device ${t}`));const s={audio:{echoCancellation:!1,sampleRate:this.context.sampleRate,noiseSuppression:!1,mozNoiseSuppression:!1}};this._device&&(s.audio.deviceId=this._device.deviceId);const o=yield navigator.mediaDevices.getUserMedia(s);if(!this._stream){this._stream=o;const a=this.context.createMediaStreamSource(o);fi(a,this.output),this._mediaStream=a}return this})}close(){return this._stream&&this._mediaStream&&(this._stream.getAudioTracks().forEach(t=>{t.stop()}),this._stream=void 0,this._mediaStream.disconnect(),this._mediaStream=void 0),this._device=void 0,this}static enumerateDevices(){return qt(this,void 0,void 0,function*(){return(yield navigator.mediaDevices.enumerateDevices()).filter(i=>i.kind==="audioinput")})}get state(){return this._stream&&this._stream.active?"started":"stopped"}get deviceId(){if(this._device)return this._device.deviceId}get groupId(){if(this._device)return this._device.groupId}get label(){if(this._device)return this._device.label}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}dispose(){return super.dispose(),this.close(),this._volume.dispose(),this.volume.dispose(),this}static get supported(){return pt(navigator.mediaDevices)&&pt(navigator.mediaDevices.getUserMedia)}}const At=["#ef8aab","#f48e7d","#e89955","#cdaa42","#a4ba57","#6ec482","#2dc8b1","#16c3da","#58b8f6","#8fa9ff","#ba9bf2","#db8fd4"],Kt=At[0];function Zt(e){const t=parseInt(e.slice(1),16);return[t>>16&255,t>>8&255,t&255]}function Pi(e,t,i){const s=Math.max(0,Math.min(1,i));return e.map((o,a)=>{const r=t[a]??o;return Math.round(o+s*(r-o))})}function Pn(e,t=0){const i=Math.floor(e),s=e-i,o=(i%12-t+12)%12,a=(o+1)%12,r=Zt(At[o]??Kt),c=Zt(At[a]??Kt);return Pi(r,c,s)}const Ci={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11};function Si(e){const t=e.replace(/\d+$/,"");return Ci[t]??0}const wt={onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70,accuracyTiers:{perfect:{onsetMs:30,pitchCents:10,coverage:95},good:{onsetMs:75,pitchCents:25,coverage:85},okay:{onsetMs:150,pitchCents:50,coverage:70}}};function Ai(e={}){const t={...wt,...e,accuracyTiers:e.accuracyTiers?{...wt.accuracyTiers,...e.accuracyTiers}:wt.accuracyTiers},i=new Map,s=new Map;function o(g,h){return(g-h)*100}function a(g,h){return Math.abs(o(g.midi,h))<=t.pitchToleranceCents}function r(g,h){return g.length===0?0:g.reduce((m,d)=>m+Math.abs(o(d.midi,h)),0)/g.length}function c(g,h,p,m){if(g.length===0)return 0;const d=g.filter(y=>a(y,h));if(d.length===0)return 0;let v=0;for(let y=0;y<d.length;y++){const w=d[y];if(!w)continue;const _=d[y+1];if(_)v+=_.timeMs-w.timeMs;else{const I=p+m,C=Math.min(50,I-w.timeMs);v+=C}}return v/m*100}function l(g,h,p){const m=t.accuracyTiers;if(!m)return"okay";const d=Math.abs(g);return d<=m.perfect.onsetMs&&h<=m.perfect.pitchCents&&p>=m.perfect.coverage?"perfect":d<=m.good.onsetMs&&h<=m.good.pitchCents&&p>=m.good.coverage?"good":d<=m.okay.onsetMs&&h<=m.okay.pitchCents&&p>=m.okay.coverage?"okay":"miss"}function u(g){const{note:h,samples:p,onsetSample:m,releaseSample:d}=g;let v=0;m?v=m.timeMs-h.startTimeMs:v=t.onsetToleranceMs*2;let y=0;const w=h.startTimeMs+h.durationMs;d?y=d.timeMs-w:y=t.releaseToleranceMs*2;const _=r(p,h.midi),I=c(p,h.midi,h.startTimeMs,h.durationMs),C=Math.abs(v)<=t.onsetToleranceMs,M=Math.abs(y)<=t.releaseToleranceMs,S=I>=t.hitThreshold,D=C&&M&&S?"hit":"miss",x=l(v,_,I);return{hitStatus:D,onsetAccuracyMs:v,releaseAccuracyMs:y,pitchAccuracyCents:_,pitchCoverage:I,pitchSamples:[...p],accuracyTier:x}}return{startNote(g,h){i.set(g,{note:h,samples:[],onsetSample:null,releaseSample:null,startedAt:performance.now()})},recordPitchSample(g){for(const[h,p]of i){const{note:m}=p,d=m.startTimeMs+m.durationMs,v=t.onsetToleranceMs,y=t.releaseToleranceMs;g.timeMs>=m.startTimeMs-v&&g.timeMs<=d+y&&(p.samples.push(g),!p.onsetSample&&g.timeMs>=m.startTimeMs-v&&g.timeMs<=m.startTimeMs+v&&a(g,m.midi)&&(p.onsetSample=g),g.timeMs>=d-y&&g.timeMs<=d+y&&(p.releaseSample=g))}},endNote(g){const h=i.get(g);if(!h)return null;const p=u(h);return s.set(g,p),i.delete(g),p},getCurrentPerformance(g){const h=i.get(g);if(!h)return null;const{note:p,samples:m,onsetSample:d}=h;let v=0;d&&(v=d.timeMs-p.startTimeMs);const y=r(m,p.midi),w=c(m,p.midi,p.startTimeMs,p.durationMs);return{onsetAccuracyMs:v,pitchAccuracyCents:y,pitchCoverage:w,pitchSamples:[...m]}},getAllPerformances(){return new Map(s)},reset(){i.clear(),s.clear()},dispose(){i.clear(),s.clear()}}}const Jt={judgmentLinePosition:.12,pixelsPerSecond:200,lookAheadMs:3e3,scrollMode:"constant-speed",leadInBeats:4,playMetronomeDuringOnramp:!0,playTargetNotes:!0,playMetronome:!1,inputSources:["microphone"],feedbackConfig:{onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70}};function Ii(e){const t={...Jt,...e,feedbackConfig:{...Jt.feedbackConfig,...e.feedbackConfig}},{stateCallbacks:i,eventCallbacks:s,visualCallbacks:o,logger:a}=t,r={isPlaying:!1,isPaused:!1,currentTimeMs:0,scrollOffset:0,onrampComplete:!1,targetNotes:[],activeNotes:new Set,startTime:null},c=Ai(t.feedbackConfig);let l=null;const u=new Set;function f(){const M=60/i.getTempo()*1e3;return t.leadInBeats*M}function g(){return i.getViewportWidth()*t.judgmentLinePosition}function h(C){const M=t.pixelsPerSecond/1e3,S=g(),D=f();return(C+D)*M-S}function p(C){const M=g(),S=i.getCellWidth(),D=C.startColumn*S-r.scrollOffset,x=C.endColumn*S-r.scrollOffset,X=t.feedbackConfig.onsetToleranceMs/1e3*t.pixelsPerSecond;return D<=M+X&&x>=M-X}function m(){const C=new Set;for(const M of r.targetNotes){const S=M.startTimeMs+M.durationMs,D=t.feedbackConfig.onsetToleranceMs;if(r.currentTimeMs>=M.startTimeMs-D&&r.currentTimeMs<=S+D)C.add(M.id),r.activeNotes.has(M.id)||(c.startNote(M.id,M),a?.debug("NoteHighway",`Note ${M.id} became active`,{note:M}));else if(r.activeNotes.has(M.id)){const x=c.endNote(M.id);if(x){M.performance=x;const H={noteId:M.id,note:M,performance:x};x.hitStatus==="hit"?(s.emit("noteHit",H),o?.onNoteHit?.(M.id,x.accuracyTier||"okay"),a?.info("NoteHighway",`Note hit: ${M.id}`,x)):(s.emit("noteMissed",H),o?.onNoteMiss?.(M.id),a?.info("NoteHighway",`Note missed: ${M.id}`,x))}}}r.activeNotes=C}function d(){for(const C of r.targetNotes){const M=p(C),S=u.has(C.id);M&&!S?(u.add(C.id),s.emit("noteEntered",{noteId:C.id,note:C})):!M&&S&&(u.delete(C.id),s.emit("noteExited",{noteId:C.id,note:C}))}}function v(){if(!r.onrampComplete)if(r.currentTimeMs>=0)r.onrampComplete=!0,s.emit("onrampComplete"),o?.clearOnrampCountdown?.(),a?.info("NoteHighway","Onramp complete",null);else{const M=60/i.getTempo()*1e3,S=Math.abs(r.currentTimeMs),D=Math.ceil(S/M);o?.updateOnrampCountdown?.(D)}}function y(){if(!r.isPlaying||r.isPaused||!r.startTime){l=null;return}const C=performance.now(),M=f();r.currentTimeMs=C-r.startTime-M,r.scrollOffset=h(r.currentTimeMs),v(),m(),d(),l=requestAnimationFrame(y)}function w(){l||(l=requestAnimationFrame(y))}function _(){l&&(cancelAnimationFrame(l),l=null)}return{init(C){r.targetNotes=C,a?.info("NoteHighway",`Initialized with ${C.length} notes`,null)},start(){r.isPlaying||(r.isPlaying=!0,r.isPaused=!1,r.currentTimeMs=-f(),r.scrollOffset=h(r.currentTimeMs),r.onrampComplete=!1,r.activeNotes.clear(),r.startTime=performance.now(),u.clear(),c.reset(),w(),s.emit("playbackStarted"),a?.info("NoteHighway","Playback started",{onrampDurationMs:f()}))},pause(){!r.isPlaying||r.isPaused||(r.isPaused=!0,_(),s.emit("playbackPaused"),a?.info("NoteHighway","Playback paused",{currentTimeMs:r.currentTimeMs}))},resume(){if(!r.isPlaying||!r.isPaused||!r.startTime)return;const C=performance.now()-(r.startTime+r.currentTimeMs+f());r.startTime+=C,r.isPaused=!1,w(),s.emit("playbackResumed"),a?.info("NoteHighway","Playback resumed",null)},stop(){if(!r.isPlaying)return;r.isPlaying=!1,r.isPaused=!1,r.currentTimeMs=0,r.scrollOffset=0,r.onrampComplete=!1,r.activeNotes.clear(),r.startTime=null,u.clear(),_(),o?.clearCanvas?.(),o?.clearOnrampCountdown?.(),s.emit("playbackStopped"),r.targetNotes.every(M=>M.performance!==void 0)&&s.emit("performanceComplete"),a?.info("NoteHighway","Playback stopped",null)},setScrollOffset(C){if(r.currentTimeMs=C,r.scrollOffset=h(C),r.isPlaying){const M=f();r.startTime=performance.now()-(C+M)}a?.debug("NoteHighway","Scroll offset set",{timeMs:C,scrollOffset:r.scrollOffset})},recordPitchInput(C,M,S){if(!r.isPlaying||r.isPaused||!t.inputSources.includes(S))return;const D={timeMs:r.currentTimeMs,midi:C,clarity:M,source:S};c.recordPitchSample(D)},getState(){return r},getVisibleNotes(){g();const C=i.getViewportWidth(),M=i.getCellWidth();return r.targetNotes.filter(S=>{const D=S.startColumn*M-r.scrollOffset;return S.endColumn*M-r.scrollOffset>=0&&D<=C})},getPerformanceResults(){return c.getAllPerformances()},getFeedbackCollector(){return c},dispose(){_(),c.dispose(),r.targetNotes=[],r.activeNotes.clear(),u.clear(),a?.info("NoteHighway","Service disposed",null)}}}function xi(e){const{cellHeight:t,columnWidths:i,viewport:s}=e,o=t/2,a=Ri(i,e.cellWidth);return{getRowY(r){return(r-s.startRow+1)*o},getRowFromY(r){const c=r/o-1;return Math.round(c)+s.startRow},getColumnX(r){return r<0?0:r>=a.length?a[a.length-1]??0:a[r]??0},getColumnFromX(r){let c=0,l=a.length-1;for(;c<l;){const u=Math.floor((c+l)/2);(a[u]??0)<=r?c=u+1:l=u}return Math.max(0,c-1)}}}function Cn(e){const{cellHeight:t,viewport:i,pixelsPerSecond:s,nowLineX:o=100,currentTimeMs:a=0}=e,r=t/2;return{getRowY(c){return(c-i.startRow+1)*r},getRowFromY(c){const l=c/r-1;return Math.round(l)+i.startRow},getColumnX(c){return 0},getColumnFromX(c){return 0},getTimeX(c){const l=c-a;return o+l/1e3*s},getTimeFromX(c){const l=(c-o)/s*1e3;return a+l}}}function Ri(e,t){const i=[0];let s=0;for(let o=0;o<e.length;o++){const a=(e[o]??1)*t;s+=a,i.push(s)}return i}function Ni(e,t){const{startRow:i,endRow:s}=e,o=Math.max(0,t.length-1);return{startRow:i,endRow:s,paddedStartRow:Math.max(0,i-1),paddedEndRow:Math.min(o,s+1)}}function Mt(e,t,i,s){const o=s.getRowY(e),a=i;return o>=-a&&o<=t.containerHeight+a}function Di(e){let t=(e||"").replace(/\d/g,"").trim();return t=t.replace(/b/g,"b-").replace(/#/g,"b_"),t}function Hi(e){switch(e){case"C":return{lineWidth:3.33,dash:[],color:"#adb5bd"};case"E":return{lineWidth:1,dash:[5,5],color:"#adb5bd"};case"G":return{lineWidth:1,dash:[],color:"#dee2e6"};case"B":case"A":case"F":case"Eb/Db":case"Db/C#":return{lineWidth:1,dash:[],color:"#ced4da"};default:return{lineWidth:1,dash:[],color:"#ced4da"}}}const st={stroke:"#c7cfd8",background:"rgba(207, 214, 222, 0.32)"};let Ye=null;function Ei(){if(Ye)return Ye;if(typeof window>"u")return st;try{const e=window.getComputedStyle(document.documentElement);Ye={stroke:e.getPropertyValue("--c-anacrusis-border").trim()||st.stroke,background:e.getPropertyValue("--c-anacrusis-bg").trim()||st.background}}catch{Ye=st}return Ye}function Li(e,t,i,s,o,a=0,r){const{fullRowData:c,viewportHeight:l,viewportWidth:u,cellHeight:f}=t,g=u,h=["B","A","F","Eâ™­/Dâ™¯","Dâ™­/Câ™¯"];for(let p=s;p<=o;p++){const m=c[p];if(!m||m.isBoundary)continue;const d=i.getRowY(p);if(d<-10||d>l+10)continue;const v=Di(m.pitch);if(h.includes(v))continue;const y=Hi(v);v==="G"?(e.save(),e.fillStyle=y.color,e.fillRect(a,d-f/2,g-a,f),e.restore()):(e.beginPath(),e.moveTo(a,d),e.lineTo(g,d),e.lineWidth=y.lineWidth,e.strokeStyle=y.color,e.setLineDash(y.dash),e.stroke(),e.setLineDash([]))}}function ki(e,t,i,s){const{columnWidths:o,viewportHeight:a,macrobeatBoundaryStyles:r,placedTonicSigns:c}=t,l=o.length;for(let u=0;u<=l;u++){const f=u===0||u===l,g=Oi(u,c),h=c.some(y=>u===y.columnIndex+2),p=s.includes(u);if(!Wi(u,c))continue;let d=null;if(f||g||h)d={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(p){const y=s.indexOf(u),w=r[y]??"dashed";if(w==="anacrusis"){const{stroke:_}=Ei();d={lineWidth:1,strokeStyle:_,dash:[4,4]}}else d={lineWidth:1,strokeStyle:"#adb5bd",dash:w==="solid"?[]:[5,5]}}if(!d)continue;const v=i.getColumnX(u);e.beginPath(),e.moveTo(v,0),e.lineTo(v,a),e.lineWidth=d.lineWidth,e.strokeStyle=d.strokeStyle,e.setLineDash(d.dash),e.stroke()}e.setLineDash([])}function Fi(e,t,i){const{viewportHeight:s,beatIntervalMs:o,measureIntervalMs:a,visibleTimeRange:r,nowLineX:c,beatTimeOffsetMs:l=0}=t,u=r.startMs-l,f=r.endMs-l,g=Math.floor(u/o),h=Math.ceil(f/o);for(let p=g;p<=h;p++){const m=l+p*o,d=i.getTimeX?.(m);if(d===void 0)continue;const v=a?(m-l)%a===0:!1;e.beginPath(),e.moveTo(d,0),e.lineTo(d,s),e.lineWidth=v?2:1,e.strokeStyle=v?"#adb5bd":"#dee2e6",e.setLineDash(v?[]:[5,5]),e.stroke()}e.setLineDash([]),c!==void 0&&(e.beginPath(),e.moveTo(c,0),e.lineTo(c,s),e.lineWidth=3,e.strokeStyle="#00ff00",e.setLineDash([]),e.stroke())}function Oi(e,t){return t.some(i=>i.columnIndex===e)}function Wi(e,t){return!t.some(i=>i.columnIndex+1===e)}const Bi=.7,zi=.9,qi=4,Yi=1,Gi=.15,Vi=.2,Ui=1,Ft=1.5;function Xe(e,t){return Number.isFinite(e)&&e>0&&Number.isFinite(t)&&t>0}function Sn(e){if(!e||typeof e.startColumnIndex!="number"||typeof e.endColumnIndex!="number")return!1;const t=e.shape==="circle"?e.startColumnIndex+1:e.startColumnIndex;return e.endColumnIndex>t}function rt(e){const t=e?.split("-")[1];return Number.parseInt(t??"0",10)}function An(e,t,i){const s=i*.25,o=e.uuid;if(!o)return 0;const a=t.filter(l=>!l.isDrum&&l.row===e.row&&l.startColumnIndex===e.startColumnIndex&&l.uuid&&l.uuid!==o);if(a.length===0)return 0;const r=[e,...a];return r.sort((l,u)=>rt(l.uuid)-rt(u.uuid)),r.findIndex(l=>l.uuid===o)*s}function ji(e,t,i){const s=i/2*.12,o=e.uuid;if(!o)return 0;const a=t.filter(l=>!l.isDrum&&l.row===e.row&&l.startColumnIndex===e.startColumnIndex&&l.uuid&&l.uuid!==o&&Sn(l));if(a.length===0)return 0;const r=[e,...a];return r.sort((l,u)=>rt(l.uuid)-rt(u.uuid)),r.findIndex(l=>l.uuid===o)*s}function Xi(e){if(!e)return{multiplier:1,category:"natural"};const t=e.includes("â™­"),i=e.includes("â™¯"),s=e.includes("/");return!t&&!i?{multiplier:1,category:"natural"}:s?{multiplier:.75,category:"both-accidentals"}:{multiplier:.88,category:"single-accidental"}}function It(e,t,i,s,o,a){const{multiplier:r,category:c}=Xi(t);let l;if(i==="circle"){const u=a*2*zi;switch(c){case"natural":l=u;break;case"single-accidental":l=u*.8;break;case"both-accidentals":l=u*.4;break;default:l=u*r}}else{const u=a*2*Bi;switch(c){case"natural":l=u*1.5;break;case"single-accidental":l=u*1.2;break;case"both-accidentals":l=u;break;default:l=u*r}}if(!(l<qi))if(e.fillStyle="#212529",e.font=`bold ${l}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle",i==="oval"&&c==="both-accidentals"&&t.includes("/")){const u=t.split("/"),f=l*1.1,g=f*(u.length-1),h=o-g/2;u.forEach((p,m)=>{const d=h+m*f,v=l*.08;e.fillText(p.trim(),s,d+v)})}else{const u=l*.08;e.fillText(t,s,o+u)}}function Ki(e,t,i,s,o,a,r){e.save(),e.beginPath(),e.arc(i,o,a,Math.PI/2,-Math.PI/2,!1),e.lineTo(s,o-a),e.arc(s,o,a,-Math.PI/2,Math.PI/2,!1),e.lineTo(i,o+a),e.closePath(),e.strokeStyle=t.color,e.lineWidth=r,e.shadowColor=t.color,e.shadowBlur=Ft,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore()}function Qt(e,t,i,s){const{config:o,coords:a,allNotes:r,getScaleDegreeLabel:c}=t,{cellWidth:l,cellHeight:u,columnWidths:f,degreeDisplayMode:g}=o,h=a.getRowY(s),p=a.getColumnX(i.startColumnIndex),d=(f[i.startColumnIndex]??1)*l;if(!Xe(d,u))return;const v=An(i,r,l),y=Math.max(.5,d*.15),w=p+d/2+v,_=d/2-y/2,I=u/2-y/2;if(Xe(_,I)&&(e.save(),e.beginPath(),e.ellipse(w,h,_,I,0,0,2*Math.PI),e.strokeStyle=i.color,e.lineWidth=y,e.shadowColor=i.color,e.shadowBlur=Ft,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore(),g!=="off"&&c)){const{label:C}=c(i);C&&It(e,C,"oval",w,h,_)}}function $t(e,t,i,s){const{config:o,coords:a,allNotes:r,getScaleDegreeLabel:c}=t,{cellWidth:l,cellHeight:u,degreeDisplayMode:f,longNoteStyle:g}=o,h=a.getRowY(s),p=a.getColumnX(i.startColumnIndex),d=a.getColumnX(i.startColumnIndex+1)-p;if(!Xe(d,u))return;const v=An(i,r,l),y=p+d+v,w=Math.max(Yi,d*Gi),_=u/2-w/2,I=Sn(i);if(I&&g==="style2"){const M=y,S=a.getColumnX(i.endColumnIndex);if(Xe(S-M,_)&&(Ki(e,i,M,S,h,_,w),f!=="off"&&c)){const{label:D}=c(i);if(D){const x=(M+S)/2;It(e,D,"circle",x,h,_)}}return}if(I){const M=a.getColumnX(i.endColumnIndex+1),S=ji(i,r,u),D=h+S;e.beginPath(),e.moveTo(y,D),e.lineTo(M,D),e.strokeStyle=i.color,e.lineWidth=Math.max(Ui,d*Vi),e.stroke()}const C=d-w/2;if(Xe(C,_)&&(e.save(),e.beginPath(),e.ellipse(y,h,C,_,0,0,2*Math.PI),e.strokeStyle=i.color,e.lineWidth=w,e.shadowColor=i.color,e.shadowBlur=Ft,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore(),f!=="off"&&c)){const{label:M}=c(i);M&&It(e,M,"circle",y,h,C)}}function Zi(e,t,i){const{config:s,coords:o}=t,{cellWidth:a,cellHeight:r}=s,c=o.getRowY(i.globalRow??i.row),l=o.getColumnX(i.columnIndex),f=o.getColumnX(i.columnIndex+1)-l,g=f*2,h=l+g/2,p=Math.min(g,r)/2*.9;if(p<2||(e.beginPath(),e.arc(h,c,p,0,2*Math.PI),e.strokeStyle="#212529",e.lineWidth=Math.max(.5,f*.05),e.stroke(),i.tonicNumber==null))return;const m=i.tonicNumber.toString(),d=p*1.5;d<6||(e.fillStyle="#212529",e.font=`bold ${d}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(m,h,c))}const Ji={timeWindowMs:4e3,pixelsPerSecond:200,circleRadius:9.5,proximityThreshold:35,maxConnections:3,connectorLineWidth:2.5,connectorColor:"rgba(0,0,0,0.4)",useTonicRelativeColors:!0,tonicPitchClass:0,clarityThreshold:.5,maxOpacity:.9};function In(e){return{...Ji,...e}}function en(e,t,i,s,o,a,r){const c=In(a.trailConfig);if(s<c.clarityThreshold||i<=0)return;const{cellHeight:l,colorMode:u}=a,f=xn(t,i,l,r),g=l/2*.8,h=u==="bw"?[128,128,128]:Pn(i,c.tonicPitchClass);e.save(),e.beginPath(),e.arc(o,f,g+4,0,2*Math.PI),e.fillStyle=`rgba(${h[0]}, ${h[1]}, ${h[2]}, ${s*.3})`,e.fill(),e.beginPath(),e.arc(o,f,g,0,2*Math.PI),e.fillStyle=`rgba(${h[0]}, ${h[1]}, ${h[2]}, ${s})`,e.fill(),e.restore()}function xn(e,t,i,s){if(s.length===0||!s[0])return 0;const o=Math.floor(t),a=t-o,l=(s[0].midi??108)-o;if(l<0||l>=s.length)return l<0?0:e.getRowY(s.length-1);const u=e.getRowY(l),f=i/2;return u-a*f}function Rn(e,t,i,s,o,a){const{viewportWidth:r,cellHeight:c,colorMode:l}=o,u=In(o.trailConfig),f=u.timeWindowMs,g=u.pixelsPerSecond,h=o.nowLineX??r,p=i.filter(m=>m.midi>0&&m.clarity>=u.clarityThreshold).map(m=>{const d=s-m.time;if(d>=f||d<0)return null;const v=h-d/1e3*g,y=xn(t,m.midi,c,a),w=l==="bw"?[128,128,128]:Pn(m.midi,u.tonicPitchClass);return{x:v,y,clarity:m.clarity,color:w}}).filter(m=>m!==null&&m.x>=0);if(p.length!==0){e.save(),e.strokeStyle=u.connectorColor,e.lineWidth=u.connectorLineWidth,e.beginPath();for(let m=0;m<p.length;m++){let d=0;for(let v=m+1;v<p.length&&d<u.maxConnections;v++){const y=p[m].x-p[v].x,w=p[m].y-p[v].y;Math.sqrt(y*y+w*w)<=u.proximityThreshold&&(e.moveTo(p[m].x,p[m].y),e.lineTo(p[v].x,p[v].y),d++)}}e.stroke();for(const m of p){const d=Math.min(m.clarity*u.maxOpacity,1);e.fillStyle=`rgba(${m.color[0]}, ${m.color[1]}, ${m.color[2]}, ${d})`,e.beginPath(),e.arc(m.x,m.y,u.circleRadius,0,2*Math.PI),e.fill()}e.restore()}}function tn(e,t,i,s,o,a,r,c){const{cellHeight:l,nowLineX:u=100,pixelsPerSecond:f}=o,g=.5;for(const h of i){const p=(u??100)+(h.startTimeMs-s)/1e3*f,m=p+h.durationMs/1e3*f;if(m<0||p>o.viewportWidth)continue;let d;if(a){if(d=a.findIndex(M=>M.midi===h.midi),d===-1)continue}else d=Math.round(108-h.midi);const v=t.getRowY(d),y=l/2-2,w=h.color??"#4CAF50",_=p<=u&&m>=u,I=r!=null&&(c??0)>.5&&Math.abs(r-h.midi)<=g,C=_&&I;if(e.save(),e.beginPath(),e.arc(p,v,y,Math.PI/2,-Math.PI/2,!1),e.lineTo(m,v-y),e.arc(m,v,y,-Math.PI/2,Math.PI/2,!1),e.lineTo(p,v+y),e.closePath(),C?(e.strokeStyle="#FFD700",e.lineWidth=5,e.shadowColor="#FFD700",e.shadowBlur=20,e.stroke(),e.fillStyle="rgba(255, 215, 0, 0.3)",e.fill(),Qi(e,u,v,y)):(e.strokeStyle=w,e.lineWidth=3,e.shadowColor=w,e.shadowBlur=8,e.stroke()),e.shadowBlur=0,e.restore(),h.label){const M=p+y+4;e.fillStyle=C?"#FFD700":"#212529",e.font=`bold ${Math.max(16,y*1.2)}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="left",e.textBaseline="middle",e.fillText(h.label,M,v)}}}function Qi(e,t,i,s){const r=s*1.5;e.save(),e.fillStyle="#FFD700",e.shadowColor="#FFD700",e.shadowBlur=6;for(let c=0;c<8;c++){const l=c/8*Math.PI*2,u=t+Math.cos(l)*r,f=i+Math.sin(l)*r;e.beginPath(),e.arc(u,f,3,0,Math.PI*2),e.fill()}e.restore()}function $i(e){const t=e.replace(/\d+$/,"");return t.length>0?t:e}function Nn(e,t){return!Number.isFinite(t)||t<=0?e:Math.round(e*t)/t}function es(e,t,i,s){const o=Math.max(10,Math.min(e*1.2,t*1.2)),a=i<=3?1:.7,r=s<=1?1.08:1;return Nn(o*a*r,s)}function ts(e){const t=e.getContext("2d");return t&&(t.getTransform().a||window.devicePixelRatio)||1}function ns(e){if(typeof e.midi=="number")return e.midi%12;if(typeof e.pitchClass=="number")return e.pitchClass;const t={C:0,D:2,E:4,F:5,G:7,A:9,B:11},i=e.pitch.charAt(0).toUpperCase();let s=t[i]??0;return(e.pitch.includes("#")||e.pitch.includes("â™¯"))&&s++,(e.pitch.includes("b")||e.pitch.includes("â™­"))&&s--,(s%12+12)%12}function is(e,t){const{showFrequencyLabels:i,showOctaveLabels:s,accidentalMode:o}=t,a=g=>s?g:$i(g);if(i)return String(Math.round(e.frequency));const{flatName:r,sharpName:c,isAccidental:l}=e,{sharp:u,flat:f}=o;return l?u&&f?a(e.pitch):u&&!f?a(c):f&&!u?a(r):null:a(r)}function nn(e,t,i,s){const{fullRowData:o,cellWidth:a,cellHeight:r,legendColumnWidth:c,colorMode:l,accidentalMode:u}=t,{startRow:f,endRow:g,coords:h}=i,p=ts(e.canvas),m=y=>Nn(y,p),d=c;let v=0;for(const y of s){for(let w=f;w<=g;w++){const _=o[w];if(!_||_.isBoundary||_.column!==y)continue;const I=h.getRowY(w),C=!u.sharp&&!u.flat,M=_.isAccidental&&C,S=is(_,t);if(S===null)continue;let D=l==="bw"?"#ffffff":_.hex||"#ffffff",x="FF";M&&(x="00"),e.fillStyle=M?"rgba(255,255,255,0)":D,e.fillRect(v,I-r/2,d,r),t.highlight&&typeof t.highlight.pitchClass=="number"&&t.highlight.opacity>.01&&ns(_)===t.highlight.pitchClass&&(e.save(),e.globalAlpha=Math.min(Math.max(t.highlight.opacity,0),1),e.fillStyle=t.highlight.color??"#ffff00",e.fillRect(v,I-r/2,d,r),e.restore());const H=es(a,r,S.length,p);e.font=`bold ${H}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle";const X=m(v+d/2),V=m(I);e.strokeStyle=`#212529${x}`,e.lineWidth=Math.max(1.2,2.5/p),e.lineJoin="round",e.strokeText(S,X,V),e.fillStyle=`#ffffff${x}`,e.fillText(S,X,V)}v+=d}}function ss(e,t,i,s){e&&(e.clearRect(0,0,e.canvas.width,e.canvas.height),nn(e,i,s,["B","A"])),t&&(t.clearRect(0,0,t.canvas.width,t.canvas.height),nn(t,i,s,["A","B"]))}var as=F('<canvas class="pitch-grid-legend pitch-grid-legend--left svelte-ui3s88"></canvas>'),os=F('<canvas class="pitch-grid-legend pitch-grid-legend--right svelte-ui3s88"></canvas>'),rs=F('<div class="pitch-grid-container svelte-ui3s88"><!> <canvas class="pitch-grid-canvas svelte-ui3s88"></canvas> <!></div>');function ls(e,t){Te(t,!0);let i=pe(t,"colorMode",3,"color"),s=pe(t,"degreeDisplayMode",3,"off"),o=pe(t,"accidentalMode",19,()=>({sharp:!0,flat:!0})),a=pe(t,"showFrequencyLabels",3,!1),r=pe(t,"showOctaveLabels",3,!0),c=pe(t,"showRightLegend",3,!0),l=pe(t,"placedNotes",19,()=>[]),u=pe(t,"placedTonicSigns",19,()=>[]),f=pe(t,"columnWidths",19,()=>[]),g=pe(t,"macrobeatGroupings",19,()=>[]),h=pe(t,"macrobeatBoundaryStyles",19,()=>[]),p=pe(t,"longNoteStyle",3,"style1"),m=pe(t,"beatIntervalMs",3,500),d=pe(t,"beatTimeOffsetMs",3,0),v=J(void 0),y=J(void 0),w=J(void 0),_=J(null),I=J(null),C=J(null),M=J(null);const S=3,D=N(()=>t.cellWidth*S),x=N(()=>n(D)*2),H=N(()=>r()||a()),X=N(()=>n(H)?n(x)*(c()?2:1):0),V=N(()=>Math.max(0,t.viewport.containerWidth-n(X))),ne=N(()=>t.mode==="notation"||t.mode==="playback"),$=N(()=>t.mode==="singing"),A=N(()=>t.mode==="highway");function W(){if(n(ne))return xi({cellWidth:t.cellWidth,cellHeight:t.cellHeight,columnWidths:f(),viewport:t.viewport,modulationMarkers:t.modulationMarkers});{const T=n(A)?t.highwayConfig:t.singingConfig;return Cn({cellWidth:t.cellWidth,cellHeight:t.cellHeight,viewport:t.viewport,pixelsPerSecond:T?.pixelsPerSecond??200,nowLineX:T?.nowLineX??100,currentTimeMs:T?.currentTimeMs??0})}}function U(){if(!n(_)||!n(v))return;const T=W(),{paddedStartRow:k,paddedEndRow:O}=Ni(t.viewport,t.fullRowData);n(_).clearRect(0,0,n(V),t.viewport.containerHeight);const ae={fullRowData:t.fullRowData,cellHeight:t.cellHeight,viewportHeight:t.viewport.containerHeight,viewportWidth:n(V),colorMode:i()};Li(n(_),ae,T,k,O),n(ne)?se(n(_),T):n($)?me(n(_),T):n(A)&&ye(n(_),T),n(H)&&(n(I)||n(C))&&Z(T,k,O)}function se(T,k){const O=L(g()),ae={columnWidths:f(),cellWidth:t.cellWidth,viewportHeight:t.viewport.containerHeight,macrobeatGroupings:g(),macrobeatBoundaryStyles:h(),placedTonicSigns:u()};ki(T,ae,k,O);const ge=l().filter(re=>re.isDrum||re.globalRow===void 0?!1:Mt(re.globalRow,t.viewport,t.cellHeight,k)),be=u().filter(re=>re.globalRow===void 0?!1:Mt(re.globalRow,t.viewport,t.cellHeight,k)),Ce={config:{cellWidth:t.cellWidth,cellHeight:t.cellHeight,columnWidths:f(),degreeDisplayMode:s(),accidentalMode:o(),longNoteStyle:p(),colorMode:i()},coords:k,allNotes:l()};for(const re of ge)re.shape==="oval"?Qt(T,Ce,re,re.globalRow):re.shape==="circle"&&$t(T,Ce,re,re.globalRow);for(const re of be)Zi(T,Ce,re)}function me(T,k){if(!t.singingConfig)return;const O={cellHeight:t.cellHeight,viewportWidth:n(V),pixelsPerSecond:t.singingConfig.pixelsPerSecond??200,timeWindowMs:t.singingConfig.timeWindowMs??4e3,colorMode:i(),trailConfig:t.singingConfig.trailConfig};t.singingConfig.pitchHistory&&t.singingConfig.pitchHistory.length>0&&Rn(T,k,t.singingConfig.pitchHistory,performance.now(),O,t.fullRowData),t.singingConfig.targetNotes&&t.singingConfig.targetNotes.length>0&&tn(T,k,t.singingConfig.targetNotes,performance.now(),O,t.fullRowData),t.singingConfig.userPitch&&t.singingConfig.userPitch.clarity>.5&&en(T,k,t.singingConfig.userPitch.midi,t.singingConfig.userPitch.clarity,n(V)-20,O,t.fullRowData)}function ye(T,k){if(!t.highwayConfig)return;const O={cellHeight:t.cellHeight,viewportWidth:t.viewport.containerWidth,nowLineX:t.highwayConfig.nowLineX,pixelsPerSecond:t.highwayConfig.pixelsPerSecond??200,timeWindowMs:t.highwayConfig.timeWindowMs??4e3,colorMode:i(),trailConfig:t.highwayConfig.trailConfig};if(t.highwayConfig.scrollingGridData&&t.highwayConfig.scrollOffset!==void 0)we(T,k);else{const ge={startMs:t.highwayConfig.currentTimeMs-1e3,endMs:t.highwayConfig.currentTimeMs+n(V)/(t.highwayConfig.pixelsPerSecond??200)*1e3},be={viewportWidth:n(V),viewportHeight:t.viewport.containerHeight,beatIntervalMs:m(),visibleTimeRange:ge,nowLineX:t.highwayConfig.nowLineX,beatTimeOffsetMs:d()};Fi(T,be,k),t.highwayConfig.targetNotes&&t.highwayConfig.targetNotes.length>0&&tn(T,k,t.highwayConfig.targetNotes,t.highwayConfig.currentTimeMs,O,t.fullRowData,t.highwayConfig.userPitch?.midi??null,t.highwayConfig.userPitch?.clarity??0)}Q(T,t.highwayConfig.nowLineX,t.viewport.containerHeight),t.highwayConfig.showOnrampCountdown&&t.highwayConfig.onrampBeatsRemaining!==void 0&&z(T,t.highwayConfig.onrampBeatsRemaining),t.highwayConfig.userPitch&&t.highwayConfig.userPitch.clarity>.5&&en(T,k,t.highwayConfig.userPitch.midi,t.highwayConfig.userPitch.clarity,t.highwayConfig.nowLineX,O,t.fullRowData)}function we(T,k){if(!t.highwayConfig?.scrollingGridData||t.highwayConfig.scrollOffset===void 0)return;const O=t.highwayConfig.scrollingGridData,ae=t.highwayConfig.scrollOffset,ge=L(O.macrobeatGroupings);for(let oe=0;oe<ge.length;oe++){const re=ge[oe]*t.cellWidth-ae;if(re>=-t.cellWidth&&re<=n(V)+t.cellWidth){const Ne=O.macrobeatBoundaryStyles[oe]||"solid",De=Ne==="solid"?2:1,ke=Ne==="dashed"?[5,5]:[];T.strokeStyle="#495057",T.lineWidth=De,T.setLineDash(ke),T.beginPath(),T.moveTo(re,0),T.lineTo(re,t.viewport.containerHeight),T.stroke(),T.setLineDash([])}}const be={cellWidth:t.cellWidth,cellHeight:t.cellHeight,columnWidths:O.columnWidths,degreeDisplayMode:s(),accidentalMode:o(),longNoteStyle:p(),colorMode:i()};for(const oe of O.placedNotes){if(oe.isDrum||oe.globalRow===void 0||!Mt(oe.globalRow,t.viewport,t.cellHeight,k))continue;const Ce=oe.startColumnIndex*t.cellWidth-ae;if(oe.endColumnIndex*t.cellWidth-ae>=-t.cellWidth&&Ce<=n(V)+t.cellWidth){const Ne={...k,getColumnX:ke=>ke*t.cellWidth-ae},De={config:be,coords:Ne,allNotes:O.placedNotes};oe.shape==="oval"?Qt(T,De,oe,oe.globalRow):oe.shape==="circle"&&$t(T,De,oe,oe.globalRow)}}}function Q(T,k,O){T.strokeStyle="rgba(255, 0, 0, 0.9)",T.lineWidth=3,T.beginPath(),T.moveTo(k,0),T.lineTo(k,O),T.stroke()}function z(T,k){T.fillStyle="rgba(0, 0, 0, 0.7)",T.fillRect(n(V)/2-40,10,80,50),T.fillStyle="#ffffff",T.font="bold 36px sans-serif",T.textAlign="center",T.textBaseline="middle",T.fillText(k.toString(),n(V)/2,35)}function Z(T,k,O){const ae={fullRowData:t.fullRowData,cellWidth:t.cellWidth,cellHeight:t.cellHeight,legendColumnWidth:n(D),colorMode:i(),showFrequencyLabels:a(),showOctaveLabels:r(),accidentalMode:o(),highlight:t.legendHighlight},ge={startRow:k,endRow:O,coords:T};ss(n(I),n(C),ae,ge)}function L(T){const k=[];let O=0;for(const ae of T)O+=ae,k.push(O);return k}function R(){if(n(M))return;function T(){U(),B(M,requestAnimationFrame(T),!0)}B(M,requestAnimationFrame(T),!0)}function j(){n(M)&&(cancelAnimationFrame(n(M)),B(M,null))}function ee(){if(!n(v)||(B(_,n(v).getContext("2d"),!0),!n(_)))return;const T=window.devicePixelRatio||1;n(v).width=n(V)*T,n(v).height=t.viewport.containerHeight*T,n(v).style.width=`${n(V)}px`,n(v).style.height=`${t.viewport.containerHeight}px`,n(_).scale(T,T),n(y)&&(B(I,n(y).getContext("2d"),!0),n(I)&&(n(y).width=n(x)*T,n(y).height=t.viewport.containerHeight*T,n(y).style.width=`${n(x)}px`,n(y).style.height=`${t.viewport.containerHeight}px`,n(I).scale(T,T))),n(w)&&(B(C,n(w).getContext("2d"),!0),n(C)&&(n(w).width=n(x)*T,n(w).height=t.viewport.containerHeight*T,n(w).style.width=`${n(x)}px`,n(w).style.height=`${t.viewport.containerHeight}px`,n(C).scale(T,T))),U(),(n($)||n(A))&&R()}_n(()=>{ee()}),ze(()=>{j()}),Re(()=>{t.mode,t.viewport,t.cellWidth,t.cellHeight,i(),s(),l(),u(),f(),n(_)&&n(ne)&&U()}),Re(()=>{t.mode,n($)||n(A)?R():(j(),n(_)&&U())}),Re(()=>{t.viewport.containerWidth,t.viewport.containerHeight,n(_)&&n(v)&&ee()});var ce=rs(),ve=b(ce);{var he=T=>{var k=as();He(k,O=>B(y,O),()=>n(y)),E(T,k)};le(ve,T=>{n(H)&&T(he)})}var ue=P(ve,2);He(ue,T=>B(v,T),()=>n(v));var q=P(ue,2);{var ie=T=>{var k=os();He(k,O=>B(w,O),()=>n(w)),E(T,k)};le(q,T=>{n(H)&&c()&&T(ie)})}E(e,ce),Pe()}const sn={isDetecting:!1,visualizationMode:"highway",tonic:"C",useDegrees:!1,showAccidentals:!0,pitchHighlightEnabled:!0,yAxisRange:{minMidi:48,maxMidi:72},drone:{isPlaying:!1,octave:3,volume:-12}};function cs(){let e=J(Ee({...sn}));return{get state(){return n(e)},toggleDetecting(){n(e).isDetecting=!n(e).isDetecting},setDetecting(t){n(e).isDetecting=t},setVisualizationMode(t){n(e).visualizationMode=t},setTonic(t){n(e).tonic=t},setUseDegrees(t){n(e).useDegrees=t},setShowAccidentals(t){n(e).showAccidentals=t},togglePitchHighlight(){n(e).pitchHighlightEnabled=!n(e).pitchHighlightEnabled},setPitchHighlightEnabled(t){n(e).pitchHighlightEnabled=t},setYAxisRange(t){n(e).yAxisRange=t},expandYAxisUpper(){n(e).yAxisRange.maxMidi<108&&(n(e).yAxisRange={...n(e).yAxisRange,maxMidi:n(e).yAxisRange.maxMidi+1})},contractYAxisUpper(){n(e).yAxisRange.maxMidi>n(e).yAxisRange.minMidi+6&&(n(e).yAxisRange={...n(e).yAxisRange,maxMidi:n(e).yAxisRange.maxMidi-1})},expandYAxisLower(){n(e).yAxisRange.minMidi>21&&(n(e).yAxisRange={...n(e).yAxisRange,minMidi:n(e).yAxisRange.minMidi-1})},contractYAxisLower(){n(e).yAxisRange.minMidi<n(e).yAxisRange.maxMidi-6&&(n(e).yAxisRange={...n(e).yAxisRange,minMidi:n(e).yAxisRange.minMidi+1})},toggleDrone(){n(e).drone={...n(e).drone,isPlaying:!n(e).drone.isPlaying}},setDroneOctave(t){n(e).drone={...n(e).drone,octave:t}},setDroneVolume(t){n(e).drone={...n(e).drone,volume:t}},reset(){B(e,{...sn},!0)}}}const K=cs(),us=200,an={currentPitch:null,history:[],stablePitch:{pitchClass:null,opacity:0,size:1}};function ds(){let e=J(Ee({...an}));return{get state(){return n(e)},setCurrentPitch(t){n(e).currentPitch=t},addHistoryPoint(t){n(e).history.push(t),n(e).history.length>us&&n(e).history.shift()},setStablePitch(t){n(e).stablePitch=t},clearHistory(){n(e).history=[]},reset(){B(e,{...an},!0)}}}const de=ds(),on={isPlaying:!1,startTime:null,currentTimeMs:0,targetNotes:[],nowLineX:100,pixelsPerSecond:200,timeWindowMs:4e3};function fs(){let e=J(Ee({...on})),t=null,i=null,s=null;function o(l){return l.map((u,f)=>({id:`target-${f}`,midi:u.midi,startTimeMs:u.startTimeMs,durationMs:u.durationMs,startColumn:0,endColumn:0,color:"#3b82f6",shape:"oval",globalRow:0}))}function a(){if(!t)return;const l=t.getState();n(e).isPlaying=l.isPlaying&&!l.isPaused,n(e).currentTimeMs=l.currentTimeMs;const u=t.getPerformanceResults();n(e).targetNotes=n(e).targetNotes.map((f,g)=>{const h=`target-${g}`,p=u.get(h);return{...f,hit:p?.hitStatus==="hit"}})}function r(){n(e).isPlaying&&t?(a(),i=requestAnimationFrame(r)):i=null}function c(){t&&t.dispose(),t=Ii({judgmentLinePosition:n(e).nowLineX/800,pixelsPerSecond:n(e).pixelsPerSecond,lookAheadMs:n(e).timeWindowMs,scrollMode:"constant-speed",leadInBeats:0,playMetronomeDuringOnramp:!1,playTargetNotes:!1,playMetronome:!1,inputSources:["microphone"],feedbackConfig:{onsetToleranceMs:100,releaseToleranceMs:150,pitchToleranceCents:50,hitThreshold:70},stateCallbacks:{getTempo:()=>120,getCellWidth:()=>20,getViewportWidth:()=>800},eventCallbacks:{emit:(u,f)=>{if(console.debug("[Highway]",u,f),u==="noteHit"){const g=f;console.log(`[Highway] Note HIT: ${g.noteId}, accuracy: ${g.performance.accuracyTier||"unknown"}`)}else u==="noteMissed"?console.log(`[Highway] Note MISSED: ${f.noteId}`):u==="onrampComplete"?console.log("[Highway] Onramp complete, playback starting!"):u==="performanceComplete"&&(console.log("[Highway] Performance complete!"),s&&t&&s(t.getPerformanceResults()))}}});const l=o(n(e).targetNotes);t.init(l)}return{get state(){return n(e)},get engineService(){return t},start(){!t&&n(e).targetNotes.length>0&&c(),t&&(t.start(),n(e).isPlaying=!0,n(e).startTime=performance.now(),n(e).currentTimeMs=0,r())},stop(){t&&t.stop(),n(e).isPlaying=!1,i!==null&&(cancelAnimationFrame(i),i=null)},pause(){t&&t.pause(),n(e).isPlaying=!1,i!==null&&(cancelAnimationFrame(i),i=null)},resume(){t&&(t.resume(),n(e).isPlaying=!0,r())},setTargetNotes(l){if(n(e).targetNotes=l,t){const u=o(l);t.init(u)}},markNoteHit(l){l>=0&&l<n(e).targetNotes.length&&(n(e).targetNotes=n(e).targetNotes.map((u,f)=>f===l?{...u,hit:!0}:u))},setNowLineX(l){n(e).nowLineX=l},setPixelsPerSecond(l){n(e).pixelsPerSecond=l},setTimeWindowMs(l){n(e).timeWindowMs=l},recordPitchInput(l,u){t&&n(e).isPlaying&&t.recordPitchInput(l,u,"microphone")},getPerformanceResults(){return t?.getPerformanceResults()??new Map},setCurrentTime(l){n(e).currentTimeMs=l,t&&t.setScrollOffset(l)},onPerformanceComplete(l){return s=l,()=>{s=null}},reset(){i!==null&&(cancelAnimationFrame(i),i=null),t&&(t.dispose(),t=null),B(e,{...on},!0)}}}const fe=fs(),hs={numLoops:5,minMidi:48,maxMidi:72,tempo:108,referenceVolume:-12},rn={isActive:!1,isPlaying:!1,config:{...hs},currentLoop:0,currentPhase:"reference",currentPitch:null,generatedNotes:[],results:[]};function vs(e,t){return Math.floor(Math.random()*(t-e+1))+e}function ln(e){return 60/e*1e3/2}function gs(){let e=J(Ee({...rn}));function t(s){const o=[],a=ln(s.tempo),r=2e3;for(let c=0;c<s.numLoops;c++){const l=vs(s.minMidi,s.maxMidi),u=r+c*32*a;o.push({midi:l,startTimeMs:u,durationMs:8*a,lyric:"ðŸ‘‚"}),o.push({midi:l,startTimeMs:u+16*a,durationMs:8*a,lyric:"ðŸŽ¤"})}return o}function i(s,o){const a=ln(o),r=32*a,l=s-2e3;if(l<0)return{loop:0,phase:"rest2"};const u=Math.floor(l/r),f=l%r,g=Math.floor(f/a);let h;return g<8?h="reference":g<16?h="rest1":g<24?h="input":h="rest2",{loop:u,phase:h}}return{get state(){return n(e)},configure(s){n(e).config={...n(e).config,...s}},setPitchRange(s,o){n(e).config.minMidi=s,n(e).config.maxMidi=o},start(){const s=t(n(e).config);n(e).generatedNotes=s,n(e).isActive=!0,n(e).isPlaying=!1,n(e).currentLoop=0,n(e).currentPhase="reference",n(e).currentPitch=s.length>0?s[0].midi:null,n(e).results=[]},stop(){n(e).isActive=!1,n(e).isPlaying=!1,n(e).currentLoop=0,n(e).currentPhase="reference",n(e).currentPitch=null},setPlaying(s){n(e).isPlaying=s},updatePhase(s){const{loop:o,phase:a}=i(s,n(e).config.tempo);n(e).currentLoop=o,n(e).currentPhase=a;const r=o*2;r<n(e).generatedNotes.length&&(n(e).currentPitch=n(e).generatedNotes[r].midi)},addResult(s){n(e).results.push(s)},hasResultForLoop(s){return n(e).results.some(o=>o.loopIndex===s)},getResults(){return n(e).results},getCurrentProgress(){return{current:n(e).currentLoop+1,total:n(e).config.numLoops}},getGeneratedNotes(){return n(e).generatedNotes},getAverageAccuracy(){return n(e).results.length===0?0:n(e).results.reduce((o,a)=>o+a.accuracy,0)/n(e).results.length},getHitCount(){return n(e).results.filter(s=>s.performance?.hitStatus==="hit").length},reset(){B(e,{...rn,config:{...n(e).config}},!0)}}}const _e=gs();var ms=F('<div class="singing-canvas-container svelte-1lr8v2d"><!> <canvas class="pitch-trail-canvas svelte-1lr8v2d"></canvas></div>');function ps(e,t){Te(t,!0);let i=J(void 0),s=J(800),o=J(400),a=J(void 0),r=J(null),c=J(null),l=0,u=0,f=0;const g=20,h=!0,p=!1,m=N(()=>n(s)>=720),d=3,v=N(()=>g*d),y=N(()=>n(v)*2),w=N(()=>h),_=N(()=>n(w)?n(y)*(n(m)?2:1):0),I=N(()=>Math.max(0,n(s)-n(_))),C=N(()=>n(w)?n(y):0),M=()=>{try{return!!globalThis.__ST_DEBUG_TRAIL}catch{return!1}},S=N(()=>hi(K.state.yAxisRange.minMidi,K.state.yAxisRange.maxMidi)),D=N(()=>vi({containerHeight:n(o),fullRowData:n(S),preferredCellHeight:40,minCellHeight:20})),x=N(()=>K.state.visualizationMode==="highway"?"highway":"singing"),H=N(()=>60/_e.state.config.tempo*1e3),X=2e3,V=N(()=>(()=>{if(!K.state.pitchHighlightEnabled)return;const L=de.state.stablePitch;if(!(L.pitchClass===null||L.opacity<=.01))return{pitchClass:L.pitchClass,opacity:L.opacity,color:"#ffff00"}})());function ne(){return fe.state.targetNotes.map((L,R)=>({id:`target-${R}`,midi:L.midi,startTimeMs:L.startTimeMs,durationMs:L.durationMs,label:L.lyric}))}const $=N(()=>({timeWindowMs:4e3,pixelsPerSecond:200,circleRadius:9.5,proximityThreshold:35,maxConnections:3,connectorLineWidth:2.5,connectorColor:"rgba(0,0,0,0.4)",useTonicRelativeColors:!0,tonicPitchClass:Si(K.state.tonic),clarityThreshold:.5,maxOpacity:.9})),A=N(()=>n(x)==="singing"?{userPitch:de.state.currentPitch?{frequency:de.state.currentPitch.frequency,midi:de.state.currentPitch.midi,clarity:de.state.currentPitch.clarity,pitchClass:de.state.currentPitch.pitchClass}:null,pitchHistory:[],targetNotes:[],pixelsPerSecond:200,timeWindowMs:4e3,trailConfig:n($)}:void 0),W=N(()=>n(x)==="highway"?{userPitch:de.state.currentPitch?{frequency:de.state.currentPitch.frequency,midi:de.state.currentPitch.midi,clarity:de.state.currentPitch.clarity,pitchClass:de.state.currentPitch.pitchClass}:null,pitchHistory:[],targetNotes:ne(),nowLineX:fe.state.nowLineX,pixelsPerSecond:fe.state.pixelsPerSecond,currentTimeMs:fe.state.currentTimeMs,timeWindowMs:fe.state.timeWindowMs,trailConfig:n($)}:void 0),U=N(()=>({startRow:n(D).startRow,endRow:n(D).endRow,zoomLevel:1,containerWidth:n(s),containerHeight:n(o)}));function se(){if(!n(a))return;const L=window.devicePixelRatio||1;n(a).width=n(I)*L,n(a).height=n(o)*L,n(a).style.width=`${n(I)}px`,n(a).style.height=`${n(o)}px`,n(a).style.left=`${n(C)}px`;const R=n(a).getContext("2d");if(!R){B(r,null);return}R.setTransform(L,0,0,L,0,0),B(r,R,!0)}function me(){if(!n(r)||n(I)<=0)return;n(r).clearRect(0,0,n(I),n(o));const L=de.state.history;if(L.length===0)return;const R=n(x)==="singing"?n(A):n(W);if(!R)return;const j=M(),ee=j?performance.now():0,ce=n(x)==="highway"&&n(W)?n(W).nowLineX:100,ve=Cn({cellHeight:n(D).cellHeight,viewport:n(U),pixelsPerSecond:R.pixelsPerSecond??200,nowLineX:ce,currentTimeMs:n(x)==="highway"&&n(W)?n(W).currentTimeMs:0}),he={cellHeight:n(D).cellHeight,viewportWidth:n(I),nowLineX:ce,pixelsPerSecond:R.pixelsPerSecond??200,timeWindowMs:R.timeWindowMs??4e3,colorMode:"color",trailConfig:n($)},ue=performance.now();if(Rn(n(r),ve,L,ue,he,n(S)),j){const q=performance.now();if(u+=1,f+=q-ee,q-l>=1e3){const ie=u>0?f/u:0;console.log(`[SingingTrail] points=${L.length} avgMs=${ie.toFixed(2)} gridWidth=${n(I)}`),l=q,u=0,f=0}}}function ye(){if(n(c))return;const L=()=>{me(),B(c,requestAnimationFrame(L),!0)};B(c,requestAnimationFrame(L),!0)}function we(){n(c)&&(cancelAnimationFrame(n(c)),B(c,null)),n(r)&&n(I)>0&&n(r).clearRect(0,0,n(I),n(o))}Re(()=>{if(!n(i))return;const L=new ResizeObserver(R=>{for(const j of R)B(s,j.contentRect.width,!0),B(o,j.contentRect.height,!0)});return L.observe(n(i)),()=>{L.disconnect()}}),Re(()=>{n(I),n(o),n(C),n(a),se()}),Re(()=>{n(x),n(r),n(x)==="singing"||n(x)==="highway"?ye():we()}),ze(()=>{we()});var Q=ms(),z=b(Q);ls(z,{get mode(){return n(x)},get fullRowData(){return n(S)},get viewport(){return n(U)},cellWidth:g,get cellHeight(){return n(D).cellHeight},colorMode:"color",showOctaveLabels:h,showFrequencyLabels:p,get showRightLegend(){return n(m)},get singingConfig(){return n(A)},get highwayConfig(){return n(W)},get legendHighlight(){return n(V)},get beatIntervalMs(){return n(H)},beatTimeOffsetMs:X});var Z=P(z,2);He(Z,L=>B(a,L),()=>n(a)),He(Q,L=>B(i,L),()=>n(i)),E(e,Q),Pe()}function ys(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Tt,cn;function bs(){if(cn)return Tt;cn=1;function e(t){if(this.size=t|0,this.size<=1||(this.size&this.size-1)!==0)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=t<<1;for(var i=new Array(this.size*2),s=0;s<i.length;s+=2){const u=Math.PI*s/this.size;i[s]=Math.cos(u),i[s+1]=-Math.sin(u)}this.table=i;for(var o=0,a=1;this.size>a;a<<=1)o++;this._width=o%2===0?o-1:o,this._bitrev=new Array(1<<this._width);for(var r=0;r<this._bitrev.length;r++){this._bitrev[r]=0;for(var c=0;c<this._width;c+=2){var l=this._width-c-2;this._bitrev[r]|=(r>>>c&3)<<l}}this._out=null,this._data=null,this._inv=0}return Tt=e,e.prototype.fromComplexArray=function(i,s){for(var o=s||new Array(i.length>>>1),a=0;a<i.length;a+=2)o[a>>>1]=i[a];return o},e.prototype.createComplexArray=function(){const i=new Array(this._csize);for(var s=0;s<i.length;s++)i[s]=0;return i},e.prototype.toComplexArray=function(i,s){for(var o=s||this.createComplexArray(),a=0;a<o.length;a+=2)o[a]=i[a>>>1],o[a+1]=0;return o},e.prototype.completeSpectrum=function(i){for(var s=this._csize,o=s>>>1,a=2;a<o;a+=2)i[s-a]=i[a],i[s-a+1]=-i[a+1]},e.prototype.transform=function(i,s){if(i===s)throw new Error("Input and output buffers must be different");this._out=i,this._data=s,this._inv=0,this._transform4(),this._out=null,this._data=null},e.prototype.realTransform=function(i,s){if(i===s)throw new Error("Input and output buffers must be different");this._out=i,this._data=s,this._inv=0,this._realTransform4(),this._out=null,this._data=null},e.prototype.inverseTransform=function(i,s){if(i===s)throw new Error("Input and output buffers must be different");this._out=i,this._data=s,this._inv=1,this._transform4();for(var o=0;o<i.length;o++)i[o]/=this.size;this._out=null,this._data=null},e.prototype._transform4=function(){var i=this._out,s=this._csize,o=this._width,a=1<<o,r=s/a<<1,c,l,u=this._bitrev;if(r===4)for(c=0,l=0;c<s;c+=r,l++){const v=u[l];this._singleTransform2(c,v,a)}else for(c=0,l=0;c<s;c+=r,l++){const v=u[l];this._singleTransform4(c,v,a)}var f=this._inv?-1:1,g=this.table;for(a>>=2;a>=2;a>>=2){r=s/a<<1;var h=r>>>2;for(c=0;c<s;c+=r)for(var p=c+h,m=c,d=0;m<p;m+=2,d+=a){const v=m,y=v+h,w=y+h,_=w+h,I=i[v],C=i[v+1],M=i[y],S=i[y+1],D=i[w],x=i[w+1],H=i[_],X=i[_+1],V=I,ne=C,$=g[d],A=f*g[d+1],W=M*$-S*A,U=M*A+S*$,se=g[2*d],me=f*g[2*d+1],ye=D*se-x*me,we=D*me+x*se,Q=g[3*d],z=f*g[3*d+1],Z=H*Q-X*z,L=H*z+X*Q,R=V+ye,j=ne+we,ee=V-ye,ce=ne-we,ve=W+Z,he=U+L,ue=f*(W-Z),q=f*(U-L),ie=R+ve,T=j+he,k=R-ve,O=j-he,ae=ee+q,ge=ce-ue,be=ee-q,oe=ce+ue;i[v]=ie,i[v+1]=T,i[y]=ae,i[y+1]=ge,i[w]=k,i[w+1]=O,i[_]=be,i[_+1]=oe}}},e.prototype._singleTransform2=function(i,s,o){const a=this._out,r=this._data,c=r[s],l=r[s+1],u=r[s+o],f=r[s+o+1],g=c+u,h=l+f,p=c-u,m=l-f;a[i]=g,a[i+1]=h,a[i+2]=p,a[i+3]=m},e.prototype._singleTransform4=function(i,s,o){const a=this._out,r=this._data,c=this._inv?-1:1,l=o*2,u=o*3,f=r[s],g=r[s+1],h=r[s+o],p=r[s+o+1],m=r[s+l],d=r[s+l+1],v=r[s+u],y=r[s+u+1],w=f+m,_=g+d,I=f-m,C=g-d,M=h+v,S=p+y,D=c*(h-v),x=c*(p-y),H=w+M,X=_+S,V=I+x,ne=C-D,$=w-M,A=_-S,W=I-x,U=C+D;a[i]=H,a[i+1]=X,a[i+2]=V,a[i+3]=ne,a[i+4]=$,a[i+5]=A,a[i+6]=W,a[i+7]=U},e.prototype._realTransform4=function(){var i=this._out,s=this._csize,o=this._width,a=1<<o,r=s/a<<1,c,l,u=this._bitrev;if(r===4)for(c=0,l=0;c<s;c+=r,l++){const mt=u[l];this._singleRealTransform2(c,mt>>>1,a>>>1)}else for(c=0,l=0;c<s;c+=r,l++){const mt=u[l];this._singleRealTransform4(c,mt>>>1,a>>>1)}var f=this._inv?-1:1,g=this.table;for(a>>=2;a>=2;a>>=2){r=s/a<<1;var h=r>>>1,p=h>>>1,m=p>>>1;for(c=0;c<s;c+=r)for(var d=0,v=0;d<=m;d+=2,v+=a){var y=c+d,w=y+p,_=w+p,I=_+p,C=i[y],M=i[y+1],S=i[w],D=i[w+1],x=i[_],H=i[_+1],X=i[I],V=i[I+1],ne=C,$=M,A=g[v],W=f*g[v+1],U=S*A-D*W,se=S*W+D*A,me=g[2*v],ye=f*g[2*v+1],we=x*me-H*ye,Q=x*ye+H*me,z=g[3*v],Z=f*g[3*v+1],L=X*z-V*Z,R=X*Z+V*z,j=ne+we,ee=$+Q,ce=ne-we,ve=$-Q,he=U+L,ue=se+R,q=f*(U-L),ie=f*(se-R),T=j+he,k=ee+ue,O=ce+ie,ae=ve-q;if(i[y]=T,i[y+1]=k,i[w]=O,i[w+1]=ae,d===0){var ge=j-he,be=ee-ue;i[_]=ge,i[_+1]=be;continue}if(d!==m){var oe=ce,Ce=-ve,re=j,Ne=-ee,De=-f*ie,ke=-f*q,ft=-f*ue,ht=-f*he,vt=oe+De,gt=Ce+ke,Ln=re+ht,kn=Ne-ft,Wt=c+p-d,Bt=c+h-d;i[Wt]=vt,i[Wt+1]=gt,i[Bt]=Ln,i[Bt+1]=kn}}}},e.prototype._singleRealTransform2=function(i,s,o){const a=this._out,r=this._data,c=r[s],l=r[s+o],u=c+l,f=c-l;a[i]=u,a[i+1]=0,a[i+2]=f,a[i+3]=0},e.prototype._singleRealTransform4=function(i,s,o){const a=this._out,r=this._data,c=this._inv?-1:1,l=o*2,u=o*3,f=r[s],g=r[s+o],h=r[s+l],p=r[s+u],m=f+h,d=f-h,v=g+p,y=c*(g-p),w=m+v,_=d,I=-y,C=m-v,M=d,S=y;a[i]=w,a[i+1]=0,a[i+2]=_,a[i+3]=I,a[i+4]=C,a[i+5]=0,a[i+6]=M,a[i+7]=S},Tt}var _s=bs();const ws=ys(_s);class Ke{_inputLength;_fft;_bufferSupplier;_paddedInputBuffer;_transformBuffer;_inverseBuffer;static forFloat32Array(t){return new Ke(t,i=>new Float32Array(i))}static forFloat64Array(t){return new Ke(t,i=>new Float64Array(i))}static forNumberArray(t){return new Ke(t,i=>Array(i))}constructor(t,i){if(t<1)throw new Error("Input length must be at least one");this._inputLength=t,this._fft=new ws(Ps(2*t)),this._bufferSupplier=i,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}get inputLength(){return this._inputLength}autocorrelate(t,i=this._bufferSupplier(t.length)){if(t.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${t.length}`);for(let o=0;o<t.length;o++)this._paddedInputBuffer[o]=t[o];for(let o=t.length;o<this._paddedInputBuffer.length;o++)this._paddedInputBuffer[o]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const s=this._transformBuffer;for(let o=0;o<s.length;o+=2)s[o]=s[o]*s[o]+s[o+1]*s[o+1],s[o+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let o=0;o<t.length;o++)i[o]=this._inverseBuffer[2*o];return i}}function Ms(e){const t=[];let i=!1,s=-1/0,o=-1;for(let a=1;a<e.length-1;a++)e[a-1]<=0&&e[a]>0?(i=!0,o=a,s=e[a]):e[a-1]>0&&e[a]<=0?(i=!1,o!==-1&&t.push(o)):i&&e[a]>s&&(s=e[a],o=a);return t}function Ts(e,t){const[i,s,o]=[e-1,e,e+1],[a,r,c]=[t[i],t[s],t[o]],l=a/2-r+c/2,u=-(a/2)*(s+o)+r*(i+o)-c/2*(i+s),f=a*s*o/2-r*i*o+c*i*s/2,g=-u/(2*l),h=l*g*g+u*g+f;return[g,h]}class Ze{_autocorrelator;_nsdfBuffer;_clarityThreshold=.9;_minVolumeAbsolute=0;_maxInputAmplitude=1;static forFloat32Array(t){return new Ze(t,i=>new Float32Array(i))}static forFloat64Array(t){return new Ze(t,i=>new Float64Array(i))}static forNumberArray(t){return new Ze(t,i=>Array(i))}constructor(t,i){this._autocorrelator=new Ke(t,i),this._nsdfBuffer=i(t)}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(t){if(!Number.isFinite(t)||t<=0||t>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=t}set minVolumeAbsolute(t){if(!Number.isFinite(t)||t<0||t>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=t}set minVolumeDecibels(t){if(!Number.isFinite(t)||t>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(t/10)}set maxInputAmplitude(t){if(!Number.isFinite(t)||t<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=t}findPitch(t,i){if(this._belowMinimumVolume(t))return[0,0];this._nsdf(t);const s=Ms(this._nsdfBuffer);if(s.length===0)return[0,0];const o=Math.max(...s.map(l=>this._nsdfBuffer[l])),a=s.find(l=>this._nsdfBuffer[l]>=this._clarityThreshold*o),[r,c]=Ts(a,this._nsdfBuffer);return[i/r,Math.min(c,1)]}_belowMinimumVolume(t){if(this._minVolumeAbsolute===0)return!1;let i=0;for(let s=0;s<t.length;s++)i+=t[s]**2;return Math.sqrt(i/t.length)<this._minVolumeAbsolute}_nsdf(t){this._autocorrelator.autocorrelate(t,this._nsdfBuffer);let i=2*this._nsdfBuffer[0],s;for(s=0;s<this._nsdfBuffer.length&&i>0;s++)this._nsdfBuffer[s]=2*this._nsdfBuffer[s]/i,i-=t[s]**2+t[t.length-s-1]**2;for(;s<this._nsdfBuffer.length;s++)this._nsdfBuffer[s]=0}}function Ps(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e++,e}const Cs=100,Pt=12;function Ss(e){const t=Math.round(e);return(e-t)*Cs}function As(e){return Math.round(e)}function Is(e){return(Math.round(e)%Pt+Pt)%Pt}class xs{synth=null;scheduledTimeouts=[];volume=null;startTime=0;_isPlaying=!1;get isPlaying(){return this._isPlaying}async init(){await Et(),this.volume=new bn(-12).toDestination(),this.synth=new wn({oscillator:{type:"triangle"},envelope:{attack:.05,decay:.1,sustain:.9,release:.1}}).connect(this.volume)}setVolume(t){this.volume&&(this.volume.volume.value=t)}scheduleReferenceTones(t){if(!this.synth){console.warn("[ReferenceAudio] Synth not initialized");return}this.clearScheduled(),this.startTime=performance.now(),t.forEach(i=>{const s=i.durationMs/1e3,o=Gt(i.midi,"midi").toFrequency(),a=window.setTimeout(()=>{this.synth&&(console.log(`[ReferenceAudio] Playing ${i.midi} at ${performance.now()-this.startTime}ms`),this._isPlaying=!0,this.synth.triggerAttackRelease(o,s))},i.startTimeMs),r=window.setTimeout(()=>{this._isPlaying=!1},i.startTimeMs+i.durationMs);this.scheduledTimeouts.push(a,r)}),console.log(`[ReferenceAudio] Scheduled ${t.length} reference tones`)}playTone(t,i){if(!this.synth){console.warn("[ReferenceAudio] Synth not initialized");return}const s=Gt(t,"midi").toFrequency(),o=i/1e3;this.synth.triggerAttackRelease(s,o)}clearScheduled(){this.scheduledTimeouts.forEach(t=>{window.clearTimeout(t)}),this.scheduledTimeouts=[]}stop(){this.clearScheduled(),this.synth&&this.synth.triggerRelease()}dispose(){this.stop(),this.synth&&(this.synth.dispose(),this.synth=null),this.volume&&(this.volume.dispose(),this.volume=null)}}const Ge=new xs,Oe={FFT_SIZE:2048,CLARITY_THRESHOLD:.8,MIN_PITCH_HZ:60,MAX_PITCH_HZ:1600,HIGHLIGHT_CENTS_RANGE:50};let We=null,Be=null,lt=null,Le=null,ct=!1;const xt=1;function Rs(e){return 12*Math.log2(e/440)+69}function Rt(){if(!ct||!Be||!lt){Le=null;return}if(Ge.isPlaying){de.addHistoryPoint({frequency:0,midi:0,time:performance.now(),clarity:0}),Le=requestAnimationFrame(Rt);return}const e=Be.getValue(),[t,i]=lt.findPitch(e,mi().sampleRate),s=t!==null&&i>Oe.CLARITY_THRESHOLD&&t>Oe.MIN_PITCH_HZ&&t<Oe.MAX_PITCH_HZ;if(s){const o=Rs(t),a={frequency:t,midi:o,clarity:i,pitchClass:Math.round(o)%12};de.setCurrentPitch(a),de.addHistoryPoint({frequency:t,midi:o,time:performance.now(),clarity:i}),fe.recordPitchInput(o,i)}else de.addHistoryPoint({frequency:0,midi:0,time:performance.now(),clarity:0});if(s&&de.state.currentPitch){const o=de.state.currentPitch.midi,a=As(o),r=Ss(o),c=Math.min(Math.abs(r),Oe.HIGHLIGHT_CENTS_RANGE),l=Math.max(0,1-c/Oe.HIGHLIGHT_CENTS_RANGE);de.setStablePitch({pitchClass:Is(a),opacity:l,size:xt})}else de.setStablePitch({pitchClass:null,opacity:0,size:xt});Le=requestAnimationFrame(Rt)}async function Ns(){if(!ct){Le!==null&&cancelAnimationFrame(Le),We=new je,Be=new gi("waveform",Oe.FFT_SIZE),lt=Ze.forFloat32Array(Be.size);try{await Et(),await We.open(),We.connect(Be),ct=!0,Rt()}catch(e){throw console.error("Microphone access denied or failed:",e),Dn(),e}}}function Ds(){ct=!1,Dn()}function Dn(){Le!==null&&(cancelAnimationFrame(Le),Le=null),We&&(We.close(),We=null),Be=null,lt=null,de.setStablePitch({pitchClass:null,opacity:0,size:xt}),de.setCurrentPitch(null)}Se(["click"]);let xe=null,Qe=!1,$e=null;function Hs(){if(!xe){xe=new pi(wn,{oscillator:{type:"sawtooth"},envelope:{attack:.3,decay:.1,sustain:.8,release:.5}}).toDestination();const e=xe.get().oscillator?.type??"unknown";console.log("[DroneAudio] Initialized drone synth",{oscillatorType:e})}return xe}function Hn(e,t){return`${e.replace("b","#").replace("Db","C#").replace("Eb","D#").replace("Gb","F#").replace("Ab","G#").replace("Bb","A#")}${t}`}async function Es(){await Et();const e=Hs(),t=Hn(K.state.tonic,K.state.drone.octave);e.volume.value=K.state.drone.volume,console.log("[DroneAudio] Starting drone",{note:t,volume:e.volume.value}),$e&&e.releaseAll(),$e=t,e.triggerAttack(t),Qe=!0}function Ls(){xe&&Qe&&(xe.releaseAll(),$e=null,Qe=!1)}function Nt(){if(!Qe||!xe)return;const e=Hn(K.state.tonic,K.state.drone.octave);xe.volume.value=K.state.drone.volume,console.log("[DroneAudio] Updating drone",{note:e,volume:xe.volume.value}),e!==$e&&(xe.releaseAll(),xe.triggerAttack(e),$e=e)}async function ks(){Qe?Ls():await Es()}var Fs=F("<option> </option>"),Os=F('<div class="tonic-selector svelte-1kv0v4r"><label for="tonic-select" class="svelte-1kv0v4r">Key:</label> <select id="tonic-select" class="svelte-1kv0v4r"></select></div>');function Ws(e,t){Te(t,!1);const i=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function s(c){const l=c.target;K.setTonic(l.value),Nt()}Lt();var o=Os(),a=P(b(o),2);a.__change=s,tt(a,5,()=>i,dt,(c,l)=>{var u=Fs(),f=b(u),g={};te(()=>{G(f,n(l)),g!==(g=n(l))&&(u.value=(u.__value=n(l))??"")}),E(c,u)});var r;Mn(a),te(()=>{r!==(r=K.state.tonic)&&(a.value=(a.__value=K.state.tonic)??"",kt(a,K.state.tonic))}),E(e,o),Pe()}Se(["change"]);var Bs=F("<option> </option>"),zs=F('<div class="drone-controls svelte-z8euf7"><button> </button> <div class="drone-settings svelte-z8euf7"><label class="svelte-z8euf7">Oct: <select class="svelte-z8euf7"></select></label> <label class="svelte-z8euf7">Vol: <input type="range" min="-40" max="0" class="svelte-z8euf7"/></label></div></div>');function qs(e,t){Te(t,!1);const i=[2,3,4,5];async function s(){await ks(),K.toggleDrone()}function o(v){const y=v.target;K.setDroneOctave(parseInt(y.value,10)),Nt()}function a(v){const y=v.target;K.setDroneVolume(parseInt(y.value,10)),Nt()}Lt();var r=zs(),c=b(r);let l;c.__click=s;var u=b(c),f=P(c,2),g=b(f),h=P(b(g));h.__change=o,tt(h,5,()=>i,dt,(v,y)=>{var w=Bs(),_=b(w),I={};te(()=>{G(_,n(y)),I!==(I=n(y))&&(w.value=(w.__value=n(y))??"")}),E(v,w)});var p;Mn(h);var m=P(g,2),d=P(b(m));d.__input=a,te(()=>{l=et(c,1,"drone-toggle svelte-z8euf7",null,l,{active:K.state.drone.isPlaying}),G(u,K.state.drone.isPlaying?"Drone On":"Drone Off"),p!==(p=K.state.drone.octave)&&(h.value=(h.__value=K.state.drone.octave)??"",kt(h,K.state.drone.octave)),ai(d,K.state.drone.volume)}),E(e,r),Pe()}Se(["click","change","input"]);Se(["click"]);var Ys=F('<div class="pitch-wheel-option svelte-53gwvz"> </div>'),Gs=F('<div class="pitch-wheel svelte-53gwvz" role="slider" tabindex="0" aria-valuemin="0"><div class="pitch-wheel-viewport svelte-53gwvz"><div class="pitch-wheel-options svelte-53gwvz"></div></div> <div class="pitch-wheel-overlay svelte-53gwvz"></div></div>');function un(e,t){Te(t,!0);let i=pe(t,"selectedIndex",15),s=pe(t,"ariaLabel",3,"Pitch selector");const o=40,a=o;let r=J(void 0),c=J(void 0),l=J(void 0),u=J(!1),f=J(null),g=J(0),h=J(0),p=J(o);const m=N(()=>t.options.map((A,W)=>Math.min(Math.abs(W-i()),3))),d=N(()=>n(c)?.clientHeight??0),v=N(()=>Math.max(0,(n(d)-n(p))/2)),y=N(()=>n(v)+i()*n(p)+n(p)/2),w=N(()=>n(d)>0?n(d)/2-n(y):0);function _(A){if(!t.options||t.options.length===0)return;let W=A;typeof t.onbeforechange=="function"&&(W=t.onbeforechange(A));const U=Math.max(0,Math.min(t.options.length-1,W));if(U!==i()&&(i(U),typeof t.onchange=="function")){const se=t.options[U];se&&t.onchange(U,se)}}function I(A){A!==0&&_(i()+A)}function C(A){A.preventDefault(),A.stopPropagation();const W=Math.sign(A.deltaY);W!==0&&I(W)}function M(A){A.key==="ArrowUp"?(A.preventDefault(),I(-1)):A.key==="ArrowDown"?(A.preventDefault(),I(1)):A.key==="Home"?(A.preventDefault(),_(0)):A.key==="End"&&(A.preventDefault(),_(t.options.length-1))}function S(A){if(B(u,!0),B(f,A.pointerId,!0),B(g,A.clientY,!0),B(h,0),n(r)&&typeof n(r).setPointerCapture=="function")try{n(r).setPointerCapture(A.pointerId)}catch{}}function D(A){if(!n(u)||A.pointerId!==n(f))return;const W=A.clientY-n(g);if(B(g,A.clientY,!0),W===0)return;B(h,n(h)+W);const U=n(p)||a;for(;Math.abs(n(h))>=U;){const se=-Math.sign(n(h));I(se),B(h,n(h)-Math.sign(n(h))*U)}}function x(A){n(u)&&A.pointerId===n(f)&&(B(u,!1),B(f,null),B(h,0),n(r)?.hasPointerCapture?.(A.pointerId)&&n(r).releasePointerCapture(A.pointerId))}Re(()=>{if(!n(l)||!n(c))return;const A=()=>{const U=n(l)?.querySelector(".pitch-wheel-option");U&&B(p,U.offsetHeight||o,!0)};A();const W=new ResizeObserver(()=>{A()});return W.observe(n(c)),()=>{W.disconnect()}});var H=Gs();H.__keydown=M,H.__pointerdown=S,H.__pointermove=D,H.__pointerup=x;let X;var V=b(H),ne=b(V);let $;tt(ne,23,()=>t.options,A=>A.index,(A,W,U)=>{var se=Ys(),me=b(se);te(()=>{Fe(se,"data-distance",n(m)[n(U)]),G(me,n(W).label)}),E(A,se)}),He(ne,A=>B(l,A),()=>n(l)),He(V,A=>B(c,A),()=>n(c)),He(H,A=>B(r,A),()=>n(r)),te(()=>{Fe(H,"aria-label",s()),Fe(H,"aria-valuemax",t.options.length-1),Fe(H,"aria-valuenow",i()),Fe(H,"aria-valuetext",t.options[i()]?.label??""),X=ot(H,"",X,{height:t.wheelHeight?`${t.wheelHeight}px`:"100%"}),$=ot(ne,"",$,{"padding-top":`${n(v)??""}px`,"padding-bottom":`${n(v)??""}px`,transform:`translateY(${n(w)??""}px)`})}),Ue("wheel",H,C),Ue("pointercancel",H,x),Ue("pointerleave",H,x),E(e,H),Pe()}Se(["keydown","pointerdown","pointermove","pointerup"]);const En=7;function ut(e,t,i){return Number.isFinite(e)?Math.max(t,Math.min(i,Math.round(e))):t}function Vs(e,t,i,s=En){const o=Math.max(0,i-1),a=ut(e,0,o),r=Math.max(1,Math.round(s)),c=Math.max(0,a-(r-1));return ut(t,0,c)}function Us(e,t,i,s=En){const o=Math.max(0,i-1),a=ut(e,0,o),r=Math.max(1,Math.round(s)),c=Math.min(o,a+(r-1));return ut(t,c,o)}function js(e){return e.map((t,i)=>({index:i,label:t.pitch,midi:t.midi,toneNote:t.toneNote,frequency:t.frequency}))}var Xs=F('<div class="summary-card svelte-yqjxxp"><div class="summary-label svelte-yqjxxp"> </div> <div class="summary-metadata svelte-yqjxxp"> </div></div>'),Ks=F('<div class="dual-pitch-wheel svelte-yqjxxp"><div class="wheels-container svelte-yqjxxp"><div class="wheel-column svelte-yqjxxp"><div class="wheel-label svelte-yqjxxp">High</div> <!></div> <div class="wheel-column svelte-yqjxxp"><div class="wheel-label svelte-yqjxxp">Low</div> <!></div></div> <!></div>');function Zs(e,t){Te(t,!0);let i=pe(t,"topIndex",15),s=pe(t,"bottomIndex",15),o=pe(t,"minSpan",3,7),a=pe(t,"showSummary",3,!0);const r=N(()=>js(t.fullRowData)),c=N(()=>({topIndex:i(),bottomIndex:s(),topPitch:t.fullRowData[i()],bottomPitch:t.fullRowData[s()],span:s()-i()+1})),l=N(()=>n(c).topPitch&&n(c).bottomPitch?`${n(c).topPitch.pitch} â€“ ${n(c).bottomPitch.pitch}`:""),u=N(()=>`${n(c).span} ${n(c).span===1?"pitch":"pitches"}`);function f(M){return Vs(s(),M,n(r).length,o())}function g(M){return Us(i(),M,n(r).length,o())}function h(M,S){i(M),typeof t.onrangechange=="function"&&t.onrangechange(n(c))}function p(M,S){s(M),typeof t.onrangechange=="function"&&t.onrangechange(n(c))}var m=Ks(),d=b(m),v=b(d),y=P(b(v),2);un(y,{get options(){return n(r)},get selectedIndex(){return i()},onchange:h,onbeforechange:f,get wheelHeight(){return t.wheelHeight},ariaLabel:"High pitch selector"});var w=P(v,2),_=P(b(w),2);un(_,{get options(){return n(r)},get selectedIndex(){return s()},onchange:p,onbeforechange:g,get wheelHeight(){return t.wheelHeight},ariaLabel:"Low pitch selector"});var I=P(d,2);{var C=M=>{var S=Xs(),D=b(S),x=b(D),H=P(D,2),X=b(H);te(()=>{G(x,n(l)),G(X,n(u))}),E(M,S)};le(I,M=>{a()&&M(C)})}E(e,m),Pe()}Se(["change"]);var Js=F('<div class="range-control svelte-y9vn59"><h3 class="control-title svelte-y9vn59">Pitch Range</h3> <!></div>');function Qs(e,t){Te(t,!0);function i(l){const u=Vt.findIndex(f=>f.midi===l);return u>=0?u:0}const s=N(()=>i(K.state.yAxisRange.maxMidi)),o=N(()=>i(K.state.yAxisRange.minMidi));function a(l){const u=l.bottomPitch.midi??21,f=l.topPitch.midi??108;K.setYAxisRange({minMidi:u,maxMidi:f})}var r=Js(),c=P(b(r),2);Zs(c,{get fullRowData(){return Vt},get topIndex(){return n(s)},get bottomIndex(){return n(o)},minSpan:7,onrangechange:a,showSummary:!0,wheelHeight:200}),E(e,r),Pe()}var $s=F('<div class="pitch-highlight-toggle svelte-167yaa1"><span class="toggle-label svelte-167yaa1">Pitch Highlight</span> <button> </button></div>');function ea(e,t){Te(t,!1);function i(){K.togglePitchHighlight()}Lt();var s=$s(),o=P(b(s),2);let a;o.__click=i;var r=b(o);te(()=>{a=et(o,1,"toggle-button svelte-167yaa1",null,a,{active:K.state.pitchHighlightEnabled}),G(r,K.state.pitchHighlightEnabled?"On":"Off")}),E(e,s),Pe()}Se(["click"]);var ta=F('<button class="start-exercise-btn svelte-16pthc8">Start Demo Exercise</button>'),na=F('<button class="stop-exercise-btn svelte-16pthc8">Stop Exercise</button> <div class="progress-indicator svelte-16pthc8"> </div> <div class="phase-indicator svelte-16pthc8"> </div>',1),ia=F('<div><span class="result-loop svelte-16pthc8"></span> <span class="result-pitch svelte-16pthc8"> </span> <span class="result-accuracy svelte-16pthc8"> </span> <span class="result-status svelte-16pthc8"> </span></div>'),sa=F('<div class="exercise-results svelte-16pthc8"><h4 class="results-title svelte-16pthc8">Results</h4> <div class="results-summary svelte-16pthc8"><div class="stat svelte-16pthc8"><span class="stat-label svelte-16pthc8">Average Accuracy:</span> <span class="stat-value svelte-16pthc8"> </span></div> <div class="stat svelte-16pthc8"><span class="stat-label svelte-16pthc8">Hits:</span> <span class="stat-value svelte-16pthc8"> </span></div></div> <details class="results-details svelte-16pthc8"><summary class="results-summary-label svelte-16pthc8">Detailed Results</summary> <div class="results-list svelte-16pthc8"></div></details></div>'),aa=F('<div class="demo-exercise-panel svelte-16pthc8"><h3 class="panel-title svelte-16pthc8">Demo Exercise</h3> <details class="settings-details svelte-16pthc8"><summary class="settings-summary svelte-16pthc8">Settings</summary> <div class="exercise-settings svelte-16pthc8"><label class="setting-label svelte-16pthc8"><span class="label-text svelte-16pthc8">Number of loops:</span> <input class="setting-input svelte-16pthc8" type="number" min="1" max="20"/></label> <label class="setting-label svelte-16pthc8"><span class="label-text svelte-16pthc8">Tempo (BPM):</span> <input class="setting-input svelte-16pthc8" type="number" min="60" max="180"/></label> <label class="setting-label svelte-16pthc8"><span class="label-text svelte-16pthc8">Reference Volume:</span> <input class="setting-slider svelte-16pthc8" type="range" min="-40" max="0"/> <span class="volume-value svelte-16pthc8"> </span></label> <div class="pitch-range-buttons svelte-16pthc8"><button class="range-btn svelte-16pthc8">Use Current Range</button> <button class="range-btn svelte-16pthc8">Use Full Range</button></div></div></details> <div class="exercise-controls svelte-16pthc8"><!></div> <!></div>');function oa(e,t){Te(t,!0);let i=J(!1),s=J(5),o=J(108),a=J(-12);const r=N(()=>_e.state.isActive),c=N(()=>_e.state.isPlaying),l=N(()=>_e.state.currentPhase),u=N(()=>_e.getCurrentProgress()),f=N(()=>_e.getResults()),g=N(()=>n(f).length>0),h=N(()=>_e.getAverageAccuracy()),p=N(()=>_e.getHitCount()),m=N(()=>n(f).length);Re(()=>{if(!n(r)||!n(c))return;const R=fe.state.currentTimeMs;_e.updatePhase(R)}),Re(()=>{if(!n(r))return;const R=fe.getPerformanceResults();_e.getGeneratedNotes().forEach((ee,ce)=>{if(ee.lyric!=="ðŸŽ¤")return;const ve=`target-${ce}`,he=R.get(ve);if(he&&!_e.hasResultForLoop(Math.floor(ce/2))){const ue=d(he);_e.addResult({loopIndex:Math.floor(ce/2),targetPitch:ee.midi,accuracy:ue,performance:he})}})});function d(R){return R.hitStatus==="hit"?R.pitchAccuracyCents!==void 0?Math.max(0,100-Math.abs(R.pitchAccuracyCents)/50*100):100:0}ze(()=>{n(r)&&_()});function v(){const R=K.state.yAxisRange;_e.setPitchRange(R.minMidi,R.maxMidi)}function y(){_e.setPitchRange(21,108)}async function w(){K.setVisualizationMode("highway"),_e.configure({numLoops:n(s),tempo:n(o),referenceVolume:n(a)}),v(),await Ge.init(),Ge.setVolume(n(a)),_e.start();const R=_e.getGeneratedNotes();fe.setTargetNotes(R),fe.start(),_e.setPlaying(!0);const j=R.filter(ee=>ee.lyric==="ðŸ‘‚");Ge.scheduleReferenceTones(j)}function _(){Ge.stop(),fe.stop(),_e.stop()}function I(R){switch(R){case"reference":return"ðŸ‘‚ Listen";case"input":return"ðŸŽ¤ Sing";default:return"Rest"}}function C(R){return yi(R)?.pitch||`MIDI ${R}`}var M=aa(),S=P(b(M),2),D=P(b(S),2),x=b(D),H=P(b(x),2),X=P(x,2),V=P(b(X),2),ne=P(X,2),$=P(b(ne),2),A=P($,2),W=b(A),U=P(ne,2),se=b(U);se.__click=v;var me=P(se,2);me.__click=y;var ye=P(S,2),we=b(ye);{var Q=R=>{var j=ta();j.__click=w,E(R,j)},z=R=>{var j=na(),ee=Je(j);ee.__click=_;var ce=P(ee,2),ve=b(ce),he=P(ce,2),ue=b(he);te(q=>{G(ve,`Loop ${n(u).current??""} / ${n(u).total??""}`),G(ue,q)},[()=>I(n(l))]),E(R,j)};le(we,R=>{n(r)?R(z,!1):R(Q)})}var Z=P(ye,2);{var L=R=>{var j=sa(),ee=P(b(j),2),ce=b(ee),ve=P(b(ce),2),he=b(ve),ue=P(ce,2),q=P(b(ue),2),ie=b(q),T=P(ee,2),k=P(b(T),2);tt(k,21,()=>n(f),dt,(O,ae,ge)=>{var be=ia();let oe;var Ce=b(be);Ce.textContent=`Loop ${ge+1}:`;var re=P(Ce,2),Ne=b(re),De=P(re,2),ke=b(De),ft=P(De,2),ht=b(ft);te((vt,gt)=>{oe=et(be,1,"result-item svelte-16pthc8",null,oe,{hit:n(ae).performance?.hitStatus==="hit"}),G(Ne,vt),G(ke,`${gt??""}%`),G(ht,n(ae).performance?.hitStatus==="hit"?"âœ“":"âœ—")},[()=>C(n(ae).targetPitch),()=>n(ae).accuracy.toFixed(0)]),E(O,be)}),te(O=>{G(he,`${O??""}%`),G(ie,`${n(p)??""}/${n(m)??""}`)},[()=>n(h).toFixed(1)]),E(R,j)};le(Z,R=>{n(g)&&!n(r)&&R(L)})}te(()=>{H.disabled=n(r),V.disabled=n(r),$.disabled=n(r),G(W,`${n(a)??""} dB`),se.disabled=n(r),me.disabled=n(r)}),yt(H,()=>n(s),R=>B(s,R)),yt(V,()=>n(o),R=>B(o,R)),yt($,()=>n(a),R=>B(a,R)),Tn("open","toggle",S,R=>B(i,R),()=>n(i)),E(e,M),Pe()}Se(["click"]);const ra=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,/^([a-zA-Z0-9_-]{11})$/],la={gapMs:0,videoGapSec:0,manualOffsetSec:0},Ot=60;function ca(e){try{const t=e.split(/\r?\n/).map(r=>r.trim()),i=ua(t);if(!i.bpm)return{success:!1,error:"Missing required #BPM tag"};const{notes:s,lineBreaks:o,totalBeats:a}=da(t);return s.length===0?{success:!1,error:"No valid notes found in file"}:{success:!0,song:{metadata:i,notes:s,lineBreaks:o,totalBeats:a}}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Unknown parsing error"}}}function ua(e){const t={};for(const i of e){if(!i.startsWith("#"))continue;const s=i.indexOf(":");if(s===-1)continue;const o=i.slice(1,s).toUpperCase().trim(),a=i.slice(s+1).trim();switch(o){case"TITLE":t.title=a;break;case"ARTIST":t.artist=a;break;case"VIDEO":t.video=a;break;case"VIDEOGAP":t.videoGap=parseFloat(a.replace(",","."))||0;break;case"GAP":t.gap=parseFloat(a.replace(",","."))||0;break;case"BPM":t.bpm=parseFloat(a.replace(",","."))||0;break;case"MP3":case"AUDIO":t.mp3=a;break;case"LANGUAGE":t.language=a;break;case"GENRE":t.genre=a;break;case"YEAR":t.year=parseInt(a)||void 0;break;case"CREATOR":t.creator=a;break;case"COVER":t.cover=a;break;case"BACKGROUND":t.background=a;break;case"PREVIEWSTART":t.previewStart=parseFloat(a.replace(",","."))||0;break}}return{title:t.title||"Unknown Title",artist:t.artist||"Unknown Artist",bpm:t.bpm||0,...t}}function da(e){const t=[],i=[];let s=0;for(const o of e){if(o.length===0||o.startsWith("#"))continue;const a=o[0];if(a==="E")break;if(a==="-"){const r=o.slice(1).trim().split(/\s+/),c=parseInt(r[0])||0;i.push(c);continue}if([":","*","F","R"].includes(a)){const r=fa(o);if(r){t.push(r);const c=r.startBeat+r.duration;c>s&&(s=c)}}}return{notes:t,lineBreaks:i,totalBeats:s}}function fa(e){const t=e[0],s=e.slice(1).trim().split(/\s+/);if(s.length<3)return null;const o=parseInt(s[0]),a=parseInt(s[1]),r=parseInt(s[2]),c=s.slice(3).join(" ")||"";return isNaN(o)||isNaN(a)||isNaN(r)?null:{type:t,startBeat:o,duration:a,pitch:r,lyric:c}}function ha(e){if(!e)return null;const t=e.trim();for(const i of ra){const s=t.match(i);if(s&&s[1])return s[1]}return null}function dn(e,t=Ot){const{metadata:i,notes:s,lineBreaks:o}=e,{bpm:a}=i,r=60/a*1e3*4;let c=0;const l=[...o].sort((f,g)=>f-g),u=s.length>0?Math.min(...s.map(f=>f.startBeat)):0;return s.filter(f=>f.type!=="F").map(f=>{const g=(f.startBeat-u)*r,h=f.duration*r,p=t+f.pitch;for(;c<l.length&&f.startBeat>=l[c];)c++;const m={midi:p,startTimeMs:g,durationMs:h,lyric:f.lyric.trim()||void 0};return f.type==="*"&&(m.isGolden=!0),m})}function va(e){return{gapMs:e.gap||0,videoGapSec:e.videoGap||0,manualOffsetSec:0}}function ga(e){const{metadata:t,notes:i,totalBeats:s}=e,{bpm:o}=t,a=60/o*1e3*4,r=i.length>0?Math.min(...i.map(l=>l.startBeat)):0;return(s-r)*a+2e3}function fn(e,t=Ot){const i=e.notes.filter(a=>a.type!=="F"&&a.type!=="-").map(a=>t+a.pitch);if(i.length===0)return{minMidi:48,maxMidi:72};const s=Math.min(...i),o=Math.max(...i);return{minMidi:Math.max(24,s-3),maxMidi:Math.min(108,o+3)}}const hn={isActive:!1,isLoading:!1,isPlaying:!1,song:null,targetNotes:[],youtubeId:null,syncConfig:{...la},baseMidi:Ot,totalDurationMs:0,detectedRange:{minMidi:48,maxMidi:72},error:null};function ma(){let e=J(Ee({...hn})),t=null;return{get state(){return n(e)},async loadFile(i){n(e).isLoading=!0,n(e).error=null;try{const s=await i.text(),o=ca(s);if(!o.success)return n(e).error=o.error,n(e).isLoading=!1,!1;const a=o.song,r=a.metadata.video?ha(a.metadata.video):null,c=va(a.metadata),l=dn(a,n(e).baseMidi),u=ga(a),f=fn(a,n(e).baseMidi);return n(e).song=a,n(e).youtubeId=r,n(e).syncConfig=c,n(e).targetNotes=l,n(e).totalDurationMs=u,n(e).detectedRange=f,n(e).isActive=!0,n(e).isLoading=!1,!0}catch(s){return n(e).error=s instanceof Error?s.message:"Failed to load file",n(e).isLoading=!1,!1}},get youtubeOffset(){const{gapMs:i,videoGapSec:s,manualOffsetSec:o}=n(e).syncConfig;return i/1e3+s+o},adjustOffset(i){n(e).syncConfig={...n(e).syncConfig,manualOffsetSec:n(e).syncConfig.manualOffsetSec+i}},setManualOffset(i){n(e).syncConfig={...n(e).syncConfig,manualOffsetSec:i}},resetOffset(){n(e).syncConfig={...n(e).syncConfig,manualOffsetSec:0}},setBaseMidi(i){n(e).baseMidi=i,n(e).song&&(n(e).targetNotes=dn(n(e).song,i),n(e).detectedRange=fn(n(e).song,i))},setPlaying(i){n(e).isPlaying=i},onComplete(i){t=i},triggerComplete(){n(e).isPlaying=!1,t&&t()},checkCompletion(i){return!n(e).isPlaying||!n(e).isActive?!1:i>=n(e).totalDurationMs-500?(this.triggerComplete(),!0):!1},get title(){return n(e).song?.metadata.title||""},get artist(){return n(e).song?.metadata.artist||""},get hasVideo(){return n(e).youtubeId!==null},reset(){B(e,{...hn},!0),t=null},unload(){n(e).isActive=!1,n(e).isPlaying=!1,n(e).song=null,n(e).targetNotes=[],n(e).youtubeId=null,n(e).totalDurationMs=0,n(e).error=null}}}const Y=ma();let at=null,Ve=!1;function pa(){return at||(Ve&&window.YT&&window.YT.Player?Promise.resolve():(at=new Promise((e,t)=>{if(window.YT&&window.YT.Player){Ve=!0,e();return}window.onYouTubeIframeAPIReady=()=>{Ve=!0,e()};const i=document.createElement("script");i.src="https://www.youtube.com/iframe_api",i.async=!0,i.onerror=()=>{t(new Error("Failed to load YouTube IFrame API"))},document.head.appendChild(i),setTimeout(()=>{Ve||t(new Error("YouTube IFrame API load timeout"))},1e4)}),at))}function ya(e,t,i={}){if(!Ve||!window.YT?.Player)throw new Error("YouTube API not loaded. Call loadYouTubeAPI() first.");const{width:s=320,height:o=180,onReady:a,onStateChange:r,onError:c}=i;return new window.YT.Player(e,{width:s,height:o,videoId:t,playerVars:{autoplay:0,controls:1,disablekb:1,enablejsapi:1,fs:0,modestbranding:1,origin:window.location.origin,playsinline:1,rel:0},events:{onReady:l=>{a?.(l.target)},onStateChange:l=>{r?.(l.data)},onError:l=>{c?.(l.data)}}})}function ba(e){switch(e){case YT.PlayerError.InvalidParam:return"Invalid video ID";case YT.PlayerError.Html5Error:return"HTML5 player error";case YT.PlayerError.VideoNotFound:return"Video not found";case YT.PlayerError.NotAllowedEmbedded:case YT.PlayerError.NotAllowedEmbedded2:return"Video cannot be embedded";default:return"Unknown player error"}}const Ct={isApiLoaded:!1,isApiLoading:!1,isPlayerReady:!1,isPlaying:!1,currentTime:0,duration:0,videoId:null,error:null,isEmbeddable:!0,volume:100,isMuted:!1};function _a(){let e=J(Ee({...Ct})),t=null,i=null,s=null;return{get state(){return n(e)},async initAPI(){if(n(e).isApiLoaded)return!0;if(n(e).isApiLoading)return!1;n(e).isApiLoading=!0,n(e).error=null;try{return await pa(),n(e).isApiLoaded=!0,n(e).isApiLoading=!1,!0}catch(o){return n(e).error=o instanceof Error?o.message:"Failed to load YouTube API",n(e).isApiLoading=!1,!1}},async loadVideo(o,a){if(!n(e).isApiLoaded&&!await this.initAPI())return!1;if(t){try{t.destroy()}catch{}t=null}return n(e).isPlayerReady=!1,n(e).error=null,n(e).isEmbeddable=!0,n(e).videoId=o,new Promise(r=>{try{t=ya(a,o,{onReady:c=>{n(e).isPlayerReady=!0,n(e).duration=c.getDuration(),n(e).volume=c.getVolume(),n(e).isMuted=c.isMuted(),r(!0)},onStateChange:c=>{n(e).isPlaying=c===YT.PlayerState.PLAYING,c===YT.PlayerState.ENDED&&(n(e).isPlaying=!1,this.stopSyncLoop())},onError:c=>{n(e).error=ba(c),n(e).isEmbeddable=c!==YT.PlayerError.NotAllowedEmbedded&&c!==YT.PlayerError.NotAllowedEmbedded2,n(e).isPlayerReady=!1,r(!1)}})}catch(c){n(e).error=c instanceof Error?c.message:"Failed to create player",r(!1)}})},play(){t&&n(e).isPlayerReady&&t.playVideo()},pause(){t&&n(e).isPlayerReady&&t.pauseVideo()},stop(){t&&n(e).isPlayerReady&&(t.stopVideo(),n(e).isPlaying=!1),this.stopSyncLoop()},seekTo(o){t&&n(e).isPlayerReady&&(t.seekTo(Math.max(0,o),!0),n(e).currentTime=Math.max(0,o))},getCurrentTime(){return t&&n(e).isPlayerReady?t.getCurrentTime():n(e).currentTime},setVolume(o){const a=Math.max(0,Math.min(100,o));t&&n(e).isPlayerReady&&t.setVolume(a),n(e).volume=a},mute(){t&&n(e).isPlayerReady&&t.mute(),n(e).isMuted=!0},unmute(){t&&n(e).isPlayerReady&&t.unMute(),n(e).isMuted=!1},toggleMute(){n(e).isMuted?this.unmute():this.mute()},startSyncLoop(o,a=250){s=o,i!==null&&clearInterval(i),i=window.setInterval(()=>{if(t&&n(e).isPlayerReady&&n(e).isPlaying){const r=t.getCurrentTime();n(e).currentTime=r,s?.(r)}},a)},stopSyncLoop(){i!==null&&(clearInterval(i),i=null),s=null},correctDrift(o,a=150){if(!t||!n(e).isPlayerReady||!n(e).isPlaying)return!1;const r=t.getCurrentTime();return Math.abs(r-o)*1e3>a?(t.seekTo(o,!0),!0):!1},getVideoUrl(){return n(e).videoId?`https://www.youtube.com/watch?v=${n(e).videoId}`:null},dispose(){if(this.stopSyncLoop(),t){try{t.destroy()}catch{}t=null}B(e,{...Ct,isApiLoaded:n(e).isApiLoaded},!0)},reset(){this.dispose(),B(e,{...Ct},!0)}}}const Me=_a();function wa(e){let t={...e.syncConfig};const i=e.driftCheckIntervalMs??250,s=e.maxDriftMs??150;function o(){return t.gapMs/1e3+t.videoGapSec+t.manualOffsetSec}function a(d){return d/1e3+o()}function r(d){return(d-o())*1e3}function c(d,v){const y=a(d),w=v-y,_=Math.abs(w*1e3);if(_>s){const I=r(v);return{driftMs:_,needsCorrection:!0,correctedTransportTimeMs:I}}return{driftMs:_,needsCorrection:!1}}function l(d){t={...t,...d}}function u(d){t.manualOffsetSec+=d}function f(){t.manualOffsetSec=0}function g(){return t.manualOffsetSec}function h(){return o()}function p(){const d=t.manualOffsetSec;return`${d>=0?"+":""}${d.toFixed(2)}s`}function m(){return{intervalMs:i,maxDriftMs:s}}return{getYouTubeOffset:o,getTotalOffset:h,getManualOffset:g,getSyncLoopConfig:m,transportToYouTube:a,youTubeToTransport:r,checkDrift:c,updateConfig:l,adjustManualOffset:u,resetManualOffset:f,formatOffset:p,getConfig:()=>({...t})}}var Ma=F('<div class="youtube-loading svelte-4iyhd6"><div class="spinner svelte-4iyhd6"></div> <span>Loading video...</span></div>'),Ta=F('<button class="fallback-btn svelte-4iyhd6">Open on YouTube â†—</button>'),Pa=F('<div class="youtube-error svelte-4iyhd6"><span class="error-icon svelte-4iyhd6">âš ï¸</span> <span class="error-message svelte-4iyhd6"> </span> <!></div>'),Ca=F('<div class="youtube-placeholder svelte-4iyhd6"><span class="placeholder-icon svelte-4iyhd6">ðŸŽ¬</span> <span class="placeholder-text svelte-4iyhd6">No video loaded</span></div>'),Sa=F('<div class="youtube-container svelte-4iyhd6"><div class="youtube-player svelte-4iyhd6"></div> <!> <!> <!></div>');function Aa(e,t){Te(t,!0);const i=`youtube-player-${Math.random().toString(36).slice(2,9)}`,s=N(()=>Me.state.isApiLoading||Me.state.videoId&&!Me.state.isPlayerReady),o=N(()=>!!Me.state.error),a=N(()=>Me.state.isEmbeddable),r=N(()=>Y.state.youtubeId);Re(()=>{n(r)&&Me.loadVideo(n(r),i)}),ze(()=>{Me.dispose()});function c(){const v=Me.getVideoUrl();v&&window.open(v,"_blank","noopener,noreferrer")}var l=Sa(),u=b(l),f=P(u,2);{var g=v=>{var y=Ma();E(v,y)};le(f,v=>{n(s)&&n(r)&&v(g)})}var h=P(f,2);{var p=v=>{var y=Pa(),w=P(b(y),2),_=b(w),I=P(w,2);{var C=M=>{var S=Ta();S.__click=c,E(M,S)};le(I,M=>{n(a)||M(C)})}te(()=>G(_,Me.state.error)),E(v,y)};le(h,v=>{n(o)&&v(p)})}var m=P(h,2);{var d=v=>{var y=Ca();E(v,y)};le(m,v=>{!n(r)&&!n(s)&&!n(o)&&v(d)})}te(()=>Fe(u,"id",i)),E(e,l),Pe()}Se(["click"]);var Ia=F('<div class="sync-controls svelte-wiblfi"><div class="sync-header svelte-wiblfi"><span class="sync-label svelte-wiblfi">Sync Offset</span> <span class="sync-value svelte-wiblfi"> </span></div> <div class="sync-buttons svelte-wiblfi"><button class="sync-btn coarse svelte-wiblfi" title="Earlier by 0.1s">-0.1s</button> <button class="sync-btn fine svelte-wiblfi" title="Earlier by 0.01s">-0.01s</button> <button class="sync-btn reset svelte-wiblfi" title="Reset offset">0</button> <button class="sync-btn fine svelte-wiblfi" title="Later by 0.01s">+0.01s</button> <button class="sync-btn coarse svelte-wiblfi" title="Later by 0.1s">+0.1s</button></div> <div class="sync-hint svelte-wiblfi">Use arrow keys to adjust (Shift for coarse)</div></div>');function xa(e,t){Te(t,!0);const i=N(()=>Y.state.syncConfig.manualOffsetSec),s=N(()=>Y.state.isActive);function o(w){return`${w>=0?"+":""}${w.toFixed(2)}s`}function a(w){Y.adjustOffset(w)}function r(){Y.resetOffset()}function c(w){if(n(s)&&!(w.target instanceof HTMLInputElement))switch(w.key){case"ArrowLeft":w.preventDefault(),a(w.shiftKey?-.1:-.01);break;case"ArrowRight":w.preventDefault(),a(w.shiftKey?.1:.01);break}}var l=Ia();Ue("keydown",yn,c);var u=b(l),f=P(b(u),2),g=b(f),h=P(u,2),p=b(h);p.__click=()=>a(-.1);var m=P(p,2);m.__click=()=>a(-.01);var d=P(m,2);d.__click=r;var v=P(d,2);v.__click=()=>a(.01);var y=P(v,2);y.__click=()=>a(.1),te(w=>{G(g,w),p.disabled=!n(s),m.disabled=!n(s),d.disabled=!n(s)||n(i)===0,v.disabled=!n(s),y.disabled=!n(s)},[()=>o(n(i))]),E(e,l),Pe()}Se(["click"]);var Ra=F('<span class="spinner svelte-1162o9n"></span> Loading...',1),Na=F('<div class="error-message svelte-1162o9n"> </div>'),Da=F('<button class="upload-btn svelte-1162o9n"><!></button> <!>',1),Ha=F('<div class="video-section svelte-1162o9n"><!> <!></div>'),Ea=F('<button class="play-btn svelte-1162o9n">â–¶ Play</button>'),La=F('<button class="stop-btn svelte-1162o9n">â¹ Stop</button>'),ka=F('<div class="progress-info svelte-1162o9n"><span class="time-display svelte-1162o9n"> </span></div>'),Fa=F('<div class="song-info svelte-1162o9n"><div class="song-title svelte-1162o9n"> </div> <div class="song-artist svelte-1162o9n"> </div></div> <!> <div class="playback-controls svelte-1162o9n"><!> <button class="unload-btn svelte-1162o9n">Unload</button></div> <!>',1),Oa=F('<div class="ultrastar-panel svelte-1162o9n"><h3 class="panel-title svelte-1162o9n">Ultrastar Song</h3> <input type="file" accept=".txt" style="display: none;"/> <!></div>');function Wa(e,t){Te(t,!0);let i=null,s;const o=N(()=>Y.state.isActive),a=N(()=>Y.state.isLoading),r=N(()=>Y.state.isPlaying),c=N(()=>Y.hasVideo),l=N(()=>Y.title),u=N(()=>Y.artist),f=N(()=>Y.state.error);async function g(S){const D=S.target,x=D.files?.[0];if(!x)return;if(await Y.loadFile(x)){i=wa({syncConfig:Y.state.syncConfig});const X=Y.state.detectedRange;K.setYAxisRange({minMidi:X.minMidi,maxMidi:X.maxMidi}),fe.setTargetNotes(Y.state.targetNotes),console.log("[Ultrastar] File loaded:",{title:Y.title,artist:Y.artist,youtubeId:Y.state.youtubeId,bpm:Y.state.song?.metadata.bpm,gap:Y.state.song?.metadata.gap,videoGap:Y.state.song?.metadata.videoGap,noteCount:Y.state.targetNotes.length,firstNotes:Y.state.targetNotes.slice(0,3),lastNotes:Y.state.targetNotes.slice(-3),totalDurationMs:Y.state.totalDurationMs,pitchRange:X,syncConfig:Y.state.syncConfig})}D.value=""}async function h(){if(n(o))if(K.setVisualizationMode("highway"),i&&i.updateConfig(Y.state.syncConfig),fe.setTargetNotes(Y.state.targetNotes),Y.setPlaying(!0),n(c)&&Me.state.isPlayerReady){const S=i?.getYouTubeOffset()??0;console.log("[Ultrastar] Starting playback:",{youtubeOffset:S,noteCount:Y.state.targetNotes.length,firstNote:Y.state.targetNotes[0],syncConfig:Y.state.syncConfig}),fe.setCurrentTime(0),Me.seekTo(S),Me.play(),d()}else fe.start()}function p(){fe.stop(),Y.setPlaying(!1),Me.pause(),v()}function m(){p(),Y.unload(),Me.dispose(),fe.reset(),i=null}function d(){Me.startSyncLoop(S=>{if(!i)return;const D=i.youTubeToTransport(S),x=fe.state.currentTimeMs;Math.abs(D-x)>50&&fe.setCurrentTime(Math.max(0,D))},100)}function v(){Me.stopSyncLoop()}function y(){s?.click()}ze(()=>{v(),Me.dispose()});var w=Oa(),_=P(b(w),2);_.__change=g,He(_,S=>s=S,()=>s);var I=P(_,2);{var C=S=>{var D=Da(),x=Je(D);x.__click=y;var H=b(x);{var X=A=>{var W=Ra();E(A,W)},V=A=>{var W=oi("Upload Ultrastar .txt");E(A,W)};le(H,A=>{n(a)?A(X):A(V,!1)})}var ne=P(x,2);{var $=A=>{var W=Na(),U=b(W);te(()=>G(U,n(f))),E(A,W)};le(ne,A=>{n(f)&&A($)})}te(()=>x.disabled=n(a)),E(S,D)},M=S=>{var D=Fa(),x=Je(D),H=b(x),X=b(H),V=P(H,2),ne=b(V),$=P(x,2);{var A=z=>{var Z=Ha(),L=b(Z);Aa(L,{});var R=P(L,2);xa(R,{}),E(z,Z)};le($,z=>{n(c)&&z(A)})}var W=P($,2),U=b(W);{var se=z=>{var Z=Ea();Z.__click=h,E(z,Z)},me=z=>{var Z=La();Z.__click=p,E(z,Z)};le(U,z=>{n(r)?z(me,!1):z(se)})}var ye=P(U,2);ye.__click=m;var we=P(W,2);{var Q=z=>{var Z=ka(),L=b(Z),R=b(L);te((j,ee)=>G(R,`${j??""}s
          / ${ee??""}s`),[()=>Math.floor(fe.state.currentTimeMs/1e3),()=>Math.floor(Y.state.totalDurationMs/1e3)]),E(z,Z)};le(we,z=>{n(r)&&z(Q)})}te(()=>{G(X,n(l)),G(ne,n(u)),ye.disabled=n(r)}),E(S,D)};le(I,S=>{n(o)?S(M,!1):S(C)})}E(e,w),Pe()}Se(["change","click"]);var Ba=F('<div class="note-display svelte-44x6iu"><span class="note-name svelte-44x6iu"> </span> <span class="octave svelte-44x6iu"> </span></div> <div class="details svelte-44x6iu"><span class="frequency"> </span> <span> </span> <span class="clarity"> </span></div>',1),za=F('<div class="no-pitch svelte-44x6iu"><span class="placeholder svelte-44x6iu">---</span> <span class="hint svelte-44x6iu">Sing or hum into the microphone</span></div>'),qa=F('<div class="pitch-readout svelte-44x6iu"><!></div>');function Ya(e,t){Te(t,!0);const i=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],s=N(()=>()=>{const l=de.state.currentPitch;if(!l)return null;const u=i[l.pitchClass],f=Math.floor(l.midi/12)-1,g=Math.round((l.midi-Math.round(l.midi))*100);return{name:u,octave:f,frequency:l.frequency.toFixed(1),cents:g,clarity:Math.round(l.clarity*100)}});var o=qa(),a=b(o);{var r=l=>{const u=N(()=>n(s)());var f=Ba(),g=Je(f),h=b(g),p=b(h),m=P(h,2),d=b(m),v=P(g,2),y=b(v),w=b(y),_=P(y,2);let I;var C=b(_),M=P(_,2),S=b(M);te(()=>{G(p,n(u).name),G(d,n(u).octave),G(w,`${n(u).frequency??""} Hz`),I=et(_,1,"cents svelte-44x6iu",null,I,{sharp:n(u).cents>0,flat:n(u).cents<0}),G(C,`${n(u).cents>0?"+":""}${n(u).cents??""}Â¢`),G(S,`${n(u).clarity??""}%`)}),E(l,f)},c=l=>{var u=za();E(l,u)};le(a,l=>{n(s)()?l(r):l(c,!1)})}E(e,o),Pe()}const vn={isVisible:!1,summary:null,songTitle:"",artistName:"",source:null},Ga={totalNotes:0,notesHit:0,notesMissed:0,accuracyPercent:0,goldenNotesHit:0,goldenNotesTotal:0,phraseResults:[],averagePitchDeviationCents:0};function Va(){let e=J(Ee({...vn}));return{get state(){return n(e)},show(t,i={}){n(e).summary=t,n(e).songTitle=i.title||"",n(e).artistName=i.artist||"",n(e).source=i.source||null,n(e).isVisible=!0},hide(){n(e).isVisible=!1},clear(){B(e,{...vn},!0)},calculateSummary(t,i){if(i.length===0)return{...Ga};let s=0,o=0,a=0,r=0,c=0;const l=new Map;i.forEach((m,d)=>{const v=`target-${d}`,y=t.get(v),w=m.isGolden===!0,_=m.phraseIndex??0;w&&a++,l.has(_)||l.set(_,{hit:0,total:0,lyrics:[]});const I=l.get(_);I.total++,m.lyric&&I.lyrics.push(m.lyric),y?.hitStatus==="hit"&&(s++,I.hit++,w&&o++,typeof y.pitchAccuracyCents=="number"&&(r+=Math.abs(y.pitchAccuracyCents),c++))});const u=i.length,f=u-s,g=u>0?s/u*100:0,h=c>0?r/c:0,p=[];return l.forEach((m,d)=>{p.push({phraseIndex:d,notesHit:m.hit,totalNotes:m.total,accuracyPercent:m.total>0?m.hit/m.total*100:0,lyricPreview:m.lyrics.join("").trim().slice(0,30)||`Phrase ${d+1}`})}),p.sort((m,d)=>m.phraseIndex-d.phraseIndex),{totalNotes:u,notesHit:s,notesMissed:f,accuracyPercent:g,goldenNotesHit:o,goldenNotesTotal:a,phraseResults:p,averagePitchDeviationCents:h}},getLetterGrade(t){return t>=95?"S":t>=90?"A":t>=80?"B":t>=70?"C":t>=60?"D":"F"},getAccuracyColor(t){return t>=90?"var(--color-success, #28a745)":t>=70?"var(--color-warning, #ffc107)":"var(--color-error, #dc3545)"}}}const Ie=Va();var Ua=F('<span class="song-artist svelte-1typ84j"> </span>'),ja=F('<div class="song-info svelte-1typ84j"><span class="song-title svelte-1typ84j"> </span> <!></div>'),Xa=F('<div class="stat-item missed svelte-1typ84j"><span class="stat-value svelte-1typ84j"> </span> <span class="stat-label svelte-1typ84j">Missed</span></div>'),Ka=F('<div class="golden-stats svelte-1typ84j"><span class="golden-icon svelte-1typ84j">â­</span> <span class="golden-text svelte-1typ84j"> </span></div>'),Za=F('<div class="pitch-stats svelte-1typ84j"><span class="pitch-label">Avg. Pitch Deviation:</span> <span class="pitch-value svelte-1typ84j"> </span></div>'),Ja=F('<div><span class="phrase-lyric svelte-1typ84j"> </span> <span class="phrase-accuracy svelte-1typ84j"> </span></div>'),Qa=F('<details class="phrase-details svelte-1typ84j"><summary class="phrase-summary svelte-1typ84j">Phrase Breakdown</summary> <div class="phrase-list svelte-1typ84j"></div></details>'),$a=F('<button class="action-btn retry-btn svelte-1typ84j">Try Again</button>'),eo=F('<div class="modal-backdrop svelte-1typ84j" role="dialog" aria-modal="true" aria-labelledby="results-title" tabindex="-1"><div class="modal-content svelte-1typ84j"><div class="modal-header svelte-1typ84j"><h2 id="results-title" class="modal-title svelte-1typ84j">Results</h2> <!></div> <div class="stats-section svelte-1typ84j"><div class="grade-display svelte-1typ84j"><span class="grade-letter svelte-1typ84j"> </span></div> <div class="accuracy-display svelte-1typ84j"><span class="accuracy-value svelte-1typ84j"> </span> <span class="accuracy-label svelte-1typ84j">Accuracy</span></div> <div class="stats-row svelte-1typ84j"><div class="stat-item svelte-1typ84j"><span class="stat-value hit svelte-1typ84j"> </span> <span class="stat-label svelte-1typ84j">Hit</span></div> <div class="stat-divider svelte-1typ84j">/</div> <div class="stat-item svelte-1typ84j"><span class="stat-value total svelte-1typ84j"> </span> <span class="stat-label svelte-1typ84j">Total</span></div> <!></div> <!> <!></div> <!> <div class="modal-actions svelte-1typ84j"><!> <button class="action-btn close-btn svelte-1typ84j">Close</button></div></div></div>');function to(e,t){Te(t,!0);const i=N(()=>Ie.state.isVisible),s=N(()=>Ie.state.summary),o=N(()=>Ie.state.songTitle),a=N(()=>Ie.state.artistName),r=N(()=>n(s)?Ie.getLetterGrade(n(s).accuracyPercent):"F"),c=N(()=>n(s)?Ie.getAccuracyColor(n(s).accuracyPercent):"");function l(){Ie.hide(),t.onClose?.()}function u(){Ie.hide(),t.onRetry?.()}function f(d){d.target===d.currentTarget&&l()}function g(d){d.key==="Escape"&&n(i)&&l()}var h=ri();Ue("keydown",yn,g);var p=Je(h);{var m=d=>{var v=eo();v.__click=f,v.__keydown=g;var y=b(v),w=b(y),_=P(b(w),2);{var I=q=>{var ie=ja(),T=b(ie),k=b(T),O=P(T,2);{var ae=ge=>{var be=Ua(),oe=b(be);te(()=>G(oe,`by ${n(a)??""}`)),E(ge,be)};le(O,ge=>{n(a)&&ge(ae)})}te(()=>G(k,n(o))),E(q,ie)};le(_,q=>{n(o)&&q(I)})}var C=P(w,2),M=b(C);let S;var D=b(M),x=b(D),H=P(M,2);let X;var V=b(H),ne=b(V),$=P(H,2),A=b($),W=b(A),U=b(W),se=P(A,4),me=b(se),ye=b(me),we=P(se,2);{var Q=q=>{var ie=Xa(),T=b(ie),k=b(T);te(()=>G(k,n(s).notesMissed)),E(q,ie)};le(we,q=>{n(s).notesMissed>0&&q(Q)})}var z=P($,2);{var Z=q=>{var ie=Ka(),T=P(b(ie),2),k=b(T);te(()=>G(k,`Golden Notes: ${n(s).goldenNotesHit??""}/${n(s).goldenNotesTotal??""}`)),E(q,ie)};le(z,q=>{n(s).goldenNotesTotal>0&&q(Z)})}var L=P(z,2);{var R=q=>{var ie=Za(),T=P(b(ie),2),k=b(T);te(O=>G(k,`${O??""} cents`),[()=>n(s).averagePitchDeviationCents.toFixed(1)]),E(q,ie)};le(L,q=>{n(s).averagePitchDeviationCents>0&&q(R)})}var j=P(C,2);{var ee=q=>{var ie=Qa(),T=P(b(ie),2);tt(T,21,()=>n(s).phraseResults,dt,(k,O)=>{var ae=Ja();let ge;var be=b(ae),oe=b(be),Ce=P(be,2),re=b(Ce);te(Ne=>{ge=et(ae,1,"phrase-item svelte-1typ84j",null,ge,{perfect:n(O).accuracyPercent===100,good:n(O).accuracyPercent>=70&&n(O).accuracyPercent<100,poor:n(O).accuracyPercent<70}),G(oe,n(O).lyricPreview),G(re,`${n(O).notesHit??""}/${n(O).totalNotes??""}
                  (${Ne??""}%)`)},[()=>n(O).accuracyPercent.toFixed(0)]),E(k,ae)}),E(q,ie)};le(j,q=>{n(s).phraseResults.length>1&&q(ee)})}var ce=P(j,2),ve=b(ce);{var he=q=>{var ie=$a();ie.__click=u,E(q,ie)};le(ve,q=>{t.onRetry&&q(he)})}var ue=P(ve,2);ue.__click=l,te(q=>{S=ot(M,"",S,{"--grade-color":n(c)}),G(x,n(r)),X=ot(H,"",X,{color:n(c)}),G(ne,`${q??""}%`),G(U,n(s).notesHit),G(ye,n(s).totalNotes)},[()=>n(s).accuracyPercent.toFixed(1)]),E(d,v)};le(p,d=>{n(i)&&n(s)&&d(m)})}E(e,h),Pe()}Se(["click","keydown"]);const St={hasImportedSnapshot:!1,snapshot:null,isLoading:!1,error:null,transpositionSemitones:0};function no(){let e=J(Ee({...St}));return{get state(){return n(e)},async checkAndConsumeHandoff(){if(!wi())return!1;n(e).isLoading=!0,n(e).error=null;try{const i=await Mi();return i?i.schemaVersion!==Ut?(n(e).error=`Incompatible snapshot version: ${i.schemaVersion}. Expected: ${Ut}`,n(e).isLoading=!1,nt(),!1):(n(e).snapshot=i,n(e).hasImportedSnapshot=!0,n(e).isLoading=!1,nt(),console.log("[HandoffState] Successfully imported snapshot",{voices:i.voices.length,microbeatCount:i.timeGrid.microbeatCount,tempo:i.tempo}),!0):(n(e).error="Handoff data expired or not found. Please try exporting again.",n(e).isLoading=!1,nt(),!1)}catch(i){return console.error("[HandoffState] Failed to process handoff",i),n(e).error="Failed to import data from Student Notation.",n(e).isLoading=!1,nt(),!1}},get voices(){return n(e).snapshot?.voices??[]},get timeGrid(){return n(e).snapshot?.timeGrid??null},get tempo(){return n(e).snapshot?.tempo??90},get suggestedPitchRange(){if(!n(e).snapshot)return null;const t=3,i=n(e).snapshot.minMidiPitch,s=n(e).snapshot.maxMidiPitch;return i===void 0||s===void 0?null:{minMidi:Math.max(21,i-t+n(e).transpositionSemitones),maxMidi:Math.min(108,s+t+n(e).transpositionSemitones)}},setTransposition(t){n(e).transpositionSemitones=t},transposeUp(){n(e).transpositionSemitones+=1},transposeDown(){n(e).transpositionSemitones-=1},getTransposedMidi(t){return t+n(e).transpositionSemitones},async bringBackToStudentNotation(){if(!n(e).snapshot){console.warn("[HandoffState] No snapshot to bring back");return}const t={...n(e).snapshot,sourceApp:"singing-trainer",createdAt:Date.now(),voices:n(e).snapshot.voices.map(i=>({...i,notes:i.notes.map(s=>({...s,midiPitch:s.midiPitch+n(e).transpositionSemitones}))}))};try{const i=await bi(t);console.log("[HandoffState] Handoff slot written for return",i),_i(i)}catch(i){console.error("[HandoffState] Failed to write return handoff",i)}},clearSnapshot(){B(e,{...St},!0)},reset(){B(e,{...St},!0)}}}const Ae=no();var io=F('<div class="handoff-controls svelte-1izxdqy"><div class="transposition-control svelte-1izxdqy"><button class="transpose-btn svelte-1izxdqy" title="Transpose down">-</button> <span class="transposition-label svelte-1izxdqy"> </span> <button class="transpose-btn svelte-1izxdqy" title="Transpose up">+</button></div> <button class="bring-back-btn svelte-1izxdqy">Bring Back to Student Notation</button></div>'),so=F('<div class="error-banner svelte-1izxdqy"> </div>'),ao=F('<div class="import-info svelte-1izxdqy"><span class="import-label svelte-1izxdqy">Microbeats:</span> <span class="import-value svelte-1izxdqy"> </span></div>'),oo=F('<div class="control-group svelte-1izxdqy"><h3 class="control-group-title svelte-1izxdqy">Imported Material</h3> <div class="import-info svelte-1izxdqy"><span class="import-label svelte-1izxdqy">Voices:</span> <span class="import-value svelte-1izxdqy"> </span></div> <div class="import-info svelte-1izxdqy"><span class="import-label svelte-1izxdqy">Tempo:</span> <span class="import-value svelte-1izxdqy"> </span></div> <!></div>'),ro=F('<div class="app svelte-1izxdqy"><header class="header svelte-1izxdqy"><h1 class="title svelte-1izxdqy">Singing Trainer</h1> <div class="header-controls svelte-1izxdqy"><!></div></header> <!> <main class="main svelte-1izxdqy"><aside class="sidebar sidebar--left svelte-1izxdqy"><div class="control-group svelte-1izxdqy"><!></div> <div class="control-group svelte-1izxdqy"><!></div> <div class="control-group svelte-1izxdqy"><!></div> <div class="control-group svelte-1izxdqy"><details class="settings-details svelte-1izxdqy"><summary class="settings-summary svelte-1izxdqy">Settings</summary> <div class="settings-content svelte-1izxdqy"><!> <!> <!></div></details></div> <div class="control-group svelte-1izxdqy"><!></div> <!></aside> <section class="canvas-area svelte-1izxdqy"><!></section></main> <!></div>');function lo(e,t){Te(t,!0);let i=J(!1);Re(()=>fe.onPerformanceComplete(z=>{if(Y.state.isActive&&Y.state.isPlaying){const Z=Ie.calculateSummary(z,Y.state.targetNotes);Ie.show(Z,{title:Y.title,artist:Y.artist,source:"ultrastar"}),Y.setPlaying(!1)}}));function s(){Ie.state.source==="ultrastar"?(fe.reset(),fe.setTargetNotes(Y.state.targetNotes),K.setVisualizationMode("highway")):Ie.state.source}_n(async()=>{if(await Ae.checkAndConsumeHandoff()){console.log("[App] Handoff detected and processed");const z=Ae.suggestedPitchRange;z&&K.setYAxisRange(z)}try{await Ns(),K.setDetecting(!0),console.log("[App] Pitch detection auto-started")}catch(z){console.error("[App] Failed to auto-start pitch detection:",z)}}),ze(()=>{Ds()});const o=N(()=>Ae.state.hasImportedSnapshot),a=N(()=>Ae.state.transpositionSemitones),r=N(()=>Ae.state.error);function c(){Ae.bringBackToStudentNotation()}function l(){Ae.transposeUp()}function u(){Ae.transposeDown()}var f=ro(),g=b(f),h=P(b(g),2),p=b(h);{var m=Q=>{var z=io(),Z=b(z),L=b(Z);L.__click=u;var R=P(L,2),j=b(R),ee=P(R,2);ee.__click=l;var ce=P(Z,2);ce.__click=c,te(()=>G(j,`${n(a)>=0?"+":""}${n(a)??""}`)),E(Q,z)};le(p,Q=>{n(o)&&Q(m)})}var d=P(g,2);{var v=Q=>{var z=so(),Z=b(z);te(()=>G(Z,n(r))),E(Q,z)};le(d,Q=>{n(r)&&Q(v)})}var y=P(d,2),w=b(y),_=b(w),I=b(_);Ya(I,{});var C=P(_,2),M=b(C);oa(M,{});var S=P(C,2),D=b(S);Wa(D,{});var x=P(S,2),H=b(x),X=P(b(H),2),V=b(X);Ws(V,{});var ne=P(V,2);qs(ne,{});var $=P(ne,2);ea($,{});var A=P(x,2),W=b(A);Qs(W,{});var U=P(A,2);{var se=Q=>{var z=oo(),Z=P(b(z),2),L=P(b(Z),2),R=b(L),j=P(Z,2),ee=P(b(j),2),ce=b(ee),ve=P(j,2);{var he=ue=>{var q=ao(),ie=P(b(q),2),T=b(ie);te(()=>G(T,Ae.timeGrid.microbeatCount)),E(ue,q)};le(ve,ue=>{Ae.timeGrid&&ue(he)})}te(()=>{G(R,Ae.voices.length),G(ce,`${Ae.tempo??""} BPM`)}),E(Q,z)};le(U,Q=>{n(o)&&Q(se)})}var me=P(w,2),ye=b(me);ps(ye,{});var we=P(y,2);to(we,{onRetry:s}),Tn("open","toggle",H,Q=>B(i,Q),()=>n(i)),E(e,f),Pe()}Se(["click"]);function co(e){const t=li(lo,{target:e});return{destroy:()=>{t.$destroy()}}}const gn=document.getElementById("app");gn&&co(gn);
