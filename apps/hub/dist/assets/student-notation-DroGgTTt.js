import"./modulepreload-polyfill-B5Qt9EMX.js";import{T as jt,o as me,P as oe,r as $e,S as oA,G as Gt,c as Cu,a as $r,M as cg,b as zo,d as dg,O as Xl,A as ug,e as hg,V as el,f as fg,g as gg,n as $l,h as bs,i as mg,W as pg,w as Bg,j as wg,k as Al,l as vg,m as Cg,p as He,q as bg,s as yg,t as Sg,u as Dt,v as Yl,x as ys,y as Eg,z as Yr,B as st,C as Qg,D as Kt,E as Vi,F as Fg,H as Ig,I as aA,J as xg,K as Ug,L as Mg,N as yA,Q as Jl,R as jl,U as te,X as Tg,Y as Pg,Z as Lg,_ as gA,$ as mA,a0 as nl,a1 as Hg,a2 as Dg,a3 as Ng,a4 as Rg,a5 as kg}from"./navigation-Dpq1k5cw.js";import{e as _g,p as Ye,h as Rt,i as Bn,u as Og,f as sl,c as DA,s as Hn,t as zi,a as qi,j as Je,g as rt,k as Bt,l as Xi,d as tA,n as Kg,m as Gg}from"./legacy-BJBcSenI.js";const Wg="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAAAXNSR0IArs4c6QAACC9JREFUeF7tnU9rXFUcQH93Jgm0iVXQrQtFIaAJdSvu9QNY/PMt/Br6BRR1objShXRjSlxLK1QRBXEnqYKplNTWRsR05sqb9KWvw5vJmzb32HFONk0mM+/enHc4eZle7kvb79/M4UdRAsNI8eyfP8cw9YqO48EjkkKX10ChyzOuR1BogLVCA5DvDKHQAGuFBiArNAdZoTnWFhpgrdAAZAvNQVZojrWFBlgrNADZQnOQFZpjbaEB1goNQLbQHGSF5lhbaIC1QgOQLTQHWaE51hYaYK3QAGQLzUEeRIqnb+242g5AbqEByL2c46e1U9EfjZUiolqxW/3b9tH83vjzpr2ueaxpr5tl7Hq+1b+zvK75s7FzVmhI6O8ePXNHaGDABR5CoYGTXxVaoQHQ1e89F/iXB63Q5RnXIyg0wFqhAci+y8FBVmiOtYUGWCs0ANlCc5AVmmNtoQHWCg1AttAcZIXmWFtogLVCA5AtNAdZoTnWFhpgrdAAZAvNQVZojnX64oObuV4bNR/rqQ7hzNOcK6F/OOPiJELr9Nb5/dHuoylHHJndGHn88ebX9eeTntPl8Unjjv/wbWPNy5yHOcdTf6+28iVO8iKNkV6/8Jfb6RY+44PI8dIfp2M4aQl04fEX6fAKDZxthQYg138UWujysBW6PON6BAsNsFZoALKF5iArNMfaQgOsFRqAbKE5yArNsbbQAGuFBiBbaA6yQnOsLTTAWqEByBaag6zQHGsLDbBWaACyheYgKzTH2kIDrCuhX7xxKgaNxUnTVhlW32v7aFsNOWn6sx6jy6rHeZizQgNCL+UUF9auxHK+e/P649aet01rlsV6k5ZQdtnzdBKSeZizQgNC93OKrbWdWIq7QgPDLuQQCg2cdoUGIPtHIQdZoTnWFhpgrdAAZAvNQVZojrWFBlgrNADZQnOQFZpjbaEB1goNQLbQHGSF5lhbaIC1QgOQLTQHWaE51hYaYK3QAGQLzUFWaI51enX7+mhh1v3ckbl+zaQ7S3d5vOvdrNvGmpc5V0J/eXrXxUmA1+mFi1tu1lgc9CB+PViPlIbFR1r0AdLGpfMKXdiCFIP47Z9NhS7MuTq8QhOQFRqgfDiEQgOoLTQAuX6Xw0uO8rAVujzjegQLDbBWaACyhQYhew2NwbbQAGoLDUC20CBkC43BttAAagsNQLbQIGQLjcG20ABqCw1AttAgZAuNwbbQAGoLDUC20CDkUaE3oudqu+LQLXRxxBGDSLF+cC1ySpGj3v+zuchx2mNtE6xf29xLtO2x8dceN2b1/OqYzZXm458f/SfznU/ajvnfzVmhAaFvRy9eObgcg9QHRlvsIRQaOP8KDUD2GpqDrNAcawsNsFZoALKF5iArNMfaQgOsFRqAbKE5yArNsbbQAGuFBiBbaA6yQnOsLTTAWqEByBaag6zQHGsLDbBWaACyheYgKzTHOp299Pk9e9vNw/2cx/E87HM+iF68fPBt3HZxUnGz00fbb9wjdL14sG3kaTc+7zrTWY8xbT71mA/7nPt5EBdXN6Mf7j7a1ZP7fV76ZPs1dx+9X3odX9fLg/hq9axCd+T1IE9T6Aeh1/G1Ct0R1Ak8TaFPAOJxh1Do4wid3PcV+uRYTjySQgOQ67ftvIYuD1uhyzM+eoNAocvDVujyjBWaYxwKzcH2GhpgrdAAZK+hOcgKzbG20ABrhQYgW2gOskJzrC00wFqhAcgWmoOs0BxrCw2wrlbbfX16w8VJAGuFBiAPUopnblyPYaoXzx634LW5k+j47p5dFkeOH7/59SxjV3AmzaUJbtrxuywAro51MnNWaEjozb3dGKYeMNpiD6HQwPmvCq3QAOiq867lKA9aocszdi0HxzgUmoNtoQHWCg1A9n1oDrJCc6wtNMBaoQHIFpqDrNAcawsNsFZoALKF5iArNMfaQgOsFRqAbKE5yArNsbbQAGuFBiDXhf50y73tSuMepIj1G1ddnFQadLWWY+fDc/noXuXjKxOPu8/6+Fais9xTfdI90asfum3F4aR7qs/BnFNOcfWx36OXXW1X2um0+965LgtsS8/jf338NExx5QmFJk6yQgOUFRqAXF9DW+jysBW6PON6BAsNsFZoALKFBiF7DY3BttAAagsNQLbQIGQLjcG20ABqCw1AttAgZAuNwbbQAGoLDUC20CBkC43BttAAagsNQLbQIGQLjcG20ADqqtC/PH4tennSnc6BSSzIEAoNnOgcw1jbfy4iefP60rgVujTh0Ya0w3jk1vMKDbBWaACyQgOQ/aOQg6zQHGsLDbBWaACyheYgKzTH2kIDrBUagGyhOcgKzbG20ABrhQYgW2gOskJzrC00wFqhAcgWmoOs0BxrCw2wVmgAsoXmICs0xzrtvvtmPryf87QdEpsTau7gWGK3xrYdIqvxZ9mtcdoOjvycR0Lvr7s4CfA67b3zsZs1Fgfdi5X+jxHRLz7Sog+Qrr/9mUIXtiDnXqwsf6PQhTmPfo8rdHnKCl2ecT2CQgOsFRqAXL/LYaHLw1bo8owtNMc4FJqD7SUHwFqhAchecnCQFZpjbaEB1goNQLbQHGSF5lhbaIC1QgOQLTQHWaE51hYaYK3QAGQLzUFWaI61hQZYV0IvLX/v4iSAtUITkPMw9laejBTuPloat0KXJlwtacyDuLqyGT2FLk5boYsjVmgA8dEQCg3QttAAZN/lACF7yYHBttAAagsNQLbQIGQLjcG20ABqCw1AttAgZAuNwbbQAGoLDUC20CBkC43BttAAagsNQLbQIGQLjcG20ABqCw1AttAgZAuNwf4X8h6Lm5rywjsAAAAASUVORK5CYII=",Vg="/assets/clear-BoKs1BI5.svg",zg="data:image/svg+xml,%3csvg%20class='diamond-icon'%20viewBox='0%200%20120%20120'%20aria-hidden='true'%20focusable='false'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M60%205%20L35%2048.3%20L35%2071.7%20L60%20115%20L85%2071.7%20L85%2048.3%20Z'%20/%3e%3c/svg%3e",qg="/assets/eraser-vjnwKGf-.svg",Xg="data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20fill='none'%20stroke='currentColor'%20stroke-width='2'%20stroke-dasharray='3%202'%20xmlns='http://www.w3.org/2000/svg'%3e%3cellipse%20cx='12'%20cy='12'%20rx='8'%20ry='6'%20transform='rotate(-15%2012%2012)'/%3e%3c/svg%3e",$g="/assets/loop-DCKCNdJ9.svg",Yg="data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20fill='none'%20stroke='currentColor'%20stroke-width='2'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M18%202L6%2014l-2%206%206-2L22%206l-4-4z'/%3e%3cline%20x1='14'%20y1='6'%20x2='18'%20y2='10'/%3e%3c/svg%3e",Jg="/assets/pause-BvM7-xog.svg",jg="/assets/play-z9TE0FgS.svg",Zg="/assets/redo-C3TqBHBd.svg",tm="/assets/settings-TJsqx0gz.svg",em="/assets/stop-BU_KSLYe.svg",Am="/assets/undo-D1s0pqx2.svg",nm="/assets/volume-BF7HNWqG.svg",sm="/assets/zoomIn-CqIKlW7B.svg",rm="/assets/zoomOut-Cm9mM1qf.svg",im="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%20fill='none'%20stroke='currentColor'%20stroke-width='2'%20stroke-linecap='round'%20stroke-linejoin='round'%3e%3c!--%20Grid%20pattern%20--%3e%3cline%20x1='3'%20y1='3'%20x2='3'%20y2='21'%20/%3e%3cline%20x1='9'%20y1='3'%20x2='9'%20y2='21'%20/%3e%3cline%20x1='15'%20y1='3'%20x2='15'%20y2='21'%20/%3e%3cline%20x1='21'%20y1='3'%20x2='21'%20y2='21'%20/%3e%3cline%20x1='3'%20y1='6'%20x2='21'%20y2='6'%20/%3e%3cline%20x1='3'%20y1='12'%20x2='21'%20y2='12'%20/%3e%3cline%20x1='3'%20y1='18'%20x2='21'%20y2='18'%20/%3e%3c!--%20Eye%20with%20slash%20(hide)%20--%3e%3cpath%20d='M1%201%20L23%2023'%20stroke-width='2.5'/%3e%3c/svg%3e",om="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%20fill='none'%20stroke='currentColor'%20stroke-width='2'%20stroke-linecap='round'%20stroke-linejoin='round'%3e%3c!--%20Drum%20pattern%20--%3e%3cellipse%20cx='12'%20cy='7'%20rx='7'%20ry='3'/%3e%3cpath%20d='M%205%207%20L%205%2017%20Q%205%2020%2012%2020%20Q%2019%2020%2019%2017%20L%2019%207'/%3e%3cline%20x1='8'%20y1='10'%20x2='8'%20y2='16'/%3e%3cline%20x1='16'%20y1='10'%20x2='16'%20y2='16'/%3e%3c!--%20Slash%20(hide)%20--%3e%3cpath%20d='M2%202%20L22%2022'%20stroke-width='2.5'/%3e%3c/svg%3e",am="/assets/newPage-C3DkqRnq.svg",lm="/assets/open-yWU2irvQ.svg",cm="/assets/print-y0OmDKSR.svg",dm="/assets/saveAs-DyEXJ3e_.svg",um="/assets/dottedQuarterNote-Cf79kpGq.svg",hm="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='168'%20zoomAndPan='magnify'%20viewBox='0%200%20126%20231.75'%20height='309'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='f11b48ab54'%3e%3cpath%20d='M%200.0664062%200%20L%20125%200%20L%20125%20230.75%20L%200.0664062%20230.75%20Z%20M%200.0664062%200%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='9738701237'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23f11b48ab54)'%3e%3cpath%20style='%20stroke:none;fill-rule:nonzero;fill:%23000000;fill-opacity:1;'%20d='M%208.109375%20225.367188%20C%20-6.25%20212.289062%201.699219%20191.523438%2025.289062%20179.214844%20C%2033.234375%20175.371094%2039.132812%20173.574219%2049.386719%20173.832031%20C%2055.796875%20174.089844%2062.976562%20177.679688%2062.976562%20177.679688%20C%2062.976562%20131.273438%2062.71875%2043.585938%2062.71875%200.511719%20C%2065.285156%200.511719%2067.078125%200.257812%2070.667969%200.257812%20C%2070.667969%202.820312%2070.667969%204.871094%2070.667969%206.921875%20C%2070.667969%209.230469%2070.667969%2010.511719%2070.925781%2012.050781%20C%2073.488281%2028.203125%2077.078125%2034.613281%2095.023438%2054.355469%20C%20117.84375%2079.738281%20124.511719%2094.863281%20124.511719%20115.121094%20C%20124.253906%20134.09375%20107.589844%20174.601562%20104%20173.0625%20C%20109.125%20158.707031%20116.304688%20143.320312%20118.101562%20130.503906%20C%20120.40625%20114.863281%20114%2092.8125%20103.742188%2081.277344%20C%2095.539062%2071.53125%2076.050781%2063.070312%2070.667969%2063.070312%20C%2070.667969%2063.070312%2070.410156%20156.398438%2070.410156%20191.78125%20C%2070.410156%20197.675781%2065.027344%20208.1875%2061.949219%20211.777344%20C%2047.847656%20228.699219%2020.414062%20236.390625%208.109375%20225.367188%20Z%20M%208.109375%20225.367188%20'/%3e%3c/g%3e%3c/g%3e%3c/svg%3e",fm="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%3e%3ccircle%20cx='12'%20cy='12'%20r='10'%20stroke='currentColor'%20stroke-width='1.5'%20fill='none'/%3e%3cpath%20d='M%2012%2012%20L%2022%2012%20A%2010%2010%200%200%200%2012%202%20Z'%20fill='currentColor'/%3e%3c/svg%3e",gm="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%3e%3ccircle%20cx='12'%20cy='12'%20r='10'%20stroke='currentColor'%20stroke-width='1.5'%20fill='none'/%3e%3cpath%20d='M%2012%2012%20L%2022%2012%20A%2010%2010%200%200%200%2012%202%20Z'%20fill='currentColor'%20transform='rotate(180,%2012,%2012)'/%3e%3c/svg%3e",mm="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%3e%3ccircle%20cx='12'%20cy='12'%20r='10'%20stroke='currentColor'%20stroke-width='1.5'%20fill='none'/%3e%3cpath%20d='M%2012%2012%20L%2022%2012%20A%2010%2010%200%200%200%2012%202%20Z'%20fill='currentColor'%20transform='rotate(270,%2012,%2012)'/%3e%3c/svg%3e",pm="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2024%2024'%3e%3ccircle%20cx='12'%20cy='12'%20r='10'%20stroke='currentColor'%20stroke-width='1.5'%20fill='none'/%3e%3cpath%20d='M%2012%2012%20L%2022%2012%20A%2010%2010%200%200%200%2012%202%20Z'%20fill='currentColor'%20transform='rotate(90,%2012,%2012)'/%3e%3c/svg%3e",Bm="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='111'%20zoomAndPan='magnify'%20viewBox='0%200%2083.25%20230.999992'%20height='308'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='084e4edff4'%3e%3cpath%20d='M%201%20165%20L%2081.761719%20165%20L%2081.761719%20229.226562%20L%201%20229.226562%20Z%20M%201%20165%20'/%3e%3c/clipPath%3e%3cclipPath%20id='fdeab4882e'%3e%3cpath%20d='M%2073%201.03125%20L%2081.761719%201.03125%20L%2081.761719%20192%20L%2073%20192%20Z%20M%2073%201.03125%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='45713f1632'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23084e4edff4)'%3e%3cpath%20style='%20stroke:none;fill-rule:evenodd;fill:%23000000;fill-opacity:0.9;'%20d='M%2057.546875%20222.390625%20C%2076.429688%20212.289062%2086.492188%20194.003906%2080.304688%20180.25%20C%2073.699219%20165.578125%2051.011719%20161.4375%2029.660156%20171.003906%20C%208.308594%20180.574219%20-3.664062%20200.25%202.9375%20214.921875%20C%209.542969%20229.59375%2032.230469%20233.734375%2053.582031%20224.164062%20C%2054.917969%20223.566406%2056.285156%20223.0625%2057.546875%20222.390625%20Z%20M%2057.546875%20222.390625%20'/%3e%3c/g%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23fdeab4882e)'%3e%3cpath%20style='fill:none;stroke-width:1.5;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%20299.504676%20305.984569%20L%20299.504676%20339.572267%20'%20transform='matrix(-5.561147,0,0,-5.549953,1743.335656,1885.43835)'/%3e%3c/g%3e%3c/g%3e%3c/svg%3e",wm="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='456e80bb30'%3e%3cpath%20d='M%2017.898438%2024.675781%20L%20111.859375%2024.675781%20L%20111.859375%20118.640625%20L%2017.898438%20118.640625%20Z%20M%2017.898438%2024.675781%20'/%3e%3c/clipPath%3e%3cclipPath%20id='87c9148330'%3e%3cpath%20d='M%2064.878906%2024.675781%20C%2038.933594%2024.675781%2017.898438%2045.710938%2017.898438%2071.660156%20C%2017.898438%2097.605469%2038.933594%20118.640625%2064.878906%20118.640625%20C%2090.828125%20118.640625%20111.859375%2097.605469%20111.859375%2071.660156%20C%20111.859375%2045.710938%2090.828125%2024.675781%2064.878906%2024.675781%20Z%20M%2064.878906%2024.675781%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='d7032f28cc'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23456e80bb30)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%2387c9148330)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%20-0.00202662%20C%2028.250074%20-0.00202662%200.0009548%2028.247092%200.0009548%2063.095541%20C%200.0009548%2097.938745%2028.250074%20126.187864%2063.093277%20126.187864%20C%2097.941726%20126.187864%20126.185599%2097.938745%20126.185599%2063.095541%20C%20126.185599%2028.247092%2097.941726%20-0.00202662%2063.093277%20-0.00202662%20Z%20M%2063.093277%20-0.00202662%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.67729)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(44.895794,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%2017.8125%200%20L%2017.8125%20-40.09375%20L%204.203125%20-40.09375%20L%204.203125%20-51.09375%20C%207.367188%20-51.09375%209.992188%20-51.253906%2012.078125%20-51.578125%20C%2014.171875%20-51.910156%2015.914062%20-52.6875%2017.3125%20-53.90625%20C%2018.71875%20-55.132812%2019.957031%20-57.09375%2021.03125%20-59.78125%20L%2031.3125%20-59.78125%20L%2031.3125%200%20Z%20M%2017.8125%200%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",vm="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='af2f53afe5'%3e%3cpath%20d='M%2017.898438%2024.566406%20L%20111.859375%2024.566406%20L%20111.859375%20118.527344%20L%2017.898438%20118.527344%20Z%20M%2017.898438%2024.566406%20'/%3e%3c/clipPath%3e%3cclipPath%20id='c8dd529e93'%3e%3cpath%20d='M%2064.878906%2024.566406%20C%2038.933594%2024.566406%2017.898438%2045.601562%2017.898438%2071.546875%20C%2017.898438%2097.496094%2038.933594%20118.527344%2064.878906%20118.527344%20C%2090.828125%20118.527344%20111.859375%2097.496094%20111.859375%2071.546875%20C%20111.859375%2045.601562%2090.828125%2024.566406%2064.878906%2024.566406%20Z%20M%2064.878906%2024.566406%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='4829c2bf70'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23af2f53afe5)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23c8dd529e93)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%200.00130943%20C%2028.250074%200.00130943%200.0009548%2028.250428%200.0009548%2063.093632%20C%200.0009548%2097.942081%2028.250074%20126.185954%2063.093277%20126.185954%20C%2097.941726%20126.185954%20126.185599%2097.942081%20126.185599%2063.093632%20C%20126.185599%2028.250428%2097.941726%200.00130943%2063.093277%200.00130943%20Z%20M%2063.093277%200.00130943%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.565431)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(38.720147,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%203.046875%200%20L%203.046875%20-11.1875%20C%2010.921875%20-16.726562%2017.179688%20-21.421875%2021.828125%20-25.265625%20C%2026.484375%20-29.117188%2029.835938%20-32.507812%2031.890625%20-35.4375%20C%2033.953125%20-38.363281%2034.984375%20-41.109375%2034.984375%20-43.671875%20C%2034.984375%20-45.992188%2034.160156%20-47.75%2032.515625%20-48.9375%20C%2030.878906%20-50.132812%2028.957031%20-50.734375%2026.75%20-50.734375%20C%2024.90625%20-50.734375%2023.085938%20-50.210938%2021.296875%20-49.171875%20C%2019.503906%20-48.128906%2018.28125%20-46.207031%2017.625%20-43.40625%20L%205.28125%20-47.875%20C%206.894531%20-52.050781%209.664062%20-55.253906%2013.59375%20-57.484375%20C%2017.53125%20-59.722656%2022.125%20-60.84375%2027.375%20-60.84375%20C%2031.4375%20-60.84375%2035.078125%20-60.171875%2038.296875%20-58.828125%20C%2041.515625%20-57.492188%2044.046875%20-55.523438%2045.890625%20-52.921875%20C%2047.742188%20-50.328125%2048.671875%20-47.15625%2048.671875%20-43.40625%20C%2048.671875%20-37.375%2046.148438%20-31.773438%2041.109375%20-26.609375%20C%2036.078125%20-21.453125%2029.175781%20-16.3125%2020.40625%20-11.1875%20L%2048.953125%20-11.1875%20L%2048.953125%200%20Z%20M%203.046875%200%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",Cm="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='0551ece328'%3e%3cpath%20d='M%2017.898438%2024.675781%20L%20111.859375%2024.675781%20L%20111.859375%20118.640625%20L%2017.898438%20118.640625%20Z%20M%2017.898438%2024.675781%20'/%3e%3c/clipPath%3e%3cclipPath%20id='073daee785'%3e%3cpath%20d='M%2064.878906%2024.675781%20C%2038.933594%2024.675781%2017.898438%2045.710938%2017.898438%2071.660156%20C%2017.898438%2097.605469%2038.933594%20118.640625%2064.878906%20118.640625%20C%2090.828125%20118.640625%20111.859375%2097.605469%20111.859375%2071.660156%20C%20111.859375%2045.710938%2090.828125%2024.675781%2064.878906%2024.675781%20Z%20M%2064.878906%2024.675781%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='04a7d7f831'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%230551ece328)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23073daee785)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%20-0.00202662%20C%2028.250074%20-0.00202662%200.0009548%2028.247092%200.0009548%2063.095541%20C%200.0009548%2097.938745%2028.250074%20126.187864%2063.093277%20126.187864%20C%2097.941726%20126.187864%20126.185599%2097.938745%20126.185599%2063.095541%20C%20126.185599%2028.247092%2097.941726%20-0.00202662%2063.093277%20-0.00202662%20Z%20M%2063.093277%20-0.00202662%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.67729)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(37.869539,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%2026.046875%201.078125%20C%2022.703125%201.078125%2019.492188%200.597656%2016.421875%20-0.359375%20C%2013.347656%20-1.316406%2010.644531%20-2.789062%208.3125%20-4.78125%20C%205.988281%20-6.78125%204.203125%20-9.363281%202.953125%20-12.53125%20L%2015.296875%20-17%20C%2016.078125%20-14.082031%2017.507812%20-12.023438%2019.59375%20-10.828125%20C%2021.6875%20-9.628906%2023.953125%20-9.03125%2026.390625%20-9.03125%20C%2029.203125%20-9.03125%2031.441406%20-9.71875%2033.109375%20-11.09375%20C%2034.773438%20-12.46875%2035.609375%20-14.378906%2035.609375%20-16.828125%20C%2035.609375%20-19.265625%2034.832031%20-21.15625%2033.28125%20-22.5%20C%2031.738281%20-23.84375%2029.695312%20-24.769531%2027.15625%20-25.28125%20C%2024.625%20-25.789062%2021.863281%20-26.046875%2018.875%20-26.046875%20L%2018.875%20-35.53125%20C%2024.007812%20-35.53125%2027.960938%20-36.242188%2030.734375%20-37.671875%20C%2033.515625%20-39.109375%2034.90625%20-41.140625%2034.90625%20-43.765625%20C%2034.90625%20-46.085938%2033.960938%20-47.828125%2032.078125%20-48.984375%20C%2030.203125%20-50.148438%2028.039062%20-50.734375%2025.59375%20-50.734375%20C%2023.382812%20-50.734375%2021.351562%20-50.195312%2019.5%20-49.125%20C%2017.65625%20-48.050781%2016.4375%20-46.144531%2015.84375%20-43.40625%20L%203.578125%20-47.875%20C%204.773438%20-50.914062%206.535156%20-53.390625%208.859375%20-55.296875%20C%2011.179688%20-57.210938%2013.863281%20-58.613281%2016.90625%20-59.5%20C%2019.945312%20-60.394531%2023.109375%20-60.84375%2026.390625%20-60.84375%20C%2029.140625%20-60.84375%2031.828125%20-60.546875%2034.453125%20-59.953125%20C%2037.078125%20-59.359375%2039.445312%20-58.421875%2041.5625%20-57.140625%20C%2043.6875%20-55.859375%2045.390625%20-54.242188%2046.671875%20-52.296875%20C%2047.953125%20-50.359375%2048.59375%20-48.050781%2048.59375%20-45.375%20C%2048.59375%20-42.144531%2047.726562%20-39.320312%2046%20-36.90625%20C%2044.269531%20-34.488281%2042.359375%20-32.6875%2040.265625%20-31.5%20C%2042.234375%20-30.78125%2043.914062%20-29.644531%2045.3125%20-28.09375%20C%2046.71875%20-26.539062%2047.78125%20-24.835938%2048.5%20-22.984375%20C%2049.21875%20-21.140625%2049.578125%20-19.296875%2049.578125%20-17.453125%20C%2049.578125%20-13.273438%2048.472656%20-9.828125%2046.265625%20-7.109375%20C%2044.054688%20-4.398438%2041.160156%20-2.359375%2037.578125%20-0.984375%20C%2034.003906%200.390625%2030.160156%201.078125%2026.046875%201.078125%20Z%20M%2026.046875%201.078125%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",bm="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='0f524ef70a'%3e%3cpath%20d='M%2017.898438%2024.675781%20L%20111.859375%2024.675781%20L%20111.859375%20118.640625%20L%2017.898438%20118.640625%20Z%20M%2017.898438%2024.675781%20'/%3e%3c/clipPath%3e%3cclipPath%20id='786a2dceed'%3e%3cpath%20d='M%2064.878906%2024.675781%20C%2038.933594%2024.675781%2017.898438%2045.710938%2017.898438%2071.660156%20C%2017.898438%2097.605469%2038.933594%20118.640625%2064.878906%20118.640625%20C%2090.828125%20118.640625%20111.859375%2097.605469%20111.859375%2071.660156%20C%20111.859375%2045.710938%2090.828125%2024.675781%2064.878906%2024.675781%20Z%20M%2064.878906%2024.675781%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='1bb9b822db'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%230f524ef70a)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23786a2dceed)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%20-0.00202662%20C%2028.250074%20-0.00202662%200.0009548%2028.247092%200.0009548%2063.095541%20C%200.0009548%2097.938745%2028.250074%20126.187864%2063.093277%20126.187864%20C%2097.941726%20126.187864%20126.185599%2097.938745%20126.185599%2063.095541%20C%20126.185599%2028.247092%2097.941726%20-0.00202662%2063.093277%20-0.00202662%20Z%20M%2063.093277%20-0.00202662%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.67729)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(36.937365,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%2031.140625%200%20L%2031.140625%20-12.625%20L%202.0625%20-12.625%20L%202.0625%20-22.546875%20L%2031.140625%20-59.78125%20L%2044.75%20-59.78125%20L%2044.75%20-24.609375%20L%2052.96875%20-24.609375%20L%2052.96875%20-12.625%20L%2044.75%20-12.625%20L%2044.75%200%20Z%20M%2016.828125%20-24.609375%20L%2031.140625%20-24.609375%20L%2031.140625%20-41.96875%20Z%20M%2016.828125%20-24.609375%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",ym="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='0d82974cc8'%3e%3cpath%20d='M%2017.898438%2024.789062%20L%20111.859375%2024.789062%20L%20111.859375%20118.753906%20L%2017.898438%20118.753906%20Z%20M%2017.898438%2024.789062%20'/%3e%3c/clipPath%3e%3cclipPath%20id='37694f020a'%3e%3cpath%20d='M%2064.878906%2024.789062%20C%2038.933594%2024.789062%2017.898438%2045.824219%2017.898438%2071.769531%20C%2017.898438%2097.71875%2038.933594%20118.753906%2064.878906%20118.753906%20C%2090.828125%20118.753906%20111.859375%2097.71875%20111.859375%2071.769531%20C%20111.859375%2045.824219%2090.828125%2024.789062%2064.878906%2024.789062%20Z%20M%2064.878906%2024.789062%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='22003a5ccc'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%230d82974cc8)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%2337694f020a)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%20-0.000119013%20C%2028.250074%20-0.000119013%200.0009548%2028.249%200.0009548%2063.092203%20C%200.0009548%2097.940652%2028.250074%20126.189771%2063.093277%20126.189771%20C%2097.941726%20126.189771%20126.185599%2097.940652%20126.185599%2063.092203%20C%20126.185599%2028.249%2097.941726%20-0.000119013%2063.093277%20-0.000119013%20Z%20M%2063.093277%20-0.000119013%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.789151)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(37.55493,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%2026.390625%201.078125%20C%2021.203125%201.078125%2016.59375%20-0.0664062%2012.5625%20-2.359375%20C%208.539062%20-4.660156%205.578125%20-8.019531%203.671875%20-12.4375%20L%2015.484375%20-16.734375%20C%2016.316406%20-13.804688%2017.671875%20-11.789062%2019.546875%20-10.6875%20C%2021.429688%20-9.582031%2023.476562%20-9.03125%2025.6875%20-9.03125%20C%2028.84375%20-9.03125%2031.4375%20-9.957031%2033.46875%20-11.8125%20C%2035.5%20-13.664062%2036.515625%20-16.320312%2036.515625%20-19.78125%20C%2036.515625%20-23.476562%2035.453125%20-26.191406%2033.328125%20-27.921875%20C%2031.210938%20-29.648438%2028.753906%20-30.515625%2025.953125%20-30.515625%20C%2021.535156%20-30.515625%2018.253906%20-28.578125%2016.109375%20-24.703125%20L%204.03125%20-29.171875%20L%207.78125%20-59.78125%20L%2047.78125%20-59.78125%20L%2047.78125%20-48.671875%20L%2019.0625%20-48.671875%20L%2017.71875%20-37.5%20C%2019.09375%20-38.507812%2020.894531%20-39.28125%2023.125%20-39.8125%20C%2025.363281%20-40.351562%2027.53125%20-40.625%2029.625%20-40.625%20C%2033.195312%20-40.625%2036.578125%20-39.847656%2039.765625%20-38.296875%20C%2042.960938%20-36.742188%2045.5625%20-34.429688%2047.5625%20-31.359375%20C%2049.5625%20-28.285156%2050.5625%20-24.425781%2050.5625%20-19.78125%20C%2050.5625%20-15.238281%2049.441406%20-11.414062%2047.203125%20-8.3125%20C%2044.960938%20-5.21875%2042.007812%20-2.878906%2038.34375%20-1.296875%20C%2034.675781%200.285156%2030.691406%201.078125%2026.390625%201.078125%20Z%20M%2026.390625%201.078125%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",Sm="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='2a134d5da5'%3e%3cpath%20d='M%2017.898438%2024.675781%20L%20111.859375%2024.675781%20L%20111.859375%20118.640625%20L%2017.898438%20118.640625%20Z%20M%2017.898438%2024.675781%20'/%3e%3c/clipPath%3e%3cclipPath%20id='1436cb12ac'%3e%3cpath%20d='M%2064.878906%2024.675781%20C%2038.933594%2024.675781%2017.898438%2045.710938%2017.898438%2071.660156%20C%2017.898438%2097.605469%2038.933594%20118.640625%2064.878906%20118.640625%20C%2090.828125%20118.640625%20111.859375%2097.605469%20111.859375%2071.660156%20C%20111.859375%2045.710938%2090.828125%2024.675781%2064.878906%2024.675781%20Z%20M%2064.878906%2024.675781%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='0d388df51e'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%232a134d5da5)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%231436cb12ac)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%20-0.00202662%20C%2028.250074%20-0.00202662%200.0009548%2028.247092%200.0009548%2063.095541%20C%200.0009548%2097.938745%2028.250074%20126.187864%2063.093277%20126.187864%20C%2097.941726%20126.187864%20126.185599%2097.938745%20126.185599%2063.095541%20C%20126.185599%2028.247092%2097.941726%20-0.00202662%2063.093277%20-0.00202662%20Z%20M%2063.093277%20-0.00202662%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.67729)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(36.669365,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%2028.71875%201.078125%20C%2023%201.078125%2018.363281%20-0.113281%2014.8125%20-2.5%20C%2011.257812%20-4.882812%208.660156%20-8.222656%207.015625%20-12.515625%20C%205.378906%20-16.816406%204.5625%20-21.769531%204.5625%20-27.375%20C%204.5625%20-31.675781%205.035156%20-35.820312%205.984375%20-39.8125%20C%206.941406%20-43.8125%208.453125%20-47.390625%2010.515625%20-50.546875%20C%2012.578125%20-53.710938%2015.242188%20-56.21875%2018.515625%20-58.0625%20C%2021.796875%20-59.914062%2025.765625%20-60.84375%2030.421875%20-60.84375%20C%2034.953125%20-60.84375%2038.738281%20-60.050781%2041.78125%20-58.46875%20C%2044.832031%20-56.894531%2047.128906%20-54.796875%2048.671875%20-52.171875%20L%2036.515625%20-47.78125%20C%2035.910156%20-48.800781%2034.984375%20-49.59375%2033.734375%20-50.15625%20C%2032.484375%20-50.71875%2031.082031%20-51%2029.53125%20-51%20C%2026.363281%20-51%2023.78125%20-49.789062%2021.78125%20-47.375%20C%2019.789062%20-44.96875%2018.796875%20-41.195312%2018.796875%20-36.0625%20C%2020.285156%20-37.4375%2022.054688%20-38.507812%2024.109375%20-39.28125%20C%2026.171875%20-40.0625%2028.664062%20-40.453125%2031.59375%20-40.453125%20C%2035.113281%20-40.453125%2038.40625%20-39.628906%2041.46875%20-37.984375%20C%2044.539062%20-36.347656%2047.015625%20-34.019531%2048.890625%20-31%20C%2050.773438%20-27.988281%2051.71875%20-24.425781%2051.71875%20-20.3125%20C%2051.71875%20-16.195312%2050.734375%20-12.523438%2048.765625%20-9.296875%20C%2046.796875%20-6.078125%2044.082031%20-3.539062%2040.625%20-1.6875%20C%2037.164062%200.15625%2033.195312%201.078125%2028.71875%201.078125%20Z%20M%2028.640625%20-9.03125%20C%2031.554688%20-9.03125%2033.847656%20-10%2035.515625%20-11.9375%20C%2037.191406%20-13.882812%2038.03125%20-16.4375%2038.03125%20-19.59375%20C%2038.03125%20-22.757812%2037.191406%20-25.328125%2035.515625%20-27.296875%20C%2033.847656%20-29.265625%2031.523438%20-30.25%2028.546875%20-30.25%20C%2025.679688%20-30.25%2023.367188%20-29.289062%2021.609375%20-27.375%20C%2019.847656%20-25.46875%2018.96875%20-22.90625%2018.96875%20-19.6875%20C%2018.96875%20-16.46875%2019.847656%20-13.882812%2021.609375%20-11.9375%20C%2023.367188%20-10%2025.710938%20-9.03125%2028.640625%20-9.03125%20Z%20M%2028.640625%20-9.03125%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",Em="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='175'%20zoomAndPan='magnify'%20viewBox='0%200%20131.25%20143.999998'%20height='192'%20preserveAspectRatio='xMidYMid%20meet'%20version='1.2'%3e%3cdefs%3e%3cclipPath%20id='d5d49c9923'%3e%3cpath%20d='M%2017.898438%2024.675781%20L%20111.859375%2024.675781%20L%20111.859375%20118.640625%20L%2017.898438%20118.640625%20Z%20M%2017.898438%2024.675781%20'/%3e%3c/clipPath%3e%3cclipPath%20id='0ef729529e'%3e%3cpath%20d='M%2064.878906%2024.675781%20C%2038.933594%2024.675781%2017.898438%2045.710938%2017.898438%2071.660156%20C%2017.898438%2097.605469%2038.933594%20118.640625%2064.878906%20118.640625%20C%2090.828125%20118.640625%20111.859375%2097.605469%20111.859375%2071.660156%20C%20111.859375%2045.710938%2090.828125%2024.675781%2064.878906%2024.675781%20Z%20M%2064.878906%2024.675781%20'/%3e%3c/clipPath%3e%3c/defs%3e%3cg%20id='926e811c6f'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%23d5d49c9923)'%3e%3cg%20clip-rule='nonzero'%20clip-path='url(%230ef729529e)'%3e%3cpath%20style='fill:none;stroke-width:8;stroke-linecap:butt;stroke-linejoin:miter;stroke:%23000000;stroke-opacity:1;stroke-miterlimit:4;'%20d='M%2063.093277%20-0.00202662%20C%2028.250074%20-0.00202662%200.0009548%2028.247092%200.0009548%2063.095541%20C%200.0009548%2097.938745%2028.250074%20126.187864%2063.093277%20126.187864%20C%2097.941726%20126.187864%20126.185599%2097.938745%20126.185599%2063.095541%20C%20126.185599%2028.247092%2097.941726%20-0.00202662%2063.093277%20-0.00202662%20Z%20M%2063.093277%20-0.00202662%20'%20transform='matrix(0.744631,0,0,0.744631,17.897727,24.67729)'/%3e%3c/g%3e%3c/g%3e%3cg%20style='fill:%23000000;fill-opacity:1;'%3e%3cg%20transform='translate(40.642754,%20101.083803)'%3e%3cpath%20style='stroke:none'%20d='M%207.421875%200%20L%2031.671875%20-48.59375%20L%201.34375%20-48.59375%20L%201.34375%20-59.78125%20L%2046.078125%20-59.78125%20L%2046.078125%20-48.59375%20L%2023.09375%200%20Z%20M%207.421875%200%20'/%3e%3c/g%3e%3c/g%3e%3c/g%3e%3c/svg%3e",Qm="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAYAAADimHc4AAAAAXNSR0IArs4c6QAABFNJREFUeF7tnU1rFEEQhqvBrOQbveshCupiUG/iSfwNfgRP/h7Be0RBEG8q6EExAQ+5SMRLFBWPEjeiyWqCaxQSoaXdDNszzi61U907U8u7t52pqp59n+nu6o+ZNYu3flhS+rFkaab1icgo/QFEZACgXHgAUK7+qAEl6w8AACBQAJ2wQLwQrgAQQkVBDJc/H9puEBlGHmotz05wPUVcVWdBRJZWR2tFfndlfHQDsJbeTU9VRswiF6IewNvpKc0DYd1pKFlLAFCk3oXyAYBQShaMAwAFhQvlNgwAHt5JT0e7jDo7P513LE/DxK5XjH5j+eVkfY0l+jg+qbsTvvbkV0fvPAX9Y74azit7zj/GJSSI70bCp1tjutcD5p55AEI1DQOK4wCc3QKAAcn9fzEAUJr07YIBAADEChj0AWINRQEAQCSf3Fk9gNmWNx3NWBbY6zzCp65JCs5h4tmqBuAGYkvja2QUD8VUA3BD9ucTDcXyEwEAp8mIaAMAEcXlhAYAjkoRbQAgoric0ADAUSmijbm4sKV2e7qbDVoaW9edhp55sZABkHz1RzV5SzTt6bD2p9sSjH/r9FrmScrqVk62rM73xp8Z1r6siDexKLSZXX6sugZ83amHH9WKJO3PGQD60yu4NQAEl7S/gADQn17BrQEguKT9BQSA/vQKbq0ewMbOcWRBwW8LZkCXP5/b/VDBBy/4qzOqa4D7mRd2VyoIgHkHuSGs5oEYAPBBR7EEgCiy8oMCAF+rKJYAEEVWftChAHBq+ZE3G9otfeo1TdxNsFg+nWt0e0PP777RnQXdXZzzlOr2+ER2xxNnBjuWT/oaX43VdW9Lubd4haMmv10YpKW19HL8JAAMUvNUWQBQmvTtggEAAKQKGPQBUgll/gAg00/srR7AyugxVhZk/+0eql7CpxqAk/NwqyW+C8sMoB5AfWujTP3EZesHsLmhe0lScxbkmqA6AIhrYeEAAFBYujCOABBGx8JRhgLAg6eXU8mxy5fdtvP05vT0FHB2M3nnbOfdM9mcO4mbbGX3I+ZvTk/n7e2L7BxLLnqm1dTdCa/evlS90Qm3Tlii9emm7gc0vtzUDWDtYHPvAREutWrZGQAoFwgAlKs/AQAACBSwROgDBPqJXQFALKEsgCX6fGCTtR4gKyiet+o+wG3MGv19lMi9OCj1EtNezy+3B3T5zzhnX5zqDxF7vVQ1G9MHlleWN2DVnIY6AJM/T+geCQNAvOaFE1l9E4QawMEcyQZNUCRhuWEBgKtUJLvhADB/Ve90NFma2HZpaCTCAwhrvt2YVwyAaL9p6J6O3rx+Xy0A9+d4tZHXADCAmppbBACUpfxeuQAAAGIFDPoAsYaiAAAgkk/urB7AvpH3yILk90HBCNbS99qRnLn9bnPwfjnZNQR3zj+Wd03h/2hNdQ1wT0k2a/WC9KrhBgAlcwAAABAogCZIIF4IVwAIoaIgBgAIxAvhOgQA/gLvdplS6vruLgAAAABJRU5ErkJggg==",Fm="/assets/favicon-Bc4v39Jn.ico",Im="/assets/favicon-BsWgUeI5.svg",xm="/assets/atkinsonHyperlegibleNextBold-CRDaWt1k.otf",Um="/assets/atkinsonHyperlegibleNextRegular-DOJsAlq1.otf",Mm="/assets/atkinsonHyperlegibleNextRegularItalic-DruWc0Qu.otf",Tm="data:application/manifest+json;base64,ew0KICAibmFtZSI6ICJTdHVkZW50Tm90YXRpb24iLA0KICAic2hvcnRfbmFtZSI6ICJTTiIsDQogICJpY29ucyI6IFsNCiAgICB7DQogICAgICAic3JjIjogIi93ZWItYXBwLW1hbmlmZXN0LTE5MngxOTIucG5nIiwNCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwNCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIsDQogICAgICAicHVycG9zZSI6ICJtYXNrYWJsZSINCiAgICB9LA0KICAgIHsNCiAgICAgICJzcmMiOiAiL3dlYi1hcHAtbWFuaWZlc3QtNTEyeDUxMi5wbmciLA0KICAgICAgInNpemVzIjogIjUxMng1MTIiLA0KICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIiwNCiAgICAgICJwdXJwb3NlIjogIm1hc2thYmxlIg0KICAgIH0NCiAgXSwNCiAgInRoZW1lX2NvbG9yIjogIiNmZmZmZmYiLA0KICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmZmZmIiwNCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSINCn0=",Pm="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAAAXNSR0IArs4c6QAACJhJREFUeF7tncFuG1UYRv9rO0ElaRFSt0gsCgKhNu0esUasQeQ9eAvEA4DoBsQKNmUBgWwRVSWKEEKCZUkXNICUJhAQajIedF1PNRnZjok6OmN8solke+Zen29OPju6vk7b7/9Rhj8IgSJSPP/nnRimHjK+g0YkBeAuAwXg2FcjKwCYgQKA8MdDKwCYgQKA8BWAh68AfAY2AJiBAoDwbQAevgLwGdgAYAYKAMK3AXj4CsBnYAOAGSgACN8G4OErAJ+BDQBmoAAgfBuAh68AfAY2AJiBAoDwbQAevgLwGdgAYAZF9OLS4Z0oXA6NpaAAGPqIflnGT+vnYjCeQ/5gRoqI6ne+uX5bfar1x1Uf6Gge23xqnv8k28xHAWABvnvqQvTBOSz70AoAXgG5ARQADMAGYOErAMvfl0AwfwWAA7AB2AAUgOVvA8D8FQAOwAZgA1AAlr8NAPNXADgAG4ANQAFY/jYAzF8B4ABsADYABWD52wAwfwWAA7AB2AAUgOVvA8D8FQAOIDfA59fdHp2KIQvwwwVXg1L8Rw3w1o2//H4AKIFhDOPZf9ZjmBfy+4MQSJtf/K0ACPqI4yjjlf0no1AAKIEIBcDQKwCI/tHQCgCmYAOA8MdDKwCYgQKA8BWAh68AfAY2AJiBAoDwbQAevgLwGdgAYAYKAMK3AXj4CsBnYAOAGSgACN8G4OErAJ+BDQBmoAAgfBuAh68AfAY2AJiBAoDwbQAefhbg5f1zrgYFo7ABQPiDMsXW+k6sRO/hNwPUvxigPq/mgvV5lk+3dcy0Oeb5LuD8FQAVoBefrf88FgCcyBIPrQBg+INSAUD8o6EVAExAAUD4vgnm4SsAn4ENAGagACB8G4CHrwB8BjYAmIECgPBtAB6+AvAZ2ABgBgoAwrcBePgKwGdgA4AZKAAI3wbg4SsAn4ENAGagACB8G4CHrwB8Bun17fvuDg3lMBj24su1e64GhfjnYdO1m1sKAAWQooi7xy9GLxXQDBw2Xb71qQJA10EW4JcHGwoA8R81gAJw9BWAY1+NrABgBgoAwq/+C2QDcCEoAMfeBuDZhwLwIfgSCMxAAUD4vgTqAHz/C4SHYAOAEdgAIHwboAPwbQA8BBsAjMAGAOHbAB2AbwPgIdgAYAQ2AAjfBugAfBsAD8EGACOwAUD4NkAH4EcR9x5ccTUoGIUNAMLPnwJ47ugghqm+4f+kTfZnbcpffwLV42ad47+ea9L5Z0FbrPkrACjAUfTjtaNv4jj1wVks99AKAOavACB83wPw8BWAz8AGADNQABC+DcDDVwA+AxsAzEABQPg2AA9fAfgMbAAwAwUA4dsAPHwF4DOwAcAMFACEbwPw8BWAz8AGADNQABC+DcDDVwA+AxsAzEABQPhVA2zculHbHXraUtnmBtL15bvTnkRbx8xazrtY8z+KXrx69K2rQUEP0ofbm7UrNV/Yk3ZLb17w8+yo3tYx0+aYKS7W/PtlEV+vXY1B+P0AlAPpo+0357maqfn9r8fNAny1dk0BwJQVAISvACD86j2ADcCFoAAc+2pkGwDMQAFA+DYAD18B+AxsADADBQDh2wA8fAXgM7ABwAwUAIRvA/DwFYDPwAYAM1AAEL4NwMNXAD4DGwDMQAFA+DYAD18B+AxsADADBQDh2wA8/H55HDfzcujS5dBUGjYART4iipTi0sH+6Hf+mfVJh/o0q8fVf+f7698OMOlpNY+rj1kf+yyfuFjU+SsAKMBxSnF1bzeK1ANnsdxDKwCYvwKA8H0PwMNXAD4DGwDMQAFA+DYAD18B+AxsADADBQDh2wA8fAXgM7ABwAwUAIRvA/DwFYDPwAYAM1AAEL4NwMNXAD4DGwDMQAFA+DYAD18B+AxsADADBQDhVw3w8Za7Q1Mx5GXQLxzsxtDVoFQEkXauv3Fie/RqV//6jdN2+q8/9rRvA5h0f3OsWeeYNK9J1BZp/r1hit2nf4te6XJoyoC0+95JAaiJLOO4WYCdiwpAZq8AIH0FAOFX7wFsAC4EBeDYVyPbAGAGCgDCtwF4+ArAZ2ADgBkoAAjfBuDhKwCfgQ0AZqAAIHwbgIevAHwGNgCYgQKA8G0AHr4C8BnYAGAGCgDCtwF4+ArAZ2ADgBkoAAjfBugA/GGKuxd/j361HLra37w5tRML1sf7qJ82/baOmTbHPJ8FnL8NcNqF1OL9ZRRx/vBylGn8BRnTNuY/7cMWk+bY1jFn+fKAtubSfN7zjNOYvwK0eIGfduqHAlyJqAQ47QDvf+wEFOCxI53/hAowP6u2HqkAbZGd47wKMAeklh+iAC0DnnV6BQDh+18gHr4C8BnYAGAGCgDCtwF4+ArAZ2ADgBkoAAjfBuDhKwCfgQ0AZqAAIHwbgIevAHwGNgCYgQKA8G0AHr4C8BnYAGAGCgDCf9QA7242V47zs1qSGeRl0OcPX3I1KJh32nvng5oAsxZ712dZPa7+O99ffSJimlPN4/Ixs26bROYsC9Kb5+nG/MuyH0/0f4yIPngJLPfQ6f7bn9gA0DWQBVhdua0AEP/Rn18F4OgrAMe+GlkBwAwUAIRfvQm2AbgQFIBjbwPw7EMB+BB8CQRmoAAgfF8C8fAVgM/ABgAzUAAQvg3Aw1cAPgMbAMxAAUD4NgAPXwH4DGwAMAMFAOHbADx8BeAzsAHADBQAhG8D8PCzAIOV7yNiMJ7MvJvv15edV3uCT7qt+Ryby9WnLQufxWbeOU4bO9/enfnbAKAHqSxib/WZSKMLwh+CgAIQ1Kv6LYv4dXUjejH+ggxwLss6tAKAyecGUAAwAD8QA8NXADYABWD52wAs/zy6L4HADBQAhO+/QTsA35dAeAg2ABiBDQDCtwE6AN8GwEOwAcAIbAAQvg3QAfg2AB6CDQBGYAOA8G2ADsC3AfAQbAAwAhsAhG8DdAC+DYCHYAOAEdgAIPzx0P8CpKm0wymYN9kAAAAASUVORK5CYII=",Lm="/assets/web-app-manifest-512x512-Dz8l3SBy.png",Hm=`<div id="app-loading-screen">\r
  <div class="loading-container">\r
    <div class="loading-logo">\r
      <svg viewBox="0 0 100 100" class="logo-svg">\r
        <circle cx="50" cy="50" r="45" class="logo-circle" />\r
        <path d="M 30 50 Q 50 30, 70 50 T 70 70" class="logo-path" />\r
      </svg>\r
    </div>\r
    <h1 class="loading-title">Student Notation</h1>\r
    <div class="loading-progress-container">\r
      <div class="loading-progress-bar">\r
        <div class="loading-progress-fill" id="loading-progress-fill"></div>\r
      </div>\r
      <div class="loading-progress-text" id="loading-progress-text">0%</div>\r
    </div>\r
    <div class="loading-status" id="loading-status">Initializing...</div>\r
  </div>\r
</div>\r
<!-- Sidebar for File/App Actions -->\r
<div id="sidebar-overlay"></div>\r
<aside id="sidebar" role="complementary" aria-label="Application settings and controls">\r
<div class="sidebar-container">\r
<div class="app-title">Student Notation</div>\r
</div>\r
<div class="sidebar-container">\r
<button class="sidebar-button" id="save-as-button" title="Save As"><img src="assets/sidebar/saveAs.svg" alt="Save As"><span class="sidebar-button-text">Save As</span></button>\r
<button class="sidebar-button" id="import-button" title="Open"><img src="assets/sidebar/open.svg" alt="Open"><span class="sidebar-button-text">Open</span></button>\r
<button class="sidebar-button" id="print-button" title="Print"><img src="assets/sidebar/print.svg" alt="Print"><span class="sidebar-button-text">Print</span></button>\r
<button class="sidebar-button" id="reset-canvas-button" title="New File"><img src="assets/sidebar/newPage.svg" alt="New Page"><span class="sidebar-button-text">New Page</span></button>\r
</div>\r
<div class="sidebar-container">\r
<h4 class="sidebar-section-header">Handoff</h4>\r
<button class="sidebar-button" id="take-to-singing-trainer-button" title="Take to Singing Trainer">\r
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\r
<path d="M7 17L17 7"/><path d="M7 7h10v10"/>\r
</svg>\r
<span class="sidebar-button-text">Take to Singing Trainer</span></button>\r
</div>\r
<div class="sidebar-container">\r
<button class="sidebar-button" id="hide-drumgrid-toggle" title="Toggle Drum Grid"><img src="assets/sidebar/hideDrums.svg" alt="Toggle Drum Grid"><span class="sidebar-button-text">Hide Drum Grid</span></button>\r
<button class="sidebar-button" id="hide-buttongrid-toggle" title="Toggle Button Grid"><img src="assets/sidebar/hideAnalysis.svg" alt="Toggle Button Grid"><span class="sidebar-button-text">Hide Button Grid</span></button>\r
<div class="sidebar-legend-toggle-row" role="group" aria-label="Legend visibility">\r
  <button class="sidebar-toggle-button" id="hide-leftlegend-toggle" type="button">Hide Left Legend</button>\r
  <button class="sidebar-toggle-button" id="hide-rightlegend-toggle" type="button">Hide Right Legend</button>\r
</div>\r
</div>\r
<div class="sidebar-container">\r
<h4 class="sidebar-section-header">Long Notes Style</h4>\r
<div class="toggle-button-group"><button class="sidebar-toggle-button active" id="long-note-style1-btn">Circle & Tails</button><button class="sidebar-toggle-button" id="long-note-style2-btn">Stadium</button></div>\r
</div>\r
<div class="sidebar-container">\r
<h4 class="sidebar-section-header">Playhead</h4>\r
<div class="toggle-button-group"><button class="sidebar-toggle-button active" id="playhead-mode-cursor-btn">Cursor Playhead</button><button class="sidebar-toggle-button" id="playhead-mode-microbeat-btn">Pulsing Microbeat</button><button class="sidebar-toggle-button" id="playhead-mode-macrobeat-btn">Pulsing Macrobeat</button></div>\r
</div>\r
</aside>\r
<main id="app-container" role="main">\r
  <!-- Toolbar Container -->\r
  <nav id="toolbar" role="navigation" aria-label="Music notation tools">\r
    <!-- Primary Toolbar -->\r
    <div id="toolbar-primary" class="toolbar-primary">\r
        <div class="primary-toolbar-grid-5x5">\r
            <!-- Row 1: settings, volume, blue notes -->\r
            <button class="toolkit-icon-button" id="settings-button" title="Settings"><img src="assets/icons/settings.svg" alt="Settings"></button>\r
            <div id="volume-control-wrapper">\r
                <button class="toolkit-icon-button" id="volume-icon-button" aria-label="Volume" title="Volume"><img src="assets/icons/volume.svg" alt="Volume"></button>\r
                <div id="volume-popup">\r
                    <input type="range" id="vertical-volume-slider" orient="vertical" min="0" max="100" value="70" step="1" />\r
                </div>\r
            </div>\r
            <div class="note circle-note" data-type="circle" data-color="#4a90e2"></div>\r
            <div class="note oval-note" data-type="oval" data-color="#4a90e2"></div>\r
            <div class="note diamond-note" data-type="diamond" data-color="#4a90e2" aria-label="Sixteenth note jewel">\r
                <svg class="diamond-icon" viewBox="0 0 120 120" aria-hidden="true" focusable="false">\r
                    <path d="M60 5 L35 48.3 L35 71.7 L60 115 L85 71.7 L85 48.3 Z" />\r
                </svg>\r
            </div>\r
            <!-- Row 2: zoom in/out, black notes -->\r
            <button class="toolkit-icon-button" id="grid-zoom-in" title="Zoom In"><img src="assets/icons/zoomIn.svg" alt="Zoom In"></button>\r
            <button class="toolkit-icon-button" id="grid-zoom-out" title="Zoom Out"><img src="assets/icons/zoomOut.svg" alt="Zoom Out"></button>\r
            <div class="note circle-note" data-type="circle" data-color="#2d2d2d"></div>\r
            <div class="note oval-note" data-type="oval" data-color="#2d2d2d"></div>\r
            <div class="note diamond-note" data-type="diamond" data-color="#2d2d2d" aria-label="Sixteenth note jewel">\r
                <svg class="diamond-icon" viewBox="0 0 120 120" aria-hidden="true" focusable="false">\r
                    <path d="M60 5 L35 48.3 L35 71.7 L60 115 L85 71.7 L85 48.3 Z" />\r
                </svg>\r
            </div>\r
            <!-- Row 3: redo/undo, red notes -->\r
            <button class="toolkit-icon-button" id="redo-button" title="Redo"><img src="assets/icons/redo.svg" alt="Redo"></button>\r
            <button class="toolkit-icon-button" id="undo-button" title="Undo"><img src="assets/icons/undo.svg" alt="Undo"></button>\r
            <div class="note circle-note" data-type="circle" data-color="#d66573"></div>\r
            <div class="note oval-note" data-type="oval" data-color="#d66573"></div>\r
            <div class="note diamond-note" data-type="diamond" data-color="#d66573" aria-label="Sixteenth note jewel">\r
                <svg class="diamond-icon" viewBox="0 0 120 120" aria-hidden="true" focusable="false">\r
                    <path d="M60 5 L35 48.3 L35 71.7 L60 115 L85 71.7 L85 48.3 Z" />\r
                </svg>\r
            </div>\r
            <!-- Row 4: clear/eraser, green notes -->\r
            <button class="toolkit-icon-button" id="clear-button" title="Clear"><img src="assets/icons/clear.svg" alt="Clear"></button>\r
            <button class="toolkit-icon-button eraser-button" id="eraser-tool-button" title="Eraser">\r
                <img src="assets/icons/eraser.svg" alt="Eraser" class="eraser-icon">\r
            </button>\r
            <div class="note circle-note" data-type="circle" data-color="#68a03f"></div>\r
            <div class="note oval-note" data-type="oval" data-color="#68a03f"></div>\r
            <div class="note diamond-note" data-type="diamond" data-color="#68a03f" aria-label="Sixteenth note jewel">\r
                <svg class="diamond-icon" viewBox="0 0 120 120" aria-hidden="true" focusable="false">\r
                    <path d="M60 5 L35 48.3 L35 71.7 L60 115 L85 71.7 L85 48.3 Z" />\r
                </svg>\r
            </div>\r
            <!-- Row 5: lasso/marker shortcuts, playback controls -->\r
            <button class="toolkit-icon-button" id="lasso-shortcut-button" title="Lasso Tool">\r
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="3 2">\r
                    <ellipse cx="12" cy="12" rx="8" ry="6" transform="rotate(-15 12 12)"/>\r
                </svg>\r
            </button>\r
            <button class="toolkit-icon-button" id="marker-shortcut-button" title="Marker Tool">\r
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                    <path d="M18 2L6 14l-2 6 6-2L22 6l-4-4z"/>\r
                    <line x1="14" y1="6" x2="18" y2="10"/>\r
                </svg>\r
            </button>\r
            <button class="toolkit-icon-button" id="play-button" title="Play"><img src="assets/icons/play.svg" alt="Play"></button>\r
            <button class="toolkit-icon-button" id="stop-button" title="Stop"><img src="assets/icons/stop.svg" alt="Stop"></button>\r
            <button class="toolkit-icon-button" id="loop-button" title="Loop"><img src="assets/icons/loop.svg" alt="Loop"></button>\r
        </div>\r
    </div>\r
    <!-- Secondary Toolbar -->\r
    <div id="toolbar-secondary" class="toolbar-secondary">\r
        <div class="tab-sidebar">\r
            <button class="tab-button" data-tab="timbre">Timbre</button>\r
            <button class="tab-button" data-tab="pitch">Pitch</button>\r
            <button class="tab-button" data-tab="rhythm">Rhythm</button>\r
        </div>\r
        <div class="tab-content">\r
            <!-- Timbre Tab -->\r
            <div class="tab-panel" id="timbre-panel">\r
                <!-- Presets/Effects Section (Separate) -->\r
                <div class="control-section preset-effects-container">\r
                    <div class="preset-effects-controls">\r
                            <div class="preset-effects-tabs">\r
                                <button class="preset-tab-button active" data-preset-tab="presets">Presets</button>\r
                                <button class="preset-tab-button" data-preset-tab="effects">Effects</button>\r
                            </div>\r
                            <div class="preset-effects-content">\r
                                <!-- Presets Tab -->\r
                                <div class="preset-tab-panel active" id="presets-panel">\r
                            <div class="preset-content-box">\r
                                <div class="preset-grid" id="preset-buttons">\r
                                    <div class="preset-column">\r
                                        <button class="preset-button" id="preset-sine">Sine</button>\r
                                        <button class="preset-button" id="preset-triangle">Triangle</button>\r
                                        <button class="preset-button" id="preset-square">Square</button>\r
                                        <button class="preset-button" id="preset-sawtooth">Sawtooth</button>\r
                                    </div>\r
                                    <div class="preset-column">\r
                                        <button class="preset-button" id="preset-piano">Piano</button>\r
                                        <button class="preset-button" id="preset-marimba">Marimba</button>\r
                                        <button class="preset-button" id="preset-woodwind">Woodwind</button>\r
                                        <button class="preset-button" id="preset-strings">Strings</button>\r
                                    </div>\r
                                </div>\r
                            </div>\r
                        </div>\r
                        <!-- Effects Tab -->\r
                        <div class="preset-tab-panel" id="effects-panel">\r
                            <div class="effects-content-box">\r
                                <div class="position-controls-container">\r
                                    <div class="position-control-group">\r
                                        <h5 class="position-label">Delay</h5>\r
                                        <div class="position-component-wrapper">\r
                                            <div class="position-component" id="delay-position"></div>\r
                                            <div id="delay-mix-wrapper"></div>\r
                                        </div>\r
                                        <div class="position-axis-labels" data-axis-x="Time" data-axis-y="Echoes"></div>\r
                                    </div>\r
                                    <div class="position-control-group">\r
                                        <h5 class="position-label">Vibrato</h5>\r
                                        <div class="position-component-wrapper">\r
                                            <div class="position-component" id="vibrato-position"></div>\r
                                            <div id="vibrato-mix-wrapper"></div>\r
                                        </div>\r
                                        <div class="position-axis-labels" data-axis-x="Speed" data-axis-y="Span"></div>\r
                                    </div>\r
                                    <div class="position-control-group">\r
                                        <h5 class="position-label">Tremolo</h5>\r
                                        <div class="position-component-wrapper">\r
                                            <div class="position-component" id="tremolo-position"></div>\r
                                            <div id="tremolo-mix-wrapper"></div>\r
                                        </div>\r
                                        <div class="position-axis-labels" data-axis-x="Speed" data-axis-y="Span"></div>\r
                                    </div>\r
                                </div>\r
                            </div>\r
                        </div>                        \r
                        <div class="effect-controls-container" id="effect-controls" style="display: none;">\r
                            <!-- Effect controls will be dynamically inserted here for data synchronization -->\r
                        </div>\r
                            </div>\r
                    </div>\r
                </div>\r
                <div class="control-section filter-container">\r
                    <!-- Row 1, Col 1: Blend slider -->\r
                    <div class="blend-slider-container"><div id="blend-slider-container"><div class="filter-blend-thumb" id="thumb-b" tabindex="0">B</div></div></div>\r
                    <!-- Row 2, Col 1: Bins grid (appended via JS) -->\r
                    <div class="filter-bins-wrapper"></div>\r
                    <!-- Row 3, Col 1: Cutoff slider -->\r
                    <div id="cutoff-slider-container"><div class="filter-cutoff-thumb" id="thumb-c" tabindex="0">C</div></div>\r
                    <!-- Row 2, Col 2: Vertical M slider (appended via JS) -->\r
                    <div class="filter-vertical-blend-wrapper"></div>\r
                </div>\r
                <div class="control-section adsr-container">\r
                    <!-- Row 1, Col 1: ADSR graph -->\r
                    <div class="adsr-graph-wrapper"><div id="adsr-envelope"></div></div>\r
                    <!-- Row 1, Col 2: Sustain slider -->\r
                    <div class="sustain-slider-wrapper"><div id="sustain-slider-track"><div id="sustain-slider-thumb" tabindex="0">S</div></div></div>\r
                    <!-- Row 2, Col 1: ADR slider -->\r
                    <div id="multi-thumb-slider-container"><div class="time-slider-thumb" id="thumb-a" tabindex="0">A</div><div class="time-slider-thumb" id="thumb-d" tabindex="0">D</div><div class="time-slider-thumb" id="thumb-r" tabindex="0">R</div></div>\r
                </div>\r
                  <!-- Waveform Section (Separate) -->\r
                  <div class="control-section">\r
                      <div class="waveform-section">\r
                          <div class="waveform-content-box">\r
                              <div class="waveform-display-wrapper">\r
                                  <canvas id="static-waveform-canvas"></canvas>\r
                                  <div class="waveform-speed-controls">\r
                                      <button class="waveform-speed-btn" data-speed="50">50%</button>\r
                                      <button class="waveform-speed-btn" data-speed="10">10%</button>\r
                                  </div>\r
                              </div>\r
                          </div>\r
                      </div>\r
                  </div>\r
              </div>\r
              <!-- Pitch Tab -->\r
            <div class="tab-panel" id="pitch-panel">\r
                <div class="control-section pitch-tabs-container">\r
                    <div class="pitch-tabs">\r
                        <button class="pitch-tab-button active" data-pitch-tab="range">Range</button>\r
                        <button class="pitch-tab-button" data-pitch-tab="chords">Chords</button>\r
                        <button class="pitch-tab-button" data-pitch-tab="draw">Draw</button>\r
                    </div>\r
                    <div class="pitch-tab-content">\r
                        <div class="pitch-tab-panel active" id="range-panel">\r
                            <div class="range-content-box">\r
                                <div class="range-layout">\r
                                   <div class="range-panel-section modes-section">\r
                                       <!-- <h4 class="panel-section-title">Modes</h4> -->\r
                                       <div class="tonic-modes-container">\r
                                           <div class="tonic-modes-grid">\r
                                               <button class="tonic-mode-button" data-tonic="1">\r
                                                   <img src="assets/tabicons/tonicShape_1.svg" alt="Major" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Major</span>\r
                                               </button>\r
                                               <button class="tonic-mode-button" data-tonic="2">\r
                                                   <img src="assets/tabicons/tonicShape_2.svg" alt="Dorian" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Dorian</span>\r
                                               </button>\r
                                               <button class="tonic-mode-button" data-tonic="3">\r
                                                   <img src="assets/tabicons/tonicShape_3.svg" alt="Phrygian" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Phrygian</span>\r
                                               </button>\r
                                               <button class="tonic-mode-button" data-tonic="4">\r
                                                   <img src="assets/tabicons/tonicShape_4.svg" alt="Lydian" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Lydian</span>\r
                                               </button>\r
                                               <button class="tonic-mode-button" data-tonic="5">\r
                                                   <img src="assets/tabicons/tonicShape_5.svg" alt="Mixolydian" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Mixolydian</span>\r
                                               </button>\r
                                               <button class="tonic-mode-button" data-tonic="6">\r
                                                   <img src="assets/tabicons/tonicShape_6.svg" alt="Minor" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Minor</span>\r
                                               </button>\r
                                               <button class="tonic-mode-button" data-tonic="7">\r
                                                   <img src="assets/tabicons/tonicShape_7.svg" alt="Locrian" class="tonic-mode-icon">\r
                                                   <span class="tonic-mode-label">Locrian</span>\r
                                               </button>\r
                                           </div>\r
                                       </div>\r
                                   </div>\r
                                   <div class="range-panel-section degrees-section">\r
                                       <!-- <h4 class="panel-section-title">Degrees</h4> -->\r
                                       <div class="degree-visibility-toggle-container">\r
                                           <button class="degree-visibility-button" id="degree-visibility-toggle" type="button">\r
                                               Show Degrees\r
                                           </button>\r
                                       </div>\r
                                       <div class="degree-mode-toggle-container" id="degree-mode-toggle">\r
                                           <button class="degree-mode-button" data-mode="diatonic" type="button">Scale</button>\r
                                           <button class="degree-mode-button" data-mode="modal" type="button">Mode</button>\r
                                       </div>\r
                                       <label class="checkbox-label">\r
                                            <input type="checkbox" id="focus-colours-toggle">\r
                                            <span class="checkbox-text">Focus Colours</span>\r
                                        </label>\r
                                   </div>\r
                                   <div class="range-panel-section wheels-section">\r
                                       <!-- <h4 class="panel-section-title">Select Range</h4> -->\r
                                       <div class="clef-wheels-wrapper">\r
                                           <div class="clef-picker-column">\r
                                               <div class="clef-wheel" id="clef-top-wheel" tabindex="0" aria-label="Select top note">\r
                                                   <div class="clef-wheel-viewport">\r
                                                       <div class="clef-wheel-options"></div>\r
                                                   </div>\r
                                                   <div class="clef-wheel-overlay"></div>\r
                                               </div>\r
                                           </div>\r
                                           <div class="clef-picker-column">\r
                                               <div class="clef-wheel" id="clef-bottom-wheel" tabindex="0" aria-label="Select bottom note">\r
                                                   <div class="clef-wheel-viewport">\r
                                                       <div class="clef-wheel-options"></div>\r
                                                   </div>\r
                                                   <div class="clef-wheel-overlay"></div>\r
                                               </div>\r
                                           </div>\r
                                       </div>\r
                                   </div>\r
                                   <div class="range-panel-section presets-section">\r
                                       <!-- <h4 class="panel-section-title">Presets</h4> -->\r
                                       <div class="clef-presets-column">\r
                                           <div class="clef-preset-buttons">\r
                                               <button class="toolkit-button clef-preset-button" id="clef-full-range-button" type="button">\r
                                                   Full Range\r
                                               </button>\r
                                               <button class="toolkit-button clef-preset-button" id="clef-treble-button" type="button">\r
                                                   Treble\r
                                               </button>\r
                                               <button class="toolkit-button clef-preset-button" id="clef-alto-button" type="button">\r
                                                   Alto\r
                                               </button>\r
                                               <button class="toolkit-button clef-preset-button" id="clef-bass-button" type="button">\r
                                                   Bass\r
                                               </button>\r
                                           </div>\r
                                       </div>\r
                                   </div>\r
                                </div>\r
                        </div>\r
                    </div>\r
                        <div class="pitch-tab-panel" id="chords-panel">\r
            <div class="chords-content-box">\r
                <div class="chords-layout">\r
                    <div class="chords-panel-section intervals-grid-section">\r
                        <h4 class="panel-section-title">Intervals</h4>\r
                        <div class="intervals-grid-column">\r
                            <div class="harmony-preset-grid intervals-4x4-grid">\r
                                <button class="harmony-preset-button">M6</button>\r
                                <button class="harmony-preset-button">A6</button>\r
                                <button class="harmony-preset-button">m7</button>\r
                                <button class="harmony-preset-button">M7</button>\r
                                <button class="harmony-preset-button">d5</button>\r
                                <button class="harmony-preset-button">P5</button>\r
                                <button class="harmony-preset-button">A5</button>\r
                                <button class="harmony-preset-button">m6</button>\r
                                <button class="harmony-preset-button">m3</button>\r
                                <button class="harmony-preset-button">M3</button>\r
                                <button class="harmony-preset-button">P4</button>\r
                                <button class="harmony-preset-button">A4</button>\r
                                <button class="harmony-preset-button">U</button>\r
                                <button class="harmony-preset-button">m2</button>\r
                                <button class="harmony-preset-button">M2</button>\r
                                <button class="harmony-preset-button">A2</button>\r
                            </div>\r
                        </div>\r
                    </div>\r
                    <div class="chords-panel-section unified-position-section">\r
                        <h4 class="panel-section-title">Position</h4>\r
                        <div class="unified-position-column">\r
                            <div class="unified-position-toggle" id="unified-position-toggle">\r
                                <div class="left-labels">\r
                                    <span class="state-label" data-step="0">Asc.</span>\r
                                    <span class="state-label" data-step="1">Desc.</span>\r
                                </div>\r
                                <div class="toggle-track">\r
                                    <div class="unified-slider"></div>\r
                                </div>\r
                                <div class="right-labels">\r
                                    <span class="state-label" data-step="0">Root</span>\r
                                    <span class="state-label" data-step="1">1st</span>\r
                                    <span class="state-label" data-step="2">2nd</span>\r
                                    <span class="state-label" data-step="3">3rd</span>\r
                                    <span class="state-label" data-step="4">4th</span>\r
                                    <span class="state-label" data-step="5">5th</span>\r
                                </div>\r
                            </div>\r
                        </div>\r
                    </div>\r
                    <div class="chords-panel-section chords-grid-section">\r
                        <h4 class="panel-section-title">Chords</h4>\r
                        <div class="chords-grid-column">\r
                            <div class="harmony-preset-grid chords-grid chords-grid-6col" id="chords-preset-grid">\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;]" title="Major triad">X</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;]" title="Minor triad">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5d&quot;]" title="Diminished triad">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;6m&quot;]" title="Augmented triad">X+</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7m&quot;]" title="Dominant 7">X</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;7m&quot;]" title="Minor 7">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7M&quot;]" title="Major 7">Xmaj</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5d&quot;, &quot;7m&quot;]" title="Half-diminished 7"></button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5d&quot;, &quot;6M&quot;]" title="Fully diminished 7">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;6M&quot;]" title="Major 6">X</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;2M&quot;, &quot;5P&quot;]" title="Suspended 2">Xsus2</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;4P&quot;, &quot;5P&quot;]" title="Suspended 4">Xsus4</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;7M&quot;]" title="Minor-major 7">xmaj</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;9M&quot;]" title="Major add 9">Xadd9</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;9M&quot;]" title="Minor add 9">xadd9</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;6M&quot;, &quot;9M&quot;]" title="Major 6/9">X6/9</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7m&quot;, &quot;9M&quot;]" title="Dominant 9">X9</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7m&quot;, &quot;9M&quot;, &quot;11P&quot;]" title="Dominant 11">X11</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7m&quot;, &quot;9M&quot;, &quot;13M&quot;]" title="Dominant 13">X13</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7M&quot;, &quot;9M&quot;]" title="Major 9">Xmaj9</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;7m&quot;, &quot;9M&quot;]" title="Minor 9">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;6M&quot;]" title="Minor 6">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;7m&quot;, &quot;9M&quot;, &quot;11P&quot;]" title="Minor 11">x</button>\r
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7M&quot;, &quot;11A&quot;]" title="Major 7 sharp 11 (Lydian)">Xmaj711</button>\r
                            </div>\r
                        </div>\r
                    </div>\r
                </div>\r
            </div>\r
        </div>\r
                        <div class="pitch-tab-panel" id="draw-panel">\r
                            <div class="draw-content-box">\r
                                <div class="draw-layout-grid">\r
                                    <!-- Arrow Tool Panel -->\r
                                    <div class="draw-tool-panel" id="draw-arrow-controls" data-draw-tool="arrow">\r
                                        <div class="draw-tool-header">\r
                                            <button class="draw-tool-button" data-draw-tool="arrow" title="Arrow Tool">\r
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                    <line x1="4" y1="20" x2="20" y2="4"/>\r
                                                    <polyline points="14,4 20,4 20,10"/>\r
                                                </svg>\r
                                            </button>\r
                                        </div>\r
                                        <div class="draw-tool-options" id="arrow-tool-options">\r
                                            <div class="draw-option-group">\r
                                                <div class="draw-toolbar-row">\r
                                                    <!-- Stroke weight popup -->\r
                                                    <div class="draw-popup-trigger">\r
                                                        <button class="draw-toolbar-button" title="Stroke width">\r
                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                                <line x1="4" y1="12" x2="20" y2="12"/>\r
                                                            </svg>\r
                                                        </button>\r
                                                        <div class="draw-popup-menu">\r
                                                            <div class="draw-option-label">Stroke</div>\r
                                                            <input type="range" id="arrow-stroke-weight" min="1" max="20" value="4" aria-label="Arrow stroke weight">\r
                                                        </div>\r
                                                    </div>\r
\r
                                                    <!-- Line style popup -->\r
                                                    <div class="draw-popup-trigger">\r
                                                        <button class="draw-toolbar-button" title="Line style">\r
                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                                <line x1="4" y1="8" x2="20" y2="8" stroke-dasharray="4 3"/>\r
                                                                <line x1="4" y1="16" x2="20" y2="16"/>\r
                                                            </svg>\r
                                                        </button>\r
                                                        <div class="draw-popup-menu">\r
                                                            <div class="draw-option-label">Line Style</div>\r
                                                            <div class="draw-button-group">\r
                                                                <button class="draw-option-button active" data-line-style="solid">Solid</button>\r
                                                                <button class="draw-option-button" data-line-style="dashed">Dashed</button>\r
                                                            </div>\r
                                                        </div>\r
                                                    </div>\r
                                                </div>\r
                                                <div class="draw-toolbar-row">\r
                                                    <!-- Left arrowhead popup -->\r
                                                    <div class="draw-popup-trigger">\r
                                                        <button class="draw-toolbar-button" id="arrow-start-head-trigger" title="Start head">\r
                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                                <polyline points="9,5 3,12 9,19"/>\r
                                                                <line x1="3" y1="12" x2="21" y2="12"/>\r
                                                            </svg>\r
                                                        </button>\r
                                                                <div class="draw-popup-menu">\r
                                                                    <div class="draw-option-label">Start</div>\r
                                                                    <div class="draw-button-group">\r
                                                                    <button class="draw-option-button active" data-arrow-start="none">No head</button>\r
                                                                    <button class="draw-option-button" data-arrow-start="filled-arrow">Arrow</button>\r
                                                                    </div>\r
                                                                </div>\r
                                                            </div>\r
                                                    <!-- Swap heads -->\r
                                                    <button class="draw-toolbar-button" id="arrow-swap-heads" title="Swap heads">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <polyline points="9 5 15 5 15 11"/>\r
                                                            <polyline points="15 19 9 19 9 13"/>\r
                                                            <line x1="9" y1="5" x2="5" y2="9"/>\r
                                                            <line x1="15" y1="19" x2="19" y2="15"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <!-- Right arrowhead popup -->\r
                                                    <div class="draw-popup-trigger">\r
                                                        <button class="draw-toolbar-button" id="arrow-end-head-trigger" title="End head">\r
                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                                <polyline points="15,5 21,12 15,19"/>\r
                                                                <line x1="3" y1="12" x2="21" y2="12"/>\r
                                                            </svg>\r
                                                        </button>\r
                                                                <div class="draw-popup-menu">\r
                                                                    <div class="draw-option-label">End</div>\r
                                                                    <div class="draw-button-group">\r
                                                                    <button class="draw-option-button active" data-arrow-end="filled-arrow">Arrow</button>\r
                                                                    <button class="draw-option-button" data-arrow-end="none">No head</button>\r
                                                                    </div>\r
                                                                    <div class="draw-option-label">Head Size</div>\r
                                                                    <input type="range" id="arrow-head-size" min="8" max="32" value="12" aria-label="Arrowhead size">\r
                                                                </div>\r
                                                            </div>\r
                                                </div>\r
                                            </div>\r
                                        </div>\r
                                    </div>\r
                                    <!-- Text Tool Panel -->\r
                                    <div class="draw-tool-panel" id="draw-text-controls" data-draw-tool="text">\r
                                        <div class="draw-tool-header">\r
                                            <button class="draw-tool-button" data-draw-tool="text" title="Text Tool">\r
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                    <polyline points="4,7 4,4 20,4 20,7"/>\r
                                                    <line x1="12" y1="4" x2="12" y2="20"/>\r
                                                    <line x1="9" y1="20" x2="15" y2="20"/>\r
                                                </svg>\r
                                            </button>\r
                                        </div>\r
                                        <div class="draw-tool-options" id="text-tool-options">\r
                                            <div class="draw-option-group draw-toolbar-row">\r
                                                <!-- Size popup -->\r
                                                <div class="draw-popup-trigger">\r
                                                    <button class="draw-toolbar-button" title="Text size">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <path d="M4 18h16"/>\r
                                                            <path d="M8 18l4-12 4 12"/>\r
                                                            <path d="M10 12h4"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <div class="draw-popup-menu">\r
                                                        <div class="draw-option-label">Size (px)</div>\r
                                                        <input type="number" id="text-size-input" min="8" max="72" value="16" aria-label="Text size (px)">\r
                                                    </div>\r
                                                </div>\r
                                                <!-- Colour popup -->\r
                                                <div class="draw-popup-trigger">\r
                                                    <button class="draw-toolbar-button" title="Text colour">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <path d="M12 3l6 16"/>\r
                                                            <path d="M6 19l6-16"/>\r
                                                            <path d="M10 12h4"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <div class="draw-popup-menu">\r
                                                        <div class="draw-option-label">Colour</div>\r
                                                        <div class="draw-color-picker">\r
                                                            <button class="draw-color-button active" data-color="#000000" style="background-color: #000000;" aria-label="Black text"></button>\r
                                                            <button class="draw-color-button" data-color="#4a90e2" style="background-color: #4a90e2;" aria-label="Blue text"></button>\r
                                                            <button class="draw-color-button" data-color="#d66573" style="background-color: #d66573;" aria-label="Red text"></button>\r
                                                            <button class="draw-color-button" data-color="#68a03f" style="background-color: #68a03f;" aria-label="Green text"></button>\r
                                                        </div>\r
                                                    </div>\r
                                                </div>\r
                                                <!-- Style buttons -->\r
                                                <div class="text-style-rows">\r
                                                    <div class="draw-button-group">\r
                                                        <button class="draw-option-button" data-text-style="bold">B</button>\r
                                                        <button class="draw-option-button" data-text-style="italic">I</button>\r
                                                        <button class="draw-option-button" data-text-style="underline">U</button>\r
                                                    </div>\r
                                                    <div class="draw-button-group">\r
                                                        <button class="draw-option-button" data-text-style="background">Bg</button>\r
                                                        <button class="draw-option-button" data-text-style="superscript">x<sup>2</sup></button>\r
                                                        <button class="draw-option-button" data-text-style="subscript">x<sub>2</sub></button>\r
                                                    </div>\r
                                                </div>\r
                                            </div>\r
                                        </div>\r
                                    </div>\r
                                    <!-- Marker Tool Panel -->\r
                                    <div class="draw-tool-panel" id="draw-marker-controls" data-draw-tool="marker">\r
                                        <div class="draw-tool-header">\r
                                            <button class="draw-tool-button" data-draw-tool="marker" title="Marker Tool">\r
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                    <!-- Pointed marker tip -->\r
                                                    <path d="M18 2L6 14l-2 6 6-2L22 6l-4-4z"/>\r
                                                    <line x1="10" y1="18" x2="6" y2="14"/>\r
                                                </svg>\r
                                            </button>\r
                                        </div>\r
                                        <div class="draw-tool-options" id="marker-tool-options">\r
                                            <div class="draw-option-group draw-toolbar-row">\r
                                                <!-- Size popup -->\r
                                                <div class="draw-popup-trigger">\r
                                                    <button class="draw-toolbar-button" title="Marker size">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <path d="M6 19l12-14"/>\r
                                                            <path d="M6 19l-2 4 4-2"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <div class="draw-popup-menu">\r
                                                        <div class="draw-option-label">Size</div>\r
                                                        <input type="range" id="marker-size-input" min="2" max="20" value="6" aria-label="Marker size">\r
                                                    </div>\r
                                                </div>\r
                                                <!-- Colours popup -->\r
                                                <div class="draw-popup-trigger">\r
                                                    <button class="draw-toolbar-button" title="Marker colour">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <path d="M19 4l-7 7"/>\r
                                                            <path d="M5 20l3.5-1.5"/>\r
                                                            <path d="M16 7l1.5 1.5"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <div class="draw-popup-menu">\r
                                                        <div class="draw-option-label">Colours</div>\r
                                                        <div class="draw-color-picker">\r
                                                            <button class="draw-color-button" data-color="#4a90e2" style="background-color: #4a90e2;" aria-label="Blue marker"></button>\r
                                                            <button class="draw-color-button" data-color="#2d2d2d" style="background-color: #2d2d2d;" aria-label="Black marker"></button>\r
                                                            <button class="draw-color-button" data-color="#d66573" style="background-color: #d66573;" aria-label="Red marker"></button>\r
                                                            <button class="draw-color-button" data-color="#68a03f" style="background-color: #68a03f;" aria-label="Green marker"></button>\r
                                                        </div>\r
                                                    </div>\r
                                                </div>\r
                                            </div>\r
                                        </div>\r
                                    </div>\r
                                    <!-- Highlighter Tool Panel -->\r
                                    <div class="draw-tool-panel" id="draw-highlighter-controls" data-draw-tool="highlighter">\r
                                        <div class="draw-tool-header">\r
                                            <button class="draw-tool-button" data-draw-tool="highlighter" title="Highlighter Tool">\r
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity="0.5">\r
                                                    <!-- Flat highlighter head -->\r
                                                    <rect x="3" y="3" width="4" height="18" rx="1"/>\r
                                                    <path d="M7 5h12l-2 14H7z"/>\r
                                                </svg>\r
                                            </button>\r
                                        </div>\r
                                        <div class="draw-tool-options" id="highlighter-tool-options">\r
                                            <div class="draw-option-group draw-toolbar-row">\r
                                                <!-- Size popup -->\r
                                                <div class="draw-popup-trigger">\r
                                                    <button class="draw-toolbar-button" title="Highlighter size">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <rect x="5" y="5" width="10" height="10" rx="2"/>\r
                                                            <path d="M9 15l-2 4"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <div class="draw-popup-menu">\r
                                                        <div class="draw-option-label">Size</div>\r
                                                        <input type="range" id="highlighter-size-input" min="4" max="30" value="10" aria-label="Highlighter size">\r
                                                    </div>\r
                                                </div>\r
                                                <!-- Colours popup -->\r
                                                <div class="draw-popup-trigger">\r
                                                    <button class="draw-toolbar-button" title="Highlighter colour">\r
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\r
                                                            <rect x="7" y="7" width="10" height="10" rx="2"/>\r
                                                        </svg>\r
                                                    </button>\r
                                                    <div class="draw-popup-menu">\r
                                                        <div class="draw-option-label">Colours</div>\r
                                                        <div class="draw-color-picker">\r
                                                            <button class="draw-color-button" data-color="#9fc5ff" style="background-color: #9fc5ff;" aria-label="Light blue highlighter"></button>\r
                                                            <button class="draw-color-button" data-color="#c2c2c2" style="background-color: #c2c2c2;" aria-label="Gray highlighter"></button>\r
                                                            <button class="draw-color-button" data-color="#ffd166" style="background-color: #ffd166;" aria-label="Yellow highlighter"></button>\r
                                                        </div>\r
                                                    </div>\r
                                                </div>\r
                                            </div>\r
                                        </div>\r
                                    </div>\r
                                    <!-- Lasso Tool Panel -->\r
                                    <div class="draw-tool-panel" id="draw-lasso-controls" data-draw-tool="lasso">\r
                                        <div class="draw-tool-header">\r
                                            <button class="draw-tool-button" data-draw-tool="lasso" title="Lasso Select">\r
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="3 2">\r
                                                    <ellipse cx="12" cy="12" rx="8" ry="6" transform="rotate(-15 12 12)"/>\r
                                                </svg>\r
                                            </button>\r
                                        </div>\r
                                        <div class="draw-tool-options" id="lasso-tool-options">\r
                                            <div class="draw-option-group draw-toolbar-row">\r
                                                <div class="draw-option-help">\r
                                                    Draw around notes to select and drag them as a group.\r
                                                </div>\r
                                            </div>\r
                                        </div>\r
                                    </div>\r
                                </div>\r
                            </div>\r
                        </div>\r
                    </div>\r
                </div>\r
            </div>\r
            <!-- Rhythm Tab -->\r
            <div class="tab-panel" id="rhythm-panel">\r
\r
                <!-- Stamps/Triplets Section (Separate) -->\r
                <div class="control-section rhythm-stamp-tabs-container">\r
                    <div class="rhythm-stamp-tabs-controls">\r
                        <div class="rhythm-tab-stamps">\r
                            <button class="rhythm-tab-button rhythm-stamp-tab-button active" data-rhythm-stamp-tab="sixteenth">Sixteenths</button>\r
                            <button class="rhythm-tab-button rhythm-stamp-tab-button" data-rhythm-stamp-tab="triplet">Triplets</button>\r
                        </div>\r
                        <div class="rhythm-stamp-tab-content">\r
                            <div class="rhythm-stamp-tab-panel active" id="sixteenth-stamps-panel">\r
                                <div id="sixteenth-stamps-toolbar-container" class="sixteenth-stamps-toolbar-container">\r
                                    <!-- Stamps toolbar will be rendered here by JavaScript -->\r
                                </div>\r
                            </div>\r
                            <div class="rhythm-stamp-tab-panel" id="triplet-stamps-panel">\r
                                <div id="triplet-stamps-toolbar-container" class="triplet-stamps-toolbar-container">\r
                                    <!-- Triplets toolbar will be rendered here by JavaScript -->\r
                                </div>\r
                            </div>\r
                        </div>\r
                    </div>\r
                </div>\r
                                <!-- Controls Section (Separate) -->\r
                <div class="control-section rhythm-controls-container">\r
                    <div class="rhythm-controls-section">\r
                        <button class="rhythm-tab-button rhythm-controls-tab-button active" disabled>Controls</button>\r
                        <div class="rhythm-controls-content-box">\r
                            <div class="tempo-content-box">\r
                                <div class="tempo-container">\r
                                    <div class="tempo-boxes-container">\r
                                        <div class="tempo-input-group tempo-row">\r
                                            <img src="assets/tabicons/eigthNote.svg" alt="Eighth Note Tempo" class="tempo-label-icon">\r
                                            <div id="eighth-note-tempo"></div>\r
                                        </div>\r
                                        <div class="tempo-input-group tempo-row">\r
                                            <img src="assets/tabicons/quarterNote.svg" alt="Quarter Note Tempo" class="tempo-label-icon">\r
                                            <div id="quarter-note-tempo"></div>\r
                                        </div>\r
                                        <div class="tempo-input-group tempo-row">\r
                                            <img src="assets/tabicons/dottedQuarterNote.svg" alt="Dotted Quarter Note Tempo" class="tempo-label-icon">\r
                                            <div id="dotted-quarter-tempo"></div>\r
                                        </div>\r
                                    </div>\r
                                    <div class="tempo-slider-container tempo-column-2">\r
                                        <input type="range" id="tempo-slider" min="30" max="240" value="90">\r
                                    </div>\r
                                </div>\r
                            </div>\r
                            <div class="rhythm-structure-container">\r
                                <div class="control-subsection">\r
                                    <h4>Add/Del Beat</h4>\r
                                    <div class="macrobeat-adjust-group">\r
                                        <button class="toolkit-button" id="macrobeat-decrease"></button>\r
                                        <button class="toolkit-button" id="macrobeat-increase">+</button>\r
                                    </div>\r
                                </div>\r
                                <div class="control-subsection">\r
                                    <h4>Pickup</h4>\r
                                    <div class="toggle-button-group"><button class="sidebar-toggle-button" id="anacrusis-on-btn">On</button><button class="sidebar-toggle-button" id="anacrusis-off-btn">Off</button></div>\r
                                </div>\r
                            </div>\r
                            <div class="modulation-container">\r
                                <div class="control-subsection">\r
                                    <h4>Modulation</h4>\r
                                    <div class="modulation-controls">\r
                                        <button class="toolkit-button modulation-ratio-btn" id="modulation-2-3-btn" data-ratio="2:3" title="Place 2:3 modulation marker (33% faster)">2:3 - 33% faster</button>\r
                                        <button class="toolkit-button modulation-ratio-btn" id="modulation-3-2-btn" data-ratio="3:2" title="Place 3:2 modulation marker (33% slower)">3:2 - 33% slower</button>\r
                                        <button class="toolkit-button" id="modulation-clear-btn" title="Clear all modulation markers">Clear</button>\r
                                    </div>\r
                                </div>\r
                            </div>\r
                        </div>\r
                    </div>\r
                </div>\r
            </div>\r
        </div>\r
    </div>\r
  </nav>\r
  <div id="canvas-container" role="region" aria-label="Musical notation canvas">\r
    <div id="canvas-content">\r
        <div id="grids-wrapper">\r
            <div id="button-grid">\r
                <div class="button-grid-left-cell">\r
                    <div class="left-cell-grid">\r
                        <div id="flat-toggle-btn" class="accidental-btn active" role="button" tabindex="0" aria-pressed="true"></div>\r
                        <div id="sharp-toggle-btn" class="accidental-btn active" role="button" tabindex="0" aria-pressed="true"></div>\r
                        <div id="hz-toggle-btn" class="accidental-btn" role="button" tabindex="0" aria-pressed="false">Hz</div>\r
                        <div id="spn-octave-toggle-btn" class="accidental-btn octave-toggle-btn active" role="button" tabindex="0" aria-pressed="true" title="Show SPN octave digits" aria-label="Toggle SPN octave digits">\r
                            <span class="octave-label">\r
                                A<span class="octave-digit">1</span>\r
                            </span>\r
                        </div>\r
                    </div>\r
                </div>\r
                <div class="button-grid-middle-cell">\r
                    <div id="beat-line-button-layer">\r
                        <div id="time-signature-row" class="beat-line-row"></div>\r
                        <div id="grouping-buttons-row" class="beat-line-row"></div>\r
                        <div id="boundary-buttons-row" class="beat-line-row"></div>\r
                    </div>\r
                </div>\r
                <div class="button-grid-right-cell">\r
                    <!-- Null/empty cell for alignment with pitch grid right legend -->\r
                </div>\r
            </div>\r
            <div id="pitch-grid-wrapper">\r
                <div id="pitch-grid-container">\r
                    <div id="grid-container">\r
                        <div id="pitch-canvas-wrapper">\r
                            <canvas id="legend-left-canvas"></canvas>\r
                            <canvas id="notation-grid"></canvas>\r
                            <canvas id="legend-right-canvas"></canvas>\r
                            <canvas id="playhead-canvas"></canvas>\r
                            <canvas id="hover-canvas"></canvas>\r
                        </div>\r
                    </div>\r
                </div>\r
            </div>\r
            <div id="grid-scrollbar-proxy" role="scrollbar" aria-label="Horizontal scroll for notation grids" tabindex="0">\r
                <div class="grid-scrollbar-inner"></div>\r
            </div>\r
            <div id="drum-grid-wrapper">\r
                <div class="drum-grid-left-cell">\r
                    <!-- Reserved for future drum legends/controls -->\r
                </div>\r
                <div class="drum-grid-middle-cell">\r
                    <div id="drum-canvas-wrapper">\r
                        <canvas id="drum-grid"></canvas>\r
                        <canvas id="drum-playhead-canvas"></canvas>\r
                        <canvas id="drum-hover-canvas"></canvas>\r
                    </div>\r
                </div>\r
                <div class="drum-grid-right-cell">\r
                    <!-- Placeholder for alignment with right legend spacing -->\r
                </div>\r
            </div>\r
        </div>\r
    </div>\r
</div>\r
</main>\r
<!-- Notification Overlay -->\r
<div id="notification-overlay">\r
    <div class="notification-modal">\r
        <div class="notification-header">\r
            <h3 class="notification-title">Notice</h3>\r
            <button class="notification-close"></button>\r
        </div>\r
        <div class="notification-message"></div>\r
        <div class="notification-actions">\r
            <button class="notification-button">OK</button>\r
        </div>\r
    </div>\r
</div>\r
<!-- ... (Print Preview Modal remains the same) ... -->\r
<div id="print-preview-overlay" class="hidden">\r
    <div id="print-preview-modal">\r
        <div class="print-preview-header">\r
            <h2>Print Preview</h2>\r
            <button id="print-close-button" class="close-button"></button>\r
        </div>\r
        <div class="print-preview-content">\r
            <div class="print-preview-canvas-wrapper">\r
                <canvas id="print-preview-canvas"></canvas>\r
                <canvas id="print-crop-overlay"></canvas>\r
            </div>\r
                <div class="print-preview-options">\r
                <div class="print-info-box">\r
                    <p>Use the crop handles on the preview to trim what gets sent to the printer.</p>\r
                </div>\r
                <h3>Layout</h3>\r
                <div class="print-option-row">\r
                    <label>Paper</label>\r
                    <select id="print-page-size" class="print-select">\r
                        <option value="letter">Letter (8.511)</option>\r
                        <option value="11x14">1114</option>\r
                        <option value="11x17">1117</option>\r
                    </select>\r
                </div>\r
                <div class="print-option-row">\r
                    <label>Orientation</label>\r
                    <button id="print-orientation-toggle" class="toggle-button">Landscape</button>\r
                </div>\r
                <div class="print-option-row">\r
                    <label>Buttons</label>\r
                    <button id="print-button-grid-toggle" class="toggle-button active">Include</button>\r
                </div>\r
                <div class="print-option-row">\r
                    <label>Drums</label>\r
                    <button id="print-drum-grid-toggle" class="toggle-button active">Include</button>\r
                </div>\r
                <div class="print-option-row">\r
                    <label>Left Legend</label>\r
                    <button id="print-left-legend-toggle" class="toggle-button active">Include</button>\r
                </div>\r
                <div class="print-option-row">\r
                    <label>Right Legend</label>\r
                    <button id="print-right-legend-toggle" class="toggle-button active">Include</button>\r
                </div>\r
                <div class="print-option-row">\r
                    <label>Color</label>\r
                    <button id="print-color-mode-toggle" class="toggle-button active">Color</button>\r
                </div>\r
            </div>\r
        </div>\r
        <div class="print-preview-footer">\r
            <button id="print-confirm-button" class="confirm-button">Print</button>\r
        </div>\r
    </div>\r
</div>\r
<div id="print-staging-area"></div>\r
\r
<!-- Svelte component mount points (headless components) -->\r
<!-- Toolbar bridges -->\r
<div data-svelte-component="playback-controls-bridge" style="display: none;"></div>\r
<div data-svelte-component="file-actions-bridge" style="display: none;"></div>\r
<div data-svelte-component="grid-controls-bridge" style="display: none;"></div>\r
<div data-svelte-component="modulation-bridge" style="display: none;"></div>\r
<div data-svelte-component="sidebar-bridge" style="display: none;"></div>\r
<div data-svelte-component="tool-selector-bridge" style="display: none;"></div>\r
<div data-svelte-component="audio-controls-bridge" style="display: none;"></div>\r
<!-- Tab management bridge -->\r
<div data-svelte-component="tab-management-bridge" style="display: none;"></div>\r
<!-- Modal bridges -->\r
<div data-svelte-component="print-preview-bridge" style="display: none;"></div>\r
`;class rl extends jt{constructor(){const t=me(rl.getDefaults(),arguments,["delayTime","maxDelay"]);super(t),this.name="Delay";const e=this.toSeconds(t.maxDelay);this._maxDelay=Math.max(e,this.toSeconds(t.delayTime)),this._delayNode=this.input=this.output=this.context.createDelay(e),this.delayTime=new oe({context:this.context,param:this._delayNode.delayTime,units:"time",value:t.delayTime,minValue:0,maxValue:this.maxDelay}),$e(this,"delayTime")}static getDefaults(){return Object.assign(jt.getDefaults(),{delayTime:0,maxDelay:1})}get maxDelay(){return this._maxDelay}dispose(){return super.dispose(),this._delayNode.disconnect(),this.delayTime.dispose(),this}}class il extends oA{constructor(){super(me(il.getDefaults(),arguments,["value"])),this.override=!1,this.name="Add",this._sum=new Gt({context:this.context}),this.input=this._sum,this.output=this._sum,this.addend=this._param,Cu(this._constantSource,this._sum)}static getDefaults(){return Object.assign(oA.getDefaults(),{value:0})}dispose(){return super.dispose(),this._sum.dispose(),this}}class Ss extends $r{constructor(){const t=me(Ss.getDefaults(),arguments,["min","max"]);super(t),this.name="Scale",this._mult=this.input=new cg({context:this.context,value:t.max-t.min}),this._add=this.output=new il({context:this.context,value:t.min}),this._min=t.min,this._max=t.max,this.input.connect(this.output)}static getDefaults(){return Object.assign($r.getDefaults(),{max:1,min:0})}get min(){return this._min}set min(t){this._min=t,this._setRange()}get max(){return this._max}set max(t){this._max=t,this._setRange()}_setRange(){this._add.value=this._min,this._mult.value=this._max-this._min}dispose(){return super.dispose(),this._add.dispose(),this._mult.dispose(),this}}class ol extends $r{constructor(){super(me(ol.getDefaults(),arguments)),this.name="Zero",this._gain=new Gt({context:this.context}),this.output=this._gain,this.input=void 0,zo(this.context.getConstant(0),this._gain)}dispose(){return super.dispose(),dg(this.context.getConstant(0),this._gain),this}}class Jr extends jt{constructor(){const t=me(Jr.getDefaults(),arguments,["frequency","min","max"]);super(t),this.name="LFO",this._stoppedValue=0,this._units="number",this.convert=!0,this._fromType=oe.prototype._fromType,this._toType=oe.prototype._toType,this._is=oe.prototype._is,this._clampValue=oe.prototype._clampValue,this._oscillator=new Xl(t),this.frequency=this._oscillator.frequency,this._amplitudeGain=new Gt({context:this.context,gain:t.amplitude,units:"normalRange"}),this.amplitude=this._amplitudeGain.gain,this._stoppedSignal=new oA({context:this.context,units:"audioRange",value:0}),this._zeros=new ol({context:this.context}),this._a2g=new ug({context:this.context}),this._scaler=this.output=new Ss({context:this.context,max:t.max,min:t.min}),this.units=t.units,this.min=t.min,this.max=t.max,this._oscillator.chain(this._amplitudeGain,this._a2g,this._scaler),this._zeros.connect(this._a2g),this._stoppedSignal.connect(this._a2g),$e(this,["amplitude","frequency"]),this.phase=t.phase}static getDefaults(){return Object.assign(Xl.getDefaults(),{amplitude:1,frequency:"4n",max:1,min:0,type:"sine",units:"number"})}start(t){return t=this.toSeconds(t),this._stoppedSignal.setValueAtTime(0,t),this._oscillator.start(t),this}stop(t){return t=this.toSeconds(t),this._stoppedSignal.setValueAtTime(this._stoppedValue,t),this._oscillator.stop(t),this}sync(){return this._oscillator.sync(),this._oscillator.syncFrequency(),this}unsync(){return this._oscillator.unsync(),this._oscillator.unsyncFrequency(),this}_setStoppedValue(){this._stoppedValue=this._oscillator.getInitialValue(),this._stoppedSignal.value=this._stoppedValue}get min(){return this._toType(this._scaler.min)}set min(t){t=this._fromType(t),this._scaler.min=t}get max(){return this._toType(this._scaler.max)}set max(t){t=this._fromType(t),this._scaler.max=t}get type(){return this._oscillator.type}set type(t){this._oscillator.type=t,this._setStoppedValue()}get partials(){return this._oscillator.partials}set partials(t){this._oscillator.partials=t,this._setStoppedValue()}get phase(){return this._oscillator.phase}set phase(t){this._oscillator.phase=t,this._setStoppedValue()}get units(){return this._units}set units(t){const e=this.min,n=this.max;this._units=t,this.min=e,this.max=n}get state(){return this._oscillator.state}connect(t,e,n){return(t instanceof oe||t instanceof oA)&&(this.convert=t.convert,this.units=t.units),hg(this,t,e,n),this}dispose(){return super.dispose(),this._oscillator.dispose(),this._stoppedSignal.dispose(),this._zeros.dispose(),this._scaler.dispose(),this._a2g.dispose(),this._amplitudeGain.dispose(),this.amplitude.dispose(),this}}class Si extends jt{constructor(){const t=me(Si.getDefaults(),arguments,["urls","onload"],"urls");super(t),this.name="Players",this.input=void 0,this._players=new Map,this._volume=this.output=new el({context:this.context,volume:t.volume}),this.volume=this._volume.volume,$e(this,"volume"),this._buffers=new fg({urls:t.urls,onload:t.onload,baseUrl:t.baseUrl,onerror:t.onerror}),this.mute=t.mute,this._fadeIn=t.fadeIn,this._fadeOut=t.fadeOut}static getDefaults(){return Object.assign(gg.getDefaults(),{baseUrl:"",fadeIn:0,fadeOut:0,mute:!1,onload:$l,onerror:$l,urls:{},volume:0})}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}get fadeIn(){return this._fadeIn}set fadeIn(t){this._fadeIn=t,this._players.forEach(e=>{e.fadeIn=t})}get fadeOut(){return this._fadeOut}set fadeOut(t){this._fadeOut=t,this._players.forEach(e=>{e.fadeOut=t})}get state(){return Array.from(this._players).some(([e,n])=>n.state==="started")?"started":"stopped"}has(t){return this._buffers.has(t)}player(t){if(bs(this.has(t),`No Player with the name ${t} exists on this object`),!this._players.has(t)){const e=new mg({context:this.context,fadeIn:this._fadeIn,fadeOut:this._fadeOut,url:this._buffers.get(t)}).connect(this.output);this._players.set(t,e)}return this._players.get(t)}get loaded(){return this._buffers.loaded}add(t,e,n){return bs(!this._buffers.has(t),"A buffer with that name already exists on this object"),this._buffers.add(t,e,n),this}stopAll(t){return this._players.forEach(e=>e.stop(t)),this}dispose(){return super.dispose(),this._volume.dispose(),this.volume.dispose(),this._players.forEach(t=>t.dispose()),this._buffers.dispose(),this}}class Dm extends $r{constructor(){super(...arguments),this.name="GainToAudio",this._norm=new pg({context:this.context,mapping:t=>Math.abs(t)*2-1}),this.input=this._norm,this.output=this._norm}dispose(){return super.dispose(),this._norm.dispose(),this}}class jr extends jt{constructor(){const t=me(jr.getDefaults(),arguments,["frequency","type"]);super(t),this.name="BiquadFilter",this._filter=this.context.createBiquadFilter(),this.input=this.output=this._filter,this.Q=new oe({context:this.context,units:"number",value:t.Q,param:this._filter.Q}),this.frequency=new oe({context:this.context,units:"frequency",value:t.frequency,param:this._filter.frequency}),this.detune=new oe({context:this.context,units:"cents",value:t.detune,param:this._filter.detune}),this.gain=new oe({context:this.context,units:"decibels",convert:!1,value:t.gain,param:this._filter.gain}),this.type=t.type}static getDefaults(){return Object.assign(jt.getDefaults(),{Q:1,type:"lowpass",frequency:350,detune:0,gain:0})}get type(){return this._filter.type}set type(t){bs(["lowpass","highpass","bandpass","lowshelf","highshelf","notch","allpass","peaking"].indexOf(t)!==-1,`Invalid filter type: ${t}`),this._filter.type=t}getFrequencyResponse(t=128){const e=new Float32Array(t);for(let i=0;i<t;i++){const a=Math.pow(i/t,2)*19980+20;e[i]=a}const n=new Float32Array(t),s=new Float32Array(t),r=this.context.createBiquadFilter();return r.type=this.type,r.Q.value=this.Q.value,r.frequency.value=this.frequency.value,r.gain.value=this.gain.value,r.getFrequencyResponse(e,n,s),n}dispose(){return super.dispose(),this._filter.disconnect(),this.Q.dispose(),this.frequency.dispose(),this.gain.dispose(),this.detune.dispose(),this}}class es extends jt{constructor(){const t=me(es.getDefaults(),arguments,["frequency","type","rolloff"]);super(t),this.name="Filter",this.input=new Gt({context:this.context}),this.output=new Gt({context:this.context}),this._filters=[],this._filters=[],this.Q=new oA({context:this.context,units:"positive",value:t.Q}),this.frequency=new oA({context:this.context,units:"frequency",value:t.frequency}),this.detune=new oA({context:this.context,units:"cents",value:t.detune}),this.gain=new oA({context:this.context,units:"decibels",convert:!1,value:t.gain}),this._type=t.type,this.rolloff=t.rolloff,$e(this,["detune","frequency","gain","Q"])}static getDefaults(){return Object.assign(jt.getDefaults(),{Q:1,detune:0,frequency:350,gain:0,rolloff:-12,type:"lowpass"})}get type(){return this._type}set type(t){bs(["lowpass","highpass","bandpass","lowshelf","highshelf","notch","allpass","peaking"].indexOf(t)!==-1,`Invalid filter type: ${t}`),this._type=t,this._filters.forEach(n=>n.type=t)}get rolloff(){return this._rolloff}set rolloff(t){const e=wg(t)?t:parseInt(t,10),n=[-12,-24,-48,-96];let s=n.indexOf(e);bs(s!==-1,`rolloff can only be ${n.join(", ")}`),s+=1,this._rolloff=e,this.input.disconnect(),this._filters.forEach(r=>r.disconnect()),this._filters=new Array(s);for(let r=0;r<s;r++){const i=new jr({context:this.context});i.type=this._type,this.frequency.connect(i.frequency),this.detune.connect(i.detune),this.Q.connect(i.Q),this.gain.connect(i.gain),this._filters[r]=i}this._internalChannels=this._filters,Cu(this.input,...this._internalChannels,this.output)}getFrequencyResponse(t=128){const e=new jr({context:this.context,frequency:this.frequency.value,gain:this.gain.value,Q:this.Q.value,type:this._type,detune:this.detune.value}),n=new Float32Array(t).map(()=>1);return this._filters.forEach(()=>{e.getFrequencyResponse(t).forEach((r,i)=>n[i]*=r)}),e.dispose(),n}dispose(){return super.dispose(),this._filters.forEach(t=>{t.dispose()}),Bg(this,["detune","frequency","gain","Q"]),this.frequency.dispose(),this.Q.dispose(),this.detune.dispose(),this.gain.dispose(),this}}class wn extends jt{constructor(){const t=me(wn.getDefaults(),arguments,["fade"]);super(t),this.name="CrossFade",this._panner=this.context.createStereoPanner(),this._split=this.context.createChannelSplitter(2),this._g2a=new Dm({context:this.context}),this.a=new Gt({context:this.context,gain:0}),this.b=new Gt({context:this.context,gain:0}),this.output=new Gt({context:this.context}),this._internalChannels=[this.a,this.b],this.fade=new oA({context:this.context,units:"normalRange",value:t.fade}),$e(this,"fade"),this.context.getConstant(1).connect(this._panner),this._panner.connect(this._split),this._panner.channelCount=1,this._panner.channelCountMode="explicit",zo(this._split,this.a.gain,0),zo(this._split,this.b.gain,1),this.fade.chain(this._g2a,this._panner.pan),this.a.connect(this.output),this.b.connect(this.output)}static getDefaults(){return Object.assign(jt.getDefaults(),{fade:.5})}dispose(){return super.dispose(),this.a.dispose(),this.b.dispose(),this.output.dispose(),this.fade.dispose(),this._g2a.dispose(),this._panner.disconnect(),this._split.disconnect(),this}}class Zl extends jt{constructor(t){super(t),this.name="Effect",this._dryWet=new wn({context:this.context}),this.wet=this._dryWet.fade,this.effectSend=new Gt({context:this.context}),this.effectReturn=new Gt({context:this.context}),this.input=new Gt({context:this.context}),this.output=this._dryWet,this.input.fan(this._dryWet.a,this.effectSend),this.effectReturn.connect(this._dryWet.b),this.wet.setValueAtTime(t.wet,0),this._internalChannels=[this.effectReturn,this.effectSend],$e(this,"wet")}static getDefaults(){return Object.assign(jt.getDefaults(),{wet:1})}connectEffect(t){return this._internalChannels.push(t),this.effectSend.chain(t,this.effectReturn),this}dispose(){return super.dispose(),this._dryWet.dispose(),this.effectSend.dispose(),this.effectReturn.dispose(),this.wet.dispose(),this}}class tc extends Zl{constructor(t){super(t),this.name="FeedbackEffect",this._feedbackGain=new Gt({context:this.context,gain:t.feedback,units:"normalRange"}),this.feedback=this._feedbackGain.gain,$e(this,"feedback"),this.effectReturn.chain(this._feedbackGain,this.effectSend)}static getDefaults(){return Object.assign(Zl.getDefaults(),{feedback:.125})}dispose(){return super.dispose(),this._feedbackGain.dispose(),this.feedback.dispose(),this}}class al extends tc{constructor(){const t=me(al.getDefaults(),arguments,["delayTime","feedback"]);super(t),this.name="FeedbackDelay",this._delayNode=new rl({context:this.context,delayTime:t.delayTime,maxDelay:t.maxDelay}),this.delayTime=this._delayNode.delayTime,this.connectEffect(this._delayNode),$e(this,"delayTime")}static getDefaults(){return Object.assign(tc.getDefaults(),{delayTime:.25,maxDelay:1})}dispose(){return super.dispose(),this._delayNode.dispose(),this.delayTime.dispose(),this}}class Zr extends jt{constructor(){super(me(Zr.getDefaults(),arguments)),this.name="MeterBase",this.input=this.output=this._analyser=new Al({context:this.context,size:256,type:"waveform"})}dispose(){return super.dispose(),this._analyser.dispose(),this}}class ll extends Zr{constructor(){const t=me(ll.getDefaults(),arguments,["smoothing"]);super(t),this.name="Meter",this.input=this.output=this._analyser=new Al({context:this.context,size:256,type:"waveform",channels:t.channelCount}),this.smoothing=t.smoothing,this.normalRange=t.normalRange,this._rms=new Array(t.channelCount),this._rms.fill(0)}static getDefaults(){return Object.assign(Zr.getDefaults(),{smoothing:.8,normalRange:!1,channelCount:1})}getLevel(){return vg("'getLevel' has been changed to 'getValue'"),this.getValue()}getValue(){const t=this._analyser.getValue(),n=(this.channels===1?[t]:t).map((s,r)=>{const i=s.reduce((a,l)=>a+l*l,0),o=Math.sqrt(i/s.length);return this._rms[r]=Math.max(o,this._rms[r]*this.smoothing),this.normalRange?this._rms[r]:Cg(this._rms[r])});return this.channels===1?n[0]:n}get channels(){return this._analyser.channels}dispose(){return super.dispose(),this._analyser.dispose(),this}}class Ei extends jt{constructor(){const t=me(Ei.getDefaults(),arguments,["threshold","ratio"]);super(t),this.name="Compressor",this._compressor=this.context.createDynamicsCompressor(),this.input=this._compressor,this.output=this._compressor,this.threshold=new oe({minValue:this._compressor.threshold.minValue,maxValue:this._compressor.threshold.maxValue,context:this.context,convert:!1,param:this._compressor.threshold,units:"decibels",value:t.threshold}),this.attack=new oe({minValue:this._compressor.attack.minValue,maxValue:this._compressor.attack.maxValue,context:this.context,param:this._compressor.attack,units:"time",value:t.attack}),this.release=new oe({minValue:this._compressor.release.minValue,maxValue:this._compressor.release.maxValue,context:this.context,param:this._compressor.release,units:"time",value:t.release}),this.knee=new oe({minValue:this._compressor.knee.minValue,maxValue:this._compressor.knee.maxValue,context:this.context,convert:!1,param:this._compressor.knee,units:"decibels",value:t.knee}),this.ratio=new oe({minValue:this._compressor.ratio.minValue,maxValue:this._compressor.ratio.maxValue,context:this.context,convert:!1,param:this._compressor.ratio,units:"positive",value:t.ratio}),$e(this,["knee","release","attack","ratio","threshold"])}static getDefaults(){return Object.assign(jt.getDefaults(),{attack:.003,knee:30,ratio:12,release:.25,threshold:-24})}get reduction(){return this._compressor.reduction}dispose(){return super.dispose(),this._compressor.disconnect(),this.attack.dispose(),this.release.dispose(),this.threshold.dispose(),this.ratio.dispose(),this.knee.dispose(),this}}class cl extends jt{constructor(){const t=me(cl.getDefaults(),arguments,["threshold"]);super(t),this.name="Limiter",this._compressor=this.input=this.output=new Ei({context:this.context,ratio:20,attack:.003,release:.01,threshold:t.threshold}),this.threshold=this._compressor.threshold,$e(this,"threshold")}static getDefaults(){return Object.assign(jt.getDefaults(),{threshold:-12})}get reduction(){return this._compressor.reduction}dispose(){return super.dispose(),this._compressor.dispose(),this.threshold.dispose(),this}}const Nm={attack:.01,decay:.1,sustain:.7,release:.3},Rm={enabled:!1,blend:.5,cutoff:.5,resonance:0,type:"lowpass",mix:1},km={speed:5,span:0},_m={speed:5,span:0};function Om(){const A=["#4a90e2","#e24a4a","#4ae24a","#e2e24a","#e24ae2","#4ae2e2","#e2a04a","#a04ae2"],t={};return A.forEach(e=>{const n=new Float32Array(32);n[0]=1;const s=new Float32Array(32);t[e]={name:"Sine",adsr:{...Nm},coeffs:n,phases:s,filter:{...Rm},activePresetName:"sine",gain:1,vibrato:{...km},tremelo:{..._m}}}),t}function Km(){return{macrobeatGroupings:[2,2,2,2],macrobeatBoundaryStyles:["dashed","dashed","dashed","dashed"],hasAnacrusis:!1,baseMicrobeatPx:40,modulationMarkers:[]}}function Gm(){const A=bg("G5","C4");return A||{topIndex:0,bottomIndex:Math.max(0,He.length-1)}}function Wm(){const A=Om();return{placedNotes:[],placedChords:[],tonicSignGroups:{},sixteenthStampPlacements:[],tripletStampPlacements:[],annotations:[],lassoSelection:{selectedItems:[],convexHull:null,isActive:!1},history:[{notes:[],tonicSignGroups:{},timbres:JSON.parse(JSON.stringify(A)),placedChords:[],sixteenthStampPlacements:[],tripletStampPlacements:[],annotations:[],lassoSelection:{selectedItems:[],convexHull:null,isActive:!1}}],historyIndex:0,fullRowData:[...He],pitchRange:Gm(),...Km(),selectedModulationRatio:null,timbres:A,colorPalette:{"#4a90e2":{primary:"#4a90e2",light:"#a8c8f0"},"#e24a4a":{primary:"#e24a4a",light:"#f0a8a8"},"#4ae24a":{primary:"#4ae24a",light:"#a8f0a8"},"#e2e24a":{primary:"#e2e24a",light:"#f0f0a8"},"#e24ae2":{primary:"#e24ae2",light:"#f0a8f0"},"#4ae2e2":{primary:"#4ae2e2",light:"#a8f0f0"},"#e2a04a":{primary:"#e2a04a",light:"#f0d0a8"},"#a04ae2":{primary:"#a04ae2",light:"#d0a8f0"}},selectedTool:"note",previousTool:"note",selectedToolTonicNumber:1,selectedNote:{shape:"circle",color:"#4a90e2"},deviceProfile:{isMobile:!1,isTouch:!1,isCoarsePointer:!1,orientation:"landscape",width:0,height:0},activeChordId:null,activeChordIntervals:["1P"],isIntervalsInverted:!1,chordPositionState:0,gridPosition:0,viewportRows:0,logicRows:0,cellWidth:0,cellHeight:0,columnWidths:[],musicalColumnWidths:[],degreeDisplayMode:"off",accidentalMode:{sharp:!0,flat:!0},showFrequencyLabels:!1,showOctaveLabels:!0,focusColours:!1,isPlaying:!1,isPaused:!1,isLooping:!1,tempo:90,playheadMode:"cursor",waveformExtendedView:!1,adsrTimeAxisScale:1,isPrintPreviewActive:!1,printOptions:{pageSize:"letter",includeButtonGrid:!0,includeDrums:!0,includeLeftLegend:!0,includeRightLegend:!0,orientation:"landscape",colorMode:"color",cropTop:0,cropBottom:1,cropLeft:0,cropRight:1},longNoteStyle:"style1"}}function ec(A){if(!(!A||A.isDrum)&&A.shape==="circle"&&typeof A.startColumnIndex=="number"){const t=A.startColumnIndex+1;(typeof A.endColumnIndex!="number"||A.endColumnIndex<t)&&(A.endColumnIndex=t)}}function $i(A,t){if(typeof A.row!="number")return;const e=t.length>0?t.length-1:-1;if(e<0)return;const n=typeof A.globalRow=="number"?A.globalRow:A.row,s=Math.max(0,Math.min(e,Math.round(n)));A.globalRow=s,A.row=s}function Yi(){return`uuid-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function Vm(A={}){const{getMacrobeatInfo:t,getDegreeForNote:e,hasAccidental:n,log:s=()=>{}}=A;return{addNote(r){const i=this.state.placedNotes.find(a=>!a.isDrum&&a.row===r.row&&a.startColumnIndex===r.startColumnIndex&&a.color===r.color);if(i){if(this.state.degreeDisplayMode!=="off"&&e&&n){const a=e(i,this.state);if(a&&n(a))return i.enharmonicPreference=!i.enharmonicPreference,s("debug","[ENHARMONIC] Toggled enharmonic preference for note",{noteUuid:i.uuid,currentDegree:a,enharmonicPreference:i.enharmonicPreference}),this.emit("notesChanged"),i}return null}const o={...r,uuid:Yi()};return ec(o),$i(o,this.state.fullRowData),this.state.placedNotes.push(o),this.emit("notesChanged"),o},updateNoteTail(r,i){let o=i;r.shape==="circle"&&(o=Math.max(r.startColumnIndex+1,i)),r.endColumnIndex=o,this.emit("notesChanged")},updateMultipleNoteTails(r,i){r.forEach(o=>{let a=i;o.shape==="circle"&&(a=Math.max(o.startColumnIndex+1,i)),o.endColumnIndex=a}),this.emit("notesChanged")},updateNoteRow(r,i){r.row=i,r.globalRow=i,this.emit("notesChanged")},updateMultipleNoteRows(r,i){r.forEach((o,a)=>{const l=i[a];l!==void 0&&(o.row=l,$i(o,this.state.fullRowData))}),this.emit("notesChanged")},updateNotePosition(r,i){r.startColumnIndex=i,r.endColumnIndex=r.shape==="circle"?i+1:i,this.emit("notesChanged")},updateMultipleNotePositions(r,i){r.forEach(o=>{o.startColumnIndex=i,o.endColumnIndex=o.shape==="circle"?i+1:i}),this.emit("notesChanged")},removeNote(r){const i=this.state.placedNotes.indexOf(r);i>-1&&(this.state.placedNotes.splice(i,1),this.emit("notesChanged"))},removeMultipleNotes(r){const i=new Set(r);this.state.placedNotes=this.state.placedNotes.filter(o=>!i.has(o)),this.emit("notesChanged")},eraseInPitchArea(r,i,o=1,a=!0){const l=r+o-1,d=i-1,u=i+1;let h=!1;const m=this.state.placedNotes.length;return this.state.placedNotes=this.state.placedNotes.filter(f=>{if(f.isDrum)return!0;if(f.shape==="circle"){const g=f.startColumnIndex+1,p=typeof f.endColumnIndex=="number"?Math.max(g,f.endColumnIndex):g,w=f.startColumnIndex<=l&&p>=r,v=f.row>=d&&f.row<=u;if(w&&v)return!1}else if(f.row>=d&&f.row<=u&&f.startColumnIndex<=l&&f.endColumnIndex>=r)return!1;return!0}),this.state.placedNotes.length<m&&(h=!0),h&&(this.emit("notesChanged"),a&&this.recordState()),h},addTonicSignGroup(r){s("debug","Starting addTonicSignGroup",{tonicSignGroup:r});const i=r[0];if(!i)return;const{preMacrobeatIndex:o}=i;if(s("debug","preMacrobeatIndex",{preMacrobeatIndex:o}),Object.entries(this.state.tonicSignGroups).find(([,m])=>m.some(f=>f.preMacrobeatIndex===o))){s("debug","Existing tonic already present for measure, skipping",{preMacrobeatIndex:o});return}if(!t){s("error","getMacrobeatInfo callback not provided");return}const l=t(this.state,o+1).startColumn;s("debug","Boundary column (canvas-space) for shifting notes",{boundaryColumn:l});const d=this.state.placedNotes.filter(m=>m.startColumnIndex>=l);s("debug","Notes that will be shifted",{noteRanges:d.map(m=>`${m.startColumnIndex}-${m.endColumnIndex}`)}),this.state.placedNotes.forEach(m=>{if(m.startColumnIndex>=l){const f=m.startColumnIndex,g=m.endColumnIndex;m.startColumnIndex=m.startColumnIndex+2,m.endColumnIndex=m.endColumnIndex+2,s("debug",`Shifted note from ${f}-${g} to ${m.startColumnIndex}-${m.endColumnIndex}`)}});const u=Yi(),h=r.map(m=>({...m,uuid:u,globalRow:typeof m.globalRow=="number"?m.globalRow:m.row}));this.state.tonicSignGroups[u]=h,s("debug","Added tonic group",{uuid:u,columns:h.map(m=>m.columnIndex)}),s("debug","Emitting events: notesChanged, rhythmStructureChanged"),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},eraseTonicSignAt(r,i=!0){const o=Object.entries(this.state.tonicSignGroups).find(([,m])=>m.some(f=>f.columnIndex===r));if(!o)return!1;if(!t)return s("error","getMacrobeatInfo callback not provided"),!1;const[a,l]=o,d=l[0];if(!d)return!1;const u=d.preMacrobeatIndex,h=t(this.state,u+1).startColumn;return delete this.state.tonicSignGroups[a],this.state.placedNotes.forEach(m=>{m.startColumnIndex>=h&&(m.startColumnIndex=m.startColumnIndex-2,m.endColumnIndex=m.endColumnIndex-2)}),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),i&&this.recordState(),!0},clearAllNotes(){this.state.placedNotes=[],this.state.tonicSignGroups={},this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},loadNotes(r){const i=(r||[]).map(o=>{const a={...o,uuid:o?.uuid??Yi()};return ec(a),$i(a,this.state.fullRowData),a});this.state.placedNotes=i,this.emit("notesChanged"),this.recordState()}}}function zm(){return`sixteenth-stamp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function qm(A={}){const{getPlacedTonicSigns:t,isWithinTonicSpan:e,log:n=()=>{}}=A;return{addSixteenthStampPlacement(s,r,i,o="#4a90e2"){const a=r+2;if(t&&e){const h=t(this.state);(e(r,h)||e(r+1,h))&&n("debug","Cannot place sixteenth stamp - overlaps tonic column",{sixteenthStampId:s,startColumn:r,row:i})}const l=this.state.sixteenthStampPlacements.find(h=>h.row===i&&h.startColumn<a&&h.endColumn>r);l&&this.removeSixteenthStampPlacement(l.id);const d=i,u={id:zm(),sixteenthStampId:s,startColumn:r,endColumn:a,row:i,globalRow:d,color:o,timestamp:Date.now(),shapeOffsets:{}};return this.state.sixteenthStampPlacements.push(u),this.emit("sixteenthStampPlacementsChanged"),n("debug",`Added sixteenth stamp ${s} at canvas-space ${r}-${a},${i}`,{sixteenthStampId:s,startColumn:r,endColumn:a,row:i,placementId:u.id}),u},removeSixteenthStampPlacement(s){const r=this.state.sixteenthStampPlacements.findIndex(o=>o.id===s);if(r===-1)return!1;const i=this.state.sixteenthStampPlacements.splice(r,1)[0];return i?(this.emit("sixteenthStampPlacementsChanged"),n("debug",`Removed sixteenth stamp ${i.sixteenthStampId} at ${i.startColumn}-${i.endColumn},${i.row}`,{placementId:s,sixteenthStampId:i.sixteenthStampId,startColumn:i.startColumn,endColumn:i.endColumn,row:i.row}),!0):!1},eraseSixteenthStampsInArea(s,r,i,o){const a=[];for(const d of this.state.sixteenthStampPlacements){const u=d.startColumn<=r&&d.endColumn>=s,h=d.row>=i&&d.row<=o;u&&h&&a.push(d.id)}let l=!1;return a.forEach(d=>{this.removeSixteenthStampPlacement(d)&&(l=!0)}),l},getAllSixteenthStampPlacements(){return[...this.state.sixteenthStampPlacements]},getSixteenthStampAt(s,r){return this.state.sixteenthStampPlacements.find(i=>i.row===r&&s>=i.startColumn&&s<i.endColumn)||null},clearAllSixteenthStamps(){const s=this.state.sixteenthStampPlacements.length>0;this.state.sixteenthStampPlacements=[],s&&(this.emit("sixteenthStampPlacementsChanged"),n("info","Cleared all sixteenth stamp placements"))},getSixteenthStampPlaybackData(){return this.state.sixteenthStampPlacements.map(s=>{const r=this.state.fullRowData[s.row];return{sixteenthStampId:s.sixteenthStampId,column:s.startColumn,startColumn:s.startColumn,endColumn:s.endColumn,row:s.row,pitch:r?.toneNote||"",color:s.color,placement:s}}).filter(s=>s.pitch)},updateSixteenthStampShapeOffset(s,r,i){const o=this.state.sixteenthStampPlacements.find(a=>a.id===s);if(!o){n("warn","[SIXTEENTH STAMP SHAPE OFFSET] Placement not found",{placementId:s});return}o.shapeOffsets||(o.shapeOffsets={}),n("debug","[SIXTEENTH STAMP SHAPE OFFSET] Updating shape offset",{placementId:s,shapeKey:r,oldOffset:o.shapeOffsets[r]||0,newOffset:i,baseRow:o.row,targetRow:o.row+i}),o.shapeOffsets[r]=i,this.emit("sixteenthStampPlacementsChanged")},getSixteenthStampShapeRow(s,r){const i=s.shapeOffsets?.[r]||0;return s.row+i}}}function Xm(){return`triplet-stamp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function $m(A={}){const{canvasToTime:t,timeToCanvas:e,getColumnMap:n,log:s=()=>{}}=A;return{addTripletStampPlacement(r){this.state.tripletStampPlacements||(this.state.tripletStampPlacements=[]);const i=r.startTimeIndex+r.span*2,o=this.state.tripletStampPlacements.find(l=>l.row!==r.row?!1:!(l.startTimeIndex+l.span*2<=r.startTimeIndex||i<=l.startTimeIndex));if(o&&this.removeTripletStampPlacement(o.id),this.state.sixteenthStampPlacements&&t&&n){const l=n(this.state);this.state.sixteenthStampPlacements.filter(u=>{if(u.row!==r.row)return!1;const h=t(u.startColumn,l);return h===null?!0:!(h+2<=r.startTimeIndex||h>=i)}).forEach(u=>{this.removeSixteenthStampPlacement&&this.removeSixteenthStampPlacement(u.id)})}const a={id:Xm(),...r,shapeOffsets:r.shapeOffsets||{}};return this.state.tripletStampPlacements.push(a),this.emit("tripletStampPlacementsChanged"),this.emit("rhythmStructureChanged"),s("debug",`Added triplet stamp ${r.tripletStampId} at time ${r.startTimeIndex}, row ${r.row}`,{tripletStampId:r.tripletStampId,startTimeIndex:r.startTimeIndex,span:r.span,row:r.row,placementId:a.id}),a},removeTripletStampPlacement(r){if(!this.state.tripletStampPlacements)return!1;const i=this.state.tripletStampPlacements.findIndex(a=>a.id===r);if(i===-1)return!1;const o=this.state.tripletStampPlacements.splice(i,1)[0];return o?(this.emit("tripletStampPlacementsChanged"),s("debug",`Removed triplet stamp ${o.tripletStampId} at time ${o.startTimeIndex}, row ${o.row}`,{placementId:r,tripletStampId:o.tripletStampId,startTimeIndex:o.startTimeIndex,span:o.span,row:o.row}),!0):!1},eraseTripletStampsInArea(r,i,o,a){if(!this.state.tripletStampPlacements||!e||!n)return!1;const l=n(this.state),d=[];for(const h of this.state.tripletStampPlacements)if(h.row>=o&&h.row<=a){const m=h.span*2,f=e(h.startTimeIndex,l);f+m-1<r||f>i||d.push(h.id)}let u=!1;return d.forEach(h=>{this.removeTripletStampPlacement(h)&&(u=!0)}),u},getAllTripletStampPlacements(){return[...this.state.tripletStampPlacements||[]]},getTripletStampAt(r,i){return this.state.tripletStampPlacements&&this.state.tripletStampPlacements.find(o=>o.row===i&&r>=o.startTimeIndex&&r<o.startTimeIndex+o.span*2)||null},clearAllTripletStamps(){if(!this.state.tripletStampPlacements)return;const r=this.state.tripletStampPlacements.length>0;this.state.tripletStampPlacements=[],r&&(this.emit("tripletStampPlacementsChanged"),s("info","Cleared all triplet stamp placements"))},getTripletStampPlaybackData(){return this.state.tripletStampPlacements?this.state.tripletStampPlacements.map(r=>{const i=this.state.fullRowData[r.row];return{startTimeIndex:r.startTimeIndex,tripletStampId:r.tripletStampId,row:r.row,pitch:i?.toneNote??"",color:r.color,span:r.span,placement:r}}).filter(r=>r.pitch):[]},updateTripletStampShapeOffset(r,i,o){const a=this.state.tripletStampPlacements?.find(l=>l.id===r);if(!a){s("warn","[TRIPLET STAMP SHAPE OFFSET] Placement not found",{placementId:r});return}a.shapeOffsets||(a.shapeOffsets={}),s("debug","[TRIPLET STAMP SHAPE OFFSET] Updating shape offset",{placementId:r,shapeKey:i,oldOffset:a.shapeOffsets[i]||0,newOffset:o,baseRow:a.row,targetRow:a.row+o}),a.shapeOffsets[i]=o,this.emit("tripletStampPlacementsChanged")},getTripletStampShapeRow(r,i){const o=r.shapeOffsets?.[i]||0;return r.row+o}}}function Ac(A){const t=JSON.parse(JSON.stringify(A));for(const e in t){const n=t[e];n.coeffs&&typeof n.coeffs=="object"&&!Array.isArray(n.coeffs)?n.coeffs=new Float32Array(Object.values(n.coeffs)):Array.isArray(n.coeffs)&&(n.coeffs=new Float32Array(n.coeffs)),n.phases&&typeof n.phases=="object"&&!Array.isArray(n.phases)?n.phases=new Float32Array(Object.values(n.phases)):Array.isArray(n.phases)&&(n.phases=new Float32Array(n.phases))}return t}function Ym(A,t){if(A)try{const e=A.getItem(t);if(e===null)return;const n=JSON.parse(e);if(n.timbres)for(const s in n.timbres){const r=n.timbres[s];if(r.coeffs&&typeof r.coeffs=="object"){const i=Array.isArray(r.coeffs)?r.coeffs:Object.values(r.coeffs);r.coeffs=new Float32Array(i)}if(r.phases&&typeof r.phases=="object"){const i=Array.isArray(r.phases)?r.phases:Object.values(r.phases);r.phases=new Float32Array(i)}}if(n.pitchRange){const s=He.length,r=Math.max(0,s-1),i=Math.max(0,Math.min(r,n.pitchRange.topIndex??0)),o=Math.max(i,Math.min(r,n.pitchRange.bottomIndex??r));n.pitchRange={topIndex:i,bottomIndex:o}}if("playheadMode"in n){const s=n.playheadMode;s!=="cursor"&&s!=="microbeat"&&s!=="macrobeat"&&delete n.playheadMode}return n.fullRowData=[...He],n}catch{return}}function Jm(A,t,e){if(t)try{const n=JSON.parse(JSON.stringify({placedNotes:A.placedNotes,placedChords:A.placedChords,tonicSignGroups:A.tonicSignGroups,sixteenthStampPlacements:A.sixteenthStampPlacements,tripletStampPlacements:A.tripletStampPlacements,timbres:A.timbres,macrobeatGroupings:A.macrobeatGroupings,macrobeatBoundaryStyles:A.macrobeatBoundaryStyles,hasAnacrusis:A.hasAnacrusis,baseMicrobeatPx:A.baseMicrobeatPx,modulationMarkers:A.modulationMarkers,tempo:A.tempo,activeChordIntervals:A.activeChordIntervals,selectedNote:A.selectedNote,annotations:A.annotations,pitchRange:A.pitchRange,degreeDisplayMode:A.degreeDisplayMode,showOctaveLabels:A.showOctaveLabels,longNoteStyle:A.longNoteStyle,playheadMode:A.playheadMode}));if(A.timbres)for(const r in A.timbres){const i=A.timbres[r],o=n.timbres?.[r];i?.coeffs&&o&&(o.coeffs=Array.from(i.coeffs)),i?.phases&&o&&(o.phases=Array.from(i.phases))}const s=JSON.stringify(n);t.setItem(e,s)}catch{}}function jm(A={}){const{storageKey:t="studentNotationState",storage:e,initialState:n,onClearState:s,noteActionCallbacks:r={},sixteenthStampActionCallbacks:i={},tripletStampActionCallbacks:o={},rhythmActionCallbacks:a={}}=A,l={},d=Ym(e,t),u=!d,f={state:{...Wm(),...d,...n},isColdStart:u,on(g,p){l[g]||(l[g]=[]),l[g].push(p)},off(g,p){if(l[g]){const w=l[g].indexOf(p);w>-1&&l[g].splice(w,1)}},emit(g,p){l[g]&&l[g].forEach(w=>{try{w(p)}catch(v){console.error(`Error in listener for event "${g}"`,v)}})},dispose(){for(const g in l)delete l[g]},saveState(){Jm(f.state,e,t)},recordState(){f.state.history=f.state.history.slice(0,f.state.historyIndex+1);const g=JSON.parse(JSON.stringify(f.state.timbres)),p={notes:JSON.parse(JSON.stringify(f.state.placedNotes)),tonicSignGroups:JSON.parse(JSON.stringify(f.state.tonicSignGroups)),placedChords:JSON.parse(JSON.stringify(f.state.placedChords)),sixteenthStampPlacements:JSON.parse(JSON.stringify(f.state.sixteenthStampPlacements)),tripletStampPlacements:JSON.parse(JSON.stringify(f.state.tripletStampPlacements||[])),timbres:g,annotations:f.state.annotations?JSON.parse(JSON.stringify(f.state.annotations)):[],lassoSelection:JSON.parse(JSON.stringify(f.state.lassoSelection))};f.state.history.push(p),f.state.historyIndex++,f.emit("historyChanged"),f.saveState()},undo(){if(f.state.historyIndex>0){f.state.historyIndex--;const g=f.state.history[f.state.historyIndex];if(!g)return;f.state.placedNotes=JSON.parse(JSON.stringify(g.notes)),f.state.tonicSignGroups=JSON.parse(JSON.stringify(g.tonicSignGroups)),f.state.sixteenthStampPlacements=JSON.parse(JSON.stringify(g.sixteenthStampPlacements||[])),f.state.tripletStampPlacements=JSON.parse(JSON.stringify(g.tripletStampPlacements||[])),f.state.timbres=Ac(g.timbres),f.state.annotations=g.annotations?JSON.parse(JSON.stringify(g.annotations)):[],f.emit("notesChanged"),f.emit("sixteenthStampPlacementsChanged"),f.emit("tripletStampPlacementsChanged"),f.emit("rhythmStructureChanged"),f.state.selectedNote?.color&&f.emit("timbreChanged",f.state.selectedNote.color),f.emit("annotationsChanged"),f.emit("historyChanged")}},redo(){if(f.state.historyIndex<f.state.history.length-1){f.state.historyIndex++;const g=f.state.history[f.state.historyIndex];if(!g)return;f.state.placedNotes=JSON.parse(JSON.stringify(g.notes)),f.state.tonicSignGroups=JSON.parse(JSON.stringify(g.tonicSignGroups)),f.state.sixteenthStampPlacements=JSON.parse(JSON.stringify(g.sixteenthStampPlacements||[])),f.state.tripletStampPlacements=JSON.parse(JSON.stringify(g.tripletStampPlacements||[])),f.state.timbres=Ac(g.timbres),f.state.annotations=g.annotations?JSON.parse(JSON.stringify(g.annotations)):[],f.emit("notesChanged"),f.emit("sixteenthStampPlacementsChanged"),f.emit("tripletStampPlacementsChanged"),f.emit("rhythmStructureChanged"),f.state.selectedNote?.color&&f.emit("timbreChanged",f.state.selectedNote.color),f.emit("annotationsChanged"),f.emit("historyChanged")}},clearSavedState(){e&&(e.removeItem(t),e.removeItem("effectDialValues")),s&&s()},setPlaybackState(g,p){f.state.isPlaying=g,f.state.isPaused=p,f.emit("playbackStateChanged",{isPlaying:g,isPaused:p})},setLooping(g){f.state.isLooping=g,f.emit("loopingChanged",g)},setTempo(g){f.state.tempo=g,f.emit("tempoChanged",g)},setPlayheadMode(g){f.state.playheadMode=g,f.emit("playheadModeChanged",g)},setSelectedTool(g,p){const w=f.state.selectedTool;if(f.state.previousTool=w,f.state.selectedTool=g,p!==void 0){const v=typeof p=="string"?parseInt(p,10):p;isNaN(v)||(f.state.selectedToolTonicNumber=v)}f.emit("toolChanged",{newTool:g,oldTool:w})},setSelectedNote(g,p){const w={...f.state.selectedNote};f.state.selectedNote={shape:g,color:p},f.emit("noteChanged",{newNote:f.state.selectedNote,oldNote:w})},setPitchRange(g){f.state.pitchRange={...f.state.pitchRange,...g},f.emit("pitchRangeChanged",f.state.pitchRange)},setDegreeDisplayMode(g){f.state.degreeDisplayMode=g,f.emit("degreeDisplayModeChanged",g)},setLongNoteStyle(g){f.state.longNoteStyle=g,f.emit("longNoteStyleChanged",g)},toggleAccidentalMode(g){f.state.accidentalMode[g]=!f.state.accidentalMode[g],f.emit("accidentalModeChanged",f.state.accidentalMode)},toggleFrequencyLabels(){f.state.showFrequencyLabels=!f.state.showFrequencyLabels,f.emit("frequencyLabelsChanged",f.state.showFrequencyLabels)},toggleOctaveLabels(){f.state.showOctaveLabels=!f.state.showOctaveLabels,f.emit("octaveLabelsChanged",f.state.showOctaveLabels)},toggleFocusColours(){f.state.focusColours=!f.state.focusColours,f.emit("focusColoursChanged",f.state.focusColours)},toggleWaveformExtendedView(){f.state.waveformExtendedView=!f.state.waveformExtendedView,f.emit("waveformExtendedViewChanged",f.state.waveformExtendedView)},setLayoutConfig(g){g.cellWidth!==void 0&&(f.state.cellWidth=g.cellWidth),g.cellHeight!==void 0&&(f.state.cellHeight=g.cellHeight),g.columnWidths!==void 0&&(f.state.columnWidths=g.columnWidths),f.emit("layoutConfigChanged",g)},setDeviceProfile(g){f.state.deviceProfile={...f.state.deviceProfile,...g},f.emit("deviceProfileChanged",f.state.deviceProfile)},setPrintPreviewActive(g){f.state.isPrintPreviewActive=g,f.emit("printPreviewStateChanged",g)},setPrintOptions(g){f.state.printOptions={...f.state.printOptions,...g},f.emit("printOptionsChanged",f.state.printOptions)},setAdsrTimeAxisScale(g){f.state.adsrTimeAxisScale=g,f.emit("adsrTimeAxisScaleChanged",g)},setAdsrComponentWidth(){},shiftGridUp(){},shiftGridDown(){},setGridPosition(){},setKeySignature(g){f.state.keySignature=g,f.emit("keySignatureChanged",g)},setActiveChordIntervals(g){f.state.activeChordIntervals=g,f.emit("activeChordIntervalsChanged",g)},setIntervalsInversion(g){f.state.isIntervalsInverted=g,f.emit("intervalsInversionChanged",g)},setChordPosition(g){f.state.chordPositionState=g,f.emit("chordPositionChanged",g)},setADSR(g,p){f.state.timbres[g]&&(f.state.timbres[g].adsr={...f.state.timbres[g].adsr,...p},f.emit("timbreChanged",g))},setHarmonicCoefficients(g,p){f.state.timbres[g]&&(f.state.timbres[g].coeffs=p,f.emit("timbreChanged",g))},setHarmonicPhases(g,p){f.state.timbres[g]&&(f.state.timbres[g].phases=p,f.emit("timbreChanged",g))},setFilterSettings(g,p){f.state.timbres[g]&&(f.state.timbres[g].filter={...f.state.timbres[g].filter,...p},f.emit("timbreChanged",g))},applyPreset(g,p){f.state.timbres[g]&&(Object.assign(f.state.timbres[g],p),f.emit("timbreChanged",g))},...Vm(r),...qm(i),...$m(o),...yg(a)};return e&&(f.on("tempoChanged",()=>f.saveState()),f.on("degreeDisplayModeChanged",()=>f.saveState()),f.on("longNoteStyleChanged",()=>f.saveState()),f.on("playheadModeChanged",()=>f.saveState())),u&&e&&f.saveState(),f}class Zm extends Sg{presetGain;vibratoLFO;vibratoDepth;vibratoGain;tremoloLFO;tremoloDepth;tremoloGain;hpFilter;lpFilterForBP;lpFilterSolo;hpOutput;bpOutput;lpOutput;hp_bp_fade;main_fade;wetDryFade;constructor(t){super(t),this.presetGain=new Gt(t.gain||1),this.vibratoLFO=new Jr(0,0),this.vibratoDepth=new Ss(-1,1),this.vibratoGain=new Gt(0),this.vibratoLFO.connect(this.vibratoDepth),this.vibratoDepth.connect(this.vibratoGain),this.vibratoGain.connect(this.oscillator.frequency),this.tremoloLFO=new Jr(0,0),this.tremoloDepth=new Ss(0,1),this.tremoloGain=new Gt(1),this.tremoloLFO.connect(this.tremoloDepth),this.tremoloDepth.connect(this.tremoloGain.gain),this.hpFilter=new es({type:"highpass"}),this.lpFilterForBP=new es({type:"lowpass"}),this.lpFilterSolo=new es({type:"lowpass"}),this.hpOutput=new Gt,this.bpOutput=new Gt,this.lpOutput=new Gt,this.hp_bp_fade=new wn(0),this.main_fade=new wn(0),this.wetDryFade=new wn(0),this.oscillator.connect(this.presetGain),this.presetGain.connect(this.wetDryFade.a),this.presetGain.connect(this.hpFilter),this.hpFilter.connect(this.hpOutput),this.hpFilter.connect(this.lpFilterForBP),this.lpFilterForBP.connect(this.bpOutput),this.presetGain.connect(this.lpFilterSolo),this.lpFilterSolo.connect(this.lpOutput),this.hpOutput.connect(this.hp_bp_fade.a),this.bpOutput.connect(this.hp_bp_fade.b),this.lpOutput.connect(this.main_fade.b),this.hp_bp_fade.connect(this.main_fade.a),this.main_fade.connect(this.wetDryFade.b),this.wetDryFade.connect(this.tremoloGain),this.tremoloGain.connect(this.envelope),t.filter&&this._setFilter(t.filter),t.vibrato?this._setVibrato(t.vibrato):this._setVibrato({speed:0,span:0}),t.tremelo?this._setTremolo(t.tremelo):this._setTremolo({speed:0,span:0})}_setPresetGain(t){this.presetGain&&(this.presetGain.gain.value=t)}_setVibrato(t,e=Dt()){if(!this.vibratoLFO||!this.vibratoGain)return;const n=t.speed/100*16,r=(Yl()?.rawContext?.state??ys.state)==="running";if(t.speed===0||t.span===0){r&&this.vibratoLFO.state==="started"&&this.vibratoLFO.stop(e),this.vibratoLFO.frequency.value=0,this.vibratoGain.gain.value=0;return}r&&this.vibratoLFO.state!=="started"&&this.vibratoLFO.start(e),this.vibratoLFO.frequency.value=n;const a=t.span/100*50/1200,u=440*(Math.pow(2,a)-1);this.vibratoGain.gain.value=u}_setTremolo(t,e=Dt()){if(!this.tremoloLFO||!this.tremoloGain)return;const n=t.speed/100*16,r=(Yl()?.rawContext?.state??ys.state)==="running";if(t.speed===0||t.span===0){r&&this.tremoloLFO.state==="started"&&this.tremoloLFO.stop(e),this.tremoloLFO.frequency.value=0,this.tremoloGain.gain.cancelScheduledValues(e),this.tremoloGain.gain.value=1;return}r&&this.tremoloLFO.state!=="started"&&this.tremoloLFO.start(e),this.tremoloLFO.frequency.value=n;const i=t.span/100,o=Math.max(0,1-i),a=1;this.tremoloDepth.min=o,this.tremoloDepth.max=a}_setFilter(t){this.wetDryFade.fade.value=t.enabled?1:0;const e=Eg(t.cutoff+35).toFrequency(),n=t.resonance/100*12+.1;this.hpFilter.set({frequency:e,Q:n}),this.lpFilterForBP.set({frequency:e,Q:n}),this.lpFilterSolo.set({frequency:e,Q:n});const s=t.blend;s<=1?(this.main_fade.fade.value=0,this.hp_bp_fade.fade.value=s):(this.main_fade.fade.value=s-1,this.hp_bp_fade.fade.value=1)}}const bu={polyphonyReference:32,smoothingTauMs:200,masterGainRampMs:50,gainUpdateIntervalMs:16};function yu(A=bu.polyphonyReference){return 1/Math.sqrt(A)}class tp{masterGain;options;perVoiceBaselineGain;activeVoiceCount=0;smoothedVoiceCount;gainUpdateLoopId=null;constructor(t,e={}){this.masterGain=t,this.options={...bu,...e},this.perVoiceBaselineGain=yu(this.options.polyphonyReference),this.smoothedVoiceCount=this.options.polyphonyReference}start(){this.stop(),this.gainUpdateLoopId=setInterval(()=>this.updateMasterGain(),this.options.gainUpdateIntervalMs)}stop(){this.gainUpdateLoopId!==null&&(clearInterval(this.gainUpdateLoopId),this.gainUpdateLoopId=null)}noteOn(t=1){t<=0||(this.activeVoiceCount+=t)}noteOff(t=1){t<=0||(this.activeVoiceCount=Math.max(0,this.activeVoiceCount-t))}clampActiveVoiceCountToAtMost(t){Number.isFinite(t)&&(this.activeVoiceCount=Math.max(0,Math.min(this.activeVoiceCount,Math.floor(t))))}resetActiveVoiceCount(){this.activeVoiceCount=0}getActiveVoiceCount(){return this.activeVoiceCount}updateMasterGain(){const{polyphonyReference:t,smoothingTauMs:e,masterGainRampMs:n,gainUpdateIntervalMs:s}=this.options,r=Dt();if(this.activeVoiceCount===0){this.smoothedVoiceCount=.01*t+(1-.01)*this.smoothedVoiceCount;return}const i=s/1e3,o=1-Math.exp(-i/(e/1e3)),a=Math.max(1,this.activeVoiceCount);this.smoothedVoiceCount=o*a+(1-o)*this.smoothedVoiceCount;const l=Math.sqrt(t/this.smoothedVoiceCount),d=this.perVoiceBaselineGain*l;this.masterGain.gain.rampTo(d,n/1e3,r)}}const ep={clippingWarningThresholdDb:-3,clippingMonitorIntervalMs:500,clippingWarningCooldownMs:2e3};class Ap{meter;options;clippingMonitorId=null;lastClippingWarningAt=0;constructor(t,e={}){this.meter=t,this.options={...ep,...e}}start(){this.stop(),this.lastClippingWarningAt=0,this.clippingMonitorId=setInterval(()=>{const t=this.meter.getValue(),e=Array.isArray(t)?t[0]:t;if(e===void 0||e<=this.options.clippingWarningThresholdDb)return;const n=Date.now();n-this.lastClippingWarningAt<this.options.clippingWarningCooldownMs||(this.lastClippingWarningAt=n,this.options.onWarning?.(e))},this.options.clippingMonitorIntervalMs)}stop(){this.clippingMonitorId!==null&&(clearInterval(this.clippingMonitorId),this.clippingMonitorId=null)}}function np(A){const{timbres:t,masterVolume:e=0,effectsManager:n,harmonicFilter:s,logger:r,audioInit:i,getDrumVolume:o}=A,a={};let l=null,d=null,u=null,h=null,m=null,f={},g=null,p=null;const w={...t},v=r??{debug:()=>{},info:()=>{},warn:()=>{}};function C(b){if(s)return s.getFilteredCoefficients(b);const S=w[b];return S?.coeffs?S.coeffs:new Float32Array([0,1])}function F(b){const S=b.reduce((y,I)=>y+Math.abs(I),0);return S>1?Array.from(b).map(y=>y/S):Array.from(b)}const E={init(){this.stopBackgroundMonitors(),l=new Gt(yu()),g=new tp(l),g.start(),d=new el(e),u=new Ei({threshold:-12,ratio:3,attack:.01,release:.1,knee:6}),h=new cl(-3),m=new ll,l.connect(d),d.connect(u),u.connect(h),h.toDestination(),h.connect(m),m&&(p=new Ap(m,{onWarning:b=>{v.warn("SynthEngine","Limiter input approaching clipping threshold",{level:b},"audio")}}),p.start());for(const b in w){const S=w[b];if(!S)continue;S.vibrato||(S.vibrato={speed:0,span:0}),S.tremelo||(S.tremelo={speed:0,span:0});const y=C(b),I=F(y),Q=S.gain||1,U=new Qg({voice:Zm,options:{oscillator:{type:"custom",partials:I},envelope:S.adsr,filter:S.filter,vibrato:S.vibrato,tremelo:S.tremelo,gain:Q}}).connect(l);n&&l&&n.applySynthEffects(U,b,l);const M=U.triggerAttack.bind(U);U.triggerAttack=function(...P){const R=M(...P);return setTimeout(()=>{const $=this._activeVoices;n?$&&$.size>0?$.forEach(L=>{L.effectsApplied||(n.applyEffectsToVoice(L,b),L.effectsApplied=!0)}):this._voices&&Array.isArray(this._voices)&&this._voices.forEach(L=>{L&&!L.effectsApplied&&(n.applyEffectsToVoice(L,b),L.effectsApplied=!0)}):$&&$.size>0?$.forEach(L=>{L._setVibrato&&L.vibratoApplied!==!0&&(L._setVibrato(this._currentVibrato),L.vibratoApplied=!0),L._setTremolo&&L.tremoloApplied!==!0&&(L._setTremolo(this._currentTremolo),L.tremoloApplied=!0)}):this._voices&&Array.isArray(this._voices)&&this._voices.forEach(L=>{L?._setVibrato&&L.vibratoApplied!==!0&&(L._setVibrato(this._currentVibrato),L.vibratoApplied=!0),L?._setTremolo&&L.tremoloApplied!==!0&&(L._setTremolo(this._currentTremolo),L.tremoloApplied=!0)})},10),R},U._currentVibrato=S.vibrato,U._currentTremolo=S.tremelo,U._currentFilter=S.filter,a[b]=U,v.debug("SynthEngine",`Created filtered synth for color: ${b}`,null,"audio")}v.info("SynthEngine","Initialized with multi-timbral support",null,"audio")},updateSynthForColor(b){const S=w[b],y=a[b];if(!y||!S)return;S.vibrato||(S.vibrato={speed:0,span:0}),S.tremelo||(S.tremelo={speed:0,span:0}),v.debug("SynthEngine",`Updating timbre for color ${b}`,null,"audio");const I=C(b),Q=F(I);y.set({oscillator:{partials:Q},envelope:S.adsr}),n&&l&&n.applySynthEffects(y,b,l),y._currentVibrato=S.vibrato,y._currentTremolo=S.tremelo,y._currentFilter=S.filter;const U=y._activeVoices;U&&U.size>0?U.forEach(M=>{if(M._setFilter&&M._setFilter(S.filter),M._setVibrato&&(M._setVibrato(S.vibrato),M.vibratoApplied=!0),M._setTremolo&&(M._setTremolo(S.tremelo),M.tremoloApplied=!0),M._setPresetGain){const P=S.gain||1;M._setPresetGain(P)}}):y._voices&&Array.isArray(y._voices)&&y._voices.forEach(M=>{if(M?._setVibrato&&(M._setVibrato(S.vibrato),M.vibratoApplied=!0),M?._setTremolo&&(M._setTremolo(S.tremelo),M.tremoloApplied=!0),M?._setFilter&&M._setFilter(S.filter),M?._setPresetGain){const P=S.gain||1;M._setPresetGain(P)}})},setBpm(b){try{st?.bpm&&(st.bpm.value=b,v.debug("SynthEngine",`Tone.Transport BPM updated to ${b}`,null,"audio"))}catch(S){v.warn("SynthEngine","Unable to update BPM on Tone.Transport",{tempo:b,error:S},"audio")}},setVolume(b){d&&(d.volume.value=b)},async playNote(b,S,y=Dt()){await(i||(()=>Yr()))();const Q=Object.keys(a);if(Q.length===0)return;const[U]=Q;if(!U)return;const M=a[U];M&&M.triggerAttackRelease(b,S,y)},triggerAttack(b,S,y=Dt(),I=!1){const Q=a[S];if(Q)if(g?.noteOn(1),I&&o){const U=o(),M=Q.volume.value,P=M+20*Math.log10(U);Q.volume.value=P,Q.triggerAttack(b,y),setTimeout(()=>{Q?.volume&&(Q.volume.value=M)},100)}else Q.triggerAttack(b,y)},triggerAttackInteractive(b,S){E.triggerAttack(b,S,Dt()+.02)},quickReleasePitches(b,S){const y=a[S];if(!y||!b||b.length===0)return;let I;try{const U=(typeof y.get=="function"?y.get():null)?.envelope?.release;I=typeof U=="number"?U:void 0,y.set({envelope:{release:.01}}),b.forEach(P=>{y.triggerRelease(P,Dt())});const M=y._activeVoices?.size??y._voices?.length??g?.getActiveVoiceCount()??0;g?.clampActiveVoiceCountToAtMost(M)}catch(Q){v.warn("SynthEngine","quickReleasePitches failed",{err:Q,color:S,pitches:b},"audio")}finally{if(I!==void 0)try{y.set({envelope:{release:I}})}catch{}}},triggerRelease(b,S,y=Dt()){const I=a[S];if(!I)return;I.triggerRelease(b,y),g?.noteOff(1);const Q=I._activeVoices?.size??I._voices?.length??g?.getActiveVoiceCount()??0;g?.clampActiveVoiceCountToAtMost(Q)},releaseAll(){for(const b in a)a[b]?.releaseAll();g?.resetActiveVoiceCount()},createWaveformAnalyzer(b){const S=a[b];return S?(f[b]||(f[b]=new Al("waveform",1024),S.connect(f[b]),v.debug("SynthEngine",`Created waveform analyzer for color: ${b}`,null,"waveform")),f[b]):(v.warn("SynthEngine",`No synth found for color: ${b}`,null,"audio"),null)},getWaveformAnalyzer(b){return f[b]||null},getAllWaveformAnalyzers(){const b=new Map;for(const S in f)f[S]&&b.set(S,f[S]);return b},removeWaveformAnalyzer(b){f[b]&&(f[b].dispose(),delete f[b],v.debug("SynthEngine",`Removed waveform analyzer for color: ${b}`,null,"waveform"))},disposeAllWaveformAnalyzers(){for(const b in f)f[b]&&f[b].dispose();f={},v.debug("SynthEngine","Disposed all waveform analyzers",null,"waveform")},getSynth(b){return a[b]||null},getAllSynths(){return{...a}},getMainVolumeNode(){return d||null},getMasterGainNode(){return l||null},stopBackgroundMonitors(){p?.stop(),g?.stop()},dispose(){this.stopBackgroundMonitors(),this.disposeAllWaveformAnalyzers();for(const b in a)a[b]?.dispose();l?.dispose(),d?.dispose(),u?.dispose(),h?.dispose(),m?.dispose(),v.debug("SynthEngine","Disposed SynthEngine",null,"audio")}};return E}const nc=1e-4;function sp(A){const{getMacrobeatInfo:t,getPlacedTonicSigns:e,getTonicSpanColumnIndices:n,updatePlayheadModel:s,logger:r}=A;let i=[],o=0,a=0,l=0;const d=r??{debug:()=>{}};function u(f){return 60/(f*2)}function h(f,g,p){let w=0;d.debug("TimeMapCalculator","[TIMEMAP] Building timeMap",{columnCount:g.length,tonicSignCount:p.length,microbeatDuration:f});const v=g.length,C=n(p);for(let F=0;F<v;F++){i[F]=w;const E=C.has(F);if(E?d.debug("TimeMapCalculator",`[TIMEMAP] Column ${F} is tonic, not advancing time`):w+=(g[F]||0)*f,F<5){const b=i[F];b!==void 0&&d.debug("TimeMapCalculator",`[TIMEMAP] timeMap[${F}] = ${b.toFixed(3)}s (isTonic: ${E})`)}}v>0&&(i[v]=w),d.debug("TimeMapCalculator",`[TIMEMAP] Complete. Total columns: ${v}, Final time: ${w.toFixed(3)}s`)}function m(f){const g=i.length>0?i[i.length-1]??0:0;if(!Number.isFinite(g)||g===0){o=0;return}const p=f.modulationMarkers?.filter(C=>C.active)||[];if(p.length===0){o=g;return}const w=[...p].sort((C,F)=>C.measureIndex-F.measureIndex);let v=g;for(const C of w){const F=t(C.measureIndex);if(F){const E=F.endColumn-1,b=i[E]??g,S=g-b,y=S*C.ratio;v=v-S+y}}o=v}return{getMicrobeatDuration:u,calculate(f){d.debug("TimeMapCalculator","calculate",{tempo:`${f.tempo} BPM`}),i=[];const g=u(f.tempo),{columnWidths:p}=f,w=e();h(g,p,w),d.timing?.("TimeMapCalculator","calculate",{totalDuration:`${i[i.length-1]?.toFixed(2)}s`}),m(f),s?.({timeMap:i,musicalEndTime:o,columnWidths:f.columnWidths,cellWidth:f.cellWidth})},getTimeMap(){return i},getMusicalEndTime(){return o},findNonAnacrusisStart(f){if(!f.hasAnacrusis)return d.debug("TimeMapCalculator","[ANACRUSIS] No anacrusis, starting from time 0"),0;for(let g=0;g<f.macrobeatBoundaryStyles.length;g++)if(f.macrobeatBoundaryStyles[g]==="solid"){const p=t(g+1);if(p){const w=i[p.startColumn]||0;return d.debug("TimeMapCalculator",`[ANACRUSIS] Found solid boundary at macrobeat ${g}, non-anacrusis starts at column ${p.startColumn}, time ${w.toFixed(3)}s`),w}}return d.debug("TimeMapCalculator","[ANACRUSIS] No solid boundary found, starting from time 0"),0},applyModulationToTime(f,g,p){const w=p.modulationMarkers?.filter(F=>F.active)||[];if(w.length===0)return f;const v=[...w].sort((F,E)=>F.measureIndex-E.measureIndex);let C=f;g<5&&d.debug("TimeMapCalculator",`[MODULATION] Column ${g}: baseTime ${f.toFixed(3)}s, ${v.length} active markers`);for(const F of v){const E=t(F.measureIndex);if(E){const b=E.endColumn;if(g>b){const S=i[b]!==void 0?i[b]:0,y=f-S,I=y*F.ratio;C=C-y+I,g<5&&d.debug("TimeMapCalculator",`[MODULATION] Column ${g}: Applied marker at measure ${F.measureIndex} (col ${b}), ratio ${F.ratio}, adjustedTime ${C.toFixed(3)}s`)}}}return C},setLoopBounds(f,g,p){const w=u(p),v=Math.max(w,.001),C=Number.isFinite(f)?f:0;let F=Number.isFinite(g)?g:C+v;F<=C&&(F=C+v),a=C,l=F,st&&(st.loopStart=C,st.loopEnd=F)},getConfiguredLoopBounds(){return{loopStart:a,loopEnd:l}},setConfiguredLoopBounds(f,g){a=f,l=g},clearConfiguredLoopBounds(){a=0,l=0},reapplyConfiguredLoopBounds(f){if(l>a){const g=Kt(st.loopStart).toSeconds(),p=Kt(st.loopEnd).toSeconds(),w=Math.abs(g-a),v=Math.abs(p-l);(w>nc||v>nc)&&(st.loopStart=a,st.loopEnd=l),st.loop!==f&&(st.loop=f)}},updateLoopBoundsFromTimeline(f){const g=this.findNonAnacrusisStart(f),p=o;this.setLoopBounds(g,p,f.tempo)}}}const rp={H:"https://tonejs.github.io/audio/drum-samples/CR78/hihat.mp3",M:"https://tonejs.github.io/audio/drum-samples/CR78/snare.mp3",L:"https://tonejs.github.io/audio/drum-samples/CR78/kick.mp3"},ip=1e-4;function op(A={}){const{samples:t=rp,synthEngine:e,initialVolume:n=0}=A;let s=null,r=null;const i=new Map;function o(a,l){let d=Number.isFinite(l)?l:Dt();const u=i.get(a)??-1/0;return d>u||(d=u+ip),i.set(a,d),d}if(r=new el(n),s=new Si(t).connect(r),e){const a=e.getMainVolumeNode?.();a?r.connect(a):r.toDestination()}else r.toDestination();return{getPlayers(){return s},getVolumeNode(){return r},trigger(a,l){if(!s)return;const d=o(a,l);s.player(a)?.start(d)},reset(){i.clear()},dispose(){s?.dispose(),r?.dispose(),s=null,r=null,i.clear()}}}const sc="",rc="";function ap(A){const{synthEngine:t,stateCallbacks:e,eventCallbacks:n,visualCallbacks:s,logger:r,audioInit:i,playbackMode:o="standard"}=A,a=r??{debug:()=>{},info:()=>{},warn:()=>{}};let l=null,d=!1,u=null,h=null,m=1;const f=[];function g(Q,U){const M=U.fullRowData[Q];return M?M.toneNote.replace(sc,"b").replace(rc,"#"):"C4"}function p(Q,U){const M=Q.globalRow??Q.row,P=U.fullRowData[M];return P?P.toneNote.replace(sc,"b").replace(rc,"#"):"C4"}function w(){if(!u)return;const Q=e.getState();a.debug("TransportService","scheduleNotes","Clearing previous transport events and rescheduling all notes"),st.cancel(),h?.reset(),u.calculate(Q),s?.clearAdsrVisuals?.();const U=u.getTimeMap(),{loopEnd:M}=u.getConfiguredLoopBounds(),P=u.findNonAnacrusisStart(Q);a.debug("TransportService",`[ANACRUSIS] hasAnacrusis: ${Q.hasAnacrusis}, anacrusisOffset: ${P.toFixed(3)}s`),Q.placedNotes.forEach((L,V)=>{const _=L.startColumnIndex,X=L.endColumnIndex,At=U[_];if(At===void 0){a.warn("TransportService",`[NOTE SCHEDULE] Note ${V}: timeMap[${_}] undefined, skipping`);return}const ht=u.applyModulationToTime(At,_,Q),mt=U[X+1];if(mt===void 0){a.warn("TransportService",`Skipping note with invalid endColumnIndex: ${L.endColumnIndex+1}`);return}const x=u.applyModulationToTime(mt,X+1,Q)-ht;L.isDrum?v(L,ht):C(L,ht,x,M,Q)});const R=e.getStampPlaybackData?.()??[];R.forEach(L=>{F(L,U,Q)});const $=e.getTripletPlaybackData?.()??[];$.forEach(L=>{E(L,U,Q)}),a.debug("TransportService","scheduleNotes",`Finished scheduling ${Q.placedNotes.length} notes, ${R.length} stamps, and ${$.length} triplets`)}function v(Q,U){const M=e.getState();st.schedule(P=>{if(M.isPaused)return;const R=Q.drumTrack;if(R==null)return;const $=String(R);h?.trigger($,P),Vi.schedule(()=>{s?.triggerDrumNotePop?.(Q.startColumnIndex,R)},P)},U)}function C(Q,U,M,P,R){const $=p(Q,R),L=Q.color,V=Q.globalRow??Q.row,_=R.fullRowData[V]?.hex||"#888888",X=Q.uuid,At=R.timbres[L];if(!At){a.warn("TransportService",`Timbre not found for color ${L}. Skipping note ${X}`);return}let ht=U+M;const it=P-.001;ht>=P&&(ht=Math.max(U+.001,it)),st.schedule(x=>{e.getState().isPaused||(t.triggerAttack($,L,x),Vi.schedule(()=>{s?.triggerAdsrVisual?.(X,"attack",_,At.adsr),n.emit("noteAttack",{noteId:X,color:L})},x))},U),st.schedule(x=>{t.triggerRelease($,L,x),Vi.schedule(()=>{s?.triggerAdsrVisual?.(X,"release",_,At.adsr),n.emit("noteRelease",{noteId:X,color:L})},x)},ht)}function F(Q,U,M){const P=Q.column,R=U[P];if(R===void 0)return;(e.getStampScheduleEvents?.(Q.sixteenthStampId,Q.placement)??[]).forEach(L=>{b(L,R,Q.row,Q.color,M)})}function E(Q,U,M){const P=e.timeToCanvas?.(Q.startTimeIndex,M)??Q.startTimeIndex,R=U[P];if(R===void 0)return;(e.getTripletScheduleEvents?.(Q.tripletStampId,Q.placement)??[]).forEach(L=>{b(L,R,Q.row,Q.color,M)})}function b(Q,U,M,P,R){const $=Kt(Q.offset).toSeconds(),L=Kt(Q.duration).toSeconds(),V=U+$,_=V+L,X=M+Q.rowOffset,At=g(X,R);st.schedule(ht=>{e.getState().isPaused||t.triggerAttack(At,P,ht)},V),st.schedule(ht=>{e.getState().isPaused||t.triggerRelease(At,P,ht)},_)}function S(){const U=e.getState().tempo,M=1e-4,P=.5,R=V=>V?.xPosition??477.5,$=typeof st?.bpm?.value=="number"?st.bpm.value:U;m=U!==0?$/U:1,d=!0;function L(){if(!d||!u)return;if(st.state==="stopped"){l=requestAnimationFrame(L);return}const V=e.getState(),_=Kt(st.loopEnd).toSeconds(),X=V.isLooping,At=u.getMusicalEndTime(),ht=X&&_>0?_:At,mt=st.seconds,it=mt>=ht-.001;if(!X&&it){a.info("TransportService","Playback reached end. Stopping playhead."),I.stop();return}if(V.isPaused){l=requestAnimationFrame(L);return}const x=u.getTimeMap();s?.clearPlayheadCanvas?.(),s?.clearDrumPlayheadCanvas?.();let H=mt;if(X){const nt=Kt(st.loopStart).toSeconds(),wt=Kt(st.loopEnd).toSeconds()-nt;wt>0&&(H=(mt-nt)%wt+nt)}const O=e.getCanvasWidth?.()??1e3,z=e.getPlacedTonicSigns?.()??[],G=e.getTonicSpanColumnIndices?.(z)??new Set;let ct=0,D=0,k=0,T=-1;for(let nt=0;nt<x.length-1;nt++){const ft=x[nt],wt=x[nt+1];if(!(ft===void 0||wt===void 0)&&H>=ft&&H<wt){let Ct=nt;for(;G.has(Ct)&&Ct<x.length-1;)Ct++;const vt=e.getColumnStartX?.(Ct)??0,Z=e.getColumnWidth?.(Ct)??10;if(D=vt,k=Z,T=Ct,G.has(nt))ct=vt;else{const lt=wt-ft,gt=H-ft,zt=lt>0?gt/lt:0;ct=vt+zt*Z}break}}const W=Math.min(ct,O);y(V,W,U,R,M,P);const K=s?.getPlayheadCanvasHeight?.()??500,q=s?.getDrumCanvasHeight?.()??100,tt=V.playheadMode==="macrobeat"&&T>=0?e.getMacrobeatHighlightRect?.(T):null,N=tt?.x??D,et=tt?.width??k;W>=0&&(V.playheadMode==="macrobeat"||V.playheadMode==="microbeat"?(s?.drawPlayheadHighlight?.(N,et,K,performance.now()),s?.drawDrumPlayheadHighlight?.(N,et,q,performance.now())):(s?.drawPlayheadLine?.(W,K),s?.drawDrumPlayheadLine?.(W,q)));const ot=V.playheadMode==="macrobeat"||V.playheadMode==="microbeat";s?.updateBeatLineHighlight?.(N,et,ot),l=requestAnimationFrame(L)}L()}function y(Q,U,M,P,R,$){if(!u)return;const V=(Array.isArray(Q.modulationMarkers)?Q.modulationMarkers:[]).filter(_=>_?.active&&typeof _.ratio=="number"&&_.ratio!==0).sort((_,X)=>P(_)-P(X));if(V.length>0){let _=1;for(const X of V){const At=P(X);if(U+$>=At)_*=1/X.ratio;else break}if((!Number.isFinite(_)||_<=0)&&(_=1),Math.abs(_-m)>R){const X=M*_;st.bpm.value=X,u.reapplyConfiguredLoopBounds(Q.isLooping),m=_,a.debug("TransportService",`Tempo multiplier updated to ${_.toFixed(3)} (${X.toFixed(2)} BPM)`)}}else Math.abs(m-1)>R&&(st.bpm.value=M,u.reapplyConfiguredLoopBounds(Q.isLooping),m=1,a.debug("TransportService",`Tempo reset to base ${M} BPM`))}const I={init(){const Q=e.getState();u=sp({getMacrobeatInfo:e.getMacrobeatInfo??(()=>null),getPlacedTonicSigns:e.getPlacedTonicSigns??(()=>[]),getTonicSpanColumnIndices:e.getTonicSpanColumnIndices??(()=>new Set),logger:a}),h=op({samples:{H:"/audio/drums/hi.mp3",M:"/audio/drums/mid.mp3",L:"/audio/drums/lo.mp3"},synthEngine:{getMainVolumeNode:()=>t.getMainVolumeNode()}}),st.bpm.value=Q.tempo;const U=()=>this.handleStateChange(),M=()=>this.handleStateChange(),P=()=>this.handleStateChange(),R=()=>{if(u&&u.getTimeMap().length>0){const _=e.getState();u.calculate(_)}this.handleStateChange()},$=_=>{const X=_?.oldConfig?.columnWidths||[],At=_?.newConfig?.columnWidths||[];X.length!==At.length&&u&&u.calculate(e.getState())},L=_=>{if(a.info("TransportService",`tempoChanged triggered with new value: ${_} BPM`),st.state==="started"){const X=st.position;st.pause(),l&&(cancelAnimationFrame(l),l=null),st.bpm.value=_,u?.reapplyConfiguredLoopBounds(e.getState().isLooping),w(),st.start(void 0,X),o==="standard"&&S()}else st.bpm.value=_,u?.reapplyConfiguredLoopBounds(e.getState().isLooping),u?.calculate(e.getState())},V=_=>{st.loop=_;const X=Kt(st.loopStart).toSeconds(),At=Kt(st.loopEnd).toSeconds();_&&At<=X&&u&&(st.loopEnd=X+Math.max(u.getMicrobeatDuration(e.getState().tempo),.001)),_&&u?u.setConfiguredLoopBounds(Kt(st.loopStart).toSeconds(),Kt(st.loopEnd).toSeconds()):u?.clearConfiguredLoopBounds()};n.on("rhythmStructureChanged",U),n.on("notesChanged",M),n.on("sixteenthStampPlacementsChanged",P),n.on("modulationMarkersChanged",R),n.on("layoutConfigChanged",$),n.on("tempoChanged",L),n.on("loopingChanged",V),f.push(()=>{}),st.on("stop",()=>{a.info("TransportService","Tone.Transport 'stop' fired. Resetting playback state"),n.setPlaybackState?.(!1,!1),s?.clearAdsrVisuals?.(),l&&(cancelAnimationFrame(l),l=null)}),a.info("TransportService","Initialized")},handleStateChange(){if(st.state==="started"){a.debug("TransportService","handleStateChange: Notes or rhythm changed during playback. Rescheduling");const U=st.position;st.pause(),w(),st.start(void 0,U)}else u?.calculate(e.getState())},start(){a.info("TransportService","Starting playback"),(i||(()=>Yr()))().then(()=>{w();const U=e.getState();u?.getTimeMap();const M=u?.getMusicalEndTime()??0,P=u?.findNonAnacrusisStart(U)??0;u?.setLoopBounds(P,M,U.tempo),st.bpm.value=U.tempo;const R=Dt()+.1;st.start(R,0),o==="standard"&&S(),n.emit("playbackStarted")})},resume(){a.info("TransportService","Resuming playback"),(i||(()=>Yr()))().then(()=>{st.start(),o==="standard"&&S(),n.emit("playbackResumed")})},pause(){a.info("TransportService","Pausing playback"),st.pause(),l&&(cancelAnimationFrame(l),l=null),n.emit("playbackPaused")},stop(){a.info("TransportService","Stopping playback and clearing visuals"),d=!1,l&&(cancelAnimationFrame(l),l=null),st.stop(),st.cancel(),h?.reset();const Q=e.getState();st.bpm.value=Q.tempo,u?.reapplyConfiguredLoopBounds(Q.isLooping),t.releaseAll(),s?.clearPlayheadCanvas?.(),s?.clearDrumPlayheadCanvas?.(),s?.updateBeatLineHighlight?.(0,0,!1),n.emit("playbackStopped")},dispose(){this.stop(),h?.dispose(),f.forEach(Q=>Q()),a.debug("TransportService","Disposed")}};return I}const lp={latencyHint:"playback",lookAhead:.1};function cp(A={}){const{latencyHint:t,lookAhead:e}={...lp,...A};let n=!1;if(ys.state==="suspended")try{Fg(new Ig({latencyHint:t})),n=!0}catch(s){console.warn("Failed to create new AudioContext, using default:",s)}return e!==void 0&&(ys.lookAhead=e),n}let dp=class{logLevel;enabledLevels;categories;constructor(){this.logLevel="ERROR",this.enabledLevels={DEBUG:!1,INFO:!1,WARN:!1,ERROR:!0},this.categories={general:!1,state:!1,canvas:!1,audio:!1,ui:!1,layout:!1,harmony:!1,performance:!1,initialization:!1,transport:!1,grid:!1,toolbar:!1,zoom:!1,scroll:!1,keyboard:!1,mouse:!1,adsr:!1,filter:!1,waveform:!1,debug:!1}}enable(...t){t.forEach(e=>{Object.prototype.hasOwnProperty.call(this.categories,e)&&(this.categories[e]=!0)})}disable(...t){t.forEach(e=>{Object.prototype.hasOwnProperty.call(this.categories,e)&&(this.categories[e]=!1)})}enableAll(){Object.keys(this.categories).forEach(t=>{this.categories[t]=!0}),this.setLevel("DEBUG")}disableAll(){Object.keys(this.categories).forEach(t=>{this.categories[t]=!1}),this.setLevel("ERROR")}isCategoryEnabled(t){return this.categories[t]===!0}setLevel(t){const n=["DEBUG","INFO","WARN","ERROR"].indexOf(t);n!==-1&&(this.logLevel=t,this.enabledLevels={DEBUG:n<=0,INFO:n<=1,WARN:n<=2,ERROR:n<=3})}logWithConsole(t,e,n,s=null){if(typeof console<"u"&&console[t]){const r=s!==null?[e,n,s]:[e,n];console[t](...r)}}event(t,e,n="",s="ui"){!this.enabledLevels.INFO||this.isCategoryEnabled(s)}state(t,e,n=null,s="state"){!this.enabledLevels.INFO||this.isCategoryEnabled(s)}debug(t,e,n=null,s="debug"){!this.enabledLevels.DEBUG||!this.isCategoryEnabled(s)||this.logWithConsole("debug",t,e,n)}timing(t,e,n,s="performance"){!this.enabledLevels.DEBUG||!this.isCategoryEnabled(s)||this.logWithConsole("debug",t,e,n)}warn(t,e,n=null,s="general"){!this.enabledLevels.WARN||!this.isCategoryEnabled(s)||this.logWithConsole("warn",t,e,n)}error(t,e,n=null,s="general"){this.enabledLevels.ERROR&&this.logWithConsole("error",t,e,n)}info(t,e,n=null,s="general"){!this.enabledLevels.INFO||!this.isCategoryEnabled(s)||this.logWithConsole("info",t,e,n)}getConfig(){return{logLevel:this.logLevel,enabledLevels:{...this.enabledLevels},enabledCategories:Object.entries(this.categories).filter(([,t])=>t).map(([t])=>t)}}getAvailableCategories(){return Object.keys(this.categories)}section(t){this.enabledLevels.INFO&&this.info("Logger",`===== ${t} =====`,null,"general")}initStart(t){this.enabledLevels.INFO&&this.info(t,"init start",null,"initialization")}initSuccess(t){this.enabledLevels.INFO&&this.info(t,"init success",null,"initialization")}initFailed(t,e){if(this.enabledLevels.ERROR){const n=e?`init failed: ${e}`:"init failed";this.error(t,n,null,"initialization")}}moduleLoaded(t,e="initialization"){this.isCategoryEnabled(e)&&this.enabledLevels.INFO&&this.info(t,"loaded",null,e)}log(t,e,n=null){this.info(t,e,n,"general")}};const B=new dp;typeof window<"u"&&(window.logger=B);B.moduleLoaded("EngineStore","general");function ic(){return{entries:[],visualToCanvas:new Map,visualToTime:new Map,canvasToVisual:new Map,canvasToTime:new Map,timeToCanvas:new Map,timeToVisual:new Map,macrobeatBoundaries:[],totalVisualColumns:0,totalCanvasColumns:0,totalTimeColumns:0,totalWidthUnmodulated:0}}const up="studentNotationState",hp={getItem:A=>localStorage.getItem(A),setItem:(A,t)=>localStorage.setItem(A,t),removeItem:A=>localStorage.removeItem(A)},qs=(A,t,e,n,s)=>{const r=s||"general";switch(A){case"debug":B.debug(t,e,n,r);break;case"info":B.info(t,e,n,r);break;case"warn":B.warn(t,e,n,r);break;case"error":B.error(t,e,n,r);break}};let Ue={};function fp(A){Ue=A,B.info("EngineStore","Column map callbacks registered")}const c=jm({storageKey:up,storage:hp,onClearState:()=>{localStorage.removeItem("effectDialValues"),window.location.reload()},noteActionCallbacks:{getMacrobeatInfo:(A,t)=>{const e=A.macrobeatGroupings||[];let n=0;for(let r=0;r<t&&r<e.length;r++)n+=e[r]||2;const s=n+(e[t]||2)-1;return{startColumn:n,endColumn:s}},log:(A,t,e)=>qs(A,"noteActions",t,e)},rhythmActionCallbacks:{getColumnMap:A=>Ue.getColumnMap?Ue.getColumnMap(A):ic(),visualToTimeIndex:(A,t,e)=>Ue.visualToTimeIndex?Ue.visualToTimeIndex(A,t,e):t,timeIndexToVisualColumn:(A,t,e)=>Ue.timeIndexToVisualColumn?Ue.timeIndexToVisualColumn(A,t,e):t,getTimeBoundaryAfterMacrobeat:(A,t,e)=>{if(Ue.getTimeBoundaryAfterMacrobeat)return Ue.getTimeBoundaryAfterMacrobeat(A,t,e);let n=0;for(let s=0;s<=t&&s<e.length;s++)n+=e[s]||2;return n},log:qs},sixteenthStampActionCallbacks:{log:(A,t,e)=>qs(A,"sixteenthStampActions",t,e)},tripletStampActionCallbacks:{canvasToTime:(A,t)=>t.canvasToTime.get(A)??null,timeToCanvas:(A,t)=>t.timeToCanvas.get(A)??A,getColumnMap:A=>Ue.getColumnMap?Ue.getColumnMap(A):ic(),log:(A,t,e)=>qs(A,"tripletStampActions",t,e)}});function dl(A){return A!==null&&typeof A=="object"&&"name"in A&&typeof A.name=="string"}function ul(A){return A!==null&&typeof A=="object"&&"step"in A&&typeof A.step=="number"&&"alt"in A&&typeof A.alt=="number"&&!isNaN(A.step)&&!isNaN(A.alt)}var Su=[0,2,4,-1,1,3,5],Eu=Su.map(A=>Math.floor(A*7/12));function Qu(A){const{step:t,alt:e,oct:n,dir:s=1}=A,r=Su[t]+7*e;if(n===void 0)return[s*r];const i=n-Eu[t]-4*e;return[s*r,s*i]}var gp=[3,0,4,1,5,2,6];function Fu(A){const[t,e,n]=A,s=gp[mp(t)],r=Math.floor((t+1)/7);if(e===void 0)return{step:s,alt:r,dir:n};const i=e+4*r+Eu[s];return{step:s,alt:r,oct:i,dir:n}}function mp(A){const t=(A+1)%7;return t<0?7+t:t}var oc=(A,t)=>Array(Math.abs(t)+1).join(A),qo=Object.freeze({empty:!0,name:"",num:NaN,q:"",type:"",step:NaN,alt:NaN,dir:NaN,simple:NaN,semitones:NaN,chroma:NaN,coord:[],oct:NaN}),pp="([-+]?\\d+)(d{1,4}|m|M|P|A{1,4})",Bp="(AA|A|P|M|m|d|dd)([-+]?\\d+)",wp=new RegExp("^"+pp+"|"+Bp+"$");function vp(A){const t=wp.exec(`${A}`);return t===null?["",""]:t[1]?[t[1],t[2]]:[t[4],t[3]]}var ac={};function xe(A){return typeof A=="string"?ac[A]||(ac[A]=Cp(A)):ul(A)?xe(yp(A)):dl(A)?xe(A.name):qo}var lc=[0,2,4,5,7,9,11],Iu="PMMPPMM";function Cp(A){const t=vp(A);if(t[0]==="")return qo;const e=+t[0],n=t[1],s=(Math.abs(e)-1)%7,r=Iu[s];if(r==="M"&&n==="P")return qo;const i=r==="M"?"majorable":"perfectable",o=""+e+n,a=e<0?-1:1,l=e===8||e===-8?e:a*(s+1),d=bp(i,n),u=Math.floor((Math.abs(e)-1)/7),h=a*(lc[s]+d+12*u),m=(a*(lc[s]+d)%12+12)%12,f=Qu({step:s,alt:d,oct:u,dir:a});return{empty:!1,name:o,num:e,q:n,step:s,alt:d,dir:a,type:i,simple:l,semitones:h,chroma:m,coord:f,oct:u}}function xu(A,t){const[e,n=0]=A,s=e*7+n*12<0,r=t||s?[-e,-n,-1]:[e,n,1];return xe(Fu(r))}function bp(A,t){return t==="M"&&A==="majorable"||t==="P"&&A==="perfectable"?0:t==="m"&&A==="majorable"?-1:/^A+$/.test(t)?t.length:/^d+$/.test(t)?-1*(A==="perfectable"?t.length:t.length+1):0}function yp(A){const{step:t,alt:e,oct:n=0,dir:s}=A;if(!s)return"";const r=t+1+7*n,i=r===0?t+1:r,o=s<0?"-":"",a=Iu[t]==="M"?"majorable":"perfectable";return o+i+Sp(a,e)}function Sp(A,t){return t===0?A==="majorable"?"M":"P":t===-1&&A==="majorable"?"m":t>0?oc("A",t):oc("d",A==="perfectable"?t:t+1)}var cc=(A,t)=>Array(Math.abs(t)+1).join(A),Uu=Object.freeze({empty:!0,name:"",letter:"",acc:"",pc:"",step:NaN,alt:NaN,chroma:NaN,height:NaN,coord:[],midi:null,freq:null}),dc=new Map,Ep=A=>"CDEFGAB".charAt(A),Mu=A=>A<0?cc("b",-A):cc("#",A),Tu=A=>A[0]==="b"?-A.length:A.length;function Vt(A){const t=JSON.stringify(A),e=dc.get(t);if(e)return e;const n=typeof A=="string"?xp(A):ul(A)?Vt(Up(A)):dl(A)?Vt(A.name):Uu;return dc.set(t,n),n}var Qp=/^([a-gA-G]?)(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)$/;function hl(A){const t=Qp.exec(A);return t?[t[1].toUpperCase(),t[2].replace(/x/g,"##"),t[3],t[4]]:["","","",""]}function Fp(A){return Vt(Fu(A))}var Ip=(A,t)=>(A%t+t)%t,Ji=[0,2,4,5,7,9,11];function xp(A){const t=hl(A);if(t[0]===""||t[3]!=="")return Uu;const e=t[0],n=t[1],s=t[2],r=(e.charCodeAt(0)+3)%7,i=Tu(n),o=s.length?+s:void 0,a=Qu({step:r,alt:i,oct:o}),l=e+n+s,d=e+n,u=(Ji[r]+i+120)%12,h=o===void 0?Ip(Ji[r]+i,12)-1188:Ji[r]+i+12*(o+1),m=h>=0&&h<=127?h:null,f=o===void 0?null:Math.pow(2,(h-69)/12)*440;return{empty:!1,acc:n,alt:i,chroma:u,coord:a,freq:f,height:h,letter:e,midi:m,name:l,oct:o,pc:d,step:r}}function Up(A){const{step:t,alt:e,oct:n}=A,s=Ep(t);if(!s)return"";const r=s+Mu(e);return n||n===0?r+n:r}function Qi(A,t){const e=Vt(A),n=Array.isArray(t)?t:xe(t).coord;if(e.empty||!n||n.length<2)return"";const s=e.coord,r=s.length===1?[s[0]+n[0]]:[s[0]+n[0],s[1]+n[1]];return Fp(r).name}function ti(A,t){const e=Vt(A),n=Vt(t);if(e.empty||n.empty)return"";const s=e.coord,r=n.coord,i=r[0]-s[0],o=s.length===2&&r.length===2?r[1]-s[1]:-Math.floor(i*7/12),a=n.height===e.height&&n.midi!==null&&e.oct===n.oct&&e.step>n.step;return xu([i,o],a).name}function fl(A,t){const e=t.length,n=(A%e+e)%e;return t.slice(n,e).concat(t.slice(0,n))}function Mp(A){return A.filter(t=>t===0||t)}var XA={empty:!0,name:"",setNum:0,chroma:"000000000000",normalized:"000000000000",intervals:[]},Pu=A=>Number(A).toString(2).padStart(12,"0"),uc=A=>parseInt(A,2),Tp=/^[01]{12}$/;function Lu(A){return Tp.test(A)}var Pp=A=>typeof A=="number"&&A>=0&&A<=4095,Lp=A=>A&&Lu(A.chroma),hc={[XA.chroma]:XA};function gl(A){const t=Lu(A)?A:Pp(A)?Pu(A):Array.isArray(A)?_p(A):Lp(A)?A.chroma:XA.chroma;return hc[t]=hc[t]||kp(t)}var Hp=["1P","2m","2M","3m","3M","4P","5d","5P","6m","6M","7m","7M"];function Dp(A){const t=[];for(let e=0;e<12;e++)A.charAt(e)==="1"&&t.push(Hp[e]);return t}function Np(A,t=!0){const n=gl(A).chroma.split("");return Mp(n.map((s,r)=>{const i=fl(r,n);return t&&i[0]==="0"?null:i.join("")}))}function Rp(A){const t=A.split("");return t.map((e,n)=>fl(n,t).join(""))}function kp(A){const t=uc(A),e=Rp(A).map(uc).filter(r=>r>=2048).sort()[0],n=Pu(e),s=Dp(A);return{empty:!1,name:"",setNum:t,chroma:A,normalized:n,intervals:s}}function _p(A){if(A.length===0)return XA.chroma;let t;const e=[0,0,0,0,0,0,0,0,0,0,0,0];for(let n=0;n<A.length;n++)t=Vt(A[n]),t.empty&&(t=xe(A[n])),t.empty||(e[t.chroma]=1);return e.join("")}var Op=[["1P 3M 5P","major","M ^  maj"],["1P 3M 5P 7M","major seventh","maj7  ma7 M7 Maj7 ^7"],["1P 3M 5P 7M 9M","major ninth","maj9 9 ^9"],["1P 3M 5P 7M 9M 13M","major thirteenth","maj13 Maj13 ^13"],["1P 3M 5P 6M","sixth","6 add6 add13 M6"],["1P 3M 5P 6M 9M","sixth added ninth","6add9 6/9 69 M69"],["1P 3M 6m 7M","major seventh flat sixth","M7b6 ^7b6"],["1P 3M 5P 7M 11A","major seventh sharp eleventh","maj#4 #4 #11 M7#11 ^7#11 maj7#11"],["1P 3m 5P","minor","m min -"],["1P 3m 5P 7m","minor seventh","m7 min7 mi7 -7"],["1P 3m 5P 7M","minor/major seventh","m/ma7 m/maj7 mM7 mMaj7 m/M7 -7 m -^7 -maj7"],["1P 3m 5P 6M","minor sixth","m6 -6"],["1P 3m 5P 7m 9M","minor ninth","m9 -9"],["1P 3m 5P 7M 9M","minor/major ninth","mM9 mMaj9 -^9"],["1P 3m 5P 7m 9M 11P","minor eleventh","m11 -11"],["1P 3m 5P 7m 9M 13M","minor thirteenth","m13 -13"],["1P 3m 5d","diminished","dim  o"],["1P 3m 5d 7d","diminished seventh","dim7 7 o7"],["1P 3m 5d 7m","half-diminished","m7b5  -7b5 h7 h"],["1P 3M 5P 7m","dominant seventh","7 dom"],["1P 3M 5P 7m 9M","dominant ninth","9"],["1P 3M 5P 7m 9M 13M","dominant thirteenth","13"],["1P 3M 5P 7m 11A","lydian dominant seventh","7#11 7#4"],["1P 3M 5P 7m 9m","dominant flat ninth","7b9"],["1P 3M 5P 7m 9A","dominant sharp ninth","7#9"],["1P 3M 7m 9m","altered","alt7"],["1P 4P 5P","suspended fourth","sus4 sus"],["1P 2M 5P","suspended second","sus2"],["1P 4P 5P 7m","suspended fourth seventh","7sus4 7sus"],["1P 5P 7m 9M 11P","eleventh","11"],["1P 4P 5P 7m 9m","suspended fourth flat ninth","b9sus phryg 7b9sus 7b9sus4"],["1P 5P","fifth","5"],["1P 3M 5A","augmented","aug + +5 ^#5"],["1P 3m 5A","minor augmented","m#5 -#5 m+"],["1P 3M 5A 7M","augmented seventh","maj7#5 maj7+5 +maj7 ^7#5"],["1P 3M 5P 7M 9M 11A","major sharp eleventh (lydian)","maj9#11 9#11 ^9#11"],["1P 2M 4P 5P","","sus24 sus4add9"],["1P 3M 5A 7M 9M","","maj9#5 Maj9#5"],["1P 3M 5A 7m","","7#5 +7 7+ 7aug aug7"],["1P 3M 5A 7m 9A","","7#5#9 7#9#5 7alt"],["1P 3M 5A 7m 9M","","9#5 9+"],["1P 3M 5A 7m 9M 11A","","9#5#11"],["1P 3M 5A 7m 9m","","7#5b9 7b9#5"],["1P 3M 5A 7m 9m 11A","","7#5b9#11"],["1P 3M 5A 9A","","+add#9"],["1P 3M 5A 9M","","M#5add9 +add9"],["1P 3M 5P 6M 11A","","M6#11 M6b5 6#11 6b5"],["1P 3M 5P 6M 7M 9M","","M7add13"],["1P 3M 5P 6M 9M 11A","","69#11"],["1P 3m 5P 6M 9M","","m69 -69"],["1P 3M 5P 6m 7m","","7b6"],["1P 3M 5P 7M 9A 11A","","maj7#9#11"],["1P 3M 5P 7M 9M 11A 13M","","M13#11 maj13#11 M13+4 M13#4"],["1P 3M 5P 7M 9m","","M7b9"],["1P 3M 5P 7m 11A 13m","","7#11b13 7b5b13"],["1P 3M 5P 7m 13M","","7add6 67 7add13"],["1P 3M 5P 7m 9A 11A","","7#9#11 7b5#9 7#9b5"],["1P 3M 5P 7m 9A 11A 13M","","13#9#11"],["1P 3M 5P 7m 9A 11A 13m","","7#9#11b13"],["1P 3M 5P 7m 9A 13M","","13#9"],["1P 3M 5P 7m 9A 13m","","7#9b13"],["1P 3M 5P 7m 9M 11A","","9#11 9+4 9#4"],["1P 3M 5P 7m 9M 11A 13M","","13#11 13+4 13#4"],["1P 3M 5P 7m 9M 11A 13m","","9#11b13 9b5b13"],["1P 3M 5P 7m 9m 11A","","7b9#11 7b5b9 7b9b5"],["1P 3M 5P 7m 9m 11A 13M","","13b9#11"],["1P 3M 5P 7m 9m 11A 13m","","7b9b13#11 7b9#11b13 7b5b9b13"],["1P 3M 5P 7m 9m 13M","","13b9"],["1P 3M 5P 7m 9m 13m","","7b9b13"],["1P 3M 5P 7m 9m 9A","","7b9#9"],["1P 3M 5P 9M","","Madd9 2 add9 add2"],["1P 3M 5P 9m","","Maddb9"],["1P 3M 5d","","Mb5"],["1P 3M 5d 6M 7m 9M","","13b5"],["1P 3M 5d 7M","","M7b5"],["1P 3M 5d 7M 9M","","M9b5"],["1P 3M 5d 7m","","7b5"],["1P 3M 5d 7m 9M","","9b5"],["1P 3M 7m","","7no5"],["1P 3M 7m 13m","","7b13"],["1P 3M 7m 9M","","9no5"],["1P 3M 7m 9M 13M","","13no5"],["1P 3M 7m 9M 13m","","9b13"],["1P 3m 4P 5P","","madd4"],["1P 3m 5P 6m 7M","","mMaj7b6"],["1P 3m 5P 6m 7M 9M","","mMaj9b6"],["1P 3m 5P 7m 11P","","m7add11 m7add4"],["1P 3m 5P 9M","","madd9"],["1P 3m 5d 6M 7M","","o7M7"],["1P 3m 5d 7M","","oM7"],["1P 3m 6m 7M","","mb6M7"],["1P 3m 6m 7m","","m7#5"],["1P 3m 6m 7m 9M","","m9#5"],["1P 3m 5A 7m 9M 11P","","m11A"],["1P 3m 6m 9m","","mb6b9"],["1P 2M 3m 5d 7m","","m9b5"],["1P 4P 5A 7M","","M7#5sus4"],["1P 4P 5A 7M 9M","","M9#5sus4"],["1P 4P 5A 7m","","7#5sus4"],["1P 4P 5P 7M","","M7sus4"],["1P 4P 5P 7M 9M","","M9sus4"],["1P 4P 5P 7m 9M","","9sus4 9sus"],["1P 4P 5P 7m 9M 13M","","13sus4 13sus"],["1P 4P 5P 7m 9m 13m","","7sus4b9b13 7b9b13sus4"],["1P 4P 7m 10m","","4 quartal"],["1P 5P 7m 9m 11P","","11b9"]],Kp=Op,Gp={...XA,name:"",quality:"Unknown",intervals:[],aliases:[]},ml=[],As={};function Wp(A){return As[A]||Gp}function Vp(){return ml.slice()}function zp(A,t,e){const n=Xp(A),s={...gl(A),name:e||"",quality:n,intervals:A,aliases:t};ml.push(s),s.name&&(As[s.name]=s),As[s.setNum]=s,As[s.chroma]=s,s.aliases.forEach(r=>qp(s,r))}function qp(A,t){As[t]=A}function Xp(A){const t=e=>A.indexOf(e)!==-1;return t("5A")?"Augmented":t("3M")?"Major":t("5d")?"Diminished":t("3m")?"Minor":"Unknown"}Kp.forEach(([A,t,e])=>zp(A.split(" "),e.split(" "),t));ml.sort((A,t)=>A.setNum-t.setNum);var $p=A=>{const t=A.reduce((e,n)=>{const s=Vt(n).chroma;return s!==void 0&&(e[s]=e[s]||Vt(n).name),e},{});return e=>t[e]};function Yp(A,t={}){const e=A.map(s=>Vt(s).pc).filter(s=>s);return Vt.length===0?[]:n0(e,1,t).filter(s=>s.weight).sort((s,r)=>r.weight-s.weight).map(s=>s.name)}var Fi={anyThirds:384,perfectFifth:16,nonPerfectFifths:40,anySeventh:3},Ii=A=>t=>!!(t&A),Jp=Ii(Fi.anyThirds),jp=Ii(Fi.perfectFifth),Zp=Ii(Fi.anySeventh),t0=Ii(Fi.nonPerfectFifths);function e0(A){const t=parseInt(A.chroma,2);return Jp(t)&&jp(t)&&Zp(t)}function A0(A){const t=parseInt(A,2);return t0(t)?A:(t|16).toString(2)}function n0(A,t,e){const n=A[0],s=Vt(n).chroma,r=$p(A),i=Np(A,!1),o=[];return i.forEach((a,l)=>{const d=e.assumePerfectFifth&&A0(a);Vp().filter(h=>e.assumePerfectFifth&&e0(h)?h.chroma===d:h.chroma===a).forEach(h=>{const m=h.aliases[0],f=r(l);l!==s?o.push({weight:.5*t,name:`${f}${m}/${n}`}):o.push({weight:1*t,name:`${f}${m}`})})}),o}var s0=xe;function r0(A){const t=xe(A);if(t.empty)return"";const e=(7-t.step)%7,n=t.type==="perfectable"?-t.alt:-(t.alt+1);return xe({step:e,alt:n,oct:t.oct,dir:t.dir}).name}var fc=ti,i0=o0((A,t)=>[A[0]-t[0],A[1]-t[1]]);function o0(A){return(t,e)=>{const n=xe(t).coord,s=xe(e).coord;if(n&&s){const r=A(n,s);return xu(r).name}}}var a0=[["1P 2M 3M 5P 6M","major pentatonic","pentatonic"],["1P 2M 3M 4P 5P 6M 7M","major","ionian"],["1P 2M 3m 4P 5P 6m 7m","minor","aeolian"],["1P 2M 3m 3M 5P 6M","major blues"],["1P 3m 4P 5d 5P 7m","minor blues","blues"],["1P 2M 3m 4P 5P 6M 7M","melodic minor"],["1P 2M 3m 4P 5P 6m 7M","harmonic minor"],["1P 2M 3M 4P 5P 6M 7m 7M","bebop"],["1P 2M 3m 4P 5d 6m 6M 7M","diminished","whole-half diminished"],["1P 2M 3m 4P 5P 6M 7m","dorian"],["1P 2M 3M 4A 5P 6M 7M","lydian"],["1P 2M 3M 4P 5P 6M 7m","mixolydian","dominant"],["1P 2m 3m 4P 5P 6m 7m","phrygian"],["1P 2m 3m 4P 5d 6m 7m","locrian"],["1P 3M 4P 5P 7M","ionian pentatonic"],["1P 3M 4P 5P 7m","mixolydian pentatonic","indian"],["1P 2M 4P 5P 6M","ritusen"],["1P 2M 4P 5P 7m","egyptian"],["1P 3M 4P 5d 7m","neopolitan major pentatonic"],["1P 3m 4P 5P 6m","vietnamese 1"],["1P 2m 3m 5P 6m","pelog"],["1P 2m 4P 5P 6m","kumoijoshi"],["1P 2M 3m 5P 6m","hirajoshi"],["1P 2m 4P 5d 7m","iwato"],["1P 2m 4P 5P 7m","in-sen"],["1P 3M 4A 5P 7M","lydian pentatonic","chinese"],["1P 3m 4P 6m 7m","malkos raga"],["1P 3m 4P 5d 7m","locrian pentatonic","minor seven flat five pentatonic"],["1P 3m 4P 5P 7m","minor pentatonic","vietnamese 2"],["1P 3m 4P 5P 6M","minor six pentatonic"],["1P 2M 3m 5P 6M","flat three pentatonic","kumoi"],["1P 2M 3M 5P 6m","flat six pentatonic"],["1P 2m 3M 5P 6M","scriabin"],["1P 3M 5d 6m 7m","whole tone pentatonic"],["1P 3M 4A 5A 7M","lydian #5P pentatonic"],["1P 3M 4A 5P 7m","lydian dominant pentatonic"],["1P 3m 4P 5P 7M","minor #7M pentatonic"],["1P 3m 4d 5d 7m","super locrian pentatonic"],["1P 2M 3m 4P 5P 7M","minor hexatonic"],["1P 2A 3M 5P 5A 7M","augmented"],["1P 2M 4P 5P 6M 7m","piongio"],["1P 2m 3M 4A 6M 7m","prometheus neopolitan"],["1P 2M 3M 4A 6M 7m","prometheus"],["1P 2m 3M 5d 6m 7m","mystery #1"],["1P 2m 3M 4P 5A 6M","six tone symmetric"],["1P 2M 3M 4A 5A 6A","whole tone","messiaen's mode #1"],["1P 2m 4P 4A 5P 7M","messiaen's mode #5"],["1P 2M 3M 4P 5d 6m 7m","locrian major","arabian"],["1P 2m 3M 4A 5P 6m 7M","double harmonic lydian"],["1P 2m 2A 3M 4A 6m 7m","altered","super locrian","diminished whole tone","pomeroy"],["1P 2M 3m 4P 5d 6m 7m","locrian #2","half-diminished","aeolian b5"],["1P 2M 3M 4P 5P 6m 7m","mixolydian b6","melodic minor fifth mode","hindu"],["1P 2M 3M 4A 5P 6M 7m","lydian dominant","lydian b7","overtone"],["1P 2M 3M 4A 5A 6M 7M","lydian augmented"],["1P 2m 3m 4P 5P 6M 7m","dorian b2","phrygian #6","melodic minor second mode"],["1P 2m 3m 4d 5d 6m 7d","ultralocrian","superlocrian bb7","superlocrian diminished"],["1P 2m 3m 4P 5d 6M 7m","locrian 6","locrian natural 6","locrian sharp 6"],["1P 2A 3M 4P 5P 5A 7M","augmented heptatonic"],["1P 2M 3m 4A 5P 6M 7m","dorian #4","ukrainian dorian","romanian minor","altered dorian"],["1P 2M 3m 4A 5P 6M 7M","lydian diminished"],["1P 2M 3M 4A 5A 7m 7M","leading whole tone"],["1P 2M 3M 4A 5P 6m 7m","lydian minor"],["1P 2m 3M 4P 5P 6m 7m","phrygian dominant","spanish","phrygian major"],["1P 2m 3m 4P 5P 6m 7M","balinese"],["1P 2m 3m 4P 5P 6M 7M","neopolitan major"],["1P 2M 3M 4P 5P 6m 7M","harmonic major"],["1P 2m 3M 4P 5P 6m 7M","double harmonic major","gypsy"],["1P 2M 3m 4A 5P 6m 7M","hungarian minor"],["1P 2A 3M 4A 5P 6M 7m","hungarian major"],["1P 2m 3M 4P 5d 6M 7m","oriental"],["1P 2m 3m 3M 4A 5P 7m","flamenco"],["1P 2m 3m 4A 5P 6m 7M","todi raga"],["1P 2m 3M 4P 5d 6m 7M","persian"],["1P 2m 3M 5d 6m 7m 7M","enigmatic"],["1P 2M 3M 4P 5A 6M 7M","major augmented","major #5","ionian augmented","ionian #5"],["1P 2A 3M 4A 5P 6M 7M","lydian #9"],["1P 2m 2M 4P 4A 5P 6m 7M","messiaen's mode #4"],["1P 2m 3M 4P 4A 5P 6m 7M","purvi raga"],["1P 2m 3m 3M 4P 5P 6m 7m","spanish heptatonic"],["1P 2M 3m 3M 4P 5P 6M 7m","bebop minor"],["1P 2M 3M 4P 5P 5A 6M 7M","bebop major"],["1P 2m 3m 4P 5d 5P 6m 7m","bebop locrian"],["1P 2M 3m 4P 5P 6m 7m 7M","minor bebop"],["1P 2M 3M 4P 5d 5P 6M 7M","ichikosucho"],["1P 2M 3m 4P 5P 6m 6M 7M","minor six diminished"],["1P 2m 3m 3M 4A 5P 6M 7m","half-whole diminished","dominant diminished","messiaen's mode #2"],["1P 3m 3M 4P 5P 6M 7m 7M","kafi raga"],["1P 2M 3M 4P 4A 5A 6A 7M","messiaen's mode #6"],["1P 2M 3m 3M 4P 5d 5P 6M 7m","composite blues"],["1P 2M 3m 3M 4A 5P 6m 7m 7M","messiaen's mode #3"],["1P 2m 2M 3m 4P 4A 5P 6m 6M 7M","messiaen's mode #7"],["1P 2m 2M 3m 3M 4P 5d 5P 6m 6M 7m 7M","chromatic"]],l0=a0,c0={...XA,intervals:[],aliases:[]},ns={};function Hu(A){return ns[A]||c0}function d0(A,t,e=[]){const n={...gl(A),name:t,intervals:A,aliases:e};return ns[n.name]=n,ns[n.setNum]=n,ns[n.chroma]=n,n.aliases.forEach(s=>u0(n,s)),n}function u0(A,t){ns[t]=A}l0.forEach(([A,t,...e])=>d0(A.split(" "),t,e));var Du={empty:!0,name:"",symbol:"",root:"",bass:"",rootDegree:0,type:"",tonic:null,setNum:NaN,quality:"Unknown",chroma:"",normalized:"",aliases:[],notes:[],intervals:[]};function Nu(A){const[t,e,n,s]=hl(A);return t===""?ji("",A):t==="A"&&s==="ug"?ji("","aug"):ji(t+e,n+s)}function ji(A,t){const e=t.split("/");if(e.length===1)return[A,e[0],""];const[n,s,r,i]=hl(e[1]);return n!==""&&r===""&&i===""?[A,e[0],n+s]:[A,t,""]}function h0(A){if(Array.isArray(A))return Zi(A[1]||"",A[0],A[2]);if(A==="")return Du;{const[t,e,n]=Nu(A),s=Zi(e,t,n);return s.empty?Zi(A):s}}function Zi(A,t,e){const n=Wp(A),s=Vt(t||""),r=Vt(e||"");if(n.empty||t&&s.empty||e&&r.empty)return Du;const i=ti(s.pc,r.pc),o=n.intervals.indexOf(i),a=o>=0,l=a?r:Vt(""),d=o===-1?NaN:o+1,u=r.pc&&r.pc!==s.pc,h=Array.from(n.intervals);if(a)for(let p=1;p<d;p++){const w=h[0][0],v=h[0][1],C=parseInt(w,10)+7;h.push(`${C}${v}`),h.shift()}else if(u){const p=i0(ti(s.pc,r.pc),"8P");p&&h.unshift(p)}const m=s.empty?[]:h.map(p=>Qi(s.pc,p));A=n.aliases.indexOf(A)!==-1?A:n.aliases[0];const f=`${s.empty?"":s.pc}${A}${a&&d>1?"/"+l.pc:u?"/"+r.pc:""}`,g=`${t?s.pc+" ":""}${n.name}${a&&d>1?" over "+l.pc:u?" over "+r.pc:""}`;return{...n,name:g,symbol:f,tonic:s.pc,type:n.name,root:l.pc,bass:u?r.pc:"",intervals:h,rootDegree:d,notes:m}}var f0=[[.125,"dl",["large","duplex longa","maxima","octuple","octuple whole"]],[.25,"l",["long","longa"]],[.5,"d",["double whole","double","breve"]],[1,"w",["whole","semibreve"]],[2,"h",["half","minim"]],[4,"q",["quarter","crotchet"]],[8,"e",["eighth","quaver"]],[16,"s",["sixteenth","semiquaver"]],[32,"t",["thirty-second","demisemiquaver"]],[64,"sf",["sixty-fourth","hemidemisemiquaver"]],[128,"h",["hundred twenty-eighth"]],[256,"th",["two hundred fifty-sixth"]]],g0=f0;g0.forEach(([A,t,e])=>void 0);var m0="C C# D D# E F F# G G# A A# B".split(" "),p0="C Db D Eb E F Gb G Ab A Bb B".split(" ");function pl(A,t={}){if(isNaN(A)||A===-1/0||A===1/0)return"";A=Math.round(A);const n=(t.sharps===!0?m0:p0)[A%12];if(t.pitchClass)return n;const s=Math.floor(A/12)-1;return n+s}var Es=Vt,Xo=A=>Es(A).pc,to=A=>Es(A).midi;function B0(A){return pl(A)}var vn=Qi,ss=A=>{const t=Es(A);return t.empty?"":pl(t.midi||t.chroma,{sharps:t.alt>0,pitchClass:t.midi===null})};function rs(A,t){const e=Es(A);if(e.empty)return"";const n=Es(t||pl(e.midi||e.chroma,{sharps:e.alt<0,pitchClass:!0}));if(n.empty||n.chroma!==e.chroma)return"";if(e.oct===void 0)return n.pc;const s=e.chroma-e.alt,r=n.chroma-n.alt,i=s>11||r<0?-1:s<0||r>11?1:0,o=e.oct+i;return n.pc+o}var Ru={empty:!0,name:"",chordType:""},gc={};function Qs(A){return typeof A=="string"?gc[A]||(gc[A]=y0(A)):typeof A=="number"?Qs(Bl[A]||""):ul(A)?w0(A):dl(A)?Qs(A.name):Ru}function w0(A){return Qs(Mu(A.alt)+Bl[A.step])}var v0=/^(#{1,}|b{1,}|x{1,}|)(IV|I{1,3}|VI{0,2}|iv|i{1,3}|vi{0,2})([^IViv]*)$/;function C0(A){return v0.exec(A)||["","","",""]}var b0="I II III IV V VI VII",Bl=b0.split(" ");function y0(A){const[t,e,n,s]=C0(A);if(!n)return Ru;const r=n.toUpperCase(),i=Bl.indexOf(r),o=Tu(e),a=1;return{empty:!1,name:t,roman:n,interval:xe({step:i,alt:o,dir:a}).name,acc:e,chordType:s,alt:o,step:i,major:n===r,oct:0,dir:a}}var wl=[[0,2773,0,"ionian","","Maj7","major"],[1,2902,2,"dorian","m","m7"],[2,3418,4,"phrygian","m","m7"],[3,2741,-1,"lydian","","Maj7"],[4,2774,1,"mixolydian","","7"],[5,2906,3,"aeolian","m","m7","minor"],[6,3434,5,"locrian","dim","m7b5"]],mc={...XA,name:"",alt:0,modeNum:NaN,triad:"",seventh:"",aliases:[]},S0=wl.map(E0),$o={};S0.forEach(A=>{$o[A.name]=A,A.aliases.forEach(t=>{$o[t]=A})});function ku(A){return typeof A=="string"?$o[A.toLowerCase()]||mc:A&&A.name?ku(A.name):mc}function E0(A){const[t,e,n,s,r,i,o]=A,a=o?[o]:[],l=Number(e).toString(2);return{empty:!1,intervals:Hu(s).intervals,modeNum:t,chroma:l,normalized:l,name:s,setNum:e,alt:n,triad:r,seventh:i,aliases:a}}function _u(A){return(t,e)=>{const n=ku(t);if(n.empty)return[];const s=fl(n.modeNum,A),r=n.intervals.map(i=>Qi(e,i));return s.map((i,o)=>r[o]+i)}}_u(wl.map(A=>A[4]));_u(wl.map(A=>A[5]));function Q0(A,t){return t.map(e=>{const[n,s]=Nu(e),r=ti(A,n);return Qs(xe(r)).name+s})}var F0={empty:!0,name:"",type:"",tonic:null,setNum:NaN,chroma:"",normalized:"",aliases:[],notes:[],intervals:[]};function I0(A){if(typeof A!="string")return["",""];const t=A.indexOf(" "),e=Vt(A.substring(0,t));if(e.empty){const s=Vt(A);return s.empty?["",A.toLowerCase()]:[s.name,""]}const n=A.substring(e.name.length+1).toLowerCase();return[e.name,n.length?n:""]}function x0(A){const t=Array.isArray(A)?A:I0(A),e=Vt(t[0]).name,n=Hu(t[1]);if(n.empty)return F0;const s=n.name,r=e?n.intervals.map(o=>Qi(e,o)):[],i=e?e+" "+s:s;return{...n,name:i,type:s,tonic:e,notes:r}}const iA=[{pitch:"C8",flatName:"C8",sharpName:"C8",toneNote:"C8",frequency:4186.01,column:"A",hex:"#fcfcfc",isAccidental:!1},{pitch:"B7",flatName:"B7",sharpName:"B7",toneNote:"B7",frequency:3951.07,column:"B",hex:"#fcf7fc",isAccidental:!1},{pitch:"B/A7",flatName:"B7",sharpName:"A7",toneNote:"Bb7",frequency:3729.31,column:"A",hex:"#f7f5fd",isAccidental:!0},{pitch:"A7",flatName:"A7",sharpName:"A7",toneNote:"A7",frequency:3520,column:"B",hex:"#f0f4ff",isAccidental:!1},{pitch:"A/G7",flatName:"A7",sharpName:"G7",toneNote:"Ab7",frequency:3322.44,column:"A",hex:"#e6f3fd",isAccidental:!0},{pitch:"G7",flatName:"G7",sharpName:"G7",toneNote:"G7",frequency:3135.96,column:"B",hex:"#def3f7",isAccidental:!1},{pitch:"G/F7",flatName:"G7",sharpName:"F7",toneNote:"Gb7",frequency:2959.96,column:"A",hex:"#daf2ec",isAccidental:!0},{pitch:"F7",flatName:"F7",sharpName:"F7",toneNote:"F7",frequency:2793.83,column:"B",hex:"#dcefdf",isAccidental:!1},{pitch:"E7",flatName:"E7",sharpName:"E7",toneNote:"E7",frequency:2637.02,column:"A",hex:"#e3ebd1",isAccidental:!1},{pitch:"E/D7",flatName:"E7",sharpName:"D7",toneNote:"Eb7",frequency:2489.02,column:"B",hex:"#eee4c8",isAccidental:!0},{pitch:"D7",flatName:"D7",sharpName:"D7",toneNote:"D7",frequency:2349.32,column:"A",hex:"#f8dcc6",isAccidental:!1},{pitch:"D/C7",flatName:"D7",sharpName:"C7",toneNote:"Db7",frequency:2217.46,column:"B",hex:"#fcd4cd",isAccidental:!0},{pitch:"C7",flatName:"C7",sharpName:"C7",toneNote:"C7",frequency:2093,column:"A",hex:"#facfdb",isAccidental:!1},{pitch:"B6",flatName:"B6",sharpName:"B6",toneNote:"B6",frequency:1975.53,column:"B",hex:"#efcdeb",isAccidental:!1},{pitch:"B/A6",flatName:"B6",sharpName:"A6",toneNote:"Bb6",frequency:1864.66,column:"A",hex:"#ddcff9",isAccidental:!0},{pitch:"A6",flatName:"A6",sharpName:"A6",toneNote:"A6",frequency:1760,column:"B",hex:"#c4d3ff",isAccidental:!1},{pitch:"A/G6",flatName:"A6",sharpName:"G6",toneNote:"Ab6",frequency:1661.22,column:"A",hex:"#abd9fa",isAccidental:!0},{pitch:"G6",flatName:"G6",sharpName:"G6",toneNote:"G6",frequency:1567.94,column:"B",hex:"#98dde9",isAccidental:!1},{pitch:"G/F6",flatName:"G6",sharpName:"F6",toneNote:"Gb6",frequency:1479.98,column:"A",hex:"#96ddcf",isAccidental:!0},{pitch:"F6",flatName:"F6",sharpName:"F6",toneNote:"F6",frequency:1396.91,column:"B",hex:"#a6d9b0",isAccidental:!1},{pitch:"E6",flatName:"E6",sharpName:"E6",toneNote:"E6",frequency:1318.51,column:"A",hex:"#c0d093",isAccidental:!1},{pitch:"E/D6",flatName:"E6",sharpName:"D6",toneNote:"Eb6",frequency:1244.51,column:"B",hex:"#dbc383",isAccidental:!0},{pitch:"D6",flatName:"D6",sharpName:"D6",toneNote:"D6",frequency:1174.66,column:"A",hex:"#efb586",isAccidental:!1},{pitch:"D/C6",flatName:"D6",sharpName:"C6",toneNote:"Db6",frequency:1108.73,column:"B",hex:"#f8a99c",isAccidental:!0},{pitch:"C6",flatName:"C6",sharpName:"C6",toneNote:"C6",frequency:1046.5,column:"A",hex:"#f3a2bb",isAccidental:!1},{pitch:"B5",flatName:"B5",sharpName:"B5",toneNote:"B5",frequency:987.77,column:"B",hex:"#e1a3db",isAccidental:!1},{pitch:"B/A5",flatName:"B5",sharpName:"A5",toneNote:"Bb5",frequency:932.33,column:"A",hex:"#c3a9f4",isAccidental:!0},{pitch:"A5",flatName:"A5",sharpName:"A5",toneNote:"A5",frequency:880,column:"B",hex:"#9ab2ff",isAccidental:!1},{pitch:"A/G5",flatName:"A5",sharpName:"G5",toneNote:"Ab5",frequency:830.61,column:"A",hex:"#67bdf7",isAccidental:!0},{pitch:"G5",flatName:"G5",sharpName:"G5",toneNote:"G5",frequency:783.99,column:"B",hex:"#30c6dc",isAccidental:!1},{pitch:"G/F5",flatName:"G5",sharpName:"F5",toneNote:"Gb5",frequency:739.99,column:"A",hex:"#32c8b2",isAccidental:!0},{pitch:"F5",flatName:"F5",sharpName:"F5",toneNote:"F5",frequency:698.46,column:"B",hex:"#6dc281",isAccidental:!1},{pitch:"E5",flatName:"E5",sharpName:"E5",toneNote:"E5",frequency:659.25,column:"A",hex:"#a0b556",isAccidental:!1},{pitch:"E/D5",flatName:"E5",sharpName:"D5",toneNote:"Eb5",frequency:622.25,column:"B",hex:"#c5a33f",isAccidental:!0},{pitch:"D5",flatName:"D5",sharpName:"D5",toneNote:"D5",frequency:587.33,column:"A",hex:"#dc9150",isAccidental:!1},{pitch:"D/C5",flatName:"D5",sharpName:"C5",toneNote:"Db5",frequency:554.37,column:"B",hex:"#e38475",isAccidental:!0},{pitch:"C5",flatName:"C5",sharpName:"C5",toneNote:"C5",frequency:523.25,column:"A",hex:"#dc7f9d",isAccidental:!1},{pitch:"B4",flatName:"B4",sharpName:"B4",toneNote:"B4",frequency:493.88,column:"B",hex:"#c781c0",isAccidental:!1},{pitch:"B/A4",flatName:"B4",sharpName:"A4",toneNote:"Bb4",frequency:466.16,column:"A",hex:"#a68ad8",isAccidental:!0},{pitch:"A4",flatName:"A4",sharpName:"A4",toneNote:"A4",frequency:440,column:"B",hex:"#7d94e0",isAccidental:!1},{pitch:"A/G4",flatName:"A4",sharpName:"G4",toneNote:"Ab4",frequency:415.3,column:"A",hex:"#4c9fd5",isAccidental:!0},{pitch:"G4",flatName:"G4",sharpName:"G4",toneNote:"G4",frequency:392,column:"B",hex:"#0fa6ba",isAccidental:!1},{pitch:"G/F4",flatName:"G4",sharpName:"F4",toneNote:"Gb4",frequency:369.99,column:"A",hex:"#24a794",isAccidental:!0},{pitch:"F4",flatName:"F4",sharpName:"F4",toneNote:"F4",frequency:349.23,column:"B",hex:"#5aa26a",isAccidental:!1},{pitch:"E4",flatName:"E4",sharpName:"E4",toneNote:"E4",frequency:329.63,column:"A",hex:"#849646",isAccidental:!1},{pitch:"E/D4",flatName:"E4",sharpName:"D4",toneNote:"Eb4",frequency:311.13,column:"B",hex:"#a38733",isAccidental:!0},{pitch:"D4",flatName:"D4",sharpName:"D4",toneNote:"D4",frequency:293.66,column:"A",hex:"#b67740",isAccidental:!1},{pitch:"D/C4",flatName:"D4",sharpName:"C4",toneNote:"Db4",frequency:277.18,column:"B",hex:"#bc6c5f",isAccidental:!0},{pitch:"C4",flatName:"C4",sharpName:"C4",toneNote:"C4",frequency:261.63,column:"A",hex:"#b56880",isAccidental:!1},{pitch:"B3",flatName:"B3",sharpName:"B3",toneNote:"B3",frequency:246.94,column:"B",hex:"#a3699e",isAccidental:!1},{pitch:"B/A3",flatName:"B3",sharpName:"A3",toneNote:"Bb3",frequency:233.08,column:"A",hex:"#8870b1",isAccidental:!0},{pitch:"A3",flatName:"A3",sharpName:"A3",toneNote:"A3",frequency:220,column:"B",hex:"#6578b7",isAccidental:!1},{pitch:"A/G3",flatName:"A3",sharpName:"G3",toneNote:"Ab3",frequency:207.65,column:"A",hex:"#3c81ad",isAccidental:!0},{pitch:"G3",flatName:"G3",sharpName:"G3",toneNote:"G3",frequency:196,column:"B",hex:"#0e8696",isAccidental:!1},{pitch:"G/F3",flatName:"G3",sharpName:"F3",toneNote:"Gb3",frequency:185,column:"A",hex:"#1b8777",isAccidental:!0},{pitch:"F3",flatName:"F3",sharpName:"F3",toneNote:"F3",frequency:174.61,column:"B",hex:"#478255",isAccidental:!1},{pitch:"E3",flatName:"E3",sharpName:"E3",toneNote:"E3",frequency:164.81,column:"A",hex:"#697836",isAccidental:!1},{pitch:"E/D3",flatName:"E3",sharpName:"D3",toneNote:"Eb3",frequency:155.56,column:"B",hex:"#836b27",isAccidental:!0},{pitch:"D3",flatName:"D3",sharpName:"D3",toneNote:"D3",frequency:146.83,column:"A",hex:"#925e32",isAccidental:!1},{pitch:"D/C3",flatName:"D3",sharpName:"C3",toneNote:"Db3",frequency:138.59,column:"B",hex:"#96554b",isAccidental:!0},{pitch:"C3",flatName:"C3",sharpName:"C3",toneNote:"C3",frequency:130.81,column:"A",hex:"#905165",isAccidental:!1},{pitch:"B2",flatName:"B2",sharpName:"B2",toneNote:"B2",frequency:123.47,column:"B",hex:"#80527c",isAccidental:!1},{pitch:"B/A2",flatName:"B2",sharpName:"A2",toneNote:"Bb2",frequency:116.54,column:"A",hex:"#6a578c",isAccidental:!0},{pitch:"A2",flatName:"A2",sharpName:"A2",toneNote:"A2",frequency:110,column:"B",hex:"#4e5e90",isAccidental:!1},{pitch:"A/G2",flatName:"A2",sharpName:"G2",toneNote:"Ab2",frequency:103.83,column:"A",hex:"#2d6488",isAccidental:!0},{pitch:"G2",flatName:"G2",sharpName:"G2",toneNote:"G2",frequency:98,column:"B",hex:"#096875",isAccidental:!1},{pitch:"G/F2",flatName:"G2",sharpName:"F2",toneNote:"Gb2",frequency:92.5,column:"A",hex:"#13685b",isAccidental:!0},{pitch:"F2",flatName:"F2",sharpName:"F2",toneNote:"F2",frequency:87.31,column:"B",hex:"#356440",isAccidental:!1},{pitch:"E2",flatName:"E2",sharpName:"E2",toneNote:"E2",frequency:82.41,column:"A",hex:"#505c28",isAccidental:!1},{pitch:"E/D2",flatName:"E2",sharpName:"D2",toneNote:"Eb2",frequency:77.78,column:"B",hex:"#63511c",isAccidental:!0},{pitch:"D2",flatName:"D2",sharpName:"D2",toneNote:"D2",frequency:73.42,column:"A",hex:"#6e4724",isAccidental:!1},{pitch:"D/C2",flatName:"D2",sharpName:"C2",toneNote:"Db2",frequency:69.3,column:"B",hex:"#713f37",isAccidental:!0},{pitch:"C2",flatName:"C2",sharpName:"C2",toneNote:"C2",frequency:65.41,column:"A",hex:"#6c3c4b",isAccidental:!1},{pitch:"B1",flatName:"B1",sharpName:"B1",toneNote:"B1",frequency:61.74,column:"B",hex:"#603c5d",isAccidental:!1},{pitch:"B/A1",flatName:"B1",sharpName:"A1",toneNote:"Bb1",frequency:58.27,column:"A",hex:"#4e4068",isAccidental:!0},{pitch:"A1",flatName:"A1",sharpName:"A1",toneNote:"A1",frequency:55,column:"B",hex:"#38446b",isAccidental:!1},{pitch:"A/G1",flatName:"A1",sharpName:"G1",toneNote:"Ab1",frequency:51.91,column:"A",hex:"#1f4964",isAccidental:!0},{pitch:"G1",flatName:"G1",sharpName:"G1",toneNote:"G1",frequency:49,column:"B",hex:"#044b55",isAccidental:!1},{pitch:"G/F1",flatName:"G1",sharpName:"F1",toneNote:"Gb1",frequency:46.25,column:"A",hex:"#0c4b41",isAccidental:!0},{pitch:"F1",flatName:"F1",sharpName:"F1",toneNote:"F1",frequency:43.65,column:"B",hex:"#24472c",isAccidental:!1},{pitch:"E1",flatName:"E1",sharpName:"E1",toneNote:"E1",frequency:41.2,column:"A",hex:"#38401a",isAccidental:!1},{pitch:"E/D1",flatName:"E1",sharpName:"D1",toneNote:"Eb1",frequency:38.89,column:"B",hex:"#463811",isAccidental:!0},{pitch:"D1",flatName:"D1",sharpName:"D1",toneNote:"D1",frequency:36.71,column:"A",hex:"#4d3017",isAccidental:!1},{pitch:"D/C1",flatName:"D1",sharpName:"C1",toneNote:"Db1",frequency:34.65,column:"B",hex:"#4f2a24",isAccidental:!0},{pitch:"C1",flatName:"C1",sharpName:"C1",toneNote:"C1",frequency:32.7,column:"A",hex:"#4a2733",isAccidental:!1},{pitch:"B0",flatName:"B0",sharpName:"B0",toneNote:"B0",frequency:30.87,column:"B",hex:"#41273f",isAccidental:!1},{pitch:"B/A0",flatName:"B0",sharpName:"A0",toneNote:"Bb0",frequency:29.14,column:"A",hex:"#342a46",isAccidental:!0},{pitch:"A0",flatName:"A0",sharpName:"A0",toneNote:"A0",frequency:27.5,column:"B",hex:"#242c48",isAccidental:!1}],U0=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"],se=A=>A.tonicSignGroups?Object.values(A.tonicSignGroups).flat():[],ge=(A,t)=>{const e=Yt.getColumnMap(A),{macrobeatGroupings:n}=A,s=n[t]??0;let r=null,i=null;for(const o of e.entries)o.macrobeatIndex===t&&o.type==="beat"&&((r===null||o.canvasIndex!==null&&o.canvasIndex<r)&&(r=o.canvasIndex),(i===null||o.canvasIndex!==null&&o.canvasIndex>i)&&(i=o.canvasIndex));if(r===null||i===null){let o=0;const a=se(A);a.some(l=>l.preMacrobeatIndex===-1)&&(o+=2);for(let l=0;l<t;l++)o+=n[l]??0,a.some(d=>d.preMacrobeatIndex===l)&&(o+=2);r=o,i=r+s-1}return{startColumn:r,endColumn:i,grouping:s}},M0=A=>A.placedNotes.filter(t=>!t.isDrum),T0=A=>A.placedNotes.filter(t=>t.isDrum),P0=(A,t)=>{const n=se(A).filter(l=>l.columnIndex<=t);if(n.length===0)return{keyTonic:"C",keyMode:"major"};const s=n.reduce((l,d)=>d.columnIndex>l.columnIndex?d:l),r=typeof s.globalRow=="number"?s.globalRow:s.row,i=iA[r]??A.fullRowData[s.row];if(!i)return{keyTonic:"C",keyMode:"major"};const o=Xo(i.toneNote),a=U0[s.tonicNumber-1]||"major";return{keyTonic:o,keyMode:a}},Cn=12,L0=50,H0=.5,Le=3,Xs=1,is=30,Fs=30,Is=.5,pc=3,D0=.7,N0=.9,R0=4,k0=1.5,_0=.15,O0=.2,K0=1,xs=1.5,G0="#CCCCCC",Ou=1,Bc=3,wc=5,W0=7,Pr=16,V0=0,z0=255;class q0{cachedMap=null;cacheKey=null;getColumnMap(t){const e=this.buildCacheKey(t);return this.cachedMap&&this.isCacheValid(e)?this.cachedMap:(this.cachedMap=this.buildColumnMap(t),this.cacheKey=e,this.cachedMap)}invalidate(){this.cachedMap=null,this.cacheKey=null}buildCacheKey(t){const n=se(t).map(s=>`${s.columnIndex}:${s.preMacrobeatIndex}:${s.uuid||""}`).sort().join("|");return{macrobeatGroupings:[...t.macrobeatGroupings],tonicSignsHash:n,macrobeatBoundaryStyles:[...t.macrobeatBoundaryStyles]}}isCacheValid(t){return this.cacheKey?this.cacheKey.tonicSignsHash===t.tonicSignsHash&&JSON.stringify(this.cacheKey.macrobeatGroupings)===JSON.stringify(t.macrobeatGroupings)&&JSON.stringify(this.cacheKey.macrobeatBoundaryStyles)===JSON.stringify(t.macrobeatBoundaryStyles):!1}buildColumnMap(t){const{macrobeatGroupings:e,macrobeatBoundaryStyles:n}=t,r=[...se(t)].sort((E,b)=>E.preMacrobeatIndex-b.preMacrobeatIndex),i=[],o=[];let a=0,l=0,d=0,u=0,h=0;const m=E=>{for(;h<r.length;){const b=r[h];if(!b||b.preMacrobeatIndex!==E)break;const S=b.uuid||"";for(let I=0;I<2;I++)i.push({visualIndex:a,canvasIndex:l,timeIndex:null,type:"tonic",widthMultiplier:Xs,xOffsetUnmodulated:u,macrobeatIndex:null,beatInMacrobeat:null,isMacrobeatStart:!1,isMacrobeatEnd:!1,isPlayable:!1,tonicSignUuid:I===0?S:null}),a++,l++,u+=Xs;const y=S;do h++;while(h<r.length&&(r[h]?.uuid||"")===y)}};for(let E=0;E<2;E++)i.push({visualIndex:a,canvasIndex:null,timeIndex:null,type:"legend-left",widthMultiplier:Le,xOffsetUnmodulated:u,macrobeatIndex:null,beatInMacrobeat:null,isMacrobeatStart:!1,isMacrobeatEnd:!1,isPlayable:!1,tonicSignUuid:null}),a++,u+=Le;m(-1),e.forEach((E,b)=>{for(let y=0;y<E;y++)i.push({visualIndex:a,canvasIndex:l,timeIndex:d,type:"beat",widthMultiplier:Xs,xOffsetUnmodulated:u,macrobeatIndex:b,beatInMacrobeat:y,isMacrobeatStart:y===0,isMacrobeatEnd:y===E-1,isPlayable:!0,tonicSignUuid:null}),a++,l++,d++,u+=Xs;const S=n[b]||"dashed";o.push({macrobeatIndex:b,visualColumn:a-1,canvasColumn:l-1,timeColumn:d-1,boundaryType:S,isMeasureStart:S==="solid"}),m(b)});for(let E=0;E<2;E++)i.push({visualIndex:a,canvasIndex:null,timeIndex:null,type:"legend-right",widthMultiplier:Le,xOffsetUnmodulated:u,macrobeatIndex:null,beatInMacrobeat:null,isMacrobeatStart:!1,isMacrobeatEnd:!1,isPlayable:!1,tonicSignUuid:null}),a++,u+=Le;const f=new Map,g=new Map,p=new Map,w=new Map,v=new Map,C=new Map;return i.forEach(E=>{f.set(E.visualIndex,E.canvasIndex),g.set(E.visualIndex,E.timeIndex),E.canvasIndex!==null&&(p.set(E.canvasIndex,E.visualIndex),w.set(E.canvasIndex,E.timeIndex)),E.timeIndex!==null&&(E.canvasIndex!==null&&v.set(E.timeIndex,E.canvasIndex),C.set(E.timeIndex,E.visualIndex))}),{entries:i,visualToCanvas:f,visualToTime:g,canvasToVisual:p,canvasToTime:w,timeToCanvas:v,timeToVisual:C,macrobeatBoundaries:o,totalVisualColumns:a,totalCanvasColumns:l,totalTimeColumns:d,totalWidthUnmodulated:u}}}const Yt=new q0;function X0(A){A.on("rhythmStructureChanged",()=>{Yt.invalidate()})}function $0(A,t){return Yt.getColumnMap(t).visualToTime.get(A)??null}function PA(A,t){return Yt.getColumnMap(t).canvasToTime.get(A)??null}function pe(A,t){const n=Yt.getColumnMap(t).timeToCanvas.get(A);return n!==void 0?n:A}function Y0(A,t){const n=Yt.getColumnMap(t).timeToVisual.get(A);return n!==void 0?n:A+2}function J0(A,t){const e=Yt.getColumnMap(t),n=e.canvasToVisual.get(A);return n!==void 0&&e.entries[n]||null}function j0(A,t){return J0(A,t)?.isPlayable??!1}function Z0(A){const t=Yt.getColumnMap(A),e=[];for(const n of t.entries)n.canvasIndex!==null&&(e[n.canvasIndex]=n.widthMultiplier);return e}function Yo(A,...t){}const Ce={COMPRESSION_2_3:2/3,EXPANSION_3_2:3/2};function tB(A,t){if(!t||!t.macrobeatGroupings)return A*4;if(A===0)return 0;const e=A-1,n=ge(t,e);if(n){const r=n.endColumn+1;return Yo("log","[MODULATION] Found measure info, canvas-space endColumn:",n.endColumn,"first column after:",r),r}return A*4}function Ku(A){return Math.abs(A-Ce.COMPRESSION_2_3)<.001?"2:3":Math.abs(A-Ce.EXPANSION_3_2)<.001?"3:2":`${A}`}function Gu(A){const t="#ffc107";return Math.abs(A-Ce.COMPRESSION_2_3)<.001||Math.abs(A-Ce.EXPANSION_3_2)<.001,t}function vc(){const A=[{startColumn:0,endColumn:1/0,scale:1}];return{segments:A,getScaleForColumn(t){return 1},microbeatToCanvasX(){return 0},canvasXToMicrobeat(){return 0},getSegmentAtX(){return A[0]||null},getGhostGridPositions(){return[]}}}function eB(A,t,e=null){if(!A||A.length===0)return vc();const n=[...A.filter(l=>l.active)].sort((l,d)=>l.measureIndex-d.measureIndex);if(n.length===0)return vc();const s=n.map(l=>{const d=tB(l.measureIndex,e);return Yo("log",`[MODULATION] Marker at measure ${l.measureIndex} calculated column=${d}`),Yo("log","[MODULATION] Final marker position:",{id:l.id,measureIndex:l.measureIndex,columnIndex:d}),{...l,columnIndex:d}}),r=[];let i=1;const o=s[0];if(s.length===0||o&&o.columnIndex>0){const l=o?o.columnIndex:1/0;r.push({startColumn:0,endColumn:l,scale:1})}for(let l=0;l<s.length;l++){const d=s[l],u=s[l+1],h=u?u.columnIndex:1/0;i*=d.ratio,r.push({startColumn:d.columnIndex,endColumn:h,scale:i,marker:d})}return{segments:r,getScaleForColumn(l){for(const d of r)if(l>=d.startColumn&&l<d.endColumn)return d.scale;return 1},microbeatToCanvasX(l){return 0},canvasXToMicrobeat(l){return 0},getSegmentAtX(l){return r[0]||null},getGhostGridPositions(l,d){return[]}}}class AB{cachedPixelMap=null;lastPixelMapHash=null;getColumnPixelPosition(t,e,n){const s=this.getOrBuildPixelMap(e,n),r=s.columnPositions.get(Math.floor(t));if(r)return r;const i=s.columnPositions.size;return t===i&&s.columnPositions.get(i-1)?{canvasIndex:t,xStart:s.totalPixelWidth,xEnd:s.totalPixelWidth,width:0,modulationScale:1}:this.calculateFallbackPosition(t,e)}columnToPixelX(t,e,n){const s=Math.floor(t),r=t-s,i=this.getColumnPixelPosition(s,e,n);return i.xStart+r*i.width}pixelXToColumn(t,e,n){const s=this.getOrBuildPixelMap(e,n),r=Array.from(s.columnPositions.values()).sort((a,l)=>a.canvasIndex-l.canvasIndex);for(const a of r)if(t>=a.xStart&&t<a.xEnd){const l=(t-a.xStart)/a.width;return a.canvasIndex+l}if(r.length===0)return 0;const i=r[0];return!i||t<i.xStart?0:r[r.length-1]?.canvasIndex??0}invalidate(){this.cachedPixelMap=null,this.lastPixelMapHash=null}getOrBuildPixelMap(t,e){const n=this.buildPixelMapHash(t,e);return this.cachedPixelMap&&this.lastPixelMapHash===n?this.cachedPixelMap:(this.cachedPixelMap=this.buildPixelMap(t,e),this.lastPixelMapHash=n,this.cachedPixelMap)}buildPixelMapHash(t,e){const n=t.modulationMarkers?JSON.stringify(t.modulationMarkers.map(s=>({id:s.id,col:s.columnIndex,ratio:s.ratio}))):"none";return JSON.stringify({cellWidth:t.cellWidth,modulation:n,columnCount:e?Yt.getColumnMap(e).totalCanvasColumns:0})}buildPixelMap(t,e){const{cellWidth:n,modulationMarkers:s}=t,r=Yt.getColumnMap(e),i=new Map,o=t.baseMicrobeatPx??n,a=s&&s.length>0?eB(s,o,e):null;let l=0;for(const d of r.entries){if(d.canvasIndex===null)continue;const u=d.widthMultiplier*n,h=a?a.getScaleForColumn(d.canvasIndex):1,m=u*h;i.set(d.canvasIndex,{canvasIndex:d.canvasIndex,xStart:l,xEnd:l+m,width:m,modulationScale:h}),l+=m}return{columnPositions:i,totalPixelWidth:l}}calculateFallbackPosition(t,e){const{cellWidth:n}=e,s=n;return{canvasIndex:t,xStart:t*s,xEnd:(t+1)*s,width:s,modulationScale:1}}}const HA=new AB;function nB(A){A.on("rhythmStructureChanged",()=>{HA.invalidate()})}function sB(A,t){const e=t.state||t;return HA.columnToPixelX(A,t,e)}function Wu(A){const t=A.state||A;return HA.getOrBuildPixelMap(A,t).totalPixelWidth}function rB(A){return Z0(A)}function iB(A,t){return A.reduce((e,n)=>e+n,0)*t}let cn=1,bn=0,_A,yn,Jo,os,as,rA,jo,Zo,Vu,zu,qu,Xu,Me,ls,ta,eo=null,Lr=!1,cs=!1,Ao=!1,no=!1,ea=!1,Cc=0,$s=null,Sn=null,Aa=0,$u=null,so=!1,Ys=0;const oB=new Promise(A=>{$u=()=>A()});let ro=0,io=0;function Yu(){const A=document.getElementById("pitch-grid-container"),t=bn||window.innerHeight||0;return A?.clientHeight||(t?t*.7:0)}function bc(A,t){return Tg(A,t,{baseUnit:is,paddingRows:1})}function En(){const A=c.state.fullRowData.length,t=Math.max(0,A-1),e=c.state.pitchRange||{topIndex:0,bottomIndex:t};return aA(e,A,te)}function Hr(){Sn!==null&&(cancelAnimationFrame(Sn),Sn=null),Aa+=1,cs=!1}function Js(A,t){const e=c.state.fullRowData.length,n=En(),s=aA(A,e,te);if(s.topIndex===n.topIndex&&s.bottomIndex===n.bottomIndex)return;const r=n.topIndex,i=yA(n);c.setPitchRange(s),c.emit("scrollChanged");const o=s.topIndex-r;if(o!==0&&c.emit("scrollByUnits",o),yA(s)!==i){We(),c.emit("zoomChanged");return}document.dispatchEvent(new CustomEvent("canvasResized",{detail:{source:t}}))}function js(A,t,e){Hr(),cs=!0;const n=c.state.fullRowData.length,s=En(),r=aA(A,n,te);if(r.topIndex===s.topIndex&&r.bottomIndex===s.bottomIndex){cs=!1;return}const i=Aa,o=performance.now(),a=Math.max(0,Math.round(t));let l=s.topIndex;const d=h=>h<.5?4*h*h*h:1-Math.pow(-2*h+2,3)/2,u=()=>{if(i!==Aa)return;const h=performance.now(),m=a>0?(h-o)/a:1,f=Math.max(0,Math.min(1,m)),g=d(f),p=Math.round(s.topIndex+(r.topIndex-s.topIndex)*g),w=Math.round(s.bottomIndex+(r.bottomIndex-s.bottomIndex)*g),v=aA({topIndex:p,bottomIndex:w},n,te);c.setPitchRange(v),c.emit("scrollChanged");const C=v.topIndex-l;if(C!==0&&(c.emit("scrollByUnits",C),l=v.topIndex),We(),c.emit("zoomChanged"),f<1){Sn=requestAnimationFrame(u);return}Sn=null,cs=!1};Sn=requestAnimationFrame(u)}function aB(){try{if(globalThis.__SN_DEBUG_VIEWPORT)return!0}catch{}try{if(new URLSearchParams(window.location.search).get("debugViewport")==="1")return!0}catch{}try{return localStorage.getItem("sn:debugViewport")==="1"}catch{return!1}}let lB=!1;function Ju(A,t){if(aB())try{const e=performance?.now?.()??Date.now();if(e-Cc<500)return;Cc=e,lB=!0}catch{}}function cB(){const A=window?.devicePixelRatio??1;return!Number.isFinite(A)||A<=0?1:A}function NA(A,t,e,n,s){if(!A)return!1;const r=Number.isFinite(n)&&n>0?n:1;A.dataset.pixelRatio=`${r}`;let i=!1;if(typeof t=="number"){const o=Math.max(1,Math.round(t*r));Math.abs(A.width-o)>.5&&(A.width=o,i=!0),A.style.width=`${t}px`,A.dataset.logicalWidth=`${t}`}if(typeof e=="number"){const o=Math.max(1,Math.round(e*r));Math.abs(A.height-o)>.5&&(A.height=o,i=!0),A.style.height=`${e}px`,A.dataset.logicalHeight=`${e}`}if(i){const o=s||A.getContext("2d");o&&o.setTransform(r,0,0,r,0,0)}return i}function dB(){_A=document.getElementById("pitch-grid-wrapper"),yn=document.getElementById("notation-grid"),os=document.getElementById("legend-left-canvas"),as=document.getElementById("legend-right-canvas"),rA=document.getElementById("drum-grid-wrapper"),jo=document.getElementById("drum-grid"),Vu=document.getElementById("drum-playhead-canvas"),zu=document.getElementById("playhead-canvas"),qu=document.getElementById("hover-canvas"),Xu=document.getElementById("drum-hover-canvas"),Me=document.getElementById("button-grid"),ls=document.getElementById("grid-scrollbar-proxy"),ta=ls?.querySelector(".grid-scrollbar-inner")||null;const A=document.getElementById("canvas-container");if(!_A||!yn||!A)return{};Jo=yn.getContext("2d"),Zo=jo?.getContext("2d")||null;const t=os?.getContext("2d")||null,e=as?.getContext("2d")||null;return{ctx:Jo,drumCtx:Zo,legendLeftCtx:t,legendRightCtx:e,canvasContainer:A}}function uB(){if(ea)return;const A=(c.state.columnWidths?.length||0)>0,t=!!(c.state.cellWidth&&c.state.cellWidth>0);!A||!t||(ea=!0,$u?.())}function We(){if(!_A||_A.clientHeight===0){Ao||(B.warn("LayoutService","Pitch grid wrapper not ready for layout (height=0). Retrying on next frame.",null,"layout"),Ao=!0),requestAnimationFrame(We);return}if(Ao=!1,Lr)return;Lr=!0;const A=document.getElementById("pitch-grid-container");_A.clientWidth;const t=window.innerHeight;(Math.abs(t-bn)>3||bn===0)&&(bn=t);const n=is,s=n*H0,r=En(),i=Yu(),o=Math.max(1,yA(r));cn=bc(i,o);const a=Math.round(n*cn),l=Math.round(s*cn);c.setLayoutConfig({cellHeight:a,cellWidth:l});const d=rB(c.state);c.setLayoutConfig({columnWidths:d}),uB(),(!c.state.cellWidth||!d.length)&&B.warn("LayoutService","Unexpected layout configuration",{cellWidth:c.state.cellWidth,columnCount:d.length},"layout");const h=d.reduce((x,H)=>x+H,0)*c.state.cellWidth,m=he.getModulatedCanvasWidth(),f=c.state.modulationMarkers&&c.state.modulationMarkers.length>0,g=f?m:h,p=Le*2*c.state.cellWidth,w=Le*2*c.state.cellWidth,v=Math.round(g+p+w),C=cB();document.getElementById("drum-grid-wrapper");const F=document.getElementById("grids-wrapper"),E=v+"px";if(A&&(A.style.width=E),_A&&(_A.style.width=E),rA&&(rA.style.width=E),ta&&ls){ta.style.width=E;const x=F?.getBoundingClientRect().width||0;v>x?ls.style.display="":ls.style.display="none"}const b=Math.max(Fs,Is*c.state.cellHeight),S=pc*b,y=`${S}px`,I=c.state.columnWidths?.length??0;let Q=0;if(f){const x={cellWidth:c.state.cellWidth,columnWidths:c.state.columnWidths,modulationMarkers:c.state.modulationMarkers,baseMicrobeatPx:c.state.cellWidth,cellHeight:c.state.cellHeight,state:c.state};Q=Wu(x)}else for(let x=0;x<I;x++)Q+=(c.state.columnWidths[x]||0)*c.state.cellWidth;if(I===0&&B.warn("LayoutService","Column widths array is empty.",{columnWidthsCount:I,columnWidths:c.state.columnWidths},"layout"),Q<50&&I>0&&B.warn("LayoutService","Computed button-grid middle cell width is unexpectedly small.",{middleCellWidth:Q,columnWidthsSample:c.state.columnWidths?.slice(0,10),cellWidth:c.state.cellWidth,macrobeatGroupings:c.state.macrobeatGroupings},"layout"),Me){const x=Me.querySelector(".button-grid-left-cell"),H=Me.querySelector(".button-grid-middle-cell"),O=Me.querySelector(".button-grid-right-cell"),z=Le*2*c.state.cellWidth,G=Le*2*c.state.cellWidth;(Math.abs(io-S)>5||io===0)&&(Me.style.height=y,io=S);const k=(K,q)=>{if(!K)return;const tt=`${Math.max(0,q)}px`;K.style.width=tt,K.style.flex=`0 0 ${tt}`,K.style.maxWidth=tt,K.style.minWidth=tt,K.style.height=y};if(x){k(x,z);const K=x.getBoundingClientRect();z>0&&K.width===0&&B.warn("LayoutService","Left button-grid cell measured width is 0 after assignment.",{assignedWidth:z,measuredWidth:K.width,computedDisplay:window.getComputedStyle(x).display},"layout")}if(H){Q===0&&B.warn("LayoutService","Calculated middle button-grid width is 0. Check column width data.",{columnWidths:c.state.columnWidths,cellWidth:c.state.cellWidth},"layout"),k(H,Q);const K=H.getBoundingClientRect();if(Q>0&&K.width===0&&B.warn("LayoutService","Middle button-grid cell assigned width but still measures 0.",{assignedWidth:Q,measuredWidth:K.width,computedStyles:window.getComputedStyle(H)},"layout"),Math.abs(K.width-Q)>5&&(B.warn("LayoutService","Middle cell measured width does not match assigned width.",{assignedWidth:Q,measuredWidth:K.width,styleWidth:H.style.width,cellWidth:c.state.cellWidth},"layout"),requestAnimationFrame(()=>{const q=H.getBoundingClientRect();Math.abs(q.width-Q)>5&&B.warn("LayoutService","Middle cell still mismatched after RAF.",{assignedWidth:Q,measuredWidth:q.width,delta:q.width-Q,computedStyles:window.getComputedStyle(H)},"layout")})),!no){const q=H.querySelector("#beat-line-button-layer");if(q){const tt=q.getBoundingClientRect();if(tt.width===0){const N=window.getComputedStyle(q);B.warn("LayoutService","#beat-line-button-layer width is 0 despite middle cell sizing.",{beatLineRect:tt,beatLineStyles:{display:N.display,position:N.position,flex:{direction:N.flexDirection,grow:N.flexGrow,shrink:N.flexShrink,basis:N.flexBasis},width:N.width,minWidth:N.minWidth,maxWidth:N.maxWidth},middleRect:K,middleCellComputedWidth:N.width},"layout"),no=!0}}else B.warn("LayoutService","Could not find #beat-line-button-layer inside middle cell to measure.",null,"layout"),no=!0}}if(O){k(O,G);const K=O.getBoundingClientRect();G>0&&K.width===0&&B.warn("LayoutService","Right button-grid cell measured width is 0 after assignment.",{assignedWidth:G,measuredWidth:K.width,computedDisplay:window.getComputedStyle(O).display},"layout")}const T=z+Q+G;Number.isFinite(T)&&T>0&&(Me.style.width=E,Me.style.maxWidth=E,Me.style.minWidth=E),Me.getBoundingClientRect().width===0&&B.warn("LayoutService","Entire button grid wrapper width is 0 after layout pass.",{leftCellWidth:z,middleCellWidth:Q,rightCellWidth:G,wrapperStyles:window.getComputedStyle(Me)},"layout")}const U=Math.max(Fs,Is*c.state.cellHeight),M=pc*U,P=`${M}px`,R=A?.clientHeight||0;if(R>0){const x=c.state.cellHeight,H=c.state.cellWidth,O=Math.max(1,yA(r)),z=bc(R,O),G=Math.round(n*z),ct=Math.round(s*z);c.setLayoutConfig({cellHeight:G,cellWidth:ct}),cn=z,(G!==x||ct!==H)&&(so=!0)}const $=Math.round(Le*2*c.state.cellWidth),L=Math.round(Le*2*c.state.cellWidth),V=Math.round(g),_=[{element:yn,context:Jo},{element:zu},{element:qu}];if(_.forEach(({element:x,context:H})=>{NA(x,V,R,C,H),x&&(x.style.left=`${$}px`)}),NA(os,$,R,C,null),NA(as,L,R,C,null),[{element:jo,context:Zo},{element:Vu},{element:Xu}].forEach(({element:x,context:H})=>{NA(x,V,M,C,H)}),rA){const x=rA.querySelector(".drum-grid-left-cell"),H=rA.querySelector(".drum-grid-middle-cell"),O=rA.querySelector(".drum-grid-right-cell"),z=(ct,D)=>{if(!ct)return;const k=`${Math.max(0,Math.round(D))}px`;ct.style.width=k,ct.style.flex=`0 0 ${k}`,ct.style.maxWidth=k,ct.style.minWidth=k,ct.style.height=P};z(x,$),z(H,V),z(O,L);const G=H?.querySelector("#drum-canvas-wrapper");G&&(G.style.width="100%",G.style.height=P)}const ht=Math.abs(ro-M)>5||ro===0;rA&&ht&&(rA.style.height=P,ro=M);const mt=C,it=V;$s&&clearTimeout($s),$s=setTimeout(()=>{$s=null;const H=document.getElementById("pitch-grid-container")?.clientHeight||0;_.forEach(({element:O,context:z})=>{NA(O,it,H,mt,z),O&&(O.style.left=`${$}px`)}),NA(os,$,H,mt,null),NA(as,L,H,mt,null),Ju("deferredResize",{finalContainerHeight:H,pitchCanvasLogicalHeight:yn?.dataset?.logicalHeight,legendLeftLogicalHeight:os?.dataset?.logicalHeight,legendRightLogicalHeight:as?.dataset?.logicalHeight}),document.dispatchEvent(new CustomEvent("canvasResized",{detail:{source:"layoutService-deferred"}}))});try{const x=c.state.fullRowData.length,H=Math.max(0,x-1),O=c.state.pitchRange||{topIndex:0,bottomIndex:H},z=aA(O,x,te);(O.topIndex!==z.topIndex||O.bottomIndex!==z.bottomIndex)&&c.setPitchRange(z)}catch{}c.emit("layoutConfigChanged"),Lr=!1,so?(so=!1,Ys<1?(Ys+=1,requestAnimationFrame(We)):B.warn("LayoutService","Skipped additional layout pass after repeated final zoom adjustments.",{finalRecalcAttempts:Ys},"layout")):Ys=0}const he={init(){const{ctx:A,drumCtx:t,legendLeftCtx:e,legendRightCtx:n}=dB();requestAnimationFrame(We),this.initScrollHandler();const s=()=>{Lr||(eo!==null&&clearTimeout(eo),eo=setTimeout(()=>{We()},L0))};return window.addEventListener("resize",s),c.on("zoomIn",r=>{this.zoomIn(r)}),c.on("zoomOut",r=>{this.zoomOut(r)}),{ctx:A,drumCtx:t,legendLeftCtx:e,legendRightCtx:n}},waitForInitialLayout(){return ea?Promise.resolve():oB},getCurrentZoomLevel(){return cn},setZoomLevel(A){const t=Number.isFinite(A)&&A>0?A:1,e=Yu(),n=c.state.fullRowData.length,s=Math.max(0,n-1);if(!n||n<=0)return;const r=2*e/(t*is),i=Math.max(te,Math.min(n,Math.round(r)-1)),o=En(),a=(o.topIndex+o.bottomIndex)/2,l=(i-1)/2;let d=Math.round(a-l),u=d+i-1;if(d<0&&(u+=-d,d=0),u>s){const h=u-s;d-=h,u=s}Js({topIndex:d,bottomIndex:u},"setZoomLevel")},setPitchViewportRange(A,t={}){const e=t.source??"setPitchViewportRange",n=Math.max(0,Math.round(t.animateMs??0));if(n>0){js(A,n);return}Js(A,e)},_canScrollRange(A){const t=c.state.pitchRange;if(!t||!iA||iA.length===0)return!1;const e=iA.length-1,n=typeof A=="string"?A==="up"?-1:1:A,s=n<0&&t.topIndex>0,r=n>0&&t.bottomIndex<e;return s||r},initScrollHandler(){const A=document.getElementById("pitch-grid-wrapper");A&&A.addEventListener("wheel",t=>{if(t.preventDefault(),t.ctrlKey||t.metaKey)t.deltaY<0?this.zoomIn({source:"wheel"}):this.zoomOut({source:"wheel"});else{const e=t.deltaY>0?1:-1;this._canScrollRange(e)&&this.scrollByUnits(e)}},{passive:!1})},zoomIn(A){const t=c.state.fullRowData.length;if(!t)return;const e=En(),n=yA(e),s=Jl(n,t),r=jl(e,"in",{totalRanks:t,minSpan:te,zoomStep:s}),i=yA(r),o=A?.source??"unknown",a=o==="wheel"?0:280;B.debug("LayoutService",`[Zoom] Range zoom in (span ${n} -> ${i})`,{source:o},"layout"),a>0?js(r,a):(Js(r,`zoomIn:${o}`),c.emit("zoomChanged"))},zoomOut(A){const t=c.state.fullRowData.length;if(!t)return;const e=En(),n=yA(e),s=Jl(n,t),r=jl(e,"out",{totalRanks:t,minSpan:te,zoomStep:s}),i=yA(r),o=A?.source??"unknown",a=o==="wheel"?0:280;B.debug("LayoutService",`[Zoom] Range zoom out (span ${n} -> ${i})`,{source:o},"layout"),a>0?js(r,a):(Js(r,`zoomOut:${o}`),c.emit("zoomChanged"))},resetZoom(A){const t=c.state.fullRowData.length;if(!t)return;const e=Math.max(0,t-1);A?.source,js({topIndex:0,bottomIndex:e},320)},scroll(A){const e=this.getViewportInfo().startRank;c.emit("scrollChanged");const r=this.getViewportInfo().startRank-e;r!==0&&c.emit("scrollByUnits",r),c.emit("layoutConfigChanged")},scrollByUnits(A){Hr();const t=c.state.pitchRange;if(!t||!iA||iA.length===0)return;const e=Math.sign(A||0);if(e===0)return;const n=iA.length,s=aA(t,n,te),r=Mg(s,e,n);r.topIndex===s.topIndex&&r.bottomIndex===s.bottomIndex||(c.setPitchRange(r),c.emit("scrollChanged"),c.emit("scrollByUnits",e),document.dispatchEvent(new CustomEvent("canvasResized",{detail:{source:"viewportScroll"}})))},setViewportTopIndex(A){Hr();const t=c.state.pitchRange||{topIndex:0,bottomIndex:Math.max(0,c.state.fullRowData.length-1)},e=c.state.fullRowData.length,n=aA(t,e,te),s=Ug(n,A,e,te),r=s.topIndex-(n.topIndex??0);s.topIndex===n.topIndex&&s.bottomIndex===n.bottomIndex||(c.setPitchRange(s),c.emit("scrollChanged"),r!==0&&c.emit("scrollByUnits",r),We(),c.emit("zoomChanged"))},setViewportBottomIndex(A){Hr();const t=c.state.pitchRange||{topIndex:0,bottomIndex:Math.max(0,c.state.fullRowData.length-1)},e=c.state.fullRowData.length,n=aA(t,e,te),s=xg(n,A,e,te),r=s.topIndex-(n.topIndex??0);B.debug("LayoutService","setViewportBottomIndex",{requestedBottom:A,currentRange:t,normalized:n,nextRange:s,willUpdate:!(s.topIndex===n.topIndex&&s.bottomIndex===n.bottomIndex)},"layout"),!(s.topIndex===n.topIndex&&s.bottomIndex===n.bottomIndex)&&(c.setPitchRange(s),c.emit("scrollChanged"),r!==0&&c.emit("scrollByUnits",r),We(),c.emit("zoomChanged"))},scrollByPixels(A,t=0){const n=this.getViewportInfo().startRank;c.state.fullRowData.length,c.state.cellHeight,c.emit("scrollChanged");const i=this.getViewportInfo().startRank-n;i!==0&&c.emit("scrollByUnits",i),c.emit("layoutConfigChanged")},getViewportInfo(){const A=c.state.fullRowData.length,t=Math.max(0,A-1),e=document.getElementById("pitch-grid-container"),n=e?.clientHeight||bn*.7,s=c.state.cellHeight||is,r=s/2,i=aA(c.state.pitchRange||{topIndex:0,bottomIndex:t},A,te),o=Math.max(0,Math.min(t,i.topIndex??0)),a=Math.max(o,Math.min(t,i.bottomIndex??t)),l=Math.min(A,a+1),d=o*r,u=document.getElementById("legend-left-canvas"),h=document.getElementById("legend-right-canvas"),m=r?n/r:0,f=Math.max(1,a-o+1),g=f*r,p=c.state.fullRowData[o],w=c.state.fullRowData[a],v=o<=0,C=a>=t;return Ju("getViewportInfo",{containerHeight:n,containerRectHeight:e?.getBoundingClientRect?.().height,cellHeight:s,halfUnit:r,ratio:m,rowCount:f,coveragePx:g,coverageGapPx:n-g,totalRanks:A,pitchRange:i,startRank:o,endRank:l,atTopGamutEdge:v,atBottomGamutEdge:C,scrollOffset:d,startRowSummary:p?{pitch:p.pitch,column:p.column,isBoundary:!!p.isBoundary}:null,endRowSummary:w?{pitch:w.pitch,column:w.column,isBoundary:!!w.isBoundary}:null,pitchCanvasLogicalHeight:yn?.dataset?.logicalHeight,legendLeftLogicalHeight:u?.dataset?.logicalHeight,legendRightLogicalHeight:h?.dataset?.logicalHeight,legendLeftCssHeight:u?.getBoundingClientRect?.().height,legendRightCssHeight:h?.getBoundingClientRect?.().height}),{zoomLevel:cn,viewportHeight:bn,containerHeight:n,cellHeight:s,halfUnit:r,startRank:o,endRank:l,scrollOffset:d}},getMacrobeatWidthPx(A,t){return t*A.cellWidth},getColumnX(A){const t=c.state.cellWidth||40,e=c.state.columnWidths||[];return sB(A,{cellWidth:t,columnWidths:e,modulationMarkers:c.state.modulationMarkers,baseMicrobeatPx:t,state:c.state})},getCanvasWidth(){return iB(c.state.columnWidths,c.state.cellWidth)},getModulatedCanvasWidth(){const A=this.getCanvasWidth();if(!c.state.modulationMarkers||c.state.modulationMarkers.length===0)return A;try{const t=c.state.cellWidth||40,e=c.state.columnWidths||[],n={cellWidth:t,columnWidths:e,modulationMarkers:c.state.modulationMarkers,baseMicrobeatPx:t,cellHeight:c.state.cellHeight||40,state:c.state};return Wu(n)}catch{return A}},recalculateLayout(){We()},reflow(){We()},get isZooming(){return cs}};let oo=null,ao=null,lo=null,co=null;const Us={setContexts({ctx:A,drumCtx:t,legendLeftCtx:e,legendRightCtx:n}){oo=A??null,ao=t??null,lo=e??null,co=n??null},getPitchContext(){return oo||B.error("CanvasContextService","Pitch context requested before it was set.",null,"canvas"),oo},getDrumContext(){return ao||B.error("CanvasContextService","Drum context requested before it was set.",null,"canvas"),ao},getLegendLeftContext(){return lo||B.error("CanvasContextService","Legend left context requested before it was set.",null,"canvas"),lo},getLegendRightContext(){return co||B.error("CanvasContextService","Legend right context requested before it was set.",null,"canvas"),co}},ae={getViewportInfo:()=>he.getViewportInfo(),setViewportTopIndex(A){he.setViewportTopIndex?.(A)},setViewportBottomIndex(A){he.setViewportBottomIndex?.(A)},setPitchViewportRange(A,t={}){he.setPitchViewportRange?.(A,t)}};let Qn=null,Fn=null;c.on("modulationMarkersChanged",()=>{});c.on("scrollChanged",()=>{Qn=null,Fn=null});c.on("zoomChanged",()=>{Qn=null,Fn=null});c.on("pitchRangeChanged",()=>{Qn=null,Fn=null});function vl(){const A=performance.now();return(!Qn||!Fn||A-Fn>1)&&(Qn=ae.getViewportInfo(),Fn=A),Qn}function Y(A,t){const e=c.state,n={cellWidth:t.cellWidth,modulationMarkers:t.modulationMarkers,baseMicrobeatPx:t.baseMicrobeatPx,columnWidths:t.columnWidths,state:e};return HA.columnToPixelX(A,n,e)}function ut(A,t){const e=vl(),n=A-e.startRank,s=t.cellHeight/2;return(n+1)*s}function hB(A){let t=(A||"").replace(/\d/g,"").trim();return t=t.replace(/b/g,"b-").replace(/#/g,"b_"),t}function fB(A){switch(A){case"C":return{lineWidth:3.33,dash:[],color:"#adb5bd"};case"E":return{lineWidth:1,dash:[5,5],color:"#adb5bd"};case"G":return{lineWidth:1,dash:[],color:"#dee2e6"};case"B":case"A":case"F":case"Eb/Db":case"Db/C#":return{lineWidth:1,dash:[],color:"#ced4da"};default:return{lineWidth:1,dash:[],color:"#ced4da"}}}function gB(){const A=vl(),{startRank:t,endRank:e}=A,n=Math.max(t,e-1);return{startRow:t,endRow:n}}function na(A,t){const e=c.state,n={cellWidth:t.cellWidth,modulationMarkers:t.modulationMarkers,baseMicrobeatPx:t.baseMicrobeatPx,columnWidths:t.columnWidths,state:e};return HA.pixelXToColumn(A,n,e)}function mB(A,t){const e=vl(),n=t.cellHeight/2;return A/n-1+e.startRank}function ju(A,t){return t.some(e=>e.columnIndex===A)}function sa(A,t){return t.some(e=>A===e.columnIndex||A===e.columnIndex+1)}function Ms(A,t){const e=se(t);return!sa(A,e)}function Zu(A,t){for(const e of t)if(A===e.columnIndex+1)return!1;return t.some(e=>A===e.columnIndex+2),!0}function pB(A){const t=new Set;return A.forEach(e=>{t.add(e.columnIndex),t.add(e.columnIndex+1)}),t}function ne(A){if(!A)return 0;const t=A.dataset?.logicalWidth,e=t!==void 0?Number(t):NaN;return Number.isFinite(e)?e:A.width||0}function Mt(A){if(!A)return 0;const t=A.dataset?.logicalHeight,e=t!==void 0?Number(t):NaN;return Number.isFinite(e)?e:A.height||0}function BB(A){if(!A)return 1;const t=A.dataset?.pixelRatio,e=t!==void 0?Number(t):NaN;return Number.isFinite(e)&&e>0?e:1}const uo={stroke:"#c7cfd8",background:"rgba(207, 214, 222, 0.32)"};let Zs=null;function th(){if(Zs)return Zs;if(typeof window>"u")return uo;const A=window.getComputedStyle(document.documentElement);return Zs={stroke:A.getPropertyValue("--c-anacrusis-border").trim()||uo.stroke,background:A.getPropertyValue("--c-anacrusis-bg").trim()||uo.background},Zs}function wB(A){if(A.length===0)return[];const t=[...A].sort((n,s)=>n.start-s.start),e=[];for(const n of t){if(e.length===0){e.push({...n});continue}const s=e[e.length-1];n.start<=s.end?s.end=Math.max(s.end,n.end):e.push({...n})}return e}function vB(A){const t=[],e=bB();return e!==null&&e>0&&t.push({start:Y(0,A),end:Y(e,A)}),se(c.state).forEach(s=>{const r=Y(s.columnIndex,A),i=Y(s.columnIndex+2,A);t.push({start:r,end:i})}),wB(t)}function CB(A,t,e){const n=new Set([A,t]);e.forEach(i=>{const o=Math.max(A,Math.min(t,i.start)),a=Math.max(A,Math.min(t,i.end));a>o&&(n.add(o),n.add(a))});const s=Array.from(n).sort((i,o)=>i-o),r=[];for(let i=0;i<s.length-1;i++){const o=s[i],a=s[i+1],l=(o+a)/2,d=e.some(u=>l>=u.start&&l<u.end);a>o&&r.push({from:o,to:a,light:d})}return r}function bB(){const A=c.state;if(!A?.hasAnacrusis||!Array.isArray(A.macrobeatBoundaryStyles))return null;const t=A.macrobeatBoundaryStyles.findIndex(n=>n==="solid");if(t<0)return null;const e=ge(A,t);return e?e.endColumn+1:null}function yB(A,t,e,n){const s=vB(t),{stroke:r}=th();for(let i=e;i<=n;i++){const o=t.fullRowData[i];if(!o||o.isBoundary)continue;const a=ut(i,t);if(a<-10||a>t.viewportHeight+10)continue;const l=hB(o.pitch);if(["B","A","F","E/D","D/C"].includes(l))continue;const u=fB(l),h=t.musicalColumnWidths&&t.musicalColumnWidths.length>0?t.musicalColumnWidths:t.columnWidths||[],m=Y(0,t),f=Y(h.length,t),g=CB(m,f,s);l==="G"?g.forEach(p=>{const w=p.to-p.from;w<=0||(A.save(),A.fillStyle=p.light?r:u.color,A.globalAlpha=p.light?.5:1,A.fillRect(p.from,a-t.cellHeight/2,w,t.cellHeight),A.restore())}):g.forEach(p=>{p.to-p.from<=0||(A.beginPath(),A.moveTo(p.from,a),A.lineTo(p.to,a),A.lineWidth=u.lineWidth,A.strokeStyle=p.light?r:u.color,A.setLineDash(u.dash),A.globalAlpha=p.light?.6:1,A.stroke(),A.setLineDash([]),A.globalAlpha=1)})}}function SB(A,t,e,n){yB(A,t,e,n)}function EB(A,t){QB(A,t)}function QB(A,t){const{columnWidths:e,macrobeatGroupings:n,macrobeatBoundaryStyles:s,placedTonicSigns:r}=t,o=(t.musicalColumnWidths&&t.musicalColumnWidths.length>0?t.musicalColumnWidths:e).length,a=n.map((l,d)=>{const{endColumn:u}=ge(c.state,d);return u+1});for(let l=0;l<=o;l++){const d=l===0||l===o,u=ju(l,r),h=r.some(w=>l===w.columnIndex+2),m=a.includes(l);if(!Zu(l,r))continue;let g=null;if(d||u||h)g={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(m){const w=a.indexOf(l),v=s[w]??"dashed";if(v==="anacrusis"){const{stroke:C}=th();g={lineWidth:1,strokeStyle:C,dash:[4,4]}}else g={lineWidth:1,strokeStyle:"#adb5bd",dash:v==="solid"?[]:[5,5]}}if(!g)continue;const p=Y(l,t);A.beginPath(),A.moveTo(p,0),A.lineTo(p,Mt(A.canvas)),A.lineWidth=g.lineWidth,A.strokeStyle=g.strokeStyle,A.setLineDash(g.dash),A.stroke()}A.setLineDash([])}let yc=0;function eh(){try{if(globalThis.__SN_DEBUG_VIEWPORT)return!0}catch{}try{if(new URLSearchParams(window.location.search).get("debugViewport")==="1")return!0}catch{}try{return localStorage.getItem("sn:debugViewport")==="1"}catch{return!1}}let FB=!1;function IB(A,t){if(eh())try{const e=performance?.now?.()??Date.now();if(e-yc<500)return;yc=e,FB=!0}catch{}}const Sc=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"];function xB(A){const t=A.replace(/\d+$/,"");return t.length>0?t:A}function Ah(A,t){return!Number.isFinite(t)||t<=0?A:Math.round(A*t)/t}function UB(A,t,e,n){const s=Math.max(10,Math.min(A*1.2,t*1.2)),r=e<=3?1:.7,i=n<=1?1.08:1;return Ah(s*r*i,n)}function MB(A,t){const e=t[A];if(!e)return null;const s=e.pitch.replace(/\d+$/,"");return(s.includes("/")?s.split("/")[0]??s:s).replace(//g,"b").replace(//g,"#")}function TB(A,t){if(!A||!t)return[];const e=t-1;if(e<0||e>=Sc.length)return B.warn("LegendRenderer",`Invalid tonic number: ${t}`,null,"grid"),[];const n=Sc[e];try{const s=`${A} ${n}`;return x0(s).notes||[]}catch(s){return B.warn("LegendRenderer",`Could not generate ${n} scale`,{tonic:A,error:s},"grid"),[]}}function ei(A){return A?A.replace(/\d+$/,"").replace(/T-/g,"b").replace(/T_/g,"#").replace(/-/g,"b").replace(/_/g,"#").replace(//g,"b").replace(//g,"#"):""}function PB(A){const t=new Set;return A.forEach(e=>{const n=ei(e);if(n){t.add(n);try{const s=ei(rs(n));s&&t.add(s)}catch{}}}),t}function Ec(A,t){if(!t.size)return!0;const e=ei(A.toneNote||A.pitch);if(!e)return!1;if(t.has(e))return!0;try{const n=ei(rs(e));if(n&&t.has(n))return!0}catch{}return e.includes("/")?e.split("/").some(n=>t.has(n)):!1}function LB(A,t,e,n,s){const{fullRowData:r,columnWidths:i,cellWidth:o,cellHeight:a,colorMode:l}=e,d=l??"color",{sharp:u,flat:h}=c.state.accidentalMode,{focusColours:m,showFrequencyLabels:f}=c.state,g=e.showOctaveLabels??!0,p=y=>g?y:xB(y),w=(y,I)=>{if(!eh())return;const Q=a/2,U=Mt(y.canvas),M=ut(s,e),P=M+Q,R=document.getElementById("pitch-grid-container")?.clientHeight??null,$=r.length,L=n<=0,V=s>=$-1,_=it=>{if(it===null)return null;const x=r[it];return x?{rowIndex:it,pitch:x.pitch,column:x.column,isBoundary:!!x.isBoundary}:{rowIndex:it,exists:!1}},X=it=>{let x=null,H=null;for(let O=n;O<=s;O++){const z=r[O];!z||z.isDummy||z.column===it&&(x===null&&(x=O),H=O)}return{first:x,last:H}},At=X("A"),ht=X("B"),mt=it=>{if(it===null)return null;const x=ut(it,e);return{rowIndex:it,y:x,topEdge:x-Q,bottomEdge:x+Q,gapCanvasMinusBottomEdge:U-(x+Q)}};IB("legendCoverage",{side:I,startRow:n,endRow:s,atTopGamutEdge:L,atBottomGamutEdge:V,cellHeight:a,halfUnit:Q,yEnd:M,bottomEdge:P,canvasHeight:U,gapCanvasMinusBottomEdge:U-P,containerHeight:R,gapCanvasMinusContainer:typeof R=="number"?U-R:null,startRowSummary:_(n),endRowSummary:_(s),firstLastA:{...At,firstSummary:_(At.first),lastSummary:_(At.last)},firstLastB:{...ht,firstSummary:_(ht.first),lastSummary:_(ht.last)},aLastCoverage:mt(At.last),bLastCoverage:mt(ht.last)})};let v=[],C=new Set;if(m){const y=se(c.state),I=new Set;y.length||B.info("LegendRenderer","Focus Colours ON but no tonic placements found",null,"grid"),y.forEach(Q=>{const U=MB(Q.row,r),M=TB(U,Q.tonicNumber);B.debug("LegendRenderer","Focus Colours tonic scale",{tonicNote:U,tonicNumber:Q.tonicNumber,scaleNotes:M},"grid"),M.forEach(P=>I.add(P))}),v=Array.from(I),B.debug("LegendRenderer","Focus Colours combined scale",{focusScale:v},"grid"),C=PB(v)}const F=(y,I=[],Q=null)=>{if(f){const $=m&&C.size>0,L=Q?Ec(Q,C):!1;return $&&Q&&!L?null:Q&&Q.frequency?String(Q.frequency):y}if(!Q){if(!y.includes("/"))return p(y);const $=y.slice(-1),L=y.substring(0,y.length-1),[V,_]=L.split("/");return p(u&&h?`${V}/${_}${$}`:u?`${_}${$}`:h?`${V}${$}`:`${_}${$}`)}const{flatName:U,sharpName:M,isAccidental:P}=Q;if(!P)return p(U);let R;return u&&h?R=Q.pitch:u&&!h?R=M:h&&!u?R=U:R=M,p(R)},E=()=>!u&&!h,b=y=>{y.clearRect(0,0,ne(y.canvas),Mt(y.canvas))};function S(y,I,Q,U){const M=Le*2*o,P=[M/2,M/2],R=BB(y.canvas),$=X=>Ah(X,R);let L=0,V=0,_=0;Q.forEach((X,At)=>{const ht=P[At]??0;for(let mt=n;mt<=s;mt++){const it=r[mt];if(!(!it||it.isDummy)&&it.column===X){const x=ut(mt,e),H=it.isAccidental??it.pitch.includes("/"),O=!f&&H&&E(),z=Ec(it,C),G=F(it.pitch,U,it);if(G===null)continue;const ct=!!it.isBoundary;let D=d==="bw"?"#ffffff":it.hex||"#ffffff";m&&!z&&!f&&(D="#ffffff");const k=O||ct?"00":m&&!z?"55":"FF";m&&C.size>0&&(_+=1,z||(V+=1)),y.fillStyle=O?"rgba(255,255,255,0)":D,y.fillRect(L,x-a/2,ht,a);const T=UB(o,a,G.length,R);y.font=`bold ${T}px 'Atkinson Hyperlegible', sans-serif`,y.textAlign="center",y.textBaseline="middle";const W=$(L+ht/2),K=$(x);y.strokeStyle=`#212529${k}`,y.lineWidth=Math.max(1.2,2.5/R),y.lineJoin="round",y.strokeText(G,W,K),y.fillStyle=`#ffffff${k}`,y.fillText(G,W,K)}}L+=ht}),m&&C.size>0&&B.debug("LegendRenderer","Focus filter summary (separate)",{side:I===0?"left":"right",startCol:I,relevantScale:U,totalLabels:_,filteredLabels:V},"grid")}A&&(b(A),w(A,"left"),S(A,0,["B","A"],v)),t&&(b(t),w(t,"right"),S(t,i.length,["A","B"],v))}const nh={0:{degree:1,alt:0},1:{degree:2,alt:-1},2:{degree:2,alt:0},3:{degree:3,alt:-1},4:{degree:3,alt:0},5:{degree:4,alt:0},6:{degree:5,alt:-1},7:{degree:5,alt:0},8:{degree:6,alt:-1},9:{degree:6,alt:0},10:{degree:7,alt:-1},11:{degree:7,alt:0}};function HB(A){if(Math.abs(A.num)!==8||A.alt>=0)return null;const e=(A.semitones%12+12)%12;return nh[e]||null}function Qc(A){if(!A)return null;const t=s0(A);if(t?.num===void 0)return null;const e=HB(t);if(e){const a=e.degree,l=e.alt;let d="";return l<0?d="".repeat(Math.abs(l)):l>0&&(d="".repeat(l)),`${d}${a}`}const n=(t.semitones%12+12)%12,s=nh[n];if(!s){const a=Math.abs(t.num),l=t.alt;let d="";return l<0?d="".repeat(Math.abs(l)):l>0&&(d="".repeat(l)),`${d}${a}`}const r=s.degree,i=s.alt;let o="";return i<0?o="".repeat(Math.abs(i)):i>0&&(o="".repeat(i)),`${o}${r}`}function Fc(A){return A&&{"1":"2","2":"1","2":"3","3":"2","4":"5","5":"4","5":"6","6":"5","6":"7","7":"6"}[A]||null}function Ic(A){return!!(A&&(A.includes("")||A.includes("")))}const ho={getEnharmonicDegree:Fc,hasAccidental:Ic,getDegreeForNote(A,t){if(!A||!t)return null;const{keyTonic:e,keyMode:n}=P0(t,A.startColumnIndex);if(!e)return null;const s=A.globalRow??A.row,r=t.fullRowData[s]?.toneNote;if(!r)return null;const i=Xo(r)||r;let o=e;if(t.degreeDisplayMode!=="modal"&&n!=="major"){const h=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"].indexOf(n);if(h>0){const f=["1P","2M","3M","4P","5P","6M","7M"][h];if(f){const g=r0(f);o=vn(e,g)||o}}}const l=fc(o,i),d=Qc(l);if(A.enharmonicPreference&&d&&Ic(d)){const u=Fc(d);if(u)return u}return d},getDegreesForNotes(A,t){return!A||A.length===0?[]:A.map(e=>{const n=Xo(e)||e,s=fc(t,n);return Qc(s)}).filter(e=>e!==null)},getRomanNumeralForNotes(A,t){if(!A||A.length<2)return null;const[e]=Yp(A);if(!e)return null;const n=h0(e),s=n?.symbol;if(!s)return null;const[r]=Q0(t,[s]);if(!r)return null;const i=Qs(r),o=i?.roman;if(!o)return null;let a=i.name.replace(o,"");const l=n?.tonic||t;return a==="6"&&(a="add6"),{roman:o,ext:a,root:l}}},ra="",ia="",Ai="/",Gs=()=>window.animationEffectsManager,oa=()=>c.state.placedNotes,ni=A=>{const t=A?.split("-")[1];return Number.parseInt(t??"0",10)};function sh(A){if(!A||typeof A.startColumnIndex!="number"||typeof A.endColumnIndex!="number")return!1;const t=A.shape==="circle"?A.startColumnIndex+1:A.startColumnIndex;return A.endColumnIndex>t}function rh(A,t,e){const{cellWidth:n}=e,s=n*.25,r=A.uuid;if(!r)return 0;const i=t.filter(l=>!l.isDrum&&l.row===A.row&&l.startColumnIndex===A.startColumnIndex&&l.uuid&&l.uuid!==r);if(i.length===0)return 0;const o=[A,...i];return o.sort((l,d)=>ni(l.uuid)-ni(d.uuid)),o.findIndex(l=>l.uuid===r)*s}function ih(A,t){const{cellHeight:e}=t,n=Gs();return n?.shouldAnimateNote?.(A)?(n.getVibratoYOffset?.(A.color)??0)*e:0}function oh(A,t,e){const n=Gs(),s=n?.hasReverbEffect;if(!(typeof s=="function"?s(t.color):!!s))return{shouldApply:!1,blur:0,spread:0};const{cellWidth:i}=e,o=n?.getReverbEffect,a=typeof o=="function"?o(t.color):void 0;if(!a)return{shouldApply:!1,blur:0,spread:0};const l=a.blur*(i/2),d=a.spread*(i/3);return{shouldApply:l>0||d>0,blur:l,spread:d}}function ah(A,t,e,n,s,r,i){const o=Gs();if(!o?.hasDelayEffect?.(t.color))return;const{cellWidth:a}=e,l=o.getDelayEffects?.(t.color);!l||l.length===0||l.forEach((d,u)=>{const h=d.delay/500*a*2,m=n+h,f=r*d.scale,g=i*d.scale;A.save(),A.globalAlpha=d.opacity*.6,A.beginPath(),A.ellipse(m,s,f,g,0,0,2*Math.PI),A.strokeStyle=t.color,A.lineWidth=Math.max(.5,f*.1),A.setLineDash([2,2]),A.stroke(),A.restore()})}function lh(A,t,e,n,s,r){const i=Gs();if(!i?.shouldFillNote?.(t))return;const o=i.getFillLevel?.(t)??0;if(o<=0)return;A.save();const a=1-o,l=A.createRadialGradient(e,n,0,e,n,Math.max(s,r));l.addColorStop(0,"transparent"),l.addColorStop(Math.max(0,a-.05),"transparent"),l.addColorStop(a,`${t.color}1F`),l.addColorStop(1,`${t.color}BF`),A.beginPath(),A.ellipse(e,n,s,r,0,0,2*Math.PI),A.clip(),A.fillStyle=l,A.fillRect(e-s-10,n-r-10,(s+10)*2,(r+10)*2),A.restore()}function DB(A,t,e,n,s,r){const i=Gs();if(!i?.shouldFillNote?.(t))return;const o=i.getFillLevel?.(t)??0;if(o<=0)return;A.save(),A.beginPath(),A.arc(e,s,r,Math.PI/2,-Math.PI/2,!1),A.lineTo(n,s-r),A.arc(n,s,r,-Math.PI/2,Math.PI/2,!1),A.lineTo(e,s+r),A.closePath(),A.clip();const a=(e+n)/2,l=n-e,d=Math.max(l/2+r,r),u=1-o,h=A.createRadialGradient(a,s,0,a,s,d);h.addColorStop(0,"transparent"),h.addColorStop(Math.max(0,u-.05),"transparent"),h.addColorStop(u,`${t.color}1F`),h.addColorStop(1,`${t.color}BF`),A.fillStyle=h,A.fillRect(e-r-10,s-r-10,l+(r+10)*2,(r+10)*2),A.restore()}function NB(A,t,e,n,s,r,i,o){if(DB(A,t,n,s,r,i),A.save(),A.beginPath(),A.arc(n,r,i,Math.PI/2,-Math.PI/2,!1),A.lineTo(s,r-i),A.arc(s,r,i,-Math.PI/2,Math.PI/2,!1),A.lineTo(n,r+i),A.closePath(),A.strokeStyle=t.color,A.lineWidth=o,A.shadowColor=t.color,A.shadowBlur=xs,A.stroke(),A.shadowBlur=0,A.shadowColor="transparent",A.restore(),e.degreeDisplayMode!=="off"){const a=(n+s)/2;Cl(A,t,e,a,r,i)}}function RB(A,t,e){const{cellHeight:n}=e,s=n/2*.12,r=A.uuid;if(!r)return 0;const i=t.filter(l=>!l.isDrum&&l.row===A.row&&l.startColumnIndex===A.startColumnIndex&&l.uuid&&l.uuid!==r&&sh(l));if(i.length===0)return 0;const o=[A,...i];return o.sort((l,d)=>ni(l.uuid)-ni(d.uuid)),o.findIndex(l=>l.uuid===r)*s}function kB(A,t){const e=ho.getDegreeForNote(A,t);if(!e)return{label:null,isAccidental:!1};if(!ho.hasAccidental(e))return{label:e,isAccidental:!1};const s=c.state.accidentalMode||{},r=s.sharp??!0,i=s.flat??!0;if(!r&&!i)return{label:null,isAccidental:!0};let o=e.includes(ra)?e:null,a=e.includes(ia)?e:null;const l=ho.getEnharmonicDegree(e);l&&(l.includes(ra)&&!o&&(o=l),l.includes(ia)&&!a&&(a=l));let d=null;if(r&&i){const u=[];o&&u.push(o),a&&(!o||a!==o)&&u.push(a),d=u.join(Ai),d||(d=e)}else r?d=o||e:i&&(d=a||e);return{label:d,isAccidental:!0}}function _B(A){if(!A)return{multiplier:1,category:"natural"};const t=A.includes(ia),e=A.includes(ra),n=A.includes(Ai);return!t&&!e?{multiplier:1,category:"natural"}:n?{multiplier:.75,category:"both-accidentals"}:{multiplier:.88,category:"single-accidental"}}function Cl(A,t,e,n,s,r,i){const{label:o}=kB(t,e);if(!o)return;const{multiplier:a,category:l}=_B(o);let d;if(t.shape==="circle"){const h=r*2*N0;switch(l){case"natural":d=h;break;case"single-accidental":d=h*.8;break;case"both-accidentals":d=h*.4;break;default:d=h*a}}else{const h=r*2*D0;switch(l){case"natural":d=h*1.5;break;case"single-accidental":d=h*1.2;break;case"both-accidentals":d=h;break;default:d=h*a}}const u=d;if(!(u<R0))if(A.fillStyle="#212529",A.font=`bold ${u}px 'Atkinson Hyperlegible', sans-serif`,A.textAlign="center",A.textBaseline="middle",t.shape==="oval"&&l==="both-accidentals"&&o.includes(Ai)){const h=o.split(Ai),m=u*1.1,f=m*(h.length-1),g=s-f/2;h.forEach((p,w)=>{const v=g+w*m,C=u*.08;A.fillText(p.trim(),n,v+C)})}else{const h=u*.08;A.fillText(o,n,s+h)}}function ds(A,t){return Number.isFinite(A)&&A>0&&Number.isFinite(t)&&t>0}function bl(A,t,e,n){const{cellWidth:s,cellHeight:r,modulationMarkers:i}=t,o=ut(n,t),a=ih(e,t),l=o+a,d=Y(e.startColumnIndex,t);let u;if(i&&i.length>0?u=Y(e.startColumnIndex+1,t)-d:u=s,!ds(u,r))return;const h=rh(e,oa(),t),m=d+u+h,f=Math.max(k0,u*_0),g=r/2-f/2,p=sh(e),w=c.state.longNoteStyle||"style1";if(p&&w==="style2"){const F=m,E=Y(e.endColumnIndex,t);if(!ds(E-F,g))return;NB(A,e,t,F,E,l,g,f);return}if(p){const F=Y(e.endColumnIndex+1,t),E=RB(e,oa(),t),b=l+E;A.beginPath(),A.moveTo(m,b),A.lineTo(F,b),A.strokeStyle=e.color,A.lineWidth=Math.max(K0,u*O0),A.stroke()}const v=u-f/2;if(!ds(v,g))return;ah(A,e,t,m,l,v,g),A.save(),lh(A,e,m,l,v,g);const C=oh(A,e,t);C.shouldApply&&(A.shadowColor=e.color,A.shadowBlur=xs+C.blur,A.shadowOffsetX=C.spread),A.beginPath(),A.ellipse(m,l,v,g,0,0,2*Math.PI),A.strokeStyle=e.color,A.lineWidth=f,C.shouldApply||(A.shadowColor=e.color,A.shadowBlur=xs),A.stroke(),A.shadowBlur=0,A.shadowColor="transparent",A.shadowOffsetX=0,A.restore(),t.degreeDisplayMode!=="off"&&Cl(A,e,t,m,l,v)}function yl(A,t,e,n){const{columnWidths:s,cellWidth:r,cellHeight:i,modulationMarkers:o}=t,a=ut(n,t),l=ih(e,t),d=a+l,u=Y(e.startColumnIndex,t);let h;if(o&&o.length>0?h=Y(e.startColumnIndex+1,t)-u:h=((t.musicalColumnWidths&&t.musicalColumnWidths.length>0?t.musicalColumnWidths:s)[e.startColumnIndex]??0)*r,!ds(h,i))return;const m=rh(e,oa(),t),f=Math.max(.5,h*.15),g=u+h/2+m,p=h/2-f/2,w=i/2-f/2;if(!ds(p,w))return;ah(A,e,t,g,d,p,w),A.save(),lh(A,e,g,d,p,w);const v=oh(A,e,t);v.shouldApply&&(A.shadowColor=e.color,A.shadowBlur=xs+v.blur,A.shadowOffsetX=v.spread),A.beginPath(),A.ellipse(g,d,p,w,0,0,2*Math.PI),A.strokeStyle=e.color,A.lineWidth=f,v.shouldApply||(A.shadowColor=e.color,A.shadowBlur=xs),A.stroke(),A.shadowBlur=0,A.shadowColor="transparent",A.shadowOffsetX=0,A.restore(),t.degreeDisplayMode!=="off"&&Cl(A,e,t,g,d,p)}function ch(A,t,e){const{cellWidth:n,cellHeight:s,modulationMarkers:r}=t,i=ut(e.globalRow??e.row,t);let o=e.columnIndex;if(e.uuid){const p=Yt.getColumnMap(c.state).entries.find(w=>w.type==="tonic"&&w.tonicSignUuid===e.uuid&&typeof w.canvasIndex=="number");p&&typeof p.canvasIndex=="number"&&(o=p.canvasIndex)}const a=Y(o,t);let l;r&&r.length>0?l=Y(o+1,t)-a:l=n;const d=l*2,u=a+d/2,h=Math.min(d,s)/2*.9;if(h<2||(A.beginPath(),A.arc(u,i,h,0,2*Math.PI),A.strokeStyle="#212529",A.lineWidth=Math.max(.5,l*.05),A.stroke(),e.tonicNumber==null))return;const m=e.tonicNumber.toString(),f=h*1.5;f<6||(A.fillStyle="#212529",A.font=`bold ${f}px 'Atkinson Hyperlegible', sans-serif`,A.textAlign="center",A.textBaseline="middle",A.fillText(m,u,i))}const aa=[{id:1,diamonds:[0],ovals:[],label:"left 8th"},{id:2,diamonds:[1],ovals:[],label:"e"},{id:3,diamonds:[2],ovals:[],label:"right 8th"},{id:4,diamonds:[3],ovals:[],label:"a"},{id:5,diamonds:[0,1],ovals:[],label:"1 e"},{id:6,diamonds:[1,2],ovals:[],label:"e &"},{id:7,diamonds:[2,3],ovals:[],label:"& a"},{id:8,diamonds:[0,2],ovals:[],label:"two 8ths"},{id:9,diamonds:[1,3],ovals:[],label:"e a"},{id:10,diamonds:[0,1,2],ovals:[],label:"1 e + right 8th"},{id:11,diamonds:[1,2,3],ovals:[],label:"e & a"},{id:12,diamonds:[0,1,3],ovals:[],label:"1 e a"},{id:13,diamonds:[0,2,3],ovals:[],label:"left 8th + & a"},{id:14,diamonds:[0,3],ovals:[],label:"left 8th + a"},{id:15,diamonds:[0,1,2,3],ovals:[],label:"1 e & a"}];function xi(A){return aa.find(t=>t.id===A)}function xc(A,t,e,n){const s=Math.sqrt(3)/2*e,r=Math.max(1,n-2*s),i=t-(r/2+s),o=i+s,a=o+r,l=a+s,d=A-e/2,u=A+e/2;return`M ${[`${A},${i}`,`${d},${o}`,`${d},${a}`,`${A},${l}`,`${u},${a}`,`${u},${o}`].join(" ")} Z`.replace(/,/g," ")}class OB{options;constructor(t={}){this.options={diamondW:30,diamondH:120,ovalRx:30,ovalRy:60,strokeWidth:2,...t}}renderToCanvas(t,e,n,s,r,i,o="#000",a=null,l=null){const d=r/100*.8,u=i/100*.8,h=this.options.diamondW*d,m=this.options.diamondH*u,f=this.options.ovalRx*d,g=this.options.ovalRy*u,p=[.125,.375,.625,.875].map(v=>n+v*r),w=s+i/2;t.save(),t.strokeStyle=o,t.fillStyle=o,t.lineWidth=this.options.strokeWidth,t.lineCap="round",t.lineJoin="round",e.ovals.forEach(v=>{const C=v===0?n+.25*r:n+.75*r;let F=w;if(a&&l){const E=`oval_${v}`,b=a.shapeOffsets?.[E]||0,S=a.row+b;F=l(S)}t.beginPath(),t.ellipse(C,F,f,g,0,0,Math.PI*2),t.stroke()}),e.diamonds.forEach(v=>{const C=p[v];if(C===void 0)return;let F=w;if(a&&l){const S=`diamond_${v}`,y=a.shapeOffsets?.[S]||0,I=a.row+y;F=l(I)}const E=xc(C,F,h,m),b=new Path2D(E);t.stroke(b)}),t.restore()}renderToSVG(t,e=100,n=100){const s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.setAttribute("viewBox",`0 0 ${e} ${n}`),s.style.color="#000000";const r=Math.min(e/100,n/100)*.8,i=this.options.diamondW*r,o=this.options.diamondH*r,a=this.options.ovalRx*r,l=this.options.ovalRy*r,d=[12.5,37.5,62.5,87.5],u=n/2;return t.ovals.forEach(h=>{const m=h===0?25:75,f=document.createElementNS("http://www.w3.org/2000/svg","ellipse");f.setAttribute("cx",String(m)),f.setAttribute("cy",String(u)),f.setAttribute("rx",String(a)),f.setAttribute("ry",String(l)),f.setAttribute("fill","none"),f.setAttribute("stroke","currentColor"),f.setAttribute("stroke-width",String(this.options.strokeWidth*2)),f.setAttribute("stroke-linecap","round"),s.appendChild(f)}),t.diamonds.forEach(h=>{const m=d[h];if(m===void 0)return;const f=xc(m,u,i,o),g=document.createElementNS("http://www.w3.org/2000/svg","path");g.setAttribute("d",f),g.setAttribute("fill","none"),g.setAttribute("stroke","currentColor"),g.setAttribute("stroke-width",String(this.options.strokeWidth*2)),g.setAttribute("stroke-linejoin","round"),g.setAttribute("stroke-linecap","round"),s.appendChild(g)}),s}}const Sl=new OB;B.moduleLoaded("SixteenthStampRenderer","stamps");function KB(A,t){const e=c.getAllSixteenthStampPlacements?.()??c.state?.sixteenthStampPlacements??[];e.length!==0&&(B.debug("SixteenthStampRenderer",`Rendering ${e.length} stamps`,{count:e.length},"stamps"),e.forEach(n=>{GB(A,n,t)}))}function GB(A,t,e){const n=xi(t.sixteenthStampId);if(!n)return;const{startColumn:s,row:r,color:i}=t,o=c.state,a=Y(s,e),d=ut(r,e)-e.cellHeight/2,u=PA(s,o);let h;if(u!==null){const v=u+2;h=pe(v,o)}else h=s+2;const f=Y(h,e)-a,g=e.cellHeight,p=ne(A.canvas);if(a+f<0||a>p)return;const w=v=>ut(v,e);Sl.renderToCanvas(A,n,a,d,f,g,i,t,w),A.save(),A.globalAlpha=.1,A.fillStyle=i,A.fillRect(a+1,d+1,f-2,g-2),A.restore(),B.debug("SixteenthStampRenderer",`Rendered stamp ${t.sixteenthStampId} at ${s}-${h},${r}`,{sixteenthStampId:t.sixteenthStampId,startColumn:s,effectiveEndColumn:h,row:r,stampX:a,stampY:d,hasOffsets:!!t.shapeOffsets},"stamps")}function WB(A,t,e,n,s){if(!n)return;const r=c.state,i=Y(t,s),a=ut(e,s)-s.cellHeight/2,l=PA(t,r);let d;if(l!==null){const f=l+2;d=pe(f,r)}else d=t+2;const h=Y(d,s)-i,m=s.cellHeight;A.save(),A.globalAlpha=.6,Sl.renderToCanvas(A,n,i,a,h,m,s.previewColor||"#4a90e2"),A.restore()}function Uc(A,t,e){return[{id:t+0,span:A,hits:[0],label:`${e} [1]`},{id:t+1,span:A,hits:[1],label:`${e} [2]`},{id:t+2,span:A,hits:[2],label:`${e} [3]`},{id:t+3,span:A,hits:[0,1],label:`${e} [1 2]`},{id:t+4,span:A,hits:[1,2],label:`${e} [2 3]`},{id:t+5,span:A,hits:[0,2],label:`${e} [1 3]`},{id:t+6,span:A,hits:[0,1,2],label:`${e} [1 2 3]`}]}const Dr=[...Uc("eighth",1,"8th triplet"),...Uc("quarter",8,"Quarter triplet")],dh={eighth:1,quarter:2},uh=[16.6667,50,83.3333];function Ui(A){return Dr.find(t=>t.id===A)}B.moduleLoaded("TripletStampRenderer","triplets");function VB(A,t){const e=c.getAllTripletStampPlacements?.()??c.state?.tripletStampPlacements??[];e.length!==0&&(B.debug("TripletStampRenderer",`Rendering ${e.length} triplet groups`,{count:e.length},"triplets"),e.forEach(n=>{zB(A,n,t)}))}function zB(A,t,e){const n=Ui(t.tripletStampId);if(!n)return;const{startTimeIndex:s,span:r,row:i,color:o}=t,a=r*2,l=pe(s,c.state),d=l+a,u=Y(l,e),h=ut(i,e),m=h-e.cellHeight/2,g=Y(d,e)-u,p=e.cellHeight,w=ne(A.canvas);if(u+g<0||u>w)return;hh(A,n,u,h,g,p,o,t,C=>ut(C,e)),A.save(),A.globalAlpha=.1,A.fillStyle=o,A.fillRect(u+1,m+1,g-2,p-2),A.restore()}function hh(A,t,e,n,s,r,i,o=null,a=null){const l=s/100*.8,d=r/100*.8,u=Math.max(1,3*d);t.hits.forEach(h=>{const m=uh[h]??50,f=e+s*m/100;let g=n;if(o&&a){const p=`triplet_${h}`,w=o.shapeOffsets?.[p]||0,v=o.row+w;g=a(v),w!==0&&B.debug("TripletStampRenderer","Drawing notehead with offset",{slot:h,shapeKey:p,rowOffset:w,baseRow:o.row,shapeRow:v,y:g},"triplets")}qB(A,f,g,i,u,l,d)})}function qB(A,t,e,n="currentColor",s=4,r=1,i=1){const o=20*r,a=60*i;A.strokeStyle=n,A.lineWidth=s,A.fillStyle="none",A.beginPath(),A.ellipse(t,e,o,a,0,0,2*Math.PI),A.stroke()}function XB(A,t,e,n,s){if(!n)return;const i=(n.span==="eighth"?1:2)*2,o=pe(t,c.state),a=Y(o,s),l=ut(e,s),d=o+i,h=Y(d,s)-a,m=s.cellHeight;A.save(),A.globalAlpha=.6;const f=s.previewColor||"#4a90e2";hh(A,n,a,l,h,m,f),A.restore()}function $B(A,t){if(A===0)return Y(0,t);const e=A-1,n=ge(c.state,e);return n?Y(n.endColumn+1,t):(B.warn("ModulationRenderer","Could not find measure info for index",{measureIndex:A},"grid"),A*200)}function fh(A,t){const{modulationMarkers:e}=t;if(!e||e.length===0)return;const n=e.filter(r=>r.active).map(r=>{let i;if(r.columnIndex!==null&&r.columnIndex!==void 0)i=Y(r.columnIndex+1,t);else if(r.macrobeatIndex!==null&&r.macrobeatIndex!==void 0&&r.macrobeatIndex>=0){const o=ge(c.state,r.macrobeatIndex);o?i=Y(o.endColumn+1,t):(B.warn("ModulationRenderer","Could not find macrobeat info for index",{macrobeatIndex:r.macrobeatIndex},"grid"),i=r.xPosition??0)}else r.measureIndex!==null&&r.measureIndex!==void 0?i=$B(r.measureIndex,t):i=r.xPosition??0;return{...r,xCanvas:i}});A.save();const s=t.showModulationLabel!==!1;n.forEach(r=>{YB(A,r,s)}),A.restore()}function YB(A,t,e){const n=t.xCanvas,s=t.ratio,r=Gu(s),i=Ku(s);JB(A,n,r),e&&jB(A,n,i,r)}function JB(A,t,e){const s=Mt(A.canvas);A.beginPath(),A.moveTo(t,0),A.lineTo(t,s),A.lineWidth=3,A.strokeStyle=e,A.setLineDash([]),A.stroke()}function jB(A,t,e,n){const r="Arial, sans-serif";A.font=`14px ${r}`,A.textAlign="center",A.textBaseline="middle";const d=A.measureText(e).width,u=14,h=d+12,m=u+12,f=t-h/2,g=20;ZB(A,f,g,h,m,8,n),A.fillStyle="#212529",A.fillText(e,t,g+m/2)}function ZB(A,t,e,n,s,r,i){A.beginPath(),A.moveTo(t+r,e),A.lineTo(t+n-r,e),A.quadraticCurveTo(t+n,e,t+n,e+r),A.lineTo(t+n,e+s-r),A.quadraticCurveTo(t+n,e+s,t+n-r,e+s),A.lineTo(t+r,e+s),A.quadraticCurveTo(t,e+s,t,e+s-r),A.lineTo(t,e+r),A.quadraticCurveTo(t,e,t+r,e),A.closePath(),A.fillStyle=i,A.fill(),A.strokeStyle="rgba(0, 0, 0, 0.2)",A.lineWidth=1,A.stroke()}function Mc(A,t,e){const{xCanvas:n}=e,s=6,r=40;return Math.abs(A-n)<=s/2?t<=r?{marker:e,type:"label",canDrag:!1}:{marker:e,type:"barline",canDrag:!0}:null}function Tc(A){if(!A)return"default";switch(A.type){case"label":return"pointer";case"barline":return A.canDrag?"ew-resize":"pointer";default:return"default"}}function De(A){return A.x??A.col??0}function Ne(A){return A.y??A.row??0}function Ts(A,t){if(!t||t.length<3)return!1;const e=De(A),n=Ne(A);let s=!1;for(let r=0,i=t.length-1;r<t.length;i=r++){const o=De(t[r]),a=Ne(t[r]),l=De(t[i]),d=Ne(t[i]);a>n!=d>n&&e<(l-o)*(n-a)/(d-a)+o&&(s=!s)}return s}function tw(A){if(!A||A.length<3)return A;const t=A.map(r=>({x:De(r),y:Ne(r)}));if(t.length===0)return[];let e=t[0];for(let r=1;r<t.length;r++){const i=t[r];(i.y<e.y||i.y===e.y&&i.x<e.x)&&(e=i)}const n=t.filter(r=>r!==e);if(n.sort((r,i)=>{const o=Math.atan2(r.y-e.y,r.x-e.x),a=Math.atan2(i.y-e.y,i.x-e.x);if(o!==a)return o-a;const l=Math.hypot(r.x-e.x,r.y-e.y),d=Math.hypot(i.x-e.x,i.y-e.y);return l-d}),n.length===0)return[e];const s=[e,n[0]];for(let r=1;r<n.length;r++){const i=n[r];for(;s.length>1&&!ew(s[s.length-2],s[s.length-1],i);)s.pop();s.push(i)}return s}function ew(A,t,e){const n=De(A),s=Ne(A),r=De(t),i=Ne(t),o=De(e),a=Ne(e);return(r-n)*(a-s)-(i-s)*(o-n)>0}function Aw(A,t,e,n=10){const s=De(A),r=Ne(A),i=De(t),o=Ne(t),a=De(e),l=Ne(e),d=a-i,u=l-o,h=d*d+u*u;if(h===0)return Math.hypot(s-i,r-o)<=n;let m=((s-i)*d+(r-o)*u)/h;m=Math.max(0,Math.min(1,m));const f=i+m*d,g=o+m*u;return Math.hypot(s-f,r-g)<=n}function Pc(A,t,e=10){if(!t||t.length<2)return!1;for(let n=0;n<t.length;n++){const s=t[n],r=t[(n+1)%t.length];if(Aw(A,s,r,e))return!0}return!1}function nw(A,t){const{centerX:e,centerY:n,rx:s,ry:r}=t,i=16;for(let o=0;o<i;o++){const a=o/i*2*Math.PI,l=e+s*Math.cos(a),d=n+r*Math.sin(a);if(Ts({x:l,y:d},A))return!0}return!!Ts({x:e,y:n},A)}function Lc(A,t){const{x:e,y:n,width:s,height:r}=t,i=[{x:e,y:n},{x:e+s,y:n},{x:e+s,y:n+r},{x:e,y:n+r}];for(const o of i)if(Ts(o,A))return!0;for(const o of A){const a=De(o),l=Ne(o);if(a>=e&&a<=e+s&&l>=n&&l<=n+r)return!0}return!1}function gh(A,t,e,n,s,r){const i=s-e,o=r-n,a=i*i+o*o;if(a===0){const f=A-e,g=t-n;return Math.sqrt(f*f+g*g)}let l=((A-e)*i+(t-n)*o)/a;l=Math.max(0,Math.min(1,l));const d=e+l*i,u=n+l*o,h=A-d,m=t-u;return Math.sqrt(h*h+m*m)}function sw(A){const{x:t,y:e,annotations:n,getRenderOptions:s}=A,r=10;let i=!1;const o=s();return{nextAnnotations:n.filter(l=>{let d=!0;if(l.type==="arrow"){const u=Y(l.startCol,o),h=ut(l.startRow,o),m=Y(l.endCol,o),f=ut(l.endRow,o);gh(t,e,u,h,m,f)<r&&(d=!1,i=!0)}else if(l.type==="text"){const u=Y(l.col,o),h=ut(l.row,o),m=Y(l.col+l.widthCols,o),f=ut(l.row+l.heightRows,o);t>=u&&t<=m&&e>=h&&e<=f&&(d=!1,i=!0)}else if(l.type==="marker"||l.type==="highlighter")for(let u=0;u<l.path.length;u++){const h=Y(l.path[u].col,o),m=ut(l.path[u].row,o),f=t-h,g=e-m;if(Math.sqrt(f*f+g*g)<r){d=!1,i=!0;break}}return d}),changed:i}}function rw(A){const{lassoPath:t,state:e,renderOptions:n,isAdditive:s,existingSelectedItems:r}=A,i=[];s&&Array.isArray(r)&&i.push(...r),e.placedNotes.forEach((a,l)=>{if(a.isDrum)return;const d=a.startColumnIndex,u=Y(d,n),h=ut(a.row,n),{cellWidth:m,cellHeight:f}=n;let g=m;n.modulationMarkers&&n.modulationMarkers.length>0&&(g=Y(d+1,n)-u);const p=a.shape==="oval"?u+g:u+g/2,w=h,v=a.shape==="oval"?g:g/2,C=f/2;if(nw(t,{centerX:p,centerY:w,rx:v,ry:C})){const F=`note-${a.row}-${d}-${a.color}-${a.shape}`;i.find(E=>E.id===F)||i.push({type:"note",id:F,data:a,index:l})}}),e.sixteenthStampPlacements.forEach((a,l)=>{const{cellWidth:d,cellHeight:u}=n,h=Y(a.startColumn,n),m=ut(a.row,n)-u/2,f=d*2;if(Lc(t,{x:h,y:m,width:f,height:u})){const p=`sixteenth-stamp-${a.row}-${a.startColumn}-${a.sixteenthStampId}`;i.find(w=>w.id===p)||i.push({type:"sixteenthStamp",id:p,data:a,index:l})}}),e.tripletStampPlacements.forEach((a,l)=>{const{cellHeight:d}=n,u=pe(a.startTimeIndex,e),h=u+a.span*2,m=Y(u,n),f=Y(h,n)-m,g=ut(a.row,n)-d/2;if(Lc(t,{x:m,y:g,width:f,height:d})){const w=`triplet-stamp-${a.row}-${u}-${a.tripletStampId}`;i.find(v=>v.id===w)||i.push({type:"tripletStamp",id:w,data:a,index:l})}});const o=Ps({selectedItems:i,renderOptions:n,state:e});return{selectedItems:i,convexHull:o,isActive:i.length>0}}function Ps(A){const{selectedItems:t,renderOptions:e,state:n}=A;if(!t.length)return null;const s=n??c.state,r=t.map(i=>{const o=i.type==="note"?i.data.startColumnIndex:i.type==="sixteenthStamp"?i.data.startColumn:pe(i.data.startTimeIndex,s),a=Y(o,e),l=ut(i.data.row,e);return{x:a,y:l}});return tw(r)}function iw(A){const{canvasX:t,canvasY:e,state:n,renderOptions:s,selection:r}=A;if(!r?.isActive)return null;const i=A.thresholdPx??15;let o=null;if(n.placedNotes.forEach(d=>{const u=d.startColumnIndex,h=Y(u,s),m=ut(d.row,s);Math.hypot(t-h,e-m)<=i&&(o=`note-${d.row}-${u}-${d.color}-${d.shape}`)}),o||n.sixteenthStampPlacements.forEach(d=>{const u=d.startColumn+1,h=Y(u,s),m=ut(d.row,s);Math.hypot(t-h,e-m)<=i&&(o=`sixteenth-stamp-${d.row}-${d.startColumn}-${d.sixteenthStampId}`)}),o||n.tripletStampPlacements.forEach(d=>{const u=pe(d.startTimeIndex,n),h=u+d.span,m=Y(h,s),f=ut(d.row,s);Math.hypot(t-m,e-f)<=i&&(o=`triplet-stamp-${d.row}-${u}-${d.tripletStampId}`)}),!o)return null;const a=r.selectedItems.filter(d=>d.id!==o),l=Ps({selectedItems:a,renderOptions:s});return{nextSelection:{selectedItems:a,convexHull:l,isActive:a.length>0},changed:!0}}function ow(A){const{selection:t,selectionDragStart:e,selectionDragTotal:n,currentPointerGrid:s,initialDragStartRank:r,currentStartRank:i,renderOptions:o}=A,a=r!==null?i-r:0,l=s.row-a,d=Math.round(s.col-e.col),u=Math.round(l-e.row),h={col:d-n.col,row:u-n.row};if(h.col===0&&h.row===0)return{moved:!1,nextSelectionDragTotal:n,nextConvexHull:t.convexHull};const m=(w,v)=>typeof v=="number"?v:w,f=(w,v)=>{const C=c.state.columnWidths?.length??0;let F=w;for(;F>=0&&F<C;){const E=PA(F,c.state);if(E!==null)return E;F+=v}return null};t.selectedItems.forEach(w=>{if(w.type==="note"){const C=m(w.data.row,w.data.globalRow)+h.row;w.data.globalRow=C,w.data.row=C,w.data.startColumnIndex=w.data.startColumnIndex+h.col,w.data.endColumnIndex=w.data.endColumnIndex+h.col}else if(w.type==="sixteenthStamp"){const C=m(w.data.row,w.data.globalRow)+h.row;w.data.globalRow=C,w.data.row=C,w.data.startColumn=w.data.startColumn+h.col,w.data.endColumn=w.data.endColumn+h.col}else if(w.type==="tripletStamp"){const C=m(w.data.row,w.data.globalRow)+h.row;if(w.data.globalRow=C,w.data.row=C,h.col!==0){const E=pe(w.data.startTimeIndex,c.state)+h.col,b=Math.sign(h.col)||1,S=f(E,b);S!==null&&(w.data.startTimeIndex=S)}}});const g={col:d,row:u},p=Ps({selectedItems:t.selectedItems,renderOptions:o,state:c.state});return t.convexHull=p,{moved:!0,nextSelectionDragTotal:g,nextConvexHull:p}}function aw(A){const{ctx:t,annotation:e,isTemp:n=!1,isSelected:s=!1,isHovered:r=!1,getStrokeWidth:i,getLineDash:o}=A,{startX:a,startY:l,endX:d,endY:u,settings:h}=e;t.save(),s&&(t.strokeStyle="#4a90e2",t.lineWidth=i(h.strokeWeight)+4,t.globalAlpha=.3,t.setLineDash([]),t.beginPath(),t.moveTo(a,l),t.lineTo(d,u),t.stroke(),t.globalAlpha=1),r&&!s&&(t.strokeStyle="#4a90e2",t.lineWidth=i(h.strokeWeight)+4,t.globalAlpha=.15,t.setLineDash([]),t.beginPath(),t.moveTo(a,l),t.lineTo(d,u),t.stroke(),t.globalAlpha=1),t.strokeStyle=n?"rgba(0, 0, 0, 0.5)":"#000000",t.lineWidth=i(h.strokeWeight),t.setLineDash(o(h.lineStyle));const m=Math.atan2(u-l,d-a),f=h.arrowheadSize||12;let g=a,p=l,w=d,v=u;h.startArrowhead!=="none"&&(g=a+Math.cos(m)*f,p=l+Math.sin(m)*f),h.endArrowhead!=="none"&&(w=d-Math.cos(m)*f,v=u-Math.sin(m)*f),t.beginPath(),t.moveTo(g,p),t.lineTo(w,v),t.stroke(),h.startArrowhead!=="none"&&Hc({ctx:t,x:a,y:l,angle:m+Math.PI,type:h.startArrowhead,size:f}),h.endArrowhead!=="none"&&Hc({ctx:t,x:d,y:u,angle:m,type:h.endArrowhead,size:f}),t.restore()}function Hc(A){const{ctx:t,x:e,y:n,angle:s,type:r,size:i}=A;switch(t.save(),t.translate(e,n),t.rotate(s),t.setLineDash([]),r){case"filled":case"filled-arrow":t.beginPath(),t.moveTo(0,0),t.lineTo(-i,-i/2),t.lineTo(-i,i/2),t.closePath(),t.fillStyle=t.strokeStyle,t.fill();break;case"unfilled":case"unfilled-arrow":t.beginPath(),t.moveTo(0,0),t.lineTo(-i,-i/2),t.lineTo(-i,i/2),t.closePath(),t.stroke();break;case"circle":t.beginPath(),t.arc(0,0,i/3,0,Math.PI*2),t.fillStyle=t.strokeStyle,t.fill();break}t.restore()}B.moduleLoaded("AnnotationService","annotation");class lw{canvas;ctx;currentTool;toolSettings;tempEraserMode;isDrawing;currentPath;startPoint;tempAnnotation;selectedAnnotation;hoverAnnotation;eraserCursor;isDragging;dragOffset;isResizing;resizeHandle;resizeStartBounds;isDraggingSelection;selectionDragStart;selectionDragTotal;lastPointerPosition;initialDragStartRank;constructor(){this.toolSettings=null,this.tempEraserMode=!1,this.currentTool=null,this.isDrawing=!1,this.currentPath=[],this.startPoint=null,this.tempAnnotation=null,this.selectedAnnotation=null,this.hoverAnnotation=null,this.eraserCursor=null,this.isDragging=!1,this.dragOffset=null,this.isResizing=!1,this.resizeHandle=null,this.resizeStartBounds=null,this.isDraggingSelection=!1,this.selectionDragStart=null,this.selectionDragTotal=null,this.lastPointerPosition=null,this.initialDragStartRank=null}initialize(){const t=document.getElementById("notation-grid");if(!(t instanceof HTMLCanvasElement)){B.error("AnnotationService","Pitch grid canvas not found",null,"annotation");return}const e=t.getContext("2d");if(!e){B.error("AnnotationService","Pitch grid context not available",null,"annotation");return}this.canvas=t,this.ctx=e,this.setupEventListeners(),c.on("annotationsChanged",()=>{this.selectedAnnotation=null,this.render()}),c.on("scrollByUnits",n=>{typeof n=="number"&&this.handleSelectionScroll(n)}),B.initSuccess("AnnotationService")}setupEventListeners(){this.canvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this.handleMouseMove.bind(this)),this.canvas.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvas.addEventListener("mouseleave",this.handleMouseLeave.bind(this)),this.canvas.addEventListener("dblclick",this.handleDoubleClick.bind(this)),this.canvas.addEventListener("wheel",this.handleWheel.bind(this),{passive:!0}),this.canvas.addEventListener("contextmenu",t=>t.preventDefault()),this.registerScrollSyncTarget(document.getElementById("pitch-grid-wrapper")),this.registerScrollSyncTarget(document.getElementById("canvas-container")),window.addEventListener("scroll",this.handleScroll.bind(this),{passive:!0}),window.addEventListener("wheel",this.handleWheel.bind(this),{passive:!0}),document.addEventListener("keydown",this.handleKeyDown.bind(this))}handleKeyDown(t){if(!this.selectedAnnotation)return;const e=document.activeElement;if(e instanceof HTMLElement){const n=e.isContentEditable,s=e.tagName.toLowerCase();if(["input","textarea"].includes(s)||n)return}(t.key==="Delete"||t.key==="Backspace")&&(t.preventDefault(),this.deleteSelectedAnnotation())}deleteSelectedAnnotation(){if(!this.selectedAnnotation)return;const t=c.state.annotations.indexOf(this.selectedAnnotation);t>-1&&(c.state.annotations.splice(t,1),this.selectedAnnotation=null,c.recordState(),this.render(),B.log("AnnotationService","Deleted annotation","annotation"))}resize(){const t=document.getElementById("notation-grid");t instanceof HTMLCanvasElement&&(this.canvas.width=t.width,this.canvas.height=t.height,this.render())}getRenderOptions(){return{columnWidths:c.state.columnWidths,cellWidth:c.state.cellWidth,cellHeight:c.state.cellHeight,modulationMarkers:c.state.modulationMarkers,baseMicrobeatPx:c.state.cellWidth}}canvasToGrid(t,e){const n=this.getRenderOptions();return{col:na(t,n),row:mB(e,n)}}canvasToGridFresh(t,e){const n=this.getRenderOptions(),s=ae.getViewportInfo(),r=n.cellHeight/2;return{col:na(t,n),row:e/r+s.startRank-1}}gridToCanvas(t,e){const n=this.getRenderOptions();return{x:Y(t,n),y:ut(e,n)}}setTool(t,e){if(this.currentTool=t,this.toolSettings=e,this.canvas)switch(t){case"arrow":case"text":this.canvas.style.cursor="crosshair";break;case"marker":case"highlighter":this.canvas.style.cursor=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16'><circle cx='8' cy='8' r='4' fill='rgba(0,0,0,0.5)'/></svg>") 8 8, crosshair`;break;case"lasso":this.canvas.style.cursor="crosshair";break;default:this.canvas.style.cursor="default"}}handleMouseDown(t){if(!this.currentTool||!this.toolSettings)return;const e=this.canvas.getBoundingClientRect(),n=t.clientX-e.left,s=t.clientY-e.top;this.lastPointerPosition={clientX:t.clientX,clientY:t.clientY};const r=this.canvasToGridFresh(n,s);if(t.button===2){if(this.currentTool==="lasso"&&c.state.lassoSelection?.isActive){this.removeFromLassoSelection(n,s);return}this.tempEraserMode=!0,this.isDrawing=!0,this.eraseAtPoint(n,s),this.showEraserCursor(n,s);return}if(this.selectedAnnotation?.type==="text"){const o=this.getResizeHandleAt(n,s,this.selectedAnnotation);if(o){this.isResizing=!0,this.resizeHandle=o,this.resizeStartBounds={col:this.selectedAnnotation.col,row:this.selectedAnnotation.row,widthCols:this.selectedAnnotation.widthCols,heightRows:this.selectedAnnotation.heightRows,mouseCol:r.col,mouseRow:r.row};return}}if(c.state.lassoSelection?.isActive&&c.state.lassoSelection.convexHull){const o=Pc({x:n,y:s},c.state.lassoSelection.convexHull,10),a=Ts({x:n,y:s},c.state.lassoSelection.convexHull);if(o||a){this.isDraggingSelection=!0,this.selectionDragStart={col:r.col,row:r.row},this.selectionDragTotal={col:0,row:0},this.lastPointerPosition={clientX:t.clientX,clientY:t.clientY},this.initialDragStartRank=ae.getViewportInfo().startRank;return}}const i=this.getAnnotationAt(n,s);if(i&&(i.type==="arrow"||i.type==="text")){if(this.selectedAnnotation===i){this.isDragging=!0,i.type==="arrow"?this.dragOffset={startCol:r.col-i.startCol,startRow:r.row-i.startRow,endCol:r.col-i.endCol,endRow:r.row-i.endRow}:i.type==="text"&&(this.dragOffset={col:r.col-i.col,row:r.row-i.row});return}if(this.currentTool==="text"&&i.type==="text"){this.editTextAnnotation(i);return}this.selectedAnnotation=i,this.loadAnnotationSettings(i),this.render();return}else this.selectedAnnotation=null;switch(this.isDrawing=!0,this.startPoint=r,this.currentPath=[r],this.currentTool){case"arrow":this.tempAnnotation={type:"arrow",startCol:r.col,startRow:r.row,endCol:r.col,endRow:r.row,settings:{...this.toolSettings.arrow}};break;case"text":this.tempAnnotation={type:"text",startCol:r.col,startRow:r.row,endCol:r.col,endRow:r.row};break;case"marker":case"highlighter":this.tempAnnotation={type:this.currentTool,path:[r],settings:{...this.toolSettings[this.currentTool]}};break;case"lasso":this.tempAnnotation={type:"lasso",path:[{x:n,y:s}]};break}}handleMouseMove(t){const e=this.canvas.getBoundingClientRect(),n=t.clientX-e.left,s=t.clientY-e.top;this.lastPointerPosition={clientX:t.clientX,clientY:t.clientY};const r=this.canvasToGridFresh(n,s);if(this.tempEraserMode){this.eraseAtPoint(n,s),this.showEraserCursor(n,s);return}if(this.isResizing&&this.selectedAnnotation?.type==="text"){if(!this.resizeHandle||!this.resizeStartBounds)return;const i=r.col-this.resizeStartBounds.mouseCol,o=r.row-this.resizeStartBounds.mouseRow;let a=this.resizeStartBounds.col,l=this.resizeStartBounds.row,d=this.resizeStartBounds.widthCols,u=this.resizeStartBounds.heightRows;this.resizeHandle.includes("n")&&(l=this.resizeStartBounds.row+o,u=this.resizeStartBounds.heightRows-o),this.resizeHandle.includes("s")&&(u=this.resizeStartBounds.heightRows+o),this.resizeHandle.includes("w")&&(a=this.resizeStartBounds.col+i,d=this.resizeStartBounds.widthCols-i),this.resizeHandle.includes("e")&&(d=this.resizeStartBounds.widthCols+i);const h=2,m=1;d<h&&(this.resizeHandle.includes("w")&&(a=this.resizeStartBounds.col+this.resizeStartBounds.widthCols-h),d=h),u<m&&(this.resizeHandle.includes("n")&&(l=this.resizeStartBounds.row+this.resizeStartBounds.heightRows-m),u=m),this.selectedAnnotation.col=a,this.selectedAnnotation.row=l,this.selectedAnnotation.widthCols=d,this.selectedAnnotation.heightRows=u,this.render();return}if(this.isDraggingSelection&&this.selectionDragStart&&this.selectionDragTotal){this.applySelectionDrag(n,s);return}if(this.isDragging&&this.selectedAnnotation){this.selectedAnnotation.type==="arrow"?(this.selectedAnnotation.startCol=r.col-this.dragOffset.startCol,this.selectedAnnotation.startRow=r.row-this.dragOffset.startRow,this.selectedAnnotation.endCol=r.col-this.dragOffset.endCol,this.selectedAnnotation.endRow=r.row-this.dragOffset.endRow):this.selectedAnnotation.type==="text"&&(this.selectedAnnotation.col=r.col-this.dragOffset.col,this.selectedAnnotation.row=r.row-this.dragOffset.row),this.render();return}if(!this.isDrawing){this.updateHover(n,s);return}if(this.tempAnnotation)switch(this.currentTool){case"arrow":this.tempAnnotation.endCol=r.col,this.tempAnnotation.endRow=r.row,this.render();break;case"text":this.tempAnnotation.endCol=r.col,this.tempAnnotation.endRow=r.row,this.render();break;case"marker":case"highlighter":if(this.tempAnnotation.path.length>0){const i=this.tempAnnotation.path[this.tempAnnotation.path.length-1],o=this.interpolatePoints(i,r);this.tempAnnotation.path.push(...o)}else this.tempAnnotation.path.push(r);this.render();break;case"lasso":this.tempAnnotation.path.push({x:n,y:s}),this.render();break}}handleMouseUp(t){if(this.isResizing){this.isResizing=!1,this.resizeHandle=null,this.resizeStartBounds=null,c.recordState();return}if(this.isDraggingSelection){this.isDraggingSelection=!1,this.selectionDragStart=null,this.selectionDragTotal=null,this.lastPointerPosition=null,this.initialDragStartRank=null,c.recordState();return}if(this.isDragging){this.isDragging=!1,this.dragOffset=null,c.recordState();return}if(this.isDrawing){if(this.isDrawing=!1,this.tempEraserMode){this.tempEraserMode=!1,this.render();return}if(this.tempAnnotation){if(this.currentTool==="text"){const{startCol:e,startRow:n,endCol:s,endRow:r}=this.tempAnnotation,i=Math.abs(s-e),o=Math.abs(r-n),a=Math.min(e,s),l=Math.min(n,r);i>.5&&o>.2?this.createTextAnnotation(a,l,i,o):this.createTextAnnotation(e,n,8,2),this.tempAnnotation=null,this.render();return}this.currentTool==="lasso"?this.handleLassoSelection(t.shiftKey):(c.state.annotations.push(this.tempAnnotation),this.currentTool==="arrow"&&(this.selectedAnnotation=this.tempAnnotation),c.recordState()),this.tempAnnotation=null,this.render()}}}handleWheel(t){!this.isDraggingSelection||!this.selectionDragStart||!this.selectionDragTotal||((t.clientX!==0||t.clientY!==0)&&(this.lastPointerPosition={clientX:t.clientX,clientY:t.clientY}),requestAnimationFrame(()=>this.applySelectionDragFromLastPointer()))}handleScroll(){!this.isDraggingSelection||!this.selectionDragStart||!this.selectionDragTotal||requestAnimationFrame(()=>this.applySelectionDragFromLastPointer())}applySelectionDragFromLastPointer(){if(!this.canvas||!this.lastPointerPosition)return;const t=this.canvas.getBoundingClientRect(),e=this.lastPointerPosition.clientX-t.left,n=this.lastPointerPosition.clientY-t.top;this.applySelectionDrag(e,n)}registerScrollSyncTarget(t){t&&(t.addEventListener("wheel",this.handleWheel.bind(this),{passive:!0}),t.addEventListener("scroll",this.handleScroll.bind(this),{passive:!0}))}applySelectionDrag(t,e){if(!this.isDraggingSelection||!this.selectionDragStart||!this.selectionDragTotal)return;const n=this.getRenderOptions(),r=ae.getViewportInfo().startRank,i=this.canvasToGridFresh(t,e),{moved:o,nextSelectionDragTotal:a}=ow({selection:c.state.lassoSelection,selectionDragStart:this.selectionDragStart,selectionDragTotal:this.selectionDragTotal,currentPointerGrid:i,initialDragStartRank:this.initialDragStartRank,currentStartRank:r,renderOptions:n});o&&(this.selectionDragTotal.col=a.col,this.selectionDragTotal.row=a.row,this.render())}handleSelectionScroll(t){if(!c.state.lassoSelection?.isActive||this.isDraggingSelection)return;const e=this.getRenderOptions();c.state.lassoSelection.convexHull=Ps({selectedItems:c.state.lassoSelection.selectedItems,renderOptions:e}),this.render()}handleMouseLeave(t){this.isDrawing&&this.handleMouseUp(t)}handleDoubleClick(t){const e=this.canvas.getBoundingClientRect(),n=t.clientX-e.left,s=t.clientY-e.top,r=this.getAnnotationAt(n,s);r?.type==="text"&&this.editTextAnnotation(r)}editTextAnnotation(t){const{col:e,row:n,widthCols:s,heightRows:r,text:i,settings:o}=t,a=c.state.annotations.indexOf(t);a>-1&&(c.state.annotations.splice(a,1),this.selectedAnnotation=null,this.render()),this.createTextAnnotation(e,n,s,r,i,o)}createTextAnnotation(t,e,n,s,r=null,i=null){this.isDrawing=!1;const o=this.gridToCanvas(t,e),a=this.gridToCanvas(t+n,e+s),l=o.x,d=o.y,u=a.x-l,h=a.y-d,f=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',g=i||this.toolSettings.text,p=document.createElement("div");p.contentEditable="true",p.className="annotation-text-input",p.textContent=r||"Type here...";const w=g.size,v=w*1.2;p.style.width=`${u}px`,p.style.height=`${h}px`,p.style.padding=g.background?"4px 8px":"4px",p.style.border="2px dashed rgba(74, 144, 226, 0.5)",p.style.backgroundColor=g.background?"#ffffff":"transparent",p.style.color=g.color,p.style.fontSize=`${w}px`,p.style.lineHeight=`${v}px`,p.style.fontWeight=g.bold?"bold":"normal",p.style.fontStyle=g.italic?"italic":"normal",p.style.textDecoration=g.underline?"underline":"none",g.superscript?(p.style.fontSize=`${w*.6}px`,p.style.verticalAlign="super"):g.subscript&&(p.style.fontSize=`${w*.6}px`,p.style.verticalAlign="sub"),p.style.outline="none",p.style.zIndex="10000",p.style.position="fixed",p.style.cursor="text",p.style.pointerEvents="auto",p.style.fontFamily=f,p.style.whiteSpace="pre-wrap",p.style.wordWrap="break-word",p.style.overflow="hidden",p.style.boxSizing="border-box";const C=this.canvas.getBoundingClientRect();p.style.left=`${C.left+l}px`,p.style.top=`${C.top+d}px`,document.body.appendChild(p),p.focus();const F=document.createRange();F.selectNodeContents(p);const E=window.getSelection();E&&(E.removeAllRanges(),E.addRange(F));let b=!1;const S=()=>{if(b)return;b=!0;const I=p.textContent.trim();if(I&&I!=="Type here..."){const Q={type:"text",col:t,row:e,widthCols:n,heightRows:s,text:I,settings:{...g}};c.state.annotations.push(Q),this.selectedAnnotation=c.state.annotations[c.state.annotations.length-1],c.recordState(),this.render()}document.body.contains(p)&&document.body.removeChild(p)};let y=!1;p.addEventListener("input",()=>{!y&&p.textContent==="Type here..."&&(p.textContent="",y=!0)}),setTimeout(()=>{p.addEventListener("blur",S)},100),p.addEventListener("keydown",I=>{I.key==="Enter"&&!I.shiftKey&&(I.preventDefault(),S()),I.key==="Escape"&&(b=!0,document.body.contains(p)&&document.body.removeChild(p))})}handleLassoSelection(t=!1){if(!this.tempAnnotation?.path)return;const e=this.getRenderOptions();c.state.lassoSelection=rw({lassoPath:this.tempAnnotation.path,state:c.state,renderOptions:e,isAdditive:t,existingSelectedItems:c.state.lassoSelection?.selectedItems}),c.recordState(),B.log("AnnotationService",`Lasso selection completed: ${c.state.lassoSelection.selectedItems.length} items selected`,"annotation"),this.render()}updateLassoConvexHull(){if(!c.state.lassoSelection?.isActive||!c.state.lassoSelection.selectedItems?.length)return;const t=this.getRenderOptions();c.state.lassoSelection.convexHull=Ps({selectedItems:c.state.lassoSelection.selectedItems,renderOptions:t})}removeFromLassoSelection(t,e){if(!c.state.lassoSelection?.isActive)return;const n=this.getRenderOptions(),s=iw({canvasX:t,canvasY:e,state:c.state,renderOptions:n,selection:c.state.lassoSelection});s?.changed&&(c.state.lassoSelection=s.nextSelection,c.recordState(),this.render(),B.log("AnnotationService",`Removed item from lasso selection. ${s.nextSelection.selectedItems.length} items remain.`,"annotation"))}drawTempAnnotation(){if(this.tempAnnotation)switch(this.tempAnnotation.type){case"arrow":this.drawArrow(this.tempAnnotation,!0);break;case"text":this.drawTextBoxPreview(this.tempAnnotation);break;case"marker":this.drawPath(this.tempAnnotation,!1);break;case"highlighter":this.drawPath(this.tempAnnotation,!0);break;case"lasso":this.drawLassoPath(this.tempAnnotation);break}}drawTextBoxPreview(t){const{startX:e,startY:n,endX:s,endY:r}=t,i=this.ctx,o=Math.min(e,s),a=Math.min(n,r),l=Math.abs(s-e),d=Math.abs(r-n);i.save(),i.strokeStyle="rgba(74, 144, 226, 0.6)",i.lineWidth=2,i.setLineDash([5,5]),i.strokeRect(o,a,l,d),this.toolSettings.text.background&&(i.fillStyle="rgba(255, 255, 255, 0.8)",i.fillRect(o,a,l,d)),i.restore()}render(){Ls.render()}drawArrow(t,e=!1,n=!1,s=!1){aw({ctx:this.ctx,annotation:t,isTemp:e,isSelected:n,isHovered:s,getStrokeWidth:this.getStrokeWidth.bind(this),getLineDash:this.getLineDash.bind(this)})}wrapText(t,e,n){const s=e.split(`
`),r=[];return s.forEach(i=>{if(!i.trim()){r.push("");return}const o=i.split(" ");let a="";o.forEach((l,d)=>{const u=a?a+" "+l:l;t.measureText(u).width>n&&a?(r.push(a),a=l):a=u}),a&&r.push(a)}),r}drawText(t,e=!1,n=!1){const{x:s,y:r,text:i,settings:o}=t,a=this.ctx;a.save();const d=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',u=this.getSizeValue(o.size);a.font=`${o.italic?"italic ":""}${o.bold?"bold ":""}${u} ${d}`,a.textBaseline="top";const h=parseInt(u)*1.2,m=t.width||0,f=t.height||0,g=o.background?16:8,p=m-g,w=this.wrapText(a,i,p);if(o.background){a.fillStyle="#ffffff";const C=8;a.fillRect(s-C/2,r-C/2,m+C,f+C/2)}if(n&&!e){a.fillStyle="rgba(74, 144, 226, 0.1)";const C=o.background?8:2;a.fillRect(s-C/2,r-C/2,m+C,f+C/2)}if(e){a.fillStyle="rgba(74, 144, 226, 0.2)";const C=o.background?8:2;a.fillRect(s-C/2,r-C/2,m+C,f+C/2)}a.fillStyle=o.color;const v=parseInt(u);w.forEach((C,F)=>{const E=r+F*h;this.drawTextWithSuperscripts(a,C,s,E,v,o,d)}),e&&this.drawResizeHandles(s,r,m,f),a.restore()}drawTextWithSuperscripts(t,e,n,s,r,i,o){if(i.superscript||i.subscript){t.save();const u=r*.6,h=i.superscript?-r*.4:r*.3;if(t.font=`${i.italic?"italic ":""}${i.bold?"bold ":""}${u}px ${o}`,t.fillText(e,n,s+h),i.underline){const m=t.measureText(e);t.beginPath(),t.strokeStyle=i.color,t.lineWidth=1,t.moveTo(n,s+h+u*1.2-2),t.lineTo(n+m.width,s+h+u*1.2-2),t.stroke()}t.restore();return}let a=n;const l=this.parseFormattedText(e),d=(u,h)=>{const m=u;if(m){if(t.save(),h==="superscript"){const f=r*.6,g=-r*.4;t.font=`${i.italic?"italic ":""}${i.bold?"bold ":""}${f}px ${o}`,t.fillText(m,a,s+g),a+=t.measureText(m).width}else if(h==="subscript"){const f=r*.6,g=r*.3;t.font=`${i.italic?"italic ":""}${i.bold?"bold ":""}${f}px ${o}`,t.fillText(m,a,s+g),a+=t.measureText(m).width}else{if(t.font=`${i.italic?"italic ":""}${i.bold?"bold ":""}${r}px ${o}`,t.fillText(m,a,s),i.underline){const f=t.measureText(m);t.beginPath(),t.strokeStyle=i.color,t.lineWidth=1,t.moveTo(a,s+r*1.2-2),t.lineTo(a+f.width,s+r*1.2-2),t.stroke()}a+=t.measureText(m).width}t.restore()}};l.forEach(u=>{d(u.text,u.format)})}parseFormattedText(t){const e=[];let n=0,s="",r=!1;for(;n<t.length;){if(t.substr(n,5)==="<sup>"){s&&(e.push({text:s,format:"normal"}),s="");const i=t.indexOf("</sup>",n);if(i!==-1){const o=t.substring(n+5,i);e.push({text:o,format:"superscript"}),n=i+6;continue}}if(t.substr(n,5)==="<sub>"){s&&(e.push({text:s,format:"normal"}),s="");const i=t.indexOf("</sub>",n);if(i!==-1){const o=t.substring(n+5,i);e.push({text:o,format:"subscript"}),n=i+6;continue}}if(t[n]==="^"&&!r){s&&(e.push({text:s,format:"normal"}),s=""),r=!0,n++;continue}if(r&&t[n]===" "){s&&(e.push({text:s,format:"superscript"}),s=""),r=!1,e.push({text:" ",format:"normal"}),n++;continue}s+=t[n],n++}return s&&e.push({text:s,format:r?"superscript":"normal"}),e}drawResizeHandles(t,e,n,s){const r=this.ctx,i=8,o=[{pos:"nw",x:t,y:e},{pos:"n",x:t+n/2,y:e},{pos:"ne",x:t+n,y:e},{pos:"e",x:t+n,y:e+s/2},{pos:"se",x:t+n,y:e+s},{pos:"s",x:t+n/2,y:e+s},{pos:"sw",x:t,y:e+s},{pos:"w",x:t,y:e+s/2}];r.save(),o.forEach(a=>{r.fillStyle="#4a90e2",r.strokeStyle="#ffffff",r.lineWidth=2,r.fillRect(a.x-i/2,a.y-i/2,i,i),r.strokeRect(a.x-i/2,a.y-i/2,i,i)}),r.restore()}drawPath(t,e){const{path:n,settings:s}=t,r=this.ctx;if(!(n.length<2)){r.save(),e&&(r.globalAlpha=.3),r.strokeStyle=s.color,r.lineWidth=this.getStrokeWidth(s.size),r.lineCap="round",r.lineJoin="round",r.beginPath(),r.moveTo(n[0].x,n[0].y);for(let i=1;i<n.length;i++)r.lineTo(n[i].x,n[i].y);r.stroke(),r.restore()}}drawLassoPath(t){const{path:e}=t,n=this.ctx;if(!(e.length<2)){n.save(),n.strokeStyle="rgba(0, 100, 255, 0.8)",n.lineWidth=2,n.setLineDash([5,5]),n.beginPath(),n.moveTo(e[0].x,e[0].y);for(let s=1;s<e.length;s++)n.lineTo(e[s].x,e[s].y);n.lineTo(e[0].x,e[0].y),n.stroke(),n.restore()}}getStrokeWidth(t){if(typeof t=="number")return t;switch(t){case"small":return 2;case"medium":return 4;case"large":return 6;default:return 2}}getLineDash(t){switch(t){case"solid":return[];case"dashed-big":return[10,5];case"dashed-small":return[5,3];case"dotted":return[2,3];default:return[]}}getSizeValue(t){if(typeof t=="number")return`${t}px`;switch(t){case"small":return"14px";case"medium":return"18px";case"large":return"24px";default:return"16px"}}updateHover(t,e){const n=this.hoverAnnotation,s=typeof document<"u"&&document.body?.dataset?.cursorOverride==="stamp";if(this.selectedAnnotation?.type==="text"){const i=this.getResizeHandleAt(t,e,this.selectedAnnotation);if(i){const o={nw:"nwse-resize",n:"ns-resize",ne:"nesw-resize",e:"ew-resize",se:"nwse-resize",s:"ns-resize",sw:"nesw-resize",w:"ew-resize"};this.canvas.style.cursor=o[i]??"default";return}}if(c.state.lassoSelection?.isActive&&c.state.lassoSelection.convexHull){const i=Pc({x:t,y:e},c.state.lassoSelection.convexHull,10),o=Ts({x:t,y:e},c.state.lassoSelection.convexHull);if(i||o){this.canvas.style.cursor="move";return}}const r=this.getAnnotationAt(t,e);r&&(r.type==="arrow"||r.type==="text")?(s||(this.currentTool==="text"&&r.type==="text"?this.selectedAnnotation===r?this.canvas.style.cursor="move":this.canvas.style.cursor="pointer":this.canvas.style.cursor="move"),this.hoverAnnotation=r):(s||(this.currentTool?this.setTool(this.currentTool,this.toolSettings):n&&(this.canvas.style.cursor="default")),this.hoverAnnotation=null),n!==this.hoverAnnotation&&this.render()}getResizeHandleAt(t,e,n){if(n?.type!=="text")return null;const r=8/2+2,i=this.getRenderOptions(),o=Y(n.col,i),a=ut(n.row,i),l=Y(n.col+n.widthCols,i),d=ut(n.row+n.heightRows,i),u=l-o,h=d-a,m=[{pos:"nw",x:o,y:a},{pos:"n",x:o+u/2,y:a},{pos:"ne",x:o+u,y:a},{pos:"e",x:o+u,y:a+h/2},{pos:"se",x:o+u,y:a+h},{pos:"s",x:o+u/2,y:a+h},{pos:"sw",x:o,y:a+h},{pos:"w",x:o,y:a+h/2}];for(const f of m)if(Math.sqrt(Math.pow(t-f.x,2)+Math.pow(e-f.y,2))<=r)return f.pos;return null}getAnnotationAt(t,e){for(let s=c.state.annotations.length-1;s>=0;s--){const r=c.state.annotations[s];if(r.type==="arrow"){if(gh(t,e,r.startX,r.startY,r.endX,r.endY)<10)return r}else if(r.type==="text"){const i=this.getRenderOptions(),o=Y(r.col,i),a=ut(r.row,i),l=Y(r.col+r.widthCols,i),d=ut(r.row+r.heightRows,i),u=l-o,h=d-a;if(t>=o&&t<=o+u&&e>=a&&e<=a+h)return r}}return null}showEraserCursor(t,e){this.render();const s=(c.state.cellWidth||40)*2;this.ctx.save(),this.ctx.fillStyle="rgba(220, 53, 69, 0.3)",this.ctx.fillRect(t-s/2,e-s/2,s,s),this.ctx.restore()}loadAnnotationSettings(t){if(t.type==="arrow"&&window.drawToolsController){const e=t.settings;window.drawToolsController.settings.arrow={...e},window.drawToolsController.renderArrowOptions()}else if(t.type==="text"&&window.drawToolsController){const e=t.settings;window.drawToolsController.settings.text={...e},window.drawToolsController.renderTextOptions()}}applyCurrentSettingsToSelected(){this.selectedAnnotation&&(this.selectedAnnotation.type==="arrow"&&this.toolSettings.arrow?(this.selectedAnnotation.settings={...this.toolSettings.arrow},this.render()):this.selectedAnnotation.type==="text"&&this.toolSettings.text&&(this.selectedAnnotation.settings={...this.toolSettings.text},this.render()))}clearAnnotations(){c.state.annotations=[],this.render()}eraseAtPoint(t,e){const{nextAnnotations:n,changed:s}=sw({x:t,y:e,annotations:c.state.annotations,getRenderOptions:()=>this.getRenderOptions()});return c.state.annotations=n,s&&this.render(),s}interpolatePoints(t,e){const n=[],s=e.col-t.col,r=e.row-t.row,i=Math.sqrt(s*s+r*r),o=Math.max(1,Math.floor(i/.1));for(let a=1;a<=o;a++){const l=a/o;n.push({col:t.col+l*s,row:t.row+l*r})}return n}deleteAnnotationAt(t,e){this.eraseAtPoint(t,e)}getAnnotations(){return c.state.annotations}loadAnnotations(t){c.state.annotations=t||[],this.render()}applyInlineFormatting(t){const e=document.querySelector(".annotation-text-input");if(!e)return;const n=window.getSelection();if(!n||!n.rangeCount)return;const s=n.getRangeAt(0),r=s.toString();if(!r)return;let i;if(t==="superscript")i=`<sup>${r}</sup>`;else if(t==="subscript")i=`<sub>${r}</sub>`;else return;s.deleteContents();const o=document.createTextNode(i);s.insertNode(o),s.setStartAfter(o),s.setEndAfter(o),n.removeAllRanges(),n.addRange(s),e instanceof HTMLElement&&e.focus()}}const It=new lw;function Dc(A){if(A?.type!=="arrow")return!1;const t=A,e=t.settings;return typeof t.startCol=="number"&&typeof t.startRow=="number"&&typeof t.endCol=="number"&&typeof t.endRow=="number"&&!!e&&typeof e.strokeWeight=="number"&&typeof e.lineStyle=="string"}function Nc(A){if(A?.type!=="text")return!1;const t=A,e=t.settings;return typeof t.col=="number"&&typeof t.row=="number"&&typeof t.widthCols=="number"&&typeof t.heightRows=="number"&&typeof t.text=="string"&&!!e&&typeof e.size=="number"&&typeof e.color=="string"}function cw(A){if(A?.type!=="text")return!1;const t=A,e=typeof A.col=="number";return typeof t.startCol=="number"&&typeof t.startRow=="number"&&typeof t.endCol=="number"&&typeof t.endRow=="number"&&!e}function Rc(A){if(!A||A.type!=="marker"&&A.type!=="highlighter")return!1;const t=A,e=t.settings;return Array.isArray(t.path)&&!!e&&typeof e.color=="string"&&(typeof e.size=="number"||e.size==="small"||e.size==="medium"||e.size==="large")}function dw(A){return A?.type==="lasso"&&Array.isArray(A.path)}function uw(A,t){const e=c.state.annotations,n=It.tempAnnotation,s=It.selectedAnnotation,r=It.hoverAnnotation;if(e&&e.length>0&&e.forEach(o=>{const a=o===s,l=o===r;switch(o.type){case"arrow":Dc(o)&&kc(A,o,a,l,t);break;case"text":Nc(o)&&Oc(A,o,a,l,t);break;case"marker":case"highlighter":Rc(o)&&Kc(A,o,t);break}}),n)switch(n.type){case"arrow":Dc(n)&&kc(A,n,!1,!1,t);break;case"text":cw(n)?pw(A,n,t):Nc(n)&&Oc(A,n,!1,!1,t);break;case"marker":case"highlighter":Rc(n)&&Kc(A,n,t);break;case"lasso":dw(n)&&ww(A,n);break}const i=c.state.lassoSelection;i?.isActive&&Array.isArray(i.convexHull)&&(It.updateLassoConvexHull(),vw(A,i.convexHull))}function kc(A,t,e=!1,n=!1,s){const{startCol:r,startRow:i,endCol:o,endRow:a,settings:l}=t,d=Y(r,s),u=ut(i,s),h=Y(o,s),m=ut(a,s);A.save(),A.strokeStyle=t.color||"#000000",A.lineWidth=la(l.strokeWeight),A.setLineDash(Bw(l.lineStyle));const f=Math.atan2(m-u,h-d),g=l.arrowheadSize||12;let p=d,w=u,v=h,C=m;l.startArrowhead&&l.startArrowhead!=="none"&&(p=d+Math.cos(f)*g,w=u+Math.sin(f)*g),l.endArrowhead&&l.endArrowhead!=="none"&&(v=h-Math.cos(f)*g,C=m-Math.sin(f)*g),A.beginPath(),A.moveTo(p,w),A.lineTo(v,C),A.stroke(),A.setLineDash([]),l.startArrowhead&&l.startArrowhead!=="none"&&_c(A,d,u,f+Math.PI,l.startArrowhead,g),l.endArrowhead&&l.endArrowhead!=="none"&&_c(A,h,m,f,l.endArrowhead,g),(e||n)&&(A.strokeStyle=e?"rgba(74, 144, 226, 0.6)":"rgba(74, 144, 226, 0.3)",A.lineWidth=la(l.strokeWeight)+4,A.setLineDash([]),A.beginPath(),A.moveTo(d,u),A.lineTo(h,m),A.stroke()),A.restore()}function _c(A,t,e,n,s,r){switch(A.save(),A.translate(t,e),A.rotate(n),s){case"filled":case"filled-arrow":A.beginPath(),A.moveTo(0,0),A.lineTo(-r,-r/2),A.lineTo(-r,r/2),A.closePath(),A.fillStyle=A.strokeStyle,A.fill();break;case"unfilled":case"unfilled-arrow":A.beginPath(),A.moveTo(0,0),A.lineTo(-r,-r/2),A.lineTo(-r,r/2),A.closePath(),A.stroke();break;case"circle":A.beginPath(),A.arc(0,0,r/3,0,Math.PI*2),A.fillStyle=A.strokeStyle,A.fill();break}A.restore()}function Oc(A,t,e=!1,n=!1,s){const{col:r,row:i,text:o,widthCols:a,heightRows:l,settings:d}=t,u=Y(r,s),h=ut(i,s),m=Y(r+(typeof a=="number"?a:2),s)-u,f=ut(i+(typeof l=="number"?l:1),s)-h;A.save(),A.textBaseline="top";const p=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',w=d.size,v=w*1.2,C=d.background?8:4,F=4,E=m-C*2,b=hw(A,o,E,w,d,p);d.background&&(A.fillStyle="#ffffff",A.fillRect(u,h,m,f)),n&&!e&&(A.fillStyle="rgba(74, 144, 226, 0.1)",A.fillRect(u,h,m,f)),e&&(A.fillStyle="rgba(74, 144, 226, 0.2)",A.fillRect(u,h,m,f)),A.fillStyle=d.color,b.forEach((S,y)=>{const I=h+F+y*v;fw(A,S,u+C,I,w,d,p)}),e&&mw(A,u,h,m,f),A.restore()}function hw(A,t,e,n,s,r){A.font=`${s.italic?"italic ":""}${s.bold?"bold ":""}${n}px ${r}`;const i=t.split(`
`),o=[];return i.forEach(a=>{if(!a.trim()){o.push("");return}const l=a.split(" ");let d="";l.forEach(u=>{const h=d?d+" "+u:u;A.measureText(h).width>e&&d?(o.push(d),d=u):d=h}),d&&o.push(d)}),o}function fw(A,t,e,n,s,r,i){if(r.superscript||r.subscript){A.save();const l=s*.6,d=r.superscript?-s*.4:s*.3;if(A.font=`${r.italic?"italic ":""}${r.bold?"bold ":""}${l}px ${i}`,A.fillText(t,e,n+d),r.underline){const u=A.measureText(t);A.beginPath(),A.strokeStyle=r.color,A.lineWidth=1,A.moveTo(e,n+d+l*1.2-2),A.lineTo(e+u.width,n+d+l*1.2-2),A.stroke()}A.restore();return}const o=gw(t);let a=e;o.forEach(l=>{if(A.save(),l.format==="superscript"){const d=s*.6,u=-s*.4;A.font=`${r.italic?"italic ":""}${r.bold?"bold ":""}${d}px ${i}`,A.fillText(l.text,a,n+u),a+=A.measureText(l.text).width}else if(l.format==="subscript"){const d=s*.6,u=s*.3;A.font=`${r.italic?"italic ":""}${r.bold?"bold ":""}${d}px ${i}`,A.fillText(l.text,a,n+u),a+=A.measureText(l.text).width}else{if(A.font=`${r.italic?"italic ":""}${r.bold?"bold ":""}${s}px ${i}`,A.fillText(l.text,a,n),r.underline){const d=A.measureText(l.text);A.beginPath(),A.strokeStyle=r.color,A.lineWidth=1,A.moveTo(a,n+s*1.2-2),A.lineTo(a+d.width,n+s*1.2-2),A.stroke()}a+=A.measureText(l.text).width}A.restore()})}function gw(A){const t=[];let e=0,n="",s=!1;for(;e<A.length;){if(A.substr(e,5)==="<sup>"){n&&(t.push({text:n,format:"normal"}),n="");const r=A.indexOf("</sup>",e);if(r!==-1){const i=A.substring(e+5,r);t.push({text:i,format:"superscript"}),e=r+6;continue}}if(A.substr(e,5)==="<sub>"){n&&(t.push({text:n,format:"normal"}),n="");const r=A.indexOf("</sub>",e);if(r!==-1){const i=A.substring(e+5,r);t.push({text:i,format:"subscript"}),e=r+6;continue}}if(A[e]==="^"&&!s){n&&(t.push({text:n,format:"normal"}),n=""),s=!0,e++;continue}if(s&&A[e]===" "){n&&(t.push({text:n,format:"superscript"}),n=""),s=!1,t.push({text:" ",format:"normal"}),e++;continue}n+=A[e],e++}return n&&t.push({text:n,format:s?"superscript":"normal"}),t}function mw(A,t,e,n,s){const i=[{x:t,y:e},{x:t+n/2,y:e},{x:t+n,y:e},{x:t+n,y:e+s/2},{x:t+n,y:e+s},{x:t+n/2,y:e+s},{x:t,y:e+s},{x:t,y:e+s/2}];A.save(),i.forEach(o=>{A.fillStyle="#4a90e2",A.strokeStyle="#ffffff",A.lineWidth=2,A.fillRect(o.x-8/2,o.y-8/2,8,8),A.strokeRect(o.x-8/2,o.y-8/2,8,8)}),A.restore()}function pw(A,t,e){const{startCol:n,startRow:s,endCol:r,endRow:i}=t,o=Y(n,e),a=ut(s,e),l=Y(r,e),d=ut(i,e),u=Math.min(o,l),h=Math.min(a,d),m=Math.abs(l-o),f=Math.abs(d-a);A.save(),A.strokeStyle="rgba(74, 144, 226, 0.6)",A.lineWidth=2,A.setLineDash([5,5]),A.strokeRect(u,h,m,f),A.restore()}function Kc(A,t,e){const{path:n,settings:s,type:r}=t;if(!n||n.length<2)return;const i=n.map(a=>({x:Y(a.col,e),y:ut(a.row,e)}));A.save(),r==="highlighter"&&(A.globalAlpha=.3),A.strokeStyle=s.color,A.lineWidth=typeof s.size=="number"?s.size:la(s.size),A.lineCap="round",A.lineJoin="round",A.beginPath();const o=i[0];if(!o){A.restore();return}A.moveTo(o.x,o.y);for(let a=1;a<i.length;a++){const l=i[a];l&&A.lineTo(l.x,l.y)}A.stroke(),A.restore()}function la(A){if(typeof A=="number")return A;switch(A){case"small":return 2;case"medium":return 4;case"large":return 6;default:return 4}}function Bw(A){switch(A){case"solid":return[];case"dashed-big":return[10,5];case"dashed-small":return[5,3];case"dotted":return[2,3];default:return[]}}function ww(A,t){const e=t.path;if(!e||e.length<2)return;const n=e[0];if(n){A.save(),A.strokeStyle="#4a90e2",A.lineWidth=2,A.setLineDash([5,5]),A.globalAlpha=.7,A.beginPath(),A.moveTo(n.x,n.y);for(let s=1;s<e.length;s++){const r=e[s];r&&A.lineTo(r.x,r.y)}e.length>2&&A.lineTo(n.x,n.y),A.stroke(),A.restore()}}function vw(A,t){if(!t||t.length<3)return;const e=t[0];if(e){A.save(),A.strokeStyle="#4a90e2",A.lineWidth=2,A.setLineDash([8,4]),A.globalAlpha=.8,A.beginPath(),A.moveTo(e.x,e.y);for(let n=1;n<t.length;n++){const s=t[n];s&&A.lineTo(s.x,s.y)}A.closePath(),A.stroke(),A.fillStyle="rgba(74, 144, 226, 0.1)",A.fill(),A.restore()}}let Gc=0;function mh(){try{if(globalThis.__SN_DEBUG_VIEWPORT)return!0}catch{}try{if(new URLSearchParams(window.location.search).get("debugViewport")==="1")return!0}catch{}try{return localStorage.getItem("sn:debugViewport")==="1"}catch{return!1}}let Cw=!1;function bw(A,t){if(mh())try{const e=performance?.now?.()??Date.now();if(e-Gc<500)return;Gc=e,Cw=!0}catch{}}function yw(A,t){const e={...c.state,...t};if(!e.columnWidths?.length||!e.fullRowData?.length)return;A.clearRect(0,0,ne(A.canvas),Mt(A.canvas));const{startRow:n,endRow:s}=gB(),r=Math.max(0,n-1),i=Math.max(0,(e.fullRowData?.length??1)-1),o=Math.min(i,s+1);if(mh()){const g=Mt(A.canvas),p=e.cellHeight/2,w=ut(s,e),v=w+p,C=e.fullRowData?.length??0,F=n<=0,E=C>0?s>=C-1:!1,b=e.fullRowData?.[n],S=e.fullRowData?.[s];bw("pitchCanvasCoverage",{startRow:n,endRow:s,paddedStartRow:r,paddedEndRow:o,atTopGamutEdge:F,atBottomGamutEdge:E,canvasHeight:g,containerHeight:e.viewportHeight,halfUnit:p,yEnd:w,bottomEdge:v,gapCanvasMinusBottomEdge:g-v,gapCanvasMinusContainer:g-e.viewportHeight,startRowSummary:b?{pitch:b.pitch,column:b.column,isBoundary:!!b.isBoundary}:null,endRowSummary:S?{pitch:S.pitch,column:S.column,isBoundary:!!S.isBoundary}:null})}const a=e.cellHeight,l=g=>{const p=ut(g,e);return p>=-a&&p<=e.viewportHeight+a},d=e.placedTonicSigns.filter(g=>g.globalRow===void 0?!1:l(g.globalRow)),u=Us.getLegendLeftContext(),h=Us.getLegendRightContext();LB(u,h,e,r,o),SB(A,e,r,o),EB(A,e);const m=t.placedNotes.filter(g=>g.isDrum||g.globalRow===void 0?!1:l(g.globalRow)),f=d;m.forEach(g=>{g.shape==="oval"?yl(A,e,g,g.globalRow):g.shape==="circle"&&bl(A,e,g,g.globalRow)}),f.forEach(g=>{ch(A,e,g)}),KB(A,e),VB(A,e),fh(A,e),uw(A,e)}const ph={getTimeSignatureSegments(){const A=c.state,t=A.macrobeatGroupings??[],e=A.macrobeatBoundaryStyles??[],n=[];let s=!!A.hasAnacrusis,r=ge(A,0).startColumn,i=0,o=!1;return t.forEach((a,l)=>{i+=a,a===3&&(o=!0);const d=l===t.length-1,h=e[l]==="solid";if(h||d){const f=ge(A,l).endColumn+1,g=Array.isArray(A.modulationMarkers)&&A.modulationMarkers.length>0,p={...A,modulationMarkers:g?A.modulationMarkers:[],cellWidth:A.cellWidth,columnWidths:A.columnWidths,musicalColumnWidths:A.musicalColumnWidths,baseMicrobeatPx:A.cellWidth},w=Y(r,p),v=Y(f,p),C=o?`${i}/8`:`${i/2}/4`;n.push({label:C,centerX:(w+v)/2,startX:w,endX:v,isAnacrusis:s}),d||(r=f,i=0,o=!1,h&&(s=!1))}}),n},getRhythmUIButtons(){const A=c.state,t=A.macrobeatGroupings??[],e=A.macrobeatBoundaryStyles??[],n=[],s=se(A),r=new Set(s.map(i=>i.columnIndex+2));return t.forEach((i,o)=>{const a=ge(A,o),{startColumn:l,endColumn:d}=a,u={...A,modulationMarkers:A.modulationMarkers||[],cellWidth:A.cellWidth,columnWidths:A.columnWidths,musicalColumnWidths:A.columnWidths,baseMicrobeatPx:A.cellWidth},h=Y(l,u),m=Y(d+1,u),f=(h+m)/2,g=e[o]??null,p=o>0?e[o-1]??null:null,w=p!==null&&r.has(l);n.push({type:"grouping",content:i,x:f,startX:h,endX:m,index:o,nextBoundaryStyle:g,prevBoundaryStyle:p,hasLeftDivider:w}),o<t.length-1&&n.push({type:"boundary",boundaryStyle:g,x:m,index:o})}),n}},Sw="data-rhythm-ui-element",ca=A=>`${Math.round(A*100)/100}px`,Ew=A=>{A.querySelectorAll(`[${Sw}]`).forEach(t=>t.remove())},Qw=A=>{const t=document.getElementById("notation-grid");if(!t)return null;const e=t.getBoundingClientRect(),n=A.getBoundingClientRect();return e.width===0?null:e.left-n.left},Fw=(A,t)=>{const e=document.createElement("button");return e.type="button",e.className="grouping-segment",e.dataset.rhythmUiElement="grouping",e.dataset.index=`${A.index}`,e.textContent=`${A.content}`,e.style.left=ca(t+A.startX),e.style.width=ca(Math.max(0,A.endX-A.startX)),e.dataset.nextBoundaryStyle=`${A.nextBoundaryStyle??""}`,e.dataset.prevBoundaryStyle=`${A.prevBoundaryStyle??""}`,e.dataset.hasLeftDivider=A.hasLeftDivider?"true":"false",e.setAttribute("aria-label",`Toggle macrobeat grouping (${A.content}) at position ${A.index+1}`),e.addEventListener("click",n=>{n.stopPropagation(),c.toggleMacrobeatGrouping(A.index)}),e},Iw=(A,t)=>{const e=document.createElement("button");e.type="button",e.className="buttonGrid-ui-button buttonGrid-ui-button--boundary",e.dataset.rhythmUiElement="boundary",e.dataset.index=`${A.index}`,e.style.left=ca(t+A.x),e.setAttribute("aria-label","Cycle boundary style");const n=document.createElement("span");return n.className="boundary-diamond",n.dataset.style=A.boundaryStyle||"dashed",e.appendChild(n),e.addEventListener("click",s=>{s.stopPropagation(),c.cycleMacrobeatBoundaryStyle(A.index)}),e};function Bh(){const A=document.getElementById("beat-line-button-layer");if(!A){B.warn("rhythmUI","Cannot render rhythm UI without beat-line container",null,"ui");return}const t=Qw(A);if(t===null)return;const e=A.querySelector("#grouping-buttons-row"),n=A.querySelector("#boundary-buttons-row");Ew(A);const s=ph.getRhythmUIButtons();if(!Array.isArray(s)||s.length===0)return;const r=document.createDocumentFragment(),i=document.createDocumentFragment();s.forEach(o=>{o.type==="grouping"?r.appendChild(Fw(o,t)):o.type==="boundary"&&i.appendChild(Iw(o,t))}),e?e.appendChild(r):A.appendChild(r),n?n.appendChild(i):A.appendChild(i)}const xw={init:Uw};function Uw(){Bh()}const Mw={getTimeSignatureOptions(){return{"Single Macrobeat":[{label:"1/4",groupings:[2],description:"one 2-beat"},{label:"2/8",groupings:[2],description:"one 2-beat"},{label:"3/8",groupings:[3],description:"one 3-beat"}],"Two Macrobeats":[{label:"2/4",groupings:[2,2],description:"two 2-beats"},{label:"4/8",groupings:[2,2],description:"two 2-beats"},{label:"5/8",groupings:[2,3],description:"2+3"},{label:"5/8",groupings:[3,2],description:"3+2"},{label:"6/8",groupings:[3,3],description:"two 3-beats"}],"Three Macrobeats":[{label:"3/4",groupings:[2,2,2],description:"three 2-beats"},{label:"7/8",groupings:[2,2,3],description:"2+2+3"},{label:"7/8",groupings:[3,2,2],description:"3+2+2"},{label:"7/8",groupings:[2,3,2],description:"2+3+2"},{label:"8/8",groupings:[3,3,2],description:"3+3+2"},{label:"8/8",groupings:[3,2,3],description:"3+2+3"},{label:"8/8",groupings:[2,3,3],description:"2+3+3"},{label:"9/8",groupings:[3,3,3],description:"three 3-beats"}],"Four Macrobeats":[{label:"4/4",groupings:[2,2,2,2],description:"four 2-beats"},{label:"10/8",groupings:[2,2,3,3],description:"2+2+3+3"},{label:"10/8",groupings:[2,3,2,3],description:"2+3+2+3"},{label:"10/8",groupings:[2,3,3,2],description:"2+3+3+2"},{label:"10/8",groupings:[3,2,3,2],description:"3+2+3+2"},{label:"10/8",groupings:[3,3,2,2],description:"3+3+2+2"},{label:"10/8",groupings:[3,2,2,3],description:"3+2+2+3"},{label:"11/8",groupings:[3,3,3,2],description:"3+3+3+2"},{label:"11/8",groupings:[3,3,2,3],description:"3+3+2+3"},{label:"11/8",groupings:[3,2,3,3],description:"3+2+3+3"},{label:"11/8",groupings:[2,3,3,3],description:"2+3+3+3"},{label:"12/8",groupings:[3,3,3,3],description:"four 3-beats"}],"Five Macrobeats":[{label:"5/4",groupings:[2,2,2,2,2],description:"five 2-beats"},{label:"11/8",groupings:[2,2,2,2,3],description:"2+2+2+2+3"},{label:"11/8",groupings:[2,2,2,3,2],description:"2+2+2+3+2"},{label:"11/8",groupings:[2,2,3,2,2],description:"2+2+3+2+2"},{label:"11/8",groupings:[2,3,2,2,2],description:"2+3+2+2+2"},{label:"11/8",groupings:[3,2,2,2,2],description:"3+2+2+2+2"},{label:"12/8",groupings:[2,2,2,3,3],description:"2+2+2+3+3"},{label:"12/8",groupings:[2,2,3,2,3],description:"2+2+3+2+3"},{label:"12/8",groupings:[2,2,3,3,2],description:"2+2+3+3+2"},{label:"12/8",groupings:[2,3,2,2,3],description:"2+3+2+2+3"},{label:"12/8",groupings:[2,3,2,3,2],description:"2+3+2+3+2"},{label:"12/8",groupings:[2,3,3,2,2],description:"2+3+3+2+2"},{label:"12/8",groupings:[3,2,2,2,3],description:"3+2+2+2+3"},{label:"12/8",groupings:[3,2,2,3,2],description:"3+2+2+3+2"},{label:"12/8",groupings:[3,2,3,2,2],description:"3+2+3+2+2"},{label:"12/8",groupings:[3,3,2,2,2],description:"3+3+2+2+2"},{label:"13/8",groupings:[3,2,2,3,3],description:"3+2+2+3+3"},{label:"13/8",groupings:[3,3,2,3,2],description:"3+3+2+3+2"},{label:"13/8",groupings:[3,3,3,2,2],description:"3+3+3+2+2"},{label:"15/8",groupings:[3,3,3,3,3],description:"five 3-beats"}]}},generateDropdownHTML(){const A=this.getTimeSignatureOptions();let t='<div id="time-signature-dropdown" class="time-signature-dropdown hidden">';return Object.entries(A).forEach(([e,n])=>{t+='<div class="dropdown-category">',t+=`<div class="dropdown-category-header">${e}</div>`,n.forEach((s,r)=>{const i=`${e}-${r}`;t+=`<div class="dropdown-option" data-groupings="${JSON.stringify(s.groupings)}" data-key="${i}">`,t+=`<span class="dropdown-label">${s.label}</span>`,t+=`<span class="dropdown-description">${s.description}</span>`,t+="</div>"}),t+="</div>"}),t+="</div>",t},getTimeSignatureLabel(A){const t=A.reduce((n,s)=>n+s,0);return A.includes(3)?`${t}/8`:`${t/2}/4`}};let si=null;function Tw(){const A=document.getElementById("beat-line-button-layer");if(!A)return;const t=A.querySelector("#time-signature-row")||A;A.querySelectorAll(".time-signature-label").forEach(a=>a.remove());const n=document.getElementById("notation-grid");if(!n)return;const s=n.getBoundingClientRect(),r=A.getBoundingClientRect(),i=s.left-r.left;ph.getTimeSignatureSegments().forEach((a,l)=>{const d=document.createElement("div");d.className="time-signature-label",a.isAnacrusis&&d.classList.add("anacrusis-label"),d.textContent=a.label,d.style.position="absolute",d.style.left=`${i+a.startX}px`,d.style.width=`${Math.max(0,a.endX-a.startX)}px`,d.style.transform="none",d.style.pointerEvents="auto",d.addEventListener("click",u=>{u.stopPropagation(),Lw(d,l)}),t.appendChild(d)}),Pw()}function Pw(){if(!document.getElementById("time-signature-dropdown")){const A=Mw.generateDropdownHTML();document.body.insertAdjacentHTML("beforeend",A),document.getElementById("time-signature-dropdown")?.addEventListener("click",Dw)}}function Lw(A,t){const e=document.getElementById("time-signature-dropdown");if(!e)return;e.dataset.measureIndex=String(t);const n=A.getBoundingClientRect();e.style.left=`${n.left}px`,e.style.top=`${n.bottom+5}px`;const s=e.getBoundingClientRect(),r=window.innerWidth,i=window.innerHeight;n.left+s.width>r&&(e.style.left=`${r-s.width-10}px`),n.bottom+s.height>i&&(e.style.top=`${n.top-s.height-5}px`),e.classList.remove("hidden"),si={dropdown:e,measureIndex:t},setTimeout(()=>{document.addEventListener("click",Hw,{once:!0})},0)}function Hw(A){const t=document.getElementById("time-signature-dropdown"),e=A.target;t&&e&&!t.contains(e)&&(t.classList.add("hidden"),si=null)}function Dw(A){const e=A.target?.closest(".dropdown-option");if(!e)return;const n=e.dataset.groupings,s=si?.measureIndex??NaN;if(!(!n||Number.isNaN(s)))try{const r=JSON.parse(n);c.updateTimeSignature(s,r),document.getElementById("time-signature-dropdown")?.classList.add("hidden"),si=null}catch{}}B.moduleLoaded("PitchGridController","grid");function Nw(){const A=Us.getPitchContext();if(!A?.canvas){B.error("PitchGridController","Pitch grid context not available for rendering",null,"grid");return}const t=ae.getViewportInfo(),e={placedNotes:M0(c.state),placedTonicSigns:se(c.state),fullRowData:c.state.fullRowData,columnWidths:c.state.columnWidths,cellWidth:c.state.cellWidth,cellHeight:c.state.cellHeight,rowHeight:c.state.cellHeight*.5,macrobeatGroupings:c.state.macrobeatGroupings,macrobeatBoundaryStyles:c.state.macrobeatBoundaryStyles,accidentalMode:c.state.accidentalMode,showFrequencyLabels:c.state.showFrequencyLabels,showOctaveLabels:c.state.showOctaveLabels,colorMode:"color",degreeDisplayMode:c.state.degreeDisplayMode,zoomLevel:t.zoomLevel,viewportHeight:t.containerHeight,modulationMarkers:c.state.modulationMarkers,showModulationLabel:!1};B.debug("PitchGridController","renderPitchGrid options",{columns:e.columnWidths?.length,rows:e.fullRowData?.length,placedNotes:e.placedNotes.length,tonicSigns:e.placedTonicSigns.length,zoomLevel:e.zoomLevel,viewportHeight:e.viewportHeight},"grid"),yw(A,e)}const Ls={render(){Nw()},renderMacrobeatTools(){Bh(),Tw()}};var da=function(A,t){return da=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])},da(A,t)};function Re(A,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");da(A,t);function e(){this.constructor=A}A.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}var ua=function(){return ua=Object.assign||function(t){for(var e,n=1,s=arguments.length;n<s;n++){e=arguments[n];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])}return t},ua.apply(this,arguments)};function ie(A,t,e,n){function s(r){return r instanceof e?r:new e(function(i){i(r)})}return new(e||(e=Promise))(function(r,i){function o(d){try{l(n.next(d))}catch(u){i(u)}}function a(d){try{l(n.throw(d))}catch(u){i(u)}}function l(d){d.done?r(d.value):s(d.value).then(o,a)}l((n=n.apply(A,[])).next())})}function Zt(A,t){var e={label:0,sent:function(){if(r[0]&1)throw r[1];return r[1]},trys:[],ops:[]},n,s,r,i;return i={next:o(0),throw:o(1),return:o(2)},typeof Symbol=="function"&&(i[Symbol.iterator]=function(){return this}),i;function o(l){return function(d){return a([l,d])}}function a(l){if(n)throw new TypeError("Generator is already executing.");for(;e;)try{if(n=1,s&&(r=l[0]&2?s.return:l[0]?s.throw||((r=s.return)&&r.call(s),0):s.next)&&!(r=r.call(s,l[1])).done)return r;switch(s=0,r&&(l=[l[0]&2,r.value]),l[0]){case 0:case 1:r=l;break;case 4:return e.label++,{value:l[1],done:!1};case 5:e.label++,s=l[1],l=[0];continue;case 7:l=e.ops.pop(),e.trys.pop();continue;default:if(r=e.trys,!(r=r.length>0&&r[r.length-1])&&(l[0]===6||l[0]===2)){e=0;continue}if(l[0]===3&&(!r||l[1]>r[0]&&l[1]<r[3])){e.label=l[1];break}if(l[0]===6&&e.label<r[1]){e.label=r[1],r=l;break}if(r&&e.label<r[2]){e.label=r[2],e.ops.push(l);break}r[2]&&e.ops.pop(),e.trys.pop();continue}l=t.call(A,e)}catch(d){l=[6,d],s=0}finally{n=r=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}function tr(A,t,e){if(arguments.length===2)for(var n=0,s=t.length,r;n<s;n++)(r||!(n in t))&&(r||(r=Array.prototype.slice.call(t,0,n)),r[n]=t[n]);return A.concat(r||t)}var hA=(function(){function A(t,e,n,s){this.left=t,this.top=e,this.width=n,this.height=s}return A.prototype.add=function(t,e,n,s){return new A(this.left+t,this.top+e,this.width+n,this.height+s)},A.fromClientRect=function(t,e){return new A(e.left+t.windowBounds.left,e.top+t.windowBounds.top,e.width,e.height)},A.fromDOMRectList=function(t,e){var n=Array.from(e).find(function(s){return s.width!==0});return n?new A(n.left+t.windowBounds.left,n.top+t.windowBounds.top,n.width,n.height):A.EMPTY},A.EMPTY=new A(0,0,0,0),A})(),Mi=function(A,t){return hA.fromClientRect(A,t.getBoundingClientRect())},Rw=function(A){var t=A.body,e=A.documentElement;if(!t||!e)throw new Error("Unable to get document size");var n=Math.max(Math.max(t.scrollWidth,e.scrollWidth),Math.max(t.offsetWidth,e.offsetWidth),Math.max(t.clientWidth,e.clientWidth)),s=Math.max(Math.max(t.scrollHeight,e.scrollHeight),Math.max(t.offsetHeight,e.offsetHeight),Math.max(t.clientHeight,e.clientHeight));return new hA(0,0,n,s)},Ti=function(A){for(var t=[],e=0,n=A.length;e<n;){var s=A.charCodeAt(e++);if(s>=55296&&s<=56319&&e<n){var r=A.charCodeAt(e++);(r&64512)===56320?t.push(((s&1023)<<10)+(r&1023)+65536):(t.push(s),e--)}else t.push(s)}return t},Lt=function(){for(var A=[],t=0;t<arguments.length;t++)A[t]=arguments[t];if(String.fromCodePoint)return String.fromCodePoint.apply(String,A);var e=A.length;if(!e)return"";for(var n=[],s=-1,r="";++s<e;){var i=A[s];i<=65535?n.push(i):(i-=65536,n.push((i>>10)+55296,i%1024+56320)),(s+1===e||n.length>16384)&&(r+=String.fromCharCode.apply(String,n),n.length=0)}return r},Wc="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",kw=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var er=0;er<Wc.length;er++)kw[Wc.charCodeAt(er)]=er;var Vc="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Vn=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var Ar=0;Ar<Vc.length;Ar++)Vn[Vc.charCodeAt(Ar)]=Ar;var _w=function(A){var t=A.length*.75,e=A.length,n,s=0,r,i,o,a;A[A.length-1]==="="&&(t--,A[A.length-2]==="="&&t--);var l=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u"&&typeof Uint8Array.prototype.slice<"u"?new ArrayBuffer(t):new Array(t),d=Array.isArray(l)?l:new Uint8Array(l);for(n=0;n<e;n+=4)r=Vn[A.charCodeAt(n)],i=Vn[A.charCodeAt(n+1)],o=Vn[A.charCodeAt(n+2)],a=Vn[A.charCodeAt(n+3)],d[s++]=r<<2|i>>4,d[s++]=(i&15)<<4|o>>2,d[s++]=(o&3)<<6|a&63;return l},Ow=function(A){for(var t=A.length,e=[],n=0;n<t;n+=2)e.push(A[n+1]<<8|A[n]);return e},Kw=function(A){for(var t=A.length,e=[],n=0;n<t;n+=4)e.push(A[n+3]<<24|A[n+2]<<16|A[n+1]<<8|A[n]);return e},zA=5,El=11,fo=2,Gw=El-zA,wh=65536>>zA,Ww=1<<zA,go=Ww-1,Vw=1024>>zA,zw=wh+Vw,qw=zw,Xw=32,$w=qw+Xw,Yw=65536>>El,Jw=1<<Gw,jw=Jw-1,zc=function(A,t,e){return A.slice?A.slice(t,e):new Uint16Array(Array.prototype.slice.call(A,t,e))},Zw=function(A,t,e){return A.slice?A.slice(t,e):new Uint32Array(Array.prototype.slice.call(A,t,e))},tv=function(A,t){var e=_w(A),n=Array.isArray(e)?Kw(e):new Uint32Array(e),s=Array.isArray(e)?Ow(e):new Uint16Array(e),r=24,i=zc(s,r/2,n[4]/2),o=n[5]===2?zc(s,(r+n[4])/2):Zw(n,Math.ceil((r+n[4])/4));return new ev(n[0],n[1],n[2],n[3],i,o)},ev=(function(){function A(t,e,n,s,r,i){this.initialValue=t,this.errorValue=e,this.highStart=n,this.highValueIndex=s,this.index=r,this.data=i}return A.prototype.get=function(t){var e;if(t>=0){if(t<55296||t>56319&&t<=65535)return e=this.index[t>>zA],e=(e<<fo)+(t&go),this.data[e];if(t<=65535)return e=this.index[wh+(t-55296>>zA)],e=(e<<fo)+(t&go),this.data[e];if(t<this.highStart)return e=$w-Yw+(t>>El),e=this.index[e],e+=t>>zA&jw,e=this.index[e],e=(e<<fo)+(t&go),this.data[e];if(t<=1114111)return this.data[this.highValueIndex]}return this.errorValue},A})(),qc="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Av=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var nr=0;nr<qc.length;nr++)Av[qc.charCodeAt(nr)]=nr;var nv="KwAAAAAAAAAACA4AUD0AADAgAAACAAAAAAAIABAAGABAAEgAUABYAGAAaABgAGgAYgBqAF8AZwBgAGgAcQB5AHUAfQCFAI0AlQCdAKIAqgCyALoAYABoAGAAaABgAGgAwgDKAGAAaADGAM4A0wDbAOEA6QDxAPkAAQEJAQ8BFwF1AH0AHAEkASwBNAE6AUIBQQFJAVEBWQFhAWgBcAF4ATAAgAGGAY4BlQGXAZ8BpwGvAbUBvQHFAc0B0wHbAeMB6wHxAfkBAQIJAvEBEQIZAiECKQIxAjgCQAJGAk4CVgJeAmQCbAJ0AnwCgQKJApECmQKgAqgCsAK4ArwCxAIwAMwC0wLbAjAA4wLrAvMC+AIAAwcDDwMwABcDHQMlAy0DNQN1AD0DQQNJA0kDSQNRA1EDVwNZA1kDdQB1AGEDdQBpA20DdQN1AHsDdQCBA4kDkQN1AHUAmQOhA3UAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AKYDrgN1AHUAtgO+A8YDzgPWAxcD3gPjA+sD8wN1AHUA+wMDBAkEdQANBBUEHQQlBCoEFwMyBDgEYABABBcDSARQBFgEYARoBDAAcAQzAXgEgASIBJAEdQCXBHUAnwSnBK4EtgS6BMIEyAR1AHUAdQB1AHUAdQCVANAEYABgAGAAYABgAGAAYABgANgEYADcBOQEYADsBPQE/AQEBQwFFAUcBSQFLAU0BWQEPAVEBUsFUwVbBWAAYgVgAGoFcgV6BYIFigWRBWAAmQWfBaYFYABgAGAAYABgAKoFYACxBbAFuQW6BcEFwQXHBcEFwQXPBdMF2wXjBeoF8gX6BQIGCgYSBhoGIgYqBjIGOgZgAD4GRgZMBmAAUwZaBmAAYABgAGAAYABgAGAAYABgAGAAYABgAGIGYABpBnAGYABgAGAAYABgAGAAYABgAGAAYAB4Bn8GhQZgAGAAYAB1AHcDFQSLBmAAYABgAJMGdQA9A3UAmwajBqsGqwaVALMGuwbDBjAAywbSBtIG1QbSBtIG0gbSBtIG0gbdBuMG6wbzBvsGAwcLBxMHAwcbByMHJwcsBywHMQcsB9IGOAdAB0gHTgfSBkgHVgfSBtIG0gbSBtIG0gbSBtIG0gbSBiwHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAdgAGAALAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAdbB2MHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsB2kH0gZwB64EdQB1AHUAdQB1AHUAdQB1AHUHfQdgAIUHjQd1AHUAlQedB2AAYAClB6sHYACzB7YHvgfGB3UAzgfWBzMB3gfmB1EB7gf1B/0HlQENAQUIDQh1ABUIHQglCBcDLQg1CD0IRQhNCEEDUwh1AHUAdQBbCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIcAh3CHoIMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIgggwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAALAcsBywHLAcsBywHLAcsBywHLAcsB4oILAcsB44I0gaWCJ4Ipgh1AHUAqgiyCHUAdQB1AHUAdQB1AHUAdQB1AHUAtwh8AXUAvwh1AMUIyQjRCNkI4AjoCHUAdQB1AO4I9gj+CAYJDgkTCS0HGwkjCYIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiAAIAAAAFAAYABgAGIAXwBgAHEAdQBFAJUAogCyAKAAYABgAEIA4ABGANMA4QDxAMEBDwE1AFwBLAE6AQEBUQF4QkhCmEKoQrhCgAHIQsAB0MLAAcABwAHAAeDC6ABoAHDCwMMAAcABwAHAAdDDGMMAAcAB6MM4wwjDWMNow3jDaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAEjDqABWw6bDqABpg6gAaABoAHcDvwOPA+gAaABfA/8DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DpcPAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcAB9cPKwkyCToJMAB1AHUAdQBCCUoJTQl1AFUJXAljCWcJawkwADAAMAAwAHMJdQB2CX4JdQCECYoJjgmWCXUAngkwAGAAYABxAHUApgn3A64JtAl1ALkJdQDACTAAMAAwADAAdQB1AHUAdQB1AHUAdQB1AHUAowYNBMUIMAAwADAAMADICcsJ0wnZCRUE4QkwAOkJ8An4CTAAMAB1AAAKvwh1AAgKDwoXCh8KdQAwACcKLgp1ADYKqAmICT4KRgowADAAdQB1AE4KMAB1AFYKdQBeCnUAZQowADAAMAAwADAAMAAwADAAMAAVBHUAbQowADAAdQC5CXUKMAAwAHwBxAijBogEMgF9CoQKiASMCpQKmgqIBKIKqgquCogEDQG2Cr4KxgrLCjAAMADTCtsKCgHjCusK8Qr5CgELMAAwADAAMAB1AIsECQsRC3UANAEZCzAAMAAwADAAMAB1ACELKQswAHUANAExCzkLdQBBC0kLMABRC1kLMAAwADAAMAAwADAAdQBhCzAAMAAwAGAAYABpC3ELdwt/CzAAMACHC4sLkwubC58Lpwt1AK4Ltgt1APsDMAAwADAAMAAwADAAMAAwAL4LwwvLC9IL1wvdCzAAMADlC+kL8Qv5C/8LSQswADAAMAAwADAAMAAwADAAMAAHDDAAMAAwADAAMAAODBYMHgx1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1ACYMMAAwADAAdQB1AHUALgx1AHUAdQB1AHUAdQA2DDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AD4MdQBGDHUAdQB1AHUAdQB1AEkMdQB1AHUAdQB1AFAMMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQBYDHUAdQB1AF8MMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUA+wMVBGcMMAAwAHwBbwx1AHcMfwyHDI8MMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAYABgAJcMMAAwADAAdQB1AJ8MlQClDDAAMACtDCwHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsB7UMLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AA0EMAC9DDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAsBywHLAcsBywHLAcsBywHLQcwAMEMyAwsBywHLAcsBywHLAcsBywHLAcsBywHzAwwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1ANQM2QzhDDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMABgAGAAYABgAGAAYABgAOkMYADxDGAA+AwADQYNYABhCWAAYAAODTAAMAAwADAAFg1gAGAAHg37AzAAMAAwADAAYABgACYNYAAsDTQNPA1gAEMNPg1LDWAAYABgAGAAYABgAGAAYABgAGAAUg1aDYsGVglhDV0NcQBnDW0NdQ15DWAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAlQCBDZUAiA2PDZcNMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAnw2nDTAAMAAwADAAMAAwAHUArw23DTAAMAAwADAAMAAwADAAMAAwADAAMAB1AL8NMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAB1AHUAdQB1AHUAdQDHDTAAYABgAM8NMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAA1w11ANwNMAAwAD0B5A0wADAAMAAwADAAMADsDfQN/A0EDgwOFA4wABsOMAAwADAAMAAwADAAMAAwANIG0gbSBtIG0gbSBtIG0gYjDigOwQUuDsEFMw7SBjoO0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGQg5KDlIOVg7SBtIGXg5lDm0OdQ7SBtIGfQ6EDooOjQ6UDtIGmg6hDtIG0gaoDqwO0ga0DrwO0gZgAGAAYADEDmAAYAAkBtIGzA5gANIOYADaDokO0gbSBt8O5w7SBu8O0gb1DvwO0gZgAGAAxA7SBtIG0gbSBtIGYABgAGAAYAAED2AAsAUMD9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGFA8sBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAccD9IGLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHJA8sBywHLAcsBywHLAccDywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywPLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAc0D9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAccD9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGFA8sBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHPA/SBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gYUD0QPlQCVAJUAMAAwADAAMACVAJUAlQCVAJUAlQCVAEwPMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAA//8EAAQABAAEAAQABAAEAAQABAANAAMAAQABAAIABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQACgATABcAHgAbABoAHgAXABYAEgAeABsAGAAPABgAHABLAEsASwBLAEsASwBLAEsASwBLABgAGAAeAB4AHgATAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQABYAGwASAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAWAA0AEQAeAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAFAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAJABYAGgAbABsAGwAeAB0AHQAeAE8AFwAeAA0AHgAeABoAGwBPAE8ADgBQAB0AHQAdAE8ATwAXAE8ATwBPABYAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAFAAUABQAFAAUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAB4AHgAeAFAATwBAAE8ATwBPAEAATwBQAFAATwBQAB4AHgAeAB4AHgAeAB0AHQAdAB0AHgAdAB4ADgBQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgBQAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAJAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAkACQAJAAkACQAJAAkABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAFAAHgAeAB4AKwArAFAAUABQAFAAGABQACsAKwArACsAHgAeAFAAHgBQAFAAUAArAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAUAAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAYAA0AKwArAB4AHgAbACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQADQAEAB4ABAAEAB4ABAAEABMABAArACsAKwArACsAKwArACsAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAKwArACsAKwBWAFYAVgBWAB4AHgArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AGgAaABoAGAAYAB4AHgAEAAQABAAEAAQABAAEAAQABAAEAAQAEwAEACsAEwATAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABLAEsASwBLAEsASwBLAEsASwBLABoAGQAZAB4AUABQAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQABMAUAAEAAQABAAEAAQABAAEAB4AHgAEAAQABAAEAAQABABQAFAABAAEAB4ABAAEAAQABABQAFAASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUAAeAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAFAABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQAUABQAB4AHgAYABMAUAArACsABAAbABsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAFAABAAEAAQABAAEAFAABAAEAAQAUAAEAAQABAAEAAQAKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAArACsAHgArAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAUAAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAABAAEAA0ADQBLAEsASwBLAEsASwBLAEsASwBLAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUAArACsAKwBQAFAAUABQACsAKwAEAFAABAAEAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABABQACsAKwArACsAKwArACsAKwAEACsAKwArACsAUABQACsAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAFAAUAAaABoAUABQAFAAUABQAEwAHgAbAFAAHgAEACsAKwAEAAQABAArAFAAUABQAFAAUABQACsAKwArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQACsAUABQACsAKwAEACsABAAEAAQABAAEACsAKwArACsABAAEACsAKwAEAAQABAArACsAKwAEACsAKwArACsAKwArACsAUABQAFAAUAArAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLAAQABABQAFAAUAAEAB4AKwArACsAKwArACsAKwArACsAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQACsAKwAEAFAABAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAArACsAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAB4AGwArACsAKwArACsAKwArAFAABAAEAAQABAAEAAQAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABAArACsAKwArACsAKwArAAQABAAEACsAKwArACsAUABQACsAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAB4AUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAAQAUAArAFAAUABQAFAAUABQACsAKwArAFAAUABQACsAUABQAFAAUAArACsAKwBQAFAAKwBQACsAUABQACsAKwArAFAAUAArACsAKwBQAFAAUAArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArAAQABAAEAAQABAArACsAKwAEAAQABAArAAQABAAEAAQAKwArAFAAKwArACsAKwArACsABAArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAHgAeAB4AHgAeAB4AGwAeACsAKwArACsAKwAEAAQABAAEAAQAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAUAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAAEACsAKwArACsAKwArACsABAAEACsAUABQAFAAKwArACsAKwArAFAAUAAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAKwAOAFAAUABQAFAAUABQAFAAHgBQAAQABAAEAA4AUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAKwArAAQAUAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAAEACsAKwArACsAKwArACsABAAEACsAKwArACsAKwArACsAUAArAFAAUAAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwBQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAFAABAAEAAQABAAEAAQABAArAAQABAAEACsABAAEAAQABABQAB4AKwArACsAKwBQAFAAUAAEAFAAUABQAFAAUABQAFAAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAFAAUABQAFAAUABQAFAAUABQABoAUABQAFAAUABQAFAAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQACsAUAArACsAUABQAFAAUABQAFAAUAArACsAKwAEACsAKwArACsABAAEAAQABAAEAAQAKwAEACsABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArAAQABAAeACsAKwArACsAKwArACsAKwArACsAKwArAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAAqAFwAXAAqACoAKgAqACoAKgAqACsAKwArACsAGwBcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAeAEsASwBLAEsASwBLAEsASwBLAEsADQANACsAKwArACsAKwBcAFwAKwBcACsAXABcAFwAXABcACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACsAXAArAFwAXABcAFwAXABcAFwAXABcAFwAKgBcAFwAKgAqACoAKgAqACoAKgAqACoAXAArACsAXABcAFwAXABcACsAXAArACoAKgAqACoAKgAqACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwBcAFwAXABcAFAADgAOAA4ADgAeAA4ADgAJAA4ADgANAAkAEwATABMAEwATAAkAHgATAB4AHgAeAAQABAAeAB4AHgAeAB4AHgBLAEsASwBLAEsASwBLAEsASwBLAFAAUABQAFAAUABQAFAAUABQAFAADQAEAB4ABAAeAAQAFgARABYAEQAEAAQAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQADQAEAAQABAAEAAQADQAEAAQAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArAA0ADQAeAB4AHgAeAB4AHgAEAB4AHgAeAB4AHgAeACsAHgAeAA4ADgANAA4AHgAeAB4AHgAeAAkACQArACsAKwArACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgBcAEsASwBLAEsASwBLAEsASwBLAEsADQANAB4AHgAeAB4AXABcAFwAXABcAFwAKgAqACoAKgBcAFwAXABcACoAKgAqAFwAKgAqACoAXABcACoAKgAqACoAKgAqACoAXABcAFwAKgAqACoAKgBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKgAqAFwAKgBLAEsASwBLAEsASwBLAEsASwBLACoAKgAqACoAKgAqAFAAUABQAFAAUABQACsAUAArACsAKwArACsAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgBQAFAAUABQAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUAArACsAUABQAFAAUABQAFAAUAArAFAAKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAKwBQACsAUABQAFAAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsABAAEAAQAHgANAB4AHgAeAB4AHgAeAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUAArACsADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAANAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAWABEAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAA0ADQANAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAANAA0AKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUAArAAQABAArACsAKwArACsAKwArACsAKwArACsAKwBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqAA0ADQAVAFwADQAeAA0AGwBcACoAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwAeAB4AEwATAA0ADQAOAB4AEwATAB4ABAAEAAQACQArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUAAEAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAHgArACsAKwATABMASwBLAEsASwBLAEsASwBLAEsASwBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAArACsAXABcAFwAXABcACsAKwArACsAKwArACsAKwArACsAKwBcAFwAXABcAFwAXABcAFwAXABcAFwAXAArACsAKwArAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAXAArACsAKwAqACoAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAArACsAHgAeAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKwAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKwArAAQASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArACoAKgAqACoAKgAqACoAXAAqACoAKgAqACoAKgArACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABABQAFAAUABQAFAAUABQACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwANAA0AHgANAA0ADQANAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAEAAQAHgAeAB4AHgAeAB4AHgAeAB4AKwArACsABAAEAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwAeAB4AHgAeAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArAA0ADQANAA0ADQBLAEsASwBLAEsASwBLAEsASwBLACsAKwArAFAAUABQAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAA0ADQBQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUAAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArAAQABAAEAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAAQAUABQAFAAUABQAFAABABQAFAABAAEAAQAUAArACsAKwArACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsABAAEAAQABAAEAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAKwBQACsAUAArAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgBQAB4AHgAeAFAAUABQACsAHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQACsAKwAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQACsAHgAeAB4AHgAeAB4AHgAOAB4AKwANAA0ADQANAA0ADQANAAkADQANAA0ACAAEAAsABAAEAA0ACQANAA0ADAAdAB0AHgAXABcAFgAXABcAFwAWABcAHQAdAB4AHgAUABQAFAANAAEAAQAEAAQABAAEAAQACQAaABoAGgAaABoAGgAaABoAHgAXABcAHQAVABUAHgAeAB4AHgAeAB4AGAAWABEAFQAVABUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ADQAeAA0ADQANAA0AHgANAA0ADQAHAB4AHgAeAB4AKwAEAAQABAAEAAQABAAEAAQABAAEAFAAUAArACsATwBQAFAAUABQAFAAHgAeAB4AFgARAE8AUABPAE8ATwBPAFAAUABQAFAAUAAeAB4AHgAWABEAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArABsAGwAbABsAGwAbABsAGgAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGgAbABsAGwAbABoAGwAbABoAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAHgAeAFAAGgAeAB0AHgBQAB4AGgAeAB4AHgAeAB4AHgAeAB4AHgBPAB4AUAAbAB4AHgBQAFAAUABQAFAAHgAeAB4AHQAdAB4AUAAeAFAAHgBQAB4AUABPAFAAUAAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAHgBQAFAAUABQAE8ATwBQAFAAUABQAFAATwBQAFAATwBQAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAFAAUABQAFAATwBPAE8ATwBPAE8ATwBPAE8ATwBQAFAAUABQAFAAUABQAFAAUAAeAB4AUABQAFAAUABPAB4AHgArACsAKwArAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB4AHQAdAB4AHgAeAB0AHQAeAB4AHQAeAB4AHgAdAB4AHQAbABsAHgAdAB4AHgAeAB4AHQAeAB4AHQAdAB0AHQAeAB4AHQAeAB0AHgAdAB0AHQAdAB0AHQAeAB0AHgAeAB4AHgAeAB0AHQAdAB0AHgAeAB4AHgAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB4AHgAeAB0AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHgAeAB0AHQAdAB0AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAeAB4AHgAdAB4AHgAeAB4AHgAeAB4AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABYAEQAWABEAHgAeAB4AHgAeAB4AHQAeAB4AHgAeAB4AHgAeACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAWABEAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAFAAHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAeAB4AHQAdAB0AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHQAdAB4AHgAeAB4AHQAdAB0AHgAeAB0AHgAeAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlAB4AHQAdAB4AHgAdAB4AHgAeAB4AHQAdAB4AHgAeAB4AJQAlAB0AHQAlAB4AJQAlACUAIAAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAeAB4AHgAeAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHgAdAB0AHQAeAB0AJQAdAB0AHgAdAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAdAB0AHQAdACUAHgAlACUAJQAdACUAJQAdAB0AHQAlACUAHQAdACUAHQAdACUAJQAlAB4AHQAeAB4AHgAeAB0AHQAlAB0AHQAdAB0AHQAdACUAJQAlACUAJQAdACUAJQAgACUAHQAdACUAJQAlACUAJQAlACUAJQAeAB4AHgAlACUAIAAgACAAIAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AFwAXABcAFwAXABcAHgATABMAJQAeAB4AHgAWABEAFgARABYAEQAWABEAFgARABYAEQAWABEATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABYAEQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAWABEAFgARABYAEQAWABEAFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFgARABYAEQAWABEAFgARABYAEQAWABEAFgARABYAEQAWABEAFgARABYAEQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAWABEAFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAEAAQABAAeAB4AKwArACsAKwArABMADQANAA0AUAATAA0AUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAUAANACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAA0ADQANAA0ADQANAA0ADQAeAA0AFgANAB4AHgAXABcAHgAeABcAFwAWABEAFgARABYAEQAWABEADQANAA0ADQATAFAADQANAB4ADQANAB4AHgAeAB4AHgAMAAwADQANAA0AHgANAA0AFgANAA0ADQANAA0ADQANAA0AHgANAB4ADQANAB4AHgAeACsAKwArACsAKwArACsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwArACsAKwArACsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArAA0AEQARACUAJQBHAFcAVwAWABEAFgARABYAEQAWABEAFgARACUAJQAWABEAFgARABYAEQAWABEAFQAWABEAEQAlAFcAVwBXAFcAVwBXAFcAVwBXAAQABAAEAAQABAAEACUAVwBXAFcAVwA2ACUAJQBXAFcAVwBHAEcAJQAlACUAKwBRAFcAUQBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFEAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBRAFcAUQBXAFEAVwBXAFcAVwBXAFcAUQBXAFcAVwBXAFcAVwBRAFEAKwArAAQABAAVABUARwBHAFcAFQBRAFcAUQBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBRAFcAVwBXAFcAVwBXAFEAUQBXAFcAVwBXABUAUQBHAEcAVwArACsAKwArACsAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwAlACUAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACsAKwArACsAKwArACsAKwArACsAKwArAFEAUQBRAFEAUQBRAFEAUQBRAFEAUQBRAFEAUQBRAFEAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBPAE8ATwBPAE8ATwBPAE8AJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQAlAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAEcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAADQATAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABLAEsASwBLAEsASwBLAEsASwBLAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAABAAEAAQABAAeAAQABAAEAAQABAAEAAQABAAEAAQAHgBQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUABQAAQABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAeAA0ADQANAA0ADQArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAB4AHgAeAB4AHgAeAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAHgAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAeAB4AUABQAFAAUABQAFAAUABQAFAAUABQAAQAUABQAFAABABQAFAAUABQAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAeAB4AHgAeAAQAKwArACsAUABQAFAAUABQAFAAHgAeABoAHgArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAADgAOABMAEwArACsAKwArACsAKwArACsABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwANAA0ASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAFAAUAAeAB4AHgBQAA4AUABQAAQAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAA0ADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArAB4AWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYACsAKwArAAQAHgAeAB4AHgAeAB4ADQANAA0AHgAeAB4AHgArAFAASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArAB4AHgBcAFwAXABcAFwAKgBcAFwAXABcAFwAXABcAFwAXABcAEsASwBLAEsASwBLAEsASwBLAEsAXABcAFwAXABcACsAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArAFAAUABQAAQAUABQAFAAUABQAFAAUABQAAQABAArACsASwBLAEsASwBLAEsASwBLAEsASwArACsAHgANAA0ADQBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKgAqACoAXAAqACoAKgBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAAqAFwAKgAqACoAXABcACoAKgBcAFwAXABcAFwAKgAqAFwAKgBcACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFwAXABcACoAKgBQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAA0ADQBQAFAAUAAEAAQAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUAArACsAUABQAFAAUABQAFAAKwArAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQADQAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAVABVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBUAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVACsAKwArACsAKwArACsAKwArACsAKwArAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAKwArACsAKwBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAKwArACsAKwAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAKwArACsAKwArAFYABABWAFYAVgBWAFYAVgBWAFYAVgBWAB4AVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgArAFYAVgBWAFYAVgArAFYAKwBWAFYAKwBWAFYAKwBWAFYAVgBWAFYAVgBWAFYAVgBWAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAEQAWAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAaAB4AKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAGAARABEAGAAYABMAEwAWABEAFAArACsAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACUAJQAlACUAJQAWABEAFgARABYAEQAWABEAFgARABYAEQAlACUAFgARACUAJQAlACUAJQAlACUAEQAlABEAKwAVABUAEwATACUAFgARABYAEQAWABEAJQAlACUAJQAlACUAJQAlACsAJQAbABoAJQArACsAKwArAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAcAKwATACUAJQAbABoAJQAlABYAEQAlACUAEQAlABEAJQBXAFcAVwBXAFcAVwBXAFcAVwBXABUAFQAlACUAJQATACUAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXABYAJQARACUAJQAlAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAWACUAEQAlABYAEQARABYAEQARABUAVwBRAFEAUQBRAFEAUQBRAFEAUQBRAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAEcARwArACsAVwBXAFcAVwBXAFcAKwArAFcAVwBXAFcAVwBXACsAKwBXAFcAVwBXAFcAVwArACsAVwBXAFcAKwArACsAGgAbACUAJQAlABsAGwArAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwAEAAQABAAQAB0AKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsADQANAA0AKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAB4AHgAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAAQAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAA0AUABQAFAAUAArACsAKwArAFAAUABQAFAAUABQAFAAUAANAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwAeACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAKwArAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUAArACsAKwBQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwANAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAB4AUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAUABQAFAAUABQAAQABAAEACsABAAEACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAKwBQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEACsAKwArACsABABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAA0ADQANAA0ADQANAA0ADQAeACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAArACsAKwArAFAAUABQAFAAUAANAA0ADQANAA0ADQAUACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsADQANAA0ADQANAA0ADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAAQABAAEAAQAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArAAQABAANACsAKwBQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAB4AHgAeAB4AHgArACsAKwArACsAKwAEAAQABAAEAAQABAAEAA0ADQAeAB4AHgAeAB4AKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgANAA0ADQANACsAKwArACsAKwArACsAKwArACsAKwAeACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsASwBLAEsASwBLAEsASwBLAEsASwANAA0ADQANAFAABAAEAFAAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAeAA4AUAArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAADQANAB4ADQAEAAQABAAEAB4ABAAEAEsASwBLAEsASwBLAEsASwBLAEsAUAAOAFAADQANAA0AKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAANAA0AHgANAA0AHgAEACsAUABQAFAAUABQAFAAUAArAFAAKwBQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAA0AKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsABAAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQACsABAAEAFAABAAEAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABAArACsAUAArACsAKwArACsAKwAEACsAKwArACsAKwBQAFAAUABQAFAABAAEACsAKwAEAAQABAAEAAQABAAEACsAKwArAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwArACsABAAEAAQABAAEAAQABABQAFAAUABQAA0ADQANAA0AHgBLAEsASwBLAEsASwBLAEsASwBLAA0ADQArAB4ABABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAFAAUAAeAFAAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAArACsABAAEAAQABAAEAAQABAAEAAQADgANAA0AEwATAB4AHgAeAA0ADQANAA0ADQANAA0ADQANAA0ADQANAA0ADQANAFAAUABQAFAABAAEACsAKwAEAA0ADQAeAFAAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKwArACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBcAFwADQANAA0AKgBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAKwArAFAAKwArAFAAUABQAFAAUABQAFAAUAArAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQAKwAEAAQAKwArAAQABAAEAAQAUAAEAFAABAAEAA0ADQANACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAArACsABAAEAAQABAAEAAQABABQAA4AUAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAFAABAAEAAQABAAOAB4ADQANAA0ADQAOAB4ABAArACsAKwArACsAKwArACsAUAAEAAQABAAEAAQABAAEAAQABAAEAAQAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAA0ADQANAFAADgAOAA4ADQANACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEACsABAAEAAQABAAEAAQABAAEAFAADQANAA0ADQANACsAKwArACsAKwArACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwAOABMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAArACsAKwAEACsABAAEACsABAAEAAQABAAEAAQABABQAAQAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAKwBQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQAKwAEAAQAKwAEAAQABAAEAAQAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAaABoAGgAaAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsADQANAA0ADQANACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAASABIAEgAQwBDAEMAUABQAFAAUABDAFAAUABQAEgAQwBIAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAASABDAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwAJAAkACQAJAAkACQAJABYAEQArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABIAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwANAA0AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEAAQABAANACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAA0ADQANAB4AHgAeAB4AHgAeAFAAUABQAFAADQAeACsAKwArACsAKwArACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAANAA0AHgAeACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwAEAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAARwBHABUARwAJACsAKwArACsAKwArACsAKwArACsAKwAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACsAKwArACsAKwArACsAKwBXAFcAVwBXAFcAVwBXAFcAVwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUQBRAFEAKwArACsAKwArACsAKwArACsAKwArACsAKwBRAFEAUQBRACsAKwArACsAKwArACsAKwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArACsAHgAEAAQADQAEAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArAB4AHgAeAB4AHgAeAB4AKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAAQABAAEAAQABAAeAB4AHgAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAB4AHgAEAAQABAAEAAQABAAEAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQAHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwBQAFAAKwArAFAAKwArAFAAUAArACsAUABQAFAAUAArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAUAArAFAAUABQAFAAUABQAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAHgAeAFAAUABQAFAAUAArAFAAKwArACsAUABQAFAAUABQAFAAUAArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeACsAKwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4ABAAeAB4AHgAeAB4AHgAeAB4AHgAeAAQAHgAeAA0ADQANAA0AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAAQAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArAAQABAAEAAQABAAEAAQAKwAEAAQAKwAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwBQAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArABsAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArAB4AHgAeAB4ABAAEAAQABAAEAAQABABQACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArABYAFgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAGgBQAFAAUAAaAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAKwBQACsAKwBQACsAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwBQACsAUAArACsAKwArACsAKwBQACsAKwArACsAUAArAFAAKwBQACsAUABQAFAAKwBQAFAAKwBQACsAKwBQACsAUAArAFAAKwBQACsAUAArAFAAUAArAFAAKwArAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUAArAFAAUABQAFAAKwBQACsAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAUABQAFAAKwBQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8AJQAlACUAHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB4AHgAeACUAJQAlAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlAB4AHgAlACUAJQAlACUAHgAlACUAJQAlACUAIAAgACAAJQAlACAAJQAlACAAIAAgACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACEAIQAhACEAIQAlACUAIAAgACUAJQAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlACUAIAAlACUAJQAlACAAIAAgACUAIAAgACAAJQAlACUAJQAlACUAJQAgACUAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAlAB4AJQAeACUAJQAlACUAJQAgACUAJQAlACUAHgAlAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAgACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACAAIAAgACUAJQAlACAAIAAgACAAIAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABcAFwAXABUAFQAVAB4AHgAeAB4AJQAlACUAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAgACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAgACUAJQAgACUAJQAlACUAJQAlACUAJQAgACAAIAAgACAAIAAgACAAJQAlACUAJQAlACUAIAAlACUAJQAlACUAJQAlACUAJQAgACAAIAAgACAAIAAgACAAIAAgACUAJQAgACAAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAgACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAlACAAIAAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAgACAAIAAlACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwArAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACUAVwBXACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAA==",Xc=50,sv=1,vh=2,Ch=3,rv=4,iv=5,$c=7,bh=8,Yc=9,SA=10,ha=11,Jc=12,fa=13,ov=14,zn=15,ga=16,sr=17,Dn=18,av=19,jc=20,ma=21,Nn=22,mo=23,jA=24,Be=25,qn=26,Xn=27,ZA=28,lv=29,OA=30,cv=31,rr=32,ir=33,pa=34,Ba=35,wa=36,Hs=37,va=38,Nr=39,Rr=40,po=41,yh=42,dv=43,uv=[9001,65288],Sh="!",pt="",or="",Ca=tv(nv),eA=[OA,wa],ba=[sv,vh,Ch,iv],Eh=[SA,bh],Zc=[Xn,qn],hv=ba.concat(Eh),td=[va,Nr,Rr,pa,Ba],fv=[zn,fa],gv=function(A,t){t===void 0&&(t="strict");var e=[],n=[],s=[];return A.forEach(function(r,i){var o=Ca.get(r);if(o>Xc?(s.push(!0),o-=Xc):s.push(!1),["normal","auto","loose"].indexOf(t)!==-1&&[8208,8211,12316,12448].indexOf(r)!==-1)return n.push(i),e.push(ga);if(o===rv||o===ha){if(i===0)return n.push(i),e.push(OA);var a=e[i-1];return hv.indexOf(a)===-1?(n.push(n[i-1]),e.push(a)):(n.push(i),e.push(OA))}if(n.push(i),o===cv)return e.push(t==="strict"?ma:Hs);if(o===yh||o===lv)return e.push(OA);if(o===dv)return r>=131072&&r<=196605||r>=196608&&r<=262141?e.push(Hs):e.push(OA);e.push(o)}),[n,e,s]},Bo=function(A,t,e,n){var s=n[e];if(Array.isArray(A)?A.indexOf(s)!==-1:A===s)for(var r=e;r<=n.length;){r++;var i=n[r];if(i===t)return!0;if(i!==SA)break}if(s===SA)for(var r=e;r>0;){r--;var o=n[r];if(Array.isArray(A)?A.indexOf(o)!==-1:A===o)for(var a=e;a<=n.length;){a++;var i=n[a];if(i===t)return!0;if(i!==SA)break}if(o!==SA)break}return!1},ed=function(A,t){for(var e=A;e>=0;){var n=t[e];if(n===SA)e--;else return n}return 0},mv=function(A,t,e,n,s){if(e[n]===0)return pt;var r=n-1;if(Array.isArray(s)&&s[r]===!0)return pt;var i=r-1,o=r+1,a=t[r],l=i>=0?t[i]:0,d=t[o];if(a===vh&&d===Ch)return pt;if(ba.indexOf(a)!==-1)return Sh;if(ba.indexOf(d)!==-1||Eh.indexOf(d)!==-1)return pt;if(ed(r,t)===bh)return or;if(Ca.get(A[r])===ha||(a===rr||a===ir)&&Ca.get(A[o])===ha||a===$c||d===$c||a===Yc||[SA,fa,zn].indexOf(a)===-1&&d===Yc||[sr,Dn,av,jA,ZA].indexOf(d)!==-1||ed(r,t)===Nn||Bo(mo,Nn,r,t)||Bo([sr,Dn],ma,r,t)||Bo(Jc,Jc,r,t))return pt;if(a===SA)return or;if(a===mo||d===mo)return pt;if(d===ga||a===ga)return or;if([fa,zn,ma].indexOf(d)!==-1||a===ov||l===wa&&fv.indexOf(a)!==-1||a===ZA&&d===wa||d===jc||eA.indexOf(d)!==-1&&a===Be||eA.indexOf(a)!==-1&&d===Be||a===Xn&&[Hs,rr,ir].indexOf(d)!==-1||[Hs,rr,ir].indexOf(a)!==-1&&d===qn||eA.indexOf(a)!==-1&&Zc.indexOf(d)!==-1||Zc.indexOf(a)!==-1&&eA.indexOf(d)!==-1||[Xn,qn].indexOf(a)!==-1&&(d===Be||[Nn,zn].indexOf(d)!==-1&&t[o+1]===Be)||[Nn,zn].indexOf(a)!==-1&&d===Be||a===Be&&[Be,ZA,jA].indexOf(d)!==-1)return pt;if([Be,ZA,jA,sr,Dn].indexOf(d)!==-1)for(var u=r;u>=0;){var h=t[u];if(h===Be)return pt;if([ZA,jA].indexOf(h)!==-1)u--;else break}if([Xn,qn].indexOf(d)!==-1)for(var u=[sr,Dn].indexOf(a)!==-1?i:r;u>=0;){var h=t[u];if(h===Be)return pt;if([ZA,jA].indexOf(h)!==-1)u--;else break}if(va===a&&[va,Nr,pa,Ba].indexOf(d)!==-1||[Nr,pa].indexOf(a)!==-1&&[Nr,Rr].indexOf(d)!==-1||[Rr,Ba].indexOf(a)!==-1&&d===Rr||td.indexOf(a)!==-1&&[jc,qn].indexOf(d)!==-1||td.indexOf(d)!==-1&&a===Xn||eA.indexOf(a)!==-1&&eA.indexOf(d)!==-1||a===jA&&eA.indexOf(d)!==-1||eA.concat(Be).indexOf(a)!==-1&&d===Nn&&uv.indexOf(A[o])===-1||eA.concat(Be).indexOf(d)!==-1&&a===Dn)return pt;if(a===po&&d===po){for(var m=e[r],f=1;m>0&&(m--,t[m]===po);)f++;if(f%2!==0)return pt}return a===rr&&d===ir?pt:or},pv=function(A,t){t||(t={lineBreak:"normal",wordBreak:"normal"});var e=gv(A,t.lineBreak),n=e[0],s=e[1],r=e[2];(t.wordBreak==="break-all"||t.wordBreak==="break-word")&&(s=s.map(function(o){return[Be,OA,yh].indexOf(o)!==-1?Hs:o}));var i=t.wordBreak==="keep-all"?r.map(function(o,a){return o&&A[a]>=19968&&A[a]<=40959}):void 0;return[n,s,i]},Bv=(function(){function A(t,e,n,s){this.codePoints=t,this.required=e===Sh,this.start=n,this.end=s}return A.prototype.slice=function(){return Lt.apply(void 0,this.codePoints.slice(this.start,this.end))},A})(),wv=function(A,t){var e=Ti(A),n=pv(e,t),s=n[0],r=n[1],i=n[2],o=e.length,a=0,l=0;return{next:function(){if(l>=o)return{done:!0,value:null};for(var d=pt;l<o&&(d=mv(e,r,s,++l,i))===pt;);if(d!==pt||l===o){var u=new Bv(e,d,a,l);return a=l,{value:u,done:!1}}return{done:!0,value:null}}}},vv=1,Cv=2,Ws=4,Ad=8,ri=10,nd=47,us=92,bv=9,yv=32,ar=34,Rn=61,Sv=35,Ev=36,Qv=37,lr=39,cr=40,kn=41,Fv=95,le=45,Iv=33,xv=60,Uv=62,Mv=64,Tv=91,Pv=93,Lv=61,Hv=123,dr=63,Dv=125,sd=124,Nv=126,Rv=128,rd=65533,wo=42,GA=43,kv=44,_v=58,Ov=59,Ds=46,Kv=0,Gv=8,Wv=11,Vv=14,zv=31,qv=127,_e=-1,Qh=48,Fh=97,Ih=101,Xv=102,$v=117,Yv=122,xh=65,Uh=69,Mh=70,Jv=85,jv=90,Ae=function(A){return A>=Qh&&A<=57},Zv=function(A){return A>=55296&&A<=57343},tn=function(A){return Ae(A)||A>=xh&&A<=Mh||A>=Fh&&A<=Xv},t2=function(A){return A>=Fh&&A<=Yv},e2=function(A){return A>=xh&&A<=jv},A2=function(A){return t2(A)||e2(A)},n2=function(A){return A>=Rv},ur=function(A){return A===ri||A===bv||A===yv},ii=function(A){return A2(A)||n2(A)||A===Fv},id=function(A){return ii(A)||Ae(A)||A===le},s2=function(A){return A>=Kv&&A<=Gv||A===Wv||A>=Vv&&A<=zv||A===qv},wA=function(A,t){return A!==us?!1:t!==ri},hr=function(A,t,e){return A===le?ii(t)||wA(t,e):ii(A)?!0:!!(A===us&&wA(A,t))},vo=function(A,t,e){return A===GA||A===le?Ae(t)?!0:t===Ds&&Ae(e):Ae(A===Ds?t:A)},r2=function(A){var t=0,e=1;(A[t]===GA||A[t]===le)&&(A[t]===le&&(e=-1),t++);for(var n=[];Ae(A[t]);)n.push(A[t++]);var s=n.length?parseInt(Lt.apply(void 0,n),10):0;A[t]===Ds&&t++;for(var r=[];Ae(A[t]);)r.push(A[t++]);var i=r.length,o=i?parseInt(Lt.apply(void 0,r),10):0;(A[t]===Uh||A[t]===Ih)&&t++;var a=1;(A[t]===GA||A[t]===le)&&(A[t]===le&&(a=-1),t++);for(var l=[];Ae(A[t]);)l.push(A[t++]);var d=l.length?parseInt(Lt.apply(void 0,l),10):0;return e*(s+o*Math.pow(10,-i))*Math.pow(10,a*d)},i2={type:2},o2={type:3},a2={type:4},l2={type:13},c2={type:8},d2={type:21},u2={type:9},h2={type:10},f2={type:11},g2={type:12},m2={type:14},fr={type:23},p2={type:1},B2={type:25},w2={type:24},v2={type:26},C2={type:27},b2={type:28},y2={type:29},S2={type:31},ya={type:32},Th=(function(){function A(){this._value=[]}return A.prototype.write=function(t){this._value=this._value.concat(Ti(t))},A.prototype.read=function(){for(var t=[],e=this.consumeToken();e!==ya;)t.push(e),e=this.consumeToken();return t},A.prototype.consumeToken=function(){var t=this.consumeCodePoint();switch(t){case ar:return this.consumeStringToken(ar);case Sv:var e=this.peekCodePoint(0),n=this.peekCodePoint(1),s=this.peekCodePoint(2);if(id(e)||wA(n,s)){var r=hr(e,n,s)?Cv:vv,i=this.consumeName();return{type:5,value:i,flags:r}}break;case Ev:if(this.peekCodePoint(0)===Rn)return this.consumeCodePoint(),l2;break;case lr:return this.consumeStringToken(lr);case cr:return i2;case kn:return o2;case wo:if(this.peekCodePoint(0)===Rn)return this.consumeCodePoint(),m2;break;case GA:if(vo(t,this.peekCodePoint(0),this.peekCodePoint(1)))return this.reconsumeCodePoint(t),this.consumeNumericToken();break;case kv:return a2;case le:var o=t,a=this.peekCodePoint(0),l=this.peekCodePoint(1);if(vo(o,a,l))return this.reconsumeCodePoint(t),this.consumeNumericToken();if(hr(o,a,l))return this.reconsumeCodePoint(t),this.consumeIdentLikeToken();if(a===le&&l===Uv)return this.consumeCodePoint(),this.consumeCodePoint(),w2;break;case Ds:if(vo(t,this.peekCodePoint(0),this.peekCodePoint(1)))return this.reconsumeCodePoint(t),this.consumeNumericToken();break;case nd:if(this.peekCodePoint(0)===wo)for(this.consumeCodePoint();;){var d=this.consumeCodePoint();if(d===wo&&(d=this.consumeCodePoint(),d===nd))return this.consumeToken();if(d===_e)return this.consumeToken()}break;case _v:return v2;case Ov:return C2;case xv:if(this.peekCodePoint(0)===Iv&&this.peekCodePoint(1)===le&&this.peekCodePoint(2)===le)return this.consumeCodePoint(),this.consumeCodePoint(),B2;break;case Mv:var u=this.peekCodePoint(0),h=this.peekCodePoint(1),m=this.peekCodePoint(2);if(hr(u,h,m)){var i=this.consumeName();return{type:7,value:i}}break;case Tv:return b2;case us:if(wA(t,this.peekCodePoint(0)))return this.reconsumeCodePoint(t),this.consumeIdentLikeToken();break;case Pv:return y2;case Lv:if(this.peekCodePoint(0)===Rn)return this.consumeCodePoint(),c2;break;case Hv:return f2;case Dv:return g2;case $v:case Jv:var f=this.peekCodePoint(0),g=this.peekCodePoint(1);return f===GA&&(tn(g)||g===dr)&&(this.consumeCodePoint(),this.consumeUnicodeRangeToken()),this.reconsumeCodePoint(t),this.consumeIdentLikeToken();case sd:if(this.peekCodePoint(0)===Rn)return this.consumeCodePoint(),u2;if(this.peekCodePoint(0)===sd)return this.consumeCodePoint(),d2;break;case Nv:if(this.peekCodePoint(0)===Rn)return this.consumeCodePoint(),h2;break;case _e:return ya}return ur(t)?(this.consumeWhiteSpace(),S2):Ae(t)?(this.reconsumeCodePoint(t),this.consumeNumericToken()):ii(t)?(this.reconsumeCodePoint(t),this.consumeIdentLikeToken()):{type:6,value:Lt(t)}},A.prototype.consumeCodePoint=function(){var t=this._value.shift();return typeof t>"u"?-1:t},A.prototype.reconsumeCodePoint=function(t){this._value.unshift(t)},A.prototype.peekCodePoint=function(t){return t>=this._value.length?-1:this._value[t]},A.prototype.consumeUnicodeRangeToken=function(){for(var t=[],e=this.consumeCodePoint();tn(e)&&t.length<6;)t.push(e),e=this.consumeCodePoint();for(var n=!1;e===dr&&t.length<6;)t.push(e),e=this.consumeCodePoint(),n=!0;if(n){var s=parseInt(Lt.apply(void 0,t.map(function(a){return a===dr?Qh:a})),16),r=parseInt(Lt.apply(void 0,t.map(function(a){return a===dr?Mh:a})),16);return{type:30,start:s,end:r}}var i=parseInt(Lt.apply(void 0,t),16);if(this.peekCodePoint(0)===le&&tn(this.peekCodePoint(1))){this.consumeCodePoint(),e=this.consumeCodePoint();for(var o=[];tn(e)&&o.length<6;)o.push(e),e=this.consumeCodePoint();var r=parseInt(Lt.apply(void 0,o),16);return{type:30,start:i,end:r}}else return{type:30,start:i,end:i}},A.prototype.consumeIdentLikeToken=function(){var t=this.consumeName();return t.toLowerCase()==="url"&&this.peekCodePoint(0)===cr?(this.consumeCodePoint(),this.consumeUrlToken()):this.peekCodePoint(0)===cr?(this.consumeCodePoint(),{type:19,value:t}):{type:20,value:t}},A.prototype.consumeUrlToken=function(){var t=[];if(this.consumeWhiteSpace(),this.peekCodePoint(0)===_e)return{type:22,value:""};var e=this.peekCodePoint(0);if(e===lr||e===ar){var n=this.consumeStringToken(this.consumeCodePoint());return n.type===0&&(this.consumeWhiteSpace(),this.peekCodePoint(0)===_e||this.peekCodePoint(0)===kn)?(this.consumeCodePoint(),{type:22,value:n.value}):(this.consumeBadUrlRemnants(),fr)}for(;;){var s=this.consumeCodePoint();if(s===_e||s===kn)return{type:22,value:Lt.apply(void 0,t)};if(ur(s))return this.consumeWhiteSpace(),this.peekCodePoint(0)===_e||this.peekCodePoint(0)===kn?(this.consumeCodePoint(),{type:22,value:Lt.apply(void 0,t)}):(this.consumeBadUrlRemnants(),fr);if(s===ar||s===lr||s===cr||s2(s))return this.consumeBadUrlRemnants(),fr;if(s===us)if(wA(s,this.peekCodePoint(0)))t.push(this.consumeEscapedCodePoint());else return this.consumeBadUrlRemnants(),fr;else t.push(s)}},A.prototype.consumeWhiteSpace=function(){for(;ur(this.peekCodePoint(0));)this.consumeCodePoint()},A.prototype.consumeBadUrlRemnants=function(){for(;;){var t=this.consumeCodePoint();if(t===kn||t===_e)return;wA(t,this.peekCodePoint(0))&&this.consumeEscapedCodePoint()}},A.prototype.consumeStringSlice=function(t){for(var e=5e4,n="";t>0;){var s=Math.min(e,t);n+=Lt.apply(void 0,this._value.splice(0,s)),t-=s}return this._value.shift(),n},A.prototype.consumeStringToken=function(t){var e="",n=0;do{var s=this._value[n];if(s===_e||s===void 0||s===t)return e+=this.consumeStringSlice(n),{type:0,value:e};if(s===ri)return this._value.splice(0,n),p2;if(s===us){var r=this._value[n+1];r!==_e&&r!==void 0&&(r===ri?(e+=this.consumeStringSlice(n),n=-1,this._value.shift()):wA(s,r)&&(e+=this.consumeStringSlice(n),e+=Lt(this.consumeEscapedCodePoint()),n=-1))}n++}while(!0)},A.prototype.consumeNumber=function(){var t=[],e=Ws,n=this.peekCodePoint(0);for((n===GA||n===le)&&t.push(this.consumeCodePoint());Ae(this.peekCodePoint(0));)t.push(this.consumeCodePoint());n=this.peekCodePoint(0);var s=this.peekCodePoint(1);if(n===Ds&&Ae(s))for(t.push(this.consumeCodePoint(),this.consumeCodePoint()),e=Ad;Ae(this.peekCodePoint(0));)t.push(this.consumeCodePoint());n=this.peekCodePoint(0),s=this.peekCodePoint(1);var r=this.peekCodePoint(2);if((n===Uh||n===Ih)&&((s===GA||s===le)&&Ae(r)||Ae(s)))for(t.push(this.consumeCodePoint(),this.consumeCodePoint()),e=Ad;Ae(this.peekCodePoint(0));)t.push(this.consumeCodePoint());return[r2(t),e]},A.prototype.consumeNumericToken=function(){var t=this.consumeNumber(),e=t[0],n=t[1],s=this.peekCodePoint(0),r=this.peekCodePoint(1),i=this.peekCodePoint(2);if(hr(s,r,i)){var o=this.consumeName();return{type:15,number:e,flags:n,unit:o}}return s===Qv?(this.consumeCodePoint(),{type:16,number:e,flags:n}):{type:17,number:e,flags:n}},A.prototype.consumeEscapedCodePoint=function(){var t=this.consumeCodePoint();if(tn(t)){for(var e=Lt(t);tn(this.peekCodePoint(0))&&e.length<6;)e+=Lt(this.consumeCodePoint());ur(this.peekCodePoint(0))&&this.consumeCodePoint();var n=parseInt(e,16);return n===0||Zv(n)||n>1114111?rd:n}return t===_e?rd:t},A.prototype.consumeName=function(){for(var t="";;){var e=this.consumeCodePoint();if(id(e))t+=Lt(e);else if(wA(e,this.peekCodePoint(0)))t+=Lt(this.consumeEscapedCodePoint());else return this.reconsumeCodePoint(e),t}},A})(),Ph=(function(){function A(t){this._tokens=t}return A.create=function(t){var e=new Th;return e.write(t),new A(e.read())},A.parseValue=function(t){return A.create(t).parseComponentValue()},A.parseValues=function(t){return A.create(t).parseComponentValues()},A.prototype.parseComponentValue=function(){for(var t=this.consumeToken();t.type===31;)t=this.consumeToken();if(t.type===32)throw new SyntaxError("Error parsing CSS component value, unexpected EOF");this.reconsumeToken(t);var e=this.consumeComponentValue();do t=this.consumeToken();while(t.type===31);if(t.type===32)return e;throw new SyntaxError("Error parsing CSS component value, multiple values found when expecting only one")},A.prototype.parseComponentValues=function(){for(var t=[];;){var e=this.consumeComponentValue();if(e.type===32)return t;t.push(e),t.push()}},A.prototype.consumeComponentValue=function(){var t=this.consumeToken();switch(t.type){case 11:case 28:case 2:return this.consumeSimpleBlock(t.type);case 19:return this.consumeFunction(t)}return t},A.prototype.consumeSimpleBlock=function(t){for(var e={type:t,values:[]},n=this.consumeToken();;){if(n.type===32||Q2(n,t))return e;this.reconsumeToken(n),e.values.push(this.consumeComponentValue()),n=this.consumeToken()}},A.prototype.consumeFunction=function(t){for(var e={name:t.value,values:[],type:18};;){var n=this.consumeToken();if(n.type===32||n.type===3)return e;this.reconsumeToken(n),e.values.push(this.consumeComponentValue())}},A.prototype.consumeToken=function(){var t=this._tokens.shift();return typeof t>"u"?ya:t},A.prototype.reconsumeToken=function(t){this._tokens.unshift(t)},A})(),Vs=function(A){return A.type===15},Ln=function(A){return A.type===17},Qt=function(A){return A.type===20},E2=function(A){return A.type===0},Sa=function(A,t){return Qt(A)&&A.value===t},Lh=function(A){return A.type!==31},xn=function(A){return A.type!==31&&A.type!==4},je=function(A){var t=[],e=[];return A.forEach(function(n){if(n.type===4){if(e.length===0)throw new Error("Error parsing function args, zero tokens for arg");t.push(e),e=[];return}n.type!==31&&e.push(n)}),e.length&&t.push(e),t},Q2=function(A,t){return t===11&&A.type===12||t===28&&A.type===29?!0:t===2&&A.type===3},LA=function(A){return A.type===17||A.type===15},Nt=function(A){return A.type===16||LA(A)},Hh=function(A){return A.length>1?[A[0],A[1]]:[A[0]]},Jt={type:17,number:0,flags:Ws},Ql={type:16,number:50,flags:Ws},EA={type:16,number:100,flags:Ws},$n=function(A,t,e){var n=A[0],s=A[1];return[Ft(n,t),Ft(typeof s<"u"?s:n,e)]},Ft=function(A,t){if(A.type===16)return A.number/100*t;if(Vs(A))switch(A.unit){case"rem":case"em":return 16*A.number;default:return A.number}return A.number},Dh="deg",Nh="grad",Rh="rad",kh="turn",Pi={name:"angle",parse:function(A,t){if(t.type===15)switch(t.unit){case Dh:return Math.PI*t.number/180;case Nh:return Math.PI/200*t.number;case Rh:return t.number;case kh:return Math.PI*2*t.number}throw new Error("Unsupported angle type")}},_h=function(A){return A.type===15&&(A.unit===Dh||A.unit===Nh||A.unit===Rh||A.unit===kh)},Oh=function(A){var t=A.filter(Qt).map(function(e){return e.value}).join(" ");switch(t){case"to bottom right":case"to right bottom":case"left top":case"top left":return[Jt,Jt];case"to top":case"bottom":return Ee(0);case"to bottom left":case"to left bottom":case"right top":case"top right":return[Jt,EA];case"to right":case"left":return Ee(90);case"to top left":case"to left top":case"right bottom":case"bottom right":return[EA,EA];case"to bottom":case"top":return Ee(180);case"to top right":case"to right top":case"left bottom":case"bottom left":return[EA,Jt];case"to left":case"right":return Ee(270)}return 0},Ee=function(A){return Math.PI*A/180},UA={name:"color",parse:function(A,t){if(t.type===18){var e=F2[t.name];if(typeof e>"u")throw new Error('Attempting to parse an unsupported color function "'+t.name+'"');return e(A,t.values)}if(t.type===5){if(t.value.length===3){var n=t.value.substring(0,1),s=t.value.substring(1,2),r=t.value.substring(2,3);return QA(parseInt(n+n,16),parseInt(s+s,16),parseInt(r+r,16),1)}if(t.value.length===4){var n=t.value.substring(0,1),s=t.value.substring(1,2),r=t.value.substring(2,3),i=t.value.substring(3,4);return QA(parseInt(n+n,16),parseInt(s+s,16),parseInt(r+r,16),parseInt(i+i,16)/255)}if(t.value.length===6){var n=t.value.substring(0,2),s=t.value.substring(2,4),r=t.value.substring(4,6);return QA(parseInt(n,16),parseInt(s,16),parseInt(r,16),1)}if(t.value.length===8){var n=t.value.substring(0,2),s=t.value.substring(2,4),r=t.value.substring(4,6),i=t.value.substring(6,8);return QA(parseInt(n,16),parseInt(s,16),parseInt(r,16),parseInt(i,16)/255)}}if(t.type===20){var o=dA[t.value.toUpperCase()];if(typeof o<"u")return o}return dA.TRANSPARENT}},MA=function(A){return(255&A)===0},qt=function(A){var t=255&A,e=255&A>>8,n=255&A>>16,s=255&A>>24;return t<255?"rgba("+s+","+n+","+e+","+t/255+")":"rgb("+s+","+n+","+e+")"},QA=function(A,t,e,n){return(A<<24|t<<16|e<<8|Math.round(n*255)<<0)>>>0},od=function(A,t){if(A.type===17)return A.number;if(A.type===16){var e=t===3?1:255;return t===3?A.number/100*e:Math.round(A.number/100*e)}return 0},ad=function(A,t){var e=t.filter(xn);if(e.length===3){var n=e.map(od),s=n[0],r=n[1],i=n[2];return QA(s,r,i,1)}if(e.length===4){var o=e.map(od),s=o[0],r=o[1],i=o[2],a=o[3];return QA(s,r,i,a)}return 0};function Co(A,t,e){return e<0&&(e+=1),e>=1&&(e-=1),e<1/6?(t-A)*e*6+A:e<1/2?t:e<2/3?(t-A)*6*(2/3-e)+A:A}var ld=function(A,t){var e=t.filter(xn),n=e[0],s=e[1],r=e[2],i=e[3],o=(n.type===17?Ee(n.number):Pi.parse(A,n))/(Math.PI*2),a=Nt(s)?s.number/100:0,l=Nt(r)?r.number/100:0,d=typeof i<"u"&&Nt(i)?Ft(i,1):1;if(a===0)return QA(l*255,l*255,l*255,1);var u=l<=.5?l*(a+1):l+a-l*a,h=l*2-u,m=Co(h,u,o+1/3),f=Co(h,u,o),g=Co(h,u,o-1/3);return QA(m*255,f*255,g*255,d)},F2={hsl:ld,hsla:ld,rgb:ad,rgba:ad},hs=function(A,t){return UA.parse(A,Ph.create(t).parseComponentValue())},dA={ALICEBLUE:4042850303,ANTIQUEWHITE:4209760255,AQUA:16777215,AQUAMARINE:2147472639,AZURE:4043309055,BEIGE:4126530815,BISQUE:4293182719,BLACK:255,BLANCHEDALMOND:4293643775,BLUE:65535,BLUEVIOLET:2318131967,BROWN:2771004159,BURLYWOOD:3736635391,CADETBLUE:1604231423,CHARTREUSE:2147418367,CHOCOLATE:3530104575,CORAL:4286533887,CORNFLOWERBLUE:1687547391,CORNSILK:4294499583,CRIMSON:3692313855,CYAN:16777215,DARKBLUE:35839,DARKCYAN:9145343,DARKGOLDENROD:3095837695,DARKGRAY:2846468607,DARKGREEN:6553855,DARKGREY:2846468607,DARKKHAKI:3182914559,DARKMAGENTA:2332068863,DARKOLIVEGREEN:1433087999,DARKORANGE:4287365375,DARKORCHID:2570243327,DARKRED:2332033279,DARKSALMON:3918953215,DARKSEAGREEN:2411499519,DARKSLATEBLUE:1211993087,DARKSLATEGRAY:793726975,DARKSLATEGREY:793726975,DARKTURQUOISE:13554175,DARKVIOLET:2483082239,DEEPPINK:4279538687,DEEPSKYBLUE:12582911,DIMGRAY:1768516095,DIMGREY:1768516095,DODGERBLUE:512819199,FIREBRICK:2988581631,FLORALWHITE:4294635775,FORESTGREEN:579543807,FUCHSIA:4278255615,GAINSBORO:3705462015,GHOSTWHITE:4177068031,GOLD:4292280575,GOLDENROD:3668254975,GRAY:2155905279,GREEN:8388863,GREENYELLOW:2919182335,GREY:2155905279,HONEYDEW:4043305215,HOTPINK:4285117695,INDIANRED:3445382399,INDIGO:1258324735,IVORY:4294963455,KHAKI:4041641215,LAVENDER:3873897215,LAVENDERBLUSH:4293981695,LAWNGREEN:2096890111,LEMONCHIFFON:4294626815,LIGHTBLUE:2916673279,LIGHTCORAL:4034953471,LIGHTCYAN:3774873599,LIGHTGOLDENRODYELLOW:4210742015,LIGHTGRAY:3553874943,LIGHTGREEN:2431553791,LIGHTGREY:3553874943,LIGHTPINK:4290167295,LIGHTSALMON:4288707327,LIGHTSEAGREEN:548580095,LIGHTSKYBLUE:2278488831,LIGHTSLATEGRAY:2005441023,LIGHTSLATEGREY:2005441023,LIGHTSTEELBLUE:2965692159,LIGHTYELLOW:4294959359,LIME:16711935,LIMEGREEN:852308735,LINEN:4210091775,MAGENTA:4278255615,MAROON:2147483903,MEDIUMAQUAMARINE:1724754687,MEDIUMBLUE:52735,MEDIUMORCHID:3126187007,MEDIUMPURPLE:2473647103,MEDIUMSEAGREEN:1018393087,MEDIUMSLATEBLUE:2070474495,MEDIUMSPRINGGREEN:16423679,MEDIUMTURQUOISE:1221709055,MEDIUMVIOLETRED:3340076543,MIDNIGHTBLUE:421097727,MINTCREAM:4127193855,MISTYROSE:4293190143,MOCCASIN:4293178879,NAVAJOWHITE:4292783615,NAVY:33023,OLDLACE:4260751103,OLIVE:2155872511,OLIVEDRAB:1804477439,ORANGE:4289003775,ORANGERED:4282712319,ORCHID:3664828159,PALEGOLDENROD:4008225535,PALEGREEN:2566625535,PALETURQUOISE:2951671551,PALEVIOLETRED:3681588223,PAPAYAWHIP:4293907967,PEACHPUFF:4292524543,PERU:3448061951,PINK:4290825215,PLUM:3718307327,POWDERBLUE:2967529215,PURPLE:2147516671,REBECCAPURPLE:1714657791,RED:4278190335,ROSYBROWN:3163525119,ROYALBLUE:1097458175,SADDLEBROWN:2336560127,SALMON:4202722047,SANDYBROWN:4104413439,SEAGREEN:780883967,SEASHELL:4294307583,SIENNA:2689740287,SILVER:3233857791,SKYBLUE:2278484991,SLATEBLUE:1784335871,SLATEGRAY:1887473919,SLATEGREY:1887473919,SNOW:4294638335,SPRINGGREEN:16744447,STEELBLUE:1182971135,TAN:3535047935,TEAL:8421631,THISTLE:3636451583,TOMATO:4284696575,TRANSPARENT:0,TURQUOISE:1088475391,VIOLET:4001558271,WHEAT:4125012991,WHITE:4294967295,WHITESMOKE:4126537215,YELLOW:4294902015,YELLOWGREEN:2597139199},I2={name:"background-clip",initialValue:"border-box",prefix:!1,type:1,parse:function(A,t){return t.map(function(e){if(Qt(e))switch(e.value){case"padding-box":return 1;case"content-box":return 2}return 0})}},x2={name:"background-color",initialValue:"transparent",prefix:!1,type:3,format:"color"},Li=function(A,t){var e=UA.parse(A,t[0]),n=t[1];return n&&Nt(n)?{color:e,stop:n}:{color:e,stop:null}},cd=function(A,t){var e=A[0],n=A[A.length-1];e.stop===null&&(e.stop=Jt),n.stop===null&&(n.stop=EA);for(var s=[],r=0,i=0;i<A.length;i++){var o=A[i].stop;if(o!==null){var a=Ft(o,t);a>r?s.push(a):s.push(r),r=a}else s.push(null)}for(var l=null,i=0;i<s.length;i++){var d=s[i];if(d===null)l===null&&(l=i);else if(l!==null){for(var u=i-l,h=s[l-1],m=(d-h)/(u+1),f=1;f<=u;f++)s[l+f-1]=m*f;l=null}}return A.map(function(g,p){var w=g.color;return{color:w,stop:Math.max(Math.min(1,s[p]/t),0)}})},U2=function(A,t,e){var n=t/2,s=e/2,r=Ft(A[0],t)-n,i=s-Ft(A[1],e);return(Math.atan2(i,r)+Math.PI*2)%(Math.PI*2)},M2=function(A,t,e){var n=typeof A=="number"?A:U2(A,t,e),s=Math.abs(t*Math.sin(n))+Math.abs(e*Math.cos(n)),r=t/2,i=e/2,o=s/2,a=Math.sin(n-Math.PI/2)*o,l=Math.cos(n-Math.PI/2)*o;return[s,r-l,r+l,i-a,i+a]},Te=function(A,t){return Math.sqrt(A*A+t*t)},dd=function(A,t,e,n,s){var r=[[0,0],[0,t],[A,0],[A,t]];return r.reduce(function(i,o){var a=o[0],l=o[1],d=Te(e-a,n-l);return(s?d<i.optimumDistance:d>i.optimumDistance)?{optimumCorner:o,optimumDistance:d}:i},{optimumDistance:s?1/0:-1/0,optimumCorner:null}).optimumCorner},T2=function(A,t,e,n,s){var r=0,i=0;switch(A.size){case 0:A.shape===0?r=i=Math.min(Math.abs(t),Math.abs(t-n),Math.abs(e),Math.abs(e-s)):A.shape===1&&(r=Math.min(Math.abs(t),Math.abs(t-n)),i=Math.min(Math.abs(e),Math.abs(e-s)));break;case 2:if(A.shape===0)r=i=Math.min(Te(t,e),Te(t,e-s),Te(t-n,e),Te(t-n,e-s));else if(A.shape===1){var o=Math.min(Math.abs(e),Math.abs(e-s))/Math.min(Math.abs(t),Math.abs(t-n)),a=dd(n,s,t,e,!0),l=a[0],d=a[1];r=Te(l-t,(d-e)/o),i=o*r}break;case 1:A.shape===0?r=i=Math.max(Math.abs(t),Math.abs(t-n),Math.abs(e),Math.abs(e-s)):A.shape===1&&(r=Math.max(Math.abs(t),Math.abs(t-n)),i=Math.max(Math.abs(e),Math.abs(e-s)));break;case 3:if(A.shape===0)r=i=Math.max(Te(t,e),Te(t,e-s),Te(t-n,e),Te(t-n,e-s));else if(A.shape===1){var o=Math.max(Math.abs(e),Math.abs(e-s))/Math.max(Math.abs(t),Math.abs(t-n)),u=dd(n,s,t,e,!1),l=u[0],d=u[1];r=Te(l-t,(d-e)/o),i=o*r}break}return Array.isArray(A.size)&&(r=Ft(A.size[0],n),i=A.size.length===2?Ft(A.size[1],s):r),[r,i]},P2=function(A,t){var e=Ee(180),n=[];return je(t).forEach(function(s,r){if(r===0){var i=s[0];if(i.type===20&&i.value==="to"){e=Oh(s);return}else if(_h(i)){e=Pi.parse(A,i);return}}var o=Li(A,s);n.push(o)}),{angle:e,stops:n,type:1}},gr=function(A,t){var e=Ee(180),n=[];return je(t).forEach(function(s,r){if(r===0){var i=s[0];if(i.type===20&&["top","left","right","bottom"].indexOf(i.value)!==-1){e=Oh(s);return}else if(_h(i)){e=(Pi.parse(A,i)+Ee(270))%Ee(360);return}}var o=Li(A,s);n.push(o)}),{angle:e,stops:n,type:1}},L2=function(A,t){var e=Ee(180),n=[],s=1,r=0,i=3,o=[];return je(t).forEach(function(a,l){var d=a[0];if(l===0){if(Qt(d)&&d.value==="linear"){s=1;return}else if(Qt(d)&&d.value==="radial"){s=2;return}}if(d.type===18){if(d.name==="from"){var u=UA.parse(A,d.values[0]);n.push({stop:Jt,color:u})}else if(d.name==="to"){var u=UA.parse(A,d.values[0]);n.push({stop:EA,color:u})}else if(d.name==="color-stop"){var h=d.values.filter(xn);if(h.length===2){var u=UA.parse(A,h[1]),m=h[0];Ln(m)&&n.push({stop:{type:16,number:m.number*100,flags:m.flags},color:u})}}}}),s===1?{angle:(e+Ee(180))%Ee(360),stops:n,type:s}:{size:i,shape:r,stops:n,position:o,type:s}},Kh="closest-side",Gh="farthest-side",Wh="closest-corner",Vh="farthest-corner",zh="circle",qh="ellipse",Xh="cover",$h="contain",H2=function(A,t){var e=0,n=3,s=[],r=[];return je(t).forEach(function(i,o){var a=!0;if(o===0){var l=!1;a=i.reduce(function(u,h){if(l)if(Qt(h))switch(h.value){case"center":return r.push(Ql),u;case"top":case"left":return r.push(Jt),u;case"right":case"bottom":return r.push(EA),u}else(Nt(h)||LA(h))&&r.push(h);else if(Qt(h))switch(h.value){case zh:return e=0,!1;case qh:return e=1,!1;case"at":return l=!0,!1;case Kh:return n=0,!1;case Xh:case Gh:return n=1,!1;case $h:case Wh:return n=2,!1;case Vh:return n=3,!1}else if(LA(h)||Nt(h))return Array.isArray(n)||(n=[]),n.push(h),!1;return u},a)}if(a){var d=Li(A,i);s.push(d)}}),{size:n,shape:e,stops:s,position:r,type:2}},mr=function(A,t){var e=0,n=3,s=[],r=[];return je(t).forEach(function(i,o){var a=!0;if(o===0?a=i.reduce(function(d,u){if(Qt(u))switch(u.value){case"center":return r.push(Ql),!1;case"top":case"left":return r.push(Jt),!1;case"right":case"bottom":return r.push(EA),!1}else if(Nt(u)||LA(u))return r.push(u),!1;return d},a):o===1&&(a=i.reduce(function(d,u){if(Qt(u))switch(u.value){case zh:return e=0,!1;case qh:return e=1,!1;case $h:case Kh:return n=0,!1;case Gh:return n=1,!1;case Wh:return n=2,!1;case Xh:case Vh:return n=3,!1}else if(LA(u)||Nt(u))return Array.isArray(n)||(n=[]),n.push(u),!1;return d},a)),a){var l=Li(A,i);s.push(l)}}),{size:n,shape:e,stops:s,position:r,type:2}},D2=function(A){return A.type===1},N2=function(A){return A.type===2},Fl={name:"image",parse:function(A,t){if(t.type===22){var e={url:t.value,type:0};return A.cache.addImage(t.value),e}if(t.type===18){var n=Yh[t.name];if(typeof n>"u")throw new Error('Attempting to parse an unsupported image function "'+t.name+'"');return n(A,t.values)}throw new Error("Unsupported image type "+t.type)}};function R2(A){return!(A.type===20&&A.value==="none")&&(A.type!==18||!!Yh[A.name])}var Yh={"linear-gradient":P2,"-moz-linear-gradient":gr,"-ms-linear-gradient":gr,"-o-linear-gradient":gr,"-webkit-linear-gradient":gr,"radial-gradient":H2,"-moz-radial-gradient":mr,"-ms-radial-gradient":mr,"-o-radial-gradient":mr,"-webkit-radial-gradient":mr,"-webkit-gradient":L2},k2={name:"background-image",initialValue:"none",type:1,prefix:!1,parse:function(A,t){if(t.length===0)return[];var e=t[0];return e.type===20&&e.value==="none"?[]:t.filter(function(n){return xn(n)&&R2(n)}).map(function(n){return Fl.parse(A,n)})}},_2={name:"background-origin",initialValue:"border-box",prefix:!1,type:1,parse:function(A,t){return t.map(function(e){if(Qt(e))switch(e.value){case"padding-box":return 1;case"content-box":return 2}return 0})}},O2={name:"background-position",initialValue:"0% 0%",type:1,prefix:!1,parse:function(A,t){return je(t).map(function(e){return e.filter(Nt)}).map(Hh)}},K2={name:"background-repeat",initialValue:"repeat",prefix:!1,type:1,parse:function(A,t){return je(t).map(function(e){return e.filter(Qt).map(function(n){return n.value}).join(" ")}).map(G2)}},G2=function(A){switch(A){case"no-repeat":return 1;case"repeat-x":case"repeat no-repeat":return 2;case"repeat-y":case"no-repeat repeat":return 3;default:return 0}},In;(function(A){A.AUTO="auto",A.CONTAIN="contain",A.COVER="cover"})(In||(In={}));var W2={name:"background-size",initialValue:"0",prefix:!1,type:1,parse:function(A,t){return je(t).map(function(e){return e.filter(V2)})}},V2=function(A){return Qt(A)||Nt(A)},Hi=function(A){return{name:"border-"+A+"-color",initialValue:"transparent",prefix:!1,type:3,format:"color"}},z2=Hi("top"),q2=Hi("right"),X2=Hi("bottom"),$2=Hi("left"),Di=function(A){return{name:"border-radius-"+A,initialValue:"0 0",prefix:!1,type:1,parse:function(t,e){return Hh(e.filter(Nt))}}},Y2=Di("top-left"),J2=Di("top-right"),j2=Di("bottom-right"),Z2=Di("bottom-left"),Ni=function(A){return{name:"border-"+A+"-style",initialValue:"solid",prefix:!1,type:2,parse:function(t,e){switch(e){case"none":return 0;case"dashed":return 2;case"dotted":return 3;case"double":return 4}return 1}}},tC=Ni("top"),eC=Ni("right"),AC=Ni("bottom"),nC=Ni("left"),Ri=function(A){return{name:"border-"+A+"-width",initialValue:"0",type:0,prefix:!1,parse:function(t,e){return Vs(e)?e.number:0}}},sC=Ri("top"),rC=Ri("right"),iC=Ri("bottom"),oC=Ri("left"),aC={name:"color",initialValue:"transparent",prefix:!1,type:3,format:"color"},lC={name:"direction",initialValue:"ltr",prefix:!1,type:2,parse:function(A,t){return t==="rtl"?1:0}},cC={name:"display",initialValue:"inline-block",prefix:!1,type:1,parse:function(A,t){return t.filter(Qt).reduce(function(e,n){return e|dC(n.value)},0)}},dC=function(A){switch(A){case"block":case"-webkit-box":return 2;case"inline":return 4;case"run-in":return 8;case"flow":return 16;case"flow-root":return 32;case"table":return 64;case"flex":case"-webkit-flex":return 128;case"grid":case"-ms-grid":return 256;case"ruby":return 512;case"subgrid":return 1024;case"list-item":return 2048;case"table-row-group":return 4096;case"table-header-group":return 8192;case"table-footer-group":return 16384;case"table-row":return 32768;case"table-cell":return 65536;case"table-column-group":return 131072;case"table-column":return 262144;case"table-caption":return 524288;case"ruby-base":return 1048576;case"ruby-text":return 2097152;case"ruby-base-container":return 4194304;case"ruby-text-container":return 8388608;case"contents":return 16777216;case"inline-block":return 33554432;case"inline-list-item":return 67108864;case"inline-table":return 134217728;case"inline-flex":return 268435456;case"inline-grid":return 536870912}return 0},uC={name:"float",initialValue:"none",prefix:!1,type:2,parse:function(A,t){switch(t){case"left":return 1;case"right":return 2;case"inline-start":return 3;case"inline-end":return 4}return 0}},hC={name:"letter-spacing",initialValue:"0",prefix:!1,type:0,parse:function(A,t){return t.type===20&&t.value==="normal"?0:t.type===17||t.type===15?t.number:0}},oi;(function(A){A.NORMAL="normal",A.STRICT="strict"})(oi||(oi={}));var fC={name:"line-break",initialValue:"normal",prefix:!1,type:2,parse:function(A,t){return t==="strict"?oi.STRICT:oi.NORMAL}},gC={name:"line-height",initialValue:"normal",prefix:!1,type:4},ud=function(A,t){return Qt(A)&&A.value==="normal"?1.2*t:A.type===17?t*A.number:Nt(A)?Ft(A,t):t},mC={name:"list-style-image",initialValue:"none",type:0,prefix:!1,parse:function(A,t){return t.type===20&&t.value==="none"?null:Fl.parse(A,t)}},pC={name:"list-style-position",initialValue:"outside",prefix:!1,type:2,parse:function(A,t){return t==="inside"?0:1}},Ea={name:"list-style-type",initialValue:"none",prefix:!1,type:2,parse:function(A,t){switch(t){case"disc":return 0;case"circle":return 1;case"square":return 2;case"decimal":return 3;case"cjk-decimal":return 4;case"decimal-leading-zero":return 5;case"lower-roman":return 6;case"upper-roman":return 7;case"lower-greek":return 8;case"lower-alpha":return 9;case"upper-alpha":return 10;case"arabic-indic":return 11;case"armenian":return 12;case"bengali":return 13;case"cambodian":return 14;case"cjk-earthly-branch":return 15;case"cjk-heavenly-stem":return 16;case"cjk-ideographic":return 17;case"devanagari":return 18;case"ethiopic-numeric":return 19;case"georgian":return 20;case"gujarati":return 21;case"gurmukhi":return 22;case"hebrew":return 22;case"hiragana":return 23;case"hiragana-iroha":return 24;case"japanese-formal":return 25;case"japanese-informal":return 26;case"kannada":return 27;case"katakana":return 28;case"katakana-iroha":return 29;case"khmer":return 30;case"korean-hangul-formal":return 31;case"korean-hanja-formal":return 32;case"korean-hanja-informal":return 33;case"lao":return 34;case"lower-armenian":return 35;case"malayalam":return 36;case"mongolian":return 37;case"myanmar":return 38;case"oriya":return 39;case"persian":return 40;case"simp-chinese-formal":return 41;case"simp-chinese-informal":return 42;case"tamil":return 43;case"telugu":return 44;case"thai":return 45;case"tibetan":return 46;case"trad-chinese-formal":return 47;case"trad-chinese-informal":return 48;case"upper-armenian":return 49;case"disclosure-open":return 50;case"disclosure-closed":return 51;default:return-1}}},ki=function(A){return{name:"margin-"+A,initialValue:"0",prefix:!1,type:4}},BC=ki("top"),wC=ki("right"),vC=ki("bottom"),CC=ki("left"),bC={name:"overflow",initialValue:"visible",prefix:!1,type:1,parse:function(A,t){return t.filter(Qt).map(function(e){switch(e.value){case"hidden":return 1;case"scroll":return 2;case"clip":return 3;case"auto":return 4;default:return 0}})}},yC={name:"overflow-wrap",initialValue:"normal",prefix:!1,type:2,parse:function(A,t){return t==="break-word"?"break-word":"normal"}},_i=function(A){return{name:"padding-"+A,initialValue:"0",prefix:!1,type:3,format:"length-percentage"}},SC=_i("top"),EC=_i("right"),QC=_i("bottom"),FC=_i("left"),IC={name:"text-align",initialValue:"left",prefix:!1,type:2,parse:function(A,t){switch(t){case"right":return 2;case"center":case"justify":return 1;default:return 0}}},xC={name:"position",initialValue:"static",prefix:!1,type:2,parse:function(A,t){switch(t){case"relative":return 1;case"absolute":return 2;case"fixed":return 3;case"sticky":return 4}return 0}},UC={name:"text-shadow",initialValue:"none",type:1,prefix:!1,parse:function(A,t){return t.length===1&&Sa(t[0],"none")?[]:je(t).map(function(e){for(var n={color:dA.TRANSPARENT,offsetX:Jt,offsetY:Jt,blur:Jt},s=0,r=0;r<e.length;r++){var i=e[r];LA(i)?(s===0?n.offsetX=i:s===1?n.offsetY=i:n.blur=i,s++):n.color=UA.parse(A,i)}return n})}},MC={name:"text-transform",initialValue:"none",prefix:!1,type:2,parse:function(A,t){switch(t){case"uppercase":return 2;case"lowercase":return 1;case"capitalize":return 3}return 0}},TC={name:"transform",initialValue:"none",prefix:!0,type:0,parse:function(A,t){if(t.type===20&&t.value==="none")return null;if(t.type===18){var e=HC[t.name];if(typeof e>"u")throw new Error('Attempting to parse an unsupported transform function "'+t.name+'"');return e(t.values)}return null}},PC=function(A){var t=A.filter(function(e){return e.type===17}).map(function(e){return e.number});return t.length===6?t:null},LC=function(A){var t=A.filter(function(a){return a.type===17}).map(function(a){return a.number}),e=t[0],n=t[1];t[2],t[3];var s=t[4],r=t[5];t[6],t[7],t[8],t[9],t[10],t[11];var i=t[12],o=t[13];return t[14],t[15],t.length===16?[e,n,s,r,i,o]:null},HC={matrix:PC,matrix3d:LC},hd={type:16,number:50,flags:Ws},DC=[hd,hd],NC={name:"transform-origin",initialValue:"50% 50%",prefix:!0,type:1,parse:function(A,t){var e=t.filter(Nt);return e.length!==2?DC:[e[0],e[1]]}},RC={name:"visible",initialValue:"none",prefix:!1,type:2,parse:function(A,t){switch(t){case"hidden":return 1;case"collapse":return 2;default:return 0}}},fs;(function(A){A.NORMAL="normal",A.BREAK_ALL="break-all",A.KEEP_ALL="keep-all"})(fs||(fs={}));var kC={name:"word-break",initialValue:"normal",prefix:!1,type:2,parse:function(A,t){switch(t){case"break-all":return fs.BREAK_ALL;case"keep-all":return fs.KEEP_ALL;default:return fs.NORMAL}}},_C={name:"z-index",initialValue:"auto",prefix:!1,type:0,parse:function(A,t){if(t.type===20)return{auto:!0,order:0};if(Ln(t))return{auto:!1,order:t.number};throw new Error("Invalid z-index number parsed")}},Jh={name:"time",parse:function(A,t){if(t.type===15)switch(t.unit.toLowerCase()){case"s":return 1e3*t.number;case"ms":return t.number}throw new Error("Unsupported time type")}},OC={name:"opacity",initialValue:"1",type:0,prefix:!1,parse:function(A,t){return Ln(t)?t.number:1}},KC={name:"text-decoration-color",initialValue:"transparent",prefix:!1,type:3,format:"color"},GC={name:"text-decoration-line",initialValue:"none",prefix:!1,type:1,parse:function(A,t){return t.filter(Qt).map(function(e){switch(e.value){case"underline":return 1;case"overline":return 2;case"line-through":return 3;case"none":return 4}return 0}).filter(function(e){return e!==0})}},WC={name:"font-family",initialValue:"",prefix:!1,type:1,parse:function(A,t){var e=[],n=[];return t.forEach(function(s){switch(s.type){case 20:case 0:e.push(s.value);break;case 17:e.push(s.number.toString());break;case 4:n.push(e.join(" ")),e.length=0;break}}),e.length&&n.push(e.join(" ")),n.map(function(s){return s.indexOf(" ")===-1?s:"'"+s+"'"})}},VC={name:"font-size",initialValue:"0",prefix:!1,type:3,format:"length"},zC={name:"font-weight",initialValue:"normal",type:0,prefix:!1,parse:function(A,t){return Ln(t)?t.number:Qt(t)&&t.value==="bold"?700:400}},qC={name:"font-variant",initialValue:"none",type:1,prefix:!1,parse:function(A,t){return t.filter(Qt).map(function(e){return e.value})}},XC={name:"font-style",initialValue:"normal",prefix:!1,type:2,parse:function(A,t){switch(t){case"oblique":return"oblique";case"italic":return"italic";default:return"normal"}}},Wt=function(A,t){return(A&t)!==0},$C={name:"content",initialValue:"none",type:1,prefix:!1,parse:function(A,t){if(t.length===0)return[];var e=t[0];return e.type===20&&e.value==="none"?[]:t}},YC={name:"counter-increment",initialValue:"none",prefix:!0,type:1,parse:function(A,t){if(t.length===0)return null;var e=t[0];if(e.type===20&&e.value==="none")return null;for(var n=[],s=t.filter(Lh),r=0;r<s.length;r++){var i=s[r],o=s[r+1];if(i.type===20){var a=o&&Ln(o)?o.number:1;n.push({counter:i.value,increment:a})}}return n}},JC={name:"counter-reset",initialValue:"none",prefix:!0,type:1,parse:function(A,t){if(t.length===0)return[];for(var e=[],n=t.filter(Lh),s=0;s<n.length;s++){var r=n[s],i=n[s+1];if(Qt(r)&&r.value!=="none"){var o=i&&Ln(i)?i.number:0;e.push({counter:r.value,reset:o})}}return e}},jC={name:"duration",initialValue:"0s",prefix:!1,type:1,parse:function(A,t){return t.filter(Vs).map(function(e){return Jh.parse(A,e)})}},ZC={name:"quotes",initialValue:"none",prefix:!0,type:1,parse:function(A,t){if(t.length===0)return null;var e=t[0];if(e.type===20&&e.value==="none")return null;var n=[],s=t.filter(E2);if(s.length%2!==0)return null;for(var r=0;r<s.length;r+=2){var i=s[r].value,o=s[r+1].value;n.push({open:i,close:o})}return n}},fd=function(A,t,e){if(!A)return"";var n=A[Math.min(t,A.length-1)];return n?e?n.open:n.close:""},tb={name:"box-shadow",initialValue:"none",type:1,prefix:!1,parse:function(A,t){return t.length===1&&Sa(t[0],"none")?[]:je(t).map(function(e){for(var n={color:255,offsetX:Jt,offsetY:Jt,blur:Jt,spread:Jt,inset:!1},s=0,r=0;r<e.length;r++){var i=e[r];Sa(i,"inset")?n.inset=!0:LA(i)?(s===0?n.offsetX=i:s===1?n.offsetY=i:s===2?n.blur=i:n.spread=i,s++):n.color=UA.parse(A,i)}return n})}},eb={name:"paint-order",initialValue:"normal",prefix:!1,type:1,parse:function(A,t){var e=[0,1,2],n=[];return t.filter(Qt).forEach(function(s){switch(s.value){case"stroke":n.push(1);break;case"fill":n.push(0);break;case"markers":n.push(2);break}}),e.forEach(function(s){n.indexOf(s)===-1&&n.push(s)}),n}},Ab={name:"-webkit-text-stroke-color",initialValue:"currentcolor",prefix:!1,type:3,format:"color"},nb={name:"-webkit-text-stroke-width",initialValue:"0",type:0,prefix:!1,parse:function(A,t){return Vs(t)?t.number:0}},sb=(function(){function A(t,e){var n,s;this.animationDuration=j(t,jC,e.animationDuration),this.backgroundClip=j(t,I2,e.backgroundClip),this.backgroundColor=j(t,x2,e.backgroundColor),this.backgroundImage=j(t,k2,e.backgroundImage),this.backgroundOrigin=j(t,_2,e.backgroundOrigin),this.backgroundPosition=j(t,O2,e.backgroundPosition),this.backgroundRepeat=j(t,K2,e.backgroundRepeat),this.backgroundSize=j(t,W2,e.backgroundSize),this.borderTopColor=j(t,z2,e.borderTopColor),this.borderRightColor=j(t,q2,e.borderRightColor),this.borderBottomColor=j(t,X2,e.borderBottomColor),this.borderLeftColor=j(t,$2,e.borderLeftColor),this.borderTopLeftRadius=j(t,Y2,e.borderTopLeftRadius),this.borderTopRightRadius=j(t,J2,e.borderTopRightRadius),this.borderBottomRightRadius=j(t,j2,e.borderBottomRightRadius),this.borderBottomLeftRadius=j(t,Z2,e.borderBottomLeftRadius),this.borderTopStyle=j(t,tC,e.borderTopStyle),this.borderRightStyle=j(t,eC,e.borderRightStyle),this.borderBottomStyle=j(t,AC,e.borderBottomStyle),this.borderLeftStyle=j(t,nC,e.borderLeftStyle),this.borderTopWidth=j(t,sC,e.borderTopWidth),this.borderRightWidth=j(t,rC,e.borderRightWidth),this.borderBottomWidth=j(t,iC,e.borderBottomWidth),this.borderLeftWidth=j(t,oC,e.borderLeftWidth),this.boxShadow=j(t,tb,e.boxShadow),this.color=j(t,aC,e.color),this.direction=j(t,lC,e.direction),this.display=j(t,cC,e.display),this.float=j(t,uC,e.cssFloat),this.fontFamily=j(t,WC,e.fontFamily),this.fontSize=j(t,VC,e.fontSize),this.fontStyle=j(t,XC,e.fontStyle),this.fontVariant=j(t,qC,e.fontVariant),this.fontWeight=j(t,zC,e.fontWeight),this.letterSpacing=j(t,hC,e.letterSpacing),this.lineBreak=j(t,fC,e.lineBreak),this.lineHeight=j(t,gC,e.lineHeight),this.listStyleImage=j(t,mC,e.listStyleImage),this.listStylePosition=j(t,pC,e.listStylePosition),this.listStyleType=j(t,Ea,e.listStyleType),this.marginTop=j(t,BC,e.marginTop),this.marginRight=j(t,wC,e.marginRight),this.marginBottom=j(t,vC,e.marginBottom),this.marginLeft=j(t,CC,e.marginLeft),this.opacity=j(t,OC,e.opacity);var r=j(t,bC,e.overflow);this.overflowX=r[0],this.overflowY=r[r.length>1?1:0],this.overflowWrap=j(t,yC,e.overflowWrap),this.paddingTop=j(t,SC,e.paddingTop),this.paddingRight=j(t,EC,e.paddingRight),this.paddingBottom=j(t,QC,e.paddingBottom),this.paddingLeft=j(t,FC,e.paddingLeft),this.paintOrder=j(t,eb,e.paintOrder),this.position=j(t,xC,e.position),this.textAlign=j(t,IC,e.textAlign),this.textDecorationColor=j(t,KC,(n=e.textDecorationColor)!==null&&n!==void 0?n:e.color),this.textDecorationLine=j(t,GC,(s=e.textDecorationLine)!==null&&s!==void 0?s:e.textDecoration),this.textShadow=j(t,UC,e.textShadow),this.textTransform=j(t,MC,e.textTransform),this.transform=j(t,TC,e.transform),this.transformOrigin=j(t,NC,e.transformOrigin),this.visibility=j(t,RC,e.visibility),this.webkitTextStrokeColor=j(t,Ab,e.webkitTextStrokeColor),this.webkitTextStrokeWidth=j(t,nb,e.webkitTextStrokeWidth),this.wordBreak=j(t,kC,e.wordBreak),this.zIndex=j(t,_C,e.zIndex)}return A.prototype.isVisible=function(){return this.display>0&&this.opacity>0&&this.visibility===0},A.prototype.isTransparent=function(){return MA(this.backgroundColor)},A.prototype.isTransformed=function(){return this.transform!==null},A.prototype.isPositioned=function(){return this.position!==0},A.prototype.isPositionedWithZIndex=function(){return this.isPositioned()&&!this.zIndex.auto},A.prototype.isFloating=function(){return this.float!==0},A.prototype.isInlineLevel=function(){return Wt(this.display,4)||Wt(this.display,33554432)||Wt(this.display,268435456)||Wt(this.display,536870912)||Wt(this.display,67108864)||Wt(this.display,134217728)},A})(),rb=(function(){function A(t,e){this.content=j(t,$C,e.content),this.quotes=j(t,ZC,e.quotes)}return A})(),gd=(function(){function A(t,e){this.counterIncrement=j(t,YC,e.counterIncrement),this.counterReset=j(t,JC,e.counterReset)}return A})(),j=function(A,t,e){var n=new Th,s=e!==null&&typeof e<"u"?e.toString():t.initialValue;n.write(s);var r=new Ph(n.read());switch(t.type){case 2:var i=r.parseComponentValue();return t.parse(A,Qt(i)?i.value:t.initialValue);case 0:return t.parse(A,r.parseComponentValue());case 1:return t.parse(A,r.parseComponentValues());case 4:return r.parseComponentValue();case 3:switch(t.format){case"angle":return Pi.parse(A,r.parseComponentValue());case"color":return UA.parse(A,r.parseComponentValue());case"image":return Fl.parse(A,r.parseComponentValue());case"length":var o=r.parseComponentValue();return LA(o)?o:Jt;case"length-percentage":var a=r.parseComponentValue();return Nt(a)?a:Jt;case"time":return Jh.parse(A,r.parseComponentValue())}break}},ib="data-html2canvas-debug",ob=function(A){var t=A.getAttribute(ib);switch(t){case"all":return 1;case"clone":return 2;case"parse":return 3;case"render":return 4;default:return 0}},Qa=function(A,t){var e=ob(A);return e===1||t===e},Ze=(function(){function A(t,e){if(this.context=t,this.textNodes=[],this.elements=[],this.flags=0,Qa(e,3))debugger;this.styles=new sb(t,window.getComputedStyle(e,null)),xa(e)&&(this.styles.animationDuration.some(function(n){return n>0})&&(e.style.animationDuration="0s"),this.styles.transform!==null&&(e.style.transform="none")),this.bounds=Mi(this.context,e),Qa(e,4)&&(this.flags|=16)}return A})(),ab="AAAAAAAAAAAAEA4AGBkAAFAaAAACAAAAAAAIABAAGAAwADgACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAIABAAQABIAEQATAAIABAACAAQAAgAEAAIABAAVABcAAgAEAAIABAACAAQAGAAaABwAHgAgACIAI4AlgAIABAAmwCjAKgAsAC2AL4AvQDFAMoA0gBPAVYBWgEIAAgACACMANoAYgFkAWwBdAF8AX0BhQGNAZUBlgGeAaMBlQGWAasBswF8AbsBwwF0AcsBYwHTAQgA2wG/AOMBdAF8AekB8QF0AfkB+wHiAHQBfAEIAAMC5gQIAAsCEgIIAAgAFgIeAggAIgIpAggAMQI5AkACygEIAAgASAJQAlgCYAIIAAgACAAKBQoFCgUTBRMFGQUrBSsFCAAIAAgACAAIAAgACAAIAAgACABdAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABoAmgCrwGvAQgAbgJ2AggAHgEIAAgACADnAXsCCAAIAAgAgwIIAAgACAAIAAgACACKAggAkQKZAggAPADJAAgAoQKkAqwCsgK6AsICCADJAggA0AIIAAgACAAIANYC3gIIAAgACAAIAAgACABAAOYCCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAkASoB+QIEAAgACAA8AEMCCABCBQgACABJBVAFCAAIAAgACAAIAAgACAAIAAgACABTBVoFCAAIAFoFCABfBWUFCAAIAAgACAAIAAgAbQUIAAgACAAIAAgACABzBXsFfQWFBYoFigWKBZEFigWKBYoFmAWfBaYFrgWxBbkFCAAIAAgACAAIAAgACAAIAAgACAAIAMEFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAMgFCADQBQgACAAIAAgACAAIAAgACAAIAAgACAAIAO4CCAAIAAgAiQAIAAgACABAAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAD0AggACAD8AggACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIANYFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAMDvwAIAAgAJAIIAAgACAAIAAgACAAIAAgACwMTAwgACAB9BOsEGwMjAwgAKwMyAwsFYgE3A/MEPwMIAEUDTQNRAwgAWQOsAGEDCAAIAAgACAAIAAgACABpAzQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFIQUoBSwFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABtAwgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABMAEwACAAIAAgACAAIABgACAAIAAgACAC/AAgACAAyAQgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACACAAIAAwAAgACAAIAAgACAAIAAgACAAIAAAARABIAAgACAAIABQASAAIAAgAIABwAEAAjgCIABsAqAC2AL0AigDQAtwC+IJIQqVAZUBWQqVAZUBlQGVAZUBlQGrC5UBlQGVAZUBlQGVAZUBlQGVAXsKlQGVAbAK6wsrDGUMpQzlDJUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAfAKAAuZA64AtwCJALoC6ADwAAgAuACgA/oEpgO6AqsD+AAIAAgAswMIAAgACAAIAIkAuwP5AfsBwwPLAwgACAAIAAgACADRA9kDCAAIAOED6QMIAAgACAAIAAgACADuA/YDCAAIAP4DyQAIAAgABgQIAAgAXQAOBAgACAAIAAgACAAIABMECAAIAAgACAAIAAgACAD8AAQBCAAIAAgAGgQiBCoECAExBAgAEAEIAAgACAAIAAgACAAIAAgACAAIAAgACAA4BAgACABABEYECAAIAAgATAQYAQgAVAQIAAgACAAIAAgACAAIAAgACAAIAFoECAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAOQEIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAB+BAcACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAEABhgSMBAgACAAIAAgAlAQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAwAEAAQABAADAAMAAwADAAQABAAEAAQABAAEAAQABHATAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAdQMIAAgACAAIAAgACAAIAMkACAAIAAgAfQMIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACACFA4kDCAAIAAgACAAIAOcBCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAIcDCAAIAAgACAAIAAgACAAIAAgACAAIAJEDCAAIAAgACADFAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABgBAgAZgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAbAQCBXIECAAIAHkECAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABAAJwEQACjBKoEsgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAC6BMIECAAIAAgACAAIAAgACABmBAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAxwQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAGYECAAIAAgAzgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAigWKBYoFigWKBYoFigWKBd0FXwUIAOIF6gXxBYoF3gT5BQAGCAaKBYoFigWKBYoFigWKBYoFigWKBYoFigXWBIoFigWKBYoFigWKBYoFigWKBYsFEAaKBYoFigWKBYoFigWKBRQGCACKBYoFigWKBQgACAAIANEECAAIABgGigUgBggAJgYIAC4GMwaKBYoF0wQ3Bj4GigWKBYoFigWKBYoFigWKBYoFigWKBYoFigUIAAgACAAIAAgACAAIAAgAigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWLBf///////wQABAAEAAQABAAEAAQABAAEAAQAAwAEAAQAAgAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAQADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAUAAAAFAAUAAAAFAAUAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUAAQAAAAUABQAFAAUABQAFAAAAAAAFAAUAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAFAAUAAQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUABQAFAAAABwAHAAcAAAAHAAcABwAFAAEAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAcABwAFAAUAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAAAAQABAAAAAAAAAAAAAAAFAAUABQAFAAAABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABwAHAAcAAAAHAAcAAAAAAAUABQAHAAUAAQAHAAEABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABwABAAUABQAFAAUAAAAAAAAAAAAAAAEAAQABAAEAAQABAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABQANAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQABAAEAAQABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAABQAHAAUABQAFAAAAAAAAAAcABQAFAAUABQAFAAQABAAEAAQABAAEAAQABAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUAAAAFAAUABQAFAAUAAAAFAAUABQAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAAAAAAAAAAAAUABQAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAUAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABwAHAAcABwAFAAcABwAAAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAUABwAHAAUABQAFAAUAAAAAAAcABwAAAAAABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAABQAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAABwAHAAcABQAFAAAAAAAAAAAABQAFAAAAAAAFAAUABQAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAFAAUABQAFAAUAAAAFAAUABwAAAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAFAAUABwAFAAUABQAFAAAAAAAHAAcAAAAAAAcABwAFAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABwAAAAAAAAAHAAcABwAAAAcABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAABQAHAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAcABwAAAAUABQAFAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABQAHAAcABQAHAAcAAAAFAAcABwAAAAcABwAFAAUAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAFAAcABwAFAAUABQAAAAUAAAAHAAcABwAHAAcABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAHAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAABwAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAUAAAAFAAAAAAAAAAAABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUABQAFAAUAAAAFAAUAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABwAFAAUABQAFAAUABQAAAAUABQAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABQAFAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABQAFAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAHAAUABQAFAAUABQAFAAUABwAHAAcABwAHAAcABwAHAAUABwAHAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABwAHAAcABwAFAAUABwAHAAcAAAAAAAAAAAAHAAcABQAHAAcABwAHAAcABwAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAHAAUABQAFAAUABQAFAAUAAAAFAAAABQAAAAAABQAFAAUABQAFAAUABQAFAAcABwAHAAcABwAHAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAUABQAFAAUABQAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABwAFAAcABwAHAAcABwAFAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAUABQAFAAUABwAHAAUABQAHAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABQAFAAcABwAHAAUABwAFAAUABQAHAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAUABQAFAAUABQAFAAUABQAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAcABQAFAAUABQAFAAUABQAAAAAAAAAAAAUAAAAAAAAAAAAAAAAABQAAAAAABwAFAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUAAAAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAABQAAAAAAAAAFAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAUABQAHAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAHAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABwAFAAUABQAFAAcABwAFAAUABwAHAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAcABwAFAAUABwAHAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAFAAUABQAAAAAABQAFAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAFAAcABwAAAAAAAAAAAAAABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAFAAcABwAFAAcABwAAAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAFAAUABQAAAAUABQAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABwAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABQAFAAUABQAFAAUABQAFAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAHAAcABQAHAAUABQAAAAAAAAAAAAAAAAAFAAAABwAHAAcABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAcABwAAAAAABwAHAAAAAAAHAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABwAHAAUABQAFAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABQAFAAUABQAFAAUABwAFAAcABwAFAAcABQAFAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABQAFAAUABQAAAAAABwAHAAcABwAFAAUABwAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAHAAUABQAFAAUABQAFAAUABQAHAAcABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAFAAcABwAFAAUABQAFAAUABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAcABwAFAAUABQAFAAcABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABQAHAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAAAAAAFAAUABwAHAAcABwAFAAAAAAAAAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABwAHAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAHAAUABQAFAAUABQAFAAUABwAFAAUABwAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAAAAAAAABQAAAAUABQAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAHAAcAAAAFAAUAAAAHAAcABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAAAAAAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAUABQAFAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAABQAFAAUABQAFAAUABQAAAAUABQAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAFAAUABQAFAAUADgAOAA4ADgAOAA4ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAAAAAAAAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAMAAwADAAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkAAAAAAAAAAAAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAAAAAAAAAAAAsADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwACwAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAADgAOAA4AAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAAAA4ADgAOAA4ADgAOAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAA4AAAAOAAAAAAAAAAAAAAAAAA4AAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAADgAAAAAAAAAAAA4AAAAOAAAAAAAAAAAADgAOAA4AAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4AAAAAAA4ADgAOAA4ADgAOAA4ADgAOAAAADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4AAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAOAA4ADgAOAA4ADgAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAAAAAAA=",md="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Yn=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var pr=0;pr<md.length;pr++)Yn[md.charCodeAt(pr)]=pr;var lb=function(A){var t=A.length*.75,e=A.length,n,s=0,r,i,o,a;A[A.length-1]==="="&&(t--,A[A.length-2]==="="&&t--);var l=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u"&&typeof Uint8Array.prototype.slice<"u"?new ArrayBuffer(t):new Array(t),d=Array.isArray(l)?l:new Uint8Array(l);for(n=0;n<e;n+=4)r=Yn[A.charCodeAt(n)],i=Yn[A.charCodeAt(n+1)],o=Yn[A.charCodeAt(n+2)],a=Yn[A.charCodeAt(n+3)],d[s++]=r<<2|i>>4,d[s++]=(i&15)<<4|o>>2,d[s++]=(o&3)<<6|a&63;return l},cb=function(A){for(var t=A.length,e=[],n=0;n<t;n+=2)e.push(A[n+1]<<8|A[n]);return e},db=function(A){for(var t=A.length,e=[],n=0;n<t;n+=4)e.push(A[n+3]<<24|A[n+2]<<16|A[n+1]<<8|A[n]);return e},qA=5,Il=11,bo=2,ub=Il-qA,jh=65536>>qA,hb=1<<qA,yo=hb-1,fb=1024>>qA,gb=jh+fb,mb=gb,pb=32,Bb=mb+pb,wb=65536>>Il,vb=1<<ub,Cb=vb-1,pd=function(A,t,e){return A.slice?A.slice(t,e):new Uint16Array(Array.prototype.slice.call(A,t,e))},bb=function(A,t,e){return A.slice?A.slice(t,e):new Uint32Array(Array.prototype.slice.call(A,t,e))},yb=function(A,t){var e=lb(A),n=Array.isArray(e)?db(e):new Uint32Array(e),s=Array.isArray(e)?cb(e):new Uint16Array(e),r=24,i=pd(s,r/2,n[4]/2),o=n[5]===2?pd(s,(r+n[4])/2):bb(n,Math.ceil((r+n[4])/4));return new Sb(n[0],n[1],n[2],n[3],i,o)},Sb=(function(){function A(t,e,n,s,r,i){this.initialValue=t,this.errorValue=e,this.highStart=n,this.highValueIndex=s,this.index=r,this.data=i}return A.prototype.get=function(t){var e;if(t>=0){if(t<55296||t>56319&&t<=65535)return e=this.index[t>>qA],e=(e<<bo)+(t&yo),this.data[e];if(t<=65535)return e=this.index[jh+(t-55296>>qA)],e=(e<<bo)+(t&yo),this.data[e];if(t<this.highStart)return e=Bb-wb+(t>>Il),e=this.index[e],e+=t>>qA&Cb,e=this.index[e],e=(e<<bo)+(t&yo),this.data[e];if(t<=1114111)return this.data[this.highValueIndex]}return this.errorValue},A})(),Bd="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Eb=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var Br=0;Br<Bd.length;Br++)Eb[Bd.charCodeAt(Br)]=Br;var Qb=1,So=2,Eo=3,wd=4,vd=5,Fb=7,Cd=8,Qo=9,Fo=10,bd=11,yd=12,Sd=13,Ed=14,Io=15,Ib=function(A){for(var t=[],e=0,n=A.length;e<n;){var s=A.charCodeAt(e++);if(s>=55296&&s<=56319&&e<n){var r=A.charCodeAt(e++);(r&64512)===56320?t.push(((s&1023)<<10)+(r&1023)+65536):(t.push(s),e--)}else t.push(s)}return t},xb=function(){for(var A=[],t=0;t<arguments.length;t++)A[t]=arguments[t];if(String.fromCodePoint)return String.fromCodePoint.apply(String,A);var e=A.length;if(!e)return"";for(var n=[],s=-1,r="";++s<e;){var i=A[s];i<=65535?n.push(i):(i-=65536,n.push((i>>10)+55296,i%1024+56320)),(s+1===e||n.length>16384)&&(r+=String.fromCharCode.apply(String,n),n.length=0)}return r},Ub=yb(ab),be="",xo="",Mb=function(A){return Ub.get(A)},Tb=function(A,t,e){var n=e-2,s=t[n],r=t[e-1],i=t[e];if(r===So&&i===Eo)return be;if(r===So||r===Eo||r===wd||i===So||i===Eo||i===wd)return xo;if(r===Cd&&[Cd,Qo,bd,yd].indexOf(i)!==-1||(r===bd||r===Qo)&&(i===Qo||i===Fo)||(r===yd||r===Fo)&&i===Fo||i===Sd||i===vd||i===Fb||r===Qb)return be;if(r===Sd&&i===Ed){for(;s===vd;)s=t[--n];if(s===Ed)return be}if(r===Io&&i===Io){for(var o=0;s===Io;)o++,s=t[--n];if(o%2===0)return be}return xo},Pb=function(A){var t=Ib(A),e=t.length,n=0,s=0,r=t.map(Mb);return{next:function(){if(n>=e)return{done:!0,value:null};for(var i=be;n<e&&(i=Tb(t,r,++n))===be;);if(i!==be||n===e){var o=xb.apply(null,t.slice(s,n));return s=n,{value:o,done:!1}}return{done:!0,value:null}}}},Lb=function(A){for(var t=Pb(A),e=[],n;!(n=t.next()).done;)n.value&&e.push(n.value.slice());return e},Hb=function(A){var t=123;if(A.createRange){var e=A.createRange();if(e.getBoundingClientRect){var n=A.createElement("boundtest");n.style.height=t+"px",n.style.display="block",A.body.appendChild(n),e.selectNode(n);var s=e.getBoundingClientRect(),r=Math.round(s.height);if(A.body.removeChild(n),r===t)return!0}}return!1},Db=function(A){var t=A.createElement("boundtest");t.style.width="50px",t.style.display="block",t.style.fontSize="12px",t.style.letterSpacing="0px",t.style.wordSpacing="0px",A.body.appendChild(t);var e=A.createRange();t.innerHTML=typeof"".repeat=="function"?"&#128104;".repeat(10):"";var n=t.firstChild,s=Ti(n.data).map(function(a){return Lt(a)}),r=0,i={},o=s.every(function(a,l){e.setStart(n,r),e.setEnd(n,r+a.length);var d=e.getBoundingClientRect();r+=a.length;var u=d.x>i.x||d.y>i.y;return i=d,l===0?!0:u});return A.body.removeChild(t),o},Nb=function(){return typeof new Image().crossOrigin<"u"},Rb=function(){return typeof new XMLHttpRequest().responseType=="string"},kb=function(A){var t=new Image,e=A.createElement("canvas"),n=e.getContext("2d");if(!n)return!1;t.src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'></svg>";try{n.drawImage(t,0,0),e.toDataURL()}catch{return!1}return!0},Qd=function(A){return A[0]===0&&A[1]===255&&A[2]===0&&A[3]===255},_b=function(A){var t=A.createElement("canvas"),e=100;t.width=e,t.height=e;var n=t.getContext("2d");if(!n)return Promise.reject(!1);n.fillStyle="rgb(0, 255, 0)",n.fillRect(0,0,e,e);var s=new Image,r=t.toDataURL();s.src=r;var i=Fa(e,e,0,0,s);return n.fillStyle="red",n.fillRect(0,0,e,e),Fd(i).then(function(o){n.drawImage(o,0,0);var a=n.getImageData(0,0,e,e).data;n.fillStyle="red",n.fillRect(0,0,e,e);var l=A.createElement("div");return l.style.backgroundImage="url("+r+")",l.style.height=e+"px",Qd(a)?Fd(Fa(e,e,0,0,l)):Promise.reject(!1)}).then(function(o){return n.drawImage(o,0,0),Qd(n.getImageData(0,0,e,e).data)}).catch(function(){return!1})},Fa=function(A,t,e,n,s){var r="http://www.w3.org/2000/svg",i=document.createElementNS(r,"svg"),o=document.createElementNS(r,"foreignObject");return i.setAttributeNS(null,"width",A.toString()),i.setAttributeNS(null,"height",t.toString()),o.setAttributeNS(null,"width","100%"),o.setAttributeNS(null,"height","100%"),o.setAttributeNS(null,"x",e.toString()),o.setAttributeNS(null,"y",n.toString()),o.setAttributeNS(null,"externalResourcesRequired","true"),i.appendChild(o),o.appendChild(s),i},Fd=function(A){return new Promise(function(t,e){var n=new Image;n.onload=function(){return t(n)},n.onerror=e,n.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(new XMLSerializer().serializeToString(A))})},$t={get SUPPORT_RANGE_BOUNDS(){var A=Hb(document);return Object.defineProperty($t,"SUPPORT_RANGE_BOUNDS",{value:A}),A},get SUPPORT_WORD_BREAKING(){var A=$t.SUPPORT_RANGE_BOUNDS&&Db(document);return Object.defineProperty($t,"SUPPORT_WORD_BREAKING",{value:A}),A},get SUPPORT_SVG_DRAWING(){var A=kb(document);return Object.defineProperty($t,"SUPPORT_SVG_DRAWING",{value:A}),A},get SUPPORT_FOREIGNOBJECT_DRAWING(){var A=typeof Array.from=="function"&&typeof window.fetch=="function"?_b(document):Promise.resolve(!1);return Object.defineProperty($t,"SUPPORT_FOREIGNOBJECT_DRAWING",{value:A}),A},get SUPPORT_CORS_IMAGES(){var A=Nb();return Object.defineProperty($t,"SUPPORT_CORS_IMAGES",{value:A}),A},get SUPPORT_RESPONSE_TYPE(){var A=Rb();return Object.defineProperty($t,"SUPPORT_RESPONSE_TYPE",{value:A}),A},get SUPPORT_CORS_XHR(){var A="withCredentials"in new XMLHttpRequest;return Object.defineProperty($t,"SUPPORT_CORS_XHR",{value:A}),A},get SUPPORT_NATIVE_TEXT_SEGMENTATION(){var A=!!(typeof Intl<"u"&&Intl.Segmenter);return Object.defineProperty($t,"SUPPORT_NATIVE_TEXT_SEGMENTATION",{value:A}),A}},gs=(function(){function A(t,e){this.text=t,this.bounds=e}return A})(),Ob=function(A,t,e,n){var s=Wb(t,e),r=[],i=0;return s.forEach(function(o){if(e.textDecorationLine.length||o.trim().length>0)if($t.SUPPORT_RANGE_BOUNDS){var a=Id(n,i,o.length).getClientRects();if(a.length>1){var l=xl(o),d=0;l.forEach(function(h){r.push(new gs(h,hA.fromDOMRectList(A,Id(n,d+i,h.length).getClientRects()))),d+=h.length})}else r.push(new gs(o,hA.fromDOMRectList(A,a)))}else{var u=n.splitText(o.length);r.push(new gs(o,Kb(A,n))),n=u}else $t.SUPPORT_RANGE_BOUNDS||(n=n.splitText(o.length));i+=o.length}),r},Kb=function(A,t){var e=t.ownerDocument;if(e){var n=e.createElement("html2canvaswrapper");n.appendChild(t.cloneNode(!0));var s=t.parentNode;if(s){s.replaceChild(n,t);var r=Mi(A,n);return n.firstChild&&s.replaceChild(n.firstChild,n),r}}return hA.EMPTY},Id=function(A,t,e){var n=A.ownerDocument;if(!n)throw new Error("Node has no owner document");var s=n.createRange();return s.setStart(A,t),s.setEnd(A,t+e),s},xl=function(A){if($t.SUPPORT_NATIVE_TEXT_SEGMENTATION){var t=new Intl.Segmenter(void 0,{granularity:"grapheme"});return Array.from(t.segment(A)).map(function(e){return e.segment})}return Lb(A)},Gb=function(A,t){if($t.SUPPORT_NATIVE_TEXT_SEGMENTATION){var e=new Intl.Segmenter(void 0,{granularity:"word"});return Array.from(e.segment(A)).map(function(n){return n.segment})}return zb(A,t)},Wb=function(A,t){return t.letterSpacing!==0?xl(A):Gb(A,t)},Vb=[32,160,4961,65792,65793,4153,4241],zb=function(A,t){for(var e=wv(A,{lineBreak:t.lineBreak,wordBreak:t.overflowWrap==="break-word"?"break-word":t.wordBreak}),n=[],s,r=function(){if(s.value){var i=s.value.slice(),o=Ti(i),a="";o.forEach(function(l){Vb.indexOf(l)===-1?a+=Lt(l):(a.length&&n.push(a),n.push(Lt(l)),a="")}),a.length&&n.push(a)}};!(s=e.next()).done;)r();return n},qb=(function(){function A(t,e,n){this.text=Xb(e.data,n.textTransform),this.textBounds=Ob(t,this.text,n,e)}return A})(),Xb=function(A,t){switch(t){case 1:return A.toLowerCase();case 3:return A.replace($b,Yb);case 2:return A.toUpperCase();default:return A}},$b=/(^|\s|:|-|\(|\))([a-z])/g,Yb=function(A,t,e){return A.length>0?t+e.toUpperCase():A},Zh=(function(A){Re(t,A);function t(e,n){var s=A.call(this,e,n)||this;return s.src=n.currentSrc||n.src,s.intrinsicWidth=n.naturalWidth,s.intrinsicHeight=n.naturalHeight,s.context.cache.addImage(s.src),s}return t})(Ze),tf=(function(A){Re(t,A);function t(e,n){var s=A.call(this,e,n)||this;return s.canvas=n,s.intrinsicWidth=n.width,s.intrinsicHeight=n.height,s}return t})(Ze),ef=(function(A){Re(t,A);function t(e,n){var s=A.call(this,e,n)||this,r=new XMLSerializer,i=Mi(e,n);return n.setAttribute("width",i.width+"px"),n.setAttribute("height",i.height+"px"),s.svg="data:image/svg+xml,"+encodeURIComponent(r.serializeToString(n)),s.intrinsicWidth=n.width.baseVal.value,s.intrinsicHeight=n.height.baseVal.value,s.context.cache.addImage(s.svg),s}return t})(Ze),Af=(function(A){Re(t,A);function t(e,n){var s=A.call(this,e,n)||this;return s.value=n.value,s}return t})(Ze),Ia=(function(A){Re(t,A);function t(e,n){var s=A.call(this,e,n)||this;return s.start=n.start,s.reversed=typeof n.reversed=="boolean"&&n.reversed===!0,s}return t})(Ze),Jb=[{type:15,flags:0,unit:"px",number:3}],jb=[{type:16,flags:0,number:50}],Zb=function(A){return A.width>A.height?new hA(A.left+(A.width-A.height)/2,A.top,A.height,A.height):A.width<A.height?new hA(A.left,A.top+(A.height-A.width)/2,A.width,A.width):A},ty=function(A){var t=A.type===ey?new Array(A.value.length+1).join(""):A.value;return t.length===0?A.placeholder||"":t},ai="checkbox",li="radio",ey="password",xd=707406591,Ul=(function(A){Re(t,A);function t(e,n){var s=A.call(this,e,n)||this;switch(s.type=n.type.toLowerCase(),s.checked=n.checked,s.value=ty(n),(s.type===ai||s.type===li)&&(s.styles.backgroundColor=3739148031,s.styles.borderTopColor=s.styles.borderRightColor=s.styles.borderBottomColor=s.styles.borderLeftColor=2779096575,s.styles.borderTopWidth=s.styles.borderRightWidth=s.styles.borderBottomWidth=s.styles.borderLeftWidth=1,s.styles.borderTopStyle=s.styles.borderRightStyle=s.styles.borderBottomStyle=s.styles.borderLeftStyle=1,s.styles.backgroundClip=[0],s.styles.backgroundOrigin=[0],s.bounds=Zb(s.bounds)),s.type){case ai:s.styles.borderTopRightRadius=s.styles.borderTopLeftRadius=s.styles.borderBottomRightRadius=s.styles.borderBottomLeftRadius=Jb;break;case li:s.styles.borderTopRightRadius=s.styles.borderTopLeftRadius=s.styles.borderBottomRightRadius=s.styles.borderBottomLeftRadius=jb;break}return s}return t})(Ze),nf=(function(A){Re(t,A);function t(e,n){var s=A.call(this,e,n)||this,r=n.options[n.selectedIndex||0];return s.value=r&&r.text||"",s}return t})(Ze),sf=(function(A){Re(t,A);function t(e,n){var s=A.call(this,e,n)||this;return s.value=n.value,s}return t})(Ze),rf=(function(A){Re(t,A);function t(e,n){var s=A.call(this,e,n)||this;s.src=n.src,s.width=parseInt(n.width,10)||0,s.height=parseInt(n.height,10)||0,s.backgroundColor=s.styles.backgroundColor;try{if(n.contentWindow&&n.contentWindow.document&&n.contentWindow.document.documentElement){s.tree=af(e,n.contentWindow.document.documentElement);var r=n.contentWindow.document.documentElement?hs(e,getComputedStyle(n.contentWindow.document.documentElement).backgroundColor):dA.TRANSPARENT,i=n.contentWindow.document.body?hs(e,getComputedStyle(n.contentWindow.document.body).backgroundColor):dA.TRANSPARENT;s.backgroundColor=MA(r)?MA(i)?s.styles.backgroundColor:i:r}}catch{}return s}return t})(Ze),Ay=["OL","UL","MENU"],kr=function(A,t,e,n){for(var s=t.firstChild,r=void 0;s;s=r)if(r=s.nextSibling,lf(s)&&s.data.trim().length>0)e.textNodes.push(new qb(A,s,e.styles));else if(dn(s))if(hf(s)&&s.assignedNodes)s.assignedNodes().forEach(function(o){return kr(A,o,e,n)});else{var i=of(A,s);i.styles.isVisible()&&(ny(s,i,n)?i.flags|=4:sy(i.styles)&&(i.flags|=2),Ay.indexOf(s.tagName)!==-1&&(i.flags|=8),e.elements.push(i),s.slot,s.shadowRoot?kr(A,s.shadowRoot,i,n):!ci(s)&&!cf(s)&&!di(s)&&kr(A,s,i,n))}},of=function(A,t){return Ua(t)?new Zh(A,t):df(t)?new tf(A,t):cf(t)?new ef(A,t):ry(t)?new Af(A,t):iy(t)?new Ia(A,t):oy(t)?new Ul(A,t):di(t)?new nf(A,t):ci(t)?new sf(A,t):uf(t)?new rf(A,t):new Ze(A,t)},af=function(A,t){var e=of(A,t);return e.flags|=4,kr(A,t,e,e),e},ny=function(A,t,e){return t.styles.isPositionedWithZIndex()||t.styles.opacity<1||t.styles.isTransformed()||Ml(A)&&e.styles.isTransparent()},sy=function(A){return A.isPositioned()||A.isFloating()},lf=function(A){return A.nodeType===Node.TEXT_NODE},dn=function(A){return A.nodeType===Node.ELEMENT_NODE},xa=function(A){return dn(A)&&typeof A.style<"u"&&!_r(A)},_r=function(A){return typeof A.className=="object"},ry=function(A){return A.tagName==="LI"},iy=function(A){return A.tagName==="OL"},oy=function(A){return A.tagName==="INPUT"},ay=function(A){return A.tagName==="HTML"},cf=function(A){return A.tagName==="svg"},Ml=function(A){return A.tagName==="BODY"},df=function(A){return A.tagName==="CANVAS"},Ud=function(A){return A.tagName==="VIDEO"},Ua=function(A){return A.tagName==="IMG"},uf=function(A){return A.tagName==="IFRAME"},Md=function(A){return A.tagName==="STYLE"},ly=function(A){return A.tagName==="SCRIPT"},ci=function(A){return A.tagName==="TEXTAREA"},di=function(A){return A.tagName==="SELECT"},hf=function(A){return A.tagName==="SLOT"},Td=function(A){return A.tagName.indexOf("-")>0},cy=(function(){function A(){this.counters={}}return A.prototype.getCounterValue=function(t){var e=this.counters[t];return e&&e.length?e[e.length-1]:1},A.prototype.getCounterValues=function(t){var e=this.counters[t];return e||[]},A.prototype.pop=function(t){var e=this;t.forEach(function(n){return e.counters[n].pop()})},A.prototype.parse=function(t){var e=this,n=t.counterIncrement,s=t.counterReset,r=!0;n!==null&&n.forEach(function(o){var a=e.counters[o.counter];a&&o.increment!==0&&(r=!1,a.length||a.push(1),a[Math.max(0,a.length-1)]+=o.increment)});var i=[];return r&&s.forEach(function(o){var a=e.counters[o.counter];i.push(o.counter),a||(a=e.counters[o.counter]=[]),a.push(o.reset)}),i},A})(),Pd={integers:[1e3,900,500,400,100,90,50,40,10,9,5,4,1],values:["M","CM","D","CD","C","XC","L","XL","X","IX","V","IV","I"]},Ld={integers:[9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,900,800,700,600,500,400,300,200,100,90,80,70,60,50,40,30,20,10,9,8,7,6,5,4,3,2,1],values:["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""]},dy={integers:[1e4,9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,400,300,200,100,90,80,70,60,50,40,30,20,19,18,17,16,15,10,9,8,7,6,5,4,3,2,1],values:["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""]},uy={integers:[1e4,9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,900,800,700,600,500,400,300,200,100,90,80,70,60,50,40,30,20,10,9,8,7,6,5,4,3,2,1],values:["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""]},en=function(A,t,e,n,s,r){return A<t||A>e?Ns(A,s,r.length>0):n.integers.reduce(function(i,o,a){for(;A>=o;)A-=o,i+=n.values[a];return i},"")+r},ff=function(A,t,e,n){var s="";do e||A--,s=n(A)+s,A/=t;while(A*t>=t);return s},Pt=function(A,t,e,n,s){var r=e-t+1;return(A<0?"-":"")+(ff(Math.abs(A),r,n,function(i){return Lt(Math.floor(i%r)+t)})+s)},RA=function(A,t,e){e===void 0&&(e=". ");var n=t.length;return ff(Math.abs(A),n,!1,function(s){return t[Math.floor(s%n)]})+e},on=1,pA=2,BA=4,Jn=8,AA=function(A,t,e,n,s,r){if(A<-9999||A>9999)return Ns(A,4,s.length>0);var i=Math.abs(A),o=s;if(i===0)return t[0]+o;for(var a=0;i>0&&a<=4;a++){var l=i%10;l===0&&Wt(r,on)&&o!==""?o=t[l]+o:l>1||l===1&&a===0||l===1&&a===1&&Wt(r,pA)||l===1&&a===1&&Wt(r,BA)&&A>100||l===1&&a>1&&Wt(r,Jn)?o=t[l]+(a>0?e[a-1]:"")+o:l===1&&a>0&&(o=e[a-1]+o),i=Math.floor(i/10)}return(A<0?n:"")+o},Hd="",Dd="",Nd="",Uo="",Ns=function(A,t,e){var n=e?". ":"",s=e?"":"",r=e?", ":"",i=e?" ":"";switch(t){case 0:return""+i;case 1:return""+i;case 2:return""+i;case 5:var o=Pt(A,48,57,!0,n);return o.length<4?"0"+o:o;case 4:return RA(A,"",s);case 6:return en(A,1,3999,Pd,3,n).toLowerCase();case 7:return en(A,1,3999,Pd,3,n);case 8:return Pt(A,945,969,!1,n);case 9:return Pt(A,97,122,!1,n);case 10:return Pt(A,65,90,!1,n);case 11:return Pt(A,1632,1641,!0,n);case 12:case 49:return en(A,1,9999,Ld,3,n);case 35:return en(A,1,9999,Ld,3,n).toLowerCase();case 13:return Pt(A,2534,2543,!0,n);case 14:case 30:return Pt(A,6112,6121,!0,n);case 15:return RA(A,"",s);case 16:return RA(A,"",s);case 17:case 48:return AA(A,"",Hd,"",s,pA|BA|Jn);case 47:return AA(A,"",Dd,"",s,on|pA|BA|Jn);case 42:return AA(A,"",Hd,"",s,pA|BA|Jn);case 41:return AA(A,"",Dd,"",s,on|pA|BA|Jn);case 26:return AA(A,"","",Nd,s,0);case 25:return AA(A,"","",Nd,s,on|pA|BA);case 31:return AA(A,"","",Uo,r,on|pA|BA);case 33:return AA(A,"","",Uo,r,0);case 32:return AA(A,"","",Uo,r,on|pA|BA);case 18:return Pt(A,2406,2415,!0,n);case 20:return en(A,1,19999,uy,3,n);case 21:return Pt(A,2790,2799,!0,n);case 22:return Pt(A,2662,2671,!0,n);case 22:return en(A,1,10999,dy,3,n);case 23:return RA(A,"");case 24:return RA(A,"");case 27:return Pt(A,3302,3311,!0,n);case 28:return RA(A,"",s);case 29:return RA(A,"",s);case 34:return Pt(A,3792,3801,!0,n);case 37:return Pt(A,6160,6169,!0,n);case 38:return Pt(A,4160,4169,!0,n);case 39:return Pt(A,2918,2927,!0,n);case 40:return Pt(A,1776,1785,!0,n);case 43:return Pt(A,3046,3055,!0,n);case 44:return Pt(A,3174,3183,!0,n);case 45:return Pt(A,3664,3673,!0,n);case 46:return Pt(A,3872,3881,!0,n);default:return Pt(A,48,57,!0,n)}},gf="data-html2canvas-ignore",Rd=(function(){function A(t,e,n){if(this.context=t,this.options=n,this.scrolledElements=[],this.referenceElement=e,this.counters=new cy,this.quoteDepth=0,!e.ownerDocument)throw new Error("Cloned element does not have an owner document");this.documentElement=this.cloneNode(e.ownerDocument.documentElement,!1)}return A.prototype.toIFrame=function(t,e){var n=this,s=hy(t,e);if(!s.contentWindow)return Promise.reject("Unable to find iframe window");var r=t.defaultView.pageXOffset,i=t.defaultView.pageYOffset,o=s.contentWindow,a=o.document,l=my(s).then(function(){return ie(n,void 0,void 0,function(){var d,u;return Zt(this,function(h){switch(h.label){case 0:return this.scrolledElements.forEach(vy),o&&(o.scrollTo(e.left,e.top),/(iPad|iPhone|iPod)/g.test(navigator.userAgent)&&(o.scrollY!==e.top||o.scrollX!==e.left)&&(this.context.logger.warn("Unable to restore scroll position for cloned document"),this.context.windowBounds=this.context.windowBounds.add(o.scrollX-e.left,o.scrollY-e.top,0,0))),d=this.options.onclone,u=this.clonedReferenceElement,typeof u>"u"?[2,Promise.reject("Error finding the "+this.referenceElement.nodeName+" in the cloned document")]:a.fonts&&a.fonts.ready?[4,a.fonts.ready]:[3,2];case 1:h.sent(),h.label=2;case 2:return/(AppleWebKit)/g.test(navigator.userAgent)?[4,gy(a)]:[3,4];case 3:h.sent(),h.label=4;case 4:return typeof d=="function"?[2,Promise.resolve().then(function(){return d(a,u)}).then(function(){return s})]:[2,s]}})})});return a.open(),a.write(By(document.doctype)+"<html></html>"),wy(this.referenceElement.ownerDocument,r,i),a.replaceChild(a.adoptNode(this.documentElement),a.documentElement),a.close(),l},A.prototype.createElementClone=function(t){if(Qa(t,2))debugger;if(df(t))return this.createCanvasClone(t);if(Ud(t))return this.createVideoClone(t);if(Md(t))return this.createStyleClone(t);var e=t.cloneNode(!1);return Ua(e)&&(Ua(t)&&t.currentSrc&&t.currentSrc!==t.src&&(e.src=t.currentSrc,e.srcset=""),e.loading==="lazy"&&(e.loading="eager")),Td(e)?this.createCustomElementClone(e):e},A.prototype.createCustomElementClone=function(t){var e=document.createElement("html2canvascustomelement");return Mo(t.style,e),e},A.prototype.createStyleClone=function(t){try{var e=t.sheet;if(e&&e.cssRules){var n=[].slice.call(e.cssRules,0).reduce(function(r,i){return i&&typeof i.cssText=="string"?r+i.cssText:r},""),s=t.cloneNode(!1);return s.textContent=n,s}}catch(r){if(this.context.logger.error("Unable to access cssRules property",r),r.name!=="SecurityError")throw r}return t.cloneNode(!1)},A.prototype.createCanvasClone=function(t){var e;if(this.options.inlineImages&&t.ownerDocument){var n=t.ownerDocument.createElement("img");try{return n.src=t.toDataURL(),n}catch{this.context.logger.info("Unable to inline canvas contents, canvas is tainted",t)}}var s=t.cloneNode(!1);try{s.width=t.width,s.height=t.height;var r=t.getContext("2d"),i=s.getContext("2d");if(i)if(!this.options.allowTaint&&r)i.putImageData(r.getImageData(0,0,t.width,t.height),0,0);else{var o=(e=t.getContext("webgl2"))!==null&&e!==void 0?e:t.getContext("webgl");if(o){var a=o.getContextAttributes();a?.preserveDrawingBuffer===!1&&this.context.logger.warn("Unable to clone WebGL context as it has preserveDrawingBuffer=false",t)}i.drawImage(t,0,0)}return s}catch{this.context.logger.info("Unable to clone canvas as it is tainted",t)}return s},A.prototype.createVideoClone=function(t){var e=t.ownerDocument.createElement("canvas");e.width=t.offsetWidth,e.height=t.offsetHeight;var n=e.getContext("2d");try{return n&&(n.drawImage(t,0,0,e.width,e.height),this.options.allowTaint||n.getImageData(0,0,e.width,e.height)),e}catch{this.context.logger.info("Unable to clone video as it is tainted",t)}var s=t.ownerDocument.createElement("canvas");return s.width=t.offsetWidth,s.height=t.offsetHeight,s},A.prototype.appendChildNode=function(t,e,n){(!dn(e)||!ly(e)&&!e.hasAttribute(gf)&&(typeof this.options.ignoreElements!="function"||!this.options.ignoreElements(e)))&&(!this.options.copyStyles||!dn(e)||!Md(e))&&t.appendChild(this.cloneNode(e,n))},A.prototype.cloneChildNodes=function(t,e,n){for(var s=this,r=t.shadowRoot?t.shadowRoot.firstChild:t.firstChild;r;r=r.nextSibling)if(dn(r)&&hf(r)&&typeof r.assignedNodes=="function"){var i=r.assignedNodes();i.length&&i.forEach(function(o){return s.appendChildNode(e,o,n)})}else this.appendChildNode(e,r,n)},A.prototype.cloneNode=function(t,e){if(lf(t))return document.createTextNode(t.data);if(!t.ownerDocument)return t.cloneNode(!1);var n=t.ownerDocument.defaultView;if(n&&dn(t)&&(xa(t)||_r(t))){var s=this.createElementClone(t);s.style.transitionProperty="none";var r=n.getComputedStyle(t),i=n.getComputedStyle(t,":before"),o=n.getComputedStyle(t,":after");this.referenceElement===t&&xa(s)&&(this.clonedReferenceElement=s),Ml(s)&&yy(s);var a=this.counters.parse(new gd(this.context,r)),l=this.resolvePseudoContent(t,s,i,ms.BEFORE);Td(t)&&(e=!0),Ud(t)||this.cloneChildNodes(t,s,e),l&&s.insertBefore(l,s.firstChild);var d=this.resolvePseudoContent(t,s,o,ms.AFTER);return d&&s.appendChild(d),this.counters.pop(a),(r&&(this.options.copyStyles||_r(t))&&!uf(t)||e)&&Mo(r,s),(t.scrollTop!==0||t.scrollLeft!==0)&&this.scrolledElements.push([s,t.scrollLeft,t.scrollTop]),(ci(t)||di(t))&&(ci(s)||di(s))&&(s.value=t.value),s}return t.cloneNode(!1)},A.prototype.resolvePseudoContent=function(t,e,n,s){var r=this;if(n){var i=n.content,o=e.ownerDocument;if(!(!o||!i||i==="none"||i==="-moz-alt-content"||n.display==="none")){this.counters.parse(new gd(this.context,n));var a=new rb(this.context,n),l=o.createElement("html2canvaspseudoelement");Mo(n,l),a.content.forEach(function(u){if(u.type===0)l.appendChild(o.createTextNode(u.value));else if(u.type===22){var h=o.createElement("img");h.src=u.value,h.style.opacity="1",l.appendChild(h)}else if(u.type===18){if(u.name==="attr"){var m=u.values.filter(Qt);m.length&&l.appendChild(o.createTextNode(t.getAttribute(m[0].value)||""))}else if(u.name==="counter"){var f=u.values.filter(xn),g=f[0],p=f[1];if(g&&Qt(g)){var w=r.counters.getCounterValue(g.value),v=p&&Qt(p)?Ea.parse(r.context,p.value):3;l.appendChild(o.createTextNode(Ns(w,v,!1)))}}else if(u.name==="counters"){var C=u.values.filter(xn),g=C[0],F=C[1],p=C[2];if(g&&Qt(g)){var E=r.counters.getCounterValues(g.value),b=p&&Qt(p)?Ea.parse(r.context,p.value):3,S=F&&F.type===0?F.value:"",y=E.map(function(U){return Ns(U,b,!1)}).join(S);l.appendChild(o.createTextNode(y))}}}else if(u.type===20)switch(u.value){case"open-quote":l.appendChild(o.createTextNode(fd(a.quotes,r.quoteDepth++,!0)));break;case"close-quote":l.appendChild(o.createTextNode(fd(a.quotes,--r.quoteDepth,!1)));break;default:l.appendChild(o.createTextNode(u.value))}}),l.className=Ma+" "+Ta;var d=s===ms.BEFORE?" "+Ma:" "+Ta;return _r(e)?e.className.baseValue+=d:e.className+=d,l}}},A.destroy=function(t){return t.parentNode?(t.parentNode.removeChild(t),!0):!1},A})(),ms;(function(A){A[A.BEFORE=0]="BEFORE",A[A.AFTER=1]="AFTER"})(ms||(ms={}));var hy=function(A,t){var e=A.createElement("iframe");return e.className="html2canvas-container",e.style.visibility="hidden",e.style.position="fixed",e.style.left="-10000px",e.style.top="0px",e.style.border="0",e.width=t.width.toString(),e.height=t.height.toString(),e.scrolling="no",e.setAttribute(gf,"true"),A.body.appendChild(e),e},fy=function(A){return new Promise(function(t){if(A.complete){t();return}if(!A.src){t();return}A.onload=t,A.onerror=t})},gy=function(A){return Promise.all([].slice.call(A.images,0).map(fy))},my=function(A){return new Promise(function(t,e){var n=A.contentWindow;if(!n)return e("No window assigned for iframe");var s=n.document;n.onload=A.onload=function(){n.onload=A.onload=null;var r=setInterval(function(){s.body.childNodes.length>0&&s.readyState==="complete"&&(clearInterval(r),t(A))},50)}})},py=["all","d","content"],Mo=function(A,t){for(var e=A.length-1;e>=0;e--){var n=A.item(e);py.indexOf(n)===-1&&t.style.setProperty(n,A.getPropertyValue(n))}return t},By=function(A){var t="";return A&&(t+="<!DOCTYPE ",A.name&&(t+=A.name),A.internalSubset&&(t+=A.internalSubset),A.publicId&&(t+='"'+A.publicId+'"'),A.systemId&&(t+='"'+A.systemId+'"'),t+=">"),t},wy=function(A,t,e){A&&A.defaultView&&(t!==A.defaultView.pageXOffset||e!==A.defaultView.pageYOffset)&&A.defaultView.scrollTo(t,e)},vy=function(A){var t=A[0],e=A[1],n=A[2];t.scrollLeft=e,t.scrollTop=n},Cy=":before",by=":after",Ma="___html2canvas___pseudoelement_before",Ta="___html2canvas___pseudoelement_after",kd=`{
    content: "" !important;
    display: none !important;
}`,yy=function(A){Sy(A,"."+Ma+Cy+kd+`
         .`+Ta+by+kd)},Sy=function(A,t){var e=A.ownerDocument;if(e){var n=e.createElement("style");n.textContent=t,A.appendChild(n)}},mf=(function(){function A(){}return A.getOrigin=function(t){var e=A._link;return e?(e.href=t,e.href=e.href,e.protocol+e.hostname+e.port):"about:blank"},A.isSameOrigin=function(t){return A.getOrigin(t)===A._origin},A.setContext=function(t){A._link=t.document.createElement("a"),A._origin=A.getOrigin(t.location.href)},A._origin="about:blank",A})(),Ey=(function(){function A(t,e){this.context=t,this._options=e,this._cache={}}return A.prototype.addImage=function(t){var e=Promise.resolve();return this.has(t)||(Po(t)||xy(t))&&(this._cache[t]=this.loadImage(t)).catch(function(){}),e},A.prototype.match=function(t){return this._cache[t]},A.prototype.loadImage=function(t){return ie(this,void 0,void 0,function(){var e,n,s,r,i=this;return Zt(this,function(o){switch(o.label){case 0:return e=mf.isSameOrigin(t),n=!To(t)&&this._options.useCORS===!0&&$t.SUPPORT_CORS_IMAGES&&!e,s=!To(t)&&!e&&!Po(t)&&typeof this._options.proxy=="string"&&$t.SUPPORT_CORS_XHR&&!n,!e&&this._options.allowTaint===!1&&!To(t)&&!Po(t)&&!s&&!n?[2]:(r=t,s?[4,this.proxy(r)]:[3,2]);case 1:r=o.sent(),o.label=2;case 2:return this.context.logger.debug("Added image "+t.substring(0,256)),[4,new Promise(function(a,l){var d=new Image;d.onload=function(){return a(d)},d.onerror=l,(Uy(r)||n)&&(d.crossOrigin="anonymous"),d.src=r,d.complete===!0&&setTimeout(function(){return a(d)},500),i._options.imageTimeout>0&&setTimeout(function(){return l("Timed out ("+i._options.imageTimeout+"ms) loading image")},i._options.imageTimeout)})];case 3:return[2,o.sent()]}})})},A.prototype.has=function(t){return typeof this._cache[t]<"u"},A.prototype.keys=function(){return Promise.resolve(Object.keys(this._cache))},A.prototype.proxy=function(t){var e=this,n=this._options.proxy;if(!n)throw new Error("No proxy defined");var s=t.substring(0,256);return new Promise(function(r,i){var o=$t.SUPPORT_RESPONSE_TYPE?"blob":"text",a=new XMLHttpRequest;a.onload=function(){if(a.status===200)if(o==="text")r(a.response);else{var u=new FileReader;u.addEventListener("load",function(){return r(u.result)},!1),u.addEventListener("error",function(h){return i(h)},!1),u.readAsDataURL(a.response)}else i("Failed to proxy resource "+s+" with status code "+a.status)},a.onerror=i;var l=n.indexOf("?")>-1?"&":"?";if(a.open("GET",""+n+l+"url="+encodeURIComponent(t)+"&responseType="+o),o!=="text"&&a instanceof XMLHttpRequest&&(a.responseType=o),e._options.imageTimeout){var d=e._options.imageTimeout;a.timeout=d,a.ontimeout=function(){return i("Timed out ("+d+"ms) proxying "+s)}}a.send()})},A})(),Qy=/^data:image\/svg\+xml/i,Fy=/^data:image\/.*;base64,/i,Iy=/^data:image\/.*/i,xy=function(A){return $t.SUPPORT_SVG_DRAWING||!My(A)},To=function(A){return Iy.test(A)},Uy=function(A){return Fy.test(A)},Po=function(A){return A.substr(0,4)==="blob"},My=function(A){return A.substr(-3).toLowerCase()==="svg"||Qy.test(A)},J=(function(){function A(t,e){this.type=0,this.x=t,this.y=e}return A.prototype.add=function(t,e){return new A(this.x+t,this.y+e)},A})(),An=function(A,t,e){return new J(A.x+(t.x-A.x)*e,A.y+(t.y-A.y)*e)},wr=(function(){function A(t,e,n,s){this.type=1,this.start=t,this.startControl=e,this.endControl=n,this.end=s}return A.prototype.subdivide=function(t,e){var n=An(this.start,this.startControl,t),s=An(this.startControl,this.endControl,t),r=An(this.endControl,this.end,t),i=An(n,s,t),o=An(s,r,t),a=An(i,o,t);return e?new A(this.start,n,i,a):new A(a,o,r,this.end)},A.prototype.add=function(t,e){return new A(this.start.add(t,e),this.startControl.add(t,e),this.endControl.add(t,e),this.end.add(t,e))},A.prototype.reverse=function(){return new A(this.end,this.endControl,this.startControl,this.start)},A})(),Se=function(A){return A.type===1},Ty=(function(){function A(t){var e=t.styles,n=t.bounds,s=$n(e.borderTopLeftRadius,n.width,n.height),r=s[0],i=s[1],o=$n(e.borderTopRightRadius,n.width,n.height),a=o[0],l=o[1],d=$n(e.borderBottomRightRadius,n.width,n.height),u=d[0],h=d[1],m=$n(e.borderBottomLeftRadius,n.width,n.height),f=m[0],g=m[1],p=[];p.push((r+a)/n.width),p.push((f+u)/n.width),p.push((i+g)/n.height),p.push((l+h)/n.height);var w=Math.max.apply(Math,p);w>1&&(r/=w,i/=w,a/=w,l/=w,u/=w,h/=w,f/=w,g/=w);var v=n.width-a,C=n.height-h,F=n.width-u,E=n.height-g,b=e.borderTopWidth,S=e.borderRightWidth,y=e.borderBottomWidth,I=e.borderLeftWidth,Q=Ft(e.paddingTop,t.bounds.width),U=Ft(e.paddingRight,t.bounds.width),M=Ft(e.paddingBottom,t.bounds.width),P=Ft(e.paddingLeft,t.bounds.width);this.topLeftBorderDoubleOuterBox=r>0||i>0?xt(n.left+I/3,n.top+b/3,r-I/3,i-b/3,bt.TOP_LEFT):new J(n.left+I/3,n.top+b/3),this.topRightBorderDoubleOuterBox=r>0||i>0?xt(n.left+v,n.top+b/3,a-S/3,l-b/3,bt.TOP_RIGHT):new J(n.left+n.width-S/3,n.top+b/3),this.bottomRightBorderDoubleOuterBox=u>0||h>0?xt(n.left+F,n.top+C,u-S/3,h-y/3,bt.BOTTOM_RIGHT):new J(n.left+n.width-S/3,n.top+n.height-y/3),this.bottomLeftBorderDoubleOuterBox=f>0||g>0?xt(n.left+I/3,n.top+E,f-I/3,g-y/3,bt.BOTTOM_LEFT):new J(n.left+I/3,n.top+n.height-y/3),this.topLeftBorderDoubleInnerBox=r>0||i>0?xt(n.left+I*2/3,n.top+b*2/3,r-I*2/3,i-b*2/3,bt.TOP_LEFT):new J(n.left+I*2/3,n.top+b*2/3),this.topRightBorderDoubleInnerBox=r>0||i>0?xt(n.left+v,n.top+b*2/3,a-S*2/3,l-b*2/3,bt.TOP_RIGHT):new J(n.left+n.width-S*2/3,n.top+b*2/3),this.bottomRightBorderDoubleInnerBox=u>0||h>0?xt(n.left+F,n.top+C,u-S*2/3,h-y*2/3,bt.BOTTOM_RIGHT):new J(n.left+n.width-S*2/3,n.top+n.height-y*2/3),this.bottomLeftBorderDoubleInnerBox=f>0||g>0?xt(n.left+I*2/3,n.top+E,f-I*2/3,g-y*2/3,bt.BOTTOM_LEFT):new J(n.left+I*2/3,n.top+n.height-y*2/3),this.topLeftBorderStroke=r>0||i>0?xt(n.left+I/2,n.top+b/2,r-I/2,i-b/2,bt.TOP_LEFT):new J(n.left+I/2,n.top+b/2),this.topRightBorderStroke=r>0||i>0?xt(n.left+v,n.top+b/2,a-S/2,l-b/2,bt.TOP_RIGHT):new J(n.left+n.width-S/2,n.top+b/2),this.bottomRightBorderStroke=u>0||h>0?xt(n.left+F,n.top+C,u-S/2,h-y/2,bt.BOTTOM_RIGHT):new J(n.left+n.width-S/2,n.top+n.height-y/2),this.bottomLeftBorderStroke=f>0||g>0?xt(n.left+I/2,n.top+E,f-I/2,g-y/2,bt.BOTTOM_LEFT):new J(n.left+I/2,n.top+n.height-y/2),this.topLeftBorderBox=r>0||i>0?xt(n.left,n.top,r,i,bt.TOP_LEFT):new J(n.left,n.top),this.topRightBorderBox=a>0||l>0?xt(n.left+v,n.top,a,l,bt.TOP_RIGHT):new J(n.left+n.width,n.top),this.bottomRightBorderBox=u>0||h>0?xt(n.left+F,n.top+C,u,h,bt.BOTTOM_RIGHT):new J(n.left+n.width,n.top+n.height),this.bottomLeftBorderBox=f>0||g>0?xt(n.left,n.top+E,f,g,bt.BOTTOM_LEFT):new J(n.left,n.top+n.height),this.topLeftPaddingBox=r>0||i>0?xt(n.left+I,n.top+b,Math.max(0,r-I),Math.max(0,i-b),bt.TOP_LEFT):new J(n.left+I,n.top+b),this.topRightPaddingBox=a>0||l>0?xt(n.left+Math.min(v,n.width-S),n.top+b,v>n.width+S?0:Math.max(0,a-S),Math.max(0,l-b),bt.TOP_RIGHT):new J(n.left+n.width-S,n.top+b),this.bottomRightPaddingBox=u>0||h>0?xt(n.left+Math.min(F,n.width-I),n.top+Math.min(C,n.height-y),Math.max(0,u-S),Math.max(0,h-y),bt.BOTTOM_RIGHT):new J(n.left+n.width-S,n.top+n.height-y),this.bottomLeftPaddingBox=f>0||g>0?xt(n.left+I,n.top+Math.min(E,n.height-y),Math.max(0,f-I),Math.max(0,g-y),bt.BOTTOM_LEFT):new J(n.left+I,n.top+n.height-y),this.topLeftContentBox=r>0||i>0?xt(n.left+I+P,n.top+b+Q,Math.max(0,r-(I+P)),Math.max(0,i-(b+Q)),bt.TOP_LEFT):new J(n.left+I+P,n.top+b+Q),this.topRightContentBox=a>0||l>0?xt(n.left+Math.min(v,n.width+I+P),n.top+b+Q,v>n.width+I+P?0:a-I+P,l-(b+Q),bt.TOP_RIGHT):new J(n.left+n.width-(S+U),n.top+b+Q),this.bottomRightContentBox=u>0||h>0?xt(n.left+Math.min(F,n.width-(I+P)),n.top+Math.min(C,n.height+b+Q),Math.max(0,u-(S+U)),h-(y+M),bt.BOTTOM_RIGHT):new J(n.left+n.width-(S+U),n.top+n.height-(y+M)),this.bottomLeftContentBox=f>0||g>0?xt(n.left+I+P,n.top+E,Math.max(0,f-(I+P)),g-(y+M),bt.BOTTOM_LEFT):new J(n.left+I+P,n.top+n.height-(y+M))}return A})(),bt;(function(A){A[A.TOP_LEFT=0]="TOP_LEFT",A[A.TOP_RIGHT=1]="TOP_RIGHT",A[A.BOTTOM_RIGHT=2]="BOTTOM_RIGHT",A[A.BOTTOM_LEFT=3]="BOTTOM_LEFT"})(bt||(bt={}));var xt=function(A,t,e,n,s){var r=4*((Math.sqrt(2)-1)/3),i=e*r,o=n*r,a=A+e,l=t+n;switch(s){case bt.TOP_LEFT:return new wr(new J(A,l),new J(A,l-o),new J(a-i,t),new J(a,t));case bt.TOP_RIGHT:return new wr(new J(A,t),new J(A+i,t),new J(a,l-o),new J(a,l));case bt.BOTTOM_RIGHT:return new wr(new J(a,t),new J(a,t+o),new J(A+i,l),new J(A,l));case bt.BOTTOM_LEFT:default:return new wr(new J(a,l),new J(a-i,l),new J(A,t+o),new J(A,t))}},ui=function(A){return[A.topLeftBorderBox,A.topRightBorderBox,A.bottomRightBorderBox,A.bottomLeftBorderBox]},Py=function(A){return[A.topLeftContentBox,A.topRightContentBox,A.bottomRightContentBox,A.bottomLeftContentBox]},hi=function(A){return[A.topLeftPaddingBox,A.topRightPaddingBox,A.bottomRightPaddingBox,A.bottomLeftPaddingBox]},Ly=(function(){function A(t,e,n){this.offsetX=t,this.offsetY=e,this.matrix=n,this.type=0,this.target=6}return A})(),vr=(function(){function A(t,e){this.path=t,this.target=e,this.type=1}return A})(),Hy=(function(){function A(t){this.opacity=t,this.type=2,this.target=6}return A})(),Dy=function(A){return A.type===0},pf=function(A){return A.type===1},Ny=function(A){return A.type===2},_d=function(A,t){return A.length===t.length?A.some(function(e,n){return e===t[n]}):!1},Ry=function(A,t,e,n,s){return A.map(function(r,i){switch(i){case 0:return r.add(t,e);case 1:return r.add(t+n,e);case 2:return r.add(t+n,e+s);case 3:return r.add(t,e+s)}return r})},Bf=(function(){function A(t){this.element=t,this.inlineLevel=[],this.nonInlineLevel=[],this.negativeZIndex=[],this.zeroOrAutoZIndexOrTransformedOrOpacity=[],this.positiveZIndex=[],this.nonPositionedFloats=[],this.nonPositionedInlineLevel=[]}return A})(),wf=(function(){function A(t,e){if(this.container=t,this.parent=e,this.effects=[],this.curves=new Ty(this.container),this.container.styles.opacity<1&&this.effects.push(new Hy(this.container.styles.opacity)),this.container.styles.transform!==null){var n=this.container.bounds.left+this.container.styles.transformOrigin[0].number,s=this.container.bounds.top+this.container.styles.transformOrigin[1].number,r=this.container.styles.transform;this.effects.push(new Ly(n,s,r))}if(this.container.styles.overflowX!==0){var i=ui(this.curves),o=hi(this.curves);_d(i,o)?this.effects.push(new vr(i,6)):(this.effects.push(new vr(i,2)),this.effects.push(new vr(o,4)))}}return A.prototype.getEffects=function(t){for(var e=[2,3].indexOf(this.container.styles.position)===-1,n=this.parent,s=this.effects.slice(0);n;){var r=n.effects.filter(function(a){return!pf(a)});if(e||n.container.styles.position!==0||!n.parent){if(s.unshift.apply(s,r),e=[2,3].indexOf(n.container.styles.position)===-1,n.container.styles.overflowX!==0){var i=ui(n.curves),o=hi(n.curves);_d(i,o)||s.unshift(new vr(o,6))}}else s.unshift.apply(s,r);n=n.parent}return s.filter(function(a){return Wt(a.target,t)})},A})(),Pa=function(A,t,e,n){A.container.elements.forEach(function(s){var r=Wt(s.flags,4),i=Wt(s.flags,2),o=new wf(s,A);Wt(s.styles.display,2048)&&n.push(o);var a=Wt(s.flags,8)?[]:n;if(r||i){var l=r||s.styles.isPositioned()?e:t,d=new Bf(o);if(s.styles.isPositioned()||s.styles.opacity<1||s.styles.isTransformed()){var u=s.styles.zIndex.order;if(u<0){var h=0;l.negativeZIndex.some(function(f,g){return u>f.element.container.styles.zIndex.order?(h=g,!1):h>0}),l.negativeZIndex.splice(h,0,d)}else if(u>0){var m=0;l.positiveZIndex.some(function(f,g){return u>=f.element.container.styles.zIndex.order?(m=g+1,!1):m>0}),l.positiveZIndex.splice(m,0,d)}else l.zeroOrAutoZIndexOrTransformedOrOpacity.push(d)}else s.styles.isFloating()?l.nonPositionedFloats.push(d):l.nonPositionedInlineLevel.push(d);Pa(o,d,r?d:e,a)}else s.styles.isInlineLevel()?t.inlineLevel.push(o):t.nonInlineLevel.push(o),Pa(o,t,e,a);Wt(s.flags,8)&&vf(s,a)})},vf=function(A,t){for(var e=A instanceof Ia?A.start:1,n=A instanceof Ia?A.reversed:!1,s=0;s<t.length;s++){var r=t[s];r.container instanceof Af&&typeof r.container.value=="number"&&r.container.value!==0&&(e=r.container.value),r.listValue=Ns(e,r.container.styles.listStyleType,!0),e+=n?-1:1}},ky=function(A){var t=new wf(A,null),e=new Bf(t),n=[];return Pa(t,e,e,n),vf(t.container,n),e},Od=function(A,t){switch(t){case 0:return Qe(A.topLeftBorderBox,A.topLeftPaddingBox,A.topRightBorderBox,A.topRightPaddingBox);case 1:return Qe(A.topRightBorderBox,A.topRightPaddingBox,A.bottomRightBorderBox,A.bottomRightPaddingBox);case 2:return Qe(A.bottomRightBorderBox,A.bottomRightPaddingBox,A.bottomLeftBorderBox,A.bottomLeftPaddingBox);default:return Qe(A.bottomLeftBorderBox,A.bottomLeftPaddingBox,A.topLeftBorderBox,A.topLeftPaddingBox)}},_y=function(A,t){switch(t){case 0:return Qe(A.topLeftBorderBox,A.topLeftBorderDoubleOuterBox,A.topRightBorderBox,A.topRightBorderDoubleOuterBox);case 1:return Qe(A.topRightBorderBox,A.topRightBorderDoubleOuterBox,A.bottomRightBorderBox,A.bottomRightBorderDoubleOuterBox);case 2:return Qe(A.bottomRightBorderBox,A.bottomRightBorderDoubleOuterBox,A.bottomLeftBorderBox,A.bottomLeftBorderDoubleOuterBox);default:return Qe(A.bottomLeftBorderBox,A.bottomLeftBorderDoubleOuterBox,A.topLeftBorderBox,A.topLeftBorderDoubleOuterBox)}},Oy=function(A,t){switch(t){case 0:return Qe(A.topLeftBorderDoubleInnerBox,A.topLeftPaddingBox,A.topRightBorderDoubleInnerBox,A.topRightPaddingBox);case 1:return Qe(A.topRightBorderDoubleInnerBox,A.topRightPaddingBox,A.bottomRightBorderDoubleInnerBox,A.bottomRightPaddingBox);case 2:return Qe(A.bottomRightBorderDoubleInnerBox,A.bottomRightPaddingBox,A.bottomLeftBorderDoubleInnerBox,A.bottomLeftPaddingBox);default:return Qe(A.bottomLeftBorderDoubleInnerBox,A.bottomLeftPaddingBox,A.topLeftBorderDoubleInnerBox,A.topLeftPaddingBox)}},Ky=function(A,t){switch(t){case 0:return Cr(A.topLeftBorderStroke,A.topRightBorderStroke);case 1:return Cr(A.topRightBorderStroke,A.bottomRightBorderStroke);case 2:return Cr(A.bottomRightBorderStroke,A.bottomLeftBorderStroke);default:return Cr(A.bottomLeftBorderStroke,A.topLeftBorderStroke)}},Cr=function(A,t){var e=[];return Se(A)?e.push(A.subdivide(.5,!1)):e.push(A),Se(t)?e.push(t.subdivide(.5,!0)):e.push(t),e},Qe=function(A,t,e,n){var s=[];return Se(A)?s.push(A.subdivide(.5,!1)):s.push(A),Se(e)?s.push(e.subdivide(.5,!0)):s.push(e),Se(n)?s.push(n.subdivide(.5,!0).reverse()):s.push(n),Se(t)?s.push(t.subdivide(.5,!1).reverse()):s.push(t),s},Cf=function(A){var t=A.bounds,e=A.styles;return t.add(e.borderLeftWidth,e.borderTopWidth,-(e.borderRightWidth+e.borderLeftWidth),-(e.borderTopWidth+e.borderBottomWidth))},fi=function(A){var t=A.styles,e=A.bounds,n=Ft(t.paddingLeft,e.width),s=Ft(t.paddingRight,e.width),r=Ft(t.paddingTop,e.width),i=Ft(t.paddingBottom,e.width);return e.add(n+t.borderLeftWidth,r+t.borderTopWidth,-(t.borderRightWidth+t.borderLeftWidth+n+s),-(t.borderTopWidth+t.borderBottomWidth+r+i))},Gy=function(A,t){return A===0?t.bounds:A===2?fi(t):Cf(t)},Wy=function(A,t){return A===0?t.bounds:A===2?fi(t):Cf(t)},Lo=function(A,t,e){var n=Gy(an(A.styles.backgroundOrigin,t),A),s=Wy(an(A.styles.backgroundClip,t),A),r=Vy(an(A.styles.backgroundSize,t),e,n),i=r[0],o=r[1],a=$n(an(A.styles.backgroundPosition,t),n.width-i,n.height-o),l=zy(an(A.styles.backgroundRepeat,t),a,r,n,s),d=Math.round(n.left+a[0]),u=Math.round(n.top+a[1]);return[l,d,u,i,o]},nn=function(A){return Qt(A)&&A.value===In.AUTO},br=function(A){return typeof A=="number"},Vy=function(A,t,e){var n=t[0],s=t[1],r=t[2],i=A[0],o=A[1];if(!i)return[0,0];if(Nt(i)&&o&&Nt(o))return[Ft(i,e.width),Ft(o,e.height)];var a=br(r);if(Qt(i)&&(i.value===In.CONTAIN||i.value===In.COVER)){if(br(r)){var l=e.width/e.height;return l<r!=(i.value===In.COVER)?[e.width,e.width/r]:[e.height*r,e.height]}return[e.width,e.height]}var d=br(n),u=br(s),h=d||u;if(nn(i)&&(!o||nn(o))){if(d&&u)return[n,s];if(!a&&!h)return[e.width,e.height];if(h&&a){var m=d?n:s*r,f=u?s:n/r;return[m,f]}var g=d?n:e.width,p=u?s:e.height;return[g,p]}if(a){var w=0,v=0;return Nt(i)?w=Ft(i,e.width):Nt(o)&&(v=Ft(o,e.height)),nn(i)?w=v*r:(!o||nn(o))&&(v=w/r),[w,v]}var C=null,F=null;if(Nt(i)?C=Ft(i,e.width):o&&Nt(o)&&(F=Ft(o,e.height)),C!==null&&(!o||nn(o))&&(F=d&&u?C/n*s:e.height),F!==null&&nn(i)&&(C=d&&u?F/s*n:e.width),C!==null&&F!==null)return[C,F];throw new Error("Unable to calculate background-size for element")},an=function(A,t){var e=A[t];return typeof e>"u"?A[0]:e},zy=function(A,t,e,n,s){var r=t[0],i=t[1],o=e[0],a=e[1];switch(A){case 2:return[new J(Math.round(n.left),Math.round(n.top+i)),new J(Math.round(n.left+n.width),Math.round(n.top+i)),new J(Math.round(n.left+n.width),Math.round(a+n.top+i)),new J(Math.round(n.left),Math.round(a+n.top+i))];case 3:return[new J(Math.round(n.left+r),Math.round(n.top)),new J(Math.round(n.left+r+o),Math.round(n.top)),new J(Math.round(n.left+r+o),Math.round(n.height+n.top)),new J(Math.round(n.left+r),Math.round(n.height+n.top))];case 1:return[new J(Math.round(n.left+r),Math.round(n.top+i)),new J(Math.round(n.left+r+o),Math.round(n.top+i)),new J(Math.round(n.left+r+o),Math.round(n.top+i+a)),new J(Math.round(n.left+r),Math.round(n.top+i+a))];default:return[new J(Math.round(s.left),Math.round(s.top)),new J(Math.round(s.left+s.width),Math.round(s.top)),new J(Math.round(s.left+s.width),Math.round(s.height+s.top)),new J(Math.round(s.left),Math.round(s.height+s.top))]}},qy="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",Kd="Hidden Text",Xy=(function(){function A(t){this._data={},this._document=t}return A.prototype.parseMetrics=function(t,e){var n=this._document.createElement("div"),s=this._document.createElement("img"),r=this._document.createElement("span"),i=this._document.body;n.style.visibility="hidden",n.style.fontFamily=t,n.style.fontSize=e,n.style.margin="0",n.style.padding="0",n.style.whiteSpace="nowrap",i.appendChild(n),s.src=qy,s.width=1,s.height=1,s.style.margin="0",s.style.padding="0",s.style.verticalAlign="baseline",r.style.fontFamily=t,r.style.fontSize=e,r.style.margin="0",r.style.padding="0",r.appendChild(this._document.createTextNode(Kd)),n.appendChild(r),n.appendChild(s);var o=s.offsetTop-r.offsetTop+2;n.removeChild(r),n.appendChild(this._document.createTextNode(Kd)),n.style.lineHeight="normal",s.style.verticalAlign="super";var a=s.offsetTop-n.offsetTop+2;return i.removeChild(n),{baseline:o,middle:a}},A.prototype.getMetrics=function(t,e){var n=t+" "+e;return typeof this._data[n]>"u"&&(this._data[n]=this.parseMetrics(t,e)),this._data[n]},A})(),bf=(function(){function A(t,e){this.context=t,this.options=e}return A})(),$y=1e4,Yy=(function(A){Re(t,A);function t(e,n){var s=A.call(this,e,n)||this;return s._activeEffects=[],s.canvas=n.canvas?n.canvas:document.createElement("canvas"),s.ctx=s.canvas.getContext("2d"),n.canvas||(s.canvas.width=Math.floor(n.width*n.scale),s.canvas.height=Math.floor(n.height*n.scale),s.canvas.style.width=n.width+"px",s.canvas.style.height=n.height+"px"),s.fontMetrics=new Xy(document),s.ctx.scale(s.options.scale,s.options.scale),s.ctx.translate(-n.x,-n.y),s.ctx.textBaseline="bottom",s._activeEffects=[],s.context.logger.debug("Canvas renderer initialized ("+n.width+"x"+n.height+") with scale "+n.scale),s}return t.prototype.applyEffects=function(e){for(var n=this;this._activeEffects.length;)this.popEffect();e.forEach(function(s){return n.applyEffect(s)})},t.prototype.applyEffect=function(e){this.ctx.save(),Ny(e)&&(this.ctx.globalAlpha=e.opacity),Dy(e)&&(this.ctx.translate(e.offsetX,e.offsetY),this.ctx.transform(e.matrix[0],e.matrix[1],e.matrix[2],e.matrix[3],e.matrix[4],e.matrix[5]),this.ctx.translate(-e.offsetX,-e.offsetY)),pf(e)&&(this.path(e.path),this.ctx.clip()),this._activeEffects.push(e)},t.prototype.popEffect=function(){this._activeEffects.pop(),this.ctx.restore()},t.prototype.renderStack=function(e){return ie(this,void 0,void 0,function(){var n;return Zt(this,function(s){switch(s.label){case 0:return n=e.element.container.styles,n.isVisible()?[4,this.renderStackContent(e)]:[3,2];case 1:s.sent(),s.label=2;case 2:return[2]}})})},t.prototype.renderNode=function(e){return ie(this,void 0,void 0,function(){return Zt(this,function(n){switch(n.label){case 0:if(Wt(e.container.flags,16))debugger;return e.container.styles.isVisible()?[4,this.renderNodeBackgroundAndBorders(e)]:[3,3];case 1:return n.sent(),[4,this.renderNodeContent(e)];case 2:n.sent(),n.label=3;case 3:return[2]}})})},t.prototype.renderTextWithLetterSpacing=function(e,n,s){var r=this;if(n===0)this.ctx.fillText(e.text,e.bounds.left,e.bounds.top+s);else{var i=xl(e.text);i.reduce(function(o,a){return r.ctx.fillText(a,o,e.bounds.top+s),o+r.ctx.measureText(a).width},e.bounds.left)}},t.prototype.createFontStyle=function(e){var n=e.fontVariant.filter(function(i){return i==="normal"||i==="small-caps"}).join(""),s=e1(e.fontFamily).join(", "),r=Vs(e.fontSize)?""+e.fontSize.number+e.fontSize.unit:e.fontSize.number+"px";return[[e.fontStyle,n,e.fontWeight,r,s].join(" "),s,r]},t.prototype.renderTextNode=function(e,n){return ie(this,void 0,void 0,function(){var s,r,i,o,a,l,d,u,h=this;return Zt(this,function(m){return s=this.createFontStyle(n),r=s[0],i=s[1],o=s[2],this.ctx.font=r,this.ctx.direction=n.direction===1?"rtl":"ltr",this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic",a=this.fontMetrics.getMetrics(i,o),l=a.baseline,d=a.middle,u=n.paintOrder,e.textBounds.forEach(function(f){u.forEach(function(g){switch(g){case 0:h.ctx.fillStyle=qt(n.color),h.renderTextWithLetterSpacing(f,n.letterSpacing,l);var p=n.textShadow;p.length&&f.text.trim().length&&(p.slice(0).reverse().forEach(function(w){h.ctx.shadowColor=qt(w.color),h.ctx.shadowOffsetX=w.offsetX.number*h.options.scale,h.ctx.shadowOffsetY=w.offsetY.number*h.options.scale,h.ctx.shadowBlur=w.blur.number,h.renderTextWithLetterSpacing(f,n.letterSpacing,l)}),h.ctx.shadowColor="",h.ctx.shadowOffsetX=0,h.ctx.shadowOffsetY=0,h.ctx.shadowBlur=0),n.textDecorationLine.length&&(h.ctx.fillStyle=qt(n.textDecorationColor||n.color),n.textDecorationLine.forEach(function(w){switch(w){case 1:h.ctx.fillRect(f.bounds.left,Math.round(f.bounds.top+l),f.bounds.width,1);break;case 2:h.ctx.fillRect(f.bounds.left,Math.round(f.bounds.top),f.bounds.width,1);break;case 3:h.ctx.fillRect(f.bounds.left,Math.ceil(f.bounds.top+d),f.bounds.width,1);break}}));break;case 1:n.webkitTextStrokeWidth&&f.text.trim().length&&(h.ctx.strokeStyle=qt(n.webkitTextStrokeColor),h.ctx.lineWidth=n.webkitTextStrokeWidth,h.ctx.lineJoin=window.chrome?"miter":"round",h.ctx.strokeText(f.text,f.bounds.left,f.bounds.top+l)),h.ctx.strokeStyle="",h.ctx.lineWidth=0,h.ctx.lineJoin="miter";break}})}),[2]})})},t.prototype.renderReplacedElement=function(e,n,s){if(s&&e.intrinsicWidth>0&&e.intrinsicHeight>0){var r=fi(e),i=hi(n);this.path(i),this.ctx.save(),this.ctx.clip(),this.ctx.drawImage(s,0,0,e.intrinsicWidth,e.intrinsicHeight,r.left,r.top,r.width,r.height),this.ctx.restore()}},t.prototype.renderNodeContent=function(e){return ie(this,void 0,void 0,function(){var n,s,r,i,o,a,v,v,l,d,u,h,F,m,f,E,g,p,w,v,C,F,E;return Zt(this,function(b){switch(b.label){case 0:this.applyEffects(e.getEffects(4)),n=e.container,s=e.curves,r=n.styles,i=0,o=n.textNodes,b.label=1;case 1:return i<o.length?(a=o[i],[4,this.renderTextNode(a,r)]):[3,4];case 2:b.sent(),b.label=3;case 3:return i++,[3,1];case 4:if(!(n instanceof Zh))return[3,8];b.label=5;case 5:return b.trys.push([5,7,,8]),[4,this.context.cache.match(n.src)];case 6:return v=b.sent(),this.renderReplacedElement(n,s,v),[3,8];case 7:return b.sent(),this.context.logger.error("Error loading image "+n.src),[3,8];case 8:if(n instanceof tf&&this.renderReplacedElement(n,s,n.canvas),!(n instanceof ef))return[3,12];b.label=9;case 9:return b.trys.push([9,11,,12]),[4,this.context.cache.match(n.svg)];case 10:return v=b.sent(),this.renderReplacedElement(n,s,v),[3,12];case 11:return b.sent(),this.context.logger.error("Error loading svg "+n.svg.substring(0,255)),[3,12];case 12:return n instanceof rf&&n.tree?(l=new t(this.context,{scale:this.options.scale,backgroundColor:n.backgroundColor,x:0,y:0,width:n.width,height:n.height}),[4,l.render(n.tree)]):[3,14];case 13:d=b.sent(),n.width&&n.height&&this.ctx.drawImage(d,0,0,n.width,n.height,n.bounds.left,n.bounds.top,n.bounds.width,n.bounds.height),b.label=14;case 14:if(n instanceof Ul&&(u=Math.min(n.bounds.width,n.bounds.height),n.type===ai?n.checked&&(this.ctx.save(),this.path([new J(n.bounds.left+u*.39363,n.bounds.top+u*.79),new J(n.bounds.left+u*.16,n.bounds.top+u*.5549),new J(n.bounds.left+u*.27347,n.bounds.top+u*.44071),new J(n.bounds.left+u*.39694,n.bounds.top+u*.5649),new J(n.bounds.left+u*.72983,n.bounds.top+u*.23),new J(n.bounds.left+u*.84,n.bounds.top+u*.34085),new J(n.bounds.left+u*.39363,n.bounds.top+u*.79)]),this.ctx.fillStyle=qt(xd),this.ctx.fill(),this.ctx.restore()):n.type===li&&n.checked&&(this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(n.bounds.left+u/2,n.bounds.top+u/2,u/4,0,Math.PI*2,!0),this.ctx.fillStyle=qt(xd),this.ctx.fill(),this.ctx.restore())),Jy(n)&&n.value.length){switch(h=this.createFontStyle(r),F=h[0],m=h[1],f=this.fontMetrics.getMetrics(F,m).baseline,this.ctx.font=F,this.ctx.fillStyle=qt(r.color),this.ctx.textBaseline="alphabetic",this.ctx.textAlign=Zy(n.styles.textAlign),E=fi(n),g=0,n.styles.textAlign){case 1:g+=E.width/2;break;case 2:g+=E.width;break}p=E.add(g,0,0,-E.height/2+1),this.ctx.save(),this.path([new J(E.left,E.top),new J(E.left+E.width,E.top),new J(E.left+E.width,E.top+E.height),new J(E.left,E.top+E.height)]),this.ctx.clip(),this.renderTextWithLetterSpacing(new gs(n.value,p),r.letterSpacing,f),this.ctx.restore(),this.ctx.textBaseline="alphabetic",this.ctx.textAlign="left"}if(!Wt(n.styles.display,2048))return[3,20];if(n.styles.listStyleImage===null)return[3,19];if(w=n.styles.listStyleImage,w.type!==0)return[3,18];v=void 0,C=w.url,b.label=15;case 15:return b.trys.push([15,17,,18]),[4,this.context.cache.match(C)];case 16:return v=b.sent(),this.ctx.drawImage(v,n.bounds.left-(v.width+10),n.bounds.top),[3,18];case 17:return b.sent(),this.context.logger.error("Error loading list-style-image "+C),[3,18];case 18:return[3,20];case 19:e.listValue&&n.styles.listStyleType!==-1&&(F=this.createFontStyle(r)[0],this.ctx.font=F,this.ctx.fillStyle=qt(r.color),this.ctx.textBaseline="middle",this.ctx.textAlign="right",E=new hA(n.bounds.left,n.bounds.top+Ft(n.styles.paddingTop,n.bounds.width),n.bounds.width,ud(r.lineHeight,r.fontSize.number)/2+1),this.renderTextWithLetterSpacing(new gs(e.listValue,E),r.letterSpacing,ud(r.lineHeight,r.fontSize.number)/2+2),this.ctx.textBaseline="bottom",this.ctx.textAlign="left"),b.label=20;case 20:return[2]}})})},t.prototype.renderStackContent=function(e){return ie(this,void 0,void 0,function(){var n,s,w,r,i,w,o,a,w,l,d,w,u,h,w,m,f,w,g,p,w;return Zt(this,function(v){switch(v.label){case 0:if(Wt(e.element.container.flags,16))debugger;return[4,this.renderNodeBackgroundAndBorders(e.element)];case 1:v.sent(),n=0,s=e.negativeZIndex,v.label=2;case 2:return n<s.length?(w=s[n],[4,this.renderStack(w)]):[3,5];case 3:v.sent(),v.label=4;case 4:return n++,[3,2];case 5:return[4,this.renderNodeContent(e.element)];case 6:v.sent(),r=0,i=e.nonInlineLevel,v.label=7;case 7:return r<i.length?(w=i[r],[4,this.renderNode(w)]):[3,10];case 8:v.sent(),v.label=9;case 9:return r++,[3,7];case 10:o=0,a=e.nonPositionedFloats,v.label=11;case 11:return o<a.length?(w=a[o],[4,this.renderStack(w)]):[3,14];case 12:v.sent(),v.label=13;case 13:return o++,[3,11];case 14:l=0,d=e.nonPositionedInlineLevel,v.label=15;case 15:return l<d.length?(w=d[l],[4,this.renderStack(w)]):[3,18];case 16:v.sent(),v.label=17;case 17:return l++,[3,15];case 18:u=0,h=e.inlineLevel,v.label=19;case 19:return u<h.length?(w=h[u],[4,this.renderNode(w)]):[3,22];case 20:v.sent(),v.label=21;case 21:return u++,[3,19];case 22:m=0,f=e.zeroOrAutoZIndexOrTransformedOrOpacity,v.label=23;case 23:return m<f.length?(w=f[m],[4,this.renderStack(w)]):[3,26];case 24:v.sent(),v.label=25;case 25:return m++,[3,23];case 26:g=0,p=e.positiveZIndex,v.label=27;case 27:return g<p.length?(w=p[g],[4,this.renderStack(w)]):[3,30];case 28:v.sent(),v.label=29;case 29:return g++,[3,27];case 30:return[2]}})})},t.prototype.mask=function(e){this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(this.canvas.width,0),this.ctx.lineTo(this.canvas.width,this.canvas.height),this.ctx.lineTo(0,this.canvas.height),this.ctx.lineTo(0,0),this.formatPath(e.slice(0).reverse()),this.ctx.closePath()},t.prototype.path=function(e){this.ctx.beginPath(),this.formatPath(e),this.ctx.closePath()},t.prototype.formatPath=function(e){var n=this;e.forEach(function(s,r){var i=Se(s)?s.start:s;r===0?n.ctx.moveTo(i.x,i.y):n.ctx.lineTo(i.x,i.y),Se(s)&&n.ctx.bezierCurveTo(s.startControl.x,s.startControl.y,s.endControl.x,s.endControl.y,s.end.x,s.end.y)})},t.prototype.renderRepeat=function(e,n,s,r){this.path(e),this.ctx.fillStyle=n,this.ctx.translate(s,r),this.ctx.fill(),this.ctx.translate(-s,-r)},t.prototype.resizeImage=function(e,n,s){var r;if(e.width===n&&e.height===s)return e;var i=(r=this.canvas.ownerDocument)!==null&&r!==void 0?r:document,o=i.createElement("canvas");o.width=Math.max(1,n),o.height=Math.max(1,s);var a=o.getContext("2d");return a.drawImage(e,0,0,e.width,e.height,0,0,n,s),o},t.prototype.renderBackgroundImage=function(e){return ie(this,void 0,void 0,function(){var n,s,r,i,o,a;return Zt(this,function(l){switch(l.label){case 0:n=e.styles.backgroundImage.length-1,s=function(d){var u,h,m,Q,L,V,P,R,y,f,Q,L,V,P,R,g,p,w,v,C,F,E,b,S,y,I,Q,U,M,P,R,$,L,V,_,X,At,ht,mt,it,x,H;return Zt(this,function(O){switch(O.label){case 0:if(d.type!==0)return[3,5];u=void 0,h=d.url,O.label=1;case 1:return O.trys.push([1,3,,4]),[4,r.context.cache.match(h)];case 2:return u=O.sent(),[3,4];case 3:return O.sent(),r.context.logger.error("Error loading background-image "+h),[3,4];case 4:return u&&(m=Lo(e,n,[u.width,u.height,u.width/u.height]),Q=m[0],L=m[1],V=m[2],P=m[3],R=m[4],y=r.ctx.createPattern(r.resizeImage(u,P,R),"repeat"),r.renderRepeat(Q,y,L,V)),[3,6];case 5:D2(d)?(f=Lo(e,n,[null,null,null]),Q=f[0],L=f[1],V=f[2],P=f[3],R=f[4],g=M2(d.angle,P,R),p=g[0],w=g[1],v=g[2],C=g[3],F=g[4],E=document.createElement("canvas"),E.width=P,E.height=R,b=E.getContext("2d"),S=b.createLinearGradient(w,C,v,F),cd(d.stops,p).forEach(function(z){return S.addColorStop(z.stop,qt(z.color))}),b.fillStyle=S,b.fillRect(0,0,P,R),P>0&&R>0&&(y=r.ctx.createPattern(E,"repeat"),r.renderRepeat(Q,y,L,V))):N2(d)&&(I=Lo(e,n,[null,null,null]),Q=I[0],U=I[1],M=I[2],P=I[3],R=I[4],$=d.position.length===0?[Ql]:d.position,L=Ft($[0],P),V=Ft($[$.length-1],R),_=T2(d,L,V,P,R),X=_[0],At=_[1],X>0&&At>0&&(ht=r.ctx.createRadialGradient(U+L,M+V,0,U+L,M+V,X),cd(d.stops,X*2).forEach(function(z){return ht.addColorStop(z.stop,qt(z.color))}),r.path(Q),r.ctx.fillStyle=ht,X!==At?(mt=e.bounds.left+.5*e.bounds.width,it=e.bounds.top+.5*e.bounds.height,x=At/X,H=1/x,r.ctx.save(),r.ctx.translate(mt,it),r.ctx.transform(1,0,0,x,0,0),r.ctx.translate(-mt,-it),r.ctx.fillRect(U,H*(M-it)+it,P,R*H),r.ctx.restore()):r.ctx.fill())),O.label=6;case 6:return n--,[2]}})},r=this,i=0,o=e.styles.backgroundImage.slice(0).reverse(),l.label=1;case 1:return i<o.length?(a=o[i],[5,s(a)]):[3,4];case 2:l.sent(),l.label=3;case 3:return i++,[3,1];case 4:return[2]}})})},t.prototype.renderSolidBorder=function(e,n,s){return ie(this,void 0,void 0,function(){return Zt(this,function(r){return this.path(Od(s,n)),this.ctx.fillStyle=qt(e),this.ctx.fill(),[2]})})},t.prototype.renderDoubleBorder=function(e,n,s,r){return ie(this,void 0,void 0,function(){var i,o;return Zt(this,function(a){switch(a.label){case 0:return n<3?[4,this.renderSolidBorder(e,s,r)]:[3,2];case 1:return a.sent(),[2];case 2:return i=_y(r,s),this.path(i),this.ctx.fillStyle=qt(e),this.ctx.fill(),o=Oy(r,s),this.path(o),this.ctx.fill(),[2]}})})},t.prototype.renderNodeBackgroundAndBorders=function(e){return ie(this,void 0,void 0,function(){var n,s,r,i,o,a,l,d,u=this;return Zt(this,function(h){switch(h.label){case 0:return this.applyEffects(e.getEffects(2)),n=e.container.styles,s=!MA(n.backgroundColor)||n.backgroundImage.length,r=[{style:n.borderTopStyle,color:n.borderTopColor,width:n.borderTopWidth},{style:n.borderRightStyle,color:n.borderRightColor,width:n.borderRightWidth},{style:n.borderBottomStyle,color:n.borderBottomColor,width:n.borderBottomWidth},{style:n.borderLeftStyle,color:n.borderLeftColor,width:n.borderLeftWidth}],i=jy(an(n.backgroundClip,0),e.curves),s||n.boxShadow.length?(this.ctx.save(),this.path(i),this.ctx.clip(),MA(n.backgroundColor)||(this.ctx.fillStyle=qt(n.backgroundColor),this.ctx.fill()),[4,this.renderBackgroundImage(e.container)]):[3,2];case 1:h.sent(),this.ctx.restore(),n.boxShadow.slice(0).reverse().forEach(function(m){u.ctx.save();var f=ui(e.curves),g=m.inset?0:$y,p=Ry(f,-g+(m.inset?1:-1)*m.spread.number,(m.inset?1:-1)*m.spread.number,m.spread.number*(m.inset?-2:2),m.spread.number*(m.inset?-2:2));m.inset?(u.path(f),u.ctx.clip(),u.mask(p)):(u.mask(f),u.ctx.clip(),u.path(p)),u.ctx.shadowOffsetX=m.offsetX.number+g,u.ctx.shadowOffsetY=m.offsetY.number,u.ctx.shadowColor=qt(m.color),u.ctx.shadowBlur=m.blur.number,u.ctx.fillStyle=m.inset?qt(m.color):"rgba(0,0,0,1)",u.ctx.fill(),u.ctx.restore()}),h.label=2;case 2:o=0,a=0,l=r,h.label=3;case 3:return a<l.length?(d=l[a],d.style!==0&&!MA(d.color)&&d.width>0?d.style!==2?[3,5]:[4,this.renderDashedDottedBorder(d.color,d.width,o,e.curves,2)]:[3,11]):[3,13];case 4:return h.sent(),[3,11];case 5:return d.style!==3?[3,7]:[4,this.renderDashedDottedBorder(d.color,d.width,o,e.curves,3)];case 6:return h.sent(),[3,11];case 7:return d.style!==4?[3,9]:[4,this.renderDoubleBorder(d.color,d.width,o,e.curves)];case 8:return h.sent(),[3,11];case 9:return[4,this.renderSolidBorder(d.color,o,e.curves)];case 10:h.sent(),h.label=11;case 11:o++,h.label=12;case 12:return a++,[3,3];case 13:return[2]}})})},t.prototype.renderDashedDottedBorder=function(e,n,s,r,i){return ie(this,void 0,void 0,function(){var o,a,l,d,u,h,m,f,g,p,w,v,C,F,E,b,E,b;return Zt(this,function(S){return this.ctx.save(),o=Ky(r,s),a=Od(r,s),i===2&&(this.path(a),this.ctx.clip()),Se(a[0])?(l=a[0].start.x,d=a[0].start.y):(l=a[0].x,d=a[0].y),Se(a[1])?(u=a[1].end.x,h=a[1].end.y):(u=a[1].x,h=a[1].y),s===0||s===2?m=Math.abs(l-u):m=Math.abs(d-h),this.ctx.beginPath(),i===3?this.formatPath(o):this.formatPath(a.slice(0,2)),f=n<3?n*3:n*2,g=n<3?n*2:n,i===3&&(f=n,g=n),p=!0,m<=f*2?p=!1:m<=f*2+g?(w=m/(2*f+g),f*=w,g*=w):(v=Math.floor((m+g)/(f+g)),C=(m-v*f)/(v-1),F=(m-(v+1)*f)/v,g=F<=0||Math.abs(g-C)<Math.abs(g-F)?C:F),p&&(i===3?this.ctx.setLineDash([0,f+g]):this.ctx.setLineDash([f,g])),i===3?(this.ctx.lineCap="round",this.ctx.lineWidth=n):this.ctx.lineWidth=n*2+1.1,this.ctx.strokeStyle=qt(e),this.ctx.stroke(),this.ctx.setLineDash([]),i===2&&(Se(a[0])&&(E=a[3],b=a[0],this.ctx.beginPath(),this.formatPath([new J(E.end.x,E.end.y),new J(b.start.x,b.start.y)]),this.ctx.stroke()),Se(a[1])&&(E=a[1],b=a[2],this.ctx.beginPath(),this.formatPath([new J(E.end.x,E.end.y),new J(b.start.x,b.start.y)]),this.ctx.stroke())),this.ctx.restore(),[2]})})},t.prototype.render=function(e){return ie(this,void 0,void 0,function(){var n;return Zt(this,function(s){switch(s.label){case 0:return this.options.backgroundColor&&(this.ctx.fillStyle=qt(this.options.backgroundColor),this.ctx.fillRect(this.options.x,this.options.y,this.options.width,this.options.height)),n=ky(e),[4,this.renderStack(n)];case 1:return s.sent(),this.applyEffects([]),[2,this.canvas]}})})},t})(bf),Jy=function(A){return A instanceof sf||A instanceof nf?!0:A instanceof Ul&&A.type!==li&&A.type!==ai},jy=function(A,t){switch(A){case 0:return ui(t);case 2:return Py(t);default:return hi(t)}},Zy=function(A){switch(A){case 1:return"center";case 2:return"right";default:return"left"}},t1=["-apple-system","system-ui"],e1=function(A){return/iPhone OS 15_(0|1)/.test(window.navigator.userAgent)?A.filter(function(t){return t1.indexOf(t)===-1}):A},A1=(function(A){Re(t,A);function t(e,n){var s=A.call(this,e,n)||this;return s.canvas=n.canvas?n.canvas:document.createElement("canvas"),s.ctx=s.canvas.getContext("2d"),s.options=n,s.canvas.width=Math.floor(n.width*n.scale),s.canvas.height=Math.floor(n.height*n.scale),s.canvas.style.width=n.width+"px",s.canvas.style.height=n.height+"px",s.ctx.scale(s.options.scale,s.options.scale),s.ctx.translate(-n.x,-n.y),s.context.logger.debug("EXPERIMENTAL ForeignObject renderer initialized ("+n.width+"x"+n.height+" at "+n.x+","+n.y+") with scale "+n.scale),s}return t.prototype.render=function(e){return ie(this,void 0,void 0,function(){var n,s;return Zt(this,function(r){switch(r.label){case 0:return n=Fa(this.options.width*this.options.scale,this.options.height*this.options.scale,this.options.scale,this.options.scale,e),[4,n1(n)];case 1:return s=r.sent(),this.options.backgroundColor&&(this.ctx.fillStyle=qt(this.options.backgroundColor),this.ctx.fillRect(0,0,this.options.width*this.options.scale,this.options.height*this.options.scale)),this.ctx.drawImage(s,-this.options.x*this.options.scale,-this.options.y*this.options.scale),[2,this.canvas]}})})},t})(bf),n1=function(A){return new Promise(function(t,e){var n=new Image;n.onload=function(){t(n)},n.onerror=e,n.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(new XMLSerializer().serializeToString(A))})},s1=(function(){function A(t){var e=t.id,n=t.enabled;this.id=e,this.enabled=n,this.start=Date.now()}return A.prototype.debug=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.enabled&&(typeof window<"u"&&window.console&&typeof console.debug=="function"?console.debug.apply(console,tr([this.id,this.getTime()+"ms"],t)):this.info.apply(this,t))},A.prototype.getTime=function(){return Date.now()-this.start},A.prototype.info=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.enabled&&typeof window<"u"&&window.console&&typeof console.info=="function"&&console.info.apply(console,tr([this.id,this.getTime()+"ms"],t))},A.prototype.warn=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.enabled&&(typeof window<"u"&&window.console&&typeof console.warn=="function"?console.warn.apply(console,tr([this.id,this.getTime()+"ms"],t)):this.info.apply(this,t))},A.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.enabled&&(typeof window<"u"&&window.console&&typeof console.error=="function"?console.error.apply(console,tr([this.id,this.getTime()+"ms"],t)):this.info.apply(this,t))},A.instances={},A})(),r1=(function(){function A(t,e){var n;this.windowBounds=e,this.instanceName="#"+A.instanceCount++,this.logger=new s1({id:this.instanceName,enabled:t.logging}),this.cache=(n=t.cache)!==null&&n!==void 0?n:new Ey(this,t)}return A.instanceCount=1,A})(),i1=function(A,t){return t===void 0&&(t={}),o1(A,t)};typeof window<"u"&&mf.setContext(window);var o1=function(A,t){return ie(void 0,void 0,void 0,function(){var e,n,s,r,i,o,a,l,d,u,h,m,f,g,p,w,v,C,F,E,S,b,S,y,I,Q,U,M,P,R,$,L,V,_,X,At,ht,mt,it,x;return Zt(this,function(H){switch(H.label){case 0:if(!A||typeof A!="object")return[2,Promise.reject("Invalid element provided as first argument")];if(e=A.ownerDocument,!e)throw new Error("Element is not attached to a Document");if(n=e.defaultView,!n)throw new Error("Document is not attached to a Window");return s={allowTaint:(y=t.allowTaint)!==null&&y!==void 0?y:!1,imageTimeout:(I=t.imageTimeout)!==null&&I!==void 0?I:15e3,proxy:t.proxy,useCORS:(Q=t.useCORS)!==null&&Q!==void 0?Q:!1},r=ua({logging:(U=t.logging)!==null&&U!==void 0?U:!0,cache:t.cache},s),i={windowWidth:(M=t.windowWidth)!==null&&M!==void 0?M:n.innerWidth,windowHeight:(P=t.windowHeight)!==null&&P!==void 0?P:n.innerHeight,scrollX:(R=t.scrollX)!==null&&R!==void 0?R:n.pageXOffset,scrollY:($=t.scrollY)!==null&&$!==void 0?$:n.pageYOffset},o=new hA(i.scrollX,i.scrollY,i.windowWidth,i.windowHeight),a=new r1(r,o),l=(L=t.foreignObjectRendering)!==null&&L!==void 0?L:!1,d={allowTaint:(V=t.allowTaint)!==null&&V!==void 0?V:!1,onclone:t.onclone,ignoreElements:t.ignoreElements,inlineImages:l,copyStyles:l},a.logger.debug("Starting document clone with size "+o.width+"x"+o.height+" scrolled to "+-o.left+","+-o.top),u=new Rd(a,A,d),h=u.clonedReferenceElement,h?[4,u.toIFrame(e,o)]:[2,Promise.reject("Unable to find element in cloned iframe")];case 1:return m=H.sent(),f=Ml(h)||ay(h)?Rw(h.ownerDocument):Mi(a,h),g=f.width,p=f.height,w=f.left,v=f.top,C=a1(a,h,t.backgroundColor),F={canvas:t.canvas,backgroundColor:C,scale:(X=(_=t.scale)!==null&&_!==void 0?_:n.devicePixelRatio)!==null&&X!==void 0?X:1,x:((At=t.x)!==null&&At!==void 0?At:0)+w,y:((ht=t.y)!==null&&ht!==void 0?ht:0)+v,width:(mt=t.width)!==null&&mt!==void 0?mt:Math.ceil(g),height:(it=t.height)!==null&&it!==void 0?it:Math.ceil(p)},l?(a.logger.debug("Document cloned, using foreign object rendering"),S=new A1(a,F),[4,S.render(h)]):[3,3];case 2:return E=H.sent(),[3,5];case 3:return a.logger.debug("Document cloned, element located at "+w+","+v+" with size "+g+"x"+p+" using computed rendering"),a.logger.debug("Starting DOM parsing"),b=af(a,h),C===b.styles.backgroundColor&&(b.styles.backgroundColor=dA.TRANSPARENT),a.logger.debug("Starting renderer for element at "+F.x+","+F.y+" with size "+F.width+"x"+F.height),S=new Yy(a,F),[4,S.render(b)];case 4:E=H.sent(),H.label=5;case 5:return(!((x=t.removeContainer)!==null&&x!==void 0)||x)&&(Rd.destroy(m)||a.logger.error("Cannot detach cloned iframe as it is not in the DOM anymore")),a.logger.debug("Finished rendering"),[2,E]}})})},a1=function(A,t,e){var n=t.ownerDocument,s=n.documentElement?hs(A,getComputedStyle(n.documentElement).backgroundColor):dA.TRANSPARENT,r=n.body?hs(A,getComputedStyle(n.body).backgroundColor):dA.TRANSPARENT,i=typeof e=="string"?hs(A,e):e===null?dA.TRANSPARENT:4294967295;return t===n.documentElement?MA(s)?MA(r)?i:r:s:i};const ps={},vA={},l1=600,Ho=.25,Gd={letter:{width:8.5,height:11},"11x14":{width:11,height:14},"11x17":{width:11,height:17}};async function c1(A,t){const e=document.getElementById("button-grid");if(!e)return B.warn("PrintService","Button grid element not found",null,"print"),null;const n=e.querySelector(".button-grid-left-cell"),s=e.querySelector(".button-grid-right-cell");try{const r=e.getBoundingClientRect(),i=n?.getBoundingClientRect().width??0,o=s?.getBoundingClientRect().width??0,a=Math.min(window.devicePixelRatio||1,2),l=await i1(e,{scale:a,backgroundColor:"#ffffff",logging:!1,useCORS:!0}),d=r.width>0?l.width/r.width:1,u=A?0:Math.round(i*d),h=t?0:Math.round(o*d),m=Math.max(0,Math.min(l.width-1,u)),f=Math.max(m+1,Math.min(l.width,l.width-h)),g=Math.max(1,f-m),p=document.createElement("canvas");p.width=g,p.height=l.height,(p.getContext("2d",{willReadFrequently:!0})||p.getContext("2d")).drawImage(l,m,0,g,l.height,0,0,g,l.height);const v=g1(p,A,t);return B.debug("PrintService",`Captured button grid: ${v.width}x${v.height}`,null,"print"),v}catch(r){return B.error("PrintService","Failed to capture button grid",r,"print"),null}}function d1(A,t){const e=document.getElementById("notation-grid"),n=document.getElementById("legend-left-canvas"),s=document.getElementById("legend-right-canvas");if(!e)return B.warn("PrintService","Notation grid canvas not found",null,"print"),null;const r=A&&n?n.width:0,i=t&&s?s.width:0,o=r+e.width+i,a=r,l=document.createElement("canvas");l.width=o,l.height=e.height;const d=l.getContext("2d");return A&&n&&r>0&&d.drawImage(n,0,0),d.drawImage(e,a,0),t&&s&&i>0&&d.drawImage(s,a+e.width,0),B.debug("PrintService",`Captured pitch grid: ${l.width}x${l.height}`,null,"print"),l}function u1(A,t){const e=document.getElementById("drum-grid"),n=document.querySelector(".drum-grid-left-cell"),s=document.querySelector(".drum-grid-right-cell");if(!e||e.width===0)return B.debug("PrintService","Drum grid not found or empty",null,"print"),null;const r=e.offsetWidth?e.width/e.offsetWidth:1,i=A?Math.max(0,Math.round((n?.offsetWidth||0)*r)):0,o=t?Math.max(0,Math.round((s?.offsetWidth||0)*r)):0,a=i+e.width+o,l=getComputedStyle(document.documentElement).getPropertyValue("--c-surface")||"#ffffff",d=document.createElement("canvas");d.width=a,d.height=e.height;const u=d.getContext("2d");return u.fillStyle=l.trim()||"#ffffff",u.fillRect(0,0,a,e.height),u.drawImage(e,i,0),B.debug("PrintService",`Captured drum grid: ${d.width}x${d.height}`,null,"print"),d}function h1(A){const t=document.createElement("canvas");t.width=A.width,t.height=A.height;const e=t.getContext("2d");e.drawImage(A,0,0);const n=e.getImageData(0,0,t.width,t.height),s=n.data;for(let r=0;r<s.length;r+=4){const i=s[r]*.299+s[r+1]*.587+s[r+2]*.114;s[r]=i,s[r+1]=i,s[r+2]=i}return e.putImageData(n,0,0),t}async function f1(A,t){B.debug("PrintService","Generating score canvas...",{printOptions:A,targetDimensions:t},"print");const e=[];if(A.includeButtonGrid){const F=await yf(A.includeLeftLegend,A.includeRightLegend);F&&e.push({canvas:F,name:"buttons"})}const n=d1(A.includeLeftLegend,A.includeRightLegend);if(n&&e.push({canvas:n,name:"pitch"}),A.includeDrums){const F=u1(A.includeLeftLegend,A.includeRightLegend);F&&e.push({canvas:F,name:"drums"})}if(e.length===0)return B.warn("PrintService","No content captured for printing",null,"print"),null;A.colorMode==="bw"&&(e.forEach(F=>{F.canvas=h1(F.canvas)}),B.debug("PrintService","Applied black & white filter",null,"print"));const s=Math.max(...e.map(F=>F.canvas.width)),r=e.reduce((F,E)=>F+E.canvas.height,0),i=A.cropTop||0,o=A.cropBottom||1,a=A.cropLeft||0,l=A.cropRight||1,d=r*(o-i),u=s*(l-a),h=r*i,m=s*a;B.debug("PrintService",`Applying crop: top=${i.toFixed(2)}, bottom=${o.toFixed(2)}, left=${a.toFixed(2)}, right=${l.toFixed(2)}`,null,"print");const f=Math.min(t.width/u,t.height/d),g=document.createElement("canvas");g.width=u*f,g.height=d*f;const p=g.getContext("2d");p.fillStyle="#FFFFFF",p.fillRect(0,0,g.width,g.height);const w=document.createElement("canvas");w.width=s,w.height=r;const v=w.getContext("2d");let C=0;return e.forEach(({canvas:F,name:E})=>{v.drawImage(F,0,C),B.debug("PrintService",`Drew ${E} at y=${C}, height=${F.height}`,null,"print"),C+=F.height}),p.drawImage(w,m,h,u,d,0,0,g.width,g.height),B.debug("PrintService",`Generated composite canvas: ${g.width}x${g.height}`,null,"print"),g}const Or={generateScoreCanvas:f1,async generateAndPrint(){const A=c.state.printOptions,t=300,e=A.pageSize,n=e&&e in Gd?e:"letter",s=Gd[n],r=A.orientation==="landscape"?s.height:s.width,i=A.orientation==="landscape"?s.width:s.height,o=Math.max(1,r-2*Ho),a=Math.max(1,i-2*Ho),l=o*t,d=a*t;B.info("PrintService","Generating print canvas at high resolution",{width:l,height:d,options:A},"print");const u=await this.generateScoreCanvas(A,{width:l,height:d});if(!u){B.error("PrintService","Failed to generate print canvas",null,"print");return}const h=document.getElementById("print-staging-area");h.innerHTML="";const m=document.getElementById("print-style-rules");m.textContent=`@page { size: ${r}in ${i}in; margin: ${Ho}in; }`;const f=document.createElement("img");f.src=u.toDataURL("image/png"),f.style.width="100%",f.style.height="auto",h.appendChild(f),B.info("PrintService","Opening print dialog",null,"print"),setTimeout(()=>window.print(),100)},async prefetchButtonGridSnapshot(A=!0,t=!0){try{await yf(A,t)}catch(e){B.warn("PrintService","Button grid prefetch failed",e,"print")}},invalidateButtonGridSnapshot(){Sf()}};function g1(A,t,e){if(!A)return A;const n=document.getElementById("notation-grid"),s=document.getElementById("legend-left-canvas"),r=document.getElementById("legend-right-canvas"),i=t&&s?s.width:0,o=e&&r?r.width:0,a=(n?.width??0)+i+o||A.width;if(!a||a===A.width)return A;const l=a/A.width,d=Math.max(1,Math.round(A.height*l)),u=document.createElement("canvas");return u.width=a,u.height=d,(u.getContext("2d",{willReadFrequently:!0})||u.getContext("2d")).drawImage(A,0,0,u.width,u.height),u}async function yf(A,t){const e=`${A}-${t}`;return ps[e]!==void 0?ps[e]??null:(vA[e]||(vA[e]=(async()=>{await m1();const n=await c1(A,t);return ps[e]=n,vA[e]=null,n})().catch(n=>{throw vA[e]=null,n})),vA[e])}function m1(){return new Promise(A=>{typeof window.requestIdleCallback=="function"?requestIdleCallback(()=>A(),{timeout:l1}):requestAnimationFrame(()=>A())})}function Sf(){Object.keys(ps).forEach(A=>{delete ps[A]}),Object.keys(vA).forEach(A=>{delete vA[A]})}typeof window<"u"&&window.addEventListener("resize",()=>Sf());function Ve(A,t){if(!A)return`rgba(204, 204, 204, ${t})`;const e=parseInt(A.slice(Ou,Bc),Pr),n=parseInt(A.slice(Bc,wc),Pr),s=parseInt(A.slice(wc,W0),Pr);return`rgba(${e}, ${n}, ${s}, ${t})`}function Oi(A,t){if(!A||typeof A!="string")return G0;const e=parseInt(A.slice(Ou),Pr),n=t<0?V0:z0,s=t<0?t*-1:t,r=e>>16,i=e>>8&255,o=e&255;return"#"+(16777216+(Math.round((n-r)*s)+r)*65536+(Math.round((n-i)*s)+i)*256+(Math.round((n-o)*s)+o)).toString(16).slice(1)}const p1=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor"/>\r
</svg>`,B1=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(90, 12, 12)"/>\r
</svg>`,w1=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(180, 12, 12)"/>\r
</svg>`,v1=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(270, 12, 12)"/>\r
</svg>`,Ef=Cn;function jn(A,t){const{blend:e,cutoff:n,resonance:s}=t,r=(n-1)/30,i=20,o=A-r,a=r-A;let l=1/(1+Math.pow(Math.max(0,o*i),2)),d=1/(1+Math.pow(Math.max(0,a*i),2));const u=.01;l<u&&(l=0),d<u&&(d=0);const h=l*d;let m;e<=1?m=d*(1-e)+h*e:m=h*(2-e)+l*(e-1);const f=1-(s||0)/105,g=Math.max(.01,.2*f*f),p=Math.exp(-Math.pow((A-r)/g,2)),w=(s||0)/100*.6,v=m+p*w,C=Math.max(0,Math.min(1,v));return C<u?0:C}function C1(A,t){const e=t/100;return 1-e+e*A}function Rs(A,t){const e=t.mix||0;if(e===0)return new Float32Array(A);const n=new Float32Array(A.length),s=e/100;for(let r=0;r<A.length;r++){const i=A[r]??0,o=(r+.5)/Ef,a=jn(o,t);if(a<i){const u=(i-a)*s;n[r]=i-u}else n[r]=i;const l=n[r]??0;n[r]=Math.max(0,l)}return n}function La(A){const t=c.state.timbres[A];if(!t)return new Float32Array(Ef);const e=t.filter;return e&&e.enabled!==!1&&(e.mix||0)>0?Rs(t.coeffs,e):new Float32Array(t.coeffs)}B.moduleLoaded("HarmonicBins with Columnar Structure");function Ha(A,...t){}const Kr={0:p1,90:B1,180:w1,270:v1},qe=Cn;let Xt=null,_t=null,ee=new Float32Array(qe).fill(0),Et=null,ve=new Float32Array(qe).fill(0);const Tl=[],Da=[];let un=!1,ye=null;const yr=new Array(qe).fill(null);let Sr=!1;const Er=new Float32Array(qe).fill(1);new Float32Array(qe).fill(0);function Na(){if(!Et||((!Xt||!_t||!ye)&&(Xt=document.getElementById("filter-overlay-canvas"),ye=document.querySelector(".harmonic-bins-grid"),Xt&&(_t=Xt.getContext("2d"))),!Xt||!_t||!ye))return;const{width:A,height:t}=Xt;_t.clearRect(0,0,A,t);const n=t*.95,s=t,r=c.state.timbres[Et]?.filter,i=r&&r.enabled!==!1;if(r&&i){const o=r.mix||0;if(o===0){Er.fill(1);return}const a=[];for(let m=0;m<qe;m++){const f=(m+.5)/qe,g=jn(f,r);Er[m]=C1(g,o),a.push({bin:m+1,rawFilterAmp:g.toFixed(3),afterMix:(Er[m]??0).toFixed(3)})}_t.beginPath();const l=2;for(let m=0;m<=A;m+=l){const f=m/A,g=jn(f,r),p=s-g*n;m===0?_t.moveTo(m,p):_t.lineTo(m,p)}const u=.4+o/100*.6;_t.strokeStyle=Ve(Oi(Et,-.3),u),_t.lineWidth=2.5,_t.stroke();const h=o/100;if(h>0){_t.beginPath(),_t.moveTo(0,0),_t.lineTo(A,0);const m=jn(1,r),f=s-m*n;_t.lineTo(A,f);for(let g=A;g>=0;g-=2){const p=g/A,w=jn(p,r),v=s-w*n;_t.lineTo(g,v)}_t.closePath(),_t.fillStyle=`rgba(255, 255, 255, ${h})`,_t.fill()}}else Er.fill(1)}function Bs(){if(!Et)return;const A=Et;Tl.forEach((t,e)=>{const n=t.sliderTrack.querySelector(".slider-fill"),s=t.sliderTrack.querySelector(".harmonic-label-internal");if(!n||!s)return;const r=ee[e]??0;if(n.style.height=`${r*100}%`,r>0){const o=Oi(A,-.1);n.style.backgroundColor=Ve(o,1)}else n.style.backgroundColor="transparent";const i=n.querySelector("canvas");i&&i.remove(),r>.1?(s.style.color="rgba(255, 255, 255, 0.35)",s.style.textShadow="0 0 2px rgba(0,0,0,0.3)"):(s.style.color="rgba(51, 51, 51, 0.5)",s.style.textShadow="0 0 1px rgba(255,255,255,0.3)")}),Na()}function Wd(A,t=null){if(!Et||!ye)return;const e=A.target instanceof Element?A.target:null;if(Ha("log","[BINS DRAG] handleBinPointerEvent called",{clientX:A.clientX,clientY:A.clientY}),B.debug("HarmonicBins","handleBinPointerEvent called",{target:e?.className},"filter"),e?.classList.contains("phase-button")||e?.closest(".phase-button")||e?.tagName==="path"||e?.tagName==="svg"){B.debug("HarmonicBins","Blocking phase button interaction in handleBinPointerEvent",null,"filter");return}if(t===null){const u=ye.getBoundingClientRect(),h=A.clientX-u.left,m=u.width/qe,f=Math.floor(h/m);t=Math.max(0,Math.min(qe-1,f))}if(B.debug("HarmonicBins","handleBinPointerEvent - binIndex",{binIndex:t},"filter"),t===null)return;const n=c.state.timbres[Et];if(!n)return;const s=Tl[t];if(!s)return;const i=s.sliderTrack.getBoundingClientRect(),o=A.clientY-i.top,a=i.height,l=(a-o)/a,d=Math.max(0,Math.min(1,l));if(Ha("log","[BINS DRAG] Setting bin",t+1,"value:",d.toFixed(3)),d===0){B.debug("HarmonicBins","Setting coefficient to zero immediately for bin",{binIndex:t},"filter");const u=new Float32Array(n.coeffs);u[t]=0,ee[t]=0,c.setHarmonicCoefficients(Et,u);const h=yr[t];typeof h=="number"&&(clearTimeout(h),yr[t]=null),un||(St.triggerAttack("C4",Et),c.emit("spacebarPlayback",{color:Et,isPlaying:!0}),un=!0);const m=c.state.timbres[Et]?.filter;m&&m.enabled!==!1&&(m.mix||0)>0&&Rs(u,m),window.waveformVisualizer?.generateWaveform&&window.waveformVisualizer.generateWaveform(),B.debug("HarmonicBins",`Set coefficient H${t+1} to 0 for color ${Et}`,null,"filter")}else{const u=yr[t];typeof u=="number"&&(clearTimeout(u),yr[t]=null),un||(St.triggerAttack("C4",Et),c.emit("spacebarPlayback",{color:Et,isPlaying:!0}),un=!0),B.debug("HarmonicBins","BEFORE creating newCoeffs - store coeffs",{coeffs:n.coeffs},"filter");const h=new Float32Array(n.coeffs);B.debug("HarmonicBins","AFTER copying to newCoeffs",{newCoeffs:h},"filter"),h[t]=d,ee[t]=d,B.debug("HarmonicBins",`AFTER setting newCoeffs[${t}] = ${d}`,{newCoeffs:h},"filter"),c.setHarmonicCoefficients(Et,h);const m=c.state.timbres[Et]?.filter;m&&m.enabled!==!1&&(m.mix||0)>0&&Rs(h,m),window.waveformVisualizer?.generateWaveform&&window.waveformVisualizer.generateWaveform(),B.debug("HarmonicBins",`Updated coefficient H${t+1} to ${d} for color ${Et}`,null,"filter"),B.debug("HarmonicBins","All coefficients",{newCoeffs:h},"filter")}Bs()}function Ra(A,t,e,n){const s=e.coeffs,r=e.phases||new Float32Array(s.length).fill(0);let i=!0,o=!0;if(A.length!==s.length)i=!1;else for(let l=0;l<A.length;l++){const d=A[l]??0,u=s[l]??0;if(Math.abs(d-u)>.001){i=!1;break}}if(t.length!==r.length)o=!1;else for(let l=0;l<t.length;l++){const d=t[l]??0,u=r[l]??0;if(Math.abs(d-u)>.001){o=!1;break}}return i&&o}function Vd(A){if(!A)return;Et=A;const t=c.state.timbres[A];t&&(t.filter?t.filter.enabled===void 0&&(t.filter.enabled=!0):t.filter={enabled:!0,blend:1,cutoff:16,resonance:0,type:"lowpass",mix:0},B.debug("HarmonicBins","updateForNewColor - timbre.coeffs",{coeffs:t.coeffs},"filter"),B.debug("HarmonicBins","updateForNewColor - timbre.phases",{phases:t.phases},"filter"),ee=new Float32Array(t.coeffs),t.phases?ve=new Float32Array(t.phases):ve=new Float32Array(ee.length).fill(0),Ra(ee,ve,t),B.debug("HarmonicBins","updateForNewColor - final coeffs",{coeffs:ee},"filter"),B.debug("HarmonicBins","updateForNewColor - final phases",{phases:ve},"filter"),Da.forEach(({phaseBtn:e},n)=>{if(!e)return;let r=(ve[n]||0)%(2*Math.PI);r<0&&(r+=2*Math.PI);const i=.1;let o=0;Math.abs(r-Math.PI/2)<i?o=90:Math.abs(r-Math.PI)<i?o=180:Math.abs(r-3*Math.PI/2)<i&&(o=270),e.innerHTML=Kr[o]}),Bs())}function b1(){const A=document.querySelector(".filter-container"),t=A?.querySelector(".filter-bins-wrapper"),e=A?.querySelector(".filter-vertical-blend-wrapper");if(!A||!t||!e){B.error("HarmonicBins","Missing required elements - aborting init",null,"audio");return}ye=document.createElement("div"),ye.className="harmonic-bins-grid";for(let o=0;o<qe;o++){const a=document.createElement("div");a.className="slider-column";const l=document.createElement("div");l.className="slider-track";const d=document.createElement("div");d.className="slider-fill",l.appendChild(d);const u=document.createElement("div");u.className="harmonic-label-internal",u.textContent=`${o+1}`,l.appendChild(u),a.appendChild(l);const h=document.createElement("button");h.className="phase-button",h.innerHTML=Kr[0],h.dataset.binIndex=String(o),h.addEventListener("pointerenter",()=>{if(Sr){const f=Dt(),g=St.synths,p=Et;if(p&&g?.[p]?.activeNotes?.C4){const w=g[p].activeNotes.C4;w.oscillators?.[o]&&w.oscillators[o].volume.linearRampTo(-1/0,.015,f)}setTimeout(()=>{const w=Et,v=w?c.state.timbres[w]:void 0;if(!w||!v)return;const C=new Float32Array(v.coeffs);C[o]=0,ee[o]=0,c.setHarmonicCoefficients(w,C);const F=c.state.timbres[w]?.filter;F&&F.enabled!==!1&&(F.mix||0)>0&&Rs(C,F),Bs()},.015*1e3)}}),h.addEventListener("click",m=>{if(Sr){m.preventDefault();return}const f=Et;if(!f)return;B.debug("HarmonicBins","Phase button click handler started",null,"filter"),B.debug("HarmonicBins","Current coeffs before phase change",{coeffs:ee},"filter"),m.preventDefault();const g=new Float32Array(ve),p=new Float32Array(ve);let v=(p[o]||0)%(2*Math.PI);v<0&&(v+=2*Math.PI);const C=.1;let F=0;Math.abs(v)<C?F=Math.PI/2:Math.abs(v-Math.PI/2)<C?F=Math.PI:Math.abs(v-Math.PI)<C?F=3*Math.PI/2:F=0,p[o]=F,ve=p,window.waveformVisualizer?.startPhaseTransition&&window.waveformVisualizer.startPhaseTransition(g,p,o),c.setHarmonicPhases(f,p);const E=F===0?0:Math.abs(F-Math.PI/2)<C?90:Math.abs(F-Math.PI)<C?180:270;h.innerHTML=Kr[E],B.debug("HarmonicBins",`Phase button clicked for H${o+1}, new phase: ${E}`,null,"filter")}),a.appendChild(h),ye.appendChild(a),Tl.push({column:a,label:u,sliderTrack:l,sliderFill:d,phaseBtn:h}),Da.push({phaseBtn:h})}ye.addEventListener("pointerdown",o=>{const a=o.target instanceof Element?o.target:null;if(Ha("log","[BINS DRAG] Pointerdown event fired",{target:a,className:a?.className}),a?.classList.contains("phase-button")||a?.closest(".phase-button")){B.debug("HarmonicBins","Pointerdown blocked - phase button clicked",null,"filter");return}if(B.debug("HarmonicBins","Pointerdown - handling bin interaction",null,"filter"),o.preventDefault(),Sr=!0,!Et)return;const l=Et;St.triggerAttack("C4",l),c.emit("spacebarPlayback",{color:l,isPlaying:!0}),un=!0,Wd(o);const d=h=>Wd(h),u=()=>{window.removeEventListener("pointermove",d),window.removeEventListener("pointerup",u),Sr=!1;const h=!!window.waveformVisualizer?.generateWaveform;c.recordState(),St.triggerRelease("C4",l),c.emit("spacebarPlayback",{color:l,isPlaying:!1}),un=!1,h?setTimeout(()=>{window.waveformVisualizer?.generateWaveform?.()},0):B.warn("HarmonicBins","Static waveform visualizer not ready when drag ended",null,"audio")};window.addEventListener("pointermove",d),window.addEventListener("pointerup",u)}),Xt=document.createElement("canvas"),Xt.id="filter-overlay-canvas",Xt.className="filter-overlay-canvas",Xt.style.pointerEvents="none",_t=Xt.getContext("2d"),ye.appendChild(Xt);const n=document.createElement("div");n.className="vertical-blend-wrapper";const s=document.createElement("div");s.id="vertical-blend-track";const r=document.createElement("div");r.id="vertical-blend-thumb",r.textContent="M",s.appendChild(r),n.appendChild(s),t.appendChild(ye),e.appendChild(n);const i=()=>{if(!Xt)return;const o=Xt.getBoundingClientRect();(Xt.width!==o.width||Xt.height!==o.height)&&(Xt.width=o.width,Xt.height=o.height,Na())};Et=c.state.selectedNote?.color||"#4a90e2",Vd(Et),c.on("timbreChanged",o=>{if(o&&o===Et){B.debug("HarmonicBins","timbreChanged event - checking what changed",null,"filter");const a=c.state.timbres[o];if(!a)return;const l=a.coeffs,d=a.phases;let u=!1;if(B.debug("HarmonicBins","Comparing coefficients...",null,"filter"),B.debug("HarmonicBins","Local coeffs",{coeffs:ee},"filter"),B.debug("HarmonicBins","Store coeffs",{newCoeffs:l},"filter"),ee.length!==l.length)B.debug("HarmonicBins","Array length mismatch - coeffsChanged = true",null,"filter"),u=!0;else for(let h=0;h<l.length;h++){const m=ee[h]??0,f=l[h]??0,g=Math.abs(m-f);if(g>.001){B.debug("HarmonicBins",`Coefficient ${h} changed: ${m} -> ${f} (diff: ${g})`,null,"filter"),u=!0;break}}B.debug("HarmonicBins","Force syncing local coeffs with store",null,"filter"),Ra(ee,ve,a),ee=new Float32Array(l),d?ve=new Float32Array(d):ve=new Float32Array(ee.length).fill(0),Ra(ee,ve,a),u?(B.debug("HarmonicBins","Coefficients changed - updating visuals",null,"filter"),Bs()):(B.debug("HarmonicBins","No coefficient changes detected - but local coeffs synced",null,"filter"),Na()),Da.forEach(({phaseBtn:h},m)=>{if(!h)return;let g=(ve[m]||0)%(2*Math.PI);g<0&&(g+=2*Math.PI);const p=.1;let w=0;Math.abs(g-Math.PI/2)<p?w=90:Math.abs(g-Math.PI)<p?w=180:Math.abs(g-3*Math.PI/2)<p&&(w=270),h.innerHTML=Kr[w]})}}),c.on("noteChanged",({newNote:o}={})=>{o?.color&&o.color!==Et&&Vd(o.color)}),c.on("filterChanged",o=>{const a=Et;if(a&&o===a){Bs();const l=c.state.timbres[a],d=l?.filter;if(!l)return;d&&d.enabled!==!1&&(d.mix||0)>0?Rs(l.coeffs,d):new Float32Array(l.coeffs)}}),new ResizeObserver(i).observe(ye),i(),B.info("HarmonicBins","Initialized with columnar div structure and perfect alignment",null,"filter")}B.moduleLoaded("EngineAudio","general");let dt=null;const St={init(){B.info("EngineAudio","Initializing with engine createSynthEngine()",null,"audio"),dt=np({timbres:c.state.timbres,masterVolume:0,harmonicFilter:{getFilteredCoefficients:A=>La(A)},effectsManager:window.audioEffectsManager?{applySynthEffects:(A,t,e)=>{window.audioEffectsManager?.applySynthEffects(A,t,e)},applyEffectsToVoice:(A,t)=>{window.audioEffectsManager?.applyEffectsToVoice(A,t)}}:void 0,logger:{debug:(A,t,e)=>{B.debug(A,t,e,"audio")},info:(A,t,e)=>{B.info(A,t,e,"audio")},warn:(A,t,e)=>{B.warn(A,t,e,"audio")}}}),dt.init(),c.on("timbreChanged",A=>{A&&this.updateSynthForColor(A)}),c.on("filterChanged",A=>{A&&this.updateSynthForColor(A)}),c.on("audioEffectChanged",A=>{if(!A||!A.color||!A.effectType)return;const{effectType:t,color:e}=A;(t==="vibrato"||t==="tremolo")&&this.updateSynthForColor(e)}),c.on("volumeChanged",A=>{typeof A=="number"&&this.setVolume(A)}),window.synthEngine=this,B.info("EngineAudio","Initialization complete",null,"audio")},updateSynthForColor(A){if(!dt)return;const t=c.state.timbres[A];t&&(t.vibrato||(t.vibrato={speed:0,span:0}),t.tremelo||(t.tremelo={speed:0,span:0}),dt.updateSynthForColor(A))},playNote(A,t,e){dt&&dt.playNote(A,t,e)},triggerAttack(A,t,e,n){dt&&dt.triggerAttack(A,t,e,n)},triggerAttackInteractive(A,t){dt&&dt.triggerAttackInteractive(A,t)},triggerRelease(A,t,e){dt&&dt.triggerRelease(A,t,e)},releaseAll(){dt&&dt.releaseAll()},quickReleasePitches(A,t){dt&&dt.quickReleasePitches(A,t)},setSynth(A,t){dt&&dt.setSynth?.(A,t)},getSynth(A){return dt?dt.getSynth(A):null},getAllSynths(){return dt?dt.getAllSynths():{}},setBpm(A){dt&&dt.setBpm(A)},setVolume(A){dt&&dt.setVolume(A)},getMasterGainNode(){return dt?dt.getMasterGainNode():null},getMainVolumeNode(){return dt?dt.getMainVolumeNode():null},createWaveformAnalyzer(A){return dt?dt.createWaveformAnalyzer(A):null},getWaveformAnalyzer(A){return dt?dt.getWaveformAnalyzer(A):null},getAllWaveformAnalyzers(){return dt?dt.getAllWaveformAnalyzers():new Map},removeWaveformAnalyzer(A){dt&&dt.removeWaveformAnalyzer(A)},disposeAllWaveformAnalyzers(){dt&&dt.disposeAllWaveformAnalyzers()},stopBackgroundMonitors(){dt&&dt.stopBackgroundMonitors()},teardown(){this.dispose()},dispose(){dt&&(dt.dispose(),dt=null)}};class y1{elements=new Map;initialized=!1;init(){this.initialized||(this.cacheElement("notationGrid","notation-grid"),this.cacheElement("playheadCanvas","playhead-canvas"),this.cacheElement("hoverCanvas","hover-canvas"),this.cacheElement("drumGrid","drum-grid"),this.cacheElement("drumPlayheadCanvas","drum-playhead-canvas"),this.cacheElement("drumHoverCanvas","drum-hover-canvas"),this.cacheElement("appContainer","app-container"),this.cacheElement("pitchGridWrapper","pitch-grid-wrapper"),this.cacheElement("drumGridWrapper","drum-grid-wrapper"),this.cacheElement("eraserButton","eraser-tool-button"),this.cacheElement("playButton","play-button"),this.cacheElement("stopButton","stop-button"),this.cacheElement("clearButton","clear-button"),this.cacheElement("loopButton","loop-button"),this.cacheElement("undoButton","undo-button"),this.cacheElement("redoButton","redo-button"),this.cacheElement("noteBankContainer","note-bank-container"),this.cacheElement("tonicModeGrid","tonic-mode-grid"),this.cacheElement("degreeVisibilityToggle","degree-visibility-toggle"),this.cacheElement("degreeModeToggle","degree-mode-toggle"),this.cacheElement("flatBtn","flat-toggle-btn"),this.cacheElement("sharpBtn","sharp-toggle-btn"),this.cacheElement("frequencyBtn","hz-toggle-btn"),this.cacheElement("octaveLabelBtn","spn-octave-toggle-btn"),this.cacheElement("focusColoursToggle","focus-colours-toggle"),this.cacheElement("harmonyContainerMain","chordShape-container"),this.cacheElement("tempoSlider","tempo-slider"),this.cacheElement("volumeSlider","vertical-volume-slider"),this.initialized=!0)}cacheElement(t,e){const n=document.getElementById(e);n&&this.elements.set(t,n)}get(t){return this.initialized?this.elements.get(t)??null:null}getMultiple(...t){const e={};return t.forEach(n=>{e[n]=this.get(n)}),e}has(t){return this.elements.has(t)}refresh(){this.elements.clear(),this.initialized=!1,this.init()}getStats(){const t=this.elements.size,e=Array.from(this.elements.values()).filter(n=>n!==null).length;return{totalCached:t,foundElements:e,missingElements:t-e}}}const fA=new y1;let S1=[],E1=0,zd=null,Gr=[];function Q1(){const A=c.state,t=Yt.getColumnMap(A);if(zd!==t){zd=t,Gr=[];for(const e of t.entries){if(e.type!=="beat"||e.canvasIndex===null||e.macrobeatIndex===null)continue;const n=e.macrobeatIndex,s=Gr[n];if(!s){Gr[n]={start:e.canvasIndex,end:e.canvasIndex};continue}s.start=Math.min(s.start,e.canvasIndex),s.end=Math.max(s.end,e.canvasIndex)}}}function Pl(){return{cellWidth:c.state.cellWidth,modulationMarkers:c.state.modulationMarkers,baseMicrobeatPx:c.state.baseMicrobeatPx}}function qd(){return S1}function F1(){return E1}function gi(A){const t=Pl(),e=Math.max(0,Math.floor(A));return HA.getColumnPixelPosition(e,t,c.state)?.xStart??0}function Qf(A){const t=Pl(),e=Math.max(0,Math.floor(A));return HA.getColumnPixelPosition(e,t,c.state)?.width??0}function I1(){return Array.isArray(c.state.columnWidths)?c.state.columnWidths.length:0}function x1(){const A=Pl(),t=I1();return HA.getColumnPixelPosition(t,A,c.state)?.xStart??0}function ka(A){const t=c.state;Q1();const e=Yt.getColumnMap(t),n=e.canvasToVisual.get(Math.floor(A));if(n===void 0)return null;const r=e.entries[n]?.macrobeatIndex;if(r==null)return null;const i=Gr[r];if(!i)return null;const o=gi(i.start),a=gi(i.end+1);return{x:o,width:Math.max(0,a-o)}}const U1={hz:0,minAlpha:.2,maxAlpha:.2,maxExpandPx:0,colorRgb:"rgb(255, 235, 0)"};function Zn(A,t,e,n,s,r,i=U1){if(!Number.isFinite(t)||!Number.isFinite(e)||!Number.isFinite(n)||!Number.isFinite(s)||n<=0||s<=0)return;const o=r/1e3,a=i.hz>0?.5+.5*Math.sin(o*(2*Math.PI)*i.hz):1,l=i.minAlpha+(i.maxAlpha-i.minAlpha)*a,d=Math.min(i.maxExpandPx,Math.max(0,n*.1))*a;A.save(),A.globalAlpha=l,A.fillStyle=i.colorRgb,A.fillRect(t-d/2,e,n+d,s),A.restore()}class M1{canvas=null;ctx=null;animationFrameId=null;_lastColumnIndex=null;_lastColumnProgress=0;_lastColumnStartX=0;_lastColumnWidth=0;_lastDebugLogTime=0;activeAnimations=new Map;popDuration={scaleUp:100,scaleDown:300};popScale=1.5;ensureContext(){return this.canvas||(this.canvas=document.getElementById("drum-playhead-canvas")),this.canvas?(this.ctx||(this.ctx=this.canvas.getContext("2d")),this.ctx):null}initialize(){this.canvas=document.getElementById("drum-playhead-canvas"),this.canvas&&(this.ctx=this.canvas.getContext("2d"),c.on("playbackStateChanged",()=>this.handlePlaybackStateChange()),c.on("tempoChanged",()=>this.invalidateTimeMap()))}drawPlayheadLine(t){const e=this.ensureContext();if(!e||!this.canvas)return;const n=Mt(this.canvas);e.strokeStyle="rgba(255, 0, 0, 0.8)",e.lineWidth=2,e.beginPath(),e.moveTo(t,0),e.lineTo(t,n),e.stroke()}drawColumnHighlight(t,e,n){const s=this.ensureContext();if(!s||!this.canvas)return;const r=Mt(this.canvas);Zn(s,t,0,e,r,n)}handlePlaybackStateChange(){c.state.isPlaying&&!c.state.isPaused?this.startRendering():this.stopRendering({clear:!c.state.isPaused})}invalidateTimeMap(){}startRendering(){this.animationFrameId||this.render()}stopRendering({clear:t}={clear:!0}){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),t&&this.ctx&&this.canvas&&this.ctx.clearRect(0,0,ne(this.canvas),Mt(this.canvas))}render(){if(!c.state.isPlaying||c.state.isPaused||!this.ctx||!this.canvas){this.animationFrameId=null;return}this.ctx.clearRect(0,0,ne(this.canvas),Mt(this.canvas));const t=Number(st.seconds||0),e=this.calculateXFromTime(t);if(e===null){this.animationFrameId=requestAnimationFrame(()=>this.render());return}const n=Mt(this.canvas);if(c.state.playheadMode==="macrobeat"){const s=this._lastColumnIndex,r=(s!==null?ka(s):null)??(s!==null?ka(s+1):null);r?Zn(this.ctx,r.x,0,r.width,n,performance.now()):Zn(this.ctx,this._lastColumnStartX,0,this._lastColumnWidth,n,performance.now())}else c.state.playheadMode==="microbeat"?Zn(this.ctx,this._lastColumnStartX,0,this._lastColumnWidth,n,performance.now()):(this.ctx.strokeStyle="#FF6B35",this.ctx.lineWidth=3,this.ctx.shadowColor="#FF6B35",this.ctx.shadowBlur=6,this.ctx.beginPath(),this.ctx.moveTo(e,0),this.ctx.lineTo(e,n),this.ctx.stroke(),this.ctx.shadowBlur=0);this.debugPlayhead(st.seconds,e),this.animationFrameId=requestAnimationFrame(()=>this.render())}calculateXFromTime(t){this._lastColumnIndex=null,this._lastColumnProgress=0,this._lastColumnStartX=0,this._lastColumnWidth=0;const e=qd();if(!Array.isArray(e)||e.length<2)return null;for(let n=0;n<e.length-1;n++){const s=e[n],r=e[n+1];if(!(typeof s!="number"||typeof r!="number")&&t>=s&&t<r){const i=r-s,o=t-s,a=gi(n)??0,l=Qf(n)??0;return this._lastColumnIndex=n,this._lastColumnProgress=i>0?o/i:0,this._lastColumnStartX=a,this._lastColumnWidth=l,a+(i>0?o/i*l:0)}}return null}debugPlayhead(t,e){if(!window.__DEBUG_PLAYHEAD_SYNC__)return;const n=performance.now();if(n-this._lastDebugLogTime<250)return;this._lastDebugLogTime=n;const s=qd(),r=this._lastColumnIndex,i=Array.isArray(s)&&r!==null&&r>=0?s[r]:void 0,o=Array.isArray(s)&&r!==null&&r+1<s.length?s[r+1]:void 0,a=Array.isArray(s)?s[s.length-1]??0:0,l=F1(),d={transportSeconds:Number(t.toFixed(3)),drumX:Number((e??0).toFixed(2)),columnIndex:r,columnProgress:Number(this._lastColumnProgress.toFixed(3)),drumStartTime:Number(i?.toFixed(3)??NaN),transportStartTime:Number(i?.toFixed(3)??NaN),startDelta:0,drumEndTime:Number(o?.toFixed(3)??NaN),transportEndTime:Number(o?.toFixed(3)??NaN),endDelta:0,drumTimelineEnd:Number(a.toFixed(3)),transportTimelineEnd:Number(l.toFixed(3)),timelineDelta:Number((a-l).toFixed(3)),toneLoopStart:Number(Number(st.loopStart??0).toFixed(3)),toneLoopEnd:Number(Number(st.loopEnd??0).toFixed(3)),storeLooping:c.state.isLooping};B.debug("DrumPlayheadRenderer","Playhead diagnostics",d,"canvas")}triggerNotePop(t,e){const n=`${t}-${e}`;this.activeAnimations.set(n,{startTime:performance.now(),phase:"scaleUp"}),window.drumGridRenderer&&window.drumGridRenderer.render()}getAnimationScale(t,e){const n=`${t}-${e}`,s=this.activeAnimations.get(n);if(!s)return 1;const r=performance.now(),i=r-s.startTime;if(s.phase==="scaleUp"){if(i>=this.popDuration.scaleUp)return s.phase="scaleDown",s.startTime=r,this.popScale;{const o=i/this.popDuration.scaleUp;return 1+(this.popScale-1)*o}}else if(s.phase==="scaleDown"){if(i>=this.popDuration.scaleDown)return this.activeAnimations.delete(n),1;{const o=i/this.popDuration.scaleDown;return this.popScale-(this.popScale-1)*o}}return 1}hasActiveAnimations(){return this.activeAnimations.size>0}cleanupAnimations(){const t=performance.now();for(const[e,n]of this.activeAnimations.entries()){const s=t-n.startTime,r=n.phase==="scaleUp"?this.popDuration.scaleUp:this.popDuration.scaleUp+this.popDuration.scaleDown;s>r&&this.activeAnimations.delete(e)}}}const uA=new M1;B.moduleLoaded("SixteenthStampPlacements","stamps");function T1(A,t,e,n="#4a90e2"){return xi(A)?c.addSixteenthStampPlacement(A,t,e,n):(B.warn("SixteenthStampPlacements",`Invalid sixteenth stamp ID: ${A}`,{sixteenthStampId:A},"stamps"),null)}function P1(A,t,e,n){return c.eraseSixteenthStampsInArea(A,t,e,n)}function Ff(){c.clearAllSixteenthStamps()}function L1(){return c.getSixteenthStampPlaybackData()}B.moduleLoaded("SixteenthStampScheduler","stamps");const Xd=["0","16n","8n",{"8n":1,"16n":1}];function If(A,t=null){const e=xi(A);if(!e)return B.warn("SixteenthStampScheduler",`Unknown sixteenth stamp ID: ${A}`,{sixteenthStampId:A},"stamps"),[];const n=[];return e.ovals.forEach(s=>{const r=`oval_${s}`,i=t?.shapeOffsets?.[r]||0;n.push({offset:Xd[s],duration:"8n",type:"oval",slot:s,shapeKey:r,rowOffset:i})}),e.diamonds.forEach(s=>{const r=`diamond_${s}`,i=t?.shapeOffsets?.[r]||0;n.push({offset:Xd[s],duration:"16n",type:"diamond",slot:s,shapeKey:r,rowOffset:i})}),n}B.moduleLoaded("TripletStampPlacements","triplets");function H1(A,t,e,n="#4a90e2"){const s=Ui(A);if(!s)return B.warn("TripletStampPlacements",`Invalid triplet stamp ID: ${A}`,{tripletStampId:A},"triplets"),null;const r=dh[s.span]??1;if(!D1(t,r,e))return B.debug("TripletStampPlacements",`Cannot place triplet at time ${t}, row ${e} - collision detected`,{tripletStampId:A,startTimeIndex:t,row:e,span:r},"triplets"),null;const i=e,o={id:`triplet_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,tripletStampId:A,startTimeIndex:t,span:r,row:e,globalRow:i,color:n,timestamp:Date.now()};return c.addTripletStampPlacement(o)}function D1(A,t,e){const n=c.state,s=se(n),r=t*2,i=pe(A,n);for(const o of s){const a=o.columnIndex,l=o.columnIndex+1;if(a>=i&&a<i+r||i>=a&&i<=l)return!1}if(n.sixteenthStampPlacements){for(const o of n.sixteenthStampPlacements)if(o.row===e){const a=PA(o.startColumn,n);if(a===null)return!1;const l=a+2,d=A+r;if(!(l<=A||a>=d))return!1}}if(n.tripletStampPlacements){for(const o of n.tripletStampPlacements)if(o.row===e){const a=o.startTimeIndex+o.span*2;if(!(A+r<=o.startTimeIndex||A>=a))return!1}}return!0}function N1(A,t,e,n){const s=c.state;if(!s.tripletStampPlacements)return!1;const r=[];for(const i of s.tripletStampPlacements)if(i.row>=e&&i.row<=n){const o=i.span*2,a=pe(i.startTimeIndex,s);a+o-1<A||a>t||r.push(i.id)}return r.length>0?(r.forEach(i=>c.removeTripletStampPlacement(i)),B.debug("TripletStampPlacements",`Erased ${r.length} triplet groups`,{removedIds:r,eraseArea:{eraseStartCol:A,eraseEndCol:t,eraseStartRow:e,eraseEndRow:n}},"triplets"),!0):!1}function R1(){return c.getTripletStampPlaybackData()}function xf(){c.clearAllTripletStamps(),B.info("TripletStampPlacements","Cleared all triplet stamp placements",null,"triplets")}B.moduleLoaded("TripletScheduler","triplets");function Uf(A,t=null){const e=Ui(A);if(!e)return B.warn("TripletScheduler",`Unknown triplet stamp ID: ${A}`,{tripletStampId:A},"triplets"),[];const n=[],s=e.span==="eighth"?"8t":"4t",r=s;return e.hits.forEach(i=>{const o=`triplet_${i}`,a=t?.shapeOffsets?.[o]||0;let l;if(i===0)l="0";else if(i===1)l=s;else if(i===2){const d=Kt(s).toSeconds();l=Kt(d*2).toNotation()}else{const d=Kt(s).toSeconds();l=Kt(d*i).toNotation()}n.push({offset:l,duration:r,type:e.span==="eighth"?"triplet-eighth":"triplet-quarter",slot:i,shapeKey:o,rowOffset:a}),B.debug("TripletScheduler",`Triplet stamp ${A} ${e.span} at slot ${i} with offset "${l}", rowOffset: ${a}`,"triplets")}),B.debug("TripletScheduler",`Total events for triplet stamp ${A}:`,n.length,"triplets"),n}B.moduleLoaded("EngineTransport","general");let re=null;const _n=()=>fA.get("playheadCanvas")??document.getElementById("playhead-canvas"),Qr=()=>fA.get("drumPlayheadCanvas")??document.getElementById("drum-playhead-canvas"),k1=()=>fA.get("beatLineHighlight")??document.getElementById("beat-line-highlight"),lA={init(){B.info("EngineTransport","Initializing with engine createTransportService()",null,"transport"),re=ap({synthEngine:St,stateCallbacks:{getState:()=>({tempo:c.state.tempo,columnWidths:c.state.columnWidths,hasAnacrusis:c.state.hasAnacrusis,macrobeatBoundaryStyles:c.state.macrobeatBoundaryStyles,modulationMarkers:c.state.modulationMarkers,isLooping:c.state.isLooping,isPaused:c.state.isPaused,cellWidth:c.state.cellWidth,placedNotes:c.state.placedNotes,timbres:c.state.timbres,fullRowData:c.state.fullRowData,playheadMode:c.state.playheadMode}),getStampPlaybackData:()=>L1().map(A=>({sixteenthStampId:String(A.sixteenthStampId),column:A.column,row:A.row,color:A.color,placement:A.placement})),getStampScheduleEvents:(A,t)=>{const e=typeof A=="string"?Number(A):A;return Number.isFinite(e)?If(e,t??null):[]},getTripletPlaybackData:()=>R1().map(A=>({tripletStampId:String(A.tripletStampId),startTimeIndex:A.startTimeIndex,row:A.row,color:A.color,placement:A.placement})),getTripletScheduleEvents:(A,t)=>{const e=typeof A=="string"?Number(A):A;return Number.isFinite(e)?Uf(e,t??null):[]},timeToCanvas:(A,t)=>pe(A,t),getPlacedTonicSigns:()=>se(c.state),getTonicSpanColumnIndices:A=>pB(A),getMacrobeatInfo:A=>ge(c.state,A),getColumnStartX:A=>gi(A),getColumnWidth:A=>Qf(A),getCanvasWidth:()=>x1(),getMacrobeatHighlightRect:A=>ka(A)},eventCallbacks:{on:(A,t)=>c.on(A,t),emit:(A,t)=>c.emit(A,t),setPlaybackState:(A,t)=>c.setPlaybackState(A,t)},visualCallbacks:{clearPlayheadCanvas:()=>{const A=_n();if(!A)return;const t=A.getContext("2d");if(!t)return;const e=ne(A),n=Mt(A);t.clearRect(0,0,e,n)},clearDrumPlayheadCanvas:()=>{const A=Qr();if(!A)return;const t=A.getContext("2d");if(!t)return;const e=ne(A),n=Mt(A);t.clearRect(0,0,e,n)},drawPlayheadLine:(A,t)=>{const e=_n();if(!e)return;const n=e.getContext("2d");n&&(n.strokeStyle="rgba(255, 0, 0, 0.8)",n.lineWidth=2,n.beginPath(),n.moveTo(A,0),n.lineTo(A,t),n.stroke())},drawPlayheadHighlight:(A,t,e,n)=>{const s=_n();if(!s)return;const r=s.getContext("2d");r&&Zn(r,A,0,t,e,n)},drawDrumPlayheadLine:(A,t)=>{Qr()&&uA.drawPlayheadLine(A)},drawDrumPlayheadHighlight:(A,t,e,n)=>{Qr()&&uA.drawColumnHighlight(A,t,n)},updateBeatLineHighlight:(A,t,e)=>{const n=k1();n&&(e?(n.style.left=`${A}px`,n.style.width=`${t}px`,n.style.display="block"):n.style.display="none")},triggerDrumNotePop:(A,t)=>{uA.triggerNotePop(A,t)},triggerAdsrVisual:(A,t,e,n)=>{window.adsrComponent&&window.adsrComponent.triggerPlayheadVisual(A,t,e,n)},clearAdsrVisuals:()=>{window.adsrComponent&&window.adsrComponent.clearAllPlayheadVisuals()},getPlayheadCanvasWidth:()=>{const A=_n();return A?ne(A):0},getPlayheadCanvasHeight:()=>{const A=_n();return A?Mt(A):0},getDrumCanvasHeight:()=>{const A=Qr();return A?Mt(A):0}},logger:{debug:(A,t,e)=>{B.debug(A,t,e,"transport")},info:(A,t,e)=>{B.info(A,t,e,"transport")},warn:(A,t,e)=>{B.warn(A,t,e,"transport")}}}),re.init(),B.info("EngineTransport","Initialization complete",null,"transport")},handleStateChange(){re&&re.handleStateChange()},start(){re&&re.start()},resume(){re&&re.resume()},pause(){re&&re.pause()},stop(){re&&re.stop()},dispose(){re&&(re.dispose(),re=null)}},_1=/(Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini)/i,Mf=900;let $d=!1,Wr=Mf,Do=!1;const O1=Object.freeze({isMobile:!1,isTouch:!1,isCoarsePointer:!1,orientation:"landscape",width:0,height:0});function Ll(){return typeof window<"u"?window:null}function K1(){const A=Ll();if(!A)return{...O1};const{innerWidth:t=0,innerHeight:e=0}=A,n=A.matchMedia?A.matchMedia("(orientation: portrait)"):null,s=n?n.matches?"portrait":"landscape":e>=t?"portrait":"landscape",r=!!(A.matchMedia&&A.matchMedia("(pointer: coarse)").matches),i=!!(A.matchMedia&&A.matchMedia("(hover: none)").matches),o=typeof navigator<"u"?navigator:null,a=o?.maxTouchPoints??o?.msMaxTouchPoints??0,l="ontouchstart"in A||a>0,d=o?.userAgent?_1.test(o.userAgent):!1,u=t>0?t<=Wr:!1;return{isMobile:!!(d||l&&(r||i||u)),isTouch:l,isCoarsePointer:r,orientation:s,width:t,height:e}}function G1(A){if(typeof document>"u")return;[document.documentElement,document.body].filter(Boolean).forEach(e=>{e.classList.toggle("is-mobile",!!A.isMobile),e.classList.toggle("is-touch",!!A.isTouch),e.classList.toggle("orientation-portrait",A.orientation==="portrait"),e.classList.toggle("orientation-landscape",A.orientation==="landscape")})}function Fr(){if(Do)return;const A=Ll();A&&(Do=!0,A.requestAnimationFrame(()=>{Do=!1;const t=K1();c.setDeviceProfile(t),G1(t)}))}function W1(A,t){return A?typeof A.addEventListener=="function"?(A.addEventListener("change",t),()=>A.removeEventListener("change",t)):typeof A.addListener=="function"?(A.addListener(t),()=>A.removeListener(t)):()=>{}:()=>{}}function V1(A={}){const t=Ll();if(!t||$d)return;Wr=A.maxMobileWidth??Mf,$d=!0;const e=()=>Fr(),n=()=>Fr();t.addEventListener("resize",e),t.addEventListener("orientationchange",n),[t.matchMedia&&t.matchMedia("(pointer: coarse)"),t.matchMedia&&t.matchMedia("(hover: none)"),t.matchMedia&&t.matchMedia(`(max-width: ${Wr}px)`),t.matchMedia&&t.matchMedia("(orientation: portrait)")].filter(Boolean).forEach(r=>{W1(r,Fr)}),Fr(),B.debug("DeviceProfileService",`Initialized (breakpoint <= ${Wr}px)`,null,"ui")}const z1=()=>"/".endsWith("/")?"/":"//",q1=`${z1()}assets/`;function X1(A=""){const t=A.replace(/^\/+/,"");return`${q1}${t}`}function Ge(A){return X1(`icons/${A}`)}class $1{tasks=[];completedTasks=0;totalTasks=0;startTime=null;loadingScreen=null;progressBar=null;progressText=null;statusText=null;initialized=!1;cache={fonts:new Map,icons:new Map,modules:new Map};diagnostics=[];createLoadingScreen(){if(this.loadingScreen)return;const t=document.getElementById("app-loading-screen");t?this.loadingScreen=t:(this.loadingScreen=document.createElement("div"),this.loadingScreen.id="app-loading-screen",this.loadingScreen.innerHTML=`
            <div class="loading-container">
                <div class="loading-logo">
                    <svg viewBox="0 0 100 100" class="logo-svg">
                        <circle cx="50" cy="50" r="45" class="logo-circle" />
                        <path d="M 30 50 Q 50 30, 70 50 T 70 70" class="logo-path" />
                    </svg>
                </div>
                <h1 class="loading-title">Student Notation</h1>
                <div class="loading-progress-container">
                    <div class="loading-progress-bar">
                        <div class="loading-progress-fill" id="loading-progress-fill"></div>
                    </div>
                    <div class="loading-progress-text" id="loading-progress-text">0%</div>
                </div>
                <div class="loading-status" id="loading-status">Initializing...</div>
            </div>
        `,document.body.appendChild(this.loadingScreen)),this.progressBar=this.loadingScreen.querySelector("#loading-progress-fill"),this.progressText=this.loadingScreen.querySelector("#loading-progress-text"),this.statusText=this.loadingScreen.querySelector("#loading-status")}registerTask(t,e=1){this.tasks.push({name:t,weight:e,completed:!1}),this.totalTasks+=e}completeTask(t){const e=this.tasks.find(n=>n.name===t&&!n.completed);e&&(e.completed=!0,this.completedTasks+=e.weight,this.updateProgress())}updateProgress(){if(!this.progressBar||!this.progressText)return;const t=this.totalTasks>0?this.completedTasks/this.totalTasks*100:0;this.progressBar.style.width=`${t}%`,this.progressText.textContent=`${Math.floor(t)}%`,t>=100&&this.completeLoading()}async nextFrame(){await new Promise(t=>{typeof requestAnimationFrame=="function"?requestAnimationFrame(()=>t()):setTimeout(t,0)})}setStatus(t){this.statusText&&(this.statusText.textContent=t)}start(){this.initialized||(this.initialized=!0,this.startTime=performance.now())}completeLoading(){this.loadingScreen&&(this.loadingScreen.classList.add("fade-out"),setTimeout(()=>{this.loadingScreen?.remove(),this.loadingScreen=null},400))}showError(t){if(this.statusText){const e=t instanceof Error?t.message:String(t);this.statusText.textContent=`Error: ${e}`,this.statusText.style.color="#ff4444"}}init(){this.createLoadingScreen(),this.start()}updateStatus(t){this.setStatus(t)}async complete(){this.completeLoading()}async preloadIcon(t){if(this.cache.icons.has(t))return this.cache.icons.get(t);const e=Ge(t);return this.cache.icons.set(t,e),e}getDiagnostics(){return[...this.diagnostics]}}const at=new $1;let Hl=!1,Dl=[],Vr=null;function Tf(){Hl=!0}function Y1(){Hl=!1}function Pf(A){try{return JSON.parse(JSON.stringify(A,(t,e)=>e instanceof Float32Array?{__type:"Float32Array",data:Array.from(e)}:e))}catch{return null}}function _a(A,t,e="root"){const n=[];if(!A||!t)return n;if(typeof A!=typeof t)return n.push({path:e,type:"type_change",oldValue:typeof A,newValue:typeof t,timestamp:Date.now()}),n;if(typeof A!="object")return A!==t&&n.push({path:e,type:"value_change",oldValue:A,newValue:t,timestamp:Date.now()}),n;if(Array.isArray(A)){if(!Array.isArray(t))return n.push({path:e,type:"array_to_non_array",oldLength:A.length,newType:typeof t,timestamp:Date.now()}),n;A.length!==t.length&&n.push({path:e,type:"array_length_change",oldLength:A.length,newLength:t.length,timestamp:Date.now()});const r=Math.max(A.length,t.length);for(let i=0;i<r;i++){const o=_a(A[i],t[i],`${e}[${i}]`);n.push(...o)}return n}const s=new Set([...Object.keys(A),...Object.keys(t)]);for(const r of s)if(!(r in A))n.push({path:`${e}.${String(r)}`,type:"property_added",newValue:t[r],timestamp:Date.now()});else if(!(r in t))n.push({path:`${e}.${String(r)}`,type:"property_removed",oldValue:A[r],timestamp:Date.now()});else{const i=_a(A[r],t[r],`${e}.${String(r)}`);n.push(...i)}return n}function J1(A){Vr=Pf(A)}function j1(A,t="unknown"){if(!Hl||!Vr)return;const e=Pf(A),n=_a(Vr,e);if(n.length>0){const s=n.filter(r=>!r.path.includes("tempo")&&!r.path.includes("isPlaying")&&!r.path.includes("fullRowData")&&!r.path.includes("columnWidths"));s.length>0&&Dl.push({action:t,mutations:s,timestamp:Date.now()})}Vr=e}function Z1(){return[...Dl]}function tS(){Dl=[]}typeof window<"u"&&(window.stateGuard={enable:Tf,disable:Y1,getLog:Z1,clearLog:tS});B.moduleLoaded("RhythmPlaybackService");class eS{scheduledEvents=[];isInitialized=!1;constructor(){this.scheduledEvents=[],this.isInitialized=!1}init(){return this.initialize()}refresh(){this.stopCurrentPattern()}async initialize(){this.isInitialized||(this.isInitialized=!0,B.info("RhythmPlaybackService","Initialized"),window.rhythmPlaybackService=this)}playRhythmPattern(t,e,n,s="oval",r=null){if(!this.isInitialized){B.warn("RhythmPlaybackService","Not initialized, call initialize() first");return}this.stopCurrentPattern();const i=If(t,r);if(!i||i.length===0){B.warn("RhythmPlaybackService",`No events found for sixteenth stamp ${t}`);return}B.debug("RhythmPlaybackService",`Playing pattern for sixteenth stamp ${t}: ${i.length} notes`,{sixteenthStampId:t,basePitch:e,color:n,events:i,hasShapeOffsets:!!r?.shapeOffsets});const o=Dt(),a=r?.globalRow??r?.row;i.forEach((l,d)=>{try{const u=Kt(String(l.offset)).toSeconds(),h=o+u,m=Kt(String(l.duration)).toSeconds(),f=s==="circle"?m*2:m,g=h+f;let p=e;if(a!==void 0&&l.rowOffset!==0){const w=a+l.rowOffset,v=c.state.fullRowData[w];v&&(p=v.toneNote.replace("","b").replace("","#"))}St.triggerAttack(p,n,h),St.triggerRelease(p,n,g),this.scheduledEvents.push({pitch:p,color:n,attackTime:h,releaseTime:g})}catch(u){B.warn("RhythmPlaybackService",`Error scheduling note ${d+1}`,u)}}),B.info("RhythmPlaybackService",`Scheduled ${i.length} notes for rhythm pattern ${t}`)}stopCurrentPattern(){this.scheduledEvents.length!==0&&(B.debug("RhythmPlaybackService",`Clearing ${this.scheduledEvents.length} scheduled events`),St.releaseAll(),this.scheduledEvents=[])}getSixteenthStampAtPosition(t,e){return c.state.sixteenthStampPlacements&&c.state.sixteenthStampPlacements.find(s=>{const r=s.row===e,i=t>=s.startColumn&&t<s.endColumn;return r&&i})||null}playTripletPattern(t,e,n,s=null){if(!this.isInitialized){B.warn("RhythmPlaybackService","Not initialized, call initialize() first");return}this.stopCurrentPattern();const r=Uf(t,s);if(!r||r.length===0){B.warn("RhythmPlaybackService",`No events found for triplet ${t}`);return}B.debug("RhythmPlaybackService",`Playing triplet pattern ${t}: ${r.length} notes`,{tripletStampId:t,basePitch:e,color:n,events:r,hasShapeOffsets:!!s?.shapeOffsets});const i=Dt(),o=s?.globalRow??s?.row;r.forEach((a,l)=>{try{const d=Kt(a.offset).toSeconds(),u=i+d,h=Kt(a.duration).toSeconds(),m=u+h;let f=e;if(o!==void 0&&a.rowOffset!==0){const g=o+a.rowOffset,p=c.state.fullRowData[g];p&&(f=p.toneNote.replace("?T-","b").replace("?T_","#"))}St.triggerAttack(f,n,u),St.triggerRelease(f,n,m),this.scheduledEvents.push({pitch:f,color:n,attackTime:u,releaseTime:m})}catch(d){B.warn("RhythmPlaybackService",`Error scheduling triplet note ${l+1}`,d)}}),B.info("RhythmPlaybackService",`Scheduled ${r.length} notes for triplet pattern ${t}`)}getTripletStampAtPosition(t,e){return c.state.tripletStampPlacements&&c.state.tripletStampPlacements.find(n=>n.row===e&&t>=n.startTimeIndex&&t<n.startTimeIndex+n.span*2)||null}dispose(){this.stopCurrentPattern(),this.isInitialized=!1,B.info("RhythmPlaybackService","Disposed")}}const kt=new eS,AS={H:"https://tonejs.github.io/audio/drum-samples/CR78/hihat.mp3",M:"https://tonejs.github.io/audio/drum-samples/CR78/snare.mp3",L:"https://tonejs.github.io/audio/drum-samples/CR78/kick.mp3"};let Ir=null,Yd=!1;async function nS(){if(!Yd){Ir=new Si(AS);try{await Ir.loaded,Yd=!0}catch(A){console.warn("Drum sample preloading failed, will load on-demand:",A),Ir?.dispose(),Ir=null}}}const Lf=[];function Ut(...A){Lf.push(A)}const Hf={enableModulationTool(){c.setSelectedTool("modulation"),Ut("[MODULATION TEST] Modulation tool enabled. Click on the grid to place markers."),Ut("[MODULATION TEST] Click marker labels to toggle 2:3  3:2"),Ut("[MODULATION TEST] Drag marker barlines to move them")},addTestMarker(){const t=this.findNearestGridLine(200),e=this.findMeasureIndexForX(t.x),n=c.addModulationMarker(e,Ce.COMPRESSION_2_3,t.x,t.columnIndex);return Ut("[MODULATION TEST] Added test marker at measure",e,"columnIndex=",t.columnIndex,"x=",t.x,"(snapped from",200,")"),n},addTestMarker2(){const t=this.findNearestGridLine(400),e=this.findMeasureIndexForX(t.x),n=c.addModulationMarker(e,Ce.EXPANSION_3_2,t.x,t.columnIndex);return Ut("[MODULATION TEST] Added test marker 2 at measure",e,"columnIndex=",t.columnIndex,"x=",t.x,"(snapped from",400,")"),n},findNearestGridLine(A){const t=c.state;let e=0,n=0,s=1/0,r=0;for(let i=0;i<t.columnWidths.length;i++){const o=Math.abs(r-A);o<s&&(s=o,n=r,e=i);const a=t.columnWidths[i]||0;r+=a*t.cellWidth}return Ut("[MODULATION TEST] findNearestGridLine:",{targetX:A,closestColumnIndex:e,closestX:n,minDistance:s}),{columnIndex:e,x:n}},findMeasureIndexForX(A){const t=c.state.cellWidth||40,e=5,n=Math.round(A/t);return Math.max(1,Math.round(n/e))},clearAllMarkers(){[...c.state.modulationMarkers||[]].forEach(t=>{c.removeModulationMarker(t.id)}),Ut("[MODULATION TEST] Cleared all markers")},testMapping(){const A=c.state.baseMicrobeatPx||c.state.cellWidth||40;Ut("[MODULATION TEST] Base microbeat pixels:",A),Ut("[MODULATION TEST] Modulation markers:",c.state.modulationMarkers);const t=typeof window<"u"?window.getModulationMapping?.():void 0;t&&(Ut("[MODULATION TEST] Coordinate mapping:",t),[0,100,200,300,400,500].forEach(n=>{const s=t.canvasXToMicrobeat(n),r=t.microbeatToCanvasX(s);Ut(`[MODULATION TEST] x=${n}  microbeat=${s.toFixed(3)}  x=${r.toFixed(1)}`)}))},testVisualExpansion(){Ut("[MODULATION TEST] Testing visual grid expansion..."),this.clearAllMarkers();const A=this.addTestMarker2();Ut("[MODULATION TEST] Added 3:2 expansion marker:",A),typeof window<"u"&&window.LayoutService?.recalculateLayout&&(Ut("[MODULATION TEST] Manually triggering layout recalculation..."),window.LayoutService.recalculateLayout()),setTimeout(()=>{Ut("[MODULATION TEST] Grid should now show expansion after x=400"),Ut("[MODULATION TEST] Container should be wider to accommodate expansion"),Ut("[MODULATION TEST] Check console for [LAYOUT], [GETCOLX], [GRIDLINES], and [NOTES] logs")},100)},testVisualCompression(){Ut("[MODULATION TEST] Testing visual grid compression..."),this.clearAllMarkers();const A=this.addTestMarker();Ut("[MODULATION TEST] Added 2:3 compression marker:",A),typeof window<"u"&&window.LayoutService?.recalculateLayout&&(Ut("[MODULATION TEST] Manually triggering layout recalculation..."),window.LayoutService.recalculateLayout()),setTimeout(()=>{Ut("[MODULATION TEST] Grid should now show compression after x=200"),Ut("[MODULATION TEST] Container should adjust to accommodate compression"),Ut("[MODULATION TEST] Check console for [LAYOUT], [GETCOLX], [GRIDLINES], and [NOTES] logs")},100)},logState(){Ut("[MODULATION TEST] Current state:",{selectedTool:c.state.selectedTool,modulationMarkers:c.state.modulationMarkers,baseMicrobeatPx:c.state.baseMicrobeatPx,cellWidth:c.state.cellWidth})}};typeof window<"u"&&(window.ModulationTest=Hf,window.ModulationTestLogs=Lf);B.moduleLoaded("ToolbarComponent","toolbar");const sS={init(){B.info("ToolbarComponent","Toolbar init called (all controls managed by Svelte)",null,"toolbar")}};var rS=sl('<img alt="Pause" class="svelte-1k8p4m2"/>'),iS=sl('<img alt="Play" class="svelte-1k8p4m2"/>'),oS=sl('<div class="playback-controls svelte-1k8p4m2"><button class="toolbar-button svelte-1k8p4m2"><!></button> <button class="toolbar-button svelte-1k8p4m2" title="Stop"><img alt="Stop" class="svelte-1k8p4m2"/></button> <button><img alt="Loop" class="svelte-1k8p4m2"/></button> <div class="separator svelte-1k8p4m2"></div> <button class="toolbar-button svelte-1k8p4m2" title="Clear All Notes"><img alt="Clear" class="svelte-1k8p4m2"/></button> <div class="separator svelte-1k8p4m2"></div> <button class="toolbar-button svelte-1k8p4m2" title="Undo"><img alt="Undo" class="svelte-1k8p4m2"/></button> <button class="toolbar-button svelte-1k8p4m2" title="Redo"><img alt="Redo" class="svelte-1k8p4m2"/></button></div>');function aS(A,t){Ye(t,!0);let e=Rt(Bn(c.state.isPlaying)),n=Rt(Bn(c.state.isPaused)),s=Rt(Bn(c.state.isLooping)),r=Rt(c.state.historyIndex>0),i=Rt(c.state.historyIndex<c.state.history.length-1);Og(()=>{const L=X=>{Bt(e,X.isPlaying,!0),Bt(n,X.isPaused,!0)},V=X=>{Bt(s,X,!0)},_=()=>{Bt(r,c.state.historyIndex>0),Bt(i,c.state.historyIndex<c.state.history.length-1)};return c.on("playbackStateChanged",L),c.on("loopingChanged",V),c.on("historyChanged",_),_(),()=>{}});const o=Xi(()=>Ge("play.svg")),a=Xi(()=>Ge("pause.svg")),l=Xi(()=>rt(e)&&!rt(n));function d(){rt(e)&&rt(n)?(c.setPlaybackState(!0,!1),lA.resume()):rt(e)&&!rt(n)?(c.setPlaybackState(!0,!0),lA.pause()):(c.setPlaybackState(!0,!1),lA.start())}function u(){c.setPlaybackState(!1,!1),lA.stop()}function h(){c.clearAllNotes(),Ff(),xf()}function m(){c.setLooping(!rt(s))}function f(){c.undo()}function g(){c.redo()}var p=oS(),w=DA(p);w.__click=d;var v=DA(w);{var C=L=>{var V=rS();zi(()=>tA(V,"src",rt(a))),qi(L,V)},F=L=>{var V=iS();zi(()=>tA(V,"src",rt(o))),qi(L,V)};Pg(v,L=>{rt(l)?L(C):L(F,!1)})}var E=Hn(w,2);E.__click=u;var b=DA(E),S=Hn(E,2);let y;S.__click=m;var I=DA(S),Q=Hn(S,4);Q.__click=h;var U=DA(Q),M=Hn(Q,4);M.__click=f;var P=DA(M),R=Hn(M,2);R.__click=g;var $=DA(R);zi((L,V,_,X,At)=>{tA(w,"title",rt(l)?"Pause":"Play"),tA(b,"src",L),y=Lg(S,1,"toolbar-button svelte-1k8p4m2",null,y,{active:rt(s)}),tA(S,"title",rt(s)?"Disable Loop":"Enable Loop"),tA(I,"src",V),tA(U,"src",_),M.disabled=!rt(r),tA(P,"src",X),R.disabled=!rt(i),tA($,"src",At)},[()=>Ge("stop.svg"),()=>Ge("loop.svg"),()=>Ge("clear.svg"),()=>Ge("undo.svg"),()=>Ge("redo.svg")]),qi(A,p),Je()}_g(["click"]);function lS(A,t){Ye(t,!0);let e=Rt(Bn(c.state.isPlaying)),n=Rt(Bn(c.state.isPaused)),s=Rt(Bn(c.state.isLooping)),r=Rt(c.state.historyIndex>0),i=Rt(c.state.historyIndex<c.state.history.length-1),o=null,a=null,l=null,d=null,u=null,h=null;function m(){rt(e)&&rt(n)?(c.setPlaybackState(!0,!1),lA.resume()):rt(e)&&!rt(n)?(c.setPlaybackState(!0,!0),lA.pause()):(c.setPlaybackState(!0,!1),lA.start())}function f(){c.setPlaybackState(!1,!1),lA.stop(),a?.blur()}function g(){d?.classList.add("flash"),setTimeout(()=>d?.classList.remove("flash"),300),c.clearAllNotes(),Ff(),xf(),d?.blur()}function p(){c.setLooping(!rt(s))}function w(){c.undo(),u?.blur()}function v(){c.redo(),h?.blur()}function C(){if(!o)return;const b=`<img src="${Ge("play.svg")}" alt="Play">`,S=`<img src="${Ge("pause.svg")}" alt="Pause">`;o.innerHTML=rt(e)&&!rt(n)?S:b}function F(){l&&l.classList.toggle("active",rt(s))}function E(){u&&(u.disabled=!rt(r)),h&&(h.disabled=!rt(i))}gA(()=>{o=document.getElementById("play-button"),a=document.getElementById("stop-button"),l=document.getElementById("loop-button"),d=document.getElementById("clear-button"),u=document.getElementById("undo-button"),h=document.getElementById("redo-button"),o?.addEventListener("click",m),a?.addEventListener("click",f),l?.addEventListener("click",p),d?.addEventListener("click",g),u?.addEventListener("click",w),h?.addEventListener("click",v);const b=I=>{Bt(e,I.isPlaying,!0),Bt(n,I.isPaused,!0),C()},S=I=>{Bt(s,I,!0),F()},y=()=>{Bt(r,c.state.historyIndex>0),Bt(i,c.state.historyIndex<c.state.history.length-1),E()};c.on("playbackStateChanged",b),c.on("loopingChanged",S),c.on("historyChanged",y),C(),F(),E(),console.log("[Svelte] PlaybackControlsBridge mounted")}),mA(()=>{o?.removeEventListener("click",m),a?.removeEventListener("click",f),l?.removeEventListener("click",p),d?.removeEventListener("click",g),u?.removeEventListener("click",w),h?.removeEventListener("click",v),console.log("[Svelte] PlaybackControlsBridge unmounted")}),Je()}function cS(A,t){Ye(t,!1);let e=null,n=null,s=null,r=null;function i(){const f=new Date,g=f.toLocaleDateString("en-US",{month:"long"}),p=f.getDate();return`SN-score-${g}${p}.csv`}async function o(f){try{const g={suggestedName:i(),types:[{description:"Student Notation CSV File",accept:{"text/csv":[".csv"]}}]},w=await(await window.showSaveFilePicker(g)).createWritable();await w.write(f),await w.close()}catch(g){g.name!=="AbortError"&&B.error("FileActionsBridge","Error saving file with picker",g,"toolbar")}}function a(f){const g=document.createElement("a"),p=URL.createObjectURL(f);g.setAttribute("href",p),g.setAttribute("download",i()),document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(p)}function l(){return c.state.placedNotes.map(f=>[f.row,f.startColumnIndex,f.endColumnIndex,f.color,f.shape,f.tonicNumber||"",f.isDrum,f.drumTrack||""].join(",")).join(`
`)}async function d(){const f=l(),g=new Blob([f],{type:"text/csv;charset=utf-8;"});window.showSaveFilePicker?await o(g):a(g)}function u(){const f=document.createElement("input");f.type="file",f.accept=".csv,.txt",f.onchange=g=>{const w=g.target.files?.[0];if(!w)return;const v=new FileReader;v.onload=C=>{const F=C.target?.result;if(!F){B.warn("FileActionsBridge","Imported file was empty",null,"toolbar");return}const E=new Set(["circle","oval","diamond"]),b=[];if(F.split(`
`).map(S=>S.trim()).filter(S=>S.length>0).forEach(S=>{const y=S.split(",");if(y.length<7){B.warn("FileActionsBridge","Skipping invalid note row",{line:S},"toolbar");return}const I=Number.parseInt(y[0]??"",10),Q=Number.parseInt(y[1]??"",10),U=Number.parseInt(y[2]??"",10),M=(y[3]??"").trim(),P=(y[4]??"").trim().toLowerCase(),R=y[5]?Number.parseInt(y[5],10):null,$=(y[6]??"").trim().toLowerCase()==="true",L=y[7]?Number.parseInt(y[7],10):null,V=typeof L=="number"&&Number.isFinite(L)?L:void 0;if(!M){B.warn("FileActionsBridge","Skipping note with missing color",{line:S},"toolbar");return}if(!Number.isFinite(I)||!Number.isFinite(Q)||!Number.isFinite(U)){B.warn("FileActionsBridge","Skipping note with invalid coordinates",{line:S},"toolbar");return}const _=E.has(P)?P:"circle";E.has(P)||B.warn("FileActionsBridge",`Unknown shape "${P}", defaulting to circle`,null,"toolbar"),b.push({row:I,startColumnIndex:Q,endColumnIndex:U,color:M,shape:_,tonicNumber:R,isDrum:$,drumTrack:V})}),b.length===0){B.warn("FileActionsBridge","No valid notes found in imported file",null,"toolbar");return}c.loadNotes(b)},v.readAsText(w)},f.click()}function h(){document.body.classList.remove("sidebar-open"),c.emit("printPreviewStateChanged",!0)}function m(){window.confirm("Are you sure you want to reset the canvas? This will clear all your work and cannot be undone.")&&c.clearSavedState()}gA(()=>{e=document.getElementById("save-as-button"),n=document.getElementById("import-button"),s=document.getElementById("print-button"),r=document.getElementById("reset-canvas-button"),e?.addEventListener("click",()=>{d()}),n?.addEventListener("click",u),s?.addEventListener("click",h),r?.addEventListener("click",m),console.log("[Svelte] FileActionsBridge mounted")}),mA(()=>{e?.removeEventListener("click",()=>{d()}),n?.removeEventListener("click",u),s?.removeEventListener("click",h),r?.removeEventListener("click",m),console.log("[Svelte] FileActionsBridge unmounted")}),nl(),Je()}function dS(A,t){Ye(t,!1);let e=null,n=null,s=null,r=null;function i(){const u=document.querySelector('.tab-button[data-tab="pitch"]'),h=document.querySelector('.pitch-tab-button[data-pitch-tab="range"]');u?.click(),h?.click()}function o(){i(),c.emit("zoomIn",{source:"button"}),e?.blur()}function a(){i(),c.emit("zoomOut",{source:"button"}),n?.blur()}function l(){c.increaseMacrobeatCount()}function d(){c.decreaseMacrobeatCount()}gA(()=>{e=document.getElementById("grid-zoom-in"),n=document.getElementById("grid-zoom-out"),s=document.getElementById("macrobeat-increase"),r=document.getElementById("macrobeat-decrease"),e?.addEventListener("click",o),n?.addEventListener("click",a),s?.addEventListener("click",l),r?.addEventListener("click",d),console.log("[Svelte] GridControlsBridge mounted")}),mA(()=>{e?.removeEventListener("click",o),n?.removeEventListener("click",a),s?.removeEventListener("click",l),r?.removeEventListener("click",d),console.log("[Svelte] GridControlsBridge unmounted")}),nl(),Je()}function uS(A,t){Ye(t,!0);let e=null,n=null,s=null,r=Rt(null);function i(){rt(r)===Ce.COMPRESSION_2_3?(Bt(r,null),e?.classList.remove("active"),c.setSelectedTool("note"),B.info("ModulationBridge","2:3 modulation tool deactivated",null,"ui")):(Bt(r,Ce.COMPRESSION_2_3,!0),e?.classList.add("active"),n?.classList.remove("active"),c.setSelectedTool("modulation"),c.state.selectedModulationRatio=rt(r),B.info("ModulationBridge","2:3 modulation tool activated",null,"ui"))}function o(){rt(r)===Ce.EXPANSION_3_2?(Bt(r,null),n?.classList.remove("active"),c.setSelectedTool("note"),B.info("ModulationBridge","3:2 modulation tool deactivated",null,"ui")):(Bt(r,Ce.EXPANSION_3_2,!0),n?.classList.add("active"),e?.classList.remove("active"),c.setSelectedTool("modulation"),c.state.selectedModulationRatio=rt(r),B.info("ModulationBridge","3:2 modulation tool activated",null,"ui"))}function a(){const h=(c.state.modulationMarkers||[]).length;if(h===0){B.info("ModulationBridge","No modulation markers to clear",null,"ui");return}c.clearModulationMarkers(),B.info("ModulationBridge",`Cleared ${h} modulation markers`,null,"ui")}function l(){if(!s)return;const h=(c.state.modulationMarkers||[]).length;h===0?(s.disabled=!0,s.style.opacity="0.5"):(s.disabled=!1,s.style.opacity="1"),s.textContent=h>0?`Clear (${h})`:"Clear"}function d(h){const m=h;(typeof m=="string"?m:m.newTool||m)!=="modulation"&&(Bt(r,null),e?.classList.remove("active"),n?.classList.remove("active"))}function u(){l()}gA(()=>{if(e=document.getElementById("modulation-2-3-btn"),n=document.getElementById("modulation-3-2-btn"),s=document.getElementById("modulation-clear-btn"),!e||!n||!s){B.warn("ModulationBridge","Modulation control buttons not found in DOM",null,"ui");return}e.addEventListener("click",i),n.addEventListener("click",o),s.addEventListener("click",a),c.on("toolChanged",d),c.on("modulationMarkersChanged",u),l(),B.info("ModulationBridge","Modulation controls initialized",null,"ui"),console.log("[Svelte] ModulationBridge mounted")}),mA(()=>{e?.removeEventListener("click",i),n?.removeEventListener("click",o),s?.removeEventListener("click",a),console.log("[Svelte] ModulationBridge unmounted")}),Je()}function hS(A,t){const e=A.endMicrobeatCol<t.startMicrobeatCol,n=t.endMicrobeatCol<A.startMicrobeatCol;return!e&&!n}function fS(A,t){const e=Math.max(A.startMicrobeatCol,t.startMicrobeatCol),n=Math.min(A.endMicrobeatCol,t.endMicrobeatCol);if(e>n)return[];const s=[];for(let r=e;r<=n;r++)s.push(r);return s}function gS(A){const t=[],e=A.notes;for(let n=0;n<e.length;n++)for(let s=n+1;s<e.length;s++){const r=e[n],i=e[s];if(hS(r,i)){const o=fS(r,i);t.push({voiceId:A.voiceId,color:A.color,conflictColumns:o,note1:{startMicrobeatCol:r.startMicrobeatCol,endMicrobeatCol:r.endMicrobeatCol,midiPitch:r.midiPitch},note2:{startMicrobeatCol:i.startMicrobeatCol,endMicrobeatCol:i.endMicrobeatCol,midiPitch:i.midiPitch}})}}return t}function mS(A){const t=`Note 1: cols ${A.note1.startMicrobeatCol}-${A.note1.endMicrobeatCol}, MIDI ${A.note1.midiPitch}`,e=`Note 2: cols ${A.note2.startMicrobeatCol}-${A.note2.endMicrobeatCol}, MIDI ${A.note2.midiPitch}`,n=A.conflictColumns.length===1?`column ${A.conflictColumns[0]}`:`columns ${A.conflictColumns[0]}-${A.conflictColumns[A.conflictColumns.length-1]}`;return`Voice "${A.voiceId}" (${A.color}): Overlap at ${n}
  ${t}
  ${e}`}function pS(A){const t=[],e=[];if(A.schemaVersion!==1&&e.push(`Unsupported schema version: ${A.schemaVersion}. Expected: 1`),A.timeGrid||e.push("Missing required field: timeGrid"),(!A.voices||!Array.isArray(A.voices))&&e.push("Missing or invalid field: voices"),A.clefPitchRange){const{minMidi:n,maxMidi:s}=A.clefPitchRange;!Number.isFinite(n)||!Number.isFinite(s)?e.push("Invalid clefPitchRange: MIDI values must be finite numbers"):n>s&&e.push("Invalid clefPitchRange: minMidi exceeds maxMidi")}if(A.voices)for(const n of A.voices){const s=gS(n);t.push(...s)}for(const n of t)e.push(mS(n));return{isValid:t.length===0&&e.length===0,conflicts:t,errorMessages:e}}function BS(A){const t=pS(A);if(t.isValid)return{isValid:!0,summary:"Validation passed. Ready to export to Singing Trainer.",details:t};const e=new Set(t.conflicts.map(s=>s.voiceId));return{isValid:!1,summary:`Cannot export: ${t.conflicts.length} overlap(s) found in ${e.size} voice(s).`,details:t}}function wS(A){return A.reduce((t,e)=>t+e,0)}function vS(A){if(A.length===0)return 2;const t=A.filter(n=>n===2).length;return A.filter(n=>n===3).length>t?3:2}function CS(A,t,e){const n=e.topIndex+A;return n<0||n>=t.length?-1:t[n]?.midi??-1}function bS(A,t,e){const n=e.topIndex+A;return n<0||n>=t.length?"Unknown":t[n]?.toneNote??"Unknown"}function yS(A,t){const e=A[t.topIndex],n=A[t.bottomIndex],s=e?.midi,r=n?.midi;return typeof s!="number"||typeof r!="number"?null:{minMidi:Math.min(s,r),maxMidi:Math.max(s,r)}}function SS(A,t,e={}){const n=A.placedNotes.filter(h=>!h.isDrum),s=new Map;for(const h of n){const m=h.color;s.has(m)||s.set(m,[]),s.get(m).push(h)}const r=[];let i=1/0,o=-1/0;for(const[h,m]of s){const f=[];for(const g of m){const p=CS(g.row,A.fullRowData,A.pitchRange),w=bS(g.row,A.fullRowData,A.pitchRange);p>0&&(i=Math.min(i,p),o=Math.max(o,p)),f.push({startMicrobeatCol:g.startColumnIndex,endMicrobeatCol:g.endColumnIndex,midiPitch:p,pitchName:w,shape:g.shape})}f.sort((g,p)=>g.startMicrobeatCol-p.startMicrobeatCol),r.push({voiceId:h,color:h,notes:f})}const a={microbeatCount:wS(A.macrobeatGroupings),microbeatsPerMacrobeat:vS(A.macrobeatGroupings),macrobeatGroupings:[...A.macrobeatGroupings],macrobeatBoundaryStyles:[...A.macrobeatBoundaryStyles]},l=[];if(A.annotations&&Array.isArray(A.annotations))for(const h of A.annotations)l.push({type:"freehand",id:h.id??`overlay-${Date.now()}`,data:h,coordinateSystem:"pixel"});const d=e.includeClefPitchRange===!1?null:yS(A.fullRowData,A.pitchRange),u={schemaVersion:Hg,createdAt:Date.now(),sourceFileId:t,sourceApp:"student-notation",timeGrid:a,voices:r,tempo:A.tempo,minMidiPitch:i===1/0?void 0:i,maxMidiPitch:o===-1/0?void 0:o};return d&&(u.clefPitchRange=d),e.preferredPitchRangeSource&&(u.preferredPitchRangeSource=e.preferredPitchRangeSource),l.length>0&&(u.visualOverlays=l),e.tonalCenter&&(u.tonalCenter=e.tonalCenter),u}function ES(A,t){Ye(t,!0);let e=null,n=null,s=null,r=null,i=null,o=null,a=null,l=null,d=null,u=null,h=null,m=null,f=null,g=null,p=null,w=null,v=null,C=null,F=null,E=null,b=null,S=null,y=Rt(!0),I=Rt(!0),Q=Rt(!0),U=Rt(!0);const M="app.volumeSliderValue";function P(N){return Math.min(100,Math.max(0,N))}function R(){try{const N=window.localStorage.getItem(M);if(N!==null){const et=Number(N);if(!Number.isNaN(et))return P(et)}}catch{}return 70}function $(N){try{window.localStorage.setItem(M,String(P(N)))}catch{}}function L(){document.body.classList.toggle("sidebar-open")}function V(N){if(N.stopPropagation(),!i||!r)return;const et=i.classList.toggle("visible");r.classList.toggle("active",et)}function _(){const N=parseInt(this.value,10),et=N===0?-1/0:N/100*37.5-50;c.emit("volumeChanged",et),$(N)}function X(N){!i||!r||!i.contains(N.target)&&N.target!==r&&(i.classList.remove("visible"),r.classList.remove("active"))}function At(){c.setAnacrusis(!0)}function ht(){c.setAnacrusis(!1)}function mt(N){const et=N;a?.classList.toggle("active",et),l?.classList.toggle("active",!et)}function it(){c.setLongNoteStyle("style1")}function x(){c.setLongNoteStyle("style2")}function H(N){const et=N;d?.classList.toggle("active",et==="style1"),u?.classList.toggle("active",et==="style2")}function O(){c.setPlayheadMode("cursor")}function z(){c.setPlayheadMode("microbeat")}function G(){c.setPlayheadMode("macrobeat")}function ct(N){const et=N==="macrobeat"?"macrobeat":N==="microbeat"?"microbeat":"cursor";h?.classList.toggle("active",et==="cursor"),m?.classList.toggle("active",et==="microbeat"),f?.classList.toggle("active",et==="macrobeat")}function D(){Bt(y,!rt(y)),p&&(p.style.display=rt(y)?"flex":"none");const N=g?.querySelector(".sidebar-button-text");N&&(N.textContent=rt(y)?"Hide Drum Grid":"Show Drum Grid"),setTimeout(()=>he.recalculateLayout(),10)}function k(){Bt(I,!rt(I)),v&&(v.style.display=rt(I)?"flex":"none");const N=w?.querySelector(".sidebar-button-text");N&&(N.textContent=rt(I)?"Hide Button Grid":"Show Button Grid"),setTimeout(()=>he.recalculateLayout(),10)}function T(){Bt(Q,!rt(Q)),F&&(F.style.display=rt(Q)?"block":"none"),C&&(C.textContent=rt(Q)?"Hide Left Legend":"Show Left Legend"),setTimeout(()=>he.recalculateLayout(),10)}function W(){Bt(U,!rt(U)),b&&(b.style.display=rt(U)?"block":"none"),E&&(E.textContent=rt(U)?"Hide Right Legend":"Show Right Legend"),setTimeout(()=>he.recalculateLayout(),10)}function K(N,et,ot=[]){const nt=document.getElementById("notification-overlay"),ft=nt?.querySelector(".notification-message"),wt=nt?.querySelector(".notification-title");if(!nt||!ft){alert(`${N}

${et}${ot.length>0?`

`+ot.join(`
`):""}`);return}wt&&(wt.textContent=N);const Ct=ot.length>0?`<ul style="text-align: left; margin-top: 8px; padding-left: 20px;">${ot.map(gt=>`<li style="margin-bottom: 4px;">${gt.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</li>`).join("")}</ul>`:"";ft.innerHTML=`<p>${et.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</p>${Ct}`,nt.classList.add("visible");const vt=nt.querySelector(".notification-close"),Z=nt.querySelector(".notification-button"),lt=()=>{nt.classList.remove("visible"),vt?.removeEventListener("click",lt),Z?.removeEventListener("click",lt)};vt?.addEventListener("click",lt),Z?.addEventListener("click",lt)}function q(){return c.state.placedNotes.some(N=>!N.isDrum)}async function tt(){if(console.log("[Svelte] Take to Singing Trainer clicked"),!q()){K("Cannot Export","No notes to export. Add some pitch notes to the grid before exporting to Singing Trainer.");return}const N={placedNotes:c.state.placedNotes,macrobeatGroupings:c.state.macrobeatGroupings,macrobeatBoundaryStyles:c.state.macrobeatBoundaryStyles,fullRowData:c.state.fullRowData,pitchRange:c.state.pitchRange,tempo:c.state.tempo,annotations:c.state.annotations},et=SS(N),ot=BS(et);if(!ot.isValid){console.warn("[Svelte] Handoff validation failed",ot.details);const nt=[];for(const ft of ot.details.conflicts){const wt=ft.conflictColumns.length===1?`column ${ft.conflictColumns[0]}`:`columns ${ft.conflictColumns[0]}-${ft.conflictColumns[ft.conflictColumns.length-1]}`;nt.push(`Voice "${ft.color}": Overlap at ${wt}`)}K("Cannot Export to Singing Trainer",ot.summary,nt);return}try{const nt=await Dg(et);console.log("[Svelte] Handoff slot written",nt),Ng(nt)}catch(nt){console.error("[Svelte] Failed to write handoff slot",nt),K("Export Failed","An error occurred while preparing the handoff. Please try again.")}}gA(()=>{if(e=document.getElementById("settings-button"),n=document.getElementById("sidebar"),s=document.getElementById("sidebar-overlay"),r=document.getElementById("volume-icon-button"),i=document.getElementById("volume-popup"),o=document.getElementById("vertical-volume-slider"),a=document.getElementById("anacrusis-on-btn"),l=document.getElementById("anacrusis-off-btn"),d=document.getElementById("long-note-style1-btn"),u=document.getElementById("long-note-style2-btn"),h=document.getElementById("playhead-mode-cursor-btn"),m=document.getElementById("playhead-mode-microbeat-btn"),f=document.getElementById("playhead-mode-macrobeat-btn"),g=document.getElementById("hide-drumgrid-toggle"),p=document.getElementById("drum-grid-wrapper"),w=document.getElementById("hide-buttongrid-toggle"),v=document.getElementById("button-grid"),C=document.getElementById("hide-leftlegend-toggle"),F=document.getElementById("legend-left-canvas"),E=document.getElementById("hide-rightlegend-toggle"),b=document.getElementById("legend-right-canvas"),S=document.getElementById("take-to-singing-trainer-button"),e&&n&&s&&(e.addEventListener("click",L),s.addEventListener("click",L)),r&&i&&o){const N=R();o.value=String(N),r.addEventListener("click",V),o.addEventListener("input",_),document.addEventListener("click",X),o.dispatchEvent(new Event("input"))}if(a&&l&&(a.addEventListener("click",At),l.addEventListener("click",ht),c.on("anacrusisChanged",mt),a.classList.toggle("active",c.state.hasAnacrusis),l.classList.toggle("active",!c.state.hasAnacrusis)),d&&u){d.addEventListener("click",it),u.addEventListener("click",x),c.on("longNoteStyleChanged",H);const N=c.state.longNoteStyle||"style1";d.classList.toggle("active",N==="style1"),u.classList.toggle("active",N==="style2")}if(h&&m&&f){h.addEventListener("click",O),m.addEventListener("click",z),f.addEventListener("click",G),c.on("playheadModeChanged",ct);const N=c.state.playheadMode||"cursor";h.classList.toggle("active",N==="cursor"),m.classList.toggle("active",N==="microbeat"),f.classList.toggle("active",N==="macrobeat")}g&&p&&g.addEventListener("click",D),w&&v&&w.addEventListener("click",k),C&&F&&C.addEventListener("click",T),E&&b&&E.addEventListener("click",W),S&&S.addEventListener("click",()=>{tt()}),console.log("[Svelte] SidebarBridge mounted")}),mA(()=>{e?.removeEventListener("click",L),s?.removeEventListener("click",L),r?.removeEventListener("click",V),o?.removeEventListener("input",_),document.removeEventListener("click",X),a?.removeEventListener("click",At),l?.removeEventListener("click",ht),d?.removeEventListener("click",it),u?.removeEventListener("click",x),h?.removeEventListener("click",O),m?.removeEventListener("click",z),f?.removeEventListener("click",G),g?.removeEventListener("click",D),w?.removeEventListener("click",k),C?.removeEventListener("click",T),E?.removeEventListener("click",W),console.log("[Svelte] SidebarBridge unmounted")}),Je()}const Ki={selectedSixteenthStampId:1,updateSixteenthStampColors:A=>{},init(){this.render(),this.bindEvents(),B.info("SixteenthStampsToolbar","Sixteenth stamps toolbar initialized",null,"stamps")},render(){const A=document.getElementById("sixteenth-stamps-toolbar-container");if(!A){B.warn("SixteenthStampsToolbar","Container not found",null,"stamps");return}A.innerHTML="";const t=document.createElement("div");t.className="sixteenth-stamps-grid",[[1,2,3,4],[5,8,14,6,9,7],[10,13,12,11,15]].forEach((n,s)=>{const r=document.createElement("div");r.className=`sixteenth-stamps-row sixteenth-stamps-row-${s+1}`,n.forEach(i=>{const o=aa.find(a=>a.id===i);if(o){const a=this.createSixteenthStampButton(o);r.appendChild(a)}}),t.appendChild(r)}),A.appendChild(t),this.setInitialSelection(this.selectedSixteenthStampId)},createSixteenthStampButton(A){const t=document.createElement("button");t.className="sixteenth-stamp-button",t.dataset.sixteenthStampId=`${A.id}`,t.setAttribute("title",`${A.id}: ${A.label}`);const e=this.createSixteenthStampPreview(A);return t.appendChild(e),t},createSixteenthStampPreview(A){const t=Sl.renderToSVG(A,100,100);return t.setAttribute("width","40"),t.setAttribute("height","40"),t},bindEvents(){const A=document.getElementById("sixteenth-stamps-toolbar-container");if(!A)return;A.addEventListener("click",e=>{const n=e.target?.closest(".sixteenth-stamp-button");if(n){const s=parseInt(n.dataset.sixteenthStampId||"",10);Number.isNaN(s)||this.selectSixteenthStamp(s)}}),this.updateSixteenthStampColors=e=>{if(!e||!A)return;const n=(l,d=50)=>{const u=parseInt(l.slice(1,3),16),h=parseInt(l.slice(3,5),16),m=parseInt(l.slice(5,7),16),f=Math.min(255,Math.floor(u+(255-u)*(d/100))),g=Math.min(255,Math.floor(h+(255-h)*(d/100))),p=Math.min(255,Math.floor(m+(255-m)*(d/100)));return`#${f.toString(16).padStart(2,"0")}${g.toString(16).padStart(2,"0")}${p.toString(16).padStart(2,"0")}`},s=(l,d=20)=>{const u=parseInt(l.slice(1,3),16),h=parseInt(l.slice(3,5),16),m=parseInt(l.slice(5,7),16),f=Math.max(0,Math.floor(u*(1-d/100))),g=Math.max(0,Math.floor(h*(1-d/100))),p=Math.max(0,Math.floor(m*(1-d/100)));return`#${f.toString(16).padStart(2,"0")}${g.toString(16).padStart(2,"0")}${p.toString(16).padStart(2,"0")}`},r=c.state.colorPalette[e]||{primary:e,light:e},i=n(r.light,60),o=r.primary,a=s(o,20);A.style.setProperty("--c-accent",o),A.style.setProperty("--c-accent-light",i),A.style.setProperty("--c-accent-hover",a)},c.on("noteChanged",({newNote:e}={})=>{e?.color&&this.updateSixteenthStampColors(e.color)});const t=c.state.selectedNote;t?.color&&this.updateSixteenthStampColors(t.color),c.on("toolChanged",({newTool:e}={})=>{e&&e!=="sixteenthStamp"&&this.clearSelection()}),c.on("tripletStampToolSelected",()=>{this.clearSelection()})},setInitialSelection(A){this.selectedSixteenthStampId=A;const t=document.getElementById("sixteenth-stamps-toolbar-container");t&&t.querySelectorAll(".sixteenth-stamp-button").forEach(e=>{const n=e;n.classList.toggle("active",parseInt(n.dataset.sixteenthStampId||"",10)===A)})},selectSixteenthStamp(A){this.selectedSixteenthStampId=A;const t=document.getElementById("sixteenth-stamps-toolbar-container");t&&t.querySelectorAll(".sixteenth-stamp-button").forEach(e=>{const n=e;n.classList.toggle("active",parseInt(n.dataset.sixteenthStampId||"",10)===A)}),c.setSelectedTool("sixteenthStamp"),c.emit("sixteenthStampSelected",A),c.emit("sixteenthStampToolSelected")},clearSelection(){const A=document.getElementById("sixteenth-stamps-toolbar-container");A&&A.querySelectorAll(".sixteenth-stamp-button").forEach(t=>{t.classList.remove("active")})},getSelectedSixteenthStamp(){return aa.find(t=>t.id===this.selectedSixteenthStampId)}};class QS{overlay;modal;title;message;actionsContainer;closeButton;constructor(){this.overlay=document.getElementById("notification-overlay"),this.modal=this.overlay?.querySelector(".notification-modal"),this.title=this.overlay?.querySelector(".notification-title"),this.message=this.overlay?.querySelector(".notification-message"),this.actionsContainer=this.overlay?.querySelector(".notification-actions"),this.closeButton=this.overlay?.querySelector(".notification-close"),this.setupEventListeners()}setupEventListeners(){this.overlay&&(this.closeButton?.addEventListener("click",()=>this.hide()),this.overlay.addEventListener("click",t=>{t.target===this.overlay&&this.hide()}),document.addEventListener("keydown",t=>{t.key==="Escape"&&this.overlay?.classList.contains("visible")&&this.hide()}))}show(t={}){const e=this.overlay;if(!e)return;const{title:n="Notice",message:s="",buttons:r=[{text:"OK",primary:!0,action:()=>this.hide()}]}=t;this.title&&(this.title.textContent=n),this.message&&(this.message.textContent=s);const i=this.actionsContainer;i&&(i.innerHTML="",r.forEach(o=>{const a=document.createElement("button");a.className=`notification-button ${o.primary?"":"secondary"}`,a.textContent=o.text,a.addEventListener("click",()=>{o.action?o.action():this.hide()}),i.appendChild(a)})),e.classList.add("visible"),setTimeout(()=>{this.actionsContainer?.querySelector(".notification-button")?.focus()},100)}hide(){this.overlay&&this.overlay.classList.remove("visible")}alert(t,e="Notice"){this.show({title:e,message:t,buttons:[{text:"OK",primary:!0,action:()=>this.hide()}]})}confirm(t,e="Confirm"){return new Promise(n=>{this.show({title:e,message:t,buttons:[{text:"Cancel",primary:!1,action:()=>{this.hide(),n(!1)}},{text:"OK",primary:!0,action:()=>{this.hide(),n(!0)}}]})})}}const Jd=new QS,Oa=40,FS=Oa;class jd{element;viewportEl;optionsEl;onChange;onBeforeChange;options;optionNodes=[];selectedIndex=0;pointerActive=!1;pointerId=null;lastPointerY=0;deltaBuffer=0;optionHeight=Oa;resizeObserver=null;constructor(t,e,n,s,r){this.element=t,this.viewportEl=t?.querySelector(".clef-wheel-viewport"),this.optionsEl=t?.querySelector(".clef-wheel-options"),this.onChange=s,this.onBeforeChange=r||null,this.options=e,!(!t||!this.viewportEl||!this.optionsEl)&&(this.renderOptions(),this.setIndex(n,{silent:!0}),this.attachEvents(),this.observeSize())}renderOptions(){const t=this.optionsEl;t&&(t.innerHTML="",this.optionNodes=this.options.map((e,n)=>{const s=document.createElement("div");return s.className="clef-wheel-option",s.dataset.index=n.toString(),s.textContent=e.label,t.appendChild(s),s}))}attachEvents(){if(!this.element)return;this.element.addEventListener("wheel",e=>{e.preventDefault(),e.stopPropagation();const n=Math.sign(e.deltaY);n!==0&&this.increment(n)},{passive:!1}),this.element.addEventListener("keydown",e=>{e.key==="ArrowUp"?(e.preventDefault(),this.increment(-1)):e.key==="ArrowDown"?(e.preventDefault(),this.increment(1)):e.key==="Home"?(e.preventDefault(),this.setIndex(0)):e.key==="End"&&(e.preventDefault(),this.setIndex(this.options.length-1))}),this.element.addEventListener("pointerdown",e=>{if(this.pointerActive=!0,this.pointerId=e.pointerId,this.lastPointerY=e.clientY,this.deltaBuffer=0,typeof this.element?.setPointerCapture=="function")try{this.element.setPointerCapture(this.pointerId)}catch{}}),this.element.addEventListener("pointermove",e=>{if(!this.pointerActive||e.pointerId!==this.pointerId)return;const n=e.clientY-this.lastPointerY;if(this.lastPointerY=e.clientY,n===0)return;this.deltaBuffer+=n;const s=this.optionHeight||FS;for(;Math.abs(this.deltaBuffer)>=s;){const r=-Math.sign(this.deltaBuffer);this.increment(r),this.deltaBuffer-=Math.sign(this.deltaBuffer)*s}});const t=e=>{this.pointerActive&&e.pointerId===this.pointerId&&(this.pointerActive=!1,this.pointerId=null,this.deltaBuffer=0,this.element?.hasPointerCapture?.(e.pointerId)&&this.element.releasePointerCapture(e.pointerId))};this.element.addEventListener("pointerup",t),this.element.addEventListener("pointercancel",t),this.element.addEventListener("pointerleave",t)}observeSize(){this.element&&(typeof ResizeObserver=="function"?(this.resizeObserver=new ResizeObserver(t=>{for(const e of t)e.target===this.element&&e.contentRect.height>0&&this.updateVisuals()}),this.resizeObserver.observe(this.element)):window.addEventListener("resize",()=>this.updateVisuals()))}getIndex(){return this.selectedIndex}increment(t){t===0||!this.options||this.options.length===0||this.setIndex(this.selectedIndex+t)}setIndex(t,{silent:e=!1}={}){if(!this.optionsEl)return;let n=t;!e&&typeof this.onBeforeChange=="function"&&(n=this.onBeforeChange(t));const s=Math.max(0,Math.min(this.options.length-1,n));if(s===this.selectedIndex){this.updateVisuals();return}if(this.selectedIndex=s,this.updateVisuals(),!e&&typeof this.onChange=="function"){const r=this.options[s];r&&this.onChange(s,r)}}updateVisuals(){if(!this.optionsEl||!this.viewportEl)return;const t=this.viewportEl.clientHeight||0,e=this.optionNodes?.[this.selectedIndex],n=this.optionNodes?.[0],s=e?.offsetHeight||n?.offsetHeight||Oa;if(this.optionHeight=s,this.optionNodes?.forEach((a,l)=>{const d=Math.abs(l-this.selectedIndex);a.dataset.distance=String(Math.min(d,3))}),t===0||s===0)return;const r=Math.max(0,(t-s)/2);this.optionsEl.style.paddingTop=`${r}px`,this.optionsEl.style.paddingBottom=`${r}px`;const i=e?e.offsetTop+s/2:r+s/2,o=t/2-i;this.optionsEl.style.transform=`translateY(${o}px)`}}class IS{initialized=!1;topPicker=null;bottomPicker=null;topWheel=null;bottomWheel=null;rangeLabel=null;rangeCount=null;fullRangeButton=null;trebleButton=null;altoButton=null;bassButton=null;presetContainer=null;presetButtons=[];activePresetId=null;masterOptions=[];presetRanges={};init(){if(this.initialized)return;if(this.topWheel=document.getElementById("clef-top-wheel"),this.bottomWheel=document.getElementById("clef-bottom-wheel"),this.rangeLabel=document.getElementById("clef-range-label"),this.rangeCount=document.getElementById("clef-range-count"),this.fullRangeButton=document.getElementById("clef-full-range-button"),this.trebleButton=document.getElementById("clef-treble-button"),this.altoButton=document.getElementById("clef-alto-button"),this.bassButton=document.getElementById("clef-bass-button"),this.presetContainer=document.querySelector(".clef-preset-buttons"),this.presetButtons=Array.from(document.querySelectorAll(".clef-preset-button")),!this.topWheel||!this.bottomWheel){B.warn("ClefViewportController","Clef tab elements not found; skipping initialization",null,"ui");return}this.masterOptions=iA.map((e,n)=>({index:n,label:e.pitch,toneNote:e.toneNote,frequency:e.frequency}));const t=this.getViewportRange();this.topPicker=new jd(this.topWheel,this.masterOptions,t.topIndex,e=>this.handleTopSelection(e),e=>this.constrainTopIndex(e)),this.bottomPicker=new jd(this.bottomWheel,this.masterOptions,t.bottomIndex,e=>this.handleBottomSelection(e),e=>this.constrainBottomIndex(e)),this.computePresetRanges(),this.fullRangeButton&&this.fullRangeButton.addEventListener("click",()=>this.applyPresetView("full")),this.trebleButton&&this.trebleButton.addEventListener("click",()=>this.applyPresetView("treble")),this.altoButton&&this.altoButton.addEventListener("click",()=>this.applyPresetView("alto")),this.bassButton&&this.bassButton.addEventListener("click",()=>this.applyPresetView("bass")),c.on("pitchRangeChanged",()=>{this.syncFromViewport()}),c.on("zoomChanged",()=>{this.syncFromViewport()}),this.calculateAndSetWheelHeight(),window.addEventListener("resize",()=>this.calculateAndSetWheelHeight()),this.syncFromViewport(),this.initialized=!0,B.moduleLoaded("ClefViewportController","ui")}refreshWheelVisuals(){this.topPicker?.updateVisuals(),this.bottomPicker?.updateVisuals()}getViewportRange(){const t=Math.max(0,this.masterOptions.length-1),e=ae.getViewportInfo(),n=e?.startRank??c.state.pitchRange?.topIndex??0,s=e?.endRank??n+1,r=Math.max(0,Math.min(t,n)),i=Math.max(r,Math.min(t,s-1));return{topIndex:r,bottomIndex:i}}syncFromViewport(){if(!this.topPicker||!this.bottomPicker)return;const{topIndex:t,bottomIndex:e}=this.getViewportRange();this.topPicker.setIndex(t,{silent:!0}),this.bottomPicker.setIndex(e,{silent:!0}),this.updateSummary(t,e),this.updatePresetHighlight(t,e)}constrainTopIndex=t=>{if(!this.bottomPicker)return t;const e=this.bottomPicker.getIndex(),n=this.masterOptions.length;return Rg(e,t,n,te)};constrainBottomIndex=t=>{if(!this.topPicker)return t;const e=this.topPicker.getIndex(),n=this.masterOptions.length;return kg(e,t,n,te)};handleTopSelection(t){B.debug("ClefViewportController","handleTopSelection called",{newTopIndex:t},"ui"),ae.setViewportTopIndex(t)}handleBottomSelection(t){B.debug("ClefViewportController","handleBottomSelection called",{newBottomIndex:t},"ui"),ae.setViewportBottomIndex(t)}updateSummary(t,e){const n=this.masterOptions[t],s=this.masterOptions[e],r=e-t+1;this.rangeLabel&&n&&s&&(this.rangeLabel.textContent=`${n.label}  ${s.label}`),this.rangeCount&&(this.rangeCount.textContent=`${r} ${r===1?"pitch":"pitches"}`)}computePresetRanges(){const t=(e,n)=>{const s=this.findToneNoteIndex(e),r=this.findToneNoteIndex(n);return s===-1||r===-1?null:{topIndex:Math.min(s,r),bottomIndex:Math.max(s,r)}};this.presetRanges={full:{topIndex:0,bottomIndex:Math.max(0,this.masterOptions.length-1)},treble:t("G5","C4"),alto:t("A4","D3"),bass:t("C4","E2")}}updatePresetHighlight(t,e){let n=null;Object.entries(this.presetRanges).forEach(([s,r])=>{r&&r.topIndex===t&&r.bottomIndex===e&&(n=s)}),this.activePresetId=n,this.presetButtons?.length&&(this.presetButtons.forEach(s=>{const r=s.dataset?.preset?s.dataset.preset??"":(s.id||"").replace(/^clef-/,"").replace(/-button$/,"").replace(/-range$/,"").replace(/-/g,""),i=this.activePresetId&&r===this.activePresetId;s.classList.toggle("active",!!i)}),this.presetContainer&&this.presetContainer.classList.toggle("locked",!1))}applyPresetView(t){const e=this.presetRanges[t];if(!e){B.warn("ClefViewportController","Preset range could not be resolved",{preset:t},"ui");return}const n=t==="full"?420:280;ae.setPitchViewportRange(e,{animateMs:n,source:`preset:${t}`})}findNoteIndex(t){return this.masterOptions.findIndex(e=>e.label===t)}findToneNoteIndex(t){return this.masterOptions.findIndex(e=>e.toneNote===t)}calculateAndSetWheelHeight(){const t=document.querySelector(".range-panel-section.wheels-section"),e=t?.querySelector(".panel-section-title");if(!t||!this.topWheel||!this.bottomWheel)return;const n=t.clientHeight,s=e?.offsetHeight||0,i=n-s-15,o=Math.max(120,Math.min(i,300));this.topWheel.style.setProperty("--clef-wheel-height",`${o}px`),this.bottomWheel.style.setProperty("--clef-wheel-height",`${o}px`),setTimeout(()=>{this.topPicker?.updateVisuals(),this.bottomPicker?.updateVisuals()},0)}}const Zd=new IS,xS={X:["1P","3M","5P"],x:["1P","3m","5P"],"x":["1P","3m","5d"],"X+":["1P","3M","5A"],"X":["1P","3M","5P","7m"],"x":["1P","3m","5P","7m"],"Xmaj":["1P","3M","5P","7M"],"":["1P","3m","5d","7m"],"x":["1P","3m","5d","6M"],"X":["1P","3M","5P","6M"],Xsus2:["1P","2M","5P"],Xsus4:["1P","4P","5P"]},US={"xmaj":["1P","3m","5P","7M"],Xadd9:["1P","3M","5P","9M"],xadd9:["1P","3m","5P","9M"],"X6/9":["1P","3M","5P","6M","9M"],X9:["1P","3M","5P","7m","9M"],X11:["1P","3M","5P","7m","9M","11P"],X13:["1P","3M","5P","7m","9M","13M"],Xmaj9:["1P","3M","5P","7M","9M"],"x":["1P","3m","5P","7m","9M"],"x":["1P","3m","5P","6M"],"x":["1P","3m","5P","7m","9M","11P"],"Xmaj711":["1P","3M","5P","7M","11A"]},tu={...xS,...US},eu={M6:["6M"],A6:["6A"],m7:["7m"],M7:["7M"],d5:["5d"],P5:["5P"],A5:["5A"],m6:["6m"],m3:["3m"],M3:["3M"],P4:["4P"],A4:["4A"],U:["1P"],m2:["2m"],M2:["2M"],A2:["2A"]},MS={"9m":"2m","9M":"2M","9A":"2A","11P":"4P","11A":"4A","13m":"6m","13M":"6M","13A":"6A"};function No(A){return MS[A]??A}function TS(A,t){Ye(t,!0);const e=15;let n=Rt("diatonic"),s=Rt("position"),r=null,i=null,o=null,a=null,l=null,d=null,u=null,h=null,m=null,f=null,g=null,p=null,w=null,v=null,C=[];function F(){return Object.keys(c.state.tonicSignGroups).length>0}function E(D=c.state.degreeDisplayMode){const k=o?.querySelector('[data-mode="diatonic"]'),T=o?.querySelector('[data-mode="modal"]');if(!k||!T)return;D!=="off"&&Bt(n,D,!0);const W=D==="off"?rt(n):D,K=D==="off";[k,T].forEach(q=>{q.disabled=K,q.classList.toggle("disabled",K)}),o&&o.classList.toggle("disabled",K),k.classList.toggle("active",W==="diatonic"),k.setAttribute("aria-pressed",W==="diatonic"?"true":"false"),T.classList.toggle("active",W==="modal"),T.setAttribute("aria-pressed",W==="modal"?"true":"false")}function b(D,k){if(!k)return;const T=D!=="off";k.classList.toggle("active",T),k.setAttribute("aria-pressed",T?"true":"false")}function S(){if(w&&(w.querySelectorAll(".harmony-preset-button").forEach(D=>{D.classList.remove("selected","partial-match")}),c.state.activeChordIntervals)){const D=c.state.activeChordIntervals,k=D.toString(),T=D.map(No),W=w.querySelectorAll(".harmony-preset-button");for(const K of W){const q=K.textContent?.trim()??"",tt=tu[q];if(!tt)continue;const N=tt.toString(),et=tt.map(No);if(N===k){K.classList.add("selected");continue}T.every(nt=>et.includes(nt))&&K.classList.add("partial-match")}}}function y(){if(v&&(v.querySelectorAll(".harmony-preset-button").forEach(D=>D.classList.remove("selected")),c.state.activeChordIntervals)){const k=c.state.activeChordIntervals.map(No);v.querySelectorAll(".harmony-preset-button").forEach(T=>{const W=T.textContent?.trim()??"",q=eu[W]?.[0];q&&k.includes(q)&&T.classList.add("selected")})}}const I=(D,k=50)=>{const T=parseInt(D.slice(1,3),16),W=parseInt(D.slice(3,5),16),K=parseInt(D.slice(5,7),16),q=Math.min(255,Math.floor(T+(255-T)*(k/100))),tt=Math.min(255,Math.floor(W+(255-W)*(k/100))),N=Math.min(255,Math.floor(K+(255-K)*(k/100)));return`#${q.toString(16).padStart(2,"0")}${tt.toString(16).padStart(2,"0")}${N.toString(16).padStart(2,"0")}`},Q=(D,k=1)=>{const T=D.startsWith("#")?D.slice(1):D;if(T.length!==6)return D;const W=parseInt(T.slice(0,2),16),K=parseInt(T.slice(2,4),16),q=parseInt(T.slice(4,6),16);return`rgba(${W}, ${K}, ${q}, ${k})`},U=(D,k)=>{if(!D)return;const T=I(k,50),W=I(T,60);D.style.setProperty("--c-accent",k),D.style.setProperty("--c-accent-light",W),D.style.setProperty("--harmony-partial-bg",Q(W,.25)),D.style.setProperty("--harmony-partial-border",Q(k,.4)),D.style.setProperty("--harmony-partial-bg-hover",Q(W,.4)),D.style.setProperty("--harmony-partial-border-hover",Q(k,.6))};function M(){return(c.state.activeChordIntervals?.length??0)===2?"inversion":"position"}function P(){const D=c.state.activeChordIntervals?.length??1;return D===2?2:Math.max(1,D)}function R(){return M()==="inversion"?c.state.isIntervalsInverted?1:0:c.state.chordPositionState}function $(D){M()==="inversion"?c.setIntervalsInversion(D===1):c.setChordPosition(D)}function L(){if(!p)return;const D=M(),k=R(),T=c.state.activeChordIntervals?.length??1;p.classList.toggle("inversion-mode",D==="inversion"),p.classList.toggle("position-mode",D==="position"),p.classList.remove("state-1","state-2","state-3","state-4","state-5"),k>=1&&k<=5&&p.classList.add(`state-${k}`);for(let W=1;W<=5;W++)p.classList.remove(`disabled-state-${W}`);D==="position"&&(T<=1?p.classList.add("disabled-state-1"):T===2?p.classList.add("disabled-state-2"):T===3?p.classList.add("disabled-state-3"):T===4?p.classList.add("disabled-state-4"):T===5&&p.classList.add("disabled-state-5"))}function V(){const D=M(),k=c.state.activeChordIntervals?.length??1;if(rt(s)!==D){if(D==="inversion"){const T=c.state.chordPositionState===0;c.setIntervalsInversion(!T)}else c.setChordPosition(0);Bt(s,D,!0)}else if(D==="position"){const T=Math.max(0,k-1);c.state.chordPositionState>T&&c.setChordPosition(0)}L()}function _(){V()}function X(D=c.state.selectedToolTonicNumber){if(!C.length)return;const k=C[0]?parseInt(C[0].dataset.tonic??"1",10):1,T=typeof D=="number"?D:parseInt(String(D??""),10),W=Number.isNaN(T)?k:T;C.forEach(K=>{const q=K.dataset.tonic,N=(q?parseInt(q,10):NaN)===W;K.classList.toggle("selected",N),K.setAttribute("aria-pressed",N?"true":"false")})}function At(){return l?.classList.contains("active")?"modal":a?.classList.contains("active")?"diatonic":rt(n)}function ht(){const D=document.querySelector('[data-tab="rhythm"]');D&&!D.classList.contains("active")&&D.click();const k=document.querySelector('[data-rhythm-stamp-tab="sixteenth"]');k&&!k.classList.contains("active")&&k.click()}const mt=D=>{[d,u,m].forEach(k=>{k&&(k.classList.toggle("accidental-btn--disabled",D),k.setAttribute("aria-disabled",D?"true":"false"))})},it=D=>{h&&(h.classList.toggle("active",D),h.setAttribute("aria-pressed",D?"true":"false")),mt(D)},x=D=>{m&&(m.classList.toggle("active",D),m.setAttribute("aria-pressed",D?"true":"false"))};function H({newTool:D}={}){if(r?.classList.remove("selected"),g&&g.classList.remove("active-tool"),D==="eraser")r?.classList.add("selected");else if(D==="chord")g?.classList.add("active-tool");else if(D==="note"){const k=c.state.selectedNote;if(k){const T=document.querySelector(`.note-pair[data-color='${k.color}']`);T?.classList.add("selected"),T?.querySelector(`.note[data-type='${k.shape}']`)?.classList.add("selected")}}X()}function O(){S(),y(),_()}function z({newNote:D}={}){if(!D?.color||!D.shape)return;const{color:k,shape:T}=D;document.querySelectorAll(".note, .note-pair").forEach(q=>q.classList.remove("selected"));const W=document.querySelector(`.note[data-color='${k}'][data-type='${T}']`);if(W)W.classList.add("selected");else{const q=document.querySelector(`.note-pair[data-color='${k}']`);q?.classList.add("selected"),q?.querySelector(`.note[data-type='${T}']`)?.classList.add("selected")}U(g,k);const K=document.querySelector(".tab-sidebar");K&&K.style.setProperty("--c-accent",k)}function G(D){b(D,i),E(D)}function ct(D){u?.classList.toggle("active",D.sharp),d?.classList.toggle("active",D.flat)}gA(()=>{const D=fA.getMultiple("noteBankContainer","eraserButton","degreeVisibilityToggle","degreeModeToggle","flatBtn","sharpBtn","frequencyBtn","octaveLabelBtn","focusColoursToggle");r=D.eraserButton,i=D.degreeVisibilityToggle??null,o=D.degreeModeToggle,a=o?.querySelector('[data-mode="diatonic"]')??null,l=o?.querySelector('[data-mode="modal"]')??null,d=D.flatBtn,u=D.sharpBtn,h=D.frequencyBtn,m=D.octaveLabelBtn,f=D.focusColoursToggle,g=document.querySelector(".pitch-tabs-container"),p=document.getElementById("unified-position-toggle"),w=document.querySelector("#chords-panel .chords-grid"),v=document.querySelector("#chords-panel .intervals-4x4-grid"),C=Array.from(document.querySelectorAll(".tonic-mode-button")),Zd.init(),document.querySelectorAll(".note").forEach(Z=>{Z.addEventListener("click",()=>{const lt=Z.dataset.type,gt=Z.dataset.color||Z.closest(".note-pair")?.dataset.color;if(!(!lt||!gt)){if(lt==="diamond"){c.setSelectedNote("diamond",gt);const zt=document.querySelector(".sixteenth-stamp-button.active"),Tt=zt?parseInt(zt.dataset.sixteenthStampId??"",10):NaN;if(c.state.selectedTool==="sixteenthStamp"&&zt&&!Number.isNaN(Tt)&&Tt!==e)return;ht(),Ki.selectSixteenthStamp(e);return}c.setSelectedNote(lt,gt),c.setSelectedTool("note")}})}),r&&r.addEventListener("click",()=>{if(c.state.selectedTool==="eraser"){c.setSelectedTool(c.state.previousTool||"note");return}c.setSelectedTool("eraser")});const T=document.getElementById("lasso-shortcut-button");T&&T.addEventListener("click",()=>{document.querySelector('[data-tab="pitch"]')?.click(),document.querySelector('[data-pitch-tab="draw"]')?.click(),document.querySelector('button.draw-tool-button[data-draw-tool="lasso"]')?.click()});const W=document.getElementById("marker-shortcut-button");W&&W.addEventListener("click",()=>{document.querySelector('[data-tab="pitch"]')?.click(),document.querySelector('[data-pitch-tab="draw"]')?.click(),document.querySelector('button.draw-tool-button[data-draw-tool="marker"]')?.click()}),C.length&&(C.forEach(Z=>{Z.addEventListener("click",()=>{const lt=Z.getAttribute("data-tonic");if(!lt)return;const gt=parseInt(lt,10);c.setSelectedTool("tonicization",gt),X(gt)})}),X()),w&&w.querySelectorAll(".harmony-preset-button").forEach(Z=>{Z.addEventListener("click",()=>{const lt=Z.textContent?.trim()??"",gt=tu[lt];gt&&gt.length>0&&(c.setActiveChordIntervals(gt),c.setSelectedTool("chord")),Z.blur()}),Z.addEventListener("dblclick",()=>{Z.classList.contains("selected")&&c.setSelectedTool("note"),Z.blur()})}),v&&v.querySelectorAll(".harmony-preset-button").forEach(Z=>{Z.addEventListener("click",()=>{const lt=Z.textContent?.trim()??"",gt=eu[lt];if(gt&&gt.length>0){const zt=gt[0];if(!zt)return;let Tt=c.state.selectedTool==="chord"&&c.state.activeChordIntervals?[...c.state.activeChordIntervals]:["1P"];Tt.includes(zt)?zt!=="1P"&&(Tt=Tt.filter(JA=>JA!==zt)):Tt.push(zt),Tt.includes("1P")||Tt.unshift("1P");const ke=["1P","2m","2M","2A","3m","3M","4P","4A","5d","5P","5A","6m","6M","6A","7m","7M","9M","11P","11A","13M"];Tt.sort((JA,lg)=>ke.indexOf(JA)-ke.indexOf(lg)),c.setActiveChordIntervals(Tt),c.setSelectedTool("chord")}Z.blur()}),Z.addEventListener("dblclick",()=>{c.setActiveChordIntervals(["1P"]),c.setSelectedTool("chord"),Z.blur()})});const K=document.querySelectorAll(".pitch-tab-button"),q=document.querySelectorAll(".pitch-tab-panel");K.forEach(Z=>{Z.addEventListener("click",()=>{const lt=Z.dataset.pitchTab;lt&&(K.forEach(gt=>gt.classList.remove("active")),Z.classList.add("active"),q.forEach(gt=>gt.classList.remove("active")),document.getElementById(`${lt}-panel`)?.classList.add("active"),localStorage.setItem("selectedPitchTab",lt),lt==="chords"&&_(),lt==="range"&&setTimeout(()=>Zd.refreshWheelVisuals(),0))})});const tt=localStorage.getItem("selectedPitchTab")||"chords",N=document.querySelector(`[data-pitch-tab="${tt}"]`);N&&(K.forEach(Z=>Z.classList.remove("active")),q.forEach(Z=>Z.classList.remove("active")),N.classList.add("active"),document.getElementById(`${tt}-panel`)?.classList.add("active"));const et=document.querySelectorAll(".rhythm-stamp-tab-button"),ot=document.querySelectorAll(".rhythm-stamp-tab-panel");et.forEach(Z=>{Z.addEventListener("click",()=>{const lt=Z.dataset.rhythmStampTab;lt&&(et.forEach(gt=>gt.classList.remove("active")),Z.classList.add("active"),ot.forEach(gt=>gt.classList.remove("active")),document.getElementById(`${lt}-stamps-panel`)?.classList.add("active"),localStorage.setItem("selectedRhythmStampTab",lt))})});const nt=localStorage.getItem("selectedRhythmStampTab")||localStorage.getItem("selectedRhythmTab"),ft=nt==="stamps"?"sixteenth":nt==="triplets"?"triplet":nt||"sixteenth",wt=document.querySelector(`[data-rhythm-stamp-tab="${ft}"]`);wt&&(et.forEach(Z=>Z.classList.remove("active")),ot.forEach(Z=>Z.classList.remove("active")),wt.classList.add("active"),document.getElementById(`${ft}-stamps-panel`)?.classList.add("active")),p&&(p.querySelector(".toggle-track")?.addEventListener("click",()=>{const lt=R(),gt=P();$((lt+1)%gt),p.blur()}),p.querySelectorAll(".left-labels .state-label").forEach(lt=>{lt.addEventListener("click",()=>{M()==="inversion"&&$(parseInt(lt.dataset.step??"0",10))})}),p.querySelectorAll(".right-labels .state-label").forEach(lt=>{lt.addEventListener("click",()=>{if(M()!=="position")return;const gt=parseInt(lt.dataset.step??"0",10);gt<P()&&$(gt)})}),c.on("chordPositionChanged",L),c.on("intervalsInversionChanged",L),L()),i&&i.addEventListener("click",()=>{if(c.state.degreeDisplayMode==="off"){if(!F()){Jd.alert("Please place a tonal center on the canvas before showing degrees.","Tonal Center Required");return}c.setDegreeDisplayMode(At())}else c.setDegreeDisplayMode("off");i.blur()}),a&&a.addEventListener("click",()=>{c.state.degreeDisplayMode!=="off"&&c.state.degreeDisplayMode!=="diatonic"&&c.setDegreeDisplayMode("diatonic"),a.blur()}),l&&l.addEventListener("click",()=>{c.state.degreeDisplayMode!=="off"&&c.state.degreeDisplayMode!=="modal"&&c.setDegreeDisplayMode("modal"),l.blur()}),d&&d.addEventListener("click",()=>{c.state.showFrequencyLabels&&c.toggleFrequencyLabels(),c.toggleAccidentalMode("flat"),d.blur()}),u&&u.addEventListener("click",()=>{c.state.showFrequencyLabels&&c.toggleFrequencyLabels(),c.toggleAccidentalMode("sharp"),u.blur()}),h&&h.addEventListener("click",()=>{c.toggleFrequencyLabels(),h.blur()}),m&&m.addEventListener("click",()=>{c.state.showFrequencyLabels&&c.toggleFrequencyLabels(),c.toggleOctaveLabels(),m.blur()}),f&&f.addEventListener("change",()=>{if(!c.state.focusColours&&!F()){Jd.alert("Please place a tonal center on the canvas before enabling focus colours.","Tonal Center Required"),f.checked=!1;return}c.toggleFocusColours()}),c.on("toolChanged",H),c.on("activeChordIntervalsChanged",O),c.on("noteChanged",z),c.on("degreeDisplayModeChanged",G),c.on("accidentalModeChanged",ct),c.on("frequencyLabelsChanged",it),c.on("octaveLabelsChanged",x),it(c.state.showFrequencyLabels),x(c.state.showOctaveLabels),g&&c.state.selectedNote&&U(g,c.state.selectedNote.color);const Ct=document.querySelector(".tab-sidebar");Ct&&c.state.selectedNote&&Ct.style.setProperty("--c-accent",c.state.selectedNote.color),setTimeout(()=>_(),50);const vt=c.state.degreeDisplayMode;b(vt,i),E(vt),S(),y(),_(),console.log("[Svelte] ToolSelectorBridge mounted")}),mA(()=>{console.log("[Svelte] ToolSelectorBridge unmounted")}),Je()}class Ro{parent;settings;_em;_value;decimalPlaces;colors;element;_minDimension;actual=0;hasMoved=!1;clicked=!1;_start={y:0};_changeFactor=1;constructor(t,e={}){const n=typeof t=="string"?document.querySelector(t):t;if(this.parent=n,!this.parent)throw new Error("DraggableNumber: parent element not found");const s={size:[60,30],value:0,min:0,max:2e4,step:1,decimalPlaces:2,colors:{fill:"#e7e7e7",dark:"#333",light:"#fff",accent:"#b35"},useAppStyling:!1},r={fill:e.colors?.fill??s.colors.fill,dark:e.colors?.dark??s.colors.dark,light:e.colors?.light??s.colors.light,accent:e.colors?.accent??s.colors.accent};this.settings={...s,...e,colors:r},this._em=new LS,this._value=new PS(this.settings.min,this.settings.max,this.settings.step,this.settings.value),this.decimalPlaces=this.settings.decimalPlaces,this.colors=this.settings.colors,this.element=document.createElement("input"),this.element.type="text",this.parent.appendChild(this.element);const[i,o]=this.settings.size;this._minDimension=Math.min(i,o),this.settings.useAppStyling?(this.element.className="draggable-number-input",this.element.style.cssText=[`width:${i}px`,`height:${o}px`,"background-color: var(--c-surface)","color: var(--c-text)","border: 1px solid var(--c-border)","border-radius: var(--border-radius-sm)","font-family: var(--main-font)","font-weight: 400","font-size: 14px","text-align: center","outline: none","padding: 0","box-sizing: border-box","user-select: text"].join(";")):this.element.style.cssText=[`width:${i}px`,`height:${o}px`,`background-color:${this.colors.fill}`,`color:${this.colors.dark}`,"font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif","font-weight:500",`font-size:${this._minDimension/2}px`,"border: none","outline: none",`padding:${this._minDimension/4}px ${this._minDimension/4}px`,"box-sizing:border-box","user-select:text"].join(";"),DS(this.element,a=>/^-?\d*\.?\d*$/.test(a)),this.actual=0,this.hasMoved=!1,this.clicked=!1,this.element.value=Au(this._value.value,this.decimalPlaces),this._bind()}on(t,e){return this._em.on(t,e),()=>this._em.off(t,e)}emit(t,e){this._em.emit(t,e)}get value(){return this._value.value}set value(t){this._value.update(t),this.emit("change",this._value.value),this._render()}get min(){return this._value.min}set min(t){this._value.min=t,this._render()}get max(){return this._value.max}set max(t){this._value.max=t,this._render()}get step(){return this._value.step}set step(t){this._value.step=t,this._render()}passiveUpdate(t){this._value.update(t),this._render()}link(t){this.min=t.min,this.max=t.max,this.step=t.step,typeof t.on=="function"&&t.on("change",e=>this.passiveUpdate(e)),this.on("change",e=>{"value"in t&&(t.value=e)}),this.value=t.value}_bind(){this.element.addEventListener("blur",()=>{this.settings.useAppStyling?(this.element.style.backgroundColor="var(--c-surface)",this.element.style.color="var(--c-text)"):(this.element.style.backgroundColor=this.colors.fill,this.element.style.color=this.colors.dark);const t=parseFloat(this.element.value);!Number.isNaN(t)&&t!==this.value?this.value=t:this._render()}),this.element.addEventListener("keydown",t=>{if(t.key==="Enter"){this.element.blur();const e=parseFloat(this.element.value);Number.isNaN(e)||(this.value=e)}},!0),this.element.addEventListener("mousedown",t=>this._onMouseDown(t)),this.element.addEventListener("dragstart",t=>t.preventDefault())}_onMouseDown(t){this.hasMoved=!1,this.clicked=!0,this.element.readOnly=!0,this.actual=this.value,this._start={y:t.clientY};const e=this.element.getBoundingClientRect(),n=(t.clientX-e.left)/e.width;this._changeFactor=HS(n);const s=i=>this._onMouseMove(i),r=()=>this._onMouseUp(s,r);window.addEventListener("mousemove",s),window.addEventListener("mouseup",r)}_onMouseMove(t){if(!this.clicked)return;this.hasMoved=!0;const e=t.clientY-this._start.y,s=Nl(this.max-this.min,0,1e3)/200*Math.pow(this._changeFactor,2),r=this.actual-e*s;this._value.update(r),this._render(),this._value.changed&&this.emit("change",this._value.value)}_onMouseUp(t,e){this.clicked=!1,window.removeEventListener("mousemove",t),window.removeEventListener("mouseup",e),this.hasMoved?document.body.focus():(this.element.readOnly=!1,this.element.focus(),this.element.setSelectionRange(0,this.element.value.length),this.settings.useAppStyling?(this.element.style.backgroundColor="var(--c-accent)",this.element.style.color="var(--c-surface)"):(this.element.style.backgroundColor=this.colors.accent,this.element.style.color=this.colors.light))}_render(){this.element.value=Au(this._value.value,this.decimalPlaces)}}class PS{min;max;step;_value;changed;constructor(t,e,n,s){this.min=Number(t),this.max=Number(e),this.step=Number(n)||1,this._value=0,this.changed=!1,this.update(s)}get value(){return this._value}update(t){const e=Nl(Number(t),this.min,this.max),n=this._stepTo(e),s=this._value;this._value=n,this.changed=n!==s}_stepTo(t){if(!isFinite(this.step)||this.step<=0)return t;const e=Math.round((t-this.min)/this.step);return this.min+e*this.step}}class LS{_m;constructor(){this._m=new Map}on(t,e){const n=this._m.get(t)||[];n.push(e),this._m.set(t,n)}off(t,e){const n=this._m.get(t);if(!n)return;const s=n.indexOf(e);s>=0&&n.splice(s,1)}emit(t,e){const n=this._m.get(t);if(n)for(const s of n.slice())s(e)}}function Nl(A,t,e){return Math.max(t,Math.min(e,A))}function HS(A){return 1-Nl(A,0,1)}function Au(A,t=2){return isFinite(A)?Number(A).toFixed(Math.max(0,t)).replace(/\.0+$/,"").replace(/(\.\d*?)0+$/,"$1"):""}function DS(A,t){let e=A.value;A.addEventListener("input",()=>{t(A.value)?e=A.value:A.value=e})}class NS{isActive=!1;pulseIntervals=new Map;tempoElements=new Map;popDuration={scaleUp:40,scaleDown:80};popScale=1.4;activeAnimations=new Map;constructor(){this.initElements()}initElements(){[{type:"eighth",containerId:"eighth-note-tempo",bpmMultiplier:2},{type:"quarter",containerId:"quarter-note-tempo",bpmMultiplier:1},{type:"dottedQuarter",containerId:"dotted-quarter-tempo",bpmMultiplier:.666}].forEach(({type:e,containerId:n,bpmMultiplier:s})=>{const r=document.getElementById(n),i=r?.parentElement,o=i?.querySelector(".tempo-label-icon");r&&o?this.tempoElements.set(e,{container:r,icon:o,bpmMultiplier:s,originalTransform:r.style.transform||"",originalIconTransform:o.style.transform||""}):B.warn("TempoVisualizer",`Could not find elements for ${e} tempo`,{container:!!r,icon:!!o,tempoGroup:!!i},"toolbar")})}start(){this.isActive||(this.isActive=!0,this.tempoElements.size===0&&this.initElements(),this.tempoElements.forEach((t,e)=>{this.startPulseForType(e)}))}stop(){this.isActive&&(this.isActive=!1,this.pulseIntervals.forEach(t=>{clearInterval(t)}),this.pulseIntervals.clear(),this.activeAnimations.clear(),this.tempoElements.forEach(t=>{t.container.style.transform=t.originalTransform,t.icon.style.transform=t.originalIconTransform}))}startPulseForType(t){const e=this.tempoElements.get(t);if(!e)return;const r=60/(c.state.tempo*e.bpmMultiplier)*1e3;this.triggerPulse(t);const i=setInterval(()=>{this.isActive&&this.triggerPulse(t)},r);this.pulseIntervals.set(t,i)}triggerPulse(t){const n={startTime:performance.now(),phase:"scaleUp"};this.activeAnimations.set(t,n);const s=this.isActive;this.isActive=!0,this.activeAnimations.size===1&&this.animationLoop(),s||setTimeout(()=>{this.activeAnimations.size===0&&(this.isActive=!1)},this.popDuration.scaleUp+this.popDuration.scaleDown+50)}animationLoop(){if(this.activeAnimations.size===0||!this.isActive)return;const t=performance.now();this.activeAnimations.forEach((e,n)=>{const s=this.calculateScale(e,t);this.applyScale(n,s),s===1&&e.phase==="complete"&&this.activeAnimations.delete(n)}),this.activeAnimations.size>0&&requestAnimationFrame(()=>this.animationLoop())}calculateScale(t,e){const n=e-t.startTime;if(t.phase==="scaleUp"){if(n>=this.popDuration.scaleUp)return t.phase="scaleDown",t.startTime=e,this.popScale;{const s=Math.min(n/this.popDuration.scaleUp,1);return 1+(this.popScale-1)*s}}else if(t.phase==="scaleDown"){if(n>=this.popDuration.scaleDown)return t.phase="complete",1;{const s=Math.min(n/this.popDuration.scaleDown,1);return this.popScale-(this.popScale-1)*s}}return 1}applyScale(t,e){const n=this.tempoElements.get(t);if(!n)return;const s=`scale(${e})`;n.container.style.transform=n.originalTransform+" "+s,n.icon.style.transform=n.originalIconTransform+" "+s;const r=e<this.popScale?"transform 0.08s ease-out":"none";n.container.style.transition=r,n.icon.style.transition=r}updateTempo(){this.isActive&&(this.stop(),this.start())}}const sn=new NS,$A=Cn,Oe={blend:2,cutoff:31,resonance:0,type:"lowpass"};function zs(){return{coeffs:new Float32Array($A).fill(0),phases:new Float32Array($A).fill(0)}}function RS(){const A=zs();return A.coeffs[0]=1,A}function kS(){const A=zs();for(let t=1;t<=$A;t+=2){const e=t-1;A.coeffs[e]=1/t,A.phases[e]=0}return A}function _S(){const A=zs();for(let t=1;t<=$A;t+=2){const e=t-1;A.coeffs[e]=1/(t*t),A.phases[e]=Math.PI/2}return A}function OS(){const A=zs();for(let t=1;t<=$A;t++){const e=t-1;A.coeffs[e]=1/t,A.phases[e]=t&1?0:Math.PI}return A}const KS={strings:{amps:[.995,.94,.425,.48,0,.365,.04,.085,0,.09,0,0],phases:[0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,0]},piano:{amps:[1,.7,.6,.5,.4,.32,.25,.2,.17,.14,.12,.1],phases:Array(12).fill(0)},marimba:{amps:[1,.2,.15,.7,.05,.18,.03,.05,.02,.01,0,0],phases:Array(12).fill(0)},woodwind:{amps:[1,.05,.5,.05,.3,.05,.2,.05,.12,.05,.08,.05],phases:Array(12).fill(0)}};function xr(A){const t=zs(),e=KS[A];if(!e)return t;const n=Math.min($A,e.amps.length);for(let s=0;s<n;s++)t.coeffs[s]=e.amps[s]||0,t.phases[s]=e.phases[s]||0;return t}const On={attack:.1,decay:.2,sustain:.8,release:.3},GS={sine:{name:"sine",gain:1,adsr:On,...RS(),filter:{...Oe}},triangle:{name:"triangle",gain:.81,adsr:On,..._S(),filter:{...Oe}},square:{name:"square",gain:4/Math.PI,adsr:On,...kS(),filter:{...Oe}},sawtooth:{name:"sawtooth",gain:2/Math.PI,adsr:On,...OS(),filter:{...Oe}},trapezium:{name:"trapezium",gain:4/Math.PI,adsr:On,coeffs:new Float32Array([.993,0,.314,0,.168,0,.101,0,.06,0,.033,0]),phases:new Float32Array($A).fill(0),filter:{...Oe}},impulse:{name:"impulse",gain:.18,adsr:{attack:.01,decay:.3,sustain:0,release:.2},coeffs:new Float32Array([1,.9,.8,.7,.6,.5,.4,.3,.2,.1,0,0]),phases:new Float32Array([0,Math.PI*1.5,Math.PI,Math.PI/2,0,Math.PI*1.5,Math.PI,Math.PI/2,0,Math.PI*1.5,Math.PI,0]),filter:{...Oe}},strings:{name:"strings",gain:.49,adsr:{attack:.08,decay:.4,sustain:.7,release:.5},...xr("strings"),filter:{...Oe,cutoff:28}},piano:{name:"piano",gain:.8,adsr:{attack:.01,decay:1.5,sustain:0,release:.4},...xr("piano"),filter:{...Oe,cutoff:28}},marimba:{name:"marimba",gain:.9,adsr:{attack:.01,decay:.8,sustain:0,release:.4},...xr("marimba"),filter:{...Oe,cutoff:25}},woodwind:{name:"woodwind",gain:.6,adsr:{attack:.1,decay:.2,sustain:.8,release:.3},...xr("woodwind"),filter:{...Oe}}};function WS(A,t){Ye(t,!0);let e=null,n=null,s=null,r=null,i=null,o=Rt(!1);const a=(S,y=20)=>{const I=parseInt(S.slice(1,3),16),Q=parseInt(S.slice(3,5),16),U=parseInt(S.slice(5,7),16),M=Math.max(0,Math.floor(I*(1-y/100))),P=Math.max(0,Math.floor(Q*(1-y/100))),R=Math.max(0,Math.floor(U*(1-y/100)));return`#${M.toString(16).padStart(2,"0")}${P.toString(16).padStart(2,"0")}${R.toString(16).padStart(2,"0")}`},l=(S,y=50)=>{const I=parseInt(S.slice(1,3),16),Q=parseInt(S.slice(3,5),16),U=parseInt(S.slice(5,7),16),M=Math.min(255,Math.floor(I+(255-I)*(y/100))),P=Math.min(255,Math.floor(Q+(255-Q)*(y/100))),R=Math.min(255,Math.floor(U+(255-U)*(y/100)));return`#${M.toString(16).padStart(2,"0")}${P.toString(16).padStart(2,"0")}${R.toString(16).padStart(2,"0")}`};function d(S){const y=Math.round(S),I=e||document.getElementById("tempo-slider");I&&parseInt(I.value,10)!==y&&(I.value=`${y}`);const Q=y*2,U=Math.round(y/1.5);n&&n.value!==Q&&n.passiveUpdate(Q),s&&s.value!==y&&s.passiveUpdate(y),r&&r.value!==U&&r.passiveUpdate(U),c.state.tempo!==y&&(c.setTempo(y),sn.updateTempo())}function u(S){if(!S)return;const y=S.closest(".tempo-slider-container");if(!y||y.querySelector(".tempo-slider-marks"))return;const I=[60,90,120,160,200],Q=document.createElement("div");Q.className="tempo-slider-marks",y.appendChild(Q);const U=Number(S.min)||0,M=Number(S.max)||1,P=Math.max(M-U,1),R=[],$=()=>{const _=S.getBoundingClientRect().height||S.clientHeight,X=getComputedStyle(S),At=parseFloat(X.getPropertyValue("--slider-thumb-size"))||0,ht=parseFloat(X.getPropertyValue("--slider-thumb-border"))||0,mt=At+ht*2,it=Math.max(_-mt,1),x=mt/2;R.forEach(({el:H,bpm:O})=>{if(O<U||O>M){H.style.display="none";return}H.style.display="";const z=(O-U)/P,G=x+it*z;H.style.bottom=`${G}px`})};I.forEach(V=>{const _=document.createElement("span");_.className="tempo-slider-mark",_.setAttribute("aria-hidden","true"),Q.appendChild(_),R.push({el:_,bpm:V})}),$(),new ResizeObserver($).observe(S)}function h(S){if(!S||!i)return;const y=c.state.timbres[S],I=c.state.colorPalette[S]||{primary:S,light:S},Q=I.light,U=I.primary;document.querySelectorAll(".preset-button").forEach(P=>{const R=P,$=R.id.replace("preset-",""),L=y?.activePresetName===$;R.classList.toggle("selected",L)});const M=l(Q,60);i.style.setProperty("--c-accent",U),i.style.setProperty("--c-accent-light",M),i.style.setProperty("--c-accent-hover",a(U,20))}function m(){Bt(o,!0),sn.start()}function f(){Bt(o,!0),sn.start()}function g(S){const y=S.target,I=y?parseInt(y.value,10):NaN;d(I)}function p(){e?.blur()}function w(){rt(o)&&(Bt(o,!1),sn.stop())}function v(){rt(o)&&(Bt(o,!1),sn.stop())}function C(){rt(o)&&(Bt(o,!1),sn.stop())}function F({newNote:S}){S?.color?h(S.color):(document.querySelectorAll(".preset-button").forEach(y=>y.classList.remove("selected")),i&&(i.style.setProperty("--c-accent","#4A90E2"),i.style.setProperty("--c-accent-hover","#357ABD")))}function E(S){S===c.state.selectedNote?.color&&h(S)}function b(S){d(S)}gA(()=>{e=document.getElementById("tempo-slider"),i=document.querySelector(".preset-effects-container");const S={size:[45,24],step:1,decimalPlaces:0,useAppStyling:!0};n=new Ro("#eighth-note-tempo",{...S,value:180,min:60,max:480}),s=new Ro("#quarter-note-tempo",{...S,value:90,min:30,max:240}),r=new Ro("#dotted-quarter-tempo",{...S,value:60,min:20,max:160}),n.on("change",I=>{!isNaN(I)&&I>0&&d(I/2)}),s.on("change",I=>{!isNaN(I)&&I>0&&d(I)}),r.on("change",I=>{!isNaN(I)&&I>0&&d(I*1.5)}),d(c.state.tempo),e?(u(e),e.addEventListener("mousedown",m),e.addEventListener("touchstart",f),e.addEventListener("input",g),e.addEventListener("mouseup",p),d(c.state.tempo)):B.warn("AudioControlsBridge","Tempo slider not found - will initialize when rhythm tab is opened",null,"toolbar"),document.addEventListener("mouseup",w),document.addEventListener("touchend",v),document.addEventListener("touchcancel",C),document.querySelectorAll(".preset-button").forEach(I=>{const Q=I,U=Q.id.replace("preset-",""),M=GS[U];M&&Q.addEventListener("click",()=>{const P=c.state.selectedNote?.color;P&&(c.applyPreset(P,M),setTimeout(()=>h(P),10)),Q.blur()})}),c.on("noteChanged",F),c.on("timbreChanged",E),c.on("tempoChanged",b);const y=c.state.selectedNote?.color;y&&h(y),console.log("[Svelte] AudioControlsBridge mounted")}),mA(()=>{e?.removeEventListener("mousedown",m),e?.removeEventListener("touchstart",f),e?.removeEventListener("input",g),e?.removeEventListener("mouseup",p),document.removeEventListener("mouseup",w),document.removeEventListener("touchend",v),document.removeEventListener("touchcancel",C),console.log("[Svelte] AudioControlsBridge unmounted")}),Je()}function VS(A,t){Ye(t,!1);const e="selectedTab",n="selectedPresetTab",s="timbre",r="presets";function i(x){try{localStorage.setItem(e,x),B.debug("TabManagement",`Saved tab to localStorage: ${x}`,void 0,"ui")}catch(H){B.warn("TabManagement","Failed to save tab to localStorage",H,"ui")}}function o(){try{return localStorage.getItem(e)||s}catch(x){return B.warn("TabManagement","Failed to read tab from localStorage",x,"ui"),s}}function a(x){try{localStorage.setItem(n,x),B.debug("TabManagement",`Saved preset tab to localStorage: ${x}`,void 0,"ui")}catch(H){B.warn("TabManagement","Failed to save preset tab to localStorage",H,"ui")}}function l(){try{return localStorage.getItem(n)||r}catch(x){return B.warn("TabManagement","Failed to read preset tab from localStorage",x,"ui"),r}}let d=null,u=null,h=null;const m=new Map,f=new Map,g=new Map,p=[{label:"effectsPanelActive",selector:"#effects-panel.preset-tab-panel.active"},{label:"effectsPanel",selector:"#effects-panel"},{label:"effectsContentBox",selector:"#effects-panel .effects-content-box"},{label:"presetsPanelActive",selector:"#presets-panel.preset-tab-panel.active"},{label:"presetsPanel",selector:"#presets-panel"},{label:"presetContentBox",selector:"#presets-panel .preset-content-box"},{label:"presetEffectsContent",selector:".preset-effects-content"},{label:"presetEffectsControls",selector:".preset-effects-controls"},{label:"presetEffectsContainer",selector:".preset-effects-container"},{label:"presetEffectsTabs",selector:".preset-effects-tabs"}];let w=null,v=null;const C=new Map;let F=null,E="",b=!1,S=null;function y(x,H){if(!x)return{selector:H,missing:!0};const O=x,z=O.getBoundingClientRect(),G=window.getComputedStyle(O),ct=O.parentElement,D=ct?.getBoundingClientRect(),k=ct?window.getComputedStyle(ct):null;return{selector:H,tag:O.tagName.toLowerCase(),id:O.id||null,className:O.className||null,rectWidth:Number(z.width.toFixed(1)),rectHeight:Number(z.height.toFixed(1)),offsetWidth:O.offsetWidth,clientWidth:O.clientWidth,scrollWidth:O.scrollWidth,computed:{display:G.display,position:G.position,width:G.width,minWidth:G.minWidth,maxWidth:G.maxWidth,flex:G.flex,flexGrow:G.flexGrow,flexShrink:G.flexShrink,flexBasis:G.flexBasis,alignSelf:G.alignSelf,alignItems:G.alignItems,justifyContent:G.justifyContent,justifySelf:G.justifySelf,gap:G.gap,boxSizing:G.boxSizing,paddingLeft:G.paddingLeft,paddingRight:G.paddingRight,borderLeftWidth:G.borderLeftWidth,borderRightWidth:G.borderRightWidth,overflowX:G.overflowX,overflowY:G.overflowY},parent:ct?{tag:ct.tagName.toLowerCase(),id:ct.id||null,className:ct.className||null,rectWidth:Number((D?.width||0).toFixed(1)),computedWidth:k?.width,display:k?.display,flex:k?.flex}:null}}function I(x){const H=Array.from(document.querySelectorAll(x));return{selector:x,count:H.length,entries:H.map((O,z)=>({index:z,...y(O,x)}))}}function Q(x,H,O=4){if(!x)return{selector:H,missing:!0,chain:[]};const z=[];let G=x,ct=0;for(;G&&ct<O;){const D=G.getBoundingClientRect(),k=window.getComputedStyle(G);z.push({tag:G.tagName.toLowerCase(),id:G.id||null,className:G.className||null,rectWidth:Number(D.width.toFixed(1)),offsetWidth:G.offsetWidth,clientWidth:G.clientWidth,computed:{display:k.display,width:k.width,minWidth:k.minWidth,maxWidth:k.maxWidth,flex:k.flex,flexGrow:k.flexGrow,flexShrink:k.flexShrink,flexBasis:k.flexBasis,alignItems:k.alignItems,justifyContent:k.justifyContent,alignSelf:k.alignSelf,boxSizing:k.boxSizing,paddingLeft:k.paddingLeft,paddingRight:k.paddingRight,gap:k.gap}}),G=G.parentElement,ct+=1}return{selector:H,missing:!1,chain:z}}function U(x){const H=Object.keys(x.elements).sort(),O={activePresetTab:x.activePresetTab,activePresetPanelId:x.activePresetPanelId};return H.forEach(z=>{const G=x.elements[z];if(!G||G.missing){O[z]="missing";return}O[z]={rectWidth:G.rectWidth,rectHeight:G.rectHeight,offsetWidth:G.offsetWidth,clientWidth:G.clientWidth,scrollWidth:G.scrollWidth}}),JSON.stringify(O)}function M(x,H,O,z){if(H.missing||z.missing)return{pair:`${x} vs ${O}`,missing:!0};const G=["rectWidth","offsetWidth","clientWidth","scrollWidth"],ct=["display","position","width","minWidth","maxWidth","flex","alignSelf","boxSizing","paddingLeft","paddingRight","borderLeftWidth","borderRightWidth","overflowX","overflowY"],D=["computedWidth","display","flex"],k=[];return G.forEach(T=>{const W=H[T],K=z[T];W!==K&&k.push({property:T,[x]:W,[O]:K})}),ct.forEach(T=>{const W=H.computed?.[T],K=z.computed?.[T];W!==K&&k.push({property:`computed.${T}`,[x]:W,[O]:K})}),D.forEach(T=>{const W=H.parent?.[T],K=z.parent?.[T];W!==K&&k.push({property:`parent.${T}`,[x]:W,[O]:K})}),{pair:`${x} vs ${O}`,missing:!1,differences:k}}function P(x){b&&(E=E?`${E}; ${x}`:x,F===null&&(F=requestAnimationFrame(()=>{const H=E||"auto";F=null,E="",V(H)})))}function R(){w&&p.forEach(x=>{document.querySelectorAll(x.selector).forEach(H=>{C.has(H)||(C.set(H,x.label),w.observe(H))})})}function $(){w||(b=!0,S=null,w=new ResizeObserver(x=>{const H=x.map(O=>C.get(O.target)||O.target.id||O.target.tagName.toLowerCase()).filter(Boolean);H.length&&P(`Resize: ${H.join(", ")}`)}),v=new MutationObserver(()=>R()),document.body?v.observe(document.body,{childList:!0,subtree:!0}):document.addEventListener("DOMContentLoaded",()=>{v?.observe(document.body,{childList:!0,subtree:!0}),R(),P("init")},{once:!0}),window.addEventListener("resize",()=>P("window resize")),R(),P("init"))}function L(){b=!1,S=null,w&&(w.disconnect(),w=null),v&&(v.disconnect(),v=null),C.clear(),F!==null&&(cancelAnimationFrame(F),F=null),E=""}function V(x){requestAnimationFrame(()=>{const H=document.querySelector(".preset-tab-button.active"),O=document.querySelector(".preset-tab-panel.active"),z=y(document.querySelector("#effects-panel.preset-tab-panel.active"),"#effects-panel.preset-tab-panel.active"),G=y(document.getElementById("effects-panel"),"#effects-panel"),ct=y(document.querySelector("#effects-panel .effects-content-box"),"#effects-panel .effects-content-box"),D=y(document.querySelector("#presets-panel.preset-tab-panel.active"),"#presets-panel.preset-tab-panel.active"),k=y(document.getElementById("presets-panel"),"#presets-panel"),T=y(document.querySelector("#presets-panel .preset-content-box"),"#presets-panel .preset-content-box"),W=y(document.querySelector(".preset-effects-content"),".preset-effects-content"),K=y(document.querySelector(".preset-effects-controls"),".preset-effects-controls"),q=y(document.querySelector(".preset-effects-container"),".preset-effects-container"),tt=y(document.querySelector(".preset-effects-tabs"),".preset-effects-tabs"),N={reason:x,activePresetTab:H?.dataset?.presetTab||null,activePresetPanelId:O?.id||null,elements:{effectsPanelActive:z,effectsPanel:G,effectsContentBox:ct,presetsPanelActive:D,presetsPanel:k,presetContentBox:T,presetEffectsContent:W,presetEffectsControls:K,presetEffectsContainer:q,presetEffectsTabs:tt},comparisons:{activePanelVsEffectsContent:M("effectsPanelActive",z.missing?G:z,"effectsContentBox",ct),panelVsEffectsContent:M("effectsPanel",G,"effectsContentBox",ct),contentBoxes:M("effectsContentBox",ct,"presetContentBox",T),panels:M("effectsPanel",G,"presetsPanel",k),tabsVsEffectsContent:M("presetEffectsTabs",tt,"effectsContentBox",ct)},chains:{effectsPanelActive:Q(document.querySelector("#effects-panel.preset-tab-panel.active"),"#effects-panel.preset-tab-panel.active"),effectsContentBox:Q(document.querySelector("#effects-panel .effects-content-box"),"#effects-panel .effects-content-box"),presetEffectsContent:Q(document.querySelector(".preset-effects-content"),".preset-effects-content")},lists:{presetTabButtons:I(".preset-effects-tabs .preset-tab-button")}},et=U(N);(x.startsWith("Resize")||x==="auto"||x==="init"||x==="window resize")&&et===S||(S=et,console.groupCollapsed(`[Sizing] Preset/Effects widths (${x})`),console.log(N),console.groupEnd())})}function _(x){window.enablePresetEffectsSizingDiagnostics&&V(x)}function X(){const x=o();document.querySelectorAll(".tab-button").forEach(z=>z.classList.remove("active")),document.querySelectorAll(".tab-panel").forEach(z=>z.classList.remove("active"));const H=document.querySelector(`[data-tab="${x}"]`),O=document.getElementById(`${x}-panel`);H&&O?(H.classList.add("active"),O.classList.add("active"),x==="rhythm"&&setTimeout(()=>{const z=window.initTempoSliderIfNeeded;typeof z=="function"&&z()},200)):B.warn("TabManagement",`Could not restore tab: ${x}. Tab button or panel not found.`)}function At(){const x=l();document.querySelectorAll(".preset-tab-button:not([disabled])").forEach(z=>z.classList.remove("active")),document.querySelectorAll(".preset-tab-panel").forEach(z=>z.classList.remove("active"));const H=document.querySelector(`[data-preset-tab="${x}"]`),O=document.getElementById(`${x}-panel`);if(H&&O&&!H.hasAttribute("disabled")){H.classList.add("active"),O.classList.add("active");const z=document.querySelector(".harmonic-bins-container");z&&(x==="effects"?z.style.display="none":z.style.display="flex")}else B.warn("TabManagement",`Could not restore preset tab: ${x}. Tab button or panel not found.`);_("restore preset tab")}function ht(){X(),d=document.querySelectorAll(".tab-button"),d.forEach(x=>{const H=()=>{const O=x.dataset.tab;if(!O)return;document.querySelectorAll(".tab-button").forEach(G=>G.classList.remove("active")),x.classList.add("active"),document.querySelectorAll(".tab-panel").forEach(G=>G.classList.remove("active"));const z=document.getElementById(`${O}-panel`);z&&z.classList.add("active"),i(O),O==="rhythm"&&setTimeout(()=>{const G=window.initTempoSliderIfNeeded;typeof G=="function"&&G()},50)};x.addEventListener("click",H),m.set(x,H)}),B.info("TabManagementBridge","Main tabs initialized",null,"ui")}function mt(){At(),u=document.querySelectorAll(".preset-tab-button"),u.forEach(x=>{const H=()=>{const O=x.dataset.presetTab;if(!O)return;document.querySelectorAll(".preset-tab-button:not([disabled])").forEach(ct=>ct.classList.remove("active")),x.classList.add("active"),document.querySelectorAll(".preset-tab-panel").forEach(ct=>ct.classList.remove("active"));const z=document.getElementById(`${O}-panel`);z&&z.classList.add("active"),a(O);const G=document.querySelector(".harmonic-bins-container");G&&(O==="effects"?G.style.display="none":G.style.display="flex"),_(`preset tab click: ${O}`)};x.addEventListener("click",H),f.set(x,H)}),B.info("TabManagementBridge","Preset tabs initialized",null,"ui")}function it(){h=document.querySelectorAll(".pitch-tab-button"),h.forEach(x=>{const H=()=>{const O=x.dataset.pitchTab;if(!O)return;document.querySelectorAll(".pitch-tab-button").forEach(G=>G.classList.remove("active")),x.classList.add("active"),document.querySelectorAll(".pitch-tab-panel").forEach(G=>G.classList.remove("active"));const z=document.getElementById(`${O}-panel`);z&&z.classList.add("active")};x.addEventListener("click",H),g.set(x,H)}),B.info("TabManagementBridge","Pitch tabs initialized",null,"ui")}gA(()=>{ht(),mt(),it(),window.logPresetEffectsSizing=(x="manual")=>{V(x)},window.enablePresetEffectsSizingAutoLog=()=>{window.enablePresetEffectsSizingDiagnostics=!0,$()},window.disablePresetEffectsSizingAutoLog=()=>{window.enablePresetEffectsSizingDiagnostics=!1,L()},window.enablePresetEffectsSizingDiagnostics&&$(),console.log("[Svelte] TabManagementBridge mounted")}),mA(()=>{m.forEach((x,H)=>{H.removeEventListener("click",x)}),m.clear(),f.forEach((x,H)=>{H.removeEventListener("click",x)}),f.clear(),g.forEach((x,H)=>{H.removeEventListener("click",x)}),g.clear(),console.log("[Svelte] TabManagementBridge unmounted")}),nl(),Je()}function zS(A,t){Ye(t,!0);const e=16,n={letter:{width:8.5,height:11},"11x14":{width:11,height:14},"11x17":{width:11,height:17}};let s=null,r=null,i=null,o=null,a=null,l=null,d=null,u=null,h=null,m=null,f=null,g=null,p=null,w=Rt(!1),v=Rt(null);const C=20,F=5;let E=null,b=null;function S(){c.state.isPrintPreviewActive||c.setPrintPreviewActive(!0),s?.classList.remove("hidden");const T=ot=>ot?getComputedStyle(ot).display!=="none":!1,W=c.state.printOptions.pageSize,K=W&&W in n?W:"letter",q=T(document.getElementById("button-grid")),tt=T(document.getElementById("drum-grid-wrapper")),N=T(document.getElementById("legend-left-canvas")),et=T(document.getElementById("legend-right-canvas"));c.setPrintOptions({pageSize:K,cropTop:0,cropBottom:1,cropLeft:0,cropRight:1,includeButtonGrid:q,includeDrums:tt,includeLeftLegend:N,includeRightLegend:et}),q&&Or.prefetchButtonGridSnapshot(N,et),U()}function y(){c.state.isPrintPreviewActive&&c.setPrintPreviewActive(!1),s?.classList.add("hidden")}function I(T,W){const q=c.state.printOptions[T]===W[0]?W[1]:W[0];c.setPrintOptions({[T]:q})}function Q(){if([u,h,m,f,g,p].some(ft=>ft===null))return;const W=c.state.printOptions.pageSize,K=W&&W in n?W:"letter",{orientation:q,colorMode:tt,includeButtonGrid:N,includeDrums:et,includeLeftLegend:ot,includeRightLegend:nt}=c.state.printOptions;d&&(d.value=K),u&&(u.textContent=q.charAt(0).toUpperCase()+q.slice(1)),h&&(h.textContent=tt==="color"?"Color":"B&W",h.classList.toggle("active",tt==="color")),m&&(m.textContent=N?"Include":"Exclude",m.classList.toggle("active",N)),f&&(f.textContent=et?"Include":"Exclude",f.classList.toggle("active",et)),g&&(g.textContent=ot?"Include":"Exclude",g.classList.toggle("active",ot)),p&&(p.textContent=nt?"Include":"Exclude",p.classList.toggle("active",nt))}async function U(){if(!c.state.isPrintPreviewActive||!r||!i)return;Q();const T=l?.clientWidth??0,W=l?.clientHeight??0;if(T===0||W===0)return;const{orientation:K}=c.state.printOptions,q=c.state.printOptions.pageSize,tt=q&&q in n?q:"letter",N=n[tt],et=K==="landscape"?N.height:N.width,ot=K==="landscape"?N.width:N.height,nt=.25,ft=et/ot,wt=e*2;let Ct=Math.max(T-wt,100),vt=Math.max(W-wt,100);Ct/vt>ft?Ct=vt*ft:vt=Ct/ft;const Z=nt/et*Ct,lt=Ct-2*Z,gt=vt-2*Z,zt={...c.state.printOptions,cropTop:0,cropBottom:1,cropLeft:0,cropRight:1},Tt=await Or.generateScoreCanvas(zt,{width:lt,height:gt});if(!Tt)return;r.width=Ct,r.height=vt,i.fillStyle="#FFFFFF",i.fillRect(0,0,Ct,vt),i.strokeStyle="#E0E0E0",i.lineWidth=1,i.strokeRect(Z,Z,lt,gt);const ke=Z+Math.max(0,(lt-Tt.width)/2),JA=Z+Math.max(0,(gt-Tt.height)/2);i.drawImage(Tt,ke,JA),M(Z,lt,gt),P(Ct,vt,{contentTop:JA,contentLeft:ke,contentWidth:Tt.width,contentHeight:Tt.height})}function M(T,W,K){if(!i)return;i.strokeStyle="#CCCCCC",i.lineWidth=1;const q=10,tt=T+W,N=T+K;i.beginPath(),i.moveTo(T,T-q),i.lineTo(T,T+q),i.moveTo(T-q,T),i.lineTo(T+q,T),i.moveTo(tt,T-q),i.lineTo(tt,T+q),i.moveTo(tt-q,T),i.lineTo(tt+q,T),i.moveTo(T,N-q),i.lineTo(T,N+q),i.moveTo(T-q,N),i.lineTo(T+q,N),i.moveTo(tt,N-q),i.lineTo(tt,N+q),i.moveTo(tt-q,N),i.lineTo(tt+q,N),i.stroke()}function P(T,W,K){const q=r?.getBoundingClientRect(),tt=l?.getBoundingClientRect();if(!q||!tt||!o||!a)return;o.width=T,o.height=W,o.style.left=`${q.left-tt.left}px`,o.style.top=`${q.top-tt.top}px`,o.style.width=`${T}px`,o.style.height=`${W}px`;const{cropTop:N,cropBottom:et,cropLeft:ot,cropRight:nt}=c.state.printOptions,{contentTop:ft,contentLeft:wt,contentHeight:Ct,contentWidth:vt}=K,Z=ft+N*Ct,lt=ft+et*Ct,gt=wt+ot*vt,zt=wt+nt*vt,Tt=ft+Ct,ke=wt+vt;a.clearRect(0,0,T,W),a.fillStyle="rgba(0, 0, 0, 0.5)",N>0&&a.fillRect(wt,ft,vt,Z-ft),et<1&&a.fillRect(wt,lt,vt,Tt-lt),ot>0&&a.fillRect(wt,Z,gt-wt,lt-Z),nt<1&&a.fillRect(zt,Z,ke-zt,lt-Z),R(Z,wt,ke,"top"),R(lt,wt,ke,"bottom"),$(gt,ft,Tt,"left"),$(zt,ft,Tt,"right"),E={pageWidth:T,pageHeight:W,contentTop:ft,contentLeft:wt,contentHeight:Ct,contentWidth:vt,cropTopY:Z,cropBottomY:lt,cropLeftX:gt,cropRightX:zt}}function R(T,W,K,q){if(!a)return;const tt=60,N=K-W,et=W+(N-tt)/2,ot=q==="top"?T-C-4:T+4;a.fillStyle="#4a90e2",a.fillRect(W,T-1,N,2),a.fillRect(et,ot,tt,C),a.strokeStyle="#FFFFFF",a.lineWidth=2,a.strokeRect(et,ot,tt,C),a.strokeStyle="#FFFFFF",a.lineWidth=1;const nt=3,ft=6,wt=30,Ct=W+(N-wt)/2;for(let vt=0;vt<nt;vt++){const Z=ot+C/2+(vt-1)*ft;a.beginPath(),a.moveTo(Ct,Z),a.lineTo(Ct+wt,Z),a.stroke()}}function $(T,W,K,q){if(!a)return;const tt=60,N=K-W,et=W+(N-tt)/2,ot=q==="left"?T-C-4:T+4;a.fillStyle="#4a90e2",a.fillRect(T-1,W,2,N),a.fillRect(ot,et,C,tt),a.strokeStyle="#FFFFFF",a.lineWidth=2,a.strokeRect(ot,et,C,tt),a.strokeStyle="#FFFFFF",a.lineWidth=1;const nt=3,ft=6,wt=30,Ct=W+(N-wt)/2;for(let vt=0;vt<nt;vt++){const Z=ot+C/2+(vt-1)*ft;a.beginPath(),a.moveTo(Z,Ct),a.lineTo(Z,Ct+wt),a.stroke()}}function L(T){if(!E||!o)return;const W=o.getBoundingClientRect(),K=T.clientX-W.left,q=T.clientY-W.top,tt=K>=E.contentLeft&&K<=E.contentLeft+E.contentWidth,N=q>=E.contentTop&&q<=E.contentTop+E.contentHeight,et=tt&&Math.abs(q-E.cropTopY)<C+F,ot=tt&&Math.abs(q-E.cropBottomY)<C+F,nt=N&&Math.abs(K-E.cropLeftX)<C+F,ft=N&&Math.abs(K-E.cropRightX)<C+F;et?(Bt(w,!0),Bt(v,"top"),o.style.cursor="ns-resize"):ot?(Bt(w,!0),Bt(v,"bottom"),o.style.cursor="ns-resize"):nt?(Bt(w,!0),Bt(v,"left"),o.style.cursor="ew-resize"):ft&&(Bt(w,!0),Bt(v,"right"),o.style.cursor="ew-resize")}function V(T){if(!E||!o)return;const W=o.getBoundingClientRect(),K=T.clientX-W.left,q=T.clientY-W.top;if(rt(w)&&rt(v)){_(K,q);return}const tt=K>=E.contentLeft&&K<=E.contentLeft+E.contentWidth,N=q>=E.contentTop&&q<=E.contentTop+E.contentHeight,et=tt&&Math.abs(q-E.cropTopY)<C+F,ot=tt&&Math.abs(q-E.cropBottomY)<C+F,nt=N&&Math.abs(K-E.cropLeftX)<C+F,ft=N&&Math.abs(K-E.cropRightX)<C+F;et||ot?o.style.cursor="ns-resize":nt||ft?o.style.cursor="ew-resize":o.style.cursor="default"}function _(T,W){if(!E)return;const{contentTop:K,contentLeft:q,contentHeight:tt,contentWidth:N}=E,et=.05;if(rt(v)==="top"){const ot=Math.max(0,Math.min(1,(W-K)/tt)),nt=c.state.printOptions.cropBottom;ot<nt-et&&c.setPrintOptions({cropTop:ot})}else if(rt(v)==="bottom"){const ot=Math.max(0,Math.min(1,(W-K)/tt)),nt=c.state.printOptions.cropTop;ot>nt+et&&c.setPrintOptions({cropBottom:ot})}else if(rt(v)==="left"){const ot=Math.max(0,Math.min(1,(T-q)/N)),nt=c.state.printOptions.cropRight;ot<nt-et&&c.setPrintOptions({cropLeft:ot})}else if(rt(v)==="right"){const ot=Math.max(0,Math.min(1,(T-q)/N)),nt=c.state.printOptions.cropLeft;ot>nt+et&&c.setPrintOptions({cropRight:ot})}}function X(){Bt(w,!1),Bt(v,null),o&&(o.style.cursor="default")}function At(){y()}function ht(){Or.generateAndPrint(),y()}function mt(){I("orientation",["landscape","portrait"])}function it(){I("colorMode",["color","bw"])}function x(){I("includeButtonGrid",[!0,!1])}function H(){I("includeDrums",[!0,!1])}function O(){I("includeLeftLegend",[!0,!1])}function z(){I("includeRightLegend",[!0,!1])}function G(){if(!d)return;const T=d.value;T in n&&c.setPrintOptions({pageSize:T})}function ct(T){T?S():y()}function D(){U()}function k(){c.state.isPrintPreviewActive&&U()}gA(()=>{s=document.getElementById("print-preview-overlay"),r=document.getElementById("print-preview-canvas"),i=r?.getContext("2d")??null,o=document.getElementById("print-crop-overlay"),a=o?.getContext("2d")??null,l=r?.parentElement??null,d=document.getElementById("print-page-size"),u=document.getElementById("print-orientation-toggle"),h=document.getElementById("print-color-mode-toggle"),m=document.getElementById("print-button-grid-toggle"),f=document.getElementById("print-drum-grid-toggle"),g=document.getElementById("print-left-legend-toggle"),p=document.getElementById("print-right-legend-toggle"),document.getElementById("print-close-button")?.addEventListener("click",At),document.getElementById("print-confirm-button")?.addEventListener("click",ht),u?.addEventListener("click",mt),h?.addEventListener("click",it),m?.addEventListener("click",x),f?.addEventListener("click",H),g?.addEventListener("click",O),p?.addEventListener("click",z),d?.addEventListener("change",G),o?.addEventListener("mousedown",L),o?.addEventListener("mousemove",V),o?.addEventListener("mouseup",X),o?.addEventListener("mouseleave",X),c.on("printPreviewStateChanged",ct),c.on("printOptionsChanged",D),c.on("notesChanged",k),l&&(b=new ResizeObserver(()=>{c.state.isPrintPreviewActive&&U()}),b.observe(l)),console.log("[Svelte] PrintPreviewBridge mounted")}),mA(()=>{document.getElementById("print-close-button")?.removeEventListener("click",At),document.getElementById("print-confirm-button")?.removeEventListener("click",ht),u?.removeEventListener("click",mt),h?.removeEventListener("click",it),m?.removeEventListener("click",x),f?.removeEventListener("click",H),g?.removeEventListener("click",O),p?.removeEventListener("click",z),d?.removeEventListener("change",G),o?.removeEventListener("mousedown",L),o?.removeEventListener("mousemove",V),o?.removeEventListener("mouseup",X),o?.removeEventListener("mouseleave",X),b?.disconnect(),console.log("[Svelte] PrintPreviewBridge unmounted")}),Je()}const qS={"playback-controls":aS,"playback-controls-bridge":lS,"file-actions-bridge":cS,"grid-controls-bridge":dS,"modulation-bridge":uS,"sidebar-bridge":ES,"tool-selector-bridge":TS,"audio-controls-bridge":WS,"tab-management-bridge":VS,"print-preview-bridge":zS},Ka=[];function XS(){document.querySelectorAll("[data-svelte-component]").forEach(t=>{const e=t.getAttribute("data-svelte-component");if(!e)return;const n=qS[e];if(!n){console.warn(`[Svelte] Unknown component: ${e}`);return}try{t.innerHTML="";const s=Gg(n,{target:t});Ka.push({target:t,component:s}),console.log(`[Svelte] Mounted: ${e}`)}catch(s){console.error(`[Svelte] Failed to mount ${e}:`,s)}})}function $S(){Ka.forEach(({component:A})=>{try{Kg(A)}catch(t){console.error("[Svelte] Failed to unmount component:",t)}}),Ka.length=0}function YS(){sS.init(),XS(),B.initSuccess("UiComponents")}function Gi(A,t){if(!(typeof window>"u"||!window.__adsrFlowDebug)){if(t===void 0){console.log("[ADSR Flow]",A);return}console.log("[ADSR Flow]",A,t)}}const Pe={container:null,parentContainer:null,sustainTrack:null,sustainThumb:null,multiSliderContainer:null,thumbA:null,thumbD:null,thumbR:null};function JS(){return Pe.container=document.querySelector("#adsr-envelope"),Pe.parentContainer=Pe.container?.closest(".adsr-container")||null,Pe.sustainTrack=document.getElementById("sustain-slider-track"),Pe.sustainThumb=document.getElementById("sustain-slider-thumb"),Pe.multiSliderContainer=document.getElementById("multi-thumb-slider-container"),Pe.thumbA=document.getElementById("thumb-a"),Pe.thumbD=document.getElementById("thumb-d"),Pe.thumbR=document.getElementById("thumb-r"),Pe}const jS={init:JS,get elements(){return Pe}};function Df(){return Rf*c.state.adsrTimeAxisScale}function Nf(A,t){const e=c.state.timbres[t.currentColor];if(!e)return;const{sustain:n}=e.adsr,s=.01;A.d=Math.max(A.a+s,A.d),A.r=Math.max(A.d+s,A.r);const r=A.a,i=A.d-A.a,o=A.r-A.d;if(isNaN(r)||isNaN(i)||isNaN(o)){B.error("AdsrInteractions","NaN value detected before setting ADSR. Aborting update.",{newAttack:r,newDecay:i,newRelease:o},"audio");return}const a={attack:r,decay:i,release:o,sustain:n};c.setADSR(t.currentColor,a),Gi("adsrInteractions:updateADSRFromAbsoluteTimes",{color:t.currentColor,adsr:a})}function ZS(A,t){let e=!1;const n=i=>{if(!e||!A.sustainTrack)return;const o=A.sustainTrack.getBoundingClientRect();let l=100-(i.clientY-o.top)/o.height*100;l=Math.max(0,Math.min(100,l));const u=(window.waveformVisualizer?.getNormalizedAmplitude()||1)*100;l=Math.min(l,u);const h=c.state.timbres[t.currentColor];if(!h)return;const m={...h.adsr,sustain:l/100};c.setADSR(t.currentColor,m),Gi("adsrInteractions:sustainSlider",{color:t.currentColor,adsr:m})},s=i=>{e=!0,n(i)},r=()=>{e=!1};A.sustainTrack?.addEventListener("pointerdown",s),document.addEventListener("pointermove",n),document.addEventListener("pointerup",r)}function tE(A,t){let e=null;const n=i=>{if(!e||!A.multiSliderContainer)return;const o=A.multiSliderContainer.getBoundingClientRect();let l=(i.clientX-o.left)/o.width*100;l=Math.max(0,Math.min(100,l));const d=l/100*Df(),u=c.state.timbres[t.currentColor];if(!u)return;const{attack:h,decay:m,release:f}=u.adsr,g={a:h,d:h+m,r:h+m+f};e.id==="thumb-a"&&(g.a=d),e.id==="thumb-d"&&(g.d=d),e.id==="thumb-r"&&(g.r=d),Nf(g,t)},s=i=>{const o=i.target;o.classList.contains("time-slider-thumb")&&(e=o,n(i))},r=()=>{e=null};A.multiSliderContainer?.addEventListener("pointerdown",s),document.addEventListener("pointermove",n),document.addEventListener("pointerup",r)}function eE(A,t){let e=null;const n=i=>{if(!e)return;const o=t.svgContainer,a=o.createSVGPoint();a.x=i.clientX,a.y=i.clientY;const l=o.getScreenCTM();if(!l)return;const d=a.matrixTransform(l.inverse());let u=d.x/t.width*100,h=1-d.y/t.height;u=Math.max(0,Math.min(100,u)),h=Math.max(0,Math.min(1,h));const m=u/100*Df(),f=c.state.timbres[t.currentColor];if(!f)return;const{attack:g,decay:p,release:w}=f.adsr;let v=f.adsr.sustain;const C={a:g,d:g+p,r:g+p+w};switch(e.id){case"attack-node":C.a=m;break;case"decay-sustain-node":{C.d=m;const b=window.waveformVisualizer?.getNormalizedAmplitude()||1;v=Math.min(h,b);break}case"release-node":C.r=m;break}const F=c.state.timbres[t.currentColor];if(!F)return;const E=F.adsr.sustain;if(v!==E){const b={attack:g,decay:p,release:w,sustain:v};c.setADSR(t.currentColor,b),Gi("adsrInteractions:nodeDragSustain",{color:t.currentColor,adsr:b})}Nf(C,t)},s=i=>{const o=i.target;o.classList.contains("adsr-node")&&(e=o,e.style.cursor="grabbing",n(i))},r=()=>{e&&(e.style.cursor="grab",e=null)};t.nodeLayer.addEventListener("pointerdown",s),document.addEventListener("pointermove",n),document.addEventListener("pointerup",r)}function AE(A){const t=A.ui;ZS(t,A),tE(t,A),eE(t,A)}function nE(A,{width:t,height:e},n){for(;A.firstChild;)A.removeChild(A.firstChild);if(n>0){for(let o=1;o<=5;o++)if(o<=n){const a=o/n*t,l=document.createElementNS("http://www.w3.org/2000/svg","text");l.setAttribute("x",String(a)),l.setAttribute("y",String(e-5)),l.setAttribute("fill","#d0d0d0"),l.setAttribute("font-size","24"),l.setAttribute("font-weight","bold"),l.setAttribute("text-anchor","middle"),l.setAttribute("dominant-baseline","auto"),l.setAttribute("opacity","0.3"),l.textContent=`${o}s`,A.appendChild(l)}}const s=c.state.tempo;if(s<=0||n<=0)return;const r=30/s;let i=0;for(let o=r;o<n;o+=r){const a=o/n*t,l=document.createElementNS("http://www.w3.org/2000/svg","line");l.setAttribute("x1",String(a)),l.setAttribute("y1","0"),l.setAttribute("x2",String(a)),l.setAttribute("y2",String(e));const d=(i+1)%2===0;l.setAttribute("stroke",d?"#adb5bd":"#ced4da"),l.setAttribute("stroke-width",d?"1":"0.5"),l.setAttribute("stroke-dasharray","3,3"),A.appendChild(l),i++}}function sE(A,t,e,{height:n,width:s},r,i,o){for(;A.firstChild;)A.removeChild(A.firstChild);for(;t.firstChild;)t.removeChild(t.firstChild);if(e.length<4)return;const a=e[0],l=e[1],d=e[2],u=e[3];if(!a||!l||!d||!u)return;const h=c.state.colorPalette[r]||{primary:r,light:r},m=h.primary,f=h.light;let g={time:0,feedback:0};if(window.effectsCoordinator&&(g=window.effectsCoordinator.getEffectParameters(r,"delay")),o&&o.clearRect(0,0,s,n),(g.time||0)>0&&(g.feedback||0)>0&&i){const y=Math.max(.01,(g.time||0)/100*.5),I=Math.min(.95,(g.feedback||0)/100),Q=.05;let U=I,M=0;for(;U>Q&&M<10;){M++;const P=y*M/i*s,R=e.map(V=>({x:V.x+P,y:V.y})),$=R[0],L=R[3];if(!(!$||!L)){if($.x<s){const V=document.createElementNS("http://www.w3.org/2000/svg","polygon"),_=`${$.x},${n} `+R.map(At=>`${At.x},${At.y}`).join(" ")+` ${Math.min(L.x,s)},${n}`;V.setAttribute("points",_),V.setAttribute("fill",Ve(f,.7*U)),V.setAttribute("class","delay-echo"),A.appendChild(V);const X=document.createElementNS("http://www.w3.org/2000/svg","polyline");X.setAttribute("points",R.map(At=>`${At.x},${At.y}`).join(" ")),X.setAttribute("stroke-width","2"),X.setAttribute("fill","none"),X.setAttribute("stroke",Ve(m,U)),X.setAttribute("class","delay-echo"),A.appendChild(X)}U*=I}}}const p=document.createElementNS("http://www.w3.org/2000/svg","polygon"),w=`0,${n} `+e.map(y=>`${y.x},${y.y}`).join(" ")+` ${s},${n}`;p.setAttribute("points",w),p.setAttribute("fill",Ve(f,.7)),A.appendChild(p);const v=document.createElementNS("http://www.w3.org/2000/svg","line");v.setAttribute("x1",String(a.x)),v.setAttribute("y1",String(a.y)),v.setAttribute("x2",String(l.x)),v.setAttribute("y2",String(l.y)),v.setAttribute("stroke",m),v.setAttribute("stroke-width","2"),A.appendChild(v);const C=document.createElementNS("http://www.w3.org/2000/svg","line");C.setAttribute("x1",String(l.x)),C.setAttribute("y1",String(l.y)),C.setAttribute("x2",String(d.x)),C.setAttribute("y2",String(d.y)),C.setAttribute("stroke",m),C.setAttribute("stroke-width","2"),A.appendChild(C);const F=1,E=document.createElementNS("http://www.w3.org/2000/svg","line");E.setAttribute("x1",String(d.x)),E.setAttribute("y1",String(d.y)),E.setAttribute("x2",String(u.x)),E.setAttribute("y2",String(u.y)),E.setAttribute("stroke",Ve(m,F)),E.setAttribute("stroke-width","2"),A.appendChild(E);const b=["attack-node","decay-sustain-node","release-node"];[l,d,u].forEach((y,I)=>{const Q=document.createElementNS("http://www.w3.org/2000/svg","circle");Q.setAttribute("id",b[I]),Q.setAttribute("class","adsr-node"),Q.setAttribute("cx",String(y.x)),Q.setAttribute("cy",String(y.y)),Q.setAttribute("r","8"),Q.setAttribute("fill",m),Q.setAttribute("stroke",Oi(m,-.3)),Q.setAttribute("stroke-width","2"),Q.style.cursor="grab";const U=document.createElementNS("http://www.w3.org/2000/svg","title");Q.appendChild(U),t.appendChild(Q)})}function rE(A,t){if(!A)return;const e=Oi(t,-.2);A.style.setProperty("--c-accent",t),A.style.setProperty("--c-accent-hover",e)}const Ht={};let Ie=null,YA=!1;function iE(A,t){const e=document.createElementNS("http://www.w3.org/2000/svg","g");e.setAttribute("data-playhead-id",A);const n=document.createElementNS("http://www.w3.org/2000/svg","line");n.setAttribute("stroke",t),n.setAttribute("stroke-width","2"),n.setAttribute("stroke-dasharray","3,3"),e.appendChild(n);const s=document.createElementNS("http://www.w3.org/2000/svg","circle");return s.setAttribute("r","5"),s.setAttribute("fill",t),e.appendChild(s),e}function oE(A,t,e,n=null){if(!(!Ie||!n)){if(t==="attack"){Ht[A]&&(Ht[A].requestId!==null&&cancelAnimationFrame(Ht[A].requestId),Ht[A].group.remove());const s=iE(A,e);Ie.playheadLayer.appendChild(s),Ht[A]={group:s,phase:t,color:e,adsr:n,requestId:null,startTimestamp:Dt(),elapsed:0},Rl(A)}else if(t==="release"){if(YA)return;const s=Ht[A];if(!s)return;s.requestId!==null&&cancelAnimationFrame(s.requestId),s.phase="release",s.adsr=n,s.startTimestamp=Dt(),s.elapsed=0,_l(A)}}}function Rl(A){if(!Ht[A]||YA||!Ie)return;const t=Ht[A];if(!t.adsr)return;const{attack:e,decay:n}=t.adsr,s=Ie.calculateEnvelopePoints(t.adsr);if(s.length<4)return;const r=s[0],i=s[1],o=s[2],a=Dt()-t.startTimestamp;t.elapsed=a;const l=e+n,d=Math.min(a,l);let u,h;if(d<=e){const g=e>0?d/e:1;u=r.x+g*(i.x-r.x),h=r.y+g*(i.y-r.y)}else{const g=d-e,p=n>0?g/n:1;u=i.x+p*(o.x-i.x),h=i.y+p*(o.y-i.y)}const[m,f]=t.group.children;m.setAttribute("x1",String(u)),m.setAttribute("y1","0"),m.setAttribute("x2",String(u)),m.setAttribute("y2",String(Ie.height)),f.setAttribute("cx",String(u)),f.setAttribute("cy",String(h)),d<l?t.requestId=requestAnimationFrame(()=>Rl(A)):(t.phase="sustain",kl(A))}function kl(A){if(!Ht[A]||YA||!Ie)return;const t=Ht[A];if(!t.adsr)return;const e=Ie.calculateEnvelopePoints(t.adsr);if(e.length<4)return;const n=e[2],[s,r]=t.group.children;s.setAttribute("x1",String(n.x)),s.setAttribute("y1","0"),s.setAttribute("x2",String(n.x)),s.setAttribute("y2",String(Ie.height)),r.setAttribute("cx",String(n.x)),r.setAttribute("cy",String(n.y)),t.requestId=requestAnimationFrame(()=>kl(A))}function _l(A){if(!Ht[A]||YA||!Ie)return;const t=Ht[A];if(!t.adsr)return;const{release:e}=t.adsr,n=Ie.calculateEnvelopePoints(t.adsr);if(n.length<4)return;const s=n[2],r=n[3],i=Dt()-t.startTimestamp;t.elapsed=i;const o=Math.min(i,e),a=e>0?o/e:1,l=s.x+a*(r.x-s.x),d=s.y+a*(r.y-s.y),[u,h]=t.group.children;u.setAttribute("x1",String(l)),u.setAttribute("y1","0"),u.setAttribute("x2",String(l)),u.setAttribute("y2",String(Ie.height)),h.setAttribute("cx",String(l)),h.setAttribute("cy",String(d)),o<e?t.requestId=requestAnimationFrame(()=>_l(A)):(t.group.remove(),delete Ht[A])}function aE(){YA=!0;for(const A in Ht){const t=Ht[A];t&&t.requestId!==null&&(cancelAnimationFrame(t.requestId),t.requestId=null)}}function lE(){YA=!1;for(const A in Ht){const t=Ht[A];t&&(t.startTimestamp=Dt()-t.elapsed,t.phase==="attack"?Rl(A):t.phase==="sustain"?kl(A):t.phase==="release"&&_l(A))}}function cE(){YA=!1;for(const A in Ht){const t=Ht[A];t&&(t.requestId!==null&&cancelAnimationFrame(t.requestId),t.group.remove())}for(const A in Ht)delete Ht[A]}function dE(A){return Ie=A,{trigger:oE,pause:aE,resume:lE,clearAll:cE}}const Fe={adsrComponent:null},Rf=2.5;class uE{ui;currentColor;attack;decay;sustain;release;width;height;reverbCanvas=null;reverbCtx=null;svgContainer;gridLayer;envelopeLayer;nodeLayer;playheadLayer;playheadManager;constructor(){if(this.ui=jS.init(),!this.ui.container)throw B.error("AdsrComponent","ADSR container element not found",null,"adsr"),new Error("ADSR container element not found");this.currentColor=c.state.selectedNote?.color||"#4a90e2",this.attack=0,this.decay=0,this.sustain=0,this.release=0,this.width=0,this.height=0,this.createSVGLayers(),this.resize(),this.playheadManager=dE(this),Fe.adsrComponent=this,AE(this),this.listenForStoreChanges(),this.initControls();const t=this.ui.container;t&&new ResizeObserver(()=>this.resize()).observe(t),this.updateFromStore(),B.info("ADSR Component","Initialized",null,"adsr")}resize(){if(this.ui.container){if(this.width=this.ui.container.clientWidth,this.height=this.ui.container.clientHeight,this.reverbCanvas){const t=window.devicePixelRatio||1;this.reverbCanvas.width=this.width*t,this.reverbCanvas.height=this.height*t,this.reverbCtx&&(this.reverbCtx.setTransform(1,0,0,1,0,0),this.reverbCtx.scale(t,t))}this.svgContainer&&this.svgContainer.setAttribute("viewBox",`0 0 ${this.width} ${this.height}`),this.render()}}updateFromStore(){const t=c.state.timbres[this.currentColor];if(!t)return;const{attack:e,decay:n,sustain:s,release:r}=t.adsr;this.attack=e,this.decay=n,this.sustain=s,this.release=r,this.render(),this.updateControls()}getCurrentMaxTime(){return Rf*c.state.adsrTimeAxisScale}initControls(){const t=document.getElementById("adsr-time-scale"),e=document.getElementById("adsr-time-scale-value");t&&e&&(t.value=String(c.state.adsrTimeAxisScale),e.textContent=`${c.state.adsrTimeAxisScale}x`,t.addEventListener("input",n=>{const s=n.currentTarget;if(!s)return;const r=parseFloat(s.value);Number.isFinite(r)&&(c.setAdsrTimeAxisScale(r),e.textContent=`${r}x`)}))}listenForStoreChanges(){c.on("noteChanged",t=>{const e=t?.newNote?.color;e&&e!==this.currentColor&&(this.currentColor=e,this.updateFromStore())}),c.on("timbreChanged",t=>{t===this.currentColor&&this.updateFromStore()}),c.on("tempoChanged",()=>this.render()),c.on("adsrTimeAxisScaleChanged",()=>{this.render(),this.updateControls()}),c.on("tremoloAmplitudeUpdate",t=>{t?.activeColors?.includes(this.currentColor)&&this.render()}),c.on("playbackStateChanged",t=>{if(!t)return;const{isPlaying:e,isPaused:n}=t;e?n?this.playheadManager.pause():this.playheadManager.resume():this.playheadManager.clearAll()}),c.on("audioEffectChanged",t=>{if(!t)return;const{effectType:e,color:n}=t;n===this.currentColor&&(e==="delay"||e==="reverb")&&this.render()})}createSVGLayers(){this.ui.container&&(this.reverbCanvas=document.createElement("canvas"),this.reverbCanvas.className="adsr-reverb-canvas",this.reverbCanvas.style.position="absolute",this.reverbCanvas.style.top="0",this.reverbCanvas.style.left="0",this.reverbCanvas.style.width="100%",this.reverbCanvas.style.height="100%",this.reverbCanvas.style.pointerEvents="none",this.ui.container.appendChild(this.reverbCanvas),this.reverbCtx=this.reverbCanvas.getContext("2d"),this.svgContainer=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svgContainer.setAttribute("width","100%"),this.svgContainer.setAttribute("height","100%"),this.ui.container.appendChild(this.svgContainer),this.gridLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.gridLayer),this.envelopeLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.envelopeLayer),this.nodeLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.nodeLayer),this.playheadLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.playheadLayer))}calculateEnvelopePoints(t){const{attack:e,decay:n,sustain:s,release:r}=t??{attack:this.attack,decay:this.decay,sustain:this.sustain,release:this.release};if(!this.width||!this.height)return[];const i=g=>g/this.getCurrentMaxTime()*this.width;let o=1;const a=window.animationEffectsManager;a?.shouldTremoloBeRunning?.()&&(o=a.getADSRTremoloAmplitudeMultiplier(this.currentColor));const l=window.waveformVisualizer?.calculatedAmplitude??1,d=l*o;B.debug("AdsrComponent","[ADSR] Amplitude calculation",{originalAmplitude:l,tremoloMultiplier:o,normalizedAmplitude:d});const u={x:0,y:this.height},h={x:i(e),y:this.height*(1-d)},m={x:i(e+n),y:this.height*(1-Math.min(s*d,d))},f={x:i(e+n+r),y:this.height};return[u,h,m,f]}render(){if(!this.width||!this.height||!this.gridLayer||!this.envelopeLayer||!this.nodeLayer)return;const t={width:this.width,height:this.height},e=this.calculateEnvelopePoints(),n=this.getCurrentMaxTime();nE(this.gridLayer,t,n),sE(this.envelopeLayer,this.nodeLayer,e,t,this.currentColor,n,this.reverbCtx),rE(this.ui.parentContainer,this.currentColor)}updateControls(){const{sustainThumb:t,sustainTrack:e,thumbA:n,thumbD:s,thumbR:r,multiSliderContainer:i}=this.ui;if(!t||!e||!n||!s||!r||!i)return;const o=c.state.timbres[this.currentColor];if(!o)return;let a=1;const l=window.animationEffectsManager;l?.shouldTremoloBeRunning?.()&&(a=l.getADSRTremoloAmplitudeMultiplier(this.currentColor));const u=(window.waveformVisualizer?.calculatedAmplitude||1)*a,h=u*100;if(this.sustain>u){const y={...o.adsr,sustain:u};c.setADSR(this.currentColor,y),Gi("adsrComponent:clampSustain",{color:this.currentColor,adsr:y,normalizedAmplitude:u}),this.sustain=u}const m=this.sustain*100;t.style.bottom=`${m}%`,e.style.setProperty("--sustain-progress",`${m}%`);const f=100-h;e.style.setProperty("--ineligible-height",`${f}%`);const g=this.getCurrentMaxTime(),p=this.attack/g*100,w=(this.attack+this.decay)/g*100,v=(this.attack+this.decay+this.release)/g*100;n.style.left=`${p}%`,s.style.left=`${w}%`,r.style.left=`${v}%`,i.style.setProperty("--adr-progress",`${v}%`);const C=y=>`${y.toFixed(3)}s`,F=y=>`${(y*100).toFixed(0)}%`;n.title=`Attack: ${C(this.attack)}`,s.title=`Decay: ${C(this.decay)}`,r.title=`Release: ${C(this.release)}`,t.title=`Sustain: ${F(this.sustain)}`;const E=this.nodeLayer.querySelector("#attack-node > title");E&&(E.textContent=`Attack: ${C(this.attack)}`);const b=this.nodeLayer.querySelector("#decay-sustain-node > title");b&&(b.textContent=`Decay: ${C(this.decay)}
Sustain: ${F(this.sustain)}`);const S=this.nodeLayer.querySelector("#release-node > title");S&&(S.textContent=`Release: ${C(this.release)}`)}}function hE(){return document.getElementById("adsr-envelope")?new uE:null}function Ga(A,...t){}let hn,ks,FA,_s,ws,vs,Un,Wa=!1,Va=!1,za=!1,fe;const mi=1,kf=31,_f=0,pi=2;function fE(){if(!fe)return null;const A=c.state.timbres[fe];return A?(A.filter?A.filter.enabled===void 0&&(A.filter.enabled=!0):A.filter={enabled:!0,blend:1,cutoff:16,resonance:0,type:"lowpass",mix:0},A.filter):null}function ko(){const A=fE();if(!A)return;const{cutoff:t=16,blend:e=0,mix:n=0}=A;if(hn&&ks){const s=(pi-e)/(pi-_f);hn.style.left=`${s*100}%`,ks.style.setProperty("--progress",`${s*100}%`)}if(vs&&Un){const s=(n||0)/100;vs.style.bottom=`${s*100}%`,Un.style.setProperty("--blend-progress",`${s*100}%`)}if(FA&&_s){const s=(t-mi)/(kf-mi);FA.style.left=`${s*100}%`,FA.style.top="50%",FA.style.transform="translate(-50%, -50%)",_s.style.setProperty("--progress",`${s*100}%`)}ws&&fe&&ws.style.setProperty("--c-accent",fe)}function gE(A){if(!Wa||!fe||!_s)return;const t=_s.getBoundingClientRect(),e=A.clientX-t.left,n=t.width;let s=e/n;s=Math.max(0,Math.min(1,s));const r=s*(kf-mi)+mi;c.setFilterSettings(fe,{cutoff:r})}function mE(A){if(!Va||!fe||!ks)return;const t=ks.getBoundingClientRect(),e=A.clientX-t.left,n=t.width;let s=e/n;s=Math.max(0,Math.min(1,s));const r=pi-s*(pi-_f);c.setFilterSettings(fe,{blend:r})}function pE(A){if(!za||!fe||!Un)return;const t=Un.getBoundingClientRect(),e=A.clientY-t.top,n=t.height;let s=1-e/n;s=Math.max(0,Math.min(1,s));const r=s*100;c.setFilterSettings(fe,{mix:r})}function BE(){if(ws=document.querySelector(".filter-container"),hn=document.getElementById("thumb-b"),ks=document.getElementById("blend-slider-container"),FA=document.getElementById("thumb-c"),_s=document.getElementById("cutoff-slider-container"),!ws||!hn||!FA){B.error("FilterControls","Missing required elements",{container:ws,blendThumb:hn,cutoffThumb:FA},"filter");return}wE(),hn.addEventListener("pointerdown",A=>{A.preventDefault(),Va=!0,document.body.style.cursor="ew-resize";const t=n=>{Ga("log","[BLEND SLIDER] Moving",{clientX:n.clientX}),mE(n)},e=()=>{Va=!1,document.body.style.cursor="default",window.removeEventListener("pointermove",t),window.removeEventListener("pointerup",e),c.recordState()};window.addEventListener("pointermove",t),window.addEventListener("pointerup",e)}),FA.addEventListener("pointerdown",A=>{A.preventDefault(),Wa=!0,document.body.style.cursor="ew-resize";const t=n=>{Ga("log","[CUTOFF SLIDER] Moving",{clientX:n.clientX}),gE(n)},e=()=>{Wa=!1,document.body.style.cursor="default",window.removeEventListener("pointermove",t),window.removeEventListener("pointerup",e),c.recordState()};window.addEventListener("pointermove",t),window.addEventListener("pointerup",e)}),c.on("noteChanged",({newNote:A}={})=>{A?.color&&A.color!==fe&&(fe=A.color,ko())}),c.on("timbreChanged",A=>{A&&A===fe&&ko()}),fe=c.state.selectedNote?.color||"#4a90e2",ko()}function wE(){if(Un=document.getElementById("vertical-blend-track"),vs=document.getElementById("vertical-blend-thumb"),!Un||!vs){B.error("FilterControls","Vertical blend slider elements not found",null,"filter");return}vs.addEventListener("pointerdown",A=>{A.preventDefault(),za=!0,document.body.style.cursor="ns-resize";const t=n=>{Ga("log","[VERTICAL BLEND] Moving",{clientY:n.clientY}),pE(n)},e=()=>{za=!1,document.body.style.cursor="default",window.removeEventListener("pointermove",t),window.removeEventListener("pointerup",e),c.recordState()};window.addEventListener("pointermove",t),window.addEventListener("pointerup",e)})}const _o=()=>window.synthEngine??null,nu=()=>window.animationEffectsManager??null;B.moduleLoaded("DynamicWaveformVisualizer");class vE{canvas=null;ctx=null;currentColor=null;isPlaybackActive=!1;liveAnalysers=new Map;liveWaveforms=new Map;playbackAnimationId=null;animationSpeed=100;frameSkipCounter=0;onWaveformUpdate;initialize(t,e){return this.canvas=t,this.ctx=e,this.currentColor=c.state.selectedNote?.color||"#4a90e2",this.setupEventListeners(),B.info("DynamicWaveformVisualizer","Initialized with canvas context",null,"waveform"),!0}setupEventListeners(){c.on("noteChanged",({newNote:t}={})=>{t?.color&&t.color!==this.currentColor&&(this.currentColor=t.color)}),c.on("playbackStateChanged",({isPlaying:t=!1,isPaused:e=!1}={})=>{t&&!e?this.startLiveVisualization():this.stopLiveVisualization()}),c.on("spacebarPlayback",({color:t,isPlaying:e=!1}={})=>{e&&t?this.startSingleNoteVisualization(t):this.stopLiveVisualization()}),c.on("tremoloAmplitudeUpdate",({activeColors:t}={})=>{this.isPlaybackActive&&t?.some(e=>this.liveWaveforms.has(e))&&B.debug("DynamicWaveformVisualizer","Tremolo update received for active colors",t,"waveform")}),B.info("DynamicWaveformVisualizer","Event subscriptions established",null,"waveform")}setAnimationSpeed(t){this.animationSpeed=t,this.frameSkipCounter=0}startLiveVisualization(){this.isPlaybackActive||(this.isPlaybackActive=!0,this.setupLiveAnalysers(),this.updateContainerState(!0),this.animateLiveWaveforms(),B.debug("DynamicWaveformVisualizer","Started live visualization",null,"waveform"))}startSingleNoteVisualization(t){this.isPlaybackActive||(this.isPlaybackActive=!0,this.setupSingleAnalyser(t),this.updateContainerState(!0),this.animateLiveWaveforms(),B.debug("DynamicWaveformVisualizer",`Started single note visualization for ${t}`,null,"waveform"))}stopLiveVisualization(){this.isPlaybackActive=!1;const t=_o();this.liveAnalysers.forEach((e,n)=>{t?.removeWaveformAnalyzer?.(n)}),this.liveAnalysers.clear(),this.liveWaveforms.clear(),this.playbackAnimationId&&(cancelAnimationFrame(this.playbackAnimationId),this.playbackAnimationId=null),this.updateContainerState(!1),B.debug("DynamicWaveformVisualizer","Stopped live visualization",null,"waveform")}updateContainerState(t){const e=this.canvas?.parentElement;e&&(t?(e.classList.add("live-mode"),c.state.isPlaying&&!c.state.isPaused&&e.classList.add("pulsing")):e.classList.remove("live-mode","pulsing"))}setupLiveAnalysers(){const t=_o();if(!t){B.warn("DynamicWaveformVisualizer","SynthEngine not available for live analysis",null,"waveform");return}this.getActivePlayingColors().forEach(n=>{const s=t.createWaveformAnalyzer?.(n);s&&(this.liveAnalysers.set(n,s),this.liveWaveforms.set(n,new Float32Array(1024)),B.debug("DynamicWaveformVisualizer",`Created analyser for ${n}`,null,"waveform"))})}setupSingleAnalyser(t){const e=_o();if(!e)return;const n=e.createWaveformAnalyzer?.(t);n&&(this.liveAnalysers.set(t,n),this.liveWaveforms.set(t,new Float32Array(1024)),B.debug("DynamicWaveformVisualizer",`Created single analyser for ${t}`,null,"waveform"))}getActivePlayingColors(){const t=new Set,e=c.state.placedNotes;c.state.isPlaying&&e.forEach(s=>{!s.isDrum&&s.color&&t.add(s.color)}),t.size===0&&this.currentColor&&t.add(this.currentColor);const n=Array.from(t);return B.debug("DynamicWaveformVisualizer","Active playing colors detected",n,"waveform"),n}animateLiveWaveforms(){if(!this.isPlaybackActive)return;this.frameSkipCounter++;const t=Math.max(1,Math.floor(100/Math.max(this.animationSpeed,1)));if(this.frameSkipCounter%t!==0){this.playbackAnimationId=requestAnimationFrame(()=>this.animateLiveWaveforms());return}this.liveAnalysers.forEach((e,n)=>{const s=e.getValue();this.liveWaveforms.set(n,s)}),this.onWaveformUpdate?.(),this.playbackAnimationId=requestAnimationFrame(()=>this.animateLiveWaveforms())}drawLiveWaveforms(t,e,n){if(!this.ctx)return;const r=Array.from(this.liveWaveforms.keys());if(r.length===1){const i=r[0];if(!i)return;const o=this.liveWaveforms.get(i);this.drawSingleLiveWaveform(o,i,t,e,n)}else r.length>1&&r.forEach(i=>{if(!i)return;const o=this.liveWaveforms.get(i);this.drawLayeredLiveWaveform(o,i,t,e,n,r.length)})}drawSingleLiveWaveform(t,e,n,s,r){const i=this.ctx;if(!i||!t||t.length===0)return;const o=nu();let a=r;if(o){const p=o.getTremoloAmplitudeMultiplier(e);a*=p}let l=0;const d=o?.vibratoCanvasEffect,u=d?.animations.get(e);d&&u&&d.shouldBeRunning()&&(l=Math.sin(u.phase)*u.amplitude*.4);let h=0;for(let p=0;p<t.length;p++){const w=t[p]??0;h=Math.max(h,Math.abs(w))}const m=h>1?1/h:1;i.strokeStyle=e,i.lineWidth=2,i.beginPath();const g=t.length/n*(1+l);for(let p=0;p<n;p++){const w=l*n*.3,v=p+w,C=Math.floor(v*g),F=Math.max(0,Math.min(t.length-1,C)),E=(t[F]??0)*m,b=s-E*a;p===0?i.moveTo(p,b):i.lineTo(p,b)}i.stroke(),B.debug("DynamicWaveformVisualizer",`Drew single live waveform for ${e} with tremolo and vibrato stretch`,{amplitudeRatio:a/r,vibratoStretch:l},"waveform")}drawLayeredLiveWaveform(t,e,n,s,r,i){const o=this.ctx;if(!o||!t||t.length===0)return;const a=nu();let l=r;a&&(l*=a.getTremoloAmplitudeMultiplier(e));let d=0;const u=a?.vibratoCanvasEffect,h=u?.animations.get(e);u&&h&&u.shouldBeRunning()&&(d=Math.sin(h.phase)*h.amplitude*.4);let m=0;for(let v=0;v<t.length;v++){const C=t[v]??0;m=Math.max(m,Math.abs(C))}const f=m>1?1/m:1,g=Math.max(.4,1/i);o.strokeStyle=Ve(e,g*2),o.lineWidth=1.5,o.beginPath();const w=t.length/n*(1+d);for(let v=0;v<n;v++){const C=d*n*.3,F=v+C,E=Math.floor(F*w),b=Math.max(0,Math.min(t.length-1,E)),S=(t[b]??0)*f,y=s-S*l*.7;v===0?o.moveTo(v,y):o.lineTo(v,y)}o.stroke()}isLiveMode(){return this.isPlaybackActive}getLiveColors(){return Array.from(this.liveWaveforms.keys())}dispose(){this.stopLiveVisualization(),B.info("DynamicWaveformVisualizer","Disposed",null,"waveform")}}const CE=512,kA=360,Kn=480,bE=()=>window.animationEffectsManager;B.moduleLoaded("StaticWaveformVisualizer");class yE{canvas=null;ctx=null;currentColor=null;animationFrameId=null;waveformData=new Float32Array(CE);isInitialized=!1;isTransitioning=!1;transitionStartTime=0;transitionDuration=300;fromWaveform=null;toWaveform=null;transitionAnimationId=null;dynamicVisualizer=new vE;animationSpeed=100;frameSkipCounter=0;resizeObserver=null;calculatedAmplitude=0;constructor(){B.info("StaticWaveformVisualizer","Initialized with dynamic visualizer integration",null,"waveform")}initialize(){if(this.canvas=document.getElementById("static-waveform-canvas"),!this.canvas)return!1;const t=this.canvas.getContext("2d");if(!t)return!1;this.ctx=t,this.currentColor=c.state.selectedNote?.color||"#4a90e2";const e=this.canvas.parentElement;return e&&typeof ResizeObserver<"u"&&(this.resizeObserver?.disconnect(),this.resizeObserver=new ResizeObserver(()=>this.resize()),this.resizeObserver.observe(e)),this.resize(),this.setupEventListeners(),this.dynamicVisualizer.initialize(this.canvas,this.ctx),this.dynamicVisualizer.onWaveformUpdate=()=>this.draw(),this.generateWaveform(),this.isInitialized=!0,!0}resize(){if(!this.canvas||!this.ctx)return;const t=this.canvas.parentElement;if(!t)return;const{clientWidth:e,clientHeight:n}=t,s=this.canvas.width,r=this.canvas.height;if((e===0||n===0)&&this.canvas.width>0&&this.canvas.height>0)return;const o=Math.abs(e-s),a=Math.abs(n-r);(o>2||a>2)&&(this.canvas.width=e,this.canvas.height=n,this.draw())}setupEventListeners(){c.on("noteChanged",(e={})=>{const n=e.newNote?.color;n&&n!==this.currentColor&&(this.currentColor=n,this.generateWaveform())}),c.on("timbreChanged",e=>{e&&e===this.currentColor&&this.generateWaveform()}),c.on("waveformExtendedViewChanged",()=>{this.generateWaveform(),this.updateToggleButton()}),document.querySelectorAll(".tab-button").forEach(e=>{e.addEventListener("click",()=>{e.dataset.tab==="timbre"&&setTimeout(()=>this.resize(),100)})}),this.setupSpeedControls(),this.setupExtendToggle()}setupSpeedControls(){const t=Array.from(document.querySelectorAll(".waveform-speed-btn"));t.length!==0&&t.forEach(e=>{e.addEventListener("click",()=>{const n=e.dataset.speed,s=n?parseInt(n,10):NaN;Number.isFinite(s)&&(e.classList.contains("active")?(e.classList.remove("active"),this.setAnimationSpeed(100)):(t.forEach(r=>r.classList.remove("active")),e.classList.add("active"),this.setAnimationSpeed(s)))})})}setAnimationSpeed(t){Number.isFinite(t)&&(this.animationSpeed=t,this.frameSkipCounter=0,this.dynamicVisualizer.setAnimationSpeed(t))}setupExtendToggle(){const t=document.getElementById("waveform-extend-toggle");t instanceof HTMLElement&&(t.addEventListener("click",()=>{c.toggleWaveformExtendedView()}),this.updateToggleButton())}updateToggleButton(){const t=document.getElementById("waveform-extend-toggle");if(!(t instanceof HTMLElement))return;const e=c.state.waveformExtendedView;t.classList.toggle("extended",e),t.textContent=e?"480 View":"360 View",t.title=e?"Switch to 360 waveform view":"Switch to 480 waveform view (shows extra 120)"}generateWaveform(){if(this.isTransitioning||!this.currentColor)return;const t=c.state.timbres[this.currentColor];if(!t?.coeffs)return;const e=La(this.currentColor),n=t.phases??new Float32Array(Cn),s=this.waveformData.length;this.waveformData.fill(0);let r=0;for(let i=0;i<s;i++){const a=(c.state.waveformExtendedView?Kn:kA)/kA,l=i/s*a*2*Math.PI;let d=0;for(let u=0;u<Cn;u++){const h=e[u]??0;if(h<=.001)continue;const m=n[u]??0,f=u+1;d+=h*Math.sin(f*l+m)}this.waveformData[i]=d,r=Math.max(r,Math.abs(d))}if(this.calculatedAmplitude=Math.min(1,r),r>1){const i=1/r;for(let o=0;o<this.waveformData.length;o++){const a=this.waveformData[o]??0;this.waveformData[o]=a*i}}this.draw()}startPhaseTransition(t,e,n){!this.isInitialized||!this.currentColor||(this.isTransitioning&&this.transitionAnimationId&&cancelAnimationFrame(this.transitionAnimationId),this.fromWaveform=new Float32Array(this.waveformData),this.generateTargetWaveform(e),this.toWaveform=new Float32Array(this.waveformData),this.waveformData=this.fromWaveform,this.isTransitioning=!0,this.transitionStartTime=performance.now(),this.animateTransition())}generateTargetWaveform(t){if(!this.currentColor||!t||!c.state.timbres[this.currentColor]?.coeffs)return;const n=La(this.currentColor),s=t instanceof Float32Array?t:new Float32Array(t),r=this.waveformData.length;this.waveformData.fill(0);let i=0;for(let o=0;o<r;o++){const l=(c.state.waveformExtendedView?Kn:kA)/kA,d=o/r*l*2*Math.PI;let u=0;for(let h=0;h<Cn;h++){const m=n[h]??0;if(m<=.001)continue;const f=s[h]??0,g=h+1;u+=m*Math.sin(g*d+f)}this.waveformData[o]=u,i=Math.max(i,Math.abs(u))}if(this.calculatedAmplitude=Math.min(1,i),i>1){const o=1/i;for(let a=0;a<this.waveformData.length;a++){const l=this.waveformData[a]??0;this.waveformData[a]=l*o}}}animateTransition(){const t=this.fromWaveform,e=this.toWaveform;if(!this.isTransitioning||!t||!e)return;const n=performance.now()-this.transitionStartTime,s=Math.min(n/this.transitionDuration,1),r=1-Math.pow(1-s,3);for(let i=0;i<this.waveformData.length;i++){const o=t[i]??0,a=e[i]??0;this.waveformData[i]=o+(a-o)*r}this.draw(),s>=1?(this.isTransitioning=!1,this.fromWaveform=null,this.toWaveform=null,this.transitionAnimationId=null):this.transitionAnimationId=requestAnimationFrame(()=>this.animateTransition())}normalizeWaveform(){let t=0;for(let e=0;e<this.waveformData.length;e++){const n=this.waveformData[e]??0;t=Math.max(t,Math.abs(n))}if(t>0){const e=.9/t;for(let n=0;n<this.waveformData.length;n++){const s=this.waveformData[n]??0;this.waveformData[n]=s*e}}}draw(){const t=this.ctx,e=this.canvas;if(!t||!e)return;const{width:n,height:s}=e,r=s/2,i=s/2;t.fillStyle="#ffffff",t.fillRect(0,0,n,s),this.drawGrid(n,s,r,i),this.dynamicVisualizer.isLiveMode()?this.dynamicVisualizer.drawLiveWaveforms(n,r,i):this.drawWaveform(n,r,i),n>200&&s>100&&this.drawLabels(n,s)}drawGrid(t,e,n,s){const r=this.ctx;if(!r)return;r.strokeStyle="#ced4da",r.lineWidth=1,r.setLineDash([2,2]),r.beginPath(),r.moveTo(0,n),r.lineTo(t,n),r.stroke();const i=c.state.waveformExtendedView?Kn:kA;if((c.state.waveformExtendedView?[90,180,270,360,450]:[90,180,270]).forEach(u=>{const h=t/i*u;r.beginPath(),r.moveTo(h,0),r.lineTo(h,e),r.stroke()}),c.state.waveformExtendedView){const u=t/Kn*kA;r.fillStyle="rgba(128, 128, 128, 0.15)",r.fillRect(u,0,t-u,e)}[.5].forEach(u=>{const h=n-s*u,m=n+s*u;r.beginPath(),r.moveTo(0,h),r.lineTo(t,h),r.moveTo(0,m),r.lineTo(t,m),r.stroke()}),r.setLineDash([]),r.strokeStyle="#999999",r.lineWidth=1;const l=n-s,d=n+s;r.beginPath(),r.moveTo(0,l),r.lineTo(t,l),r.stroke(),r.beginPath(),r.moveTo(0,d),r.lineTo(t,d),r.stroke()}drawWaveform(t,e,n){const s=this.ctx;if(!s||this.waveformData.length===0)return;const r=this.currentColor||"#4a90e2";s.strokeStyle=r,s.lineWidth=2,s.beginPath();const i=this.waveformData.length/t;for(let a=0;a<t;a++){const l=Math.floor(a*i),d=this.waveformData[l]||0,u=e-d*n;a===0?s.moveTo(a,u):s.lineTo(a,u)}s.stroke(),s.lineTo(t,e),s.lineTo(0,e),s.closePath();const o=s.createLinearGradient(0,e-n,0,e+n);o.addColorStop(0,Ve(r,.3)),o.addColorStop(.5,Ve(r,.1)),o.addColorStop(1,Ve(r,.3)),s.fillStyle=o,s.fill()}drawLabels(t,e){const n=this.ctx;if(!n)return;const s=c.state.waveformExtendedView,r=s?Kn:kA,i=s?["0","90","180","270","360","450"]:["0","90","180","270","360"],o=s?[0,90,180,270,360,450]:[0,90,180,270,360];n.fillStyle="#666666",n.font='12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',n.textAlign="center",i.forEach((a,l)=>{const d=o[l]??0,u=t/r*d+10;n.fillText(a,u,e/2+4)}),n.textAlign="left",n.fillText("+1.0",5,15),n.fillText("-1.0",5,e-8)}getNormalizedAmplitude(){return this.calculatedAmplitude||0}getADSRTremoloAmplitude(){const t=this.calculatedAmplitude||0,e=bE();if(this.currentColor&&e?.getADSRTremoloAmplitudeMultiplier){const n=e.getADSRTremoloAmplitudeMultiplier(this.currentColor);return t*n}return t}startSingleNoteVisualization(t){this.dynamicVisualizer.startSingleNoteVisualization(t)}stopLiveVisualization(){this.dynamicVisualizer.stopLiveVisualization()}startLiveVisualization(){this.dynamicVisualizer.startLiveVisualization()}dispose(){this.dynamicVisualizer.dispose(),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.transitionAnimationId&&(cancelAnimationFrame(this.transitionAnimationId),this.transitionAnimationId=null),this.resizeObserver?.disconnect(),this.resizeObserver=null,this.isTransitioning=!1,this.fromWaveform=null,this.toWaveform=null,this.isInitialized=!1}}const Of=new yE;window.waveformVisualizer=Of;function SE(){return Of.initialize()}class Ol{effectName;animations;activeNoteAnimations;ghostNoteAnimation;activeSoundingNotes;isPlaybackActive;hasActiveInteraction;hasDialInteraction;constructor(t){this.effectName=t,this.animations=new Map,this.activeNoteAnimations=new Map,this.ghostNoteAnimation=null,this.activeSoundingNotes=new Map,this.isPlaybackActive=!1,this.hasActiveInteraction=!1,this.hasDialInteraction=!1,B.info(`${t}AnimationEffect`,"Base initialized",null,"animation")}initBase(){c.on("visualEffectChanged",t=>{if(!t)return;const{effectType:e,color:n,effectParams:s}=t;e===this.effectName.toLowerCase()&&this.updateAnimationParameters(n,s)}),c.on("playbackStarted",()=>{this.isPlaybackActive=!0,this.requestAnimationStateUpdate()}),c.on("playbackStopped",()=>{this.isPlaybackActive=!1,this.activeNoteAnimations.clear(),this.activeSoundingNotes.clear(),this.requestAnimationStateUpdate()}),c.on("noteInteractionStart",t=>{t&&this.onNoteInteractionStart(t.noteId,t.color)}),c.on("noteInteractionEnd",t=>{const e=t?.noteId;e&&this.onNoteInteractionEnd(e)}),c.on("ghostNoteUpdated",t=>{t&&this.onGhostNoteUpdated(t.color)}),c.on("ghostNoteCleared",()=>this.onGhostNoteCleared()),c.on("spacebarPlayback",t=>{t&&(this.isPlaybackActive=t.isPlaying,this.requestAnimationStateUpdate())}),c.on("noteAttack",t=>{t&&this.onNoteAttack(t.noteId,t.color)}),c.on("noteRelease",t=>{t&&this.onNoteRelease(t.noteId,t.color)}),c.on("effectDialInteractionStart",t=>{t&&t.effectType===this.effectName.toLowerCase()&&this.onDialInteractionStart(t.color)}),c.on("effectDialInteractionEnd",t=>{t&&t.effectType===this.effectName.toLowerCase()&&this.onDialInteractionEnd(t.color)}),B.info(`${this.effectName}AnimationEffect`,"Base event subscriptions established",null,"animation")}shouldAnimateColor(t){return this.animations.has(t)}shouldAnimateNote(t){if(!t?.color||!this.shouldAnimateColor(t.color))return!1;if(this.hasDialInteraction&&this.activeNoteAnimations.has("dial-preview")){const e=this.activeNoteAnimations.get("dial-preview");if(e&&t.color===e)return!0}return!!(this.isPlaybackActive&&t.uuid&&this.activeSoundingNotes.has(t.uuid)||this.hasActiveInteraction&&t.uuid&&this.activeNoteAnimations.has(t.uuid)||!t.uuid&&this.ghostNoteAnimation&&this.ghostNoteAnimation.color===t.color&&this.isPlaybackActive)}shouldBeRunning(){const t=this.animations.size>0;return t?!!(this.isPlaybackActive||this.hasActiveInteraction||this.hasDialInteraction||this.ghostNoteAnimation!==null||t):!1}onNoteInteractionStart(t,e){this.shouldAnimateColor(e)&&(this.activeNoteAnimations.set(t,e),this.hasActiveInteraction=!0,B.debug(`${this.effectName}AnimationEffect`,`Started interaction animation for note ${t} (${e})`,null,"animation"),this.requestAnimationStateUpdate())}onNoteInteractionEnd(t){this.activeNoteAnimations.delete(t),this.hasActiveInteraction=this.activeNoteAnimations.size>0,B.debug(`${this.effectName}AnimationEffect`,`Ended interaction animation for note ${t}`,null,"animation"),this.requestAnimationStateUpdate()}onGhostNoteUpdated(t){this.shouldAnimateColor(t)?(this.ghostNoteAnimation={color:t,active:!0},B.debug(`${this.effectName}AnimationEffect`,`Ghost note animation updated for color ${t}`,null,"animation")):this.ghostNoteAnimation=null}onGhostNoteCleared(){this.ghostNoteAnimation=null,B.debug(`${this.effectName}AnimationEffect`,"Ghost note animation cleared",null,"animation")}onNoteAttack(t,e){this.shouldAnimateColor(e)&&(this.activeSoundingNotes.set(t,e),B.debug(`${this.effectName}AnimationEffect`,`Note attack: ${t} (${e}) added to active sounding notes`,null,"animation"),this.requestAnimationStateUpdate())}onNoteRelease(t,e){this.activeSoundingNotes.delete(t),B.debug(`${this.effectName}AnimationEffect`,`Note release: ${t} (${e}) removed from active sounding notes`,null,"animation"),this.requestAnimationStateUpdate()}onDialInteractionStart(t){this.shouldAnimateColor(t)&&(this.hasDialInteraction=!0,this.activeNoteAnimations.set("dial-preview",t),B.debug(`${this.effectName}AnimationEffect`,`Dial interaction started for ${t}`,null,"animation"),this.requestAnimationStateUpdate())}onDialInteractionEnd(t){this.hasDialInteraction=!1,this.activeNoteAnimations.delete("dial-preview"),B.debug(`${this.effectName}AnimationEffect`,`Dial interaction ended for ${t}`,null,"animation"),this.requestAnimationStateUpdate()}getActiveColors(){const t=new Set;for(const[,e]of this.activeSoundingNotes.entries())this.shouldAnimateColor(e)&&t.add(e);for(const[,e]of this.activeNoteAnimations.entries())this.shouldAnimateColor(e)&&t.add(e);return this.ghostNoteAnimation&&this.shouldAnimateColor(this.ghostNoteAnimation.color)&&t.add(this.ghostNoteAnimation.color),Array.from(t)}disposeBase(){this.animations.clear(),this.activeNoteAnimations.clear(),this.activeSoundingNotes.clear(),this.ghostNoteAnimation=null,B.info(`${this.effectName}AnimationEffect`,"Base disposed",null,"animation")}requestAnimationStateUpdate(){window.animationEffectsManager?.updateAnimationState()}}B.moduleLoaded("VibratoCanvasEffect");class EE extends Ol{constructor(){super("Vibrato"),B.info("VibratoCanvasEffect","Initialized for canvas note positions",null,"animation")}init(){return this.initBase(),B.info("VibratoCanvasEffect","Ready for canvas animation",null,"animation"),!0}updateAnimationParameters(t,e){const{speed:n,span:s}=e;if(n===0||s===0)this.animations.delete(t),B.debug("VibratoCanvasEffect",`Disabled vibrato animation for ${t}`,null,"animation");else{const r=this.animations.get(t),i=n/100*16,o=s/100*.5,a={frequency:i,amplitude:o,phase:r?.phase||0,lastUpdate:performance.now()};this.animations.set(t,a),B.debug("VibratoCanvasEffect",`Updated vibrato animation for ${t}`,{frequency:i,amplitude:o,preservedPhase:!!r},"animation")}}updateAnimationPhases(t){this.animations.forEach(e=>{const n=(t-e.lastUpdate)/1e3;e.phase+=e.frequency*n*2*Math.PI,e.lastUpdate=t,e.phase>4*Math.PI&&(e.phase-=4*Math.PI)})}getVibratoYOffset(t){if(!t)return 0;const e=this.animations.get(t);if(!e||window.animationEffectsManager&&!window.animationEffectsManager.shouldVibratoBeRunning())return 0;const n=Math.sin(e.phase),s=-n*e.amplitude;return B.debug("VibratoCanvasEffect","Visual vibrato",{sine:n.toFixed(3),offset:s.toFixed(3),phase:e.phase.toFixed(3)},"effects"),s}shouldBeRunning(){return this.animations.size>0?this.isPlaybackActive||this.hasActiveInteraction||this.hasDialInteraction||this.ghostNoteAnimation!==null&&this.isPlaybackActive:!1}shouldAnimateColor(t){const e=this.animations.get(t);return e?e.frequency>0&&e.amplitude>0:!1}dispose(){this.disposeBase(),B.info("VibratoCanvasEffect","Disposed",null,"animation")}}B.moduleLoaded("TremoloWaveformEffect");class QE extends Ol{constructor(){super("Tremolo"),B.info("TremoloWaveformEffect","Initialized for waveform/ADSR amplitude",null,"animation")}init(){return this.initBase(),B.info("TremoloWaveformEffect","Ready for waveform/ADSR animation",null,"animation"),!0}updateAnimationParameters(t,e){const{speed:n,span:s}=e;if(n===0||s===0)this.animations.delete(t),B.debug("TremoloWaveformEffect",`Disabled tremolo animation for ${t}`,null,"animation");else{const r=this.animations.get(t),i=n/100*16,o=s/100,a=window.Tone?.now?.(),l=typeof a=="number"?a*1e3:performance.now(),d={frequency:i,span:o,phase:r?.phase||0,lastUpdate:l};this.animations.set(t,d),B.debug("TremoloWaveformEffect",`Updated tremolo animation for ${t}`,{frequency:i,span:o,preservedPhase:!!r},"animation")}}updateAnimationPhases(t){let e=0;const n=window.Tone?.now?.(),s=typeof n=="number"?n*1e3:t;if(this.animations.forEach((r,i)=>{const o=(s-r.lastUpdate)/1e3,a=r.phase;r.phase+=r.frequency*o*2*Math.PI,r.lastUpdate=s,e++,Math.abs(r.phase-a)<.001&&B.warn("TremoloWaveformEffect",`Phase not advancing for ${i}`,{deltaSeconds:Number(o.toFixed(4)),frequency:r.frequency},"animation"),r.phase>4*Math.PI&&(r.phase-=4*Math.PI)}),e>0&&Math.random()<.05){const r=window.Tone?.now?"Tone.js":"performance";B.debug("TremoloWaveformEffect","Timing sample",{hasTone:!!window.Tone,hasToneNow:!!window.Tone?.now,toneTime:s,currentTime:t,timingSource:r},"animation")}}getTremoloAmplitudeMultiplier(t){const e=this.animations.get(t);if(!e||window.animationEffectsManager&&!window.animationEffectsManager.shouldTremoloBeRunning())return 1;const n=window.waveformVisualizer?.calculatedAmplitude??1,s=Math.sin(e.phase),r=e.span,i=n,o=n*(1-r),a=(i+o)/2,l=(i-o)/2,u=(a+s*l)/n,h=window.Tone?.now?.(),f=(typeof h=="number"?h*1e3:performance.now())-e.lastUpdate;if(f>100&&e.span>0){const g=e.frequency*(f/1e3)*2*Math.PI;g>.1&&B.warn("TremoloWaveformEffect",`Phase stagnation detected for ${t}`,{phase:Number(e.phase.toFixed(3)),millisecondsSinceUpdate:Number(f.toFixed(1)),expectedAdvancement:Number(g.toFixed(3))},"animation")}return Math.max(0,Math.min(1,u))}getADSRTremoloAmplitudeMultiplier(t){return this.getTremoloAmplitudeMultiplier(t)}shouldAnimateColor(t){const e=this.animations.get(t);return e?e.frequency>0&&e.span>0:!1}dispose(){this.disposeBase(),B.info("TremoloWaveformEffect","Disposed",null,"animation")}}B.moduleLoaded("EnvelopeFillEffect");class FE{activeFills;instanceId;constructor(){this.activeFills=new Map,this.instanceId=Math.random().toString(36).substring(7),B.info("EnvelopeFillEffect","Initialized",null,"animation")}init(){c.on("noteAttack",t=>{const e=t?.noteId,n=t?.color;if(!e||!n)return;const s=c.state.timbres?.[n];if(!s){B.warn("EnvelopeFillEffect","No timbre found for color",{color:n},"effects");return}this.activeFills.set(e,{fillLevel:0,color:n,startTime:Dt(),adsr:s.adsr,phase:"attack"}),B.debug("EnvelopeFillEffect",`Started fill animation for note ${e}`,null,"animation"),window.animationEffectsManager?.updateAnimationState()}),c.on("noteRelease",t=>{const e=t?.noteId;if(!e)return;const n=this.activeFills.get(e);n?(n.phase="release",n.releaseStartTime=Dt(),n.releaseStartLevel=n.fillLevel,B.debug("EnvelopeFillEffect",`Started release phase for note ${e}`,null,"animation")):B.warn("EnvelopeFillEffect","No fill data found for release",{noteId:e},"effects")}),c.on("playbackStopped",()=>{this.activeFills.clear(),window.animationEffectsManager?.updateAnimationState(),c.emit("animationUpdate",{type:"envelopeFill",activeColors:[],hasEnvelopeFills:!1})}),B.info("EnvelopeFillEffect","Event subscriptions established",null,"animation")}updateAnimationPhases(t){const e=Dt();for(const[n,s]of this.activeFills.entries()){const{adsr:r,startTime:i,phase:o,releaseStartTime:a,releaseStartLevel:l}=s,d=e-i;if(o==="attack"){const u=r.attack||.01;d<u?s.fillLevel=d/u:(s.phase="decay",s.decayStartTime=e)}else if(o==="decay"){const u=r.decay||.1,h=e-(s.decayStartTime??e),m=r.sustain??.5;if(h<u){const f=h/u;s.fillLevel=1-f*(1-m)}else s.phase="sustain",s.fillLevel=m}else if(o==="sustain"){const u=r.sustain??.5;s.fillLevel=u}else if(o==="release"){const u=r.release||.5,h=a?e-a:0,m=l??s.fillLevel;if(h<u){const f=h/u;s.fillLevel=m*(1-f)}else this.activeFills.delete(n),B.debug("EnvelopeFillEffect",`Completed fill animation for note ${n}`,null,"animation"),this.activeFills.size===0&&window.animationEffectsManager?.updateAnimationState()}}}getFillLevel(t){if(!t.uuid)return 0;const e=this.activeFills.get(t.uuid);return e?e.fillLevel:0}shouldFillNote(t){return t.uuid?this.activeFills.has(t.uuid):!1}shouldBeRunning(){return this.activeFills.size>0}dispose(){this.activeFills.clear(),B.info("EnvelopeFillEffect","Disposed",null,"animation")}}B.moduleLoaded("DelayADSREffect");class IE extends Ol{constructor(){super("Delay"),B.info("DelayADSREffect","Initialized for delay visualization (PLACEHOLDER)",null,"animation")}init(){return this.initBase(),B.info("DelayADSREffect","Ready for delay animation (PLACEHOLDER)",null,"animation"),!0}updateAnimationParameters(t,e){const{time:n,feedback:s}=e;if(n===0&&s===0)this.animations.delete(t),B.debug("DelayADSREffect",`Disabled delay animation for ${t}`,null,"animation");else{const r=n/100*500,i=s/100,o={delayTime:r,feedback:i,echoCount:Math.floor(i*5),lastTrigger:0,echoPhases:[],lastUpdate:performance.now()};this.animations.set(t,o),B.debug("DelayADSREffect",`Updated delay animation for ${t} (PLACEHOLDER)`,{delayTime:r,feedback:i},"animation")}}updateAnimationPhases(t){this.animations.forEach(e=>{e.lastUpdate=t})}getDelayEffects(t){const e=this.animations.get(t);if(!e)return[];const n=[];for(let s=0;s<e.echoCount;s++)n.push({delay:e.delayTime*(s+1),opacity:1-s*.3,scale:1-s*.1,active:!1});return n}triggerDelay(t,e){const n=this.animations.get(t);n&&(n.lastTrigger=e,B.debug("DelayADSREffect",`Triggered delay for ${t} (PLACEHOLDER)`,null,"animation"))}shouldBeRunning(){return this.animations.size>0?this.isPlaybackActive||this.hasActiveInteraction||this.ghostNoteAnimation!==null:!1}shouldAnimateColor(t){const e=this.animations.get(t);return e?e.delayTime>0||e.feedback>0:!1}dispose(){this.disposeBase(),B.info("DelayADSREffect","Disposed",null,"animation")}}B.moduleLoaded("AnimationEffectsManager");class xE{vibratoEffect;tremoloEffect;envelopeFillEffect;delayEffect;isRunning;animationFrameId;lastTime;lastRenderTrigger;constructor(){this.vibratoEffect=new EE,this.tremoloEffect=new QE,this.envelopeFillEffect=new FE,this.delayEffect=new IE,this.isRunning=!1,this.animationFrameId=null,this.lastTime=0,this.lastRenderTrigger=0,B.info("AnimationEffectsManager","Initialized with single animation loop",null,"animation")}init(){return this.vibratoEffect.init(),this.tremoloEffect.init(),this.envelopeFillEffect.init(),this.delayEffect.init(),c.on("visualEffectChanged",t=>{const e=t?.effectType;(e==="vibrato"||e==="tremolo")&&(setTimeout(()=>this.updateAnimationState(),0),e==="tremolo"&&setTimeout(()=>this.triggerTremoloAmplitudeUpdate(),0))}),c.on("audioEffectChanged",t=>{if(!t)return;const{effectType:e,color:n,effectParams:s}=t;!n||!s||e==="delay"&&this.delayEffect.updateAnimationParameters(n,s)}),B.info("AnimationEffectsManager","Event subscriptions established",null,"animation"),!0}animate(t){this.isRunning&&(this.lastTime=t,this.vibratoEffect.updateAnimationPhases(t),this.tremoloEffect.updateAnimationPhases(t),this.envelopeFillEffect.updateAnimationPhases(t),this.triggerVisualUpdates(t),this.animationFrameId=requestAnimationFrame(e=>this.animate(e)))}start(){this.isRunning||(this.isRunning=!0,this.lastTime=performance.now(),this.animationFrameId=requestAnimationFrame(t=>this.animate(t)),B.debug("AnimationEffectsManager","Single animation loop started",null,"animation"))}stop(){this.isRunning&&(this.isRunning=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.triggerFinalUpdates(),B.debug("AnimationEffectsManager","Animation loop stopped",null,"animation"))}shouldTremoloBeRunning(){if(!(this.tremoloEffect.animations.size>0))return!1;const e=this.tremoloEffect.activeSoundingNotes.size>0,n=this.tremoloEffect.hasDialInteraction;return e||n}shouldVibratoBeRunning(){return this.vibratoEffect.animations.size>0?this.vibratoEffect.isPlaybackActive||this.vibratoEffect.hasActiveInteraction||this.vibratoEffect.hasDialInteraction||this.vibratoEffect.ghostNoteAnimation!==null:!1}shouldEnvelopeFillBeRunning(){return this.envelopeFillEffect.shouldBeRunning()}updateAnimationState(){const t=this.shouldVibratoBeRunning(),e=this.shouldTremoloBeRunning(),n=this.shouldEnvelopeFillBeRunning(),s=t||e||n;s&&!this.isRunning?this.start():!s&&this.isRunning&&this.stop()}triggerVisualUpdates(t){if(!this.lastRenderTrigger||t-this.lastRenderTrigger>=16.67){this.lastRenderTrigger=t;const e=this.vibratoEffect.getActiveColors(),n=this.tremoloEffect.getActiveColors(),s=this.envelopeFillEffect.activeFills.size>0;(e.length>0||s)&&c.emit("animationUpdate",{type:e.length>0?"vibrato":"envelopeFill",activeColors:e,hasEnvelopeFills:s}),n.length>0&&c.emit("tremoloAmplitudeUpdate",{activeColors:n})}}triggerFinalUpdates(){const t=Array.from(this.vibratoEffect.animations.keys());t.length>0&&c.emit("animationUpdate",{type:"vibrato",activeColors:t});const e=Array.from(this.tremoloEffect.animations.keys());e.length>0&&c.emit("tremoloAmplitudeUpdate",{activeColors:e})}shouldAnimateNote(t){return this.vibratoEffect.shouldAnimateNote(t)}getVibratoYOffset(t){return this.vibratoEffect.getVibratoYOffset(t)}getTremoloAmplitudeMultiplier(t){return this.tremoloEffect.getTremoloAmplitudeMultiplier(t)}getADSRTremoloAmplitudeMultiplier(t){return this.tremoloEffect.getADSRTremoloAmplitudeMultiplier(t)}getFillLevel(t){return this.envelopeFillEffect.getFillLevel(t)}shouldFillNote(t){return this.envelopeFillEffect.shouldFillNote(t)}getDelayEffects(t){return this.delayEffect.getDelayEffects(t)}hasDelayEffect(t){return this.delayEffect.shouldAnimateColor(t)}triggerTremoloAmplitudeUpdate(){const t=this.tremoloEffect.getActiveColors();t.length>0&&c.emit("tremoloAmplitudeUpdate",{activeColors:t})}getAllActiveColors(){const t=this.vibratoEffect.getActiveColors(),e=this.tremoloEffect.getActiveColors();return[...new Set([...t,...e])]}dispose(){this.stop(),this.vibratoEffect.dispose(),this.tremoloEffect.dispose(),this.envelopeFillEffect.dispose(),this.delayEffect.dispose(),B.info("AnimationEffectsManager","Disposed",null,"animation")}}const su=new xE;B.moduleLoaded("VibratoAudioEffect");class UE{currentSettings=new Map;constructor(){B.info("VibratoAudioEffect","Initialized",null,"audio")}init(){return B.info("VibratoAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(t,e){const{speed:n,span:s}=t;this.currentSettings.set(e,{speed:n,span:s}),B.debug("VibratoAudioEffect",`Updated parameters for ${e}`,{speed:n,span:s},"audio")}applyToVoice(t,e){if(!t||typeof t._setVibrato!="function")return;const n=this.currentSettings.get(e);if(!n){B.debug("VibratoAudioEffect",`No vibrato settings found for color ${e}`,null,"audio");return}try{t._setVibrato(n),t.vibratoApplied=!0,B.debug("VibratoAudioEffect",`Applied vibrato to voice for ${e}`,n,"audio")}catch(s){B.warn("VibratoAudioEffect",`Failed to apply vibrato to voice for ${e}`,s,"audio")}}getCurrentSettings(t){return this.currentSettings.get(t)??{speed:0,span:0}}getEffectInstance(){return null}createVibratoSettings(t,e){if(t===0||e===0)return null;const n=t/100*16,s=e/100*50;return{frequency:n,depth:s}}disableForColor(t){this.updateParameters({speed:0,span:0},t)}dispose(){this.currentSettings.clear(),B.info("VibratoAudioEffect","Disposed",null,"audio")}}B.moduleLoaded("TremoloAudioEffect");class ME{currentSettings=new Map;constructor(){B.info("TremoloAudioEffect","Initialized",null,"audio")}init(){return B.info("TremoloAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(t,e){const{speed:n,span:s}=t;this.currentSettings.set(e,{speed:n,span:s}),B.debug("TremoloAudioEffect",`Updated parameters for ${e}`,{speed:n,span:s},"audio")}applyToVoice(t,e){if(!t||typeof t._setTremolo!="function")return;const n=this.currentSettings.get(e);if(!n){B.debug("TremoloAudioEffect",`No tremolo settings found for color ${e}`,null,"audio");return}try{t._setTremolo(n),t.tremoloApplied=!0,B.debug("TremoloAudioEffect",`Applied tremolo to voice for ${e}`,n,"audio")}catch(s){B.warn("TremoloAudioEffect",`Failed to apply tremolo to voice for ${e}`,s,"audio")}}getCurrentSettings(t){return this.currentSettings.get(t)??{speed:0,span:0}}getEffectInstance(){return null}createTremoloSettings(t,e){if(t===0||e===0)return null;const n=t/100*16,s=e/100;return{frequency:n,depth:s}}disableForColor(t){this.updateParameters({speed:0,span:0},t)}dispose(){this.currentSettings.clear(),B.info("TremoloAudioEffect","Disposed",null,"audio")}}B.moduleLoaded("DelayAudioEffect");const TE=()=>window.synthEngine;class PE{currentSettings=new Map;delayInstances=new Map;init(){return B.info("DelayAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(t,e){const{time:n,feedback:s,wet:r}=t;this.currentSettings.set(e,{time:n,feedback:s,wet:r}),B.debug("DelayAudioEffect",`Updated parameters for ${e}`,{time:n,feedback:s,wet:r},"audio");let i=this.delayInstances.get(e);i?this.updateDelayInstance(i,n,s,r):(n>0||s>0)&&(i=this.createDelayInstance(n,s,r),i&&(this.delayInstances.set(e,i),B.debug("DelayAudioEffect",`Created new delay instance for ${e}`,{time:n,feedback:s,wet:r},"audio"),TE()?.updateSynthForColor?.(e)))}applyToVoice(t,e){if(!t)return;const n=this.currentSettings.get(e);if(!(!n||n.time===0&&n.feedback===0))try{let s=this.delayInstances.get(e);if(!s){if(s=this.createDelayInstance(n.time,n.feedback,n.wet),!s)return;this.delayInstances.set(e,s)}if(typeof t.isDisposed=="function"&&t.isDisposed())return;try{t.connect?.(s)}catch{t.output?.connect?.(s)}B.debug("DelayAudioEffect",`Applied delay to voice for ${e}`,n,"audio")}catch(s){B.warn("DelayAudioEffect",`Failed to apply delay to voice for ${e}`,s,"audio")}}getCurrentSettings(t){return this.currentSettings.get(t)??{time:0,feedback:0,wet:0}}getEffectInstance(t){const e=this.getCurrentSettings(t);return e.time>0&&e.wet>0?this.delayInstances.get(t)??null:null}createDelayInstance(t,e,n=30){if(t===0&&e===0)return null;const s=Math.max(.01,t/100*.5),r=Math.min(.95,e/100),i=n/100,o=new al({delayTime:s,feedback:r,wet:i});return o._wetAmount=i,B.debug("DelayAudioEffect","Created delay instance",{delayTime:s,feedbackAmount:r,wetAmount:i},"audio"),o}updateDelayInstance(t,e,n,s=15){const r=Math.max(.01,e/100*.5),i=Math.min(.95,n/100),o=s/100;try{t.delayTime.value=r,t.feedback.value=i,t._crossFade&&(t._crossFade.fade.value=o),t._wetAmount=o,B.debug("DelayAudioEffect","Updated delay instance",{delayTime:r,feedbackAmount:i,wetAmount:o},"audio")}catch(a){B.warn("DelayAudioEffect","Failed to update delay instance",a,"audio")}}createDelaySettings(t,e,n=30){if(t===0&&e===0)return null;const s=Math.max(.01,t/100*.5),r=Math.min(.95,e/100),i=n/100;return{time:s,feedback:r,wet:i}}disableForColor(t){this.updateParameters({time:0,feedback:0,wet:0},t);const e=this.delayInstances.get(t);if(e)try{e._crossFade?.dispose(),e.dispose()}finally{this.delayInstances.delete(t)}}dispose(){this.delayInstances.forEach((t,e)=>{try{t._crossFade?.dispose(),t.dispose()}catch(n){B.warn("DelayAudioEffect",`Failed to dispose delay for ${e}`,n,"audio")}}),this.currentSettings.clear(),this.delayInstances.clear(),B.info("DelayAudioEffect","Disposed",null,"audio")}}B.moduleLoaded("AudioEffectsManager");const LE=()=>window.synthEngine;class HE{vibratoEffect=new UE;tremoloEffect=new ME;delayEffect=new PE;init(){return this.vibratoEffect.init(),this.tremoloEffect.init(),this.delayEffect.init(),c.on("audioEffectChanged",t=>{if(!t)return;const{effectType:e,parameter:n,value:s,color:r,effectParams:i}=t;this.handleAudioEffectChange(e,n,s,r,i)}),B.info("AudioEffectsManager","Event subscriptions established",null,"audio"),!0}handleAudioEffectChange(t,e,n,s,r){switch(B.debug("AudioEffectsManager",`Processing audio effect: ${t}.${e} = ${n} for ${s}`,null,"audio"),t){case"vibrato":this.vibratoEffect.updateParameters(r,s);break;case"tremolo":this.tremoloEffect.updateParameters(r,s);break;case"delay":this.delayEffect.updateParameters(r,s);break;default:B.debug("AudioEffectsManager",`Effect type ${t} not handled by audio system`,null,"audio")}}getEffectHandler(t){switch(t){case"vibrato":return this.vibratoEffect;case"tremolo":return this.tremoloEffect;case"delay":return this.delayEffect;default:return null}}applySynthEffects(t,e,n){const s=this.delayEffect.getEffectInstance(e);try{t.disconnect()}catch{}let r=t;if(s)try{r.connect(s),r=s}catch(i){B.error("AudioEffectsManager","Delay connection error",i,"audio")}try{r.connect(n);const i=LE()?.getWaveformAnalyzer?.(e);i&&t.connect(i)}catch(i){B.error("AudioEffectsManager","masterGain connection error",i,"audio")}}applyEffectsToVoice(t,e){this.vibratoEffect.applyToVoice(t,e),this.tremoloEffect.applyToVoice(t,e)}dispose(){this.vibratoEffect.dispose(),this.tremoloEffect.dispose(),this.delayEffect.dispose(),B.info("AudioEffectsManager","Disposed",null,"audio")}}const ru=new HE;B.moduleLoaded("EffectsCoordinator");class DE{constructor(){this.effectParameters=new Map,this.defaultEffects={vibrato:{speed:0,span:0,wet:100},tremolo:{speed:0,span:0,wet:100},delay:{time:0,feedback:0,wet:20}},B.info("EffectsCoordinator","Initialized as main coordinator",null,"effects")}init(){return Object.keys(c.state.timbres).forEach(t=>{this.initializeColorEffects(t)}),c.on("timbreCreated",({color:t})=>{this.initializeColorEffects(t)}),this.loadSavedValues(),B.info("EffectsCoordinator","Event subscriptions established",null,"effects"),!0}initializeColorEffects(t){if(!this.effectParameters.has(t)){const e={};Object.entries(this.defaultEffects).forEach(([s,r])=>{e[s]={...r}}),this.effectParameters.set(t,e);const n=c.state.timbres[t];n&&(n.vibrato&&(e.vibrato={...n.vibrato}),n.tremelo&&(e.tremolo={...n.tremelo})),B.debug("EffectsCoordinator",`Initialized effects for color ${t}`,e,"effects")}}updateParameter(t,e,n,s){if(!s){B.warn("EffectsCoordinator","Cannot update parameter: no color provided",{effectType:t,parameter:e,value:n},"effects");return}this.initializeColorEffects(s);const r=this.effectParameters.get(s);r[t]||(r[t]={...this.defaultEffects[t]}),r[t][e]=n,this.notifyAudioSystem(t,e,n,s,r[t]),this.notifyAnimationSystem(t,e,n,s,r[t]),this.updateTimbreState(t,r[t],s),this.saveValues()}notifyAudioSystem(t,e,n,s,r){c.emit("audioEffectChanged",{effectType:t,parameter:e,value:n,color:s,effectParams:{...r}}),B.debug("EffectsCoordinator",`Notified audio system: ${t}.${e} = ${n} for ${s}`,null,"effects")}notifyAnimationSystem(t,e,n,s,r){(t==="vibrato"||t==="tremolo")&&(c.emit("visualEffectChanged",{effectType:t,parameter:e,value:n,color:s,effectParams:{...r}}),B.debug("EffectsCoordinator",`Notified animation system: ${t}.${e} = ${n} for ${s}`,null,"effects"))}updateTimbreState(t,e,n){const s=c.state.timbres[n];if(!s)return;const i={vibrato:"vibrato",tremolo:"tremelo"}[t];i&&(s[i]||(s[i]={}),Object.assign(s[i],e),c.recordState())}getEffectParameters(t,e){const n=this.effectParameters.get(t);return n?.[e]?{...n[e]}:{...this.defaultEffects[e]}}getAllEffectParameters(t){const e=this.effectParameters.get(t);return e?{...e}:{...this.defaultEffects}}resetColorEffects(t){const e={};Object.entries(this.defaultEffects).forEach(([n,s])=>{e[n]={...s}}),this.effectParameters.set(t,e),Object.keys(e).forEach(n=>{Object.keys(e[n]).forEach(s=>{this.notifyAudioSystem(n,s,e[n][s],t,e[n]),this.notifyAnimationSystem(n,s,e[n][s],t,e[n])})}),B.info("EffectsCoordinator",`Reset all effects for color ${t}`,e,"effects")}saveValues(){const t={};Object.keys(c.state.timbres).forEach(e=>{const n=this.effectParameters.get(e);n&&(t[e]={vibrato:n.vibrato||{speed:0,span:0,wet:100},tremelo:n.tremolo||{speed:0,span:0,wet:100},delay:n.delay||{time:0,feedback:0,wet:20}})});try{localStorage.setItem("effectDialValues",JSON.stringify(t)),B.debug("EffectsCoordinator","Saved effect values to localStorage",null,"effects")}catch(e){B.warn("EffectsCoordinator","Failed to save effect values to localStorage",e,"effects")}}loadSavedValues(){try{const t=localStorage.getItem("effectDialValues");if(!t){B.debug("EffectsCoordinator","No saved effect values found",null,"effects");return}const e=JSON.parse(t);B.debug("EffectsCoordinator","Loading saved effect values",null,"effects"),Object.keys(e).forEach(n=>{const s=c.state.timbres[n],r=e[n];s&&r&&(r.vibrato&&Object.entries(r.vibrato).forEach(([i,o])=>{typeof o=="number"&&this.updateParameter("vibrato",i,o,n)}),r.tremelo&&Object.entries(r.tremelo).forEach(([i,o])=>{typeof o=="number"&&this.updateParameter("tremolo",i,o,n)}),r.delay&&Object.entries(r.delay).forEach(([i,o])=>{typeof o=="number"&&this.updateParameter("delay",i,o,n)}))}),B.info("EffectsCoordinator","Applied saved effect values",null,"effects"),window.synthEngine&&Object.keys(e).forEach(n=>{const s=e[n];s.delay&&(s.delay.time>0||s.delay.feedback>0)&&(window.synthEngine.updateSynthForColor(n),B.debug("EffectsCoordinator",`Re-applied effects to synth for ${n}`,null,"effects"))})}catch(t){B.warn("EffectsCoordinator","Failed to load saved effect values",t,"effects")}}dispose(){this.effectParameters.clear(),B.info("EffectsCoordinator","Disposed",null,"effects")}}const fn=new DE;class NE{currentEffect=null;effectControlsContainer=null;effectButtons=[];dials=[];currentColor=null;isDialInteractionActive=!1;lastPreviewAt={};previewThrottleMs=180;previewDurationMs=220;previewPitch="C4";holdPreviews={};effectConfigs={delay:{name:"Delay",controls:{time:{label:"Time",min:0,max:100,default:0,unit:"%"},feedback:{label:"Echoes",min:0,max:95,default:0,unit:"%"},wet:{label:"Mix",min:0,max:100,default:15,unit:"%"}}},vibrato:{name:"Vibrato",controls:{speed:{label:"Speed",min:0,max:100,default:0,unit:"%"},span:{label:"Span",min:0,max:100,default:0,unit:"%"}}},tremolo:{name:"Tremolo",controls:{speed:{label:"Speed",min:0,max:100,default:0,unit:"%"},span:{label:"Span",min:0,max:100,default:0,unit:"%"}}}};init(){return B.initStart("Effects Controller"),this.effectControlsContainer=document.getElementById("effect-controls"),this.effectButtons=document.querySelectorAll(".effect-button[data-effect]"),this.effectButtons.length>0&&this.setupEventListeners(),this.initializeSelectedColorTracking(),this.setupGlobalMouseUpHandler(),B.initSuccess("Effects Controller"),!0}setupGlobalMouseUpHandler(){document.addEventListener("mouseup",()=>{this.isDialInteractionActive&&this.onDialInteractionEnd(this.currentEffect)})}setupEventListeners(){this.effectButtons.forEach(t=>{t.addEventListener("click",e=>{const s=e.currentTarget.dataset.effect;s&&this.selectEffect(s)})})}selectEffect(t){if(B.debug("Effects",`Selecting effect: ${t}`,null,"ui"),!this.effectConfigs[t]){B.info("Effects",`Effect ${t} not configured`,null,"ui");return}if(this.effectButtons.forEach(e=>{e.classList.remove("active"),e.dataset.effect===t&&e.classList.add("active")}),this.currentEffect===t){this.currentEffect=null,this.hideEffectControls();return}this.currentEffect=t,this.showEffectControls(t)}showEffectControls(t){const e=this.effectConfigs[t];if(!e||!this.effectControlsContainer){B.warn("Effects",`No configuration found for effect: ${t}`,null,"ui");return}this.clearControls(),this.effectControlsContainer.innerHTML='<div class="effect-controls"></div>';const n=this.effectControlsContainer.querySelector(".effect-controls");n&&Object.entries(e.controls).forEach(([s,r])=>{const o=(this.currentColor?fn.getEffectParameters?.(this.currentColor,t):null)?.[s]??r.default??0,a=document.createElement("div");a.className="effect-slider-group",a.style.cssText="margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;",n.appendChild(a);const l=document.createElement("label");l.className="effect-slider-label",l.textContent=r.label,l.style.cssText="display: block; margin-bottom: 5px; font-weight: bold; color: #333;",a.appendChild(l);const d=document.createElement("input");d.type="range",d.min=`${r.min}`,d.max=`${r.max}`,d.value=`${o}`,d.className="effect-slider",d.style.cssText="width: 100%; margin: 5px 0;",a.appendChild(d);const u=document.createElement("div");u.className="effect-slider-value";const h=r.unit?`${Math.round(o)}${r.unit}`:Math.round(o);u.textContent=`${h}`,u.style.cssText="text-align: center; font-size: 12px; color: #666;",a.appendChild(u),this.dials.push({dial:{element:d,value:o,destroy:()=>{}},control:s,effectType:t,valueDisplay:u,controlConfig:r});const m=f=>{const g=f.target;if(!g)return;const p=parseFloat(g.value),w=r.unit?`${Math.round(p)}${r.unit}`:Math.round(p);u.textContent=`${w}`,B.debug("Effects",`${t} ${s}: ${p}`,null,"audio"),this.onEffectParameterChange(t,s,p)};d.addEventListener("input",m),d.addEventListener("change",m),d.addEventListener("mousedown",()=>this.onDialInteractionStart(t)),d.addEventListener("mouseup",()=>this.onDialInteractionEnd(t)),d.addEventListener("mouseleave",f=>{(f.buttons&1)===1&&this.onDialInteractionEnd(t)})})}hideEffectControls(){this.clearControls(),this.currentEffect=null}clearControls(){this.dials.forEach(t=>t.dial.destroy()),this.dials=[],this.effectControlsContainer&&(this.effectControlsContainer.innerHTML="")}onEffectParameterChange(t,e,n){const s=this.currentColor||c.state.selectedNote?.color;s&&fn.updateParameter(t,e,n,s)}updateEffect(t,e){const n=this.currentColor||c.state.selectedNote?.color;n&&Object.entries(e).forEach(([s,r])=>{typeof r=="number"&&fn.updateParameter(t,s,r,n)})}getEffectState(t){const e=this.currentColor||c.state.selectedNote?.color;return e?fn.getEffectParameters(e,t)||{}:{}}getActiveColor(){return this.currentColor||c.state.selectedNote?.color||null}getPreviewNotes(){const t=this.getActiveColor();if(!t)return null;const e=c.state.placedNotes.slice().reverse().find(i=>!i.isDrum),n=e?c.state.fullRowData[e.row]?.toneNote||this.previewPitch:this.previewPitch,s=c.state.selectedTool;let r=[n];return s==="chord"&&Array.isArray(c.state.activeChordIntervals)&&(r=c.state.activeChordIntervals.map(o=>ss(vn(n,o)))),{pitches:r,root:n,color:t}}previewEffect(t){const e=this.getActiveColor();if(!e)return;const n=Date.now(),s=this.lastPreviewAt[t]??0;if(n-s<this.previewThrottleMs)return;this.lastPreviewAt[t]=n;const{isPlaying:r,isPaused:i}=c.state;if(r&&!i)return;const o=`effect-preview-${t}`;c.emit?.("noteAttack",{noteId:o,color:e});try{St.triggerAttack(this.previewPitch,e),setTimeout(()=>St.triggerRelease(this.previewPitch,e),this.previewDurationMs)}catch(a){B.warn("Effects","Preview trigger failed",{err:a},"audio")}finally{setTimeout(()=>c.emit?.("noteRelease",{noteId:o,color:e}),this.previewDurationMs)}}startHoldPreview(t){if(this.holdPreviews[t])return;const e=this.getPreviewNotes();if(!e)return;const{pitches:n,root:s,color:r}=e,i=`effect-hold-${t}-${Date.now()}`;this.holdPreviews[t]={pitches:n,root:s,color:r,noteId:i};const{isPlaying:o,isPaused:a}=c.state;if(o&&!a)return;n.forEach(h=>St.triggerAttack(h,r));const l=c.state.fullRowData.find(h=>h.toneNote===s),d=l?l.hex:"#888888",u=c.state.timbres[r];u&&Fe.adsrComponent?.playheadManager.trigger(i,"attack",d,u.adsr),c.emit("spacebarPlayback",{note:s,color:r,isPlaying:!0}),c.emit("noteAttack",{noteId:i,color:r})}stopHoldPreview(t){const e=this.holdPreviews[t];if(!e)return;delete this.holdPreviews[t];const{pitches:n,root:s,color:r,noteId:i}=e;n.forEach(d=>St.triggerRelease(d,r));const o=c.state.fullRowData.find(d=>d.toneNote===s),a=o?o.hex:"#888888",l=c.state.timbres[r];l&&Fe.adsrComponent?.playheadManager.trigger(i,"release",a,l.adsr),c.emit("spacebarPlayback",{note:s,color:r,isPlaying:!1}),c.emit("noteRelease",{noteId:i,color:r})}initializeSelectedColorTracking(){c.on("noteChanged",({newNote:t}={})=>{this.currentColor=t?.color||null,this.currentColor&&this.currentEffect&&this.showEffectControls(this.currentEffect)}),this.currentColor=c.state.selectedNote?.color||null}onDialInteractionStart(t){if(this.isDialInteractionActive=!0,t){B.debug("Effects",`Dial interaction start for ${t}`,null,"ui");const e=this.getActiveColor();e&&c.emit("effectDialInteractionStart",{effectType:t,color:e}),this.startHoldPreview(t)}}onDialInteractionEnd(t){if(this.isDialInteractionActive=!1,t){B.debug("Effects",`Dial interaction end for ${t}`,null,"ui");const e=this.getActiveColor();e&&c.emit("effectDialInteractionEnd",{effectType:t,color:e}),this.stopHoldPreview(t)}}}const CA=new NE;class RE{listeners=new Map;on(t,e){const n=this.listeners.get(t)||[];n.push(e),this.listeners.set(t,n)}off(t,e){const n=this.listeners.get(t);if(!n)return;const s=n.indexOf(e);s>=0&&n.splice(s,1)}emit(t,e){const n=this.listeners.get(t);n&&n.slice().forEach(s=>s(e))}}class kE{static DEBUG=!1;debugLog(...t){}_root;_svgWrapper;_bg;_gridFill;_gridPatternRect;_dial;_crosshairV;_crosshairH;_label;_em=new RE;_patternId;_size;_mode;_minX;_maxX;_stepX;_minY;_maxY;_stepY;_reverseX;_x;_y;_normX;_normY;_dragging=!1;colors={accent:"#4a90e2",fill:"#1f1f1f",stroke:"#555",grid:"#333",text:"#fff"};constructor(t,e={}){if(this._root=typeof t=="string"?document.querySelector(t):t,!this._root)throw new Error("Position: target not found");const{size:n=[200,200],mode:s="absolute",x:r=.5,minX:i=0,maxX:o=1,stepX:a=0,y:l=.5,minY:d=0,maxY:u=1,stepY:h=0,reverseX:m=!1,colors:f}=e;this._patternId=`pos-grid-${Math.random().toString(36).slice(2,8)}`;try{const w=getComputedStyle(document.documentElement),v=w.getPropertyValue("--c-surface").trim(),C=w.getPropertyValue("--c-border").trim(),F=w.getPropertyValue("--c-border-strong").trim(),E=w.getPropertyValue("--c-text").trim();this.colors={...this.colors,fill:v||this.colors.fill,stroke:C||this.colors.stroke,grid:F||this.colors.grid,text:E||this.colors.text}}catch{}this._size=n,this._mode=s,this._minX=i,this._maxX=o,this._stepX=a,this._minY=d,this._maxY=u,this._stepY=h,this._reverseX=m,f&&(this.colors={...this.colors,...f}),this._x=r,this._y=l,this._normX=0,this._normY=0,this._svgWrapper=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._svgWrapper.setAttribute("width",`${n[0]}`),this._svgWrapper.setAttribute("height",`${n[1]}`),this._svgWrapper.setAttribute("viewBox",`0 0 ${n[0]} ${n[1]}`),this._svgWrapper.style.touchAction="none";const g=document.createElementNS("http://www.w3.org/2000/svg","defs"),p=document.createElementNS("http://www.w3.org/2000/svg","pattern");p.setAttribute("id",this._patternId),p.setAttribute("width","20"),p.setAttribute("height","20"),p.setAttribute("patternUnits","userSpaceOnUse"),this._gridPatternRect=document.createElementNS("http://www.w3.org/2000/svg","rect"),this._gridPatternRect.setAttribute("width","20"),this._gridPatternRect.setAttribute("height","20"),this._gridPatternRect.setAttribute("fill","none"),this._gridPatternRect.setAttribute("stroke",this.colors.grid),this._gridPatternRect.setAttribute("stroke-width","1"),p.appendChild(this._gridPatternRect),g.appendChild(p),this._svgWrapper.appendChild(g),this._bg=document.createElementNS("http://www.w3.org/2000/svg","rect"),this._bg.setAttribute("x","0"),this._bg.setAttribute("y","0"),this._bg.setAttribute("width",`${n[0]}`),this._bg.setAttribute("height",`${n[1]}`),this._bg.setAttribute("fill",this.colors.fill),this._bg.setAttribute("stroke",this.colors.stroke),this._svgWrapper.appendChild(this._bg),this._gridFill=document.createElementNS("http://www.w3.org/2000/svg","rect"),this._gridFill.setAttribute("x","0"),this._gridFill.setAttribute("y","0"),this._gridFill.setAttribute("width",`${n[0]}`),this._gridFill.setAttribute("height",`${n[1]}`),this._gridFill.setAttribute("fill",`url(#${this._patternId})`),this._gridFill.setAttribute("opacity","0.2"),this._svgWrapper.appendChild(this._gridFill),this._crosshairV=document.createElementNS("http://www.w3.org/2000/svg","line"),this._crosshairH=document.createElementNS("http://www.w3.org/2000/svg","line"),[this._crosshairV,this._crosshairH].forEach(w=>{w.setAttribute("stroke",this.colors.grid),w.setAttribute("stroke-width","1"),w.setAttribute("opacity","0.6"),this._svgWrapper.appendChild(w)}),this._dial=document.createElementNS("http://www.w3.org/2000/svg","circle"),this._dial.setAttribute("r","10"),this._dial.setAttribute("fill",this.colors.accent),this._dial.setAttribute("stroke","#fff"),this._dial.setAttribute("stroke-width","2"),this._svgWrapper.appendChild(this._dial),this._label=document.createElementNS("http://www.w3.org/2000/svg","text"),this._label.setAttribute("x","8"),this._label.setAttribute("y",`${n[1]-8}`),this._label.setAttribute("fill",this.colors.text),this._label.setAttribute("font-size","12"),this._label.setAttribute("font-family","monospace"),this._label.setAttribute("opacity","0"),this._label.textContent="",this._svgWrapper.appendChild(this._label),this._root.innerHTML="",this._root.appendChild(this._svgWrapper),this._bind(),this.setColors(),this._updateFromValues()}on(t,e){return this._em.on(t,e),()=>this._em.off(t,e)}get value(){return{x:this._x,y:this._y}}get normalized(){return{x:this._normX,y:this._normY}}set x(t){this._x=this._clamp(this._maybeStep(t,this._minX,this._maxX,this._stepX),this._minX,this._maxX),this._updateFromValues()}get x(){return this._x}set y(t){this._y=this._clamp(this._maybeStep(t,this._minY,this._maxY,this._stepY),this._minY,this._maxY),this._updateFromValues()}get y(){return this._y}set minX(t){this._minX=t,this._updateFromValues()}set maxX(t){this._maxX=t,this._updateFromValues()}set minY(t){this._minY=t,this._updateFromValues()}set maxY(t){this._maxY=t,this._updateFromValues()}set stepX(t){this._stepX=t}set stepY(t){this._stepY=t}resize(t,e){this._size=[t,e],this._svgWrapper.setAttribute("width",`${t}`),this._svgWrapper.setAttribute("height",`${e}`),this._svgWrapper.setAttribute("viewBox",`0 0 ${t} ${e}`),this._label.setAttribute("y",`${e-8}`),this._updateFromValues()}destroy(){this._root.innerHTML=""}setColors(t={}){this.colors={...this.colors,...t},this._bg.setAttribute("fill",this.colors.fill),this._bg.setAttribute("stroke",this.colors.stroke),this._gridPatternRect.setAttribute("stroke",this.colors.grid),this._gridFill.setAttribute("fill",`url(#${this._patternId})`),this._crosshairV.setAttribute("stroke",this.colors.grid),this._crosshairH.setAttribute("stroke",this.colors.grid),this._dial.setAttribute("fill",this.colors.accent),this._label.setAttribute("fill",this.colors.text)}_updateFromValues(){if(this._x===this._minX&&this._y===this._minY)this.debugLog("At origin (off state)",{x:this._x,y:this._y});else{const n=this._x,s=this._y;if(this._x===this._minX){const r=this._stepX>0?this._stepX:Math.max((this._maxX-this._minX)/100,.01);this._x=this._minX+r}if(this._y===this._minY){const r=this._stepY>0?this._stepY:Math.max((this._maxY-this._minY)/100,.01);this._y=this._minY+r}this.debugLog("Adjusted single-axis zero",{from:{x:n,y:s},to:{x:this._x,y:this._y}})}const t=(this._x-this._minX)/(this._maxX-this._minX||1),e=(this._y-this._minY)/(this._maxY-this._minY||1);this._normX=this._clamp(t,0,1),this._normY=this._clamp(e,0,1),this._updateGraphics(),this._em.emit("change",{x:this._x,y:this._y})}_updateGraphics(){const[t,e]=this._size,n=this._reverseX?(1-this._normX)*t:this._normX*t,s=this._mode==="absolute"?this._normY*e:(1-this._normY)*e;this._dial.setAttribute("cx",`${n}`),this._dial.setAttribute("cy",`${s}`),this._crosshairV.setAttribute("x1",`${n}`),this._crosshairV.setAttribute("x2",`${n}`),this._crosshairV.setAttribute("y1","0"),this._crosshairV.setAttribute("y2",`${e}`),this._crosshairH.setAttribute("x1","0"),this._crosshairH.setAttribute("x2",`${t}`),this._crosshairH.setAttribute("y1",`${s}`),this._crosshairH.setAttribute("y2",`${s}`),this._label.textContent=`x:${this._x.toFixed(3)} y:${this._y.toFixed(3)}`}_bind(){const t=s=>{this._dragging=!0,this._handlePointer(s),s.target.setPointerCapture?.(s.pointerId)},e=s=>{this._dragging&&this._handlePointer(s)},n=s=>{this._dragging=!1,s.target.releasePointerCapture?.(s.pointerId)};this._svgWrapper.addEventListener("pointerdown",t),this._svgWrapper.addEventListener("pointermove",e),this._svgWrapper.addEventListener("pointerup",n),this._svgWrapper.addEventListener("pointercancel",n)}_handlePointer(t){const e=this._svgWrapper.getBoundingClientRect(),n=(t.clientX-e.left)/e.width,s=this._reverseX?1-n:n,r=(t.clientY-e.top)/e.height;this._normX=this._clamp(s,0,1);const i=this._mode==="relative"?1-r:r;if(this._normY=this._clamp(i,0,1),this._x=this._minX+this._normX*(this._maxX-this._minX),this._y=this._minY+this._normY*(this._maxY-this._minY),this.debugLog("Pointer move",{raw:{nx:s,ny:r},norm:{x:this._normX,y:this._normY},value:{x:this._x,y:this._y},mode:this._mode}),this._stepX>0){const o=this._maybeStep(this._x,this._minX,this._maxX,this._stepX);this._x=o}if(this._stepY>0){const o=this._maybeStep(this._y,this._minY,this._maxY,this._stepY);this._y=o}if(!(this._x===this._minX&&this._y===this._minY)){if(this._x===this._minX){const o=this._stepX>0?this._stepX:Math.max((this._maxX-this._minX)/100,.01);this._x=this._minX+o}if(this._y===this._minY){const o=this._stepY>0?this._stepY:Math.max((this._maxY-this._minY)/100,.01);this._y=this._minY+o}}this._normX=this._clamp((this._x-this._minX)/(this._maxX-this._minX||1),0,1),this._normY=this._clamp((this._y-this._minY)/(this._maxY-this._minY||1),0,1),this._updateGraphics(),this._em.emit("change",{x:this._x,y:this._y})}_maybeStep(t,e,n,s){if(s<=0)return t;const r=t-e,i=Math.round(r/s),o=e+i*s;return this._clamp(o,e,n)}_clamp(t,e,n){return Math.max(e,Math.min(n,t))}}B.moduleLoaded("CartesianSliderController");class _E{sliders={};resizeObservers=[];effectConfigs;isDragging={};constructor(){this.effectConfigs={delay:{containerId:"delay-position",xParam:"time",yParam:"feedback",xRange:{min:0,max:100,step:1},yRange:{min:0,max:95,step:1},backgroundOpacity:.2},vibrato:{containerId:"vibrato-position",xParam:"speed",yParam:"span",xRange:{min:0,max:100,step:1},yRange:{min:0,max:100,step:1},backgroundOpacity:.5},tremolo:{containerId:"tremolo-position",xParam:"speed",yParam:"span",xRange:{min:0,max:100,step:1},yRange:{min:0,max:100,step:1},backgroundOpacity:.5}},B.info("CartesianSliderController","Initialized",null,"ui")}init(){return B.initStart("Cartesian Slider Controller"),Object.entries(this.effectConfigs).forEach(([t,e])=>{this.createSliderComponent(t,e)}),this.initializeColorTracking(),B.initSuccess("Cartesian Slider Controller"),!0}createSliderComponent(t,e){const n=document.getElementById(e.containerId);if(!n){B.warn("CartesianSliderController",`Container not found for ${t}`,{containerId:e.containerId},"ui");return}try{t==="delay"&&setTimeout(()=>{console.group("[Effects Width Debug]");const l=document.querySelector(".position-controls-container"),d=document.querySelector(".effects-content-box"),u=document.getElementById("effects-panel"),h=document.querySelector(".preset-effects-content"),m=document.querySelector(".preset-effects-controls"),f=(g,p)=>{if(!p){console.log(`${g}: NOT FOUND`);return}const w=getComputedStyle(p),v=p.getBoundingClientRect();console.log(`${g}:`,{actualWidth:v.width,computedWidth:w.width,flex:`${w.flexGrow} ${w.flexShrink} ${w.flexBasis}`,minWidth:w.minWidth,maxWidth:w.maxWidth})};f("position-controls-container",l),f("effects-content-box",d),f("effects-panel",u),f("preset-effects-content",h),f("preset-effects-controls",m),console.groupEnd()},100);const[s,r]=this.getSliderComponentSize(n),i=new kE(n,{size:[s,r],mode:"relative",x:e.xRange.min,minX:e.xRange.min,maxX:e.xRange.max,stepX:e.xRange.step,y:e.yRange.min,minY:e.yRange.min,maxY:e.yRange.max,stepY:e.yRange.step});this.sliders[t]=i,this.observeSliderResize(n,i,s,r),i.on("change",({x:l,y:d})=>{this.onSliderChange(t,e.xParam,l,e.yParam,d)});const o=()=>{this.isDragging[t]=!0,this.onSliderInteractionStart(t),CA.startHoldPreview(t)},a=()=>{this.isDragging[t]&&(this.isDragging[t]=!1,this.onSliderInteractionEnd(t),CA.stopHoldPreview(t))};n.addEventListener("pointerdown",o),["pointerup","pointerleave","pointercancel"].forEach(l=>{n.addEventListener(l,a)}),this.loadInitialValues(t,e,i),B.debug("CartesianSliderController",`Created slider component for ${t}`,null,"ui")}catch(s){B.error("CartesianSliderController",`Failed to create slider component for ${t}`,s,"ui")}}getSliderComponentSize(t){const n=t.getBoundingClientRect();let s=n?.width||t.clientWidth||t.offsetWidth||120,r=n?.height||t.clientHeight||t.offsetHeight||s;return(!s||s<10)&&(s=120),(!r||r<10)&&(r=s),[Math.round(s),Math.round(r)]}observeSliderResize(t,e,n,s){if(typeof ResizeObserver>"u")return;const r={currentWidth:Math.round(n)||0,currentHeight:Math.round(s)||0},i=new ResizeObserver(o=>{for(const a of o){const{width:l,height:d}=a.contentRect,u=Math.round(l),h=Math.round(d||l);!u||!h||u===r.currentWidth&&h===r.currentHeight||(r.currentWidth=u,r.currentHeight=h,e.resize(u,h))}});i.observe(t),this.resizeObservers.push(i)}onSliderChange(t,e,n,s,r){CA.updateEffect(t,{[e]:n,[s]:r})}onSliderInteractionStart(t){const e=CA.getActiveColor();B.debug("CartesianSliderController",`Interaction start for ${t}`,null,"ui"),c.emit("effectDialInteractionStart",{effectType:t,color:e})}onSliderInteractionEnd(t){const e=CA.getActiveColor();B.debug("CartesianSliderController",`Interaction end for ${t}`,null,"ui"),c.emit("effectDialInteractionEnd",{effectType:t,color:e})}loadInitialValues(t,e,n){const s=CA.getEffectState(t)||{},r=s[e.xParam],i=s[e.yParam],o=typeof r=="number"?r:e.xRange.min,a=typeof i=="number"?i:e.yRange.min;n.x=o,n.y=a}initializeColorTracking(){c.on("noteChanged",({newNote:t}={})=>{t?.color&&this.applyColorPalette(t.color)}),c.state.selectedNote?.color&&this.applyColorPalette(c.state.selectedNote.color)}applyColorPalette(t){const e=c.state.colorPalette[t]||{primary:t,light:t},n=(o,a)=>{const l=f=>Math.max(0,Math.min(255,f)),d=o.replace("#",""),u=l(parseInt(d.slice(0,2),16)+a),h=l(parseInt(d.slice(2,4),16)+a),m=l(parseInt(d.slice(4,6),16)+a);return`#${u.toString(16).padStart(2,"0")}${h.toString(16).padStart(2,"0")}${m.toString(16).padStart(2,"0")}`},s=e.primary,r=e.light||n(s,80),i=(o,a)=>{const l=o.replace("#",""),d=parseInt(l.slice(0,2),16),u=parseInt(l.slice(2,4),16),h=parseInt(l.slice(4,6),16);return`rgba(${d}, ${u}, ${h}, ${a})`};Object.entries(this.sliders).forEach(([o,a])=>{const d=this.effectConfigs[o]?.backgroundOpacity??.5;a.setColors({accent:e.primary,fill:i(r,d),stroke:"#c3c9d0",grid:"#d7dce4",text:"#3c4048"})})}}const iu=new _E;function OE(){hE(),b1(),BE(),B.initStart("Waveform Visualizer"),SE()?B.initSuccess("Waveform Visualizer"):B.initFailed("Waveform Visualizer"),B.initStart("Effects Managers"),su.init(),ru.init(),fn.init(),CA.init(),iu.init();const A=window;A.effectsCoordinator=fn,A.animationEffectsManager=su,A.audioEffectsManager=ru,A.effectsController=CA,A.cartesianSliderController=iu,B.initSuccess("Effects Managers")}function KE({cx:A,cy:t,rx:e,ry:n,stroke:s="currentColor",strokeWidth:r=3}){const i=document.createElementNS("http://www.w3.org/2000/svg","ellipse");return i.setAttribute("cx",`${A}`),i.setAttribute("cy",`${t}`),i.setAttribute("rx",`${e}`),i.setAttribute("ry",`${n}`),i.setAttribute("fill","none"),i.setAttribute("stroke",s),i.setAttribute("stroke-width",`${r}`),i.setAttribute("stroke-linecap","round"),i}function GE(A,t=48,e=48){const n=document.createElementNS("http://www.w3.org/2000/svg","svg"),s=A.span==="quarter",r=s?200:100;n.setAttribute("viewBox",`0 0 ${r} 100`),n.setAttribute("width",`${t}`),n.setAttribute("height",`${e}`),n.setAttribute("aria-label",A.label),n.style.color="#000000";const o=50,a=s?32:16,l=40,d=s?[33.33,100,166.67]:[16.67,50,83.33];return A.hits.forEach(u=>{const h=KE({cx:d[u]??0,cy:o,rx:a,ry:l,stroke:"currentColor",strokeWidth:3});n.appendChild(h)}),n}const Os={selectedTripletStampId:1,init(){this.render(),this.bindEvents(),B.info("TripletStampsToolbar","Triplet stamps toolbar initialized",null,"triplets")},render(){const A=document.getElementById("triplet-stamps-toolbar-container");if(!A){B.warn("TripletStampsToolbar","Container not found",null,"triplets");return}A.innerHTML="";const t=Dr.filter(s=>s.span==="eighth"),e=Dr.filter(s=>s.span==="quarter"),n=document.createElement("div");if(n.className="triplet-stamps-grid",t.length>0){const s=document.createElement("div");s.className="triplet-stamps-row triplet-stamps-eighth-row",t.forEach(r=>{const i=this.createTripletStampButton(r);s.appendChild(i)}),n.appendChild(s)}if(e.length>0){const s=document.createElement("div");if(s.className="triplet-stamps-row triplet-stamps-quarter-row",e.slice(0,3).forEach(r=>{const i=this.createTripletStampButton(r);i.classList.add("triplet-stamp-button-wide"),s.appendChild(i)}),n.appendChild(s),e.length>3){const r=document.createElement("div");r.className="triplet-stamps-row triplet-stamps-quarter-row",e.slice(3).forEach(i=>{const o=this.createTripletStampButton(i);o.classList.add("triplet-stamp-button-wide"),r.appendChild(o)}),n.appendChild(r)}}A.appendChild(n),this.setInitialSelection(this.selectedTripletStampId)},createTripletStampButton(A){const t=document.createElement("button");t.className="triplet-stamp-button",t.dataset.tripletStampId=`${A.id}`,t.setAttribute("title",A.label||`Triplet ${A.id}`);const n=A.span==="quarter"?80:40,r=GE(A,n,40);return r.style.width="100%",r.style.height="100%",r.style.maxWidth="100%",r.style.maxHeight="100%",t.appendChild(r),t},bindEvents(){const A=document.getElementById("triplet-stamps-toolbar-container");A&&(A.addEventListener("click",t=>{const e=t.target?.closest(".triplet-stamp-button");if(!e)return;const n=parseInt(e.dataset.tripletStampId||"",10);Number.isNaN(n)||this.selectTripletStamp(n)}),c.on("toolChanged",({newTool:t}={})=>{t&&t!=="tripletStamp"&&this.clearSelection()}),c.on("sixteenthStampToolSelected",()=>{this.clearSelection()}))},setInitialSelection(A){this.selectedTripletStampId=A;const t=document.getElementById("triplet-stamps-toolbar-container");t&&t.querySelectorAll(".triplet-stamp-button").forEach(e=>{const n=e;n.classList.toggle("active",parseInt(n.dataset.tripletStampId||"",10)===A)})},selectTripletStamp(A){this.selectedTripletStampId=A;const t=document.getElementById("triplet-stamps-toolbar-container");t&&t.querySelectorAll(".triplet-stamp-button").forEach(e=>{const n=e;n.classList.toggle("active",parseInt(n.dataset.tripletStampId||"",10)===A)}),c.setSelectedTool("tripletStamp"),c.emit("tripletStampSelected",A),c.emit("tripletStampToolSelected")},clearSelection(){const A=document.getElementById("triplet-stamps-toolbar-container");A&&A.querySelectorAll(".triplet-stamp-button").forEach(t=>{t.classList.remove("active")})},getSelectedTripletStamp(){return Dr.find(t=>t.id===this.selectedTripletStampId)}};function WE(){xw.init(),kt.initialize?.()??kt.init?.(),Ki.init(),Os.init(),B.initSuccess("RhythmUi")}class VE{gridsWrapper=null;pitchGridWrapper=null;drumGridWrapper=null;gridScrollbarProxy=null;isInitialized=!1;lastScrollTime=0;isSyncingFromProxy=!1;isSyncingFromWrapper=!1;handleWrapperScroll;handleProxyScroll;init(){if(this.gridsWrapper=document.getElementById("grids-wrapper"),this.pitchGridWrapper=document.getElementById("pitch-grid-wrapper"),this.drumGridWrapper=document.getElementById("drum-grid-wrapper"),this.gridScrollbarProxy=document.getElementById("grid-scrollbar-proxy"),!this.gridsWrapper||!this.pitchGridWrapper||!this.drumGridWrapper){B.error("ScrollSyncService","Required elements not found for scroll sync",null,"scroll");return}this.setupScrollSynchronization(),this.isInitialized=!0,B.info("ScrollSyncService","Initialized with unified grids-wrapper structure",null,"scroll")}setupScrollSynchronization(){this.handleWrapperScroll=this.handleWrapperScrollInternal.bind(this),this.handleProxyScroll=this.handleProxyScrollInternal.bind(this),this.gridsWrapper.addEventListener("scroll",this.handleWrapperScroll,{passive:!0}),this.gridScrollbarProxy?this.gridScrollbarProxy.addEventListener("scroll",this.handleProxyScroll,{passive:!0}):B.warn("ScrollSyncService","Grid scrollbar proxy not found; falling back to native scrollbars.",null,"scroll")}handleWrapperScrollInternal(t){if(this.isSyncingFromProxy||!this.gridsWrapper)return;const e=Date.now();if(this.lastScrollTime=e,this.gridScrollbarProxy){const s=this.gridsWrapper.scrollLeft;Math.abs(this.gridScrollbarProxy.scrollLeft-s)>.5&&(this.isSyncingFromWrapper=!0,this.gridScrollbarProxy.scrollLeft=s,this.isSyncingFromWrapper=!1)}const n=t.target;B.debug("ScrollSyncService",`Unified scroll: ${n?.scrollLeft??0}px`,null,"scroll")}handleProxyScrollInternal(){if(this.isSyncingFromWrapper||!this.gridScrollbarProxy)return;const t=this.gridScrollbarProxy.scrollLeft;this.gridsWrapper&&Math.abs(this.gridsWrapper.scrollLeft-t)>.5&&(this.isSyncingFromProxy=!0,this.gridsWrapper.scrollLeft=t,this.isSyncingFromProxy=!1)}syncScrollTo(t){!this.isInitialized||!this.gridsWrapper||(this.isSyncingFromProxy=!0,this.isSyncingFromWrapper=!0,this.gridsWrapper.scrollLeft=t,this.gridScrollbarProxy&&(this.gridScrollbarProxy.scrollLeft=t),this.isSyncingFromProxy=!1,this.isSyncingFromWrapper=!1)}}const zE=new VE,Oo={stroke:"#c7cfd8",background:"rgba(207, 214, 222, 0.32)"};let Ur=null;function Kf(){if(Ur)return Ur;if(typeof window>"u")return Oo;const A=window.getComputedStyle(document.documentElement);return Ur={stroke:A.getPropertyValue("--c-anacrusis-border").trim()||Oo.stroke,background:A.getPropertyValue("--c-anacrusis-bg").trim()||Oo.background},Ur}function qE(A){if(A.length===0)return[];const t=[...A].sort((n,s)=>n.start-s.start),e=[];for(const n of t){if(e.length===0){e.push({...n});continue}const s=e[e.length-1];n.start<=s.end?s.end=Math.max(s.end,n.end):e.push({...n})}return e}function XE(A){const t=[],e=YE(c.state);return e!==null&&e>0&&t.push({start:WA(0,A),end:WA(e,A)}),A.placedTonicSigns.forEach(n=>{const s=WA(n.columnIndex,A),r=WA(n.columnIndex+2,A);t.push({start:s,end:r})}),qE(t)}function $E(A,t,e){const n=new Set([A,t]);e.forEach(i=>{const o=Math.max(A,Math.min(t,i.start)),a=Math.max(A,Math.min(t,i.end));a>o&&(n.add(o),n.add(a))});const s=Array.from(n).sort((i,o)=>i-o),r=[];for(let i=0;i<s.length-1;i++){const o=s[i],a=s[i+1],l=(o+a)/2,d=e.some(u=>l>=u.start&&l<u.end);a>o&&r.push({from:o,to:a,light:d})}return r}function YE(A){if(!A.hasAnacrusis||!Array.isArray(A.macrobeatBoundaryStyles))return null;const t=A.macrobeatBoundaryStyles.findIndex(n=>n==="solid");if(t<0)return null;const e=ge(A,t);return e?e.endColumn+1:null}function WA(A,t){return Y(A,t)}function Gf(A,t,e,n,s,r,i=1){const o=e+s/2,a=n+r/2,l=Math.min(s,r)*.4*i;if(A.beginPath(),t===0)A.moveTo(o,a-l),A.lineTo(o-l,a+l),A.lineTo(o+l,a+l),A.closePath();else if(t===1)A.moveTo(o,a-l),A.lineTo(o+l,a),A.lineTo(o,a+l),A.lineTo(o-l,a),A.closePath();else{for(let u=0;u<5;u++){const h=2*Math.PI/5*u-Math.PI/2,m=o+l*Math.cos(h),f=a+l*Math.sin(h);u===0?A.moveTo(m,f):A.lineTo(m,f)}A.closePath()}A.fill()}function JE(A,t){const{columnWidths:e,musicalColumnWidths:n,macrobeatGroupings:s,macrobeatBoundaryStyles:r,placedTonicSigns:i}=t,a=(n&&n.length>0?n:e).length,l=s.map((d,u)=>{const{endColumn:h}=ge(c.state,u);return h+1});for(let d=0;d<=a;d++){const u=d===0||d===a,h=ju(d,i),m=i.some(v=>d===v.columnIndex+2),f=l.includes(d);if(!Zu(d,i))continue;let p=null;if(u||h||m)p={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(f){const v=l.indexOf(d),C=r[v];if(C==="anacrusis"){const{stroke:F}=Kf();p={lineWidth:1,strokeStyle:F,dash:[4,4]}}else p={lineWidth:1,strokeStyle:"#adb5bd",dash:C==="solid"?[]:[5,5]}}if(!p)continue;const w=WA(d,t);A.beginPath(),A.moveTo(w,0),A.lineTo(w,Mt(A.canvas)),A.lineWidth=p.lineWidth,A.strokeStyle=p.strokeStyle,A.setLineDash(p.dash),A.stroke()}A.setLineDash([])}function jE(A,t){const{placedNotes:e,columnWidths:n,cellWidth:s,cellHeight:r,placedTonicSigns:i}=t;A.clearRect(0,0,ne(A.canvas),Mt(A.canvas));const o=Math.max(Fs,Is*r),a=n.length,l=["H","M","L"],d=XE(t),u=$E(0,ne(A.canvas),d),{stroke:h}=Kf();for(let m=0;m<4;m++){const f=m*o;u.forEach(g=>{g.to<=g.from||(A.beginPath(),A.moveTo(g.from,f),A.lineTo(g.to,f),A.strokeStyle=g.light?h:"#ced4da",A.lineWidth=1,A.globalAlpha=g.light?.6:1,A.stroke(),A.globalAlpha=1)})}JE(A,t);for(let m=0;m<a;m++){if(i.some(p=>m===p.columnIndex||m===p.columnIndex+1))continue;const f=WA(m,t);let g;t.modulationMarkers&&t.modulationMarkers.length>0?g=WA(m+1,t)-f:g=(n[m]??0)*s;for(let p=0;p<3;p++){const w=p*o,v=l[p],C=e.find(F=>F.isDrum&&(typeof F.drumTrack=="number"?String(F.drumTrack):F.drumTrack)===v&&F.startColumnIndex===m);if(C){A.fillStyle=C.color;const F=uA.getAnimationScale(m,v);Gf(A,p,f,w,g,o,F)}else A.fillStyle="#ced4da",A.beginPath(),A.arc(f+g/2,w+o/2,2,0,Math.PI*2),A.fill()}}t.modulationMarkers&&t.modulationMarkers.length>0&&fh(A,t)}const Xe={getColumnIndex(A){const{cellWidth:t,modulationMarkers:e,cellHeight:n,musicalColumnWidths:s}=c.state,r=c.state.columnWidths||[];if(t===0)return 0;const i={...c.state,modulationMarkers:e,cellWidth:t,columnWidths:r,baseMicrobeatPx:c.state.baseMicrobeatPx||t},o=na(A,i),a=Math.floor(o);return a},getPitchRowIndex(A){const t=ae.getViewportInfo();if(!t?.halfUnit||t.halfUnit===0)return-1;const e=t.halfUnit,n=Math.round(A/e-1),s=t.startRank+n,r=t.startRank,i=Math.max(r,(t.endRank??r+1)-1);return Math.max(r,Math.min(i,s))},getDrumRowIndex(A){const t=Math.max(Fs,Is*c.state.cellHeight);return t===0?-1:Math.floor(A/t)}},Kl=["H","M","L"],ZE="canvas-container",tQ="drum-grid-wrapper",Wf="eraser-tool-button",eQ="drum-grid",AQ="drum-hover-canvas";let de=null,Bi=!1,Ks=!1,zr=1,nA=null,ou=0;const nQ=500,wi=A=>{c.state.musicalColumnWidths&&c.state.musicalColumnWidths.length>0?c.state.musicalColumnWidths:c.state.columnWidths;const t={modulationMarkers:c.state.modulationMarkers||[],columnWidths:c.state.columnWidths,cellWidth:c.state.cellWidth,cellHeight:c.state.cellHeight,baseMicrobeatPx:c.state.baseMicrobeatPx||c.state.cellWidth||40};return Y(A,t)},Vf=A=>{if(c.state.modulationMarkers&&c.state.modulationMarkers.length>0){const s=wi(A);return wi(A+1)-s}return((c.state.musicalColumnWidths&&c.state.musicalColumnWidths.length>0?c.state.musicalColumnWidths:c.state.columnWidths)[A]??1)*c.state.cellWidth},vi=()=>Math.max(Fs,Is*c.state.cellHeight),Gl=()=>{de&&de.clearRect(0,0,ne(de.canvas),Mt(de.canvas))};function qa(A,t,e){if(!de)return;const n=wi(A),s=t*vi(),r=Vf(A);de.fillStyle=e,de.fillRect(n,s,r,vi())}function sQ(A,t){if(!de)return;const e=wi(A),n=t*vi(),s=Vf(A),r=Kl[t];if(!r)return;const i=uA.getAnimationScale(A,r),o=c.state.selectedTool?.color??"#212529";de.globalAlpha=.4,de.fillStyle=o,Gf(de,t,e,n,s,vi(),i),de.globalAlpha=1}const zf=()=>document.getElementById(ZE)?.scrollLeft??0;function rQ(A){const t=A.currentTarget;if(!t)return;const e=t.getBoundingClientRect(),n=A.clientX-e.left,s=A.clientY-e.top,r=Xe.getColumnIndex(n+zf()),i=Xe.getDrumRowIndex(s),o=c.state.musicalColumnWidths&&c.state.musicalColumnWidths.length>0?c.state.musicalColumnWidths.length:c.state.columnWidths.length;if(!de||r<0||r>=o||i<0||i>2){Wl();return}Gl();const a=Kl[i];a&&(Bi?(c.eraseDrumNoteAt?.(r,a,!1)&&(Ks=!0),qa(r,i,"rgba(220, 53, 69, 0.3)")):(qa(r,i,"rgba(74, 144, 226, 0.2)"),sQ(r,i)))}function Wl(){Gl()}function iQ(A){A.preventDefault();const t=A.currentTarget;if(!t)return;const e=t.getBoundingClientRect(),n=A.clientX-e.left,s=A.clientY-e.top,r=Xe.getColumnIndex(n+zf()),i=c.state.musicalColumnWidths&&c.state.musicalColumnWidths.length>0?c.state.musicalColumnWidths.length:c.state.columnWidths.length;if(r<0||r>=i||!j0(r,c.state))return;const o=Xe.getDrumRowIndex(s);if(o<0||o>2)return;const a=Kl[o];if(a){if(A.button===2){Bi=!0,Ks=!1,document.getElementById(Wf)?.classList.add("erasing-active"),c.eraseDrumNoteAt?.(r,a,!1)&&(Ks=!0),Gl(),qa(r,o,"rgba(220, 53, 69, 0.3)");return}if(A.button===0){const l=c.state.selectedTool?.color??"#000000",d={isDrum:!0,drumTrack:a,startColumnIndex:r,endColumnIndex:r,color:l,shape:a==="H"?"triangle":a==="M"?"square":"pentagon"};c.toggleDrumNote?.(d);const h=window.transportService?.drumPlayers;h?.player&&(h.player(a).start(),uA.triggerNotePop(r,a))}}}function oQ(){Bi&&(Ks&&c.recordState?.(),Bi=!1,Ks=!1,document.getElementById(Wf)?.classList.remove("erasing-active")),Wl()}function aQ(){const A=document.getElementById(tQ),t=A?.querySelector(".drum-grid-left-cell");if(!A||!t)return;let e=t.querySelector(".drum-left-content");if(!e){e=document.createElement("div"),e.className="drum-left-content";const i=e,o=document.createElement("button");o.className="drum-volume-button",o.type="button",o.setAttribute("aria-label","Drum volume"),o.innerHTML=`
      <span class="drum-volume-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" focusable="false" role="img">
          <path d="M3 10v4h4l5 5V5L7 10H3z" fill="currentColor"></path>
          <path d="M16 8.82v6.36c1.18-.85 2-2.22 2-3.64s-.82-2.79-2-3.64z" fill="currentColor"></path>
          <path d="M16 4v2c2.9 1.06 5 3.86 5 7s-2.1 5.94-5 7v2c4.01-1.15 7-4.97 7-9s-2.99-7.85-7-9z" fill="currentColor"></path>
        </svg>
      </span>
    `,o.style.gridRow="1 / span 3",o.style.gridColumn="1",["H","M","L"].forEach((a,l)=>{const d=document.createElement("span");d.className="drum-track-label",d.textContent=a,d.style.gridColumn="2",d.style.gridRow=`${l+1}`,i.appendChild(d)}),i.appendChild(o),t.appendChild(i)}const n=document.createElement("div");n.className="drum-volume-control",nA=document.createElement("input"),nA.type="range",nA.min="0",nA.max="100",nA.value="100",nA.className="drum-volume-slider",nA.style.cssText="width: 80px; margin: 0;",nA.addEventListener("input",i=>{const o=i.currentTarget;zr=Number(o.value)/100;const a=window.drumVolumeNode;if(a?.volume){const l=zr===0?-60:20*Math.log10(zr);a.volume.value=l;const u=window.transportService?.drumPlayers,h=Date.now();u?.player&&h-ou>=nQ&&(u.player("M").start("+0.1"),ou=h)}}),n.appendChild(nA),t.appendChild(n);const s=()=>{if(!n)return;n.classList.contains("visible")?n.classList.remove("visible"):n.classList.add("visible")},r=t.querySelector(".drum-volume-button");r&&r.addEventListener("click",i=>{i.stopPropagation(),s()}),document.addEventListener("click",i=>{const o=i.target,a=o?.closest(".drum-volume-control"),l=o?.closest(".drum-volume-button");!a&&!l&&n.classList.remove("visible")})}function lQ(){return zr}window.getDrumVolume=lQ;function cQ(){const A=document.getElementById(eQ),t=document.getElementById(AQ);!A||!t||(de=t.getContext("2d"),A.addEventListener("mousedown",iQ),A.addEventListener("mousemove",rQ),A.addEventListener("mouseleave",Wl),A.addEventListener("contextmenu",e=>e.preventDefault()),window.addEventListener("mouseup",oQ),aQ())}function au(){const A=Us.getDrumContext();if(!A?.canvas)return;const t={placedNotes:T0(c.state),placedTonicSigns:se(c.state),columnWidths:c.state.columnWidths,musicalColumnWidths:c.state.musicalColumnWidths,cellWidth:c.state.cellWidth,cellHeight:c.state.cellHeight,macrobeatGroupings:c.state.macrobeatGroupings,macrobeatBoundaryStyles:c.state.macrobeatBoundaryStyles,modulationMarkers:c.state.modulationMarkers,baseMicrobeatPx:c.state.cellWidth};jE(A,t)}const we={animationFrameId:null,render(){au(),uA.hasActiveAnimations()?we.animationFrameId||we.startAnimationLoop():we.stopAnimationLoop()},startAnimationLoop(){if(we.animationFrameId)return;const A=()=>{uA.cleanupAnimations(),au(),uA.hasActiveAnimations()?we.animationFrameId=requestAnimationFrame(A):we.animationFrameId=null};we.animationFrameId=requestAnimationFrame(A)},stopAnimationLoop(){we.animationFrameId&&(cancelAnimationFrame(we.animationFrameId),we.animationFrameId=null)}};window.drumGridRenderer=we;function lu(A){if(A)return A.uuid}function qf(A,t=null){const e=Array.isArray(t)?t:A.macrobeatGroupings||[],s=[...se(A)].sort((d,u)=>d.preMacrobeatIndex-u.preMacrobeatIndex);let r=0;const i=[];let o=0;const a=d=>{i.push({visualIndex:i.length,type:`legend-${d}`,timeIndex:null})},l=d=>{for(;r<s.length;){const u=s[r];if(u?.preMacrobeatIndex!==d)break;i.push({visualIndex:i.length,type:"tonic",timeIndex:null}),i.push({visualIndex:i.length,type:"tonic",timeIndex:null});const h=lu(u);if(h)do r++;while(r<s.length&&lu(s[r])===h);else r++}};return a("left"),a("left"),l(-1),e.forEach((d,u)=>{for(let h=0;h<d;h++)i.push({visualIndex:i.length,type:"time",timeIndex:o++});l(u)}),a("right"),a("right"),{entries:i,totalTimeColumns:o}}function dQ(A,t,e=null){if(e!==null){const{entries:n}=qf(A,e),s=n[t];return s?s.timeIndex:null}return $0(t,A)}function uQ(A,t,e=null){if(t==null)return null;if(e!==null){const{entries:n,totalTimeColumns:s}=qf(A,e);if(t<0||t>=s)return null;const r=n.find(i=>i.timeIndex===t);return r?r.visualIndex:null}return Y0(t,A)}let Mr=!1,bA="C4",Ci=null;function qr(){return{pitches:[],rootNote:bA,color:c.state.selectedNote?.color||"#000000"}}let Ke=qr();function hQ(){const A=document.activeElement;if(!(A instanceof HTMLElement))return!0;const t=A.tagName.toLowerCase();return!(["input","textarea","select"].includes(t)||A.isContentEditable)}function fQ(A){const t=A.globalRow??A.row,e=c.state.fullRowData[t];return e?e.toneNote:"C4"}function cu(){const A=c.state.placedNotes.slice().reverse().find(t=>!t.isDrum);bA=A?fQ(A):"C4"}function du(A){const{activeChordIntervals:t}=c.state;return!A||!t?.length?[]:t.map(e=>{const n=vn(A,e);return ss(n)})}function gQ(){cu(),c.on("notesChanged",cu),document.addEventListener("keydown",A=>{if(A.code!=="Enter"||Mr||A.repeat||!hQ())return;A.preventDefault(),Mr=!0;const t=c.state.selectedNote?.color;let e,n=[];if(Ci&&t){const s=c.state.fullRowData[Ci.row];e=s?s.toneNote:bA,c.state.selectedTool==="chord"?n=du(e):n=[e]}else t&&bA&&(e=bA,c.state.selectedTool==="chord"?n=du(bA):n=[bA]);if(n.length>0&&t&&e){Ke={pitches:[...n],rootNote:e,color:t},n.forEach(l=>{St.triggerAttack(l,t)});const s=c.state.fullRowData.find(l=>l.toneNote===e),r=s?s.hex:"#888888",i=c.state.timbres[t];if(!i)return;const o=i.adsr;Fe.adsrComponent?.playheadManager.trigger("spacebar","attack",r,o),c.emit("spacebarPlayback",{note:e,color:t,isPlaying:!0});const a=`spacebar-${Date.now()}`;c.emit("noteAttack",{noteId:a,color:t}),Ke.noteId=a}}),document.addEventListener("keyup",A=>{if(A.code!=="Enter"||!Mr)return;A.preventDefault(),Mr=!1;const t=Ke.pitches;if(!Array.isArray(t)||t.length===0){Ke=qr();return}const e=Ke.color;if(e){t.forEach(a=>{St.triggerRelease(a,e)});const n=Ke.rootNote??bA,s=c.state.fullRowData.find(a=>a.toneNote===n),r=s?s.hex:"#888888",i=c.state.timbres[e];if(!i){Ke=qr();return}const o=i.adsr;Fe.adsrComponent?.playheadManager.trigger("spacebar","release",r,o),c.emit("spacebarPlayback",{note:n,color:e,isPlaying:!1}),Ke.noteId&&c.emit("noteRelease",{noteId:Ke.noteId,color:e})}Ke=qr()})}function Xf(A,t){Ci={col:A,row:t};const e=c.state.selectedNote?.color;e&&c.emit("ghostNoteUpdated",{color:e})}function $f(){Ci=null,c.emit("ghostNoteCleared")}const mQ={single:40,chord:20,transient:30};function Yf(A){return String(A)}function pQ(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}const uu={single:0,chord:0,transient:0},IA=new Map;function hu(A,t){const e=Yf(t),n=IA.get(A)??new Set;n.add(e),IA.set(A,n)}function fu(A,t){const e=IA.get(A);e&&(e.delete(Yf(t)),e.size===0&&IA.delete(A))}const ce={shouldPlayPreview(A){const t=pQ(),e=mQ[A],n=uu[A];return t-n<e?!1:(uu[A]=t,!0)},triggerAttack(A,t,e={}){const n=e.kind??"single";return!e.bypassThrottle&&!this.shouldPlayPreview(n)?!1:(St.triggerAttack(A,t),hu(t,A),!0)},triggerAttacks(A,t,e={}){const n=e.kind??"chord";return!e.bypassThrottle&&!this.shouldPlayPreview(n)?!1:(A.forEach(s=>{St.triggerAttack(s,t),hu(t,s)}),!0)},triggerRelease(A,t){St.triggerRelease(A,t),fu(t,A)},releasePitches(A,t){A.forEach(e=>{this.triggerRelease(e,t)})},quickReleasePitches(A,t){!A||A.length===0||(St.quickReleasePitches(A,t),A.forEach(e=>fu(t,e)))},playTransient(A,t,e=100){this.triggerAttack(A,t,{kind:"transient"})&&setTimeout(()=>this.triggerRelease(A,t),e)},releaseAll(A){if(typeof A=="string"){const t=IA.get(A);if(!t)return;Array.from(t.values()).forEach(e=>{St.triggerRelease(e,A)}),IA.delete(A);return}for(const[t,e]of IA.entries())Array.from(e.values()).forEach(n=>{St.triggerRelease(n,t)});IA.clear()}};class BQ{isDragging=!1;draggedModulationMarker=null;lastModulationHoverResult=null;handleMouseDown(t,e){for(const n of c.state.modulationMarkers||[]){const s=n.xCanvas??n.xPosition??0,r=Mc(t,e,{...n,xCanvas:s});if(r){if(r.type==="label"){const i=n.ratio===Ce.COMPRESSION_2_3?Ce.EXPANSION_3_2:Ce.COMPRESSION_2_3;return c.setModulationRatio(n.id,i),!0}if(r.type==="barline"&&r.canDrag)return this.isDragging=!0,this.draggedModulationMarker=n,document.body.style.cursor=Tc(r),!0}}return!1}handlePlacementClick(t,e){if(c.state.selectedTool!=="modulation")return!1;const n=c.state.selectedModulationRatio;if(typeof n!="number")return B.warn("PitchGridModulationToolInteractor","No modulation ratio selected before placement",null,"grid"),!0;const s=e(t);if(!s)return B.warn("PitchGridModulationToolInteractor","Modulation placement must be near a measure boundary",{clickX:t},"grid"),!0;B.debug("PitchGridModulationToolInteractor","Placing modulation marker at boundary",{measureIndex:s.measureIndex,ratio:n,clickX:t,boundaryX:s.xPosition},"grid");const r=c.addModulationMarker(s.measureIndex,n,s.xPosition,null,s.macrobeatIndex);return B.debug("PitchGridModulationToolInteractor","Modulation marker placed",{markerId:r,measureIndex:s.measureIndex,ratio:n},"grid"),!0}handleMouseMove(t){if(!this.isDragging||!this.draggedModulationMarker)return!1;const e=c.state.baseMicrobeatPx||c.state.cellWidth||40,n=Math.round(t/e)*e;return c.moveModulationMarker(this.draggedModulationMarker.id,n),!0}getHoveredMarker(t,e){for(const n of c.state.modulationMarkers||[]){const s=n.xCanvas??n.xPosition??0,r=Mc(t,e,{...n,xCanvas:s});if(r)return r}return null}updateCursor(t,e){if(e){t.style.cursor=Tc(e),this.lastModulationHoverResult=e;return}this.lastModulationHoverResult&&(t.style.cursor="default",this.lastModulationHoverResult=null)}handleMouseUp(){return this.isDragging?(this.isDragging=!1,this.draggedModulationMarker=null,!0):!1}}class wQ{handleExistingNoteMouseDown(t,e,n,s){if(c.state.selectedTool!=="note")return{handled:!1,state:n};const r=c.state.placedNotes.find(u=>!u.isDrum&&u.row===e&&t>=u.startColumnIndex&&t<=u.endColumnIndex);if(!r)return{handled:!1,state:n};const i=s.getPitchForRow(e);if(!i)return{handled:!0,state:n};const o=window.waveformVisualizer;o&&(o.currentColor=r.color,o.generateWaveform(),o.startSingleNoteVisualization(r.color));const a=kt.getSixteenthStampAtPosition(t,e);if(a)return kt.playRhythmPattern(a.sixteenthStampId,i,r.color,r.shape,a),{handled:!0,state:{...n,activePreviewPitches:[i],activeNote:r}};ce.triggerAttack(i,r.color,{kind:"single",bypassThrottle:!0});const l=c.state.fullRowData[e]?.hex||"#888888",d=c.state.timbres[r.color]?.adsr;return d&&Fe.adsrComponent?.playheadManager.trigger(r.uuid,"attack",l,d),{handled:!0,state:{...n,activePreviewPitches:[i],activeNote:r}}}attemptPlaceNoteAt(t,e,n,s,r){if(c.state.selectedTool!=="note")return{placed:!1,state:n,shouldStartDragging:!1};if(!Ms(t,c.state))return{placed:!1,state:n,shouldStartDragging:!1};const i=c.state.selectedNote;if(!i)return{placed:!1,state:n,shouldStartDragging:!1};const{shape:o,color:a}=i;if(o==="circle"&&!Ms(t+1,c.state))return{placed:!1,state:n,shouldStartDragging:!1};const l=o==="circle"?t+1:t,d={row:e,startColumnIndex:t,endColumnIndex:l,color:a,shape:o,isDrum:!1},u=c.addNote(d);if(!u)return{placed:!1,state:n,shouldStartDragging:!1};const h={...n,activeNote:u,lastDragRow:e};u.uuid&&c.emit("noteInteractionStart",{noteId:u.uuid,color:u.color});const m=r.getPitchForRow(e);if(m){u.uuid&&(s.add(u.uuid),c.emit("noteAttack",{noteId:u.uuid,color:u.color})),h.activePreviewPitches=[m],ce.triggerAttack(m,u.color,{kind:"single",bypassThrottle:!0});const f=c.state.fullRowData[e]?.hex||"#888888",g=c.state.timbres[u.color]?.adsr;g&&Fe.adsrComponent?.playheadManager.trigger(u.uuid,"attack",f,g);const p=window.waveformVisualizer;p&&(p.currentColor=u.color,p.generateWaveform(),p.startSingleNoteVisualization(u.color))}return{placed:!0,state:h,shouldStartDragging:!0}}handleActiveNoteDrag(t,e,n,s){const r=n.activeNote;if(!r)return n;const i=t,o=e,a=r.uuid;if(r.shape==="circle"){if(i!==r.endColumnIndex&&c.updateNoteTail(r,i),o!==n.lastDragRow){const l=s.getPitchForRow(o);if(!l)return n;n.activePreviewPitches.length>0&&ce.quickReleasePitches(n.activePreviewPitches,r.color);const d=c.state.placedNotes.find(p=>p.uuid===a);d&&c.updateNoteRow(d,o);const h=c.state.placedNotes.find(p=>p.uuid===a)||d||r;let m=n.activePreviewPitches;ce.triggerAttack(l,h.color,{kind:"single"})&&(m=[l]);const f=c.state.fullRowData[o]?.hex||"#888888",g=c.state.timbres[h.color]?.adsr;return g&&h.uuid&&Fe.adsrComponent?.playheadManager.trigger(h.uuid,"attack",f,g),{...n,activeNote:h,lastDragRow:o,activePreviewPitches:m}}return n}if(r.shape==="oval"){const l=t;if(l!==r.startColumnIndex&&c.updateNotePosition(r,l),o!==n.lastDragRow){const d=s.getPitchForRow(o);if(!d)return n;n.activePreviewPitches.length>0&&ce.quickReleasePitches(n.activePreviewPitches,r.color);const u=c.state.placedNotes.find(w=>w.uuid===a);u&&c.updateNoteRow(u,o);const m=c.state.placedNotes.find(w=>w.uuid===a)||u||r;let f=n.activePreviewPitches;ce.triggerAttack(d,m.color,{kind:"single"})&&(f=[d]);const g=c.state.fullRowData[o]?.hex||"#888888",p=c.state.timbres[m.color]?.adsr;return p&&m.uuid&&Fe.adsrComponent?.playheadManager.trigger(m.uuid,"attack",g,p),{...n,activeNote:m,lastDragRow:o,activePreviewPitches:f}}}return n}}class vQ{handleMouseDown(t,e){if(c.state.selectedTool!=="eraser")return{handled:!1,shouldStartDrag:!1};c.eraseInPitchArea(t,e,2,!1);const n=t+2-1,s=e-1,r=e+1;return P1(t,n,s,r),N1(t,n,s,r),{handled:!0,shouldStartDrag:!0}}handleMouseMove(t,e,n){if(!n)return!1;c.eraseInPitchArea(t,e,2,!1);const s=t+2-1,r=e-1,i=e+1;return c.eraseSixteenthStampsInArea(t,s,r,i),c.eraseTripletStampsInArea(t,s,r,i),!0}}class CQ{handleMouseDown(t,e,n,s,r){if(c.state.selectedTool!=="chord")return{handled:!1,state:n,shouldStartDragging:!1};if(!Ms(t,c.state))return{handled:!0,state:n,shouldStartDragging:!1};const i=r.getPitchForRow(e);if(!i)return{handled:!0,state:n,shouldStartDragging:!1};const o=r.getChordPitchesForRootPitch(i),a=c.state.selectedNote;if(!a)return{handled:!0,state:n,shouldStartDragging:!1};const{shape:l,color:d}=a;ce.triggerAttacks(o,d,{kind:"chord",bypassThrottle:!0});const u=c.state.fullRowData[e]?.hex||"#888888",h=c.state.timbres[d]?.adsr;h&&Fe.adsrComponent?.playheadManager.trigger("chord_preview","attack",u,h);const m=[];return o.forEach(f=>{const g=c.state.fullRowData.findIndex(C=>C.toneNote===f);if(g===-1)return;const p=l==="circle"?t+1:t,w={row:g,startColumnIndex:t,endColumnIndex:p,color:d,shape:l,isDrum:!1},v=c.addNote(w);v&&(m.push(v),v.uuid&&(s.add(v.uuid),c.emit("noteAttack",{noteId:v.uuid,color:v.color}),c.emit("noteInteractionStart",{noteId:v.uuid,color:v.color})))}),{handled:!0,shouldStartDragging:!0,state:{...n,activeChordNotes:m,activePreviewPitches:[...o],lastDragRow:e}}}handleActiveChordDrag(t,e,n,s){if(!n.activeChordNotes||n.activeChordNotes.length===0)return n;const r=n.activeChordNotes[0];if(!r)return n;const i=r.color,o=e;if(r.shape==="circle"){const a=t,l=n.activeChordNotes.filter(d=>a!==d.endColumnIndex);if(l.length>0&&c.updateMultipleNoteTails(l,a),o!==n.lastDragRow){const d=n.lastDragRow??r.row,u=o-d;if(u===0)return n;ce.quickReleasePitches(n.activePreviewPitches,i);const h=n.activeChordNotes.map(g=>g.row+u);if(!h.every(g=>s.getPitchForRow(g)!==null))return n;c.updateMultipleNoteRows(n.activeChordNotes,h);const f=h.map(g=>s.getPitchForRow(g)).filter(g=>typeof g=="string");return ce.triggerAttacks(f,i,{kind:"chord"}),{...n,activePreviewPitches:f,lastDragRow:o}}return n}if(r.shape==="oval"){const a=t,l=n.activeChordNotes.filter(g=>a!==g.startColumnIndex);l.length>0&&c.updateMultipleNotePositions(l,a);const d=n.lastDragRow!==null?n.lastDragRow:r.row,u=o-d;if(u===0)return n;ce.quickReleasePitches(n.activePreviewPitches,i);const h=n.activeChordNotes.map(g=>g.row+u);if(!h.every(g=>s.getPitchForRow(g)!==null))return n;c.updateMultipleNoteRows(n.activeChordNotes,h);const f=h.map(g=>s.getPitchForRow(g)).filter(g=>typeof g=="string");return ce.triggerAttacks(f,i,{kind:"chord"}),{...n,activePreviewPitches:f,lastDragRow:o}}return n}}function bQ(A,t,e,n){const s=xi(e.sixteenthStampId);if(!s)return null;const r=Y(e.startColumn,n),i=n.cellWidth*2,o=n.cellHeight,a=[.125,.375,.625,.875].map(l=>r+l*i);for(const l of s.diamonds){const d=`diamond_${l}`,u=e.shapeOffsets?.[d]||0,h=e.row+u,m=ut(h,n),f=a[l];if(f===void 0)continue;const g=Math.sqrt(Math.pow(A-f,2)+Math.pow(t-m,2)),p=Math.min(i*.2,o*1);if(g<p)return{type:"diamond",slot:l??0,shapeKey:d,cx:f,cy:m,placement:e}}for(const l of s.ovals){const d=`oval_${l}`,u=e.shapeOffsets?.[d]||0,h=e.row+u,m=ut(h,n),f=l===0?r+.25*i:r+.75*i,g=Math.sqrt(Math.pow(A-f,2)+Math.pow(t-m,2)),p=Math.min(i*.25,o*1);if(g<p)return{type:"oval",slot:l,shapeKey:d,cx:f,cy:m,placement:e}}return null}function gu(A,t,e,n){for(const s of e){const r=bQ(A,t,s,n);if(r)return r}return null}class yQ{draggedStampShape=null;isDraggingShape(){return this.draggedStampShape!==null}tryStartShapeDrag(t){const e=c.getAllSixteenthStampPlacements(),n={...c.state},s=gu(t.actualX,t.canvasY,e,n);return s?(this.draggedStampShape={...s,startRow:c.getSixteenthStampShapeRow(s.placement,s.shapeKey),startMouseY:t.canvasY},!0):!1}handleMouseDown(t){if(this.tryStartShapeDrag({actualX:t.actualX,canvasY:t.canvasY}))return{handled:!0};if(c.state.selectedTool!=="sixteenthStamp")return{handled:!1};const e=kt.getSixteenthStampAtPosition(t.colIndex,t.rowIndex);if(e){const l=t.getPitchForRow(t.rowIndex);if(!l)return{handled:!0};const d=c.state.placedNotes.find(h=>!h.isDrum&&h.row===t.rowIndex&&t.colIndex>=h.startColumnIndex&&t.colIndex<=h.endColumnIndex),u=d?d.shape:"oval";return kt.playRhythmPattern(e.sixteenthStampId,l,e.color,u,e),{handled:!0,activePreviewPitches:[l]}}const n=Ki.getSelectedSixteenthStamp();if(!n)return{handled:!0};const s=t.getTimeAlignedCanvasColumn(t.colIndex);if(s===null)return{handled:!0};const r=c.state.selectedNote;if(!r)return{handled:!0};const{color:i,shape:o}=r;T1(n.id,s,t.rowIndex,i);const a=t.getPitchForRow(t.rowIndex);return a?(kt.playRhythmPattern(n.id,a,i,o),c.recordState(),{handled:!0,activePreviewPitches:[a]}):(c.recordState(),{handled:!0})}handleMouseMove(t){if(!this.draggedStampShape)return!1;const e=t.rowIndex-this.draggedStampShape.placement.row;if(c.updateSixteenthStampShapeOffset(this.draggedStampShape.placement.id,this.draggedStampShape.shapeKey,e),t.rowIndex!==this.draggedStampShape.startRow){const n=t.getPitchForRow(t.rowIndex);if(n){const s=this.draggedStampShape.placement.color||c.state.selectedNote?.color;s&&ce.playTransient(n,s,100)}this.draggedStampShape.startRow=t.rowIndex}return t.canvasEl&&(t.canvasEl.style.cursor="ns-resize"),!0}updateHoverCursor(t){if(c.state.selectedTool!=="sixteenthStamp"||this.draggedStampShape)return;const e=t.canvasEl;if(!e)return;const n=c.getAllSixteenthStampPlacements(),s={...c.state};gu(t.actualX,t.canvasY,n,s)||SQ(t.actualX,t.canvasY,n,s)?e.style.cursor="grab":e.style.cursor="default"}handleMouseUp(){if(!this.draggedStampShape)return!1;this.draggedStampShape=null,c.recordState();const t=document.getElementById("notation-grid");return t&&(t.style.cursor="default"),!0}}function SQ(A,t,e,n){const s=n.columnWidths||[];for(const r of e){const i=r.startColumn,o=Math.min(r.endColumn,s.length),a=Y(i,n),l=Y(o,n),u=ut(r.row,n)-n.cellHeight/2;if(A>=a&&A<=l&&t>=u&&t<=u+n.cellHeight)return!0}return!1}function EQ(A,t,e,n){const s=Ui(e.tripletStampId);if(!s)return null;const r=e.span*2,i=pe(e.startTimeIndex,c.state),o=i+r,a=Y(i,n),d=Y(o,n)-a,u=n.cellHeight;for(const h of s.hits){const m=`triplet_${h}`,f=e.shapeOffsets?.[m]||0,g=e.row+f,p=ut(g,n),w=uh[h];if(w===void 0)continue;const v=a+d*w/100,C=Math.sqrt(Math.pow(A-v,2)+Math.pow(t-p,2)),F=Math.min(d*.15,u*1);if(C<F)return{type:"tripletStamp",slot:h,shapeKey:m,cx:v,cy:p,placement:e}}return null}function mu(A,t,e,n){for(const s of e){const r=EQ(A,t,s,n);if(r)return r}return null}class QQ{draggedTripletShape=null;isDraggingShape(){return this.draggedTripletShape!==null}tryStartShapeDrag(t){const e=c.getAllTripletStampPlacements(),n={...c.state},s=mu(t.actualX,t.canvasY,e,n);return s?(this.draggedTripletShape={...s,startRow:c.getTripletStampShapeRow(s.placement,s.shapeKey),startMouseY:t.canvasY},!0):!1}handleMouseDown(t){if(this.tryStartShapeDrag({actualX:t.actualX,canvasY:t.canvasY}))return{handled:!0};if(c.state.selectedTool!=="tripletStamp")return{handled:!1};const e=PA(t.colIndex,c.state);if(e===null)return{handled:!0};const n=e,s=kt.getTripletStampAtPosition(n,t.rowIndex);if(s){const a=t.getPitchForRow(t.rowIndex);return a?(kt.playTripletPattern(s.tripletStampId,a,s.color,s),{handled:!0,activePreviewPitches:[a]}):{handled:!0}}const r=Os.getSelectedTripletStamp();if(!r||!c.state.selectedNote)return{handled:!0};const i=H1(r.id,n,t.rowIndex,c.state.selectedNote.color),o=t.getPitchForRow(t.rowIndex);return o&&i?(kt.playTripletPattern(r.id,o,c.state.selectedNote.color,i),c.recordState(),{handled:!0,activePreviewPitches:[o]}):(c.recordState(),{handled:!0})}handleMouseMove(t){if(!this.draggedTripletShape)return!1;const e=t.rowIndex-this.draggedTripletShape.placement.row;if(c.updateTripletStampShapeOffset(this.draggedTripletShape.placement.id,this.draggedTripletShape.shapeKey,e),t.rowIndex!==this.draggedTripletShape.startRow){const n=t.getPitchForRow(t.rowIndex);if(n){const s=this.draggedTripletShape.placement.color||c.state.selectedNote?.color;s&&ce.playTransient(n,s,100)}this.draggedTripletShape.startRow=t.rowIndex}return t.canvasEl&&(t.canvasEl.style.cursor="ns-resize"),!0}updateHoverCursor(t){if(c.state.selectedTool!=="tripletStamp"||this.draggedTripletShape)return;const e=t.canvasEl;if(!e)return;const n=c.getAllTripletStampPlacements(),s={...c.state};mu(t.actualX,t.canvasY,n,s)||FQ(t.actualX,t.canvasY,n,s)?e.style.cursor="grab":e.style.cursor="default"}handleMouseUp(){if(!this.draggedTripletShape)return!1;this.draggedTripletShape=null,c.recordState();const t=document.getElementById("notation-grid");return t&&(t.style.cursor="default"),!0}}function FQ(A,t,e,n){for(const s of e){const r=s.span*2,i=pe(s.startTimeIndex,c.state),o=i+r,a=Y(i,n),l=Y(o,n),u=ut(s.row,n)-n.cellHeight/2;if(A>=a&&A<=l&&t>=u&&t<=u+n.cellHeight)return!0}return!1}function IQ(A){const{macrobeatGroupings:t,macrobeatBoundaryStyles:e,columnWidths:n}=c.state,s=n.length;if(A<0||A>=s)return null;let r=-1;for(let u=0;u<t.length;u++){const{startColumn:h,endColumn:m}=ge(c.state,u);if(A>=h&&A<=m){r=u;break}}if(r===-1)return null;let i=0;for(let u=r-1;u>=0;u--)if(e[u]==="solid"){i=u+1;break}const o=i-1;return(u=>u<=0?!0:e[u-1]==="solid")(i)?{drawColumn:ge(c.state,i).startColumn,preMacrobeatIndex:o}:null}function pu(A){return A.replace(/\d+$/,"")}class xQ{lastHoveredTonicPoint=null;lastHoveredOctaveRows=[];resetHoverState(){this.lastHoveredTonicPoint=null,this.lastHoveredOctaveRows=[]}handleMouseMove(t){if(c.state.selectedTool!=="tonicization")return(this.lastHoveredTonicPoint||this.lastHoveredOctaveRows.length>0)&&this.resetHoverState(),!1;const e=IQ(t.colIndex);if(!e)return this.resetHoverState(),!0;if(se(c.state).some(d=>d.preMacrobeatIndex===e.preMacrobeatIndex))return this.resetHoverState(),!0;const r=t.getPitchForRow(t.rowIndex);if(!r)return this.resetHoverState(),!0;const i=pu(r),o=iA.map((d,u)=>({rowData:d,masterIndex:u})).filter(({rowData:d})=>d.toneNote&&pu(d.toneNote)===i).map(({masterIndex:d})=>d);this.lastHoveredTonicPoint=e,this.lastHoveredOctaveRows=o;const a=o.filter(d=>d>=0&&d<c.state.fullRowData.length);t.hoverCtx.globalAlpha=.5;const l={...c.state,zoomLevel:ae.getViewportInfo().zoomLevel};return a.forEach(d=>{const u={row:d,globalRow:d,columnIndex:e.drawColumn,tonicNumber:c.state.selectedToolTonicNumber,preMacrobeatIndex:e.preMacrobeatIndex};ch(t.hoverCtx,l,u)}),t.hoverCtx.globalAlpha=1,!0}handleMouseDown(){if(c.state.selectedTool!=="tonicization")return!1;if(!this.lastHoveredTonicPoint||this.lastHoveredOctaveRows.length===0)return!0;const t=this.lastHoveredTonicPoint;if(se(c.state).some(r=>r.preMacrobeatIndex===t.preMacrobeatIndex))return this.resetHoverState(),!0;const s=this.lastHoveredOctaveRows.map(r=>({row:r,tonicNumber:c.state.selectedToolTonicNumber,preMacrobeatIndex:t.preMacrobeatIndex,columnIndex:t.drawColumn}));return c.addTonicSignGroup(s),this.resetHoverState(),!0}}class UQ{constructor(t){this.deps=t}handleToolMouseDown(t){const{toolType:e,colIndex:n,rowIndex:s,actualX:r,canvasY:i}=t,o=t.state;if(e==="chord"){const a=this.deps.chordToolInteractor.handleMouseDown(n,s,{activeChordNotes:o.activeChordNotes,lastDragRow:o.lastDragRow,activePreviewPitches:o.activePreviewPitches},this.deps.placementFillNoteIds,{getPitchForRow:this.deps.getPitchForRow,getChordPitchesForRootPitch:this.deps.getChordPitchesForRootPitch});return{handled:a.handled,state:{...o,isDragging:a.shouldStartDragging?!0:o.isDragging,activeChordNotes:a.state.activeChordNotes,lastDragRow:a.state.lastDragRow,activePreviewPitches:a.state.activePreviewPitches}}}if(e==="tonicization")return this.deps.tonicizationToolInteractor.handleMouseDown(),{handled:!0,state:o};if(e==="eraser"){const a=this.deps.eraserToolInteractor.handleMouseDown(n,s);return{handled:a.handled,state:{...o,isEraserDragActive:a.handled?a.shouldStartDrag:o.isEraserDragActive}}}if(e==="sixteenthStamp"){const a=this.deps.stampToolInteractor.handleMouseDown({colIndex:n,rowIndex:s,actualX:r,canvasY:i,getPitchForRow:this.deps.getPitchForRow,getTimeAlignedCanvasColumn:this.deps.getTimeAlignedCanvasColumn});return{handled:a.handled,state:{...o,activePreviewPitches:a.activePreviewPitches??o.activePreviewPitches}}}if(e==="tripletStamp"){const a=this.deps.tripletToolInteractor.handleMouseDown({colIndex:n,rowIndex:s,actualX:r,canvasY:i,getPitchForRow:this.deps.getPitchForRow});return{handled:a.handled,state:{...o,activePreviewPitches:a.activePreviewPitches??o.activePreviewPitches}}}if(e==="modulation")return this.deps.modulationToolInteractor.handlePlacementClick(r,this.deps.findNearestMeasureBoundary),{handled:!0,state:o};if(e==="note"){const a=this.deps.noteToolInteractor.attemptPlaceNoteAt(n,s,{activeNote:o.activeNote,lastDragRow:o.lastDragRow,activePreviewPitches:o.activePreviewPitches},this.deps.placementFillNoteIds,{getPitchForRow:this.deps.getPitchForRow});return{handled:!0,state:{...o,isDragging:a.placed&&a.shouldStartDragging?!0:o.isDragging,activeNote:a.state.activeNote,lastDragRow:a.state.lastDragRow,activePreviewPitches:a.state.activePreviewPitches}}}return{handled:!1,state:o}}handleToolMouseMoveBeforeBoundsCheck(t){const{actualX:e,rowIndex:n,canvasEl:s,state:r}=t;return this.deps.modulationToolInteractor.handleMouseMove(e)?{handled:!0,state:r}:this.deps.stampToolInteractor.handleMouseMove({rowIndex:n,canvasEl:s,getPitchForRow:this.deps.getPitchForRow})?{handled:!0,state:r}:this.deps.tripletToolInteractor.handleMouseMove({rowIndex:n,canvasEl:s,getPitchForRow:this.deps.getPitchForRow})?{handled:!0,state:r}:{handled:!1,state:r}}handleNoteOrChordDragMouseMove(t){const{colIndex:e,rowIndex:n}=t,s=t.state;if(!s.isDragging||!s.activeNote&&s.activeChordNotes.length===0)return{handled:!1,state:s};if(s.activeNote){const i=this.deps.noteToolInteractor.handleActiveNoteDrag(e,n,{activeNote:s.activeNote,lastDragRow:s.lastDragRow,activePreviewPitches:s.activePreviewPitches},{getPitchForRow:this.deps.getPitchForRow});return{handled:!0,state:{...s,activeNote:i.activeNote,lastDragRow:i.lastDragRow,activePreviewPitches:i.activePreviewPitches}}}const r=this.deps.chordToolInteractor.handleActiveChordDrag(e,n,{activeChordNotes:s.activeChordNotes,lastDragRow:s.lastDragRow,activePreviewPitches:s.activePreviewPitches},{getPitchForRow:this.deps.getPitchForRow});return{handled:!0,state:{...s,activeChordNotes:r.activeChordNotes,lastDragRow:r.lastDragRow,activePreviewPitches:r.activePreviewPitches}}}handleToolHoverVisuals(t){const{toolType:e,actualX:n,canvasY:s,pitchHoverCtx:r,canvasEl:i}=t;e==="sixteenthStamp"?this.deps.stampToolInteractor.updateHoverCursor({actualX:n,canvasY:s,canvasEl:i}):e==="tripletStamp"&&this.deps.tripletToolInteractor.updateHoverCursor({actualX:n,canvasY:s,canvasEl:i});const o=this.deps.modulationToolInteractor.getHoveredMarker(n,s);if(e==="modulation"&&!o&&r){const a=t.findNearestMeasureBoundary(n),l=t.selectedModulationRatio;a&&typeof l=="number"&&t.drawModulationPreview(r,a.xPosition,l)}i&&this.deps.modulationToolInteractor.updateCursor(i,o)}handleToolMouseUp(){return!!(this.deps.stampToolInteractor.handleMouseUp()||this.deps.tripletToolInteractor.handleMouseUp()||this.deps.modulationToolInteractor.handleMouseUp())}handleChordToolHover(t){if(c.state.selectedTool!=="chord")return!1;const e=this.deps.getPitchForRow(t.rowIndex);if(!e)return!0;const n=this.deps.getChordPitchesForRootPitch(e),s=c.state.selectedNote;if(!s)return!0;const{shape:r,color:i}=s;return t.pitchHoverCtx.globalAlpha=.4,n.forEach(o=>{const a=c.state.fullRowData.findIndex(h=>h.toneNote===o);if(a<=-1)return;const l=r==="circle"?t.colIndex+1:t.colIndex,d={row:a,startColumnIndex:t.colIndex,endColumnIndex:l,color:i,shape:r,isDrum:!1},u={...c.state,zoomLevel:t.zoomLevel};r==="oval"?t.drawSingleColumnOvalNote(t.pitchHoverCtx,u,d,a):t.drawTwoColumnOvalNote(t.pitchHoverCtx,u,d,a)}),t.pitchHoverCtx.globalAlpha=1,!0}}class MQ{isActive=!1;actionTaken=!1;previousTool=null;getIsActive(){return this.isActive}handleMouseDown(t){const{event:e,colIndex:n,rowIndex:s,annotationService:r}=t;if(e.button!==2)return!1;e.preventDefault(),this.isActive=!0,this.actionTaken=!1,c.state.selectedTool!=="eraser"&&(this.previousTool=c.state.selectedTool,c.setSelectedTool("eraser")),fA.get("eraserButton")?.classList.add("erasing-active"),this.actionTaken||=!!c.eraseInPitchArea(n,s,2,!1),this.actionTaken||=!!c.eraseTonicSignAt(n,!1);const i=n+2-1,o=s-1,a=s+1;this.actionTaken||=!!c.eraseSixteenthStampsInArea(n,i,o,a),this.actionTaken||=!!c.eraseTripletStampsInArea(n,i,o,a);const l=e.target instanceof Element?e.target:null;if(l){const d=l.getBoundingClientRect(),u=e.clientX-d.left,h=e.clientY-d.top;this.actionTaken||=!!r.eraseAtPoint(u,h)}return!0}handleMouseMove(t){if(!this.isActive)return!1;const{event:e,colIndex:n,rowIndex:s,annotationService:r}=t;this.actionTaken||=!!c.eraseInPitchArea(n,s,2,!1),this.actionTaken||=!!c.eraseTonicSignAt(n,!1);const i=n+2-1,o=s-1,a=s+1;this.actionTaken||=!!c.eraseSixteenthStampsInArea(n,i,o,a),this.actionTaken||=!!c.eraseTripletStampsInArea(n,i,o,a);const l=e.target instanceof Element?e.target:null;if(l){const d=l.getBoundingClientRect(),u=e.clientX-d.left,h=e.clientY-d.top;this.actionTaken||=!!r.eraseAtPoint(u,h)}return!0}handleGlobalMouseUp(){return this.isActive?(this.actionTaken&&c.recordState(),this.isActive=!1,this.actionTaken=!1,this.previousTool&&(c.setSelectedTool(this.previousTool),this.previousTool=null),fA.get("eraserButton")?.classList.remove("erasing-active"),!0):!1}}class TQ{constructor(t,e){this.deps=t,this.options=e}pitchCanvasElement=null;mobileLongPressTimer=null;mobileTouchState=null;mobileGhostActive=!1;setPitchCanvasElement(t){this.pitchCanvasElement=t}handleTouchStart(t){if(!this.deps.shouldUseMobileLongPress()||this.mobileTouchState)return;const e=t.changedTouches?.[0];if(!e)return;const n=this.getTouchGridPosition(e);!n||!this.deps.isPositionWithinPitchGrid(n.colIndex,n.rowIndex)||(t.preventDefault(),this.mobileTouchState={identifier:e.identifier,colIndex:n.colIndex,rowIndex:n.rowIndex},this.mobileLongPressTimer=window.setTimeout(()=>{this.activateMobileGhostPreview()},this.options.longPressDelayMs))}handleTouchMove(t){if(!this.mobileTouchState)return;const e=this.findTouchById(t.changedTouches,this.mobileTouchState.identifier)||this.findTouchById(t.touches,this.mobileTouchState.identifier);if(!e)return;const n=this.getTouchGridPosition(e);if(!n){this.resetMobileTouchState({clearOverlay:this.mobileGhostActive});return}if(!this.deps.isPositionWithinPitchGrid(n.colIndex,n.rowIndex)){this.resetMobileTouchState({clearOverlay:this.mobileGhostActive});return}t.preventDefault(),this.mobileTouchState.colIndex=n.colIndex,this.mobileTouchState.rowIndex=n.rowIndex,this.mobileGhostActive&&this.renderMobileGhostPreview()}handleTouchEnd(t){if(!this.mobileTouchState||!this.findTouchById(t.changedTouches,this.mobileTouchState.identifier))return;t.preventDefault();const n=this.mobileGhostActive,s=this.mobileTouchState.colIndex,r=this.mobileTouchState.rowIndex;if(this.resetMobileTouchState(),!n||this.deps.getSelectedTool()!=="note")return;this.deps.attemptPlaceNoteAt(s,r)?this.deps.onNotePlaced():this.deps.onNoteNotPlaced()}handleTouchCancel(){this.resetMobileTouchState({clearOverlay:this.mobileGhostActive})}getTouchGridPosition(t){if(!this.pitchCanvasElement)return null;const e=this.pitchCanvasElement.getBoundingClientRect(),n=t.clientX-e.left,s=t.clientY-e.top,r=document.getElementById("canvas-container")?.scrollLeft??0,i=Xe.getColumnIndex(n+r),o=Xe.getPitchRowIndex(s);return{colIndex:i,rowIndex:o}}findTouchById(t,e){if(!t)return null;for(let n=0;n<t.length;n++){const s=t.item(n);if(s&&s.identifier===e)return s}return null}renderMobileGhostPreview(){const t=this.deps.getPitchHoverCtx();!t||!this.mobileTouchState||(t.clearRect(0,0,ne(t.canvas),Mt(t.canvas)),this.deps.drawHoverHighlight(this.mobileTouchState.colIndex,this.mobileTouchState.rowIndex,this.deps.getNoteHoverColor(this.options.ghostAlpha)),this.deps.drawGhostNote(this.mobileTouchState.colIndex,this.mobileTouchState.rowIndex),this.deps.setGhostNotePosition(this.mobileTouchState.colIndex,this.mobileTouchState.rowIndex))}activateMobileGhostPreview(){if(this.mobileTouchState){if(!this.deps.isPositionWithinPitchGrid(this.mobileTouchState.colIndex,this.mobileTouchState.rowIndex)){this.resetMobileTouchState({clearOverlay:!1});return}this.mobileGhostActive=!0,this.renderMobileGhostPreview()}}resetMobileTouchState({clearOverlay:t=!1}={}){this.mobileLongPressTimer&&(clearTimeout(this.mobileLongPressTimer),this.mobileLongPressTimer=null),t&&this.mobileGhostActive&&this.deps.clearOverlay(),this.mobileTouchState=null,this.mobileGhostActive=!1}}function PQ(A,t){const{activeChordIntervals:e,isIntervalsInverted:n,chordPositionState:s}=t;if(!A||!e||e.length===0)return[];if(n&&e.length===2&&e[0]==="1P"){const o="-"+e[1],a=vn(A,o),l=ss(a),d=l.includes("#")&&rs(l).includes("b")?rs(l):l;return[A,d]}const r=e.map(i=>{const o=vn(A,i),a=ss(o);if(a.includes("#")){const l=rs(a);if(l.includes("b"))return l}return a});if(e.length>=3&&s>0){const i=[...r];for(let m=0;m<s;m++){const f=i.shift();if(!f)break;const g=vn(f,"8P");i.push(ss(g)??f)}const o=i[0],a=A;if(!o)return r;const l=to(o),d=to(a);if(l===null||d===null)return r;let u=0,h=l;for(;h>d;)h-=12,u-=12;for(;h+12<=d;)h+=12,u+=12;return i.map(m=>{const f=to(m);if(f===null)return m;const g=f+u;return B0(g)??m})}return r}let bi=!1,Xa=null,$a=null,Ya=null,ts=null;const VA="grab";function LQ(A){if(bi){A&&(A.style.cursor=VA);return}Xa=document.body.style.cursor||null,$a=document.documentElement.style.cursor||null,Ya=A?.style.cursor??null,ts=A??null,A&&(A.style.cursor=VA),document.body.style.cursor=VA,document.documentElement.style.cursor=VA,document.body.dataset.cursorOverride="stamp",bi=!0}function Jf(){bi&&(ts&&ts.style.cursor===VA&&(ts.style.cursor=Ya??""),document.body.style.cursor===VA&&(document.body.style.cursor=Xa??""),document.documentElement.style.cursor===VA&&(document.documentElement.style.cursor=$a??""),document.body.dataset.cursorOverride==="stamp"&&delete document.body.dataset.cursorOverride,bi=!1,Xa=null,$a=null,Ya=null,ts=null)}let yt=null,TA=!1,Ot=null,cA=[],ue=[];const gn=new Set;let xA=!1,ze=null;const jf=new BQ,Vl=new wQ,Zf=new vQ,HQ=new CQ,zl=new yQ,ql=new QQ,yi=new xQ,Wi=new MQ,mn=new UQ({noteToolInteractor:Vl,chordToolInteractor:HQ,eraserToolInteractor:Zf,stampToolInteractor:zl,tripletToolInteractor:ql,modulationToolInteractor:jf,tonicizationToolInteractor:yi,placementFillNoteIds:gn,getPitchForRow:Mn,getTimeAlignedCanvasColumn:Ja,getChordPitchesForRootPitch:A=>PQ(A,c.state),findNearestMeasureBoundary:ig}),DQ=275,NQ=.25,Gn=new TQ({shouldUseMobileLongPress:_Q,isPositionWithinPitchGrid:ng,getSelectedTool:()=>c.state.selectedTool,getPitchHoverCtx:()=>yt,clearOverlay:Tn,drawHoverHighlight:Cs,getNoteHoverColor:eg,drawGhostNote:sg,setGhostNotePosition:Xf,attemptPlaceNoteAt:kQ,onNotePlaced:rg,onNoteNotPlaced:Tn},{longPressDelayMs:DQ,ghostAlpha:NQ}),tg="#4a90e2";function RQ(A,t=1){const e=A.startsWith("#")?A.slice(1):A;if(e.length!==6)return A;const n=parseInt(e.slice(0,2),16),s=parseInt(e.slice(2,4),16),r=parseInt(e.slice(4,6),16);return`rgba(${n}, ${s}, ${r}, ${t})`}function eg(A=.2){const t=c.state.selectedNote?.color||tg;return RQ(t,A)}function Bu(){return c.state.selectedNote?.color||tg}function Ag(){return!!It.currentTool}function Mn(A){const t=c.state.fullRowData[A];return!t||t.isBoundary?null:t.toneNote}function Ja(A){const t=A+2,e=dQ(c.state,t);if(e===null)return null;const n=uQ(c.state,e);return n===null?null:Math.max(0,n-2)}function ng(A,t){const e=(c.state.selectedTool==="note"||c.state.selectedTool==="chord")&&c.state.selectedNote?.shape==="circle",s=(c.state.musicalColumnWidths&&c.state.musicalColumnWidths.length>0?c.state.musicalColumnWidths:c.state.columnWidths||[]).length,r=e?s-1:s;return A<0||A>=r?!1:Mn(t)!==null}function Cs(A,t,e){if(!yt)return;const n={...c.state,zoomLevel:ae.getViewportInfo().zoomLevel},s=Y(A,n),i=ut(t,c.state)-c.state.cellHeight/2,o=c.state.selectedTool;let a;if(c.state.modulationMarkers&&c.state.modulationMarkers.length>0?a=Y(A+1,n)-s:a=(c.state.columnWidths[A]??1)*c.state.cellWidth,o==="eraser"||Wi.getIsActive())c.state.modulationMarkers&&c.state.modulationMarkers.length>0?a=Y(A+2,n)-s:a=c.state.cellWidth*2;else if(o==="note"&&c.state.selectedNote?.shape==="circle")c.state.modulationMarkers&&c.state.modulationMarkers.length>0?a=Y(A+2,n)-s:a=c.state.cellWidth*2;else if(o==="sixteenthStamp")c.state.modulationMarkers&&c.state.modulationMarkers.length>0?a=Y(A+2,n)-s:a=c.state.cellWidth*2;else if(o==="tripletStamp"){const l=Os.getSelectedTripletStamp();if(l){const u=2*(l.span==="eighth"?1:2);c.state.modulationMarkers&&c.state.modulationMarkers.length>0?a=Y(A+u,n)-s:a=c.state.cellWidth*u}else a=c.state.cellWidth*2}else o==="tonicization"&&(c.state.modulationMarkers&&c.state.modulationMarkers.length>0?a=Y(A+2,n)-s:a=c.state.cellWidth*2);yt.fillStyle=e,yt.fillRect(s,i,a,c.state.cellHeight)}function sg(A,t,e=!1){if(!yt||!c.state.selectedNote)return;const n=c.state.selectedTool,{shape:s,color:r}=c.state.selectedNote;if(yt.globalAlpha=e?.2:.4,n==="note"){const i=s==="circle"?A+1:A,o={uuid:"ghost-note",globalRow:t,row:t,startColumnIndex:A,endColumnIndex:i,color:r,shape:s,isDrum:!1},a={...c.state,zoomLevel:ae.getViewportInfo().zoomLevel};s==="oval"?yl(yt,a,o,t):bl(yt,a,o,t)}yt.globalAlpha=1}function kQ(A,t){const e=Vl.attemptPlaceNoteAt(A,t,{activeNote:Ot,lastDragRow:ze,activePreviewPitches:ue},gn,{getPitchForRow:Mn});return Ot=e.state.activeNote,ze=e.state.lastDragRow,ue=e.state.activePreviewPitches,e.placed&&e.shouldStartDragging&&(TA=!0),e.placed}function _Q(){if(c.state.selectedTool!=="note")return!1;const A=c.state.deviceProfile;if(A&&typeof A.isMobile=="boolean")return A.isMobile;if(typeof window<"u"&&typeof window.matchMedia=="function")try{return window.matchMedia("(pointer: coarse)").matches}catch{return!1}return!1}function OQ(A){if(Ag()){Tn();return}if(!yt)return;const t=A.target instanceof Element?A.target:null;if(!t)return;const e=t.getBoundingClientRect(),n=A.clientX-e.left,s=A.clientY-e.top,r=document.getElementById("canvas-container")?.scrollLeft??0,i=Xe.getColumnIndex(n+r),o=Xe.getPitchRowIndex(s);if(!ng(i,o)){c.state.selectedTool;return}if(A.button===2&&Wi.handleMouseDown({event:A,colIndex:i,rowIndex:o,annotationService:It})){yt.clearRect(0,0,ne(yt.canvas),Mt(yt.canvas)),Cs(i,o,"rgba(220, 53, 69, 0.3)");return}if(A.button===0){const a=n+r;if(jf.handleMouseDown(a,s))return;const l=Vl.handleExistingNoteMouseDown(i,o,{activeNote:Ot,lastDragRow:ze,activePreviewPitches:ue},{getPitchForRow:Mn});if(l.handled){Ot=l.state.activeNote,ze=l.state.lastDragRow,ue=l.state.activePreviewPitches;return}const d=c.state.selectedTool;if(d==="note"||d==="chord"){const h=zl.tryStartShapeDrag({actualX:n+r,canvasY:s}),m=!h&&ql.tryStartShapeDrag({actualX:n+r,canvasY:s});if(h||m)return;const f=kt.getSixteenthStampAtPosition(i,o),g=PA(i,c.state),p=g===null?null:kt.getTripletStampAtPosition(g,o);if(f||p)return}const u=mn.handleToolMouseDown({toolType:d,colIndex:i,rowIndex:o,actualX:n+r,canvasY:s,state:{isDragging:TA,isEraserDragActive:xA,activeNote:Ot,activeChordNotes:cA,activePreviewPitches:ue,lastDragRow:ze}});if(u.handled){TA=u.state.isDragging,xA=u.state.isEraserDragActive,Ot=u.state.activeNote,cA=u.state.activeChordNotes,ue=u.state.activePreviewPitches,ze=u.state.lastDragRow;return}}}function KQ(A){if(Ag()){Tn();return}if(!yt)return;const t=A.target instanceof Element?A.target:null;if(!t)return;const e=t.getBoundingClientRect(),n=A.clientX-e.left,s=A.clientY-e.top,r=document.getElementById("canvas-container")?.scrollLeft??0,i=Xe.getColumnIndex(n+r),o=Xe.getPitchRowIndex(s);if(!yt)return;yt.clearRect(0,0,ne(yt.canvas),Mt(yt.canvas));const a=A.target instanceof HTMLElement?A.target:null,l=c.state.selectedTool,d=n+r,u=PA(i,c.state);if(mn.handleToolMouseMoveBeforeBoundsCheck({actualX:d,rowIndex:o,canvasEl:a,state:{isDragging:TA,isEraserDragActive:xA,activeNote:Ot,activeChordNotes:cA,activePreviewPitches:ue,lastDragRow:ze}}).handled)return;mn.handleToolHoverVisuals({toolType:l,actualX:d,canvasY:s,pitchHoverCtx:yt,canvasEl:a,selectedModulationRatio:c.state.selectedModulationRatio,findNearestMeasureBoundary:ig,drawModulationPreview:GQ});const m=(c.state.selectedTool==="note"||c.state.selectedTool==="chord")&&c.state.selectedNote?.shape==="circle",f=c.state.columnWidths.length,g=m?f-1:f;if(i<0||i>=g||Mn(o)===null){yi.resetHoverState(),$f();return}Xf(i,o);const p=kt.getSixteenthStampAtPosition(i,o),w=u===null?null:kt.getTripletStampAtPosition(u,o),v=!!(p||w),C=v&&(l==="note"||l==="chord");if(v&&l!=="eraser"&&!zl.isDraggingShape()&&!ql.isDraggingShape()?LQ(a):Jf(),(l==="sixteenthStamp"||l==="tripletStamp")&&v)return;const b=mn.handleNoteOrChordDragMouseMove({colIndex:i,rowIndex:o,state:{isDragging:TA,isEraserDragActive:xA,activeNote:Ot,activeChordNotes:cA,activePreviewPitches:ue,lastDragRow:ze}});if(b.handled){TA=b.state.isDragging,xA=b.state.isEraserDragActive,Ot=b.state.activeNote,cA=b.state.activeChordNotes,ue=b.state.activePreviewPitches,ze=b.state.lastDragRow;return}if(!C&&mn.handleChordToolHover({colIndex:i,rowIndex:o,pitchHoverCtx:yt,zoomLevel:ae.getViewportInfo().zoomLevel,drawSingleColumnOvalNote:yl,drawTwoColumnOvalNote:bl}))return;if(Wi.handleMouseMove({event:A,colIndex:i,rowIndex:o,annotationService:It})){Cs(i,o,"rgba(220, 53, 69, 0.3)");return}if(Zf.handleMouseMove(i,o,xA)){Cs(i,o,"rgba(220, 53, 69, 0.3)");return}if(yt&&yi.handleMouseMove({colIndex:i,rowIndex:o,hoverCtx:yt,getPitchForRow:Mn})||C)return;const S=se(c.state),y=c.state.selectedNote?.shape==="circle";let I=null,Q=!0;if(c.state.selectedTool==="note"||c.state.selectedTool==="chord")Q=Ms(i,c.state)&&(!y||Ms(i+1,c.state));else if(c.state.selectedTool==="sixteenthStamp"){const P=Ja(i);Q=P!==null&&!sa(P,S)&&!sa(P+1,S)}else if(c.state.selectedTool==="tripletStamp"){const P=Os.getSelectedTripletStamp();if(P){const R=PA(i,c.state);if(R===null)Q=!1;else{I=R;const L=(dh[P.span]??1)*2,V=pe(I,c.state);Q=!0;for(const _ of S){const X=_.columnIndex,At=_.columnIndex+1;if(X>=V&&X<V+L){Q=!1;break}if(V>=X&&V<=At){Q=!1;break}}}}}const U=c.state.selectedTool==="eraser"?"rgba(220, 53, 69, 0.3)":Q?eg(.2):"rgba(220, 53, 69, 0.15)";if(Cs(i,o,U),c.state.selectedTool==="sixteenthStamp"){const P=Ki.getSelectedSixteenthStamp();if(P&&Q){const R=Ja(i);if(R===null)return;const $={cellWidth:c.state.cellWidth,cellHeight:c.state.cellHeight,columnWidths:c.state.columnWidths,musicalColumnWidths:c.state.columnWidths,modulationMarkers:c.state.modulationMarkers,baseMicrobeatPx:c.state.cellWidth,macrobeatGroupings:c.state.macrobeatGroupings,previewColor:Bu()};WB(yt,R,o,P,$)}}else if(c.state.selectedTool==="tripletStamp"){const P=Os.getSelectedTripletStamp();if(P&&Q&&I!==null){const R={cellWidth:c.state.cellWidth,cellHeight:c.state.cellHeight,columnWidths:c.state.columnWidths,musicalColumnWidths:c.state.columnWidths,modulationMarkers:c.state.modulationMarkers,baseMicrobeatPx:c.state.cellWidth,macrobeatGroupings:c.state.macrobeatGroupings,previewColor:Bu()};XB(yt,I,o,P,R)}}else Q&&sg(i,o)}function Tn(){yt&&yt.clearRect(0,0,ne(yt.canvas),Mt(yt.canvas)),Jf(),yi.resetHoverState(),$f()}function rg(){if(!mn.handleToolMouseUp()){if(ue.length>0){kt.stopCurrentPattern();const A=Ot?.color??cA[0]?.color??c.state.selectedNote?.color;A&&ce.releasePitches(ue,A);const t=Ot;if(t&&A){const n=c.state.timbres[A]?.adsr;if(n){const s=c.state.fullRowData[t.row]?.hex||"#888888";Fe.adsrComponent?.playheadManager.trigger(t.uuid,"release",s,n)}}else if(A){const n=ue[0];if(!n){ue=[];return}const s=c.state.fullRowData.find(r=>r.toneNote===n);if(s){const r=c.state.timbres[A]?.adsr;if(r){const i=s.hex;Fe.adsrComponent?.playheadManager.trigger("chord_preview","release",i,r)}}}ue=[];const e=window.waveformVisualizer;e&&e.stopLiveVisualization()}Ot?.uuid&&gn.has(Ot.uuid)&&(c.emit("noteRelease",{noteId:Ot.uuid,color:Ot.color}),gn.delete(Ot.uuid)),cA.forEach(A=>{A?.uuid&&gn.has(A.uuid)&&(c.emit("noteRelease",{noteId:A.uuid,color:A.color}),gn.delete(A.uuid))}),TA&&c.recordState(),TA=!1,ze=null,Ot?.uuid&&c.emit("noteInteractionEnd",{noteId:Ot.uuid}),cA.forEach(A=>{A.uuid&&c.emit("noteInteractionEnd",{noteId:A.uuid})}),Ot=null,cA=[],xA&&(c.recordState(),xA=!1),Wi.handleGlobalMouseUp(),Tn()}}function ig(A){const{macrobeatBoundaryStyles:t}=c.state,e=100,n=[],s=c.state.modulationMarkers&&c.state.modulationMarkers.length>0;B.debug("PitchGridInteractor","Boundary calculation modulation state",{hasModulation:s},"grid");for(let a=0;a<t.length;a++)if(t[a]==="solid"){const l=ge(c.state,a);if(l){const d=l.endColumn+1,u=Y(d,{...c.state,modulationMarkers:c.state.modulationMarkers||[],cellWidth:c.state.cellWidth,columnWidths:c.state.columnWidths,musicalColumnWidths:c.state.columnWidths,baseMicrobeatPx:c.state.cellWidth});B.debug("PitchGridInteractor","Computed measure boundary",{boundaryIndex:a,endColumn:l.endColumn,calculatedX:u,method:"canvas-space"},"grid"),n.push({measureIndex:a+1,xPosition:u,macrobeatIndex:a})}}const r=Y(0,{...c.state,modulationMarkers:c.state.modulationMarkers||[],cellWidth:c.state.cellWidth,columnWidths:c.state.columnWidths,musicalColumnWidths:c.state.columnWidths,baseMicrobeatPx:c.state.cellWidth});B.debug("PitchGridInteractor","Start boundary position",{startBoundaryX:r,method:"canvas-space"},"grid"),n.unshift({measureIndex:0,xPosition:r,macrobeatIndex:-1}),B.debug("PitchGridInteractor","Available measure boundaries",{boundaries:n},"grid"),B.debug("PitchGridInteractor","Modulation click context",{clickX:A,tolerance:e},"grid");let i=null,o=1/0;return n.forEach(a=>{const l=Math.abs(A-a.xPosition);B.debug("PitchGridInteractor","Boundary distance check",{boundaryX:a.xPosition,distance:l},"grid"),l<=e&&l<o&&(o=l,i=a)}),i?B.debug("PitchGridInteractor","Found closest boundary",{boundary:i,distance:o},"grid"):B.debug("PitchGridInteractor","No boundary found within tolerance",{tolerance:e},"grid"),i}function GQ(A,t,e){if(!e)return;const n=Gu(e),s=Ku(e);A.save();const r=3,i=2,o=Mt(A.canvas);A.strokeStyle=n,A.lineWidth=i,A.globalAlpha=.7,A.setLineDash([]);for(let a=-1;a<=1;a++){const l=t+a*r;A.beginPath(),A.moveTo(l,0),A.lineTo(l,o),A.stroke()}A.globalAlpha=.8,A.font="12px Arial, sans-serif",A.textAlign="center",A.textBaseline="top",A.fillStyle=n,A.fillText(`Preview: ${s}`,t,10),A.restore()}function WQ(){const A=document.getElementById("notation-grid"),t=document.getElementById("hover-canvas");if(!A||!t){B.error("PitchGridInteractor","Could not find required canvas elements.",{hasPitchCanvas:!!A,hasHoverCanvas:!!t},"grid");return}if(yt=t.getContext("2d"),!yt){B.error("PitchGridInteractor","Could not get hover canvas context.",null,"grid");return}Gn.setPitchCanvasElement(A),A.addEventListener("mousedown",OQ),A.addEventListener("mousemove",KQ),A.addEventListener("mouseleave",Tn),A.addEventListener("contextmenu",e=>e.preventDefault()),A.addEventListener("touchstart",e=>Gn.handleTouchStart(e),{passive:!1}),A.addEventListener("touchmove",e=>Gn.handleTouchMove(e),{passive:!1}),A.addEventListener("touchend",e=>Gn.handleTouchEnd(e),{passive:!1}),A.addEventListener("touchcancel",()=>Gn.handleTouchCancel(),{passive:!1}),window.addEventListener("mouseup",rg)}const VQ={init(){WQ(),cQ(),document.addEventListener("canvasResized",()=>{this.renderPitchGrid(),this.renderDrumGrid()}),c.on("animationUpdate",A=>{A.type==="vibrato"&&A.activeColors&&A.activeColors.length>0?this.renderPitchGrid():A.type==="envelopeFill"||A.hasEnvelopeFills?this.renderPitchGrid():A.type==="combined"&&A.vibratoColors&&A.vibratoColors.length>0&&this.renderPitchGrid()}),B.debug("GridManager","Initialized pitch and drum grid interactions",null,"grid")},renderPitchGrid:Ls.render,renderDrumGrid:we.render};function zQ(){const A=he.init();return Us.setContexts(A),zE.init(),VQ.init(),A}class qQ{currentTool=null;toolButtons=[];toolPanels=[];lastSelectedNote=null;optionsContainers={arrow:null,text:null,marker:null,highlighter:null,lasso:null};settings={arrow:{lineStyle:"solid",strokeWeight:4,startArrowhead:"none",endArrowhead:"filled-arrow",arrowheadSize:12},text:{color:"#000000",size:16,bold:!1,italic:!1,underline:!1,background:!1,superscript:!1,subscript:!1},marker:{color:"#4a90e2",size:6},highlighter:{color:"#4a90e2",size:10},lasso:{}};initialize(){if(this.toolButtons=document.querySelectorAll(".draw-tool-button"),this.toolPanels=document.querySelectorAll(".draw-tool-panel"),this.optionsContainers={arrow:document.getElementById("arrow-tool-options"),text:document.getElementById("text-tool-options"),marker:document.getElementById("marker-tool-options"),highlighter:document.getElementById("highlighter-tool-options"),lasso:document.getElementById("lasso-tool-options")},!this.toolButtons.length||!this.optionsContainers.arrow){B.warn("DrawToolsController","Could not find draw tool elements",null,"draw");return}this.attachEventListeners(),this.setupChordTabListeners(),this.setupMainTabListeners(),this.populateAllPanels(),this.initializePanelWidthSync(),this.logPanelMetrics(),window.addEventListener("resize",()=>this.logPanelMetrics(),{passive:!0}),c.on("noteChanged",({newNote:t}={})=>{this.lastSelectedNote=t??null,this.currentTool&&this.deselectAllTools()})}attachEventListeners(){this.toolButtons.forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.drawTool;this.selectTool(e)})})}setupMainTabListeners(){document.querySelectorAll(".tab-button").forEach(e=>{e.addEventListener("click",()=>{e.dataset.tab!=="pitch"&&this.currentTool&&(this.deselectAllTools(),this.restoreLastSelectedNote())})})}setupChordTabListeners(){document.querySelectorAll(".pitch-tab-button").forEach(e=>{e.addEventListener("click",()=>{e.dataset.pitchTab!=="draw"&&this.currentTool&&(this.deselectAllTools(),this.restoreLastSelectedNote())})})}restoreLastSelectedNote(){this.lastSelectedNote?(c.setSelectedNote(this.lastSelectedNote.shape,this.lastSelectedNote.color),c.setSelectedTool("note")):c.state.selectedNote&&(c.setSelectedNote(c.state.selectedNote.shape,c.state.selectedNote.color),c.setSelectedTool("note"))}deselectAllTools(){this.toolButtons.forEach(t=>t.classList.remove("active")),this.toolPanels.forEach(t=>t.classList.remove("active")),this.currentTool=null,It.setTool(null,null),c.state.selectedTool==="draw"&&c.setSelectedTool("note")}selectTool(t){this.toolButtons.forEach(n=>n.classList.remove("active")),this.toolPanels.forEach(n=>n.classList.remove("active"));const e=Array.from(this.toolButtons).find(n=>n.dataset.drawTool===t);e&&(e.classList.add("active"),e.closest(".draw-tool-panel")?.classList.add("active")),this.currentTool=t,It.setTool(t,this.settings),c.setSelectedTool("draw"),c.state.selectedNote={shape:"circle",color:c.state.selectedNote?.color||"#4a90e2"}}populateAllPanels(){this.populateArrowOptions(),this.populateTextOptions(),this.populateMarkerOptions(),this.populateHighlighterOptions()}initializePanelWidthSync(){const t=Array.from(this.toolPanels);t.length&&t.forEach(e=>{e.style.minWidth="",e.style.width="fit-content",e.style.maxWidth="100%",e.style.flex="0 0 auto"})}logPanelMetrics(){try{const t=document.querySelector(".draw-layout-grid");Array.from(this.toolPanels??[]).forEach(n=>{n.getBoundingClientRect()}),t?.getBoundingClientRect()}catch{}}populateArrowOptions(){const t=this.optionsContainers.arrow;if(!t)return;const e=t.querySelector("#arrow-start-head-trigger"),n=t.querySelector("#arrow-end-head-trigger"),s=(h,m)=>m!=="filled-arrow"?`
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="4" y1="12" x2="20" y2="12"/>
          </svg>
        `:h==="start"?`
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9,5 3,12 9,19"/>
            <line x1="3" y1="12" x2="21" y2="12"/>
          </svg>
        `:`
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15,5 21,12 15,19"/>
          <line x1="3" y1="12" x2="21" y2="12"/>
        </svg>
      `,r=(h,m,f)=>{h&&(h.innerHTML=s(m,f))},i=t.querySelector("#arrow-stroke-weight");i&&(i.value=`${this.settings.arrow.strokeWeight}`,i.addEventListener("input",()=>{this.settings.arrow.strokeWeight=parseInt(i.value,10),It.setTool("arrow",this.settings)}));const o=t.querySelector("#arrow-head-size");o&&(o.value=`${this.settings.arrow.arrowheadSize}`,o.addEventListener("input",()=>{this.settings.arrow.arrowheadSize=parseInt(o.value,10),It.setTool("arrow",this.settings)}));const a=Array.from(t.querySelectorAll("[data-line-style]"));if(a.length){const h=m=>{a.forEach(f=>f.classList.toggle("active",f.dataset.lineStyle===m))};h(this.settings.arrow.lineStyle),a.forEach(m=>{m.addEventListener("click",()=>{const f=m.dataset.lineStyle;f&&(this.settings.arrow.lineStyle=f,h(f),It.setTool("arrow",this.settings))})})}const l=Array.from(t.querySelectorAll("[data-arrow-start]"));if(l.length){const h=m=>{l.forEach(f=>f.classList.toggle("active",f.dataset.arrowStart===m)),r(e,"start",m)};h(this.settings.arrow.startArrowhead),l.forEach(m=>{m.addEventListener("click",()=>{const f=m.dataset.arrowStart;f&&(this.settings.arrow.startArrowhead=f,h(f),It.setTool("arrow",this.settings))})})}const d=Array.from(t.querySelectorAll("[data-arrow-end]"));if(d.length){const h=m=>{d.forEach(f=>f.classList.toggle("active",f.dataset.arrowEnd===m)),r(n,"end",m)};h(this.settings.arrow.endArrowhead),d.forEach(m=>{m.addEventListener("click",()=>{const f=m.dataset.arrowEnd;f&&(this.settings.arrow.endArrowhead=f,h(f),It.setTool("arrow",this.settings))})})}const u=t.querySelector("#arrow-swap-heads");u&&u.addEventListener("click",()=>{const h=this.settings.arrow.startArrowhead;if(this.settings.arrow.startArrowhead=this.settings.arrow.endArrowhead,this.settings.arrow.endArrowhead=h,l.length){const m=this.settings.arrow.startArrowhead;l.forEach(f=>f.classList.toggle("active",f.dataset.arrowStart===m)),r(e,"start",m)}if(d.length){const m=this.settings.arrow.endArrowhead;d.forEach(f=>f.classList.toggle("active",f.dataset.arrowEnd===m)),r(n,"end",m)}It.setTool("arrow",this.settings)})}populateTextOptions(){const t=this.optionsContainers.text;if(!t)return;const e=t.querySelector("#text-size-input");e&&(e.value=`${this.settings.text.size}`,e.addEventListener("input",()=>{this.settings.text.size=parseInt(e.value,10),It.setTool("text",this.settings)}));const n=Array.from(t.querySelectorAll(".draw-color-button"));if(n.length){const r=i=>{n.forEach(o=>{const a=o.dataset.color||"";o.classList.toggle("active",a.toLowerCase()===i.toLowerCase())})};r(this.settings.text.color),n.forEach(i=>{i.addEventListener("click",()=>{const o=i.dataset.color;o&&(this.settings.text.color=o,r(o),It.setTool("text",this.settings))})})}const s=Array.from(t.querySelectorAll("[data-text-style]"));if(s.length){const r=["bold","italic","underline","background","superscript","subscript"],i=o=>{this.settings.text[o]=!this.settings.text[o],It.setTool("text",this.settings)};s.forEach(o=>{const a=o.dataset.textStyle;a&&r.includes(a)&&o.classList.toggle("active",!!this.settings.text[a])}),s.forEach(o=>{o.addEventListener("click",()=>{const a=o.dataset.textStyle;!a||!r.includes(a)||(i(a),o.classList.toggle("active",!!this.settings.text[a]))})})}}populateMarkerOptions(){const t=this.optionsContainers.marker;if(!t)return;const e=t.querySelector("#marker-size-input");e&&(e.value=`${this.settings.marker.size}`,e.addEventListener("input",()=>{this.settings.marker.size=parseInt(e.value,10),It.setTool("marker",this.settings)}));const n=Array.from(t.querySelectorAll(".draw-color-button"));if(n.length){const s=r=>{n.forEach(i=>{const o=i.dataset.color||"";i.classList.toggle("active",o.toLowerCase()===r.toLowerCase())})};s(this.settings.marker.color),n.forEach(r=>{r.addEventListener("click",()=>{const i=r.dataset.color;i&&(this.settings.marker.color=i,s(i),It.setTool("marker",this.settings))})})}}populateHighlighterOptions(){const t=this.optionsContainers.highlighter;if(!t)return;const e=t.querySelector("#highlighter-size-input");e&&(e.value=`${this.settings.highlighter.size}`,e.addEventListener("input",()=>{this.settings.highlighter.size=parseInt(e.value,10),It.setTool("highlighter",this.settings)}));const n=Array.from(t.querySelectorAll(".draw-color-button"));if(n.length){const s=r=>{n.forEach(i=>{const o=i.dataset.color||"";i.classList.toggle("active",o.toLowerCase()===r.toLowerCase())})};s(this.settings.highlighter.color),n.forEach(r=>{r.addEventListener("click",()=>{const i=r.dataset.color;i&&(this.settings.highlighter.color=i,s(i),It.setTool("highlighter",this.settings))})})}}}const XQ=new qQ;function $Q(){return It.initialize(),XQ.initialize?.(),B.initSuccess("DrawSystem"),typeof window<"u"&&(window.annotationService=It),{annotationService:It}}B.moduleLoaded("KeyboardHandler","keyboard");function YQ(){document.addEventListener("keydown",A=>{const t=document.activeElement;if(!t)return;const e=t.tagName.toLowerCase(),n=t.contentEditable==="true";if(["input","textarea"].includes(e)||n)return;if(A.ctrlKey&&A.key.toLowerCase()==="p"){A.preventDefault(),B.info("KeyboardHandler","Ctrl+P pressed. Opening print preview",null,"keyboard"),c.emit("printPreviewStateChanged",!0);return}if(A.ctrlKey&&A.key.toLowerCase()==="z"){A.preventDefault(),c.undo();return}if(A.ctrlKey&&A.key.toLowerCase()==="y"){A.preventDefault(),c.redo();return}let s=!1;switch(A.key){case"Backspace":case"Delete":if(c.state.lassoSelection?.isActive){const r=c.state.lassoSelection.selectedItems;r.forEach(i=>{if(i.type==="note"){const o=i.data,a=c.state.placedNotes.findIndex(l=>l.uuid===o.uuid);a!==-1&&c.state.placedNotes.splice(a,1)}else if(i.type==="sixteenthStamp"){const o=i.data,a=c.state.sixteenthStampPlacements.findIndex(l=>l.id===o.id);a!==-1&&c.state.sixteenthStampPlacements.splice(a,1)}else if(i.type==="tripletStamp"){const o=i.data,a=c.state.tripletStampPlacements.findIndex(l=>l.id===o.id);a!==-1&&c.state.tripletStampPlacements.splice(a,1)}}),c.state.lassoSelection={selectedItems:[],convexHull:null,isActive:!1},c.recordState(),c.emit("render"),s=!0,B.info("KeyboardHandler",`Deleted ${r.length} items from lasso selection`,null,"keyboard")}break}s&&A.preventDefault()}),B.info("KeyboardHandler","Initialized",null,"keyboard")}B.moduleLoaded("TransportKeyboardShortcuts","keyboard");function JQ(){const A=document.activeElement;if(!(A instanceof HTMLElement))return!0;const t=A.tagName.toLowerCase();return!(["input","textarea","select"].includes(t)||A.isContentEditable)}function jQ(){let A=!1;document.addEventListener("keydown",t=>{if(t.code!=="Space"||A||t.repeat||!JQ())return;const e=document.getElementById("play-button");e&&(t.preventDefault(),A=!0,e.click())}),document.addEventListener("keyup",t=>{t.code==="Space"&&(A=!1)}),B.info("TransportKeyboardShortcuts","Initialized",null,"keyboard")}const ZQ=[{label:"Toolbar",selector:"#toolbar"},{label:"Toolbar Primary",selector:"#toolbar-primary"},{label:"Primary Actions Grid",selector:"#toolbar-primary .primary-toolbar-actions"},{label:"Primary Playback Row",selector:"#toolbar-primary .primary-toolbar-playback"},{label:"Toolbar Secondary",selector:"#toolbar-secondary"},{label:"Toolbar Preset Controls",selector:"#toolbar-secondary .preset-effects-controls"},{label:"Toolbar Tab Sidebar",selector:"#toolbar-secondary .tab-sidebar"},{label:"Sidebar",selector:"#sidebar"},{label:"Timbre Tab Panel",selector:"#timbre-panel"},{label:"Pitch Tab Panel",selector:"#pitch-panel"},{label:"Rhythm Tab Panel",selector:"#rhythm-panel"},{label:"Macrobeat Tools",selector:"#canvas-macrobeat-tools, #macrobeat-tools"},{label:"Waveform Card",selector:"#timbre-panel .waveform-content-box"},{label:"Preset Card",selector:"#timbre-panel .preset-content-box"},{label:"Effects Card",selector:"#timbre-panel #effects-panel .effects-content-box"},{label:"Envelope Card",selector:"#adsr-envelope"},{label:"Harmonics Card",selector:".harmonic-bins-container"},{label:"Canvas Container",selector:"#canvas-container"},{label:"Pitch Grid Wrapper",selector:"#pitch-grid-wrapper"},{label:"Pitch Grid Container",selector:"#pitch-grid-container"},{label:"Drum Grid Wrapper",selector:"#drum-grid-wrapper"},{label:"Drum Grid",selector:"#drum-grid"}],ja=new Map;let Za,Ko,Go=null,Wn="",pn=!1;function Tr(A){return Number.isFinite(A)?Number(A.toFixed(1)):A}function tF(A){const t=A.getBoundingClientRect(),e=window.getComputedStyle(A);return{tag:A.tagName.toLowerCase(),id:A.id||null,class:A.className||null,top:Tr(t.top),left:Tr(t.left),width:Tr(t.width),height:Tr(t.height),offsetWidth:A.offsetWidth,offsetHeight:A.offsetHeight,scrollWidth:A.scrollWidth,scrollHeight:A.scrollHeight,clientWidth:A.clientWidth,clientHeight:A.clientHeight,display:e.display,position:e.position,overflowX:e.overflowX,overflowY:e.overflowY,transform:e.transform!=="none"?e.transform:void 0}}function og(A="manual"){const t=window.__uiDiagnosticsTrackedElements;if(!t)return[];if(!pn&&A!=="manual")return[];Xr();const e=[];return t.forEach(n=>{const s=Array.from(document.querySelectorAll(n.selector));if(!s.length){e.push({label:n.label,selector:n.selector,missing:!0});return}s.forEach((r,i)=>{const o=s.length>1?`${n.label} [${i}]`:n.label,a=tF(r);e.push({label:o,selector:n.selector,info:a})})}),window.__uiDiagnosticsLastSnapshot=e,e}function ln(A){pn&&(Wn=Wn?`${Wn}; ${A}`:A,Go===null&&(Go=requestAnimationFrame(()=>{const t=Wn||"auto";Go=null,Wn="",og(t)})))}function Xr(){const A=window.__uiDiagnosticsTrackedElements;!A||!Za||A.forEach(t=>{document.querySelectorAll(t.selector).forEach(n=>{ja.has(n)||(ja.set(n,t.label),Za.observe(n),n.addEventListener("scroll",()=>ln(`${t.label} scroll`),{passive:!0}))})})}function eF(A={}){if(window.__uiDiagnosticsInitialized)return;window.__uiDiagnosticsInitialized=!0;const{elements:t,autoLog:e=!1}=A;pn=!!e,window.__uiDiagnosticsAutoLog=pn;const n=t||ZQ;window.__uiDiagnosticsTrackedElements=n,Za=new ResizeObserver(s=>{const r=s.map(i=>ja.get(i.target)||i.target.id||i.target.tagName.toLowerCase()).filter(Boolean);r.length&&ln(`Resize: ${r.join(", ")}`)}),Ko=new MutationObserver(()=>Xr()),document.body?Ko.observe(document.body,{childList:!0,subtree:!0}):document.addEventListener("DOMContentLoaded",()=>{Ko.observe(document.body,{childList:!0,subtree:!0}),Xr(),ln("init")},{once:!0}),window.addEventListener("resize",()=>ln("window resize")),Xr(),ln("init"),window.logUIState=(s="manual")=>og(s),window.enableUIDiagnosticsAutoLog=()=>{pn=!0,window.__uiDiagnosticsAutoLog=!0,ln("auto-log enabled")},window.disableUIDiagnosticsAutoLog=()=>{pn=!1,window.__uiDiagnosticsAutoLog=!1}}function AF(){B.section("SETTING UP INPUT HANDLERS"),YQ(),jQ(),gQ(),window.enableUIDiagnostics&&eF()}function nF(){c.on("tempoChanged",()=>{St.setBpm(c.state.tempo)}),c.on("layoutChanged",()=>{he.reflow()}),c.on("rhythmPatternChanged",()=>{kt.refresh&&kt.refresh()});const A=()=>{try{Ls.render(),we.render?.(),B.debug("StateSubscriptions","renderAll invoked",null,"grid")}catch(t){B.error("StateSubscriptions","renderAll failed",t,"grid")}};return c.on("notesChanged",A),c.on("sixteenthStampPlacementsChanged",A),c.on("tripletStampPlacementsChanged",A),c.on("accidentalModeChanged",A),c.on("frequencyLabelsChanged",A),c.on("focusColoursChanged",A),c.on("octaveLabelsChanged",A),c.on("degreeDisplayModeChanged",A),c.on("longNoteStyleChanged",A),c.on("layoutConfigChanged",()=>{Ls.renderMacrobeatTools()}),c.on("rhythmStructureChanged",()=>{he.reflow()}),c.on("modulationMarkersChanged",()=>{he.reflow(),A()}),B.initSuccess("StateSubscriptions"),{renderAll:A}}let tl=!1,KA=[],Wo=!1,rn=null,Vo=!1;function sF(){Wo=!1,rn=null,Vo=!1,window.initAudio=async()=>{if(!Wo)return rn||(rn=(async()=>{try{ys.state!=="running"&&(await Yr(),B.info("Main.js","AudioContext started successfully")),Wo=!0}catch(e){throw B.error("Main.js","Could not start AudioContext",e),rn=null,e}})(),rn)};const A=()=>{Vo||(Vo=!0,window.initAudio?.().catch(e=>B.warn("Main.js","Failed to initialize audio after user interaction",e,"initialization")),document.removeEventListener("click",A,!0),document.removeEventListener("keydown",A,!0),document.removeEventListener("touchstart",A,!0))},t=()=>{typeof St.teardown=="function"&&St.teardown()};document.addEventListener("click",A,!0),document.addEventListener("keydown",A,!0),document.addEventListener("touchstart",A,!0),window.addEventListener("beforeunload",t),KA.push(()=>document.removeEventListener("click",A,!0)),KA.push(()=>document.removeEventListener("keydown",A,!0)),KA.push(()=>document.removeEventListener("touchstart",A,!0)),KA.push(()=>window.removeEventListener("beforeunload",t)),KA.push(()=>{delete window.initAudio})}const Pn={domCache:!1,layoutService:!1,canvasContextService:!1,synthEngine:!1,transportService:!1,scrollSync:!1,uiComponents:!1,audioComponents:!1,rhythmPlaybackService:!1,initialized:!1},rF={top:"G5",bottom:"C4"};function iF(A){if(!A?.top||!A?.bottom)return null;const t=He.findIndex(n=>n.toneNote===A.top),e=He.findIndex(n=>n.toneNote===A.bottom);return t===-1||e===-1?(B.warn("Main.js","Failed to resolve preset range from tone notes",A),null):{topIndex:Math.min(t,e),bottomIndex:Math.max(t,e)}}function oF(){return iF(rF)}function sA(A){Pn[A]=!0}function wu(A,t=5e3){return new Promise((e,n)=>{if(Pn[A]){e();return}const s=Date.now(),r=()=>{Pn[A]?e():Date.now()-s>t?n(new Error(`Component ${A} not ready within ${t}ms`)):setTimeout(r,50)};r()})}function ag(){Object.keys(Pn).forEach(A=>{Pn[A]=!1})}async function aF(){window.initStartTime=Date.now(),B.info("Main.js","Initialization triggered"),B.section("STARTING INITIALIZATION");const A=["dom-cache","drum-samples","state-setup","canvas-services","layout-ready","synth-engine","rhythm-playback","transport-service","input-handlers","store-hooks","ui-components","audio-components","state-subscriptions","initial-render","finalize"];try{at.init(),A.forEach(i=>at.registerTask(i)),await at.nextFrame(),V1(),cp({latencyHint:"playback",lookAhead:.1}),B.info("Main.js","AudioContext configured with latencyHint: playback"),(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&Tf(),at.updateStatus("Initializing interface..."),fA.init(),sA("domCache"),at.completeTask("dom-cache"),await at.nextFrame(),at.updateStatus("Loading audio samples..."),await nS(),at.completeTask("drum-samples"),B.info("Main.js","Drum samples preloaded"),await at.nextFrame(),(()=>{const i=fA.get("appContainer")||document.getElementById("app-container");if(i){const o=["click","keydown","touchstart"],a=()=>{window.initAudio?.()};o.forEach(l=>{i.addEventListener(l,a,{once:!0})})}})(),at.updateStatus("Preparing core systems..."),J1(c.state);const e=c.state.pitchRange||{topIndex:0,bottomIndex:He.length-1},n=Math.max(0,Math.min(He.length-1,e.topIndex??0)),s=Math.max(n,Math.min(He.length-1,e.bottomIndex??He.length-1));c.state.pitchRange={topIndex:n,bottomIndex:s},c.state.fullRowData=[...He],at.completeTask("state-setup"),await at.nextFrame(),at.updateStatus("Sizing canvas..."),zQ(),sA("layoutService"),sA("canvasContextService"),at.completeTask("canvas-services"),await at.nextFrame(),at.updateStatus("Calculating layout..."),await he.waitForInitialLayout(),at.completeTask("layout-ready"),await at.nextFrame(),at.updateStatus("Initializing synth engine..."),St.init(),sA("synthEngine"),at.completeTask("synth-engine"),await at.nextFrame(),at.updateStatus("Preparing rhythm playback..."),kt.initialize().catch(i=>{B.warn("Main.js","RhythmPlaybackService initialization deferred (needs user interaction)",i,"initialization")}),sA("rhythmPlaybackService"),at.completeTask("rhythm-playback"),await at.nextFrame(),at.updateStatus("Configuring transport..."),lA.init(),sA("transportService"),at.completeTask("transport-service"),await at.nextFrame(),at.updateStatus("Registering input handlers..."),AF(),at.completeTask("input-handlers"),await at.nextFrame(),at.updateStatus("Syncing state services..."),X0(c),nB(c),fp({getColumnMap:i=>Yt.getColumnMap(i),visualToTimeIndex:(i,o)=>Yt.getColumnMap(i).visualToTime.get(o)??null,timeIndexToVisualColumn:(i,o)=>Yt.getColumnMap(i).timeToVisual.get(o)??null,getTimeBoundaryAfterMacrobeat:(i,o)=>{const l=Yt.getColumnMap(i).macrobeatBoundaries.find(d=>d.macrobeatIndex===o);return l?l.timeColumn+1:0}}),at.completeTask("store-hooks"),await at.nextFrame(),at.updateStatus("Loading interface components..."),YS(),sA("uiComponents"),at.completeTask("ui-components"),await at.nextFrame(),await wu("uiComponents"),at.updateStatus("Preparing audio components..."),OE(),sA("audioComponents"),at.completeTask("audio-components"),await at.nextFrame(),j1(c.state,"audio-components-initialization"),WE(),$Q(),await wu("audioComponents"),B.section("SETTING UP STATE SUBSCRIPTIONS"),at.updateStatus("Binding state subscriptions...");const{renderAll:r}=nF();if(at.completeTask("state-subscriptions"),await at.nextFrame(),B.section("PERFORMING INITIAL RENDER"),c.setSelectedTool("note"),c.setSelectedNote("circle","#4a90e2"),at.updateStatus("Rendering workspace..."),r(),Ls.renderMacrobeatTools(),at.completeTask("initial-render"),Or.prefetchButtonGridSnapshot(),await at.nextFrame(),sA("initialized"),B.section("INITIALIZATION COMPLETE"),at.updateStatus("Finalizing..."),at.completeTask("finalize"),await at.nextFrame(),c.isColdStart){const i=oF();i?ae.setPitchViewportRange(i,{animateMs:0,source:"coldStart:treble"}):B.warn("Main.js","Treble Clef preset range could not be resolved during cold start")}await at.complete(),window.ModulationTest=Hf}catch(t){B.error("Main.js","Initialization failed",t,"initialization"),B.error("Main.js","Component readiness snapshot at failure",{...Pn},"initialization");const e=t instanceof Error?t:new Error(String(t));at.showError(e);const n=document.createElement("div");n.style.cssText=`
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #ff4444; color: white; padding: 20px; border-radius: 8px;
            z-index: 10000; font-family: monospace; max-width: 80vw;
        `,n.innerHTML=`
            <h3>Initialization Error</h3>
            <p>The application failed to initialize properly.</p>
            <details>
                <summary>Technical Details</summary>
                <pre>${e.message}</pre>
                <pre>Stack: ${e.stack}</pre>
            </details>
            <button onclick="location.reload()">Reload Page</button>
        `,document.body.appendChild(n)}}function lF(){tl||(tl=!0,ag(),sF(),fA.refresh(),aF())}function cF(){KA.forEach(t=>t()),KA=[];try{$S()}catch(t){B.warn("Main.js","Failed to unmount Svelte components",t,"cleanup")}typeof St.teardown=="function"&&St.teardown(),typeof kt.dispose=="function"&&kt.dispose();const A=["is-mobile","is-touch","orientation-portrait","orientation-landscape"];[document.documentElement,document.body].forEach(t=>{A.forEach(e=>t?.classList.remove(e))}),ag(),tl=!1}const dF=Object.assign({"../public/apple-touch-icon.png":Wg,"../public/assets/icons/clear.svg":Vg,"../public/assets/icons/diamond-note.svg":zg,"../public/assets/icons/eraser.svg":qg,"../public/assets/icons/lasso-tool.svg":Xg,"../public/assets/icons/loop.svg":$g,"../public/assets/icons/marker-tool.svg":Yg,"../public/assets/icons/pause.svg":Jg,"../public/assets/icons/play.svg":jg,"../public/assets/icons/redo.svg":Zg,"../public/assets/icons/settings.svg":tm,"../public/assets/icons/stop.svg":em,"../public/assets/icons/undo.svg":Am,"../public/assets/icons/volume.svg":nm,"../public/assets/icons/zoomIn.svg":sm,"../public/assets/icons/zoomOut.svg":rm,"../public/assets/sidebar/hideAnalysis.svg":im,"../public/assets/sidebar/hideDrums.svg":om,"../public/assets/sidebar/newPage.svg":am,"../public/assets/sidebar/open.svg":lm,"../public/assets/sidebar/print.svg":cm,"../public/assets/sidebar/saveAs.svg":dm,"../public/assets/tabicons/dottedQuarterNote.svg":um,"../public/assets/tabicons/eigthNote.svg":hm,"../public/assets/tabicons/phaseButton_0.svg":fm,"../public/assets/tabicons/phaseButton_180.svg":gm,"../public/assets/tabicons/phaseButton_270.svg":mm,"../public/assets/tabicons/phaseButton_90.svg":pm,"../public/assets/tabicons/quarterNote.svg":Bm,"../public/assets/tabicons/tonicShape_1.svg":wm,"../public/assets/tabicons/tonicShape_2.svg":vm,"../public/assets/tabicons/tonicShape_3.svg":Cm,"../public/assets/tabicons/tonicShape_4.svg":bm,"../public/assets/tabicons/tonicShape_5.svg":ym,"../public/assets/tabicons/tonicShape_6.svg":Sm,"../public/assets/tabicons/tonicShape_7.svg":Em,"../public/favicon-96x96.png":Qm,"../public/favicon.ico":Fm,"../public/favicon.svg":Im,"../public/fonts/atkinsonHyperlegibleNextBold.otf":xm,"../public/fonts/atkinsonHyperlegibleNextRegular.otf":Um,"../public/fonts/atkinsonHyperlegibleNextRegularItalic.otf":Mm,"../public/site.webmanifest":Tm,"../public/web-app-manifest-192x192.png":Pm,"../public/web-app-manifest-512x512.png":Lm}),uF="../public/";function hF(A){const t=A.replace(/^\/+/,""),e=`${uF}${t}`;return dF[e]??A}function fF(A){A.querySelectorAll("[src], [href]").forEach(e=>{const n=e.hasAttribute("src")?"src":"href",s=e.getAttribute(n);!s||s.startsWith("http")||s.startsWith("data:")||s.startsWith("#")||!s.startsWith("assets/")&&!s.startsWith("fonts/")&&!s.startsWith("favicon")||e.setAttribute(n,hF(s))})}function gF(A){return A.innerHTML=Hm,fF(A),lF(),{destroy:()=>{cF(),A.innerHTML=""}}}const vu=document.getElementById("app");vu&&gF(vu);
