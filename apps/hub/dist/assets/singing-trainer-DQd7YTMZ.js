import"./modulepreload-polyfill-B5Qt9EMX.js";import{o as ht,h as ft,i as ae,w as Dt,l as Lt,m as Wt,p as kt,S as Ve,q as Re,j as Oe,r as Ze,t as Nt,u as Ot}from"./navigation-yOjPGfHj.js";import{q as Ft,r as qt,v as Et,w as Bt,x as Xt,y as Yt,z as gt,A as zt,S as vt,B as Gt,C as jt,P as Ut,g as n,D as Vt,E as Zt,k as Ae,n as P,F as Kt,G as Jt,H as Qt,I as $t,J as en,K as tn,L as nn,M as on,N as an,p as ne,l as he,j as q,o as A,f as N,c as C,s as I,a as W,i as ie,h as ge,t as J,d as Me,O as Be,b as U,m as sn,u as rn,Q as ln,R as cn,T as mt}from"./disclose-version-CQsWsxfw.js";import{e as Fe,s as Ke,i as Ge}from"./style-CDe0fSxQ.js";import{U as dn,A as un,b as wt,i as hn,P as fn,S as gn}from"./index-Daas8fXP.js";import{P as vn}from"./index-DoA2xU7W.js";function je(e,t,i=!1){if(e.multiple){if(t==null)return;if(!qt(t))return Et();for(var s of e.options)s.selected=t.includes(Je(s));return}for(s of e.options){var o=Je(s);if(Bt(o,t)){s.selected=!0;return}}(!i||t!==void 0)&&(e.selectedIndex=-1)}function yt(e){var t=new MutationObserver(()=>{je(e,e.__value)});t.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),Ft(()=>{t.disconnect()})}function Je(e){return"__value"in e?e.__value:e.value}function Qe(e,t){return e===t||e?.[vt]===t}function de(e={},t,i,s){return Xt(()=>{var o,l;return Yt(()=>{o=l,l=[],gt(()=>{e!==i(...l)&&(t(e,...l),o&&Qe(i(...o),e)&&t(null,...o))})}),()=>{zt(()=>{l&&Qe(i(...l),e)&&t(null,...l)})}}),e}let xe=!1;function mn(e){var t=xe;try{return xe=!1,[e(),xe]}finally{xe=t}}function G(e,t,i,s){var o=!en||(i&tn)!==0,l=(i&$t)!==0,d=(i&on)!==0,c=s,a=!0,r=()=>(a&&(a=!1,c=d?gt(s):s),c),h;if(l){var y=vt in e||an in e;h=Gt(e,t)?.set??(y&&t in e?b=>e[t]=b:void 0)}var u,f=!1;l?[u,f]=mn(()=>e[t]):u=e[t],u===void 0&&s!==void 0&&(u=r(),h&&(o&&jt(),h(u)));var v;if(o?v=()=>{var b=e[t];return b===void 0?r():(a=!0,b)}:v=()=>{var b=e[t];return b!==void 0&&(c=void 0),b===void 0?c:b},o&&(i&Ut)===0)return v;if(h){var g=e.$$legacy;return(function(b,T){return arguments.length>0?((!o||!T||g||f)&&h(T?v():b),b):v()})}var p=!1,m=((i&nn)!==0?Vt:Zt)(()=>(p=!1,v()));l&&n(m);var S=Jt;return(function(b,T){if(arguments.length>0){const E=T?n(m):o&&l?Ae(b):b;return P(m,E),p=!0,c!==void 0&&(c=E),b}return Kt&&p||(S.f&Qt)!==0?m.v:n(m)})}const $e=["#ef8aab","#f48e7d","#e89955","#cdaa42","#a4ba57","#6ec482","#2dc8b1","#16c3da","#58b8f6","#8fa9ff","#ba9bf2","#db8fd4"];function et(e){const t=parseInt(e.slice(1),16);return[t>>16&255,t>>8&255,t&255]}function wn(e,t,i){const s=Math.max(0,Math.min(1,i));return e.map((o,l)=>Math.round(o+s*(t[l]-o)))}function bt(e,t=0){const i=Math.floor(e),s=e-i,o=(i%12-t+12)%12,l=(o+1)%12,d=et($e[o]),c=et($e[l]);return wn(d,c,s)}const yn={C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11};function bn(e){const t=e.replace(/\d+$/,"");return yn[t]??0}function pn(e){const{cellHeight:t,columnWidths:i,viewport:s}=e,o=t/2,l=Mn(i,e.cellWidth);return{getRowY(d){return(d-s.startRow+1)*o},getRowFromY(d){const c=d/o-1;return Math.round(c)+s.startRow},getColumnX(d){return d<0?0:d>=l.length?l[l.length-1]??0:l[d]??0},getColumnFromX(d){let c=0,a=l.length-1;for(;c<a;){const r=Math.floor((c+a)/2);(l[r]??0)<=d?c=r+1:a=r}return Math.max(0,c-1)}}}function pt(e){const{cellHeight:t,viewport:i,pixelsPerSecond:s,nowLineX:o=100,currentTimeMs:l=0}=e,d=t/2;return{getRowY(c){return(c-i.startRow+1)*d},getRowFromY(c){const a=c/d-1;return Math.round(a)+i.startRow},getColumnX(c){return 0},getColumnFromX(c){return 0},getTimeX(c){const a=c-l;return o+a/1e3*s},getTimeFromX(c){const a=(c-o)/s*1e3;return l+a}}}function Mn(e,t){const i=[0];let s=0;for(let o=0;o<e.length;o++){const l=(e[o]??1)*t;s+=l,i.push(s)}return i}function Cn(e,t){const{startRow:i,endRow:s}=e,o=Math.max(0,t.length-1);return{startRow:i,endRow:s,paddedStartRow:Math.max(0,i-1),paddedEndRow:Math.min(o,s+1)}}function tt(e,t,i,s){const o=s.getRowY(e),l=i;return o>=-l&&o<=t.containerHeight+l}function Sn(e){let t=(e||"").replace(/\d/g,"").trim();return t=t.replace(/b/g,"b-").replace(/#/g,"b_"),t}function Pn(e){switch(e){case"C":return{lineWidth:3.33,dash:[],color:"#adb5bd"};case"E":return{lineWidth:1,dash:[5,5],color:"#adb5bd"};case"G":return{lineWidth:1,dash:[],color:"#dee2e6"};case"B":case"A":case"F":case"Eb/Db":case"Db/C#":return{lineWidth:1,dash:[],color:"#ced4da"};default:return{lineWidth:1,dash:[],color:"#ced4da"}}}const De={stroke:"#c7cfd8",background:"rgba(207, 214, 222, 0.32)"};let Ce=null;function _n(){if(Ce)return Ce;if(typeof window>"u")return De;try{const e=window.getComputedStyle(document.documentElement);Ce={stroke:e.getPropertyValue("--c-anacrusis-border").trim()||De.stroke,background:e.getPropertyValue("--c-anacrusis-bg").trim()||De.background}}catch{Ce=De}return Ce}function Tn(e,t,i,s,o,l=0,d){const{fullRowData:c,viewportHeight:a,viewportWidth:r,cellHeight:h}=t,y=r,u=["B","A","F","E♭/D♯","D♭/C♯"];for(let f=s;f<=o;f++){const v=c[f];if(!v||v.isBoundary)continue;const g=i.getRowY(f);if(g<-10||g>a+10)continue;const p=Sn(v.pitch);if(u.includes(p))continue;const m=Pn(p);p==="G"?(e.save(),e.fillStyle=m.color,e.fillRect(l,g-h/2,y-l,h),e.restore()):(e.beginPath(),e.moveTo(l,g),e.lineTo(y,g),e.lineWidth=m.lineWidth,e.strokeStyle=m.color,e.setLineDash(m.dash),e.stroke(),e.setLineDash([]))}}function In(e,t,i,s){const{columnWidths:o,viewportHeight:l,macrobeatBoundaryStyles:d,placedTonicSigns:c}=t,a=o.length;for(let r=0;r<=a;r++){const h=r===0||r===a,y=An(r,c),u=c.some(m=>r===m.columnIndex+2),f=s.includes(r);if(!Rn(r,c))continue;let g=null;if(h||y||u)g={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(f){const m=s.indexOf(r),S=d[m]??"dashed";if(S==="anacrusis"){const{stroke:b}=_n();g={lineWidth:1,strokeStyle:b,dash:[4,4]}}else g={lineWidth:1,strokeStyle:"#adb5bd",dash:S==="solid"?[]:[5,5]}}if(!g)continue;const p=i.getColumnX(r);e.beginPath(),e.moveTo(p,0),e.lineTo(p,l),e.lineWidth=g.lineWidth,e.strokeStyle=g.strokeStyle,e.setLineDash(g.dash),e.stroke()}e.setLineDash([])}function Hn(e,t,i){const{viewportHeight:s,beatIntervalMs:o,measureIntervalMs:l,visibleTimeRange:d,nowLineX:c}=t,a=Math.floor(d.startMs/o)*o,r=Math.ceil(d.endMs/o)*o;for(let h=a;h<=r;h+=o){const y=i.getTimeX?.(h);if(y===void 0)continue;const u=l?h%l===0:!1;e.beginPath(),e.moveTo(y,0),e.lineTo(y,s),e.lineWidth=u?2:1,e.strokeStyle=u?"#adb5bd":"#dee2e6",e.setLineDash(u?[]:[5,5]),e.stroke()}e.setLineDash([]),c!==void 0&&(e.beginPath(),e.moveTo(c,0),e.lineTo(c,s),e.lineWidth=3,e.strokeStyle="#00ff00",e.setLineDash([]),e.stroke())}function An(e,t){return t.some(i=>i.columnIndex===e)}function Rn(e,t){return!t.some(i=>i.columnIndex+1===e)}const xn=.7,Dn=.9,Ln=4,Wn=1,kn=.15,Nn=.2,On=1,Ue=1.5;function Te(e,t){return Number.isFinite(e)&&e>0&&Number.isFinite(t)&&t>0}function Mt(e){if(!e||typeof e.startColumnIndex!="number"||typeof e.endColumnIndex!="number")return!1;const t=e.shape==="circle"?e.startColumnIndex+1:e.startColumnIndex;return e.endColumnIndex>t}function Le(e){const t=e?.split("-")[1];return Number.parseInt(t??"0",10)}function Ct(e,t,i){const s=i*.25,o=e.uuid;if(!o)return 0;const l=t.filter(a=>!a.isDrum&&a.row===e.row&&a.startColumnIndex===e.startColumnIndex&&a.uuid&&a.uuid!==o);if(l.length===0)return 0;const d=[e,...l];return d.sort((a,r)=>Le(a.uuid)-Le(r.uuid)),d.findIndex(a=>a.uuid===o)*s}function Fn(e,t,i){const s=i/2*.12,o=e.uuid;if(!o)return 0;const l=t.filter(a=>!a.isDrum&&a.row===e.row&&a.startColumnIndex===e.startColumnIndex&&a.uuid&&a.uuid!==o&&Mt(a));if(l.length===0)return 0;const d=[e,...l];return d.sort((a,r)=>Le(a.uuid)-Le(r.uuid)),d.findIndex(a=>a.uuid===o)*s}function qn(e){if(!e)return{multiplier:1,category:"natural"};const t=e.includes("♭"),i=e.includes("♯"),s=e.includes("/");return!t&&!i?{multiplier:1,category:"natural"}:s?{multiplier:.75,category:"both-accidentals"}:{multiplier:.88,category:"single-accidental"}}function Ye(e,t,i,s,o,l){const{multiplier:d,category:c}=qn(t);let a;if(i==="circle"){const r=l*2*Dn;switch(c){case"natural":a=r;break;case"single-accidental":a=r*.8;break;case"both-accidentals":a=r*.4;break;default:a=r*d}}else{const r=l*2*xn;switch(c){case"natural":a=r*1.5;break;case"single-accidental":a=r*1.2;break;case"both-accidentals":a=r;break;default:a=r*d}}if(!(a<Ln))if(e.fillStyle="#212529",e.font=`bold ${a}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle",i==="oval"&&c==="both-accidentals"&&t.includes("/")){const r=t.split("/"),h=a*1.1,y=h*(r.length-1),u=o-y/2;r.forEach((f,v)=>{const g=u+v*h,p=a*.08;e.fillText(f.trim(),s,g+p)})}else{const r=a*.08;e.fillText(t,s,o+r)}}function En(e,t,i,s,o,l,d){e.save(),e.beginPath(),e.arc(i,o,l,Math.PI/2,-Math.PI/2,!1),e.lineTo(s,o-l),e.arc(s,o,l,-Math.PI/2,Math.PI/2,!1),e.lineTo(i,o+l),e.closePath(),e.strokeStyle=t.color,e.lineWidth=d,e.shadowColor=t.color,e.shadowBlur=Ue,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore()}function Bn(e,t,i,s){const{config:o,coords:l,allNotes:d,getScaleDegreeLabel:c}=t,{cellWidth:a,cellHeight:r,columnWidths:h,degreeDisplayMode:y}=o,u=l.getRowY(s),f=l.getColumnX(i.startColumnIndex),g=(h[i.startColumnIndex]??1)*a;if(!Te(g,r))return;const p=Ct(i,d,a),m=Math.max(.5,g*.15),S=f+g/2+p,b=g/2-m/2,T=r/2-m/2;if(Te(b,T)&&(e.save(),e.beginPath(),e.ellipse(S,u,b,T,0,0,2*Math.PI),e.strokeStyle=i.color,e.lineWidth=m,e.shadowColor=i.color,e.shadowBlur=Ue,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore(),y!=="off"&&c)){const{label:E}=c(i);E&&Ye(e,E,"oval",S,u,b)}}function Xn(e,t,i,s){const{config:o,coords:l,allNotes:d,getScaleDegreeLabel:c}=t,{cellWidth:a,cellHeight:r,degreeDisplayMode:h,longNoteStyle:y}=o,u=l.getRowY(s),f=l.getColumnX(i.startColumnIndex),g=l.getColumnX(i.startColumnIndex+1)-f;if(!Te(g,r))return;const p=Ct(i,d,a),m=f+g+p,S=Math.max(Wn,g*kn),b=r/2-S/2,T=Mt(i);if(T&&y==="style2"){const _=m,H=l.getColumnX(i.endColumnIndex);if(Te(H-_,b)&&(En(e,i,_,H,u,b,S),h!=="off"&&c)){const{label:Y}=c(i);if(Y){const k=(_+H)/2;Ye(e,Y,"circle",k,u,b)}}return}if(T){const _=l.getColumnX(i.endColumnIndex+1),H=Fn(i,d,r),Y=u+H;e.beginPath(),e.moveTo(m,Y),e.lineTo(_,Y),e.strokeStyle=i.color,e.lineWidth=Math.max(On,g*Nn),e.stroke()}const E=g-S/2;if(Te(E,b)&&(e.save(),e.beginPath(),e.ellipse(m,u,E,b,0,0,2*Math.PI),e.strokeStyle=i.color,e.lineWidth=S,e.shadowColor=i.color,e.shadowBlur=Ue,e.stroke(),e.shadowBlur=0,e.shadowColor="transparent",e.restore(),h!=="off"&&c)){const{label:_}=c(i);_&&Ye(e,_,"circle",m,u,E)}}function Yn(e,t,i){const{config:s,coords:o}=t,{cellWidth:l,cellHeight:d}=s,c=o.getRowY(i.globalRow??i.row),a=o.getColumnX(i.columnIndex),h=o.getColumnX(i.columnIndex+1)-a,y=h*2,u=a+y/2,f=Math.min(y,d)/2*.9;if(f<2||(e.beginPath(),e.arc(u,c,f,0,2*Math.PI),e.strokeStyle="#212529",e.lineWidth=Math.max(.5,h*.05),e.stroke(),i.tonicNumber==null))return;const v=i.tonicNumber.toString(),g=f*1.5;g<6||(e.fillStyle="#212529",e.font=`bold ${g}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(v,u,c))}const zn={timeWindowMs:4e3,pixelsPerSecond:200,circleRadius:9.5,proximityThreshold:35,maxConnections:3,connectorLineWidth:2.5,connectorColor:"rgba(0,0,0,0.4)",useTonicRelativeColors:!0,tonicPitchClass:0,clarityThreshold:.5,maxOpacity:.9};function St(e){return{...zn,...e}}function nt(e,t,i,s,o,l,d){const c=St(l.trailConfig);if(s<c.clarityThreshold||i<=0)return;const{cellHeight:a,colorMode:r}=l,h=Pt(t,i,a,d),y=a/2*.8,u=r==="bw"?[128,128,128]:bt(i,c.tonicPitchClass);e.save(),e.beginPath(),e.arc(o,h,y+4,0,2*Math.PI),e.fillStyle=`rgba(${u[0]}, ${u[1]}, ${u[2]}, ${s*.3})`,e.fill(),e.beginPath(),e.arc(o,h,y,0,2*Math.PI),e.fillStyle=`rgba(${u[0]}, ${u[1]}, ${u[2]}, ${s})`,e.fill(),e.restore()}function Pt(e,t,i,s){if(s.length===0||!s[0])return 0;const o=Math.floor(t),l=t-o,a=(s[0].midi??108)-o;if(a<0||a>=s.length)return a<0?0:e.getRowY(s.length-1);const r=e.getRowY(a),h=i/2;return r-l*h}function _t(e,t,i,s,o,l){const{viewportWidth:d,cellHeight:c,colorMode:a}=o,r=St(o.trailConfig),h=r.timeWindowMs,y=r.pixelsPerSecond,u=i.filter(f=>f.midi>0&&f.clarity>=r.clarityThreshold).map(f=>{const v=s-f.time;if(v>=h||v<0)return null;const g=d-v/1e3*y,p=Pt(t,f.midi,c,l),m=a==="bw"?[128,128,128]:bt(f.midi,r.tonicPitchClass);return{x:g,y:p,clarity:f.clarity,color:m}}).filter(f=>f!==null&&f.x>=0);if(u.length!==0){e.save(),e.strokeStyle=r.connectorColor,e.lineWidth=r.connectorLineWidth,e.beginPath();for(let f=0;f<u.length;f++){let v=0;for(let g=f+1;g<u.length&&v<r.maxConnections;g++){const p=u[f].x-u[g].x,m=u[f].y-u[g].y;Math.sqrt(p*p+m*m)<=r.proximityThreshold&&(e.moveTo(u[f].x,u[f].y),e.lineTo(u[g].x,u[g].y),v++)}}e.stroke();for(const f of u){const v=Math.min(f.clarity*r.maxOpacity,1);e.fillStyle=`rgba(${f.color[0]}, ${f.color[1]}, ${f.color[2]}, ${v})`,e.beginPath(),e.arc(f.x,f.y,r.circleRadius,0,2*Math.PI),e.fill()}e.restore()}}function it(e,t,i,s,o){const{cellHeight:l,nowLineX:d=100,pixelsPerSecond:c}=o;for(const a of i){const r=(d??100)+(a.startTimeMs-s)/1e3*c,h=r+a.durationMs/1e3*c;if(h<0||r>o.viewportWidth)continue;const y=Math.round(108-a.midi),u=t.getRowY(y),f=l/2-2,v=a.color??"#4CAF50";if(e.save(),e.beginPath(),e.arc(r,u,f,Math.PI/2,-Math.PI/2,!1),e.lineTo(h,u-f),e.arc(h,u,f,-Math.PI/2,Math.PI/2,!1),e.lineTo(r,u+f),e.closePath(),e.strokeStyle=v,e.lineWidth=3,e.shadowColor=v,e.shadowBlur=8,e.stroke(),e.shadowBlur=0,e.restore(),a.label){const g=(r+h)/2;e.fillStyle=v,e.font=`bold ${f}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(a.label,g,u)}}}function Gn(e){const t=e.replace(/\d+$/,"");return t.length>0?t:e}function Tt(e,t){return!Number.isFinite(t)||t<=0?e:Math.round(e*t)/t}function jn(e,t,i,s){const o=Math.max(10,Math.min(e*1.2,t*1.2)),l=i<=3?1:.7,d=s<=1?1.08:1;return Tt(o*l*d,s)}function Un(e){const t=e.getContext("2d");return t&&(t.getTransform().a||window.devicePixelRatio)||1}function Vn(e,t){const{showFrequencyLabels:i,showOctaveLabels:s,accidentalMode:o}=t,l=y=>s?y:Gn(y);if(i)return String(Math.round(e.frequency));const{flatName:d,sharpName:c,isAccidental:a}=e,{sharp:r,flat:h}=o;return a?r&&h?l(e.pitch):r&&!h?l(c):h&&!r?l(d):null:l(d)}function ot(e,t,i,s){const{fullRowData:o,cellWidth:l,cellHeight:d,legendColumnWidth:c,colorMode:a,accidentalMode:r}=t,{startRow:h,endRow:y,coords:u}=i,f=Un(e.canvas),v=m=>Tt(m,f),g=c;let p=0;for(const m of s){for(let S=h;S<=y;S++){const b=o[S];if(!b||b.isBoundary||b.column!==m)continue;const T=u.getRowY(S),E=!r.sharp&&!r.flat,_=b.isAccidental&&E,H=Vn(b,t);if(H===null)continue;let Y=a==="bw"?"#ffffff":b.hex||"#ffffff",k="FF";_&&(k="00"),e.fillStyle=_?"rgba(255,255,255,0)":Y,e.fillRect(p,T-d/2,g,d);const x=jn(l,d,H.length,f);e.font=`bold ${x}px 'Atkinson Hyperlegible', sans-serif`,e.textAlign="center",e.textBaseline="middle";const V=v(p+g/2),Z=v(T);e.strokeStyle=`#212529${k}`,e.lineWidth=Math.max(1.2,2.5/f),e.lineJoin="round",e.strokeText(H,V,Z),e.fillStyle=`#ffffff${k}`,e.fillText(H,V,Z)}p+=g}}function Zn(e,t,i,s){e&&(e.clearRect(0,0,e.canvas.width,e.canvas.height),ot(e,i,s,["B","A"])),t&&(t.clearRect(0,0,t.canvas.width,t.canvas.height),ot(t,i,s,["A","B"]))}var Kn=N('<canvas class="pitch-grid-legend pitch-grid-legend--left svelte-ui3s88"></canvas>'),Jn=N('<canvas class="pitch-grid-legend pitch-grid-legend--right svelte-ui3s88"></canvas>'),Qn=N('<div class="pitch-grid-container svelte-ui3s88"><!> <canvas class="pitch-grid-canvas svelte-ui3s88"></canvas> <!></div>');function $n(e,t){ne(t,!0);let i=G(t,"colorMode",3,"color"),s=G(t,"degreeDisplayMode",3,"off"),o=G(t,"accidentalMode",19,()=>({sharp:!0,flat:!0})),l=G(t,"showFrequencyLabels",3,!1),d=G(t,"showOctaveLabels",3,!0),c=G(t,"placedNotes",19,()=>[]),a=G(t,"placedTonicSigns",19,()=>[]),r=G(t,"columnWidths",19,()=>[]),h=G(t,"macrobeatGroupings",19,()=>[]),y=G(t,"macrobeatBoundaryStyles",19,()=>[]),u=G(t,"longNoteStyle",3,"style1"),f=G(t,"beatIntervalMs",3,500),v=q(void 0),g=q(void 0),p=q(void 0),m=q(null),S=q(null),b=q(null),T=q(null);const E=3,_=A(()=>t.cellWidth*E),H=A(()=>n(_)*2),Y=A(()=>d()||l()?n(H)*2:0),k=A(()=>Math.max(0,t.viewport.containerWidth-n(Y))),x=A(()=>t.mode==="notation"||t.mode==="playback"),V=A(()=>t.mode==="singing"),Z=A(()=>t.mode==="highway");function se(){if(n(x))return pn({cellWidth:t.cellWidth,cellHeight:t.cellHeight,columnWidths:r(),viewport:t.viewport,modulationMarkers:t.modulationMarkers});{const M=n(Z)?t.highwayConfig:t.singingConfig;return pt({cellWidth:t.cellWidth,cellHeight:t.cellHeight,viewport:t.viewport,pixelsPerSecond:M?.pixelsPerSecond??200,nowLineX:M?.nowLineX??100,currentTimeMs:M?.currentTimeMs??0})}}function $(){if(!n(m)||!n(v))return;const M=se(),{paddedStartRow:F,paddedEndRow:X}=Cn(t.viewport,t.fullRowData);n(m).clearRect(0,0,n(k),t.viewport.containerHeight);const le={fullRowData:t.fullRowData,cellHeight:t.cellHeight,viewportHeight:t.viewport.containerHeight,viewportWidth:n(k),colorMode:i()};Tn(n(m),le,M,F,X),n(x)?w(n(m),M):n(V)?L(n(m),M):n(Z)&&O(n(m),M),(d()||l())&&(n(S)||n(b))&&z(M,F,X)}function w(M,F){const X=oe(h()),le={columnWidths:r(),cellWidth:t.cellWidth,viewportHeight:t.viewport.containerHeight,macrobeatGroupings:h(),macrobeatBoundaryStyles:y(),placedTonicSigns:a()};In(M,le,F,X);const pe=c().filter(K=>K.isDrum||K.globalRow===void 0?!1:tt(K.globalRow,t.viewport,t.cellHeight,F)),xt=a().filter(K=>K.globalRow===void 0?!1:tt(K.globalRow,t.viewport,t.cellHeight,F)),Ee={config:{cellWidth:t.cellWidth,cellHeight:t.cellHeight,columnWidths:r(),degreeDisplayMode:s(),accidentalMode:o(),longNoteStyle:u(),colorMode:i()},coords:F,allNotes:c()};for(const K of pe)K.shape==="oval"?Bn(M,Ee,K,K.globalRow):K.shape==="circle"&&Xn(M,Ee,K,K.globalRow);for(const K of xt)Yn(M,Ee,K)}function L(M,F){if(!t.singingConfig)return;const X={cellHeight:t.cellHeight,viewportWidth:n(k),pixelsPerSecond:t.singingConfig.pixelsPerSecond??200,timeWindowMs:t.singingConfig.timeWindowMs??4e3,colorMode:i(),trailConfig:t.singingConfig.trailConfig};t.singingConfig.pitchHistory&&t.singingConfig.pitchHistory.length>0&&_t(M,F,t.singingConfig.pitchHistory,performance.now(),X,t.fullRowData),t.singingConfig.targetNotes&&t.singingConfig.targetNotes.length>0&&it(M,F,t.singingConfig.targetNotes,performance.now(),X),t.singingConfig.userPitch&&t.singingConfig.userPitch.clarity>.5&&nt(M,F,t.singingConfig.userPitch.midi,t.singingConfig.userPitch.clarity,n(k)-20,X,t.fullRowData)}function O(M,F){if(!t.highwayConfig)return;const X={cellHeight:t.cellHeight,viewportWidth:t.viewport.containerWidth,nowLineX:t.highwayConfig.nowLineX,pixelsPerSecond:t.highwayConfig.pixelsPerSecond??200,timeWindowMs:t.highwayConfig.timeWindowMs??4e3,colorMode:i(),trailConfig:t.highwayConfig.trailConfig},le={startMs:t.highwayConfig.currentTimeMs-1e3,endMs:t.highwayConfig.currentTimeMs+n(k)/(t.highwayConfig.pixelsPerSecond??200)*1e3},pe={viewportWidth:n(k),viewportHeight:t.viewport.containerHeight,beatIntervalMs:f(),visibleTimeRange:le,nowLineX:t.highwayConfig.nowLineX};Hn(M,pe,F),t.highwayConfig.targetNotes&&t.highwayConfig.targetNotes.length>0&&it(M,F,t.highwayConfig.targetNotes,t.highwayConfig.currentTimeMs,X),t.highwayConfig.userPitch&&t.highwayConfig.userPitch.clarity>.5&&nt(M,F,t.highwayConfig.userPitch.midi,t.highwayConfig.userPitch.clarity,t.highwayConfig.nowLineX,X,t.fullRowData)}function z(M,F,X){const le={fullRowData:t.fullRowData,cellWidth:t.cellWidth,cellHeight:t.cellHeight,legendColumnWidth:n(_),colorMode:i(),showFrequencyLabels:l(),showOctaveLabels:d(),accidentalMode:o()},pe={startRow:F,endRow:X,coords:M};Zn(n(S),n(b),le,pe)}function oe(M){const F=[];let X=0;for(const le of M)X+=le,F.push(X);return F}function D(){if(n(T))return;function M(){$(),P(T,requestAnimationFrame(M),!0)}P(T,requestAnimationFrame(M),!0)}function j(){n(T)&&(cancelAnimationFrame(n(T)),P(T,null))}function ee(){if(!n(v)||(P(m,n(v).getContext("2d"),!0),!n(m)))return;const M=window.devicePixelRatio||1;n(v).width=n(k)*M,n(v).height=t.viewport.containerHeight*M,n(v).style.width=`${n(k)}px`,n(v).style.height=`${t.viewport.containerHeight}px`,n(m).scale(M,M),n(g)&&(P(S,n(g).getContext("2d"),!0),n(S)&&(n(g).width=n(H)*M,n(g).height=t.viewport.containerHeight*M,n(g).style.width=`${n(H)}px`,n(g).style.height=`${t.viewport.containerHeight}px`,n(S).scale(M,M))),n(p)&&(P(b,n(p).getContext("2d"),!0),n(b)&&(n(p).width=n(H)*M,n(p).height=t.viewport.containerHeight*M,n(p).style.width=`${n(H)}px`,n(p).style.height=`${t.viewport.containerHeight}px`,n(b).scale(M,M))),$(),(n(V)||n(Z))&&D()}ht(()=>{ee()}),ft(()=>{j()}),he(()=>{t.mode,t.viewport,t.cellWidth,t.cellHeight,i(),s(),c(),a(),r(),n(m)&&n(x)&&$()}),he(()=>{t.mode,n(V)||n(Z)?D():(j(),n(m)&&$())}),he(()=>{t.viewport.containerWidth,t.viewport.containerHeight,n(m)&&n(v)&&ee()});var ve=Qn(),me=C(ve);{var ue=M=>{var F=Kn();de(F,X=>P(g,X),()=>n(g)),W(M,F)};ae(me,M=>{(d()||l())&&M(ue)})}var re=I(me,2);de(re,M=>P(v,M),()=>n(v));var be=I(re,2);{var qe=M=>{var F=Jn();de(F,X=>P(p,X),()=>n(p)),W(M,F)};ae(be,M=>{(d()||l())&&M(qe)})}W(e,ve),ie()}var ei=N('<div class="pitch-wheel-option svelte-53gwvz"> </div>'),ti=N('<div class="pitch-wheel svelte-53gwvz" role="slider" tabindex="0" aria-valuemin="0"><div class="pitch-wheel-viewport svelte-53gwvz"><div class="pitch-wheel-options svelte-53gwvz"></div></div> <div class="pitch-wheel-overlay svelte-53gwvz"></div></div>');function at(e,t){ne(t,!0);let i=G(t,"selectedIndex",15),s=G(t,"ariaLabel",3,"Pitch selector");const o=40,l=o;let d=q(void 0),c=q(void 0),a=q(void 0),r=q(!1),h=q(null),y=q(0),u=q(0),f=q(o);const v=A(()=>t.options.map((w,L)=>Math.min(Math.abs(L-i()),3))),g=A(()=>n(c)?.clientHeight??0),p=A(()=>Math.max(0,(n(g)-n(f))/2)),m=A(()=>i()*n(f)+n(f)/2),S=A(()=>n(g)>0?n(g)/2-n(m):0);function b(w){if(!t.options||t.options.length===0)return;let L=w;typeof t.onbeforechange=="function"&&(L=t.onbeforechange(w));const O=Math.max(0,Math.min(t.options.length-1,L));if(O!==i()&&(i(O),typeof t.onchange=="function")){const z=t.options[O];z&&t.onchange(O,z)}}function T(w){w!==0&&b(i()+w)}function E(w){w.preventDefault(),w.stopPropagation();const L=Math.sign(w.deltaY);L!==0&&T(L)}function _(w){w.key==="ArrowUp"?(w.preventDefault(),T(-1)):w.key==="ArrowDown"?(w.preventDefault(),T(1)):w.key==="Home"?(w.preventDefault(),b(0)):w.key==="End"&&(w.preventDefault(),b(t.options.length-1))}function H(w){if(P(r,!0),P(h,w.pointerId,!0),P(y,w.clientY,!0),P(u,0),n(d)&&typeof n(d).setPointerCapture=="function")try{n(d).setPointerCapture(w.pointerId)}catch{}}function Y(w){if(!n(r)||w.pointerId!==n(h))return;const L=w.clientY-n(y);if(P(y,w.clientY,!0),L===0)return;P(u,n(u)+L);const O=n(f)||l;for(;Math.abs(n(u))>=O;){const z=-Math.sign(n(u));T(z),P(u,n(u)-Math.sign(n(u))*O)}}function k(w){n(r)&&w.pointerId===n(h)&&(P(r,!1),P(h,null),P(u,0),n(d)?.hasPointerCapture?.(w.pointerId)&&n(d).releasePointerCapture(w.pointerId))}he(()=>{if(!n(a)||!n(c))return;const w=()=>{const O=n(a)?.querySelector(".pitch-wheel-option");O&&P(f,O.offsetHeight||o,!0)};w();const L=new ResizeObserver(()=>{w()});return L.observe(n(c)),()=>{L.disconnect()}});var x=ti();x.__keydown=_,x.__pointerdown=H,x.__pointermove=Y,x.__pointerup=k;let V;var Z=C(x),se=C(Z);let $;Fe(se,23,()=>t.options,w=>w.index,(w,L,O)=>{var z=ei(),oe=C(z);J(()=>{Me(z,"data-distance",n(v)[n(O)]),U(oe,n(L).label)}),W(w,z)}),de(se,w=>P(a,w),()=>n(a)),de(Z,w=>P(c,w),()=>n(c)),de(x,w=>P(d,w),()=>n(d)),J(()=>{Me(x,"aria-label",s()),Me(x,"aria-valuemax",t.options.length-1),Me(x,"aria-valuenow",i()),Me(x,"aria-valuetext",t.options[i()]?.label??""),V=Ke(x,"",V,{height:t.wheelHeight?`${t.wheelHeight}px`:"100%"}),$=Ke(se,"",$,{"padding-top":`${n(p)??""}px`,"padding-bottom":`${n(p)??""}px`,transform:`translateY(${n(S)??""}px)`})}),Be("wheel",x,E),Be("pointercancel",x,k),Be("pointerleave",x,k),W(e,x),ie()}ge(["keydown","pointerdown","pointermove","pointerup"]);const It=7;function We(e,t,i){return Number.isFinite(e)?Math.max(t,Math.min(i,Math.round(e))):t}function ni(e,t,i,s=It){const o=Math.max(0,i-1),l=We(e,0,o),d=Math.max(1,Math.round(s)),c=Math.max(0,l-(d-1));return We(t,0,c)}function ii(e,t,i,s=It){const o=Math.max(0,i-1),l=We(e,0,o),d=Math.max(1,Math.round(s)),c=Math.min(o,l+(d-1));return We(t,c,o)}function oi(e){return e.map((t,i)=>({index:i,label:t.pitch,midi:t.midi,toneNote:t.toneNote,frequency:t.frequency}))}var ai=N('<div class="summary-card svelte-yqjxxp"><div class="summary-label svelte-yqjxxp"> </div> <div class="summary-metadata svelte-yqjxxp"> </div></div>'),si=N('<div class="dual-pitch-wheel svelte-yqjxxp"><div class="wheels-container svelte-yqjxxp"><div class="wheel-column svelte-yqjxxp"><div class="wheel-label svelte-yqjxxp">High</div> <!></div> <div class="wheel-column svelte-yqjxxp"><div class="wheel-label svelte-yqjxxp">Low</div> <!></div></div> <!></div>');function ri(e,t){ne(t,!0);let i=G(t,"topIndex",15),s=G(t,"bottomIndex",15),o=G(t,"minSpan",3,7),l=G(t,"showSummary",3,!0);const d=A(()=>oi(t.fullRowData)),c=A(()=>({topIndex:i(),bottomIndex:s(),topPitch:t.fullRowData[i()],bottomPitch:t.fullRowData[s()],span:s()-i()+1})),a=A(()=>n(c).topPitch&&n(c).bottomPitch?`${n(c).topPitch.pitch} – ${n(c).bottomPitch.pitch}`:""),r=A(()=>`${n(c).span} ${n(c).span===1?"pitch":"pitches"}`);function h(_){return ni(s(),_,n(d).length,o())}function y(_){return ii(i(),_,n(d).length,o())}function u(_,H){i(_),typeof t.onrangechange=="function"&&t.onrangechange(n(c))}function f(_,H){s(_),typeof t.onrangechange=="function"&&t.onrangechange(n(c))}var v=si(),g=C(v),p=C(g),m=I(C(p),2);at(m,{get options(){return n(d)},get selectedIndex(){return i()},onchange:u,onbeforechange:h,get wheelHeight(){return t.wheelHeight},ariaLabel:"High pitch selector"});var S=I(p,2),b=I(C(S),2);at(b,{get options(){return n(d)},get selectedIndex(){return s()},onchange:f,onbeforechange:y,get wheelHeight(){return t.wheelHeight},ariaLabel:"Low pitch selector"});var T=I(g,2);{var E=_=>{var H=ai(),Y=C(H),k=C(Y),x=I(Y,2),V=C(x);J(()=>{U(k,n(a)),U(V,n(r))}),W(_,H)};ae(T,_=>{l()&&_(E)})}W(e,v),ie()}ge(["change"]);const st={isDetecting:!1,visualizationMode:"stationary",tonic:"C",useDegrees:!1,showAccidentals:!0,yAxisRange:{minMidi:48,maxMidi:72},drone:{isPlaying:!1,octave:3,volume:-12}};function li(){let e=q(Ae({...st}));return{get state(){return n(e)},toggleDetecting(){n(e).isDetecting=!n(e).isDetecting},setDetecting(t){n(e).isDetecting=t},setVisualizationMode(t){n(e).visualizationMode=t},setTonic(t){n(e).tonic=t},setUseDegrees(t){n(e).useDegrees=t},setShowAccidentals(t){n(e).showAccidentals=t},setYAxisRange(t){n(e).yAxisRange=t},expandYAxisUpper(){n(e).yAxisRange.maxMidi<108&&(n(e).yAxisRange={...n(e).yAxisRange,maxMidi:n(e).yAxisRange.maxMidi+1})},contractYAxisUpper(){n(e).yAxisRange.maxMidi>n(e).yAxisRange.minMidi+6&&(n(e).yAxisRange={...n(e).yAxisRange,maxMidi:n(e).yAxisRange.maxMidi-1})},expandYAxisLower(){n(e).yAxisRange.minMidi>21&&(n(e).yAxisRange={...n(e).yAxisRange,minMidi:n(e).yAxisRange.minMidi-1})},contractYAxisLower(){n(e).yAxisRange.minMidi<n(e).yAxisRange.maxMidi-6&&(n(e).yAxisRange={...n(e).yAxisRange,minMidi:n(e).yAxisRange.minMidi+1})},toggleDrone(){n(e).drone={...n(e).drone,isPlaying:!n(e).drone.isPlaying}},setDroneOctave(t){n(e).drone={...n(e).drone,octave:t}},setDroneVolume(t){n(e).drone={...n(e).drone,volume:t}},reset(){P(e,{...st},!0)}}}const R=li(),ci=200,rt={currentPitch:null,history:[],stablePitch:{pitchClass:null,opacity:0,size:1}};function di(){let e=q(Ae({...rt}));return{get state(){return n(e)},setCurrentPitch(t){n(e).currentPitch=t},addHistoryPoint(t){n(e).history.push(t),n(e).history.length>ci&&n(e).history.shift()},setStablePitch(t){n(e).stablePitch=t},clearHistory(){n(e).history=[]},reset(){P(e,{...rt},!0)}}}const B=di(),lt={isPlaying:!1,startTime:null,currentTimeMs:0,targetNotes:[],nowLineX:100,pixelsPerSecond:200,timeWindowMs:4e3};function ui(){let e=q(Ae({...lt})),t=null;function i(){n(e).isPlaying&&n(e).startTime!==null&&(n(e).currentTimeMs=performance.now()-n(e).startTime,t=requestAnimationFrame(i))}return{get state(){return n(e)},start(){n(e).isPlaying=!0,n(e).startTime=performance.now(),n(e).currentTimeMs=0,t=requestAnimationFrame(i)},stop(){n(e).isPlaying=!1,t!==null&&(cancelAnimationFrame(t),t=null)},pause(){n(e).isPlaying=!1,t!==null&&(cancelAnimationFrame(t),t=null)},resume(){if(n(e).startTime!==null){const s=performance.now()-(n(e).startTime+n(e).currentTimeMs);n(e).startTime+=s,n(e).isPlaying=!0,t=requestAnimationFrame(i)}},setTargetNotes(s){n(e).targetNotes=s},markNoteHit(s){s>=0&&s<n(e).targetNotes.length&&(n(e).targetNotes=n(e).targetNotes.map((o,l)=>l===s?{...o,hit:!0}:o))},setNowLineX(s){n(e).nowLineX=s},setPixelsPerSecond(s){n(e).pixelsPerSecond=s},setTimeWindowMs(s){n(e).timeWindowMs=s},reset(){t!==null&&(cancelAnimationFrame(t),t=null),P(e,{...lt},!0)}}}const Se=ui();var hi=N('<div class="singing-canvas-container svelte-15ar5r5"><!> <canvas class="pitch-trail-canvas svelte-15ar5r5"></canvas></div>');function fi(e,t){ne(t,!0);let i=q(void 0),s=q(800),o=q(400),l=q(void 0),d=q(null),c=q(null),a=0,r=0,h=0;const y=20,u=!0,f=!1,v=3,g=A(()=>y*v),p=A(()=>n(g)*2),m=A(()=>n(p)*2),S=A(()=>Math.max(0,n(s)-n(m))),b=A(()=>n(p)),T=()=>{try{return!!globalThis.__ST_DEBUG_TRAIL}catch{return!1}},E=A(()=>Ot(R.state.yAxisRange.minMidi,R.state.yAxisRange.maxMidi)),_=A(()=>Nt({containerHeight:n(o),fullRowData:n(E),preferredCellHeight:40,minCellHeight:20})),H=A(()=>R.state.visualizationMode==="highway"?"highway":"singing");function Y(){return Se.state.targetNotes.map((D,j)=>({id:`target-${j}`,midi:D.midi,startTimeMs:D.startTimeMs,durationMs:D.durationMs}))}const k=A(()=>({timeWindowMs:4e3,pixelsPerSecond:200,circleRadius:9.5,proximityThreshold:35,maxConnections:3,connectorLineWidth:2.5,connectorColor:"rgba(0,0,0,0.4)",useTonicRelativeColors:!0,tonicPitchClass:bn(R.state.tonic),clarityThreshold:.5,maxOpacity:.9})),x=A(()=>n(H)==="singing"?{userPitch:B.state.currentPitch?{frequency:B.state.currentPitch.frequency,midi:B.state.currentPitch.midi,clarity:B.state.currentPitch.clarity,pitchClass:B.state.currentPitch.pitchClass}:null,pitchHistory:[],targetNotes:[],pixelsPerSecond:200,timeWindowMs:4e3,trailConfig:n(k)}:void 0),V=A(()=>n(H)==="highway"?{userPitch:B.state.currentPitch?{frequency:B.state.currentPitch.frequency,midi:B.state.currentPitch.midi,clarity:B.state.currentPitch.clarity,pitchClass:B.state.currentPitch.pitchClass}:null,pitchHistory:[],targetNotes:Y(),nowLineX:Se.state.nowLineX,pixelsPerSecond:Se.state.pixelsPerSecond,currentTimeMs:Se.state.currentTimeMs,timeWindowMs:Se.state.timeWindowMs,trailConfig:n(k)}:void 0),Z=A(()=>({startRow:n(_).startRow,endRow:n(_).endRow,zoomLevel:1,containerWidth:n(s),containerHeight:n(o)}));function se(){if(!n(l))return;const D=window.devicePixelRatio||1;n(l).width=n(S)*D,n(l).height=n(o)*D,n(l).style.width=`${n(S)}px`,n(l).style.height=`${n(o)}px`,n(l).style.left=`${n(b)}px`;const j=n(l).getContext("2d");if(!j){P(d,null);return}j.setTransform(D,0,0,D,0,0),P(d,j,!0)}function $(){if(!n(d)||n(S)<=0)return;n(d).clearRect(0,0,n(S),n(o));const D=B.state.history;if(D.length===0||n(H)!=="singing"||!n(x))return;const j=T(),ee=j?performance.now():0,ve=pt({cellHeight:n(_).cellHeight,viewport:n(Z),pixelsPerSecond:n(x).pixelsPerSecond??200,nowLineX:100,currentTimeMs:0}),me={cellHeight:n(_).cellHeight,viewportWidth:n(S),pixelsPerSecond:n(x).pixelsPerSecond??200,timeWindowMs:n(x).timeWindowMs??4e3,colorMode:"color",trailConfig:n(k)},ue=performance.now();if(_t(n(d),ve,D,ue,me,n(E)),j){const re=performance.now();if(r+=1,h+=re-ee,re-a>=1e3){const be=r>0?h/r:0;console.log(`[SingingTrail] points=${D.length} avgMs=${be.toFixed(2)} gridWidth=${n(S)}`),a=re,r=0,h=0}}}function w(){if(n(c))return;const D=()=>{$(),P(c,requestAnimationFrame(D),!0)};P(c,requestAnimationFrame(D),!0)}function L(){n(c)&&(cancelAnimationFrame(n(c)),P(c,null)),n(d)&&n(S)>0&&n(d).clearRect(0,0,n(S),n(o))}he(()=>{if(!n(i))return;const D=new ResizeObserver(j=>{for(const ee of j)P(s,ee.contentRect.width,!0),P(o,ee.contentRect.height,!0)});return D.observe(n(i)),()=>{D.disconnect()}}),he(()=>{n(S),n(o),n(b),n(l),se()}),he(()=>{n(H),n(d),n(H)==="singing"?w():L()}),ft(()=>{L()});var O=hi(),z=C(O);$n(z,{get mode(){return n(H)},get fullRowData(){return n(E)},get viewport(){return n(Z)},cellWidth:y,get cellHeight(){return n(_).cellHeight},colorMode:"color",showOctaveLabels:u,showFrequencyLabels:f,get singingConfig(){return n(x)},get highwayConfig(){return n(V)}});var oe=I(z,2);de(oe,D=>P(l,D),()=>n(l)),de(O,D=>P(i,D),()=>n(i)),W(e,O),ie()}const ce={FFT_SIZE:2048,CLARITY_THRESHOLD:.8,MIN_PITCH_HZ:60,MAX_PITCH_HZ:1600,STABILITY_THRESHOLD:15,HIGHLIGHT_FADE_SPEED:.2};let we=null,ye=null,ke=null,fe=null,Ne=!1,Pe=-1,_e=0,ct=0,dt=1;function gi(e){return 12*Math.log2(e/440)+69}function Ht(){if(!Ne||!ye||!ke){fe=null;return}const e=ye.getValue(),[t,i]=ke.findPitch(e,hn().sampleRate),s=t!==null&&i>ce.CLARITY_THRESHOLD&&t>ce.MIN_PITCH_HZ&&t<ce.MAX_PITCH_HZ;if(s){const a=gi(t),r={frequency:t,midi:a,clarity:i,pitchClass:Math.round(a)%12};B.setCurrentPitch(r),B.addHistoryPoint({frequency:t,midi:a,time:performance.now(),clarity:i})}else B.addHistoryPoint({frequency:0,midi:0,time:performance.now(),clarity:0});const o=s&&B.state.currentPitch?Math.round(B.state.currentPitch.midi)%12:-1;o===Pe&&o!==-1?_e++:(_e=0,Pe=o),ct=_e>=ce.STABILITY_THRESHOLD?1:0,dt=_e>=ce.STABILITY_THRESHOLD?1.05:1;const l=B.state.stablePitch,d=l.opacity+(ct-l.opacity)*ce.HIGHLIGHT_FADE_SPEED,c=l.size+(dt-l.size)*ce.HIGHLIGHT_FADE_SPEED;B.setStablePitch({pitchClass:Pe>=0?Pe:null,opacity:d,size:c}),fe=requestAnimationFrame(Ht)}async function vi(){if(!Ne){fe!==null&&cancelAnimationFrame(fe),we=new dn,ye=new un("waveform",ce.FFT_SIZE),ke=vn.forFloat32Array(ye.size);try{await wt(),await we.open(),we.connect(ye),Ne=!0,Ht()}catch(e){throw console.error("Microphone access denied or failed:",e),At(),e}}}function mi(){Ne=!1,At()}function At(){fe!==null&&(cancelAnimationFrame(fe),fe=null),we&&(we.close(),we=null),ye=null,ke=null,_e=0,Pe=-1,B.setStablePitch({pitchClass:null,opacity:0,size:1}),B.setCurrentPitch(null)}var wi=N('<span class="spinner svelte-cytsjj"></span> Starting...',1),yi=N('<span class="icon svelte-cytsjj">&#9632;</span> Stop',1),bi=N('<span class="icon svelte-cytsjj">&#9654;</span> Start',1),pi=N("<button><!></button>");function Mi(e,t){ne(t,!0);let i=q(!1);async function s(){if(!n(i))if(R.state.isDetecting)mi(),R.setDetecting(!1),B.reset();else{P(i,!0);try{await vi(),R.setDetecting(!0)}catch(r){console.error("Failed to start detection:",r),alert("Could not access microphone. Please grant permission and try again.")}finally{P(i,!1)}}}var o=pi();let l;o.__click=s;var d=C(o);{var c=r=>{var h=wi();W(r,h)},a=r=>{var h=cn(),y=mt(h);{var u=v=>{var g=yi();W(v,g)},f=v=>{var g=bi();W(v,g)};ae(y,v=>{R.state.isDetecting?v(u):v(f,!1)},!0)}W(r,h)};ae(d,r=>{n(i)?r(c):r(a,!1)})}J(()=>{l=Oe(o,1,"start-button svelte-cytsjj",null,l,{active:R.state.isDetecting,loading:n(i)}),o.disabled=n(i)}),W(e,o),ie()}ge(["click"]);let te=null,Ie=!1,He=null;function Ci(){var e;if(!te){te=new fn(gn,{oscillator:{type:"sawtooth"},envelope:{attack:.3,decay:.1,sustain:.8,release:.5}}).toDestination();const t=((e=te.get().oscillator)==null?void 0:e.type)??"unknown";console.log("[DroneAudio] Initialized drone synth",{oscillatorType:t})}return te}function Rt(e,t){return`${e.replace("b","#").replace("Db","C#").replace("Eb","D#").replace("Gb","F#").replace("Ab","G#").replace("Bb","A#")}${t}`}async function Si(){await wt();const e=Ci(),t=Rt(R.state.tonic,R.state.drone.octave);e.volume.value=R.state.drone.volume,console.log("[DroneAudio] Starting drone",{note:t,volume:e.volume.value}),He&&e.releaseAll(),He=t,e.triggerAttack(t),Ie=!0}function Pi(){te&&Ie&&(te.releaseAll(),He=null,Ie=!1)}function ze(){if(!Ie||!te)return;const e=Rt(R.state.tonic,R.state.drone.octave);te.volume.value=R.state.drone.volume,console.log("[DroneAudio] Updating drone",{note:e,volume:te.volume.value}),e!==He&&(te.releaseAll(),te.triggerAttack(e),He=e)}async function _i(){Ie?Pi():await Si()}var Ti=N("<option> </option>"),Ii=N('<div class="tonic-selector svelte-16h7our"><label for="tonic-select" class="svelte-16h7our">Key:</label> <select id="tonic-select" class="svelte-16h7our"></select></div>');function Hi(e,t){ne(t,!0);const i=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function s(c){const a=c.target;R.setTonic(a.value),ze()}var o=Ii(),l=I(C(o),2);l.__change=s,Fe(l,21,()=>i,Ge,(c,a)=>{var r=Ti(),h=C(r),y={};J(()=>{U(h,n(a)),y!==(y=n(a))&&(r.value=(r.__value=n(a))??"")}),W(c,r)});var d;yt(l),J(()=>{d!==(d=R.state.tonic)&&(l.value=(l.__value=R.state.tonic)??"",je(l,R.state.tonic))}),W(e,o),ie()}ge(["change"]);var Ai=N("<option> </option>"),Ri=N('<div class="drone-controls svelte-1rkr6nv"><button> </button> <div class="drone-settings svelte-1rkr6nv"><label class="svelte-1rkr6nv">Oct: <select class="svelte-1rkr6nv"></select></label> <label class="svelte-1rkr6nv">Vol: <input type="range" min="-40" max="0" class="svelte-1rkr6nv"/></label></div></div>');function xi(e,t){ne(t,!0);const i=[2,3,4,5];async function s(){await _i(),R.toggleDrone()}function o(p){const m=p.target;R.setDroneOctave(parseInt(m.value,10)),ze()}function l(p){const m=p.target;R.setDroneVolume(parseInt(m.value,10)),ze()}var d=Ri(),c=C(d);let a;c.__click=s;var r=C(c),h=I(c,2),y=C(h),u=I(C(y));u.__change=o,Fe(u,21,()=>i,Ge,(p,m)=>{var S=Ai(),b=C(S),T={};J(()=>{U(b,n(m)),T!==(T=n(m))&&(S.value=(S.__value=n(m))??"")}),W(p,S)});var f;yt(u);var v=I(y,2),g=I(C(v));g.__input=l,J(()=>{a=Oe(c,1,"drone-toggle svelte-1rkr6nv",null,a,{active:R.state.drone.isPlaying}),U(r,R.state.drone.isPlaying?"Drone On":"Drone Off"),f!==(f=R.state.drone.octave)&&(u.value=(u.__value=R.state.drone.octave)??"",je(u,R.state.drone.octave)),ln(g,R.state.drone.volume)}),W(e,d),ie()}ge(["click","change","input"]);var Di=N("<button> </button>"),Li=N('<div class="mode-toggle svelte-i9tkj4"></div>');function Wi(e,t){ne(t,!0);const i=[{value:"stationary",label:"Stationary"},{value:"highway",label:"Highway"}];function s(l){R.setVisualizationMode(l)}var o=Li();Fe(o,21,()=>i,Ge,(l,d)=>{let c=()=>n(d).value,a=()=>n(d).label;var r=Di();let h;r.__click=()=>s(c());var y=C(r);J(()=>{h=Oe(r,1,"mode-button svelte-i9tkj4",null,h,{active:R.state.visualizationMode===c()}),U(y,a())}),W(l,r)}),W(e,o),ie()}ge(["click"]);var ki=N('<div class="range-control svelte-1es7ond"><h3 class="control-title svelte-1es7ond">Pitch Range</h3> <!></div>');function Ni(e,t){ne(t,!0);function i(a){const r=Ze.findIndex(h=>h.midi===a);return r>=0?r:0}const s=A(()=>i(R.state.yAxisRange.maxMidi)),o=A(()=>i(R.state.yAxisRange.minMidi));function l(a){const r=a.bottomPitch.midi??21,h=a.topPitch.midi??108;R.setYAxisRange({minMidi:r,maxMidi:h})}var d=ki(),c=I(C(d),2);ri(c,{get fullRowData(){return Ze},get topIndex(){return n(s)},get bottomIndex(){return n(o)},minSpan:7,onrangechange:l,showSummary:!0,wheelHeight:200}),W(e,d),ie()}var Oi=N('<div class="note-display svelte-1hjl33a"><span class="note-name svelte-1hjl33a"> </span> <span class="octave svelte-1hjl33a"> </span></div> <div class="details svelte-1hjl33a"><span class="frequency"> </span> <span> </span> <span class="clarity"> </span></div>',1),Fi=N('<div class="no-pitch svelte-1hjl33a"><span class="placeholder svelte-1hjl33a">---</span> <span class="hint svelte-1hjl33a">Sing or hum into the microphone</span></div>'),qi=N('<div class="pitch-readout svelte-1hjl33a"><!></div>');function Ei(e,t){ne(t,!0);const i=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],s=A(()=>()=>{const a=B.state.currentPitch;if(!a)return null;const r=i[a.pitchClass],h=Math.floor(a.midi/12)-1,y=Math.round((a.midi-Math.round(a.midi))*100);return{name:r,octave:h,frequency:a.frequency.toFixed(1),cents:y,clarity:Math.round(a.clarity*100)}});var o=qi(),l=C(o);{var d=a=>{const r=A(()=>n(s)());var h=Oi(),y=mt(h),u=C(y),f=C(u),v=I(u,2),g=C(v),p=I(y,2),m=C(p),S=C(m),b=I(m,2);let T;var E=C(b),_=I(b,2),H=C(_);J(()=>{U(f,n(r).name),U(g,n(r).octave),U(S,`${n(r).frequency??""} Hz`),T=Oe(b,1,"cents svelte-1hjl33a",null,T,{sharp:n(r).cents>0,flat:n(r).cents<0}),U(E,`${n(r).cents>0?"+":""}${n(r).cents??""}¢`),U(H,`${n(r).clarity??""}%`)}),W(a,h)},c=a=>{var r=Fi();W(a,r)};ae(l,a=>{n(s)()?a(d):a(c,!1)})}W(e,o),ie()}const Xe={hasImportedSnapshot:!1,snapshot:null,isLoading:!1,error:null,transpositionSemitones:0};function Bi(){let e=q(Ae({...Xe}));return{get state(){return n(e)},async checkAndConsumeHandoff(){if(!Wt())return!1;n(e).isLoading=!0,n(e).error=null;try{const t=await kt();return t?t.schemaVersion!==Ve?(n(e).error=`Incompatible snapshot version: ${t.schemaVersion}. Expected: ${Ve}`,n(e).isLoading=!1,Re(),!1):(n(e).snapshot=t,n(e).hasImportedSnapshot=!0,n(e).isLoading=!1,Re(),console.log("[HandoffState] Successfully imported snapshot",{voices:t.voices.length,microbeatCount:t.timeGrid.microbeatCount,tempo:t.tempo}),!0):(n(e).error="Handoff data expired or not found. Please try exporting again.",n(e).isLoading=!1,Re(),!1)}catch(t){return console.error("[HandoffState] Failed to process handoff",t),n(e).error="Failed to import data from Student Notation.",n(e).isLoading=!1,Re(),!1}},get voices(){var t;return((t=n(e).snapshot)==null?void 0:t.voices)??[]},get timeGrid(){var t;return((t=n(e).snapshot)==null?void 0:t.timeGrid)??null},get tempo(){var t;return((t=n(e).snapshot)==null?void 0:t.tempo)??90},get suggestedPitchRange(){if(!n(e).snapshot)return null;const t=3,i=n(e).snapshot.minMidiPitch,s=n(e).snapshot.maxMidiPitch;return i===void 0||s===void 0?null:{minMidi:Math.max(21,i-t+n(e).transpositionSemitones),maxMidi:Math.min(108,s+t+n(e).transpositionSemitones)}},setTransposition(t){n(e).transpositionSemitones=t},transposeUp(){n(e).transpositionSemitones+=1},transposeDown(){n(e).transpositionSemitones-=1},getTransposedMidi(t){return t+n(e).transpositionSemitones},async bringBackToStudentNotation(){if(!n(e).snapshot){console.warn("[HandoffState] No snapshot to bring back");return}const t={...n(e).snapshot,sourceApp:"singing-trainer",createdAt:Date.now(),voices:n(e).snapshot.voices.map(i=>({...i,notes:i.notes.map(s=>({...s,midiPitch:s.midiPitch+n(e).transpositionSemitones}))}))};try{const i=await Dt(t);console.log("[HandoffState] Handoff slot written for return",i),Lt(i)}catch(i){console.error("[HandoffState] Failed to write return handoff",i)}},clearSnapshot(){P(e,{...Xe},!0)},reset(){P(e,{...Xe},!0)}}}const Q=Bi();var Xi=N('<div class="handoff-controls svelte-1n46o8q"><div class="transposition-control svelte-1n46o8q"><button class="transpose-btn svelte-1n46o8q" title="Transpose down">-</button> <span class="transposition-label svelte-1n46o8q"> </span> <button class="transpose-btn svelte-1n46o8q" title="Transpose up">+</button></div> <button class="bring-back-btn svelte-1n46o8q">Bring Back to Student Notation</button></div>'),Yi=N('<div class="error-banner svelte-1n46o8q"> </div>'),zi=N('<div class="import-info svelte-1n46o8q"><span class="import-label svelte-1n46o8q">Microbeats:</span> <span class="import-value svelte-1n46o8q"> </span></div>'),Gi=N('<div class="control-group svelte-1n46o8q"><h3 class="control-group-title svelte-1n46o8q">Imported Material</h3> <div class="import-info svelte-1n46o8q"><span class="import-label svelte-1n46o8q">Voices:</span> <span class="import-value svelte-1n46o8q"> </span></div> <div class="import-info svelte-1n46o8q"><span class="import-label svelte-1n46o8q">Tempo:</span> <span class="import-value svelte-1n46o8q"> </span></div> <!></div>'),ji=N('<div class="app svelte-1n46o8q"><header class="header svelte-1n46o8q"><h1 class="title svelte-1n46o8q">Singing Trainer</h1> <div class="header-controls svelte-1n46o8q"><!> <!></div></header> <!> <main class="main svelte-1n46o8q"><aside class="sidebar sidebar--left svelte-1n46o8q"><div class="control-group svelte-1n46o8q"><!></div> <div class="control-group svelte-1n46o8q"><!></div> <div class="control-group svelte-1n46o8q"><h3 class="control-group-title svelte-1n46o8q">Settings</h3> <!> <!></div> <div class="control-group svelte-1n46o8q"><!></div> <!></aside> <section class="canvas-area svelte-1n46o8q"><!></section></main></div>');function Ui(e,t){ne(t,!0),ht(async()=>{if(await Q.checkAndConsumeHandoff()){console.log("[App] Handoff detected and processed");const w=Q.suggestedPitchRange;w&&R.setYAxisRange(w)}});const i=A(()=>Q.state.hasImportedSnapshot),s=A(()=>Q.state.transpositionSemitones),o=A(()=>Q.state.error);function l(){Q.bringBackToStudentNotation()}function d(){Q.transposeUp()}function c(){Q.transposeDown()}var a=ji(),r=C(a),h=I(C(r),2),y=C(h);{var u=w=>{var L=Xi(),O=C(L),z=C(O);z.__click=c;var oe=I(z,2),D=C(oe),j=I(oe,2);j.__click=d;var ee=I(O,2);ee.__click=l,J(()=>U(D,`${n(s)>=0?"+":""}${n(s)??""}`)),W(w,L)};ae(y,w=>{n(i)&&w(u)})}var f=I(y,2);Wi(f,{});var v=I(r,2);{var g=w=>{var L=Yi(),O=C(L);J(()=>U(O,n(o))),W(w,L)};ae(v,w=>{n(o)&&w(g)})}var p=I(v,2),m=C(p),S=C(m),b=C(S);Mi(b,{});var T=I(S,2),E=C(T);Ei(E,{});var _=I(T,2),H=I(C(_),2);Hi(H,{});var Y=I(H,2);xi(Y,{});var k=I(_,2),x=C(k);Ni(x,{});var V=I(k,2);{var Z=w=>{var L=Gi(),O=I(C(L),2),z=I(C(O),2),oe=C(z),D=I(O,2),j=I(C(D),2),ee=C(j),ve=I(D,2);{var me=ue=>{var re=zi(),be=I(C(re),2),qe=C(be);J(()=>U(qe,Q.timeGrid.microbeatCount)),W(ue,re)};ae(ve,ue=>{Q.timeGrid&&ue(me)})}J(()=>{U(oe,Q.voices.length),U(ee,`${Q.tempo??""} BPM`)}),W(w,L)};ae(V,w=>{n(i)&&w(Z)})}var se=I(m,2),$=C(se);fi($,{}),W(e,a),ie()}ge(["click"]);function Vi(e){const t=sn(Ui,{target:e});return{destroy:()=>rn(t)}}const Zi=Vi,ut=document.getElementById("app");ut&&Zi(ut);
