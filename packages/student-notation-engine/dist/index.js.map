{"version":3,"file":"index.js","sources":["../src/controller.ts","../../pitch-data/src/pitchData.ts","../../pitch-data/src/pitchUtils.ts","../src/state/initialState.ts","../src/state/store.ts","../src/audio/FilteredVoice.ts","../src/audio/GainManager.ts","../src/audio/ClippingMonitor.ts","../src/audio/synthEngine.ts","../src/audio/transportService.ts","../src/audio/contextConfig.ts","../src/canvas/pitchGridRenderer.ts","../src/canvas/drumGridRenderer.ts","../src/transport/timeMapCalculator.ts","../src/transport/drumManager.ts","../src/index.ts"],"sourcesContent":["/**\n * Student Notation Engine - Public Controller API\n *\n * This is the main public interface for the engine. It provides a clean,\n * framework-agnostic API for UI components and tutorial systems to control\n * the notation editor.\n *\n * IMPORTANT: This controller does NOT depend on DOM IDs or any specific UI framework.\n * Canvas contexts and other DOM refs should be passed in during initialization.\n */\n\nimport type {\n  AppState,\n  PlacedNote,\n  NoteShape,\n  PitchRange,\n  ADSREnvelope,\n  FilterSettings,\n  LassoSelection,\n  DegreeDisplayMode,\n  PlayheadMode,\n  LongNoteStyle,\n  CanvasSpaceColumn,\n} from '@mlt/types';\n\n/**\n * Configuration for engine initialization\n */\nexport interface EngineConfig {\n  /** Canvas context for the pitch grid */\n  pitchGridContext?: CanvasRenderingContext2D;\n  /** Canvas context for the pitch grid playhead */\n  pitchPlayheadContext?: CanvasRenderingContext2D;\n  /** Canvas context for the pitch grid hover indicator */\n  pitchHoverContext?: CanvasRenderingContext2D;\n  /** Canvas context for the drum grid */\n  drumGridContext?: CanvasRenderingContext2D;\n  /** Canvas context for the drum grid playhead */\n  drumPlayheadContext?: CanvasRenderingContext2D;\n  /** Canvas context for the drum grid hover indicator */\n  drumHoverContext?: CanvasRenderingContext2D;\n  /** Initial state (optional, for restoring saved state) */\n  initialState?: Partial<AppState>;\n  /** Storage key for localStorage persistence */\n  storageKey?: string;\n}\n\n/**\n * Selection item for multi-select operations\n */\nexport interface SelectionItem {\n  type: 'note' | 'sixteenthStamp' | 'tripletStamp';\n  id: string;\n}\n\n/**\n * Event callback type\n */\nexport type EventCallback<T = unknown> = (data: T) => void;\n\n/**\n * The main engine controller interface\n */\nexport interface EngineController {\n  // ============================================================================\n  // INITIALIZATION\n  // ============================================================================\n\n  /**\n   * Initialize the engine with configuration\n   */\n  init(config: EngineConfig): void;\n\n  /**\n   * Dispose of the engine and clean up resources\n   */\n  dispose(): void;\n\n  /**\n   * Check if engine is initialized\n   */\n  isInitialized(): boolean;\n\n  // ============================================================================\n  // TOOL SELECTION\n  // ============================================================================\n\n  /**\n   * Set the current editing tool\n   */\n  setTool(tool: 'note' | 'eraser' | 'chord' | 'tonic' | 'modulation' | 'sixteenth' | 'triplet'): void;\n\n  /**\n   * Get the current tool\n   */\n  getTool(): string;\n\n  /**\n   * Set the note shape for the note tool\n   */\n  setNoteShape(shape: NoteShape): void;\n\n  /**\n   * Set the note color for the note tool\n   */\n  setNoteColor(color: string): void;\n\n  // ============================================================================\n  // NOTE MANIPULATION\n  // ============================================================================\n\n  /**\n   * Insert a new note at the specified position\n   */\n  insertNote(row: number, startColumn: number, endColumn?: number): PlacedNote | null;\n\n  /**\n   * Delete a note by ID\n   */\n  deleteNote(noteId: string): boolean;\n\n  /**\n   * Delete all selected items\n   */\n  deleteSelection(): void;\n\n  /**\n   * Move a note to a new position\n   */\n  moveNote(noteId: string, toRow: number, toColumn: number): void;\n\n  /**\n   * Update a note's tail (end column)\n   */\n  setNoteTail(noteId: string, endColumn: number): void;\n\n  /**\n   * Clear all notes\n   */\n  clearAllNotes(): void;\n\n  // ============================================================================\n  // SELECTION\n  // ============================================================================\n\n  /**\n   * Set the current selection\n   */\n  setSelection(items: SelectionItem[]): void;\n\n  /**\n   * Clear the current selection\n   */\n  clearSelection(): void;\n\n  /**\n   * Select all items\n   */\n  selectAll(): void;\n\n  /**\n   * Get current selection\n   */\n  getSelection(): LassoSelection;\n\n  /**\n   * Check if there's an active selection\n   */\n  hasSelection(): boolean;\n\n  // ============================================================================\n  // PLAYBACK\n  // ============================================================================\n\n  /**\n   * Start playback from the beginning\n   */\n  play(): void;\n\n  /**\n   * Pause playback\n   */\n  pause(): void;\n\n  /**\n   * Resume paused playback\n   */\n  resume(): void;\n\n  /**\n   * Stop playback and reset to beginning\n   */\n  stop(): void;\n\n  /**\n   * Check if currently playing\n   */\n  isPlaying(): boolean;\n\n  /**\n   * Check if currently paused\n   */\n  isPaused(): boolean;\n\n  /**\n   * Set the tempo in BPM\n   */\n  setTempo(bpm: number): void;\n\n  /**\n   * Get the current tempo\n   */\n  getTempo(): number;\n\n  /**\n   * Enable or disable looping\n   */\n  setLooping(enabled: boolean): void;\n\n  /**\n   * Check if looping is enabled\n   */\n  isLooping(): boolean;\n\n  /**\n   * Set the playhead visualization mode\n   */\n  setPlayheadMode(mode: PlayheadMode): void;\n\n  // ============================================================================\n  // HISTORY\n  // ============================================================================\n\n  /**\n   * Undo the last action\n   */\n  undo(): void;\n\n  /**\n   * Redo the last undone action\n   */\n  redo(): void;\n\n  /**\n   * Check if undo is available\n   */\n  canUndo(): boolean;\n\n  /**\n   * Check if redo is available\n   */\n  canRedo(): boolean;\n\n  /**\n   * Record current state for undo\n   */\n  recordState(): void;\n\n  // ============================================================================\n  // RHYTHM STRUCTURE\n  // ============================================================================\n\n  /**\n   * Add a macrobeat to the end\n   */\n  addMacrobeat(): void;\n\n  /**\n   * Remove the last macrobeat\n   */\n  removeMacrobeat(): void;\n\n  /**\n   * Set the grouping for a specific macrobeat\n   */\n  setMacrobeatGrouping(index: number, grouping: 2 | 3): void;\n\n  /**\n   * Toggle anacrusis (pickup measure)\n   */\n  toggleAnacrusis(): void;\n\n  // ============================================================================\n  // VIEW\n  // ============================================================================\n\n  /**\n   * Set the visible pitch range\n   */\n  setPitchRange(topIndex: number, bottomIndex: number): void;\n\n  /**\n   * Get the current pitch range\n   */\n  getPitchRange(): PitchRange;\n\n  /**\n   * Set degree display mode\n   */\n  setDegreeDisplayMode(mode: DegreeDisplayMode): void;\n\n  /**\n   * Set the long note rendering style\n   */\n  setLongNoteStyle(style: LongNoteStyle): void;\n\n  // ============================================================================\n  // TIMBRE\n  // ============================================================================\n\n  /**\n   * Set ADSR envelope for a timbre\n   */\n  setTimbreADSR(color: string, adsr: Partial<ADSREnvelope>): void;\n\n  /**\n   * Set harmonic coefficients for a timbre\n   */\n  setTimbreHarmonics(color: string, coeffs: number[]): void;\n\n  /**\n   * Set filter settings for a timbre\n   */\n  setTimbreFilter(color: string, settings: Partial<FilterSettings>): void;\n\n  // ============================================================================\n  // STATE ACCESS\n  // ============================================================================\n\n  /**\n   * Get a readonly snapshot of the current state\n   */\n  getState(): Readonly<AppState>;\n\n  /**\n   * Get all placed notes\n   */\n  getNotes(): readonly PlacedNote[];\n\n  /**\n   * Get a note at a specific position\n   */\n  getNoteAt(row: number, column: number): PlacedNote | null;\n\n  // ============================================================================\n  // IMPORT/EXPORT\n  // ============================================================================\n\n  /**\n   * Export the current score as CSV\n   */\n  exportCSV(): string;\n\n  /**\n   * Import a score from CSV\n   */\n  importCSV(csv: string): void;\n\n  /**\n   * Export the complete state as JSON\n   */\n  exportState(): string;\n\n  /**\n   * Import state from JSON\n   */\n  importState(json: string): void;\n\n  // ============================================================================\n  // EVENTS\n  // ============================================================================\n\n  /**\n   * Subscribe to an engine event\n   */\n  on(event: string, callback: EventCallback): void;\n\n  /**\n   * Unsubscribe from an engine event\n   */\n  off(event: string, callback: EventCallback): void;\n\n  // ============================================================================\n  // RENDERING\n  // ============================================================================\n\n  /**\n   * Request a re-render of all canvases\n   */\n  render(): void;\n\n  /**\n   * Request a re-render of the pitch grid only\n   */\n  renderPitchGrid(): void;\n\n  /**\n   * Request a re-render of the drum grid only\n   */\n  renderDrumGrid(): void;\n}\n\n/**\n * Lesson mode API for tutorials\n */\nexport interface LessonModeAPI {\n  /**\n   * Set which actions are allowed (whitelist)\n   */\n  setAllowedActions(actions: string[]): void;\n\n  /**\n   * Set which actions are blocked (blacklist)\n   */\n  setBlockedActions(actions: string[]): void;\n\n  /**\n   * Clear all action restrictions\n   */\n  clearActionRestrictions(): void;\n\n  /**\n   * Highlight a UI target for the user\n   */\n  highlightTarget(target: HighlightTarget): void;\n\n  /**\n   * Clear all highlights\n   */\n  clearHighlights(): void;\n\n  /**\n   * Wait for a specific action to be performed\n   */\n  waitForAction(action: string, timeout?: number): Promise<ActionEvent>;\n\n  /**\n   * Wait for state to match a condition\n   */\n  waitForState(predicate: (state: AppState) => boolean): Promise<void>;\n\n  /**\n   * Intercept and optionally block actions\n   */\n  onAction(action: string, handler: ActionHandler): () => void;\n}\n\n/**\n * Target for visual highlighting\n */\nexport type HighlightTarget =\n  | { type: 'tool'; id: string }\n  | { type: 'button'; id: string }\n  | { type: 'cell'; row: number; column: number }\n  | { type: 'note'; noteId: string }\n  | { type: 'region'; x: number; y: number; width: number; height: number };\n\n/**\n * Action event for interception\n */\nexport interface ActionEvent {\n  action: string;\n  args: unknown[];\n  timestamp: number;\n}\n\n/**\n * Action handler that can block actions\n */\nexport type ActionHandler = (event: ActionEvent) => boolean | void | Promise<boolean | void>;\n\n/**\n * Create a new engine controller instance\n */\nexport function createEngineController(): EngineController {\n  // This will be implemented when we extract the actual state/audio/canvas modules\n  throw new Error('Not yet implemented - engine modules need to be extracted first');\n}\n\n/**\n * Create a lesson mode API wrapper around an engine controller\n */\nexport function createLessonMode(engine: EngineController): LessonModeAPI {\n  // This will be implemented in the tutorial-runtime package\n  throw new Error('Not yet implemented - will be in @mlt/tutorial-runtime package');\n}\n","/**\n * FULL PITCH GAMUT DATA\n * =====================\n * The single source of truth for all pitch information across Music Learning Tools.\n *\n * STRUCTURE:\n * Contains pitch rows from C8 (highest) to A0 (lowest audible pitch).\n * Each object contains:\n * - pitch: The display name for the pitch (e.g., \"B♭/A♯7\") - combined notation for accidentals, single for naturals.\n * - flatName: The flat enharmonic spelling (e.g., \"B♭7\") - same as pitch for naturals.\n * - sharpName: The sharp enharmonic spelling (e.g., \"A♯7\") - same as pitch for naturals.\n * - toneNote: The scientific pitch notation compatible with Tone.js (e.g., \"Bb7\").\n * - frequency: The frequency in Hz.\n * - column: The pitch-row parity column ('A' or 'B') used by the pitch-to-Y axis mapping.\n * - hex: The specific color code for this exact pitch.\n * - isAccidental: Boolean flag indicating if this is a black key (accidental note).\n * - midi: MIDI note number (21-108 for A0-C8).\n * - pitchClass: Pitch class (0-11, where C=0).\n * - octave: Octave number (-1 to 8).\n *\n * MUSICAL RANGE:\n * - Audible range: Rows 0..87 (C8 to A0) - standard 88-key piano range\n * - MIDI numbers: 108 (C8) to 21 (A0)\n */\nimport type { PitchRowData } from '@mlt/types';\n\nexport const fullRowData: PitchRowData[] = [\n  // === AUDIBLE PITCH RANGE (C8 to A0) ===\n  { pitch: 'C8', flatName: 'C8', sharpName: 'C8', toneNote: 'C8', frequency: 4186.01, column: 'A', hex: '#fcfcfc', isAccidental: false, midi: 108, pitchClass: 0, octave: 8 },\n  { pitch: 'B7', flatName: 'B7', sharpName: 'B7', toneNote: 'B7', frequency: 3951.07, column: 'B', hex: '#fcf7fc', isAccidental: false, midi: 107, pitchClass: 11, octave: 7 },\n  { pitch: 'B♭/A♯7', flatName: 'B♭7', sharpName: 'A♯7', toneNote: 'Bb7', frequency: 3729.31, column: 'A', hex: '#f7f5fd', isAccidental: true, midi: 106, pitchClass: 10, octave: 7 },\n  { pitch: 'A7', flatName: 'A7', sharpName: 'A7', toneNote: 'A7', frequency: 3520.00, column: 'B', hex: '#f0f4ff', isAccidental: false, midi: 105, pitchClass: 9, octave: 7 },\n  { pitch: 'A♭/G♯7', flatName: 'A♭7', sharpName: 'G♯7', toneNote: 'Ab7', frequency: 3322.44, column: 'A', hex: '#e6f3fd', isAccidental: true, midi: 104, pitchClass: 8, octave: 7 },\n  { pitch: 'G7', flatName: 'G7', sharpName: 'G7', toneNote: 'G7', frequency: 3135.96, column: 'B', hex: '#def3f7', isAccidental: false, midi: 103, pitchClass: 7, octave: 7 },\n  { pitch: 'G♭/F♯7', flatName: 'G♭7', sharpName: 'F♯7', toneNote: 'Gb7', frequency: 2959.96, column: 'A', hex: '#daf2ec', isAccidental: true, midi: 102, pitchClass: 6, octave: 7 },\n  { pitch: 'F7', flatName: 'F7', sharpName: 'F7', toneNote: 'F7', frequency: 2793.83, column: 'B', hex: '#dcefdf', isAccidental: false, midi: 101, pitchClass: 5, octave: 7 },\n  { pitch: 'E7', flatName: 'E7', sharpName: 'E7', toneNote: 'E7', frequency: 2637.02, column: 'A', hex: '#e3ebd1', isAccidental: false, midi: 100, pitchClass: 4, octave: 7 },\n  { pitch: 'E♭/D♯7', flatName: 'E♭7', sharpName: 'D♯7', toneNote: 'Eb7', frequency: 2489.02, column: 'B', hex: '#eee4c8', isAccidental: true, midi: 99, pitchClass: 3, octave: 7 },\n  { pitch: 'D7', flatName: 'D7', sharpName: 'D7', toneNote: 'D7', frequency: 2349.32, column: 'A', hex: '#f8dcc6', isAccidental: false, midi: 98, pitchClass: 2, octave: 7 },\n  { pitch: 'D♭/C♯7', flatName: 'D♭7', sharpName: 'C♯7', toneNote: 'Db7', frequency: 2217.46, column: 'B', hex: '#fcd4cd', isAccidental: true, midi: 97, pitchClass: 1, octave: 7 },\n  { pitch: 'C7', flatName: 'C7', sharpName: 'C7', toneNote: 'C7', frequency: 2093.00, column: 'A', hex: '#facfdb', isAccidental: false, midi: 96, pitchClass: 0, octave: 7 },\n  { pitch: 'B6', flatName: 'B6', sharpName: 'B6', toneNote: 'B6', frequency: 1975.53, column: 'B', hex: '#efcdeb', isAccidental: false, midi: 95, pitchClass: 11, octave: 6 },\n  { pitch: 'B♭/A♯6', flatName: 'B♭6', sharpName: 'A♯6', toneNote: 'Bb6', frequency: 1864.66, column: 'A', hex: '#ddcff9', isAccidental: true, midi: 94, pitchClass: 10, octave: 6 },\n  { pitch: 'A6', flatName: 'A6', sharpName: 'A6', toneNote: 'A6', frequency: 1760.00, column: 'B', hex: '#c4d3ff', isAccidental: false, midi: 93, pitchClass: 9, octave: 6 },\n  { pitch: 'A♭/G♯6', flatName: 'A♭6', sharpName: 'G♯6', toneNote: 'Ab6', frequency: 1661.22, column: 'A', hex: '#abd9fa', isAccidental: true, midi: 92, pitchClass: 8, octave: 6 },\n  { pitch: 'G6', flatName: 'G6', sharpName: 'G6', toneNote: 'G6', frequency: 1567.94, column: 'B', hex: '#98dde9', isAccidental: false, midi: 91, pitchClass: 7, octave: 6 },\n  { pitch: 'G♭/F♯6', flatName: 'G♭6', sharpName: 'F♯6', toneNote: 'Gb6', frequency: 1479.98, column: 'A', hex: '#96ddcf', isAccidental: true, midi: 90, pitchClass: 6, octave: 6 },\n  { pitch: 'F6', flatName: 'F6', sharpName: 'F6', toneNote: 'F6', frequency: 1396.91, column: 'B', hex: '#a6d9b0', isAccidental: false, midi: 89, pitchClass: 5, octave: 6 },\n  { pitch: 'E6', flatName: 'E6', sharpName: 'E6', toneNote: 'E6', frequency: 1318.51, column: 'A', hex: '#c0d093', isAccidental: false, midi: 88, pitchClass: 4, octave: 6 },\n  { pitch: 'E♭/D♯6', flatName: 'E♭6', sharpName: 'D♯6', toneNote: 'Eb6', frequency: 1244.51, column: 'B', hex: '#dbc383', isAccidental: true, midi: 87, pitchClass: 3, octave: 6 },\n  { pitch: 'D6', flatName: 'D6', sharpName: 'D6', toneNote: 'D6', frequency: 1174.66, column: 'A', hex: '#efb586', isAccidental: false, midi: 86, pitchClass: 2, octave: 6 },\n  { pitch: 'D♭/C♯6', flatName: 'D♭6', sharpName: 'C♯6', toneNote: 'Db6', frequency: 1108.73, column: 'B', hex: '#f8a99c', isAccidental: true, midi: 85, pitchClass: 1, octave: 6 },\n  { pitch: 'C6', flatName: 'C6', sharpName: 'C6', toneNote: 'C6', frequency: 1046.50, column: 'A', hex: '#f3a2bb', isAccidental: false, midi: 84, pitchClass: 0, octave: 6 },\n  { pitch: 'B5', flatName: 'B5', sharpName: 'B5', toneNote: 'B5', frequency: 987.77, column: 'B', hex: '#e1a3db', isAccidental: false, midi: 83, pitchClass: 11, octave: 5 },\n  { pitch: 'B♭/A♯5', flatName: 'B♭5', sharpName: 'A♯5', toneNote: 'Bb5', frequency: 932.33, column: 'A', hex: '#c3a9f4', isAccidental: true, midi: 82, pitchClass: 10, octave: 5 },\n  { pitch: 'A5', flatName: 'A5', sharpName: 'A5', toneNote: 'A5', frequency: 880.00, column: 'B', hex: '#9ab2ff', isAccidental: false, midi: 81, pitchClass: 9, octave: 5 },\n  { pitch: 'A♭/G♯5', flatName: 'A♭5', sharpName: 'G♯5', toneNote: 'Ab5', frequency: 830.61, column: 'A', hex: '#67bdf7', isAccidental: true, midi: 80, pitchClass: 8, octave: 5 },\n  { pitch: 'G5', flatName: 'G5', sharpName: 'G5', toneNote: 'G5', frequency: 783.99, column: 'B', hex: '#30c6dc', isAccidental: false, midi: 79, pitchClass: 7, octave: 5 },\n  { pitch: 'G♭/F♯5', flatName: 'G♭5', sharpName: 'F♯5', toneNote: 'Gb5', frequency: 739.99, column: 'A', hex: '#32c8b2', isAccidental: true, midi: 78, pitchClass: 6, octave: 5 },\n  { pitch: 'F5', flatName: 'F5', sharpName: 'F5', toneNote: 'F5', frequency: 698.46, column: 'B', hex: '#6dc281', isAccidental: false, midi: 77, pitchClass: 5, octave: 5 },\n  { pitch: 'E5', flatName: 'E5', sharpName: 'E5', toneNote: 'E5', frequency: 659.25, column: 'A', hex: '#a0b556', isAccidental: false, midi: 76, pitchClass: 4, octave: 5 },\n  { pitch: 'E♭/D♯5', flatName: 'E♭5', sharpName: 'D♯5', toneNote: 'Eb5', frequency: 622.25, column: 'B', hex: '#c5a33f', isAccidental: true, midi: 75, pitchClass: 3, octave: 5 },\n  { pitch: 'D5', flatName: 'D5', sharpName: 'D5', toneNote: 'D5', frequency: 587.33, column: 'A', hex: '#dc9150', isAccidental: false, midi: 74, pitchClass: 2, octave: 5 },\n  { pitch: 'D♭/C♯5', flatName: 'D♭5', sharpName: 'C♯5', toneNote: 'Db5', frequency: 554.37, column: 'B', hex: '#e38475', isAccidental: true, midi: 73, pitchClass: 1, octave: 5 },\n  { pitch: 'C5', flatName: 'C5', sharpName: 'C5', toneNote: 'C5', frequency: 523.25, column: 'A', hex: '#dc7f9d', isAccidental: false, midi: 72, pitchClass: 0, octave: 5 },\n  { pitch: 'B4', flatName: 'B4', sharpName: 'B4', toneNote: 'B4', frequency: 493.88, column: 'B', hex: '#c781c0', isAccidental: false, midi: 71, pitchClass: 11, octave: 4 },\n  { pitch: 'B♭/A♯4', flatName: 'B♭4', sharpName: 'A♯4', toneNote: 'Bb4', frequency: 466.16, column: 'A', hex: '#a68ad8', isAccidental: true, midi: 70, pitchClass: 10, octave: 4 },\n  { pitch: 'A4', flatName: 'A4', sharpName: 'A4', toneNote: 'A4', frequency: 440.00, column: 'B', hex: '#7d94e0', isAccidental: false, midi: 69, pitchClass: 9, octave: 4 },\n  { pitch: 'A♭/G♯4', flatName: 'A♭4', sharpName: 'G♯4', toneNote: 'Ab4', frequency: 415.30, column: 'A', hex: '#4c9fd5', isAccidental: true, midi: 68, pitchClass: 8, octave: 4 },\n  { pitch: 'G4', flatName: 'G4', sharpName: 'G4', toneNote: 'G4', frequency: 392.00, column: 'B', hex: '#0fa6ba', isAccidental: false, midi: 67, pitchClass: 7, octave: 4 },\n  { pitch: 'G♭/F♯4', flatName: 'G♭4', sharpName: 'F♯4', toneNote: 'Gb4', frequency: 369.99, column: 'A', hex: '#24a794', isAccidental: true, midi: 66, pitchClass: 6, octave: 4 },\n  { pitch: 'F4', flatName: 'F4', sharpName: 'F4', toneNote: 'F4', frequency: 349.23, column: 'B', hex: '#5aa26a', isAccidental: false, midi: 65, pitchClass: 5, octave: 4 },\n  { pitch: 'E4', flatName: 'E4', sharpName: 'E4', toneNote: 'E4', frequency: 329.63, column: 'A', hex: '#849646', isAccidental: false, midi: 64, pitchClass: 4, octave: 4 },\n  { pitch: 'E♭/D♯4', flatName: 'E♭4', sharpName: 'D♯4', toneNote: 'Eb4', frequency: 311.13, column: 'B', hex: '#a38733', isAccidental: true, midi: 63, pitchClass: 3, octave: 4 },\n  { pitch: 'D4', flatName: 'D4', sharpName: 'D4', toneNote: 'D4', frequency: 293.66, column: 'A', hex: '#b67740', isAccidental: false, midi: 62, pitchClass: 2, octave: 4 },\n  { pitch: 'D♭/C♯4', flatName: 'D♭4', sharpName: 'C♯4', toneNote: 'Db4', frequency: 277.18, column: 'B', hex: '#bc6c5f', isAccidental: true, midi: 61, pitchClass: 1, octave: 4 },\n  { pitch: 'C4', flatName: 'C4', sharpName: 'C4', toneNote: 'C4', frequency: 261.63, column: 'A', hex: '#b56880', isAccidental: false, midi: 60, pitchClass: 0, octave: 4 },\n  { pitch: 'B3', flatName: 'B3', sharpName: 'B3', toneNote: 'B3', frequency: 246.94, column: 'B', hex: '#a3699e', isAccidental: false, midi: 59, pitchClass: 11, octave: 3 },\n  { pitch: 'B♭/A♯3', flatName: 'B♭3', sharpName: 'A♯3', toneNote: 'Bb3', frequency: 233.08, column: 'A', hex: '#8870b1', isAccidental: true, midi: 58, pitchClass: 10, octave: 3 },\n  { pitch: 'A3', flatName: 'A3', sharpName: 'A3', toneNote: 'A3', frequency: 220.00, column: 'B', hex: '#6578b7', isAccidental: false, midi: 57, pitchClass: 9, octave: 3 },\n  { pitch: 'A♭/G♯3', flatName: 'A♭3', sharpName: 'G♯3', toneNote: 'Ab3', frequency: 207.65, column: 'A', hex: '#3c81ad', isAccidental: true, midi: 56, pitchClass: 8, octave: 3 },\n  { pitch: 'G3', flatName: 'G3', sharpName: 'G3', toneNote: 'G3', frequency: 196.00, column: 'B', hex: '#0e8696', isAccidental: false, midi: 55, pitchClass: 7, octave: 3 },\n  { pitch: 'G♭/F♯3', flatName: 'G♭3', sharpName: 'F♯3', toneNote: 'Gb3', frequency: 185.00, column: 'A', hex: '#1b8777', isAccidental: true, midi: 54, pitchClass: 6, octave: 3 },\n  { pitch: 'F3', flatName: 'F3', sharpName: 'F3', toneNote: 'F3', frequency: 174.61, column: 'B', hex: '#478255', isAccidental: false, midi: 53, pitchClass: 5, octave: 3 },\n  { pitch: 'E3', flatName: 'E3', sharpName: 'E3', toneNote: 'E3', frequency: 164.81, column: 'A', hex: '#697836', isAccidental: false, midi: 52, pitchClass: 4, octave: 3 },\n  { pitch: 'E♭/D♯3', flatName: 'E♭3', sharpName: 'D♯3', toneNote: 'Eb3', frequency: 155.56, column: 'B', hex: '#836b27', isAccidental: true, midi: 51, pitchClass: 3, octave: 3 },\n  { pitch: 'D3', flatName: 'D3', sharpName: 'D3', toneNote: 'D3', frequency: 146.83, column: 'A', hex: '#925e32', isAccidental: false, midi: 50, pitchClass: 2, octave: 3 },\n  { pitch: 'D♭/C♯3', flatName: 'D♭3', sharpName: 'C♯3', toneNote: 'Db3', frequency: 138.59, column: 'B', hex: '#96554b', isAccidental: true, midi: 49, pitchClass: 1, octave: 3 },\n  { pitch: 'C3', flatName: 'C3', sharpName: 'C3', toneNote: 'C3', frequency: 130.81, column: 'A', hex: '#905165', isAccidental: false, midi: 48, pitchClass: 0, octave: 3 },\n  { pitch: 'B2', flatName: 'B2', sharpName: 'B2', toneNote: 'B2', frequency: 123.47, column: 'B', hex: '#80527c', isAccidental: false, midi: 47, pitchClass: 11, octave: 2 },\n  { pitch: 'B♭/A♯2', flatName: 'B♭2', sharpName: 'A♯2', toneNote: 'Bb2', frequency: 116.54, column: 'A', hex: '#6a578c', isAccidental: true, midi: 46, pitchClass: 10, octave: 2 },\n  { pitch: 'A2', flatName: 'A2', sharpName: 'A2', toneNote: 'A2', frequency: 110.00, column: 'B', hex: '#4e5e90', isAccidental: false, midi: 45, pitchClass: 9, octave: 2 },\n  { pitch: 'A♭/G♯2', flatName: 'A♭2', sharpName: 'G♯2', toneNote: 'Ab2', frequency: 103.83, column: 'A', hex: '#2d6488', isAccidental: true, midi: 44, pitchClass: 8, octave: 2 },\n  { pitch: 'G2', flatName: 'G2', sharpName: 'G2', toneNote: 'G2', frequency: 98.00, column: 'B', hex: '#096875', isAccidental: false, midi: 43, pitchClass: 7, octave: 2 },\n  { pitch: 'G♭/F♯2', flatName: 'G♭2', sharpName: 'F♯2', toneNote: 'Gb2', frequency: 92.50, column: 'A', hex: '#13685b', isAccidental: true, midi: 42, pitchClass: 6, octave: 2 },\n  { pitch: 'F2', flatName: 'F2', sharpName: 'F2', toneNote: 'F2', frequency: 87.31, column: 'B', hex: '#356440', isAccidental: false, midi: 41, pitchClass: 5, octave: 2 },\n  { pitch: 'E2', flatName: 'E2', sharpName: 'E2', toneNote: 'E2', frequency: 82.41, column: 'A', hex: '#505c28', isAccidental: false, midi: 40, pitchClass: 4, octave: 2 },\n  { pitch: 'E♭/D♯2', flatName: 'E♭2', sharpName: 'D♯2', toneNote: 'Eb2', frequency: 77.78, column: 'B', hex: '#63511c', isAccidental: true, midi: 39, pitchClass: 3, octave: 2 },\n  { pitch: 'D2', flatName: 'D2', sharpName: 'D2', toneNote: 'D2', frequency: 73.42, column: 'A', hex: '#6e4724', isAccidental: false, midi: 38, pitchClass: 2, octave: 2 },\n  { pitch: 'D♭/C♯2', flatName: 'D♭2', sharpName: 'C♯2', toneNote: 'Db2', frequency: 69.30, column: 'B', hex: '#713f37', isAccidental: true, midi: 37, pitchClass: 1, octave: 2 },\n  { pitch: 'C2', flatName: 'C2', sharpName: 'C2', toneNote: 'C2', frequency: 65.41, column: 'A', hex: '#6c3c4b', isAccidental: false, midi: 36, pitchClass: 0, octave: 2 },\n  { pitch: 'B1', flatName: 'B1', sharpName: 'B1', toneNote: 'B1', frequency: 61.74, column: 'B', hex: '#603c5d', isAccidental: false, midi: 35, pitchClass: 11, octave: 1 },\n  { pitch: 'B♭/A♯1', flatName: 'B♭1', sharpName: 'A♯1', toneNote: 'Bb1', frequency: 58.27, column: 'A', hex: '#4e4068', isAccidental: true, midi: 34, pitchClass: 10, octave: 1 },\n  { pitch: 'A1', flatName: 'A1', sharpName: 'A1', toneNote: 'A1', frequency: 55.00, column: 'B', hex: '#38446b', isAccidental: false, midi: 33, pitchClass: 9, octave: 1 },\n  { pitch: 'A♭/G♯1', flatName: 'A♭1', sharpName: 'G♯1', toneNote: 'Ab1', frequency: 51.91, column: 'A', hex: '#1f4964', isAccidental: true, midi: 32, pitchClass: 8, octave: 1 },\n  { pitch: 'G1', flatName: 'G1', sharpName: 'G1', toneNote: 'G1', frequency: 49.00, column: 'B', hex: '#044b55', isAccidental: false, midi: 31, pitchClass: 7, octave: 1 },\n  { pitch: 'G♭/F♯1', flatName: 'G♭1', sharpName: 'F♯1', toneNote: 'Gb1', frequency: 46.25, column: 'A', hex: '#0c4b41', isAccidental: true, midi: 30, pitchClass: 6, octave: 1 },\n  { pitch: 'F1', flatName: 'F1', sharpName: 'F1', toneNote: 'F1', frequency: 43.65, column: 'B', hex: '#24472c', isAccidental: false, midi: 29, pitchClass: 5, octave: 1 },\n  { pitch: 'E1', flatName: 'E1', sharpName: 'E1', toneNote: 'E1', frequency: 41.20, column: 'A', hex: '#38401a', isAccidental: false, midi: 28, pitchClass: 4, octave: 1 },\n  { pitch: 'E♭/D♯1', flatName: 'E♭1', sharpName: 'D♯1', toneNote: 'Eb1', frequency: 38.89, column: 'B', hex: '#463811', isAccidental: true, midi: 27, pitchClass: 3, octave: 1 },\n  { pitch: 'D1', flatName: 'D1', sharpName: 'D1', toneNote: 'D1', frequency: 36.71, column: 'A', hex: '#4d3017', isAccidental: false, midi: 26, pitchClass: 2, octave: 1 },\n  { pitch: 'D♭/C♯1', flatName: 'D♭1', sharpName: 'C♯1', toneNote: 'Db1', frequency: 34.65, column: 'B', hex: '#4f2a24', isAccidental: true, midi: 25, pitchClass: 1, octave: 1 },\n  { pitch: 'C1', flatName: 'C1', sharpName: 'C1', toneNote: 'C1', frequency: 32.70, column: 'A', hex: '#4a2733', isAccidental: false, midi: 24, pitchClass: 0, octave: 1 },\n  { pitch: 'B0', flatName: 'B0', sharpName: 'B0', toneNote: 'B0', frequency: 30.87, column: 'B', hex: '#41273f', isAccidental: false, midi: 23, pitchClass: 11, octave: 0 },\n  { pitch: 'B♭/A♯0', flatName: 'B♭0', sharpName: 'A♯0', toneNote: 'Bb0', frequency: 29.14, column: 'A', hex: '#342a46', isAccidental: true, midi: 22, pitchClass: 10, octave: 0 },\n  { pitch: 'A0', flatName: 'A0', sharpName: 'A0', toneNote: 'A0', frequency: 27.50, column: 'B', hex: '#242c48', isAccidental: false, midi: 21, pitchClass: 9, octave: 0 },\n];\n","/**\n * Pitch Data Utilities\n *\n * Helper functions for working with the full pitch gamut.\n */\nimport type { PitchRowData } from '@mlt/types';\nimport { fullRowData } from './pitchData.js';\n\n// Pre-build lookup maps for O(1) access\nconst toneNoteToIndex = new Map<string, number>();\nconst midiToIndex = new Map<number, number>();\n\nfullRowData.forEach((row, index) => {\n  toneNoteToIndex.set(row.toneNote, index);\n  if (row.midi !== undefined) {\n    midiToIndex.set(row.midi, index);\n  }\n});\n\n/**\n * Get pitch row data by Tone.js note name (e.g., 'C4', 'Bb5')\n */\nexport function getPitchByToneNote(toneNote: string): PitchRowData | undefined {\n  const index = toneNoteToIndex.get(toneNote);\n  return index !== undefined ? fullRowData[index] : undefined;\n}\n\n/**\n * Get pitch row data by index in fullRowData (0 = C8, 87 = A0)\n */\nexport function getPitchByIndex(index: number): PitchRowData | undefined {\n  return fullRowData[index];\n}\n\n/**\n * Get the index of a pitch by its Tone.js note name\n */\nexport function getPitchIndex(toneNote: string): number {\n  return toneNoteToIndex.get(toneNote) ?? -1;\n}\n\n/**\n * Get pitch row data by MIDI note number (21-108)\n */\nexport function getPitchByMidi(midi: number): PitchRowData | undefined {\n  const index = midiToIndex.get(midi);\n  return index !== undefined ? fullRowData[index] : undefined;\n}\n\n/**\n * Get MIDI note number from Tone.js note name\n */\nexport function getMidiFromToneNote(toneNote: string): number | undefined {\n  const pitch = getPitchByToneNote(toneNote);\n  return pitch?.midi;\n}\n\n/**\n * Resolve pitch range from Tone.js note names\n * Returns start/end indices in fullRowData (topIndex < bottomIndex since C8 is index 0)\n */\nexport function resolvePitchRange(\n  topToneNote: string,\n  bottomToneNote: string\n): { topIndex: number; bottomIndex: number } | null {\n  const topIndex = getPitchIndex(topToneNote);\n  const bottomIndex = getPitchIndex(bottomToneNote);\n\n  if (topIndex === -1 || bottomIndex === -1) {\n    return null;\n  }\n\n  return {\n    topIndex: Math.min(topIndex, bottomIndex),\n    bottomIndex: Math.max(topIndex, bottomIndex),\n  };\n}\n\n/**\n * Get a slice of row data for a specific pitch range\n * @param topToneNote - Highest pitch (e.g., 'C6')\n * @param bottomToneNote - Lowest pitch (e.g., 'C3')\n */\nexport function getRowDataForRange(\n  topToneNote: string,\n  bottomToneNote: string\n): PitchRowData[] {\n  const range = resolvePitchRange(topToneNote, bottomToneNote);\n  if (!range) return [];\n  return fullRowData.slice(range.topIndex, range.bottomIndex + 1);\n}\n\n/**\n * Generate row data for a MIDI range (useful for singing trainer)\n * @param minMidi - Lowest MIDI note (e.g., 48 for C3)\n * @param maxMidi - Highest MIDI note (e.g., 84 for C6)\n */\nexport function generateRowDataForMidiRange(\n  minMidi: number,\n  maxMidi: number\n): PitchRowData[] {\n  const rows: PitchRowData[] = [];\n\n  // Iterate from high to low (fullRowData order is C8 to A0)\n  for (let midi = maxMidi; midi >= minMidi; midi--) {\n    const pitch = getPitchByMidi(midi);\n    if (pitch) {\n      rows.push(pitch);\n    }\n  }\n\n  return rows;\n}\n\n// ============================================================================\n// MIDI Range Helpers\n// ============================================================================\n\n/**\n * A MIDI range representing a span of pitches.\n */\nexport interface MidiRange {\n  /** Lowest MIDI note number */\n  minMidi: number;\n  /** Highest MIDI note number */\n  maxMidi: number;\n}\n\n/**\n * Get MIDI range from Tone.js note names.\n * @param lowNote - Lower pitch (e.g., 'C3')\n * @param highNote - Higher pitch (e.g., 'C5')\n * @returns MidiRange or null if notes are invalid\n *\n * @example\n * getMidiRangeFromToneNotes('C3', 'C5') // { minMidi: 48, maxMidi: 72 }\n * getMidiRangeFromToneNotes('A2', 'A4') // { minMidi: 45, maxMidi: 69 }\n */\nexport function getMidiRangeFromToneNotes(\n  lowNote: string,\n  highNote: string\n): MidiRange | null {\n  const lowMidi = getMidiFromToneNote(lowNote);\n  const highMidi = getMidiFromToneNote(highNote);\n\n  if (lowMidi === undefined || highMidi === undefined) {\n    return null;\n  }\n\n  return {\n    minMidi: Math.min(lowMidi, highMidi),\n    maxMidi: Math.max(lowMidi, highMidi),\n  };\n}\n\n/**\n * Get Tone.js note names from a MIDI range.\n * @param range - MIDI range object\n * @returns Object with lowNote and highNote, or null if invalid\n *\n * @example\n * getToneNotesFromMidiRange({ minMidi: 48, maxMidi: 72 }) // { lowNote: 'C3', highNote: 'C5' }\n */\nexport function getToneNotesFromMidiRange(\n  range: MidiRange\n): { lowNote: string; highNote: string } | null {\n  const lowPitch = getPitchByMidi(range.minMidi);\n  const highPitch = getPitchByMidi(range.maxMidi);\n\n  if (!lowPitch || !highPitch) {\n    return null;\n  }\n\n  return {\n    lowNote: lowPitch.toneNote,\n    highNote: highPitch.toneNote,\n  };\n}\n\n/**\n * Expand a MIDI range by a number of semitones in each direction.\n * Clamps to valid piano range (21-108).\n *\n * @example\n * expandMidiRange({ minMidi: 48, maxMidi: 72 }, 12) // { minMidi: 36, maxMidi: 84 }\n */\nexport function expandMidiRange(range: MidiRange, semitones: number): MidiRange {\n  return {\n    minMidi: Math.max(21, range.minMidi - semitones),\n    maxMidi: Math.min(108, range.maxMidi + semitones),\n  };\n}\n\n/**\n * Shift a MIDI range up or down by a number of semitones.\n * Clamps to valid piano range (21-108).\n *\n * @example\n * shiftMidiRange({ minMidi: 48, maxMidi: 72 }, 12)  // { minMidi: 60, maxMidi: 84 }\n * shiftMidiRange({ minMidi: 48, maxMidi: 72 }, -12) // { minMidi: 36, maxMidi: 60 }\n */\nexport function shiftMidiRange(range: MidiRange, semitones: number): MidiRange {\n  const newMin = range.minMidi + semitones;\n  const newMax = range.maxMidi + semitones;\n\n  // Clamp to valid range while maintaining the span\n  if (newMin < 21) {\n    const adjustment = 21 - newMin;\n    return { minMidi: 21, maxMidi: newMax + adjustment };\n  }\n  if (newMax > 108) {\n    const adjustment = newMax - 108;\n    return { minMidi: newMin - adjustment, maxMidi: 108 };\n  }\n\n  return { minMidi: newMin, maxMidi: newMax };\n}\n\n/**\n * Get the number of semitones (pitches) in a MIDI range.\n *\n * @example\n * getMidiRangeSpan({ minMidi: 48, maxMidi: 72 }) // 25 (includes both endpoints)\n */\nexport function getMidiRangeSpan(range: MidiRange): number {\n  return range.maxMidi - range.minMidi + 1;\n}\n\n/**\n * Check if a MIDI note is within a range.\n *\n * @example\n * isMidiInRange(60, { minMidi: 48, maxMidi: 72 }) // true\n * isMidiInRange(36, { minMidi: 48, maxMidi: 72 }) // false\n */\nexport function isMidiInRange(midi: number, range: MidiRange): boolean {\n  return midi >= range.minMidi && midi <= range.maxMidi;\n}\n\n/**\n * Clamp a MIDI note to be within a range.\n *\n * @example\n * clampMidiToRange(36, { minMidi: 48, maxMidi: 72 }) // 48\n * clampMidiToRange(60, { minMidi: 48, maxMidi: 72 }) // 60\n * clampMidiToRange(84, { minMidi: 48, maxMidi: 72 }) // 72\n */\nexport function clampMidiToRange(midi: number, range: MidiRange): number {\n  return Math.max(range.minMidi, Math.min(range.maxMidi, midi));\n}\n\n// ============================================================================\n// Preset Pitch Ranges\n// ============================================================================\n\n/**\n * Common pitch ranges for different voice types and instruments.\n * Each range includes MIDI numbers and Tone.js note names.\n */\nexport const PITCH_RANGES = {\n  /** Full 88-key piano range */\n  PIANO: { minMidi: 21, maxMidi: 108, lowNote: 'A0', highNote: 'C8' },\n  /** Typical soprano voice range */\n  SOPRANO: { minMidi: 60, maxMidi: 84, lowNote: 'C4', highNote: 'C6' },\n  /** Typical alto voice range */\n  ALTO: { minMidi: 53, maxMidi: 77, lowNote: 'F3', highNote: 'F5' },\n  /** Typical tenor voice range */\n  TENOR: { minMidi: 48, maxMidi: 72, lowNote: 'C3', highNote: 'C5' },\n  /** Typical bass voice range */\n  BASS: { minMidi: 40, maxMidi: 64, lowNote: 'E2', highNote: 'E4' },\n  /** General singing range (covers most voices) */\n  SINGING: { minMidi: 48, maxMidi: 84, lowNote: 'C3', highNote: 'C6' },\n  /** Comfortable speaking range */\n  SPEAKING: { minMidi: 55, maxMidi: 70, lowNote: 'G3', highNote: 'Bb4' },\n  /** Extended vocal range (trained singers) */\n  EXTENDED_VOCAL: { minMidi: 36, maxMidi: 96, lowNote: 'C2', highNote: 'C7' },\n} as const;\n\n/** Type for preset range keys */\nexport type PitchRangePreset = keyof typeof PITCH_RANGES;\n\n/**\n * Get a MidiRange from a preset name.\n *\n * @example\n * getMidiRangeFromPreset('TENOR') // { minMidi: 48, maxMidi: 72 }\n */\nexport function getMidiRangeFromPreset(preset: PitchRangePreset): MidiRange {\n  const range = PITCH_RANGES[preset];\n  return { minMidi: range.minMidi, maxMidi: range.maxMidi };\n}\n","/**\n * Initial State Configuration\n *\n * Default state values for the notation engine.\n * This provides sensible defaults that can be overridden via configuration.\n */\n\nimport type { AppState, TimbresMap } from '@mlt/types';\nimport { fullRowData, resolvePitchRange } from './pitchData.js';\n\n/**\n * Default ADSR envelope settings\n */\nconst DEFAULT_ADSR = {\n  attack: 0.01,\n  decay: 0.1,\n  sustain: 0.7,\n  release: 0.3\n};\n\n/**\n * Default filter settings\n */\nconst DEFAULT_FILTER = {\n  type: 'lowpass' as const,\n  frequency: 2000,\n  Q: 1,\n  gain: 0,\n  enabled: false\n};\n\n/**\n * Create default timbres for each note color\n */\nfunction createDefaultTimbres(): TimbresMap {\n  const colors = [\n    '#4a90e2', // Blue\n    '#e24a4a', // Red\n    '#4ae24a', // Green\n    '#e2e24a', // Yellow\n    '#e24ae2', // Magenta\n    '#4ae2e2', // Cyan\n    '#e2a04a', // Orange\n    '#a04ae2'  // Purple\n  ];\n\n  const timbres: TimbresMap = {};\n\n  colors.forEach(color => {\n    // Create sine wave coefficients (only first harmonic)\n    const coeffs = new Float32Array(32);\n    coeffs[0] = 1.0; // Fundamental\n\n    // Create zero phases\n    const phases = new Float32Array(32);\n\n    timbres[color] = {\n      adsr: { ...DEFAULT_ADSR },\n      coeffs,\n      phases,\n      filter: { ...DEFAULT_FILTER },\n      activePresetName: 'sine'\n    };\n  });\n\n  return timbres;\n}\n\n/**\n * Default rhythm configuration\n */\nfunction getDefaultRhythm() {\n  return {\n    macrobeatGroupings: [2, 2, 2, 2] as (2 | 3)[],\n    macrobeatBoundaryStyles: ['dashed', 'dashed', 'dashed', 'dashed'] as ('dashed' | 'solid' | 'anacrusis')[],\n    hasAnacrusis: false,\n    baseMicrobeatPx: 40,\n    modulationMarkers: []\n  };\n}\n\n/**\n * Calculate default pitch range (G5 to C4)\n */\nfunction getDefaultPitchRange() {\n  const range = resolvePitchRange('G5', 'C4');\n  if (range) {\n    return range;\n  }\n  // Fallback to full range if resolution fails\n  return {\n    topIndex: 0,\n    bottomIndex: Math.max(0, fullRowData.length - 1)\n  };\n}\n\n/**\n * Get the complete initial state\n */\nexport function getInitialState(): AppState {\n  const timbres = createDefaultTimbres();\n\n  return {\n    // --- Data & History ---\n    placedNotes: [],\n    placedChords: [],\n    tonicSignGroups: {},\n    sixteenthStampPlacements: [],\n    tripletStampPlacements: [],\n    annotations: [],\n    lassoSelection: {\n      selectedItems: [],\n      convexHull: null,\n      isActive: false\n    },\n    history: [{\n      notes: [],\n      tonicSignGroups: {},\n      timbres: JSON.parse(JSON.stringify(timbres)),\n      placedChords: [],\n      sixteenthStampPlacements: [],\n      tripletStampPlacements: [],\n      annotations: [],\n      lassoSelection: { selectedItems: [], convexHull: null, isActive: false }\n    }],\n    historyIndex: 0,\n    fullRowData: [...fullRowData],\n    pitchRange: getDefaultPitchRange(),\n\n    // --- Rhythm ---\n    ...getDefaultRhythm(),\n    selectedModulationRatio: null,\n\n    // --- Timbres & Colors ---\n    timbres,\n    colorPalette: {\n      '#4a90e2': { primary: '#4a90e2', light: '#a8c8f0' },\n      '#e24a4a': { primary: '#e24a4a', light: '#f0a8a8' },\n      '#4ae24a': { primary: '#4ae24a', light: '#a8f0a8' },\n      '#e2e24a': { primary: '#e2e24a', light: '#f0f0a8' },\n      '#e24ae2': { primary: '#e24ae2', light: '#f0a8f0' },\n      '#4ae2e2': { primary: '#4ae2e2', light: '#a8f0f0' },\n      '#e2a04a': { primary: '#e2a04a', light: '#f0d0a8' },\n      '#a04ae2': { primary: '#a04ae2', light: '#d0a8f0' }\n    },\n\n    // --- UI & View State ---\n    selectedTool: 'note',\n    previousTool: 'note',\n    selectedToolTonicNumber: 1,\n    selectedNote: { shape: 'circle', color: '#4a90e2' },\n    deviceProfile: {\n      isMobile: false,\n      isTouch: false,\n      isCoarsePointer: false,\n      orientation: 'landscape',\n      width: 0,\n      height: 0\n    },\n    activeChordId: null,\n    activeChordIntervals: ['1P'], // Start with just root (U) selected\n    isIntervalsInverted: false,\n    chordPositionState: 0, // 0 = Root, 1 = 1st Inversion, 2 = 2nd Inversion\n\n    gridPosition: 0,\n    viewportRows: 0,\n    logicRows: 0,\n    cellWidth: 0,\n    cellHeight: 0,\n    columnWidths: [],\n    musicalColumnWidths: [],\n    degreeDisplayMode: 'off',\n    accidentalMode: { sharp: true, flat: true },\n    showFrequencyLabels: false,\n    showOctaveLabels: true,\n    focusColours: false,\n\n    // --- Playback ---\n    isPlaying: false,\n    isPaused: false,\n    isLooping: false,\n    tempo: 90,\n    playheadMode: 'cursor',\n\n    // --- Waveform ---\n    waveformExtendedView: false,\n\n    // --- ADSR ---\n    adsrTimeAxisScale: 1.0,\n\n    // --- Print ---\n    isPrintPreviewActive: false,\n    printOptions: {\n      pageSize: 'letter',\n      includeButtonGrid: true,\n      includeDrums: true,\n      includeLeftLegend: true,\n      includeRightLegend: true,\n      orientation: 'landscape',\n      colorMode: 'color',\n      cropTop: 0,\n      cropBottom: 1.0,\n      cropLeft: 0,\n      cropRight: 1.0\n    },\n\n    // --- Long Notes Style ---\n    longNoteStyle: 'style1'\n  };\n}\n","/**\n * State Store Factory\n *\n * Event-emitter based state store for the notation engine.\n * This provides a clean, framework-agnostic state management system\n * that can be used both as a singleton (for backward compatibility)\n * and as factory-created instances (for the engine package).\n *\n * Key features:\n * - Event-based reactivity (on/emit/off pattern)\n * - Action methods bound to state\n * - Optional localStorage persistence\n * - Undo/redo history\n * - No DOM dependencies (storage adapter is injectable)\n */\n\nimport type { AppState, Store, TimbreState, HistoryEntry } from '@mlt/types';\nimport { fullRowData } from './pitchData.js';\nimport { getInitialState } from './initialState.js';\n\n// Event callback type\nexport type EventCallback<T = unknown> = (data: T) => void;\n\n// Unsubscribe function\nexport type Unsubscribe = () => void;\n\n/**\n * Storage adapter interface for persistence\n * This allows injecting localStorage, sessionStorage, or a mock for testing\n */\nexport interface StorageAdapter {\n  getItem(key: string): string | null;\n  setItem(key: string, value: string): void;\n  removeItem(key: string): void;\n}\n\n/**\n * Configuration for store creation\n */\nexport interface StoreConfig {\n  /** Storage key for persistence */\n  storageKey?: string;\n  /** Storage adapter (defaults to no persistence) */\n  storage?: StorageAdapter;\n  /** Initial state override */\n  initialState?: Partial<AppState>;\n  /** Callback when state should be reloaded (replaces window.location.reload) */\n  onClearState?: () => void;\n}\n\n/**\n * Extended store instance with lifecycle methods\n */\nexport interface StoreInstance extends Store {\n  /** Whether this is a cold start (no persisted state) */\n  isColdStart: boolean;\n  /** Dispose of the store and clean up */\n  dispose(): void;\n  /** Unsubscribe from an event */\n  off(eventName: string, callback: EventCallback): void;\n  /** Save state to storage (if configured) */\n  saveState(): void;\n}\n\n// Helper to safely restore timbres, ensuring coeffs/phases are Float32Array\nfunction restoreTimbres(timbresSnapshot: Record<string, TimbreState>): Record<string, TimbreState> {\n  const newTimbres = JSON.parse(JSON.stringify(timbresSnapshot));\n  for (const color in newTimbres) {\n    const timbre = newTimbres[color];\n    if (timbre.coeffs && typeof timbre.coeffs === 'object' && !Array.isArray(timbre.coeffs)) {\n      timbre.coeffs = new Float32Array(Object.values(timbre.coeffs));\n    } else if (Array.isArray(timbre.coeffs)) {\n      timbre.coeffs = new Float32Array(timbre.coeffs);\n    }\n    if (timbre.phases && typeof timbre.phases === 'object' && !Array.isArray(timbre.phases)) {\n      timbre.phases = new Float32Array(Object.values(timbre.phases));\n    } else if (Array.isArray(timbre.phases)) {\n      timbre.phases = new Float32Array(timbre.phases);\n    }\n  }\n  return newTimbres;\n}\n\n/**\n * Load state from storage\n */\nfunction loadStateFromStorage(storage: StorageAdapter | undefined, storageKey: string): Partial<AppState> | undefined {\n  if (!storage) return undefined;\n\n  try {\n    const serializedState = storage.getItem(storageKey);\n    if (serializedState === null) {\n      return undefined;\n    }\n    const parsedState = JSON.parse(serializedState);\n\n    // Convert Float32Arrays back from storage\n    if (parsedState.timbres) {\n      for (const color in parsedState.timbres) {\n        const timbre = parsedState.timbres[color];\n        if (timbre.coeffs && typeof timbre.coeffs === 'object') {\n          const values = Array.isArray(timbre.coeffs) ? timbre.coeffs : Object.values(timbre.coeffs);\n          timbre.coeffs = new Float32Array(values as number[]);\n        }\n        if (timbre.phases && typeof timbre.phases === 'object') {\n          const values = Array.isArray(timbre.phases) ? timbre.phases : Object.values(timbre.phases);\n          timbre.phases = new Float32Array(values as number[]);\n        }\n      }\n    }\n\n    // Validate pitch range\n    if (parsedState.pitchRange) {\n      const totalRows = fullRowData.length;\n      const maxIndex = Math.max(0, totalRows - 1);\n      const topIndex = Math.max(0, Math.min(maxIndex, parsedState.pitchRange.topIndex ?? 0));\n      const bottomIndex = Math.max(topIndex, Math.min(maxIndex, parsedState.pitchRange.bottomIndex ?? maxIndex));\n      parsedState.pitchRange = { topIndex, bottomIndex };\n    }\n\n    // Validate playhead mode\n    if ('playheadMode' in parsedState) {\n      const mode = parsedState.playheadMode;\n      if (mode !== 'cursor' && mode !== 'microbeat' && mode !== 'macrobeat') {\n        delete parsedState.playheadMode;\n      }\n    }\n\n    // Ensure fullRowData is always complete\n    parsedState.fullRowData = [...fullRowData];\n\n    return parsedState;\n  } catch {\n    return undefined;\n  }\n}\n\n/**\n * Save state to storage\n */\nfunction saveStateToStorage(state: AppState, storage: StorageAdapter | undefined, storageKey: string): void {\n  if (!storage) return;\n\n  try {\n    const stateToPersist = JSON.parse(JSON.stringify({\n      placedNotes: state.placedNotes,\n      placedChords: state.placedChords,\n      tonicSignGroups: state.tonicSignGroups,\n      sixteenthStampPlacements: state.sixteenthStampPlacements,\n      tripletStampPlacements: state.tripletStampPlacements,\n      timbres: state.timbres,\n      macrobeatGroupings: state.macrobeatGroupings,\n      macrobeatBoundaryStyles: state.macrobeatBoundaryStyles,\n      hasAnacrusis: state.hasAnacrusis,\n      baseMicrobeatPx: state.baseMicrobeatPx,\n      modulationMarkers: state.modulationMarkers,\n      tempo: state.tempo,\n      activeChordIntervals: state.activeChordIntervals,\n      selectedNote: state.selectedNote,\n      annotations: state.annotations,\n      pitchRange: state.pitchRange,\n      degreeDisplayMode: state.degreeDisplayMode,\n      showOctaveLabels: state.showOctaveLabels,\n      longNoteStyle: state.longNoteStyle,\n      playheadMode: state.playheadMode\n    }));\n\n    // Convert Float32Arrays to regular arrays for storage\n    if (state.timbres) {\n      for (const color in state.timbres) {\n        const timbre = state.timbres[color];\n        const persistTimbre = stateToPersist.timbres?.[color];\n        if (timbre?.coeffs && persistTimbre) {\n          persistTimbre.coeffs = Array.from(timbre.coeffs);\n        }\n        if (timbre?.phases && persistTimbre) {\n          persistTimbre.phases = Array.from(timbre.phases);\n        }\n      }\n    }\n\n    const serializedState = JSON.stringify(stateToPersist);\n    storage.setItem(storageKey, serializedState);\n  } catch {\n    // Silently fail on storage errors\n  }\n}\n\n/**\n * Create a new store instance\n */\nexport function createStore(config: StoreConfig = {}): StoreInstance {\n  const {\n    storageKey = 'studentNotationState',\n    storage,\n    initialState: configInitialState,\n    onClearState\n  } = config;\n\n  // Event subscribers\n  const subscribers: Record<string, EventCallback[]> = {};\n\n  // Load persisted state\n  const persistedState = loadStateFromStorage(storage, storageKey);\n  const isColdStart = !persistedState;\n\n  // Merge initial state\n  const baseInitialState = getInitialState();\n  const mergedState: AppState = {\n    ...baseInitialState,\n    ...persistedState,\n    ...configInitialState\n  } as AppState;\n\n  // Create the store object with state and event methods\n  const store: StoreInstance = {\n    state: mergedState,\n    isColdStart,\n\n    on(eventName: string, callback: EventCallback): void {\n      if (!subscribers[eventName]) {\n        subscribers[eventName] = [];\n      }\n      subscribers[eventName].push(callback);\n    },\n\n    off(eventName: string, callback: EventCallback): void {\n      if (subscribers[eventName]) {\n        const index = subscribers[eventName].indexOf(callback);\n        if (index > -1) {\n          subscribers[eventName].splice(index, 1);\n        }\n      }\n    },\n\n    emit(eventName: string, data?: unknown): void {\n      if (subscribers[eventName]) {\n        subscribers[eventName].forEach(callback => {\n          try {\n            callback(data);\n          } catch (error) {\n            console.error(`Error in listener for event \"${eventName}\"`, error);\n          }\n        });\n      }\n    },\n\n    dispose(): void {\n      // Clear all subscribers\n      for (const key in subscribers) {\n        delete subscribers[key];\n      }\n    },\n\n    saveState(): void {\n      saveStateToStorage(store.state, storage, storageKey);\n    },\n\n    // ========== HISTORY ACTIONS ==========\n    recordState(): void {\n      store.state.history = store.state.history.slice(0, store.state.historyIndex + 1);\n\n      const timbresForHistory = JSON.parse(JSON.stringify(store.state.timbres));\n\n      const newSnapshot: HistoryEntry = {\n        notes: JSON.parse(JSON.stringify(store.state.placedNotes)),\n        tonicSignGroups: JSON.parse(JSON.stringify(store.state.tonicSignGroups)),\n        placedChords: JSON.parse(JSON.stringify(store.state.placedChords)),\n        sixteenthStampPlacements: JSON.parse(JSON.stringify(store.state.sixteenthStampPlacements)),\n        tripletStampPlacements: JSON.parse(JSON.stringify(store.state.tripletStampPlacements || [])),\n        timbres: timbresForHistory,\n        annotations: store.state.annotations ? JSON.parse(JSON.stringify(store.state.annotations)) : [],\n        lassoSelection: JSON.parse(JSON.stringify(store.state.lassoSelection))\n      };\n      store.state.history.push(newSnapshot);\n      store.state.historyIndex++;\n      store.emit('historyChanged');\n      store.saveState();\n    },\n\n    undo(): void {\n      if (store.state.historyIndex > 0) {\n        store.state.historyIndex--;\n        const snapshot = store.state.history[store.state.historyIndex];\n        if (!snapshot) return;\n        store.state.placedNotes = JSON.parse(JSON.stringify(snapshot.notes));\n        store.state.tonicSignGroups = JSON.parse(JSON.stringify(snapshot.tonicSignGroups));\n        store.state.sixteenthStampPlacements = JSON.parse(JSON.stringify(snapshot.sixteenthStampPlacements || []));\n        store.state.tripletStampPlacements = JSON.parse(JSON.stringify(snapshot.tripletStampPlacements || []));\n        store.state.timbres = restoreTimbres(snapshot.timbres);\n        store.state.annotations = snapshot.annotations ? JSON.parse(JSON.stringify(snapshot.annotations)) : [];\n        store.emit('notesChanged');\n        store.emit('sixteenthStampPlacementsChanged');\n        store.emit('tripletStampPlacementsChanged');\n        store.emit('rhythmStructureChanged');\n        if (store.state.selectedNote?.color) {\n          store.emit('timbreChanged', store.state.selectedNote.color);\n        }\n        store.emit('annotationsChanged');\n        store.emit('historyChanged');\n      }\n    },\n\n    redo(): void {\n      if (store.state.historyIndex < store.state.history.length - 1) {\n        store.state.historyIndex++;\n        const snapshot = store.state.history[store.state.historyIndex];\n        if (!snapshot) return;\n        store.state.placedNotes = JSON.parse(JSON.stringify(snapshot.notes));\n        store.state.tonicSignGroups = JSON.parse(JSON.stringify(snapshot.tonicSignGroups));\n        store.state.sixteenthStampPlacements = JSON.parse(JSON.stringify(snapshot.sixteenthStampPlacements || []));\n        store.state.tripletStampPlacements = JSON.parse(JSON.stringify(snapshot.tripletStampPlacements || []));\n        store.state.timbres = restoreTimbres(snapshot.timbres);\n        store.state.annotations = snapshot.annotations ? JSON.parse(JSON.stringify(snapshot.annotations)) : [];\n        store.emit('notesChanged');\n        store.emit('sixteenthStampPlacementsChanged');\n        store.emit('tripletStampPlacementsChanged');\n        store.emit('rhythmStructureChanged');\n        if (store.state.selectedNote?.color) {\n          store.emit('timbreChanged', store.state.selectedNote.color);\n        }\n        store.emit('annotationsChanged');\n        store.emit('historyChanged');\n      }\n    },\n\n    clearSavedState(): void {\n      if (storage) {\n        storage.removeItem(storageKey);\n        storage.removeItem('effectDialValues');\n      }\n      if (onClearState) {\n        onClearState();\n      }\n    },\n\n    // ========== VIEW ACTIONS ==========\n    setPlaybackState(isPlaying: boolean, isPaused: boolean): void {\n      store.state.isPlaying = isPlaying;\n      store.state.isPaused = isPaused;\n      store.emit('playbackStateChanged', { isPlaying, isPaused });\n    },\n\n    setLooping(isLooping: boolean): void {\n      store.state.isLooping = isLooping;\n      store.emit('loopingChanged', isLooping);\n    },\n\n    setTempo(tempo: number): void {\n      store.state.tempo = tempo;\n      store.emit('tempoChanged', tempo);\n    },\n\n    setPlayheadMode(mode: 'cursor' | 'microbeat' | 'macrobeat'): void {\n      store.state.playheadMode = mode;\n      store.emit('playheadModeChanged', mode);\n    },\n\n    setSelectedTool(tool: string): void {\n      const oldTool = store.state.selectedTool;\n      store.state.previousTool = oldTool;\n      store.state.selectedTool = tool;\n      store.emit('toolChanged', { newTool: tool, oldTool });\n    },\n\n    setSelectedNote(note: { shape?: string; color?: string }): void {\n      const oldNote = { ...store.state.selectedNote };\n      store.state.selectedNote = { ...store.state.selectedNote, ...note };\n      store.emit('noteChanged', { newNote: store.state.selectedNote, oldNote });\n    },\n\n    setPitchRange(topIndex: number, bottomIndex: number): void {\n      store.state.pitchRange = { topIndex, bottomIndex };\n      store.emit('pitchRangeChanged', { topIndex, bottomIndex });\n    },\n\n    setDegreeDisplayMode(mode: 'off' | 'diatonic' | 'modal'): void {\n      store.state.degreeDisplayMode = mode;\n      store.emit('degreeDisplayModeChanged', mode);\n    },\n\n    setLongNoteStyle(style: 'style1' | 'style2'): void {\n      store.state.longNoteStyle = style;\n      store.emit('longNoteStyleChanged', style);\n    },\n\n    toggleAccidentalMode(type: 'sharp' | 'flat'): void {\n      store.state.accidentalMode[type] = !store.state.accidentalMode[type];\n      store.emit('accidentalModeChanged', store.state.accidentalMode);\n    },\n\n    toggleFrequencyLabels(): void {\n      store.state.showFrequencyLabels = !store.state.showFrequencyLabels;\n      store.emit('frequencyLabelsChanged', store.state.showFrequencyLabels);\n    },\n\n    toggleOctaveLabels(): void {\n      store.state.showOctaveLabels = !store.state.showOctaveLabels;\n      store.emit('octaveLabelsChanged', store.state.showOctaveLabels);\n    },\n\n    toggleFocusColours(): void {\n      store.state.focusColours = !store.state.focusColours;\n      store.emit('focusColoursChanged', store.state.focusColours);\n    },\n\n    toggleWaveformExtendedView(): void {\n      store.state.waveformExtendedView = !store.state.waveformExtendedView;\n      store.emit('waveformExtendedViewChanged', store.state.waveformExtendedView);\n    },\n\n    setLayoutConfig(config: Partial<AppState>): void {\n      Object.assign(store.state, config);\n      store.emit('layoutConfigChanged', config);\n    },\n\n    setDeviceProfile(profile: AppState['deviceProfile']): void {\n      store.state.deviceProfile = profile;\n      store.emit('deviceProfileChanged', profile);\n    },\n\n    setPrintPreviewActive(isActive: boolean): void {\n      store.state.isPrintPreviewActive = isActive;\n      store.emit('printPreviewStateChanged', isActive);\n    },\n\n    setPrintOptions(options: Partial<AppState['printOptions']>): void {\n      store.state.printOptions = { ...store.state.printOptions, ...options };\n      store.emit('printOptionsChanged', store.state.printOptions);\n    },\n\n    setAdsrTimeAxisScale(scale: number): void {\n      store.state.adsrTimeAxisScale = scale;\n      store.emit('adsrTimeAxisScaleChanged', scale);\n    },\n\n    setAdsrComponentWidth(): void {\n      // Placeholder - implementation depends on app-specific logic\n    },\n\n    shiftGridUp(): void {\n      // Placeholder - implementation depends on app-specific logic\n    },\n\n    shiftGridDown(): void {\n      // Placeholder - implementation depends on app-specific logic\n    },\n\n    setGridPosition(): void {\n      // Placeholder - implementation depends on app-specific logic\n    },\n\n    setKeySignature(key?: string): void {\n      store.state.keySignature = key;\n      store.emit('keySignatureChanged', key);\n    },\n\n    // ========== HARMONY ACTIONS ==========\n    setActiveChordIntervals(intervals: string[]): void {\n      store.state.activeChordIntervals = intervals;\n      store.emit('activeChordIntervalsChanged', intervals);\n    },\n\n    setIntervalsInversion(isInverted: boolean): void {\n      store.state.isIntervalsInverted = isInverted;\n      store.emit('intervalsInversionChanged', isInverted);\n    },\n\n    setChordPosition(position: number): void {\n      store.state.chordPositionState = position;\n      store.emit('chordPositionChanged', position);\n    },\n\n    // ========== TIMBRE ACTIONS ==========\n    setADSR(color: string, adsr: Partial<AppState['timbres'][string]['adsr']>): void {\n      if (store.state.timbres[color]) {\n        store.state.timbres[color].adsr = { ...store.state.timbres[color].adsr, ...adsr };\n        store.emit('timbreChanged', color);\n      }\n    },\n\n    setHarmonicCoefficients(color: string, coeffs: Float32Array): void {\n      if (store.state.timbres[color]) {\n        store.state.timbres[color].coeffs = coeffs;\n        store.emit('timbreChanged', color);\n      }\n    },\n\n    setHarmonicPhases(color: string, phases: Float32Array): void {\n      if (store.state.timbres[color]) {\n        store.state.timbres[color].phases = phases;\n        store.emit('timbreChanged', color);\n      }\n    },\n\n    setFilterSettings(color: string, settings: Partial<AppState['timbres'][string]['filter']>): void {\n      if (store.state.timbres[color]) {\n        store.state.timbres[color].filter = { ...store.state.timbres[color].filter, ...settings };\n        store.emit('timbreChanged', color);\n      }\n    },\n\n    applyPreset(color: string, preset: Partial<AppState['timbres'][string]>): void {\n      if (store.state.timbres[color]) {\n        Object.assign(store.state.timbres[color], preset);\n        store.emit('timbreChanged', color);\n      }\n    },\n\n    // ========== PLACEHOLDER ACTIONS ==========\n    // These will be implemented when the full action modules are extracted\n    addNote: () => null,\n    updateNoteTail: () => {},\n    updateMultipleNoteTails: () => {},\n    updateNoteRow: () => {},\n    updateMultipleNoteRows: () => {},\n    updateNotePosition: () => {},\n    updateMultipleNotePositions: () => {},\n    removeNote: () => {},\n    removeMultipleNotes: () => {},\n    clearAllNotes: () => {},\n    loadNotes: () => {},\n    eraseInPitchArea: () => false,\n    eraseTonicSignAt: () => false,\n    addTonicSignGroup: () => {},\n    increaseMacrobeatCount: () => {},\n    decreaseMacrobeatCount: () => {},\n    updateTimeSignature: () => {},\n    setAnacrusis: () => {},\n    addModulationMarker: () => null,\n    removeModulationMarker: () => {},\n    moveModulationMarker: () => {},\n    setModulationRatio: () => {},\n    toggleModulationMarker: () => {},\n    clearModulationMarkers: () => {},\n    toggleMacrobeatGrouping: () => {},\n    cycleMacrobeatBoundaryStyle: () => {},\n    addSixteenthStampPlacement: () => ({}) as ReturnType<Store['addSixteenthStampPlacement']>,\n    removeSixteenthStampPlacement: () => false,\n    eraseSixteenthStampsInArea: () => false,\n    getAllSixteenthStampPlacements: () => [],\n    getSixteenthStampAt: () => null,\n    clearAllSixteenthStamps: () => {},\n    getSixteenthStampPlaybackData: () => [],\n    updateSixteenthStampShapeOffset: () => {},\n    getSixteenthStampShapeRow: () => 0,\n    addTripletStampPlacement: () => ({}) as ReturnType<Store['addTripletStampPlacement']>,\n    removeTripletStampPlacement: () => false,\n    eraseTripletStampsInArea: () => false,\n    getAllTripletStampPlacements: () => [],\n    getTripletStampAt: () => null,\n    clearAllTripletStamps: () => {},\n    getTripletStampPlaybackData: () => [],\n    updateTripletStampShapeOffset: () => {},\n    getTripletStampShapeRow: () => 0,\n\n    // Internal helper\n    _isBoundaryInAnacrusis: () => false\n  };\n\n  // Set up automatic persistence on key events\n  if (storage) {\n    store.on('tempoChanged', () => store.saveState());\n    store.on('degreeDisplayModeChanged', () => store.saveState());\n    store.on('longNoteStyleChanged', () => store.saveState());\n    store.on('playheadModeChanged', () => store.saveState());\n  }\n\n  // Save initial state if cold start\n  if (isColdStart && storage) {\n    store.saveState();\n  }\n\n  return store;\n}\n","/**\n * Filtered Voice\n *\n * A custom Tone.js synth voice with:\n * - Multi-mode filter (HP/BP/LP with crossfade blend)\n * - Vibrato (frequency modulation via LFO)\n * - Tremolo (amplitude modulation via LFO)\n * - Preset gain control\n *\n * Framework-agnostic - no DOM dependencies.\n */\nimport * as Tone from 'tone';\n\nexport interface FilteredVoiceOptions extends Tone.SynthOptions {\n  filter?: FilterParams;\n  vibrato?: VibratoParams;\n  tremelo?: TremoloParams;  // Note: 'tremelo' spelling for consistency with existing code\n  gain?: number;\n}\n\nexport interface FilterParams {\n  enabled: boolean;\n  cutoff: number;      // MIDI note number offset\n  resonance: number;   // 0-100\n  blend: number;       // 0-2: 0=HP, 1=BP, 2=LP\n}\n\nexport interface VibratoParams {\n  speed: number;  // 0-100\n  span: number;   // 0-100\n}\n\nexport interface TremoloParams {\n  speed: number;  // 0-100\n  span: number;   // 0-100\n}\n\n/**\n * Optional logger interface for debug output.\n * If not provided, logging is silently skipped.\n */\nexport interface VoiceLogger {\n  debug(category: string, message: string, data?: unknown, context?: string): void;\n}\n\n// Module-level logger that can be set\nlet voiceLogger: VoiceLogger | null = null;\n\n/**\n * Set the logger for FilteredVoice instances.\n * Call this once during initialization if you want debug logging.\n */\nexport function setVoiceLogger(logger: VoiceLogger | null): void {\n  voiceLogger = logger;\n}\n\n/**\n * A custom synth voice with a sophisticated series/parallel filter blend.\n */\nexport class FilteredVoice extends Tone.Synth {\n  // Audio effect nodes\n  presetGain!: Tone.Gain;\n  vibratoLFO!: Tone.LFO;\n  vibratoDepth!: Tone.Scale;\n  vibratoGain!: Tone.Gain;\n  tremoloLFO!: Tone.LFO;\n  tremoloDepth!: Tone.Scale;\n  tremoloGain!: Tone.Gain;\n\n  // Filter nodes\n  hpFilter!: Tone.Filter;\n  lpFilterForBP!: Tone.Filter;\n  lpFilterSolo!: Tone.Filter;\n\n  // Output nodes\n  hpOutput!: Tone.Gain;\n  bpOutput!: Tone.Gain;\n  lpOutput!: Tone.Gain;\n\n  // Crossfade nodes\n  hp_bp_fade!: Tone.CrossFade;\n  main_fade!: Tone.CrossFade;\n  wetDryFade!: Tone.CrossFade;\n\n  constructor(options: FilteredVoiceOptions) {\n    super(options);\n\n    // --- Create all necessary audio nodes ---\n    this.presetGain = new Tone.Gain(options.gain || 1.0);\n\n    // --- Vibrato LFO and frequency modulation ---\n    this.vibratoLFO = new Tone.LFO(0, 0);\n    this.vibratoDepth = new Tone.Scale(-1, 1);\n    this.vibratoGain = new Tone.Gain(0);\n\n    // Connect vibrato chain: LFO -> Scale -> Gain -> Oscillator frequency\n    this.vibratoLFO.connect(this.vibratoDepth);\n    this.vibratoDepth.connect(this.vibratoGain);\n    this.vibratoGain.connect(this.oscillator.frequency);\n\n    // --- Tremolo LFO and amplitude modulation ---\n    this.tremoloLFO = new Tone.LFO(0, 0);\n    this.tremoloDepth = new Tone.Scale(0, 1);\n    this.tremoloGain = new Tone.Gain(1);\n\n    // Connect tremolo chain: LFO -> Scale -> Gain\n    this.tremoloLFO.connect(this.tremoloDepth);\n    this.tremoloDepth.connect(this.tremoloGain.gain);\n\n    // Filters for the three distinct paths\n    this.hpFilter = new Tone.Filter({ type: 'highpass' });\n    this.lpFilterForBP = new Tone.Filter({ type: 'lowpass' });\n    this.lpFilterSolo = new Tone.Filter({ type: 'lowpass' });\n\n    // Gain nodes to tap the audio from different points in the chain\n    this.hpOutput = new Tone.Gain();\n    this.bpOutput = new Tone.Gain();\n    this.lpOutput = new Tone.Gain();\n\n    // Cross-faders to blend between the three outputs\n    this.hp_bp_fade = new Tone.CrossFade(0);\n    this.main_fade = new Tone.CrossFade(0);\n\n    // Wet/Dry control for filter bypass\n    this.wetDryFade = new Tone.CrossFade(0);\n\n    // --- Audio Routing ---\n    // 1. Oscillator -> Preset Gain Node\n    this.oscillator.connect(this.presetGain);\n\n    // 2. Preset Gain -> Dry Path & Wet Path (start)\n    this.presetGain.connect(this.wetDryFade.a); // Dry Path\n\n    // 3. Setup Wet Path (now fed from presetGain)\n    // A) High-Pass path\n    this.presetGain.connect(this.hpFilter);\n    this.hpFilter.connect(this.hpOutput);\n\n    // B) Band-Pass path (HPF -> LPF in series)\n    this.hpFilter.connect(this.lpFilterForBP);\n    this.lpFilterForBP.connect(this.bpOutput);\n\n    // C) Low-Pass path (a separate, parallel LPF)\n    this.presetGain.connect(this.lpFilterSolo);\n    this.lpFilterSolo.connect(this.lpOutput);\n\n    // 4. Route the three paths into the blender\n    this.hpOutput.connect(this.hp_bp_fade.a);\n    this.bpOutput.connect(this.hp_bp_fade.b);\n    this.lpOutput.connect(this.main_fade.b);\n    this.hp_bp_fade.connect(this.main_fade.a);\n\n    // 5. Connect the blended (wet) signal to the wet/dry fader\n    this.main_fade.connect(this.wetDryFade.b);\n\n    // 6. Apply tremolo gain to the signal before the envelope\n    this.wetDryFade.connect(this.tremoloGain);\n\n    // 7. Final output goes to the main amplitude envelope\n    this.tremoloGain.connect(this.envelope);\n\n    if (options.filter) {\n      this._setFilter(options.filter);\n    }\n\n    if (options.vibrato) {\n      this._setVibrato(options.vibrato);\n    } else {\n      this._setVibrato({ speed: 0, span: 0 });\n    }\n\n    if (options.tremelo) {\n      this._setTremolo(options.tremelo);\n    } else {\n      this._setTremolo({ speed: 0, span: 0 });\n    }\n  }\n\n  _setPresetGain(value: number): void {\n    if (this.presetGain) {\n      this.presetGain.gain.value = value;\n    }\n  }\n\n  _setVibrato(params: VibratoParams, time = Tone.now()): void {\n    if (!this.vibratoLFO || !this.vibratoGain) return;\n\n    // Convert 0-100% speed to 0-16 Hz (linear mapping)\n    const speedHz = (params.speed / 100) * 16;\n    const rawContextState = ((Tone.getContext() as any)?.rawContext?.state ?? Tone.context.state) as string;\n    const isAudioRunning = rawContextState === 'running';\n\n    // If speed is 0 or span is 0, disable vibrato completely\n    if (params.speed === 0 || params.span === 0) {\n      if (isAudioRunning && this.vibratoLFO.state === 'started') {\n        this.vibratoLFO.stop(time);\n      }\n      this.vibratoLFO.frequency.value = 0;\n      this.vibratoGain.gain.value = 0;\n      return;\n    }\n\n    // Start LFO if it was stopped\n    if (isAudioRunning && this.vibratoLFO.state !== 'started') {\n      this.vibratoLFO.start(time);\n    }\n\n    this.vibratoLFO.frequency.value = speedHz;\n\n    // Convert 0-100% span to proper Hz deviation\n    // 100% span = ±50 cents maximum deviation\n    const maxCents = 50;\n    const centsAmplitude = (params.span / 100) * maxCents;\n\n    // Convert cents to Hz deviation for frequency modulation\n    const centRatio = centsAmplitude / 1200;\n    const hzDeviationFactor = Math.pow(2, centRatio) - 1;\n\n    // For vibrato, we need a reasonable Hz range. Using 440Hz as reference\n    const referenceFreq = 440;\n    const hzDeviation = referenceFreq * hzDeviationFactor;\n\n    this.vibratoGain.gain.value = hzDeviation;\n    voiceLogger?.debug('FilteredVoice', 'Vibrato gain set', { hzDeviation, centsAmplitude }, 'audio');\n  }\n\n  _setTremolo(params: TremoloParams, time = Tone.now()): void {\n    if (!this.tremoloLFO || !this.tremoloGain) return;\n\n    // Convert 0-100% speed to 0-16 Hz (linear mapping)\n    const speedHz = (params.speed / 100) * 16;\n    const rawContextState = ((Tone.getContext() as any)?.rawContext?.state ?? Tone.context.state) as string;\n    const isAudioRunning = rawContextState === 'running';\n\n    // If speed is 0 or span is 0, disable tremolo completely\n    if (params.speed === 0 || params.span === 0) {\n      if (isAudioRunning && this.tremoloLFO.state === 'started') {\n        this.tremoloLFO.stop(time);\n      }\n      this.tremoloLFO.frequency.value = 0;\n      this.tremoloGain.gain.cancelScheduledValues(time);\n      this.tremoloGain.gain.value = 1.0;\n      return;\n    }\n\n    // Start LFO if it was stopped\n    if (isAudioRunning && this.tremoloLFO.state !== 'started') {\n      this.tremoloLFO.start(time);\n    }\n\n    this.tremoloLFO.frequency.value = speedHz;\n\n    // Convert 0-100% span to amplitude modulation depth\n    const spanAmount = params.span / 100;\n\n    // Set tremolo depth scale to modulate from (1 - span) to 1.0\n    const minGain = Math.max(0, 1 - spanAmount);\n    const maxGain = 1.0;\n\n    this.tremoloDepth.min = minGain;\n    this.tremoloDepth.max = maxGain;\n  }\n\n  _setFilter(params: FilterParams): void {\n    this.wetDryFade.fade.value = params.enabled ? 1 : 0;\n\n    const freq = Tone.Midi(params.cutoff + 35).toFrequency();\n    const q = (params.resonance / 100) * 12 + 0.1;\n\n    // Set parameters on all three filters\n    this.hpFilter.set({ frequency: freq, Q: q });\n    this.lpFilterForBP.set({ frequency: freq, Q: q });\n    this.lpFilterSolo.set({ frequency: freq, Q: q });\n\n    const blend = params.blend;\n\n    // Blend from HP (0) -> BP (1)\n    if (blend <= 1.0) {\n      this.main_fade.fade.value = 0;\n      this.hp_bp_fade.fade.value = blend;\n    }\n    // Blend from BP (1) -> LP (2)\n    else {\n      this.main_fade.fade.value = blend - 1.0;\n      this.hp_bp_fade.fade.value = 1.0;\n    }\n  }\n}\n","/**\n * Gain Manager\n *\n * Handles polyphony-aware gain scaling for the synth engine.\n * Smoothly adjusts master gain based on active voice count to\n * maintain consistent perceived volume levels.\n */\nimport * as Tone from 'tone';\n\nexport interface GainManagerOptions {\n  polyphonyReference?: number;\n  smoothingTauMs?: number;\n  masterGainRampMs?: number;\n  gainUpdateIntervalMs?: number;\n}\n\nexport const DEFAULT_GAIN_MANAGER_OPTIONS: Required<GainManagerOptions> = {\n  polyphonyReference: 32,\n  smoothingTauMs: 200,\n  masterGainRampMs: 50,\n  gainUpdateIntervalMs: 16\n};\n\nexport function getPerVoiceBaselineGain(polyphonyReference = DEFAULT_GAIN_MANAGER_OPTIONS.polyphonyReference): number {\n  return 1.0 / Math.sqrt(polyphonyReference);\n}\n\nexport class GainManager {\n  private readonly masterGain: Tone.Gain;\n  private readonly options: Required<GainManagerOptions>;\n  private readonly perVoiceBaselineGain: number;\n\n  private activeVoiceCount = 0;\n  private smoothedVoiceCount: number;\n  private gainUpdateLoopId: ReturnType<typeof setInterval> | null = null;\n\n  constructor(masterGain: Tone.Gain, options: GainManagerOptions = {}) {\n    this.masterGain = masterGain;\n    this.options = { ...DEFAULT_GAIN_MANAGER_OPTIONS, ...options };\n    this.perVoiceBaselineGain = getPerVoiceBaselineGain(this.options.polyphonyReference);\n    this.smoothedVoiceCount = this.options.polyphonyReference;\n  }\n\n  start(): void {\n    this.stop();\n    this.gainUpdateLoopId = setInterval(() => this.updateMasterGain(), this.options.gainUpdateIntervalMs);\n  }\n\n  stop(): void {\n    if (this.gainUpdateLoopId === null) {\n      return;\n    }\n    clearInterval(this.gainUpdateLoopId);\n    this.gainUpdateLoopId = null;\n  }\n\n  noteOn(voiceCount = 1): void {\n    if (voiceCount <= 0) {\n      return;\n    }\n    this.activeVoiceCount += voiceCount;\n  }\n\n  noteOff(voiceCount = 1): void {\n    if (voiceCount <= 0) {\n      return;\n    }\n    this.activeVoiceCount = Math.max(0, this.activeVoiceCount - voiceCount);\n  }\n\n  clampActiveVoiceCountToAtMost(maxVoiceCount: number): void {\n    if (!Number.isFinite(maxVoiceCount)) {\n      return;\n    }\n    this.activeVoiceCount = Math.max(0, Math.min(this.activeVoiceCount, Math.floor(maxVoiceCount)));\n  }\n\n  resetActiveVoiceCount(): void {\n    this.activeVoiceCount = 0;\n  }\n\n  getActiveVoiceCount(): number {\n    return this.activeVoiceCount;\n  }\n\n  private updateMasterGain(): void {\n    const { polyphonyReference, smoothingTauMs, masterGainRampMs, gainUpdateIntervalMs } = this.options;\n\n    const now = Tone.now();\n\n    if (this.activeVoiceCount === 0) {\n      const alpha = 0.01;\n      this.smoothedVoiceCount = alpha * polyphonyReference + (1 - alpha) * this.smoothedVoiceCount;\n      return;\n    }\n\n    const deltaT = gainUpdateIntervalMs / 1000;\n    const alpha = 1 - Math.exp(-deltaT / (smoothingTauMs / 1000));\n\n    const currentVoices = Math.max(1, this.activeVoiceCount);\n    this.smoothedVoiceCount = alpha * currentVoices + (1 - alpha) * this.smoothedVoiceCount;\n\n    const scaleFactor = Math.sqrt(polyphonyReference / this.smoothedVoiceCount);\n    const targetGain = this.perVoiceBaselineGain * scaleFactor;\n\n    this.masterGain.gain.rampTo(targetGain, masterGainRampMs / 1000, now);\n  }\n}\n","/**\n * Clipping Monitor\n *\n * Monitors audio levels and warns when approaching clipping thresholds.\n * Framework-agnostic - callbacks handle the warning notifications.\n */\nimport type * as Tone from 'tone';\n\nexport interface ClippingMonitorOptions {\n  clippingWarningThresholdDb?: number;\n  clippingMonitorIntervalMs?: number;\n  clippingWarningCooldownMs?: number;\n  onWarning?: (levelDb: number) => void;\n}\n\nexport const DEFAULT_CLIPPING_MONITOR_OPTIONS: Required<Omit<ClippingMonitorOptions, 'onWarning'>> = {\n  clippingWarningThresholdDb: -3.0,\n  clippingMonitorIntervalMs: 500,\n  clippingWarningCooldownMs: 2000\n};\n\nexport class ClippingMonitor {\n  private readonly meter: Tone.Meter;\n  private readonly options: Required<Omit<ClippingMonitorOptions, 'onWarning'>> & { onWarning?: (levelDb: number) => void };\n  private clippingMonitorId: ReturnType<typeof setInterval> | null = null;\n  private lastClippingWarningAt = 0;\n\n  constructor(meter: Tone.Meter, options: ClippingMonitorOptions = {}) {\n    this.meter = meter;\n    this.options = { ...DEFAULT_CLIPPING_MONITOR_OPTIONS, ...options };\n  }\n\n  start(): void {\n    this.stop();\n    this.lastClippingWarningAt = 0;\n\n    this.clippingMonitorId = setInterval(() => {\n      const level = this.meter.getValue();\n      const levelValue = Array.isArray(level) ? level[0] : level;\n      if (levelValue === undefined) {\n        return;\n      }\n      if (levelValue <= this.options.clippingWarningThresholdDb) {\n        return;\n      }\n\n      const now = Date.now();\n      if (now - this.lastClippingWarningAt < this.options.clippingWarningCooldownMs) {\n        return;\n      }\n\n      this.lastClippingWarningAt = now;\n      this.options.onWarning?.(levelValue);\n    }, this.options.clippingMonitorIntervalMs);\n  }\n\n  stop(): void {\n    if (this.clippingMonitorId === null) {\n      return;\n    }\n    clearInterval(this.clippingMonitorId);\n    this.clippingMonitorId = null;\n  }\n}\n","/**\n * Synth Engine\n *\n * Framework-agnostic polyphonic synthesizer manager using Tone.js.\n * This is the engine package version with no DOM or window dependencies.\n *\n * Key design decisions:\n * - All dependencies are injected via config\n * - No window globals\n * - No store subscriptions (caller handles events)\n * - Optional effects manager and harmonic filter\n */\n\nimport * as Tone from 'tone';\nimport { FilteredVoice } from './FilteredVoice.js';\nimport { GainManager, getPerVoiceBaselineGain } from './GainManager.js';\nimport { ClippingMonitor } from './ClippingMonitor.js';\nimport type {\n  SynthEngineInstance,\n  SynthEngineConfig,\n  InternalTimbreState,\n  SynthLogger\n} from './types.js';\n\n/**\n * Create a new synth engine instance\n */\nexport function createSynthEngine(config: SynthEngineConfig): SynthEngineInstance {\n  const {\n    timbres,\n    masterVolume = 0,\n    effectsManager,\n    harmonicFilter,\n    logger,\n    audioInit,\n    getDrumVolume\n  } = config;\n\n  // Internal state\n  const synths: Record<string, Tone.PolySynth> = {};\n  let masterGain: Tone.Gain | null = null;\n  let volumeControl: Tone.Volume | null = null;\n  let compressor: Tone.Compressor | null = null;\n  let limiter: Tone.Limiter | null = null;\n  let clippingMeter: Tone.Meter | null = null;\n  let waveformAnalyzers: Record<string, Tone.Analyser> = {};\n  let gainManager: GainManager | null = null;\n  let clippingMonitor: ClippingMonitor | null = null;\n\n  // Copy of timbres for internal mutation\n  const internalTimbres: Record<string, InternalTimbreState> = { ...timbres };\n\n  // Logger helper\n  const log: SynthLogger = logger ?? {\n    debug: () => {},\n    info: () => {},\n    warn: () => {}\n  };\n\n  /**\n   * Get coefficients for a color, using harmonic filter if provided\n   */\n  function getCoefficients(color: string): Float32Array {\n    if (harmonicFilter) {\n      return harmonicFilter.getFilteredCoefficients(color);\n    }\n    // Fallback to raw coefficients from timbre\n    const timbre = internalTimbres[color];\n    if (timbre?.coeffs) {\n      return timbre.coeffs;\n    }\n    // Default to sine wave\n    return new Float32Array([0, 1]);\n  }\n\n  /**\n   * Normalize coefficients if total amplitude exceeds 1.0\n   */\n  function normalizeCoefficients(coeffs: Float32Array): number[] {\n    const totalAmplitude = coeffs.reduce((sum, coeff) => sum + Math.abs(coeff), 0);\n    if (totalAmplitude > 1.0) {\n      return Array.from(coeffs).map(coeff => coeff / totalAmplitude);\n    }\n    return Array.from(coeffs);\n  }\n\n  const instance: SynthEngineInstance = {\n    init() {\n      // Stop any existing monitors\n      this.stopBackgroundMonitors();\n\n      // === Build Master Audio Chain ===\n      // Signal flow: synths → masterGain → volumeControl → compressor → limiter → destination\n\n      // 1. Master gain node (polyphony-aware scaling with smoothing)\n      masterGain = new Tone.Gain(getPerVoiceBaselineGain());\n      gainManager = new GainManager(masterGain);\n      gainManager.start();\n\n      // 2. User volume control (independent of automatic gain scaling)\n      volumeControl = new Tone.Volume(masterVolume);\n\n      // 3. Bus compressor (gentle glue, transparent action)\n      compressor = new Tone.Compressor({\n        threshold: -12,\n        ratio: 3,\n        attack: 0.01,\n        release: 0.1,\n        knee: 6\n      });\n\n      // 4. True-peak limiter (safety net, should rarely engage)\n      limiter = new Tone.Limiter(-3.0);\n\n      // 5. Clipping detection meter\n      clippingMeter = new Tone.Meter();\n\n      // Connect chain: masterGain → volumeControl → compressor → limiter → destination → meter\n      masterGain.connect(volumeControl);\n      volumeControl.connect(compressor);\n      compressor.connect(limiter);\n      limiter.toDestination();\n      limiter.connect(clippingMeter);\n\n      // Start monitoring for clipping\n      if (clippingMeter) {\n        clippingMonitor = new ClippingMonitor(clippingMeter, {\n          onWarning: (levelDb) => {\n            log.warn('SynthEngine', 'Limiter input approaching clipping threshold', { level: levelDb }, 'audio');\n          }\n        });\n        clippingMonitor.start();\n      }\n\n      // Create synths for each timbre\n      for (const color in internalTimbres) {\n        const timbre = internalTimbres[color];\n        if (!timbre) continue;\n\n        // Initialize defaults if not present\n        if (!timbre.vibrato) {\n          timbre.vibrato = { speed: 0, span: 0 };\n        }\n        if (!timbre.tremelo) {\n          timbre.tremelo = { speed: 0, span: 0 };\n        }\n\n        const filteredCoeffs = getCoefficients(color);\n        const normalizedCoeffs = normalizeCoefficients(filteredCoeffs);\n        const presetGain = timbre.gain || 1.0;\n\n        const synth = new Tone.PolySynth({\n          voice: FilteredVoice,\n          options: {\n            oscillator: { type: 'custom', partials: normalizedCoeffs },\n            envelope: timbre.adsr,\n            filter: timbre.filter,\n            vibrato: timbre.vibrato,\n            tremelo: timbre.tremelo,\n            gain: presetGain\n          } as any\n        }).connect(masterGain) as any;\n\n        // Apply synth-level effects if effects manager is available\n        if (effectsManager && masterGain) {\n          effectsManager.applySynthEffects(synth, color, masterGain);\n        }\n\n        // Hook into voice creation to apply vibrato/tremolo to new voices\n        const originalTriggerAttack = synth.triggerAttack.bind(synth);\n        synth.triggerAttack = function(...args: any[]) {\n          const result = originalTriggerAttack(...args);\n\n          // Apply current settings to newly created voices\n          setTimeout(() => {\n            const activeVoices = this._activeVoices;\n\n            if (effectsManager) {\n              if (activeVoices && activeVoices.size > 0) {\n                activeVoices.forEach((voice: any) => {\n                  if (!voice.effectsApplied) {\n                    effectsManager.applyEffectsToVoice(voice, color);\n                    voice.effectsApplied = true;\n                  }\n                });\n              } else if (this._voices && Array.isArray(this._voices)) {\n                this._voices.forEach((voice: any) => {\n                  if (voice && !voice.effectsApplied) {\n                    effectsManager.applyEffectsToVoice(voice, color);\n                    voice.effectsApplied = true;\n                  }\n                });\n              }\n            } else {\n              // Fallback to legacy approach\n              if (activeVoices && activeVoices.size > 0) {\n                activeVoices.forEach((voice: any) => {\n                  if (voice._setVibrato && voice.vibratoApplied !== true) {\n                    voice._setVibrato(this._currentVibrato);\n                    voice.vibratoApplied = true;\n                  }\n                  if (voice._setTremolo && voice.tremoloApplied !== true) {\n                    voice._setTremolo(this._currentTremolo);\n                    voice.tremoloApplied = true;\n                  }\n                });\n              } else if (this._voices && Array.isArray(this._voices)) {\n                this._voices.forEach((voice: any) => {\n                  if (voice?._setVibrato && voice.vibratoApplied !== true) {\n                    voice._setVibrato(this._currentVibrato);\n                    voice.vibratoApplied = true;\n                  }\n                  if (voice?._setTremolo && voice.tremoloApplied !== true) {\n                    voice._setTremolo(this._currentTremolo);\n                    voice.tremoloApplied = true;\n                  }\n                });\n              }\n            }\n          }, 10);\n\n          return result;\n        };\n\n        // Store current settings on synth for future reference\n        synth._currentVibrato = timbre.vibrato;\n        synth._currentTremolo = timbre.tremelo;\n        synth._currentFilter = timbre.filter;\n\n        synths[color] = synth;\n        log.debug('SynthEngine', `Created filtered synth for color: ${color}`, null, 'audio');\n      }\n\n      log.info('SynthEngine', 'Initialized with multi-timbral support', null, 'audio');\n    },\n\n    updateSynthForColor(color: string) {\n      const timbre = internalTimbres[color];\n      const synth = synths[color];\n      if (!synth || !timbre) return;\n\n      // Initialize vibrato if it doesn't exist\n      if (!timbre.vibrato) {\n        timbre.vibrato = { speed: 0, span: 0 };\n      }\n\n      // Initialize tremolo if it doesn't exist\n      if (!timbre.tremelo) {\n        timbre.tremelo = { speed: 0, span: 0 };\n      }\n\n      log.debug('SynthEngine', `Updating timbre for color ${color}`, null, 'audio');\n\n      const filteredCoeffs = getCoefficients(color);\n      const normalizedCoeffs = normalizeCoefficients(filteredCoeffs);\n\n      synth.set({\n        oscillator: { partials: normalizedCoeffs },\n        envelope: timbre.adsr\n      });\n\n      // Re-apply synth-level effects when timbre changes\n      if (effectsManager && masterGain) {\n        effectsManager.applySynthEffects(synth, color, masterGain);\n      }\n\n      // Update stored settings on synth for future voices\n      synth._currentVibrato = timbre.vibrato;\n      synth._currentTremolo = timbre.tremelo;\n      synth._currentFilter = timbre.filter;\n\n      // Try setting parameters on existing voices\n      const activeVoices = synth._activeVoices;\n\n      if (activeVoices && activeVoices.size > 0) {\n        activeVoices.forEach((voice: any) => {\n          if (voice._setFilter) {\n            voice._setFilter(timbre.filter);\n          }\n          if (voice._setVibrato) {\n            voice._setVibrato(timbre.vibrato);\n            voice.vibratoApplied = true;\n          }\n          if (voice._setTremolo) {\n            voice._setTremolo(timbre.tremelo);\n            voice.tremoloApplied = true;\n          }\n          if (voice._setPresetGain) {\n            const presetGain = timbre.gain || 1.0;\n            voice._setPresetGain(presetGain);\n          }\n        });\n      } else if (synth._voices && Array.isArray(synth._voices)) {\n        synth._voices.forEach((voice: any) => {\n          if (voice?._setVibrato) {\n            voice._setVibrato(timbre.vibrato);\n            voice.vibratoApplied = true;\n          }\n          if (voice?._setTremolo) {\n            voice._setTremolo(timbre.tremelo);\n            voice.tremoloApplied = true;\n          }\n          if (voice?._setFilter) {\n            voice._setFilter(timbre.filter);\n          }\n          if (voice?._setPresetGain) {\n            const presetGain = timbre.gain || 1.0;\n            voice._setPresetGain(presetGain);\n          }\n        });\n      }\n    },\n\n    setBpm(tempo: number) {\n      try {\n        if (Tone?.Transport?.bpm) {\n          Tone.Transport.bpm.value = tempo;\n          log.debug('SynthEngine', `Tone.Transport BPM updated to ${tempo}`, null, 'audio');\n        }\n      } catch (error) {\n        log.warn('SynthEngine', 'Unable to update BPM on Tone.Transport', { tempo, error }, 'audio');\n      }\n    },\n\n    setVolume(dB: number) {\n      if (volumeControl) {\n        volumeControl.volume.value = dB;\n      }\n    },\n\n    async playNote(pitch: string | number, duration: number | string, time = Tone.now()) {\n      // Use provided audio init or default to Tone.start()\n      const init = audioInit || (() => Tone.start());\n      await init();\n\n      // Get the first available synth\n      const colors = Object.keys(synths);\n      if (colors.length === 0) return;\n\n      const synth = synths[colors[0]];\n      if (synth) {\n        synth.triggerAttackRelease(pitch, duration, time);\n      }\n    },\n\n    /**\n     * Trigger note attack. Used by Transport scheduling with explicit time parameter.\n     * For interactive (user-initiated) triggers, use triggerAttackInteractive instead.\n     */\n    triggerAttack(pitch: string | number, color: string, time = Tone.now(), isDrum = false) {\n      const synth = synths[color];\n      if (!synth) return;\n\n      // Increment active voice count\n      gainManager?.noteOn(1);\n\n      if (isDrum && getDrumVolume) {\n        // Apply drum volume by temporarily adjusting synth volume\n        const drumVolume = getDrumVolume();\n        const originalVolume = synth.volume.value;\n        const drumVolumeDB = originalVolume + 20 * Math.log10(drumVolume);\n        synth.volume.value = drumVolumeDB;\n\n        synth.triggerAttack(pitch, time);\n\n        // Reset volume after a short delay\n        setTimeout(() => {\n          if (synth?.volume) {\n            synth.volume.value = originalVolume;\n          }\n        }, 100);\n      } else {\n        synth.triggerAttack(pitch, time);\n      }\n    },\n\n    /**\n     * Trigger note attack for interactive (user-initiated) events.\n     * Adds a small scheduling offset (20ms) to help the audio thread process\n     * the event without pops or clicks.\n     *\n     * Use this for mouse clicks, keyboard presses, or other immediate UI triggers.\n     */\n    triggerAttackInteractive(pitch: string | number, color: string) {\n      // Small offset helps avoid performance-related audio pops\n      // 20ms is imperceptible but gives the audio thread breathing room\n      instance.triggerAttack(pitch, color, Tone.now() + 0.02);\n    },\n\n    quickReleasePitches(pitches: Array<string | number>, color: string) {\n      const synth = synths[color];\n      if (!synth || !pitches || pitches.length === 0) return;\n\n      let originalRelease: number | undefined;\n      try {\n        const currentConfig = typeof synth.get === 'function' ? synth.get() : null;\n        originalRelease = currentConfig?.envelope?.release;\n\n        // Use a tiny but non-zero release to avoid audible clicks\n        synth.set({ envelope: { release: 0.01 } });\n\n        pitches.forEach(pitch => {\n          synth.triggerRelease(pitch, Tone.now());\n        });\n\n        // Clamp active voice count to current synth voices after quick release\n        const currentVoices = (synth as any)._activeVoices?.size ?? (synth as any)._voices?.length ?? gainManager?.getActiveVoiceCount() ?? 0;\n        gainManager?.clampActiveVoiceCountToAtMost(currentVoices);\n      } catch (err) {\n        log.warn('SynthEngine', 'quickReleasePitches failed', { err, color, pitches }, 'audio');\n      } finally {\n        if (originalRelease !== undefined) {\n          try {\n            synth.set({ envelope: { release: originalRelease } });\n          } catch {\n            // Ignore restore errors\n          }\n        }\n      }\n    },\n\n    triggerRelease(pitch: string | number, color: string, time = Tone.now()) {\n      const synth = synths[color];\n      if (!synth) return;\n\n      synth.triggerRelease(pitch, time);\n\n      // Decrement active voice count\n      gainManager?.noteOff(1);\n\n      // Clamp to actual synth voices to avoid drift\n      const currentVoices = (synth as any)._activeVoices?.size ?? (synth as any)._voices?.length ?? gainManager?.getActiveVoiceCount() ?? 0;\n      gainManager?.clampActiveVoiceCountToAtMost(currentVoices);\n    },\n\n    releaseAll() {\n      for (const color in synths) {\n        synths[color]?.releaseAll();\n      }\n      gainManager?.resetActiveVoiceCount();\n    },\n\n    // === Waveform Visualization ===\n\n    createWaveformAnalyzer(color: string): Tone.Analyser | null {\n      const synth = synths[color];\n      if (!synth) {\n        log.warn('SynthEngine', `No synth found for color: ${color}`, null, 'audio');\n        return null;\n      }\n\n      if (!waveformAnalyzers[color]) {\n        waveformAnalyzers[color] = new Tone.Analyser('waveform', 1024);\n        synth.connect(waveformAnalyzers[color]);\n        log.debug('SynthEngine', `Created waveform analyzer for color: ${color}`, null, 'waveform');\n      }\n\n      return waveformAnalyzers[color];\n    },\n\n    getWaveformAnalyzer(color: string): Tone.Analyser | null {\n      return waveformAnalyzers[color] || null;\n    },\n\n    getAllWaveformAnalyzers(): Map<string, Tone.Analyser> {\n      const activeAnalyzers = new Map<string, Tone.Analyser>();\n      for (const color in waveformAnalyzers) {\n        if (waveformAnalyzers[color]) {\n          activeAnalyzers.set(color, waveformAnalyzers[color]);\n        }\n      }\n      return activeAnalyzers;\n    },\n\n    removeWaveformAnalyzer(color: string) {\n      if (waveformAnalyzers[color]) {\n        waveformAnalyzers[color].dispose();\n        delete waveformAnalyzers[color];\n        log.debug('SynthEngine', `Removed waveform analyzer for color: ${color}`, null, 'waveform');\n      }\n    },\n\n    disposeAllWaveformAnalyzers() {\n      for (const color in waveformAnalyzers) {\n        if (waveformAnalyzers[color]) {\n          waveformAnalyzers[color].dispose();\n        }\n      }\n      waveformAnalyzers = {};\n      log.debug('SynthEngine', 'Disposed all waveform analyzers', null, 'waveform');\n    },\n\n    // === Node Access ===\n\n    getSynth(color: string): unknown | null {\n      return synths[color] || null;\n    },\n\n    getAllSynths(): Record<string, unknown> {\n      return { ...synths };\n    },\n\n    getMainVolumeNode(): Tone.Volume | null {\n      return volumeControl || null;\n    },\n\n    getMasterGainNode(): Tone.Gain | null {\n      return masterGain || null;\n    },\n\n    // === Cleanup ===\n\n    stopBackgroundMonitors() {\n      clippingMonitor?.stop();\n      gainManager?.stop();\n    },\n\n    dispose() {\n      this.stopBackgroundMonitors();\n      this.disposeAllWaveformAnalyzers();\n\n      // Dispose synths\n      for (const color in synths) {\n        synths[color]?.dispose();\n      }\n\n      // Dispose audio chain\n      masterGain?.dispose();\n      volumeControl?.dispose();\n      compressor?.dispose();\n      limiter?.dispose();\n      clippingMeter?.dispose();\n\n      log.debug('SynthEngine', 'Disposed SynthEngine', null, 'audio');\n    }\n  };\n\n  return instance;\n}\n","/**\n * Transport Service\n *\n * Framework-agnostic playback controller using Tone.js Transport.\n *\n * TODO: Extract implementation from apps/student-notation/src/services/transportService.ts\n * Key refactoring needed:\n * - Remove domCache.get() calls\n * - Pass canvas contexts as parameters to animate functions\n * - Remove document.getElementById / document.createElement calls\n * - Accept callbacks for highlight rendering instead of direct DOM manipulation\n */\n\nimport type { TransportServiceInstance, TransportConfig } from './types.js';\n\n/**\n * Create a new transport service instance\n */\nexport function createTransportService(_config: TransportConfig): TransportServiceInstance {\n  throw new Error(\n    'TransportService not yet implemented. Needs to be extracted from ' +\n    'apps/student-notation/src/services/transportService.ts'\n  );\n}\n","/**\n * Audio Context Configuration\n *\n * Utilities for configuring Tone.js AudioContext with optimal performance settings.\n *\n * Key settings:\n * - latencyHint: Controls the trade-off between latency and stability\n *   - \"interactive\": Lowest latency (default), best for real-time instruments\n *   - \"playback\": Prioritizes sustained playback stability\n *   - \"balanced\": Balance between latency and performance\n *   - number: Custom latency in seconds\n *\n * - lookAhead: How far in advance events are scheduled (default 0.1s)\n *   - Higher values = better stability, worse latency\n *   - Lower values = better latency, may cause glitches\n */\n\nimport * as Tone from 'tone';\n\n/**\n * Standard Web Audio API latency hints\n */\nexport type LatencyHint = 'interactive' | 'playback' | 'balanced';\n\n/**\n * Options for configuring the audio context\n */\nexport interface ContextOptions {\n  /**\n   * Latency hint for the audio context.\n   * - \"interactive\": Low latency, may have glitches under load\n   * - \"playback\": Stable playback, higher latency\n   * - \"balanced\": Balance between latency and stability\n   * @default \"playback\"\n   */\n  latencyHint?: LatencyHint;\n\n  /**\n   * How far in advance to schedule events (in seconds).\n   * Higher values improve stability but increase latency.\n   * @default 0.1\n   */\n  lookAhead?: number;\n}\n\n/**\n * Default context options optimized for playback applications\n */\nexport const DEFAULT_CONTEXT_OPTIONS: ContextOptions = {\n  latencyHint: 'playback',\n  lookAhead: 0.1\n};\n\n/**\n * Configure the Tone.js audio context with performance-optimized settings.\n *\n * IMPORTANT: This should be called early in app initialization, before any\n * audio nodes are created. If the context has already started, only lookAhead\n * can be adjusted.\n *\n * @param options - Configuration options\n * @returns true if a new context was created, false if existing context was configured\n *\n * @example\n * ```ts\n * // Call early in app startup\n * configureAudioContext({ latencyHint: 'playback' });\n *\n * // Later, after user gesture\n * await Tone.start();\n * ```\n */\nexport function configureAudioContext(options: ContextOptions = {}): boolean {\n  const { latencyHint, lookAhead } = { ...DEFAULT_CONTEXT_OPTIONS, ...options };\n\n  let createdNewContext = false;\n\n  // Only create new context if the current one hasn't started yet\n  // Once started, we can't replace the context without breaking existing audio nodes\n  if (Tone.context.state === 'suspended') {\n    try {\n      // Cast latencyHint to satisfy Tone.js type expectations\n      // The Web Audio API accepts these string values\n      Tone.setContext(new Tone.Context({\n        latencyHint: latencyHint as AudioContextLatencyCategory\n      }));\n      createdNewContext = true;\n    } catch (error) {\n      // Context creation can fail in some environments\n      // Fall back to configuring the existing context\n      console.warn('Failed to create new AudioContext, using default:', error);\n    }\n  }\n\n  // lookAhead can be adjusted on any context\n  if (lookAhead !== undefined) {\n    Tone.context.lookAhead = lookAhead;\n  }\n\n  return createdNewContext;\n}\n\n/**\n * Get the current audio context state and configuration.\n * Useful for debugging and diagnostics.\n */\nexport function getContextInfo(): {\n  state: AudioContextState;\n  sampleRate: number;\n  baseLatency: number | undefined;\n  lookAhead: number;\n} {\n  // baseLatency is available on the raw AudioContext but not on Tone.Context wrapper\n  const rawContext = Tone.context.rawContext;\n  const baseLatency = rawContext && 'baseLatency' in rawContext\n    ? (rawContext as AudioContext).baseLatency\n    : undefined;\n\n  return {\n    state: Tone.context.state,\n    sampleRate: Tone.context.sampleRate,\n    baseLatency,\n    lookAhead: Tone.context.lookAhead\n  };\n}\n","/**\n * Pitch Grid Renderer\n *\n * Pure rendering functions for the pitch grid canvas.\n * These are framework-agnostic and only take a canvas context and render options.\n *\n * TODO: Extract implementation from:\n * - apps/student-notation/src/components/canvas/PitchGrid/renderers/pitchGridRenderer.ts\n */\n\nimport type {\n  PlacedNote,\n  TonicSign,\n  PitchRowData,\n  MacrobeatGrouping,\n  MacrobeatBoundaryStyle,\n  ModulationMarker,\n  DegreeDisplayMode,\n  AccidentalMode,\n} from '@mlt/types';\n\n/**\n * Options for rendering the pitch grid\n */\nexport interface PitchGridRenderOptions {\n  placedNotes: PlacedNote[];\n  placedTonicSigns: TonicSign[];\n  fullRowData: PitchRowData[];\n  columnWidths: number[];\n  cellWidth: number;\n  cellHeight: number;\n  rowHeight: number;\n  macrobeatGroupings: MacrobeatGrouping[];\n  macrobeatBoundaryStyles: MacrobeatBoundaryStyle[];\n  accidentalMode: AccidentalMode;\n  showFrequencyLabels: boolean;\n  showOctaveLabels: boolean;\n  colorMode: 'color' | 'bw';\n  degreeDisplayMode: DegreeDisplayMode;\n  zoomLevel: number;\n  viewportHeight: number;\n  modulationMarkers: ModulationMarker[];\n}\n\n/**\n * Render the pitch grid to a canvas context\n */\nexport function renderPitchGrid(\n  _ctx: CanvasRenderingContext2D,\n  _options: PitchGridRenderOptions\n): void {\n  throw new Error(\n    'renderPitchGrid not yet implemented. Needs to be extracted from ' +\n    'apps/student-notation/src/components/canvas/PitchGrid/renderers/pitchGridRenderer.ts'\n  );\n}\n","/**\n * Drum Grid Renderer\n *\n * Pure rendering functions for the drum grid canvas.\n * These are framework-agnostic and only take a canvas context and render options.\n *\n * TODO: Extract implementation from:\n * - apps/student-notation/src/components/canvas/drumGrid/drumGridRenderer.ts\n */\n\nimport type {\n  PlacedNote,\n  TonicSign,\n  MacrobeatGrouping,\n  MacrobeatBoundaryStyle,\n  ModulationMarker,\n} from '@mlt/types';\n\n/**\n * Volume icon state for drum grid\n */\nexport interface VolumeIconState {\n  isHovered: boolean;\n  volume: number;\n}\n\n/**\n * Options for rendering the drum grid\n */\nexport interface DrumGridRenderOptions {\n  placedNotes: PlacedNote[];\n  placedTonicSigns: TonicSign[];\n  columnWidths: number[];\n  musicalColumnWidths: number[];\n  cellWidth: number;\n  cellHeight: number;\n  macrobeatGroupings: MacrobeatGrouping[];\n  macrobeatBoundaryStyles: MacrobeatBoundaryStyle[];\n  modulationMarkers: ModulationMarker[];\n  baseMicrobeatPx: number;\n  volumeIconState: VolumeIconState;\n}\n\n/**\n * Render the drum grid to a canvas context\n */\nexport function renderDrumGrid(\n  _ctx: CanvasRenderingContext2D,\n  _options: DrumGridRenderOptions\n): void {\n  throw new Error(\n    'renderDrumGrid not yet implemented. Needs to be extracted from ' +\n    'apps/student-notation/src/components/canvas/drumGrid/drumGridRenderer.ts'\n  );\n}\n","/**\n * Time Map Calculator\n *\n * Calculates the mapping between grid columns and playback time.\n * Handles modulation adjustments and tonic column time skipping.\n *\n * Framework-agnostic - accepts state and callbacks as parameters.\n */\n\nimport * as Tone from 'tone';\nimport type {\n  LoopBounds,\n  TimeMapConfig,\n  TimeMapState,\n  MacrobeatInfo,\n  PlacedTonicSign,\n  TransportLogger,\n  GetMacrobeatInfoCallback,\n  GetPlacedTonicSignsCallback,\n  UpdatePlayheadModelCallback\n} from './types.js';\n\nconst LOOP_EPSILON = 1e-4;\n\n/**\n * Configuration for time map calculator instance\n */\nexport interface TimeMapCalculatorConfig {\n  /** Function to get macrobeat info by index */\n  getMacrobeatInfo: GetMacrobeatInfoCallback;\n  /** Function to get placed tonic signs */\n  getPlacedTonicSigns: GetPlacedTonicSignsCallback;\n  /** Function to get tonic span column indices from placed tonic signs */\n  getTonicSpanColumnIndices: (tonicSigns: PlacedTonicSign[]) => Set<number>;\n  /** Optional callback to update playhead model */\n  updatePlayheadModel?: UpdatePlayheadModelCallback;\n  /** Optional logger */\n  logger?: TransportLogger;\n}\n\n/**\n * Time map calculator instance\n */\nexport interface TimeMapCalculatorInstance {\n  /** Get the duration of one microbeat in seconds */\n  getMicrobeatDuration(tempo: number): number;\n  /** Calculate the time map from state */\n  calculate(state: TimeMapState): void;\n  /** Get the current time map */\n  getTimeMap(): number[];\n  /** Get the cached musical end time */\n  getMusicalEndTime(): number;\n  /** Find the time where non-anacrusis section starts */\n  findNonAnacrusisStart(state: TimeMapState): number;\n  /** Apply modulation to a time value */\n  applyModulationToTime(baseTime: number, columnIndex: number, state: TimeMapState): number;\n  /** Set loop bounds on Tone.Transport */\n  setLoopBounds(loopStart: number, loopEnd: number, tempo: number): void;\n  /** Get configured loop bounds */\n  getConfiguredLoopBounds(): LoopBounds;\n  /** Set configured loop bounds directly */\n  setConfiguredLoopBounds(loopStart: number, loopEnd: number): void;\n  /** Clear configured loop bounds */\n  clearConfiguredLoopBounds(): void;\n  /** Reapply configured loop bounds if they've drifted */\n  reapplyConfiguredLoopBounds(isLooping: boolean): void;\n  /** Update loop bounds from current timeline */\n  updateLoopBoundsFromTimeline(state: TimeMapState): void;\n}\n\n/**\n * Create a time map calculator instance.\n */\nexport function createTimeMapCalculator(config: TimeMapCalculatorConfig): TimeMapCalculatorInstance {\n  const {\n    getMacrobeatInfo,\n    getPlacedTonicSigns,\n    getTonicSpanColumnIndices,\n    updatePlayheadModel,\n    logger\n  } = config;\n\n  // Internal state\n  let timeMap: number[] = [];\n  let cachedMusicalEndTime = 0;\n  let configuredLoopStart = 0;\n  let configuredLoopEnd = 0;\n\n  // Logger helper\n  const log: TransportLogger = logger ?? {\n    debug: () => {}\n  };\n\n  /**\n   * Get the duration of one microbeat in seconds based on tempo.\n   */\n  function getMicrobeatDuration(tempo: number): number {\n    const microbeatBPM = tempo * 2;\n    return 60 / microbeatBPM;\n  }\n\n  /**\n   * Calculate the regular (non-modulated) time map.\n   */\n  function calculateRegularTimeMap(\n    microbeatDuration: number,\n    columnWidths: number[],\n    placedTonicSigns: PlacedTonicSign[]\n  ): void {\n    let currentTime = 0;\n\n    log.debug('TimeMapCalculator', '[TIMEMAP] Building timeMap', {\n      columnCount: columnWidths.length,\n      tonicSignCount: placedTonicSigns.length,\n      microbeatDuration\n    });\n\n    const totalColumns = columnWidths.length;\n    const tonicSpanColumns = getTonicSpanColumnIndices(placedTonicSigns);\n\n    for (let i = 0; i < totalColumns; i++) {\n      timeMap[i] = currentTime;\n\n      const isTonicColumn = tonicSpanColumns.has(i);\n      if (!isTonicColumn) {\n        currentTime += (columnWidths[i] || 0) * microbeatDuration;\n      } else {\n        log.debug('TimeMapCalculator', `[TIMEMAP] Column ${i} is tonic, not advancing time`);\n      }\n\n      if (i < 5) {\n        const entry = timeMap[i];\n        if (entry !== undefined) {\n          log.debug('TimeMapCalculator', `[TIMEMAP] timeMap[${i}] = ${entry.toFixed(3)}s (isTonic: ${isTonicColumn})`);\n        }\n      }\n    }\n\n    if (totalColumns > 0) {\n      timeMap[totalColumns] = currentTime;\n    }\n\n    log.debug('TimeMapCalculator', `[TIMEMAP] Complete. Total columns: ${totalColumns}, Final time: ${currentTime.toFixed(3)}s`);\n  }\n\n  /**\n   * Calculate and cache the modulation-adjusted musical end time.\n   */\n  function calculateMusicalEndTime(state: TimeMapState): void {\n    const baseEndTime = timeMap.length > 0 ? (timeMap[timeMap.length - 1] ?? 0) : 0;\n\n    if (!Number.isFinite(baseEndTime) || baseEndTime === 0) {\n      cachedMusicalEndTime = 0;\n      return;\n    }\n\n    const modulationMarkers = state.modulationMarkers?.filter(m => m.active) || [];\n\n    if (modulationMarkers.length === 0) {\n      cachedMusicalEndTime = baseEndTime;\n      return;\n    }\n\n    const sortedMarkers = [...modulationMarkers].sort((a, b) => a.measureIndex - b.measureIndex);\n    let adjustedEndTime = baseEndTime;\n\n    for (const marker of sortedMarkers) {\n      const macrobeatInfo = getMacrobeatInfo(marker.measureIndex);\n\n      if (macrobeatInfo) {\n        const modulationStartColumn = macrobeatInfo.endColumn - 1;\n        const modulationStartTime = timeMap[modulationStartColumn] ?? baseEndTime;\n        const remainingBaseTime = baseEndTime - modulationStartTime;\n        const stretchedTime = remainingBaseTime * marker.ratio;\n        adjustedEndTime = adjustedEndTime - remainingBaseTime + stretchedTime;\n      }\n    }\n\n    cachedMusicalEndTime = adjustedEndTime;\n  }\n\n  return {\n    getMicrobeatDuration,\n\n    calculate(state: TimeMapState): void {\n      log.debug('TimeMapCalculator', 'calculate', { tempo: `${state.tempo} BPM` });\n      timeMap = [];\n\n      const microbeatDuration = getMicrobeatDuration(state.tempo);\n      const { columnWidths } = state;\n      const placedTonicSigns = getPlacedTonicSigns();\n\n      calculateRegularTimeMap(microbeatDuration, columnWidths, placedTonicSigns);\n\n      log.timing?.('TimeMapCalculator', 'calculate', { totalDuration: `${timeMap[timeMap.length - 1]?.toFixed(2)}s` });\n\n      calculateMusicalEndTime(state);\n      const musicalEnd = cachedMusicalEndTime;\n\n      updatePlayheadModel?.({\n        timeMap,\n        musicalEndTime: musicalEnd,\n        columnWidths: state.columnWidths,\n        cellWidth: state.cellWidth\n      });\n    },\n\n    getTimeMap(): number[] {\n      return timeMap;\n    },\n\n    getMusicalEndTime(): number {\n      return cachedMusicalEndTime;\n    },\n\n    findNonAnacrusisStart(state: TimeMapState): number {\n      if (!state.hasAnacrusis) {\n        log.debug('TimeMapCalculator', '[ANACRUSIS] No anacrusis, starting from time 0');\n        return 0;\n      }\n\n      // Find the first solid boundary which marks the end of anacrusis\n      for (let i = 0; i < state.macrobeatBoundaryStyles.length; i++) {\n        if (state.macrobeatBoundaryStyles[i] === 'solid') {\n          const macrobeatInfo = getMacrobeatInfo(i + 1);\n          if (macrobeatInfo) {\n            const startTime = timeMap[macrobeatInfo.startColumn] || 0;\n            log.debug('TimeMapCalculator', `[ANACRUSIS] Found solid boundary at macrobeat ${i}, non-anacrusis starts at column ${macrobeatInfo.startColumn}, time ${startTime.toFixed(3)}s`);\n            return startTime;\n          }\n        }\n      }\n\n      log.debug('TimeMapCalculator', '[ANACRUSIS] No solid boundary found, starting from time 0');\n      return 0;\n    },\n\n    applyModulationToTime(baseTime: number, columnIndex: number, state: TimeMapState): number {\n      const modulationMarkers = state.modulationMarkers?.filter(m => m.active) || [];\n\n      if (modulationMarkers.length === 0) {\n        return baseTime;\n      }\n\n      const sortedMarkers = [...modulationMarkers].sort((a, b) => a.measureIndex - b.measureIndex);\n      let adjustedTime = baseTime;\n\n      if (columnIndex < 5) {\n        log.debug('TimeMapCalculator', `[MODULATION] Column ${columnIndex}: baseTime ${baseTime.toFixed(3)}s, ${sortedMarkers.length} active markers`);\n      }\n\n      for (const marker of sortedMarkers) {\n        const macrobeatInfo = getMacrobeatInfo(marker.measureIndex);\n\n        if (macrobeatInfo) {\n          const modulationStartColumn = macrobeatInfo.endColumn;\n\n          if (columnIndex > modulationStartColumn) {\n            const modulationStartTime = timeMap[modulationStartColumn] !== undefined ? timeMap[modulationStartColumn] : 0;\n            const deltaTime = baseTime - modulationStartTime;\n            const modulatedDelta = deltaTime * marker.ratio;\n            adjustedTime = adjustedTime - deltaTime + modulatedDelta;\n\n            if (columnIndex < 5) {\n              log.debug('TimeMapCalculator', `[MODULATION] Column ${columnIndex}: Applied marker at measure ${marker.measureIndex} (col ${modulationStartColumn}), ratio ${marker.ratio}, adjustedTime ${adjustedTime.toFixed(3)}s`);\n            }\n          }\n        }\n      }\n\n      return adjustedTime;\n    },\n\n    setLoopBounds(loopStart: number, loopEnd: number, tempo: number): void {\n      const microbeatDuration = getMicrobeatDuration(tempo);\n      const minDuration = Math.max(microbeatDuration, 0.001);\n      const safeStart = Number.isFinite(loopStart) ? loopStart : 0;\n      let safeEnd = Number.isFinite(loopEnd) ? loopEnd : safeStart + minDuration;\n      if (safeEnd <= safeStart) {\n        safeEnd = safeStart + minDuration;\n      }\n      configuredLoopStart = safeStart;\n      configuredLoopEnd = safeEnd;\n\n      if (Tone?.Transport) {\n        Tone.Transport.loopStart = safeStart;\n        Tone.Transport.loopEnd = safeEnd;\n      }\n    },\n\n    getConfiguredLoopBounds(): LoopBounds {\n      return { loopStart: configuredLoopStart, loopEnd: configuredLoopEnd };\n    },\n\n    setConfiguredLoopBounds(loopStart: number, loopEnd: number): void {\n      configuredLoopStart = loopStart;\n      configuredLoopEnd = loopEnd;\n    },\n\n    clearConfiguredLoopBounds(): void {\n      configuredLoopStart = 0;\n      configuredLoopEnd = 0;\n    },\n\n    reapplyConfiguredLoopBounds(isLooping: boolean): void {\n      if (configuredLoopEnd > configuredLoopStart) {\n        const loopStartSeconds = Tone.Time(Tone.Transport.loopStart).toSeconds();\n        const loopEndSeconds = Tone.Time(Tone.Transport.loopEnd).toSeconds();\n        const loopStartDiff = Math.abs(loopStartSeconds - configuredLoopStart);\n        const loopEndDiff = Math.abs(loopEndSeconds - configuredLoopEnd);\n        if (loopStartDiff > LOOP_EPSILON || loopEndDiff > LOOP_EPSILON) {\n          Tone.Transport.loopStart = configuredLoopStart;\n          Tone.Transport.loopEnd = configuredLoopEnd;\n        }\n        if (Tone.Transport.loop !== isLooping) {\n          Tone.Transport.loop = isLooping;\n        }\n      }\n    },\n\n    updateLoopBoundsFromTimeline(state: TimeMapState): void {\n      const loopStart = this.findNonAnacrusisStart(state);\n      const loopEnd = cachedMusicalEndTime;\n      this.setLoopBounds(loopStart, loopEnd, state.tempo);\n    }\n  };\n}\n","/**\n * Drum Manager\n *\n * Handles drum player initialization and safe scheduling.\n * Framework-agnostic - accepts synth engine as dependency for audio routing.\n */\n\nimport * as Tone from 'tone';\nimport type {\n  DrumConfig,\n  DrumManagerInstance,\n  DrumTrackId\n} from './types.js';\n\n/** Default drum sample URLs */\nexport const DEFAULT_DRUM_SAMPLES: Record<DrumTrackId, string> = {\n  H: 'https://tonejs.github.io/audio/drum-samples/CR78/hihat.mp3',\n  M: 'https://tonejs.github.io/audio/drum-samples/CR78/snare.mp3',\n  L: 'https://tonejs.github.io/audio/drum-samples/CR78/kick.mp3'\n};\n\n/** Minimum time between drum triggers */\nconst DRUM_START_EPSILON = 1e-4;\n\n/**\n * Create a drum manager instance.\n */\nexport function createDrumManager(config: DrumConfig = {}): DrumManagerInstance {\n  const {\n    samples = DEFAULT_DRUM_SAMPLES,\n    synthEngine,\n    initialVolume = 0\n  } = config;\n\n  // Internal state\n  let drumPlayers: Tone.Players | null = null;\n  let drumVolumeNode: Tone.Volume | null = null;\n  const lastDrumStartTimes = new Map<string, number>();\n\n  /**\n   * Get a safe drum start time that prevents overlapping triggers.\n   */\n  function getSafeDrumStartTime(trackId: string, requestedTime: number): number {\n    let safeTime = Number.isFinite(requestedTime) ? requestedTime : Tone.now();\n    const lastTime = lastDrumStartTimes.get(trackId) ?? -Infinity;\n\n    if (!(safeTime > lastTime)) {\n      safeTime = lastTime + DRUM_START_EPSILON;\n    }\n\n    lastDrumStartTimes.set(trackId, safeTime);\n    return safeTime;\n  }\n\n  // Initialize drum players\n  drumVolumeNode = new Tone.Volume(initialVolume);\n\n  drumPlayers = new Tone.Players(samples).connect(drumVolumeNode);\n\n  // Connect to synth engine's main volume if available, otherwise to destination\n  if (synthEngine) {\n    const synthEngineDestination = synthEngine.getMainVolumeNode?.();\n    if (synthEngineDestination) {\n      drumVolumeNode.connect(synthEngineDestination);\n    } else {\n      drumVolumeNode.toDestination();\n    }\n  } else {\n    drumVolumeNode.toDestination();\n  }\n\n  return {\n    getPlayers(): Tone.Players | null {\n      return drumPlayers;\n    },\n\n    getVolumeNode(): Tone.Volume | null {\n      return drumVolumeNode;\n    },\n\n    trigger(trackId: DrumTrackId, time: number): void {\n      if (!drumPlayers) return;\n\n      const safeTime = getSafeDrumStartTime(trackId, time);\n      drumPlayers.player(trackId)?.start(safeTime);\n    },\n\n    reset(): void {\n      lastDrumStartTimes.clear();\n    },\n\n    dispose(): void {\n      drumPlayers?.dispose();\n      drumVolumeNode?.dispose();\n      drumPlayers = null;\n      drumVolumeNode = null;\n      lastDrumStartTimes.clear();\n    }\n  };\n}\n","/**\n * @mlt/student-notation-engine\n *\n * Framework-agnostic engine for Student Notation.\n * Provides canvas rendering, audio playback, and state management\n * without any DOM dependencies.\n *\n * Usage:\n *\n * ```typescript\n * import { createEngineController } from '@mlt/student-notation-engine';\n *\n * const engine = createEngineController();\n *\n * engine.init({\n *   pitchGridContext: canvas.getContext('2d'),\n *   drumGridContext: drumCanvas.getContext('2d'),\n * });\n *\n * // Use the public API\n * engine.setTool('note');\n * engine.insertNote(40, 0, 4);\n * engine.play();\n *\n * // Subscribe to events\n * engine.on('noteAdded', (note) => {\n *   console.log('Note added:', note);\n * });\n * ```\n */\n\n// Re-export types from @mlt/types\nexport type {\n  // State\n  AppState,\n  Store,\n  HistoryEntry,\n\n  // Music\n  PlacedNote,\n  NoteShape,\n  PlacedChord,\n  TonicSign,\n  TonicSignGroups,\n  PitchRowData,\n  PitchRange,\n\n  // Stamps\n  SixteenthStampPlacement,\n  TripletStampPlacement,\n  SixteenthStampPlaybackData,\n  TripletStampPlaybackData,\n\n  // Rhythm\n  MacrobeatGrouping,\n  MacrobeatBoundaryStyle,\n  ModulationMarker,\n  ModulationRatio,\n\n  // Timbre\n  TimbreState,\n  TimbresMap,\n  ADSREnvelope,\n  FilterSettings,\n\n  // Selection\n  LassoSelection,\n  LassoSelectedItem,\n  GeometryPoint,\n\n  // View\n  DeviceProfile,\n  AccidentalMode,\n  DegreeDisplayMode,\n  PlayheadMode,\n  LongNoteStyle,\n  PrintOptions,\n\n  // Coordinates\n  CanvasSpaceColumn,\n} from '@mlt/types';\n\n// Controller API\nexport {\n  createEngineController,\n  createLessonMode,\n  type EngineController,\n  type EngineConfig,\n  type LessonModeAPI,\n  type SelectionItem,\n  type HighlightTarget,\n  type ActionEvent,\n  type ActionHandler,\n  type EventCallback,\n} from './controller.js';\n\n// State module\nexport {\n  createStore,\n  getInitialState,\n  fullRowData,\n  getPitchByToneNote,\n  getPitchByIndex,\n  getPitchIndex,\n  resolvePitchRange,\n  type StoreConfig,\n  type StoreInstance,\n  type StorageAdapter,\n  type Unsubscribe\n} from './state/index.js';\n\n// Audio module\nexport {\n  createSynthEngine,\n  createTransportService,\n  // Context configuration\n  configureAudioContext,\n  getContextInfo,\n  DEFAULT_CONTEXT_OPTIONS,\n  // Utilities\n  GainManager,\n  getPerVoiceBaselineGain,\n  ClippingMonitor,\n  FilteredVoice,\n  setVoiceLogger,\n  // Types\n  type ContextOptions,\n  type SynthEngineInstance,\n  type SynthEngineConfig,\n  type TransportServiceInstance,\n  type TransportConfig,\n  type EffectsManager,\n  type HarmonicFilter,\n  type SynthLogger,\n  type GainManagerOptions,\n  type ClippingMonitorOptions,\n  type FilteredVoiceOptions,\n  type FilterParams,\n  type VibratoParams,\n  type TremoloParams,\n  type VoiceLogger,\n} from './audio/index.js';\n\n// Canvas module\nexport {\n  renderPitchGrid,\n  renderDrumGrid,\n  type PitchGridRenderOptions,\n  type DrumGridRenderOptions,\n} from './canvas/index.js';\n\n// Transport module\nexport {\n  createTimeMapCalculator,\n  createDrumManager,\n  DEFAULT_DRUM_SAMPLES,\n  type TimeMapCalculatorConfig,\n  type TimeMapCalculatorInstance,\n  type DrumConfig,\n  type DrumManagerInstance,\n  type DrumTrackId,\n  type LoopBounds,\n  type TimeMapConfig,\n  type TimeMapState,\n  type MacrobeatInfo,\n  type PlacedTonicSign,\n  type TransportLogger,\n  type StampPlaybackData,\n  type TripletPlaybackData,\n  type ScheduleEvent,\n  type ModulationMarkerData,\n} from './transport/index.js';\n\n// Version\nexport const VERSION = '0.1.0';\n"],"names":["createEngineController","createLessonMode","engine","fullRowData","toneNoteToIndex","midiToIndex","row","index","getPitchByToneNote","toneNote","getPitchByIndex","getPitchIndex","resolvePitchRange","topToneNote","bottomToneNote","topIndex","bottomIndex","DEFAULT_ADSR","DEFAULT_FILTER","createDefaultTimbres","colors","timbres","color","coeffs","phases","getDefaultRhythm","getDefaultPitchRange","range","getInitialState","restoreTimbres","timbresSnapshot","newTimbres","timbre","loadStateFromStorage","storage","storageKey","serializedState","parsedState","values","totalRows","maxIndex","mode","saveStateToStorage","state","stateToPersist","persistTimbre","_a","createStore","config","configInitialState","onClearState","subscribers","persistedState","isColdStart","store","eventName","callback","data","error","key","timbresForHistory","newSnapshot","snapshot","isPlaying","isPaused","isLooping","tempo","tool","oldTool","note","oldNote","style","type","profile","isActive","options","scale","intervals","isInverted","position","adsr","settings","preset","voiceLogger","setVoiceLogger","logger","FilteredVoice","Tone","__publicField","value","params","time","speedHz","isAudioRunning","_b","centsAmplitude","centRatio","hzDeviation","spanAmount","minGain","maxGain","freq","q","blend","DEFAULT_GAIN_MANAGER_OPTIONS","getPerVoiceBaselineGain","polyphonyReference","GainManager","masterGain","voiceCount","maxVoiceCount","smoothingTauMs","masterGainRampMs","gainUpdateIntervalMs","now","alpha","deltaT","currentVoices","scaleFactor","targetGain","DEFAULT_CLIPPING_MONITOR_OPTIONS","ClippingMonitor","meter","level","levelValue","createSynthEngine","masterVolume","effectsManager","harmonicFilter","audioInit","getDrumVolume","synths","volumeControl","compressor","limiter","clippingMeter","waveformAnalyzers","gainManager","clippingMonitor","internalTimbres","log","getCoefficients","normalizeCoefficients","totalAmplitude","sum","coeff","instance","levelDb","filteredCoeffs","normalizedCoeffs","presetGain","synth","originalTriggerAttack","args","result","activeVoices","voice","dB","pitch","duration","isDrum","drumVolume","originalVolume","drumVolumeDB","pitches","originalRelease","currentConfig","_c","err","activeAnalyzers","createTransportService","_config","DEFAULT_CONTEXT_OPTIONS","configureAudioContext","latencyHint","lookAhead","createdNewContext","getContextInfo","rawContext","baseLatency","renderPitchGrid","_ctx","_options","renderDrumGrid","LOOP_EPSILON","createTimeMapCalculator","getMacrobeatInfo","getPlacedTonicSigns","getTonicSpanColumnIndices","updatePlayheadModel","timeMap","cachedMusicalEndTime","configuredLoopStart","configuredLoopEnd","getMicrobeatDuration","calculateRegularTimeMap","microbeatDuration","columnWidths","placedTonicSigns","currentTime","totalColumns","tonicSpanColumns","i","isTonicColumn","entry","calculateMusicalEndTime","baseEndTime","modulationMarkers","m","sortedMarkers","a","b","adjustedEndTime","marker","macrobeatInfo","modulationStartColumn","modulationStartTime","remainingBaseTime","stretchedTime","musicalEnd","startTime","baseTime","columnIndex","adjustedTime","deltaTime","modulatedDelta","loopStart","loopEnd","minDuration","safeStart","safeEnd","loopStartSeconds","loopEndSeconds","loopStartDiff","loopEndDiff","DEFAULT_DRUM_SAMPLES","DRUM_START_EPSILON","createDrumManager","samples","synthEngine","initialVolume","drumPlayers","drumVolumeNode","lastDrumStartTimes","getSafeDrumStartTime","trackId","requestedTime","safeTime","lastTime","synthEngineDestination","VERSION"],"mappings":"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"}